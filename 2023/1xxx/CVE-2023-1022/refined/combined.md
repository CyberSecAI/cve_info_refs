=== Content from plugins.trac.wordpress.org_eabf23bb_20250114_212144.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2870465%2540wp-meta-seo%26old%3D2870465%2540wp-meta-seo)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2869205/wp-meta-seo "Changeset 2869205 for wp-meta-seo")
* [Next Change](/changeset/2883268/wp-meta-seo "Changeset 2883268 for wp-meta-seo") →

---

# Changeset [2870465](/changeset/2870465 "Show full changeset") for [wp-meta-seo](/browser/wp-meta-seo?rev=2870465 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/24/2023 08:47:03 AM
([23 months](/timeline?from=2023-02-24T08%3A47%3A03Z&precision=second "See timeline at 02/24/2023 08:47:03 AM") ago)

Author:
JoomUnited
Message:

Updating to version 4.5.4

Location:
[wp-meta-seo](/browser/wp-meta-seo?rev=2870465)
Files:

14 edited
1 copied

* [tags/4.5.4](/browser/wp-meta-seo/tags/4.5.4?rev=2870465 "Show entry in browser")
  (copied)
  *(copied from [wp-meta-seo/trunk](/browser/wp-meta-seo/trunk?rev=2869205 "Show original file (revision 2870464)"))*
* [tags/4.5.4/assets/js/metaseo\_admin.js](/browser/wp-meta-seo/tags/4.5.4/assets/js/metaseo_admin.js?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [tags/4.5.4/assets/js/metaseo\_sitemap.js](/browser/wp-meta-seo/tags/4.5.4/assets/js/metaseo_sitemap.js?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [tags/4.5.4/inc/class.metaseo-admin.php](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-admin.php?rev=2870465 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [tags/4.5.4/inc/class.metaseo-sitemap.php](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php?rev=2870465 "Show entry in browser")
  (modified)
  ([6 diffs](#file4 "Show differences"))
* [tags/4.5.4/languages/wp-meta-seo-en\_US.mo](/browser/wp-meta-seo/tags/4.5.4/languages/wp-meta-seo-en_US.mo?rev=2870465 "Show entry in browser")
  (modified)
  ([previous](/browser/wp-meta-seo/trunk/languages/wp-meta-seo-en_US.mo?rev=2869205 "Show previous version in browser"))
* [tags/4.5.4/readme.txt](/browser/wp-meta-seo/tags/4.5.4/readme.txt?rev=2870465 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [tags/4.5.4/wp-meta-seo.php](/browser/wp-meta-seo/tags/4.5.4/wp-meta-seo.php?rev=2870465 "Show entry in browser")
  (modified)
  ([2 diffs](#file7 "Show differences"))
* [trunk/assets/js/metaseo\_admin.js](/browser/wp-meta-seo/trunk/assets/js/metaseo_admin.js?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [trunk/assets/js/metaseo\_sitemap.js](/browser/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [trunk/inc/class.metaseo-admin.php](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2870465 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))
* [trunk/inc/class.metaseo-sitemap.php](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465 "Show entry in browser")
  (modified)
  ([6 diffs](#file11 "Show differences"))
* [trunk/languages/wp-meta-seo-en\_US.mo](/browser/wp-meta-seo/trunk/languages/wp-meta-seo-en_US.mo?rev=2870465 "Show entry in browser")
  (modified)
  ([previous](/browser/wp-meta-seo/trunk/languages/wp-meta-seo-en_US.mo?rev=2869205 "Show previous version in browser"))
* [trunk/readme.txt](/browser/wp-meta-seo/trunk/readme.txt?rev=2870465 "Show entry in browser")
  (modified)
  ([2 diffs](#file13 "Show differences"))
* [trunk/wp-meta-seo.php](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2870465 "Show entry in browser")
  (modified)
  ([2 diffs](#file14 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-meta-seo/tags/4.5.4/assets/js/metaseo\_admin.js](/changeset/2870465/wp-meta-seo/tags/4.5.4/assets/js/metaseo_admin.js "Show the changeset 2870465 restricted to wp-meta-seo/tags/4.5.4/assets/js/metaseo_admin.js")

  | [r2594823](/browser/wp-meta-seo/trunk/assets/js/metaseo_admin.js?rev=2594823#L17 "Show revision 2594823 of this file in browser") | [r2870465](/browser/wp-meta-seo/tags/4.5.4/assets/js/metaseo_admin.js?rev=2870465#L17 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 17 | 17 | function wpmsIgnore(option, hide, nonce) { |
  | 18 | 18 | jQuery.post(ajaxurl, { |
  | 19 |  | action: "wpms\_set\_ignore" |
  |  | 19 | action: "wpms\_set\_ignore", |
  |  | 20 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 20 | 21 | }, function (data) { |
  | 21 | 22 | if (data) { |
* ## [wp-meta-seo/tags/4.5.4/assets/js/metaseo\_sitemap.js](/changeset/2870465/wp-meta-seo/tags/4.5.4/assets/js/metaseo_sitemap.js "Show the changeset 2870465 restricted to wp-meta-seo/tags/4.5.4/assets/js/metaseo_sitemap.js")

  | [r2522725](/browser/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js?rev=2522725#L321 "Show revision 2522725 of this file in browser") | [r2870465](/browser/wp-meta-seo/tags/4.5.4/assets/js/metaseo_sitemap.js?rev=2870465#L321 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 321 | 321 | dataType: 'json', |
  | 322 | 322 | data: { |
  | 323 |  | action: 'wpms\_regenerate\_sitemaps' |
  |  | 323 | action: 'wpms\_regenerate\_sitemaps', |
  |  | 324 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 324 | 325 | }, |
  | 325 | 326 | success: function () { |
* ## [wp-meta-seo/tags/4.5.4/inc/class.metaseo-admin.php](/changeset/2870465/wp-meta-seo/tags/4.5.4/inc/class.metaseo-admin.php "Show the changeset 2870465 restricted to wp-meta-seo/tags/4.5.4/inc/class.metaseo-admin.php")

  | [r2869205](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2869205#L1010 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-admin.php?rev=2870465#L1010 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 1010 | 1010 | public function setIgnore() |
  | 1011 | 1011 | { |
  |  | 1012 | if (empty($\_POST['wpms\_nonce']) |
  |  | 1013 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  |  | 1014 | die(); |
  |  | 1015 | } |
  | 1012 | 1016 | if (!current\_user\_can('manage\_options')) { |
  | 1013 | 1017 | wp\_send\_json(false); |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2869205#L4742) | […](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-admin.php?rev=2870465#L4746) |  |
  | 4742 | 4746 | { |
  | 4743 | 4747 | check\_ajax\_referer('wpms\_nonce', 'wpms\_nonce'); |
  |  | 4748 | if (!current\_user\_can('manage\_options')) { |
  |  | 4749 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 4750 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 4751 | } |
  | 4744 | 4752 |  |
  | 4745 | 4753 | $google\_alanytics = array( |
* ## [wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php](/changeset/2870465/wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php "Show the changeset 2870465 restricted to wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php")

  | [r2810660](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L57 "Show revision 2810660 of this file in browser") | [r2870465](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php?rev=2870465#L57 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 57 | 57 | add\_filter('the\_content', array($this, 'sitemapInContent')); |
  | 58 | 58 | add\_shortcode('wpms\_html\_sitemap', array($this, 'sitemapShortcode')); |
  | 59 |  | add\_action('wp\_ajax\_wpms\_regenerate\_sitemaps', array($this, 'regenerateSitemaps')); |
  |  | 59 | add\_action('wp\_ajax\_wpms\_regenerate\_sitemaps', array($this, 'regenerateSitemapsAjax')); |
  | 60 | 60 | add\_action('wp\_ajax\_wpms\_save\_sitemap\_settings', array($this, 'saveSitemapSettings')); |
  | 61 | 61 | add\_action('wp\_ajax\_wpms\_list\_posts\_category', array($this, 'listPostsCategory')); |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2512) | […](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php?rev=2870465#L2512) |  |
  | 2512 | 2512 | \* Ajax generate sitemap to xml file |
  | 2513 | 2513 | \* |
  |  | 2514 | \* @return void |
  |  | 2515 | \*/ |
  |  | 2516 | public function regenerateSitemapsAjax() |
  |  | 2517 | { |
  |  | 2518 | if (empty($\_POST['wpms\_nonce']) |
  |  | 2519 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  |  | 2520 | die(); |
  |  | 2521 | } |
  |  | 2522 |  |
  |  | 2523 | $this->regenerateSitemaps(); |
  |  | 2524 | } |
  |  | 2525 | /\*\* |
  |  | 2526 | \* Ajax generate sitemap to xml file |
  |  | 2527 | \* |
  | 2514 | 2528 | \* @param string $type Type |
  | 2515 | 2529 | \* |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2518) | […](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php?rev=2870465#L2532) |  |
  | 2518 | 2532 | public function regenerateSitemaps($type = 'ajax') |
  | 2519 | 2533 | { |
  |  | 2534 | if (!current\_user\_can('manage\_options')) { |
  |  | 2535 | if ($type === 'ajax') { |
  |  | 2536 | wp\_send\_json(array('status' => false, 'message' => \_\_('There is no permission here', 'wp-meta-seo'))); |
  |  | 2537 | } else { |
  |  | 2538 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2539 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 2540 | } |
  |  | 2541 | } |
  | 2520 | 2542 | if (! function\_exists('get\_home\_path')) { |
  | 2521 | 2543 | include\_once ABSPATH . '/wp-admin/includes/file.php'; |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2650) | […](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php?rev=2870465#L2672) |  |
  | 2650 | 2672 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2651 | 2673 | die(); |
  |  | 2674 | } |
  |  | 2675 | if (!current\_user\_can('manage\_options')) { |
  |  | 2676 | wp\_send\_json(array('status' => false)); |
  | 2652 | 2677 | } |
  | 2653 | 2678 | set\_time\_limit(0); |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2740) | […](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php?rev=2870465#L2765) |  |
  | 2740 | 2765 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2741 | 2766 | die(); |
  |  | 2767 | } |
  |  | 2768 | if (!current\_user\_can('manage\_options')) { |
  |  | 2769 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2770 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  | 2742 | 2771 | } |
  | 2743 | 2772 |  |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2924) | […](/browser/wp-meta-seo/tags/4.5.4/inc/class.metaseo-sitemap.php?rev=2870465#L2953) |  |
  | 2924 | 2953 | die(); |
  | 2925 | 2954 | } |
  |  | 2955 | if (!current\_user\_can('manage\_options')) { |
  |  | 2956 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2957 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 2958 | } |
  | 2926 | 2959 | $post\_in\_category = array(); |
  | 2927 | 2960 | $post\_in\_sitemap = array(); |
* ## [wp-meta-seo/tags/4.5.4/readme.txt](/changeset/2870465/wp-meta-seo/tags/4.5.4/readme.txt "Show the changeset 2870465 restricted to wp-meta-seo/tags/4.5.4/readme.txt")

  | [r2869205](/browser/wp-meta-seo/trunk/readme.txt?rev=2869205#L4 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/tags/4.5.4/readme.txt?rev=2870465#L4 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.7 |
  | 5 | 5 | Tested up to: 6.1 |
  | 6 |  | Stable tag: 4.5.~~3~~ |
  |  | 6 | Stable tag: 4.5.4 |
  | 7 | 7 | Requires PHP: 5.6 |
  | 8 | 8 | License: GPLv2 or later |
  | […](/browser/wp-meta-seo/trunk/readme.txt?rev=2869205#L261) | […](/browser/wp-meta-seo/tags/4.5.4/readme.txt?rev=2870465#L261) |  |
  | 261 | 261 | == Changelog == |
  | 262 | 262 |  |
  |  | 263 | = 4.5.4 = |
  |  | 264 | \* Fix : Security: Added current\_user\_can() and nonce checks to some functions |
  |  | 265 |  |
  | 263 | 266 | = 4.5.3 = |
  | 264 | 267 | \* Fix : Security: SQL injection by subscriber users |
* ## [wp-meta-seo/tags/4.5.4/wp-meta-seo.php](/changeset/2870465/wp-meta-seo/tags/4.5.4/wp-meta-seo.php "Show the changeset 2870465 restricted to wp-meta-seo/tags/4.5.4/wp-meta-seo.php")

  | [r2869205](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2869205#L5 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/tags/4.5.4/wp-meta-seo.php?rev=2870465#L5 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Plugin URI: http://www.joomunited.com/wordpress-products/wp-meta-seo |
  | 6 | 6 | \* Description: WP Meta SEO is a plugin for WordPress to fill meta for content, images and main SEO info in a single view. |
  | 7 |  | \* Version: 4.5.~~3~~ |
  |  | 7 | \* Version: 4.5.4 |
  | 8 | 8 | \* Text Domain: wp-meta-seo |
  | 9 | 9 | \* Domain Path: /languages |
  | […](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2869205#L134) | […](/browser/wp-meta-seo/tags/4.5.4/wp-meta-seo.php?rev=2870465#L134) |  |
  | 134 | 134 | \* Plugin version |
  | 135 | 135 | \*/ |
  | 136 |  | define('WPMSEO\_VERSION', '4.5.~~3~~'); |
  |  | 136 | define('WPMSEO\_VERSION', '4.5.4'); |
  | 137 | 137 | } |
  | 138 | 138 |  |
* ## [wp-meta-seo/trunk/assets/js/metaseo\_admin.js](/changeset/2870465/wp-meta-seo/trunk/assets/js/metaseo_admin.js "Show the changeset 2870465 restricted to wp-meta-seo/trunk/assets/js/metaseo_admin.js")

  | [r2594823](/browser/wp-meta-seo/trunk/assets/js/metaseo_admin.js?rev=2594823#L17 "Show revision 2594823 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/assets/js/metaseo_admin.js?rev=2870465#L17 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 17 | 17 | function wpmsIgnore(option, hide, nonce) { |
  | 18 | 18 | jQuery.post(ajaxurl, { |
  | 19 |  | action: "wpms\_set\_ignore" |
  |  | 19 | action: "wpms\_set\_ignore", |
  |  | 20 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 20 | 21 | }, function (data) { |
  | 21 | 22 | if (data) { |
* ## [wp-meta-seo/trunk/assets/js/metaseo\_sitemap.js](/changeset/2870465/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js "Show the changeset 2870465 restricted to wp-meta-seo/trunk/assets/js/metaseo_sitemap.js")

  | [r2522725](/browser/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js?rev=2522725#L321 "Show revision 2522725 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js?rev=2870465#L321 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 321 | 321 | dataType: 'json', |
  | 322 | 322 | data: { |
  | 323 |  | action: 'wpms\_regenerate\_sitemaps' |
  |  | 323 | action: 'wpms\_regenerate\_sitemaps', |
  |  | 324 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 324 | 325 | }, |
  | 325 | 326 | success: function () { |
* ## [wp-meta-seo/trunk/inc/class.metaseo-admin.php](/changeset/2870465/wp-meta-seo/trunk/inc/class.metaseo-admin.php "Show the changeset 2870465 restricted to wp-meta-seo/trunk/inc/class.metaseo-admin.php")

  | [r2869205](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2869205#L1010 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2870465#L1010 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 1010 | 1010 | public function setIgnore() |
  | 1011 | 1011 | { |
  |  | 1012 | if (empty($\_POST['wpms\_nonce']) |
  |  | 1013 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  |  | 1014 | die(); |
  |  | 1015 | } |
  | 1012 | 1016 | if (!current\_user\_can('manage\_options')) { |
  | 1013 | 1017 | wp\_send\_json(false); |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2869205#L4742) | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2870465#L4746) |  |
  | 4742 | 4746 | { |
  | 4743 | 4747 | check\_ajax\_referer('wpms\_nonce', 'wpms\_nonce'); |
  |  | 4748 | if (!current\_user\_can('manage\_options')) { |
  |  | 4749 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 4750 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 4751 | } |
  | 4744 | 4752 |  |
  | 4745 | 4753 | $google\_alanytics = array( |
* ## [wp-meta-seo/trunk/inc/class.metaseo-sitemap.php](/changeset/2870465/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php "Show the changeset 2870465 restricted to wp-meta-seo/trunk/inc/class.metaseo-sitemap.php")

  | [r2810660](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L57 "Show revision 2810660 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465#L57 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 57 | 57 | add\_filter('the\_content', array($this, 'sitemapInContent')); |
  | 58 | 58 | add\_shortcode('wpms\_html\_sitemap', array($this, 'sitemapShortcode')); |
  | 59 |  | add\_action('wp\_ajax\_wpms\_regenerate\_sitemaps', array($this, 'regenerateSitemaps')); |
  |  | 59 | add\_action('wp\_ajax\_wpms\_regenerate\_sitemaps', array($this, 'regenerateSitemapsAjax')); |
  | 60 | 60 | add\_action('wp\_ajax\_wpms\_save\_sitemap\_settings', array($this, 'saveSitemapSettings')); |
  | 61 | 61 | add\_action('wp\_ajax\_wpms\_list\_posts\_category', array($this, 'listPostsCategory')); |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2512) | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465#L2512) |  |
  | 2512 | 2512 | \* Ajax generate sitemap to xml file |
  | 2513 | 2513 | \* |
  |  | 2514 | \* @return void |
  |  | 2515 | \*/ |
  |  | 2516 | public function regenerateSitemapsAjax() |
  |  | 2517 | { |
  |  | 2518 | if (empty($\_POST['wpms\_nonce']) |
  |  | 2519 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  |  | 2520 | die(); |
  |  | 2521 | } |
  |  | 2522 |  |
  |  | 2523 | $this->regenerateSitemaps(); |
  |  | 2524 | } |
  |  | 2525 | /\*\* |
  |  | 2526 | \* Ajax generate sitemap to xml file |
  |  | 2527 | \* |
  | 2514 | 2528 | \* @param string $type Type |
  | 2515 | 2529 | \* |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2518) | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465#L2532) |  |
  | 2518 | 2532 | public function regenerateSitemaps($type = 'ajax') |
  | 2519 | 2533 | { |
  |  | 2534 | if (!current\_user\_can('manage\_options')) { |
  |  | 2535 | if ($type === 'ajax') { |
  |  | 2536 | wp\_send\_json(array('status' => false, 'message' => \_\_('There is no permission here', 'wp-meta-seo'))); |
  |  | 2537 | } else { |
  |  | 2538 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2539 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 2540 | } |
  |  | 2541 | } |
  | 2520 | 2542 | if (! function\_exists('get\_home\_path')) { |
  | 2521 | 2543 | include\_once ABSPATH . '/wp-admin/includes/file.php'; |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2650) | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465#L2672) |  |
  | 2650 | 2672 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2651 | 2673 | die(); |
  |  | 2674 | } |
  |  | 2675 | if (!current\_user\_can('manage\_options')) { |
  |  | 2676 | wp\_send\_json(array('status' => false)); |
  | 2652 | 2677 | } |
  | 2653 | 2678 | set\_time\_limit(0); |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2740) | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465#L2765) |  |
  | 2740 | 2765 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2741 | 2766 | die(); |
  |  | 2767 | } |
  |  | 2768 | if (!current\_user\_can('manage\_options')) { |
  |  | 2769 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2770 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  | 2742 | 2771 | } |
  | 2743 | 2772 |  |
  | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L2924) | […](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465#L2953) |  |
  | 2924 | 2953 | die(); |
  | 2925 | 2954 | } |
  |  | 2955 | if (!current\_user\_can('manage\_options')) { |
  |  | 2956 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2957 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 2958 | } |
  | 2926 | 2959 | $post\_in\_category = array(); |
  | 2927 | 2960 | $post\_in\_sitemap = array(); |
* ## [wp-meta-seo/trunk/readme.txt](/changeset/2870465/wp-meta-seo/trunk/readme.txt "Show the changeset 2870465 restricted to wp-meta-seo/trunk/readme.txt")

  | [r2869205](/browser/wp-meta-seo/trunk/readme.txt?rev=2869205#L4 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/readme.txt?rev=2870465#L4 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.7 |
  | 5 | 5 | Tested up to: 6.1 |
  | 6 |  | Stable tag: 4.5.~~3~~ |
  |  | 6 | Stable tag: 4.5.4 |
  | 7 | 7 | Requires PHP: 5.6 |
  | 8 | 8 | License: GPLv2 or later |
  | […](/browser/wp-meta-seo/trunk/readme.txt?rev=2869205#L261) | […](/browser/wp-meta-seo/trunk/readme.txt?rev=2870465#L261) |  |
  | 261 | 261 | == Changelog == |
  | 262 | 262 |  |
  |  | 263 | = 4.5.4 = |
  |  | 264 | \* Fix : Security: Added current\_user\_can() and nonce checks to some functions |
  |  | 265 |  |
  | 263 | 266 | = 4.5.3 = |
  | 264 | 267 | \* Fix : Security: SQL injection by subscriber users |
* ## [wp-meta-seo/trunk/wp-meta-seo.php](/changeset/2870465/wp-meta-seo/trunk/wp-meta-seo.php "Show the changeset 2870465 restricted to wp-meta-seo/trunk/wp-meta-seo.php")

  | [r2869205](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2869205#L5 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2870465#L5 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Plugin URI: http://www.joomunited.com/wordpress-products/wp-meta-seo |
  | 6 | 6 | \* Description: WP Meta SEO is a plugin for WordPress to fill meta for content, images and main SEO info in a single view. |
  | 7 |  | \* Version: 4.5.~~3~~ |
  |  | 7 | \* Version: 4.5.4 |
  | 8 | 8 | \* Text Domain: wp-meta-seo |
  | 9 | 9 | \* Domain Path: /languages |
  | […](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2869205#L134) | […](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2870465#L134) |  |
  | 134 | 134 | \* Plugin version |
  | 135 | 135 | \*/ |
  | 136 |  | define('WPMSEO\_VERSION', '4.5.~~3~~'); |
  |  | 136 | define('WPMSEO\_VERSION', '4.5.4'); |
  | 137 | 137 | } |
  | 138 | 138 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2870465)
* [Zip Archive](?format=zip&new=2870465)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_46c9165e_20250114_212142.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2870465%2Fwp-meta-seo%2Ftrunk%3Fcontextall%3D1%26old%3D2869205%26old_path%3D%252Fwp-meta-seo%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2869205/wp-meta-seo/trunk?old=2870465&old_path=%2Fwp-meta-seo%2Ftrunk)

---

# Changes in [wp-meta-seo/trunk](/browser/wp-meta-seo/trunk?rev=2870465 "Show entry in browser") [[2869205:2870465]](/log/wp-meta-seo/trunk?rev=2870465&stop_rev=2869205 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[wp-meta-seo/trunk](/browser/wp-meta-seo/trunk?rev=2870465)
Files:

7 edited

* [assets/js/metaseo\_admin.js](/browser/wp-meta-seo/trunk/assets/js/metaseo_admin.js?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [assets/js/metaseo\_sitemap.js](/browser/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [inc/class.metaseo-admin.php](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [inc/class.metaseo-sitemap.php](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [languages/wp-meta-seo-en\_US.mo](/browser/wp-meta-seo/trunk/languages/wp-meta-seo-en_US.mo?rev=2870465 "Show entry in browser")
  (modified)
  ([previous](/browser/wp-meta-seo/trunk/languages/wp-meta-seo-en_US.mo?rev=2869205 "Show previous version in browser"))
* [readme.txt](/browser/wp-meta-seo/trunk/readme.txt?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [wp-meta-seo.php](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2870465 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-meta-seo/trunk/assets/js/metaseo\_admin.js](/changeset/2870465/wp-meta-seo/trunk/assets/js/metaseo_admin.js?old=2594823&old_path=wp-meta-seo%2Ftrunk%2Fassets%2Fjs%2Fmetaseo_admin.js "Show the [2869205:2870465] differences restricted to wp-meta-seo/trunk/assets/js/metaseo_admin.js")

  | [r2869205](/browser/wp-meta-seo/trunk/assets/js/metaseo_admin.js?rev=2594823#L1 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/assets/js/metaseo_admin.js?rev=2870465#L1 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | /\* |
  | 2 | 2 | \* To change this license header, choose License Headers in Project Properties. |
  | 3 | 3 | \* To change this template file, choose Tools | Templates |
  | 4 | 4 | \* and open the template in the editor. |
  | 5 | 5 | \*/ |
  | 6 | 6 | var title\_max\_len = 60; |
  | 7 | 7 | var desc\_max\_len = 143; |
  | 8 | 8 | var keywords\_max\_len = 256; |
  | 9 | 9 | var metaseoValueHolder = {}; |
  | 10 | 10 |  |
  | 11 | 11 | /\*\* |
  | 12 | 12 | \* Set option when disable search engines from indexing this site |
  | 13 | 13 | \* @param option |
  | 14 | 14 | \* @param hide |
  | 15 | 15 | \* @param nonce |
  | 16 | 16 | \*/ |
  | 17 | 17 | function wpmsIgnore(option, hide, nonce) { |
  | 18 | 18 | jQuery.post(ajaxurl, { |
  | 19 |  | action: "wpms\_set\_ignore" |
  |  | 19 | action: "wpms\_set\_ignore", |
  |  | 20 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 20 | 21 | }, function (data) { |
  | 21 | 22 | if (data) { |
  | 22 | 23 | jQuery("#" + hide).hide(); |
  | 23 | 24 | } |
  | 24 | 25 | } |
  | 25 | 26 | ) |
  | 26 | 27 | } |
  | 27 | 28 |  |
  | 28 | 29 | /\*\* |
  | 29 | 30 | \* Clean meta |
  | 30 | 31 | \* @param str string need clean |
  | 31 | 32 | \* @returns {\*} |
  | 32 | 33 | \*/ |
  | 33 | 34 | function metaseo\_clean(str) { |
  | 34 | 35 | if (str === '' || typeof str === "undefined") |
  | 35 | 36 | return ''; |
  | 36 | 37 | try { |
  | 37 | 38 | str = jQuery('<div/>').html(str).text(); |
  | 38 | 39 | str = str.replace(/<\/?[^>]+>/gi, ''); |
  | 39 | 40 | str = str.replace(/\[(.+?)\](.+?\[\/\\1\])?/g, ''); |
  | 40 | 41 | } catch (e) { |
  | 41 | 42 | } |
  | 42 | 43 |  |
  | 43 | 44 | return str; |
  | 44 | 45 | } |
  | 45 | 46 |  |
  | 46 | 47 | var oldTitleValues = {}; |
  | 47 | 48 | var oldKeywordsValues = {}; |
  | 48 | 49 | var oldDescValues = {}; |
  | 49 | 50 |  |
  | 50 | 51 | /\*\* |
  | 51 | 52 | \* Update length number of meta title for post, page, custom post type |
  | 52 | 53 | \* @param metatitle\_id string id of element tag |
  | 53 | 54 | \* @param updateSnippet |
  | 54 | 55 | \*/ |
  | 55 | 56 | function metaseo\_titlelength(metatitle\_id, updateSnippet) { |
  | 56 | 57 | var title = (metaseo\_clean(jQuery('#' + metatitle\_id).val())).trim(); |
  | 57 | 58 | var postid = metatitle\_id.replace('metaseo-metatitle-', ''); |
  | 58 | 59 | var counter\_id = 'metaseo-metatitle-len' + postid; |
  | 59 | 60 | jQuery('#' + counter\_id).text(title\_max\_len - title.length); |
  | 60 | 61 | if (title.length >= title\_max\_len) { |
  | 61 | 62 | jQuery('#' + counter\_id).removeClass('word-74B6FC').addClass('word-exceed');//#FEFB04 |
  | 62 | 63 | } else if (title.length <= 50) { |
  | 63 | 64 | jQuery('#' + counter\_id).removeClass('word-exceed').addClass('word-74B6FC');//#74B6FC |
  | 64 | 65 | } else { |
  | 65 | 66 | jQuery('#' + counter\_id).removeClass('word-exceed word-74B6FC'); |
  | 66 | 67 | } |
  | 67 | 68 |  |
  | 68 | 69 | if (title.length > title\_max\_len) { |
  | 69 | 70 | jQuery('#snippet\_title' + postid).empty().text(title.substr(0, title\_max\_len)); |
  | 70 | 71 | } |
  | 71 | 72 |  |
  | 72 | 73 | if (typeof updateSnippet === "undefined" || updateSnippet !== false) { |
  | 73 | 74 | jQuery('#snippet\_title' + postid).text(title.substr(0, title\_max\_len)); |
  | 74 | 75 | } |
  | 75 | 76 | } |
  | 76 | 77 |  |
  | 77 | 78 | /\*\* |
  | 78 | 79 | \* Update meta title for post, page, custom post type |
  | 79 | 80 | \* @param metatitle\_id string id of element tag |
  | 80 | 81 | \* @param needToSave |
  | 81 | 82 | \*/ |
  | 82 | 83 | function metaseo\_updateTitle(metatitle\_id, needToSave) { |
  | 83 | 84 | var title = (metaseo\_clean(jQuery('#' + metatitle\_id).val())).trim(); |
  | 84 | 85 | var postid = metatitle\_id.replace('metaseo-metatitle-', ''); |
  | 85 | 86 | if (needToSave === true && oldTitleValues[postid] !== title) { |
  | 86 | 87 | saveMetaContentChanges('metatitle', postid, title); |
  | 87 | 88 | } |
  | 88 | 89 |  |
  | 89 | 90 | //Push the new value into the array |
  | 90 | 91 | oldTitleValues[postid] = title; |
  | 91 | 92 | } |
  | 92 | 93 |  |
  | 93 | 94 | /\*\* |
  | 94 | 95 | \* Update length number of meta keyword for post, page, custom post type |
  | 95 | 96 | \* @param metakeywords\_id string id of element tag |
  | 96 | 97 | \*/ |
  | 97 | 98 | function metaseo\_keywordlength(metakeywords\_id) { |
  | 98 | 99 | var keywords = (metaseo\_clean(jQuery('#' + metakeywords\_id).val())).trim(); |
  | 99 | 100 | var postid = metakeywords\_id.replace('metaseo-metakeywords-', ''); |
  | 100 | 101 |  |
  | 101 | 102 | var counter\_id = 'metaseo-metakeywords-len' + postid; |
  | 102 | 103 | jQuery('#' + counter\_id).text(keywords\_max\_len - keywords.length); |
  | 103 | 104 |  |
  | 104 | 105 | if (keywords.length >= keywords\_max\_len) { |
  | 105 | 106 | jQuery('#' + counter\_id).addClass('word-exceed'); |
  | 106 | 107 | } else { |
  | 107 | 108 | jQuery('#' + counter\_id).removeClass('word-exceed'); |
  | 108 | 109 | } |
  | 109 | 110 | } |
  | 110 | 111 |  |
  | 111 | 112 | /\*\* |
  | 112 | 113 | \* Update meta keyword for post, page, custom post type |
  | 113 | 114 | \* @param metakeywords\_id string id of element tag |
  | 114 | 115 | \* @param needToSave |
  | 115 | 116 | \*/ |
  | 116 | 117 | function metaseo\_updatekeywords(metakeywords\_id, needToSave) { |
  | 117 | 118 | var keywords = (metaseo\_clean(jQuery('#' + metakeywords\_id).val())).trim(); |
  | 118 | 119 | var postid = metakeywords\_id.replace('metaseo-metakeywords-', ''); |
  | 119 | 120 | if (needToSave === true && oldKeywordsValues[postid] !== keywords) { |
  | 120 | 121 | saveMetaContentChanges('metakeywords', postid, keywords); |
  | 121 | 122 | } |
  | 122 | 123 |  |
  | 123 | 124 | //Push the new value into the array |
  | 124 | 125 | oldKeywordsValues[postid] = keywords; |
  | 125 | 126 | } |
  | 126 | 127 |  |
  | 127 | 128 |  |
  | 128 | 129 | /\*\* |
  | 129 | 130 | \* remove link |
  | 130 | 131 | \* @param link\_id id of this link |
  | 131 | 132 | \*/ |
  | 132 | 133 | function wpmsRemoveLink(link\_id) { |
  | 133 | 134 | jQuery.ajax({ |
  | 134 | 135 | url: ajaxurl, |
  | 135 | 136 | method: 'POST', |
  | 136 | 137 | dataType: 'json', |
  | 137 | 138 | data: { |
  | 138 | 139 | 'action': 'wpms', |
  | 139 | 140 | 'task': 'remove\_link', |
  | 140 | 141 | 'link\_id': link\_id, |
  | 141 | 142 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 142 | 143 | }, |
  | 143 | 144 | success: function (response) { |
  | 144 | 145 | if (response.status) { |
  | 145 | 146 | jQuery('#record\_' + link\_id).remove(); |
  | 146 | 147 | } |
  | 147 | 148 | } |
  | 148 | 149 | }); |
  | 149 | 150 | } |
  | 150 | 151 |  |
  | 151 | 152 | /\*\* |
  | 152 | 153 | \* Update meta title for link |
  | 153 | 154 | \* @param button\_update |
  | 154 | 155 | \*/ |
  | 155 | 156 | function saveMetaLinkChanges(button\_update) { |
  | 156 | 157 | var link\_id = jQuery(button\_update).closest('tr').data('link'); |
  | 157 | 158 | var meta\_title = jQuery(button\_update).closest('tr').find('.metaseo\_link\_title').val(); |
  | 158 | 159 | meta\_title = (metaseo\_clean(meta\_title)).trim(); |
  | 159 | 160 | jQuery.ajax({ |
  | 160 | 161 | url: ajaxurl, |
  | 161 | 162 | method: 'POST', |
  | 162 | 163 | dataType: 'json', |
  | 163 | 164 | data: { |
  | 164 | 165 | 'action': 'wpms', |
  | 165 | 166 | 'task': 'update\_link', |
  | 166 | 167 | 'link\_id': link\_id, |
  | 167 | 168 | 'meta\_title': meta\_title, |
  | 168 | 169 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 169 | 170 | }, |
  | 170 | 171 | success: function (response) { |
  | 171 | 172 | jQuery(button\_update).closest('tr').find('.wpms\_update\_link').hide(); |
  | 172 | 173 | if (response !== false) { |
  | 173 | 174 | jQuery(button\_update).closest('tr').find('.wpms\_old\_link').val(response.link\_new).change(); |
  | 174 | 175 | jQuery(button\_update).closest('tr').find('.wpms\_mesage\_link').show().fadeIn(3000).delay(200).fadeOut(3000); |
  | 175 | 176 | } else { |
  | 176 | 177 | jQuery(button\_update).closest('tr').find('.wpms\_error\_mesage\_link').show().fadeIn(3000).delay(200).fadeOut(3000); |
  | 177 | 178 | } |
  | 178 | 179 |  |
  | 179 | 180 | } |
  | 180 | 181 | }); |
  | 181 | 182 | } |
  | 182 | 183 |  |
  | 183 | 184 | /\*\* |
  | 184 | 185 | \* Update index for page |
  | 185 | 186 | \* @param page\_id int page ID |
  | 186 | 187 | \* @param index int index value |
  | 187 | 188 | \*/ |
  | 188 | 189 | function metaseo\_update\_pageindex(page\_id, index) { |
  | 189 | 190 | jQuery.ajax({ |
  | 190 | 191 | url: ajaxurl, |
  | 191 | 192 | method: 'POST', |
  | 192 | 193 | dataType: 'json', |
  | 193 | 194 | data: { |
  | 194 | 195 | 'action': 'wpms', |
  | 195 | 196 | 'task': 'update\_pageindex', |
  | 196 | 197 | 'page\_id': page\_id, |
  | 197 | 198 | 'index': index, |
  | 198 | 199 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 199 | 200 | } |
  | 200 | 201 | }); |
  | 201 | 202 | } |
  | 202 | 203 |  |
  | 203 | 204 | /\*\* |
  | 204 | 205 | \* Update follow for page |
  | 205 | 206 | \* @param page\_id int page ID |
  | 206 | 207 | \* @param follow int follow value |
  | 207 | 208 | \*/ |
  | 208 | 209 | function metaseo\_update\_pagefollow(page\_id, follow) { |
  | 209 | 210 | jQuery.ajax({ |
  | 210 | 211 | url: ajaxurl, |
  | 211 | 212 | method: 'POST', |
  | 212 | 213 | dataType: 'json', |
  | 213 | 214 | data: { |
  | 214 | 215 | 'action': 'wpms', |
  | 215 | 216 | 'task': 'update\_pagefollow', |
  | 216 | 217 | 'page\_id': page\_id, |
  | 217 | 218 | 'follow': follow, |
  | 218 | 219 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 219 | 220 | } |
  | 220 | 221 | }); |
  | 221 | 222 | } |
  | 222 | 223 |  |
  | 223 | 224 | /\*\* |
  | 224 | 225 | \* update follow for link |
  | 225 | 226 | \* @param button |
  | 226 | 227 | \*/ |
  | 227 | 228 | function wpmsChangeFollow(button) { |
  | 228 | 229 | var link\_id = jQuery(button).closest('tr').data('link'); |
  | 229 | 230 | var type = jQuery(button).data('type'); |
  | 230 | 231 | var follow = 1; |
  | 231 | 232 | if (type === 'done') { |
  | 232 | 233 | jQuery(button).data('type', 'warning').html('warning'); |
  | 233 | 234 | jQuery(button).removeClass('wpms\_ok').addClass('wpms\_warning'); |
  | 234 | 235 | follow = 0; |
  | 235 | 236 | } else { |
  | 236 | 237 | jQuery(button).data('type', 'done').html('done'); |
  | 237 | 238 | jQuery(button).removeClass('wpms\_warning').addClass('wpms\_ok'); |
  | 238 | 239 | follow = 1; |
  | 239 | 240 | } |
  | 240 | 241 |  |
  | 241 | 242 | jQuery.ajax({ |
  | 242 | 243 | url: ajaxurl, |
  | 243 | 244 | method: 'POST', |
  | 244 | 245 | dataType: 'json', |
  | 245 | 246 | data: { |
  | 246 | 247 | 'action': 'wpms', |
  | 247 | 248 | 'task': 'update\_follow', |
  | 248 | 249 | 'link\_id': link\_id, |
  | 249 | 250 | 'follow': follow, |
  | 250 | 251 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 251 | 252 | } |
  | 252 | 253 | }); |
  | 253 | 254 | } |
  | 254 | 255 |  |
  | 255 | 256 | /\*\* |
  | 256 | 257 | \* Scan link to save to database |
  | 257 | 258 | \* @param $this |
  | 258 | 259 | \*/ |
  | 259 | 260 | function wpmsScanLink($this) { |
  | 260 | 261 | $this.addClass('scaning'); |
  | 261 | 262 | jQuery.ajax({ |
  | 262 | 263 | url: ajaxurl, |
  | 263 | 264 | method: 'POST', |
  | 264 | 265 | dataType: 'json', |
  | 265 | 266 | data: { |
  | 266 | 267 | 'action': 'wpms', |
  | 267 | 268 | 'task': 'scan\_link', |
  | 268 | 269 | 'paged': $this.data('paged'), |
  | 269 | 270 | 'comment\_paged': $this.data('comment\_paged'), |
  | 270 | 271 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 271 | 272 | }, |
  | 272 | 273 | success: function (res) { |
  | 273 | 274 | if (!res.status) { |
  | 274 | 275 | if (res.type === 'limit') { |
  | 275 | 276 | var wpms\_process = jQuery('.wpms\_process').data('w'); |
  | 276 | 277 | var wpms\_process\_new = parseFloat(wpms\_process) + parseFloat(res.percent); |
  | 277 | 278 | if (wpms\_process\_new > 100) |
  | 278 | 279 | wpms\_process\_new = 100; |
  | 279 | 280 | jQuery('.wpms\_process').data('w', wpms\_process\_new).html('<span>' + parseInt(wpms\_process\_new) + '%</span>').css('width', wpms\_process\_new + '%').show(); |
  | 280 | 281 | $this.trigger('click'); |
  | 281 | 282 | } else if (res.type === 'limit\_comment\_content') { |
  | 282 | 283 | wpms\_process = jQuery('.wpms\_process').data('w'); |
  | 283 | 284 | if (wpms\_process < 33.33) |
  | 284 | 285 | wpms\_process = 33.33; |
  | 285 | 286 | wpms\_process\_new = parseFloat(wpms\_process) + parseFloat(res.percent); |
  | 286 | 287 | if (wpms\_process\_new > 100) |
  | 287 | 288 | wpms\_process\_new = 100; |
  | 288 | 289 | jQuery('.wpms\_process').data('w', wpms\_process\_new).html('<span>' + parseInt(wpms\_process\_new) + '%</span>').css('width', wpms\_process\_new + '%').show(); |
  | 289 | 290 | $this.data('comment\_paged', parseInt(res.paged) + 1); |
  | 290 | 291 | $this.trigger('click'); |
  | 291 | 292 | } else { |
  | 292 | 293 | wpms\_process = jQuery('.wpms\_process').data('w'); |
  | 293 | 294 | if (wpms\_process < 66.66) |
  | 294 | 295 | wpms\_process = 66.66; |
  | 295 | 296 | wpms\_process\_new = parseFloat(wpms\_process) + parseFloat(res.percent); |
  | 296 | 297 | if (wpms\_process\_new > 100) |
  | 297 | 298 | wpms\_process\_new = 100; |
  | 298 | 299 | jQuery('.wpms\_process').data('w', wpms\_process\_new).html('<span>' + parseInt(wpms\_process\_new) + '%</span>').css('width', wpms\_process\_new + '%').show(); |
  | 299 | 300 | $this.data('paged', parseInt(res.paged) + 1); |
  | 300 | 301 | $this.trigger('click'); |
  | 301 | 302 | } |
  | 302 | 303 | } else { |
  | 303 | 304 | $this.removeClass('scaning'); |
  | 304 | 305 | jQuery('.wpms\_process').data('w', 100).html('<span>100%</span>').css('width', '100%'); |
  | 305 | 306 | jQuery('#wp-seo-meta-form .spinner').hide(); |
  | 306 | 307 | window.location.assign(document.URL); |
  | 307 | 308 | } |
  | 308 | 309 | } |
  | 309 | 310 | }); |
  | 310 | 311 | } |
  | 311 | 312 |  |
  | 312 | 313 | /\*\* |
  | 313 | 314 | \* Update follow for link |
  | 314 | 315 | \* @param button |
  | 315 | 316 | \*/ |
  | 316 | 317 | function wpmsLinkDoAction(button) { |
  | 317 | 318 | var $this = jQuery(button); |
  | 318 | 319 | var apply = jQuery('.link-apply-action:checked').val(); |
  | 319 | 320 | var type\_follow = jQuery('.link-bulk-action:checked').val(); |
  | 320 | 321 | if (typeof type\_follow === "undefined" || typeof apply === "undefined") { |
  | 321 | 322 | return; |
  | 322 | 323 | } |
  | 323 | 324 |  |
  | 324 | 325 | var action\_name = type\_follow + '\_' + apply; |
  | 325 | 326 | if (action\_name === 'follow\_selected' || action\_name === 'nofollow\_selected' || action\_name === 'copy\_title\_selected') { |
  | 326 | 327 | if (parseInt(action\_name) === 0) |
  | 327 | 328 | return; |
  | 328 | 329 |  |
  | 329 | 330 | var link\_selected = []; |
  | 330 | 331 | jQuery(".metaseo\_link").each(function () { |
  | 331 | 332 | if (jQuery(this).is(':checked')) { |
  | 332 | 333 | link\_selected.push(jQuery(this).val()); |
  | 333 | 334 | } |
  | 334 | 335 | }); |
  | 335 | 336 | if (link\_selected.length === 0) |
  | 336 | 337 | return; |
  | 337 | 338 | var data = { |
  | 338 | 339 | action: 'wpms', |
  | 339 | 340 | task: 'update\_multiplefollow', |
  | 340 | 341 | linkids: link\_selected, |
  | 341 | 342 | action\_name: action\_name, |
  | 342 | 343 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 343 | 344 | }; |
  | 344 | 345 | } else { |
  | 345 | 346 | data = { |
  | 346 | 347 | action: 'wpms', |
  | 347 | 348 | task: 'update\_multiplefollow', |
  | 348 | 349 | action\_name: action\_name, |
  | 349 | 350 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 350 | 351 | }; |
  | 351 | 352 | } |
  | 352 | 353 |  |
  | 353 | 354 | jQuery('.spinner\_apply\_follow').css('visibility', 'visible').show(); |
  | 354 | 355 | jQuery.ajax({ |
  | 355 | 356 | url: ajaxurl, |
  | 356 | 357 | method: 'POST', |
  | 357 | 358 | dataType: 'json', |
  | 358 | 359 | data: data, |
  | 359 | 360 | success: function (response) { |
  | 360 | 361 | if (response.status) { |
  | 361 | 362 | jQuery('.spinner\_apply\_follow').hide(); |
  | 362 | 363 | window.location.assign(document.URL); |
  | 363 | 364 | } else { |
  | 364 | 365 | if (action\_name === 'follow\_all' || action\_name === 'nofollow\_all' || action\_name === 'copy\_title\_all') { |
  | 365 | 366 | if (response.message === 'limit') { |
  | 366 | 367 | $this.trigger('click'); |
  | 367 | 368 | } |
  | 368 | 369 | } |
  | 369 | 370 | } |
  | 370 | 371 | } |
  | 371 | 372 | }); |
  | 372 | 373 | } |
  | 373 | 374 |  |
  | 374 | 375 | /\*\* |
  | 375 | 376 | \* Update length number of meta description for post, page, custom post type |
  | 376 | 377 | \* @param metadesc\_id string id of element tag |
  | 377 | 378 | \*/ |
  | 378 | 379 | function metaseo\_desclength(metadesc\_id) { |
  | 379 | 380 | var desc = (metaseo\_clean(jQuery('#' + metadesc\_id).val())).trim(); |
  | 380 | 381 | var postid = metadesc\_id.replace('metaseo-metadesc-', ''); |
  | 381 | 382 | var counter\_id = 'metaseo-metadesc-len' + postid; |
  | 382 | 383 | jQuery('#' + counter\_id).text(desc\_max\_len - desc.length); |
  | 383 | 384 | if (desc.length >= desc\_max\_len) { |
  | 384 | 385 | jQuery('#' + counter\_id).removeClass('word-74B6FC').addClass('word-exceed');//#FEFB04 |
  | 385 | 386 | } else if (desc.length <= 120) { |
  | 386 | 387 | jQuery('#' + counter\_id).removeClass('word-exceed').addClass('word-74B6FC');//#74B6FC |
  | 387 | 388 | } else { |
  | 388 | 389 | jQuery('#' + counter\_id).removeClass('word-exceed word-74B6FC'); |
  | 389 | 390 | } |
  | 390 | 391 |  |
  | 391 | 392 | jQuery('#snippet\_desc' + postid).text(desc.substr(0, desc\_max\_len)); |
  | 392 | 393 | } |
  | 393 | 394 |  |
  | 394 | 395 |  |
  | 395 | 396 | /\*\* |
  | 396 | 397 | \* Update meta description for post, page, custom post type |
  | 397 | 398 | \* @param metadesc\_id |
  | 398 | 399 | \* @param needToSave |
  | 399 | 400 | \*/ |
  | 400 | 401 | function metaseo\_updateDesc(metadesc\_id, needToSave) { |
  | 401 | 402 | var desc = (metaseo\_clean(jQuery('#' + metadesc\_id).val())).trim(); |
  | 402 | 403 | var postid = metadesc\_id.replace('metaseo-metadesc-', ''); |
  | 403 | 404 | if (needToSave === true && oldDescValues[postid] !== desc) { |
  | 404 | 405 | saveMetaContentChanges('metadesc', postid, desc); |
  | 405 | 406 | } |
  | 406 | 407 |  |
  | 407 | 408 | //Push the new value into the array |
  | 408 | 409 | oldDescValues[postid] = desc; |
  | 409 | 410 | } |
  | 410 | 411 |  |
  | 411 | 412 | var autosaveNotification; |
  | 412 | 413 |  |
  | 413 | 414 | /\*\* |
  | 414 | 415 | \* Update content meta |
  | 415 | 416 | \* @param metakey |
  | 416 | 417 | \* @param postid |
  | 417 | 418 | \* @param data |
  | 418 | 419 | \*/ |
  | 419 | 420 | function saveMetaContentChanges(metakey, postid, data) { |
  | 420 | 421 | jQuery('.wpms\_loader' + postid).show(); |
  | 421 | 422 | var postData = { |
  | 422 | 423 | 'action': 'wpms', |
  | 423 | 424 | 'task': 'updateContentMeta', |
  | 424 | 425 | 'metakey': metakey, |
  | 425 | 426 | 'postid': postid, |
  | 426 | 427 | 'value': data, |
  | 427 | 428 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 428 | 429 | }; |
  | 429 | 430 | // We can also pass the url value separately from ajaxurl for front end AJAX implementations |
  | 430 | 431 | jQuery.post(wpms\_localize.ajax\_url, postData, function (response) { |
  | 431 | 432 | jQuery('.wpms\_loader' + postid).hide(); |
  | 432 | 433 | result = JSON.parse(response); |
  | 433 | 434 |  |
  | 434 | 435 | if (result.updated) { |
  | 435 | 436 | autosaveNotification = setTimeout(function () { |
  | 436 | 437 | jQuery('#savedInfo' + postid).text(result.msg); |
  | 437 | 438 | jQuery('#savedInfo' + postid).css('visibility', 'visible'); |
  | 438 | 439 | setTimeout(function () { |
  | 439 | 440 | jQuery('#savedInfo' + postid).css('visibility', 'hidden'); |
  | 440 | 441 | }, 1000); |
  | 441 | 442 | }, 1000); |
  | 442 | 443 | } else { |
  | 443 | 444 | alert(result.msg); |
  | 444 | 445 | } |
  | 445 | 446 |  |
  | 446 | 447 | }); |
  | 447 | 448 | } |
  | 448 | 449 |  |
  | 449 | 450 | function checkspecial(element\_id) { |
  | 450 | 451 | var element = jQuery(element\_id); |
  | 451 | 452 | var meta\_type = element.data('meta-type'); |
  | 452 | 453 |  |
  | 453 | 454 | if (meta\_type === 'change\_image\_name') { |
  | 454 | 455 | var str = (element.val()); |
  | 455 | 456 | return /^[\w\d\-\s+\_.$]\*$/.test(str) != false; |
  | 456 | 457 | } else { |
  | 457 | 458 | return true; |
  | 458 | 459 | } |
  | 459 | 460 | } |
  | 460 | 461 |  |
  | 461 | 462 | function metaseo\_update(element\_id) { |
  | 462 | 463 | var element = jQuery(element\_id); |
  | 463 | 464 | element.data('post-id'); |
  | 464 | 465 | element.data('meta-type'); |
  | 465 | 466 | element.val(); |
  | 466 | 467 | } |
  | 467 | 468 |  |
  | 468 | 469 | /\*\* |
  | 469 | 470 | \* Update meta |
  | 470 | 471 | \* @param element\_id string element id |
  | 471 | 472 | \* @param post\_id int post id |
  | 472 | 473 | \* @param meta\_type string meta type name |
  | 473 | 474 | \* @param meta\_value string meta value |
  | 474 | 475 | \* @returns {boolean} |
  | 475 | 476 | \*/ |
  | 476 | 477 | function saveChanges(element\_id, post\_id, meta\_type, meta\_value) { |
  | 477 | 478 |  |
  | 478 | 479 | var element = jQuery(element\_id); |
  | 479 | 480 | var savedInfo = element.parent().find('span.saved-info'); |
  | 480 | 481 | if (savedInfo.length < 1) { |
  | 481 | 482 | savedInfo = element.closest('td').find('span.saved-info'); |
  | 482 | 483 | } |
  | 483 | 484 |  |
  | 484 | 485 | var updated = false; |
  | 485 | 486 | var postData = { |
  | 486 | 487 | 'action': 'wpms', |
  | 487 | 488 | 'task': 'updateMeta', |
  | 488 | 489 | 'post\_id': post\_id, |
  | 489 | 490 | 'meta\_type': meta\_type, |
  | 490 | 491 | 'meta\_value': meta\_value, |
  | 491 | 492 | 'img\_name': element.closest('tr').find('.fix-metas').data('img-name'), |
  | 492 | 493 | 'opt\_key': element.closest('tr').find('.fix-metas').data('opt-key'), |
  | 493 | 494 | 'addition': { |
  | 494 | 495 | 'meta\_key': element.data('meta-key'), |
  | 495 | 496 | 'meta\_type': element.data('meta-type'), |
  | 496 | 497 | 'meta\_value': element.val(), |
  | 497 | 498 | 'meta\_order': element.data('meta-order'), |
  | 498 | 499 | 'img\_post\_id': element.data('img-post-id'), |
  | 499 | 500 | 'post\_id': element.data('post-id') |
  | 500 | 501 | }, |
  | 501 | 502 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 502 | 503 | }; |
  | 503 | 504 |  |
  | 504 | 505 | // We can also pass the url value separately from ajaxurl for front end AJAX implementations |
  | 505 | 506 | jQuery.ajax({ |
  | 506 | 507 | url: wpms\_localize.ajax\_url, |
  | 507 | 508 | type: 'post', |
  | 508 | 509 | data: postData, |
  | 509 | 510 | dataType: 'json', |
  | 510 | 511 | beforeSend: function () { |
  | 511 | 512 | savedInfo.empty().append('<span class="spinner"></span>'); |
  | 512 | 513 | if (element.hasClass('metaseo-fix-meta')) { |
  | 513 | 514 | element.closest('.metaseo-img-wrapper').find('.spinner').css('visibility', 'visible').show(); |
  | 514 | 515 | } else { |
  | 515 | 516 | element.parent().find('.spinner').css('visibility', 'visible').show(); |
  | 516 | 517 | } |
  | 517 | 518 | }, |
  | 518 | 519 | success: function (response) { |
  | 519 | 520 | if (parseInt(response) === 0) { |
  | 520 | 521 | saveChanges(element\_id, post\_id, meta\_type, meta\_value); |
  | 521 | 522 | } |
  | 522 | 523 |  |
  | 523 | 524 | updated = response.updated; |
  | 524 | 525 |  |
  | 525 | 526 | if (updated) { |
  | 526 | 527 | autosaveNotification = setTimeout(function () { |
  | 527 | 528 |  |
  | 528 | 529 | if (element.hasClass('metaseo-fix-meta')) { |
  | 529 | 530 | element.closest('.metaseo-img-wrapper').find('.spinner').hide(); |
  | 530 | 531 | } else { |
  | 531 | 532 | element.parent().find('.spinner').hide(); |
  | 532 | 533 | } |
  | 533 | 534 |  |
  | 534 | 535 | savedInfo.removeClass('metaseo-msg-warning').addClass('metaseo-msg-success') |
  | 535 | 536 | .text(response.msg).fadeIn(200); |
  | 536 | 537 | setTimeout(function () { |
  | 537 | 538 | savedInfo.empty().append('<span class="spinner"></span>'); |
  | 538 | 539 | savedInfo.hide(); |
  | 539 | 540 | }, 3000); |
  | 540 | 541 |  |
  | 541 | 542 | }, 200); |
  | 542 | 543 |  |
  | 543 | 544 | //update image's data-name attribute |
  | 544 | 545 | if (typeof element.data('extension') !== 'undefined') { |
  | 545 | 546 | jQuery('[data-img-post-id="' + element.data('post-id') + '"]').data('name', element.val() + element.data('extension')); |
  | 546 | 547 | } |
  | 547 | 548 | //Scan post and update post\_meta |
  | 548 | 549 | var img = jQuery('[data-img-post-id="' + postData['addition']['img\_post\_id'] + '"]'); |
  | 549 | 550 | if (img.length > 0) { |
  | 550 | 551 | \_metaSeoScanImages( |
  | 551 | 552 | { |
  | 552 | 553 | 'name': img.data('name'), |
  | 553 | 554 | 'img\_post\_id': postData['addition']['img\_post\_id'], |
  | 554 | 555 | 'type': 'update\_meta' |
  | 555 | 556 | } |
  | 556 | 557 | ); |
  | 557 | 558 | } |
  | 558 | 559 |  |
  | 559 | 560 | if (typeof response.type !== "undefined" && response.type === 'auto\_override') { |
  | 560 | 561 | \_metaSeoScanImages( |
  | 561 | 562 | { |
  | 562 | 563 | 'name': response.imgname, |
  | 563 | 564 | 'img\_post\_id': response.pid, |
  | 564 | 565 | 'type': 'update\_meta' |
  | 565 | 566 | } |
  | 566 | 567 | ); |
  | 567 | 568 | } |
  | 568 | 569 |  |
  | 569 | 570 | if (typeof response.type\_change !== "undefined" && response.type\_change === 'edit\_meta\_alt') { |
  | 570 | 571 | jQuery('#img-alt-' + element.data('img-post-id')).val(element.val()); |
  | 571 | 572 | } |
  | 572 | 573 | } else { |
  | 573 | 574 | element.val(response.iname); |
  | 574 | 575 | savedInfo.removeClass('metaseo-msg-success').addClass('metaseo-msg-warning') |
  | 575 | 576 | .text(response.msg).fadeIn(200).delay(2000).fadeOut(200); |
  | 576 | 577 | } |
  | 577 | 578 | }, |
  | 578 | 579 | error: function () { |
  | 579 | 580 |  |
  | 580 | 581 | } |
  | 581 | 582 | }); |
  | 582 | 583 |  |
  | 583 | 584 | return updated; |
  | 584 | 585 | } |
  | 585 | 586 |  |
  | 586 | 587 | /\*\* |
  | 587 | 588 | \* Scan all posts to find a group of images in their content |
  | 588 | 589 | \*/ |
  | 589 | 590 | function metaSeoScanImages() { |
  | 590 | 591 | var imgs = []; |
  | 591 | 592 | jQuery('.metaseo-image').each(function (i) { |
  | 592 | 593 | if (jQuery(this).data('name') !== '') { |
  | 593 | 594 | imgs[i] = { |
  | 594 | 595 | 'name': jQuery(this).data('name'), |
  | 595 | 596 | 'img\_post\_id': jQuery(this).data('img-post-id') |
  | 596 | 597 | }; |
  | 597 | 598 | } |
  | 598 | 599 | }); |
  | 599 | 600 |  |
  | 600 | 601 | jQuery.each(imgs, function (i, v) { |
  | 601 | 602 | \_metaSeoScanImages(v); |
  | 602 | 603 | }); |
  | 603 | 604 |  |
  | 604 | 605 | } |
  | 605 | 606 |  |
  | 606 | 607 | /\*\* |
  | 607 | 608 | \* Scan images good and not good in post content |
  | 608 | 609 | \* @param imgs array current image info |
  | 609 | 610 | \* @returns {boolean} |
  | 610 | 611 | \* @private |
  | 611 | 612 | \*/ |
  | 612 | 613 | function \_metaSeoScanImages(imgs) { |
  | 613 | 614 | if (imgs.length < 1) { |
  | 614 | 615 | //alert('No images choosen for scanning, please check again!'); |
  | 615 | 616 | return false; |
  | 616 | 617 | } |
  | 617 | 618 |  |
  | 618 | 619 | jQuery.ajax({ |
  | 619 | 620 | url: wpms\_localize.ajax\_url, |
  | 620 | 621 | method: 'post', |
  | 621 | 622 | data: { |
  | 622 | 623 | 'action': 'wpms', |
  | 623 | 624 | 'task': 'scanPosts', |
  | 624 | 625 | 'imgs': imgs, |
  | 625 | 626 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 626 | 627 | }, |
  | 627 | 628 | dataType: 'json', |
  | 628 | 629 | beforeSend: function () { |
  | 629 | 630 | }, |
  | 630 | 631 | success: function (response) { |
  | 631 | 632 | if (parseInt(response) === 0) { |
  | 632 | 633 | \_metaSeoScanImages(imgs); |
  | 633 | 634 | } |
  | 634 | 635 | //clog(imgs); |
  | 635 | 636 | if (response.success === true) { |
  | 636 | 637 | //Clear content holder first |
  | 637 | 638 | if (imgs.length === 1) { |
  | 638 | 639 | jQuery('#opt-info-' + imgs[0]['img\_post\_id']).removeClass('opt-info-warning').empty(); |
  | 639 | 640 | } |
  | 640 | 641 | //id is refered to image post id |
  | 641 | 642 | for (var iID in response.msg) { |
  | 642 | 643 | jQuery('#opt-info-' + iID).html(null); |
  | 643 | 644 | //Change css position property of td tag to default |
  | 644 | 645 | jQuery('#opt-info-' + iID).parent().css('position', 'static'); |
  | 645 | 646 | jQuery('#opt-info-' + iID).append('<p class="btn-wrapper"></p>'); |
  | 646 | 647 |  |
  | 647 | 648 | for (var msgType in response.msg[iID]) { |
  | 648 | 649 | if (response.msg[iID][msgType]['warning'] |
  | 649 | 650 | && !jQuery('#opt-info-' + iID).hasClass('opt-info-warning')) { |
  | 650 | 651 | jQuery('#opt-info-' + iID).addClass('opt-info-warning'); |
  | 651 | 652 | } |
  | 652 | 653 |  |
  | 653 | 654 | jQuery('#opt-info-' + iID).find('p.btn-wrapper').append(response.msg[iID][msgType]['button']); |
  | 654 | 655 | if (typeof response.msg[iID][msgType]['msg'] !== 'object') { |
  | 655 | 656 | var hlight = !response.msg[iID][msgType]['warning'] ? 'metaseo-msg-success' : ''; |
  | 656 | 657 | jQuery('#opt-info-' + iID).prepend('<p class="' + hlight + '">' + response.msg[iID][msgType]['msg'] + '</p>'); |
  | 657 | 658 | } else { |
  | 658 | 659 | for (var k in response.msg[iID][msgType]['msg']) { |
  | 659 | 660 | jQuery('#opt-info-' + iID).prepend('<p>' + response.msg[iID][msgType]['msg'][k] + '</p>'); |
  | 660 | 661 | } |
  | 661 | 662 | } |
  | 662 | 663 |  |
  | 663 | 664 | } |
  | 664 | 665 |  |
  | 665 | 666 | jQuery('#opt-info-' + iID).parent().find('span.metaseo-loading').hide(); |
  | 666 | 667 | } |
  | 667 | 668 |  |
  | 668 | 669 | jQuery('.opt-info-warning').fadeIn(200); |
  | 669 | 670 | jQuery('input.metaseo-checkin').each(function (i, input) { |
  | 670 | 671 | uncheck(input); |
  | 671 | 672 | }); |
  | 672 | 673 | } |
  | 673 | 674 |  |
  | 674 | 675 | // show tooltip when hover 'Fix meta/Edit meta' button |
  | 675 | 676 | tippy('.fix-metas', { |
  | 676 | 677 | animation: 'scale', |
  | 677 | 678 | duration: 0, |
  | 678 | 679 | arrow: false, |
  | 679 | 680 | placement: 'top', |
  | 680 | 681 | theme: 'wpms-widgets-tippy\_show\_arow', |
  | 681 | 682 | onShow(instance) { |
  | 682 | 683 | instance.popper.hidden = instance.reference.dataset.tippy ? false : true; |
  | 683 | 684 | instance.setContent(instance.reference.dataset.tippy); |
  | 684 | 685 | } |
  | 685 | 686 | }); |
  | 686 | 687 | }, |
  | 687 | 688 | error: function () { |
  | 688 | 689 | // alert('Errors occured while scanning posts for optimization'); |
  | 689 | 690 | } |
  | 690 | 691 | }); |
  | 691 | 692 | } |
  | 692 | 693 |  |
  | 693 | 694 | /\*\* |
  | 694 | 695 | \* To fix meta of a specified image |
  | 695 | 696 | \* @param that |
  | 696 | 697 | \*/ |
  | 697 | 698 | function metaseo\_fix\_meta(that) { |
  | 698 | 699 | var $this = jQuery(that); |
  | 699 | 700 |  |
  | 700 | 701 | if (checkspecial(that) === true) { |
  | 701 | 702 |  |
  | 702 | 703 | if (that.jquery === undefined) { |
  | 703 | 704 | $this.bind('input propertychange', function () { |
  | 704 | 705 | metaseo\_update(that); |
  | 705 | 706 | }); |
  | 706 | 707 | } else { |
  | 707 | 708 | metaseo\_update(that); |
  | 708 | 709 | } |
  | 709 | 710 |  |
  | 710 | 711 | } |
  | 711 | 712 | } |
  | 712 | 713 |  |
  | 713 | 714 | /\*\* |
  | 714 | 715 | \* Add meta default |
  | 715 | 716 | \* @param that |
  | 716 | 717 | \*/ |
  | 717 | 718 | function add\_meta\_default(that) { |
  | 718 | 719 | var $this = jQuery(that); |
  | 719 | 720 | var input = $this.parent().find('input'); |
  | 720 | 721 | input.val($this.data('default-value')).focus(); |
  | 721 | 722 | } |
  | 722 | 723 |  |
  | 723 | 724 | //-------------------------------- |
  | 724 | 725 | /\*\* |
  | 725 | 726 | \* Optimize a single post |
  | 726 | 727 | \* @param element string current element |
  | 727 | 728 | \* @returns {boolean} |
  | 728 | 729 | \*/ |
  | 729 | 730 | function optimize\_imgs(element) { |
  | 730 | 731 | var $this = jQuery(element); |
  | 731 | 732 | var post\_id = $this.data('post-id'); |
  | 732 | 733 | var img\_post\_id = $this.data('img-post-id'); |
  | 733 | 734 | var checkin = jQuery('.checkin-' + post\_id); |
  | 734 | 735 | var img\_exclude = []; |
  | 735 | 736 | var not\_checked\_counter = 0; |
  | 736 | 737 | var updated = false; |
  | 737 | 738 |  |
  | 738 | 739 | var j = 0; |
  | 739 | 740 | checkin.each(function (i, el) { |
  | 740 | 741 | if (!(jQuery(el).is(':checked'))) { |
  | 741 | 742 | not\_checked\_counter++; |
  | 742 | 743 | if (jQuery(el).val() !== '' || jQuery(el).val() !== 'undefined') { |
  | 743 | 744 | img\_exclude[j] = parseInt(jQuery(el).val()); |
  | 744 | 745 | j++; |
  | 745 | 746 | } |
  | 746 | 747 | } |
  | 747 | 748 | }); |
  | 748 | 749 |  |
  | 749 | 750 | if (checkin.length <= not\_checked\_counter) { |
  | 750 | 751 | //alert('No images has choosen. \\nPlease click on the checkbox in what image you want to replace!'); |
  | 751 | 752 | return false; |
  | 752 | 753 | } |
  | 753 | 754 |  |
  | 754 | 755 | if (!post\_id && !img\_post\_id) { |
  | 755 | 756 | alert('Cant do the optimization because of missing image ID.\\nPlease check again!'); |
  | 756 | 757 | } else { |
  | 757 | 758 | jQuery.ajax({ |
  | 758 | 759 | url: wpms\_localize.ajax\_url, |
  | 759 | 760 | async: false, |
  | 760 | 761 | data: { |
  | 761 | 762 | 'action': 'wpms', |
  | 762 | 763 | 'task': 'optimize\_imgs', |
  | 763 | 764 | 'post\_id': post\_id, |
  | 764 | 765 | 'img\_post\_id': img\_post\_id, |
  | 765 | 766 | 'img\_exclude': img\_exclude, |
  | 766 | 767 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 767 | 768 | }, |
  | 768 | 769 | dataType: 'json', |
  | 769 | 770 | type: 'post', |
  | 770 | 771 | beforeSend: function () { |
  | 771 | 772 | $this.parent().find('span.spinner').css('visibility', 'visible').show(); |
  | 772 | 773 | }, |
  | 773 | 774 | success: function (response) { |
  | 774 | 775 | if (parseInt(response) === 0) { |
  | 775 | 776 | optimize\_imgs(element); |
  | 776 | 777 | } |
  | 777 | 778 |  |
  | 778 | 779 | if (response.success) { |
  | 779 | 780 | updated = true; |
  | 780 | 781 |  |
  | 781 | 782 | checkin.each(function () { |
  | 782 | 783 | if (jQuery.inArray(parseInt(jQuery(this).val()), img\_exclude) === -1) { |
  | 783 | 784 |  |
  | 784 | 785 | var img\_choosen = jQuery(this).parent(); |
  | 785 | 786 | jQuery(this).remove(); |
  | 786 | 787 |  |
  | 787 | 788 | img\_choosen.empty().append('<span class="metaseo-checked"></span>'); |
  | 788 | 789 | img\_choosen.parent().find('p.metaseo-msg').removeClass('msg-error').addClass('msg-success').empty().text(response.msg).fadeIn(200); |
  | 789 | 790 | setTimeout(function () { |
  | 790 | 791 | img\_choosen.find('p.metaseo-msg').fadeOut(300); |
  | 791 | 792 | }, 5000); |
  | 792 | 793 |  |
  | 793 | 794 | } |
  | 794 | 795 | }); |
  | 795 | 796 |  |
  | 796 | 797 | var checked = jQuery('.checkin-' + post\_id); |
  | 797 | 798 | if (checked.length === 0) { |
  | 798 | 799 | $this.addClass('disabled replaced').removeClass('ju-button waves-effect waves-light').html(wpms\_localize.replaced); |
  | 799 | 800 | } |
  | 800 | 801 |  |
  | 801 | 802 | $this.parent().find('span.spinner').fadeOut(300); |
  | 802 | 803 | //Disable Replace all button if all image were resized |
  | 803 | 804 | var metaseo\_checkin = jQuery('.metaseo-checkin'); |
  | 804 | 805 |  |
  | 805 | 806 | if (metaseo\_checkin.length === 0) { |
  | 806 | 807 | jQuery('#metaseo-replace-all').addClass('disabled'); |
  | 807 | 808 | } |
  | 808 | 809 | //Scan post and update post\_meta |
  | 809 | 810 | var img = jQuery('[data-img-post-id="' + img\_post\_id + '"]'); |
  | 810 | 811 | \_metaSeoScanImages({'name': img.data('name'), 'img\_post\_id': img\_post\_id}); |
  | 811 | 812 |  |
  | 812 | 813 | setTimeout(function () { |
  | 813 | 814 | window.location.reload(true); |
  | 814 | 815 | }, 1000); |
  | 815 | 816 | } else { |
  | 816 | 817 | $this.parent().find('span.spinner').hide(); |
  | 817 | 818 | $this.parent().find('p.metaseo-msg').removeClass('msg-success').addClass('msg-error'); |
  | 818 | 819 | } |
  | 819 | 820 |  |
  | 820 | 821 | }, |
  | 821 | 822 | error: function () { |
  | 822 | 823 |  |
  | 823 | 824 | } |
  | 824 | 825 | }); |
  | 825 | 826 | } |
  | 826 | 827 |  |
  | 827 | 828 | img\_exclude = []; |
  | 828 | 829 | return updated; |
  | 829 | 830 | } |
  | 830 | 831 |  |
  | 831 | 832 | /\*\* |
  | 832 | 833 | \* Optimize all posts in list displayed |
  | 833 | 834 | \* @param that |
  | 834 | 835 | \*/ |
  | 835 | 836 | function optimize\_imgs\_group(that) { |
  | 836 | 837 | jQuery('a.metaseo-optimize').each(function (i, el) { |
  | 837 | 838 | if (parseInt(i) === 0) { |
  | 838 | 839 | jQuery(that).parent().find('span.spinner').show(); |
  | 839 | 840 | } |
  | 840 | 841 |  |
  | 841 | 842 | jQuery(this).trigger('click'); |
  | 842 | 843 |  |
  | 843 | 844 | if (parseInt(i) === (jQuery(el).length - 1)) { |
  | 844 | 845 | jQuery(that).parent().find('span.spinner').hide(); |
  | 845 | 846 | } |
  | 846 | 847 | }); |
  | 847 | 848 |  |
  | 848 | 849 | } |
  | 849 | 850 |  |
  | 850 | 851 | /\*\* |
  | 851 | 852 | \* disable Replace images |
  | 852 | 853 | \* @param that |
  | 853 | 854 | \*/ |
  | 854 | 855 | function uncheck(that) { |
  | 855 | 856 | var post\_id = that.get(0).className.substr(that.get(0).className.lastIndexOf('-') + 1); |
  | 856 | 857 | var checked = jQuery('.checkin-' + post\_id); |
  | 857 | 858 | var not\_checked\_counter = 0; |
  | 858 | 859 |  |
  | 859 | 860 | checked.each(function () { |
  | 860 | 861 | if (!(jQuery(this).is(':checked'))) { |
  | 861 | 862 | not\_checked\_counter++; |
  | 862 | 863 | } |
  | 863 | 864 | }); |
  | 864 | 865 |  |
  | 865 | 866 | //Toggle disable Replace button if all images in a post were resized |
  | 866 | 867 | if (not\_checked\_counter >= checked.length) { |
  | 867 | 868 | jQuery('a.metaseo-optimize[data-post-id="' + post\_id + '"]').addClass('disabled'); |
  | 868 | 869 | } else { |
  | 869 | 870 | jQuery('a.metaseo-optimize[data-post-id="' + post\_id + '"]').removeClass('disabled'); |
  | 870 | 871 | } |
  | 871 | 872 |  |
  | 872 | 873 | //Toggle disable Replace all button if all images in posts were resized |
  | 873 | 874 | var replaceBtns = jQuery('.metaseo-optimize'); |
  | 874 | 875 | var disable = true; |
  | 875 | 876 | replaceBtns.each(function (i, btn) { |
  | 876 | 877 | if (!jQuery(btn).hasClass('disabled')) { |
  | 877 | 878 | disable = false; |
  | 878 | 879 | } |
  | 879 | 880 | }); |
  | 880 | 881 |  |
  | 881 | 882 | if (disable === true) { |
  | 882 | 883 | jQuery('#metaseo-replace-all').addClass('disabled'); |
  | 883 | 884 | } else { |
  | 884 | 885 | jQuery('#metaseo-replace-all').removeClass('disabled'); |
  | 885 | 886 | } |
  | 886 | 887 | } |
  | 887 | 888 |  |
  | 888 | 889 | /\*\* |
  | 889 | 890 | \* Show posts list for resizing or update meta info of an image with specified id |
  | 890 | 891 | \* @param element |
  | 891 | 892 | \*/ |
  | 892 | 893 | function showPostsList(element) { |
  | 893 | 894 | var that = jQuery(element); |
  | 894 | 895 | var data = { |
  | 895 | 896 | 'action': 'wpms', |
  | 896 | 897 | 'task': 'load\_posts', |
  | 897 | 898 | 'img\_name': that.data('img-name'), |
  | 898 | 899 | 'post\_id': that.data('post-id'), |
  | 899 | 900 | 'opt\_key': that.data('opt-key'), |
  | 900 | 901 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 901 | 902 | }; |
  | 902 | 903 |  |
  | 903 | 904 | if (that.data('img-name') !== '') { |
  | 904 | 905 | jQuery.ajax({ |
  | 905 | 906 | url: wpms\_localize.ajax\_url, |
  | 906 | 907 | type: 'post', |
  | 907 | 908 | dataType: 'html', |
  | 908 | 909 | data: data, |
  | 909 | 910 | beforeSend: function () { |
  | 910 | 911 | that.find('.spinner-light').show(); |
  | 911 | 912 | }, |
  | 912 | 913 | success: function (response) { |
  | 913 | 914 | if (parseInt(response) === 0) { |
  | 914 | 915 | showPostsList(element); |
  | 915 | 916 | } |
  | 916 | 917 | that.parent().find('.spinner-light').hide(); |
  | 917 | 918 | that.closest('td.col\_image\_info').find('div.popup > .popup-content').empty().html(response).fadeIn(300); |
  | 918 | 919 |  |
  | 919 | 920 | jQuery('.metaseo-img img').on('click', function () { |
  | 920 | 921 | if (jQuery(this).closest('.metaseo-img-wrapper').hasClass('checked')) { |
  | 921 | 922 | jQuery(this).closest('.metaseo-img-wrapper').removeClass('checked'); |
  | 922 | 923 | jQuery(this).closest('.metaseo-img-wrapper').find('.metaseo-checkin').prop('checked', false); |
  | 923 | 924 | uncheck(jQuery(this).closest('.metaseo-img-wrapper').find('.metaseo-checkin')); |
  | 924 | 925 | } else { |
  | 925 | 926 | jQuery(this).closest('.metaseo-img-wrapper').addClass('checked'); |
  | 926 | 927 | jQuery(this).closest('.metaseo-img-wrapper').find('.metaseo-checkin').prop('checked', true); |
  | 927 | 928 | } |
  | 928 | 929 | }); |
  | 929 | 930 |  |
  | 930 | 931 | //to set background-color of popup-header to like adminmenu active |
  | 931 | 932 | var metaseo\_bg = jQuery('#adminmenu li.wp-has-current-submenu a.wp-has-current-submenu').css('background-color'); |
  | 932 | 933 |  |
  | 933 | 934 | if (metaseo\_bg !== 'undified') { |
  | 934 | 935 | jQuery('.popup-content .content-header').css({'background-color': metaseo\_bg, 'color': '#FFF'}); |
  | 935 | 936 | jQuery('span.popup-close').css({'color': '#FFF'}); |
  | 936 | 937 | } |
  | 937 | 938 |  |
  | 938 | 939 | that.showPopup(that); |
  | 939 | 940 | } |
  | 940 | 941 | }); |
  | 941 | 942 | } else { |
  | 942 | 943 | alert('Something went wrong, please check Image name if it\'s empty before click Resize button'); |
  | 943 | 944 | } |
  | 944 | 945 | } |
  | 945 | 946 |  |
  | 946 | 947 | /\*\* |
  | 947 | 948 | \* Import meta data from other plugin into Wp Meta Seo |
  | 948 | 949 | \* @param that |
  | 949 | 950 | \* @param event |
  | 950 | 951 | \*/ |
  | 951 | 952 | function importMetaData(that, event) { |
  | 952 | 953 | var element = jQuery('#' + that.id); |
  | 953 | 954 |  |
  | 954 | 955 | event.preventDefault(); |
  | 955 | 956 | if (that.id === '\_aio\_' || that.id === '\_yoast\_') { |
  | 956 | 957 | jQuery.ajax({ |
  | 957 | 958 | url: wpms\_localize.ajax\_url, |
  | 958 | 959 | type: 'post', |
  | 959 | 960 | data: { |
  | 960 | 961 | 'action': 'wpms', |
  | 961 | 962 | 'task': 'import\_meta\_data', |
  | 962 | 963 | 'plugin': that.id, |
  | 963 | 964 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 964 | 965 | }, |
  | 965 | 966 | dataType: 'json', |
  | 966 | 967 | beforeSend: function () { |
  | 967 | 968 | element.find('span.spinner-light').show(); |
  | 968 | 969 | }, |
  | 969 | 970 | success: function (response) { |
  | 970 | 971 | if (response.success) { |
  | 971 | 972 | element.find('span.spinner-light').fadeOut(500); |
  | 972 | 973 | jQuery('.metaseo-import-wrn').closest('.error').fadeOut(1500); |
  | 973 | 974 | //Refresh the page to see al changed after import Yoast or AIO data into MetaSEO |
  | 974 | 975 | if (location.href.search('page=metaseo\_content\_meta') !== -1) { |
  | 975 | 976 | location.reload(); |
  | 976 | 977 | } |
  | 977 | 978 | } |
  | 978 | 979 | }, |
  | 979 | 980 | error: function () { |
  | 980 | 981 | alert('Something went wrong in import processing!'); |
  | 981 | 982 | } |
  | 982 | 983 |  |
  | 983 | 984 | }); |
  | 984 | 985 | } |
  | 985 | 986 | } |
  | 986 | 987 |  |
  | 987 | 988 | /\*\* |
  | 988 | 989 | \* Update once input changed and blur |
  | 989 | 990 | \* @param that |
  | 990 | 991 | \*/ |
  | 991 | 992 | function updateInputBlur(that) { |
  | 992 | 993 | var element = jQuery(that); |
  | 993 | 994 | var post\_id = element.data('post-id'); |
  | 994 | 995 | var meta\_type = element.data('meta-type'); |
  | 995 | 996 | var meta\_value = element.val(); |
  | 996 | 997 | if (saveChanges(that, post\_id, meta\_type, meta\_value)) { |
  | 997 | 998 | if (meta\_type === 'change\_image\_name') { |
  | 998 | 999 | jQuery('a.img-resize[data-post-id="' + post\_id + '"]').data('img-name', meta\_value); |
  | 999 | 1000 | } |
  | 1000 | 1001 | } |
  | 1001 | 1002 | } |
  | 1002 | 1003 |  |
  | 1003 | 1004 | /\*\* |
  | 1004 | 1005 | \* Check keypress Code |
  | 1005 | 1006 | \* @param event |
  | 1006 | 1007 | \* @returns {boolean} |
  | 1007 | 1008 | \*/ |
  | 1008 | 1009 | function checkeyCode(event) { |
  | 1009 | 1010 | if (parseInt(event.which) === 13 || parseInt(event.keyCode) === 13) { |
  | 1010 | 1011 | return false; |
  | 1011 | 1012 | } |
  | 1012 | 1013 | } |
  | 1013 | 1014 |  |
  | 1014 | 1015 | /\*\* |
  | 1015 | 1016 | \* Check if a image name is valid or not |
  | 1016 | 1017 | \* @param iname string name of image |
  | 1017 | 1018 | \* @returns {\*} |
  | 1018 | 1019 | \*/ |
  | 1019 | 1020 | function validateiName(iname) { |
  | 1020 | 1021 | var is\_only\_spaces = iname.length > 0; |
  | 1021 | 1022 | iname = iname.trim(); |
  | 1022 | 1023 | var msg = ''; |
  | 1023 | 1024 |  |
  | 1024 | 1025 | if (iname.length < 1) { |
  | 1025 | 1026 | msg = !is\_only\_spaces ? 'Should not be empty' : 'Should not only spaces'; |
  | 1026 | 1027 | return {msg: msg, name: ''}; |
  | 1027 | 1028 | } |
  | 1028 | 1029 |  |
  | 1029 | 1030 | return {msg: '', name: iname}; |
  | 1030 | 1031 | } |
  | 1031 | 1032 |  |
  | 1032 | 1033 | /\*\* |
  | 1033 | 1034 | \* Scan meta image |
  | 1034 | 1035 | \* @param $this |
  | 1035 | 1036 | \*/ |
  | 1036 | 1037 | function wpms\_image\_scan\_meta($this) { |
  | 1037 | 1038 | $this.addClass('scaning'); |
  | 1038 | 1039 | jQuery.ajax({ |
  | 1039 | 1040 | type: 'POST', |
  | 1040 | 1041 | url: ajaxurl, |
  | 1041 | 1042 | data: { |
  | 1042 | 1043 | action: "wpms", |
  | 1043 | 1044 | task: "image\_scan\_meta", |
  | 1044 | 1045 | paged: $this.data('paged'), |
  | 1045 | 1046 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 1046 | 1047 | }, |
  | 1047 | 1048 | success: function (res) { |
  | 1048 | 1049 | var w = jQuery('.wpms\_process\_meta').data('w'); |
  | 1049 | 1050 |  |
  | 1050 | 1051 |  |
  | 1051 | 1052 | if (res.status === 'error\_time') { |
  | 1052 | 1053 | if (typeof res.percent !== "undefined") { |
  | 1053 | 1054 | var wpms\_process = jQuery('.wpms\_process').data('w'); |
  | 1054 | 1055 | var wpms\_process\_new = parseFloat(wpms\_process) + parseFloat(res.percent); |
  | 1055 | 1056 | if (wpms\_process\_new > 100) |
  | 1056 | 1057 | wpms\_process\_new = 100; |
  | 1057 | 1058 | $this.data('paged', parseInt(res.paged) + 1); |
  | 1058 | 1059 | jQuery('.wpms\_process').data('w', wpms\_process\_new).html('<span>' + parseInt(wpms\_process\_new) + '%</span>').css('width', wpms\_process\_new + '%').show(); |
  | 1059 | 1060 | jQuery('.image\_scan\_meta').trigger('click'); |
  | 1060 | 1061 | } |
  | 1061 | 1062 | } else { |
  | 1062 | 1063 | $this.removeClass('scaning'); |
  | 1063 | 1064 | jQuery('.wpms\_process').data('w', 100).html('<span>100%</span>').css('width', '100%'); |
  | 1064 | 1065 | jQuery('#wp-seo-meta-form .spinner').hide(); |
  | 1065 | 1066 | window.location.assign(document.URL); |
  | 1066 | 1067 | } |
  | 1067 | 1068 | } |
  | 1068 | 1069 | }); |
  | 1069 | 1070 | } |
  | 1070 | 1071 |  |
  | 1071 | 1072 | jQuery(document).ready(function ($) { |
  | 1072 | 1073 | $('.mbulk\_copy').on('click', function () { |
  | 1073 | 1074 | $('.mbulk\_copy').prop('checked', false); |
  | 1074 | 1075 | $(this).prop('checked', true); |
  | 1075 | 1076 | }); |
  | 1076 | 1077 |  |
  | 1077 | 1078 | $('.bulk-action-follow').on('click', function () { |
  | 1078 | 1079 | $('.bulk-action-follow').prop('checked', false); |
  | 1079 | 1080 | $(this).prop('checked', true); |
  | 1080 | 1081 | }); |
  | 1081 | 1082 |  |
  | 1082 | 1083 | $('[name="post\_type\_filter"], .wpms\_duplicate\_meta, .wpms\_lang\_list, .wpms\_post\_visibility').on('change', function () { |
  | 1083 | 1084 | $('#wp-seo-meta-form').submit() |
  | 1084 | 1085 | }); |
  | 1085 | 1086 | $('[name="taxonomy\_filter"], .wpms\_duplicate\_cat\_meta').on('change', function () { |
  | 1086 | 1087 | $('#wp-seo-meta-form').submit() |
  | 1087 | 1088 | }); |
  | 1088 | 1089 |  |
  | 1089 | 1090 | $('#home\_text\_default').on('change', function () { |
  | 1090 | 1091 | if ($(this).is(':checked')) { |
  | 1091 | 1092 | $('.tr\_home\_text').addClass('show').removeClass('hide'); |
  | 1092 | 1093 | } else { |
  | 1093 | 1094 | $('.tr\_home\_text').addClass('hide').removeClass('show'); |
  | 1094 | 1095 | } |
  | 1095 | 1096 | }); |
  | 1096 | 1097 |  |
  | 1097 | 1098 | $('.image\_scan\_meta').on('click', function () { |
  | 1098 | 1099 | wpms\_image\_scan\_meta($(this)); |
  | 1099 | 1100 | }); |
  | 1100 | 1101 |  |
  | 1101 | 1102 | $('.wp-meta-seo\_page\_metaseo\_image\_meta #image-submit').on('click', function (e) { |
  | 1102 | 1103 | e.preventDefault(); |
  | 1103 | 1104 | $('.imgspinner').show().css('visibility', 'visible'); |
  | 1104 | 1105 | $('#wp-seo-meta-form').submit(); |
  | 1105 | 1106 | }); |
  | 1106 | 1107 |  |
  | 1107 | 1108 | //Cursor changes on any ajax start and end |
  | 1108 | 1109 | //Thanks to iambriansreed from stacoverflow.com |
  | 1109 | 1110 | $(document).ajaxStart(function () { |
  | 1110 | 1111 | $('body').css({'cursor': 'wait'}); |
  | 1111 | 1112 | }).ajaxStop(function () { |
  | 1112 | 1113 | $('body').css({'cursor': 'default'}); |
  | 1113 | 1114 | }); |
  | 1114 | 1115 |  |
  | 1115 | 1116 | $('span.pagination-links a.disabled').on('click', function (e) { |
  | 1116 | 1117 | e.preventDefault(); |
  | 1117 | 1118 | }); |
  | 1118 | 1119 |  |
  | 1119 | 1120 | // when change value of per page input in image view |
  | 1120 | 1121 | $('.metaseo\_imgs\_per\_page').on('input propertychange', function () { |
  | 1121 | 1122 | var perpage = $(this).val(); |
  | 1122 | 1123 | $('.metaseo\_imgs\_per\_page').each(function (i, e) { |
  | 1123 | 1124 | if ($(e).val() !== perpage) { |
  | 1124 | 1125 | $(e).val(perpage); |
  | 1125 | 1126 | } |
  | 1126 | 1127 | }); |
  | 1127 | 1128 | }); |
  | 1128 | 1129 |  |
  | 1129 | 1130 | // when change link source filter in link view |
  | 1130 | 1131 | $('.metaseo\_link\_source').on('change', function () { |
  | 1131 | 1132 | var value = $(this).val(); |
  | 1132 | 1133 | $('.metaseo\_link\_source').each(function (i, e) { |
  | 1133 | 1134 | if ($(e).val() !== value) { |
  | 1134 | 1135 | $(e).val(value); |
  | 1135 | 1136 | } |
  | 1136 | 1137 | }); |
  | 1137 | 1138 | }); |
  | 1138 | 1139 |  |
  | 1139 | 1140 | // when change follow value of link in link view |
  | 1140 | 1141 | $('.metaseo\_follow\_action').on('change', function () { |
  | 1141 | 1142 | var value = $(this).val(); |
  | 1142 | 1143 | $('.metaseo\_follow\_action').each(function (i, e) { |
  | 1143 | 1144 | if ($(e).val() !== value) { |
  | 1144 | 1145 | $(e).val(value); |
  | 1145 | 1146 | } |
  | 1146 | 1147 | }); |
  | 1147 | 1148 | }); |
  | 1148 | 1149 |  |
  | 1149 | 1150 | // when change the filter |
  | 1150 | 1151 | $('.metaseo-filter').on('change', function () { |
  | 1151 | 1152 | var value = $(this).val(); |
  | 1152 | 1153 | $('.metaseo-filter').each(function (i, e) { |
  | 1153 | 1154 | if ($(e).val() !== value) { |
  | 1154 | 1155 | $(e).val(value); |
  | 1155 | 1156 | } |
  | 1156 | 1157 | }); |
  | 1157 | 1158 | }); |
  | 1158 | 1159 |  |
  | 1159 | 1160 | // when change 'All images' filter in image view |
  | 1160 | 1161 | $('.meta\_filter').on('change', function () { |
  | 1161 | 1162 | var value = $(this).val(); |
  | 1162 | 1163 | $('.meta\_filter').each(function (i, e) { |
  | 1163 | 1164 | if ($(e).val() !== value) { |
  | 1164 | 1165 | $(e).val(value); |
  | 1165 | 1166 | } |
  | 1166 | 1167 | }); |
  | 1167 | 1168 | }); |
  | 1168 | 1169 |  |
  | 1169 | 1170 | // when change 'Status' filter in 404 view |
  | 1170 | 1171 | $('.redirect\_filter').on('change', function () { |
  | 1171 | 1172 | var value = $(this).val(); |
  | 1172 | 1173 | $('.redirect\_filter').each(function (i, e) { |
  | 1173 | 1174 | if ($(e).val() !== value) { |
  | 1174 | 1175 | $(e).val(value); |
  | 1175 | 1176 | } |
  | 1176 | 1177 | }); |
  | 1177 | 1178 | }); |
  | 1178 | 1179 |  |
  | 1179 | 1180 | // when change broken filter in 404 view |
  | 1180 | 1181 | $('.broken\_filter').on('change', function () { |
  | 1181 | 1182 | var value = $(this).val(); |
  | 1182 | 1183 | $('.broken\_filter').each(function (i, e) { |
  | 1183 | 1184 | if ($(e).val() !== value) { |
  | 1184 | 1185 | $(e).val(value); |
  | 1185 | 1186 | } |
  | 1186 | 1187 | }); |
  | 1187 | 1188 | }); |
  | 1188 | 1189 |  |
  | 1189 | 1190 | // when change 'All meta infomation' filter in content view |
  | 1190 | 1191 | $('.wpms\_duplicate\_meta').on('change', function () { |
  | 1191 | 1192 | var value = $(this).val(); |
  | 1192 | 1193 | $('.wpms\_duplicate\_meta').each(function (i, e) { |
  | 1193 | 1194 | if ($(e).val() !== value) { |
  | 1194 | 1195 | $(e).val(value); |
  | 1195 | 1196 | } |
  | 1196 | 1197 | }); |
  | 1197 | 1198 | }); |
  | 1198 | 1199 |  |
  | 1199 | 1200 | $('.wpms\_post\_visibility').on('change', function () { |
  | 1200 | 1201 | var value = $(this).val(); |
  | 1201 | 1202 | $('.wpms\_post\_visibility').each(function (i, e) { |
  | 1202 | 1203 | if ($(e).val() !== value) { |
  | 1203 | 1204 | $(e).val(value); |
  | 1204 | 1205 | } |
  | 1205 | 1206 | }); |
  | 1206 | 1207 | }); |
  | 1207 | 1208 |  |
  | 1208 | 1209 | $('.wpms\_lang\_list').on('change', function () { |
  | 1209 | 1210 | var value = $(this).val(); |
  | 1210 | 1211 | $('.wpms\_lang\_list').each(function (i, e) { |
  | 1211 | 1212 | if ($(e).val() !== value) { |
  | 1212 | 1213 | $(e).val(value); |
  | 1213 | 1214 | } |
  | 1214 | 1215 | }); |
  | 1215 | 1216 | }); |
  | 1216 | 1217 |  |
  | 1217 | 1218 | $('.metaseo-img-name').on('input propertychange', function () { |
  | 1218 | 1219 | var savedInfo = $(this).parent().find('span.saved-info'); |
  | 1219 | 1220 | var iname = validateiName($(this).val()); |
  | 1220 | 1221 | var msg = iname.msg; |
  | 1221 | 1222 | if (iname.name.length > 0) { |
  | 1222 | 1223 | if (!checkspecial(this)) { |
  | 1223 | 1224 | msg = 'Should not special char'; |
  | 1224 | 1225 | } |
  | 1225 | 1226 | } |
  | 1226 | 1227 |  |
  | 1227 | 1228 | if (msg.length > 0) { |
  | 1228 | 1229 | //Set this value to metaseoValueHolder |
  | 1229 | 1230 | metaseoValueHolder[this.id] = iname.name.substr(0, iname.name.length - 1); |
  | 1230 | 1231 |  |
  | 1231 | 1232 | savedInfo.removeClass('metaseo-msg-success') |
  | 1232 | 1233 | .addClass('metaseo-msg-warning').empty().text(msg); |
  | 1233 | 1234 | } |
  | 1234 | 1235 | }); |
  | 1235 | 1236 |  |
  | 1236 | 1237 | $('.metaseo-img-meta').each(function (i, element) { |
  | 1237 | 1238 | if ($(this).hasClass('metaseo-img-name')) { |
  | 1238 | 1239 | metaseoValueHolder[this.id + '\_prev'] = jQuery(this).val(); |
  | 1239 | 1240 | } |
  | 1240 | 1241 | $(element).on('keydown', function (event) { |
  | 1241 | 1242 | if (parseInt(event.which) === 13 || parseInt(event.keyCode) === 13) { |
  | 1242 | 1243 | return false; |
  | 1243 | 1244 | } |
  | 1244 | 1245 | }); |
  | 1245 | 1246 | }); |
  | 1246 | 1247 |  |
  | 1247 | 1248 | $('.metaseo-img-meta').on('change', function () { |
  | 1248 | 1249 | if (jQuery(this).val() === '') { |
  | 1249 | 1250 | jQuery(this).val(metaseoValueHolder[this.id + '\_prev']); |
  | 1250 | 1251 | $(this).parent().find('span.saved-info').empty().append('<span class="spinner"></span>'); |
  | 1251 | 1252 | } |
  | 1252 | 1253 | if (checkspecial(this) === true) { |
  | 1253 | 1254 | updateInputBlur(this); |
  | 1254 | 1255 | } |
  | 1255 | 1256 | }); |
  | 1256 | 1257 |  |
  | 1257 | 1258 | // when import meta |
  | 1258 | 1259 | $('.dissmiss-import').on('click', function (e) { |
  | 1259 | 1260 | e.preventDefault(); |
  | 1260 | 1261 | $(this).closest('.error').fadeOut(1000); |
  | 1261 | 1262 | setTimeout(function () { |
  | 1262 | 1263 | $(this).closest('.error').remove(); |
  | 1263 | 1264 | }, 5000); |
  | 1264 | 1265 |  |
  | 1265 | 1266 | var plugin = $(this).parent().find('a.button').attr('id'); |
  | 1266 | 1267 |  |
  | 1267 | 1268 | if (plugin === '\_aio\_' || plugin === '\_yoast\_') { |
  | 1268 | 1269 | $.ajax({ |
  | 1269 | 1270 | url: wpms\_localize.ajax\_url, |
  | 1270 | 1271 | type: 'post', |
  | 1271 | 1272 | data: { |
  | 1272 | 1273 | 'action': 'wpms', |
  | 1273 | 1274 | 'task': 'dismiss\_import\_meta', |
  | 1274 | 1275 | 'plugin': plugin, |
  | 1275 | 1276 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 1276 | 1277 | }, |
  | 1277 | 1278 | dataType: 'json', |
  | 1278 | 1279 | beforeSend: function () { |
  | 1279 | 1280 |  |
  | 1280 | 1281 | }, |
  | 1281 | 1282 | success: function (response) { |
  | 1282 | 1283 | if (response.success !== true) { |
  | 1283 | 1284 | alert('Dismiss failed!'); |
  | 1284 | 1285 | } |
  | 1285 | 1286 | } |
  | 1286 | 1287 | }); |
  | 1287 | 1288 | } |
  | 1288 | 1289 | }); |
  | 1289 | 1290 |  |
  | 1290 | 1291 | // when change follow of post/page in metabox view |
  | 1291 | 1292 | $('.metaseo\_metabox\_follow').on('change', function () { |
  | 1292 | 1293 | var page\_id = $(this).data('post\_id'); |
  | 1293 | 1294 | var follow = $(this).val(); |
  | 1294 | 1295 | metaseo\_update\_pagefollow(page\_id, follow); |
  | 1295 | 1296 | }); |
  | 1296 | 1297 |  |
  | 1297 | 1298 | // when change index of post/page in metabox view |
  | 1298 | 1299 | $('.metaseo\_metabox\_index').on('change', function () { |
  | 1299 | 1300 | var page\_id = $(this).data('post\_id'); |
  | 1300 | 1301 | var index = $(this).val(); |
  | 1301 | 1302 | metaseo\_update\_pageindex(page\_id, index); |
  | 1302 | 1303 | }); |
  | 1303 | 1304 | //---------------------------------------------------------- |
  | 1304 | 1305 | //Pop-up declaration |
  | 1305 | 1306 | $.fn.absoluteCenter = function () { |
  | 1306 | 1307 | this.each(function () { |
  | 1307 | 1308 | $(this).css({ |
  | 1308 | 1309 | 'position': 'fixed', |
  | 1309 | 1310 | 'top': $('div.wrap').offset().top, |
  | 1310 | 1311 | 'left': $('div.wrap').offset().left, |
  | 1311 | 1312 | 'right': '25px', |
  | 1312 | 1313 | 'bottom': '10px' |
  | 1313 | 1314 | }); |
  | 1314 | 1315 | return this; |
  | 1315 | 1316 | }); |
  | 1316 | 1317 | }; |
  | 1317 | 1318 |  |
  | 1318 | 1319 | $.fn.showPopup = function (that) { |
  | 1319 | 1320 | var bg = $('div.popup-bg'); |
  | 1320 | 1321 | var obj = that.closest('.col\_image\_info').find('div.popup'); |
  | 1321 | 1322 | var btnClose = obj.find('.popup-close'); |
  | 1322 | 1323 | bg.animate({opacity: 0.2}, 0).fadeIn(200); |
  | 1323 | 1324 | obj.fadeIn(200).absoluteCenter(); |
  | 1324 | 1325 | btnClose.on('click', function () { |
  | 1325 | 1326 | bg.fadeOut(100); |
  | 1326 | 1327 | obj.fadeOut(100).find('div.popup-content').empty(); |
  | 1327 | 1328 | }); |
  | 1328 | 1329 | bg.on('click', function () { |
  | 1329 | 1330 | btnClose.trigger('click'); |
  | 1330 | 1331 | }); |
  | 1331 | 1332 | $(document).keydown(function (e) { |
  | 1332 | 1333 | if (parseInt(e.keyCode) === 27) { |
  | 1333 | 1334 | btnClose.trigger('click'); |
  | 1334 | 1335 | } |
  | 1335 | 1336 | }); |
  | 1336 | 1337 | return false; |
  | 1337 | 1338 | }; |
  | 1338 | 1339 | $('a.show-popup').on('click', function () { |
  | 1339 | 1340 | $(this).showPopup($(this)); |
  | 1340 | 1341 | }); |
  | 1341 | 1342 |  |
  | 1342 | 1343 |  |
  | 1343 | 1344 | $(".wpms-blocks-active").attr('disabled', 'disabled'); |
  | 1344 | 1345 |  |
  | 1345 | 1346 | $('.custom-bulk-metaseo-metadesc, .custom-bulk-metaseo-metatitle, .wpms-category-title-input, .wpms-category-desc-textarea').on('mouseover', function () { |
  | 1346 | 1347 | $(this).addClass('wpms-mouseover-frame'); |
  | 1347 | 1348 | }).on('mouseout', function () { |
  | 1348 | 1349 | $(this).removeClass('wpms-mouseover-frame'); |
  | 1349 | 1350 | }); |
  | 1350 | 1351 | }); |
  | 1351 | 1352 |  |
  | 1352 | 1353 | function changeSettingProfile(profileId, profileList) { |
  | 1353 | 1354 | let selectedProfile; |
  | 1354 | 1355 | for (let i = 0; i < profileList.length; i++) { |
  | 1355 | 1356 | if (profileList[i][1] === profileId) { |
  | 1356 | 1357 | selectedProfile = profileList[i]; |
  | 1357 | 1358 | break; |
  | 1358 | 1359 | } |
  | 1359 | 1360 | } |
  | 1360 | 1361 | // Select element |
  | 1361 | 1362 | let anonymizeIpElement = document.getElementById('anonymize-ip-tracking'); |
  | 1362 | 1363 | let trackingTypeElement = document.getElementById('gg-tracking-type'); |
  | 1363 | 1364 | let profileElement = document.getElementById('tracking-profile-info'); |
  | 1364 | 1365 | if (profileId == 0 && profileElement != null) { |
  | 1365 | 1366 | profileElement.innerHTML = ''; |
  | 1366 | 1367 | } |
  | 1367 | 1368 | if (profileId != 0 && selectedProfile !== 'undefined') { |
  | 1368 | 1369 | // Setting basic tracking |
  | 1369 | 1370 | if (typeof selectedProfile !== 'undefined' && selectedProfile[4] === 'GA4') { |
  | 1370 | 1371 | anonymizeIpElement.style.display = 'none'; |
  | 1371 | 1372 | trackingTypeElement.style.display = 'none'; |
  | 1372 | 1373 | } else { |
  | 1373 | 1374 | anonymizeIpElement.style.display = 'block'; |
  | 1374 | 1375 | trackingTypeElement.style.display = 'block'; |
  | 1375 | 1376 | } |
  | 1376 | 1377 |  |
  | 1377 | 1378 | // Display select profile info |
  | 1378 | 1379 | let profileInfoHtml = ''; |
  | 1379 | 1380 | if (typeof selectedProfile[0] !== 'undefined' && selectedProfile[0]) profileInfoHtml += 'Profile Name: ' + selectedProfile[0] + '<br>'; |
  | 1380 | 1381 | if (typeof selectedProfile[1] !== 'undefined' && selectedProfile[1]) profileInfoHtml += 'Profile ID: ' + selectedProfile[1] + '<br>'; |
  | 1381 | 1382 | if (typeof selectedProfile[2] !== 'undefined' && selectedProfile[2]) profileInfoHtml += 'Property ID: ' + selectedProfile[2] + '<br>'; |
  | 1382 | 1383 | if (typeof selectedProfile[3] !== 'undefined' && selectedProfile[3]) profileInfoHtml += 'Default URL: ' + selectedProfile[3] + '<br>'; |
  | 1383 | 1384 | if (typeof selectedProfile[4] !== 'undefined' && selectedProfile[4]) profileInfoHtml += 'Property Type: ' + selectedProfile[4] + '<br>'; |
  | 1384 | 1385 | if (typeof selectedProfile[5] !== 'undefined' && selectedProfile[5]) profileInfoHtml += 'Time Shift: ' + selectedProfile[5] + '<br>'; |
  | 1385 | 1386 | if (typeof selectedProfile[6] !== 'undefined' && selectedProfile[6]) profileInfoHtml += 'Time Zone: ' + selectedProfile[6] + '<br>'; |
  | 1386 | 1387 | if (typeof selectedProfile[7] !== 'undefined' && selectedProfile[7]) profileInfoHtml += 'Default Page: ' + selectedProfile[7] + '<br>'; |
  | 1387 | 1388 | if (typeof selectedProfile[8] !== 'undefined' && selectedProfile[8]) profileInfoHtml += 'Measurement ID: ' + selectedProfile[8]; |
  | 1388 | 1389 |  |
  | 1389 | 1390 | if (profileElement != null) { |
  | 1390 | 1391 | profileElement.innerHTML = profileInfoHtml; |
  | 1391 | 1392 | } |
  | 1392 | 1393 | } |
  | 1393 | 1394 |  |
  | 1394 | 1395 |  |
  | 1395 | 1396 | } |
  | 1396 | 1397 |  |
  | 1397 | 1398 | function requireTrackingIdTitle(propertyType) { |
  | 1398 | 1399 | if (propertyType !== 'undefined') { |
  | 1399 | 1400 | if (propertyType === 'analytics4') { |
  | 1400 | 1401 | jQuery('#wpms-trackingId-title > label').text(wpms\_localize.gg\_disconnect\_title.ga4); |
  | 1401 | 1402 | } else if(propertyType === 'tagmanager') { |
  | 1402 | 1403 | jQuery('#wpms-trackingId-title > label').text(wpms\_localize.gg\_disconnect\_title.tagmanager); |
  | 1403 | 1404 | } else { |
  | 1404 | 1405 | jQuery('#wpms-trackingId-title > label').text(wpms\_localize.gg\_disconnect\_title.universal); |
  | 1405 | 1406 | } |
  | 1406 | 1407 | } |
  | 1407 | 1408 | } |
  | 1408 | 1409 |  |
  | 1409 | 1410 | function reloadSelectContainer(data) { |
  | 1410 | 1411 | let selectElement = document.getElementById('wpms-displaySelectContainers'); |
  | 1411 | 1412 | let html = '<option value="0">Select a container</option>'; |
  | 1412 | 1413 | for (let i = 0; i < data.length; i++) { |
  | 1413 | 1414 | html += '<optgroup label="containers/' + data[i]['containerId'] + '">' + |
  | 1414 | 1415 | '<option value="' + data[i]['containerId'] + '">' + data[i]['name'] + '</option>' + |
  | 1415 | 1416 | '</optgroup>' |
  | 1416 | 1417 | } |
  | 1417 | 1418 | if (selectElement) { |
  | 1418 | 1419 | selectElement.innerHTML = html; |
  | 1419 | 1420 | } |
  | 1420 | 1421 | } |
  | 1421 | 1422 |  |
  | 1422 | 1423 | function tagmanagerDisplayAccountInfo(accountList, selectedID) { |
  | 1423 | 1424 | let accountInfo = document.getElementById('wpms-tagmanager-account-info'); |
  | 1424 | 1425 | if (typeof accountList !== 'undefined' && typeof selectedID !== 'undefined') { |
  | 1425 | 1426 | let html = ''; |
  | 1426 | 1427 | let i = 0 |
  | 1427 | 1428 | for (; i < accountList.length; i++) { |
  | 1428 | 1429 | if (accountList[i]['accountId'] === selectedID) { |
  | 1429 | 1430 | break; |
  | 1430 | 1431 | } |
  | 1431 | 1432 | } |
  | 1432 | 1433 | if (accountList[i]['accountId']) html += 'Account ID: ' + accountList[i]['accountId'] + '<br>'; |
  | 1433 | 1434 | if (accountList[i]['name']) html += 'Account Name: ' + accountList[i]['name'] + '<br>'; |
  | 1434 | 1435 |  |
  | 1435 | 1436 | if (accountInfo) { |
  | 1436 | 1437 | accountInfo.innerHTML = html; |
  | 1437 | 1438 | } |
  | 1438 | 1439 | } |
  | 1439 | 1440 | } |
  | 1440 | 1441 |  |
  | 1441 | 1442 | function getSelectedTagManagerAccount(accountList, selectedID) { |
  | 1442 | 1443 | let titleInfo = document.getElementById('wpms-tagmanager-title-info'); |
  | 1443 | 1444 | let accountDiv = document.getElementById('wpms-tagmanager-account-div'); |
  | 1444 | 1445 | let wpmstmInformationDiv = document.getElementById('wpmstm-information'); |
  | 1445 | 1446 |  |
  | 1446 | 1447 | if (typeof selectedID !== 'undefined' && typeof accountList !== 'undefined') { |
  | 1447 | 1448 | if (0 === parseInt(selectedID)) { |
  | 1448 | 1449 | titleInfo.style.display = 'none'; |
  | 1449 | 1450 | accountDiv.style.display = 'none'; |
  | 1450 | 1451 | wpmstmInformationDiv.style.display = 'none'; |
  | 1451 | 1452 | document.getElementById('wpms-displaySelectContainers').innerHTML = '<option value="0">Select a container</option>'; |
  | 1452 | 1453 | document.getElementById('wpms-tagmanager-container-div').style.display = 'none'; |
  | 1453 | 1454 | } |
  | 1454 | 1455 |  |
  | 1455 | 1456 | // Call Tag Manager API to get containers |
  | 1456 | 1457 | if (0 < parseInt(selectedID)) { |
  | 1457 | 1458 | titleInfo.style.display = 'block'; |
  | 1458 | 1459 | wpmstmInformationDiv.style.display = 'block'; |
  | 1459 | 1460 | accountDiv.style.display = 'block'; |
  | 1460 | 1461 | tagmanagerDisplayAccountInfo(accountList, selectedID); |
  | 1461 | 1462 | jQuery.ajax({ |
  | 1462 | 1463 | url: wpms\_localize.ajax\_url, |
  | 1463 | 1464 | type: 'post', |
  | 1464 | 1465 | data: { |
  | 1465 | 1466 | 'accountID': selectedID, |
  | 1466 | 1467 | 'action': 'wpms', |
  | 1467 | 1468 | 'task': 'wpms\_tagmanager\_request\_containers', |
  | 1468 | 1469 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 1469 | 1470 | }, |
  | 1470 | 1471 | dataType: 'json', |
  | 1471 | 1472 | beforeSend: function () { |
  | 1472 | 1473 | jQuery('.load-containers-spinner').css('visibility', 'visible'); |
  | 1473 | 1474 | }, |
  | 1474 | 1475 | success: function (response) { |
  | 1475 | 1476 | reloadSelectContainer(response); |
  | 1476 | 1477 | jQuery('.load-containers-spinner').css('visibility', 'hidden'); |
  | 1477 | 1478 | } |
  | 1478 | 1479 | }); |
  | 1479 | 1480 | } |
  | 1480 | 1481 | } |
  | 1481 | 1482 | } |
  | 1482 | 1483 |  |
  | 1483 | 1484 | function tagmanagerDisplayContainerInfo(container) { |
  | 1484 | 1485 | // Selected element |
  | 1485 | 1486 | let containerInfo = document.getElementById('wpms-tagmanager-container-info'); |
  | 1486 | 1487 |  |
  | 1487 | 1488 | if (typeof container !== 'undefined' && container) { |
  | 1488 | 1489 | let html = ''; |
  | 1489 | 1490 |  |
  | 1490 | 1491 | if (container['containerId']) html += 'Container ID: ' + container['containerId'] + '<br>'; |
  | 1491 | 1492 | if (container['name']) html += 'Container Name: ' + container['name'] + '<br>'; |
  | 1492 | 1493 | if (container['path']) html += 'Container Path: ' + container['path'] + '<br>'; |
  | 1493 | 1494 | if (container['publicId']) html += 'Public ID: ' + container['publicId'] + '<br>'; |
  | 1494 | 1495 | if (container['usageContext']) html += 'Usage Context: ' + container['usageContext'][0] + '<br>'; |
  | 1495 | 1496 | if (container['notes']) html += 'Notes: ' + container['notes'] + '<br>'; |
  | 1496 | 1497 | if (containerInfo) { |
  | 1497 | 1498 | containerInfo.innerHTML = html; |
  | 1498 | 1499 | } |
  | 1499 | 1500 | } |
  | 1500 | 1501 | } |
  | 1501 | 1502 |  |
  | 1502 | 1503 | function getSelectedTagManagerContainer(selectedID) { |
  | 1503 | 1504 | let containerDiv = document.getElementById('wpms-tagmanager-container-div'); |
  | 1504 | 1505 | if (typeof selectedID !== 'undefined' && selectedID > 1) { |
  | 1505 | 1506 | if (containerDiv) { |
  | 1506 | 1507 | containerDiv.style.display = 'block'; |
  | 1507 | 1508 | } |
  | 1508 | 1509 | jQuery.ajax({ |
  | 1509 | 1510 | url: wpms\_localize.ajax\_url, |
  | 1510 | 1511 | type: 'post', |
  | 1511 | 1512 | data: { |
  | 1512 | 1513 | 'containerID': selectedID, |
  | 1513 | 1514 | 'action': 'wpms', |
  | 1514 | 1515 | 'task': 'wpms\_tagmanager\_container\_info', |
  | 1515 | 1516 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 1516 | 1517 | }, |
  | 1517 | 1518 | dataType: 'json', |
  | 1518 | 1519 | beforeSend: function () { |
  | 1519 | 1520 |  |
  | 1520 | 1521 | }, |
  | 1521 | 1522 | success: function (response) { |
  | 1522 | 1523 | tagmanagerDisplayContainerInfo(response); |
  | 1523 | 1524 | } |
  | 1524 | 1525 | }); |
  | 1525 | 1526 | } else { |
  | 1526 | 1527 | if (containerDiv) { |
  | 1527 | 1528 | containerDiv.style.display = 'none'; |
  | 1528 | 1529 | } |
  | 1529 | 1530 | } |
  | 1530 | 1531 | } |
  | 1531 | 1532 |  |
  | 1532 | 1533 | function reloadContainerInfo() { |
  | 1533 | 1534 | // Selected element |
  | 1534 | 1535 | let containerDiv = document.getElementById('wpms-tagmanager-container-div'); |
  | 1535 | 1536 | if (containerDiv) { |
  | 1536 | 1537 | containerDiv.style.display = 'none'; |
  | 1537 | 1538 | } |
  | 1538 | 1539 | } |
  | 1539 | 1540 |  |
  | 1540 | 1541 | // Javascript display setting account after reload connect with GTM |
  | 1541 | 1542 | function tagmanagerDisplayAccountSetting(accList) { |
  | 1542 | 1543 | // Hide old information |
  | 1543 | 1544 | accountList = accList; // global variable |
  | 1544 | 1545 | document.getElementById('wpmstm-information').style.display = 'none'; |
  | 1545 | 1546 | document.getElementById('wpms-tagmanager-title-info').style.display = 'none'; |
  | 1546 | 1547 | document.getElementById('wpms-displaySelectContainers').innerHTML = '<option value="0">Select a container</option>'; |
  | 1547 | 1548 |  |
  | 1548 | 1549 | // Selected element |
  | 1549 | 1550 | const selectedEl = document.getElementById('wpms-tagmanager-account-setting'); |
  | 1550 | 1551 | let elementHtml = '<lable class="ju-setting-label wpms\_width\_100">' + 'Account:' + '</lable>'; |
  | 1551 | 1552 | if (typeof accList !== 'undefined' && accList[0] !== null) { |
  | 1552 | 1553 | elementHtml += '<p class="p-d-20">' + |
  | 1553 | 1554 | '<label>' + |
  | 1554 | 1555 | '<input type="hidden" name="wpms\_nonce" value="' + wpms\_localize.wpms\_nonce + '">' + |
  | 1555 | 1556 | '<select id="wpms-tagmanager-accounts" class="wpms-large-input wpms\_width\_100" ' + |
  | 1556 | 1557 | 'onchange="reloadContainerInfo()" onclick="getSelectedTagManagerAccount(accountList, this.value)"' + |
  | 1557 | 1558 | 'name="wpms-tagmanager-accounts">' + |
  | 1558 | 1559 | '<option value="0">Select an account</option>'; |
  | 1559 | 1560 | accList.forEach(function (account) { |
  | 1560 | 1561 | elementHtml += '<optgroup label="' + account['path'] + '"><option value="' + account['accountId'] + '">' + account['name'] + '</option></optgroup>'; |
  | 1561 | 1562 | }) |
  | 1562 | 1563 | elementHtml += '</select></label></p>'; |
  | 1563 | 1564 | if (selectedEl) { |
  | 1564 | 1565 | selectedEl.innerHTML = elementHtml; |
  | 1565 | 1566 | } |
  | 1566 | 1567 | } else { |
  | 1567 | 1568 | elementHtml += '<p class="wpms\_width\_50" style="margin: auto;" id="wpms-create-tagmanager-account">' + |
  | 1568 | 1569 | '<a style="border: none; background-color: #00a0d2" class="ju-button orange-button" href="https://tagmanager.google.com/#/admin/accounts/create" target="\_blank">' + |
  | 1569 | 1570 | 'Create an account</a></p>'; |
  | 1570 | 1571 | if (selectedEl) { |
  | 1571 | 1572 | selectedEl.innerHTML = elementHtml; |
  | 1572 | 1573 | } |
  | 1573 | 1574 | } |
  | 1574 | 1575 | } |
  | 1575 | 1576 |  |
  | 1576 | 1577 | // Refresh connection with google tag manager |
  | 1577 | 1578 | function refreshTagmanagerConnect() { |
  | 1578 | 1579 | wpmstm\_refresh\_process = document.getElementById('wpms-refresh-gtm-process'); |
  | 1579 | 1580 | jQuery.ajax({ |
  | 1580 | 1581 | url: wpms\_localize.ajax\_url, |
  | 1581 | 1582 | type: 'post', |
  | 1582 | 1583 | data: { |
  | 1583 | 1584 | 'action': 'wpms', |
  | 1584 | 1585 | 'task': 'wpms\_tagmanager\_refresh\_connect', |
  | 1585 | 1586 | 'wpms\_nonce': wpms\_localize.wpms\_nonce |
  | 1586 | 1587 | }, |
  | 1587 | 1588 | dataType: 'json', |
  | 1588 | 1589 | beforeSend: function () { |
  | 1589 | 1590 | jQuery('.refresh-tm-spinner').css('visibility', 'visible'); |
  | 1590 | 1591 | }, |
  | 1591 | 1592 | success: function (response) { |
  | 1592 | 1593 | if (response) { |
  | 1593 | 1594 | tagmanagerDisplayAccountSetting(response); |
  | 1594 | 1595 | jQuery('.refresh-tm-spinner').css('visibility', 'hidden'); |
  | 1595 | 1596 | wpmsSnackbarModule.show({ |
  | 1596 | 1597 | id: 'wpms-refresh-gtm-success', |
  | 1597 | 1598 | content: "Refresh successfully", |
  | 1598 | 1599 | auto\_close: true, |
  | 1599 | 1600 | is\_progress: true |
  | 1600 | 1601 | }); |
  | 1601 | 1602 | } |
  | 1602 | 1603 | }, |
  | 1603 | 1604 | error: function (jqXHR, textStatus, errorThrown) { |
  | 1604 | 1605 | jQuery('.refresh-tm-spinner').css('visibility', 'hidden'); |
  | 1605 | 1606 | if (textStatus === 'error' && errorThrown === 'Internal Server Error') { |
  | 1606 | 1607 | jQuery('.wpmstm-error-enable-api').removeClass('hidden'); |
  | 1607 | 1608 | setTimeout(function () { |
  | 1608 | 1609 | jQuery('.wpmstm-error-enable-api').addClass('hidden'); |
  | 1609 | 1610 | }, 5000); |
  | 1610 | 1611 | } else { |
  | 1611 | 1612 | jQuery('.wpmstm-error-access-code').removeClass('hidden'); |
  | 1612 | 1613 | setTimeout(function () { |
  | 1613 | 1614 | jQuery('.wpmstm-error-access-code').addClass('hidden'); |
  | 1614 | 1615 | }, 5000); |
  | 1615 | 1616 | } |
  | 1616 | 1617 | } |
  | 1617 | 1618 | }); |
  | 1618 | 1619 | } |
* ## [wp-meta-seo/trunk/assets/js/metaseo\_sitemap.js](/changeset/2870465/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js?old=2522725&old_path=wp-meta-seo%2Ftrunk%2Fassets%2Fjs%2Fmetaseo_sitemap.js "Show the [2869205:2870465] differences restricted to wp-meta-seo/trunk/assets/js/metaseo_sitemap.js")

  | [r2869205](/browser/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js?rev=2522725#L1 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/assets/js/metaseo_sitemap.js?rev=2870465#L1 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | (function ($) { |
  | 2 | 2 | $.fn.hScroll = function (amount) { |
  | 3 | 3 | amount = amount || 120; |
  | 4 | 4 | $(this).on("DOMMouseScroll mousewheel", function (event) { |
  | 5 | 5 | var oEvent = event.originalEvent, |
  | 6 | 6 | direction = oEvent.detail ? oEvent.detail \* -amount : oEvent.wheelDelta, |
  | 7 | 7 | position = $(this).scrollLeft(); |
  | 8 | 8 | position += direction > 0 ? -amount : amount; |
  | 9 | 9 | $(this).scrollLeft(position); |
  | 10 | 10 | event.preventDefault(); |
  | 11 | 11 | }) |
  | 12 | 12 | }; |
  | 13 | 13 |  |
  | 14 | 14 | $(document).ready(function () { |
  | 15 | 15 | $('.ju-horizontal-tabs').hScroll(60); |
  | 16 | 16 |  |
  | 17 | 17 | $('.open-popup-posts-list').magnificPopup({ |
  | 18 | 18 | type:'inline', |
  | 19 | 19 | midClick: true // Allow opening popup on middle mouse click. Always set it to true if you don't provide alternative source in href. |
  | 20 | 20 | }); |
  | 21 | 21 |  |
  | 22 | 22 | $('.open-popup-posts-list').on('click', function () { |
  | 23 | 23 | var category\_id  = $(this).data('category'); |
  | 24 | 24 | var slug  = $(this).data('slug'); |
  | 25 | 25 | if (typeof category\_id === "undefined") { |
  | 26 | 26 | return; |
  | 27 | 27 | } |
  | 28 | 28 |  |
  | 29 | 29 | $('#open-popup-posts-list-'+category\_id+' .list\_posts\_sitemap').html(''); |
  | 30 | 30 | $('.img-links-loader').show(); |
  | 31 | 31 |  |
  | 32 | 32 | $('.list\_posts\_sitemap .img-links-loader').show(); |
  | 33 | 33 | $.ajax({ |
  | 34 | 34 | url: wpms\_localize.ajax\_url, |
  | 35 | 35 | type: 'POST', |
  | 36 | 36 | dataType: 'json', |
  | 37 | 37 | data: { |
  | 38 | 38 | action: 'wpms\_list\_posts\_category', |
  | 39 | 39 | category\_id: category\_id, |
  | 40 | 40 | slug: slug, |
  | 41 | 41 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 42 | 42 | }, |
  | 43 | 43 | success: function (res) { |
  | 44 | 44 | $('.img-links-loader').hide(); |
  | 45 | 45 | $('#open-popup-posts-list-'+category\_id+' .list\_posts\_sitemap').html(res); |
  | 46 | 46 | if ($('#category' + slug + ':checked').length) { |
  | 47 | 47 | $('.category' + slug).prop('checked', true); |
  | 48 | 48 | } |
  | 49 | 49 | } |
  | 50 | 50 | }); |
  | 51 | 51 | }); |
  | 52 | 52 |  |
  | 53 | 53 | /\* |
  | 54 | 54 | \* Paging list posts in sitemap settings |
  | 55 | 55 | \*/ |
  | 56 | 56 | $(".holder\_posts").jPages({ |
  | 57 | 57 | containerID: "wrap\_sitemap\_option\_posts", |
  | 58 | 58 | previous: "←", |
  | 59 | 59 | next: "→", |
  | 60 | 60 | perPage: 100, |
  | 61 | 61 | delay: 20 |
  | 62 | 62 | }); |
  | 63 | 63 |  |
  | 64 | 64 | $.each(wpmseositemap.post\_type,function(i,v){ |
  | 65 | 65 | $(".holder\_"+v).jPages({ |
  | 66 | 66 | containerID: "wrap\_sitemap\_option\_"+v, |
  | 67 | 67 | previous: "←", |
  | 68 | 68 | next: "→", |
  | 69 | 69 | perPage: 100, |
  | 70 | 70 | delay: 20 |
  | 71 | 71 | }); |
  | 72 | 72 | }); |
  | 73 | 73 |  |
  | 74 | 74 | /\* |
  | 75 | 75 | \* Paging list pages in sitemap settings |
  | 76 | 76 | \*/ |
  | 77 | 77 | $(".holder\_pages").jPages({ |
  | 78 | 78 | containerID: "wrap\_sitemap\_option\_pages", |
  | 79 | 79 | previous: "←", |
  | 80 | 80 | next: "→", |
  | 81 | 81 | perPage: 100, |
  | 82 | 82 | delay: 20 |
  | 83 | 83 | }); |
  | 84 | 84 |  |
  | 85 | 85 | /\* |
  | 86 | 86 | \* Paging list custom link |
  | 87 | 87 | \*/ |
  | 88 | 88 | $(".holder\_custom\_url").jPages({ |
  | 89 | 89 | containerID: "wrap\_sitemap\_option\_customUrl", |
  | 90 | 90 | previous: "←", |
  | 91 | 91 | next: "→", |
  | 92 | 92 | perPage: 100, |
  | 93 | 93 | delay: 20 |
  | 94 | 94 | }); |
  | 95 | 95 |  |
  | 96 | 96 | // Open tippy |
  | 97 | 97 | tippy('.wpms\_source .ju-setting-label', { |
  | 98 | 98 | animation: 'scale', |
  | 99 | 99 | duration: 0, |
  | 100 | 100 | arrow: false, |
  | 101 | 101 | placement: 'top', |
  | 102 | 102 | theme: 'metaseo-tippy tippy-rounded', |
  | 103 | 103 | onShow(instance) { |
  | 104 | 104 | instance.popper.hidden = instance.reference.dataset.tippy ? false : true; |
  | 105 | 105 | instance.setContent(instance.reference.dataset.tippy); |
  | 106 | 106 | } |
  | 107 | 107 | }); |
  | 108 | 108 |  |
  | 109 | 109 | if($('#wpms\_html\_sitemap\_theme').length > 0 && $('#wpms\_html\_sitemap\_theme').val() !== 'default'){ |
  | 110 | 110 | $('#wpms\_html\_sitemap\_column').closest('tr').hide(); |
  | 111 | 111 | $('.wpms\_xmp\_custom\_column').hide(); |
  | 112 | 112 | $('.wpms\_xmp\_order').show(); |
  | 113 | 113 | }else{ |
  | 114 | 114 | $('#wpms\_html\_sitemap\_column').closest('tr').show(); |
  | 115 | 115 | $('.wpms\_xmp\_custom\_column').show(); |
  | 116 | 116 | $('.wpms\_xmp\_order').hide(); |
  | 117 | 117 | } |
  | 118 | 118 |  |
  | 119 | 119 | $('#wpms\_html\_sitemap\_theme').on('change',function(){ |
  | 120 | 120 | if($('#wpms\_html\_sitemap\_theme').length > 0 && $('#wpms\_html\_sitemap\_theme').val() !== 'default'){ |
  | 121 | 121 | $('#wpms\_html\_sitemap\_column').closest('tr').hide(); |
  | 122 | 122 | $('.wpms\_xmp\_custom\_column').hide(); |
  | 123 | 123 | $('.wpms\_xmp\_order').show(); |
  | 124 | 124 | }else{ |
  | 125 | 125 | $('#wpms\_html\_sitemap\_column').closest('tr').show(); |
  | 126 | 126 | $('.wpms\_xmp\_custom\_column').show(); |
  | 127 | 127 | $('.wpms\_xmp\_order').hide(); |
  | 128 | 128 | } |
  | 129 | 129 | }); |
  | 130 | 130 |  |
  | 131 | 131 | $('.wpms\_save\_create\_sitemaps').on('click', function () { |
  | 132 | 132 | wpms\_save\_create\_sitemaps(); |
  | 133 | 133 | }); |
  | 134 | 134 |  |
  | 135 | 135 | $('.wpms-sitemap-xml-link-button').on('click', function (e) { |
  | 136 | 136 | e.preventDefault(); |
  | 137 | 137 |  |
  | 138 | 138 | var link\_sitemap = $(this).attr('href'); |
  | 139 | 139 | wpms\_save\_create\_sitemaps(link\_sitemap); |
  | 140 | 140 | }); |
  | 141 | 141 |  |
  | 142 | 142 | $('.wpms-save-popup-posts-button').on('click', function() { |
  | 143 | 143 | wpms\_save\_create\_sitemaps(); |
  | 144 | 144 | }); |
  | 145 | 145 |  |
  | 146 | 146 | /\*\* |
  | 147 | 147 | \* Create sitemap |
  | 148 | 148 | \*/ |
  | 149 | 149 | var wpms\_save\_create\_sitemaps = function (link\_sitemap) { |
  | 150 | 150 | // show spinner |
  | 151 | 151 | $('.spinner\_save\_sitemaps').css({'visibility': 'visible'}).show(); |
  | 152 | 152 | var posts = {}, pages = {}, menus = {}, customUrl = {} ,taxonomies = [], columns\_menu = {}, wpms\_category\_link = [], check\_all\_menu\_items = [], wpms\_category\_select\_all = []; |
  | 153 | 153 | var custom\_post\_type = {}; |
  | 154 | 154 | // get custom post type params to save to sitemap |
  | 155 | 155 | $.each(wpmseositemap.post\_type,function(i,post\_type){ |
  | 156 | 156 | custom\_post\_type[post\_type] = {}; |
  | 157 | 157 | $(".wpms\_xmap\_"+post\_type).each(function (i, v) { |
  | 158 | 158 | if ($(v).is(':checked')) { |
  | 159 | 159 | var id = $(v).val(); |
  | 160 | 160 | var priority = $('#priority\_'+post\_type+'\_' + id).val(); |
  | 161 | 161 | var frequency = $('#frequency\_'+post\_type+'\_' + id).val(); |
  | 162 | 162 | custom\_post\_type[post\_type][id] = {'post\_id': id, 'priority': priority, 'frequency': frequency}; |
  | 163 | 163 | } |
  | 164 | 164 | }); |
  | 165 | 165 | }); |
  | 166 | 166 |  |
  | 167 | 167 | // get custom url params to save to sitemap |
  | 168 | 168 | $(".wpms\_xmap\_customUrl").each(function (i, v) { |
  | 169 | 169 | if ($(v).is(':checked')) { |
  | 170 | 170 | var id = $(v).val(); |
  | 171 | 171 | var priority = $('#priority\_customUrl\_' + id).val(); |
  | 172 | 172 | var frequency = $('#frequency\_customUrl\_' + id).val(); |
  | 173 | 173 | customUrl[id] = {'customUrl\_id': id, 'priority': priority, 'frequency': frequency}; |
  | 174 | 174 | } |
  | 175 | 175 | }); |
  | 176 | 176 |  |
  | 177 | 177 | // get post params to save to sitemap |
  | 178 | 178 | $(".wpms\_xmap\_posts").each(function (i, v) { |
  | 179 | 179 | if ($(v).is(':checked')) { |
  | 180 | 180 | var id = $(v).val(); |
  | 181 | 181 | var priority = $('#priority\_posts\_' + id).val(); |
  | 182 | 182 | var frequency = $('#frequency\_posts\_' + id).val(); |
  | 183 | 183 | posts[id] = {'post\_id': id, 'priority': priority, 'frequency': frequency}; |
  | 184 | 184 | } |
  | 185 | 185 | }); |
  | 186 | 186 |  |
  | 187 | 187 | // get page params to save to sitemap |
  | 188 | 188 | $(".wpms\_xmap\_pages").each(function (i, v) { |
  | 189 | 189 | if ($(v).is(':checked')) { |
  | 190 | 190 | var id = $(v).val(); |
  | 191 | 191 | var priority = $('#priority\_pages\_' + id).val(); |
  | 192 | 192 | var frequency = $('#frequency\_pages\_' + id).val(); |
  | 193 | 193 | pages[id] = {'post\_id': id, 'priority': priority, 'frequency': frequency}; |
  | 194 | 194 | } |
  | 195 | 195 | }); |
  | 196 | 196 |  |
  | 197 | 197 | // get menu params to save to sitemap |
  | 198 | 198 | $(".wpms\_xmap\_menu").each(function (i, v) { |
  | 199 | 199 | if ($(v).is(':checked')) { |
  | 200 | 200 | var id = $(v).val(); |
  | 201 | 201 | var priority = $('#priority\_menu\_' + id).val(); |
  | 202 | 202 | var frequency = $('#frequency\_menu\_' + id).val(); |
  | 203 | 203 | menus[id] = {'menu\_id': id, 'priority': priority, 'frequency': frequency}; |
  | 204 | 204 | } |
  | 205 | 205 | }); |
  | 206 | 206 |  |
  | 207 | 207 | // get category params to save to sitemap |
  | 208 | 208 | $('.wpms\_sitemap\_taxonomies').each(function (i, v) { |
  | 209 | 209 | if ($(v).is(':checked')) { |
  | 210 | 210 | taxonomies.push($(v).val()); |
  | 211 | 211 | } |
  | 212 | 212 | }); |
  | 213 | 213 |  |
  | 214 | 214 | $(".xm\_category\_select\_all").each(function (i, v) { |
  | 215 | 215 | if ($(v).is(':checked')) { |
  | 216 | 216 | wpms\_category\_select\_all.push($(v).val()); |
  | 217 | 217 | } |
  | 218 | 218 | }); |
  | 219 | 219 |  |
  | 220 | 220 | $('.sitemap\_addlink\_categories').each(function (i, v) { |
  | 221 | 221 | if ($(v).is(':checked')) { |
  | 222 | 222 | wpms\_category\_link.push($(v).val()); |
  | 223 | 223 | } |
  | 224 | 224 | }); |
  | 225 | 225 |  |
  | 226 | 226 | $('.check\_all\_menu\_items').each(function (i, v) { |
  | 227 | 227 | if ($(v).is(':checked')) { |
  | 228 | 228 | check\_all\_menu\_items.push($(v).val()); |
  | 229 | 229 | } |
  | 230 | 230 | }); |
  | 231 | 231 |  |
  | 232 | 232 | // get author params to save to sitemap |
  | 233 | 233 | if ($('#wpms\_sitemap\_author').is(':checked')) { |
  | 234 | 234 | var wpms\_sitemap\_author = 1; |
  | 235 | 235 | } else { |
  | 236 | 236 | wpms\_sitemap\_author = 0; |
  | 237 | 237 | } |
  | 238 | 238 |  |
  | 239 | 239 | if ($('#wpms\_sitemap\_root').is(':checked')) { |
  | 240 | 240 | var wpms\_sitemap\_root = 1; |
  | 241 | 241 | } else { |
  | 242 | 242 | wpms\_sitemap\_root = 0; |
  | 243 | 243 | } |
  | 244 | 244 |  |
  | 245 | 245 | if ($('#wpms\_sitemap\_add').is(':checked')) { |
  | 246 | 246 | var wpms\_sitemap\_add = 1; |
  | 247 | 247 | } else { |
  | 248 | 248 | wpms\_sitemap\_add = 0; |
  | 249 | 249 | } |
  | 250 | 250 |  |
  | 251 | 251 | if ($('#wpms\_sitemap\_enable\_core').is(':checked')) { |
  | 252 | 252 | var wpms\_sitemap\_enable\_core = 1; |
  | 253 | 253 | } else { |
  | 254 | 254 | wpms\_sitemap\_enable\_core = 0; |
  | 255 | 255 | } |
  | 256 | 256 |  |
  | 257 | 257 | // get position of menu to save to sitemap |
  | 258 | 258 | $('.wpms\_display\_column\_menus').each(function (i, v) { |
  | 259 | 259 | var menu\_id = $(v).data('menu\_id'); |
  | 260 | 260 | columns\_menu[menu\_id] = $(v).val() |
  | 261 | 261 | }); |
  | 262 | 262 |  |
  | 263 | 263 | var datas = { |
  | 264 | 264 | action: 'wpms\_save\_sitemap\_settings', |
  | 265 | 265 | wpms\_sitemap\_posts: JSON.stringify(posts), |
  | 266 | 266 | wpms\_sitemap\_pages: JSON.stringify(pages), |
  | 267 | 267 | wpms\_sitemap\_menus: JSON.stringify(menus), |
  | 268 | 268 | wpms\_sitemap\_customUrl: JSON.stringify(customUrl), |
  | 269 | 269 | wpms\_html\_sitemap\_page: $('#wpms\_html\_sitemap\_page').val(), |
  | 270 | 270 | wpms\_html\_sitemap\_column: $('#wpms\_html\_sitemap\_column').val(), |
  | 271 | 271 | wpms\_html\_sitemap\_theme: $('#wpms\_html\_sitemap\_theme').val(), |
  | 272 | 272 | wpms\_html\_sitemap\_position: $('#wpms\_html\_sitemap\_position').val(), |
  | 273 | 273 | wpms\_check\_firstsave: $('#wpms\_check\_firstsave').val(), |
  | 274 | 274 | wpms\_sitemap\_author: wpms\_sitemap\_author, |
  | 275 | 275 | wpms\_sitemap\_root: wpms\_sitemap\_root, |
  | 276 | 276 | wpms\_sitemap\_add: wpms\_sitemap\_add, |
  | 277 | 277 | wpms\_sitemap\_enable\_core: wpms\_sitemap\_enable\_core, |
  | 278 | 278 | wpms\_category\_link: wpms\_category\_link, |
  | 279 | 279 | wpms\_category\_select\_all: wpms\_category\_select\_all, |
  | 280 | 280 | check\_all\_menu\_items: check\_all\_menu\_items, |
  | 281 | 281 | wpms\_sitemap\_taxonomies: taxonomies, |
  | 282 | 282 | wpms\_public\_name\_posts: $('.public\_name\_posts').val(), |
  | 283 | 283 | wpms\_public\_name\_pages: $('.public\_name\_pages').val(), |
  | 284 | 284 | wpms\_public\_name\_customUrl: $('.public\_name\_customUrl').val(), |
  | 285 | 285 | wpms\_display\_column\_menus: JSON.stringify(columns\_menu), |
  | 286 | 286 | wpms\_display\_column\_posts: $('.wpms\_display\_column\_posts').val(), |
  | 287 | 287 | wpms\_display\_column\_pages: $('.wpms\_display\_column\_pages').val(), |
  | 288 | 288 | wpms\_display\_column\_customUrl: $('.wpms\_display\_column\_customUrl').val(), |
  | 289 | 289 | wpms\_display\_order\_posts: $('.wpms\_display\_order\_posts').val(), |
  | 290 | 290 | wpms\_display\_order\_pages: $('.wpms\_display\_order\_pages').val(), |
  | 291 | 291 | wpms\_display\_order\_menus: $('.wpms\_display\_order\_menus').val(), |
  | 292 | 292 | wpms\_display\_order\_urls: $('.wpms\_display\_order\_urls').val(), |
  | 293 | 293 | wpms\_lang\_list: $('.wpms\_lang\_list').val(), |
  | 294 | 294 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 295 | 295 | }; |
  | 296 | 296 |  |
  | 297 | 297 | $.each(wpmseositemap.post\_type,function(i,post\_type){ |
  | 298 | 298 | datas['wpms\_sitemap\_'+post\_type] = JSON.stringify(custom\_post\_type[post\_type]); |
  | 299 | 299 | datas['wpms\_display\_column\_'+post\_type] = $('.wpms\_display\_column\_'+post\_type).val(); |
  | 300 | 300 | datas['wpms\_public\_name\_'+post\_type] = $('.public\_name\_'+post\_type).val(); |
  | 301 | 301 | }); |
  | 302 | 302 |  |
  | 303 | 303 | $.ajax({ |
  | 304 | 304 | url: ajaxurl, |
  | 305 | 305 | method: 'POST', |
  | 306 | 306 | dataType: 'json', |
  | 307 | 307 | data: datas, |
  | 308 | 308 | success: function () { |
  | 309 | 309 | wpms\_regen\_sitemaps(link\_sitemap); |
  | 310 | 310 | } |
  | 311 | 311 | }); |
  | 312 | 312 | }; |
  | 313 | 313 |  |
  | 314 | 314 | /\*\* |
  | 315 | 315 | \* Generate sitemaps |
  | 316 | 316 | \*/ |
  | 317 | 317 | var wpms\_regen\_sitemaps = function (link\_sitemap) { |
  | 318 | 318 | $.ajax({ |
  | 319 | 319 | url: ajaxurl, |
  | 320 | 320 | method: 'POST', |
  | 321 | 321 | dataType: 'json', |
  | 322 | 322 | data: { |
  | 323 |  | action: 'wpms\_regenerate\_sitemaps' |
  |  | 323 | action: 'wpms\_regenerate\_sitemaps', |
  |  | 324 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 324 | 325 | }, |
  | 325 | 326 | success: function () { |
  | 326 | 327 | $('.spinner\_save\_sitemaps').hide(); |
  | 327 | 328 | $('.div\_wpms\_save\_sitemaps .msg-success').fadeIn(100).delay(1000).fadeOut(3000); |
  | 328 | 329 |  |
  | 329 | 330 | if (typeof link\_sitemap !== 'undefined') { |
  | 330 | 331 | window.open(link\_sitemap, '\_blank'); |
  | 331 | 332 | window.location.reload(); |
  | 332 | 333 | } |
  | 333 | 334 | } |
  | 334 | 335 | }); |
  | 335 | 336 | }; |
  | 336 | 337 |  |
  | 337 | 338 | /\*\* |
  | 338 | 339 | \* Remove custom url |
  | 339 | 340 | \*/ |
  | 340 | 341 | var wpms\_clear\_customUrl = function(){ |
  | 341 | 342 | $('.wpms\_clear\_customUrl').on('click',function(){ |
  | 342 | 343 | var $this = $(this); |
  | 343 | 344 | var idUrl = $this.closest('.wpms\_row').data('id'); |
  | 344 | 345 | $.ajax({ |
  | 345 | 346 | url: ajaxurl, |
  | 346 | 347 | method: 'POST', |
  | 347 | 348 | dataType: 'json', |
  | 348 | 349 | data: { |
  | 349 | 350 | action: 'wpms\_clear\_customUrl', |
  | 350 | 351 | idUrl: idUrl, |
  | 351 | 352 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 352 | 353 | }, |
  | 353 | 354 | success: function (res) { |
  | 354 | 355 | if(res){ |
  | 355 | 356 | $this.closest('.wpms\_row').remove(); |
  | 356 | 357 | wpms\_regen\_sitemaps(); |
  | 357 | 358 | } |
  | 358 | 359 | } |
  | 359 | 360 | }); |
  | 360 | 361 | }); |
  | 361 | 362 | }; |
  | 362 | 363 |  |
  | 363 | 364 | var wpms\_columns = ['Zezo', 'One', 'Two', 'Three']; |
  | 364 | 365 | $('#wpms\_html\_sitemap\_column').on('change', function () { |
  | 365 | 366 | $('.wpms\_display\_column').html(null); |
  | 366 | 367 | for (var i = 1; i <= parseInt($(this).val()); i++) { |
  | 367 | 368 | $('.wpms\_display\_column').append('<option value="' + i + '">' + wpms\_columns[i] + '</option>'); |
  | 368 | 369 | } |
  | 369 | 370 | }); |
  | 370 | 371 |  |
  | 371 | 372 | $('.xm\_cb\_all').on('click', function () { |
  | 372 | 373 | var category = $(this).data('category'); |
  | 373 | 374 | if ($(this).is(':checked')) { |
  | 374 | 375 | $('.' + category).prop('checked', true); |
  | 375 | 376 | } else { |
  | 376 | 377 | $('.' + category).prop('checked', false); |
  | 377 | 378 | } |
  | 378 | 379 | // Create sitemap automatic |
  | 379 | 380 | wpms\_save\_create\_sitemaps(); |
  | 380 | 381 | }); |
  | 381 | 382 |  |
  | 382 | 383 | $('.xml\_cb\_customposttype\_all').on('click', function () { |
  | 383 | 384 | var posttype = $(this).data('posttype'); |
  | 384 | 385 |  |
  | 385 | 386 | if ($(this).is(':checked')) { |
  | 386 | 387 | $('.cb\_sitemaps\_' + posttype).prop('checked', true); |
  | 387 | 388 | } else { |
  | 388 | 389 | $('.cb\_sitemaps\_' + posttype).prop('checked', false); |
  | 389 | 390 | } |
  | 390 | 391 | }); |
  | 391 | 392 |  |
  | 392 | 393 |  |
  | 393 | 394 | $('.xm\_category\_select\_all').on('click', function () { |
  | 394 | 395 | var categoryID = $(this).val(); |
  | 395 | 396 | var category = $(this).data('category'); |
  | 396 | 397 |  |
  | 397 | 398 | if ($(this).is(':checked')) { |
  | 398 | 399 | $('.' + category).prop('checked', true); |
  | 399 | 400 | is\_all = 1; |
  | 400 | 401 | } else { |
  | 401 | 402 | $('.' + category).prop('checked', false); |
  | 402 | 403 | is\_all = 0; |
  | 403 | 404 | } |
  | 404 | 405 |  |
  | 405 | 406 | var datas = { |
  | 406 | 407 | action: 'wpms\_sitemap\_check\_all\_category', |
  | 407 | 408 | wpms\_sitemap\_category\_id: categoryID, |
  | 408 | 409 | wpms\_sitemap\_cateogry\_is\_all: is\_all, |
  | 409 | 410 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 410 | 411 | }; |
  | 411 | 412 |  |
  | 412 | 413 | $.ajax({ |
  | 413 | 414 | url: ajaxurl, |
  | 414 | 415 | method: 'POST', |
  | 415 | 416 | dataType: 'json', |
  | 416 | 417 | data: datas, |
  | 417 | 418 | success: function () { |
  | 418 | 419 | wpms\_regen\_sitemaps(); |
  | 419 | 420 | } |
  | 420 | 421 | }); |
  | 421 | 422 | }); |
  | 422 | 423 |  |
  | 423 | 424 | // check all |
  | 424 | 425 | $('.sitemap\_check\_all').on('click', function () { |
  | 425 | 426 | var type = $(this).data('type'); |
  | 426 | 427 | if ($(this).is(':checked')) { |
  | 427 | 428 | $('.cb\_sitemaps\_' + type).prop('checked', true); |
  | 428 | 429 | $('.check\_all\_menu\_items').prop('checked', true); |
  | 429 | 430 | $('.xm\_category\_select\_all\_'+ type).prop('checked', true); |
  | 430 | 431 | $('.xml\_cb\_customposttype\_all\_' + type).prop('checked', true); |
  | 431 | 432 | } else { |
  | 432 | 433 | $('.cb\_sitemaps\_' + type).prop('checked', false); |
  | 433 | 434 | $('.check\_all\_menu\_items').prop('checked', false); |
  | 434 | 435 | $('.xm\_category\_select\_all\_'+ type).prop('checked', false); |
  | 435 | 436 | $('.xml\_cb\_customposttype\_all\_' + type).prop('checked', false); |
  | 436 | 437 | } |
  | 437 | 438 | // Create sitemap automatic |
  | 438 | 439 | wpms\_save\_create\_sitemaps(); |
  | 439 | 440 | }); |
  | 440 | 441 |  |
  | 441 | 442 | // Add custom url |
  | 442 | 443 | $('.wpms\_add\_customurl').on('click', function () { |
  | 443 | 444 | if ($('#custom\_url\_link').val() === '' || $('#custom\_url\_title').val() === '') { |
  | 444 | 445 | return; |
  | 445 | 446 | } |
  | 446 | 447 | $('.wpms\_customurl\_spinner').css('visibility','visible').show(); |
  | 447 | 448 | $.ajax({ |
  | 448 | 449 | url: ajaxurl, |
  | 449 | 450 | method: 'POST', |
  | 450 | 451 | dataType: 'json', |
  | 451 | 452 | data: { |
  | 452 | 453 | action : 'wpms\_sitemaps\_add\_customUrl', |
  | 453 | 454 | link: $('#custom\_url\_link').val(), |
  | 454 | 455 | title: $('#custom\_url\_title').val(), |
  | 455 | 456 | wpms\_nonce: wpms\_localize.wpms\_nonce |
  | 456 | 457 | }, |
  | 457 | 458 | success: function (res) { |
  | 458 | 459 | if(res.status){ |
  | 459 | 460 | $('#wrap\_sitemap\_option\_customUrl').append(res.html); |
  | 460 | 461 | wpms\_clear\_customUrl(); |
  | 461 | 462 | } |
  | 462 | 463 | $('.wpms\_customurl\_spinner').hide(); |
  | 463 | 464 | } |
  | 464 | 465 | }); |
  | 465 | 466 | }); |
  | 466 | 467 |  |
  | 467 | 468 | wpms\_clear\_customUrl(); |
  | 468 | 469 | }); |
  | 469 | 470 | }(jQuery)); |
* ## [wp-meta-seo/trunk/inc/class.metaseo-admin.php](/changeset/2870465/wp-meta-seo/trunk/inc/class.metaseo-admin.php?old=2869205&old_path=wp-meta-seo%2Ftrunk%2Finc%2Fclass.metaseo-admin.php "Show the [2869205:2870465] differences restricted to wp-meta-seo/trunk/inc/class.metaseo-admin.php")

  | [r2869205](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2869205#L1 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/inc/class.metaseo-admin.php?rev=2870465#L1 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | /\* Prohibit direct script loading \*/ |
  | 3 | 3 | defined('ABSPATH') || die('No direct script access allowed!'); |
  | 4 | 4 |  |
  | 5 | 5 | /\*\* |
  | 6 | 6 | \* Class MetaSeoAdmin |
  | 7 | 7 | \* Class that holds most of the admin functionality for Meta SEO. |
  | 8 | 8 | \*/ |
  | 9 | 9 | class MetaSeoAdmin |
  | 10 | 10 | { |
  | 11 | 11 |  |
  | 12 | 12 | /\*\* |
  | 13 | 13 | \* Current page |
  | 14 | 14 | \* |
  | 15 | 15 | \* @var mixed |
  | 16 | 16 | \*/ |
  | 17 | 17 | private $pagenow; |
  | 18 | 18 | /\*\* |
  | 19 | 19 | \* Max length meta description |
  | 20 | 20 | \* |
  | 21 | 21 | \* @var integer |
  | 22 | 22 | \*/ |
  | 23 | 23 | public static $desc\_length = 158; |
  | 24 | 24 | /\*\* |
  | 25 | 25 | \* Max length meta title |
  | 26 | 26 | \* |
  | 27 | 27 | \* @var integer |
  | 28 | 28 | \*/ |
  | 29 | 29 | public static $title\_length = 60; |
  | 30 | 30 | /\*\* |
  | 31 | 31 | \* Google client |
  | 32 | 32 | \* |
  | 33 | 33 | \* @var object |
  | 34 | 34 | \*/ |
  | 35 | 35 | public $client; |
  | 36 | 36 | /\*\* |
  | 37 | 37 | \* Default access to connect to google |
  | 38 | 38 | \* |
  | 39 | 39 | \* @var array |
  | 40 | 40 | \*/ |
  | 41 | 41 | public $access = array(WPMS\_CLIENTID, WPMS\_CLIENTSECRET); |
  | 42 | 42 | /\*\* |
  | 43 | 43 | \* Error timeout |
  | 44 | 44 | \* |
  | 45 | 45 | \* @var integer |
  | 46 | 46 | \*/ |
  | 47 | 47 | public $error\_timeout; |
  | 48 | 48 | /\*\* |
  | 49 | 49 | \* List google analytics options |
  | 50 | 50 | \* |
  | 51 | 51 | \* @var array |
  | 52 | 52 | \*/ |
  | 53 | 53 | public $ga\_tracking; |
  | 54 | 54 | /\*\* |
  | 55 | 55 | \* Option to check connect status |
  | 56 | 56 | \* |
  | 57 | 57 | \* @var array |
  | 58 | 58 | \*/ |
  | 59 | 59 | public $gaDisconnect; |
  | 60 | 60 | /\*\* |
  | 61 | 61 | \* Google alanytics options |
  | 62 | 62 | \* |
  | 63 | 63 | \* @var array |
  | 64 | 64 | \*/ |
  | 65 | 65 | public $google\_alanytics; |
  | 66 | 66 |  |
  | 67 | 67 | /\*\* |
  | 68 | 68 | \* Google Tag Manager options setting |
  | 69 | 69 | \* |
  | 70 | 70 | \* @var Google tag manager options |
  | 71 | 71 | \*/ |
  | 72 | 72 | public $google\_tagmanager; |
  | 73 | 73 |  |
  | 74 | 74 | /\*\* |
  | 75 | 75 | \* All settings for meta seo |
  | 76 | 76 | \* |
  | 77 | 77 | \* @var array |
  | 78 | 78 | \*/ |
  | 79 | 79 | public $settings; |
  | 80 | 80 |  |
  | 81 | 81 | /\*\* |
  | 82 | 82 | \* Google service |
  | 83 | 83 | \* |
  | 84 | 84 | \* @var object |
  | 85 | 85 | \*/ |
  | 86 | 86 | public $service; |
  | 87 | 87 |  |
  | 88 | 88 | /\*\* |
  | 89 | 89 | \* MetaSeoAdmin constructor. |
  | 90 | 90 | \*/ |
  | 91 | 91 | public function \_\_construct() |
  | 92 | 92 | { |
  | 93 | 93 | $this->pagenow = $GLOBALS['pagenow']; |
  | 94 | 94 | $this->setErrorTimeout(); |
  | 95 | 95 | $this->initSettings(); |
  | 96 | 96 | $this->initGaSettings(); |
  | 97 | 97 | $this->initGADisconnect(); |
  | 98 | 98 | if (!get\_option('\_wpms\_dash\_last\_update', false)) { |
  | 99 | 99 | update\_option('\_wpms\_dash\_last\_update', time()); |
  | 100 | 100 | } |
  | 101 | 101 |  |
  | 102 | 102 | add\_action('admin\_init', array($this, 'adminRedirects')); |
  | 103 | 103 | add\_action('init', array($this, 'install')); |
  | 104 | 104 | add\_action('admin\_init', array($this, 'adminInit')); |
  | 105 | 105 | add\_action('init', array($this, 'loadLangguage')); |
  | 106 | 106 | add\_action('admin\_menu', array($this, 'addMenuPage')); |
  | 107 | 107 | /\*\* |
  | 108 | 108 | \* Load admin js |
  | 109 | 109 | \*/ |
  | 110 | 110 | add\_action('admin\_enqueue\_scripts', array($this, 'loadAdminScripts')); |
  | 111 | 111 |  |
  | 112 | 112 | if (!class\_exists('MetaSeoContentListTable')) { |
  | 113 | 113 | require\_once(WPMETASEO\_PLUGIN\_DIR . '/inc/class.metaseo-content-list-table.php'); |
  | 114 | 114 | } |
  | 115 | 115 | add\_action('added\_post\_meta', array('MetaSeoContentListTable', 'updateMetaSync'), 99, 4); |
  | 116 | 116 | add\_action('updated\_post\_meta', array('MetaSeoContentListTable', 'updateMetaSync'), 99, 4); |
  | 117 | 117 | add\_action('deleted\_post\_meta', array('MetaSeoContentListTable', 'deleteMetaSync'), 99, 4); |
  | 118 | 118 |  |
  | 119 | 119 | if (!get\_option('wpms\_set\_ignore', false)) { |
  | 120 | 120 | add\_option('wpms\_set\_ignore', 1, '', 'yes'); |
  | 121 | 121 | } |
  | 122 | 122 |  |
  | 123 | 123 | add\_action('wp\_ajax\_wpms\_set\_ignore', array($this, 'setIgnore')); |
  | 124 | 124 | if (0 === (int)get\_option('blog\_public')) { |
  | 125 | 125 | add\_action('admin\_notices', array($this, 'publicWarning')); |
  | 126 | 126 | } |
  | 127 | 127 | add\_action('wp\_enqueue\_editor', array($this, 'linkTitleField'), 20); |
  | 128 | 128 |  |
  | 129 | 129 | if (!class\_exists('MetaSeoBrokenLinkTable')) { |
  | 130 | 130 | require\_once(WPMETASEO\_PLUGIN\_DIR . '/inc/class.metaseo-broken-link-table.php'); |
  | 131 | 131 | } |
  | 132 | 132 | add\_action('post\_updated', array('MetaSeoBrokenLinkTable', 'updatePost'), 10, 3); |
  | 133 | 133 | add\_action('delete\_post', array('MetaSeoBrokenLinkTable', 'deletePost')); |
  | 134 | 134 | add\_action('edit\_comment', array('MetaSeoBrokenLinkTable', 'updateComment')); |
  | 135 | 135 | add\_action('deleted\_comment', array('MetaSeoBrokenLinkTable', 'deletedComment')); |
  | 136 | 136 | add\_action('admin\_head', array('MetaSeoContentListTable', 'customStyles')); |
  | 137 | 137 |  |
  | 138 | 138 | add\_action('admin\_footer', array($this, 'editorFooter')); |
  | 139 | 139 | add\_action('wp\_dashboard\_setup', array($this, 'addDashboardWidgets')); |
  | 140 | 140 | add\_action('category\_add\_form\_fields', array($this, 'categoryField'), 10, 2); |
  | 141 | 141 | add\_action('category\_edit\_form\_fields', array($this, 'editCategoryFields')); |
  | 142 | 142 | add\_action('edited\_category', array($this, 'saveCategoryMeta'), 10, 2); |
  | 143 | 143 | add\_action('create\_category', array($this, 'saveCategoryMeta'), 10, 2); |
  | 144 | 144 |  |
  | 145 | 145 | if (!class\_exists('MetaSeoImageListTable')) { |
  | 146 | 146 | require\_once(WPMETASEO\_PLUGIN\_DIR . '/inc/class.metaseo-image-list-table.php'); |
  | 147 | 147 | } |
  | 148 | 148 | add\_action('post\_updated', array('MetaSeoImageListTable', 'updatePost'), 10, 3); |
  | 149 | 149 | add\_action('delete\_post', array('MetaSeoImageListTable', 'deletePost')); |
  | 150 | 150 |  |
  | 151 | 151 | // Category meta hook |
  | 152 | 152 | add\_action('admin\_head', array('WPMSCategoryMetaTable', 'customStyles')); |
  | 153 | 153 |  |
  | 154 | 154 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 155 | 155 | add\_action('product\_cat\_add\_form\_fields', array($this, 'categoryField')); |
  | 156 | 156 | add\_action('product\_cat\_edit\_form\_fields', array($this, 'editCategoryFields'), 10); |
  | 157 | 157 | add\_action('created\_term', array($this, 'saveCategoryMeta'), 10, 3); |
  | 158 | 158 | add\_action('edit\_term', array($this, 'saveCategoryMeta'), 10, 3); |
  | 159 | 159 | } |
  | 160 | 160 | add\_action('wp\_ajax\_wpms', array($this, 'startProcess')); |
  | 161 | 161 | add\_action('wp\_ajax\_wpms\_gg\_save\_information', array($this, 'wpmsGGSaveInformation')); |
  | 162 | 162 | add\_filter('wpms\_the\_content', array($this, 'wpmsTheContent'), 10, 2); |
  | 163 | 163 |  |
  | 164 | 164 | $settings = get\_option('\_metaseo\_settings'); |
  | 165 | 165 | if (isset($settings['metaseo\_removecatprefix']) && $settings['metaseo\_removecatprefix'] === '1') { |
  | 166 | 166 | add\_action('created\_category', array($this, 'wpmsScheduleRewriteFlush')); |
  | 167 | 167 | add\_action('edited\_category', array($this, 'wpmsScheduleRewriteFlush')); |
  | 168 | 168 | add\_action('delete\_category', array($this, 'wpmsScheduleRewriteFlush')); |
  | 169 | 169 | } |
  | 170 | 170 | } |
  | 171 | 171 |  |
  | 172 | 172 | /\*\* |
  | 173 | 173 | \* Init Meta seo settings |
  | 174 | 174 | \* |
  | 175 | 175 | \* @return void |
  | 176 | 176 | \*/ |
  | 177 | 177 | public function initSettings() |
  | 178 | 178 | { |
  | 179 | 179 | $this->settings = wpmsGetDefaultSettings(); |
  | 180 | 180 | $settings = get\_option('\_metaseo\_settings'); |
  | 181 | 181 |  |
  | 182 | 182 | if (is\_array($settings)) { |
  | 183 | 183 | $this->settings = array\_merge($this->settings, $settings); |
  | 184 | 184 | } |
  | 185 | 185 |  |
  | 186 | 186 | if ((isset($this->settings['metaseo\_showtmetablock']) && (int)$this->settings['metaseo\_showtmetablock'] === 1)) { |
  | 187 | 187 | $this->loadMetaBoxes(); |
  | 188 | 188 | } |
  | 189 | 189 | } |
  | 190 | 190 |  |
  | 191 | 191 | /\*\* |
  | 192 | 192 | \* Init google analytics tracking options |
  | 193 | 193 | \* |
  | 194 | 194 | \* @return void |
  | 195 | 195 | \*/ |
  | 196 | 196 | public function initGaSettings() |
  | 197 | 197 | { |
  | 198 | 198 | $this->ga\_tracking = array( |
  | 199 | 199 | 'wpmsga\_dash\_tracking' => 1, |
  | 200 | 200 | 'wpmsga\_dash\_tracking\_type' => 'universal', |
  | 201 | 201 | 'wpmsga\_dash\_anonim' => 0, |
  | 202 | 202 | 'wpmsga\_dash\_remarketing' => 0, |
  | 203 | 203 | 'wpmsga\_event\_tracking' => 0, |
  | 204 | 204 | 'wpmsga\_event\_downloads' => 'zip|mp3\*|mpe\*g|pdf|docx\*|pptx\*|xlsx\*|rar\*', |
  | 205 | 205 | 'wpmsga\_aff\_tracking' => 0, |
  | 206 | 206 | 'wpmsga\_event\_affiliates' => '/out/', |
  | 207 | 207 | 'wpmsga\_hash\_tracking' => 0, |
  | 208 | 208 | 'wpmsga\_author\_dimindex' => 0, |
  | 209 | 209 | 'wpmsga\_pubyear\_dimindex' => 0, |
  | 210 | 210 | 'wpmsga\_category\_dimindex' => 0, |
  | 211 | 211 | 'wpmsga\_user\_dimindex' => 0, |
  | 212 | 212 | 'wpmsga\_tag\_dimindex' => 0, |
  | 213 | 213 | 'wpmsga\_speed\_samplerate' => 1, |
  | 214 | 214 | 'wpmsga\_event\_bouncerate' => 0, |
  | 215 | 215 | 'wpmsga\_enhanced\_links' => 0, |
  | 216 | 216 | 'wpmsga\_dash\_adsense' => 0, |
  | 217 | 217 | 'wpmsga\_crossdomain\_tracking' => 0, |
  | 218 | 218 | 'wpmsga\_crossdomain\_list' => '', |
  | 219 | 219 | 'wpmsga\_cookiedomain' => '', |
  | 220 | 220 | 'wpmsga\_cookiename' => '', |
  | 221 | 221 | 'wpmsga\_cookieexpires' => '', |
  | 222 | 222 | 'wpmsga\_track\_exclude' => array(), |
  | 223 | 223 | 'wpmsga\_code\_tracking' => '' |
  | 224 | 224 | ); |
  | 225 | 225 | } |
  | 226 | 226 |  |
  | 227 | 227 | /\*\* |
  | 228 | 228 | \* Init GTM setting |
  | 229 | 229 | \* |
  | 230 | 230 | \* @return void |
  | 231 | 231 | \*/ |
  | 232 | 232 | public function initGADisconnect() |
  | 233 | 233 | { |
  | 234 | 234 | $this->gaDisconnect = array( |
  | 235 | 235 | 'wpms\_gg\_service\_tracking\_id' => '', |
  | 236 | 236 | 'wpms\_gg\_service\_tracking\_type' => 'universal', |
  | 237 | 237 | 'wpmsga\_code\_tracking' => '', |
  | 238 | 238 | 'wpmstm\_header\_code\_tracking' => '', |
  | 239 | 239 | 'wpmstm\_body\_code\_tracking' => '' |
  | 240 | 240 | ); |
  | 241 | 241 | } |
  | 242 | 242 |  |
  | 243 | 243 | /\*\* |
  | 244 | 244 | \* Ajax request google tag manager containers list |
  | 245 | 245 | \* |
  | 246 | 246 | \* @return mixed |
  | 247 | 247 | \*/ |
  | 248 | 248 | public function tagmanagerContainersReport() |
  | 249 | 249 | { |
  | 250 | 250 | if (empty($\_POST['wpms\_nonce']) |
  | 251 | 251 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 252 | 252 | die(); |
  | 253 | 253 | } |
  | 254 | 254 | $accont\_id = $\_POST['accountID']; |
  | 255 | 255 | if (isset($accont\_id) && $accont\_id) { |
  | 256 | 256 | $accont\_id = sanitize\_text\_field($accont\_id); |
  | 257 | 257 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/google-tag-manager/wpms-tagmanager-api.php'); |
  | 258 | 258 | $wpmstm = new WpmsTagManagerController(); |
  | 259 | 259 | $list\_containers = $wpmstm->getListContainers($accont\_id); |
  | 260 | 260 | $this->google\_tagmanager = get\_option('wpms\_tagmanager\_setting'); |
  | 261 | 261 | $listsContainer = $list\_containers->getContainer(); |
  | 262 | 262 | $lists = array(); |
  | 263 | 263 | foreach ($listsContainer as $container) { |
  | 264 | 264 | $lists[] = array( |
  | 265 | 265 | 'containerId' => $container->getContainerId(), |
  | 266 | 266 | 'name' => $container->getName(), |
  | 267 | 267 | 'path' => $container->getPath(), |
  | 268 | 268 | 'publicId' => $container->getPublicId(), |
  | 269 | 269 | 'usageContext' => $container->getUsageContext(), |
  | 270 | 270 | 'notes' => $container->getNotes(), |
  | 271 | 271 | ); |
  | 272 | 272 | } |
  | 273 | 273 | $this->google\_tagmanager['list\_containers'] = $lists; |
  | 274 | 274 | update\_option('wpms\_tagmanager\_setting', $this->google\_tagmanager); |
  | 275 | 275 | return wp\_send\_json($list\_containers->getContainer()); |
  | 276 | 276 | } |
  | 277 | 277 | } |
  | 278 | 278 |  |
  | 279 | 279 | /\*\* |
  | 280 | 280 | \* Ajax return tag manager container information |
  | 281 | 281 | \* |
  | 282 | 282 | \* @return mixed |
  | 283 | 283 | \*/ |
  | 284 | 284 | public function tagmanagerContainerInfo() |
  | 285 | 285 | { |
  | 286 | 286 | if (empty($\_POST['wpms\_nonce']) |
  | 287 | 287 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 288 | 288 | die(); |
  | 289 | 289 | } |
  | 290 | 290 | $container\_id = $\_POST['containerID']; |
  | 291 | 291 | if (isset($container\_id) && $container\_id) { |
  | 292 | 292 | $container\_id = sanitize\_text\_field($container\_id); |
  | 293 | 293 | $gg\_tagmanager = get\_option('wpms\_tagmanager\_setting'); |
  | 294 | 294 | $gg\_tagmanager\_containers = $gg\_tagmanager['list\_containers']; |
  | 295 | 295 | $containerIndex = 0; |
  | 296 | 296 | foreach ($gg\_tagmanager\_containers as $container) { |
  | 297 | 297 | if ($container['containerId'] === $container\_id) { |
  | 298 | 298 | break; |
  | 299 | 299 | } |
  | 300 | 300 | $containerIndex++; |
  | 301 | 301 | } |
  | 302 | 302 |  |
  | 303 | 303 | return wp\_send\_json($gg\_tagmanager\_containers[$containerIndex]); |
  | 304 | 304 | } |
  | 305 | 305 | } |
  | 306 | 306 |  |
  | 307 | 307 | /\*\* |
  | 308 | 308 | \* Ajax refresh tag manager connect |
  | 309 | 309 | \* |
  | 310 | 310 | \* @return mixed |
  | 311 | 311 | \*/ |
  | 312 | 312 | public function tagmanagerRefreshConnect() |
  | 313 | 313 | { |
  | 314 | 314 | // Update list accounts tag managers |
  | 315 | 315 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/google-tag-manager/wpms-tagmanager-api.php'); |
  | 316 | 316 | $wpmstm\_controller = new WpmsTagManagerController(); |
  | 317 | 317 | $wpmstm\_listAccounts = $wpmstm\_controller->getListAccounts(); |
  | 318 | 318 | $wpmstm\_accounts = $wpmstm\_listAccounts->getAccount(); |
  | 319 | 319 | if (isset($wpmstm\_accounts[0])) { |
  | 320 | 320 | $lists\_acc = array(); |
  | 321 | 321 | foreach ($wpmstm\_accounts as $account) { |
  | 322 | 322 | $lists\_acc[] = array( |
  | 323 | 323 | 'accountId' => $account->getAccountId(), |
  | 324 | 324 | 'name' => $account->getName(), |
  | 325 | 325 | 'path' => $account->getPath(), |
  | 326 | 326 | ); |
  | 327 | 327 | } |
  | 328 | 328 | $this->google\_tagmanager['list\_accounts'] = $lists\_acc; |
  | 329 | 329 | update\_option('wpms\_tagmanager\_setting', $this->google\_tagmanager); |
  | 330 | 330 | return wp\_send\_json($this->google\_tagmanager['list\_accounts']); |
  | 331 | 331 | } else { |
  | 332 | 332 | return false; |
  | 333 | 333 | } |
  | 334 | 334 | } |
  | 335 | 335 |  |
  | 336 | 336 | /\*\* |
  | 337 | 337 | \* Admin init |
  | 338 | 338 | \* |
  | 339 | 339 | \* @return void |
  | 340 | 340 | \*/ |
  | 341 | 341 | public function adminInit() |
  | 342 | 342 | { |
  | 343 | 343 | $this->createDatabase(); |
  | 344 | 344 | $this->updateLinksTable(); |
  | 345 | 345 |  |
  | 346 | 346 | // Column Content. |
  | 347 | 347 | $this->registerPostColumns(); |
  | 348 | 348 | add\_filter('metaseo\_seokeywords\_details\_column', array($this, 'getColumnSeoKeywordsDetails'), 5); |
  | 349 | 349 | } |
  | 350 | 350 |  |
  | 351 | 351 | /\*\* |
  | 352 | 352 | \* Add category meta field |
  | 353 | 353 | \* |
  | 354 | 354 | \* @return void |
  | 355 | 355 | \*/ |
  | 356 | 356 | public function categoryField() |
  | 357 | 357 | { |
  | 358 | 358 | wp\_enqueue\_style('wpms-tippy-style'); |
  | 359 | 359 | wp\_enqueue\_script('wpms-tippy-core'); |
  | 360 | 360 | wp\_enqueue\_script('wpms-tippy'); |
  | 361 | 361 | wp\_enqueue\_script('wpms-my-tippy'); |
  | 362 | 362 |  |
  | 363 | 363 | wp\_enqueue\_style('wpms-category-field'); |
  | 364 | 364 | wp\_enqueue\_script('wpms-category-field'); |
  | 365 | 365 | // this will add the custom meta field to the add new term page |
  | 366 | 366 | ?> |
  | 367 | 367 | <div class="form-field"> |
  | 368 | 368 | <label class="wpms\_custom\_cat\_field" |
  | 369 | 369 | data-tippy="<?php esc\_attr\_e('This is the title of your content that may be displayed in search engine |
  | 370 | 370 | results (meta title). By default it’s the content title (page title, post title…). |
  | 371 | 371 | 69 characters max allowed.', 'wp-meta-seo') ?>"> |
  | 372 | 372 | <?php esc\_html\_e('Search engine title', 'wp-meta-seo'); ?> |
  | 373 | 373 | </label> |
  | 374 | 374 | <label> |
  | 375 | 375 | <textarea name="wpms\_category\_metatitle" class="wpms\_category\_metatitle"></textarea> |
  | 376 | 376 | <br/> |
  | 377 | 377 | </label> |
  | 378 | 378 | <div class="cat-title-len"><?php echo esc\_html(MPMSCAT\_TITLE\_LENGTH); ?></div> |
  | 379 | 379 | </div> |
  | 380 | 380 |  |
  | 381 | 381 | <?php |
  | 382 | 382 | $settings = get\_option('\_metaseo\_settings'); |
  | 383 | 383 | if (isset($settings['metaseo\_showkeywords']) && (int)$settings['metaseo\_showkeywords'] === 1) : |
  | 384 | 384 | ?> |
  | 385 | 385 | <div class="form-field" style="margin-top: 20px;margin-bottom: 20px;"> |
  | 386 | 386 | <label class="wpms\_custom\_cat\_field" |
  | 387 | 387 | data-tippy="<?php esc\_attr\_e('This is the keywords of your content that may be |
  | 388 | 388 | displayed in search engine results (meta keywords).', 'wp-meta-seo') ?>"> |
  | 389 | 389 | <?php esc\_html\_e('Search engine keywords', 'wp-meta-seo'); ?> |
  | 390 | 390 | </label> |
  | 391 | 391 | <label> |
  | 392 | 392 | <textarea name="wpms\_category\_metakeywords" class="wpms\_cat\_keywords"></textarea><br/> |
  | 393 | 393 | </label> |
  | 394 | 394 | <div class="cat-keywords-len"><?php echo esc\_html(MPMSCAT\_KEYWORDS\_LENGTH); ?></div> |
  | 395 | 395 | </div> |
  | 396 | 396 | <?php endif; ?> |
  | 397 | 397 | <div class="form-field" style="margin-top: 20px;margin-bottom: 20px;"> |
  | 398 | 398 | <label for="extra1" class="wpms\_custom\_cat\_field" |
  | 399 | 399 | data-tippy="<?php esc\_attr\_e('This is the title of your content that may be displayed in search |
  | 400 | 400 | engine results (meta title). By default it’s the content title (page title, post title…). |
  | 401 | 401 | 69 characters max allowed.', 'wp-meta-seo') ?>"> |
  | 402 | 402 | <?php esc\_html\_e('Search engine description', 'wp-meta-seo'); ?> |
  | 403 | 403 | </label> |
  | 404 | 404 | <label> |
  | 405 | 405 | <textarea name="wpms\_category\_metadesc" class="wpms\_category\_metadesc"></textarea><br/> |
  | 406 | 406 | <input type="hidden" name="wpms\_nonce" value="<?php echo esc\_attr(wp\_create\_nonce('wpms\_nonce')) ?>"> |
  | 407 | 407 | </label> |
  | 408 | 408 | <div class="cat-desc-len"><?php echo esc\_html(MPMSCAT\_DESC\_LENGTH); ?></div> |
  | 409 | 409 | </div> |
  | 410 | 410 | <?php |
  | 411 | 411 | if (isset($settings['metaseo\_canonical']) && (int)$settings['metaseo\_canonical'] === 1) : ?> |
  | 412 | 412 | <div class="form-field" style="margin-top: 20px;margin-bottom: 20px;"> |
  | 413 | 413 | <label class="wpms\_custom\_cat\_field" |
  | 414 | 414 | data-tippy="<?php esc\_attr\_e('Put the canonical URL which this page should point to. By default, it\'s the permalink', 'wp-meta-seo') ?>"> |
  | 415 | 415 | <?php esc\_html\_e('Canonical URL', 'wp-meta-seo'); ?> |
  | 416 | 416 | </label> |
  | 417 | 417 | <label> |
  | 418 | 418 | <textarea name="wpms\_category\_canonical" class="wpms\_category\_canonical"></textarea><br/> |
  | 419 | 419 | </label> |
  | 420 | 420 | </div> |
  | 421 | 421 | <?php endif; |
  | 422 | 422 | } |
  | 423 | 423 |  |
  | 424 | 424 | /\*\* |
  | 425 | 425 | \* Save category meta |
  | 426 | 426 | \* |
  | 427 | 427 | \* @param integer $term\_id Current category id |
  | 428 | 428 | \* |
  | 429 | 429 | \* @return void |
  | 430 | 430 | \*/ |
  | 431 | 431 | public function saveCategoryMeta($term\_id) |
  | 432 | 432 | { |
  | 433 | 433 | global $pagenow; |
  | 434 | 434 | // phpcs:disable WordPress.Security.NonceVerification.Missing -- Nonce used in next lines |
  | 435 | 435 | if ($pagenow === 'edit-tags.php' || (isset($\_POST['action'], $\_POST['screen']) && $\_POST['action'] === 'add-tag' && ($\_POST['screen'] === 'edit-category' || $\_POST['screen'] === 'edit-product\_cat'))) { |
  | 436 | 436 | if (isset($\_POST['taxonomy']) && ($\_POST['taxonomy'] === 'product\_cat' || $\_POST['taxonomy'] === 'category')) { |
  | 437 | 437 | if (empty($\_POST['wpms\_nonce']) |
  | 438 | 438 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 439 | 439 | die(); |
  | 440 | 440 | } |
  | 441 | 441 |  |
  | 442 | 442 | if (isset($\_POST['wpms\_category\_metatitle'])) { |
  | 443 | 443 | update\_term\_meta($term\_id, 'wpms\_category\_metatitle', $\_POST['wpms\_category\_metatitle']); |
  | 444 | 444 | } |
  | 445 | 445 |  |
  | 446 | 446 | if (isset($\_POST['wpms\_category\_metadesc'])) { |
  | 447 | 447 | update\_term\_meta($term\_id, 'wpms\_category\_metadesc', $\_POST['wpms\_category\_metadesc']); |
  | 448 | 448 | } |
  | 449 | 449 |  |
  | 450 | 450 | $settings = get\_option('\_metaseo\_settings'); |
  | 451 | 451 | if (isset($settings['metaseo\_showkeywords']) && (int)$settings['metaseo\_showkeywords'] === 1) { |
  | 452 | 452 | if (isset($\_POST['wpms\_category\_metakeywords'])) { |
  | 453 | 453 | update\_term\_meta($term\_id, 'wpms\_category\_metakeywords', $\_POST['wpms\_category\_metakeywords']); |
  | 454 | 454 | } |
  | 455 | 455 | } |
  | 456 | 456 |  |
  | 457 | 457 | if (isset($settings['metaseo\_canonical']) && (int)$settings['metaseo\_canonical'] === 1) { |
  | 458 | 458 | if (isset($\_POST['wpms\_category\_canonical'])) { |
  | 459 | 459 | // Set link to field |
  | 460 | 460 | $canonical = self::convertCanonicalUrlToSave($\_POST['wpms\_category\_canonical']); |
  | 461 | 461 |  |
  | 462 | 462 | update\_term\_meta($term\_id, 'wpms\_category\_canonical', $canonical); |
  | 463 | 463 | } |
  | 464 | 464 | } |
  | 465 | 465 | } |
  | 466 | 466 | } |
  | 467 | 467 | //phpcs:enable |
  | 468 | 468 | } |
  | 469 | 469 |  |
  | 470 | 470 | /\*\* |
  | 471 | 471 | \* Add extra fields to category edit form callback function |
  | 472 | 472 | \* |
  | 473 | 473 | \* @param object $tag Current category |
  | 474 | 474 | \* |
  | 475 | 475 | \* @return void |
  | 476 | 476 | \*/ |
  | 477 | 477 | public function editCategoryFields($tag) |
  | 478 | 478 | { |
  | 479 | 479 | wp\_enqueue\_style('wpms-tippy-style'); |
  | 480 | 480 | wp\_enqueue\_script('wpms-tippy-core'); |
  | 481 | 481 | wp\_enqueue\_script('wpms-tippy'); |
  | 482 | 482 | wp\_enqueue\_script('wpms-my-tippy'); |
  | 483 | 483 |  |
  | 484 | 484 | wp\_enqueue\_style('wpms-category-field'); |
  | 485 | 485 | wp\_enqueue\_script('wpms-category-field'); |
  | 486 | 486 | $t\_id = $tag->term\_id; |
  | 487 | 487 | $metatitle = get\_term\_meta($t\_id, 'wpms\_category\_metatitle', true); |
  | 488 | 488 | $metadesc = get\_term\_meta($t\_id, 'wpms\_category\_metadesc', true); |
  | 489 | 489 | $metakeywords = get\_term\_meta($t\_id, 'wpms\_category\_metakeywords', true); |
  | 490 | 490 | $metacanonical = get\_term\_meta($t\_id, 'wpms\_category\_canonical', true); |
  | 491 | 491 | $metacanonical = self::convertCanonicalUrlToDisplay($metacanonical); |
  | 492 | 492 | ?> |
  | 493 | 493 | <tr class="form-field"> |
  | 494 | 494 | <th scope="row" valign="top"> |
  | 495 | 495 | <label class="wpms\_custom\_cat\_field" data-tippy="<?php esc\_attr\_e('This is the title of your content that may |
  | 496 | 496 | be displayed in search engine results (meta title). By default it’s the content title |
  | 497 | 497 | (page title, post title…).69 characters max allowed.', 'wp-meta-seo') ?>"> |
  | 498 | 498 | <?php esc\_html\_e('Search engine title', 'wp-meta-seo'); ?> |
  | 499 | 499 | </label> |
  | 500 | 500 | </th> |
  | 501 | 501 | <td> |
  | 502 | 502 | <label> |
  | 503 | 503 | <?php if ((!empty($metatitle))) : ?> |
  | 504 | 504 | <textarea name="wpms\_category\_metatitle" |
  | 505 | 505 | class="wpms\_category\_metatitle"><?php echo esc\_textarea($metatitle); ?></textarea> |
  | 506 | 506 | <?php else : ?> |
  | 507 | 507 | <textarea name="wpms\_category\_metatitle" |
  | 508 | 508 | class="wpms\_category\_metatitle"></textarea> |
  | 509 | 509 | <?php endif; ?> |
  | 510 | 510 | <br/> |
  | 511 | 511 | </label> |
  | 512 | 512 | <div class="cat-title-len"> |
  | 513 | 513 | <?php |
  | 514 | 514 | echo esc\_html($metatitle ? MPMSCAT\_TITLE\_LENGTH - strlen($metatitle) : MPMSCAT\_TITLE\_LENGTH); |
  | 515 | 515 | ?> |
  | 516 | 516 | </div> |
  | 517 | 517 | </td> |
  | 518 | 518 | </tr> |
  | 519 | 519 |  |
  | 520 | 520 | <?php |
  | 521 | 521 | $settings = get\_option('\_metaseo\_settings'); |
  | 522 | 522 | if (isset($settings['metaseo\_showkeywords']) && (int)$settings['metaseo\_showkeywords'] === 1) : |
  | 523 | 523 | ?> |
  | 524 | 524 | <tr class="form-field"> |
  | 525 | 525 | <th scope="row" valign="top"> |
  | 526 | 526 | <label for="extra1" class="wpms\_custom\_cat\_field" |
  | 527 | 527 | data-tippy="<?php esc\_attr\_e('This is the keywords of your content that may be |
  | 528 | 528 | displayed in search engine results (meta keywords).', 'wp-meta-seo') ?>"> |
  | 529 | 529 | <?php esc\_html\_e('Search engine keywords', 'wp-meta-seo'); ?> |
  | 530 | 530 | </label> |
  | 531 | 531 | </th> |
  | 532 | 532 | <td> |
  | 533 | 533 | <label> |
  | 534 | 534 | <?php if ((!empty($metakeywords))) : ?> |
  | 535 | 535 | <textarea name="wpms\_category\_metakeywords" |
  | 536 | 536 | class="wpms\_cat\_keywords"><?php echo esc\_textarea($metakeywords); ?></textarea> |
  | 537 | 537 | <?php else : ?> |
  | 538 | 538 | <textarea name="wpms\_category\_metakeywords" |
  | 539 | 539 | class="wpms\_cat\_keywords"></textarea> |
  | 540 | 540 | <?php endif; ?> |
  | 541 | 541 | <br/> |
  | 542 | 542 | </label> |
  | 543 | 543 |  |
  | 544 | 544 | <div class="cat-keywords-len"> |
  | 545 | 545 | <?php |
  | 546 | 546 | echo esc\_html($metakeywords ? MPMSCAT\_KEYWORDS\_LENGTH - strlen($metakeywords) : MPMSCAT\_KEYWORDS\_LENGTH); |
  | 547 | 547 | ?> |
  | 548 | 548 | </div> |
  | 549 | 549 | </td> |
  | 550 | 550 | </tr> |
  | 551 | 551 | <?php endif; ?> |
  | 552 | 552 | <tr class="form-field"> |
  | 553 | 553 | <th scope="row" valign="top"> |
  | 554 | 554 | <label for="extra1" class="wpms\_custom\_cat\_field" |
  | 555 | 555 | data-tippy="<?php esc\_attr\_e('This is the title of your content that may be displayed in |
  | 556 | 556 | search engine results (meta title). By default it’s the content title (page title, post title…). |
  | 557 | 557 | 69 characters max allowed.', 'wp-meta-seo') ?>"> |
  | 558 | 558 | <?php esc\_html\_e('Search engine description', 'wp-meta-seo'); ?> |
  | 559 | 559 | </label> |
  | 560 | 560 | </th> |
  | 561 | 561 | <td> |
  | 562 | 562 | <label> |
  | 563 | 563 | <?php if ((!empty($metadesc))) : ?> |
  | 564 | 564 | <textarea name="wpms\_category\_metadesc" |
  | 565 | 565 | class="wpms\_category\_metadesc"><?php echo esc\_textarea($metadesc); ?></textarea> |
  | 566 | 566 | <?php else : ?> |
  | 567 | 567 | <textarea name="wpms\_category\_metadesc" |
  | 568 | 568 | class="wpms\_category\_metadesc"></textarea> |
  | 569 | 569 | <?php endif; ?> |
  | 570 | 570 | <br/> |
  | 571 | 571 | </label> |
  | 572 | 572 | <input type="hidden" name="wpms\_nonce" value="<?php echo esc\_attr(wp\_create\_nonce('wpms\_nonce')) ?>"> |
  | 573 | 573 | <div class="cat-desc-len"> |
  | 574 | 574 | <?php echo esc\_html($metadesc ? MPMSCAT\_DESC\_LENGTH - strlen($metadesc) : MPMSCAT\_DESC\_LENGTH); ?> |
  | 575 | 575 | </div> |
  | 576 | 576 | </td> |
  | 577 | 577 | </tr> |
  | 578 | 578 | <?php |
  | 579 | 579 | if (isset($settings['metaseo\_canonical']) && (int)$settings['metaseo\_canonical'] === 1) : ?> |
  | 580 | 580 | <tr class="form-field"> |
  | 581 | 581 | <th scope="row" valign="top"> |
  | 582 | 582 | <label for="extra1" class="wpms\_custom\_cat\_field" |
  | 583 | 583 | data-tippy="<?php esc\_attr\_e('Put the canonical URL which this page should point to. By default, it\'s the permalink', 'wp-meta-seo') ?>"> |
  | 584 | 584 | <?php esc\_html\_e('Canonical URL', 'wp-meta-seo'); ?> |
  | 585 | 585 | </label> |
  | 586 | 586 | </th> |
  | 587 | 587 | <td> |
  | 588 | 588 | <label> |
  | 589 | 589 | <?php if ((!empty($metacanonical))) : ?> |
  | 590 | 590 | <textarea name="wpms\_category\_canonical" |
  | 591 | 591 | class="wpms\_category\_canonical"><?php echo esc\_textarea($metacanonical); ?></textarea> |
  | 592 | 592 | <?php else : ?> |
  | 593 | 593 | <textarea name="wpms\_category\_canonical" |
  | 594 | 594 | class="wpms\_category\_canonical"></textarea> |
  | 595 | 595 | <?php endif; ?> |
  | 596 | 596 | <br/> |
  | 597 | 597 | </label> |
  | 598 | 598 | </td> |
  | 599 | 599 | </tr> |
  | 600 | 600 | <?php endif; |
  | 601 | 601 | } |
  | 602 | 602 |  |
  | 603 | 603 | /\*\* |
  | 604 | 604 | \* Function that outputs the contents of the dashboard widget |
  | 605 | 605 | \* |
  | 606 | 606 | \* @return void |
  | 607 | 607 | \*/ |
  | 608 | 608 | public function dashboardWidget() |
  | 609 | 609 | { |
  | 610 | 610 | wp\_enqueue\_style('wpms-tippy-style'); |
  | 611 | 611 | wp\_enqueue\_style('wpms-mytippy-style'); |
  | 612 | 612 | wp\_enqueue\_script('wpms-tippy-core'); |
  | 613 | 613 | wp\_enqueue\_script('wpms-tippy'); |
  | 614 | 614 | wp\_enqueue\_script('wpms-my-tippy'); |
  | 615 | 615 | wp\_enqueue\_style('wpms-dashboard-widgets'); |
  | 616 | 616 | wp\_enqueue\_script( |
  | 617 | 617 | 'wpms-dashboard-widgets', |
  | 618 | 618 | plugins\_url('assets/js/dashboard\_widgets/dashboard\_widgets.js', dirname(\_\_FILE\_\_)), |
  | 619 | 619 | array('jquery'), |
  | 620 | 620 | WPMSEO\_VERSION |
  | 621 | 621 | ); |
  | 622 | 622 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/dashboard-widgets/dashboard\_widgets.php'); |
  | 623 | 623 | } |
  | 624 | 624 |  |
  | 625 | 625 | /\*\* |
  | 626 | 626 | \* Generate dasboard Analytics widget |
  | 627 | 627 | \* |
  | 628 | 628 | \* @return void |
  | 629 | 629 | \*/ |
  | 630 | 630 | public function dashboardAnalyticsWidget() |
  | 631 | 631 | { |
  | 632 | 632 | // Jsapi |
  | 633 | 633 | $lang = get\_bloginfo('language'); |
  | 634 | 634 | $lang = explode('-', $lang); |
  | 635 | 635 | $lang = $lang[0]; |
  | 636 | 636 | wp\_enqueue\_script( |
  | 637 | 637 | 'wpmsgooglejsapi', |
  | 638 | 638 | 'https://www.google.com/jsapi?autoload=%7B%22modules%22%3A%5B%7B%22name%22%3A%22visualization%22%2C%22version%22%3A%221%22%2C%22language%22%3A%22' . $lang . '%22%2C%22packages%22%3A%5B%22corechart%22%2C%20%22imagechart%22%2C%20%22table%22%2C%20%22orgchart%22%2C%20%22geochart%22%5D%7D%5D%7D', |
  | 639 | 639 | array(), |
  | 640 | 640 | null |
  | 641 | 641 | ); |
  | 642 | 642 | // WPMS style |
  | 643 | 643 | wp\_enqueue\_style( |
  | 644 | 644 | 'wpms-dashboard-analytics-widgets', |
  | 645 | 645 | plugins\_url('assets/css/dashboard-widgets/analytics-widgets.css', dirname(\_\_FILE\_\_)), |
  | 646 | 646 | array(), |
  | 647 | 647 | WPMSEO\_VERSION |
  | 648 | 648 | ); |
  | 649 | 649 | // WPMS script |
  | 650 | 650 | wp\_enqueue\_script( |
  | 651 | 651 | 'wpms-dashboard-analytics-widgets', |
  | 652 | 652 | plugins\_url('assets/js/dashboard\_widgets/analytics-widgets.js', dirname(\_\_FILE\_\_)), |
  | 653 | 653 | array('jquery'), |
  | 654 | 654 | WPMSEO\_VERSION, |
  | 655 | 655 | true |
  | 656 | 656 | ); |
  | 657 | 657 |  |
  | 658 | 658 | wp\_localize\_script('wpms-dashboard-analytics-widgets', 'wpmsDashboardAnalytics', $this->localizeDashoardWidgets()); |
  | 659 | 659 |  |
  | 660 | 660 | $requestDates = array( |
  | 661 | 661 | array('value' => 'today', 'html' => 'TODAY'), |
  | 662 | 662 | array('value' => 'yesterday', 'html' => 'YESTERDAY'), |
  | 663 | 663 | array('value' => '7daysAgo', 'html' => 'LAST 7 DAYS'), |
  | 664 | 664 | array('value' => '14daysAgo', 'html' => 'LAST 14 DAYS'), |
  | 665 | 665 | array('value' => '30daysAgo', 'html' => 'LAST 30 DAYS'), |
  | 666 | 666 | array('value' => '90daysAgo', 'html' => 'LAST 90 DAYS'), |
  | 667 | 667 | array('value' => '365daysAgo', 'html' => 'ONE YEAR'), |
  | 668 | 668 | array('value' => '1095daysAgo', 'html' => 'THREE YEARS'), |
  | 669 | 669 | ); |
  | 670 | 670 | $requestQuery = array( |
  | 671 | 671 | array('value' => 'sessions', 'html' => 'SESSIONS'), |
  | 672 | 672 | array('value' => 'users', 'html' => 'USERS'), |
  | 673 | 673 | array('value' => 'pageviews', 'html' => 'PAGE VIEWS'), |
  | 674 | 674 | array('value' => 'visitBounceRate', 'html' => 'ENGAGEMENT'), |
  | 675 | 675 | array('value' => 'organicSearches', 'html' => 'TRANSACTIONS'), |
  | 676 | 676 | array('value' => 'contentpages', 'html' => 'PAGES'), |
  | 677 | 677 | array('value' => 'locations', 'html' => 'LOCATION'), |
  | 678 | 678 | array('value' => 'referrers', 'html' => 'REFERRERS'), |
  | 679 | 679 | array('value' => 'searches', 'html' => 'SEARCHES'), |
  | 680 | 680 | array('value' => 'channelGrouping', 'html' => 'TRAFFIC'), |
  | 681 | 681 | array('value' => 'deviceCategory', 'html' => 'TECHNOLOGY') |
  | 682 | 682 | ); |
  | 683 | 683 | $google\_analytics =  get\_option('wpms\_google\_alanytics'); |
  | 684 | 684 | if (!empty($google\_analytics['tableid\_jail'])) { |
  | 685 | 685 | require\_once WPMETASEO\_PLUGIN\_DIR . 'inc/google\_analytics/wpmstools.php'; |
  | 686 | 686 | $profile = WpmsGaTools::getSelectedProfile($google\_analytics['profile\_list'], $google\_analytics['tableid\_jail']); |
  | 687 | 687 | if (!empty($profile[4]) && $profile[4] === 'UA') { |
  | 688 | 688 | $requestQuery[3] = array('value' => 'visitBounceRate', 'html' => 'BOUNCE RATE'); |
  | 689 | 689 | $requestQuery[4] = array('value' => 'organicSearches', 'html' => 'ORGANIC'); |
  | 690 | 690 | } |
  | 691 | 691 | } |
  | 692 | 692 |  |
  | 693 | 693 | $selectedDate = 'today'; |
  | 694 | 694 | $selectedQuery = 'sessions'; |
  | 695 | 695 | if (!empty($google\_analytics['dashboard\_analytics\_widgets'])) { |
  | 696 | 696 | $selectedDate = $google\_analytics['dashboard\_analytics\_widgets']['requestDate']; |
  | 697 | 697 | $selectedQuery = $google\_analytics['dashboard\_analytics\_widgets']['requestQuery']; |
  | 698 | 698 | } |
  | 699 | 699 |  |
  | 700 | 700 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/dashboard-widgets/analytics\_widgets.php'); |
  | 701 | 701 | } |
  | 702 | 702 |  |
  | 703 | 703 | /\*\* |
  | 704 | 704 | \* Function used in the action hook |
  | 705 | 705 | \* |
  | 706 | 706 | \* @return void |
  | 707 | 707 | \*/ |
  | 708 | 708 | public function addDashboardWidgets() |
  | 709 | 709 | { |
  | 710 | 710 | wp\_add\_dashboard\_widget( |
  | 711 | 711 | 'wpms\_dashboard\_widget', |
  | 712 | 712 | esc\_html\_\_('WP Meta SEO: Quick SEO preview', 'wp-meta-seo'), |
  | 713 | 713 | array( |
  | 714 | 714 | $this, |
  | 715 | 715 | 'dashboardWidget' |
  | 716 | 716 | ) |
  | 717 | 717 | ); |
  | 718 | 718 |  |
  | 719 | 719 | // Add Google Analytics Overview dashboard widget |
  | 720 | 720 | wp\_add\_dashboard\_widget( |
  | 721 | 721 | 'wpms\_dashboard\_analytics\_widget', |
  | 722 | 722 | esc\_html\_\_('Google Analytics Overview', 'wp-meta-seo'), |
  | 723 | 723 | array( |
  | 724 | 724 | $this, |
  | 725 | 725 | 'dashboardAnalyticsWidget' |
  | 726 | 726 | ) |
  | 727 | 727 | ); |
  | 728 | 728 | } |
  | 729 | 729 |  |
  | 730 | 730 | /\*\* |
  | 731 | 731 | \* Localize dashboard widget |
  | 732 | 732 | \* |
  | 733 | 733 | \* @return array |
  | 734 | 734 | \*/ |
  | 735 | 735 | public function localizeDashoardWidgets() |
  | 736 | 736 | { |
  | 737 | 737 | return array( |
  | 738 | 738 | 'ajaxUrl' => admin\_url('admin-ajax.php'), |
  | 739 | 739 | 'wpms\_nonce' => wp\_create\_nonce('wpms\_nonce'), |
  | 740 | 740 | 'wpms\_security' => wp\_create\_nonce('dashboard\_analytics\_widgets\_security'), |
  | 741 | 741 | 'colorVariations' => array( |
  | 742 | 742 | esc\_attr('#1e73be'), |
  | 743 | 743 | esc\_attr('#0459a4'), |
  | 744 | 744 | esc\_attr('#378cd7'), |
  | 745 | 745 | esc\_attr('#51a6f1'), |
  | 746 | 746 | esc\_attr('#00408b'), |
  | 747 | 747 | esc\_attr('#6abfff'), |
  | 748 | 748 | esc\_attr('#002671') |
  | 749 | 749 | ), |
  | 750 | 750 | 'region' => false, |
  | 751 | 751 | 'language' => get\_bloginfo('language'), |
  | 752 | 752 | 'viewList' => false |
  | 753 | 753 | ); |
  | 754 | 754 | } |
  | 755 | 755 |  |
  | 756 | 756 | /\*\* |
  | 757 | 757 | \* Create link dialog |
  | 758 | 758 | \* |
  | 759 | 759 | \* @return void |
  | 760 | 760 | \*/ |
  | 761 | 761 | public function editorFooter() |
  | 762 | 762 | { |
  | 763 | 763 | if (!class\_exists('\_WP\_Editors', false)) { |
  | 764 | 764 | require\_once ABSPATH . 'wp-includes/class-wp-editor.php'; |
  | 765 | 765 | \_WP\_Editors::wp\_link\_dialog(); |
  | 766 | 766 | } |
  | 767 | 767 | } |
  | 768 | 768 |  |
  | 769 | 769 | /\*\* |
  | 770 | 770 | \* Create or update 404 page |
  | 771 | 771 | \* |
  | 772 | 772 | \* @param string $title    Old page title |
  | 773 | 773 | \* @param string $newtitle New page title |
  | 774 | 774 | \* |
  | 775 | 775 | \* @return void |
  | 776 | 776 | \*/ |
  | 777 | 777 | public function create404Page($title, $newtitle) |
  | 778 | 778 | { |
  | 779 | 779 | global $wpdb; |
  | 780 | 780 | $post\_if = $wpdb->get\_results($wpdb->prepare( |
  | 781 | 781 | 'SELECT \* FROM ' . $wpdb->prefix . 'posts |
  | 782 | 782 | WHERE post\_title = %s AND post\_excerpt = %s AND post\_type = %s', |
  | 783 | 783 | array($title, 'metaseo\_404\_page', 'page') |
  | 784 | 784 | )); |
  | 785 | 785 |  |
  | 786 | 786 | if (empty($post\_if)) { |
  | 787 | 787 | $content = '<div class="wall" |
  | 788 | 788 | style="background-color: #F2F3F7; border: 30px solid #fff; width: 90%; height: 90%; margin: 0 auto;"> |
  | 789 | 789 |  |
  | 790 | 790 | <h1 style="text-align: center; font-family:\'open-sans\', arial; |
  | 791 | 791 | color: #444; font-size: 60px; padding: 50px;">ERROR 404 <br />-<br />NOT FOUND</h1> |
  | 792 | 792 | <p style="text-align: center; font-family:\'open-sans\', arial; color: #444; |
  | 793 | 793 | font-size: 40px; padding: 20px; line-height: 55px;"> |
  | 794 | 794 | // You may have mis-typed the URL,<br /> |
  | 795 | 795 | // Or the page has been removed,<br /> |
  | 796 | 796 | // Actually, there is nothing to see here...</p> |
  | 797 | 797 | <p style="text-align: center;"><a style=" font-family:\'open-sans\', arial; color: #444; |
  | 798 | 798 | font-size: 20px; padding: 20px; line-height: 30px; text-decoration: none;" |
  | 799 | 799 | href="' . get\_home\_url() . '"><< Go back to home page >></a></p> |
  | 800 | 800 | </div>'; |
  | 801 | 801 | $\_page404 = array( |
  | 802 | 802 | 'post\_title' => $newtitle, |
  | 803 | 803 | 'post\_content' => $content, |
  | 804 | 804 | 'post\_status' => 'publish', |
  | 805 | 805 | 'post\_excerpt' => 'metaseo\_404\_page', |
  | 806 | 806 | 'post\_type' => 'page' |
  | 807 | 807 | ); |
  | 808 | 808 | wp\_insert\_post($\_page404); |
  | 809 | 809 | } else { |
  | 810 | 810 | $my\_post = array( |
  | 811 | 811 | 'ID' => $post\_if[0]->ID, |
  | 812 | 812 | 'post\_title' => $newtitle |
  | 813 | 813 | ); |
  | 814 | 814 |  |
  | 815 | 815 | wp\_update\_post($my\_post); |
  | 816 | 816 | } |
  | 817 | 817 | } |
  | 818 | 818 |  |
  | 819 | 819 | /\*\* |
  | 820 | 820 | \* Update links table |
  | 821 | 821 | \* |
  | 822 | 822 | \* @return void |
  | 823 | 823 | \*/ |
  | 824 | 824 | public function updateLinksTable() |
  | 825 | 825 | { |
  | 826 | 826 | global $wpdb; |
  | 827 | 827 | $option\_v = 'metaseo\_db\_version3.7.2'; |
  | 828 | 828 | $db\_installed = get\_option($option\_v, false); |
  | 829 | 829 | if (!$db\_installed) { |
  | 830 | 830 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'wpms\_links MODIFY `link\_url` text CHARACTER SET utf8 COLLATE utf8\_unicode\_ci NOT NULL'); |
  | 831 | 831 | update\_option($option\_v, true); |
  | 832 | 832 | } |
  | 833 | 833 |  |
  | 834 | 834 | // Add index for wpms links |
  | 835 | 835 | $option\_v = 'metaseo\_db\_version4.0.4'; |
  | 836 | 836 | $db\_installed = get\_option($option\_v, false); |
  | 837 | 837 | if (!$db\_installed) { |
  | 838 | 838 | // Add index for wpms\_links table; |
  | 839 | 839 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'wpms\_links ADD INDEX linkurl(link\_url(256))'); |
  | 840 | 840 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'wpms\_links ADD INDEX typeurl(type(50))'); |
  | 841 | 841 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'wpms\_links ADD INDEX sourceid(source\_id)'); |
  | 842 | 842 |  |
  | 843 | 843 | // Add index for metaseo\_images table; |
  | 844 | 844 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'metaseo\_images ADD INDEX postid(post\_id)'); |
  | 845 | 845 | // Update option metaseo\_db |
  | 846 | 846 | update\_option($option\_v, true); |
  | 847 | 847 | } |
  | 848 | 848 | } |
  | 849 | 849 |  |
  | 850 | 850 | /\*\* |
  | 851 | 851 | \* Create wpms\_links table |
  | 852 | 852 | \* |
  | 853 | 853 | \* @return void |
  | 854 | 854 | \*/ |
  | 855 | 855 | public function createDatabase() |
  | 856 | 856 | { |
  | 857 | 857 | global $wpdb; |
  | 858 | 858 | $option\_v = 'metaseo\_db\_version3.3.0'; |
  | 859 | 859 | $db\_installed = get\_option($option\_v, false); |
  | 860 | 860 | if (!$db\_installed) { |
  | 861 | 861 | // create table wpms\_links |
  | 862 | 862 | $sql = 'CREATE TABLE IF NOT EXISTS ' . $wpdb->prefix . 'wpms\_links( |
  | 863 | 863 | `id` int(20) unsigned NOT NULL AUTO\_INCREMENT, |
  | 864 | 864 | `link\_url` text CHARACTER SET latin1 COLLATE latin1\_general\_cs NOT NULL, |
  | 865 | 865 | `link\_final\_url` text CHARACTER SET latin1 COLLATE latin1\_general\_cs, |
  | 866 | 866 | `link\_url\_redirect` text CHARACTER SET latin1 COLLATE latin1\_general\_cs NOT NULL, |
  | 867 | 867 | `link\_text` text NOT NULL DEFAULT "", |
  | 868 | 868 | `source\_id` int(20) DEFAULT "0", |
  | 869 | 869 | `type` varchar(100) DEFAULT "", |
  | 870 | 870 | `status\_code` varchar(100) DEFAULT "", |
  | 871 | 871 | `status\_text` varchar(250) DEFAULT "", |
  | 872 | 872 | `hit` int(20) NOT NULL DEFAULT "1", |
  | 873 | 873 | `redirect` tinyint(1) NOT NULL DEFAULT "0", |
  | 874 | 874 | `broken\_indexed` tinyint(1) unsigned NOT NULL DEFAULT "0", |
  | 875 | 875 | `broken\_internal` tinyint(1) unsigned NOT NULL DEFAULT "0", |
  | 876 | 876 | `warning` tinyint(1) unsigned NOT NULL DEFAULT "0", |
  | 877 | 877 | `dismissed` tinyint(1) NOT NULL DEFAULT "0", |
  | 878 | 878 | PRIMARY KEY  (id))'; |
  | 879 | 879 |  |
  | 880 | 880 |  |
  | 881 | 881 | require\_once(ABSPATH . 'wp-admin/includes/upgrade.php'); |
  | 882 | 882 | dbDelta($sql); |
  | 883 | 883 |  |
  | 884 | 884 | $row = $wpdb->get\_results($wpdb->prepare( |
  | 885 | 885 | 'SELECT COLUMN\_NAME FROM INFORMATION\_SCHEMA.COLUMNS |
  | 886 | 886 | WHERE table\_name = %s AND column\_name = %s  AND TABLE\_SCHEMA = %s', |
  | 887 | 887 | array($wpdb->prefix . 'wpms\_links', 'follow', $wpdb->dbname) |
  | 888 | 888 | )); |
  | 889 | 889 |  |
  | 890 | 890 | if (empty($row)) { |
  | 891 | 891 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'wpms\_links ADD follow tinyint(1) DEFAULT 1'); |
  | 892 | 892 | } |
  | 893 | 893 |  |
  | 894 | 894 | $row = $wpdb->get\_results($wpdb->prepare( |
  | 895 | 895 | 'SELECT COLUMN\_NAME FROM INFORMATION\_SCHEMA.COLUMNS |
  | 896 | 896 | WHERE table\_name = %s AND column\_name = %s  AND TABLE\_SCHEMA = %s', |
  | 897 | 897 | array($wpdb->prefix . 'wpms\_links', 'meta\_title', $wpdb->dbname) |
  | 898 | 898 | )); |
  | 899 | 899 |  |
  | 900 | 900 | if (empty($row)) { |
  | 901 | 901 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'wpms\_links ADD meta\_title varchar(250) DEFAULT ""'); |
  | 902 | 902 | } |
  | 903 | 903 |  |
  | 904 | 904 | $row = $wpdb->get\_results($wpdb->prepare( |
  | 905 | 905 | 'SELECT COLUMN\_NAME FROM INFORMATION\_SCHEMA.COLUMNS |
  | 906 | 906 | WHERE table\_name = %s AND column\_name = %s  AND TABLE\_SCHEMA = %s', |
  | 907 | 907 | array($wpdb->prefix . 'wpms\_links', 'internal', $wpdb->dbname) |
  | 908 | 908 | )); |
  | 909 | 909 |  |
  | 910 | 910 | if (empty($row)) { |
  | 911 | 911 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'wpms\_links ADD internal tinyint(1) DEFAULT 1'); |
  | 912 | 912 | } |
  | 913 | 913 |  |
  | 914 | 914 | // create page 404 |
  | 915 | 915 | $this->create404Page('WP Meta SEO 404 Page', '404 error page'); |
  | 916 | 916 | // create sitemap page |
  | 917 | 917 | $post\_if = $wpdb->get\_var( |
  | 918 | 918 | $wpdb->prepare('SELECT COUNT(\*) FROM ' . $wpdb->prefix . 'posts |
  | 919 | 919 | WHERE post\_title = %s AND post\_excerpt = %s AND post\_type = %s', array( |
  | 920 | 920 | 'WPMS HTML Sitemap', |
  | 921 | 921 | 'metaseo\_html\_sitemap', |
  | 922 | 922 | 'page' |
  | 923 | 923 | )) |
  | 924 | 924 | ); |
  | 925 | 925 | if ($post\_if < 1) { |
  | 926 | 926 | $\_sitemap\_page = array( |
  | 927 | 927 | 'post\_title' => 'WPMS HTML Sitemap', |
  | 928 | 928 | 'post\_content' => '', |
  | 929 | 929 | 'post\_status' => 'publish', |
  | 930 | 930 | 'post\_excerpt' => 'metaseo\_html\_sitemap', |
  | 931 | 931 | 'post\_type' => 'page', |
  | 932 | 932 | ); |
  | 933 | 933 | wp\_insert\_post($\_sitemap\_page); |
  | 934 | 934 | } |
  | 935 | 935 |  |
  | 936 | 936 | update\_option($option\_v, true); |
  | 937 | 937 | } |
  | 938 | 938 |  |
  | 939 | 939 |  |
  | 940 | 940 | $option\_v = 'metaseo\_db\_version3.7.3'; |
  | 941 | 941 | $db\_installed = get\_option($option\_v, false); |
  | 942 | 942 | if (!$db\_installed) { |
  | 943 | 943 | // create page 404 |
  | 944 | 944 | $this->create404Page('404 error page', '404 Error, content does not exist anymore'); |
  | 945 | 945 | update\_option($option\_v, true); |
  | 946 | 946 | } |
  | 947 | 947 |  |
  | 948 | 948 | $option\_v = 'metaseo\_db\_version4.0.0'; |
  | 949 | 949 | $db\_installed = get\_option($option\_v, false); |
  | 950 | 950 | if (!$db\_installed) { |
  | 951 | 951 | $row = $wpdb->get\_results($wpdb->prepare( |
  | 952 | 952 | 'SELECT COLUMN\_NAME FROM INFORMATION\_SCHEMA.COLUMNS |
  | 953 | 953 | WHERE table\_name = %s AND column\_name = %s  AND TABLE\_SCHEMA = %s', |
  | 954 | 954 | array($wpdb->prefix . 'wpms\_links', 'referrer', $wpdb->dbname) |
  | 955 | 955 | )); |
  | 956 | 956 |  |
  | 957 | 957 | if (empty($row)) { |
  | 958 | 958 | $wpdb->query('ALTER TABLE ' . $wpdb->prefix . 'wpms\_links ADD referrer text DEFAULT ""'); |
  | 959 | 959 | } |
  | 960 | 960 | update\_option($option\_v, true); |
  | 961 | 961 | } |
  | 962 | 962 |  |
  | 963 | 963 | $option\_v = 'metaseo\_db\_version4.0.4'; |
  | 964 | 964 | $db\_installed = get\_option($option\_v, false); |
  | 965 | 965 | $wpms\_db\_version = get\_option('metaseo\_db\_version', false); |
  | 966 | 966 | // update plugin v4.3.5 |
  | 967 | 967 | if ($db\_installed && !$wpms\_db\_version) { |
  | 968 | 968 | // Get old settings |
  | 969 | 969 | $gaDisconnect = get\_option('\_metaseo\_ggtracking\_disconnect\_settings'); |
  | 970 | 970 |  |
  | 971 | 971 | // Update value to new ga parameters |
  | 972 | 972 | if ($gaDisconnect) { |
  | 973 | 973 | $this->gaDisconnect['wpms\_gg\_service\_tracking\_id'] = $gaDisconnect['wpms\_ga\_uax\_reference']; |
  | 974 | 974 | $this->gaDisconnect['wpms\_gg\_service\_tracking\_type'] = $gaDisconnect['wpmsga\_dash\_tracking\_type']; |
  | 975 | 975 | $this->gaDisconnect['wpmsga\_code\_tracking'] = $gaDisconnect['wpmsga\_code\_tracking']; |
  | 976 | 976 | $this->gaDisconnect['wpmstm\_header\_code\_tracking'] = ''; |
  | 977 | 977 | $this->gaDisconnect['wpmstm\_body\_code\_tracking'] = ''; |
  | 978 | 978 | update\_option('\_metaseo\_ggtracking\_disconnect\_settings', $this->gaDisconnect); |
  | 979 | 979 | } |
  | 980 | 980 | update\_option('metaseo\_db\_version', WPMSEO\_VERSION); |
  | 981 | 981 | } |
  | 982 | 982 | } |
  | 983 | 983 |  |
  | 984 | 984 | /\*\* |
  | 985 | 985 | \* Add field title in dialog link when edit a link |
  | 986 | 986 | \* |
  | 987 | 987 | \* @return void |
  | 988 | 988 | \*/ |
  | 989 | 989 | public function linkTitleField() |
  | 990 | 990 | { |
  | 991 | 991 | if (isset($this->settings['metaseo\_linkfield']) && (int)$this->settings['metaseo\_linkfield'] === 1) { |
  | 992 | 992 | wp\_enqueue\_script( |
  | 993 | 993 | 'wpmslinkTitle', |
  | 994 | 994 | plugins\_url('assets/js/wpms-link-title-field.js', dirname(\_\_FILE\_\_)), |
  | 995 | 995 | array('wplink'), |
  | 996 | 996 | WPMSEO\_VERSION, |
  | 997 | 997 | true |
  | 998 | 998 | ); |
  | 999 | 999 | wp\_localize\_script('wpmslinkTitle', 'wpmsLinkTitleL10n', array( |
  | 1000 | 1000 | 'titleLabel' => esc\_html\_\_('Title', 'wp-meta-seo'), |
  | 1001 | 1001 | )); |
  | 1002 | 1002 | } |
  | 1003 | 1003 | } |
  | 1004 | 1004 |  |
  | 1005 | 1005 | /\*\* |
  | 1006 | 1006 | \* Update option wpms\_set\_ignore |
  | 1007 | 1007 | \* |
  | 1008 | 1008 | \* @return void |
  | 1009 | 1009 | \*/ |
  | 1010 | 1010 | public function setIgnore() |
  | 1011 | 1011 | { |
  |  | 1012 | if (empty($\_POST['wpms\_nonce']) |
  |  | 1013 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  |  | 1014 | die(); |
  |  | 1015 | } |
  | 1012 | 1016 | if (!current\_user\_can('manage\_options')) { |
  | 1013 | 1017 | wp\_send\_json(false); |
  | 1014 | 1018 | } |
  | 1015 | 1019 | update\_option('wpms\_set\_ignore', 0); |
  | 1016 | 1020 | wp\_send\_json(true); |
  | 1017 | 1021 | } |
  | 1018 | 1022 |  |
  | 1019 | 1023 | /\*\* |
  | 1020 | 1024 | \* Render message error when disable search engines from indexing this site |
  | 1021 | 1025 | \* |
  | 1022 | 1026 | \* @return void |
  | 1023 | 1027 | \*/ |
  | 1024 | 1028 | public function publicWarning() |
  | 1025 | 1029 | { |
  | 1026 | 1030 | if ((function\_exists('is\_network\_admin') && is\_network\_admin())) { |
  | 1027 | 1031 | return; |
  | 1028 | 1032 | } |
  | 1029 | 1033 |  |
  | 1030 | 1034 | if ((int)get\_option('wpms\_set\_ignore') === 0) { |
  | 1031 | 1035 | return; |
  | 1032 | 1036 | } |
  | 1033 | 1037 |  |
  | 1034 | 1038 | printf( |
  | 1035 | 1039 | '<div id="robotsmessage" class="error"> |
  | 1036 | 1040 | <p> |
  | 1037 | 1041 | <strong>%1$s</strong> |
  | 1038 | 1042 | %2$s |
  | 1039 | 1043 | <a href="javascript:wpmsIgnore(\'wpms\_public\_warning\',\'robotsmessage\',\'%3$s\');" |
  | 1040 | 1044 | class="button">%4$s</a> |
  | 1041 | 1045 | </p> |
  | 1042 | 1046 | </div>', |
  | 1043 | 1047 | esc\_html\_\_('Your website is not indexed by search engine because of your WordPress settings.', 'wp-meta-seo'), |
  | 1044 | 1048 | sprintf( |
  | 1045 | 1049 | esc\_html\_\_('%1$sFix it now%2$s', 'wp-meta-seo'), |
  | 1046 | 1050 | sprintf('<a href="%s">', esc\_url(admin\_url('options-reading.php'))), |
  | 1047 | 1051 | '</a>' |
  | 1048 | 1052 | ), |
  | 1049 | 1053 | esc\_js(wp\_create\_nonce('wpseo-ignore')), |
  | 1050 | 1054 | esc\_html\_\_('OK I know that.', 'wp-meta-seo') |
  | 1051 | 1055 | ); |
  | 1052 | 1056 | } |
  | 1053 | 1057 |  |
  | 1054 | 1058 | /\*\* |
  | 1055 | 1059 | \* Loads translated strings. |
  | 1056 | 1060 | \* |
  | 1057 | 1061 | \* @return void |
  | 1058 | 1062 | \*/ |
  | 1059 | 1063 | public function loadLangguage() |
  | 1060 | 1064 | { |
  | 1061 | 1065 | load\_plugin\_textdomain( |
  | 1062 | 1066 | 'wp-meta-seo', |
  | 1063 | 1067 | false, |
  | 1064 | 1068 | dirname(plugin\_basename(\_\_FILE\_\_)) . DIRECTORY\_SEPARATOR . 'languages' . DIRECTORY\_SEPARATOR |
  | 1065 | 1069 | ); |
  | 1066 | 1070 | } |
  | 1067 | 1071 |  |
  | 1068 | 1072 | /\*\* |
  | 1069 | 1073 | \* Handle redirects to setup/welcome page after install and updates. |
  | 1070 | 1074 | \* |
  | 1071 | 1075 | \* For setup wizard, transient must be present, the user must have access rights, and we must ignore the network/bulk plugin updaters. |
  | 1072 | 1076 | \* |
  | 1073 | 1077 | \* @return void |
  | 1074 | 1078 | \*/ |
  | 1075 | 1079 | public function adminRedirects() |
  | 1076 | 1080 | { |
  | 1077 | 1081 | // Disable all admin notice for page belong to plugin |
  | 1078 | 1082 | add\_action('admin\_print\_scripts', function () { |
  | 1079 | 1083 | global $wp\_filter; |
  | 1080 | 1084 | // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- No action, nonce is not required |
  | 1081 | 1085 | if ((!empty($\_GET['page']) && in\_array($\_GET['page'], array('wpms-setup', 'metaseo\_settings', 'metaseo\_console')))) { |
  | 1082 | 1086 | if (is\_user\_admin()) { |
  | 1083 | 1087 | if (isset($wp\_filter['user\_admin\_notices'])) { |
  | 1084 | 1088 | unset($wp\_filter['user\_admin\_notices']); |
  | 1085 | 1089 | } |
  | 1086 | 1090 | } elseif (isset($wp\_filter['admin\_notices'])) { |
  | 1087 | 1091 | unset($wp\_filter['admin\_notices']); |
  | 1088 | 1092 | } |
  | 1089 | 1093 | if (isset($wp\_filter['all\_admin\_notices'])) { |
  | 1090 | 1094 | unset($wp\_filter['all\_admin\_notices']); |
  | 1091 | 1095 | } |
  | 1092 | 1096 | } |
  | 1093 | 1097 | }); |
  | 1094 | 1098 |  |
  | 1095 | 1099 | // Setup wizard redirect |
  | 1096 | 1100 | if (is\_null(get\_option('\_wpmf\_activation\_redirect', null)) && is\_null(get\_option('wpms\_version', null))) { |
  | 1097 | 1101 | // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- View request, no action |
  | 1098 | 1102 | if ((!empty($\_GET['page']) && in\_array($\_GET['page'], array('wpms-setup')))) { |
  | 1099 | 1103 | return; |
  | 1100 | 1104 | } |
  | 1101 | 1105 | update\_option('wpms\_version', WPMSEO\_VERSION); |
  | 1102 | 1106 | wp\_safe\_redirect(admin\_url('index.php?page=wpms-setup')); |
  | 1103 | 1107 | exit; |
  | 1104 | 1108 | } |
  | 1105 | 1109 | } |
  | 1106 | 1110 |  |
  | 1107 | 1111 | /\*\* |
  | 1108 | 1112 | \* Includes WP Media Folder setup |
  | 1109 | 1113 | \* |
  | 1110 | 1114 | \* @return void |
  | 1111 | 1115 | \*/ |
  | 1112 | 1116 | public function install() |
  | 1113 | 1117 | { |
  | 1114 | 1118 | // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- View request, no action |
  | 1115 | 1119 | if (!empty($\_GET['page'])) { |
  | 1116 | 1120 | // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- View request, no action |
  | 1117 | 1121 | switch ($\_GET['page']) { |
  | 1118 | 1122 | case 'wpms-setup': |
  | 1119 | 1123 | require\_once WPMETASEO\_PLUGIN\_DIR . '/inc/install-wizard/install-wizard.php'; |
  | 1120 | 1124 | break; |
  | 1121 | 1125 | } |
  | 1122 | 1126 | } |
  | 1123 | 1127 | } |
  | 1124 | 1128 |  |
  | 1125 | 1129 | /\*\* |
  | 1126 | 1130 | \* Create field analysis |
  | 1127 | 1131 | \* |
  | 1128 | 1132 | \* @param string $data\_title   Title |
  | 1129 | 1133 | \* @param string $alt          Alt text |
  | 1130 | 1134 | \* @param string $dashicon     Type |
  | 1131 | 1135 | \* @param string $label        Label |
  | 1132 | 1136 | \* @param string $value\_hidden Value |
  | 1133 | 1137 | \* |
  | 1134 | 1138 | \* @return string |
  | 1135 | 1139 | \*/ |
  | 1136 | 1140 | public function createFieldAnalysis($data\_title, $alt, $dashicon, $label, $value\_hidden) |
  | 1137 | 1141 | { |
  | 1138 | 1142 | $output = '<div class="metaseo\_analysis metaseo\_tool" data-title="' . esc\_attr($data\_title) . '" data-tippy="' . esc\_attr($alt) . '">'; |
  | 1139 | 1143 | if ($dashicon === 'done') { |
  | 1140 | 1144 | $output .= '<i class="metaseo-dashicons material-icons dashicons-before icons-mboxdone">done</i>'; |
  | 1141 | 1145 | } else { |
  | 1142 | 1146 | $output .= '<i class="metaseo-dashicons material-icons dashicons-before icons-mboxwarning">error\_outline</i>'; |
  | 1143 | 1147 | } |
  | 1144 | 1148 |  |
  | 1145 | 1149 | $output .= esc\_html($label); |
  | 1146 | 1150 | $output .= '</div>'; |
  | 1147 | 1151 | $output .= '<input type="hidden" class="wpms\_analysis\_hidden" |
  | 1148 | 1152 | name="' . esc\_attr('wpms[' . $data\_title . ']') . '" value="' . esc\_attr($value\_hidden) . '">'; |
  | 1149 | 1153 | return $output; |
  | 1150 | 1154 | } |
  | 1151 | 1155 |  |
  | 1152 | 1156 | /\*\* |
  | 1153 | 1157 | \* Get content |
  | 1154 | 1158 | \* |
  | 1155 | 1159 | \* @param string  $content Post content |
  | 1156 | 1160 | \* @param integer $post\_id Post ID |
  | 1157 | 1161 | \* |
  | 1158 | 1162 | \* @return string |
  | 1159 | 1163 | \*/ |
  | 1160 | 1164 | public function wpmsTheContent($content, $post\_id) |
  | 1161 | 1165 | { |
  | 1162 | 1166 | $content = apply\_filters( |
  | 1163 | 1167 | 'the\_content', |
  | 1164 | 1168 | $content, |
  | 1165 | 1169 | $post\_id |
  | 1166 | 1170 | ); |
  | 1167 | 1171 |  |
  | 1168 | 1172 | if (is\_plugin\_active('oxygen/functions.php')) { |
  | 1169 | 1173 | $shortcodes = get\_post\_meta($post\_id, 'ct\_builder\_shortcodes', true); |
  | 1170 | 1174 | $cf = do\_shortcode($shortcodes); |
  | 1171 | 1175 | $content = $content . $cf; |
  | 1172 | 1176 | } |
  | 1173 | 1177 |  |
  | 1174 | 1178 | return $content; |
  | 1175 | 1179 | } |
  | 1176 | 1180 |  |
  | 1177 | 1181 | /\*\* |
  | 1178 | 1182 | \* Get all the values of an array |
  | 1179 | 1183 | \* |
  | 1180 | 1184 | \* @param array $array List array to get value |
  | 1181 | 1185 | \* |
  | 1182 | 1186 | \* @return array|string |
  | 1183 | 1187 | \*/ |
  | 1184 | 1188 | public function getValues($array) |
  | 1185 | 1189 | { |
  | 1186 | 1190 | if (is\_array($array)) { |
  | 1187 | 1191 | $array = array\_values($array); |
  | 1188 | 1192 | } |
  | 1189 | 1193 |  |
  | 1190 | 1194 | return $array; |
  | 1191 | 1195 | } |
  | 1192 | 1196 |  |
  | 1193 | 1197 | /\*\* |
  | 1194 | 1198 | \* Check strpos with list array |
  | 1195 | 1199 | \* |
  | 1196 | 1200 | \* @param string  $haystack String to compare |
  | 1197 | 1201 | \* @param array   $needle   List array need compare |
  | 1198 | 1202 | \* @param integer $offset   Offset value |
  | 1199 | 1203 | \* |
  | 1200 | 1204 | \* @return boolean |
  | 1201 | 1205 | \*/ |
  | 1202 | 1206 | public function strPosArray($haystack, $needle, $offset = 0) |
  | 1203 | 1207 | { |
  | 1204 | 1208 | if (!is\_array($needle)) { |
  | 1205 | 1209 | $needle = array($needle); |
  | 1206 | 1210 | } |
  | 1207 | 1211 | foreach ($needle as $query) { |
  | 1208 | 1212 | // stop on first true result |
  | 1209 | 1213 | if (strpos($haystack, $query, $offset) !== false) { |
  | 1210 | 1214 | return true; |
  | 1211 | 1215 | } |
  | 1212 | 1216 | } |
  | 1213 | 1217 | return false; |
  | 1214 | 1218 | } |
  | 1215 | 1219 |  |
  | 1216 | 1220 | /\*\* |
  | 1217 | 1221 | \* Recursion to get specific value of file |
  | 1218 | 1222 | \* |
  | 1219 | 1223 | \* @param array $fields List specific value of field |
  | 1220 | 1224 | \* |
  | 1221 | 1225 | \* @return string |
  | 1222 | 1226 | \*/ |
  | 1223 | 1227 | public function getACFData($fields) |
  | 1224 | 1228 | { |
  | 1225 | 1229 | $values = $this->getValues($fields); |
  | 1226 | 1230 | $data = ''; |
  | 1227 | 1231 |  |
  | 1228 | 1232 | if (is\_array($values)) { |
  | 1229 | 1233 | foreach ($values as $item) { |
  | 1230 | 1234 | switch (gettype($item)) { |
  | 1231 | 1235 | case 'array': |
  | 1232 | 1236 | $data .= $this->getACFData($item); |
  | 1233 | 1237 | break; |
  | 1234 | 1238 | case 'string': |
  | 1235 | 1239 | // Check link |
  | 1236 | 1240 | if (filter\_var($item, FILTER\_VALIDATE\_URL)) { |
  | 1237 | 1241 | $checkImageLink = $this->strPosArray($item, array('.jpg', '.png', '.jpeg', 'svg', 'gif')); |
  | 1238 | 1242 | if (!$checkImageLink) { |
  | 1239 | 1243 | $item = '<a href="' . $item . '">' . $item . '</a>'; |
  | 1240 | 1244 | } |
  | 1241 | 1245 | } |
  | 1242 | 1246 | $data .= ' ' . $item; |
  | 1243 | 1247 | break; |
  | 1244 | 1248 | } |
  | 1245 | 1249 | } |
  | 1246 | 1250 | } |
  | 1247 | 1251 | if (is\_string($values)) { |
  | 1248 | 1252 | $data .= ' ' . $values; |
  | 1249 | 1253 | } |
  | 1250 | 1254 | return $data; |
  | 1251 | 1255 | } |
  | 1252 | 1256 |  |
  | 1253 | 1257 | /\*\* |
  | 1254 | 1258 | \* Inject ACF field to content |
  | 1255 | 1259 | \* |
  | 1256 | 1260 | \* @param string  $content Post content |
  | 1257 | 1261 | \* @param integer $post\_id Post ID |
  | 1258 | 1262 | \* |
  | 1259 | 1263 | \* @return string |
  | 1260 | 1264 | \*/ |
  | 1261 | 1265 | public function injectAcfField($content, $post\_id) |
  | 1262 | 1266 | { |
  | 1263 | 1267 | if (class\_exists('ACF')) { |
  | 1264 | 1268 | $fields = get\_field\_objects($post\_id); |
  | 1265 | 1269 |  |
  | 1266 | 1270 | if (!empty($fields)) { |
  | 1267 | 1271 | $inject = ''; |
  | 1268 | 1272 | foreach ($fields as $name => $field) { |
  | 1269 | 1273 | if ($field['type'] === 'image') { |
  | 1270 | 1274 | $size = $field['preview\_size']; |
  | 1271 | 1275 | if (is\_array($field['value'])) { |
  | 1272 | 1276 | $caption = $field['value']['caption']; |
  | 1273 | 1277 | // Get image link if field is array |
  | 1274 | 1278 | if ($caption) { |
  | 1275 | 1279 | $inject .= '<div class="wp-caption">'; |
  | 1276 | 1280 | } |
  | 1277 | 1281 | $inject = '<a href="' . $field['value']['url'] . '" title="' . $field['value']['title'] . '">'; |
  | 1278 | 1282 | $inject .= '<img src="' . $field['value']['sizes'][$size] . '" alt="' . $field['value']['alt'] . '" width="' . $field['value']['sizes'][$size . '-width'] . '" height="' . $field['value']['sizes'][$size . '-height'] . '" />'; |
  | 1279 | 1283 | $inject .= '</a>'; |
  | 1280 | 1284 | if ($caption) { |
  | 1281 | 1285 | $inject .= '<p class="wp-caption-text">' . $caption . '</p>'; |
  | 1282 | 1286 | } |
  | 1283 | 1287 | $inject .= '</div>'; |
  | 1284 | 1288 | } elseif (is\_string($field['value'])) { |
  | 1285 | 1289 | $inject = '<img src="' . $field['value'] . '" />'; |
  | 1286 | 1290 | } else { |
  | 1287 | 1291 | $inject = wp\_get\_attachment\_image($field['value'], $size); |
  | 1288 | 1292 | } |
  | 1289 | 1293 | } elseif ($field['type'] === 'link') { |
  | 1290 | 1294 | // Get link if field is array |
  | 1291 | 1295 | if (is\_array($field['value'])) { |
  | 1292 | 1296 | $inject = '<a class="link-url" href="' . $field['value']['url'] . '" target="' . ($field['value']['target'] ? $field['value']['target'] : '\_self') . '">' . esc\_html($field['value']['title']) . '</a>'; |
  | 1293 | 1297 | } else { |
  | 1294 | 1298 | $inject = '<a class="link-url" href="' . $field['value'] . '">' . esc\_html($field['value']) . '</a>'; |
  | 1295 | 1299 | } |
  | 1296 | 1300 | } else { |
  | 1297 | 1301 | $inject = $this->getACFData($field['value']); |
  | 1298 | 1302 | } |
  | 1299 | 1303 |  |
  | 1300 | 1304 | $content .= ' ' . $inject; |
  | 1301 | 1305 | } |
  | 1302 | 1306 | } |
  | 1303 | 1307 | } |
  | 1304 | 1308 |  |
  | 1305 | 1309 | return $content; |
  | 1306 | 1310 | } |
  | 1307 | 1311 |  |
  | 1308 | 1312 | /\*\* |
  | 1309 | 1313 | \* Inject Woocommerce short description to content |
  | 1310 | 1314 | \* |
  | 1311 | 1315 | \* @param string  $content Post content |
  | 1312 | 1316 | \* @param integer $post\_id Post ID |
  | 1313 | 1317 | \* |
  | 1314 | 1318 | \* @return string |
  | 1315 | 1319 | \*/ |
  | 1316 | 1320 | public function injectWooCommerce($content, $post\_id) |
  | 1317 | 1321 | { |
  | 1318 | 1322 | if (class\_exists('WooCommerce')) { |
  | 1319 | 1323 | $post = get\_post($post\_id); |
  | 1320 | 1324 |  |
  | 1321 | 1325 | if (!empty($post->post\_excerpt)) { |
  | 1322 | 1326 | $content .= '' . $post->post\_excerpt; |
  | 1323 | 1327 | } |
  | 1324 | 1328 | } |
  | 1325 | 1329 |  |
  | 1326 | 1330 | return $content; |
  | 1327 | 1331 | } |
  | 1328 | 1332 |  |
  | 1329 | 1333 | /\*\* |
  | 1330 | 1334 | \* Ajax load page analysis |
  | 1331 | 1335 | \* |
  | 1332 | 1336 | \* @return void |
  | 1333 | 1337 | \*/ |
  | 1334 | 1338 | public function reloadAnalysis() |
  | 1335 | 1339 | { |
  | 1336 | 1340 | if (empty($\_POST['wpms\_nonce']) |
  | 1337 | 1341 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 1338 | 1342 | die(); |
  | 1339 | 1343 | } |
  | 1340 | 1344 |  |
  | 1341 | 1345 | if (!current\_user\_can('edit\_posts')) { |
  | 1342 | 1346 | wp\_send\_json(array('status' => false)); |
  | 1343 | 1347 | } |
  | 1344 | 1348 | $tooltip\_page = array(); |
  | 1345 | 1349 | $tooltip\_page['title\_in\_heading'] = esc\_attr\_\_('Check if a word of this content title |
  | 1346 | 1350 | is also in a title heading (h1, h2...)', 'wp-meta-seo'); |
  | 1347 | 1351 | $tooltip\_page['title\_in\_content'] = esc\_attr\_\_('Check if a word of this content |
  | 1348 | 1352 | title is also in the text', 'wp-meta-seo'); |
  | 1349 | 1353 | $tooltip\_page['page\_url'] = esc\_attr\_\_('Does the page title match with the permalink (URL structure)', 'wp-meta-seo'); |
  | 1350 | 1354 | $tooltip\_page['meta\_title'] = esc\_attr\_\_('Is the meta title of this page filled?', 'wp-meta-seo'); |
  | 1351 | 1355 | $tooltip\_page['meta\_desc'] = esc\_attr\_\_('Is the meta description of this page filled?', 'wp-meta-seo'); |
  | 1352 | 1356 | $tooltip\_page['image\_resize'] = esc\_attr\_\_('Check for image HTML resizing in content |
  | 1353 | 1357 | (usually image resized using handles)', 'wp-meta-seo'); |
  | 1354 | 1358 | $tooltip\_page['image\_alt'] = esc\_attr\_\_('Check for image Alt text and title', 'wp-meta-seo'); |
  | 1355 | 1359 | if (empty($\_POST['datas'])) { |
  | 1356 | 1360 | wp\_send\_json(false); |
  | 1357 | 1361 | } |
  | 1358 | 1362 |  |
  | 1359 | 1363 | if (isset($\_POST['datas']['post\_id']) && empty($\_POST['datas']['first\_load'])) { |
  | 1360 | 1364 | update\_post\_meta($\_POST['datas']['post\_id'], 'wpms\_validate\_analysis', ''); |
  | 1361 | 1365 | } |
  | 1362 | 1366 |  |
  | 1363 | 1367 | $meta\_analysis = get\_post\_meta((int)$\_POST['datas']['post\_id'], 'wpms\_validate\_analysis', true); |
  | 1364 | 1368 | $check = 0; |
  | 1365 | 1369 | $output = ''; |
  | 1366 | 1370 |  |
  | 1367 | 1371 | // title heading |
  | 1368 | 1372 | $words\_post\_title = preg\_split( |
  | 1369 | 1373 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1370 | 1374 | strtolower($\_POST['datas']['title']), |
  | 1371 | 1375 | -1, |
  | 1372 | 1376 | PREG\_SPLIT\_NO\_EMPTY |
  | 1373 | 1377 | ); |
  | 1374 | 1378 |  |
  | 1375 | 1379 | // do shortcode js\_composer plugin |
  | 1376 | 1380 | if (is\_plugin\_active('js\_composer\_theme/js\_composer.php')) { |
  | 1377 | 1381 | add\_shortcode('mk\_fancy\_title', 'vc\_do\_shortcode'); |
  | 1378 | 1382 | } |
  | 1379 | 1383 |  |
  | 1380 | 1384 | $content = apply\_filters( |
  | 1381 | 1385 | 'wpms\_the\_content', |
  | 1382 | 1386 | '<div>' . html\_entity\_decode(stripcslashes($\_POST['datas']['content']), ENT\_COMPAT, 'UTF-8') . '</div>', |
  | 1383 | 1387 | $\_POST['datas']['post\_id'] |
  | 1384 | 1388 | ); |
  | 1385 | 1389 |  |
  | 1386 | 1390 | $content = $this->injectAcfField($content, $\_POST['datas']['post\_id']); |
  | 1387 | 1391 |  |
  | 1388 | 1392 | $content = $this->injectWooCommerce($content, $\_POST['datas']['post\_id']); |
  | 1389 | 1393 |  |
  | 1390 | 1394 | if (isset($\_POST['datas']['first\_load']) && !empty($meta\_analysis) && !empty($meta\_analysis['heading\_title'])) { |
  | 1391 | 1395 | $output .= $this->createFieldAnalysis( |
  | 1392 | 1396 | 'heading\_title', |
  | 1393 | 1397 | $tooltip\_page['title\_in\_heading'], |
  | 1394 | 1398 | 'done', |
  | 1395 | 1399 | esc\_html\_\_('Page title word in content heading', 'wp-meta-seo'), |
  | 1396 | 1400 | 1 |
  | 1397 | 1401 | ); |
  | 1398 | 1402 | $check++; |
  | 1399 | 1403 | } else { |
  | 1400 | 1404 | if ($content === '') { |
  | 1401 | 1405 | $output .= $this->createFieldAnalysis( |
  | 1402 | 1406 | 'heading\_title', |
  | 1403 | 1407 | $tooltip\_page['title\_in\_heading'], |
  | 1404 | 1408 | 'warning', |
  | 1405 | 1409 | esc\_html\_\_('Page title word in content heading', 'wp-meta-seo'), |
  | 1406 | 1410 | 0 |
  | 1407 | 1411 | ); |
  | 1408 | 1412 | } else { |
  | 1409 | 1413 | // Extracting the specified elements from the web page |
  | 1410 | 1414 | $tags\_h1 = wpmsExtractTags($content, 'h1', false, true); |
  | 1411 | 1415 | $tags\_h2 = wpmsExtractTags($content, 'h2', false, true); |
  | 1412 | 1416 | $tags\_h3 = wpmsExtractTags($content, 'h3', false, true); |
  | 1413 | 1417 | $tags\_h4 = wpmsExtractTags($content, 'h4', false, true); |
  | 1414 | 1418 | $tags\_h5 = wpmsExtractTags($content, 'h5', false, true); |
  | 1415 | 1419 | $tags\_h6 = wpmsExtractTags($content, 'h6', false, true); |
  | 1416 | 1420 |  |
  | 1417 | 1421 | // extract heading tags from WPBakery plugin shortcode |
  | 1418 | 1422 | if (is\_plugin\_active('js\_composer/js\_composer.php') && isset($\_POST['datas']['content'])) { |
  | 1419 | 1423 | $textContent = $\_POST['datas']['content']; |
  | 1420 | 1424 | $textContent = html\_entity\_decode(stripcslashes($textContent), ENT\_COMPAT, 'UTF-8'); |
  | 1421 | 1425 | $msPostTitle = isset($\_POST['datas']['title']) ? $\_POST['datas']['title'] : ''; |
  | 1422 | 1426 | $vcCustomHeading = $this->wpmsShortcodeExtract($msPostTitle, $textContent, array('h1', 'h2', 'h3', 'h4', 'h5', 'h6')); |
  | 1423 | 1427 | if (!empty($vcCustomHeading)) { |
  | 1424 | 1428 | $tags\_h1 = array\_merge($tags\_h1, $vcCustomHeading['h1']); |
  | 1425 | 1429 | $tags\_h2 = array\_merge($tags\_h2, $vcCustomHeading['h2']); |
  | 1426 | 1430 | $tags\_h3 = array\_merge($tags\_h3, $vcCustomHeading['h3']); |
  | 1427 | 1431 | $tags\_h4 = array\_merge($tags\_h4, $vcCustomHeading['h4']); |
  | 1428 | 1432 | $tags\_h5 = array\_merge($tags\_h5, $vcCustomHeading['h5']); |
  | 1429 | 1433 | $tags\_h6 = array\_merge($tags\_h6, $vcCustomHeading['h6']); |
  | 1430 | 1434 | } |
  | 1431 | 1435 | } |
  | 1432 | 1436 | $test = false; |
  | 1433 | 1437 | if (empty($tags\_h1) && empty($tags\_h2) && empty($tags\_h3) |
  | 1434 | 1438 | && empty($tags\_h4) && empty($tags\_h5) && empty($tags\_h6)) { |
  | 1435 | 1439 | $test = false; |
  | 1436 | 1440 | } else { |
  | 1437 | 1441 | // check tag h1 |
  | 1438 | 1442 | if (!empty($tags\_h1)) { |
  | 1439 | 1443 | foreach ($tags\_h1 as $order => $tagh1) { |
  | 1440 | 1444 | $words\_tagh1 = preg\_split( |
  | 1441 | 1445 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1442 | 1446 | strtolower($tagh1['contents']), |
  | 1443 | 1447 | -1, |
  | 1444 | 1448 | PREG\_SPLIT\_NO\_EMPTY |
  | 1445 | 1449 | ); |
  | 1446 | 1450 |  |
  | 1447 | 1451 | if (is\_array($words\_tagh1) && is\_array($words\_post\_title)) { |
  | 1448 | 1452 | foreach ($words\_tagh1 as $mh) { |
  | 1449 | 1453 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 1450 | 1454 | $test = true; |
  | 1451 | 1455 | } |
  | 1452 | 1456 | } |
  | 1453 | 1457 | } |
  | 1454 | 1458 | } |
  | 1455 | 1459 | } |
  | 1456 | 1460 |  |
  | 1457 | 1461 | // check tag h2 |
  | 1458 | 1462 | if (!empty($tags\_h2)) { |
  | 1459 | 1463 | foreach ($tags\_h2 as $order => $tagh2) { |
  | 1460 | 1464 | $words\_tagh2 = preg\_split( |
  | 1461 | 1465 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1462 | 1466 | strtolower($tagh2['contents']), |
  | 1463 | 1467 | -1, |
  | 1464 | 1468 | PREG\_SPLIT\_NO\_EMPTY |
  | 1465 | 1469 | ); |
  | 1466 | 1470 | if (is\_array($words\_tagh2) && is\_array($words\_post\_title)) { |
  | 1467 | 1471 | foreach ($words\_tagh2 as $mh) { |
  | 1468 | 1472 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 1469 | 1473 | $test = true; |
  | 1470 | 1474 | } |
  | 1471 | 1475 | } |
  | 1472 | 1476 | } |
  | 1473 | 1477 | } |
  | 1474 | 1478 | } |
  | 1475 | 1479 |  |
  | 1476 | 1480 | // check tag h3 |
  | 1477 | 1481 | if (!empty($tags\_h3)) { |
  | 1478 | 1482 | foreach ($tags\_h3 as $order => $tagh3) { |
  | 1479 | 1483 | $words\_tagh3 = preg\_split( |
  | 1480 | 1484 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1481 | 1485 | strtolower($tagh3['contents']), |
  | 1482 | 1486 | -1, |
  | 1483 | 1487 | PREG\_SPLIT\_NO\_EMPTY |
  | 1484 | 1488 | ); |
  | 1485 | 1489 | if (is\_array($words\_tagh3) && is\_array($words\_post\_title)) { |
  | 1486 | 1490 | foreach ($words\_tagh3 as $mh) { |
  | 1487 | 1491 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 1488 | 1492 | $test = true; |
  | 1489 | 1493 | } |
  | 1490 | 1494 | } |
  | 1491 | 1495 | } |
  | 1492 | 1496 | } |
  | 1493 | 1497 | } |
  | 1494 | 1498 |  |
  | 1495 | 1499 | // check tag h4 |
  | 1496 | 1500 | if (!empty($tags\_h4)) { |
  | 1497 | 1501 | foreach ($tags\_h4 as $order => $tagh4) { |
  | 1498 | 1502 | $words\_tagh4 = preg\_split( |
  | 1499 | 1503 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1500 | 1504 | strtolower($tagh4['contents']), |
  | 1501 | 1505 | -1, |
  | 1502 | 1506 | PREG\_SPLIT\_NO\_EMPTY |
  | 1503 | 1507 | ); |
  | 1504 | 1508 | if (is\_array($words\_tagh4) && is\_array($words\_post\_title)) { |
  | 1505 | 1509 | foreach ($words\_tagh4 as $mh) { |
  | 1506 | 1510 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 1507 | 1511 | $test = true; |
  | 1508 | 1512 | } |
  | 1509 | 1513 | } |
  | 1510 | 1514 | } |
  | 1511 | 1515 | } |
  | 1512 | 1516 | } |
  | 1513 | 1517 |  |
  | 1514 | 1518 | // check tag h5 |
  | 1515 | 1519 | if (!empty($tags\_h5)) { |
  | 1516 | 1520 | foreach ($tags\_h5 as $order => $tagh5) { |
  | 1517 | 1521 | $words\_tagh5 = preg\_split( |
  | 1518 | 1522 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1519 | 1523 | strtolower($tagh5['contents']), |
  | 1520 | 1524 | -1, |
  | 1521 | 1525 | PREG\_SPLIT\_NO\_EMPTY |
  | 1522 | 1526 | ); |
  | 1523 | 1527 | if (is\_array($words\_tagh5) && is\_array($words\_post\_title)) { |
  | 1524 | 1528 | foreach ($words\_tagh5 as $mh) { |
  | 1525 | 1529 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 1526 | 1530 | $test = true; |
  | 1527 | 1531 | } |
  | 1528 | 1532 | } |
  | 1529 | 1533 | } |
  | 1530 | 1534 | } |
  | 1531 | 1535 | } |
  | 1532 | 1536 |  |
  | 1533 | 1537 | // check tag h6 |
  | 1534 | 1538 | if (!empty($tags\_h6)) { |
  | 1535 | 1539 | foreach ($tags\_h6 as $order => $tagh6) { |
  | 1536 | 1540 | $words\_tagh6 = preg\_split( |
  | 1537 | 1541 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1538 | 1542 | strtolower($tagh6['contents']), |
  | 1539 | 1543 | -1, |
  | 1540 | 1544 | PREG\_SPLIT\_NO\_EMPTY |
  | 1541 | 1545 | ); |
  | 1542 | 1546 | if (is\_array($words\_tagh6) && is\_array($words\_post\_title)) { |
  | 1543 | 1547 | foreach ($words\_tagh6 as $mh) { |
  | 1544 | 1548 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 1545 | 1549 | $test = true; |
  | 1546 | 1550 | } |
  | 1547 | 1551 | } |
  | 1548 | 1552 | } |
  | 1549 | 1553 | } |
  | 1550 | 1554 | } |
  | 1551 | 1555 | } |
  | 1552 | 1556 |  |
  | 1553 | 1557 | if ($test) { |
  | 1554 | 1558 | $output .= $this->createFieldAnalysis( |
  | 1555 | 1559 | 'heading\_title', |
  | 1556 | 1560 | $tooltip\_page['title\_in\_heading'], |
  | 1557 | 1561 | 'done', |
  | 1558 | 1562 | esc\_html\_\_('Page title word in content heading', 'wp-meta-seo'), |
  | 1559 | 1563 | 1 |
  | 1560 | 1564 | ); |
  | 1561 | 1565 | $check++; |
  | 1562 | 1566 | } else { |
  | 1563 | 1567 | $output .= $this->createFieldAnalysis( |
  | 1564 | 1568 | 'heading\_title', |
  | 1565 | 1569 | $tooltip\_page['title\_in\_heading'], |
  | 1566 | 1570 | 'warning', |
  | 1567 | 1571 | esc\_html\_\_('Page title word in content heading', 'wp-meta-seo'), |
  | 1568 | 1572 | 0 |
  | 1569 | 1573 | ); |
  | 1570 | 1574 | } |
  | 1571 | 1575 | } |
  | 1572 | 1576 | } |
  | 1573 | 1577 |  |
  | 1574 | 1578 | // title content |
  | 1575 | 1579 | $words\_title = preg\_split( |
  | 1576 | 1580 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1577 | 1581 | strtolower($\_POST['datas']['title']), |
  | 1578 | 1582 | -1, |
  | 1579 | 1583 | PREG\_SPLIT\_NO\_EMPTY |
  | 1580 | 1584 | ); |
  | 1581 | 1585 | $words\_post\_content = preg\_split( |
  | 1582 | 1586 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 1583 | 1587 | strtolower(strip\_tags($content)), |
  | 1584 | 1588 | -1, |
  | 1585 | 1589 | PREG\_SPLIT\_NO\_EMPTY |
  | 1586 | 1590 | ); |
  | 1587 | 1591 |  |
  | 1588 | 1592 | $test1 = false; |
  | 1589 | 1593 | if (is\_array($words\_title) && is\_array($words\_post\_content)) { |
  | 1590 | 1594 | foreach ($words\_title as $mtitle) { |
  | 1591 | 1595 | if (in\_array($mtitle, $words\_post\_content) && $mtitle !== '') { |
  | 1592 | 1596 | $test1 = true; |
  | 1593 | 1597 | break; |
  | 1594 | 1598 | } |
  | 1595 | 1599 | } |
  | 1596 | 1600 | } else { |
  | 1597 | 1601 | $test1 = false; |
  | 1598 | 1602 | } |
  | 1599 | 1603 |  |
  | 1600 | 1604 | if (isset($\_POST['datas']['first\_load']) && !empty($meta\_analysis) && !empty($meta\_analysis['content\_title'])) { |
  | 1601 | 1605 | $output .= $this->createFieldAnalysis( |
  | 1602 | 1606 | 'content\_title', |
  | 1603 | 1607 | $tooltip\_page['title\_in\_content'], |
  | 1604 | 1608 | 'done', |
  | 1605 | 1609 | esc\_html\_\_('Page title word in content', 'wp-meta-seo'), |
  | 1606 | 1610 | 1 |
  | 1607 | 1611 | ); |
  | 1608 | 1612 | $check++; |
  | 1609 | 1613 | } else { |
  | 1610 | 1614 | if ($test1) { |
  | 1611 | 1615 | $output .= $this->createFieldAnalysis( |
  | 1612 | 1616 | 'content\_title', |
  | 1613 | 1617 | $tooltip\_page['title\_in\_content'], |
  | 1614 | 1618 | 'done', |
  | 1615 | 1619 | esc\_html\_\_('Page title word in content', 'wp-meta-seo'), |
  | 1616 | 1620 | 1 |
  | 1617 | 1621 | ); |
  | 1618 | 1622 | $check++; |
  | 1619 | 1623 | } else { |
  | 1620 | 1624 | $output .= $this->createFieldAnalysis( |
  | 1621 | 1625 | 'content\_title', |
  | 1622 | 1626 | $tooltip\_page['title\_in\_content'], |
  | 1623 | 1627 | 'warning', |
  | 1624 | 1628 | esc\_html\_\_('Page title word in content', 'wp-meta-seo'), |
  | 1625 | 1629 | 0 |
  | 1626 | 1630 | ); |
  | 1627 | 1631 | } |
  | 1628 | 1632 | } |
  | 1629 | 1633 |  |
  | 1630 | 1634 | // page url matches page title |
  | 1631 | 1635 | $mtitle = $\_POST['datas']['title']; |
  | 1632 | 1636 | if (isset($\_POST['datas']['first\_load']) && !empty($meta\_analysis) && !empty($meta\_analysis['pageurl'])) { |
  | 1633 | 1637 | $output .= $this->createFieldAnalysis( |
  | 1634 | 1638 | 'pageurl', |
  | 1635 | 1639 | $tooltip\_page['page\_url'], |
  | 1636 | 1640 | 'done', |
  | 1637 | 1641 | esc\_html\_\_('Page url matches with page title', 'wp-meta-seo'), |
  | 1638 | 1642 | 1 |
  | 1639 | 1643 | ); |
  | 1640 | 1644 | $check++; |
  | 1641 | 1645 | } else { |
  | 1642 | 1646 | $mpageurl = ''; |
  | 1643 | 1647 | if (isset($\_POST['datas']['mpageurl'])) { |
  | 1644 | 1648 | $infos = pathinfo($\_POST['datas']['mpageurl']); |
  | 1645 | 1649 | $mpageurl = $infos['filename']; |
  | 1646 | 1650 | if ($mpageurl[0] === '?') { |
  | 1647 | 1651 | $mpageurl = ltrim($mpageurl, '?'); // remove ? from ?page=abc |
  | 1648 | 1652 | } |
  | 1649 | 1653 | } |
  | 1650 | 1654 |  |
  | 1651 | 1655 | //check is home page |
  | 1652 | 1656 | $home\_url = home\_url(); |
  | 1653 | 1657 | $home\_url\_1 = explode('//', $home\_url); |
  | 1654 | 1658 | $is\_home = false; |
  | 1655 | 1659 | if (!empty($home\_url\_1[1]) && isset($\_POST['datas']['mpageurl'])) { |
  | 1656 | 1660 | $home\_url\_2 = explode($home\_url\_1[1], $\_POST['datas']['mpageurl']); |
  | 1657 | 1661 | if (!isset($home\_url\_2[1]) || (!empty($home\_url\_2[1]) && $home\_url\_2[1] === '/')) { |
  | 1658 | 1662 | $is\_home = true; |
  | 1659 | 1663 | } |
  | 1660 | 1664 | } |
  | 1661 | 1665 |  |
  | 1662 | 1666 | if ((isset($\_POST['datas']['mpageurl']) && $is\_home) || (!empty($mpageurl) && !empty($mtitle) && strpos(sanitize\_title($mtitle), sanitize\_title($mpageurl)) !== false)) { |
  | 1663 | 1667 | $output .= $this->createFieldAnalysis( |
  | 1664 | 1668 | 'pageurl', |
  | 1665 | 1669 | $tooltip\_page['page\_url'], |
  | 1666 | 1670 | 'done', |
  | 1667 | 1671 | esc\_html\_\_('Page url matches with page title', 'wp-meta-seo'), |
  | 1668 | 1672 | 1 |
  | 1669 | 1673 | ); |
  | 1670 | 1674 | $check++; |
  | 1671 | 1675 | } else { |
  | 1672 | 1676 | $output .= $this->createFieldAnalysis( |
  | 1673 | 1677 | 'pageurl', |
  | 1674 | 1678 | $tooltip\_page['page\_url'], |
  | 1675 | 1679 | 'warning', |
  | 1676 | 1680 | esc\_html\_\_('Page url matches with page title', 'wp-meta-seo'), |
  | 1677 | 1681 | 0 |
  | 1678 | 1682 | ); |
  | 1679 | 1683 | } |
  | 1680 | 1684 | } |
  | 1681 | 1685 |  |
  | 1682 | 1686 | // meta title filled |
  | 1683 | 1687 | if (isset($\_POST['datas']['first\_load']) && !empty($meta\_analysis) && !empty($meta\_analysis['metatitle'])) { |
  | 1684 | 1688 | $output .= $this->createFieldAnalysis( |
  | 1685 | 1689 | 'metatitle', |
  | 1686 | 1690 | $tooltip\_page['meta\_title'], |
  | 1687 | 1691 | 'done', |
  | 1688 | 1692 | esc\_html\_\_('Meta title filled', 'wp-meta-seo'), |
  | 1689 | 1693 | 1 |
  | 1690 | 1694 | ); |
  | 1691 | 1695 | $check++; |
  | 1692 | 1696 | } else { |
  | 1693 | 1697 | if (($\_POST['datas']['meta\_title'] !== '' |
  | 1694 | 1698 | && mb\_strlen($\_POST['datas']['meta\_title'], 'UTF-8') <= self::$title\_length)) { |
  | 1695 | 1699 | $output .= $this->createFieldAnalysis( |
  | 1696 | 1700 | 'metatitle', |
  | 1697 | 1701 | $tooltip\_page['meta\_title'], |
  | 1698 | 1702 | 'done', |
  | 1699 | 1703 | esc\_html\_\_('Meta title filled', 'wp-meta-seo'), |
  | 1700 | 1704 | 1 |
  | 1701 | 1705 | ); |
  | 1702 | 1706 | $check++; |
  | 1703 | 1707 | } else { |
  | 1704 | 1708 | $output .= $this->createFieldAnalysis( |
  | 1705 | 1709 | 'metatitle', |
  | 1706 | 1710 | $tooltip\_page['meta\_title'], |
  | 1707 | 1711 | 'warning', |
  | 1708 | 1712 | esc\_html\_\_('Meta title filled', 'wp-meta-seo'), |
  | 1709 | 1713 | 0 |
  | 1710 | 1714 | ); |
  | 1711 | 1715 | } |
  | 1712 | 1716 | } |
  | 1713 | 1717 |  |
  | 1714 | 1718 | // desc filled |
  | 1715 | 1719 | if (isset($\_POST['datas']['first\_load']) && !empty($meta\_analysis) && !empty($meta\_analysis['metadesc'])) { |
  | 1716 | 1720 | $output .= $this->createFieldAnalysis( |
  | 1717 | 1721 | 'metadesc', |
  | 1718 | 1722 | $tooltip\_page['meta\_desc'], |
  | 1719 | 1723 | 'done', |
  | 1720 | 1724 | esc\_html\_\_('Meta description filled', 'wp-meta-seo'), |
  | 1721 | 1725 | 1 |
  | 1722 | 1726 | ); |
  | 1723 | 1727 | $check++; |
  | 1724 | 1728 | } else { |
  | 1725 | 1729 | if ($\_POST['datas']['meta\_desc'] !== '' |
  | 1726 | 1730 | && mb\_strlen($\_POST['datas']['meta\_desc'], 'UTF-8') <= self::$desc\_length) { |
  | 1727 | 1731 | $output .= $this->createFieldAnalysis( |
  | 1728 | 1732 | 'metadesc', |
  | 1729 | 1733 | $tooltip\_page['meta\_desc'], |
  | 1730 | 1734 | 'done', |
  | 1731 | 1735 | esc\_html\_\_('Meta description filled', 'wp-meta-seo'), |
  | 1732 | 1736 | 1 |
  | 1733 | 1737 | ); |
  | 1734 | 1738 | $check++; |
  | 1735 | 1739 | } else { |
  | 1736 | 1740 | $output .= $this->createFieldAnalysis( |
  | 1737 | 1741 | 'metadesc', |
  | 1738 | 1742 | $tooltip\_page['meta\_desc'], |
  | 1739 | 1743 | 'warning', |
  | 1740 | 1744 | esc\_html\_\_('Meta description filled', 'wp-meta-seo'), |
  | 1741 | 1745 | 0 |
  | 1742 | 1746 | ); |
  | 1743 | 1747 | } |
  | 1744 | 1748 | } |
  | 1745 | 1749 |  |
  | 1746 | 1750 | // image resize |
  | 1747 | 1751 | if ($content === '') { |
  | 1748 | 1752 | $output .= $this->createFieldAnalysis( |
  | 1749 | 1753 | 'imgresize', |
  | 1750 | 1754 | $tooltip\_page['image\_resize'], |
  | 1751 | 1755 | 'done', |
  | 1752 | 1756 | esc\_html\_\_('Wrong image resize', 'wp-meta-seo'), |
  | 1753 | 1757 | 1 |
  | 1754 | 1758 | ); |
  | 1755 | 1759 | $output .= $this->createFieldAnalysis( |
  | 1756 | 1760 | 'imgalt', |
  | 1757 | 1761 | $tooltip\_page['image\_alt'], |
  | 1758 | 1762 | 'done', |
  | 1759 | 1763 | esc\_html\_\_('Image alt information filled', 'wp-meta-seo'), |
  | 1760 | 1764 | 1 |
  | 1761 | 1765 | ); |
  | 1762 | 1766 | $check += 2; |
  | 1763 | 1767 | } else { |
  | 1764 | 1768 | // Extracting the specified elements from the web page |
  | 1765 | 1769 | $img\_tags = wpmsExtractTags($content, 'img', true, true); |
  | 1766 | 1770 | $img\_wrong = false; |
  | 1767 | 1771 | $img\_wrong\_alt = false; |
  | 1768 | 1772 | foreach ($img\_tags as $order => $tag) { |
  | 1769 | 1773 | if (!isset($tag['attributes']['src'])) { |
  | 1770 | 1774 | continue; |
  | 1771 | 1775 | } |
  | 1772 | 1776 |  |
  | 1773 | 1777 | $src = $tag['attributes']['src']; |
  | 1774 | 1778 | $imgpath = str\_replace(site\_url(), ABSPATH, $src); |
  | 1775 | 1779 | if (!file\_exists($imgpath)) { |
  | 1776 | 1780 | continue; |
  | 1777 | 1781 | } |
  | 1778 | 1782 | if (!list($width\_origin, $height\_origin) = getimagesize($imgpath)) { |
  | 1779 | 1783 | continue; |
  | 1780 | 1784 | } |
  | 1781 | 1785 |  |
  | 1782 | 1786 | if (empty($tag['attributes']['width']) && empty($tag['attributes']['height'])) { |
  | 1783 | 1787 | $img\_wrong = false; |
  | 1784 | 1788 | } else { |
  | 1785 | 1789 | if (!empty($width\_origin) && !empty($height\_origin)) { |
  | 1786 | 1790 | if ((isset($tag['attributes']['width']) && (int)$width\_origin !== (int)$tag['attributes']['width']) |
  | 1787 | 1791 | || (isset($tag['attributes']['height']) && (int)$height\_origin !== (int)$tag['attributes']['height'])) { |
  | 1788 | 1792 | $img\_wrong = true; |
  | 1789 | 1793 | } |
  | 1790 | 1794 | } |
  | 1791 | 1795 | } |
  | 1792 | 1796 |  |
  | 1793 | 1797 | if (empty($tag['attributes']['alt'])) { |
  | 1794 | 1798 | $img\_wrong\_alt = true; |
  | 1795 | 1799 | } |
  | 1796 | 1800 | } |
  | 1797 | 1801 |  |
  | 1798 | 1802 | if (isset($\_POST['datas']['first\_load']) && !empty($meta\_analysis) && !empty($meta\_analysis['imgresize'])) { |
  | 1799 | 1803 | $output .= $this->createFieldAnalysis( |
  | 1800 | 1804 | 'imgresize', |
  | 1801 | 1805 | $tooltip\_page['image\_resize'], |
  | 1802 | 1806 | 'done', |
  | 1803 | 1807 | esc\_html\_\_('Wrong image resize', 'wp-meta-seo'), |
  | 1804 | 1808 | 1 |
  | 1805 | 1809 | ); |
  | 1806 | 1810 | $check++; |
  | 1807 | 1811 | } else { |
  | 1808 | 1812 | if (!$img\_wrong) { |
  | 1809 | 1813 | $output .= $this->createFieldAnalysis( |
  | 1810 | 1814 | 'imgresize', |
  | 1811 | 1815 | $tooltip\_page['image\_resize'], |
  | 1812 | 1816 | 'done', |
  | 1813 | 1817 | esc\_html\_\_('Wrong image resize', 'wp-meta-seo'), |
  | 1814 | 1818 | 1 |
  | 1815 | 1819 | ); |
  | 1816 | 1820 | $check++; |
  | 1817 | 1821 | } else { |
  | 1818 | 1822 | $output .= $this->createFieldAnalysis( |
  | 1819 | 1823 | 'imgresize', |
  | 1820 | 1824 | $tooltip\_page['image\_resize'], |
  | 1821 | 1825 | 'warning', |
  | 1822 | 1826 | esc\_html\_\_('Wrong image resize', 'wp-meta-seo'), |
  | 1823 | 1827 | 0 |
  | 1824 | 1828 | ); |
  | 1825 | 1829 | } |
  | 1826 | 1830 | } |
  | 1827 | 1831 |  |
  | 1828 | 1832 | if (isset($\_POST['datas']['first\_load']) && !empty($meta\_analysis) && !empty($meta\_analysis['imgalt'])) { |
  | 1829 | 1833 | $output .= $this->createFieldAnalysis( |
  | 1830 | 1834 | 'imgalt', |
  | 1831 | 1835 | $tooltip\_page['image\_alt'], |
  | 1832 | 1836 | 'done', |
  | 1833 | 1837 | esc\_html\_\_('Image alt information filled', 'wp-meta-seo'), |
  | 1834 | 1838 | 1 |
  | 1835 | 1839 | ); |
  | 1836 | 1840 | $check++; |
  | 1837 | 1841 | } else { |
  | 1838 | 1842 | if (!$img\_wrong\_alt) { |
  | 1839 | 1843 | $output .= $this->createFieldAnalysis( |
  | 1840 | 1844 | 'imgalt', |
  | 1841 | 1845 | $tooltip\_page['image\_alt'], |
  | 1842 | 1846 | 'done', |
  | 1843 | 1847 | esc\_html\_\_('Image alt information filled', 'wp-meta-seo'), |
  | 1844 | 1848 | 1 |
  | 1845 | 1849 | ); |
  | 1846 | 1850 | $check++; |
  | 1847 | 1851 | } else { |
  | 1848 | 1852 | $output .= $this->createFieldAnalysis( |
  | 1849 | 1853 | 'imgalt', |
  | 1850 | 1854 | $tooltip\_page['image\_alt'], |
  | 1851 | 1855 | 'warning', |
  | 1852 | 1856 | esc\_html\_\_('Image alt information filled', 'wp-meta-seo'), |
  | 1853 | 1857 | 0 |
  | 1854 | 1858 | ); |
  | 1855 | 1859 | } |
  | 1856 | 1860 | } |
  | 1857 | 1861 |  |
  | 1858 | 1862 | $output .= $this->createFieldAnalysis( |
  | 1859 | 1863 | 'seokeyword', |
  | 1860 | 1864 | esc\_html\_\_('At least one of the SEO keywords are found in the page title OR meta title OR SEO meta description OR page content heading OR the page content', 'wp-meta-seo'), |
  | 1861 | 1865 | 'warning', |
  | 1862 | 1866 | esc\_html\_\_('SEO keywords are found', 'wp-meta-seo'), |
  | 1863 | 1867 | 0 |
  | 1864 | 1868 | ); |
  | 1865 | 1869 |  |
  | 1866 | 1870 | $right\_output = '<div class="metaseo\_analysis metaseo\_tool"><span style="font-weight: 700">' . esc\_html\_\_('Page SEO keywords check', 'wp-meta-seo') . '</span></div>'; |
  | 1867 | 1871 |  |
  | 1868 | 1872 | $right\_output .= $this->createFieldAnalysis( |
  | 1869 | 1873 | 'keyintitle', |
  | 1870 | 1874 | esc\_html\_\_('The SEO keywords are found in page title', 'wp-meta-seo'), |
  | 1871 | 1875 | 'warning', |
  | 1872 | 1876 | esc\_html\_\_('The keywords are found in page title', 'wp-meta-seo'), |
  | 1873 | 1877 | 0 |
  | 1874 | 1878 | ); |
  | 1875 | 1879 |  |
  | 1876 | 1880 | $right\_output .= $this->createFieldAnalysis( |
  | 1877 | 1881 | 'keyincontent', |
  | 1878 | 1882 | esc\_html\_\_('The SEO keywords are found in page content', 'wp-meta-seo'), |
  | 1879 | 1883 | 'warning', |
  | 1880 | 1884 | esc\_html\_\_('The keywords are found in page content', 'wp-meta-seo'), |
  | 1881 | 1885 | 0 |
  | 1882 | 1886 | ); |
  | 1883 | 1887 |  |
  | 1884 | 1888 |  |
  | 1885 | 1889 | $right\_output .= $this->createFieldAnalysis( |
  | 1886 | 1890 | 'keyinmetatitle', |
  | 1887 | 1891 | esc\_html\_\_('The SEO keywords are found in meta title', 'wp-meta-seo'), |
  | 1888 | 1892 | 'warning', |
  | 1889 | 1893 | esc\_html\_\_('The keywords are found in meta title', 'wp-meta-seo'), |
  | 1890 | 1894 | 0 |
  | 1891 | 1895 | ); |
  | 1892 | 1896 |  |
  | 1893 | 1897 | $right\_output .= $this->createFieldAnalysis( |
  | 1894 | 1898 | 'keyinmetadescription', |
  | 1895 | 1899 | esc\_html\_\_('The SEO keywords are found in meta description', 'wp-meta-seo'), |
  | 1896 | 1900 | 'warning', |
  | 1897 | 1901 | esc\_html\_\_('The keywords are found in meta description', 'wp-meta-seo'), |
  | 1898 | 1902 | 0 |
  | 1899 | 1903 | ); |
  | 1900 | 1904 |  |
  | 1901 | 1905 | $right\_output .= $this->createFieldAnalysis( |
  | 1902 | 1906 | 'keyincontentheading', |
  | 1903 | 1907 | esc\_html\_\_('The SEO keywords are found in page content heading', 'wp-meta-seo'), |
  | 1904 | 1908 | 'warning', |
  | 1905 | 1909 | esc\_html\_\_('The keywords are found in page content heading', 'wp-meta-seo'), |
  | 1906 | 1910 | 0 |
  | 1907 | 1911 | ); |
  | 1908 | 1912 | } |
  | 1909 | 1913 | $total\_check = 7; |
  | 1910 | 1914 | if (isset($\_POST['datas']['seo\_keywords']) && !empty($\_POST['datas']['seo\_keywords'])) { |
  | 1911 | 1915 | $total\_check++; |
  | 1912 | 1916 | } |
  | 1913 | 1917 | $circliful = ceil(100 \* ($check) / $total\_check); |
  | 1914 | 1918 | /\*\* |
  | 1915 | 1919 | \* Reload analytics |
  | 1916 | 1920 | \* |
  | 1917 | 1921 | \* @param integer Post ID |
  | 1918 | 1922 | \* @param array   All the datas |
  | 1919 | 1923 | \*/ |
  | 1920 | 1924 | do\_action('wpms\_reload\_analytics', $\_POST['datas']['post\_id'], $\_POST['datas']); |
  | 1921 | 1925 | wp\_send\_json(array('circliful' => $circliful, 'output' => $output, 'check' => $check, 'right\_output' => $right\_output)); |
  | 1922 | 1926 | } |
  | 1923 | 1927 |  |
  | 1924 | 1928 | /\*\* |
  | 1925 | 1929 | \* Extract html heading tags from WPBakery Page Builder shortcode |
  | 1926 | 1930 | \* |
  | 1927 | 1931 | \* @param string $postTitle   Post title |
  | 1928 | 1932 | \* @param string $textContent Text content page/post |
  | 1929 | 1933 | \* @param array  $search      Html heading tags to extract |
  | 1930 | 1934 | \* |
  | 1931 | 1935 | \* @return array |
  | 1932 | 1936 | \*/ |
  | 1933 | 1937 | public function wpmsShortcodeExtract($postTitle, $textContent, $search) |
  | 1934 | 1938 | { |
  | 1935 | 1939 | $extracted = array(); |
  | 1936 | 1940 | // Capture vc\_custom\_heading shortcode from post content |
  | 1937 | 1941 | if (preg\_match\_all('/\[vc\_custom\_heading(.\*?)\]/i', $textContent, $matches)) { |
  | 1938 | 1942 | if (!empty($matches)) { |
  | 1939 | 1943 | foreach ($matches[1] as $vcCustomHeading) { |
  | 1940 | 1944 | $attrs = shortcode\_parse\_atts(trim($vcCustomHeading)); |
  | 1941 | 1945 | if (!empty($attrs['font\_container'])) { |
  | 1942 | 1946 | foreach ($search as $s) { |
  | 1943 | 1947 | if (strpos($attrs['font\_container'], 'tag:' . $s . '|') !== false) { |
  | 1944 | 1948 | $tag = $s; |
  | 1945 | 1949 | break; // find out html tag |
  | 1946 | 1950 | } |
  | 1947 | 1951 | } |
  | 1948 | 1952 | } else { |
  | 1949 | 1953 | $tag = 'h2'; // default by WPBakery page builder if empty font\_container attr |
  | 1950 | 1954 | } |
  | 1951 | 1955 |  |
  | 1952 | 1956 | // Check case source="post\_title" |
  | 1953 | 1957 | $content = ''; |
  | 1954 | 1958 | if (isset($attrs['source']) && $attrs['source'] === 'post\_title') { |
  | 1955 | 1959 | $content = $postTitle; |
  | 1956 | 1960 | } elseif (isset($attrs['text']) && !empty($attrs['text'])) { |
  | 1957 | 1961 | $content = $attrs['text']; |
  | 1958 | 1962 | } |
  | 1959 | 1963 |  |
  | 1960 | 1964 | if (!empty($attrs) && isset($tag)) { |
  | 1961 | 1965 | $extracted[$tag][] = array( |
  | 1962 | 1966 | 'tag\_name' => $tag, |
  | 1963 | 1967 | 'offset' => '', |
  | 1964 | 1968 | 'contents' => $content, |
  | 1965 | 1969 | 'attributes' => array(), |
  | 1966 | 1970 | 'full\_tag' => '[vc\_custom\_heading ' . $vcCustomHeading . ']' |
  | 1967 | 1971 | ); |
  | 1968 | 1972 | } |
  | 1969 | 1973 | } |
  | 1970 | 1974 | } |
  | 1971 | 1975 | } |
  | 1972 | 1976 |  |
  | 1973 | 1977 | // Capture trx\_sc\_title shortcode from post content |
  | 1974 | 1978 | if (preg\_match\_all('/\[trx\_sc\_title(.\*?)\]/i', $textContent, $matches)) { |
  | 1975 | 1979 | if (!empty($matches)) { |
  | 1976 | 1980 | foreach ($matches[1] as $trxScTitle) { |
  | 1977 | 1981 | $attrs = shortcode\_parse\_atts(trim($trxScTitle)); |
  | 1978 | 1982 | if (!empty($attrs['title\_tag'])) { |
  | 1979 | 1983 | $titleTag = $attrs['title\_tag']; |
  | 1980 | 1984 | } else { |
  | 1981 | 1985 | $titleTag = 'h2'; // default by WPBakery page builder if empty title\_tag attr |
  | 1982 | 1986 | } |
  | 1983 | 1987 |  |
  | 1984 | 1988 | // Check case source="post\_title" |
  | 1985 | 1989 | $title = ''; |
  | 1986 | 1990 | if (isset($attrs['title'])) { |
  | 1987 | 1991 | $title = $attrs['title']; |
  | 1988 | 1992 | } |
  | 1989 | 1993 |  |
  | 1990 | 1994 | if (!empty($attrs) && !empty($title)) { |
  | 1991 | 1995 | $extracted[$titleTag][] = array( |
  | 1992 | 1996 | 'tag\_name' => $titleTag, |
  | 1993 | 1997 | 'offset' => '', |
  | 1994 | 1998 | 'contents' => $title, |
  | 1995 | 1999 | 'attributes' => array(), |
  | 1996 | 2000 | 'full\_tag' => '[trx\_sc\_title ' . $trxScTitle . ']' |
  | 1997 | 2001 | ); |
  | 1998 | 2002 | } |
  | 1999 | 2003 | } |
  | 2000 | 2004 | } |
  | 2001 | 2005 | } |
  | 2002 | 2006 |  |
  | 2003 | 2007 | return $extracted; |
  | 2004 | 2008 | } |
  | 2005 | 2009 | /\*\* |
  | 2006 | 2010 | \* Validate propertyin page optimization |
  | 2007 | 2011 | \* |
  | 2008 | 2012 | \* @return void |
  | 2009 | 2013 | \*/ |
  | 2010 | 2014 | public function validateAnalysis() |
  | 2011 | 2015 | { |
  | 2012 | 2016 | if (empty($\_POST['wpms\_nonce']) |
  | 2013 | 2017 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2014 | 2018 | die(); |
  | 2015 | 2019 | } |
  | 2016 | 2020 |  |
  | 2017 | 2021 | if (!current\_user\_can('manage\_options')) { |
  | 2018 | 2022 | wp\_send\_json(false); |
  | 2019 | 2023 | } |
  | 2020 | 2024 | $post\_id = $\_POST['post\_id']; |
  | 2021 | 2025 | $key = 'wpms\_validate\_analysis'; |
  | 2022 | 2026 | $analysis = get\_post\_meta($post\_id, $key, true); |
  | 2023 | 2027 | if (empty($analysis)) { |
  | 2024 | 2028 | $analysis = array(); |
  | 2025 | 2029 | } |
  | 2026 | 2030 |  |
  | 2027 | 2031 | $analysis[$\_POST['field']] = 1; |
  | 2028 | 2032 | update\_post\_meta($post\_id, $key, $analysis); |
  | 2029 | 2033 | wp\_send\_json(true); |
  | 2030 | 2034 | } |
  | 2031 | 2035 |  |
  | 2032 | 2036 | /\*\* |
  | 2033 | 2037 | \* Remove link in source 404 |
  | 2034 | 2038 | \* |
  | 2035 | 2039 | \* @return void |
  | 2036 | 2040 | \*/ |
  | 2037 | 2041 | public function removeLink() |
  | 2038 | 2042 | { |
  | 2039 | 2043 | if (empty($\_POST['wpms\_nonce']) |
  | 2040 | 2044 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2041 | 2045 | die(); |
  | 2042 | 2046 | } |
  | 2043 | 2047 |  |
  | 2044 | 2048 | if (!current\_user\_can('manage\_options')) { |
  | 2045 | 2049 | wp\_send\_json(array('status' => false)); |
  | 2046 | 2050 | } |
  | 2047 | 2051 |  |
  | 2048 | 2052 | global $wpdb; |
  | 2049 | 2053 | if (isset($\_POST['link\_id'])) { |
  | 2050 | 2054 | $wpdb->delete($wpdb->prefix . 'wpms\_links', array('id' => (int)$\_POST['link\_id'])); |
  | 2051 | 2055 | wp\_send\_json(array('status' => true)); |
  | 2052 | 2056 | } |
  | 2053 | 2057 |  |
  | 2054 | 2058 | wp\_send\_json(array('status' => false)); |
  | 2055 | 2059 | } |
  | 2056 | 2060 |  |
  | 2057 | 2061 | /\*\* |
  | 2058 | 2062 | \* Ajax update link meta title and content editor |
  | 2059 | 2063 | \* |
  | 2060 | 2064 | \* @param string  $type        Action type |
  | 2061 | 2065 | \* @param string  $link\_detail Link details |
  | 2062 | 2066 | \* @param string  $title       Title value |
  | 2063 | 2067 | \* @param integer $link\_id     Link ID |
  | 2064 | 2068 | \* |
  | 2065 | 2069 | \* @return void |
  | 2066 | 2070 | \*/ |
  | 2067 | 2071 | public function updateLink1($type, $link\_detail, $title, $link\_id) |
  | 2068 | 2072 | { |
  | 2069 | 2073 | global $wpdb; |
  | 2070 | 2074 | global $wp\_version; |
  | 2071 | 2075 | // Purge title |
  | 2072 | 2076 | $title = strip\_tags($title); |
  | 2073 | 2077 | $title = str\_replace("'", '', $title); |
  | 2074 | 2078 | $title = str\_replace('"', '', $title); |
  | 2075 | 2079 |  |
  | 2076 | 2080 | $value = array('meta\_title' => $title); |
  | 2077 | 2081 | $wpdb->update( |
  | 2078 | 2082 | $wpdb->prefix . 'wpms\_links', |
  | 2079 | 2083 | $value, |
  | 2080 | 2084 | array('id' => (int)$link\_id) |
  | 2081 | 2085 | ); |
  | 2082 | 2086 | $post = get\_post($link\_detail->source\_id); |
  | 2083 | 2087 |  |
  | 2084 | 2088 | if (!empty($post)) { |
  | 2085 | 2089 | if (version\_compare($wp\_version, '5.0', '>=')) { |
  | 2086 | 2090 | if (function\_exists('has\_blocks')) { |
  | 2087 | 2091 | if (has\_blocks((int)$link\_detail->source\_id)) { |
  | 2088 | 2092 | // Gutenberg |
  | 2089 | 2093 | $post\_content = $this->gutenbergUpdateContent($post->post\_content, $link\_detail, $title); |
  | 2090 | 2094 | } else { |
  | 2091 | 2095 | // Classic editor |
  | 2092 | 2096 | $post\_content = $this->replaceNewTitle($post->post\_content, $link\_detail, $title); |
  | 2093 | 2097 | } |
  | 2094 | 2098 | } |
  | 2095 | 2099 | } else { |
  | 2096 | 2100 | // Classic editor |
  | 2097 | 2101 | $post\_content = $this->replaceNewTitle($post->post\_content, $link\_detail, $title); |
  | 2098 | 2102 | } |
  | 2099 | 2103 |  |
  | 2100 | 2104 | $my\_post = array( |
  | 2101 | 2105 | 'ID' => (int)$link\_detail->source\_id, |
  | 2102 | 2106 | 'post\_content' => $post\_content |
  | 2103 | 2107 | ); |
  | 2104 | 2108 | remove\_action('post\_updated', array('MetaSeoBrokenLinkTable', 'updatePost')); |
  | 2105 | 2109 | wp\_update\_post($my\_post); |
  | 2106 | 2110 | if ($type === 'ajax') { |
  | 2107 | 2111 | wp\_send\_json(array('status' => true)); |
  | 2108 | 2112 | } |
  | 2109 | 2113 | } |
  | 2110 | 2114 | } |
  | 2111 | 2115 |  |
  | 2112 | 2116 | /\*\* |
  | 2113 | 2117 | \* Update link meta title and content editor in gutenberg |
  | 2114 | 2118 | \* |
  | 2115 | 2119 | \* @param string $post\_content Content of posts |
  | 2116 | 2120 | \* @param string $link\_detail  Link details |
  | 2117 | 2121 | \* @param string $title        Title value |
  | 2118 | 2122 | \* |
  | 2119 | 2123 | \* @return string |
  | 2120 | 2124 | \*/ |
  | 2121 | 2125 | public function gutenbergUpdateContent($post\_content, $link\_detail, $title) |
  | 2122 | 2126 | { |
  | 2123 | 2127 | $blocks = parse\_blocks($post\_content); |
  | 2124 | 2128 | // phpcs:disable Generic.PHP.LowerCaseConstant.Found -- In special case the block returns NULL |
  | 2125 | 2129 | $allowed\_blocks = array( |
  | 2126 | 2130 | // Classic blocks have their blockName set to null. |
  | 2127 | 2131 | null, |
  | 2128 | 2132 | NULL, |
  | 2129 | 2133 | 'core/button', |
  | 2130 | 2134 | 'core/paragraph', |
  | 2131 | 2135 | 'core/heading', |
  | 2132 | 2136 | 'core/list', |
  | 2133 | 2137 | 'core/quote', |
  | 2134 | 2138 | 'core/cover', |
  | 2135 | 2139 | 'core/html', |
  | 2136 | 2140 | 'core/verse', |
  | 2137 | 2141 | 'core/preformatted', |
  | 2138 | 2142 | 'core/pullquote', |
  | 2139 | 2143 | 'core/table', |
  | 2140 | 2144 | 'core/media-text' |
  | 2141 | 2145 | ); |
  | 2142 | 2146 | // phpcs:enable |
  | 2143 | 2147 | foreach ($blocks as $block) { |
  | 2144 | 2148 | // Gutenberg block |
  | 2145 | 2149 | if (in\_array($block['blockName'], $allowed\_blocks, true)) { |
  | 2146 | 2150 | if (!empty($block['innerBlocks'])) { |
  | 2147 | 2151 | // Skip the block if it has disallowed or nested inner blocks. |
  | 2148 | 2152 | foreach ($block['innerBlocks'] as $inner\_block) { |
  | 2149 | 2153 | if (!in\_array($inner\_block['blockName'], $allowed\_blocks, true) || |
  | 2150 | 2154 | !empty($inner\_block['innerBlocks']) |
  | 2151 | 2155 | ) { |
  | 2152 | 2156 | continue; |
  | 2153 | 2157 | } |
  | 2154 | 2158 | } |
  | 2155 | 2159 | } |
  | 2156 | 2160 |  |
  | 2157 | 2161 | if (strpos($block['innerHTML'], $link\_detail->link\_text) !== false) { |
  | 2158 | 2162 | $post\_content = $this->replaceNewTitle($post\_content, $link\_detail, $title); |
  | 2159 | 2163 | } |
  | 2160 | 2164 | } |
  | 2161 | 2165 | } |
  | 2162 | 2166 |  |
  | 2163 | 2167 | return $post\_content; |
  | 2164 | 2168 | } |
  | 2165 | 2169 |  |
  | 2166 | 2170 | /\*\* |
  | 2167 | 2171 | \* Filter and replace new title |
  | 2168 | 2172 | \* |
  | 2169 | 2173 | \* @param string $post\_content Content of posts |
  | 2170 | 2174 | \* @param string $link\_detail  Link details |
  | 2171 | 2175 | \* @param string $title        Title value |
  | 2172 | 2176 | \* |
  | 2173 | 2177 | \* @return string |
  | 2174 | 2178 | \*/ |
  | 2175 | 2179 | protected function replaceNewTitle($post\_content, $link\_detail, $title) |
  | 2176 | 2180 | { |
  | 2177 | 2181 | $links = wpmsExtractTags($post\_content, 'a', false, true); |
  | 2178 | 2182 | $title\_tag = sprintf('%s="%s"', 'title', esc\_attr($title)); |
  | 2179 | 2183 | if (!empty($links)) { |
  | 2180 | 2184 | foreach ($links as $link) { |
  | 2181 | 2185 | if ($link['contents'] === $link\_detail->link\_text) { |
  | 2182 | 2186 | if (!isset($link['attributes']['title'])) { |
  | 2183 | 2187 | // Not titlte, add new |
  | 2184 | 2188 | $new\_html = preg\_replace( |
  | 2185 | 2189 | '/<a/is', |
  | 2186 | 2190 | '<a ' . $title\_tag, |
  | 2187 | 2191 | $link['full\_tag'] |
  | 2188 | 2192 | ); |
  | 2189 | 2193 | } else { |
  | 2190 | 2194 | $new\_html = preg\_replace( |
  | 2191 | 2195 | '/title=(["\'])(.\*?)["\']/is', |
  | 2192 | 2196 | $title\_tag, |
  | 2193 | 2197 | $link['full\_tag'] |
  | 2194 | 2198 | ); |
  | 2195 | 2199 | } |
  | 2196 | 2200 | // Replace tag |
  | 2197 | 2201 | $post\_content = str\_replace($link['full\_tag'], $new\_html, $post\_content); |
  | 2198 | 2202 | } |
  | 2199 | 2203 | } |
  | 2200 | 2204 | } |
  | 2201 | 2205 |  |
  | 2202 | 2206 | return $post\_content; |
  | 2203 | 2207 | } |
  | 2204 | 2208 |  |
  | 2205 | 2209 | /\*\* |
  | 2206 | 2210 | \* Ajax update link meta title and content editor |
  | 2207 | 2211 | \* |
  | 2208 | 2212 | \* @return void |
  | 2209 | 2213 | \*/ |
  | 2210 | 2214 | public function updateLink() |
  | 2211 | 2215 | { |
  | 2212 | 2216 | if (empty($\_POST['wpms\_nonce']) |
  | 2213 | 2217 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2214 | 2218 | die(); |
  | 2215 | 2219 | } |
  | 2216 | 2220 |  |
  | 2217 | 2221 | if (!current\_user\_can('manage\_options')) { |
  | 2218 | 2222 | wp\_send\_json(false); |
  | 2219 | 2223 | } |
  | 2220 | 2224 | if (isset($\_POST['link\_id'])) { |
  | 2221 | 2225 | global $wpdb; |
  | 2222 | 2226 | $link\_detail = $wpdb->get\_row($wpdb->prepare( |
  | 2223 | 2227 | 'SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE id=%d', |
  | 2224 | 2228 | array( |
  | 2225 | 2229 | (int)$\_POST['link\_id'] |
  | 2226 | 2230 | ) |
  | 2227 | 2231 | )); |
  | 2228 | 2232 | if (empty($link\_detail)) { |
  | 2229 | 2233 | wp\_send\_json(false); |
  | 2230 | 2234 | } |
  | 2231 | 2235 | $this->updateLink1('ajax', $link\_detail, $\_POST['meta\_title'], $\_POST['link\_id']); |
  | 2232 | 2236 | } |
  | 2233 | 2237 | wp\_send\_json(false); |
  | 2234 | 2238 | } |
  | 2235 | 2239 |  |
  | 2236 | 2240 | /\*\* |
  | 2237 | 2241 | \* Ajax update meta index for page |
  | 2238 | 2242 | \* |
  | 2239 | 2243 | \* @return void |
  | 2240 | 2244 | \*/ |
  | 2241 | 2245 | public function updatePageIndex() |
  | 2242 | 2246 | { |
  | 2243 | 2247 | if (empty($\_POST['wpms\_nonce']) |
  | 2244 | 2248 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2245 | 2249 | die(); |
  | 2246 | 2250 | } |
  | 2247 | 2251 |  |
  | 2248 | 2252 | if (!current\_user\_can('manage\_options')) { |
  | 2249 | 2253 | wp\_send\_json(array('status' => false)); |
  | 2250 | 2254 | } |
  | 2251 | 2255 | if (isset($\_POST['page\_id']) && isset($\_POST['index'])) { |
  | 2252 | 2256 | update\_post\_meta($\_POST['page\_id'], '\_metaseo\_metaindex', $\_POST['index']); |
  | 2253 | 2257 | /\*\* |
  | 2254 | 2258 | \* Update index/noindex for robots meta tag of a page |
  | 2255 | 2259 | \* |
  | 2256 | 2260 | \* @param integer Page ID |
  | 2257 | 2261 | \* @param string  Page meta index |
  | 2258 | 2262 | \* @param integer Page index value |
  | 2259 | 2263 | \*/ |
  | 2260 | 2264 | do\_action('wpms\_update\_page\_index', $\_POST['page\_id'], '\_metaseo\_metaindex', $\_POST['index']); |
  | 2261 | 2265 | wp\_send\_json(array('status' => true)); |
  | 2262 | 2266 | } |
  | 2263 | 2267 | wp\_send\_json(array('status' => false)); |
  | 2264 | 2268 | } |
  | 2265 | 2269 |  |
  | 2266 | 2270 | /\*\* |
  | 2267 | 2271 | \* Ajax update meta follow for page |
  | 2268 | 2272 | \* |
  | 2269 | 2273 | \* @return void |
  | 2270 | 2274 | \*/ |
  | 2271 | 2275 | public function updatePageFollow() |
  | 2272 | 2276 | { |
  | 2273 | 2277 | if (empty($\_POST['wpms\_nonce']) |
  | 2274 | 2278 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2275 | 2279 | die(); |
  | 2276 | 2280 | } |
  | 2277 | 2281 |  |
  | 2278 | 2282 | if (!current\_user\_can('manage\_options')) { |
  | 2279 | 2283 | wp\_send\_json(array('status' => false)); |
  | 2280 | 2284 | } |
  | 2281 | 2285 | if (isset($\_POST['page\_id']) && isset($\_POST['follow'])) { |
  | 2282 | 2286 | update\_post\_meta((int)$\_POST['page\_id'], '\_metaseo\_metafollow', $\_POST['follow']); |
  | 2283 | 2287 |  |
  | 2284 | 2288 | /\*\* |
  | 2285 | 2289 | \* Update follow/nofollow for robots meta tag of a page |
  | 2286 | 2290 | \* |
  | 2287 | 2291 | \* @param integer Page ID |
  | 2288 | 2292 | \* @param string  Page meta follow |
  | 2289 | 2293 | \* @param integer Page follow value |
  | 2290 | 2294 | \*/ |
  | 2291 | 2295 | do\_action('wpms\_update\_page\_follow', $\_POST['page\_id'], '\_metaseo\_metafollow', $\_POST['follow']); |
  | 2292 | 2296 | wp\_send\_json(array('status' => true)); |
  | 2293 | 2297 | } |
  | 2294 | 2298 | wp\_send\_json(array('status' => false)); |
  | 2295 | 2299 | } |
  | 2296 | 2300 |  |
  | 2297 | 2301 | /\*\* |
  | 2298 | 2302 | \* Ajax update meta follow for link |
  | 2299 | 2303 | \* |
  | 2300 | 2304 | \* @return void |
  | 2301 | 2305 | \*/ |
  | 2302 | 2306 | public function updateFollow() |
  | 2303 | 2307 | { |
  | 2304 | 2308 | if (empty($\_POST['wpms\_nonce']) |
  | 2305 | 2309 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2306 | 2310 | die(); |
  | 2307 | 2311 | } |
  | 2308 | 2312 |  |
  | 2309 | 2313 | if (!current\_user\_can('manage\_options')) { |
  | 2310 | 2314 | wp\_send\_json(array('status' => false)); |
  | 2311 | 2315 | } |
  | 2312 | 2316 | if (isset($\_POST['link\_id'])) { |
  | 2313 | 2317 | $this->doUpdateFollow($\_POST['link\_id'], $\_POST['follow']); |
  | 2314 | 2318 | /\*\* |
  | 2315 | 2319 | \* Update follow/nofollow for rel attribute of a link |
  | 2316 | 2320 | \* |
  | 2317 | 2321 | \* @param integer Link ID |
  | 2318 | 2322 | \* @param integer Link follow |
  | 2319 | 2323 | \*/ |
  | 2320 | 2324 | do\_action('wpms\_update\_link\_follow', $\_POST['link\_id'], $\_POST['follow']); |
  | 2321 | 2325 | wp\_send\_json(array('status' => true)); |
  | 2322 | 2326 | } |
  | 2323 | 2327 | wp\_send\_json(array('status' => false)); |
  | 2324 | 2328 | } |
  | 2325 | 2329 |  |
  | 2326 | 2330 | /\*\* |
  | 2327 | 2331 | \* Ajax update multitle meta follow for link |
  | 2328 | 2332 | \* |
  | 2329 | 2333 | \* @return void |
  | 2330 | 2334 | \*/ |
  | 2331 | 2335 | public function updateMultipleFollow() |
  | 2332 | 2336 | { |
  | 2333 | 2337 | if (empty($\_POST['wpms\_nonce']) |
  | 2334 | 2338 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2335 | 2339 | die(); |
  | 2336 | 2340 | } |
  | 2337 | 2341 |  |
  | 2338 | 2342 | if (!current\_user\_can('manage\_options')) { |
  | 2339 | 2343 | wp\_send\_json(array('status' => false)); |
  | 2340 | 2344 | } |
  | 2341 | 2345 | global $wpdb; |
  | 2342 | 2346 | $action\_name = $\_POST['action\_name']; |
  | 2343 | 2347 | $limit = 20; |
  | 2344 | 2348 |  |
  | 2345 | 2349 | switch ($action\_name) { |
  | 2346 | 2350 | case 'copy\_title\_selected': |
  | 2347 | 2351 | if (empty($\_POST['linkids'])) { |
  | 2348 | 2352 | wp\_send\_json(array('status' => true)); |
  | 2349 | 2353 | } |
  | 2350 | 2354 | foreach ($\_POST['linkids'] as $linkId) { |
  | 2351 | 2355 | $link = $wpdb->get\_row( |
  | 2352 | 2356 | $wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE id = %d', $linkId) |
  | 2353 | 2357 | ); |
  | 2354 | 2358 | $link\_text = $link->link\_text; |
  | 2355 | 2359 | if ($link\_text !== '') { |
  | 2356 | 2360 | $this->updateLink1('bulk', $link, $link\_text, $linkId); |
  | 2357 | 2361 | } |
  | 2358 | 2362 | } |
  | 2359 | 2363 |  |
  | 2360 | 2364 | break; |
  | 2361 | 2365 | case 'copy\_title\_all': |
  | 2362 | 2366 | $links = $wpdb->get\_results( |
  | 2363 | 2367 | 'SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE type="url"' |
  | 2364 | 2368 | ); |
  | 2365 | 2369 | foreach ($links as $link) { |
  | 2366 | 2370 | $link\_text = $link->link\_text; |
  | 2367 | 2371 | if ($link\_text !== '') { |
  | 2368 | 2372 | $this->updateLink1('bulk', $link, $link\_text, $link->id); |
  | 2369 | 2373 | } |
  | 2370 | 2374 | } |
  | 2371 | 2375 | break; |
  | 2372 | 2376 | case 'follow\_selected': |
  | 2373 | 2377 | if (empty($\_POST['linkids'])) { |
  | 2374 | 2378 | wp\_send\_json(array('status' => true)); |
  | 2375 | 2379 | } |
  | 2376 | 2380 |  |
  | 2377 | 2381 | $follow = 1; |
  | 2378 | 2382 | foreach ($\_POST['linkids'] as $linkId) { |
  | 2379 | 2383 | $this->doUpdateFollow($linkId, $follow); |
  | 2380 | 2384 | /\*\* |
  | 2381 | 2385 | \* Update follow/nofollow for rel attribute of a link |
  | 2382 | 2386 | \* |
  | 2383 | 2387 | \* @param integer Link ID |
  | 2384 | 2388 | \* @param integer Link follow |
  | 2385 | 2389 | \* |
  | 2386 | 2390 | \* @ignore Hook already documented |
  | 2387 | 2391 | \*/ |
  | 2388 | 2392 | do\_action('wpms\_update\_link\_follow', $linkId, $follow); |
  | 2389 | 2393 | } |
  | 2390 | 2394 | break; |
  | 2391 | 2395 | case 'follow\_all': |
  | 2392 | 2396 | $follow = 1; |
  | 2393 | 2397 | $i = 0; |
  | 2394 | 2398 | $links = $wpdb->get\_results( |
  | 2395 | 2399 | 'SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE follow=0 AND type="url"' |
  | 2396 | 2400 | ); |
  | 2397 | 2401 | foreach ($links as $link) { |
  | 2398 | 2402 | if ($i > $limit) { |
  | 2399 | 2403 | wp\_send\_json(array('status' => false, 'message' => 'limit')); |
  | 2400 | 2404 | } else { |
  | 2401 | 2405 | $this->doUpdateFollow($link->id, $follow); |
  | 2402 | 2406 | $i++; |
  | 2403 | 2407 | /\*\* |
  | 2404 | 2408 | \* Update follow/nofollow for rel attribute of a link |
  | 2405 | 2409 | \* |
  | 2406 | 2410 | \* @param integer Link ID |
  | 2407 | 2411 | \* @param integer Link follow |
  | 2408 | 2412 | \* |
  | 2409 | 2413 | \* @ignore Hook already documented |
  | 2410 | 2414 | \*/ |
  | 2411 | 2415 | do\_action('wpms\_update\_link\_follow', $link->id, $follow); |
  | 2412 | 2416 | } |
  | 2413 | 2417 | } |
  | 2414 | 2418 | break; |
  | 2415 | 2419 | case 'nofollow\_selected': |
  | 2416 | 2420 | $follow = 0; |
  | 2417 | 2421 | if (empty($\_POST['linkids'])) { |
  | 2418 | 2422 | wp\_send\_json(array('status' => true)); |
  | 2419 | 2423 | } |
  | 2420 | 2424 |  |
  | 2421 | 2425 | foreach ($\_POST['linkids'] as $linkId) { |
  | 2422 | 2426 | $this->doUpdateFollow($linkId, $follow); |
  | 2423 | 2427 | /\*\* |
  | 2424 | 2428 | \* Update follow/nofollow for rel attribute of a link |
  | 2425 | 2429 | \* |
  | 2426 | 2430 | \* @param integer Link ID |
  | 2427 | 2431 | \* @param integer Link follow |
  | 2428 | 2432 | \* |
  | 2429 | 2433 | \* @ignore Hook already documented |
  | 2430 | 2434 | \*/ |
  | 2431 | 2435 | do\_action('wpms\_update\_link\_follow', $linkId, $follow); |
  | 2432 | 2436 | } |
  | 2433 | 2437 | break; |
  | 2434 | 2438 | case 'nofollow\_all': |
  | 2435 | 2439 | $follow = 0; |
  | 2436 | 2440 | $i = 0; |
  | 2437 | 2441 | $links = $wpdb->get\_results( |
  | 2438 | 2442 | 'SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE follow=1 AND type="url"' |
  | 2439 | 2443 | ); |
  | 2440 | 2444 | foreach ($links as $link) { |
  | 2441 | 2445 | if ($i > $limit) { |
  | 2442 | 2446 | wp\_send\_json(array('status' => false, 'message' => 'limit')); |
  | 2443 | 2447 | } else { |
  | 2444 | 2448 | $this->doUpdateFollow($link->id, $follow); |
  | 2445 | 2449 | $i++; |
  | 2446 | 2450 | /\*\* |
  | 2447 | 2451 | \* Update follow/nofollow for rel attribute of a link |
  | 2448 | 2452 | \* |
  | 2449 | 2453 | \* @param integer Link ID |
  | 2450 | 2454 | \* @param integer Link follow |
  | 2451 | 2455 | \* |
  | 2452 | 2456 | \* @ignore Hook already documented |
  | 2453 | 2457 | \*/ |
  | 2454 | 2458 | do\_action('wpms\_update\_link\_follow', $link->id, $follow); |
  | 2455 | 2459 | } |
  | 2456 | 2460 | } |
  | 2457 | 2461 | break; |
  | 2458 | 2462 | } |
  | 2459 | 2463 | wp\_send\_json(array('status' => true)); |
  | 2460 | 2464 | } |
  | 2461 | 2465 |  |
  | 2462 | 2466 | /\*\* |
  | 2463 | 2467 | \* Ajax update meta follow for link |
  | 2464 | 2468 | \* |
  | 2465 | 2469 | \* @param integer $linkId Link id |
  | 2466 | 2470 | \* @param integer $follow Follow value |
  | 2467 | 2471 | \* |
  | 2468 | 2472 | \* @return void |
  | 2469 | 2473 | \*/ |
  | 2470 | 2474 | public function doUpdateFollow($linkId, $follow) |
  | 2471 | 2475 | { |
  | 2472 | 2476 | global $wpdb; |
  | 2473 | 2477 | $link\_detail = $wpdb->get\_row($wpdb->prepare( |
  | 2474 | 2478 | 'SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE id=%d', |
  | 2475 | 2479 | array((int)$linkId) |
  | 2476 | 2480 | )); |
  | 2477 | 2481 | if (empty($link\_detail)) { |
  | 2478 | 2482 | wp\_send\_json(array('status' => false)); |
  | 2479 | 2483 | } |
  | 2480 | 2484 |  |
  | 2481 | 2485 | $value = array('follow' => $follow); |
  | 2482 | 2486 | $wpdb->update( |
  | 2483 | 2487 | $wpdb->prefix . 'wpms\_links', |
  | 2484 | 2488 | $value, |
  | 2485 | 2489 | array('id' => (int)$linkId) |
  | 2486 | 2490 | ); |
  | 2487 | 2491 |  |
  | 2488 | 2492 | $post = get\_post($link\_detail->source\_id); |
  | 2489 | 2493 | if (!empty($post)) { |
  | 2490 | 2494 | $old\_value = $post->post\_content; |
  | 2491 | 2495 | $edit\_result = $this->editLinkHtml( |
  | 2492 | 2496 | $old\_value, |
  | 2493 | 2497 | $link\_detail->link\_url, |
  | 2494 | 2498 | $link\_detail->link\_url, |
  | 2495 | 2499 | $link\_detail->meta\_title, |
  | 2496 | 2500 | $follow |
  | 2497 | 2501 | ); |
  | 2498 | 2502 | $my\_post = array( |
  | 2499 | 2503 | 'ID' => (int)$link\_detail->source\_id, |
  | 2500 | 2504 | 'post\_content' => $edit\_result['content'] |
  | 2501 | 2505 | ); |
  | 2502 | 2506 | remove\_action('post\_updated', array('MetaSeoBrokenLinkTable', 'updatePost')); |
  | 2503 | 2507 | wp\_update\_post($my\_post); |
  | 2504 | 2508 | } |
  | 2505 | 2509 | } |
  | 2506 | 2510 |  |
  | 2507 | 2511 | /\*\* |
  | 2508 | 2512 | \* Render new content when edit a link |
  | 2509 | 2513 | \* |
  | 2510 | 2514 | \* @param string  $content    Post content |
  | 2511 | 2515 | \* @param string  $new\_url    New url |
  | 2512 | 2516 | \* @param string  $old\_url    Old url |
  | 2513 | 2517 | \* @param string  $meta\_title Meta title |
  | 2514 | 2518 | \* @param integer $follow     Follow value |
  | 2515 | 2519 | \* @param null    $new\_text   New text of link |
  | 2516 | 2520 | \* |
  | 2517 | 2521 | \* @return array |
  | 2518 | 2522 | \*/ |
  | 2519 | 2523 | public function editLinkHtml($content, $new\_url, $old\_url, $meta\_title, $follow, $new\_text = null) |
  | 2520 | 2524 | { |
  | 2521 | 2525 | //Save the old & new URLs for use in the edit callback. |
  | 2522 | 2526 | $args = array( |
  | 2523 | 2527 | 'old\_url' => $old\_url, |
  | 2524 | 2528 | 'new\_url' => $new\_url, |
  | 2525 | 2529 | 'new\_text' => $new\_text, |
  | 2526 | 2530 | 'meta\_title' => $meta\_title, |
  | 2527 | 2531 | 'follow' => $follow |
  | 2528 | 2532 | ); |
  | 2529 | 2533 |  |
  | 2530 | 2534 | //Find all links and replace those that match $old\_url. |
  | 2531 | 2535 | $content = MetaSeoBrokenLinkTable::multiEdit( |
  | 2532 | 2536 | $content, |
  | 2533 | 2537 | array( |
  | 2534 | 2538 | 'MetaSeoBrokenLinkTable', |
  | 2535 | 2539 | 'editHtmlCallback' |
  | 2536 | 2540 | ), |
  | 2537 | 2541 | $args |
  | 2538 | 2542 | ); |
  | 2539 | 2543 |  |
  | 2540 | 2544 | $result = array( |
  | 2541 | 2545 | 'content' => $content, |
  | 2542 | 2546 | 'raw\_url' => $new\_url, |
  | 2543 | 2547 | ); |
  | 2544 | 2548 | if (isset($new\_text)) { |
  | 2545 | 2549 | $result['link\_text'] = $new\_text; |
  | 2546 | 2550 | } |
  | 2547 | 2551 | return $result; |
  | 2548 | 2552 | } |
  | 2549 | 2553 |  |
  | 2550 | 2554 | /\*\* |
  | 2551 | 2555 | \* Update option wpms\_settings\_404 |
  | 2552 | 2556 | \* |
  | 2553 | 2557 | \* @return void |
  | 2554 | 2558 | \*/ |
  | 2555 | 2559 | public function save404Settings() |
  | 2556 | 2560 | { |
  | 2557 | 2561 | if (empty($\_POST['wpms\_nonce']) |
  | 2558 | 2562 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2559 | 2563 | die(); |
  | 2560 | 2564 | } |
  | 2561 | 2565 |  |
  | 2562 | 2566 | if (!current\_user\_can('manage\_options')) { |
  | 2563 | 2567 | wp\_send\_json(false); |
  | 2564 | 2568 | } |
  | 2565 | 2569 |  |
  | 2566 | 2570 | if (isset($\_POST['wpms\_redirect'])) { |
  | 2567 | 2571 | update\_option('wpms\_settings\_404', $\_POST['wpms\_redirect']); |
  | 2568 | 2572 | } |
  | 2569 | 2573 |  |
  | 2570 | 2574 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 2571 | 2575 | $params = array('enable', 'numberFrequency', 'showlinkFrequency'); |
  | 2572 | 2576 | $settinglink = array(); |
  | 2573 | 2577 | foreach ($params as $param) { |
  | 2574 | 2578 | if (isset($\_POST[$param])) { |
  | 2575 | 2579 | $settinglink[$param] = $\_POST[$param]; |
  | 2576 | 2580 | } |
  | 2577 | 2581 | } |
  | 2578 | 2582 |  |
  | 2579 | 2583 | if (empty($settinglink['wpms\_lastRun\_scanlink'])) { |
  | 2580 | 2584 | $settinglink['wpms\_lastRun\_scanlink'] = time(); |
  | 2581 | 2585 | } |
  | 2582 | 2586 | update\_option('wpms\_link\_settings', $settinglink); |
  | 2583 | 2587 | } |
  | 2584 | 2588 |  |
  | 2585 | 2589 | wp\_send\_json(true); |
  | 2586 | 2590 | } |
  | 2587 | 2591 |  |
  | 2588 | 2592 | /\*\* |
  | 2589 | 2593 | \* Update breadcrumb settings |
  | 2590 | 2594 | \* |
  | 2591 | 2595 | \* @return void |
  | 2592 | 2596 | \*/ |
  | 2593 | 2597 | public function saveBreadcrumbSettings() |
  | 2594 | 2598 | { |
  | 2595 | 2599 | if (empty($\_POST['wpms\_nonce']) |
  | 2596 | 2600 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2597 | 2601 | die(); |
  | 2598 | 2602 | } |
  | 2599 | 2603 |  |
  | 2600 | 2604 | if (!current\_user\_can('manage\_options')) { |
  | 2601 | 2605 | wp\_send\_json(false); |
  | 2602 | 2606 | } |
  | 2603 | 2607 |  |
  | 2604 | 2608 | $params = array('separator', 'include\_home', 'home\_text', 'clickable', 'home\_text\_default'); |
  | 2605 | 2609 | $settinglink = array(); |
  | 2606 | 2610 | foreach ($params as $param) { |
  | 2607 | 2611 | if (isset($\_POST[$param])) { |
  | 2608 | 2612 | $settinglink[$param] = $\_POST[$param]; |
  | 2609 | 2613 | } |
  | 2610 | 2614 | } |
  | 2611 | 2615 |  |
  | 2612 | 2616 | update\_option('\_metaseo\_breadcrumbs', $settinglink); |
  | 2613 | 2617 | wp\_send\_json(true); |
  | 2614 | 2618 | } |
  | 2615 | 2619 |  |
  | 2616 | 2620 | /\*\* |
  | 2617 | 2621 | \* Show meta box in single post, on elementor plugin |
  | 2618 | 2622 | \* |
  | 2619 | 2623 | \* @return void |
  | 2620 | 2624 | \*/ |
  | 2621 | 2625 | private function loadMetaBoxes() |
  | 2622 | 2626 | { |
  | 2623 | 2627 | if (in\_array($this->pagenow, array( |
  | 2624 | 2628 | 'edit.php', |
  | 2625 | 2629 | 'post.php', |
  | 2626 | 2630 | 'post-new.php', |
  | 2627 | 2631 | )) || apply\_filters('wpmseo\_always\_register\_metaboxes\_on\_admin', false) |
  | 2628 | 2632 | ) { |
  | 2629 | 2633 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-metabox.php'); |
  | 2630 | 2634 | $GLOBALS['wpmseo\_metabox'] = new WPMSEOMetabox; |
  | 2631 | 2635 | } |
  | 2632 | 2636 | } |
  | 2633 | 2637 |  |
  | 2634 | 2638 | /\*\* |
  | 2635 | 2639 | \* Update meta title , meta description , meta keyword for content |
  | 2636 | 2640 | \* |
  | 2637 | 2641 | \* @return void |
  | 2638 | 2642 | \*/ |
  | 2639 | 2643 | public function updateContentMetaCallback() |
  | 2640 | 2644 | { |
  | 2641 | 2645 | if (empty($\_POST['wpms\_nonce']) |
  | 2642 | 2646 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2643 | 2647 | die(); |
  | 2644 | 2648 | } |
  | 2645 | 2649 |  |
  | 2646 | 2650 | if (!current\_user\_can('manage\_options')) { |
  | 2647 | 2651 | wp\_send\_json(array('status' => false)); |
  | 2648 | 2652 | } |
  | 2649 | 2653 | $\_POST = stripslashes\_deep($\_POST); |
  | 2650 | 2654 | $response = new stdClass(); |
  | 2651 | 2655 | $metakey = strtolower(trim($\_POST['metakey'])); |
  | 2652 | 2656 | $postID = intval($\_POST['postid']); |
  | 2653 | 2657 | $value = trim($\_POST['value']); |
  | 2654 | 2658 | $response->msg = esc\_html\_\_('Modification was saved', 'wp-meta-seo'); |
  | 2655 | 2659 | if ($metakey === 'metatitle') { |
  | 2656 | 2660 | if (!update\_post\_meta($postID, '\_metaseo\_metatitle', $value)) { |
  | 2657 | 2661 | $response->updated = false; |
  | 2658 | 2662 | $response->msg = esc\_html\_\_('Meta title was not saved', 'wp-meta-seo'); |
  | 2659 | 2663 | } else { |
  | 2660 | 2664 | $response->updated = true; |
  | 2661 | 2665 | $response->msg = esc\_html\_\_('Meta title was saved', 'wp-meta-seo'); |
  | 2662 | 2666 | } |
  | 2663 | 2667 | } |
  | 2664 | 2668 |  |
  | 2665 | 2669 | if ($metakey === 'metadesc') { |
  | 2666 | 2670 | if (!update\_post\_meta($postID, '\_metaseo\_metadesc', $value)) { |
  | 2667 | 2671 | $response->updated = false; |
  | 2668 | 2672 | $response->msg = esc\_html\_\_('Meta description was not saved', 'wp-meta-seo'); |
  | 2669 | 2673 | } else { |
  | 2670 | 2674 | $response->updated = true; |
  | 2671 | 2675 | $response->msg = esc\_html\_\_('Meta description was saved', 'wp-meta-seo'); |
  | 2672 | 2676 | } |
  | 2673 | 2677 | } |
  | 2674 | 2678 |  |
  | 2675 | 2679 | if ($metakey === 'metakeywords') { |
  | 2676 | 2680 | if (!update\_post\_meta($postID, '\_metaseo\_metakeywords', $value)) { |
  | 2677 | 2681 | $response->updated = false; |
  | 2678 | 2682 | $response->msg = esc\_html\_\_('Meta keywords was not saved', 'wp-meta-seo'); |
  | 2679 | 2683 | } else { |
  | 2680 | 2684 | $response->updated = true; |
  | 2681 | 2685 | $response->msg = esc\_html\_\_('Meta keywords was saved', 'wp-meta-seo'); |
  | 2682 | 2686 | } |
  | 2683 | 2687 | } |
  | 2684 | 2688 | update\_option('wpms\_last\_update\_post', time()); |
  | 2685 | 2689 | echo json\_encode($response); |
  | 2686 | 2690 | wp\_die(); |
  | 2687 | 2691 | } |
  | 2688 | 2692 |  |
  | 2689 | 2693 | /\*\* |
  | 2690 | 2694 | \* Loads js/ajax scripts |
  | 2691 | 2695 | \* |
  | 2692 | 2696 | \* @return void |
  | 2693 | 2697 | \*/ |
  | 2694 | 2698 | public function loadAdminScripts() |
  | 2695 | 2699 | { |
  | 2696 | 2700 | global $pagenow, $current\_screen; |
  | 2697 | 2701 | wp\_enqueue\_script('jquery'); |
  | 2698 | 2702 | $array\_menu = array( |
  | 2699 | 2703 | 'wp-meta-seo\_page\_metaseo\_dashboard', |
  | 2700 | 2704 | 'wp-meta-seo\_page\_metaseo\_image\_optimize', |
  | 2701 | 2705 | 'wp-meta-seo\_page\_metaseo\_google\_sitemap', |
  | 2702 | 2706 | 'wp-meta-seo\_page\_metaseo\_image\_compression', |
  | 2703 | 2707 | 'wp-meta-seo\_page\_metaseo\_broken\_link', |
  | 2704 | 2708 | 'wp-meta-seo\_page\_metaseo\_settings', |
  | 2705 | 2709 | 'wp-meta-seo\_page\_metaseo\_content\_meta', |
  | 2706 | 2710 | 'wp-meta-seo\_page\_metaseo\_category\_meta', |
  | 2707 | 2711 | 'wp-meta-seo\_page\_metaseo\_image\_meta', |
  | 2708 | 2712 | 'wp-meta-seo\_page\_metaseo\_link\_meta' |
  | 2709 | 2713 | ); |
  | 2710 | 2714 |  |
  | 2711 | 2715 | $lists\_pages = array( |
  | 2712 | 2716 | 'toplevel\_page\_metaseo\_dashboard', |
  | 2713 | 2717 | 'wp-meta-seo\_page\_metaseo\_content\_meta', |
  | 2714 | 2718 | 'wp-meta-seo\_page\_metaseo\_category\_meta', |
  | 2715 | 2719 | 'wp-meta-seo\_page\_metaseo\_google\_sitemap', |
  | 2716 | 2720 | 'wp-meta-seo\_page\_metaseo\_image\_meta', |
  | 2717 | 2721 | 'wp-meta-seo\_page\_metaseo\_link\_meta', |
  | 2718 | 2722 | 'wp-meta-seo\_page\_metaseo\_broken\_link', |
  | 2719 | 2723 | 'wp-meta-seo\_page\_metaseo\_console', |
  | 2720 | 2724 | 'wp-meta-seo\_page\_metaseo\_google\_analytics', |
  | 2721 | 2725 | 'wp-meta-seo\_page\_metaseo\_sendemail', |
  | 2722 | 2726 | 'wp-meta-seo\_page\_metaseo\_settings' |
  | 2723 | 2727 | ); |
  | 2724 | 2728 |  |
  | 2725 | 2729 | wp\_enqueue\_style( |
  | 2726 | 2730 | 'metaseo-google-icon', |
  | 2727 | 2731 | '//fonts.googleapis.com/icon?family=Material+Icons' |
  | 2728 | 2732 | ); |
  | 2729 | 2733 |  |
  | 2730 | 2734 | if (!empty($current\_screen) && in\_array($current\_screen->base, $lists\_pages)) { |
  | 2731 | 2735 | wp\_enqueue\_style( |
  | 2732 | 2736 | 'wpms-magnific-popup-style', |
  | 2733 | 2737 | plugins\_url('assets/css/magnific-popup.css', dirname(\_\_FILE\_\_)), |
  | 2734 | 2738 | array(), |
  | 2735 | 2739 | WPMSEO\_VERSION |
  | 2736 | 2740 | ); |
  | 2737 | 2741 |  |
  | 2738 | 2742 | wp\_enqueue\_style( |
  | 2739 | 2743 | 'wpms\_ju\_waves\_css', |
  | 2740 | 2744 | plugins\_url('assets/wordpress-css-framework/css/waves.min.css', dirname(\_\_FILE\_\_)), |
  | 2741 | 2745 | array(), |
  | 2742 | 2746 | WPMSEO\_VERSION |
  | 2743 | 2747 | ); |
  | 2744 | 2748 |  |
  | 2745 | 2749 | wp\_enqueue\_script( |
  | 2746 | 2750 | 'wpms-magnific-popup-script', |
  | 2747 | 2751 | plugins\_url('assets/js/jquery.magnific-popup.min.js', dirname(\_\_FILE\_\_)), |
  | 2748 | 2752 | array(), |
  | 2749 | 2753 | WPMSEO\_VERSION |
  | 2750 | 2754 | ); |
  | 2751 | 2755 |  |
  | 2752 | 2756 | wp\_enqueue\_style( |
  | 2753 | 2757 | 'wpms\_ju\_framework\_styles', |
  | 2754 | 2758 | plugins\_url('assets/wordpress-css-framework/css/style.min.css', dirname(\_\_FILE\_\_)), |
  | 2755 | 2759 | array(), |
  | 2756 | 2760 | WPMSEO\_VERSION |
  | 2757 | 2761 | ); |
  | 2758 | 2762 |  |
  | 2759 | 2763 | wp\_enqueue\_script( |
  | 2760 | 2764 | 'wpms\_ju\_velocity\_js', |
  | 2761 | 2765 | plugins\_url('assets/wordpress-css-framework/js/velocity.min.js', dirname(\_\_FILE\_\_)), |
  | 2762 | 2766 | array(), |
  | 2763 | 2767 | WPMSEO\_VERSION |
  | 2764 | 2768 | ); |
  | 2765 | 2769 | wp\_enqueue\_script( |
  | 2766 | 2770 | 'wpms\_ju\_waves\_js', |
  | 2767 | 2771 | plugins\_url('assets/wordpress-css-framework/js/waves.min.js', dirname(\_\_FILE\_\_)), |
  | 2768 | 2772 | array(), |
  | 2769 | 2773 | WPMSEO\_VERSION |
  | 2770 | 2774 | ); |
  | 2771 | 2775 |  |
  | 2772 | 2776 | wp\_enqueue\_script( |
  | 2773 | 2777 | 'wpms\_ju\_tabs\_js', |
  | 2774 | 2778 | plugins\_url('assets/wordpress-css-framework/js/tabs.js', dirname(\_\_FILE\_\_)), |
  | 2775 | 2779 | array(), |
  | 2776 | 2780 | WPMSEO\_VERSION |
  | 2777 | 2781 | ); |
  | 2778 | 2782 |  |
  | 2779 | 2783 | wp\_enqueue\_script( |
  | 2780 | 2784 | 'wpms\_ju\_framework\_js', |
  | 2781 | 2785 | plugins\_url('assets/wordpress-css-framework/js/script.js', dirname(\_\_FILE\_\_)), |
  | 2782 | 2786 | array('wpms\_ju\_tabs\_js'), |
  | 2783 | 2787 | WPMSEO\_VERSION |
  | 2784 | 2788 | ); |
  | 2785 | 2789 |  |
  | 2786 | 2790 | if ($current\_screen->base !== 'wp-meta-seo\_page\_metaseo\_settings') { |
  | 2787 | 2791 | wp\_enqueue\_style( |
  | 2788 | 2792 | 'wpms\_materialize\_style', |
  | 2789 | 2793 | plugins\_url('assets/css/materialize/materialize.css', dirname(\_\_FILE\_\_)), |
  | 2790 | 2794 | array(), |
  | 2791 | 2795 | WPMSEO\_VERSION |
  | 2792 | 2796 | ); |
  | 2793 | 2797 | } else { |
  | 2794 | 2798 | // Register CSS |
  | 2795 | 2799 | wp\_enqueue\_style( |
  | 2796 | 2800 | 'wpms-settings-styles', |
  | 2797 | 2801 | plugins\_url('assets/css/settings.css', dirname(\_\_FILE\_\_)), |
  | 2798 | 2802 | array('wpms\_main'), |
  | 2799 | 2803 | WPMSEO\_VERSION |
  | 2800 | 2804 | ); |
  | 2801 | 2805 |  |
  | 2802 | 2806 | wp\_enqueue\_script( |
  | 2803 | 2807 | 'wpms-settings-script', |
  | 2804 | 2808 | plugins\_url('assets/js/settings.js', dirname(\_\_FILE\_\_)), |
  | 2805 | 2809 | array('jquery'), |
  | 2806 | 2810 | WPMSEO\_VERSION, |
  | 2807 | 2811 | true |
  | 2808 | 2812 | ); |
  | 2809 | 2813 |  |
  | 2810 | 2814 | wp\_localize\_script('wpms-settings-script', 'wpmsSettingsL10n', array( |
  | 2811 | 2815 | 'choose\_image' => esc\_html\_\_('Use Image', 'wp-meta-seo') |
  | 2812 | 2816 | )); |
  | 2813 | 2817 | } |
  | 2814 | 2818 |  |
  | 2815 | 2819 | wp\_enqueue\_style( |
  | 2816 | 2820 | 'wpms\_main', |
  | 2817 | 2821 | plugins\_url('assets/css/main.css', dirname(\_\_FILE\_\_)), |
  | 2818 | 2822 | array(), |
  | 2819 | 2823 | WPMSEO\_VERSION |
  | 2820 | 2824 | ); |
  | 2821 | 2825 | } |
  | 2822 | 2826 |  |
  | 2823 | 2827 | wp\_enqueue\_script( |
  | 2824 | 2828 | 'wpmetaseoAdmin', |
  | 2825 | 2829 | plugins\_url('assets/js/metaseo\_admin.js', dirname(\_\_FILE\_\_)), |
  | 2826 | 2830 | array('jquery'), |
  | 2827 | 2831 | WPMSEO\_VERSION, |
  | 2828 | 2832 | true |
  | 2829 | 2833 | ); |
  | 2830 | 2834 |  |
  | 2831 | 2835 | if (!empty($current\_screen) && (in\_array($current\_screen->base, $array\_menu) || $pagenow === 'post.php' || $pagenow === 'post-new.php')) { |
  | 2832 | 2836 | wp\_enqueue\_style( |
  | 2833 | 2837 | 'wpmetaseoAdmin', |
  | 2834 | 2838 | plugins\_url('assets/css/metaseo\_admin.css', dirname(\_\_FILE\_\_)), |
  | 2835 | 2839 | array(), |
  | 2836 | 2840 | WPMSEO\_VERSION |
  | 2837 | 2841 | ); |
  | 2838 | 2842 | wp\_enqueue\_style( |
  | 2839 | 2843 | 'tooltip-metaimage', |
  | 2840 | 2844 | plugins\_url('assets/css/tooltip-metaimage.css', dirname(\_\_FILE\_\_)), |
  | 2841 | 2845 | array(), |
  | 2842 | 2846 | WPMSEO\_VERSION |
  | 2843 | 2847 | ); |
  | 2844 | 2848 |  |
  | 2845 | 2849 | wp\_enqueue\_style('style', plugins\_url('assets/css/style.css', dirname(\_\_FILE\_\_)), array(), WPMSEO\_VERSION); |
  | 2846 | 2850 | } |
  | 2847 | 2851 |  |
  | 2848 | 2852 | if (!empty($current\_screen) && ($current\_screen->base === 'wp-meta-seo\_page\_metaseo\_image\_meta' |
  | 2849 | 2853 | || $current\_screen->base === 'wp-meta-seo\_page\_metaseo\_content\_meta')) { |
  | 2850 | 2854 | wp\_enqueue\_script( |
  | 2851 | 2855 | 'wpms-bulk', |
  | 2852 | 2856 | plugins\_url('assets/js/wpms-bulk-action.js', dirname(\_\_FILE\_\_)), |
  | 2853 | 2857 | array('jquery'), |
  | 2854 | 2858 | WPMSEO\_VERSION, |
  | 2855 | 2859 | true |
  | 2856 | 2860 | ); |
  | 2857 | 2861 | wp\_localize\_script('wpms-bulk', 'wpmseobulkL10n', $this->localizeScript()); |
  | 2858 | 2862 | } |
  | 2859 | 2863 |  |
  | 2860 | 2864 | if (!empty($current\_screen) && $current\_screen->base === 'wp-meta-seo\_page\_metaseo\_broken\_link') { |
  | 2861 | 2865 | wp\_enqueue\_style( |
  | 2862 | 2866 | 'wpms\_brokenlink\_style', |
  | 2863 | 2867 | plugins\_url('assets/css/broken\_link.css', dirname(\_\_FILE\_\_)), |
  | 2864 | 2868 | array(), |
  | 2865 | 2869 | WPMSEO\_VERSION |
  | 2866 | 2870 | ); |
  | 2867 | 2871 |  |
  | 2868 | 2872 | wp\_enqueue\_style( |
  | 2869 | 2873 | 'wpms-bootstrap-style', |
  | 2870 | 2874 | plugins\_url('assets/css/bootstrap/bootstrap.min.css', dirname(\_\_FILE\_\_)), |
  | 2871 | 2875 | array(), |
  | 2872 | 2876 | WPMSEO\_VERSION |
  | 2873 | 2877 | ); |
  | 2874 | 2878 |  |
  | 2875 | 2879 | wp\_enqueue\_style( |
  | 2876 | 2880 | 'wpms-bootstrap-multiselect-style', |
  | 2877 | 2881 | plugins\_url('assets/css/bootstrap/bootstrap-multiselect.css', dirname(\_\_FILE\_\_)), |
  | 2878 | 2882 | array(), |
  | 2879 | 2883 | WPMSEO\_VERSION |
  | 2880 | 2884 | ); |
  | 2881 | 2885 |  |
  | 2882 | 2886 | wp\_enqueue\_script( |
  | 2883 | 2887 | 'wpms-bootstrap-multiselect-script', |
  | 2884 | 2888 | plugins\_url('assets/css/bootstrap/bootstrap-multiselect.js', dirname(\_\_FILE\_\_)), |
  | 2885 | 2889 | array('jquery'), |
  | 2886 | 2890 | WPMSEO\_VERSION, |
  | 2887 | 2891 | true |
  | 2888 | 2892 | ); |
  | 2889 | 2893 | } |
  | 2890 | 2894 |  |
  | 2891 | 2895 | if (!empty($current\_screen) && $current\_screen->base === 'toplevel\_page\_metaseo\_dashboard') { |
  | 2892 | 2896 | wp\_enqueue\_script( |
  | 2893 | 2897 | 'metaseo-dashboard', |
  | 2894 | 2898 | plugins\_url('assets/js/dashboard.js', dirname(\_\_FILE\_\_)), |
  | 2895 | 2899 | array('jquery'), |
  | 2896 | 2900 | WPMSEO\_VERSION, |
  | 2897 | 2901 | true |
  | 2898 | 2902 | ); |
  | 2899 | 2903 |  |
  | 2900 | 2904 | wp\_enqueue\_style( |
  | 2901 | 2905 | 'metaseo-quirk', |
  | 2902 | 2906 | plugins\_url('assets/css/metaseo-quirk.css', dirname(\_\_FILE\_\_)) |
  | 2903 | 2907 | ); |
  | 2904 | 2908 |  |
  | 2905 | 2909 | wp\_enqueue\_style( |
  | 2906 | 2910 | 'm-style-dashboard', |
  | 2907 | 2911 | plugins\_url('assets/css/dashboard.css', dirname(\_\_FILE\_\_)), |
  | 2908 | 2912 | array(), |
  | 2909 | 2913 | WPMSEO\_VERSION |
  | 2910 | 2914 | ); |
  | 2911 | 2915 |  |
  | 2912 | 2916 | wp\_enqueue\_style( |
  | 2913 | 2917 | 'wpms-ju-css-framwork', |
  | 2914 | 2918 | plugins\_url('assets/css/main.css', dirname(\_\_FILE\_\_)), |
  | 2915 | 2919 | array(), |
  | 2916 | 2920 | WPMSEO\_VERSION |
  | 2917 | 2921 | ); |
  | 2918 | 2922 |  |
  | 2919 | 2923 | if (class\_exists('MetaSeoAddonAdmin')) { |
  | 2920 | 2924 | wp\_enqueue\_style( |
  | 2921 | 2925 | 'msaddon-style-dashboard', |
  | 2922 | 2926 | WPMETASEO\_ADDON\_PLUGIN\_URL . 'assets/css/dashboard.css', |
  | 2923 | 2927 | array(), |
  | 2924 | 2928 | WPMSEO\_ADDON\_VERSION |
  | 2925 | 2929 | ); |
  | 2926 | 2930 | } |
  | 2927 | 2931 | } |
  | 2928 | 2932 |  |
  | 2929 | 2933 | if (!empty($current\_screen) && $current\_screen->base === 'wp-meta-seo\_page\_metaseo\_better\_ranking') { |
  | 2930 | 2934 | wp\_enqueue\_style( |
  | 2931 | 2935 | 'wpms-better-seo', |
  | 2932 | 2936 | plugins\_url('assets/css/better\_seo.css', dirname(\_\_FILE\_\_)), |
  | 2933 | 2937 | array(), |
  | 2934 | 2938 | WPMSEO\_VERSION |
  | 2935 | 2939 | ); |
  | 2936 | 2940 |  |
  | 2937 | 2941 | wp\_enqueue\_style( |
  | 2938 | 2942 | 'wpms-ju-css-framwork', |
  | 2939 | 2943 | plugins\_url('assets/css/main.css', dirname(\_\_FILE\_\_)), |
  | 2940 | 2944 | array(), |
  | 2941 | 2945 | WPMSEO\_VERSION |
  | 2942 | 2946 | ); |
  | 2943 | 2947 | } |
  | 2944 | 2948 |  |
  | 2945 | 2949 | $lists\_pages = array( |
  | 2946 | 2950 | 'toplevel\_page\_metaseo\_dashboard', |
  | 2947 | 2951 | 'wp-meta-seo\_page\_metaseo\_google\_sitemap', |
  | 2948 | 2952 | 'wp-meta-seo\_page\_metaseo\_link\_meta', |
  | 2949 | 2953 | 'wp-meta-seo\_page\_metaseo\_broken\_link', |
  | 2950 | 2954 | 'wp-meta-seo\_page\_metaseo\_google\_analytics' |
  | 2951 | 2955 | ); |
  | 2952 | 2956 | if (!empty($current\_screen) && in\_array($current\_screen->base, $lists\_pages)) { |
  | 2953 | 2957 | wp\_enqueue\_style( |
  | 2954 | 2958 | 'wpms\_notification\_style', |
  | 2955 | 2959 | plugins\_url('assets/css/notification.css', dirname(\_\_FILE\_\_)), |
  | 2956 | 2960 | array(), |
  | 2957 | 2961 | WPMSEO\_VERSION |
  | 2958 | 2962 | ); |
  | 2959 | 2963 | wp\_enqueue\_script( |
  | 2960 | 2964 | 'wpms\_notification\_script', |
  | 2961 | 2965 | plugins\_url('assets/js/notification.js', dirname(\_\_FILE\_\_)), |
  | 2962 | 2966 | array(), |
  | 2963 | 2967 | WPMSEO\_VERSION |
  | 2964 | 2968 | ); |
  | 2965 | 2969 | } |
  | 2966 | 2970 |  |
  | 2967 | 2971 | wp\_register\_style( |
  | 2968 | 2972 | 'wpms-dashboard-widgets', |
  | 2969 | 2973 | plugins\_url('assets/css/dashboard-widgets/dashboard\_widgets.css', dirname(\_\_FILE\_\_)), |
  | 2970 | 2974 | null, |
  | 2971 | 2975 | WPMSEO\_VERSION |
  | 2972 | 2976 | ); |
  | 2973 | 2977 | wp\_register\_style( |
  | 2974 | 2978 | 'wpms-category-field', |
  | 2975 | 2979 | plugins\_url('assets/css/category\_field.css', dirname(\_\_FILE\_\_)), |
  | 2976 | 2980 | null, |
  | 2977 | 2981 | WPMSEO\_VERSION |
  | 2978 | 2982 | ); |
  | 2979 | 2983 | wp\_register\_script( |
  | 2980 | 2984 | 'wpms-category-field', |
  | 2981 | 2985 | plugins\_url('assets/js/category\_field.js', dirname(\_\_FILE\_\_)), |
  | 2982 | 2986 | array('jquery'), |
  | 2983 | 2987 | WPMSEO\_VERSION, |
  | 2984 | 2988 | true |
  | 2985 | 2989 | ); |
  | 2986 | 2990 |  |
  | 2987 | 2991 | // Enqueue for category meta page |
  | 2988 | 2992 | if (!empty($current\_screen) && $current\_screen->base === 'wp-meta-seo\_page\_metaseo\_category\_meta') { |
  | 2989 | 2993 | wp\_enqueue\_style( |
  | 2990 | 2994 | 'wpmsCategoryMeta', |
  | 2991 | 2995 | plugins\_url('assets/css/metaseo-category-meta-bulk.css', dirname(\_\_FILE\_\_)), |
  | 2992 | 2996 | array(), |
  | 2993 | 2997 | WPMSEO\_VERSION |
  | 2994 | 2998 | ); |
  | 2995 | 2999 |  |
  | 2996 | 3000 | wp\_enqueue\_script( |
  | 2997 | 3001 | 'wpmsCategoryMeta', |
  | 2998 | 3002 | plugins\_url('assets/js/wpms-category-meta.js', dirname(\_\_FILE\_\_)), |
  | 2999 | 3003 | array('jquery'), |
  | 3000 | 3004 | WPMSEO\_VERSION, |
  | 3001 | 3005 | true |
  | 3002 | 3006 | ); |
  | 3003 | 3007 | wp\_enqueue\_script('wpms-category-field'); |
  | 3004 | 3008 | } |
  | 3005 | 3009 |  |
  | 3006 | 3010 | wp\_register\_style( |
  | 3007 | 3011 | 'wpms-tippy-style', |
  | 3008 | 3012 | plugins\_url('assets/tippy/tippy.css', dirname(\_\_FILE\_\_)), |
  | 3009 | 3013 | array(), |
  | 3010 | 3014 | WPMSEO\_VERSION |
  | 3011 | 3015 | ); |
  | 3012 | 3016 |  |
  | 3013 | 3017 | wp\_register\_script( |
  | 3014 | 3018 | 'wpms-tippy-core', |
  | 3015 | 3019 | plugins\_url('assets/tippy/tippy-core.js', dirname(\_\_FILE\_\_)), |
  | 3016 | 3020 | array('jquery'), |
  | 3017 | 3021 | '2.2.1', |
  | 3018 | 3022 | true |
  | 3019 | 3023 | ); |
  | 3020 | 3024 |  |
  | 3021 | 3025 | wp\_register\_script( |
  | 3022 | 3026 | 'wpms-tippy', |
  | 3023 | 3027 | plugins\_url('assets/tippy/tippy.js', dirname(\_\_FILE\_\_)), |
  | 3024 | 3028 | array('jquery'), |
  | 3025 | 3029 | '2.2.1', |
  | 3026 | 3030 | true |
  | 3027 | 3031 | ); |
  | 3028 | 3032 |  |
  | 3029 | 3033 | wp\_register\_script( |
  | 3030 | 3034 | 'wpms-my-tippy', |
  | 3031 | 3035 | plugins\_url('assets/tippy/my-tippy.js', dirname(\_\_FILE\_\_)), |
  | 3032 | 3036 | array('jquery'), |
  | 3033 | 3037 | WPMSEO\_VERSION, |
  | 3034 | 3038 | true |
  | 3035 | 3039 | ); |
  | 3036 | 3040 |  |
  | 3037 | 3041 | wp\_enqueue\_style( |
  | 3038 | 3042 | 'wpms-mytippy-style', |
  | 3039 | 3043 | plugins\_url('assets/tippy/my-tippy.css', dirname(\_\_FILE\_\_)), |
  | 3040 | 3044 | array(), |
  | 3041 | 3045 | WPMSEO\_VERSION |
  | 3042 | 3046 | ); |
  | 3043 | 3047 | // Register snackbar script alert |
  | 3044 | 3048 | wp\_register\_script( |
  | 3045 | 3049 | 'wpms-snackbar-script', |
  | 3046 | 3050 | plugins\_url('assets/js/snackbar.js', dirname(\_\_FILE\_\_)), |
  | 3047 | 3051 | array('jquery'), |
  | 3048 | 3052 | WPMSEO\_VERSION, |
  | 3049 | 3053 | true |
  | 3050 | 3054 | ); |
  | 3051 | 3055 | // Register snackbar style alert |
  | 3052 | 3056 | wp\_register\_style( |
  | 3053 | 3057 | 'wpms-snackbar-style', |
  | 3054 | 3058 | plugins\_url('assets/css/snackbar.css', dirname(\_\_FILE\_\_)), |
  | 3055 | 3059 | array(), |
  | 3056 | 3060 | WPMSEO\_VERSION |
  | 3057 | 3061 | ); |
  | 3058 | 3062 | wp\_register\_script( |
  | 3059 | 3063 | 'wpms-broken-link', |
  | 3060 | 3064 | plugins\_url('assets/js/wpms-broken-link.js', dirname(\_\_FILE\_\_)), |
  | 3061 | 3065 | array('jquery'), |
  | 3062 | 3066 | WPMSEO\_VERSION, |
  | 3063 | 3067 | true |
  | 3064 | 3068 | ); |
  | 3065 | 3069 |  |
  | 3066 | 3070 | wp\_register\_style('metaseo-google-icon', '//fonts.googleapis.com/icon?family=Material+Icons'); |
  | 3067 | 3071 | if (!empty($current\_screen) && $current\_screen->base === 'wp-meta-seo\_page\_metaseo\_google\_analytics') { |
  | 3068 | 3072 | $lang = get\_bloginfo('language'); |
  | 3069 | 3073 | $lang = explode('-', $lang); |
  | 3070 | 3074 | $lang = $lang[0]; |
  | 3071 | 3075 | wp\_enqueue\_style( |
  | 3072 | 3076 | 'wpms-nprogress', |
  | 3073 | 3077 | plugins\_url('assets/css/google-analytics/nprogress.css', dirname(\_\_FILE\_\_)), |
  | 3074 | 3078 | null, |
  | 3075 | 3079 | WPMSEO\_VERSION |
  | 3076 | 3080 | ); |
  | 3077 | 3081 |  |
  | 3078 | 3082 | wp\_register\_style( |
  | 3079 | 3083 | 'wpms-backend-item-reports', |
  | 3080 | 3084 | plugins\_url('assets/css/google-analytics/admin-widgets.css', dirname(\_\_FILE\_\_)), |
  | 3081 | 3085 | null, |
  | 3082 | 3086 | WPMSEO\_VERSION |
  | 3083 | 3087 | ); |
  | 3084 | 3088 | wp\_register\_style( |
  | 3085 | 3089 | 'wpms-backend-tracking-code', |
  | 3086 | 3090 | plugins\_url('assets/css/google-analytics/wpms-tracking-code.css', dirname(\_\_FILE\_\_)), |
  | 3087 | 3091 | null, |
  | 3088 | 3092 | WPMSEO\_VERSION |
  | 3089 | 3093 | ); |
  | 3090 | 3094 |  |
  | 3091 | 3095 | wp\_register\_style( |
  | 3092 | 3096 | 'jquery-ui-tooltip-html', |
  | 3093 | 3097 | plugins\_url('assets/css/google-analytics/jquery.ui.tooltip.html.css', dirname(\_\_FILE\_\_)) |
  | 3094 | 3098 | ); |
  | 3095 | 3099 |  |
  | 3096 | 3100 | wp\_enqueue\_style('jquery-ui-tooltip-html'); |
  | 3097 | 3101 |  |
  | 3098 | 3102 | wp\_enqueue\_script( |
  | 3099 | 3103 | 'wpmsgooglejsapi', |
  | 3100 | 3104 | 'https://www.google.com/jsapi?autoload=%7B%22modules%22%3A%5B%7B%22name%22%3A%22visualization%22%2C%22version%22%3A%221%22%2C%22language%22%3A%22' . $lang . '%22%2C%22packages%22%3A%5B%22corechart%22%2C%20%22imagechart%22%2C%20%22table%22%2C%20%22orgchart%22%2C%20%22geochart%22%5D%7D%5D%7D', |
  | 3101 | 3105 | array(), |
  | 3102 | 3106 | null |
  | 3103 | 3107 | ); |
  | 3104 | 3108 |  |
  | 3105 | 3109 | wp\_enqueue\_script( |
  | 3106 | 3110 | 'wpms-nprogress', |
  | 3107 | 3111 | plugins\_url('assets/js/google-analytics/nprogress.js', dirname(\_\_FILE\_\_)), |
  | 3108 | 3112 | array('jquery'), |
  | 3109 | 3113 | WPMSEO\_VERSION |
  | 3110 | 3114 | ); |
  | 3111 | 3115 |  |
  | 3112 | 3116 | wp\_enqueue\_script( |
  | 3113 | 3117 | 'wpms-google-analytics', |
  | 3114 | 3118 | plugins\_url('assets/js/google-analytics/google\_analytics.js', dirname(\_\_FILE\_\_)), |
  | 3115 | 3119 | array('jquery'), |
  | 3116 | 3120 | WPMSEO\_VERSION, |
  | 3117 | 3121 | true |
  | 3118 | 3122 | ); |
  | 3119 | 3123 |  |
  | 3120 | 3124 | // Select toolbar |
  | 3121 | 3125 | require\_once 'google\_analytics/wpmstools.php'; |
  | 3122 | 3126 | $wpms\_google\_analytics = get\_option('wpms\_google\_alanytics'); |
  | 3123 | 3127 | if (isset($wpms\_google\_analytics['tableid\_jail']) && isset($wpms\_google\_analytics['profile\_list'])) { |
  | 3124 | 3128 | $wpms\_profile = WpmsGaTools::getSelectedProfile($wpms\_google\_analytics['profile\_list'], $wpms\_google\_analytics['tableid\_jail']); |
  | 3125 | 3129 | } |
  | 3126 | 3130 | if (isset($wpms\_profile[4])) { |
  | 3127 | 3131 | $property\_type = $wpms\_profile[4]; |
  | 3128 | 3132 | } else { |
  | 3129 | 3133 | $property\_type = 'UA'; |
  | 3130 | 3134 | } |
  | 3131 | 3135 | /\* @formatter:off \*/ |
  | 3132 | 3136 | wp\_localize\_script( |
  | 3133 | 3137 | 'wpms-google-analytics', |
  | 3134 | 3138 | 'wpmsItemData', |
  | 3135 | 3139 | array( |
  | 3136 | 3140 | 'ajaxurl' => admin\_url('admin-ajax.php'), |
  | 3137 | 3141 | 'security' => wp\_create\_nonce('wpms\_backend\_item\_reports'), |
  | 3138 | 3142 | 'dateList' => array( |
  | 3139 | 3143 | 'realtime' => esc\_html\_\_('Real-Time', 'wp-meta-seo'), |
  | 3140 | 3144 | 'today' => esc\_html\_\_('Today', 'wp-meta-seo'), |
  | 3141 | 3145 | 'yesterday' => esc\_html\_\_('Yesterday', 'wp-meta-seo'), |
  | 3142 | 3146 | '7daysAgo' => sprintf(esc\_html\_\_('Last %d Days', 'wp-meta-seo'), 7), |
  | 3143 | 3147 | '14daysAgo' => sprintf(esc\_html\_\_('Last %d Days', 'wp-meta-seo'), 14), |
  | 3144 | 3148 | '30daysAgo' => sprintf(esc\_html\_\_('Last %d Days', 'wp-meta-seo'), 30), |
  | 3145 | 3149 | '90daysAgo' => sprintf(esc\_html\_\_('Last %d Days', 'wp-meta-seo'), 90), |
  | 3146 | 3150 | '365daysAgo' => sprintf(\_n('%s Year', '%s Years', 1, 'wp-meta-seo'), esc\_html\_\_('One', 'wp-meta-seo')), |
  | 3147 | 3151 | '1095daysAgo' => sprintf( |
  | 3148 | 3152 | \_n('%s Year', '%s Years', 3, 'wp-meta-seo'), |
  | 3149 | 3153 | esc\_html\_\_('Three', 'wp-meta-seo') |
  | 3150 | 3154 | ), |
  | 3151 | 3155 | ), |
  | 3152 | 3156 | 'property\_type' => $property\_type, |
  | 3153 | 3157 | 'reportList' => array( |
  | 3154 | 3158 | 'sessions' => esc\_html\_\_('Sessions', 'wp-meta-seo'), |
  | 3155 | 3159 | 'users' => esc\_html\_\_('Users', 'wp-meta-seo'), |
  | 3156 | 3160 | 'organicSearches' => esc\_html\_\_('Organic', 'wp-meta-seo'), |
  | 3157 | 3161 | 'pageviews' => esc\_html\_\_('Page Views', 'wp-meta-seo'), |
  | 3158 | 3162 | 'visitBounceRate' => esc\_html\_\_('Bounce Rate', 'wp-meta-seo'), |
  | 3159 | 3163 | 'locations' => esc\_html\_\_('Location', 'wp-meta-seo'), |
  | 3160 | 3164 | 'contentpages' => esc\_html\_\_('Pages', 'wp-meta-seo'), |
  | 3161 | 3165 | 'referrers' => esc\_html\_\_('Referrers', 'wp-meta-seo'), |
  | 3162 | 3166 | 'searches' => esc\_html\_\_('Searches', 'wp-meta-seo'), |
  | 3163 | 3167 | 'trafficdetails' => esc\_html\_\_('Traffic', 'wp-meta-seo'), |
  | 3164 | 3168 | 'technologydetails' => esc\_html\_\_('Technology', 'wp-meta-seo'), |
  | 3165 | 3169 | ), |
  | 3166 | 3170 | 'reportList\_ga4' => array( |
  | 3167 | 3171 | 'sessions' => esc\_html\_\_('Sessions', 'wp-meta-seo'), |
  | 3168 | 3172 | 'users' => esc\_html\_\_('Users', 'wp-meta-seo'), |
  | 3169 | 3173 | 'pageviews' => esc\_html\_\_('Page Views', 'wp-meta-seo'), |
  | 3170 | 3174 | 'visitBounceRate' => esc\_html\_\_('Engagement', 'wp-meta-seo'), |
  | 3171 | 3175 | 'organicSearches' => esc\_html\_\_('Transactions', 'wp-meta-seo'), |
  | 3172 | 3176 | 'locations' => esc\_html\_\_('Location', 'wp-meta-seo'), |
  | 3173 | 3177 | 'contentpages' => esc\_html\_\_('Pages', 'wp-meta-seo'), |
  | 3174 | 3178 | 'referrers' => esc\_html\_\_('Referrers', 'wp-meta-seo'), |
  | 3175 | 3179 | 'searches' => esc\_html\_\_('Searches', 'wp-meta-seo'), |
  | 3176 | 3180 | 'trafficdetails' => esc\_html\_\_('Traffic', 'wp-meta-seo'), |
  | 3177 | 3181 | 'technologydetails' => esc\_html\_\_('Technology', 'wp-meta-seo'), |
  | 3178 | 3182 | ), |
  | 3179 | 3183 | 'i18n' => array( |
  | 3180 | 3184 | esc\_html\_\_('A JavaScript Error is blocking plugin resources!', 'wp-meta-seo'), //0 |
  | 3181 | 3185 | esc\_html\_\_('Traffic Mediums', 'wp-meta-seo'), |
  | 3182 | 3186 | esc\_html\_\_('Visitor Type', 'wp-meta-seo'), |
  | 3183 | 3187 | esc\_html\_\_('Search Engines', 'wp-meta-seo'), |
  | 3184 | 3188 | esc\_html\_\_('Social Networks', 'wp-meta-seo'), |
  | 3185 | 3189 | esc\_html\_\_('Sessions', 'wp-meta-seo'), //5 |
  | 3186 | 3190 | esc\_html\_\_('Users', 'wp-meta-seo'), |
  | 3187 | 3191 | esc\_html\_\_('Page Views', 'wp-meta-seo'), |
  | 3188 | 3192 | esc\_html\_\_('Bounce Rate', 'wp-meta-seo'), |
  | 3189 | 3193 | esc\_html\_\_('Organic Search', 'wp-meta-seo'), |
  | 3190 | 3194 | esc\_html\_\_('Pages/Session', 'wp-meta-seo'), //10 |
  | 3191 | 3195 | esc\_html\_\_('Invalid response', 'wp-meta-seo'), |
  | 3192 | 3196 | esc\_html\_\_('Not enough data collected', 'wp-meta-seo'), |
  | 3193 | 3197 | esc\_html\_\_('This report is unavailable', 'wp-meta-seo'), |
  | 3194 | 3198 | esc\_html\_\_('report generated by', 'wp-meta-seo'), //14 |
  | 3195 | 3199 | esc\_html\_\_('This plugin needs an authorization:', 'wp-meta-seo') . ' |
  | 3196 | 3200 | <a href="' . esc\_html(admin\_url('admin.php?page=metaseo\_google\_analytics&view=wpmsga\_trackcode')) . '"> |
  | 3197 | 3201 | ' . esc\_html\_\_('authorize the plugin', 'wp-meta-seo') . '</a>.', |
  | 3198 | 3202 | esc\_html\_\_('Browser', 'wp-meta-seo'), //16 |
  | 3199 | 3203 | esc\_html\_\_('Operating System', 'wp-meta-seo'), |
  | 3200 | 3204 | esc\_html\_\_('Screen Resolution', 'wp-meta-seo'), |
  | 3201 | 3205 | esc\_html\_\_('Mobile Brand', 'wp-meta-seo'), |
  | 3202 | 3206 | esc\_html\_\_('REFERRALS', 'wp-meta-seo'), //20 |
  | 3203 | 3207 | esc\_html\_\_('KEYWORDS', 'wp-meta-seo'), |
  | 3204 | 3208 | esc\_html\_\_('SOCIAL', 'wp-meta-seo'), |
  | 3205 | 3209 | esc\_html\_\_('CAMPAIGN', 'wp-meta-seo'), |
  | 3206 | 3210 | esc\_html\_\_('DIRECT', 'wp-meta-seo'), |
  | 3207 | 3211 | esc\_html\_\_('NEW', 'wp-meta-seo'), //25 |
  | 3208 | 3212 | esc\_html\_\_('You need select a profile:', 'wp-meta-seo') . ' |
  | 3209 | 3213 | <a href="' . esc\_html(admin\_url('admin.php?page=metaseo\_google\_analytics&view=wpmsga\_trackcode')) . '"> |
  | 3210 | 3214 | ' . esc\_html\_\_('authorize the plugin', 'wp-meta-seo') . '</a>.', |
  | 3211 | 3215 | esc\_html\_\_('Engagement', 'wp-meta-seo'), |
  | 3212 | 3216 | esc\_html\_\_('Transactions', 'wp-meta-seo'), |
  | 3213 | 3217 | ), |
  | 3214 | 3218 | 'rtLimitPages' => 10, |
  | 3215 | 3219 | 'colorVariations' => array( |
  | 3216 | 3220 | '#1e73be', |
  | 3217 | 3221 | '#0459a4', |
  | 3218 | 3222 | '#378cd7', |
  | 3219 | 3223 | '#51a6f1', |
  | 3220 | 3224 | '#00408b', |
  | 3221 | 3225 | '#6abfff', |
  | 3222 | 3226 | '#002671' |
  | 3223 | 3227 | ), |
  | 3224 | 3228 | 'region' => false, |
  | 3225 | 3229 | 'language' => get\_bloginfo('language'), |
  | 3226 | 3230 | 'viewList' => false, |
  | 3227 | 3231 | 'scope' => 'admin-widgets', |
  | 3228 | 3232 | 'admin\_url' => admin\_url() |
  | 3229 | 3233 | ) |
  | 3230 | 3234 | ); |
  | 3231 | 3235 |  |
  | 3232 | 3236 | wp\_enqueue\_script( |
  | 3233 | 3237 | 'wpms-cookie', |
  | 3234 | 3238 | plugins\_url('assets/js/jquery.cookie.js', dirname(\_\_FILE\_\_)), |
  | 3235 | 3239 | array(), |
  | 3236 | 3240 | '1.4.1' |
  | 3237 | 3241 | ); |
  | 3238 | 3242 | } |
  | 3239 | 3243 |  |
  | 3240 | 3244 | // Add intro text on each wpms topic |
  | 3241 | 3245 | $tippy\_pages = array( |
  | 3242 | 3246 | 'wp-meta-seo\_page\_metaseo\_content\_meta', |
  | 3243 | 3247 | 'wp-meta-seo\_page\_metaseo\_category\_meta', |
  | 3244 | 3248 | 'wp-meta-seo\_page\_metaseo\_image\_meta', |
  | 3245 | 3249 | 'wp-meta-seo\_page\_metaseo\_google\_sitemap', |
  | 3246 | 3250 | 'wp-meta-seo\_page\_metaseo\_link\_meta', |
  | 3247 | 3251 | 'wp-meta-seo\_page\_metaseo\_broken\_link', |
  | 3248 | 3252 | 'wp-meta-seo\_page\_metaseo\_google\_analytics', |
  | 3249 | 3253 | 'wp-meta-seo\_page\_metaseo\_sendemail' |
  | 3250 | 3254 | ); |
  | 3251 | 3255 | if (!empty($current\_screen) && in\_array($current\_screen->base, $tippy\_pages)) { |
  | 3252 | 3256 | wp\_enqueue\_style('wpms-tippy-style'); |
  | 3253 | 3257 | wp\_enqueue\_script('wpms-tippy-core'); |
  | 3254 | 3258 | wp\_enqueue\_script('wpms-tippy'); |
  | 3255 | 3259 | wp\_enqueue\_script('wpms-my-tippy'); |
  | 3256 | 3260 | } |
  | 3257 | 3261 |  |
  | 3258 | 3262 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 3259 | 3263 | $addon\_active = 1; |
  | 3260 | 3264 | } else { |
  | 3261 | 3265 | $addon\_active = 0; |
  | 3262 | 3266 | } |
  | 3263 | 3267 | // in JavaScript, object properties are accessed as ajax\_object.ajax\_url, ajax\_object.we\_value |
  | 3264 | 3268 | wp\_localize\_script('wpmetaseoAdmin', 'wpms\_localize', array( |
  | 3265 | 3269 | 'filter\_by' => esc\_html\_\_('Select to filter', 'wp-meta-seo'), |
  | 3266 | 3270 | 'replaced' => esc\_html\_\_('Replaced', 'wp-meta-seo'), |
  | 3267 | 3271 | 'index\_link' => esc\_html\_\_('Loading...', 'wp-meta-seo'), |
  | 3268 | 3272 | 'addon\_active' => $addon\_active, |
  | 3269 | 3273 | 'ajax\_url' => admin\_url('admin-ajax.php'), |
  | 3270 | 3274 | 'settings' => $this->settings, |
  | 3271 | 3275 | 'wpms\_cat\_metatitle\_length' => MPMSCAT\_TITLE\_LENGTH, |
  | 3272 | 3276 | 'wpms\_cat\_metadesc\_length' => MPMSCAT\_DESC\_LENGTH, |
  | 3273 | 3277 | 'wpms\_cat\_metakeywords\_length' => MPMSCAT\_KEYWORDS\_LENGTH, |
  | 3274 | 3278 | 'wpms\_nonce' => wp\_create\_nonce('wpms\_nonce'), |
  | 3275 | 3279 | 'home\_url' => home\_url(), |
  | 3276 | 3280 | 'images\_url' => WPMETASEO\_PLUGIN\_URL . 'assets/images/', |
  | 3277 | 3281 | 'dashboard\_tooltips' => array( |
  | 3278 | 3282 | 'url\_rewwrite' => esc\_html\_\_('Optimized at: ', 'wp-meta-seo'), |
  | 3279 | 3283 | 'images\_resized' => esc\_html\_\_('HTML image resized (using handles) count: ', 'wp-meta-seo'), |
  | 3280 | 3284 | 'metatitle' => esc\_html\_\_('Meta title filled: ', 'wp-meta-seo'), |
  | 3281 | 3285 | 'image\_alt' => esc\_html\_\_('Image data filled (in content): ', 'wp-meta-seo'), |
  | 3282 | 3286 | 'metadesc' => esc\_html\_\_('Meta description filled: ', 'wp-meta-seo'), |
  | 3283 | 3287 | 'link\_title' => esc\_html\_\_('Links title completed: ', 'wp-meta-seo'), |
  | 3284 | 3288 | 'fresh\_content' => esc\_html\_\_('Last month new or updated content: ', 'wp-meta-seo'), |
  | 3285 | 3289 | 'elements' => esc\_html\_\_(' elements', 'wp-meta-seo'), |
  | 3286 | 3290 | 'duplicate\_title' => esc\_html\_\_('Duplicate Meta Titles: ', 'wp-meta-seo'), |
  | 3287 | 3291 | 'duplicate\_desc' => esc\_html\_\_('Duplicate Meta Descriptions: ', 'wp-meta-seo'), |
  | 3288 | 3292 | '404' => esc\_html\_\_('Redirected 404 errors: ', 'wp-meta-seo') |
  | 3289 | 3293 | ), |
  | 3290 | 3294 | 'gg\_disconnect\_title' => array ( |
  | 3291 | 3295 | 'universal' => esc\_html\_\_('UA-Tracking ID', 'wp-meta-seo'), |
  | 3292 | 3296 | 'ga4' => esc\_html\_\_('Measurement ID', 'wp-meta-seo'), |
  | 3293 | 3297 | 'tagmanager' => esc\_html\_\_('Container ID', 'wp-meta-seo'), |
  | 3294 | 3298 | ) |
  | 3295 | 3299 | )); |
  | 3296 | 3300 |  |
  | 3297 | 3301 |  |
  | 3298 | 3302 | $this->columnsEnqueue(); |
  | 3299 | 3303 | } |
  | 3300 | 3304 |  |
  | 3301 | 3305 | /\*\* |
  | 3302 | 3306 | \* Enqueue styles and scripts. |
  | 3303 | 3307 | \* |
  | 3304 | 3308 | \* @return void |
  | 3305 | 3309 | \*/ |
  | 3306 | 3310 | public function columnsEnqueue() |
  | 3307 | 3311 | { |
  | 3308 | 3312 | if (function\_exists('get\_current\_screen')) { |
  | 3309 | 3313 | $screen = get\_current\_screen(); |
  | 3310 | 3314 | $allowed\_post\_types = self::getAccessiblePostTypes(); |
  | 3311 | 3315 |  |
  | 3312 | 3316 | if (!empty($current\_screen) && !in\_array($screen->post\_type, $allowed\_post\_types, true)) { |
  | 3313 | 3317 | return; |
  | 3314 | 3318 | } |
  | 3315 | 3319 | } |
  | 3316 | 3320 |  |
  | 3317 | 3321 | wp\_enqueue\_style( |
  | 3318 | 3322 | 'wpms-post-bulk-edit', |
  | 3319 | 3323 | plugins\_url('assets/css/wpms-post-bulk-edit.css', dirname(\_\_FILE\_\_)), |
  | 3320 | 3324 | null, |
  | 3321 | 3325 | WPMSEO\_VERSION |
  | 3322 | 3326 | ); |
  | 3323 | 3327 |  |
  | 3324 | 3328 | wp\_enqueue\_script( |
  | 3325 | 3329 | 'wpms-post-bulk-edit-js', |
  | 3326 | 3330 | plugins\_url('assets/js/wpms-post-bulk-edit.js', dirname(\_\_FILE\_\_)), |
  | 3327 | 3331 | array('jquery'), |
  | 3328 | 3332 | WPMSEO\_VERSION, |
  | 3329 | 3333 | true |
  | 3330 | 3334 | ); |
  | 3331 | 3335 | wp\_localize\_script('wpms-post-bulk-edit-js', 'wpms\_post\_bulk', array( |
  | 3332 | 3336 | 'title' => esc\_attr\_\_('Bulk Edit This Field', 'wp-meta-seo'), |
  | 3333 | 3337 | 'saveAll' => esc\_attr\_\_('Save all', 'wp-meta-seo'), |
  | 3334 | 3338 | 'cancelButton' => esc\_attr\_\_('Cancel all', 'wp-meta-seo'), |
  | 3335 | 3339 | 'nonce' => wp\_create\_nonce('wpms\_nonce') |
  | 3336 | 3340 | )); |
  | 3337 | 3341 | } |
  | 3338 | 3342 |  |
  | 3339 | 3343 | /\*\* |
  | 3340 | 3344 | \* Add content for title column. |
  | 3341 | 3345 | \* |
  | 3342 | 3346 | \* @param integer $post\_id The current post ID. |
  | 3343 | 3347 | \* |
  | 3344 | 3348 | \* @return void |
  | 3345 | 3349 | \*/ |
  | 3346 | 3350 | public function getColumnSeoKeywordsDetails($post\_id) |
  | 3347 | 3351 | { |
  | 3348 | 3352 | $score = get\_post\_meta($post\_id, 'wp\_metaseo\_seoscore', true); |
  | 3349 | 3353 | $keywords = get\_post\_meta($post\_id, '\_metaseo\_metaspecific\_keywords', true); |
  | 3350 | 3354 | $class = !empty($score) ? $this->getScoreClass((int)$score) : 'wpms-no-score'; |
  | 3351 | 3355 | $score = !empty($score) ? $score . ' / 100' : 'N/A'; |
  | 3352 | 3356 |  |
  | 3353 | 3357 | ?> |
  | 3354 | 3358 | <span class="wpms-column-display score <?php echo esc\_attr($class); ?> <?php echo empty($score) ? 'disabled' : ''; ?>"> |
  | 3355 | 3359 | <strong><?php echo esc\_html($score); ?></strong> |
  | 3356 | 3360 | </span> |
  | 3357 | 3361 | <span class="wpms-column-display keyword" <?php echo (empty($keywords)) ? 'style="display:none"' : ''; ?> > |
  | 3358 | 3362 | <strong title="SEO Keyword" class="title"><?php esc\_html\_e('Keyword', 'wp-meta-seo'); ?>:</strong> |
  | 3359 | 3363 | <span><?php echo $keywords ? esc\_html($keywords) : ''; ?></span> |
  | 3360 | 3364 | </span> |
  | 3361 | 3365 | <span class="wpms-column-value" data-field="seo\_keyword" contenteditable="true" tabindex="11"> |
  | 3362 | 3366 | <span><?php echo esc\_html($keywords); ?></span> |
  | 3363 | 3367 | </span> |
  | 3364 | 3368 | <div class="wpms-column-edit"> |
  | 3365 | 3369 | <a href="#" class="wpms-column-save"><?php esc\_html\_e('Save', 'wp-meta-seo'); ?></a> |
  | 3366 | 3370 | <a href="#" class="button-link-delete wpms-column-cancel"><?php esc\_html\_e('Cancel', 'wp-meta-seo'); ?></a> |
  | 3367 | 3371 | </div> |
  | 3368 | 3372 | <?php |
  | 3369 | 3373 | } |
  | 3370 | 3374 |  |
  | 3371 | 3375 | /\*\* |
  | 3372 | 3376 | \* Get SEO score rating string: great/good/bad. |
  | 3373 | 3377 | \* |
  | 3374 | 3378 | \* @param integer $score Score. |
  | 3375 | 3379 | \* |
  | 3376 | 3380 | \* @return string |
  | 3377 | 3381 | \*/ |
  | 3378 | 3382 | private function getScoreClass($score) |
  | 3379 | 3383 | { |
  | 3380 | 3384 | if ($score > 75) { |
  | 3381 | 3385 | return 'wpms-great-score'; |
  | 3382 | 3386 | } |
  | 3383 | 3387 |  |
  | 3384 | 3388 | return 'wpms-bad-score'; |
  | 3385 | 3389 | } |
  | 3386 | 3390 |  |
  | 3387 | 3391 | /\*\* |
  | 3388 | 3392 | \* Register post column hooks. |
  | 3389 | 3393 | \* |
  | 3390 | 3394 | \* @return void |
  | 3391 | 3395 | \*/ |
  | 3392 | 3396 | public function registerPostColumns() |
  | 3393 | 3397 | { |
  | 3394 | 3398 | foreach (self::getAccessiblePostTypes() as $post\_type) { |
  | 3395 | 3399 | add\_filter('edd\_download\_columns', array($this, 'addColumns'), 11); |
  | 3396 | 3400 | add\_filter('manage\_' . $post\_type . '\_posts\_columns', array($this, 'addColumns'), 11); |
  | 3397 | 3401 |  |
  | 3398 | 3402 |  |
  | 3399 | 3403 | add\_action('manage\_' . $post\_type . '\_posts\_custom\_column', array($this, 'columnsContents'), 11, 2); |
  | 3400 | 3404 | add\_filter('manage\_edit-' . $post\_type . '\_sortable\_columns', array($this, 'sortableColumns'), 11); |
  | 3401 | 3405 | } |
  | 3402 | 3406 | } |
  | 3403 | 3407 |  |
  | 3404 | 3408 | /\*\* |
  | 3405 | 3409 | \* Make the SEO Score column sortable. |
  | 3406 | 3410 | \* |
  | 3407 | 3411 | \* @param array $columns Array of column names. |
  | 3408 | 3412 | \* |
  | 3409 | 3413 | \* @return array |
  | 3410 | 3414 | \*/ |
  | 3411 | 3415 | public function sortableColumns($columns) |
  | 3412 | 3416 | { |
  | 3413 | 3417 |  |
  | 3414 | 3418 | $columns['metaseo\_seokeywords\_details\_column'] = 'wp\_metaseo\_seoscore'; |
  | 3415 | 3419 |  |
  | 3416 | 3420 | return $columns; |
  | 3417 | 3421 | } |
  | 3418 | 3422 |  |
  | 3419 | 3423 | /\*\* |
  | 3420 | 3424 | \* Add content for custom column. |
  | 3421 | 3425 | \* |
  | 3422 | 3426 | \* @param string  $column\_name The name of the column to display. |
  | 3423 | 3427 | \* @param integer $post\_id     The current post ID. |
  | 3424 | 3428 | \* |
  | 3425 | 3429 | \* @return void |
  | 3426 | 3430 | \*/ |
  | 3427 | 3431 | public function columnsContents($column\_name, $post\_id) |
  | 3428 | 3432 | { |
  | 3429 | 3433 | do\_action($column\_name, $post\_id); |
  | 3430 | 3434 | } |
  | 3431 | 3435 |  |
  | 3432 | 3436 | /\*\* |
  | 3433 | 3437 | \* Add new columns for SEO title, description and focus keywords. |
  | 3434 | 3438 | \* |
  | 3435 | 3439 | \* @param array $columns Array of column names. |
  | 3436 | 3440 | \* |
  | 3437 | 3441 | \* @return array |
  | 3438 | 3442 | \*/ |
  | 3439 | 3443 | public function addColumns($columns) |
  | 3440 | 3444 | { |
  | 3441 | 3445 | $columns['metaseo\_seokeywords\_details\_column'] = esc\_html\_\_('SEO score', 'wp-meta-seo'); |
  | 3442 | 3446 |  |
  | 3443 | 3447 | return $columns; |
  | 3444 | 3448 | } |
  | 3445 | 3449 |  |
  | 3446 | 3450 | /\*\* |
  | 3447 | 3451 | \* Get post types that are public and not set to noindex. |
  | 3448 | 3452 | \* |
  | 3449 | 3453 | \* @codeCoverageIgnore |
  | 3450 | 3454 | \* |
  | 3451 | 3455 | \* @return array All the accessible post types. |
  | 3452 | 3456 | \*/ |
  | 3453 | 3457 | public static function getAccessiblePostTypes() |
  | 3454 | 3458 | { |
  | 3455 | 3459 | static $accessible\_post\_types; |
  | 3456 | 3460 |  |
  | 3457 | 3461 | if (isset($accessible\_post\_types) && did\_action('wp\_loaded')) { |
  | 3458 | 3462 | return $accessible\_post\_types; |
  | 3459 | 3463 | } |
  | 3460 | 3464 |  |
  | 3461 | 3465 | $accessible\_post\_types = get\_post\_types(array('public' => true)); |
  | 3462 | 3466 | $accessible\_post\_types = array\_filter($accessible\_post\_types, 'is\_post\_type\_viewable'); |
  | 3463 | 3467 |  |
  | 3464 | 3468 | if (!is\_array($accessible\_post\_types)) { |
  | 3465 | 3469 | $accessible\_post\_types = array(); |
  | 3466 | 3470 | } |
  | 3467 | 3471 |  |
  | 3468 | 3472 | if (isset($accessible\_post\_types['elementor\_library'])) { |
  | 3469 | 3473 | unset($accessible\_post\_types['elementor\_library']); |
  | 3470 | 3474 | } |
  | 3471 | 3475 |  |
  | 3472 | 3476 | return $accessible\_post\_types; |
  | 3473 | 3477 | } |
  | 3474 | 3478 |  |
  | 3475 | 3479 | /\*\* |
  | 3476 | 3480 | \* Update post meta keywords |
  | 3477 | 3481 | \* |
  | 3478 | 3482 | \* @return void |
  | 3479 | 3483 | \*/ |
  | 3480 | 3484 | public function updateSeokeywordBulkEdit() |
  | 3481 | 3485 | { |
  | 3482 | 3486 | if (empty($\_POST['wpms\_nonce']) |
  | 3483 | 3487 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 3484 | 3488 | die(); |
  | 3485 | 3489 | } |
  | 3486 | 3490 |  |
  | 3487 | 3491 | if (!isset($\_POST['listData']) || empty($\_POST['listData'])) { |
  | 3488 | 3492 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  | 3489 | 3493 | wp\_die(\_\_('Unspecified list data', 'wp-meta-seo')); |
  | 3490 | 3494 | } |
  | 3491 | 3495 |  |
  | 3492 | 3496 | $result = array(); |
  | 3493 | 3497 | foreach ($\_POST['listData'] as $data) { |
  | 3494 | 3498 | if (empty($data['idpost'])) { |
  | 3495 | 3499 | continue; |
  | 3496 | 3500 | } |
  | 3497 | 3501 |  |
  | 3498 | 3502 | $circliful = $this->doAnalysisFromBulkEdit((int)$data['idpost'], $data['keyword']); |
  | 3499 | 3503 | update\_post\_meta((int)$data['idpost'], '\_metaseo\_metaspecific\_keywords', $data['keyword']); |
  | 3500 | 3504 | update\_post\_meta((int)$data['idpost'], 'wp\_metaseo\_seoscore', $circliful); |
  | 3501 | 3505 | $result[(int)$data['idpost']] = array($circliful, $data['keyword']); |
  | 3502 | 3506 | } |
  | 3503 | 3507 |  |
  | 3504 | 3508 | wp\_send\_json(array('status' => true, 'res\_back' => $result)); |
  | 3505 | 3509 | } |
  | 3506 | 3510 |  |
  | 3507 | 3511 | /\*\* |
  | 3508 | 3512 | \* Ajax load analysis from post edit |
  | 3509 | 3513 | \* |
  | 3510 | 3514 | \* @param integer $post\_id  Id post |
  | 3511 | 3515 | \* @param string  $keywords Keyword search |
  | 3512 | 3516 | \* |
  | 3513 | 3517 | \* @return mixed |
  | 3514 | 3518 | \*/ |
  | 3515 | 3519 | public function doAnalysisFromBulkEdit($post\_id, $keywords) |
  | 3516 | 3520 | { |
  | 3517 | 3521 | if (empty($\_POST['wpms\_nonce']) || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 3518 | 3522 | die(); |
  | 3519 | 3523 | } |
  | 3520 | 3524 |  |
  | 3521 | 3525 | if (!current\_user\_can('edit\_posts')) { |
  | 3522 | 3526 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  | 3523 | 3527 | wp\_die(\_\_('There is no edit permission here', 'wp-meta-seo')); |
  | 3524 | 3528 | } |
  | 3525 | 3529 |  |
  | 3526 | 3530 | $content\_post = get\_post($post\_id); |
  | 3527 | 3531 | $content = apply\_filters('the\_content', $content\_post->post\_content); |
  | 3528 | 3532 | $title = !(empty($content\_post->post\_title)) ? $content\_post->post\_title : null; |
  | 3529 | 3533 | $meta\_title = get\_post\_meta($post\_id, '\_metaseo\_metatitle', true); |
  | 3530 | 3534 | $meta\_desc = get\_post\_meta($post\_id, '\_metaseo\_metadesc', true); |
  | 3531 | 3535 | $check = 0; |
  | 3532 | 3536 |  |
  | 3533 | 3537 | // title heading |
  | 3534 | 3538 | $words\_post\_title = preg\_split( |
  | 3535 | 3539 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3536 | 3540 | strtolower($title), |
  | 3537 | 3541 | -1, |
  | 3538 | 3542 | PREG\_SPLIT\_NO\_EMPTY |
  | 3539 | 3543 | ); |
  | 3540 | 3544 |  |
  | 3541 | 3545 | // do shortcode js\_composer plugin |
  | 3542 | 3546 | if (is\_plugin\_active('js\_composer\_theme/js\_composer.php')) { |
  | 3543 | 3547 | add\_shortcode('mk\_fancy\_title', 'vc\_do\_shortcode'); |
  | 3544 | 3548 | } |
  | 3545 | 3549 |  |
  | 3546 | 3550 | $content = apply\_filters('wpms\_the\_content', '<div>' . html\_entity\_decode(stripcslashes($content), ENT\_COMPAT, 'UTF-8') . '</div>', $post\_id); |
  | 3547 | 3551 | $content = $this->injectAcfField($content, $post\_id); |
  | 3548 | 3552 | $content = $this->injectWooCommerce($content, $post\_id); |
  | 3549 | 3553 |  |
  | 3550 | 3554 | if ($content !== '') { |
  | 3551 | 3555 | // Extracting the specified elements from the web page |
  | 3552 | 3556 | $tags\_h1 = wpmsExtractTags($content, 'h1', false, true); |
  | 3553 | 3557 | $tags\_h2 = wpmsExtractTags($content, 'h2', false, true); |
  | 3554 | 3558 | $tags\_h3 = wpmsExtractTags($content, 'h3', false, true); |
  | 3555 | 3559 | $tags\_h4 = wpmsExtractTags($content, 'h4', false, true); |
  | 3556 | 3560 | $tags\_h5 = wpmsExtractTags($content, 'h5', false, true); |
  | 3557 | 3561 | $tags\_h6 = wpmsExtractTags($content, 'h6', false, true); |
  | 3558 | 3562 |  |
  | 3559 | 3563 | $test = false; |
  | 3560 | 3564 | if (empty($tags\_h1) && empty($tags\_h2) && empty($tags\_h3) |
  | 3561 | 3565 | && empty($tags\_h4) && empty($tags\_h5) && empty($tags\_h6)) { |
  | 3562 | 3566 | $test = false; |
  | 3563 | 3567 | } else { |
  | 3564 | 3568 | // check tag h1 |
  | 3565 | 3569 | if (!empty($tags\_h1)) { |
  | 3566 | 3570 | foreach ($tags\_h1 as $order => $tagh1) { |
  | 3567 | 3571 | $words\_tagh1 = preg\_split( |
  | 3568 | 3572 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3569 | 3573 | utf8\_decode(strtolower($tagh1['contents'])), |
  | 3570 | 3574 | -1, |
  | 3571 | 3575 | PREG\_SPLIT\_NO\_EMPTY |
  | 3572 | 3576 | ); |
  | 3573 | 3577 |  |
  | 3574 | 3578 | if (is\_array($words\_tagh1) && is\_array($words\_post\_title)) { |
  | 3575 | 3579 | foreach ($words\_tagh1 as $mh) { |
  | 3576 | 3580 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 3577 | 3581 | $test = true; |
  | 3578 | 3582 | } |
  | 3579 | 3583 | } |
  | 3580 | 3584 | } |
  | 3581 | 3585 | } |
  | 3582 | 3586 | } |
  | 3583 | 3587 |  |
  | 3584 | 3588 | // check tag h2 |
  | 3585 | 3589 | if (!empty($tags\_h2)) { |
  | 3586 | 3590 | foreach ($tags\_h2 as $order => $tagh2) { |
  | 3587 | 3591 | $words\_tagh2 = preg\_split( |
  | 3588 | 3592 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3589 | 3593 | utf8\_decode(strtolower($tagh2['contents'])), |
  | 3590 | 3594 | -1, |
  | 3591 | 3595 | PREG\_SPLIT\_NO\_EMPTY |
  | 3592 | 3596 | ); |
  | 3593 | 3597 | if (is\_array($words\_tagh2) && is\_array($words\_post\_title)) { |
  | 3594 | 3598 | foreach ($words\_tagh2 as $mh) { |
  | 3595 | 3599 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 3596 | 3600 | $test = true; |
  | 3597 | 3601 | } |
  | 3598 | 3602 | } |
  | 3599 | 3603 | } |
  | 3600 | 3604 | } |
  | 3601 | 3605 | } |
  | 3602 | 3606 |  |
  | 3603 | 3607 | // check tag h3 |
  | 3604 | 3608 | if (!empty($tags\_h3)) { |
  | 3605 | 3609 | foreach ($tags\_h3 as $order => $tagh3) { |
  | 3606 | 3610 | $words\_tagh3 = preg\_split( |
  | 3607 | 3611 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3608 | 3612 | utf8\_decode(strtolower($tagh3['contents'])), |
  | 3609 | 3613 | -1, |
  | 3610 | 3614 | PREG\_SPLIT\_NO\_EMPTY |
  | 3611 | 3615 | ); |
  | 3612 | 3616 | if (is\_array($words\_tagh3) && is\_array($words\_post\_title)) { |
  | 3613 | 3617 | foreach ($words\_tagh3 as $mh) { |
  | 3614 | 3618 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 3615 | 3619 | $test = true; |
  | 3616 | 3620 | } |
  | 3617 | 3621 | } |
  | 3618 | 3622 | } |
  | 3619 | 3623 | } |
  | 3620 | 3624 | } |
  | 3621 | 3625 |  |
  | 3622 | 3626 | // check tag h4 |
  | 3623 | 3627 | if (!empty($tags\_h4)) { |
  | 3624 | 3628 | foreach ($tags\_h4 as $order => $tagh4) { |
  | 3625 | 3629 | $words\_tagh4 = preg\_split( |
  | 3626 | 3630 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3627 | 3631 | utf8\_decode(strtolower($tagh4['contents'])), |
  | 3628 | 3632 | -1, |
  | 3629 | 3633 | PREG\_SPLIT\_NO\_EMPTY |
  | 3630 | 3634 | ); |
  | 3631 | 3635 | if (is\_array($words\_tagh4) && is\_array($words\_post\_title)) { |
  | 3632 | 3636 | foreach ($words\_tagh4 as $mh) { |
  | 3633 | 3637 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 3634 | 3638 | $test = true; |
  | 3635 | 3639 | } |
  | 3636 | 3640 | } |
  | 3637 | 3641 | } |
  | 3638 | 3642 | } |
  | 3639 | 3643 | } |
  | 3640 | 3644 |  |
  | 3641 | 3645 | // check tag h5 |
  | 3642 | 3646 | if (!empty($tags\_h5)) { |
  | 3643 | 3647 | foreach ($tags\_h5 as $order => $tagh5) { |
  | 3644 | 3648 | $words\_tagh5 = preg\_split( |
  | 3645 | 3649 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3646 | 3650 | utf8\_decode(strtolower($tagh5['contents'])), |
  | 3647 | 3651 | -1, |
  | 3648 | 3652 | PREG\_SPLIT\_NO\_EMPTY |
  | 3649 | 3653 | ); |
  | 3650 | 3654 | if (is\_array($words\_tagh5) && is\_array($words\_post\_title)) { |
  | 3651 | 3655 | foreach ($words\_tagh5 as $mh) { |
  | 3652 | 3656 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 3653 | 3657 | $test = true; |
  | 3654 | 3658 | } |
  | 3655 | 3659 | } |
  | 3656 | 3660 | } |
  | 3657 | 3661 | } |
  | 3658 | 3662 | } |
  | 3659 | 3663 |  |
  | 3660 | 3664 | // check tag h6 |
  | 3661 | 3665 | if (!empty($tags\_h6)) { |
  | 3662 | 3666 | foreach ($tags\_h6 as $order => $tagh6) { |
  | 3663 | 3667 | $words\_tagh6 = preg\_split( |
  | 3664 | 3668 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3665 | 3669 | utf8\_decode(strtolower($tagh6['contents'])), |
  | 3666 | 3670 | -1, |
  | 3667 | 3671 | PREG\_SPLIT\_NO\_EMPTY |
  | 3668 | 3672 | ); |
  | 3669 | 3673 | if (is\_array($words\_tagh6) && is\_array($words\_post\_title)) { |
  | 3670 | 3674 | foreach ($words\_tagh6 as $mh) { |
  | 3671 | 3675 | if (in\_array($mh, $words\_post\_title) && $mh !== '') { |
  | 3672 | 3676 | $test = true; |
  | 3673 | 3677 | } |
  | 3674 | 3678 | } |
  | 3675 | 3679 | } |
  | 3676 | 3680 | } |
  | 3677 | 3681 | } |
  | 3678 | 3682 | } |
  | 3679 | 3683 |  |
  | 3680 | 3684 | if ($test) { |
  | 3681 | 3685 | $check++; |
  | 3682 | 3686 | } |
  | 3683 | 3687 | } |
  | 3684 | 3688 |  |
  | 3685 | 3689 | // title content |
  | 3686 | 3690 | $words\_title = preg\_split( |
  | 3687 | 3691 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3688 | 3692 | strtolower($title), |
  | 3689 | 3693 | -1, |
  | 3690 | 3694 | PREG\_SPLIT\_NO\_EMPTY |
  | 3691 | 3695 | ); |
  | 3692 | 3696 | $words\_post\_content = preg\_split( |
  | 3693 | 3697 | '/((^\p{P}+)|(\p{P}\*\s+\p{P}\*)|(\p{P}+$))/', |
  | 3694 | 3698 | strtolower(strip\_tags($content)), |
  | 3695 | 3699 | -1, |
  | 3696 | 3700 | PREG\_SPLIT\_NO\_EMPTY |
  | 3697 | 3701 | ); |
  | 3698 | 3702 |  |
  | 3699 | 3703 | $test1 = false; |
  | 3700 | 3704 | if (is\_array($words\_title) && is\_array($words\_post\_content)) { |
  | 3701 | 3705 | foreach ($words\_title as $mtitle) { |
  | 3702 | 3706 | if (in\_array($mtitle, $words\_post\_content) && $mtitle !== '') { |
  | 3703 | 3707 | $test1 = true; |
  | 3704 | 3708 | break; |
  | 3705 | 3709 | } |
  | 3706 | 3710 | } |
  | 3707 | 3711 | } else { |
  | 3708 | 3712 | $test1 = false; |
  | 3709 | 3713 | } |
  | 3710 | 3714 |  |
  | 3711 | 3715 | if ($test1) { |
  | 3712 | 3716 | $check++; |
  | 3713 | 3717 | } |
  | 3714 | 3718 |  |
  | 3715 | 3719 | // page url matches page title |
  | 3716 | 3720 | $mtitle = $title; |
  | 3717 | 3721 | $pageurl = pathinfo(get\_permalink($post\_id)); |
  | 3718 | 3722 | $mpageurl = $pageurl['filename']; |
  | 3719 | 3723 |  |
  | 3720 | 3724 | if (!empty($mpageurl) && !empty($mtitle) && $mpageurl === sanitize\_title($mtitle)) { |
  | 3721 | 3725 | $check++; |
  | 3722 | 3726 | } |
  | 3723 | 3727 |  |
  | 3724 | 3728 | // meta title filled |
  | 3725 | 3729 | if (($meta\_title !== '' && mb\_strlen($meta\_title, 'UTF-8') <= self::$title\_length)) { |
  | 3726 | 3730 | $check++; |
  | 3727 | 3731 | } |
  | 3728 | 3732 |  |
  | 3729 | 3733 | // desc filled |
  | 3730 | 3734 | if ($meta\_desc !== '' && mb\_strlen($meta\_desc, 'UTF-8') <= self::$desc\_length) { |
  | 3731 | 3735 | $check++; |
  | 3732 | 3736 | } |
  | 3733 | 3737 |  |
  | 3734 | 3738 | // image resize |
  | 3735 | 3739 | if ($content === '') { |
  | 3736 | 3740 | $check += 2; |
  | 3737 | 3741 | } else { |
  | 3738 | 3742 | // Extracting the specified elements from the web page |
  | 3739 | 3743 | $img\_tags = wpmsExtractTags($content, 'img', true, true); |
  | 3740 | 3744 | $img\_wrong = false; |
  | 3741 | 3745 | $img\_wrong\_alt = false; |
  | 3742 | 3746 | foreach ($img\_tags as $order => $tag) { |
  | 3743 | 3747 | if (!isset($tag['attributes']['src'])) { |
  | 3744 | 3748 | continue; |
  | 3745 | 3749 | } |
  | 3746 | 3750 |  |
  | 3747 | 3751 | $src = $tag['attributes']['src']; |
  | 3748 | 3752 | $imgpath = str\_replace(site\_url(), ABSPATH, $src); |
  | 3749 | 3753 | if (!file\_exists($imgpath)) { |
  | 3750 | 3754 | continue; |
  | 3751 | 3755 | } |
  | 3752 | 3756 | if (!list($width\_origin, $height\_origin) = getimagesize($imgpath)) { |
  | 3753 | 3757 | continue; |
  | 3754 | 3758 | } |
  | 3755 | 3759 |  |
  | 3756 | 3760 | if (empty($tag['attributes']['width']) && empty($tag['attributes']['height'])) { |
  | 3757 | 3761 | $img\_wrong = false; |
  | 3758 | 3762 | } else { |
  | 3759 | 3763 | if (!empty($width\_origin) && !empty($height\_origin)) { |
  | 3760 | 3764 | if ((isset($tag['attributes']['width']) && (int)$width\_origin !== (int)$tag['attributes']['width']) |
  | 3761 | 3765 | || (isset($tag['attributes']['height']) && (int)$height\_origin !== (int)$tag['attributes']['height'])) { |
  | 3762 | 3766 | $img\_wrong = true; |
  | 3763 | 3767 | } |
  | 3764 | 3768 | } |
  | 3765 | 3769 | } |
  | 3766 | 3770 |  |
  | 3767 | 3771 | if (empty($tag['attributes']['alt'])) { |
  | 3768 | 3772 | $img\_wrong\_alt = true; |
  | 3769 | 3773 | } |
  | 3770 | 3774 | } |
  | 3771 | 3775 |  |
  | 3772 | 3776 | if (!$img\_wrong) { |
  | 3773 | 3777 | $check++; |
  | 3774 | 3778 | } |
  | 3775 | 3779 |  |
  | 3776 | 3780 |  |
  | 3777 | 3781 | if (!$img\_wrong\_alt) { |
  | 3778 | 3782 | $check++; |
  | 3779 | 3783 | } |
  | 3780 | 3784 | } |
  | 3781 | 3785 |  |
  | 3782 | 3786 | $total\_check = 7; |
  | 3783 | 3787 | if (!empty($keywords)) { |
  | 3784 | 3788 | $total\_check++; |
  | 3785 | 3789 |  |
  | 3786 | 3790 | $listkeywords = array\_map('trim', explode(',', strtolower($keywords))); |
  | 3787 | 3791 |  |
  | 3788 | 3792 | foreach ($listkeywords as $key) { |
  | 3789 | 3793 | if (strpos(strtolower($title), $key) !== false) { |
  | 3790 | 3794 | $check++; |
  | 3791 | 3795 | break; |
  | 3792 | 3796 | } |
  | 3793 | 3797 |  |
  | 3794 | 3798 | if (strpos(strtolower($content), $key) !== false) { |
  | 3795 | 3799 | $check++; |
  | 3796 | 3800 | break; |
  | 3797 | 3801 | } |
  | 3798 | 3802 |  |
  | 3799 | 3803 | if (strpos(strtolower($meta\_title), $key) !== false) { |
  | 3800 | 3804 | $check++; |
  | 3801 | 3805 | break; |
  | 3802 | 3806 | } |
  | 3803 | 3807 |  |
  | 3804 | 3808 | if (strpos(strtolower($meta\_desc), $key) !== false) { |
  | 3805 | 3809 | $check++; |
  | 3806 | 3810 | break; |
  | 3807 | 3811 | } |
  | 3808 | 3812 |  |
  | 3809 | 3813 | $pattern = '/<h[2-6][^>]\*>.\*' . $key . '.\*<\/h[2-6]>/'; |
  | 3810 | 3814 | if (preg\_match($pattern, $content)) { |
  | 3811 | 3815 | $check++; |
  | 3812 | 3816 | break; |
  | 3813 | 3817 | } |
  | 3814 | 3818 | } |
  | 3815 | 3819 | } |
  | 3816 | 3820 |  |
  | 3817 | 3821 | $circliful = ceil(100 \* ($check) / $total\_check); |
  | 3818 | 3822 |  |
  | 3819 | 3823 | return $circliful; |
  | 3820 | 3824 | } |
  | 3821 | 3825 |  |
  | 3822 | 3826 | /\*\* |
  | 3823 | 3827 | \* Localize a script. |
  | 3824 | 3828 | \* |
  | 3825 | 3829 | \* Works only if the script has already been added. |
  | 3826 | 3830 | \* |
  | 3827 | 3831 | \* @return array |
  | 3828 | 3832 | \*/ |
  | 3829 | 3833 | public function localizeScript() |
  | 3830 | 3834 | { |
  | 3831 | 3835 | return array( |
  | 3832 | 3836 | 'metaseo\_message\_false\_copy' => esc\_html\_\_('Warning, you\'re about to replace existing image |
  | 3833 | 3837 | alt or tile content, are you sire about that?', 'wp-meta-seo'), |
  | 3834 | 3838 | ); |
  | 3835 | 3839 | } |
  | 3836 | 3840 |  |
  | 3837 | 3841 | /\*\* |
  | 3838 | 3842 | \* Add a top-level menu page. |
  | 3839 | 3843 | \* |
  | 3840 | 3844 | \* This function takes a capability which will be used to determine whether |
  | 3841 | 3845 | \* or not a page is included in the menu. |
  | 3842 | 3846 | \* |
  | 3843 | 3847 | \* @return void |
  | 3844 | 3848 | \*/ |
  | 3845 | 3849 | public function addMenuPage() |
  | 3846 | 3850 | { |
  | 3847 | 3851 | // Add main page |
  | 3848 | 3852 | add\_menu\_page( |
  | 3849 | 3853 | esc\_html\_\_('WP Meta SEO: Dashboard', 'wp-meta-seo'), |
  | 3850 | 3854 | esc\_html\_\_('WP Meta SEO', 'wp-meta-seo'), |
  | 3851 | 3855 | 'manage\_options', |
  | 3852 | 3856 | 'metaseo\_dashboard', |
  | 3853 | 3857 | array( |
  | 3854 | 3858 | $this, |
  | 3855 | 3859 | 'loadPage' |
  | 3856 | 3860 | ), |
  | 3857 | 3861 | 'dashicons-chart-area' |
  | 3858 | 3862 | ); |
  | 3859 | 3863 |  |
  | 3860 | 3864 | /\*\* |
  | 3861 | 3865 | \* Allow changing the capability users need to view the settings pages |
  | 3862 | 3866 | \* |
  | 3863 | 3867 | \* @return string |
  | 3864 | 3868 | \* @api    string Default capability |
  | 3865 | 3869 | \*/ |
  | 3866 | 3870 | $manage\_options\_cap = apply\_filters('metaseo\_manage\_options\_capability', 'manage\_options'); |
  | 3867 | 3871 |  |
  | 3868 | 3872 | // Sub menu pages |
  | 3869 | 3873 | $submenu\_pages = array( |
  | 3870 | 3874 | array( |
  | 3871 | 3875 | 'metaseo\_dashboard', |
  | 3872 | 3876 | '', |
  | 3873 | 3877 | esc\_html\_\_('Dashboard', 'wp-meta-seo'), |
  | 3874 | 3878 | $manage\_options\_cap, |
  | 3875 | 3879 | 'metaseo\_dashboard', |
  | 3876 | 3880 | array($this, 'loadPage'), |
  | 3877 | 3881 | null |
  | 3878 | 3882 | ), |
  | 3879 | 3883 | array( |
  | 3880 | 3884 | 'metaseo\_dashboard', |
  | 3881 | 3885 | '', |
  | 3882 | 3886 | esc\_html\_\_('Content meta', 'wp-meta-seo'), |
  | 3883 | 3887 | $manage\_options\_cap, |
  | 3884 | 3888 | 'metaseo\_content\_meta', |
  | 3885 | 3889 | array($this, 'loadPage'), |
  | 3886 | 3890 | null |
  | 3887 | 3891 | ), |
  | 3888 | 3892 | array( |
  | 3889 | 3893 | 'metaseo\_dashboard', |
  | 3890 | 3894 | '', |
  | 3891 | 3895 | esc\_html\_\_('Category meta', 'wp-meta-seo'), |
  | 3892 | 3896 | $manage\_options\_cap, |
  | 3893 | 3897 | 'metaseo\_category\_meta', |
  | 3894 | 3898 | array($this, 'loadPage'), |
  | 3895 | 3899 | null |
  | 3896 | 3900 | ), |
  | 3897 | 3901 | array( |
  | 3898 | 3902 | 'metaseo\_dashboard', |
  | 3899 | 3903 | '', |
  | 3900 | 3904 | esc\_html\_\_('Image editor', 'wp-meta-seo'), |
  | 3901 | 3905 | $manage\_options\_cap, |
  | 3902 | 3906 | 'metaseo\_image\_meta', |
  | 3903 | 3907 | array($this, 'loadPage'), |
  | 3904 | 3908 | null |
  | 3905 | 3909 | ), |
  | 3906 | 3910 | array( |
  | 3907 | 3911 | 'metaseo\_dashboard', |
  | 3908 | 3912 | '', |
  | 3909 | 3913 | esc\_html\_\_('Sitemap', 'wp-meta-seo'), |
  | 3910 | 3914 | $manage\_options\_cap, |
  | 3911 | 3915 | 'metaseo\_google\_sitemap', |
  | 3912 | 3916 | array($this, 'loadPage'), |
  | 3913 | 3917 | null, |
  | 3914 | 3918 | ), |
  | 3915 | 3919 | array( |
  | 3916 | 3920 | 'metaseo\_dashboard', |
  | 3917 | 3921 | '', |
  | 3918 | 3922 | esc\_html\_\_('Link editor', 'wp-meta-seo'), |
  | 3919 | 3923 | $manage\_options\_cap, |
  | 3920 | 3924 | 'metaseo\_link\_meta', |
  | 3921 | 3925 | array($this, 'loadPage'), |
  | 3922 | 3926 | null |
  | 3923 | 3927 | ), |
  | 3924 | 3928 | array( |
  | 3925 | 3929 | 'metaseo\_dashboard', |
  | 3926 | 3930 | '', |
  | 3927 | 3931 | esc\_html\_\_('404 & Redirects', 'wp-meta-seo'), |
  | 3928 | 3932 | $manage\_options\_cap, |
  | 3929 | 3933 | 'metaseo\_broken\_link', |
  | 3930 | 3934 | array($this, 'loadPage'), |
  | 3931 | 3935 | null |
  | 3932 | 3936 | ), |
  | 3933 | 3937 | array( |
  | 3934 | 3938 | 'metaseo\_dashboard', |
  | 3935 | 3939 | '', |
  | 3936 | 3940 | esc\_html\_\_('Google Analytics', 'wp-meta-seo'), |
  | 3937 | 3941 | $manage\_options\_cap, |
  | 3938 | 3942 | 'metaseo\_google\_analytics', |
  | 3939 | 3943 | array($this, 'loadPage'), |
  | 3940 | 3944 | null |
  | 3941 | 3945 | ) |
  | 3942 | 3946 | ); |
  | 3943 | 3947 |  |
  | 3944 | 3948 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 3945 | 3949 | global $metaseo\_addon; |
  | 3946 | 3950 | $submenu\_pages[] = array( |
  | 3947 | 3951 | 'metaseo\_dashboard', |
  | 3948 | 3952 | esc\_html\_\_('WP Meta SEO Send email', 'wp-meta-seo'), |
  | 3949 | 3953 | esc\_html\_\_('Email report', 'wp-meta-seo'), |
  | 3950 | 3954 | $manage\_options\_cap, |
  | 3951 | 3955 | 'metaseo\_sendemail', |
  | 3952 | 3956 | array($metaseo\_addon, 'loadPageSendEmail'), |
  | 3953 | 3957 | null |
  | 3954 | 3958 | ); |
  | 3955 | 3959 |  |
  | 3956 | 3960 | // REMOVE SEARCH CONSOLE TAB, WAIT NEW API FROM GOOGLE GUYS |
  | 3957 | 3961 | // |
  | 3958 | 3962 | // |
  | 3959 | 3963 | // |
  | 3960 | 3964 | //            $submenu\_pages[] = array( |
  | 3961 | 3965 | //                'metaseo\_dashboard', |
  | 3962 | 3966 | //                esc\_html\_\_('Search Console', 'wp-meta-seo'), |
  | 3963 | 3967 | //                esc\_html\_\_('Search Console', 'wp-meta-seo'), |
  | 3964 | 3968 | //                $manage\_options\_cap, |
  | 3965 | 3969 | //                'metaseo\_console', |
  | 3966 | 3970 | //                array($metaseo\_addon->admin\_features['metaseo\_gsc'], 'display'), |
  | 3967 | 3971 | //                null |
  | 3968 | 3972 | //            ); |
  | 3969 | 3973 | } |
  | 3970 | 3974 |  |
  | 3971 | 3975 | $submenu\_pages[] = array( |
  | 3972 | 3976 | 'metaseo\_dashboard', |
  | 3973 | 3977 | '', |
  | 3974 | 3978 | esc\_html\_\_('Settings', 'wp-meta-seo'), |
  | 3975 | 3979 | $manage\_options\_cap, |
  | 3976 | 3980 | 'metaseo\_settings', |
  | 3977 | 3981 | array($this, 'loadPage'), |
  | 3978 | 3982 | null |
  | 3979 | 3983 | ); |
  | 3980 | 3984 |  |
  | 3981 | 3985 | if (!is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 3982 | 3986 | $submenu\_pages[] = array( |
  | 3983 | 3987 | 'metaseo\_dashboard', |
  | 3984 | 3988 | '', |
  | 3985 | 3989 | '<span style="color:orange">' . esc\_html\_\_('Better SEO ranking', 'wp-meta-seo') . '</span>', |
  | 3986 | 3990 | $manage\_options\_cap, |
  | 3987 | 3991 | 'metaseo\_better\_ranking', |
  | 3988 | 3992 | array($this, 'loadPage'), |
  | 3989 | 3993 | null |
  | 3990 | 3994 | ); |
  | 3991 | 3995 | } |
  | 3992 | 3996 |  |
  | 3993 | 3997 | // Allow submenu pages manipulation |
  | 3994 | 3998 | $submenu\_pages = apply\_filters('metaseo\_submenu\_pages', $submenu\_pages); |
  | 3995 | 3999 |  |
  | 3996 | 4000 | // Loop through submenu pages and add them |
  | 3997 | 4001 | if (count($submenu\_pages)) { |
  | 3998 | 4002 | foreach ($submenu\_pages as $submenu\_page) { |
  | 3999 | 4003 | // Add submenu page |
  | 4000 | 4004 | $admin\_page = add\_submenu\_page( |
  | 4001 | 4005 | $submenu\_page[0], |
  | 4002 | 4006 | $submenu\_page[2] . ' - ' . esc\_html\_\_('WP Meta SEO:', 'wp-meta-seo'), |
  | 4003 | 4007 | $submenu\_page[2], |
  | 4004 | 4008 | $submenu\_page[3], |
  | 4005 | 4009 | $submenu\_page[4], |
  | 4006 | 4010 | $submenu\_page[5] |
  | 4007 | 4011 | ); |
  | 4008 | 4012 |  |
  | 4009 | 4013 | // Check if we need to hook |
  | 4010 | 4014 | if (isset($submenu\_page[6]) && null !== $submenu\_page[6] |
  | 4011 | 4015 | && is\_array($submenu\_page[6]) && count($submenu\_page[6]) > 0) { |
  | 4012 | 4016 | foreach ($submenu\_page[6] as $submenu\_page\_action) { |
  | 4013 | 4017 | add\_action('load-' . $admin\_page, $submenu\_page\_action); |
  | 4014 | 4018 | } |
  | 4015 | 4019 | } |
  | 4016 | 4020 | } |
  | 4017 | 4021 | } |
  | 4018 | 4022 | } |
  | 4019 | 4023 |  |
  | 4020 | 4024 | /\*\* |
  | 4021 | 4025 | \* Set error time out |
  | 4022 | 4026 | \* |
  | 4023 | 4027 | \* @return void |
  | 4024 | 4028 | \*/ |
  | 4025 | 4029 | public function setErrorTimeout() |
  | 4026 | 4030 | { |
  | 4027 | 4031 | $midnight = strtotime('tomorrow 00:00:00'); // UTC midnight |
  | 4028 | 4032 | $midnight = $midnight + 8 \* 3600; // UTC 8 AM |
  | 4029 | 4033 | $this->error\_timeout = $midnight - time(); |
  | 4030 | 4034 | } |
  | 4031 | 4035 |  |
  | 4032 | 4036 | /\*\* |
  | 4033 | 4037 | \* Load the form for a WPSEO admin page |
  | 4034 | 4038 | \* |
  | 4035 | 4039 | \* @return void |
  | 4036 | 4040 | \*/ |
  | 4037 | 4041 | public function loadPage() |
  | 4038 | 4042 | { |
  | 4039 | 4043 | if (isset($\_GET['page'])) { |
  | 4040 | 4044 | // phpcs:ignore WordPress.Security.NonceVerification.Recommended -- No action, nonce is not required |
  | 4041 | 4045 | switch ($\_GET['page']) { |
  | 4042 | 4046 | case 'metaseo\_google\_analytics': |
  | 4043 | 4047 | $this->google\_alanytics = get\_option('wpms\_google\_alanytics'); |
  | 4044 | 4048 | if (isset($this->google\_alanytics['setting\_success']) && $this->google\_alanytics['setting\_success'] === 1) { |
  | 4045 | 4049 | echo '<div id="setting-error-settings\_updated" |
  | 4046 | 4050 | class="updated settings-error notice is-dismissible"> |
  | 4047 | 4051 | <p><strong>' . esc\_html\_\_('Settings saved.', 'wp-meta-seo') . '</strong></p><button type="button" class="notice-dismiss"> |
  | 4048 | 4052 | <span class="screen-reader-text">Dismiss this notice.</span></button></div>'; |
  | 4049 | 4053 | $this->google\_alanytics['setting\_success'] = 0; |
  | 4050 | 4054 | update\_option('wpms\_google\_alanytics', $this->google\_alanytics); |
  | 4051 | 4055 | } |
  | 4052 | 4056 | if (isset($\_POST['\_metaseo\_ggtracking\_settings'])) { |
  | 4053 | 4057 | if (empty($\_POST['gadash\_security']) |
  | 4054 | 4058 | || !wp\_verify\_nonce($\_POST['gadash\_security'], 'gadash\_form')) { |
  | 4055 | 4059 | die(); |
  | 4056 | 4060 | } |
  | 4057 | 4061 | update\_option('\_metaseo\_ggtracking\_settings', $\_POST['\_metaseo\_ggtracking\_settings']); |
  | 4058 | 4062 | echo '<div id="setting-error-settings\_updated" |
  | 4059 | 4063 | class="updated settings-error notice is-dismissible"> |
  | 4060 | 4064 | <p><strong>' . esc\_html\_\_('Settings saved.', 'wp-meta-seo') . '</strong></p><button type="button" class="notice-dismiss"> |
  | 4061 | 4065 | <span class="screen-reader-text">Dismiss this notice.</span></button></div>'; |
  | 4062 | 4066 | } |
  | 4063 | 4067 |  |
  | 4064 | 4068 | // Update selected profile |
  | 4065 | 4069 | if (!empty($\_POST['tableid\_jail'])) { |
  | 4066 | 4070 | if (empty($\_POST['wpms\_nonce']) |
  | 4067 | 4071 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4068 | 4072 | die(); |
  | 4069 | 4073 | } |
  | 4070 | 4074 | if ($this->google\_alanytics['tableid\_jail'] !== $\_POST['tableid\_jail']) { |
  | 4071 | 4075 | $this->google\_alanytics['tableid\_jail'] = $\_POST['tableid\_jail']; |
  | 4072 | 4076 | $this->google\_alanytics['setting\_success'] = 1; |
  | 4073 | 4077 | update\_option('wpms\_google\_alanytics', $this->google\_alanytics); |
  | 4074 | 4078 | wp\_redirect($\_SERVER['HTTP\_REFERER']); |
  | 4075 | 4079 | } |
  | 4076 | 4080 | } |
  | 4077 | 4081 |  |
  | 4078 | 4082 | $ga\_tracking = get\_option('\_metaseo\_ggtracking\_settings'); |
  | 4079 | 4083 | if (is\_array($ga\_tracking)) { |
  | 4080 | 4084 | $this->ga\_tracking = array\_merge($this->ga\_tracking, $ga\_tracking); |
  | 4081 | 4085 | } |
  | 4082 | 4086 | include\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/google\_analytics/wpmstools.php'); |
  | 4083 | 4087 | include\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/google\_analytics/wpmsgapi.php'); |
  | 4084 | 4088 | wp\_enqueue\_style('wpms-tippy-style'); |
  | 4085 | 4089 | wp\_enqueue\_script('wpms-tippy-core'); |
  | 4086 | 4090 | wp\_enqueue\_script('wpms-tippy'); |
  | 4087 | 4091 | // Enqueue snackbar |
  | 4088 | 4092 | wp\_enqueue\_style('wpms-snackbar-style'); |
  | 4089 | 4093 | wp\_enqueue\_script('wpms-snackbar-script'); |
  | 4090 | 4094 |  |
  | 4091 | 4095 | // WPMS Google Analytics Data |
  | 4092 | 4096 | if (isset($\_GET['view']) && $\_GET['view'] === 'wpms\_gg\_service\_data') { |
  | 4093 | 4097 | wp\_enqueue\_style('wpms-backend-tracking-code'); |
  | 4094 | 4098 | wp\_enqueue\_style('wpms-backend-item-reports'); |
  | 4095 | 4099 |  |
  | 4096 | 4100 | // When user save access code |
  | 4097 | 4101 | if (isset($\_POST['wpmsga\_dash\_clientid']) && isset($\_POST['wpmsga\_dash\_clientsecret'])) { |
  | 4098 | 4102 | // Check nonce field |
  | 4099 | 4103 | if (empty($\_POST['wpms\_nonce']) |
  | 4100 | 4104 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4101 | 4105 | die(); |
  | 4102 | 4106 | } |
  | 4103 | 4107 | $this->google\_alanytics['wpmsga\_dash\_clientid'] = $\_POST['wpmsga\_dash\_clientid']; |
  | 4104 | 4108 | $this->google\_alanytics['wpmsga\_dash\_clientsecret'] = $\_POST['wpmsga\_dash\_clientsecret']; |
  | 4105 | 4109 | update\_option('wpms\_google\_alanytics', $this->google\_alanytics); |
  | 4106 | 4110 | } |
  | 4107 | 4111 |  |
  | 4108 | 4112 | require\_once WPMETASEO\_PLUGIN\_DIR . 'inc/google\_analytics/wpmstools.php'; |
  | 4109 | 4113 | if (!empty($this->google\_alanytics['wpmsga\_dash\_clientid']) && !empty($this->google\_alanytics['wpmsga\_dash\_clientsecret'])) { |
  | 4110 | 4114 | $this->client = WpmsGaTools::initClient($this->google\_alanytics['wpmsga\_dash\_clientid'], $this->google\_alanytics['wpmsga\_dash\_clientsecret']); |
  | 4111 | 4115 | $controller = new WpmsGapiController(); |
  | 4112 | 4116 | $this->service = new \WPMSGoogle\Service\Analytics($this->client); |
  | 4113 | 4117 | } |
  | 4114 | 4118 |  |
  | 4115 | 4119 | $this->setErrorTimeout(); |
  | 4116 | 4120 |  |
  | 4117 | 4121 | if (!empty($\_POST['wpms\_gg\_access\_code'])) { |
  | 4118 | 4122 | $wpms\_gg\_access\_code = $\_POST['wpms\_gg\_access\_code']; |
  | 4119 | 4123 | if (!stripos('x' . $wpms\_gg\_access\_code, 'UA-', 1)) { |
  | 4120 | 4124 | WpmsGaTools::deleteCache('gapi\_errors'); |
  | 4121 | 4125 | WpmsGaTools::deleteCache('last\_error'); |
  | 4122 | 4126 | WpmsGaTools::clearCache(); |
  | 4123 | 4127 | try { |
  | 4124 | 4128 | $this->client->authenticate($wpms\_gg\_access\_code); |
  | 4125 | 4129 | $getAccessToken = $this->client->getAccessToken(); |
  | 4126 | 4130 | if ($getAccessToken) { |
  | 4127 | 4131 | try { |
  | 4128 | 4132 | $this->client->setAccessToken($getAccessToken); |
  | 4129 | 4133 | $this->google\_alanytics['googleCredentials'] |
  | 4130 | 4134 | = $this->client->getAccessToken(); |
  | 4131 | 4135 | } catch (WPMSGoogle\Service\Exception $e) { |
  | 4132 | 4136 | WpmsGaTools::setCache( |
  | 4133 | 4137 | 'wpmsga\_dash\_lasterror', |
  | 4134 | 4138 | date('Y-m-d H:i:s') . ': ' . esc\_html('(' . $e->getCode() . ') ' . $e->getMessage()), |
  | 4135 | 4139 | $this->error\_timeout |
  | 4136 | 4140 | ); |
  | 4137 | 4141 | WpmsGaTools::setCache( |
  | 4138 | 4142 | 'wpmsga\_dash\_gapi\_errors', |
  | 4139 | 4143 | $e->getCode(), |
  | 4140 | 4144 | $this->error\_timeout |
  | 4141 | 4145 | ); |
  | 4142 | 4146 | } catch (Exception $e) { |
  | 4143 | 4147 | WpmsGaTools::setCache( |
  | 4144 | 4148 | 'wpmsga\_dash\_lasterror', |
  | 4145 | 4149 | date('Y-m-d H:i:s') . ': ' . esc\_html($e), |
  | 4146 | 4150 | $this->error\_timeout |
  | 4147 | 4151 | ); |
  | 4148 | 4152 | } |
  | 4149 | 4153 | } |
  | 4150 | 4154 |  |
  | 4151 | 4155 | if (!empty($this->google\_alanytics['profile\_list'])) { |
  | 4152 | 4156 | $profiles = $this->google\_alanytics['profile\_list']; |
  | 4153 | 4157 | } else { |
  | 4154 | 4158 | $profiles = WpmsGaTools::refreshProfiles($this->service, $getAccessToken['access\_token'], $this->error\_timeout); |
  | 4155 | 4159 | } |
  | 4156 | 4160 |  |
  | 4157 | 4161 | $this->google\_alanytics['code'] = $wpms\_gg\_access\_code; |
  | 4158 | 4162 | $this->google\_alanytics['googleCredentials'] = $getAccessToken; |
  | 4159 | 4163 | $this->google\_alanytics['profile\_list'] = $profiles; |
  | 4160 | 4164 | update\_option('wpms\_google\_alanytics', $this->google\_alanytics); |
  | 4161 | 4165 | } catch (WPMSGoogle\Service\Exception $e) { |
  | 4162 | 4166 | echo ''; |
  | 4163 | 4167 | } catch (Exception $e) { |
  | 4164 | 4168 | echo ''; |
  | 4165 | 4169 | } |
  | 4166 | 4170 | } else { |
  | 4167 | 4171 | echo '<div class="error"><p>' . esc\_html\_\_('The access code is |
  | 4168 | 4172 | <strong>NOT</strong> your <strong>Tracking ID</strong> |
  | 4169 | 4173 | (UA-XXXXX-X). Try again, and use the red link to get your access code', 'wp-meta-seo') . '.</p></div>'; |
  | 4170 | 4174 | } |
  | 4171 | 4175 | update\_option('wpms\_google\_alanytics', $this->google\_alanytics); |
  | 4172 | 4176 | wp\_redirect($\_SERVER['HTTP\_REFERER']); |
  | 4173 | 4177 | exit; |
  | 4174 | 4178 | } |
  | 4175 | 4179 | $gg\_analytcis = get\_option('wpms\_google\_alanytics'); |
  | 4176 | 4180 | if (is\_array($gg\_analytcis)) { |
  | 4177 | 4181 | $this->google\_alanytics = array\_merge($gg\_analytcis, $this->google\_alanytics); |
  | 4178 | 4182 | } |
  | 4179 | 4183 | // If user have google credentials |
  | 4180 | 4184 | if (!empty($this->google\_alanytics['googleCredentials'])) { |
  | 4181 | 4185 | // WPMS google analytics setting |
  | 4182 | 4186 | include\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/google-services/ga-trackcode.php'); |
  | 4183 | 4187 | // Google analytics data |
  | 4184 | 4188 | if (!empty($this->google\_alanytics['tableid\_jail'])) { |
  | 4185 | 4189 | echo '<h1 class="wpms-top-h1">' . esc\_html\_\_('Google Analytics Report', 'wp-meta-seo') . ' |
  | 4186 | 4190 | <i class="material-icons intro-topic-tooltip" data-tippy="' . esc\_html\_\_('Create a Google Analytics property then connect WordPress to this Analytics property. You can then follow your traffic and include the data in your Email report (Pro Addon)', 'wp-meta-seo') . '">help\_outline</i> |
  | 4187 | 4191 | </h1>'; |
  | 4188 | 4192 | echo '<div id="wpms-window-1"> |
  | 4189 | 4193 | <!-- WPMS Google analytics response using JS --> |
  | 4190 | 4194 |  |
  | 4191 | 4195 | </div>'; |
  | 4192 | 4196 | } |
  | 4193 | 4197 | } else { |
  | 4194 | 4198 | include\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/google-services/gg-services-connect.php'); |
  | 4195 | 4199 | } |
  | 4196 | 4200 | } else { |
  | 4197 | 4201 | // WPMS Google Service Tracking - when user don't have Google cloud credentials |
  | 4198 | 4202 | $gaDisconnect = get\_option('\_metaseo\_ggtracking\_disconnect\_settings'); |
  | 4199 | 4203 | if (is\_array($gaDisconnect)) { |
  | 4200 | 4204 | $this->gaDisconnect = array\_merge( |
  | 4201 | 4205 | $this->gaDisconnect, |
  | 4202 | 4206 | $gaDisconnect |
  | 4203 | 4207 | ); |
  | 4204 | 4208 | } |
  | 4205 | 4209 |  |
  | 4206 | 4210 | // When user submit tracking options |
  | 4207 | 4211 | if (isset($\_POST['\_metaseo\_gg\_service\_disconnect'])) { |
  | 4208 | 4212 | // Check none field |
  | 4209 | 4213 | if (empty($\_POST['wpms\_nonce']) |
  | 4210 | 4214 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4211 | 4215 | die(); |
  | 4212 | 4216 | } |
  | 4213 | 4217 | // Sanitizing submit data and save options |
  | 4214 | 4218 | $\_metaseo\_ga\_disconnect = $\_POST['\_metaseo\_gg\_service\_disconnect']; |
  | 4215 | 4219 | $\_metaseo\_ga\_disconnect['wpms\_gg\_service\_tracking\_id'] = sanitize\_text\_field($\_metaseo\_ga\_disconnect['wpms\_gg\_service\_tracking\_id']); |
  | 4216 | 4220 | $\_metaseo\_ga\_disconnect['wpms\_gg\_service\_tracking\_type'] = sanitize\_text\_field($\_metaseo\_ga\_disconnect['wpms\_gg\_service\_tracking\_type']); |
  | 4217 | 4221 | $\_metaseo\_ga\_disconnect['wpmsga\_code\_tracking'] = stripslashes($\_metaseo\_ga\_disconnect['wpmsga\_code\_tracking']); |
  | 4218 | 4222 | $\_metaseo\_ga\_disconnect['wpmstm\_header\_code\_tracking'] = stripslashes($\_metaseo\_ga\_disconnect['wpmstm\_header\_code\_tracking']); |
  | 4219 | 4223 | $\_metaseo\_ga\_disconnect['wpmstm\_body\_code\_tracking'] = stripslashes($\_metaseo\_ga\_disconnect['wpmstm\_body\_code\_tracking']); |
  | 4220 | 4224 | update\_option( |
  | 4221 | 4225 | '\_metaseo\_ggtracking\_disconnect\_settings', |
  | 4222 | 4226 | $\_metaseo\_ga\_disconnect |
  | 4223 | 4227 | ); |
  | 4224 | 4228 | $gaDisconnect = get\_option('\_metaseo\_ggtracking\_disconnect\_settings'); |
  | 4225 | 4229 | if (is\_array($gaDisconnect)) { |
  | 4226 | 4230 | $this->gaDisconnect = array\_merge( |
  | 4227 | 4231 | $this->gaDisconnect, |
  | 4228 | 4232 | $gaDisconnect |
  | 4229 | 4233 | ); |
  | 4230 | 4234 | } |
  | 4231 | 4235 | } |
  | 4232 | 4236 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/google-services/google-services.php'); |
  | 4233 | 4237 | } |
  | 4234 | 4238 |  |
  | 4235 | 4239 | $w = '99%'; |
  | 4236 | 4240 | $text = esc\_html\_\_('Bring your WordPress website SEO to the next level with the PRO Addon: Email Report, |
  | 4237 | 4241 | Google Search Console Connect, Automatic Redirect, Advanced Sitemaps and more!', 'wp-meta-seo'); |
  | 4238 | 4242 | $class\_btn\_close = 'close\_gga'; |
  | 4239 | 4243 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/notification.php'); |
  | 4240 | 4244 | break; |
  | 4241 | 4245 | case 'metaseo\_google\_sitemap': |
  | 4242 | 4246 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 4243 | 4247 | // remove filter by lang |
  | 4244 | 4248 | if (is\_plugin\_active('sitepress-multilingual-cms/sitepress.php')) { |
  | 4245 | 4249 | global $sitepress; |
  | 4246 | 4250 | remove\_filter('terms\_clauses', array($sitepress, 'terms\_clauses')); |
  | 4247 | 4251 | } elseif (is\_plugin\_active('polylang/polylang.php')) { |
  | 4248 | 4252 | global $polylang; |
  | 4249 | 4253 | $filters\_term = $polylang->filters\_term; |
  | 4250 | 4254 | remove\_filter('terms\_clauses', array($filters\_term, 'terms\_clauses')); |
  | 4251 | 4255 | } |
  | 4252 | 4256 | } |
  | 4253 | 4257 |  |
  | 4254 | 4258 | if (!class\_exists('MetaSeoSitemap')) { |
  | 4255 | 4259 | require\_once(WPMETASEO\_PLUGIN\_DIR . '/inc/class.metaseo-sitemap.php'); |
  | 4256 | 4260 | } |
  | 4257 | 4261 |  |
  | 4258 | 4262 | $sitemap = new MetaSeoSitemap(); |
  | 4259 | 4263 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/sitemaps/metaseo-google-sitemap.php'); |
  | 4260 | 4264 | break; |
  | 4261 | 4265 | case 'metaseo\_broken\_link': |
  | 4262 | 4266 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/metaseo-broken-link.php'); |
  | 4263 | 4267 | break; |
  | 4264 | 4268 | case 'metaseo\_settings': |
  | 4265 | 4269 | if (isset($\_POST['\_metaseo\_settings'])) { |
  | 4266 | 4270 | if (empty($\_POST['wpms\_nonce']) |
  | 4267 | 4271 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4268 | 4272 | die(); |
  | 4269 | 4273 | } |
  | 4270 | 4274 | update\_option('\_metaseo\_settings', $\_POST['\_metaseo\_settings']); |
  | 4271 | 4275 | if (isset($\_POST['\_metaseo\_settings']['wpms\_save\_general'])) { |
  | 4272 | 4276 | $\_SESSION['\_metaseo\_settings\_general'] = 1; |
  | 4273 | 4277 | } |
  | 4274 | 4278 | if (isset($\_POST['\_metaseo\_settings']['wpms\_save\_social'])) { |
  | 4275 | 4279 | $\_SESSION['\_metaseo\_settings\_social'] = 1; |
  | 4276 | 4280 | } |
  | 4277 | 4281 | if (isset($\_POST['gscapi']['save'])) { |
  | 4278 | 4282 | $\_SESSION['\_metaseo\_settings\_search\_console'] = 1; |
  | 4279 | 4283 | } |
  | 4280 | 4284 | } |
  | 4281 | 4285 |  |
  | 4282 | 4286 | $posts = get\_posts(array('post\_type' => 'page', 'posts\_per\_page' => -1, 'numberposts' => -1)); |
  | 4283 | 4287 | $types\_404 = array( |
  | 4284 | 4288 | 'none' => 'None', |
  | 4285 | 4289 | 'wp-meta-seo-page' => esc\_html\_\_('WP Meta SEO page', 'wp-meta-seo'), |
  | 4286 | 4290 | 'custom\_page' => esc\_html\_\_('Custom page', 'wp-meta-seo') |
  | 4287 | 4291 | ); |
  | 4288 | 4292 |  |
  | 4289 | 4293 | // get settings 404 |
  | 4290 | 4294 | $defaul\_settings\_404 = array( |
  | 4291 | 4295 | 'wpms\_redirect\_homepage' => 0, |
  | 4292 | 4296 | 'wpms\_type\_404' => 'none', |
  | 4293 | 4297 | 'wpms\_page\_redirected' => 'none' |
  | 4294 | 4298 | ); |
  | 4295 | 4299 | $wpms\_settings\_404 = get\_option('wpms\_settings\_404'); |
  | 4296 | 4300 | if (is\_array($wpms\_settings\_404)) { |
  | 4297 | 4301 | $defaul\_settings\_404 = array\_merge($defaul\_settings\_404, $wpms\_settings\_404); |
  | 4298 | 4302 | } |
  | 4299 | 4303 |  |
  | 4300 | 4304 | // get settings breadcrumb |
  | 4301 | 4305 | $home\_title = get\_the\_title(get\_option('page\_on\_front')); |
  | 4302 | 4306 | if (empty($home\_title)) { |
  | 4303 | 4307 | $home\_title = get\_bloginfo('title'); |
  | 4304 | 4308 | } |
  | 4305 | 4309 | $breadcrumbs = array( |
  | 4306 | 4310 | 'separator' => ' &gt; ', |
  | 4307 | 4311 | 'include\_home' => 1, |
  | 4308 | 4312 | 'home\_text' => $home\_title, |
  | 4309 | 4313 | 'home\_text\_default' => 0, |
  | 4310 | 4314 | 'clickable' => 1 |
  | 4311 | 4315 | ); |
  | 4312 | 4316 | $breadcrumb\_settings = get\_option('\_metaseo\_breadcrumbs'); |
  | 4313 | 4317 | if (is\_array($breadcrumb\_settings)) { |
  | 4314 | 4318 | $breadcrumbs = array\_merge($breadcrumbs, $breadcrumb\_settings); |
  | 4315 | 4319 | } |
  | 4316 | 4320 |  |
  | 4317 | 4321 | // email settings |
  | 4318 | 4322 | $email\_settings = array( |
  | 4319 | 4323 | 'enable' => 0, |
  | 4320 | 4324 | 'host' => 'smtp.gmail.com', |
  | 4321 | 4325 | 'type\_encryption' => 'ssl', |
  | 4322 | 4326 | 'port' => '465', |
  | 4323 | 4327 | 'autentication' => 'yes', |
  | 4324 | 4328 | 'username' => '', |
  | 4325 | 4329 | 'password' => '', |
  | 4326 | 4330 | ); |
  | 4327 | 4331 |  |
  | 4328 | 4332 | $mailsettings = get\_option('wpms\_email\_settings'); |
  | 4329 | 4333 | if (is\_array($mailsettings)) { |
  | 4330 | 4334 | $email\_settings = array\_merge($email\_settings, $mailsettings); |
  | 4331 | 4335 | } |
  | 4332 | 4336 |  |
  | 4333 | 4337 | $html\_tabemail = apply\_filters('wpmsaddon\_emailsettings', '', $email\_settings); |
  | 4334 | 4338 |  |
  | 4335 | 4339 | // link settings |
  | 4336 | 4340 | $link\_settings = array( |
  | 4337 | 4341 | 'enable' => 0, |
  | 4338 | 4342 | 'numberFrequency' => 1, |
  | 4339 | 4343 | 'showlinkFrequency' => 'month' |
  | 4340 | 4344 | ); |
  | 4341 | 4345 |  |
  | 4342 | 4346 | $linksettings = get\_option('wpms\_link\_settings'); |
  | 4343 | 4347 | if (is\_array($linksettings)) { |
  | 4344 | 4348 | $link\_settings = array\_merge($link\_settings, $linksettings); |
  | 4345 | 4349 | } |
  | 4346 | 4350 |  |
  | 4347 | 4351 | $link\_settings\_html = apply\_filters('wpmsaddon\_linksettings', '', $link\_settings); |
  | 4348 | 4352 |  |
  | 4349 | 4353 | // local business settings |
  | 4350 | 4354 | $local\_business = array( |
  | 4351 | 4355 | 'enable' => 0, |
  | 4352 | 4356 | 'logo' => '', |
  | 4353 | 4357 | 'type\_name' => '', |
  | 4354 | 4358 | 'country' => '', |
  | 4355 | 4359 | 'address' => '', |
  | 4356 | 4360 | 'city' => '', |
  | 4357 | 4361 | 'state' => '', |
  | 4358 | 4362 | 'phone' => '', |
  | 4359 | 4363 | 'pricerange' => '$$' |
  | 4360 | 4364 | ); |
  | 4361 | 4365 |  |
  | 4362 | 4366 | $business = get\_option('wpms\_local\_business'); |
  | 4363 | 4367 | if (is\_array($business)) { |
  | 4364 | 4368 | $local\_business = array\_merge($local\_business, $business); |
  | 4365 | 4369 | } |
  | 4366 | 4370 | $countrys = apply\_filters('wpms\_get\_countryList', array()); |
  | 4367 | 4371 | $local\_business\_html = apply\_filters('wpmsaddon\_local\_business', '', $local\_business, $countrys); |
  | 4368 | 4372 |  |
  | 4369 | 4373 | $search\_console\_html = apply\_filters('wpmsaddon\_search\_console', ''); |
  | 4370 | 4374 |  |
  | 4371 | 4375 | $default\_settings = wpmsGetDefaultSettings(); |
  | 4372 | 4376 | $settings = get\_option('\_metaseo\_settings'); |
  | 4373 | 4377 | if (is\_array($settings)) { |
  | 4374 | 4378 | $settings = array\_merge($default\_settings, $settings); |
  | 4375 | 4379 | } else { |
  | 4376 | 4380 | $settings = $default\_settings; |
  | 4377 | 4381 | } |
  | 4378 | 4382 |  |
  | 4379 | 4383 | foreach ($settings as $setting\_name => $setting\_value) { |
  | 4380 | 4384 | ${$setting\_name} = $setting\_value; |
  | 4381 | 4385 | } |
  | 4382 | 4386 |  |
  | 4383 | 4387 | $home\_meta\_active = wpmsGetOption('home\_meta\_active'); |
  | 4384 | 4388 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/settings.php'); |
  | 4385 | 4389 | break; |
  | 4386 | 4390 |  |
  | 4387 | 4391 | case 'metaseo\_content\_meta': |
  | 4388 | 4392 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/content-meta.php'); |
  | 4389 | 4393 | break; |
  | 4390 | 4394 |  |
  | 4391 | 4395 | case 'metaseo\_category\_meta': |
  | 4392 | 4396 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/category-meta.php'); |
  | 4393 | 4397 | break; |
  | 4394 | 4398 |  |
  | 4395 | 4399 | case 'metaseo\_image\_meta': |
  | 4396 | 4400 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/image-meta.php'); |
  | 4397 | 4401 | break; |
  | 4398 | 4402 |  |
  | 4399 | 4403 | case 'metaseo\_link\_meta': |
  | 4400 | 4404 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/link-meta.php'); |
  | 4401 | 4405 | break; |
  | 4402 | 4406 |  |
  | 4403 | 4407 | case 'metaseo\_image\_optimize': |
  | 4404 | 4408 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/image-optimize.php'); |
  | 4405 | 4409 | break; |
  | 4406 | 4410 |  |
  | 4407 | 4411 | case 'metaseo\_better\_ranking': |
  | 4408 | 4412 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/better\_seo.php'); |
  | 4409 | 4413 | break; |
  | 4410 | 4414 | case 'metaseo\_dashboard': |
  | 4411 | 4415 | default: |
  | 4412 | 4416 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/pages/dashboard.php'); |
  | 4413 | 4417 | break; |
  | 4414 | 4418 | } |
  | 4415 | 4419 | } |
  | 4416 | 4420 | } |
  | 4417 | 4421 |  |
  | 4418 | 4422 | /\*\* |
  | 4419 | 4423 | \* Ajax check attachment have alt empty |
  | 4420 | 4424 | \* |
  | 4421 | 4425 | \* @return void |
  | 4422 | 4426 | \*/ |
  | 4423 | 4427 | public function checkExist() |
  | 4424 | 4428 | { |
  | 4425 | 4429 | if (empty($\_POST['wpms\_nonce']) |
  | 4426 | 4430 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4427 | 4431 | die(); |
  | 4428 | 4432 | } |
  | 4429 | 4433 |  |
  | 4430 | 4434 | if (isset($\_POST['action\_name'])) { |
  | 4431 | 4435 | switch ($\_POST['action\_name']) { |
  | 4432 | 4436 | case 'img-copy-alt': |
  | 4433 | 4437 | $margs = array( |
  | 4434 | 4438 | 'posts\_per\_page' => -1, |
  | 4435 | 4439 | 'post\_type' => 'attachment', |
  | 4436 | 4440 | 'post\_status' => 'any', |
  | 4437 | 4441 | 'meta\_query' => array( |
  | 4438 | 4442 | 'relation' => 'OR', |
  | 4439 | 4443 | array( |
  | 4440 | 4444 | 'key' => '\_wp\_attachment\_image\_alt', |
  | 4441 | 4445 | 'value' => '', |
  | 4442 | 4446 | 'compare' => '!=' |
  | 4443 | 4447 | ) |
  | 4444 | 4448 | ) |
  | 4445 | 4449 | ); |
  | 4446 | 4450 |  |
  | 4447 | 4451 | $m\_newquery = new WP\_Query($margs); |
  | 4448 | 4452 | $mposts\_empty\_alt = $m\_newquery->get\_posts(); |
  | 4449 | 4453 | if (!empty($mposts\_empty\_alt)) { |
  | 4450 | 4454 | wp\_send\_json(true); |
  | 4451 | 4455 | } else { |
  | 4452 | 4456 | wp\_send\_json(false); |
  | 4453 | 4457 | } |
  | 4454 | 4458 | break; |
  | 4455 | 4459 |  |
  | 4456 | 4460 | case 'img-copy-title': |
  | 4457 | 4461 | global $wpdb; |
  | 4458 | 4462 | $check\_title = $wpdb->get\_var('SELECT COUNT(posts.ID) as total FROM ' . $wpdb->prefix . 'posts as posts |
  | 4459 | 4463 | WHERE posts.post\_type = "attachment" AND post\_title != ""'); |
  | 4460 | 4464 | if ($check\_title > 0) { |
  | 4461 | 4465 | wp\_send\_json(true); |
  | 4462 | 4466 | } else { |
  | 4463 | 4467 | wp\_send\_json(false); |
  | 4464 | 4468 | } |
  | 4465 | 4469 | break; |
  | 4466 | 4470 | case 'img-copy-desc': |
  | 4467 | 4471 | global $wpdb; |
  | 4468 | 4472 | $check\_title = $wpdb->get\_var('SELECT COUNT(posts.ID) as total FROM ' . $wpdb->prefix . 'posts as posts |
  | 4469 | 4473 | WHERE posts.post\_type = "attachment" AND post\_content != ""'); |
  | 4470 | 4474 | if ($check\_title > 0) { |
  | 4471 | 4475 | wp\_send\_json(true); |
  | 4472 | 4476 | } else { |
  | 4473 | 4477 | wp\_send\_json(false); |
  | 4474 | 4478 | } |
  | 4475 | 4479 | break; |
  | 4476 | 4480 | } |
  | 4477 | 4481 | } |
  | 4478 | 4482 | } |
  | 4479 | 4483 |  |
  | 4480 | 4484 | /\*\* |
  | 4481 | 4485 | \* Ajax update image alt and image title |
  | 4482 | 4486 | \* |
  | 4483 | 4487 | \* @return void |
  | 4484 | 4488 | \*/ |
  | 4485 | 4489 | public function bulkImageCopy() |
  | 4486 | 4490 | { |
  | 4487 | 4491 | if (empty($\_POST['wpms\_nonce']) |
  | 4488 | 4492 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4489 | 4493 | die(); |
  | 4490 | 4494 | } |
  | 4491 | 4495 |  |
  | 4492 | 4496 | global $wpdb; |
  | 4493 | 4497 | if (empty($\_POST['action\_name'])) { |
  | 4494 | 4498 | wp\_send\_json(false); |
  | 4495 | 4499 | } |
  | 4496 | 4500 |  |
  | 4497 | 4501 | if (isset($\_POST['sl\_bulk']) && $\_POST['sl\_bulk'] === 'all') { |
  | 4498 | 4502 | // select all |
  | 4499 | 4503 | $limit = 500; |
  | 4500 | 4504 | // query attachment and update meta |
  | 4501 | 4505 | $total = $wpdb->get\_var('SELECT COUNT(posts.ID) as total FROM ' . $wpdb->prefix . 'posts as posts |
  | 4502 | 4506 | WHERE posts.post\_type = "attachment"'); |
  | 4503 | 4507 |  |
  | 4504 | 4508 | $j = ceil((int)$total / $limit); |
  | 4505 | 4509 | for ($i = 0; $i <= $j; $i++) { |
  | 4506 | 4510 | $ofset = $i \* $limit; |
  | 4507 | 4511 | $attachments = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'posts as posts |
  | 4508 | 4512 | WHERE posts.post\_type = %s LIMIT %d OFFSET %d', array('attachment', $limit, $ofset))); |
  | 4509 | 4513 |  |
  | 4510 | 4514 | foreach ($attachments as $attachment) { |
  | 4511 | 4515 | $i\_info\_url = pathinfo($attachment->guid); |
  | 4512 | 4516 | switch ($\_POST['action\_name']) { |
  | 4513 | 4517 | case 'img-copy-alt': |
  | 4514 | 4518 | $value = $i\_info\_url['filename']; |
  | 4515 | 4519 | /\*\* |
  | 4516 | 4520 | \* Filter before update meta for image |
  | 4517 | 4521 | \* |
  | 4518 | 4522 | \* @param string  Meta value |
  | 4519 | 4523 | \* @param integer Image ID |
  | 4520 | 4524 | \* @param string  Meta key |
  | 4521 | 4525 | \* @param array   Extra informations |
  | 4522 | 4526 | \* |
  | 4523 | 4527 | \* @return string |
  | 4524 | 4528 | \*/ |
  | 4525 | 4529 | $value = apply\_filters('wpms\_update\_image\_meta', $value, $attachment->ID, '\_wp\_attachment\_image\_alt', array('source' => 'bulk\_copy\_alt')); |
  | 4526 | 4530 | update\_post\_meta($attachment->ID, '\_wp\_attachment\_image\_alt', $value); |
  | 4527 | 4531 | break; |
  | 4528 | 4532 |  |
  | 4529 | 4533 | case 'img-copy-title': |
  | 4530 | 4534 | $value = $i\_info\_url['filename']; |
  | 4531 | 4535 | /\*\* |
  | 4532 | 4536 | \* Filter before update meta for image |
  | 4533 | 4537 | \* |
  | 4534 | 4538 | \* @param string  Meta value |
  | 4535 | 4539 | \* @param integer Image ID |
  | 4536 | 4540 | \* @param string  Post title field name |
  | 4537 | 4541 | \* @param array   Extra informations |
  | 4538 | 4542 | \* |
  | 4539 | 4543 | \* @return string |
  | 4540 | 4544 | \* |
  | 4541 | 4545 | \* @ignore Hook already documented |
  | 4542 | 4546 | \*/ |
  | 4543 | 4547 | $value = apply\_filters('wpms\_update\_image\_meta', $value, $attachment->ID, 'post\_title', array('source' => 'bulk\_copy\_title')); |
  | 4544 | 4548 | wp\_update\_post(array('ID' => $attachment->ID, 'post\_title' => $value)); |
  | 4545 | 4549 | break; |
  | 4546 | 4550 | case 'img-copy-desc': |
  | 4547 | 4551 | wp\_update\_post(array('ID' => $attachment->ID, 'post\_content' => $i\_info\_url['filename'])); |
  | 4548 | 4552 | break; |
  | 4549 | 4553 | } |
  | 4550 | 4554 | } |
  | 4551 | 4555 | } |
  | 4552 | 4556 |  |
  | 4553 | 4557 | wp\_send\_json(true); |
  | 4554 | 4558 | } else { |
  | 4555 | 4559 | // selected |
  | 4556 | 4560 | if (isset($\_POST['ids'])) { |
  | 4557 | 4561 | $ids =  (array)$\_POST['ids']; |
  | 4558 | 4562 | $ids = array\_map('absint', $ids); |
  | 4559 | 4563 | switch ($\_POST['action\_name']) { |
  | 4560 | 4564 | case 'img-copy-alt': |
  | 4561 | 4565 | $margs = array( |
  | 4562 | 4566 | 'posts\_per\_page' => -1, |
  | 4563 | 4567 | 'post\_type' => 'attachment', |
  | 4564 | 4568 | 'post\_status' => 'any', |
  | 4565 | 4569 | 'post\_\_in' => $ids |
  | 4566 | 4570 | ); |
  | 4567 | 4571 |  |
  | 4568 | 4572 | $m\_newquery = new WP\_Query($margs); |
  | 4569 | 4573 | $mposts\_empty\_alt = $m\_newquery->get\_posts(); |
  | 4570 | 4574 | if (!empty($mposts\_empty\_alt)) { |
  | 4571 | 4575 | foreach ($mposts\_empty\_alt as $post) { |
  | 4572 | 4576 | $i\_info\_url = pathinfo($post->guid); |
  | 4573 | 4577 | $value = $i\_info\_url['filename']; |
  | 4574 | 4578 | /\*\* |
  | 4575 | 4579 | \* Filter before update meta for image |
  | 4576 | 4580 | \* |
  | 4577 | 4581 | \* @param string  Meta value |
  | 4578 | 4582 | \* @param integer Image ID |
  | 4579 | 4583 | \* @param string  Meta key |
  | 4580 | 4584 | \* @param array   Extra informations |
  | 4581 | 4585 | \* |
  | 4582 | 4586 | \* @return string |
  | 4583 | 4587 | \* |
  | 4584 | 4588 | \* @ignore Hook already documented |
  | 4585 | 4589 | \*/ |
  | 4586 | 4590 | $value = apply\_filters('wpms\_update\_image\_meta', $value, $post->ID, '\_wp\_attachment\_image\_alt', array('source' => 'bulk\_copy\_alt')); |
  | 4587 | 4591 | update\_post\_meta($post->ID, '\_wp\_attachment\_image\_alt', $value); |
  | 4588 | 4592 | } |
  | 4589 | 4593 | } else { |
  | 4590 | 4594 | wp\_send\_json(false); |
  | 4591 | 4595 | } |
  | 4592 | 4596 | break; |
  | 4593 | 4597 |  |
  | 4594 | 4598 | case 'img-copy-title': |
  | 4595 | 4599 | $posts\_result = $wpdb->get\_results($wpdb->prepare('SELECT \* |
  | 4596 | 4600 | FROM ' . $wpdb->posts . ' WHERE post\_type = %s |
  | 4597 | 4601 | AND post\_mime\_type LIKE %s AND ID IN (' . implode(',', esc\_sql($ids)) . ') |
  | 4598 | 4602 | ', array('attachment', '%image%'))); |
  | 4599 | 4603 |  |
  | 4600 | 4604 | if (!empty($posts\_result)) { |
  | 4601 | 4605 | foreach ($posts\_result as $post) { |
  | 4602 | 4606 | $i\_info\_url = pathinfo($post->guid); |
  | 4603 | 4607 | $value = $i\_info\_url['filename']; |
  | 4604 | 4608 | /\*\* |
  | 4605 | 4609 | \* Filter before update meta for image |
  | 4606 | 4610 | \* |
  | 4607 | 4611 | \* @param string  Meta value |
  | 4608 | 4612 | \* @param integer Image ID |
  | 4609 | 4613 | \* @param string  Post title field name |
  | 4610 | 4614 | \* @param array   Extra informations |
  | 4611 | 4615 | \* |
  | 4612 | 4616 | \* @return string |
  | 4613 | 4617 | \* |
  | 4614 | 4618 | \* @ignore Hook already documented |
  | 4615 | 4619 | \*/ |
  | 4616 | 4620 | $value = apply\_filters('wpms\_update\_image\_meta', $value, $post->ID, 'post\_title', array('source' => 'bulk\_copy\_title')); |
  | 4617 | 4621 | wp\_update\_post(array('ID' => $post->ID, 'post\_title' => $value)); |
  | 4618 | 4622 | } |
  | 4619 | 4623 | } else { |
  | 4620 | 4624 | wp\_send\_json(false); |
  | 4621 | 4625 | } |
  | 4622 | 4626 | break; |
  | 4623 | 4627 | case 'img-copy-desc': |
  | 4624 | 4628 | // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared -- Variable has been prepare |
  | 4625 | 4629 | $sql = $wpdb->prepare('SELECT \* FROM ' . $wpdb->posts . ' WHERE post\_type = %s AND post\_mime\_type LIKE %s AND ID IN ('.implode(',', $ids).')', array('attachment', '%image%'  )); |
  | 4626 | 4630 | // phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared -- Variable has been prepare |
  | 4627 | 4631 | $posts\_result = $wpdb->get\_results($sql); |
  | 4628 | 4632 | if (!empty($posts\_result)) { |
  | 4629 | 4633 | foreach ($posts\_result as $post) { |
  | 4630 | 4634 | $i\_info\_url = pathinfo($post->guid); |
  | 4631 | 4635 | wp\_update\_post(array('ID' => $post->ID, 'post\_content' => $i\_info\_url['filename'])); |
  | 4632 | 4636 | } |
  | 4633 | 4637 | } else { |
  | 4634 | 4638 | wp\_send\_json(false); |
  | 4635 | 4639 | } |
  | 4636 | 4640 | break; |
  | 4637 | 4641 | } |
  | 4638 | 4642 | wp\_send\_json(true); |
  | 4639 | 4643 | } else { |
  | 4640 | 4644 | wp\_send\_json(false); |
  | 4641 | 4645 | } |
  | 4642 | 4646 | } |
  | 4643 | 4647 | } |
  | 4644 | 4648 |  |
  | 4645 | 4649 | /\*\* |
  | 4646 | 4650 | \* Ajax bulk update meta title for a post/page |
  | 4647 | 4651 | \* |
  | 4648 | 4652 | \* @return void |
  | 4649 | 4653 | \*/ |
  | 4650 | 4654 | public function bulkPostCopy() |
  | 4651 | 4655 | { |
  | 4652 | 4656 | if (empty($\_POST['wpms\_nonce']) |
  | 4653 | 4657 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4654 | 4658 | die(); |
  | 4655 | 4659 | } |
  | 4656 | 4660 |  |
  | 4657 | 4661 | $post\_types = get\_post\_types(array('public' => true, 'exclude\_from\_search' => false)); |
  | 4658 | 4662 | unset($post\_types['attachment']); |
  | 4659 | 4663 | $margs = array(); |
  | 4660 | 4664 |  |
  | 4661 | 4665 | switch ($\_POST['action\_name']) { |
  | 4662 | 4666 | case 'post-copy-title': |
  | 4663 | 4667 | $key = '\_metaseo\_metatitle'; |
  | 4664 | 4668 | break; |
  | 4665 | 4669 | case 'post-copy-desc': |
  | 4666 | 4670 | $key = '\_metaseo\_metadesc'; |
  | 4667 | 4671 | break; |
  | 4668 | 4672 | } |
  | 4669 | 4673 |  |
  | 4670 | 4674 | if (isset($\_POST['sl\_bulk']) && $\_POST['sl\_bulk'] === 'all') { // for select a;; |
  | 4671 | 4675 | $margs = array( |
  | 4672 | 4676 | 'posts\_per\_page' => -1, |
  | 4673 | 4677 | 'post\_type' => $post\_types, |
  | 4674 | 4678 | 'post\_status' => 'any' |
  | 4675 | 4679 | ); |
  | 4676 | 4680 | } else { // for select some post |
  | 4677 | 4681 | if (isset($\_POST['ids'])) { |
  | 4678 | 4682 | $ids = $\_POST['ids']; |
  | 4679 | 4683 | $margs = array( |
  | 4680 | 4684 | 'posts\_per\_page' => -1, |
  | 4681 | 4685 | 'post\_type' => $post\_types, |
  | 4682 | 4686 | 'post\_status' => 'any', |
  | 4683 | 4687 | 'post\_\_in' => $ids |
  | 4684 | 4688 | ); |
  | 4685 | 4689 | } else { |
  | 4686 | 4690 | wp\_send\_json(false); |
  | 4687 | 4691 | } |
  | 4688 | 4692 | } |
  | 4689 | 4693 |  |
  | 4690 | 4694 | $m\_newquery = new WP\_Query($margs); |
  | 4691 | 4695 | $mposts = $m\_newquery->get\_posts(); |
  | 4692 | 4696 | if (!empty($mposts)) { |
  | 4693 | 4697 | foreach ($mposts as $post) { |
  | 4694 | 4698 | $value = $post->post\_title; |
  | 4695 | 4699 | /\*\* |
  | 4696 | 4700 | \* Filter before update meta for post/page |
  | 4697 | 4701 | \* |
  | 4698 | 4702 | \* @param string  Meta value |
  | 4699 | 4703 | \* @param integer Post ID |
  | 4700 | 4704 | \* @param string  Meta key |
  | 4701 | 4705 | \* @param array   Extra informations |
  | 4702 | 4706 | \* |
  | 4703 | 4707 | \* @return string |
  | 4704 | 4708 | \* |
  | 4705 | 4709 | \* @ignore Hook already documented |
  | 4706 | 4710 | \*/ |
  | 4707 | 4711 | $value = apply\_filters('wpms\_update\_content\_meta', $value, $post->ID, $key, array('source' => 'copy\_meta')); |
  | 4708 | 4712 | update\_post\_meta($post->ID, $key, $value); |
  | 4709 | 4713 | } |
  | 4710 | 4714 | wp\_send\_json(true); |
  | 4711 | 4715 | } else { |
  | 4712 | 4716 | wp\_send\_json(false); |
  | 4713 | 4717 | } |
  | 4714 | 4718 | } |
  | 4715 | 4719 |  |
  | 4716 | 4720 | /\*\* |
  | 4717 | 4721 | \* Set cookie notification |
  | 4718 | 4722 | \* |
  | 4719 | 4723 | \* @return void |
  | 4720 | 4724 | \*/ |
  | 4721 | 4725 | public function setcookieNotification() |
  | 4722 | 4726 | { |
  | 4723 | 4727 | if (empty($\_POST['wpms\_nonce']) |
  | 4724 | 4728 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4725 | 4729 | die(); |
  | 4726 | 4730 | } |
  | 4727 | 4731 |  |
  | 4728 | 4732 | if (isset($\_POST['page'])) { |
  | 4729 | 4733 | setcookie($\_POST['page'], time(), time() + (86400 \* 30), '/'); |
  | 4730 | 4734 | wp\_send\_json(true); |
  | 4731 | 4735 | } |
  | 4732 | 4736 | wp\_send\_json(false); |
  | 4733 | 4737 | } |
  | 4734 | 4738 |  |
  | 4735 | 4739 |  |
  | 4736 | 4740 | /\*\* |
  | 4737 | 4741 | \* Ajax save ga information |
  | 4738 | 4742 | \* |
  | 4739 | 4743 | \* @return void |
  | 4740 | 4744 | \*/ |
  | 4741 | 4745 | public function wpmsGGSaveInformation() |
  | 4742 | 4746 | { |
  | 4743 | 4747 | check\_ajax\_referer('wpms\_nonce', 'wpms\_nonce'); |
  |  | 4748 | if (!current\_user\_can('manage\_options')) { |
  |  | 4749 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 4750 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 4751 | } |
  | 4744 | 4752 |  |
  | 4745 | 4753 | $google\_alanytics = array( |
  | 4746 | 4754 | 'wpmsga\_dash\_clientid' => isset($\_POST['wpmsga\_dash\_clientid']) ? trim($\_POST['wpmsga\_dash\_clientid']) : '', |
  | 4747 | 4755 | 'wpmsga\_dash\_clientsecret' => isset($\_POST['wpmsga\_dash\_clientsecret']) ? trim($\_POST['wpmsga\_dash\_clientsecret']) : '' |
  | 4748 | 4756 | ); |
  | 4749 | 4757 |  |
  | 4750 | 4758 | update\_option('wpms\_google\_alanytics', $google\_alanytics); |
  | 4751 | 4759 |  |
  | 4752 | 4760 | require\_once WPMETASEO\_PLUGIN\_DIR . 'inc/google\_analytics/wpmstools.php'; |
  | 4753 | 4761 | $client = WpmsGaTools::initClient($google\_alanytics['wpmsga\_dash\_clientid'], $google\_alanytics['wpmsga\_dash\_clientsecret']); |
  | 4754 | 4762 | $authUrl = $client->createAuthUrl(); |
  | 4755 | 4763 |  |
  | 4756 | 4764 | if (!empty($authUrl)) { |
  | 4757 | 4765 | echo json\_encode(array('status' => 'true', 'authUrl' => $authUrl)); |
  | 4758 | 4766 | die(); |
  | 4759 | 4767 | } |
  | 4760 | 4768 |  |
  | 4761 | 4769 | echo json\_encode(array('status' => 'false', 'authUrl' => '')); |
  | 4762 | 4770 | die(); |
  | 4763 | 4771 | } |
  | 4764 | 4772 |  |
  | 4765 | 4773 | /\*\* |
  | 4766 | 4774 | \* Run ajax |
  | 4767 | 4775 | \* |
  | 4768 | 4776 | \* @return void |
  | 4769 | 4777 | \*/ |
  | 4770 | 4778 | public function startProcess() |
  | 4771 | 4779 | { |
  | 4772 | 4780 | if (empty($\_POST['wpms\_nonce']) || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 4773 | 4781 | die(); |
  | 4774 | 4782 | } |
  | 4775 | 4783 | if (!current\_user\_can('edit\_posts')) { |
  | 4776 | 4784 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  | 4777 | 4785 | wp\_die(\_\_('There is no edit permission here', 'wp-meta-seo')); |
  | 4778 | 4786 | } |
  | 4779 | 4787 | if (isset($\_REQUEST['task'])) { |
  | 4780 | 4788 | switch ($\_REQUEST['task']) { |
  | 4781 | 4789 | case 'updateContentMeta': |
  | 4782 | 4790 | $this->updateContentMetaCallback(); |
  | 4783 | 4791 | break; |
  | 4784 | 4792 | case 'scanPosts': |
  | 4785 | 4793 | MetaSeoImageListTable::scanPostsCallback(); |
  | 4786 | 4794 | break; |
  | 4787 | 4795 | case 'load\_posts': |
  | 4788 | 4796 | MetaSeoImageListTable::loadPostsCallback(); |
  | 4789 | 4797 | break; |
  | 4790 | 4798 | case 'optimize\_imgs': |
  | 4791 | 4799 | MetaSeoImageListTable::optimizeImages(); |
  | 4792 | 4800 | break; |
  | 4793 | 4801 | case 'updateMeta': |
  | 4794 | 4802 | MetaSeoImageListTable::updateMetaCallback(); |
  | 4795 | 4803 | break; |
  | 4796 | 4804 | case 'import\_meta\_data': |
  | 4797 | 4805 | MetaSeoContentListTable::importMetaData(); |
  | 4798 | 4806 | break; |
  | 4799 | 4807 | case 'dismiss\_import\_meta': |
  | 4800 | 4808 | MetaSeoContentListTable::dismissImport(); |
  | 4801 | 4809 | break; |
  | 4802 | 4810 | case 'bulk\_post\_copy': |
  | 4803 | 4811 | $this->bulkPostCopy(); |
  | 4804 | 4812 | break; |
  | 4805 | 4813 | case 'bulk\_image\_copy': |
  | 4806 | 4814 | $this->bulkImageCopy(); |
  | 4807 | 4815 | break; |
  | 4808 | 4816 | case 'ajax\_check\_exist': |
  | 4809 | 4817 | $this->checkExist(); |
  | 4810 | 4818 | break; |
  | 4811 | 4819 | case 'reload\_analysis': |
  | 4812 | 4820 | $this->reloadAnalysis(); |
  | 4813 | 4821 | break; |
  | 4814 | 4822 | case 'wpmsElementorSavePost': |
  | 4815 | 4823 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-metabox.php'); |
  | 4816 | 4824 | WPMSEOMetabox::savePostByElementor(); |
  | 4817 | 4825 | break; |
  | 4818 | 4826 | case 'validate\_analysis': |
  | 4819 | 4827 | $this->validateAnalysis(); |
  | 4820 | 4828 | break; |
  | 4821 | 4829 | case 'update\_link': |
  | 4822 | 4830 | $this->updateLink(); |
  | 4823 | 4831 | break; |
  | 4824 | 4832 | case 'remove\_link': |
  | 4825 | 4833 | $this->removeLink(); |
  | 4826 | 4834 | break; |
  | 4827 | 4835 | case 'save\_settings404': |
  | 4828 | 4836 | $this->save404Settings(); |
  | 4829 | 4837 | break; |
  | 4830 | 4838 | case 'save\_settings\_breadcrumb': |
  | 4831 | 4839 | $this->saveBreadcrumbSettings(); |
  | 4832 | 4840 | break; |
  | 4833 | 4841 | case 'update\_link\_redirect': |
  | 4834 | 4842 | MetaSeoBrokenLinkTable::updateLinkRedirect(); |
  | 4835 | 4843 | break; |
  | 4836 | 4844 | case 'add\_custom\_redirect': |
  | 4837 | 4845 | MetaSeoBrokenLinkTable::addCustomRedirect(); |
  | 4838 | 4846 | break; |
  | 4839 | 4847 | case 'unlink': |
  | 4840 | 4848 | MetaSeoBrokenLinkTable::unlink(); |
  | 4841 | 4849 | break; |
  | 4842 | 4850 | case 'recheck\_link': |
  | 4843 | 4851 | MetaSeoBrokenLinkTable::reCheckLink(); |
  | 4844 | 4852 | break; |
  | 4845 | 4853 | case 'scan\_link': |
  | 4846 | 4854 | MetaSeoBrokenLinkTable::scanLink(); |
  | 4847 | 4855 | break; |
  | 4848 | 4856 | case 'flush\_link': |
  | 4849 | 4857 | MetaSeoBrokenLinkTable::flushLink(); |
  | 4850 | 4858 | break; |
  | 4851 | 4859 | case 'update\_follow': |
  | 4852 | 4860 | $this->updateFollow(); |
  | 4853 | 4861 | break; |
  | 4854 | 4862 | case 'update\_multiplefollow': |
  | 4855 | 4863 | $this->updateMultipleFollow(); |
  | 4856 | 4864 | break; |
  | 4857 | 4865 | case 'update\_pagefollow': |
  | 4858 | 4866 | $this->updatePageFollow(); |
  | 4859 | 4867 | break; |
  | 4860 | 4868 | case 'update\_pageindex': |
  | 4861 | 4869 | $this->updatePageIndex(); |
  | 4862 | 4870 | break; |
  | 4863 | 4871 | case 'backend\_item\_reports': |
  | 4864 | 4872 | MetaSeoGoogleAnalytics::itemsReport(); |
  | 4865 | 4873 | break; |
  | 4866 | 4874 | case 'analytics\_widgets\_data': |
  | 4867 | 4875 | MetaSeoGoogleAnalytics::analyticsWidgetsData(); |
  | 4868 | 4876 | break; |
  | 4869 | 4877 | case 'wpms\_tagmanager\_request\_containers': |
  | 4870 | 4878 | $this->tagmanagerContainersReport(); |
  | 4871 | 4879 | break; |
  | 4872 | 4880 | case 'wpms\_tagmanager\_container\_info': |
  | 4873 | 4881 | $this->tagmanagerContainerInfo(); |
  | 4874 | 4882 | break; |
  | 4875 | 4883 | case 'wpms\_tagmanager\_refresh\_connect': |
  | 4876 | 4884 | $this->tagmanagerRefreshConnect(); |
  | 4877 | 4885 | break; |
  | 4878 | 4886 | case 'ga\_clearauthor': |
  | 4879 | 4887 | MetaSeoGoogleAnalytics::clearAuthor(); |
  | 4880 | 4888 | break; |
  | 4881 | 4889 | case 'ga\_update\_option': |
  | 4882 | 4890 | MetaSeoGoogleAnalytics::updateOption(); |
  | 4883 | 4891 | break; |
  | 4884 | 4892 | case 'dash\_permalink': |
  | 4885 | 4893 | MetaSeoDashboard::dashboardPermalink(); |
  | 4886 | 4894 | break; |
  | 4887 | 4895 | case 'dash\_newcontent': |
  | 4888 | 4896 | MetaSeoDashboard::dashboardNewContent(); |
  | 4889 | 4897 | break; |
  | 4890 | 4898 | case 'dash\_linkmeta': |
  | 4891 | 4899 | MetaSeoDashboard::dashboardLinkMeta(); |
  | 4892 | 4900 | break; |
  | 4893 | 4901 | case 'dash\_metatitle': |
  | 4894 | 4902 | MetaSeoDashboard::dashboardMetaTitle(); |
  | 4895 | 4903 | break; |
  | 4896 | 4904 | case 'dash\_metadesc': |
  | 4897 | 4905 | MetaSeoDashboard::dashboardMetaDesc(); |
  | 4898 | 4906 | break; |
  | 4899 | 4907 | case 'dash\_imgsmeta': |
  | 4900 | 4908 | MetaSeoDashboard::dashImgsMeta(); |
  | 4901 | 4909 | break; |
  | 4902 | 4910 | case 'reload-web': |
  | 4903 | 4911 | MetaSeoDashboard::reloadWeb(); |
  | 4904 | 4912 | break; |
  | 4905 | 4913 | case 'setcookie\_notification': |
  | 4906 | 4914 | $this->setcookieNotification(); |
  | 4907 | 4915 | break; |
  | 4908 | 4916 | case 'image\_scan\_meta': |
  | 4909 | 4917 | MetaSeoImageListTable::imageScanMeta(); |
  | 4910 | 4918 | break; |
  | 4911 | 4919 | case 'update\_seokeyword\_bulk\_edit': |
  | 4912 | 4920 | $this->updateSeokeywordBulkEdit(); |
  | 4913 | 4921 | break; |
  | 4914 | 4922 | case 'updateCategoryContent': |
  | 4915 | 4923 | WPMSCategoryMetaTable::updateCategoryContent(); |
  | 4916 | 4924 | break; |
  | 4917 | 4925 | case 'wpmsDeleteCat': |
  | 4918 | 4926 | WPMSCategoryMetaTable::wpmsDeleteCat(); |
  | 4919 | 4927 | break; |
  | 4920 | 4928 | case 'wpmsBulkCatCopy': |
  | 4921 | 4929 | WPMSCategoryMetaTable::wpmsBulkCatCopy(); |
  | 4922 | 4930 | break; |
  | 4923 | 4931 | } |
  | 4924 | 4932 | } |
  | 4925 | 4933 | } |
  | 4926 | 4934 |  |
  | 4927 | 4935 |  |
  | 4928 | 4936 | /\*\* |
  | 4929 | 4937 | \* Convert canonical url |
  | 4930 | 4938 | \* |
  | 4931 | 4939 | \* @param string $url Url |
  | 4932 | 4940 | \* |
  | 4933 | 4941 | \* @return string |
  | 4934 | 4942 | \*/ |
  | 4935 | 4943 | public static function convertCanonicalUrlToSave($url) |
  | 4936 | 4944 | { |
  | 4937 | 4945 | if (empty($url)) { |
  | 4938 | 4946 | return $url; |
  | 4939 | 4947 | } |
  | 4940 | 4948 |  |
  | 4941 | 4949 | $url = preg\_replace('/\s+/', '', $url); |
  | 4942 | 4950 |  |
  | 4943 | 4951 | if (substr($url, 0, 2) === '//') { |
  | 4944 | 4952 | $url = (is\_ssl() ? 'https:' : 'http:') . $url; |
  | 4945 | 4953 | } |
  | 4946 | 4954 |  |
  | 4947 | 4955 | // Remove / in first |
  | 4948 | 4956 | $url = ltrim($url, '/'); |
  | 4949 | 4957 |  |
  | 4950 | 4958 | // Full link |
  | 4951 | 4959 | if (preg\_match('#http(s?)://#i', $url)) { |
  | 4952 | 4960 | if (strpos($url, trim(home\_url(), '/')) !== false) { |
  | 4953 | 4961 | $url = str\_replace(trim(home\_url(), '/'), '', $url); |
  | 4954 | 4962 | return (empty($url) ? '/' : $url); |
  | 4955 | 4963 | } else { |
  | 4956 | 4964 | // External link |
  | 4957 | 4965 | return $url; |
  | 4958 | 4966 | } |
  | 4959 | 4967 | } |
  | 4960 | 4968 |  |
  | 4961 | 4969 | $parseHome = parse\_url(home\_url()); |
  | 4962 | 4970 | $host = (!empty($parseHome['host']) ? $parseHome['host'] : ''); |
  | 4963 | 4971 | $host .= (!empty($parseHome['path']) ? $parseHome['path'] : ''); |
  | 4964 | 4972 |  |
  | 4965 | 4973 | if ($host && $url && strpos($url, $host) !== false) { |
  | 4966 | 4974 | $url = str\_replace($host, '', $url); |
  | 4967 | 4975 | } |
  | 4968 | 4976 |  |
  | 4969 | 4977 | return '/' . ltrim($url, '/'); |
  | 4970 | 4978 | } |
  | 4971 | 4979 |  |
  | 4972 | 4980 | /\*\* |
  | 4973 | 4981 | \* Convert canonical url to display |
  | 4974 | 4982 | \* |
  | 4975 | 4983 | \* @param string $url Url |
  | 4976 | 4984 | \* |
  | 4977 | 4985 | \* @return string |
  | 4978 | 4986 | \*/ |
  | 4979 | 4987 | public static function convertCanonicalUrlToDisplay($url) |
  | 4980 | 4988 | { |
  | 4981 | 4989 | if (empty($url)) { |
  | 4982 | 4990 | return $url; |
  | 4983 | 4991 | } |
  | 4984 | 4992 |  |
  | 4985 | 4993 | if (preg\_match('#http(s?)://#i', $url)) { |
  | 4986 | 4994 | // External link |
  | 4987 | 4995 | return $url; |
  | 4988 | 4996 | } |
  | 4989 | 4997 |  |
  | 4990 | 4998 | return trim(home\_url(), '/') . $url; |
  | 4991 | 4999 | } |
  | 4992 | 5000 |  |
  | 4993 | 5001 | /\*\* |
  | 4994 | 5002 | \* Schedules a rewrite flush. |
  | 4995 | 5003 | \* |
  | 4996 | 5004 | \* @return void |
  | 4997 | 5005 | \*/ |
  | 4998 | 5006 | public function wpmsScheduleRewriteFlush() |
  | 4999 | 5007 | { |
  | 5000 | 5008 | // Bail if this is a multisite installation and the site has been switched. |
  | 5001 | 5009 | if (is\_multisite() && ms\_is\_switched()) { |
  | 5002 | 5010 | return; |
  | 5003 | 5011 | } |
  | 5004 | 5012 |  |
  | 5005 | 5013 | add\_action('shutdown', 'flush\_rewrite\_rules'); |
  | 5006 | 5014 | } |
  | 5007 | 5015 | } |
* ## [wp-meta-seo/trunk/inc/class.metaseo-sitemap.php](/changeset/2870465/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?old=2810660&old_path=wp-meta-seo%2Ftrunk%2Finc%2Fclass.metaseo-sitemap.php "Show the [2869205:2870465] differences restricted to wp-meta-seo/trunk/inc/class.metaseo-sitemap.php")

  | [r2869205](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2810660#L1 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/inc/class.metaseo-sitemap.php?rev=2870465#L1 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | /\* Prohibit direct script loading \*/ |
  | 3 | 3 | defined('ABSPATH') || die('No direct script access allowed!'); |
  | 4 | 4 |  |
  | 5 | 5 | /\*\* |
  | 6 | 6 | \* Class MetaSeoSitemap |
  | 7 | 7 | \* Class that holds most of the sitemap functionality for Meta SEO. |
  | 8 | 8 | \*/ |
  | 9 | 9 | class MetaSeoSitemap |
  | 10 | 10 | { |
  | 11 | 11 |  |
  | 12 | 12 | /\*\* |
  | 13 | 13 | \* Sitemap html |
  | 14 | 14 | \* |
  | 15 | 15 | \* @var string |
  | 16 | 16 | \*/ |
  | 17 | 17 | public $html = ''; |
  | 18 | 18 | /\*\* |
  | 19 | 19 | \* WPMS Sitemap xml file |
  | 20 | 20 | \* |
  | 21 | 21 | \* @var string |
  | 22 | 22 | \*/ |
  | 23 | 23 | public $wpms\_sitemap\_name = 'wpms-sitemap.xml'; |
  | 24 | 24 | /\*\* |
  | 25 | 25 | \* Sitemap xml file |
  | 26 | 26 | \* |
  | 27 | 27 | \* @var string |
  | 28 | 28 | \*/ |
  | 29 | 29 | public $wpms\_sitemap\_default\_name = 'sitemap.xml'; |
  | 30 | 30 | /\*\* |
  | 31 | 31 | \* List columns sitemap |
  | 32 | 32 | \* |
  | 33 | 33 | \* @var array |
  | 34 | 34 | \*/ |
  | 35 | 35 | public $columns = array('Zezo', 'One', 'Two', 'Three'); |
  | 36 | 36 | /\*\* |
  | 37 | 37 | \* Level menu |
  | 38 | 38 | \* |
  | 39 | 39 | \* @var array |
  | 40 | 40 | \*/ |
  | 41 | 41 | public $level = array(); |
  | 42 | 42 | /\*\* |
  | 43 | 43 | \* Sitemap settings |
  | 44 | 44 | \* |
  | 45 | 45 | \* @var array |
  | 46 | 46 | \*/ |
  | 47 | 47 | public $settings\_sitemap; |
  | 48 | 48 |  |
  | 49 | 49 | /\*\* |
  | 50 | 50 | \* MetaSeoSitemap constructor. |
  | 51 | 51 | \*/ |
  | 52 | 52 | public function \_\_construct() |
  | 53 | 53 | { |
  | 54 | 54 | $this->getSitemapSettings(); |
  | 55 | 55 | add\_action('admin\_enqueue\_scripts', array($this, 'adminEnqueueScripts')); |
  | 56 | 56 | add\_action('wp\_enqueue\_scripts', array($this, 'enqueueScripts')); |
  | 57 | 57 | add\_filter('the\_content', array($this, 'sitemapInContent')); |
  | 58 | 58 | add\_shortcode('wpms\_html\_sitemap', array($this, 'sitemapShortcode')); |
  | 59 |  | add\_action('wp\_ajax\_wpms\_regenerate\_sitemaps', array($this, 'regenerateSitemaps')); |
  |  | 59 | add\_action('wp\_ajax\_wpms\_regenerate\_sitemaps', array($this, 'regenerateSitemapsAjax')); |
  | 60 | 60 | add\_action('wp\_ajax\_wpms\_save\_sitemap\_settings', array($this, 'saveSitemapSettings')); |
  | 61 | 61 | add\_action('wp\_ajax\_wpms\_list\_posts\_category', array($this, 'listPostsCategory')); |
  | 62 | 62 | add\_action('wp\_update\_nav\_menu', array($this, 'wpUpdateNavMenu'), 10, 1); |
  | 63 | 63 | add\_action('wp\_update\_nav\_menu\_item', array($this, 'wpAddNavMenuItem'), 10, 3); |
  | 64 | 64 | add\_action('publish\_post', array($this, 'wpAutoAddPostInSitemap'), 10, 1); |
  | 65 | 65 | add\_action('wp\_ajax\_wpms\_sitemap\_check\_all\_category', array($this, 'checkAllCategoryInSitemap')); |
  | 66 | 66 | $this->disableDefaultWPSitemap(); |
  | 67 | 67 | } |
  | 68 | 68 |  |
  | 69 | 69 | /\*\* |
  | 70 | 70 | \*  Fires after a post item has been updated. |
  | 71 | 71 | \* |
  | 72 | 72 | \* @param integer $postId Post ID |
  | 73 | 73 | \* |
  | 74 | 74 | \* @return void |
  | 75 | 75 | \*/ |
  | 76 | 76 | public function wpAutoAddPostInSitemap($postId) |
  | 77 | 77 | { |
  | 78 | 78 | if (!(defined('REST\_REQUEST') && REST\_REQUEST)) { |
  | 79 | 79 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 80 | 80 | $category = get\_the\_category($postId); |
  | 81 | 81 | $is\_create\_sitemap = false; |
  | 82 | 82 | if (!empty($category)) { |
  | 83 | 83 | foreach ($category as $cat) { |
  | 84 | 84 | if (isset($settings['wpms\_category\_select\_all']) && isset($settings['wpms\_category\_link']) |
  | 85 | 85 | && in\_array($cat->cat\_ID, $settings['wpms\_category\_select\_all']) |
  | 86 | 86 | && in\_array($cat->cat\_ID, $settings['wpms\_category\_link']) |
  | 87 | 87 | ) { |
  | 88 | 88 | $is\_create\_sitemap = true; |
  | 89 | 89 | } |
  | 90 | 90 | } |
  | 91 | 91 | } |
  | 92 | 92 |  |
  | 93 | 93 | if (!empty($settings['wpms\_sitemap\_posts'])) { |
  | 94 | 94 | foreach ($settings['wpms\_sitemap\_posts'] as $post) { |
  | 95 | 95 | if ((int)$post['post\_id'] === $postId) { |
  | 96 | 96 | // Exist in sitemap |
  | 97 | 97 | $is\_create\_sitemap = false; |
  | 98 | 98 | } |
  | 99 | 99 | } |
  | 100 | 100 | } |
  | 101 | 101 |  |
  | 102 | 102 | if ($is\_create\_sitemap) { |
  | 103 | 103 | $settings['wpms\_sitemap\_posts'][$postId] = array( |
  | 104 | 104 | 'post\_id'   => $postId, |
  | 105 | 105 | 'priority'  => '1', |
  | 106 | 106 | 'frequency' => 'monthly' |
  | 107 | 107 | ); |
  | 108 | 108 |  |
  | 109 | 109 | update\_option('\_metaseo\_settings\_sitemap', $settings); |
  | 110 | 110 | $this->regenerateSitemaps('submit'); |
  | 111 | 111 | } |
  | 112 | 112 | } |
  | 113 | 113 | } |
  | 114 | 114 |  |
  | 115 | 115 | /\*\* |
  | 116 | 116 | \*  Fires after a navigation menu item has been updated. |
  | 117 | 117 | \* |
  | 118 | 118 | \* @param integer $menu\_id         Menu ID |
  | 119 | 119 | \* @param integer $menu\_item\_db\_id Menu item ID |
  | 120 | 120 | \* @param array   $args            Params |
  | 121 | 121 | \* |
  | 122 | 122 | \* @return void |
  | 123 | 123 | \*/ |
  | 124 | 124 | public function wpAddNavMenuItem($menu\_id, $menu\_item\_db\_id, $args) |
  | 125 | 125 | { |
  | 126 | 126 | $this->autoAddMenuItems($menu\_id); |
  | 127 | 127 | } |
  | 128 | 128 |  |
  | 129 | 129 | /\*\* |
  | 130 | 130 | \* This action is documented in wp-includes/nav-menu.php. |
  | 131 | 131 | \* |
  | 132 | 132 | \* @param integer $nav\_menu\_selected\_id Menu ID |
  | 133 | 133 | \* |
  | 134 | 134 | \* @return void |
  | 135 | 135 | \*/ |
  | 136 | 136 | public function wpUpdateNavMenu($nav\_menu\_selected\_id) |
  | 137 | 137 | { |
  | 138 | 138 | global $pagenow; |
  | 139 | 139 | if (isset($pagenow) && $pagenow === 'nav-menus.php') { |
  | 140 | 140 | $this->autoAddMenuItems($nav\_menu\_selected\_id); |
  | 141 | 141 | } |
  | 142 | 142 | } |
  | 143 | 143 |  |
  | 144 | 144 |  |
  | 145 | 145 | /\*\* |
  | 146 | 146 | \* Auto add menu items |
  | 147 | 147 | \* |
  | 148 | 148 | \* @param integer $nav\_menu\_selected\_id Menu ID |
  | 149 | 149 | \* |
  | 150 | 150 | \* @return void |
  | 151 | 151 | \*/ |
  | 152 | 152 | public function autoAddMenuItems($nav\_menu\_selected\_id) |
  | 153 | 153 | { |
  | 154 | 154 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 155 | 155 | if (isset($settings['check\_all\_menu\_items']) && in\_array($nav\_menu\_selected\_id, $settings['check\_all\_menu\_items'])) { |
  | 156 | 156 | $list\_submenu\_id = get\_objects\_in\_term($nav\_menu\_selected\_id, 'nav\_menu'); |
  | 157 | 157 | $args            = array( |
  | 158 | 158 | 'orderby'        => 'menu\_order', |
  | 159 | 159 | 'order'          => 'ASC', |
  | 160 | 160 | 'posts\_per\_page' => - 1, |
  | 161 | 161 | 'post\_type'      => 'nav\_menu\_item', |
  | 162 | 162 | 'post\_status'    => 'any', |
  | 163 | 163 | 'post\_\_in'       => $list\_submenu\_id, |
  | 164 | 164 | 'meta\_key'       => '\_menu\_item\_menu\_item\_parent', |
  | 165 | 165 | 'meta\_value'     => 0 |
  | 166 | 166 | ); |
  | 167 | 167 |  |
  | 168 | 168 | $query    = new WP\_Query($args); |
  | 169 | 169 | $submenus = $query->get\_posts(); |
  | 170 | 170 | foreach ($submenus as $menu) { |
  | 171 | 171 | if (empty($settings['wpms\_sitemap\_menus'][$menu->ID])) { |
  | 172 | 172 | $settings['wpms\_sitemap\_menus'][$menu->ID] = array( |
  | 173 | 173 | 'menu\_id'   => $menu->ID, |
  | 174 | 174 | 'priority'  => '1', |
  | 175 | 175 | 'frequency' => 'monthly' |
  | 176 | 176 | ); |
  | 177 | 177 | } |
  | 178 | 178 | } |
  | 179 | 179 |  |
  | 180 | 180 | update\_option('\_metaseo\_settings\_sitemap', $settings); |
  | 181 | 181 | $this->regenerateSitemaps('submit'); |
  | 182 | 182 | } |
  | 183 | 183 | } |
  | 184 | 184 |  |
  | 185 | 185 | /\*\* |
  | 186 | 186 | \* Get sitemap settings |
  | 187 | 187 | \* |
  | 188 | 188 | \* @return void |
  | 189 | 189 | \*/ |
  | 190 | 190 | public function getSitemapSettings() |
  | 191 | 191 | { |
  | 192 | 192 | $this->settings\_sitemap = array( |
  | 193 | 193 | 'wpms\_sitemap\_add'           => 1, |
  | 194 | 194 | 'wpms\_sitemap\_root'          => 1, |
  | 195 | 195 | 'wpms\_sitemap\_author'        => 0, |
  | 196 | 196 | 'wpms\_sitemap\_taxonomies'    => array(), |
  | 197 | 197 | 'wpms\_category\_link'         => array(), |
  | 198 | 198 | 'check\_all\_menu\_items'       => array(), |
  | 199 | 199 | 'wpms\_html\_sitemap\_page'     => 0, |
  | 200 | 200 | 'wpms\_html\_sitemap\_column'   => 1, |
  | 201 | 201 | 'wpms\_html\_sitemap\_theme'    => 'default', |
  | 202 | 202 | 'wpms\_html\_sitemap\_position' => 'after', |
  | 203 | 203 | 'wpms\_display\_column\_menus'  => array(0), |
  | 204 | 204 | 'wpms\_display\_column\_posts'  => 1, |
  | 205 | 205 | 'wpms\_display\_column\_pages'  => 1, |
  | 206 | 206 | 'wpms\_display\_order\_menus'   => 1, |
  | 207 | 207 | 'wpms\_display\_order\_posts'   => 2, |
  | 208 | 208 | 'wpms\_display\_order\_pages'   => 3, |
  | 209 | 209 | 'wpms\_display\_order\_urls'    => 4, |
  | 210 | 210 | 'wpms\_public\_name\_pages'     => '', |
  | 211 | 211 | 'wpms\_public\_name\_posts'     => '', |
  | 212 | 212 | 'wpms\_sitemap\_posts'         => array(), |
  | 213 | 213 | 'wpms\_sitemap\_pages'         => array(), |
  | 214 | 214 | 'wpms\_sitemap\_include\_lang'  => array(), |
  | 215 | 215 | 'wpms\_category\_select\_all'    => array(), |
  | 216 | 216 | 'wpms\_sitemap\_enable\_core'   => 0 |
  | 217 | 217 | ); |
  | 218 | 218 |  |
  | 219 | 219 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 220 | 220 | $this->settings\_sitemap['wpms\_sitemap\_customUrl']        = array(); |
  | 221 | 221 | $this->settings\_sitemap['wpms\_display\_column\_customUrl'] = 1; |
  | 222 | 222 | $this->settings\_sitemap['wpms\_public\_name\_customUrl']    = ''; |
  | 223 | 223 | $custom\_post\_types                                       = get\_post\_types( |
  | 224 | 224 | array( |
  | 225 | 225 | 'public'              => true, |
  | 226 | 226 | 'exclude\_from\_search' => false, |
  | 227 | 227 | '\_builtin'            => false |
  | 228 | 228 | ) |
  | 229 | 229 | ); |
  | 230 | 230 | if (!empty($custom\_post\_types)) { |
  | 231 | 231 | foreach ($custom\_post\_types as $post\_type => $label) { |
  | 232 | 232 | $this->settings\_sitemap['wpms\_display\_column\_' . $post\_type] = 1; |
  | 233 | 233 | $this->settings\_sitemap['wpms\_public\_name\_' . $post\_type]    = ''; |
  | 234 | 234 | $this->settings\_sitemap['wpms\_sitemap\_' . $post\_type]        = array(); |
  | 235 | 235 | } |
  | 236 | 236 | } |
  | 237 | 237 | } |
  | 238 | 238 |  |
  | 239 | 239 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 240 | 240 | if ((isset($settings['wpms\_sitemap\_pages']) && is\_object($settings['wpms\_sitemap\_pages'])) || (isset($settings['wpms\_sitemap\_posts']) && is\_object($settings['wpms\_sitemap\_posts'])) |
  | 241 | 241 | || (isset($settings['wpms\_sitemap\_menus']) && is\_object($settings['wpms\_sitemap\_menus']))) { |
  | 242 | 242 | $settings\_array = json\_decode(json\_encode($settings), true); |
  | 243 | 243 | update\_option('\_metaseo\_settings\_sitemap', $settings\_array); |
  | 244 | 244 | } |
  | 245 | 245 |  |
  | 246 | 246 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 247 | 247 | if (is\_array($settings)) { |
  | 248 | 248 | $this->settings\_sitemap = array\_merge($this->settings\_sitemap, $settings); |
  | 249 | 249 | } |
  | 250 | 250 | } |
  | 251 | 251 |  |
  | 252 | 252 | /\*\* |
  | 253 | 253 | \* Load metaseo script and style front-end |
  | 254 | 254 | \* |
  | 255 | 255 | \* @return void |
  | 256 | 256 | \*/ |
  | 257 | 257 | public function enqueueScripts() |
  | 258 | 258 | { |
  | 259 | 259 | global $post; |
  | 260 | 260 | if (empty($post)) { |
  | 261 | 261 | return; |
  | 262 | 262 | } |
  | 263 | 263 |  |
  | 264 | 264 | if (!empty($this->settings\_sitemap) && (int) $this->settings\_sitemap['wpms\_html\_sitemap\_page'] !== (int) $post->ID) { |
  | 265 | 265 | return; |
  | 266 | 266 | } |
  | 267 | 267 |  |
  | 268 | 268 | wp\_enqueue\_script( |
  | 269 | 269 | 'site-jPages-js', |
  | 270 | 270 | plugins\_url('assets/js/site-jPages.js', dirname(\_\_FILE\_\_)), |
  | 271 | 271 | array('jquery'), |
  | 272 | 272 | WPMSEO\_VERSION, |
  | 273 | 273 | true |
  | 274 | 274 | ); |
  | 275 | 275 | wp\_localize\_script( |
  | 276 | 276 | 'site-jPages-js', |
  | 277 | 277 | 'wpms\_avarible', |
  | 278 | 278 | $this->localizeScript() |
  | 279 | 279 | ); |
  | 280 | 280 | wp\_enqueue\_script( |
  | 281 | 281 | 'jpage-js', |
  | 282 | 282 | plugins\_url('assets/js/jPages.js', dirname(\_\_FILE\_\_)), |
  | 283 | 283 | array('jquery'), |
  | 284 | 284 | WPMSEO\_VERSION, |
  | 285 | 285 | true |
  | 286 | 286 | ); |
  | 287 | 287 | wp\_enqueue\_style( |
  | 288 | 288 | 'jpage-css', |
  | 289 | 289 | plugins\_url('assets/css/jPages.css', dirname(\_\_FILE\_\_)), |
  | 290 | 290 | array(), |
  | 291 | 291 | WPMSEO\_VERSION |
  | 292 | 292 | ); |
  | 293 | 293 | } |
  | 294 | 294 |  |
  | 295 | 295 | /\*\* |
  | 296 | 296 | \* Localize a script |
  | 297 | 297 | \* |
  | 298 | 298 | \* @return array |
  | 299 | 299 | \*/ |
  | 300 | 300 | public function localizeScript() |
  | 301 | 301 | { |
  | 302 | 302 | $custom\_post\_types = get\_post\_types( |
  | 303 | 303 | array( |
  | 304 | 304 | 'public'              => true, |
  | 305 | 305 | 'exclude\_from\_search' => false, |
  | 306 | 306 | '\_builtin'            => false |
  | 307 | 307 | ) |
  | 308 | 308 | ); |
  | 309 | 309 | $arrays            = array( |
  | 310 | 310 | 'wpms\_display\_column\_menus' => $this->settings\_sitemap['wpms\_display\_column\_menus'], |
  | 311 | 311 | 'post\_type'                 => $custom\_post\_types |
  | 312 | 312 | ); |
  | 313 | 313 | return $arrays; |
  | 314 | 314 | } |
  | 315 | 315 |  |
  | 316 | 316 | /\*\* |
  | 317 | 317 | \* Load metaseo script and style back-end |
  | 318 | 318 | \* |
  | 319 | 319 | \* @return void |
  | 320 | 320 | \*/ |
  | 321 | 321 | public function adminEnqueueScripts() |
  | 322 | 322 | { |
  | 323 | 323 | global $current\_screen; |
  | 324 | 324 | if (!empty($current\_screen) && $current\_screen->base !== 'wp-meta-seo\_page\_metaseo\_google\_sitemap') { |
  | 325 | 325 | return; |
  | 326 | 326 | } |
  | 327 | 327 |  |
  | 328 | 328 | $custom\_post\_types = get\_post\_types( |
  | 329 | 329 | array( |
  | 330 | 330 | 'public'              => true, |
  | 331 | 331 | 'exclude\_from\_search' => false, |
  | 332 | 332 | '\_builtin'            => false |
  | 333 | 333 | ) |
  | 334 | 334 | ); |
  | 335 | 335 |  |
  | 336 | 336 | wp\_enqueue\_script( |
  | 337 | 337 | 'metaseositemap', |
  | 338 | 338 | plugins\_url('assets/js/metaseo\_sitemap.js', dirname(\_\_FILE\_\_)), |
  | 339 | 339 | array('jquery'), |
  | 340 | 340 | WPMSEO\_VERSION, |
  | 341 | 341 | true |
  | 342 | 342 | ); |
  | 343 | 343 | wp\_localize\_script( |
  | 344 | 344 | 'metaseositemap', |
  | 345 | 345 | 'wpmseositemap', |
  | 346 | 346 | array( |
  | 347 | 347 | 'post\_type' => $custom\_post\_types |
  | 348 | 348 | ) |
  | 349 | 349 | ); |
  | 350 | 350 | wp\_enqueue\_script( |
  | 351 | 351 | 'jpage-js', |
  | 352 | 352 | plugins\_url('assets/js/jPages.js', dirname(\_\_FILE\_\_)), |
  | 353 | 353 | array('jquery'), |
  | 354 | 354 | WPMSEO\_VERSION, |
  | 355 | 355 | true |
  | 356 | 356 | ); |
  | 357 | 357 | wp\_enqueue\_style( |
  | 358 | 358 | 'metaseositemapstyle', |
  | 359 | 359 | plugins\_url('assets/css/metaseo\_sitemap.css', dirname(\_\_FILE\_\_)), |
  | 360 | 360 | array(), |
  | 361 | 361 | WPMSEO\_VERSION |
  | 362 | 362 | ); |
  | 363 | 363 | wp\_enqueue\_style( |
  | 364 | 364 | 'jpage-css', |
  | 365 | 365 | plugins\_url('assets/css/jPages.css', dirname(\_\_FILE\_\_)), |
  | 366 | 366 | array(), |
  | 367 | 367 | WPMSEO\_VERSION |
  | 368 | 368 | ); |
  | 369 | 369 | wp\_enqueue\_style( |
  | 370 | 370 | 'wpms-tippy-style', |
  | 371 | 371 | plugins\_url('assets/tippy/tippy.css', WPMSEO\_FILE), |
  | 372 | 372 | array(), |
  | 373 | 373 | WPMSEO\_VERSION |
  | 374 | 374 | ); |
  | 375 | 375 | wp\_enqueue\_script( |
  | 376 | 376 | 'wpms-tippy-core', |
  | 377 | 377 | plugins\_url('assets/tippy/tippy-core.js', WPMSEO\_FILE), |
  | 378 | 378 | array('jquery'), |
  | 379 | 379 | '2.2.1', |
  | 380 | 380 | true |
  | 381 | 381 | ); |
  | 382 | 382 | wp\_enqueue\_script( |
  | 383 | 383 | 'wpms-tippy', |
  | 384 | 384 | plugins\_url('assets/tippy/tippy.js', WPMSEO\_FILE), |
  | 385 | 385 | array('jquery'), |
  | 386 | 386 | '2.2.1', |
  | 387 | 387 | true |
  | 388 | 388 | ); |
  | 389 | 389 | } |
  | 390 | 390 |  |
  | 391 | 391 | /\*\* |
  | 392 | 392 | \* Display field sitemap link |
  | 393 | 393 | \* |
  | 394 | 394 | \* @return void |
  | 395 | 395 | \*/ |
  | 396 | 396 | public function sitemapLink() |
  | 397 | 397 | { |
  | 398 | 398 | echo '<input id="wpms\_check\_firstsave" name="\_metaseo\_settings\_sitemap[wpms\_check\_firstsave]" |
  | 399 | 399 | type="hidden" value="1">'; |
  | 400 | 400 | if (is\_multisite()) { |
  | 401 | 401 | $home\_url = preg\_replace( |
  | 402 | 402 | '/[^a-zA-ZА-Яа-я0-9\s]/', |
  | 403 | 403 | '\_', |
  | 404 | 404 | str\_replace('http://', '', str\_replace('https://', '', site\_url())) |
  | 405 | 405 | ); |
  | 406 | 406 | $value = ABSPATH . '/sitemap\_' . $home\_url . '.xml'; |
  | 407 | 407 | $link = network\_home\_url('', 'relative') . 'sitemap\_' . $home\_url . '.xml'; |
  | 408 | 408 | } else { |
  | 409 | 409 | $value = ABSPATH . '/' . $this->wpms\_sitemap\_name; |
  | 410 | 410 | global $sitepress; |
  | 411 | 411 | if ($sitepress && !empty($this->settings\_sitemap['wpms\_sitemap\_include\_lang'])) { |
  | 412 | 412 | $langs = implode('-', $this->settings\_sitemap['wpms\_sitemap\_include\_lang']); |
  | 413 | 413 | $sitemap\_xml\_name = 'wpms-sitemap-'.$langs .'.xml'; |
  | 414 | 414 | $link = home\_url() . '/' . $sitemap\_xml\_name; |
  | 415 | 415 | } else { |
  | 416 | 416 | $link = home\_url() . '/' . $this->wpms\_sitemap\_name; |
  | 417 | 417 | } |
  | 418 | 418 | } |
  | 419 | 419 |  |
  | 420 | 420 | $refresh\_install = false; |
  | 421 | 421 | // Refresh install |
  | 422 | 422 | if (!file\_exists($value)) { |
  | 423 | 423 | $refresh\_install = true; |
  | 424 | 424 | } |
  | 425 | 425 |  |
  | 426 | 426 | echo '<input readonly id="wpms\_sitemap\_link" name="\_metaseo\_settings\_sitemap[wpms\_sitemap\_link]" |
  | 427 | 427 | type="text" value="' . esc\_attr($link) . '" size="50" class="wpms-large-input wpms-no-margin wpms\_width\_90 '.($refresh\_install ? 'wpms-sitemap-xml-link-input' : '').'" />'; |
  | 428 | 428 | echo '<a class="wpms-open-xml-sitemap ju-button orange-button waves-effect waves-light wpms-small-btn '.(($refresh\_install) ? 'wpms-sitemap-xml-link-button' : '').'" href="' . esc\_url($link) . '" target="\_blank">' . (($refresh\_install) ? esc\_html\_\_('Generate and Open', 'wp-meta-seo') : esc\_html\_\_('Open', 'wp-meta-seo')) . '</a>'; |
  | 429 | 429 | } |
  | 430 | 430 |  |
  | 431 | 431 | /\*\* |
  | 432 | 432 | \* Display field sitemap lang |
  | 433 | 433 | \* |
  | 434 | 434 | \* @return void |
  | 435 | 435 | \*/ |
  | 436 | 436 | public function sitemapIncludeLanguages() |
  | 437 | 437 | { |
  | 438 | 438 | $lang    = $this->settings\_sitemap['wpms\_sitemap\_include\_lang']; |
  | 439 | 439 | $sl\_lang = apply\_filters('wpms\_get\_languagesList', '', $lang, 'multiple'); |
  | 440 | 440 | // phpcs:ignore WordPress.Security.EscapeOutput -- Content escaped in the method MetaSeoAddonAdmin::listLanguageSelect |
  | 441 | 441 | echo $sl\_lang; |
  | 442 | 442 | } |
  | 443 | 443 |  |
  | 444 | 444 | /\*\* |
  | 445 | 445 | \* Display field sitemap link check |
  | 446 | 446 | \* |
  | 447 | 447 | \* @return void |
  | 448 | 448 | \*/ |
  | 449 | 449 | public function checkLink() |
  | 450 | 450 | { |
  | 451 | 451 | ?> |
  | 452 | 452 | <a href="#links-check-list" title="<?php esc\_attr\_e('Sitemap links', 'wp-meta-seo') ?>" |
  | 453 | 453 | class="ju-button orange-button wpms-small-btn wpms\_run\_linkcheck m-t-5" |
  | 454 | 454 | ><?php esc\_html\_e('Run a link check', 'wp-meta-seo') ?></a> |
  | 455 | 455 | <?php |
  | 456 | 456 | } |
  | 457 | 457 |  |
  | 458 | 458 | /\*\* |
  | 459 | 459 | \* Display field sitemap author |
  | 460 | 460 | \* |
  | 461 | 461 | \* @return void |
  | 462 | 462 | \*/ |
  | 463 | 463 | public function sitemapAuthor() |
  | 464 | 464 | { |
  | 465 | 465 | ?> |
  | 466 | 466 | <input id="wpms\_sitemap\_author" type="checkbox" name="\_metaseo\_settings\_sitemap[wpms\_sitemap\_author]" |
  | 467 | 467 | value="1" <?php checked(1, $this->settings\_sitemap['wpms\_sitemap\_author']); ?>> |
  | 468 | 468 | <?php |
  | 469 | 469 | } |
  | 470 | 470 |  |
  | 471 | 471 | /\*\* |
  | 472 | 472 | \* Display field sitemap taxonomies |
  | 473 | 473 | \* |
  | 474 | 474 | \* @return void |
  | 475 | 475 | \*/ |
  | 476 | 476 | public function sitemapTaxonomies() |
  | 477 | 477 | { |
  | 478 | 478 | $wpms\_taxonomies = array( |
  | 479 | 479 | 'category' => 'Post category', |
  | 480 | 480 | 'post\_tag' => 'Post tag' |
  | 481 | 481 | ); |
  | 482 | 482 | foreach ($wpms\_taxonomies as $key => $value) { |
  | 483 | 483 | ?> |
  | 484 | 484 | <div class="pure-checkbox wpms\_left wpms\_width\_50"> |
  | 485 | 485 | <?php if (in\_array($key, $this->settings\_sitemap['wpms\_sitemap\_taxonomies'])) : ?> |
  | 486 | 486 | <input title class="wpms\_sitemap\_taxonomies" |
  | 487 | 487 | id="<?php echo esc\_attr('wpms\_sitemap\_taxonomies\_' . $key); ?>" |
  | 488 | 488 | type="checkbox" |
  | 489 | 489 | name="\_metaseo\_settings\_sitemap[wpms\_sitemap\_taxonomies][]" |
  | 490 | 490 | value="<?php echo esc\_attr($key) ?>" checked> |
  | 491 | 491 | <?php else : ?> |
  | 492 | 492 | <input title class="wpms\_sitemap\_taxonomies" |
  | 493 | 493 | id="<?php echo esc\_attr('wpms\_sitemap\_taxonomies\_' . $key); ?>" |
  | 494 | 494 | type="checkbox" |
  | 495 | 495 | name="\_metaseo\_settings\_sitemap[wpms\_sitemap\_taxonomies][]" |
  | 496 | 496 | value="<?php echo esc\_attr($key) ?>"> |
  | 497 | 497 | <?php endif; ?> |
  | 498 | 498 | <label class="wpms-text" |
  | 499 | 499 | for="<?php echo esc\_attr('wpms\_sitemap\_taxonomies\_' . $key); ?>"><?php echo esc\_html($value) ?></label> |
  | 500 | 500 | </div> |
  | 501 | 501 | <?php |
  | 502 | 502 | } |
  | 503 | 503 | } |
  | 504 | 504 |  |
  | 505 | 505 | /\*\* |
  | 506 | 506 | \* Display field sitemap list page |
  | 507 | 507 | \* |
  | 508 | 508 | \* @return void |
  | 509 | 509 | \*/ |
  | 510 | 510 | public function sitemapPage() |
  | 511 | 511 | { |
  | 512 | 512 | global $wpdb; |
  | 513 | 513 | $pages        = get\_pages(); |
  | 514 | 514 | $sitemap\_page = $wpdb->get\_row($wpdb->prepare( |
  | 515 | 515 | 'SELECT \* FROM ' . $wpdb->prefix . 'posts WHERE post\_title = %s AND post\_excerpt = %s AND post\_type = %s', |
  | 516 | 516 | array( |
  | 517 | 517 | 'WPMS HTML Sitemap', |
  | 518 | 518 | 'metaseo\_html\_sitemap', |
  | 519 | 519 | 'page' |
  | 520 | 520 | ) |
  | 521 | 521 | )); |
  | 522 | 522 |  |
  | 523 | 523 | if (empty($this->settings\_sitemap['wpms\_html\_sitemap\_page']) && !empty($sitemap\_page)) { |
  | 524 | 524 | $this->settings\_sitemap['wpms\_html\_sitemap\_page'] = $sitemap\_page->ID; |
  | 525 | 525 | } |
  | 526 | 526 | ?> |
  | 527 | 527 | <select id="wpms\_html\_sitemap\_page" name="\_metaseo\_settings\_sitemap[wpms\_html\_sitemap\_page]" |
  | 528 | 528 | class="wpms-large-input wpms\_width\_90"> |
  | 529 | 529 | <option value="0"><?php esc\_html\_e('- Choose Your Sitemap Page -', 'wp-meta-seo') ?></option> |
  | 530 | 530 | <?php |
  | 531 | 531 | foreach ($pages as $page) { |
  | 532 | 532 | if ((int) $this->settings\_sitemap['wpms\_html\_sitemap\_page'] === (int) $page->ID) { |
  | 533 | 533 | echo '<option selected value="' . esc\_attr($page->ID) . '">' . esc\_html($page->post\_title) . '</option>'; |
  | 534 | 534 | } else { |
  | 535 | 535 | echo '<option value="' . esc\_attr($page->ID) . '">' . esc\_html($page->post\_title) . '</option>'; |
  | 536 | 536 | } |
  | 537 | 537 | } |
  | 538 | 538 | ?> |
  | 539 | 539 | </select> |
  | 540 | 540 | <?php |
  | 541 | 541 | if (!empty($this->settings\_sitemap['wpms\_html\_sitemap\_page'])) { |
  | 542 | 542 | echo '<a class="ju-button orange-button waves-effect waves-light wpms-open-html-sitemap wpms-no-margin wpms-small-btn" href="' . esc\_url(get\_post\_permalink($this->settings\_sitemap['wpms\_html\_sitemap\_page'])) . '" |
  | 543 | 543 | target="\_blank">' . esc\_html\_\_('Open', 'wp-meta-seo') . '</a>'; |
  | 544 | 544 | } |
  | 545 | 545 | ?> |
  | 546 | 546 | <?php |
  | 547 | 547 | } |
  | 548 | 548 |  |
  | 549 | 549 | /\*\* |
  | 550 | 550 | \* Display field sitemap column |
  | 551 | 551 | \* |
  | 552 | 552 | \* @return void |
  | 553 | 553 | \*/ |
  | 554 | 554 | public function sitemapColumn() |
  | 555 | 555 | { |
  | 556 | 556 | ?> |
  | 557 | 557 | <label> |
  | 558 | 558 | <select id="wpms\_html\_sitemap\_column" name="\_metaseo\_settings\_sitemap[wpms\_html\_sitemap\_column]" |
  | 559 | 559 | class="wpms-large-input wpms\_width\_100"> |
  | 560 | 560 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_column'], 1) ?> |
  | 561 | 561 | value="1"><?php esc\_html\_e('1 column', 'wp-meta-seo') ?></option> |
  | 562 | 562 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_column'], 2) ?> |
  | 563 | 563 | value="2"><?php esc\_html\_e('2 columns', 'wp-meta-seo') ?></option> |
  | 564 | 564 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_column'], 3) ?> |
  | 565 | 565 | value="3"><?php esc\_html\_e('3 columns', 'wp-meta-seo') ?></option> |
  | 566 | 566 | </select> |
  | 567 | 567 | </label> |
  | 568 | 568 | <?php |
  | 569 | 569 | } |
  | 570 | 570 |  |
  | 571 | 571 | /\*\* |
  | 572 | 572 | \* Display field sitemap position |
  | 573 | 573 | \* |
  | 574 | 574 | \* @return void |
  | 575 | 575 | \*/ |
  | 576 | 576 | public function sitemapTheme() |
  | 577 | 577 | { |
  | 578 | 578 | ?> |
  | 579 | 579 | <label> |
  | 580 | 580 | <select id="wpms\_html\_sitemap\_theme" name="\_metaseo\_settings\_sitemap[wpms\_html\_sitemap\_theme]" |
  | 581 | 581 | class="wpms-large-input wpms\_width\_100"> |
  | 582 | 582 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_theme'], 'default') ?> |
  | 583 | 583 | value="default"><?php esc\_html\_e('Simple list', 'wp-meta-seo') ?></option> |
  | 584 | 584 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_theme'], 'accordions') ?> |
  | 585 | 585 | value="accordions"><?php esc\_html\_e('List with accordions', 'wp-meta-seo') ?></option> |
  | 586 | 586 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_theme'], 'tab') ?> |
  | 587 | 587 | value="tab"><?php esc\_html\_e('Tab layout', 'wp-meta-seo') ?></option> |
  | 588 | 588 | </select> |
  | 589 | 589 | </label> |
  | 590 | 590 | <?php |
  | 591 | 591 | } |
  | 592 | 592 |  |
  | 593 | 593 | /\*\* |
  | 594 | 594 | \* Display field sitemap position |
  | 595 | 595 | \* |
  | 596 | 596 | \* @return void |
  | 597 | 597 | \*/ |
  | 598 | 598 | public function sitemapPosition() |
  | 599 | 599 | { |
  | 600 | 600 | ?> |
  | 601 | 601 | <select id="wpms\_html\_sitemap\_position" name="\_metaseo\_settings\_sitemap[wpms\_html\_sitemap\_position]" |
  | 602 | 602 | class="wpms-large-input wpms\_width\_100"> |
  | 603 | 603 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_position'], 'replace') ?> |
  | 604 | 604 | value="replace"><?php esc\_html\_e('Replace the Page Content', 'wp-meta-seo') ?></option> |
  | 605 | 605 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_position'], 'before') ?> |
  | 606 | 606 | value="before"><?php esc\_html\_e('Before Page Content', 'wp-meta-seo') ?></option> |
  | 607 | 607 | <option <?php selected($this->settings\_sitemap['wpms\_html\_sitemap\_position'], 'after') ?> |
  | 608 | 608 | value="after"><?php esc\_html\_e('After Page Content', 'wp-meta-seo') ?></option> |
  | 609 | 609 | </select> |
  | 610 | 610 | <?php |
  | 611 | 611 | } |
  | 612 | 612 |  |
  | 613 | 613 | /\*\* |
  | 614 | 614 | \* Get info of sitemap file xml |
  | 615 | 615 | \* |
  | 616 | 616 | \* @return array |
  | 617 | 617 | \*/ |
  | 618 | 618 | public function getPathSitemapFile() |
  | 619 | 619 | { |
  | 620 | 620 | if (is\_multisite()) { |
  | 621 | 621 | $home\_url = preg\_replace( |
  | 622 | 622 | '/[^a-zA-ZА-Яа-я0-9\s]/', |
  | 623 | 623 | '\_', |
  | 624 | 624 | str\_replace('http://', '', str\_replace('https://', '', site\_url())) |
  | 625 | 625 | ); |
  | 626 | 626 | $xml\_file = 'wpms-sitemap\_' . $home\_url . '.xml'; |
  | 627 | 627 | } else { |
  | 628 | 628 | $xml\_file = $this->wpms\_sitemap\_name; |
  | 629 | 629 | } |
  | 630 | 630 | $xml\_path = ABSPATH . $xml\_file; |
  | 631 | 631 | return array('path' => $xml\_path, 'name' => $xml\_file); |
  | 632 | 632 | } |
  | 633 | 633 |  |
  | 634 | 634 | /\*\* |
  | 635 | 635 | \* Check external link |
  | 636 | 636 | \* |
  | 637 | 637 | \* @param string $link Link to check |
  | 638 | 638 | \* |
  | 639 | 639 | \* @return boolean |
  | 640 | 640 | \*/ |
  | 641 | 641 | public function checkExternalLink($link) |
  | 642 | 642 | { |
  | 643 | 643 | if (empty($link)) { |
  | 644 | 644 | return true; |
  | 645 | 645 | } |
  | 646 | 646 |  |
  | 647 | 647 | $parseLink = parse\_url($link); |
  | 648 | 648 |  |
  | 649 | 649 | if (empty($parseLink['host'])) { |
  | 650 | 650 | // Maybe is an internal link |
  | 651 | 651 | return false; |
  | 652 | 652 | } |
  | 653 | 653 | global $sitepress; |
  | 654 | 654 | if ($sitepress || $parseLink['host'] === $\_SERVER['HTTP\_HOST']) { |
  | 655 | 655 | // Is an internal link |
  | 656 | 656 | return false; |
  | 657 | 657 | } |
  | 658 | 658 |  |
  | 659 | 659 | return true; |
  | 660 | 660 | } |
  | 661 | 661 |  |
  | 662 | 662 | /\*\* |
  | 663 | 663 | \* Check custom link |
  | 664 | 664 | \* |
  | 665 | 665 | \* @param string $link Link to check |
  | 666 | 666 | \* |
  | 667 | 667 | \* @return string |
  | 668 | 668 | \*/ |
  | 669 | 669 | public function customLink($link) |
  | 670 | 670 | { |
  | 671 | 671 | if (empty($link)) { |
  | 672 | 672 | return $link; |
  | 673 | 673 | } |
  | 674 | 674 |  |
  | 675 | 675 | if (preg\_match('#http(s?)://#i', $link)) { |
  | 676 | 676 | return $link; |
  | 677 | 677 | } |
  | 678 | 678 |  |
  | 679 | 679 | $parseHome = parse\_url(home\_url()); |
  | 680 | 680 |  |
  | 681 | 681 | $http = (is\_ssl()) ? 'https:' : 'http:'; |
  | 682 | 682 | $host = (!empty($parseHome['host']) ? $parseHome['host'] : ''); |
  | 683 | 683 | $host .= (!empty($parseHome['path']) ? $parseHome['path'] : ''); |
  | 684 | 684 |  |
  | 685 | 685 | if (substr($link, 0, 2) === '//') { |
  | 686 | 686 | return $http . $link; |
  | 687 | 687 | } |
  | 688 | 688 |  |
  | 689 | 689 | // Force the path become relative. |
  | 690 | 690 | if (substr($link, 0, 1) === '/') { |
  | 691 | 691 | if (!empty($host)) { |
  | 692 | 692 | return $http . '//' . $host . $link; |
  | 693 | 693 | } |
  | 694 | 694 | } |
  | 695 | 695 |  |
  | 696 | 696 | return $link; |
  | 697 | 697 | } |
  | 698 | 698 |  |
  | 699 | 699 | /\*\* |
  | 700 | 700 | \* Create sitemap |
  | 701 | 701 | \* |
  | 702 | 702 | \* @param string $sitemap\_xml\_name Sitemap file name |
  | 703 | 703 | \* |
  | 704 | 704 | \* @return void |
  | 705 | 705 | \*/ |
  | 706 | 706 | public function createSitemap($sitemap\_xml\_name) |
  | 707 | 707 | { |
  | 708 | 708 | global $wpdb, $sitepress; |
  | 709 | 709 | $taxonomies = array(); |
  | 710 | 710 | $list\_links = array(); |
  | 711 | 711 | foreach ($this->settings\_sitemap['wpms\_sitemap\_taxonomies'] as $val) { |
  | 712 | 712 | $taxonomies[] = $val; |
  | 713 | 713 | } |
  | 714 | 714 |  |
  | 715 | 715 | $xml                 = new DomDocument('1.0', 'utf-8'); |
  | 716 | 716 | $xml\_stylesheet\_path = content\_url(); |
  | 717 | 717 | if (defined('WP\_PLUGIN\_DIR')) { |
  | 718 | 718 | $xml\_stylesheet\_path .= '/' . basename(WP\_PLUGIN\_DIR) . '/wp-meta-seo/wpms-sitemap.xsl'; |
  | 719 | 719 | } else { |
  | 720 | 720 | $xml\_stylesheet\_path .= '/plugins/wp-meta-seo/sitemap.xsl'; |
  | 721 | 721 | } |
  | 722 | 722 |  |
  | 723 | 723 | $xslt = $xml->createProcessingInstruction('xml-stylesheet', 'type="text/xsl" href="' . $xml\_stylesheet\_path . '"'); |
  | 724 | 724 | $xml->appendChild($xslt); |
  | 725 | 725 | $gglstmp\_urlset = $xml->appendChild( |
  | 726 | 726 | $xml->createElementNS( |
  | 727 | 727 | 'http://www.sitemaps.org/schemas/sitemap/0.9', |
  | 728 | 728 | 'urlset' |
  | 729 | 729 | ) |
  | 730 | 730 | ); |
  | 731 | 731 | $gglstmp\_urlset->setAttribute('xmlns:xhtml', 'http://www.w3.org/1999/xhtml'); |
  | 732 | 732 | /\* add home page \*/ |
  | 733 | 733 | $home\_url = home\_url('/'); |
  | 734 | 734 | if ($sitepress && !empty($this->settings\_sitemap['wpms\_sitemap\_include\_lang'])) { |
  | 735 | 735 | $domains = $sitepress->get\_setting('language\_domains'); |
  | 736 | 736 | $default\_language = $sitepress->get\_default\_language(); |
  | 737 | 737 | $wpms\_lang = $this->settings\_sitemap['wpms\_sitemap\_include\_lang'][0]; |
  | 738 | 738 | if ($wpms\_lang !== $default\_language) { |
  | 739 | 739 | $home\_schema      = wpml\_parse\_url($home\_url, PHP\_URL\_SCHEME) . '://'; |
  | 740 | 740 | $home\_url = $home\_schema . $domains[$wpms\_lang]; |
  | 741 | 741 | } |
  | 742 | 742 | } |
  | 743 | 743 | $list\_links[] = $home\_url; |
  | 744 | 744 | $url          = $gglstmp\_urlset->appendChild($xml->createElement('url')); |
  | 745 | 745 | $loc          = $url->appendChild($xml->createElement('loc')); |
  | 746 | 746 | $loc->appendChild($xml->createTextNode($home\_url)); |
  | 747 | 747 | $lastmod = $url->appendChild($xml->createElement('lastmod')); |
  | 748 | 748 | $lastmod->appendChild($xml->createTextNode(date('Y-m-d\TH:i:sP', time()))); |
  | 749 | 749 | $changefreq = $url->appendChild($xml->createElement('changefreq')); |
  | 750 | 750 | $changefreq->appendChild($xml->createTextNode('monthly')); |
  | 751 | 751 | $priority = $url->appendChild($xml->createElement('priority')); |
  | 752 | 752 | $priority->appendChild($xml->createTextNode(1.0)); |
  | 753 | 753 |  |
  | 754 | 754 | // add menus post custom |
  | 755 | 755 | $menus = $this->getAllMenus(); |
  | 756 | 756 | $res   = $menus['posts\_custom']; |
  | 757 | 757 | if (!empty($res)) { |
  | 758 | 758 | foreach ($res as $val) { |
  | 759 | 759 | $menu\_object = $wpdb->get\_results($wpdb->prepare( |
  | 760 | 760 | 'SELECT post\_id FROM ' . $wpdb->postmeta . ' WHERE meta\_key=%s AND meta\_value=%d', |
  | 761 | 761 | array('\_menu\_item\_object\_id', $val->ID) |
  | 762 | 762 | )); |
  | 763 | 763 | if (!empty($menu\_object)) { |
  | 764 | 764 | foreach ($menu\_object as $menu) { |
  | 765 | 765 | $id         = $menu->post\_id; |
  | 766 | 766 | $type       = get\_post\_meta($id, '\_menu\_item\_type', true); |
  | 767 | 767 | $check\_type = get\_post\_meta($id, '\_menu\_item\_object', true); |
  | 768 | 768 | $permalink  = $this->getPermalinkSitemap($check\_type, $val->ID); |
  | 769 | 769 | if ($permalink !== '#') { |
  | 770 | 770 | if (strpos($permalink, '#') !== false) { |
  | 771 | 771 | // Check anchor links |
  | 772 | 772 | $permalink = strstr($permalink, '#', true); |
  | 773 | 773 | } |
  | 774 | 774 |  |
  | 775 | 775 | // Filter full link with custom link |
  | 776 | 776 | $permalink = $this->customLink($permalink); |
  | 777 | 777 |  |
  | 778 | 778 | // Check to exclude external link |
  | 779 | 779 | if ($this->checkExternalLink($permalink)) { |
  | 780 | 780 | continue; |
  | 781 | 781 | } |
  | 782 | 782 |  |
  | 783 | 783 | if (!in\_array($permalink, $list\_links)) { |
  | 784 | 784 | $list\_links[] = $permalink; |
  | 785 | 785 | if ($type !== 'taxonomy') { |
  | 786 | 786 | $gglstmp\_url = $gglstmp\_urlset->appendChild($xml->createElement('url')); |
  | 787 | 787 | $loc         = $gglstmp\_url->appendChild($xml->createElement('loc')); |
  | 788 | 788 | $loc->appendChild($xml->createTextNode($permalink)); |
  | 789 | 789 | $lastmod = $gglstmp\_url->appendChild($xml->createElement('lastmod')); |
  | 790 | 790 | $now     = $val->post\_modified; |
  | 791 | 791 | $date    = date('Y-m-d\TH:i:sP', strtotime($now)); |
  | 792 | 792 | $lastmod->appendChild($xml->createTextNode($date)); |
  | 793 | 793 | $changefreq = $gglstmp\_url->appendChild($xml->createElement('changefreq')); |
  | 794 | 794 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 795 | 795 | $changefreq->appendChild($xml->createTextNode('monthly')); |
  | 796 | 796 | } else { |
  | 797 | 797 | if (empty($this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['frequency'])) { |
  | 798 | 798 | $this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['frequency'] = 'monthly'; |
  | 799 | 799 | } |
  | 800 | 800 | $changefreq->appendChild( |
  | 801 | 801 | $xml->createTextNode( |
  | 802 | 802 | $this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['frequency'] |
  | 803 | 803 | ) |
  | 804 | 804 | ); |
  | 805 | 805 | } |
  | 806 | 806 |  |
  | 807 | 807 | $priority = $gglstmp\_url->appendChild($xml->createElement('priority')); |
  | 808 | 808 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 809 | 809 | $priority->appendChild($xml->createTextNode('1.0')); |
  | 810 | 810 | } else { |
  | 811 | 811 | if (empty($this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['priority'])) { |
  | 812 | 812 | $this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['priority'] = '1.0'; |
  | 813 | 813 | } |
  | 814 | 814 | $priority->appendChild( |
  | 815 | 815 | $xml->createTextNode( |
  | 816 | 816 | $this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['priority'] |
  | 817 | 817 | ) |
  | 818 | 818 | ); |
  | 819 | 819 | } |
  | 820 | 820 |  |
  | 821 | 821 | $this->createXmlLang( |
  | 822 | 822 | $xml, |
  | 823 | 823 | $id, |
  | 824 | 824 | 'post\_post', |
  | 825 | 825 | $loc |
  | 826 | 826 | ); |
  | 827 | 827 | } |
  | 828 | 828 | } |
  | 829 | 829 | } |
  | 830 | 830 | } |
  | 831 | 831 | } |
  | 832 | 832 | } |
  | 833 | 833 | } |
  | 834 | 834 |  |
  | 835 | 835 | // add menus category |
  | 836 | 836 | $res = $menus['categories']; |
  | 837 | 837 | if (!empty($res)) { |
  | 838 | 838 | foreach ($res as $k => $val) { |
  | 839 | 839 | $menu\_object = $wpdb->get\_results($wpdb->prepare( |
  | 840 | 840 | 'SELECT post\_id FROM ' . $wpdb->postmeta . ' WHERE meta\_key=%s AND meta\_value=%d', |
  | 841 | 841 | array( |
  | 842 | 842 | '\_menu\_item\_object\_id', |
  | 843 | 843 | $val |
  | 844 | 844 | ) |
  | 845 | 845 | )); |
  | 846 | 846 | if (!empty($menu\_object)) { |
  | 847 | 847 | foreach ($menu\_object as $menu) { |
  | 848 | 848 | $id         = $menu->post\_id; |
  | 849 | 849 | $type       = get\_post\_meta($id, '\_menu\_item\_type', true); |
  | 850 | 850 | $check\_type = get\_post\_meta($id, '\_menu\_item\_object', true); |
  | 851 | 851 | $permalink  = get\_term\_link((int) $val, $check\_type); |
  | 852 | 852 | if (empty($permalink)) { |
  | 853 | 853 | $permalink = get\_permalink($id); |
  | 854 | 854 | } |
  | 855 | 855 | if (strpos($permalink, '#') !== false) { |
  | 856 | 856 | // Check anchor links |
  | 857 | 857 | $permalink = strstr($permalink, '#', true); |
  | 858 | 858 | } |
  | 859 | 859 |  |
  | 860 | 860 | // Filter full link with custom link |
  | 861 | 861 | $permalink = $this->customLink($permalink); |
  | 862 | 862 |  |
  | 863 | 863 | // Check to exclude external link |
  | 864 | 864 | if ($this->checkExternalLink($permalink)) { |
  | 865 | 865 | continue; |
  | 866 | 866 | } |
  | 867 | 867 |  |
  | 868 | 868 | if (!in\_array($permalink, $list\_links)) { |
  | 869 | 869 | $list\_links[] = $permalink; |
  | 870 | 870 | if ($type === 'taxonomy') { |
  | 871 | 871 | $gglstmp\_url = $gglstmp\_urlset->appendChild($xml->createElement('url')); |
  | 872 | 872 | $loc         = $gglstmp\_url->appendChild($xml->createElement('loc')); |
  | 873 | 873 | $loc->appendChild($xml->createTextNode($permalink)); |
  | 874 | 874 | $lastmod = $gglstmp\_url->appendChild($xml->createElement('lastmod')); |
  | 875 | 875 | $ps      = get\_post($id); |
  | 876 | 876 |  |
  | 877 | 877 | if (!empty($ps)) { |
  | 878 | 878 | $now  = $ps->post\_modified; |
  | 879 | 879 | $date = date('Y-m-d\TH:i:sP', strtotime($now)); |
  | 880 | 880 | $lastmod->appendChild($xml->createTextNode($date)); |
  | 881 | 881 | } |
  | 882 | 882 |  |
  | 883 | 883 | $changefreq = $gglstmp\_url->appendChild($xml->createElement('changefreq')); |
  | 884 | 884 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 885 | 885 | $changefreq->appendChild($xml->createTextNode('monthly')); |
  | 886 | 886 | } else { |
  | 887 | 887 | if (empty($this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['frequency'])) { |
  | 888 | 888 | $menufre = 'monthly'; |
  | 889 | 889 | } else { |
  | 890 | 890 | $menufre = $this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['frequency']; |
  | 891 | 891 | } |
  | 892 | 892 | $changefreq->appendChild($xml->createTextNode($menufre)); |
  | 893 | 893 | } |
  | 894 | 894 |  |
  | 895 | 895 | $priority = $gglstmp\_url->appendChild($xml->createElement('priority')); |
  | 896 | 896 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 897 | 897 | $priority->appendChild($xml->createTextNode('1.0')); |
  | 898 | 898 | } else { |
  | 899 | 899 | if (empty($this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['priority'])) { |
  | 900 | 900 | $menupriority = '1.0'; |
  | 901 | 901 | } else { |
  | 902 | 902 | $menupriority = $this->settings\_sitemap['wpms\_sitemap\_menus'][$id]['priority']; |
  | 903 | 903 | } |
  | 904 | 904 | $priority->appendChild($xml->createTextNode($menupriority)); |
  | 905 | 905 | } |
  | 906 | 906 | $this->createXmlLang($xml, $id, 'post\_post', $loc); |
  | 907 | 907 | } |
  | 908 | 908 | } |
  | 909 | 909 | } |
  | 910 | 910 | } |
  | 911 | 911 | } |
  | 912 | 912 | } |
  | 913 | 913 |  |
  | 914 | 914 | if ($sitepress) { |
  | 915 | 915 | $sitepress->switch\_lang('all', false); |
  | 916 | 916 | } |
  | 917 | 917 | // add posts |
  | 918 | 918 | $res = $this->getPostsSitemap(); |
  | 919 | 919 | if (!empty($res)) { |
  | 920 | 920 | foreach ($res as $val) { |
  | 921 | 921 | /\* get translation post id \*/ |
  | 922 | 922 | $permalink = get\_permalink($val->ID); |
  | 923 | 923 | if (strpos($permalink, '#') !== false) { |
  | 924 | 924 | // Check anchor links |
  | 925 | 925 | $permalink = strstr($permalink, '#', true); |
  | 926 | 926 | } |
  | 927 | 927 |  |
  | 928 | 928 | // Filter full link with custom link |
  | 929 | 929 | $permalink = $this->customLink($permalink); |
  | 930 | 930 |  |
  | 931 | 931 | // Check to exclude external link |
  | 932 | 932 | if ($this->checkExternalLink($permalink)) { |
  | 933 | 933 | continue; |
  | 934 | 934 | } |
  | 935 | 935 |  |
  | 936 | 936 | if (!in\_array($permalink, $list\_links)) { |
  | 937 | 937 | $list\_links[] = $permalink; |
  | 938 | 938 | $gglstmp\_url  = $gglstmp\_urlset->appendChild($xml->createElement('url')); |
  | 939 | 939 | $loc          = $gglstmp\_url->appendChild($xml->createElement('loc')); |
  | 940 | 940 | $loc->appendChild($xml->createTextNode($permalink)); |
  | 941 | 941 | $lastmod = $gglstmp\_url->appendChild($xml->createElement('lastmod')); |
  | 942 | 942 | $now     = $val->post\_modified; |
  | 943 | 943 | $date    = date('Y-m-d\TH:i:sP', strtotime($now)); |
  | 944 | 944 | $lastmod->appendChild($xml->createTextNode($date)); |
  | 945 | 945 | $changefreq = $gglstmp\_url->appendChild($xml->createElement('changefreq')); |
  | 946 | 946 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 947 | 947 | $changefreq->appendChild($xml->createTextNode('monthly')); |
  | 948 | 948 | } else { |
  | 949 | 949 | if (empty($this->settings\_sitemap['wpms\_sitemap\_posts'][$val->ID]['frequency'])) { |
  | 950 | 950 | $postfrequency = 'monthly'; |
  | 951 | 951 | } else { |
  | 952 | 952 | $postfrequency = $this->settings\_sitemap['wpms\_sitemap\_posts'][$val->ID]['frequency']; |
  | 953 | 953 | } |
  | 954 | 954 | $changefreq->appendChild($xml->createTextNode($postfrequency)); |
  | 955 | 955 | } |
  | 956 | 956 |  |
  | 957 | 957 | $priority = $gglstmp\_url->appendChild($xml->createElement('priority')); |
  | 958 | 958 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 959 | 959 | $priority->appendChild($xml->createTextNode('1.0')); |
  | 960 | 960 | } else { |
  | 961 | 961 | if (empty($this->settings\_sitemap['wpms\_sitemap\_posts'][$val->ID]['priority'])) { |
  | 962 | 962 | $postpriority = '1.0'; |
  | 963 | 963 | } else { |
  | 964 | 964 | $postpriority = $this->settings\_sitemap['wpms\_sitemap\_posts'][$val->ID]['priority']; |
  | 965 | 965 | } |
  | 966 | 966 | $priority->appendChild($xml->createTextNode($postpriority)); |
  | 967 | 967 | } |
  | 968 | 968 |  |
  | 969 | 969 | $this->createXmlLang($xml, $val->ID, 'post\_post', $loc); |
  | 970 | 970 | } |
  | 971 | 971 | } |
  | 972 | 972 | } |
  | 973 | 973 |  |
  | 974 | 974 | // run when WP Meta SEO Addon active |
  | 975 | 975 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 976 | 976 | // add custom post type |
  | 977 | 977 | $custom\_post\_types = get\_post\_types( |
  | 978 | 978 | array( |
  | 979 | 979 | 'public'              => true, |
  | 980 | 980 | 'exclude\_from\_search' => false, |
  | 981 | 981 | '\_builtin'            => false |
  | 982 | 982 | ) |
  | 983 | 983 | ); |
  | 984 | 984 | if (!empty($custom\_post\_types)) { |
  | 985 | 985 | foreach ($custom\_post\_types as $pt => $label) { |
  | 986 | 986 | $ids              = array(0); |
  | 987 | 987 | $settings\_sitemap = get\_option('\_metaseo\_settings\_sitemap'); |
  | 988 | 988 | if (!empty($settings\_sitemap['wpms\_sitemap\_' . $pt])) { |
  | 989 | 989 | foreach ((array) $settings\_sitemap['wpms\_sitemap\_' . $pt] as $k => $v) { |
  | 990 | 990 | if (!empty($v['post\_id'])) { |
  | 991 | 991 | $ids[] = (int) $v['post\_id']; |
  | 992 | 992 | } |
  | 993 | 993 | } |
  | 994 | 994 | } |
  | 995 | 995 |  |
  | 996 | 996 | $posts = $wpdb->get\_results($wpdb->prepare('SELECT ID, post\_modified FROM ' . $wpdb->posts . ' WHERE   post\_status = %s AND post\_type = %s AND ID IN (' . implode(',', esc\_sql($ids)) . ') ORDER BY post\_date DESC', array( |
  | 997 | 997 | 'publish', |
  | 998 | 998 | $pt |
  | 999 | 999 | ))); |
  | 1000 | 1000 | if (!empty($posts)) { |
  | 1001 | 1001 | foreach ($posts as $val) { |
  | 1002 | 1002 | $permalink = get\_permalink($val->ID); |
  | 1003 | 1003 | if (strpos($permalink, '#') !== false) { |
  | 1004 | 1004 | // Check anchor links |
  | 1005 | 1005 | $permalink = strstr($permalink, '#', true); |
  | 1006 | 1006 | } |
  | 1007 | 1007 |  |
  | 1008 | 1008 | // Filter full link with custom link |
  | 1009 | 1009 | $permalink = $this->customLink($permalink); |
  | 1010 | 1010 |  |
  | 1011 | 1011 | // Check to exclude external link |
  | 1012 | 1012 | if ($this->checkExternalLink($permalink)) { |
  | 1013 | 1013 | continue; |
  | 1014 | 1014 | } |
  | 1015 | 1015 |  |
  | 1016 | 1016 | if (!in\_array($permalink, $list\_links)) { |
  | 1017 | 1017 | $list\_links[] = $permalink; |
  | 1018 | 1018 | $gglstmp\_url  = $gglstmp\_urlset->appendChild($xml->createElement('url')); |
  | 1019 | 1019 | $loc          = $gglstmp\_url->appendChild($xml->createElement('loc')); |
  | 1020 | 1020 | $loc->appendChild($xml->createTextNode($permalink)); |
  | 1021 | 1021 | $lastmod = $gglstmp\_url->appendChild($xml->createElement('lastmod')); |
  | 1022 | 1022 | $now     = $val->post\_modified; |
  | 1023 | 1023 | $date    = date('Y-m-d\TH:i:sP', strtotime($now)); |
  | 1024 | 1024 | $lastmod->appendChild($xml->createTextNode($date)); |
  | 1025 | 1025 | $changefreq = $gglstmp\_url->appendChild($xml->createElement('changefreq')); |
  | 1026 | 1026 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 1027 | 1027 | $changefreq->appendChild($xml->createTextNode('monthly')); |
  | 1028 | 1028 | } else { |
  | 1029 | 1029 | if (empty($this->settings\_sitemap['wpms\_sitemap\_' . $pt][$val->ID]['frequency'])) { |
  | 1030 | 1030 | $postfr = 'monthly'; |
  | 1031 | 1031 | } else { |
  | 1032 | 1032 | $postfr = $this->settings\_sitemap['wpms\_sitemap\_' . $pt][$val->ID]['frequency']; |
  | 1033 | 1033 | } |
  | 1034 | 1034 | $changefreq->appendChild($xml->createTextNode($postfr)); |
  | 1035 | 1035 | } |
  | 1036 | 1036 |  |
  | 1037 | 1037 | $priority = $gglstmp\_url->appendChild($xml->createElement('priority')); |
  | 1038 | 1038 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 1039 | 1039 | $priority->appendChild($xml->createTextNode('1.0')); |
  | 1040 | 1040 | } else { |
  | 1041 | 1041 | if (empty($this->settings\_sitemap['wpms\_sitemap\_' . $pt][$val->ID]['priority'])) { |
  | 1042 | 1042 | $postpri = '1.0'; |
  | 1043 | 1043 | } else { |
  | 1044 | 1044 | $postpri = $this->settings\_sitemap['wpms\_sitemap\_' . $pt][$val->ID]['priority']; |
  | 1045 | 1045 | } |
  | 1046 | 1046 | $priority->appendChild($xml->createTextNode($postpri)); |
  | 1047 | 1047 | } |
  | 1048 | 1048 |  |
  | 1049 | 1049 | $this->createXmlLang( |
  | 1050 | 1050 | $xml, |
  | 1051 | 1051 | $val->ID, |
  | 1052 | 1052 | 'post\_post', |
  | 1053 | 1053 | $loc |
  | 1054 | 1054 | ); |
  | 1055 | 1055 | } |
  | 1056 | 1056 | } |
  | 1057 | 1057 | } |
  | 1058 | 1058 | } |
  | 1059 | 1059 | } |
  | 1060 | 1060 |  |
  | 1061 | 1061 | // add custom Url |
  | 1062 | 1062 | $listUrls = get\_option('wpms\_customUrls\_list'); |
  | 1063 | 1063 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 1064 | 1064 | if (!empty($settings['wpms\_sitemap\_customUrl']) && $settings['wpms\_sitemap\_customUrl'] !== '{}') { |
  | 1065 | 1065 | foreach ($settings['wpms\_sitemap\_customUrl'] as $key => $customUrl) { |
  | 1066 | 1066 | if (!empty($listUrls[$key])) { |
  | 1067 | 1067 | if (strpos($listUrls[$key]['link'], '#') !== false) { |
  | 1068 | 1068 | // Check anchor links |
  | 1069 | 1069 | $listUrls[$key]['link'] = strstr($listUrls[$key]['link'], '#', true); |
  | 1070 | 1070 | } |
  | 1071 | 1071 |  |
  | 1072 | 1072 | // Filter full link with custom link |
  | 1073 | 1073 | $listUrls[$key]['link'] = $this->customLink($listUrls[$key]['link']); |
  | 1074 | 1074 |  |
  | 1075 | 1075 | // Check to exclude external link |
  | 1076 | 1076 | if ($this->checkExternalLink($listUrls[$key]['link'])) { |
  | 1077 | 1077 | continue; |
  | 1078 | 1078 | } |
  | 1079 | 1079 |  |
  | 1080 | 1080 | if (!in\_array($listUrls[$key]['link'], $list\_links)) { |
  | 1081 | 1081 | $list\_links[] = $listUrls[$key]['link']; |
  | 1082 | 1082 | $gglstmp\_url  = $gglstmp\_urlset->appendChild($xml->createElement('url')); |
  | 1083 | 1083 | $loc          = $gglstmp\_url->appendChild($xml->createElement('loc')); |
  | 1084 | 1084 |  |
  | 1085 | 1085 | $loc->appendChild($xml->createTextNode($listUrls[$key]['link'])); |
  | 1086 | 1086 | $lastmod = $gglstmp\_url->appendChild($xml->createElement('lastmod')); |
  | 1087 | 1087 | $date    = date('Y-m-d\TH:i:sP', $key); |
  | 1088 | 1088 | $lastmod->appendChild($xml->createTextNode($date)); |
  | 1089 | 1089 | $changefreq = $gglstmp\_url->appendChild($xml->createElement('changefreq')); |
  | 1090 | 1090 |  |
  | 1091 | 1091 | if (empty($customUrl['frequency'])) { |
  | 1092 | 1092 | $pagefrequency = 'monthly'; |
  | 1093 | 1093 | } else { |
  | 1094 | 1094 | $pagefrequency = $customUrl['frequency']; |
  | 1095 | 1095 | } |
  | 1096 | 1096 | $changefreq->appendChild($xml->createTextNode($pagefrequency)); |
  | 1097 | 1097 |  |
  | 1098 | 1098 | $priority = $gglstmp\_url->appendChild($xml->createElement('priority')); |
  | 1099 | 1099 |  |
  | 1100 | 1100 | if (empty($customUrl['priority'])) { |
  | 1101 | 1101 | $pagepriority = '1.0'; |
  | 1102 | 1102 | } else { |
  | 1103 | 1103 | $pagepriority = $customUrl['priority']; |
  | 1104 | 1104 | } |
  | 1105 | 1105 | $priority->appendChild($xml->createTextNode($pagepriority)); |
  | 1106 | 1106 | } |
  | 1107 | 1107 | } |
  | 1108 | 1108 | } |
  | 1109 | 1109 | } |
  | 1110 | 1110 | } |
  | 1111 | 1111 | // ======================================== |
  | 1112 | 1112 | // add pages |
  | 1113 | 1113 | $res = $this->getPagesSitemap(); |
  | 1114 | 1114 | if (!empty($res)) { |
  | 1115 | 1115 | foreach ($res as $val) { |
  | 1116 | 1116 | /\* get translation post id \*/ |
  | 1117 | 1117 | $permalink = get\_permalink($val->ID); |
  | 1118 | 1118 | if (strpos($permalink, '#') !== false) { |
  | 1119 | 1119 | // Check anchor links |
  | 1120 | 1120 | $permalink = strstr($permalink, '#', true); |
  | 1121 | 1121 | } |
  | 1122 | 1122 |  |
  | 1123 | 1123 | // Filter full link with custom link |
  | 1124 | 1124 | $permalink = $this->customLink($permalink); |
  | 1125 | 1125 |  |
  | 1126 | 1126 | // Check to exclude external link |
  | 1127 | 1127 | if ($this->checkExternalLink($permalink)) { |
  | 1128 | 1128 | continue; |
  | 1129 | 1129 | } |
  | 1130 | 1130 |  |
  | 1131 | 1131 | if (!in\_array($permalink, $list\_links)) { |
  | 1132 | 1132 | $list\_links[] = $permalink; |
  | 1133 | 1133 | $gglstmp\_url  = $gglstmp\_urlset->appendChild($xml->createElement('url')); |
  | 1134 | 1134 | $loc          = $gglstmp\_url->appendChild($xml->createElement('loc')); |
  | 1135 | 1135 |  |
  | 1136 | 1136 | $loc->appendChild($xml->createTextNode($permalink)); |
  | 1137 | 1137 | $lastmod = $gglstmp\_url->appendChild($xml->createElement('lastmod')); |
  | 1138 | 1138 | $now     = $val->post\_modified; |
  | 1139 | 1139 | $date    = date('Y-m-d\TH:i:sP', strtotime($now)); |
  | 1140 | 1140 | $lastmod->appendChild($xml->createTextNode($date)); |
  | 1141 | 1141 | $changefreq = $gglstmp\_url->appendChild($xml->createElement('changefreq')); |
  | 1142 | 1142 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 1143 | 1143 | $changefreq->appendChild($xml->createTextNode('monthly')); |
  | 1144 | 1144 | } else { |
  | 1145 | 1145 | if (empty($this->settings\_sitemap['wpms\_sitemap\_pages'][$val->ID]['frequency'])) { |
  | 1146 | 1146 | $pagefrequency = 'monthly'; |
  | 1147 | 1147 | } else { |
  | 1148 | 1148 | $pagefrequency = $this->settings\_sitemap['wpms\_sitemap\_pages'][$val->ID]['frequency']; |
  | 1149 | 1149 | } |
  | 1150 | 1150 | $changefreq->appendChild($xml->createTextNode($pagefrequency)); |
  | 1151 | 1151 | } |
  | 1152 | 1152 | $priority = $gglstmp\_url->appendChild($xml->createElement('priority')); |
  | 1153 | 1153 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 1154 | 1154 | $priority->appendChild($xml->createTextNode('1.0')); |
  | 1155 | 1155 | } else { |
  | 1156 | 1156 | if (empty($this->settings\_sitemap['wpms\_sitemap\_pages'][$val->ID]['priority'])) { |
  | 1157 | 1157 | $pagepriority = '1.0'; |
  | 1158 | 1158 | } else { |
  | 1159 | 1159 | $pagepriority = $this->settings\_sitemap['wpms\_sitemap\_pages'][$val->ID]['priority']; |
  | 1160 | 1160 | } |
  | 1161 | 1161 | $priority->appendChild($xml->createTextNode($pagepriority)); |
  | 1162 | 1162 | } |
  | 1163 | 1163 |  |
  | 1164 | 1164 | $this->createXmlLang($xml, $val->ID, 'post\_page', $loc); |
  | 1165 | 1165 | } |
  | 1166 | 1166 | } |
  | 1167 | 1167 | } |
  | 1168 | 1168 |  |
  | 1169 | 1169 | // add category |
  | 1170 | 1170 | if (!empty($taxonomies)) { |
  | 1171 | 1171 | foreach ($taxonomies as $value) { |
  | 1172 | 1172 | $terms = get\_terms($value, 'hide\_empty=1'); |
  | 1173 | 1173 | if (!empty($terms) && !is\_wp\_error($terms)) { |
  | 1174 | 1174 | foreach ($terms as $term\_value) { |
  | 1175 | 1175 | $permalink = get\_term\_link((int) $term\_value->term\_id, $value); |
  | 1176 | 1176 | if (strpos($permalink, '#') !== false) { |
  | 1177 | 1177 | // Check anchor links |
  | 1178 | 1178 | $permalink = strstr($permalink, '#', true); |
  | 1179 | 1179 | } |
  | 1180 | 1180 |  |
  | 1181 | 1181 | // Filter full link with custom link |
  | 1182 | 1182 | $permalink = $this->customLink($permalink); |
  | 1183 | 1183 |  |
  | 1184 | 1184 | // Check to exclude external link |
  | 1185 | 1185 | if ($this->checkExternalLink($permalink)) { |
  | 1186 | 1186 | continue; |
  | 1187 | 1187 | } |
  | 1188 | 1188 |  |
  | 1189 | 1189 | if (!in\_array($permalink, $list\_links)) { |
  | 1190 | 1190 | $list\_links[] = $permalink; |
  | 1191 | 1191 | $gglstmp\_url  = $gglstmp\_urlset->appendChild($xml->createElement('url')); |
  | 1192 | 1192 | $loc          = $gglstmp\_url->appendChild($xml->createElement('loc')); |
  | 1193 | 1193 |  |
  | 1194 | 1194 | $loc->appendChild($xml->createTextNode($permalink)); |
  | 1195 | 1195 | $lastmod = $gglstmp\_url->appendChild($xml->createElement('lastmod')); |
  | 1196 | 1196 |  |
  | 1197 | 1197 | $now  = $wpdb->get\_var( |
  | 1198 | 1198 | $wpdb->prepare('SELECT post\_modified FROM ' . $wpdb->posts . ' AS posttable, ' . $wpdb->term\_relationships . ' AS termrelationship WHERE post\_status = %s AND term\_taxonomy\_id = %d AND posttable.ID = termrelationship.object\_id ORDER BY post\_modified DESC', array( |
  | 1199 | 1199 | 'publish', |
  | 1200 | 1200 | $term\_value->term\_taxonomy\_id |
  | 1201 | 1201 | )) |
  | 1202 | 1202 | ); |
  | 1203 | 1203 | $date = date('Y-m-d\TH:i:sP', strtotime($now)); |
  | 1204 | 1204 | $lastmod->appendChild($xml->createTextNode($date)); |
  | 1205 | 1205 | $changefreq = $gglstmp\_url->appendChild($xml->createElement('changefreq')); |
  | 1206 | 1206 | $changefreq->appendChild($xml->createTextNode('monthly')); |
  | 1207 | 1207 | $priority = $gglstmp\_url->appendChild($xml->createElement('priority')); |
  | 1208 | 1208 | $priority->appendChild($xml->createTextNode(1.0)); |
  | 1209 | 1209 | } |
  | 1210 | 1210 | } |
  | 1211 | 1211 | } |
  | 1212 | 1212 | } |
  | 1213 | 1213 | } |
  | 1214 | 1214 |  |
  | 1215 | 1215 | $xml->formatOutput = true; |
  | 1216 | 1216 |  |
  | 1217 | 1217 | if (!is\_writable(ABSPATH)) { |
  | 1218 | 1218 | chmod(ABSPATH, 0755); |
  | 1219 | 1219 | } |
  | 1220 | 1220 |  |
  | 1221 | 1221 | /\*\* |
  | 1222 | 1222 | \* Filter run before save sitemap to xml file |
  | 1223 | 1223 | \* |
  | 1224 | 1224 | \* @param object The current xml object |
  | 1225 | 1225 | \* |
  | 1226 | 1226 | \* @return object |
  | 1227 | 1227 | \*/ |
  | 1228 | 1228 | $xml = apply\_filters('wpms\_save\_sitemap\_xml', $xml); |
  | 1229 | 1229 |  |
  | 1230 | 1230 | if (is\_multisite()) { |
  | 1231 | 1231 | $home\_url = preg\_replace( |
  | 1232 | 1232 | '/[^a-zA-ZА-Яа-я0-9\s]/', |
  | 1233 | 1233 | '\_', |
  | 1234 | 1234 | str\_replace('http://', '', str\_replace('https://', '', site\_url())) |
  | 1235 | 1235 | ); |
  | 1236 | 1236 | $xml->save(ABSPATH . 'sitemap\_' . $home\_url . '.xml'); |
  | 1237 | 1237 | } else { |
  | 1238 | 1238 | if ($sitepress && !empty($this->settings\_sitemap['wpms\_sitemap\_include\_lang'])) { |
  | 1239 | 1239 | $langs = implode('-', $this->settings\_sitemap['wpms\_sitemap\_include\_lang']); |
  | 1240 | 1240 | $sitemap\_xml\_name = 'wpms-sitemap-'.$langs .'.xml'; |
  | 1241 | 1241 | } |
  | 1242 | 1242 | $xml->save(ABSPATH . $sitemap\_xml\_name); |
  | 1243 | 1243 | } |
  | 1244 | 1244 | $this->sitemapInfos(); |
  | 1245 | 1245 | } |
  | 1246 | 1246 |  |
  | 1247 | 1247 | /\*\* |
  | 1248 | 1248 | \* Create xml language |
  | 1249 | 1249 | \* |
  | 1250 | 1250 | \* @param object  $xml     XML |
  | 1251 | 1251 | \* @param integer $id      Element Id |
  | 1252 | 1252 | \* @param string  $el\_type Element type |
  | 1253 | 1253 | \* @param object  $loc     Node Info |
  | 1254 | 1254 | \* |
  | 1255 | 1255 | \* @return void |
  | 1256 | 1256 | \*/ |
  | 1257 | 1257 | public function createXmlLang($xml, $id, $el\_type, $loc) |
  | 1258 | 1258 | { |
  | 1259 | 1259 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME) && is\_plugin\_active('sitepress-multilingual-cms/sitepress.php')) { |
  | 1260 | 1260 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_include\_lang'])) { |
  | 1261 | 1261 | global $sitepress; |
  | 1262 | 1262 | $trid = $sitepress->get\_element\_trid($id, $el\_type); |
  | 1263 | 1263 | if ($trid) { |
  | 1264 | 1264 | // get post $translation |
  | 1265 | 1265 | $translations = $sitepress->get\_element\_translations($trid, $el\_type, true, true, true); |
  | 1266 | 1266 | foreach ($translations as $translation) { |
  | 1267 | 1267 | if (isset($translation->language\_code) |
  | 1268 | 1268 | && in\_array( |
  | 1269 | 1269 | $translation->language\_code, |
  | 1270 | 1270 | $this->settings\_sitemap['wpms\_sitemap\_include\_lang'] |
  | 1271 | 1271 | )) { |
  | 1272 | 1272 | $permalink = get\_permalink($translation->element\_id); |
  | 1273 | 1273 | // can use |
  | 1274 | 1274 | // $xml->appendChild($xml->createElementNS('http://www.w3.org/1999/xhtml', 'xhtml:link')); |
  | 1275 | 1275 | $node = $xml->appendChild($xml->createElement('xhtml:link')); |
  | 1276 | 1276 | $node->setAttribute('rel', 'alternate'); |
  | 1277 | 1277 | $node->setAttribute('hreflang', $translation->language\_code); |
  | 1278 | 1278 | $node->setAttribute('href', $permalink); |
  | 1279 | 1279 | $loc->parentNode->appendChild($node); |
  | 1280 | 1280 | } |
  | 1281 | 1281 | } |
  | 1282 | 1282 | } |
  | 1283 | 1283 | } |
  | 1284 | 1284 | } elseif (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME) && is\_plugin\_active('polylang/polylang.php')) { |
  | 1285 | 1285 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_include\_lang'])) { |
  | 1286 | 1286 | global $polylang; |
  | 1287 | 1287 | $model      = $polylang->filters->links\_model->model; |
  | 1288 | 1288 | $model\_post = $polylang->filters->links\_model->model->post; |
  | 1289 | 1289 | foreach ($model->get\_languages\_list() as $language) { |
  | 1290 | 1290 | $value = $model\_post->get\_translation($id, $language); |
  | 1291 | 1291 | if ($value) { |
  | 1292 | 1292 | $lang = pll\_get\_post\_language($value); |
  | 1293 | 1293 | if (isset($lang) && in\_array($lang, $this->settings\_sitemap['wpms\_sitemap\_include\_lang'])) { |
  | 1294 | 1294 | $permalink = get\_permalink($value); |
  | 1295 | 1295 | $node      = $xml->appendChild( |
  | 1296 | 1296 | $xml->createElementNS('http://www.w3.org/1999/xhtml', 'xhtml:link') |
  | 1297 | 1297 | ); |
  | 1298 | 1298 | $node->setAttribute('rel', 'alternate'); |
  | 1299 | 1299 | $node->setAttribute('hreflang', $lang); |
  | 1300 | 1300 | $node->setAttribute('href', $permalink); |
  | 1301 | 1301 | $loc->parentNode->appendChild($node); |
  | 1302 | 1302 | } |
  | 1303 | 1303 | } |
  | 1304 | 1304 | } |
  | 1305 | 1305 | } |
  | 1306 | 1306 | } |
  | 1307 | 1307 | } |
  | 1308 | 1308 |  |
  | 1309 | 1309 | /\*\* |
  | 1310 | 1310 | \* Retrieves the full permalink for the current post or post ID |
  | 1311 | 1311 | \* |
  | 1312 | 1312 | \* @param string  $type Element type |
  | 1313 | 1313 | \* @param integer $id   Element id |
  | 1314 | 1314 | \* |
  | 1315 | 1315 | \* @return false|mixed|string |
  | 1316 | 1316 | \*/ |
  | 1317 | 1317 | public function getPermalinkSitemap($type, $id) |
  | 1318 | 1318 | { |
  | 1319 | 1319 | if (isset($type) && $type === 'custom') { |
  | 1320 | 1320 | $permalink = get\_post\_meta($id, '\_menu\_item\_url', true); |
  | 1321 | 1321 | } elseif ($type === 'taxonomy') { |
  | 1322 | 1322 | $permalink = get\_category\_link($id); |
  | 1323 | 1323 | } else { |
  | 1324 | 1324 | $permalink = get\_permalink($id); |
  | 1325 | 1325 | } |
  | 1326 | 1326 | return $permalink; |
  | 1327 | 1327 | } |
  | 1328 | 1328 |  |
  | 1329 | 1329 | /\*\* |
  | 1330 | 1330 | \* Update sitemap setting |
  | 1331 | 1331 | \* |
  | 1332 | 1332 | \* @return void |
  | 1333 | 1333 | \*/ |
  | 1334 | 1334 | public function sitemapInfos() |
  | 1335 | 1335 | { |
  | 1336 | 1336 | $settings  = get\_option('\_metaseo\_settings\_sitemap'); |
  | 1337 | 1337 | $info\_file = $this->getPathSitemapFile(); |
  | 1338 | 1338 | $xml\_url   = site\_url('/') . $info\_file['name']; |
  | 1339 | 1339 | if (file\_exists($info\_file['path'])) { |
  | 1340 | 1340 | $settings['sitemap'] = array( |
  | 1341 | 1341 | 'file'    => $info\_file['name'], |
  | 1342 | 1342 | 'path'    => $info\_file['path'], |
  | 1343 | 1343 | 'loc'     => $xml\_url, |
  | 1344 | 1344 | 'lastmod' => date('Y-m-d\TH:i:sP', filemtime($info\_file['path'])) |
  | 1345 | 1345 | ); |
  | 1346 | 1346 | update\_option('\_metaseo\_settings\_sitemap', $settings); |
  | 1347 | 1347 | } |
  | 1348 | 1348 | } |
  | 1349 | 1349 |  |
  | 1350 | 1350 | /\*\* |
  | 1351 | 1351 | \* Display sitemap posts by column in front-end |
  | 1352 | 1352 | \* |
  | 1353 | 1353 | \* @return string |
  | 1354 | 1354 | \*/ |
  | 1355 | 1355 | public function displayPosts() |
  | 1356 | 1356 | { |
  | 1357 | 1357 | $html      = ''; |
  | 1358 | 1358 | $postTitle = get\_post\_type\_object('post'); |
  | 1359 | 1359 | $postTitle = $postTitle->label; |
  | 1360 | 1360 |  |
  | 1361 | 1361 | if (get\_option('show\_on\_front') === 'page') { |
  | 1362 | 1362 | $postsURL  = get\_permalink(get\_option('page\_for\_posts')); |
  | 1363 | 1363 | $postTitle = get\_the\_title(get\_option('page\_for\_posts')); |
  | 1364 | 1364 | } else { |
  | 1365 | 1365 | $postsURL = get\_bloginfo('url'); |
  | 1366 | 1366 | } |
  | 1367 | 1367 |  |
  | 1368 | 1368 | if (!empty($this->settings\_sitemap['wpms\_public\_name\_posts'])) { |
  | 1369 | 1369 | $postTitle = $this->settings\_sitemap['wpms\_public\_name\_posts']; |
  | 1370 | 1370 | } |
  | 1371 | 1371 | $html .= '<div id="sitemap\_posts" class="wpms\_sitemap\_posts"><h4>'; |
  | 1372 | 1372 | if ($postsURL !== '' && $postsURL !== get\_permalink($this->settings\_sitemap['wpms\_html\_sitemap\_page'])) { |
  | 1373 | 1373 | $html .= '<a href="' . $postsURL . '">' . $postTitle . '</a>'; |
  | 1374 | 1374 | } else { |
  | 1375 | 1375 | $html .= $postTitle; |
  | 1376 | 1376 | } |
  | 1377 | 1377 | $html .= '</h4><ul>'; |
  | 1378 | 1378 |  |
  | 1379 | 1379 | //Categories |
  | 1380 | 1380 | $ids = array(0); |
  | 1381 | 1381 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_posts'])) { |
  | 1382 | 1382 | foreach ((array) $this->settings\_sitemap['wpms\_sitemap\_posts'] as $k => $v) { |
  | 1383 | 1383 | if (!empty($v['post\_id'])) { |
  | 1384 | 1384 | $ids[] = $k; |
  | 1385 | 1385 | } |
  | 1386 | 1386 | } |
  | 1387 | 1387 | } |
  | 1388 | 1388 |  |
  | 1389 | 1389 | $cats = get\_categories(array('taxonomy' => 'category', 'hide\_empty' => true)); |
  | 1390 | 1390 | foreach ($cats as $cat) { |
  | 1391 | 1391 | if (in\_array($cat->cat\_ID, $this->settings\_sitemap['wpms\_category\_link'])) { |
  | 1392 | 1392 | $cat\_link = '<a href="' . esc\_url(get\_term\_link($cat)) . '">' . esc\_html($cat->cat\_name) . '</a>'; |
  | 1393 | 1393 | } else { |
  | 1394 | 1394 | $cat\_link = $cat->cat\_name; |
  | 1395 | 1395 | } |
  | 1396 | 1396 | $html .= '<li class="wpms\_li\_cate"><div class="cat\_name">' . $cat\_link . '</div></li>'; |
  | 1397 | 1397 |  |
  | 1398 | 1398 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_posts'])) { |
  | 1399 | 1399 | query\_posts(array('post\_\_in' => $ids, 'posts\_per\_page' => - 1, 'cat' => $cat->cat\_ID)); |
  | 1400 | 1400 | while (have\_posts()) { |
  | 1401 | 1401 | the\_post(); |
  | 1402 | 1402 | if ((get\_post\_meta(get\_the\_ID(), '\_yoast\_wpseo\_meta-robots-noindex', true) === '1' |
  | 1403 | 1403 | && get\_post\_meta(get\_the\_ID(), '\_yoast\_wpseo\_sitemap-include', true) !== 'always') |
  | 1404 | 1404 | || (get\_post\_meta(get\_the\_ID(), '\_yoast\_wpseo\_sitemap-include', true) === 'never') |
  | 1405 | 1405 | || (get\_post\_meta(get\_the\_ID(), '\_yoast\_wpms\_redirect', true) !== '')) { |
  | 1406 | 1406 | continue; |
  | 1407 | 1407 | } |
  | 1408 | 1408 |  |
  | 1409 | 1409 | $category = get\_the\_category(); |
  | 1410 | 1410 | // Only display a post link once, even if it's in multiple categories |
  | 1411 | 1411 | if ((int) $category[0]->cat\_ID === (int) $cat->cat\_ID) { |
  | 1412 | 1412 | $html .= '<li><a href="' . get\_permalink() . '">' . get\_the\_title() . '</a></li>'; |
  | 1413 | 1413 | } |
  | 1414 | 1414 | } |
  | 1415 | 1415 | wp\_reset\_query(); |
  | 1416 | 1416 | } |
  | 1417 | 1417 | } |
  | 1418 | 1418 | $html .= '</ul></div>'; |
  | 1419 | 1419 | $html .= '<div class="holder holder\_sitemaps\_posts"></div>'; |
  | 1420 | 1420 |  |
  | 1421 | 1421 | return $html; |
  | 1422 | 1422 | } |
  | 1423 | 1423 |  |
  | 1424 | 1424 | /\*\* |
  | 1425 | 1425 | \* Display sitemap pages by column in front-end |
  | 1426 | 1426 | \* |
  | 1427 | 1427 | \* @return string |
  | 1428 | 1428 | \*/ |
  | 1429 | 1429 | public function displayPages() |
  | 1430 | 1430 | { |
  | 1431 | 1431 | $html = ''; |
  | 1432 | 1432 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_pages'])) { |
  | 1433 | 1433 | $pageTitle = get\_post\_type\_object('page'); |
  | 1434 | 1434 | $pageTitle = $pageTitle->label; |
  | 1435 | 1435 | if (!empty($this->settings\_sitemap['wpms\_public\_name\_pages'])) { |
  | 1436 | 1436 | $pageTitle = $this->settings\_sitemap['wpms\_public\_name\_pages']; |
  | 1437 | 1437 | } |
  | 1438 | 1438 | $html     .= '<div id="sitemap\_pages" class="wpms\_sitemap\_pages"><h4>' . $pageTitle . '</h4> |
  | 1439 | 1439 | <ul>'; |
  | 1440 | 1440 | $pageInc  = ''; |
  | 1441 | 1441 | $getPages = $this->getPagesSitemap(); |
  | 1442 | 1442 | foreach ($getPages as $page) { |
  | 1443 | 1443 | if (isset($this->settings\_sitemap['wpms\_html\_sitemap\_page']) |
  | 1444 | 1444 | && (int) $page->ID !== (int) $this->settings\_sitemap['wpms\_html\_sitemap\_page']) { |
  | 1445 | 1445 | if ((get\_post\_meta($page->ID, '\_yoast\_wpseo\_meta-robots-noindex', true) === '1' |
  | 1446 | 1446 | && get\_post\_meta($page->ID, '\_yoast\_wpseo\_sitemap-include', true) !== 'always') |
  | 1447 | 1447 | || (get\_post\_meta($page->ID, '\_yoast\_wpseo\_sitemap-include', true) === 'never') |
  | 1448 | 1448 | || (get\_post\_meta($page->ID, '\_yoast\_wpms\_redirect', true) !== '')) { |
  | 1449 | 1449 | continue; |
  | 1450 | 1450 | } |
  | 1451 | 1451 | if ($pageInc === '') { |
  | 1452 | 1452 | $pageInc = $page->ID; |
  | 1453 | 1453 | continue; |
  | 1454 | 1454 | } |
  | 1455 | 1455 | $pageInc .= ', ' . $page->ID; |
  | 1456 | 1456 | } |
  | 1457 | 1457 | } |
  | 1458 | 1458 |  |
  | 1459 | 1459 | if ($pageInc !== '') { |
  | 1460 | 1460 | $html .= wp\_list\_pages( |
  | 1461 | 1461 | array( |
  | 1462 | 1462 | 'include'     => $pageInc, |
  | 1463 | 1463 | 'title\_li'    => '', |
  | 1464 | 1464 | 'sort\_column' => 'post\_title', |
  | 1465 | 1465 | 'sort\_order'  => 'ASC', |
  | 1466 | 1466 | 'echo'        => false |
  | 1467 | 1467 | ) |
  | 1468 | 1468 | ); |
  | 1469 | 1469 | } |
  | 1470 | 1470 |  |
  | 1471 | 1471 | $html .= '</ul></div>'; |
  | 1472 | 1472 | $html .= '<div class="holder holder\_sitemaps\_pages"></div>'; |
  | 1473 | 1473 | } |
  | 1474 | 1474 | return $html; |
  | 1475 | 1475 | } |
  | 1476 | 1476 |  |
  | 1477 | 1477 | /\*\* |
  | 1478 | 1478 | \* Display sitemap customUrl by column in front-end |
  | 1479 | 1479 | \* |
  | 1480 | 1480 | \* @return string |
  | 1481 | 1481 | \*/ |
  | 1482 | 1482 | public function displayCustomUrl() |
  | 1483 | 1483 | { |
  | 1484 | 1484 | $html  = ''; |
  | 1485 | 1485 | $lists = $this->settings\_sitemap['wpms\_sitemap\_customUrl']; |
  | 1486 | 1486 | $links = get\_option('wpms\_customUrls\_list'); |
  | 1487 | 1487 | if (!empty($lists)) { |
  | 1488 | 1488 | $html .= '<div id="sitemap\_customUrl" class="wpms\_sitemap\_customUrl">'; |
  | 1489 | 1489 | if (!empty($this->settings\_sitemap['wpms\_public\_name\_customUrl'])) { |
  | 1490 | 1490 | $publictitle = $this->settings\_sitemap['wpms\_public\_name\_customUrl']; |
  | 1491 | 1491 | } else { |
  | 1492 | 1492 | $publictitle = esc\_html\_\_('Custom Url', 'wp-meta-seo'); |
  | 1493 | 1493 | } |
  | 1494 | 1494 |  |
  | 1495 | 1495 | if (!empty($lists) && $lists !== '{}') { |
  | 1496 | 1496 | $html .= '<h4>' . $publictitle . '</h4>'; |
  | 1497 | 1497 | $html .= '<ul>'; |
  | 1498 | 1498 | foreach ($lists as $key => $list) { |
  | 1499 | 1499 | if (!empty($links[$key])) { |
  | 1500 | 1500 | $html .= '<li>'; |
  | 1501 | 1501 | $html .= '<a href="' . esc\_url($links[$key]['link']) . '">' . esc\_html($links[$key]['title']) . '</a>'; |
  | 1502 | 1502 | $html .= '</li>'; |
  | 1503 | 1503 | } |
  | 1504 | 1504 | } |
  | 1505 | 1505 |  |
  | 1506 | 1506 | $html .= '</ul>'; |
  | 1507 | 1507 | } |
  | 1508 | 1508 |  |
  | 1509 | 1509 | $html .= '</div>'; |
  | 1510 | 1510 | $html .= '<div class="holder holder\_sitemaps\_customUrl"></div>'; |
  | 1511 | 1511 | } |
  | 1512 | 1512 |  |
  | 1513 | 1513 | return $html; |
  | 1514 | 1514 | } |
  | 1515 | 1515 |  |
  | 1516 | 1516 | /\*\* |
  | 1517 | 1517 | \* Render sitemap theme default |
  | 1518 | 1518 | \* |
  | 1519 | 1519 | \* @return string |
  | 1520 | 1520 | \*/ |
  | 1521 | 1521 | public function sitemapThemeDefault() |
  | 1522 | 1522 | { |
  | 1523 | 1523 | $html = ''; |
  | 1524 | 1524 | $html .= '<div id="wpms\_sitemap" |
  | 1525 | 1525 | class="' . esc\_attr('theme\_default columns\_' . $this->settings\_sitemap['wpms\_html\_sitemap\_column']) . '">'; |
  | 1526 | 1526 | $arrs = array('displayPosts' => 'wpms\_display\_column\_posts', 'displayPages' => 'wpms\_display\_column\_pages'); |
  | 1527 | 1527 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 1528 | 1528 | $arrs['displayCustomUrl'] = 'wpms\_display\_column\_customUrl'; |
  | 1529 | 1529 | } |
  | 1530 | 1530 | $checkColumn = array(); |
  | 1531 | 1531 | for ($i = 1; $i <= (int) $this->settings\_sitemap['wpms\_html\_sitemap\_column']; $i ++) { |
  | 1532 | 1532 | $html .= '<div class="' . esc\_attr('wpms\_column wpms\_column\_' . $i) . '" style="width:33%;float:left;">'; |
  | 1533 | 1533 | if ((int) $i === 1) { |
  | 1534 | 1534 | // Authors |
  | 1535 | 1535 | if ((int) $this->settings\_sitemap['wpms\_sitemap\_author'] === 1) { |
  | 1536 | 1536 | $html .= '<div id="sitemap\_authors"><h3>' . esc\_html\_\_('Authors', 'wp-meta-seo') . '</h3> |
  | 1537 | 1537 | <ul>'; |
  | 1538 | 1538 |  |
  | 1539 | 1539 | $authEx = implode( |
  | 1540 | 1540 | ', ', |
  | 1541 | 1541 | get\_users('orderby=nicename&meta\_key=wpms\_excludeauthorsitemap&meta\_value=on') |
  | 1542 | 1542 | ); |
  | 1543 | 1543 | $html   .= wp\_list\_authors(array('exclude\_admin' => false, 'exclude' => $authEx, 'echo' => false)); |
  | 1544 | 1544 | $html   .= '</ul></div>'; |
  | 1545 | 1545 | } |
  | 1546 | 1546 | } |
  | 1547 | 1547 |  |
  | 1548 | 1548 | foreach ($arrs as $ar => $arr) { |
  | 1549 | 1549 | if (empty($this->settings\_sitemap[$arr])) { |
  | 1550 | 1550 | $this->settings\_sitemap[$arr] = 1; |
  | 1551 | 1551 | } |
  | 1552 | 1552 |  |
  | 1553 | 1553 | if (!in\_array($ar, $checkColumn)) { |
  | 1554 | 1554 | if ((int) $i === (int) $this->settings\_sitemap[$arr]) { |
  | 1555 | 1555 | $checkColumn[] = $ar; |
  | 1556 | 1556 | $output        = $this->{$ar}(); |
  | 1557 | 1557 | $html          .= $output; |
  | 1558 | 1558 | } |
  | 1559 | 1559 | } |
  | 1560 | 1560 | } |
  | 1561 | 1561 | // custom post type |
  | 1562 | 1562 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 1563 | 1563 | $custom\_post\_types = get\_post\_types( |
  | 1564 | 1564 | array( |
  | 1565 | 1565 | 'public'              => true, |
  | 1566 | 1566 | 'exclude\_from\_search' => false, |
  | 1567 | 1567 | '\_builtin'            => false |
  | 1568 | 1568 | ) |
  | 1569 | 1569 | ); |
  | 1570 | 1570 | if (!empty($custom\_post\_types)) { |
  | 1571 | 1571 | foreach ($custom\_post\_types as $post\_type => $label) { |
  | 1572 | 1572 | if (!empty($this->settings\_sitemap['wpms\_display\_column\_' . $post\_type]) |
  | 1573 | 1573 | && (int) $i === (int) $this->settings\_sitemap['wpms\_display\_column\_' . $post\_type]) { |
  | 1574 | 1574 | //===================================================================================== |
  | 1575 | 1575 | if (isset($this->settings\_sitemap['wpms\_public\_name\_' . $post\_type]) |
  | 1576 | 1576 | && $this->settings\_sitemap['wpms\_public\_name\_' . $post\_type] !== '') { |
  | 1577 | 1577 | $postTitle = $this->settings\_sitemap['wpms\_public\_name\_' . $post\_type]; |
  | 1578 | 1578 | } else { |
  | 1579 | 1579 | $postTitle = get\_post\_type\_object($post\_type); |
  | 1580 | 1580 | $postTitle = $postTitle->label; |
  | 1581 | 1581 | } |
  | 1582 | 1582 |  |
  | 1583 | 1583 | global $wpdb; |
  | 1584 | 1584 | if ($post\_type === 'product') { |
  | 1585 | 1585 | $taxonomy\_objects = array('product\_cat'); |
  | 1586 | 1586 | } else { |
  | 1587 | 1587 | $taxonomy\_objects = get\_object\_taxonomies($post\_type, 'names'); |
  | 1588 | 1588 | } |
  | 1589 | 1589 | $ids = array(0); |
  | 1590 | 1590 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_' . $post\_type])) { |
  | 1591 | 1591 | $html .= '<div id="sitemap\_' . $post\_type . '" class="wpms\_sitemap\_' . $post\_type . '"><h4>'; |
  | 1592 | 1592 | $html .= esc\_html($postTitle); |
  | 1593 | 1593 | $html .= '</h4><ul>'; |
  | 1594 | 1594 | foreach ((array) $this->settings\_sitemap['wpms\_sitemap\_' . $post\_type] as $k => $v) { |
  | 1595 | 1595 | if (!empty($v['post\_id'])) { |
  | 1596 | 1596 | $ids[] = (int) $v['post\_id']; |
  | 1597 | 1597 | } |
  | 1598 | 1598 | } |
  | 1599 | 1599 | } |
  | 1600 | 1600 |  |
  | 1601 | 1601 | $list\_links = array(); |
  | 1602 | 1602 | if (!empty($taxonomy\_objects)) { |
  | 1603 | 1603 | foreach ($taxonomy\_objects as $taxo) { |
  | 1604 | 1604 | $categorys = get\_categories(array('hide\_empty' => true, 'taxonomy' => $taxo)); |
  | 1605 | 1605 | foreach ($categorys as $cat) { |
  | 1606 | 1606 | $results = $wpdb->get\_results($wpdb->prepare('SELECT p.ID as ID,p.post\_title as post\_title |
  | 1607 | 1607 | FROM ' . $wpdb->posts . ' AS p |
  | 1608 | 1608 | INNER JOIN ' . $wpdb->term\_relationships . ' AS tr ON (p.ID = tr.object\_id) |
  | 1609 | 1609 | INNER JOIN ' . $wpdb->term\_taxonomy . ' AS tt ON (tr.term\_taxonomy\_id = tt.term\_taxonomy\_id) |
  | 1610 | 1610 | INNER JOIN ' . $wpdb->terms . ' AS t ON (t.term\_id = tt.term\_id) |
  | 1611 | 1611 | WHERE   p.post\_status = %s |
  | 1612 | 1612 | AND p.post\_type = %s |
  | 1613 | 1613 | AND tt.taxonomy = %s AND t.slug = %s AND ID IN (' . implode(',', esc\_sql($ids)) . ') |
  | 1614 | 1614 | ORDER BY p.post\_date DESC', array('publish', $post\_type, $taxo, $cat->slug))); |
  | 1615 | 1615 | if (!empty($results)) { |
  | 1616 | 1616 | if (in\_array($cat->cat\_ID, $this->settings\_sitemap['wpms\_category\_link'])) { |
  | 1617 | 1617 | $cat\_link = '<a href="' . esc\_url(get\_term\_link($cat)) . '"> |
  | 1618 | 1618 | ' . esc\_html($cat->cat\_name) . '</a>'; |
  | 1619 | 1619 | $html     .= '<li class="wpms\_li\_cate wpms\_li\_cate">'; |
  | 1620 | 1620 | $html     .= '<div class="cat\_name">' . $cat\_link . '</div>'; |
  | 1621 | 1621 | $html     .= '</li>'; |
  | 1622 | 1622 | } else { |
  | 1623 | 1623 | $cat\_link = esc\_html($cat->cat\_name); |
  | 1624 | 1624 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_' . $post\_type])) { |
  | 1625 | 1625 | $html .= '<li class="wpms\_li\_cate wpms\_li\_cate">'; |
  | 1626 | 1626 | $html .= '<div class="cat\_name">' . $cat\_link . '</div>'; |
  | 1627 | 1627 | $html .= '</li>'; |
  | 1628 | 1628 | } |
  | 1629 | 1629 | } |
  | 1630 | 1630 |  |
  | 1631 | 1631 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_' . $post\_type])) { |
  | 1632 | 1632 | foreach ($results as $p) { |
  | 1633 | 1633 | $i    = $cat->cat\_ID . '-' . $p->ID; |
  | 1634 | 1634 | $link = get\_permalink($p->ID); |
  | 1635 | 1635 | if (!in\_array($link, $list\_links)) { |
  | 1636 | 1636 | $list\_links[] = $link; |
  | 1637 | 1637 | $html         .= '<li><a href="' . esc\_url($link) . '">' . esc\_html($p->post\_title) . '</a></li>'; |
  | 1638 | 1638 | } |
  | 1639 | 1639 | } |
  | 1640 | 1640 | } |
  | 1641 | 1641 | } |
  | 1642 | 1642 | } |
  | 1643 | 1643 | } |
  | 1644 | 1644 | } else { |
  | 1645 | 1645 | $results = $wpdb->get\_results($wpdb->prepare('SELECT ID, post\_title FROM ' . $wpdb->posts . ' WHERE   post\_status = %s AND post\_type = %s AND ID IN (' . implode(',', esc\_sql($ids)) . ') ORDER BY post\_date DESC', array( |
  | 1646 | 1646 | 'publish', |
  | 1647 | 1647 | $post\_type |
  | 1648 | 1648 | ))); |
  | 1649 | 1649 | if (!empty($results)) { |
  | 1650 | 1650 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_' . $post\_type])) { |
  | 1651 | 1651 | $html .= '<ul>'; |
  | 1652 | 1652 | foreach ($results as $p) { |
  | 1653 | 1653 | $link = get\_permalink($p->ID); |
  | 1654 | 1654 | if (!in\_array($link, $list\_links)) { |
  | 1655 | 1655 | $list\_links[] = $link; |
  | 1656 | 1656 | $html         .= '<li><a href="' . esc\_url(get\_permalink($p->ID)) . '">' . esc\_html($p->post\_title) . '</a></li>'; |
  | 1657 | 1657 | } |
  | 1658 | 1658 | } |
  | 1659 | 1659 | $html .= '</ul>'; |
  | 1660 | 1660 | } |
  | 1661 | 1661 | } |
  | 1662 | 1662 | } |
  | 1663 | 1663 |  |
  | 1664 | 1664 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_' . $post\_type])) { |
  | 1665 | 1665 | $html .= '</ul></div>'; |
  | 1666 | 1666 | } |
  | 1667 | 1667 | $html .= '<div class="holder holder\_sitemaps\_' . $post\_type . '"></div>'; |
  | 1668 | 1668 | //====================================================================================== |
  | 1669 | 1669 | } |
  | 1670 | 1670 | } |
  | 1671 | 1671 | } |
  | 1672 | 1672 | } |
  | 1673 | 1673 | // ==================== |
  | 1674 | 1674 |  |
  | 1675 | 1675 | $ids\_menu   = array(0); |
  | 1676 | 1676 | $check\_menu = array(); |
  | 1677 | 1677 | $terms      = get\_terms(array( |
  | 1678 | 1678 | 'taxonomy'   => 'nav\_menu', |
  | 1679 | 1679 | 'hide\_empty' => true, |
  | 1680 | 1680 | 'orderby'    => 'term\_id', |
  | 1681 | 1681 | 'order'      => 'ASC' |
  | 1682 | 1682 | )); |
  | 1683 | 1683 | foreach ($terms as $term) { |
  | 1684 | 1684 | $list\_submenu\_id = get\_objects\_in\_term($term->term\_id, 'nav\_menu'); |
  | 1685 | 1685 | $ids\_menu        = array\_merge($ids\_menu, $list\_submenu\_id); |
  | 1686 | 1686 | } |
  | 1687 | 1687 |  |
  | 1688 | 1688 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 1689 | 1689 | $this->settings\_sitemap['wpms\_sitemap\_menus'] = $ids\_menu; |
  | 1690 | 1690 | } |
  | 1691 | 1691 |  |
  | 1692 | 1692 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_menus'])) { |
  | 1693 | 1693 | if (!empty($terms)) { |
  | 1694 | 1694 | foreach ($terms as $term) { |
  | 1695 | 1695 | if (!in\_array('sitemap\_menus\_' . $term->term\_id, $check\_menu)) { |
  | 1696 | 1696 | if (empty($this->settings\_sitemap['wpms\_display\_column\_menus'][$term->term\_id])) { |
  | 1697 | 1697 | $this->settings\_sitemap['wpms\_display\_column\_menus'][$term->term\_id] = 1; |
  | 1698 | 1698 | } |
  | 1699 | 1699 |  |
  | 1700 | 1700 | if ((int) $i === (int) $this->settings\_sitemap['wpms\_display\_column\_menus'][$term->term\_id]) { |
  | 1701 | 1701 | $check\_menu[] = 'sitemap\_menus\_' . $term->term\_id; |
  | 1702 | 1702 | $html         .= '<div id="' . esc\_attr('sitemap\_menus\_' . $term->term\_id) . '" class="wpms\_sitemap\_menus">'; |
  | 1703 | 1703 | $viewmenu     = $this->viewMenusFrontend($term, $ids\_menu); |
  | 1704 | 1704 | $html         .= $viewmenu; |
  | 1705 | 1705 |  |
  | 1706 | 1706 | $html .= '</div>'; |
  | 1707 | 1707 | $html .= '<div class="' . esc\_attr('holder holder\_sitemaps\_menus\_' . $term->term\_id) . '"></div>'; |
  | 1708 | 1708 | } |
  | 1709 | 1709 | } |
  | 1710 | 1710 | } |
  | 1711 | 1711 | } |
  | 1712 | 1712 | } |
  | 1713 | 1713 |  |
  | 1714 | 1714 | $html .= '</div>'; |
  | 1715 | 1715 | } |
  | 1716 | 1716 |  |
  | 1717 | 1717 | // ============================================================================== |
  | 1718 | 1718 |  |
  | 1719 | 1719 | $html .= '</div>'; |
  | 1720 | 1720 | $html .= '<div class="wpms\_clearRow"></div>'; |
  | 1721 | 1721 | return $html; |
  | 1722 | 1722 | } |
  | 1723 | 1723 |  |
  | 1724 | 1724 | /\*\* |
  | 1725 | 1725 | \* Display html sitemap in front-end |
  | 1726 | 1726 | \* |
  | 1727 | 1727 | \* @return array|string |
  | 1728 | 1728 | \*/ |
  | 1729 | 1729 | public function sitemapShortcode() |
  | 1730 | 1730 | { |
  | 1731 | 1731 | $html = ''; |
  | 1732 | 1732 | // include style |
  | 1733 | 1733 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 1734 | 1734 | $theme = $this->settings\_sitemap['wpms\_html\_sitemap\_theme']; |
  | 1735 | 1735 | } else { |
  | 1736 | 1736 | $theme = 'default'; |
  | 1737 | 1737 | } |
  | 1738 | 1738 |  |
  | 1739 | 1739 | $custom\_post\_types = get\_post\_types( |
  | 1740 | 1740 | array( |
  | 1741 | 1741 | 'public'              => true, |
  | 1742 | 1742 | 'exclude\_from\_search' => false, |
  | 1743 | 1743 | '\_builtin'            => false |
  | 1744 | 1744 | ) |
  | 1745 | 1745 | ); |
  | 1746 | 1746 |  |
  | 1747 | 1747 | if ($theme === 'default') { |
  | 1748 | 1748 | wp\_enqueue\_style( |
  | 1749 | 1749 | 'html-sitemap', |
  | 1750 | 1750 | plugins\_url('assets/css/html\_sitemap.css', dirname(\_\_FILE\_\_)), |
  | 1751 | 1751 | array(), |
  | 1752 | 1752 | WPMSEO\_VERSION |
  | 1753 | 1753 | ); |
  | 1754 | 1754 |  |
  | 1755 | 1755 | $html = $this->sitemapThemeDefault(); |
  | 1756 | 1756 | } elseif ($theme === 'tab') { |
  | 1757 | 1757 | wp\_enqueue\_script( |
  | 1758 | 1758 | 'wpms\_tabs\_js', |
  | 1759 | 1759 | plugins\_url('assets/js/wpms-tabs.js', dirname(\_\_FILE\_\_)), |
  | 1760 | 1760 | array('jquery'), |
  | 1761 | 1761 | WPMSEO\_VERSION, |
  | 1762 | 1762 | true |
  | 1763 | 1763 | ); |
  | 1764 | 1764 | wp\_enqueue\_style( |
  | 1765 | 1765 | 'wpms\_materialize\_style', |
  | 1766 | 1766 | plugins\_url('assets/css/materialize/materialize\_frontend\_tab\_theme.css', dirname(\_\_FILE\_\_)), |
  | 1767 | 1767 | array(), |
  | 1768 | 1768 | WPMSEO\_VERSION |
  | 1769 | 1769 | ); |
  | 1770 | 1770 | echo '<div id="wpms\_sitemap" class="theme\_tab">'; |
  | 1771 | 1771 | require\_once(WPMETASEO\_ADDON\_PLUGIN\_DIR . 'inc/page/sitemaps/theme/tab/menu\_bar.php'); |
  | 1772 | 1772 | require\_once(WPMETASEO\_ADDON\_PLUGIN\_DIR . 'inc/page/sitemaps/theme/tab/source\_posts.php'); |
  | 1773 | 1773 | require\_once(WPMETASEO\_ADDON\_PLUGIN\_DIR . 'inc/page/sitemaps/theme/tab/source\_pages.php'); |
  | 1774 | 1774 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_customUrl'])) { |
  | 1775 | 1775 | require\_once(WPMETASEO\_ADDON\_PLUGIN\_DIR . 'inc/page/sitemaps/theme/tab/source\_urlcustom.php'); |
  | 1776 | 1776 | } |
  | 1777 | 1777 | // source menu |
  | 1778 | 1778 | $ids\_menu   = array(0); |
  | 1779 | 1779 | $check\_menu = array(); |
  | 1780 | 1780 | $terms      = get\_terms(array('taxonomy' => 'nav\_menu', 'hide\_empty' => true)); |
  | 1781 | 1781 | foreach ($terms as $term) { |
  | 1782 | 1782 | $list\_submenu\_id = get\_objects\_in\_term($term->term\_id, 'nav\_menu'); |
  | 1783 | 1783 | $ids\_menu        = array\_merge($ids\_menu, $list\_submenu\_id); |
  | 1784 | 1784 | } |
  | 1785 | 1785 |  |
  | 1786 | 1786 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 1787 | 1787 | $this->settings\_sitemap['wpms\_sitemap\_menus'] = $ids\_menu; |
  | 1788 | 1788 | } |
  | 1789 | 1789 |  |
  | 1790 | 1790 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_menus'])) { |
  | 1791 | 1791 | if (!empty($terms)) { |
  | 1792 | 1792 | echo '<div id="menu\_source\_menus">'; |
  | 1793 | 1793 | foreach ($terms as $term) { |
  | 1794 | 1794 | if (!in\_array('sitemap\_menus\_' . $term->term\_id, $check\_menu)) { |
  | 1795 | 1795 | $check\_menu[] = 'sitemap\_menus\_' . $term->term\_id; |
  | 1796 | 1796 | echo '<div id="' . esc\_attr('sitemap\_menus\_' . $term->term\_id) . '" class="wpms\_sitemap\_menus">'; |
  | 1797 | 1797 | $viewmenu = $this->viewMenusFrontend($term, $ids\_menu); |
  | 1798 | 1798 | // phpcs:ignore WordPress.Security.EscapeOutput -- Content escaped in the method viewMenusFrontend |
  | 1799 | 1799 | echo $viewmenu; |
  | 1800 | 1800 |  |
  | 1801 | 1801 | echo '</div>'; |
  | 1802 | 1802 | echo '<div class="' . esc\_attr('holder holder\_sitemaps\_menus\_' . $term->term\_id) . '"></div>'; |
  | 1803 | 1803 | } |
  | 1804 | 1804 | } |
  | 1805 | 1805 | echo '</div>'; |
  | 1806 | 1806 | } |
  | 1807 | 1807 | } |
  | 1808 | 1808 | echo '</div>'; |
  | 1809 | 1809 | } elseif ($theme === 'accordions') { |
  | 1810 | 1810 | wp\_enqueue\_style( |
  | 1811 | 1811 | 'wpms\_materialize\_style', |
  | 1812 | 1812 | plugins\_url('assets/css/materialize/materialize\_frontend\_accordions\_theme.css', dirname(\_\_FILE\_\_)), |
  | 1813 | 1813 | array(), |
  | 1814 | 1814 | WPMSEO\_VERSION |
  | 1815 | 1815 | ); |
  | 1816 | 1816 | echo '<div id="wpms\_sitemap" class="theme\_accordions">'; |
  | 1817 | 1817 | echo '<ul class="collapsible wpms\_collapsible" data-collapsible="accordion">'; |
  | 1818 | 1818 | $arrays = array(); |
  | 1819 | 1819 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_menus'])) { |
  | 1820 | 1820 | $arrays['wpms\_display\_order\_menus'] |
  | 1821 | 1821 | = WPMETASEO\_ADDON\_PLUGIN\_DIR . 'inc/page/sitemaps/theme/accordions/source\_menu.php'; |
  | 1822 | 1822 | } |
  | 1823 | 1823 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_posts'])) { |
  | 1824 | 1824 | $arrays['wpms\_display\_order\_posts'] |
  | 1825 | 1825 | = WPMETASEO\_ADDON\_PLUGIN\_DIR . 'inc/page/sitemaps/theme/accordions/source\_posts.php'; |
  | 1826 | 1826 | } |
  | 1827 | 1827 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_pages'])) { |
  | 1828 | 1828 | $arrays['wpms\_display\_order\_pages'] |
  | 1829 | 1829 | = WPMETASEO\_ADDON\_PLUGIN\_DIR . 'inc/page/sitemaps/theme/accordions/source\_pages.php'; |
  | 1830 | 1830 | } |
  | 1831 | 1831 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_customUrl'])) { |
  | 1832 | 1832 | $arrays['wpms\_display\_order\_urls'] |
  | 1833 | 1833 | = WPMETASEO\_ADDON\_PLUGIN\_DIR . 'inc/page/sitemaps/theme/accordions/source\_urlcustom.php'; |
  | 1834 | 1834 | } |
  | 1835 | 1835 |  |
  | 1836 | 1836 | for ($i = 1; $i <= 4; $i ++) { |
  | 1837 | 1837 | foreach ($arrays as $key => $item) { |
  | 1838 | 1838 | if ((int) $this->settings\_sitemap[$key] === (int) $i) { |
  | 1839 | 1839 | require\_once($item); |
  | 1840 | 1840 | } |
  | 1841 | 1841 | } |
  | 1842 | 1842 | } |
  | 1843 | 1843 |  |
  | 1844 | 1844 | echo '</ul>'; |
  | 1845 | 1845 | echo '</div>'; |
  | 1846 | 1846 | } |
  | 1847 | 1847 |  |
  | 1848 | 1848 | return $html; |
  | 1849 | 1849 | } |
  | 1850 | 1850 |  |
  | 1851 | 1851 | /\*\* |
  | 1852 | 1852 | \* Add wpms\_html\_sitemap shortcode in content |
  | 1853 | 1853 | \* |
  | 1854 | 1854 | \* @param string $content Sitemap content |
  | 1855 | 1855 | \* |
  | 1856 | 1856 | \* @return string |
  | 1857 | 1857 | \*/ |
  | 1858 | 1858 | public function sitemapInContent($content) |
  | 1859 | 1859 | { |
  | 1860 | 1860 | global $wpdb; |
  | 1861 | 1861 | $sitemap\_page = $wpdb->get\_row($wpdb->prepare( |
  | 1862 | 1862 | 'SELECT \* FROM ' . $wpdb->prefix . 'posts |
  | 1863 | 1863 | WHERE post\_title = %s AND post\_excerpt = %s AND post\_type = %s', |
  | 1864 | 1864 | array( |
  | 1865 | 1865 | 'WPMS HTML Sitemap', |
  | 1866 | 1866 | 'metaseo\_html\_sitemap', |
  | 1867 | 1867 | 'page' |
  | 1868 | 1868 | ) |
  | 1869 | 1869 | )); |
  | 1870 | 1870 |  |
  | 1871 | 1871 | if (empty($this->settings\_sitemap['wpms\_html\_sitemap\_page']) && !empty($sitemap\_page)) { |
  | 1872 | 1872 | $this->settings\_sitemap['wpms\_html\_sitemap\_page'] = $sitemap\_page->ID; |
  | 1873 | 1873 | } |
  | 1874 | 1874 |  |
  | 1875 | 1875 | if (!empty($this->settings\_sitemap['wpms\_html\_sitemap\_page']) |
  | 1876 | 1876 | && is\_page($this->settings\_sitemap['wpms\_html\_sitemap\_page'])) { |
  | 1877 | 1877 | $sitemap = '[wpms\_html\_sitemap]'; |
  | 1878 | 1878 | switch ($this->settings\_sitemap['wpms\_html\_sitemap\_position']) { |
  | 1879 | 1879 | case 'after': |
  | 1880 | 1880 | $content .= $sitemap; |
  | 1881 | 1881 | break; |
  | 1882 | 1882 | case 'before': |
  | 1883 | 1883 | $content = $sitemap . $content; |
  | 1884 | 1884 | break; |
  | 1885 | 1885 | case 'replace': |
  | 1886 | 1886 | $content = $sitemap; |
  | 1887 | 1887 | break; |
  | 1888 | 1888 | default: |
  | 1889 | 1889 | $content .= $sitemap; |
  | 1890 | 1890 | } |
  | 1891 | 1891 | } |
  | 1892 | 1892 | return $content; |
  | 1893 | 1893 | } |
  | 1894 | 1894 |  |
  | 1895 | 1895 | /\*\* |
  | 1896 | 1896 | \* Get all menu |
  | 1897 | 1897 | \* |
  | 1898 | 1898 | \* @return array |
  | 1899 | 1899 | \*/ |
  | 1900 | 1900 | public function getAllMenus() |
  | 1901 | 1901 | { |
  | 1902 | 1902 | $settings\_sitemap = get\_option('\_metaseo\_settings\_sitemap'); |
  | 1903 | 1903 | $post\_types       = get\_post\_types('', 'names'); |
  | 1904 | 1904 | unset($post\_types['revision']); |
  | 1905 | 1905 | unset($post\_types['attachment']); |
  | 1906 | 1906 | $ids\_posts\_custom = array(0); |
  | 1907 | 1907 | $ids\_categories   = array(); |
  | 1908 | 1908 |  |
  | 1909 | 1909 | if (empty($settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 1910 | 1910 | $args       = array( |
  | 1911 | 1911 | 'posts\_per\_page' => - 1, |
  | 1912 | 1912 | 'post\_type'      => 'nav\_menu\_item', |
  | 1913 | 1913 | 'post\_status'    => 'publish' |
  | 1914 | 1914 | ); |
  | 1915 | 1915 | $query      = new WP\_Query($args); |
  | 1916 | 1916 | $posts\_menu = $query->get\_posts(); |
  | 1917 | 1917 | foreach ($posts\_menu as $k => $v) { |
  | 1918 | 1918 | $type                = get\_post\_meta($v->ID, '\_menu\_item\_type', true); |
  | 1919 | 1919 | $post\_meta\_object\_id = get\_post\_meta($v->ID, '\_menu\_item\_object\_id', true); |
  | 1920 | 1920 | if ($type !== 'taxonomy') { |
  | 1921 | 1921 | $ids\_posts\_custom[] = $post\_meta\_object\_id; |
  | 1922 | 1922 | } else { |
  | 1923 | 1923 | $ids\_categories[] = $post\_meta\_object\_id; |
  | 1924 | 1924 | } |
  | 1925 | 1925 | } |
  | 1926 | 1926 | } else { |
  | 1927 | 1927 | if (!empty($settings\_sitemap['wpms\_sitemap\_menus'])) { |
  | 1928 | 1928 | foreach ($settings\_sitemap['wpms\_sitemap\_menus'] as $k => $v) { |
  | 1929 | 1929 | if (!empty($v['menu\_id'])) { |
  | 1930 | 1930 | $type                = get\_post\_meta($k, '\_menu\_item\_type', true); |
  | 1931 | 1931 | $post\_meta\_object\_id = get\_post\_meta($k, '\_menu\_item\_object\_id', true); |
  | 1932 | 1932 | if ($type !== 'taxonomy') { |
  | 1933 | 1933 | $ids\_posts\_custom[] = $post\_meta\_object\_id; |
  | 1934 | 1934 | } else { |
  | 1935 | 1935 | $ids\_categories[] = $post\_meta\_object\_id; |
  | 1936 | 1936 | } |
  | 1937 | 1937 | } |
  | 1938 | 1938 | } |
  | 1939 | 1939 | } |
  | 1940 | 1940 | } |
  | 1941 | 1941 |  |
  | 1942 | 1942 | $args              = array( |
  | 1943 | 1943 | 'posts\_per\_page' => - 1, |
  | 1944 | 1944 | 'post\_type'      => $post\_types, |
  | 1945 | 1945 | 'post\_\_in'       => $ids\_posts\_custom, |
  | 1946 | 1946 | 'post\_status'    => 'publish' |
  | 1947 | 1947 | ); |
  | 1948 | 1948 | $query             = new WP\_Query($args); |
  | 1949 | 1949 | $menus\_post\_custom = $query->get\_posts(); |
  | 1950 | 1950 | return array('posts\_custom' => $menus\_post\_custom, 'categories' => $ids\_categories); |
  | 1951 | 1951 | } |
  | 1952 | 1952 |  |
  | 1953 | 1953 | /\*\* |
  | 1954 | 1954 | \* Get posts selected in sitemap setting |
  | 1955 | 1955 | \* |
  | 1956 | 1956 | \* @return array |
  | 1957 | 1957 | \*/ |
  | 1958 | 1958 | public function getPostsSitemap() |
  | 1959 | 1959 | { |
  | 1960 | 1960 | $post\_types       = $this->getPostTypes(); |
  | 1961 | 1961 | $ids              = array(0); |
  | 1962 | 1962 | $settings\_sitemap = get\_option('\_metaseo\_settings\_sitemap'); |
  | 1963 | 1963 | if (!empty($settings\_sitemap['wpms\_sitemap\_posts'])) { |
  | 1964 | 1964 | foreach ((array) $settings\_sitemap['wpms\_sitemap\_posts'] as $k => $v) { |
  | 1965 | 1965 | if (!empty($v['post\_id'])) { |
  | 1966 | 1966 | $ids[] = $k; |
  | 1967 | 1967 | } |
  | 1968 | 1968 | } |
  | 1969 | 1969 | } |
  | 1970 | 1970 |  |
  | 1971 | 1971 | $args  = array( |
  | 1972 | 1972 | 'posts\_per\_page' => - 1, |
  | 1973 | 1973 | 'post\_type'      => $post\_types, |
  | 1974 | 1974 | 'post\_\_in'       => $ids, |
  | 1975 | 1975 | 'post\_status'    => 'publish' |
  | 1976 | 1976 | ); |
  | 1977 | 1977 | $query = new WP\_Query($args); |
  | 1978 | 1978 | $posts = $query->get\_posts(); |
  | 1979 | 1979 | return $posts; |
  | 1980 | 1980 | } |
  | 1981 | 1981 |  |
  | 1982 | 1982 | /\*\* |
  | 1983 | 1983 | \* Get a list of all registered post type objects. |
  | 1984 | 1984 | \* |
  | 1985 | 1985 | \* @return array |
  | 1986 | 1986 | \*/ |
  | 1987 | 1987 | public function getPostTypes() |
  | 1988 | 1988 | { |
  | 1989 | 1989 | $post\_types = get\_post\_types(array('public' => true, 'exclude\_from\_search' => false)); |
  | 1990 | 1990 | unset($post\_types['attachment']); |
  | 1991 | 1991 | unset($post\_types['page']); |
  | 1992 | 1992 | return $post\_types; |
  | 1993 | 1993 | } |
  | 1994 | 1994 |  |
  | 1995 | 1995 | /\*\* |
  | 1996 | 1996 | \* Get pages selected in sitemap setting |
  | 1997 | 1997 | \* |
  | 1998 | 1998 | \* @return array |
  | 1999 | 1999 | \*/ |
  | 2000 | 2000 | public function getPagesSitemap() |
  | 2001 | 2001 | { |
  | 2002 | 2002 | $ids              = array(0); |
  | 2003 | 2003 | $settings\_sitemap = get\_option('\_metaseo\_settings\_sitemap'); |
  | 2004 | 2004 | if (!empty($settings\_sitemap['wpms\_sitemap\_pages'])) { |
  | 2005 | 2005 | foreach ($settings\_sitemap['wpms\_sitemap\_pages'] as $k => $v) { |
  | 2006 | 2006 | if (!empty($v['post\_id'])) { |
  | 2007 | 2007 | $ids[] = $k; |
  | 2008 | 2008 | } |
  | 2009 | 2009 | } |
  | 2010 | 2010 | } |
  | 2011 | 2011 |  |
  | 2012 | 2012 | $args  = array( |
  | 2013 | 2013 | 'posts\_per\_page' => - 1, |
  | 2014 | 2014 | 'post\_type'      => 'page', |
  | 2015 | 2015 | 'post\_\_in'       => $ids, |
  | 2016 | 2016 | 'post\_status'    => 'publish' |
  | 2017 | 2017 | ); |
  | 2018 | 2018 | $query = new WP\_Query($args); |
  | 2019 | 2019 | $pages = $query->get\_posts(); |
  | 2020 | 2020 | return $pages; |
  | 2021 | 2021 | } |
  | 2022 | 2022 |  |
  | 2023 | 2023 | /\*\* |
  | 2024 | 2024 | \* Get pages |
  | 2025 | 2025 | \* |
  | 2026 | 2026 | \* @return array|null|object |
  | 2027 | 2027 | \*/ |
  | 2028 | 2028 | public function getPages() |
  | 2029 | 2029 | { |
  | 2030 | 2030 | global $wpdb; |
  | 2031 | 2031 | $pages = $wpdb->get\_results($wpdb->prepare('SELECT ID,post\_title FROM ' . $wpdb->posts . ' WHERE |
  | 2032 | 2032 | post\_status = %s AND post\_type = %s ORDER BY post\_date DESC', array('publish', 'page'))); |
  | 2033 | 2033 | return $pages; |
  | 2034 | 2034 | } |
  | 2035 | 2035 |  |
  | 2036 | 2036 | /\*\* |
  | 2037 | 2037 | \* Get posts by category |
  | 2038 | 2038 | \* |
  | 2039 | 2039 | \* @return array |
  | 2040 | 2040 | \*/ |
  | 2041 | 2041 | public function getPosts() |
  | 2042 | 2042 | { |
  | 2043 | 2043 | $posts     = array(); |
  | 2044 | 2044 | $taxo      = 'category'; |
  | 2045 | 2045 | $categorys = get\_categories(array('hide\_empty' => true, 'taxonomy' => $taxo)); |
  | 2046 | 2046 | global $wpdb, $sitepress; |
  | 2047 | 2047 | foreach ($categorys as $cat) { |
  | 2048 | 2048 | if ($sitepress && !empty($this->settings\_sitemap['wpms\_sitemap\_include\_lang'])) { |
  | 2049 | 2049 | $language\_code = apply\_filters('wpml\_element\_language\_code', null, array('element\_id' => (int)$cat->cat\_ID, 'element\_type' => 'category')); |
  | 2050 | 2050 | if (!in\_array($language\_code, $this->settings\_sitemap['wpms\_sitemap\_include\_lang'])) { |
  | 2051 | 2051 | continue; |
  | 2052 | 2052 | } |
  | 2053 | 2053 | } |
  | 2054 | 2054 |  |
  | 2055 | 2055 | $count = $wpdb->get\_var($wpdb->prepare('SELECT COUNT(p.ID) |
  | 2056 | 2056 | FROM ' . $wpdb->posts . ' AS p |
  | 2057 | 2057 | INNER JOIN ' . $wpdb->term\_relationships . ' AS tr ON (p.ID = tr.object\_id) |
  | 2058 | 2058 | INNER JOIN ' . $wpdb->term\_taxonomy . ' AS tt ON (tr.term\_taxonomy\_id = tt.term\_taxonomy\_id) |
  | 2059 | 2059 | INNER JOIN ' . $wpdb->terms . ' AS t ON (t.term\_id = tt.term\_id) |
  | 2060 | 2060 | WHERE   p.post\_status = %s |
  | 2061 | 2061 | AND p.post\_type = %s |
  | 2062 | 2062 | AND tt.taxonomy = %s AND t.slug=%s |
  | 2063 | 2063 | ORDER BY p.post\_date DESC', array('publish', 'post', $taxo, $cat->slug))); |
  | 2064 | 2064 |  |
  | 2065 | 2065 | $results       = $wpdb->get\_results($wpdb->prepare('SELECT p.ID as ID,p.post\_title as post\_title |
  | 2066 | 2066 | FROM ' . $wpdb->posts . ' AS p |
  | 2067 | 2067 | INNER JOIN ' . $wpdb->term\_relationships . ' AS tr ON (p.ID = tr.object\_id) |
  | 2068 | 2068 | INNER JOIN ' . $wpdb->term\_taxonomy . ' AS tt ON (tr.term\_taxonomy\_id = tt.term\_taxonomy\_id) |
  | 2069 | 2069 | INNER JOIN ' . $wpdb->terms . ' AS t ON (t.term\_id = tt.term\_id) |
  | 2070 | 2070 | WHERE   p.post\_status = %s |
  | 2071 | 2071 | AND p.post\_type = %s |
  | 2072 | 2072 | AND tt.taxonomy = %s AND t.slug=%s |
  | 2073 | 2073 | ORDER BY p.post\_date DESC LIMIT 10', array('publish', 'post', $taxo, $cat->slug))); |
  | 2074 | 2074 | $obj           = new StdClass(); |
  | 2075 | 2075 | $obj->cat\_name = $cat->cat\_name; |
  | 2076 | 2076 | $obj->cat\_ID   = $cat->cat\_ID; |
  | 2077 | 2077 | $obj->taxo     = $taxo; |
  | 2078 | 2078 | $obj->slug     = $cat->slug; |
  | 2079 | 2079 | $obj->results  = array(); |
  | 2080 | 2080 | if (!empty($results)) { |
  | 2081 | 2081 | $obj->results = $results; |
  | 2082 | 2082 | } |
  | 2083 | 2083 | $obj->count\_posts = $count; |
  | 2084 | 2084 | $posts[]          = $obj; |
  | 2085 | 2085 | } |
  | 2086 | 2086 |  |
  | 2087 | 2087 | return $posts; |
  | 2088 | 2088 | } |
  | 2089 | 2089 |  |
  | 2090 | 2090 | /\*\* |
  | 2091 | 2091 | \* Get posts by category |
  | 2092 | 2092 | \* |
  | 2093 | 2093 | \* @param string $post\_type Post type |
  | 2094 | 2094 | \* |
  | 2095 | 2095 | \* @return array |
  | 2096 | 2096 | \*/ |
  | 2097 | 2097 | public function getPostsCustom($post\_type) |
  | 2098 | 2098 | { |
  | 2099 | 2099 | global $wpdb; |
  | 2100 | 2100 | $posts = array(); |
  | 2101 | 2101 |  |
  | 2102 | 2102 | $results = $wpdb->get\_results($wpdb->prepare('SELECT p.ID as ID,p.post\_title as post\_title |
  | 2103 | 2103 | FROM ' . $wpdb->posts . ' AS p |
  | 2104 | 2104 | WHERE   p.post\_status = "publish" AND p.post\_type = %s |
  | 2105 | 2105 | ORDER BY p.post\_date DESC', array($post\_type))); |
  | 2106 | 2106 | if (!empty($results)) { |
  | 2107 | 2107 | $obj = new StdClass(); |
  | 2108 | 2108 | $obj->cat\_name = ''; |
  | 2109 | 2109 | $obj->cat\_ID = ''; |
  | 2110 | 2110 | $obj->taxo = ''; |
  | 2111 | 2111 | $obj->slug = ''; |
  | 2112 | 2112 | $obj->results = $results; |
  | 2113 | 2113 | $posts[] = $obj; |
  | 2114 | 2114 | } |
  | 2115 | 2115 |  |
  | 2116 | 2116 | return $posts; |
  | 2117 | 2117 | } |
  | 2118 | 2118 |  |
  | 2119 | 2119 | /\*\* |
  | 2120 | 2120 | \* Display sitemap menu in front-end |
  | 2121 | 2121 | \* |
  | 2122 | 2122 | \* @param object $term     Term |
  | 2123 | 2123 | \* @param array  $ids\_menu List menu id |
  | 2124 | 2124 | \* |
  | 2125 | 2125 | \* @return string |
  | 2126 | 2126 | \*/ |
  | 2127 | 2127 | public function viewMenusFrontend($term, $ids\_menu) |
  | 2128 | 2128 | { |
  | 2129 | 2129 | $html       = ''; |
  | 2130 | 2130 | $list\_menus = array(); |
  | 2131 | 2131 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 2132 | 2132 | $list\_menus = $ids\_menu; |
  | 2133 | 2133 | } else { |
  | 2134 | 2134 | if (!empty($this->settings\_sitemap['wpms\_sitemap\_menus'])) { |
  | 2135 | 2135 | foreach ($this->settings\_sitemap['wpms\_sitemap\_menus'] as $k => $v) { |
  | 2136 | 2136 | $list\_menus[] = $k; |
  | 2137 | 2137 | } |
  | 2138 | 2138 | } |
  | 2139 | 2139 | } |
  | 2140 | 2140 |  |
  | 2141 | 2141 | $args = array( |
  | 2142 | 2142 | 'orderby'        => 'menu\_order', |
  | 2143 | 2143 | 'order'          => 'ASC', |
  | 2144 | 2144 | 'posts\_per\_page' => - 1, |
  | 2145 | 2145 | 'post\_type'      => 'nav\_menu\_item', |
  | 2146 | 2146 | 'post\_status'    => 'any', |
  | 2147 | 2147 | 'post\_\_in'       => $list\_menus, |
  | 2148 | 2148 | 'tax\_query'      => array( |
  | 2149 | 2149 | array( |
  | 2150 | 2150 | 'taxonomy' => 'nav\_menu', |
  | 2151 | 2151 | 'field'    => 'slug', |
  | 2152 | 2152 | 'terms'    => $term->slug, |
  | 2153 | 2153 | ), |
  | 2154 | 2154 | ), |
  | 2155 | 2155 | ); |
  | 2156 | 2156 |  |
  | 2157 | 2157 | $query    = new WP\_Query($args); |
  | 2158 | 2158 | $submenus = $query->get\_posts(); |
  | 2159 | 2159 | if (!empty($submenus)) { |
  | 2160 | 2160 | $html .= '<h4>' . esc\_html($term->name) . '</h4>'; |
  | 2161 | 2161 | $html .= '<ul class="wpms\_frontend\_menus\_sitemap">'; |
  | 2162 | 2162 | foreach ($submenus as $menu) { |
  | 2163 | 2163 | $type                   = get\_post\_meta($menu->ID, '\_menu\_item\_type', true); |
  | 2164 | 2164 | $type\_menu              = get\_post\_meta($menu->ID, '\_menu\_item\_object', true); |
  | 2165 | 2165 | $id\_menu                = get\_post\_meta($menu->ID, '\_menu\_item\_object\_id', true); |
  | 2166 | 2166 | $this->level[$menu->ID] = 0; |
  | 2167 | 2167 | $level                  = $this->countParent($menu->ID); |
  | 2168 | 2168 | if ($type === 'taxonomy') { |
  | 2169 | 2169 | $post\_submenu = get\_post($menu->ID); |
  | 2170 | 2170 | $title        = $post\_submenu->post\_title; |
  | 2171 | 2171 | if (empty($title)) { |
  | 2172 | 2172 | $term  = get\_term($id\_menu, $type\_menu); |
  | 2173 | 2173 | if (empty($term->name)) { |
  | 2174 | 2174 | continue; |
  | 2175 | 2175 | } |
  | 2176 | 2176 | $title = $term->name; |
  | 2177 | 2177 | } |
  | 2178 | 2178 | } else { |
  | 2179 | 2179 | $post  = get\_post($menu->ID); |
  | 2180 | 2180 | $title = $post->post\_title; |
  | 2181 | 2181 | if (empty($title)) { |
  | 2182 | 2182 | $post\_submenu = get\_post($id\_menu); |
  | 2183 | 2183 | $title        = $post\_submenu->post\_title; |
  | 2184 | 2184 | } |
  | 2185 | 2185 | } |
  | 2186 | 2186 | $type      = get\_post\_meta($menu->ID, '\_menu\_item\_type', true); |
  | 2187 | 2187 | $permalink = $this->getPermalinkSitemap($type, $id\_menu); |
  | 2188 | 2188 | $margin    = $level \* 10; |
  | 2189 | 2189 | $style     = ''; |
  | 2190 | 2190 | if ((int) $level !== 0) { |
  | 2191 | 2191 | $style = 'style="' . esc\_attr('margin-left:' . $margin . 'px') . '"'; |
  | 2192 | 2192 | } |
  | 2193 | 2193 | $html .= '<li class="' . esc\_attr('wpms\_menu\_level\_' . $level) . '" ' . $style . '>'; |
  | 2194 | 2194 | $html .= '<a href="' . esc\_url($permalink) . '">' . esc\_html($title) . '</a>'; |
  | 2195 | 2195 | $html .= '</li>'; |
  | 2196 | 2196 | } |
  | 2197 | 2197 |  |
  | 2198 | 2198 | $html .= '</ul>'; |
  | 2199 | 2199 | } |
  | 2200 | 2200 | return $html; |
  | 2201 | 2201 | } |
  | 2202 | 2202 |  |
  | 2203 | 2203 | /\*\* |
  | 2204 | 2204 | \* Get count parent for a menu |
  | 2205 | 2205 | \* |
  | 2206 | 2206 | \* @param integer $menuID ID of menu |
  | 2207 | 2207 | \* |
  | 2208 | 2208 | \* @return integer |
  | 2209 | 2209 | \*/ |
  | 2210 | 2210 | public function countParent($menuID) |
  | 2211 | 2211 | { |
  | 2212 | 2212 | $parent = get\_post\_meta($menuID, '\_menu\_item\_menu\_item\_parent', true); |
  | 2213 | 2213 | if ((!empty($this->settings\_sitemap['wpms\_sitemap\_menus'][$parent]) || !empty($this->settings\_sitemap['wpms\_sitemap\_menus']->{$parent})) && !empty($parent)) { |
  | 2214 | 2214 | $this->level[$menuID] += 1; |
  | 2215 | 2215 | $this->loopParent($parent, $menuID); |
  | 2216 | 2216 | } else { |
  | 2217 | 2217 | $this->loopParent($parent, $menuID); |
  | 2218 | 2218 | } |
  | 2219 | 2219 |  |
  | 2220 | 2220 | return (int) $this->level[$menuID]; |
  | 2221 | 2221 | } |
  | 2222 | 2222 |  |
  | 2223 | 2223 | /\*\* |
  | 2224 | 2224 | \* Get level list menu |
  | 2225 | 2225 | \* |
  | 2226 | 2226 | \* @param integer $menuID     Current menu id |
  | 2227 | 2227 | \* @param integer $menuIDroot Root menu id |
  | 2228 | 2228 | \* |
  | 2229 | 2229 | \* @return void |
  | 2230 | 2230 | \*/ |
  | 2231 | 2231 | public function loopParent($menuID, $menuIDroot) |
  | 2232 | 2232 | { |
  | 2233 | 2233 | $parent   = get\_post\_meta($menuID, '\_menu\_item\_menu\_item\_parent', true); |
  | 2234 | 2234 | $parent\_1 = get\_post\_meta($parent, '\_menu\_item\_menu\_item\_parent', true); |
  | 2235 | 2235 | if ((!empty($this->settings\_sitemap['wpms\_sitemap\_menus'][$parent]) && !empty($parent)) |
  | 2236 | 2236 | || (!empty($parent\_1) && !empty($parent))) { |
  | 2237 | 2237 | $this->level[$menuIDroot] += 1; |
  | 2238 | 2238 | $this->loopParent($parent, $menuIDroot); |
  | 2239 | 2239 | } |
  | 2240 | 2240 | } |
  | 2241 | 2241 |  |
  | 2242 | 2242 | /\*\* |
  | 2243 | 2243 | \* Display list menu in sitemap settings |
  | 2244 | 2244 | \* |
  | 2245 | 2245 | \* @param object $term Current menu |
  | 2246 | 2246 | \* |
  | 2247 | 2247 | \* @return string |
  | 2248 | 2248 | \*/ |
  | 2249 | 2249 | public function viewMenus($term) |
  | 2250 | 2250 | { |
  | 2251 | 2251 | $list\_submenu\_id = get\_objects\_in\_term($term->term\_id, 'nav\_menu'); |
  | 2252 | 2252 | $args            = array( |
  | 2253 | 2253 | 'orderby'        => 'menu\_order', |
  | 2254 | 2254 | 'order'          => 'ASC', |
  | 2255 | 2255 | 'posts\_per\_page' => - 1, |
  | 2256 | 2256 | 'post\_type'      => 'nav\_menu\_item', |
  | 2257 | 2257 | 'post\_status'    => 'any', |
  | 2258 | 2258 | 'post\_\_in'       => $list\_submenu\_id, |
  | 2259 | 2259 | 'meta\_key'       => '\_menu\_item\_menu\_item\_parent', |
  | 2260 | 2260 | 'meta\_value'     => 0 |
  | 2261 | 2261 | ); |
  | 2262 | 2262 |  |
  | 2263 | 2263 | $query    = new WP\_Query($args); |
  | 2264 | 2264 | $submenus = $query->get\_posts(); |
  | 2265 | 2265 | ?> |
  | 2266 | 2266 | <div class="wpms\_row\_full"> |
  | 2267 | 2267 | <div class="ju-settings-option wpms\_row" style="margin-top: 20px"> |
  | 2268 | 2268 | <div class="wpms\_row\_full"> |
  | 2269 | 2269 | <label class="ju-setting-label text wpms-uppercase" |
  | 2270 | 2270 | data-tippy="<?php echo esc\_attr('Include all elements in the sitemap', 'wp-meta-seo') ?>"> |
  | 2271 | 2271 | <?php echo esc\_html($term->name) ?> |
  | 2272 | 2272 | </label> |
  | 2273 | 2273 | <div class="ju-switch-button"> |
  | 2274 | 2274 | <label class="switch"> |
  | 2275 | 2275 | <?php if (isset($this->settings\_sitemap['check\_all\_menu\_items']) && in\_array($term->term\_id, $this->settings\_sitemap['check\_all\_menu\_items'])) : ?> |
  | 2276 | 2276 | <input class="xm\_cb\_all check\_all\_menu\_items" checked |
  | 2277 | 2277 | data-category="<?php echo esc\_attr('nav\_menu' . $term->slug) ?>" |
  | 2278 | 2278 | value="<?php echo esc\_attr($term->term\_id) ?>" |
  | 2279 | 2279 | id="<?php echo esc\_attr('xm\_cb\_all\_' . $term->slug) ?>" type="checkbox" ?>> |
  | 2280 | 2280 | <?php else : ?> |
  | 2281 | 2281 | <input class="xm\_cb\_all check\_all\_menu\_items" |
  | 2282 | 2282 | data-category="<?php echo esc\_attr('nav\_menu' . $term->slug) ?>" |
  | 2283 | 2283 | value="<?php echo esc\_attr($term->term\_id) ?>" |
  | 2284 | 2284 | id="<?php echo esc\_attr('xm\_cb\_all\_' . $term->slug) ?>" type="checkbox" ?>> |
  | 2285 | 2285 | <?php endif; ?> |
  | 2286 | 2286 | <span class="slider round"></span> |
  | 2287 | 2287 | </label> |
  | 2288 | 2288 | </div> |
  | 2289 | 2289 | </div> |
  | 2290 | 2290 | </div> |
  | 2291 | 2291 |  |
  | 2292 | 2292 | <div class="ju-settings-option wpms\_xmp\_custom\_column wpms\_row wpms\_right m-r-0" style="margin-top: 20px"> |
  | 2293 | 2293 | <div class="wpms\_row\_full"> |
  | 2294 | 2294 | <label class="ju-setting-label wpms\_left" |
  | 2295 | 2295 | data-tippy="<?php echo esc\_attr('Column selection if you’re using the HTML sitemap', 'wp-meta-seo') ?>"> |
  | 2296 | 2296 | <?php esc\_html\_e('HTML Sitemap column', 'wp-meta-seo') ?> |
  | 2297 | 2297 | </label> |
  | 2298 | 2298 | <div class="ju-switch-button"> |
  | 2299 | 2299 | <label> |
  | 2300 | 2300 | <select class="wpms\_display\_column wpms\_display\_column\_menus wpms-large-input m-r-10" |
  | 2301 | 2301 | data-menu\_id="<?php echo esc\_attr($term->term\_id) ?>"> |
  | 2302 | 2302 | <?php |
  | 2303 | 2303 | for ($i = 1; $i <= $this->settings\_sitemap['wpms\_html\_sitemap\_column']; $i ++) { |
  | 2304 | 2304 | if (isset($this->settings\_sitemap['wpms\_display\_column\_menus'][$term->term\_id]) |
  | 2305 | 2305 | && (int) $this->settings\_sitemap['wpms\_display\_column\_menus'][$term->term\_id] === (int) $i) { |
  | 2306 | 2306 | echo '<option selected value="' . esc\_attr($i) . '">' . esc\_html($this->columns[$i]) . '</option>'; |
  | 2307 | 2307 | } else { |
  | 2308 | 2308 | echo '<option value="' . esc\_attr($i) . '">' . esc\_html($this->columns[$i]) . '</option>'; |
  | 2309 | 2309 | } |
  | 2310 | 2310 | } |
  | 2311 | 2311 | ?> |
  | 2312 | 2312 | </select> |
  | 2313 | 2313 | </label> |
  | 2314 | 2314 | </div> |
  | 2315 | 2315 | </div> |
  | 2316 | 2316 | </div> |
  | 2317 | 2317 | </div> |
  | 2318 | 2318 |  |
  | 2319 | 2319 | <?php |
  | 2320 | 2320 | foreach ($submenus as $menu) { |
  | 2321 | 2321 | if (empty($this->settings\_sitemap['wpms\_sitemap\_menus'][$menu->ID]['frequency'])) { |
  | 2322 | 2322 | $this->settings\_sitemap['wpms\_sitemap\_menus'][$menu->ID]['frequency'] = 'monthly'; |
  | 2323 | 2323 | } |
  | 2324 | 2324 | if (empty($this->settings\_sitemap['wpms\_sitemap\_menus'][$menu->ID]['priority'])) { |
  | 2325 | 2325 | $this->settings\_sitemap['wpms\_sitemap\_menus'][$menu->ID]['priority'] = '1.0'; |
  | 2326 | 2326 | } |
  | 2327 | 2327 | $slpr = $this->viewPriority( |
  | 2328 | 2328 | 'priority\_menu\_' . $menu->ID, |
  | 2329 | 2329 | '\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $menu->ID . '][priority]', |
  | 2330 | 2330 | $this->settings\_sitemap['wpms\_sitemap\_menus'][$menu->ID]['priority'] |
  | 2331 | 2331 | ); |
  | 2332 | 2332 | $slfr = $this->viewFrequency( |
  | 2333 | 2333 | 'frequency\_menu\_' . $menu->ID, |
  | 2334 | 2334 | '\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $menu->ID . '][frequency]', |
  | 2335 | 2335 | $this->settings\_sitemap['wpms\_sitemap\_menus'][$menu->ID]['frequency'] |
  | 2336 | 2336 | ); |
  | 2337 | 2337 |  |
  | 2338 | 2338 | $type      = get\_post\_meta($menu->ID, '\_menu\_item\_type', true); |
  | 2339 | 2339 | $type\_menu = get\_post\_meta($menu->ID, '\_menu\_item\_object', true); |
  | 2340 | 2340 | $id\_menu   = get\_post\_meta($menu->ID, '\_menu\_item\_object\_id', true); |
  | 2341 | 2341 | if ($type === 'taxonomy') { |
  | 2342 | 2342 | $post\_submenu = get\_post($menu->ID); |
  | 2343 | 2343 | $title        = $post\_submenu->post\_title; |
  | 2344 | 2344 | if (empty($title)) { |
  | 2345 | 2345 | $term\_menu = get\_term($id\_menu, $type\_menu); |
  | 2346 | 2346 | $title     = $term\_menu->name; |
  | 2347 | 2347 | } |
  | 2348 | 2348 | } else { |
  | 2349 | 2349 | $post  = get\_post($menu->ID); |
  | 2350 | 2350 | $title = $post->post\_title; |
  | 2351 | 2351 | if (empty($title)) { |
  | 2352 | 2352 | $post\_submenu = get\_post($id\_menu); |
  | 2353 | 2353 | $title        = $post\_submenu->post\_title; |
  | 2354 | 2354 | } |
  | 2355 | 2355 | } |
  | 2356 | 2356 | $level = 1; |
  | 2357 | 2357 | echo '<div class="wpms\_row wpms\_row\_record">'; |
  | 2358 | 2358 | $check\_type = get\_post\_meta($menu->ID, '\_menu\_item\_object', true); |
  | 2359 | 2359 | $permalink  = $this->getPermalinkSitemap($check\_type, $id\_menu); |
  | 2360 | 2360 | echo '<div style="float:left;line-height:30px">'; |
  | 2361 | 2361 | if (empty($this->settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 2362 | 2362 | echo '<input class="wpms\_sitemap\_input\_link checked" |
  | 2363 | 2363 | type="hidden" data-type="menu" value="' . esc\_attr($permalink) . '">'; |
  | 2364 | 2364 | echo '<div class="pure-checkbox">'; |
  | 2365 | 2365 | echo '<input class="' . esc\_attr('cb\_sitemaps\_menu wpms\_xmap\_menu nav\_menu' . $term->slug) . '" |
  | 2366 | 2366 | id="' . esc\_attr('wpms\_sitemap\_menus\_' . $menu->ID) . '" type="checkbox" |
  | 2367 | 2367 | name="' . esc\_attr('\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $menu->ID . '][menu\_id]') . '" |
  | 2368 | 2368 | value="' . esc\_attr($menu->ID) . '" checked>'; |
  | 2369 | 2369 | //phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- It cannot display some special characters on the title |
  | 2370 | 2370 | echo '<label for="' . esc\_attr('wpms\_sitemap\_menus\_' . $menu->ID) . '" class="wpms-text">' . $title . '</label>'; |
  | 2371 | 2371 | echo '</div>'; |
  | 2372 | 2372 | } else { |
  | 2373 | 2373 | if (isset($this->settings\_sitemap['wpms\_sitemap\_menus'][$menu->ID]['menu\_id']) |
  | 2374 | 2374 | && (int) $this->settings\_sitemap['wpms\_sitemap\_menus'][$menu->ID]['menu\_id'] === (int) $menu->ID) { |
  | 2375 | 2375 | echo '<input class="wpms\_sitemap\_input\_link checked" |
  | 2376 | 2376 | type="hidden" data-type="menu" value="' . esc\_url($permalink) . '">'; |
  | 2377 | 2377 | echo '<div class="pure-checkbox">'; |
  | 2378 | 2378 | echo '<input class="' . esc\_attr('cb\_sitemaps\_menu wpms\_xmap\_menu nav\_menu' . $term->slug) . '" |
  | 2379 | 2379 | id="' . esc\_attr('wpms\_sitemap\_menus\_' . $menu->ID) . '" type="checkbox" |
  | 2380 | 2380 | name="' . esc\_attr('\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $menu->ID . '][menu\_id]') . '" |
  | 2381 | 2381 | value="' . esc\_attr($menu->ID) . '" checked>'; |
  | 2382 | 2382 | //phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- It cannot display some special characters on the title |
  | 2383 | 2383 | echo '<label for="' . esc\_attr('wpms\_sitemap\_menus\_' . $menu->ID) . '" class="wpms-text">' . $title . '</label>'; |
  | 2384 | 2384 | echo '</div>'; |
  | 2385 | 2385 | } else { |
  | 2386 | 2386 | echo '<input class="wpms\_sitemap\_input\_link" type="hidden" data-type="menu" |
  | 2387 | 2387 | value="' . esc\_url($permalink) . '">'; |
  | 2388 | 2388 | echo '<div class="pure-checkbox">'; |
  | 2389 | 2389 | echo '<input class="' . esc\_attr('cb\_sitemaps\_menu wpms\_xmap\_menu nav\_menu' . $term->slug) . '" |
  | 2390 | 2390 | id="' . esc\_attr('wpms\_sitemap\_menus\_' . $menu->ID) . '" type="checkbox" |
  | 2391 | 2391 | name="' . esc\_attr('\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $menu->ID . '][menu\_id]') . '" |
  | 2392 | 2392 | value="' . esc\_attr($menu->ID) . '">'; |
  | 2393 | 2393 | //phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- It cannot display some special characters on the title |
  | 2394 | 2394 | echo '<label for="' . esc\_attr('wpms\_sitemap\_menus\_' . $menu->ID) . '" class="wpms-text">' . $title . '</label>'; |
  | 2395 | 2395 | echo '</div>'; |
  | 2396 | 2396 | } |
  | 2397 | 2397 | } |
  | 2398 | 2398 |  |
  | 2399 | 2399 | echo '</div>'; |
  | 2400 | 2400 | // phpcs:ignore WordPress.Security.EscapeOutput -- Content escaped in the method MetaSeoSitemap::viewFrequency, MetaSeoSitemap::viewPriority |
  | 2401 | 2401 | echo '<div class="wpms\_right">' . $slpr . $slfr . '</div>'; |
  | 2402 | 2402 | echo '</div>'; |
  | 2403 | 2403 | $this->loop($menu->ID, $level + 1, $this->settings\_sitemap, $term); |
  | 2404 | 2404 | } |
  | 2405 | 2405 |  |
  | 2406 | 2406 | return $this->html; |
  | 2407 | 2407 | } |
  | 2408 | 2408 |  |
  | 2409 | 2409 | /\*\* |
  | 2410 | 2410 | \* Display list menu in sitemap settings |
  | 2411 | 2411 | \* |
  | 2412 | 2412 | \* @param integer $menuID           ID of menu |
  | 2413 | 2413 | \* @param integer $level            Level of menu |
  | 2414 | 2414 | \* @param array   $settings\_sitemap All settings |
  | 2415 | 2415 | \* @param object  $term             Current menu |
  | 2416 | 2416 | \* |
  | 2417 | 2417 | \* @return void |
  | 2418 | 2418 | \*/ |
  | 2419 | 2419 | public function loop($menuID, $level, $settings\_sitemap, $term) |
  | 2420 | 2420 | { |
  | 2421 | 2421 | $args     = array( |
  | 2422 | 2422 | 'post\_type'      => 'nav\_menu\_item', |
  | 2423 | 2423 | 'posts\_per\_page' => - 1, |
  | 2424 | 2424 | 'meta\_key'       => '\_menu\_item\_menu\_item\_parent', |
  | 2425 | 2425 | 'meta\_value'     => $menuID, |
  | 2426 | 2426 | 'orderby'        => 'menu\_order', |
  | 2427 | 2427 | 'order'          => 'ASC' |
  | 2428 | 2428 | ); |
  | 2429 | 2429 | $query    = new WP\_Query($args); |
  | 2430 | 2430 | $submenus = $query->get\_posts(); |
  | 2431 | 2431 |  |
  | 2432 | 2432 | if (!empty($submenus)) { |
  | 2433 | 2433 | foreach ($submenus as $submenu) { |
  | 2434 | 2434 | $type       = get\_post\_meta($submenu->ID, '\_menu\_item\_type', true); |
  | 2435 | 2435 | $type\_menu  = get\_post\_meta($submenu->ID, '\_menu\_item\_object', true); |
  | 2436 | 2436 | $post\_subid = get\_post\_meta($submenu->ID, '\_menu\_item\_object\_id', true); |
  | 2437 | 2437 | if (empty($settings\_sitemap['wpms\_sitemap\_menus'][$submenu->ID]['frequency'])) { |
  | 2438 | 2438 | $settings\_sitemap['wpms\_sitemap\_menus'][$submenu->ID]['frequency'] = 'monthly'; |
  | 2439 | 2439 | } |
  | 2440 | 2440 | if (empty($settings\_sitemap['wpms\_sitemap\_menus'][$submenu->ID]['priority'])) { |
  | 2441 | 2441 | $settings\_sitemap['wpms\_sitemap\_menus'][$submenu->ID]['priority'] = '1.0'; |
  | 2442 | 2442 | } |
  | 2443 | 2443 |  |
  | 2444 | 2444 | if ($type === 'taxonomy') { |
  | 2445 | 2445 | $post\_submenu = get\_post($submenu->ID); |
  | 2446 | 2446 | $title        = $post\_submenu->post\_title; |
  | 2447 | 2447 | if (empty($title)) { |
  | 2448 | 2448 | $term\_sub = get\_term($post\_subid, $type\_menu); |
  | 2449 | 2449 | $title    = $term\_sub->name; |
  | 2450 | 2450 | } |
  | 2451 | 2451 | } else { |
  | 2452 | 2452 | $post\_submenu = get\_post($submenu->ID); |
  | 2453 | 2453 | $title        = $post\_submenu->post\_title; |
  | 2454 | 2454 | if (empty($title)) { |
  | 2455 | 2455 | $post\_submenu = get\_post($post\_subid); |
  | 2456 | 2456 | $title        = $post\_submenu->post\_title; |
  | 2457 | 2457 | } |
  | 2458 | 2458 | } |
  | 2459 | 2459 |  |
  | 2460 | 2460 | $space = ''; |
  | 2461 | 2461 | for ($i = 1; $i <= $level \* 3; $i ++) { |
  | 2462 | 2462 | $space .= '&nbsp;'; |
  | 2463 | 2463 | } |
  | 2464 | 2464 | $slpr = $this->viewPriority( |
  | 2465 | 2465 | 'priority\_menu\_' . $submenu->ID, |
  | 2466 | 2466 | '\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $submenu->post\_id . '][priority]', |
  | 2467 | 2467 | $settings\_sitemap['wpms\_sitemap\_menus'][$submenu->ID]['priority'] |
  | 2468 | 2468 | ); |
  | 2469 | 2469 | $slfr = $this->viewFrequency( |
  | 2470 | 2470 | 'frequency\_menu\_' . $submenu->ID, |
  | 2471 | 2471 | '\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $submenu->post\_id . '][frequency]', |
  | 2472 | 2472 | $settings\_sitemap['wpms\_sitemap\_menus'][$submenu->ID]['frequency'] |
  | 2473 | 2473 | ); |
  | 2474 | 2474 |  |
  | 2475 | 2475 | if (empty($settings\_sitemap['wpms\_check\_firstsave'])) { |
  | 2476 | 2476 | $checkbox = $space . '<input id="' . esc\_attr('wpms\_sitemap\_menus\_' . $submenu->ID) . '" |
  | 2477 | 2477 | class="' . esc\_attr('cb\_sitemaps\_menu wpms\_xmap\_menu nav\_menu' . $term->slug) . '" |
  | 2478 | 2478 | checked name="' . esc\_attr('\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $submenu->ID . '][menu\_id]') . '" |
  | 2479 | 2479 | type="checkbox" value="' . $submenu->ID . '">'; |
  | 2480 | 2480 | } else { |
  | 2481 | 2481 | if (isset($settings\_sitemap['wpms\_sitemap\_menus'][$submenu->ID]['menu\_id']) |
  | 2482 | 2482 | && (int) $settings\_sitemap['wpms\_sitemap\_menus'][$submenu->ID]['menu\_id'] === (int) $submenu->ID) { |
  | 2483 | 2483 | $checkbox = $space . '<input id="' . esc\_attr('wpms\_sitemap\_menus\_' . $submenu->ID) . '" |
  | 2484 | 2484 | class="' . esc\_attr('cb\_sitemaps\_menu wpms\_xmap\_menu nav\_menu' . $term->slug) . '" checked |
  | 2485 | 2485 | name="' . esc\_attr('\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $submenu->ID . '][menu\_id]') . '" |
  | 2486 | 2486 | type="checkbox" value="' . esc\_attr($submenu->ID) . '">'; |
  | 2487 | 2487 | } else { |
  | 2488 | 2488 | $checkbox = $space . '<input id="' . esc\_attr('wpms\_sitemap\_menus\_' . $submenu->ID) . '" |
  | 2489 | 2489 | class="' . esc\_attr('cb\_sitemaps\_menu wpms\_xmap\_menu nav\_menu' . $term->slug) . '" |
  | 2490 | 2490 | name="' . esc\_attr('\_metaseo\_settings\_sitemap[wpms\_sitemap\_menus][' . $submenu->ID . '][menu\_id]') . '" |
  | 2491 | 2491 | type="checkbox" value="' . esc\_attr($submenu->ID) . '">'; |
  | 2492 | 2492 | } |
  | 2493 | 2493 | } |
  | 2494 | 2494 |  |
  | 2495 | 2495 | echo '<div class="wpms\_row wpms\_row\_record">'; |
  | 2496 | 2496 | echo '<div style="float:left;line-height:30px">'; |
  | 2497 | 2497 | echo '<div class="pure-checkbox">'; |
  | 2498 | 2498 | // phpcs:ignore WordPress.Security.EscapeOutput -- Content escaped in this method |
  | 2499 | 2499 | echo $checkbox; |
  | 2500 | 2500 | echo '<label for="' . esc\_attr('wpms\_sitemap\_menus\_' . $submenu->ID) . '" class="wpms-text">' . esc\_html($title) . '</label>'; |
  | 2501 | 2501 | echo '</div>'; |
  | 2502 | 2502 | echo '</div>'; |
  | 2503 | 2503 | // phpcs:ignore WordPress.Security.EscapeOutput -- Content escaped in the method MetaSeoSitemap::viewFrequency, MetaSeoSitemap::viewPriority |
  | 2504 | 2504 | echo '<div class="wpms\_right">' . $slpr . $slfr . '</div>'; |
  | 2505 | 2505 | echo '</div>'; |
  | 2506 | 2506 | $this->loop($submenu->ID, $level + 1, $settings\_sitemap, $term); |
  | 2507 | 2507 | } |
  | 2508 | 2508 | } |
  | 2509 | 2509 | } |
  | 2510 | 2510 |  |
  | 2511 | 2511 | /\*\* |
  | 2512 | 2512 | \* Ajax generate sitemap to xml file |
  | 2513 | 2513 | \* |
  |  | 2514 | \* @return void |
  |  | 2515 | \*/ |
  |  | 2516 | public function regenerateSitemapsAjax() |
  |  | 2517 | { |
  |  | 2518 | if (empty($\_POST['wpms\_nonce']) |
  |  | 2519 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  |  | 2520 | die(); |
  |  | 2521 | } |
  |  | 2522 |  |
  |  | 2523 | $this->regenerateSitemaps(); |
  |  | 2524 | } |
  |  | 2525 | /\*\* |
  |  | 2526 | \* Ajax generate sitemap to xml file |
  |  | 2527 | \* |
  | 2514 | 2528 | \* @param string $type Type |
  | 2515 | 2529 | \* |
  | 2516 | 2530 | \* @return void |
  | 2517 | 2531 | \*/ |
  | 2518 | 2532 | public function regenerateSitemaps($type = 'ajax') |
  | 2519 | 2533 | { |
  |  | 2534 | if (!current\_user\_can('manage\_options')) { |
  |  | 2535 | if ($type === 'ajax') { |
  |  | 2536 | wp\_send\_json(array('status' => false, 'message' => \_\_('There is no permission here', 'wp-meta-seo'))); |
  |  | 2537 | } else { |
  |  | 2538 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2539 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 2540 | } |
  |  | 2541 | } |
  | 2520 | 2542 | if (! function\_exists('get\_home\_path')) { |
  | 2521 | 2543 | include\_once ABSPATH . '/wp-admin/includes/file.php'; |
  | 2522 | 2544 | } |
  | 2523 | 2545 | $wpms\_url\_robot = get\_home\_path() . 'robots.txt'; |
  | 2524 | 2546 | $wpms\_url\_home  = site\_url('/'); |
  | 2525 | 2547 | $this->getSitemapSettings(); |
  | 2526 | 2548 | $this->createSitemap($this->wpms\_sitemap\_name); |
  | 2527 | 2549 | if ((int) $this->settings\_sitemap['wpms\_sitemap\_root'] === 1) { |
  | 2528 | 2550 | $this->createSitemap($this->wpms\_sitemap\_default\_name); |
  | 2529 | 2551 | } |
  | 2530 | 2552 |  |
  | 2531 | 2553 | if (isset($this->settings\_sitemap['wpms\_sitemap\_add']) && (int) $this->settings\_sitemap['wpms\_sitemap\_add'] === 1) { |
  | 2532 | 2554 | if (!file\_exists($wpms\_url\_robot) && !is\_multisite()) { |
  | 2533 | 2555 | ob\_start(); |
  | 2534 | 2556 | // phpcs:ignore WordPress.PHP.DevelopmentFunctions.prevent\_path\_disclosure\_error\_reporting -- Turn off all error reporting to write file |
  | 2535 | 2557 | error\_reporting(0); |
  | 2536 | 2558 | do\_robots(); |
  | 2537 | 2559 | $robots\_content = ob\_get\_clean(); |
  | 2538 | 2560 |  |
  | 2539 | 2561 | $f = fopen($wpms\_url\_robot, 'x'); |
  | 2540 | 2562 | fwrite($f, $robots\_content); |
  | 2541 | 2563 | } |
  | 2542 | 2564 | } |
  | 2543 | 2565 |  |
  | 2544 | 2566 | if (file\_exists($wpms\_url\_robot) && !is\_multisite()) { |
  | 2545 | 2567 | if (!is\_writable($wpms\_url\_robot)) { |
  | 2546 | 2568 | chmod($wpms\_url\_robot, 0755); |
  | 2547 | 2569 | } |
  | 2548 | 2570 |  |
  | 2549 | 2571 | if (is\_writable($wpms\_url\_robot)) { |
  | 2550 | 2572 | $file\_content = file\_get\_contents($wpms\_url\_robot); |
  | 2551 | 2573 | if (isset($this->settings\_sitemap['wpms\_sitemap\_add']) |
  | 2552 | 2574 | && (int) $this->settings\_sitemap['wpms\_sitemap\_add'] === 1 |
  | 2553 | 2575 | && !preg\_match('|Sitemap: ' . $wpms\_url\_home . $this->wpms\_sitemap\_name . '|', $file\_content)) { |
  | 2554 | 2576 | file\_put\_contents( |
  | 2555 | 2577 | $wpms\_url\_robot, |
  | 2556 | 2578 | $file\_content . "\nSitemap: " . $wpms\_url\_home . $this->wpms\_sitemap\_name |
  | 2557 | 2579 | ); |
  | 2558 | 2580 | } |
  | 2559 | 2581 | } else { |
  | 2560 | 2582 | $error = esc\_html\_\_('Cannot edit "robots.txt". Check your permissions', 'wp-meta-seo'); |
  | 2561 | 2583 | if ($type === 'ajax') { |
  | 2562 | 2584 | wp\_send\_json(array('status' => false, 'message' => $error)); |
  | 2563 | 2585 | } |
  | 2564 | 2586 | } |
  | 2565 | 2587 | } |
  | 2566 | 2588 |  |
  | 2567 | 2589 | if ((int)$this->settings\_sitemap['wpms\_sitemap\_root'] === 1) { |
  | 2568 | 2590 | $sitemapUrl = site\_url($this->wpms\_sitemap\_default\_name); |
  | 2569 | 2591 | } else { |
  | 2570 | 2592 | $sitemapUrl = site\_url($this->wpms\_sitemap\_name); |
  | 2571 | 2593 | } |
  | 2572 | 2594 |  |
  | 2573 | 2595 | /\*\* |
  | 2574 | 2596 | \* Submit sitemaps, don't ping if blog is not public. |
  | 2575 | 2597 | \* |
  | 2576 | 2598 | \* @param string Sitemap URL |
  | 2577 | 2599 | \*/ |
  | 2578 | 2600 | do\_action('wpms\_submit\_sitemap', $sitemapUrl); |
  | 2579 | 2601 | if ($type === 'ajax') { |
  | 2580 | 2602 | wp\_send\_json(array('status' => true, 'message' => 'success')); |
  | 2581 | 2603 | } |
  | 2582 | 2604 | } |
  | 2583 | 2605 |  |
  | 2584 | 2606 | /\*\* |
  | 2585 | 2607 | \* Display priority for each item |
  | 2586 | 2608 | \* |
  | 2587 | 2609 | \* @param string $id       Selectbox id |
  | 2588 | 2610 | \* @param string $name     Selectbox name |
  | 2589 | 2611 | \* @param string $selected Selected value |
  | 2590 | 2612 | \* |
  | 2591 | 2613 | \* @return string |
  | 2592 | 2614 | \*/ |
  | 2593 | 2615 | public function viewPriority($id, $name, $selected) |
  | 2594 | 2616 | { |
  | 2595 | 2617 | $values = array('1' => '100%', '0.9' => '90%', '0.8' => '80%', '0.7' => '70%', '0.6' => '60%', '0.5' => '50%'); |
  | 2596 | 2618 | $select = '<select id="' . esc\_attr($id) . '" name="' . esc\_attr($name) . '" class="wpmsleft wpms-large-input">'; |
  | 2597 | 2619 | $select .= '<option value="1">' . esc\_html\_\_('Priority', 'wp-meta-seo') . '</option>'; |
  | 2598 | 2620 | foreach ($values as $k => $v) { |
  | 2599 | 2621 | if ($k === $selected) { |
  | 2600 | 2622 | $select .= '<option selected value="' . esc\_attr($k) . '">' . esc\_html($v) . '</option>'; |
  | 2601 | 2623 | } else { |
  | 2602 | 2624 | $select .= '<option value="' . esc\_attr($k) . '">' . esc\_html($v) . '</option>'; |
  | 2603 | 2625 | } |
  | 2604 | 2626 | } |
  | 2605 | 2627 | $select .= '</select>'; |
  | 2606 | 2628 | return $select; |
  | 2607 | 2629 | } |
  | 2608 | 2630 |  |
  | 2609 | 2631 | /\*\* |
  | 2610 | 2632 | \* Display frequency for each item |
  | 2611 | 2633 | \* |
  | 2612 | 2634 | \* @param string $id       Selectbox id |
  | 2613 | 2635 | \* @param string $name     Selectbox name |
  | 2614 | 2636 | \* @param string $selected Selected value |
  | 2615 | 2637 | \* |
  | 2616 | 2638 | \* @return string |
  | 2617 | 2639 | \*/ |
  | 2618 | 2640 | public function viewFrequency($id, $name, $selected) |
  | 2619 | 2641 | { |
  | 2620 | 2642 | $values = array( |
  | 2621 | 2643 | 'always'  => 'Always', |
  | 2622 | 2644 | 'hourly'  => 'Hourly', |
  | 2623 | 2645 | 'daily'   => 'Daily', |
  | 2624 | 2646 | 'weekly'  => 'Weekly', |
  | 2625 | 2647 | 'monthly' => 'Monthly', |
  | 2626 | 2648 | 'yearly'  => 'Yearly', |
  | 2627 | 2649 | 'never'   => 'Never' |
  | 2628 | 2650 | ); |
  | 2629 | 2651 | $select = '<select id="' . esc\_attr($id) . '" name="' . esc\_attr($name) . '" class="wpmsleft wpms-large-input">'; |
  | 2630 | 2652 | $select .= '<option value="monthly">' . esc\_html\_\_('Frequency', 'wp-meta-seo') . '</option>'; |
  | 2631 | 2653 | foreach ($values as $k => $v) { |
  | 2632 | 2654 | if ($k === $selected) { |
  | 2633 | 2655 | $select .= '<option selected value="' . esc\_attr($k) . '">' . esc\_html($v) . '</option>'; |
  | 2634 | 2656 | } else { |
  | 2635 | 2657 | $select .= '<option value="' . esc\_attr($k) . '">' . esc\_html($v) . '</option>'; |
  | 2636 | 2658 | } |
  | 2637 | 2659 | } |
  | 2638 | 2660 | $select .= '</select>'; |
  | 2639 | 2661 | return $select; |
  | 2640 | 2662 | } |
  | 2641 | 2663 |  |
  | 2642 | 2664 | /\*\* |
  | 2643 | 2665 | \* Get all posts in a category |
  | 2644 | 2666 | \* |
  | 2645 | 2667 | \* @return void |
  | 2646 | 2668 | \*/ |
  | 2647 | 2669 | public function listPostsCategory() |
  | 2648 | 2670 | { |
  | 2649 | 2671 | if (empty($\_POST['wpms\_nonce']) |
  | 2650 | 2672 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2651 | 2673 | die(); |
  |  | 2674 | } |
  |  | 2675 | if (!current\_user\_can('manage\_options')) { |
  |  | 2676 | wp\_send\_json(array('status' => false)); |
  | 2652 | 2677 | } |
  | 2653 | 2678 | set\_time\_limit(0); |
  | 2654 | 2679 | global $wpdb; |
  | 2655 | 2680 | $results = $wpdb->get\_results($wpdb->prepare('SELECT p.ID as ID,p.post\_title as post\_title |
  | 2656 | 2681 | FROM ' . $wpdb->posts . ' AS p |
  | 2657 | 2682 | INNER JOIN ' . $wpdb->term\_relationships . ' AS tr ON (p.ID = tr.object\_id) |
  | 2658 | 2683 | INNER JOIN ' . $wpdb->term\_taxonomy . ' AS tt ON (tr.term\_taxonomy\_id = tt.term\_taxonomy\_id) |
  | 2659 | 2684 | INNER JOIN ' . $wpdb->terms . ' AS t ON (t.term\_id = tt.term\_id) |
  | 2660 | 2685 | WHERE   p.post\_status = "publish" |
  | 2661 | 2686 | AND p.post\_type = "post" |
  | 2662 | 2687 | AND tt.taxonomy = "category" AND t.term\_id=%s |
  | 2663 | 2688 | ORDER BY p.post\_date DESC', array($\_POST['category\_id']))); |
  | 2664 | 2689 |  |
  | 2665 | 2690 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 2666 | 2691 | $html     = ''; |
  | 2667 | 2692 | foreach ($results as $num => $p) { |
  | 2668 | 2693 | if ((int) $num < 10) { |
  | 2669 | 2694 | continue; |
  | 2670 | 2695 | } |
  | 2671 | 2696 |  |
  | 2672 | 2697 | if (empty($settings['wpms\_sitemap\_posts'][$p->ID]['frequency'])) { |
  | 2673 | 2698 | $postfrequency = 'monthly'; |
  | 2674 | 2699 | } else { |
  | 2675 | 2700 | $postfrequency = $settings['wpms\_sitemap\_posts'][$p->ID]['frequency']; |
  | 2676 | 2701 | } |
  | 2677 | 2702 | if (empty($settings['wpms\_sitemap\_posts'][$p->ID]['priority'])) { |
  | 2678 | 2703 | $postpriority = '1.0'; |
  | 2679 | 2704 | } else { |
  | 2680 | 2705 | $postpriority = $settings['wpms\_sitemap\_posts'][$p->ID]['priority']; |
  | 2681 | 2706 | } |
  | 2682 | 2707 | $slpr      = $this->viewPriority( |
  | 2683 | 2708 | 'priority\_posts\_' . $p->ID, |
  | 2684 | 2709 | '\_metaseo\_settings\_sitemap[wpms\_sitemap\_posts][' . $p->ID . '][priority]', |
  | 2685 | 2710 | $postpriority |
  | 2686 | 2711 | ); |
  | 2687 | 2712 | $slfr      = $this->viewFrequency( |
  | 2688 | 2713 | 'frequency\_posts\_' . $p->ID, |
  | 2689 | 2714 | '\_metaseo\_settings\_sitemap[wpms\_sitemap\_posts][' . $p->ID . '][frequency]', |
  | 2690 | 2715 | $postfrequency |
  | 2691 | 2716 | ); |
  | 2692 | 2717 | $permalink = get\_permalink($p->ID); |
  | 2693 | 2718 | $html      .= '<div class="wpms\_row wpms\_row\_record">'; |
  | 2694 | 2719 | $html      .= '<div style="float:left;line-height:30px;">'; |
  | 2695 | 2720 | if (strlen($p->post\_title) > 30) { |
  | 2696 | 2721 | $title = substr($p->post\_title, 0, 30); |
  | 2697 | 2722 | } else { |
  | 2698 | 2723 | $title = $p->post\_title; |
  | 2699 | 2724 | } |
  | 2700 | 2725 | if (isset($settings['wpms\_sitemap\_posts'][$p->ID]['post\_id']) |
  | 2701 | 2726 | && (int) $settings['wpms\_sitemap\_posts'][$p->ID]['post\_id'] === (int) $p->ID) { |
  | 2702 | 2727 | $html .= '<input class="wpms\_sitemap\_input\_link checked" |
  | 2703 | 2728 | type="hidden" data-type="post" value="' . esc\_attr($permalink) . '">'; |
  | 2704 | 2729 | $html .= '<div class="pure-checkbox">'; |
  | 2705 | 2730 | $html .= '<input class="' . esc\_attr('cb\_sitemaps\_posts wpms\_xmap\_posts category' . $\_POST['slug']) . '" |
  | 2706 | 2731 | id="' . esc\_attr('wpms\_sitemap\_posts\_' . $p->ID) . '" type="checkbox" |
  | 2707 | 2732 | name="\_metaseo\_settings\_sitemap[wpms\_sitemap\_posts]" value="' . esc\_attr($p->ID) . '" checked>'; |
  | 2708 | 2733 | //phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- It cannot display some special characters on the title |
  | 2709 | 2734 | $html .= '<label for="' . esc\_attr('wpms\_sitemap\_posts\_' . $p->ID) . '" class="wpms-text">' . $title . '</label>'; |
  | 2710 | 2735 | $html .= '</div>'; |
  | 2711 | 2736 | } else { |
  | 2712 | 2737 | $html .= '<input class="wpms\_sitemap\_input\_link" type="hidden" |
  | 2713 | 2738 | data-type="post" value="' . esc\_attr($permalink) . '">'; |
  | 2714 | 2739 | $html .= '<div class="pure-checkbox">'; |
  | 2715 | 2740 | $html .= '<input class="' . esc\_attr('cb\_sitemaps\_posts wpms\_xmap\_posts category' . $\_POST['slug']) . '" |
  | 2716 | 2741 | id="' . esc\_attr('wpms\_sitemap\_posts\_' . $p->ID) . '" type="checkbox" |
  | 2717 | 2742 | name="\_metaseo\_settings\_sitemap[wpms\_sitemap\_posts]" value="' . esc\_attr($p->ID) . '">'; |
  | 2718 | 2743 | //phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- It cannot display some special characters on the title |
  | 2719 | 2744 | $html .= '<label for="' . esc\_attr('wpms\_sitemap\_posts\_' . $p->ID) . '" class="wpms-text">' . $title . '</label>'; |
  | 2720 | 2745 | $html .= '</div>'; |
  | 2721 | 2746 | } |
  | 2722 | 2747 |  |
  | 2723 | 2748 | $html .= '</div>'; |
  | 2724 | 2749 | // phpcs:ignore WordPress.Security.EscapeOutput -- Content escaped in the method MetaSeoSitemap::viewPriority and MetaSeoSitemap::viewFrequency |
  | 2725 | 2750 | $html .= '<div class="wpms\_right">' . $slpr . $slfr . '</div>'; |
  | 2726 | 2751 | $html .= '</div>'; |
  | 2727 | 2752 | } |
  | 2728 | 2753 |  |
  | 2729 | 2754 | wp\_send\_json($html); |
  | 2730 | 2755 | } |
  | 2731 | 2756 |  |
  | 2732 | 2757 | /\*\* |
  | 2733 | 2758 | \* Ajax update sitemap settings |
  | 2734 | 2759 | \* |
  | 2735 | 2760 | \* @return void |
  | 2736 | 2761 | \*/ |
  | 2737 | 2762 | public function saveSitemapSettings() |
  | 2738 | 2763 | { |
  | 2739 | 2764 | if (empty($\_POST['wpms\_nonce']) |
  | 2740 | 2765 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2741 | 2766 | die(); |
  |  | 2767 | } |
  |  | 2768 | if (!current\_user\_can('manage\_options')) { |
  |  | 2769 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2770 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  | 2742 | 2771 | } |
  | 2743 | 2772 |  |
  | 2744 | 2773 | $settings\_sitemap = get\_option('\_metaseo\_settings\_sitemap'); |
  | 2745 | 2774 | $lists            = array( |
  | 2746 | 2775 | 'wpms\_sitemap\_add'           => 1, |
  | 2747 | 2776 | 'wpms\_sitemap\_root'          => 1, |
  | 2748 | 2777 | 'wpms\_sitemap\_author'        => 0, |
  | 2749 | 2778 | 'wpms\_html\_sitemap\_page'     => 0, |
  | 2750 | 2779 | 'wpms\_html\_sitemap\_column'   => 1, |
  | 2751 | 2780 | 'wpms\_html\_sitemap\_theme'    => 'default', |
  | 2752 | 2781 | 'wpms\_html\_sitemap\_position' => 'after', |
  | 2753 | 2782 | 'wpms\_sitemap\_taxonomies'    => array(), |
  | 2754 | 2783 | 'wpms\_check\_firstsave'       => 0, |
  | 2755 | 2784 | 'wpms\_display\_column\_posts'  => 1, |
  | 2756 | 2785 | 'wpms\_display\_column\_pages'  => 1, |
  | 2757 | 2786 | 'wpms\_category\_link'         => array(), |
  | 2758 | 2787 | 'check\_all\_menu\_items'       => array(), |
  | 2759 | 2788 | 'wpms\_display\_order\_menus'   => 1, |
  | 2760 | 2789 | 'wpms\_display\_order\_posts'   => 2, |
  | 2761 | 2790 | 'wpms\_display\_order\_pages'   => 3, |
  | 2762 | 2791 | 'wpms\_display\_order\_urls'    => 4, |
  | 2763 | 2792 | 'wpms\_category\_select\_all'    => array(), |
  | 2764 | 2793 | 'wpms\_sitemap\_enable\_core' => 0 |
  | 2765 | 2794 | ); |
  | 2766 | 2795 |  |
  | 2767 | 2796 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 2768 | 2797 | $custom\_post\_types = get\_post\_types( |
  | 2769 | 2798 | array( |
  | 2770 | 2799 | 'public'              => true, |
  | 2771 | 2800 | 'exclude\_from\_search' => false, |
  | 2772 | 2801 | '\_builtin'            => false |
  | 2773 | 2802 | ) |
  | 2774 | 2803 | ); |
  | 2775 | 2804 | if (!empty($custom\_post\_types)) { |
  | 2776 | 2805 | foreach ($custom\_post\_types as $post\_type => $label) { |
  | 2777 | 2806 | $lists['wpms\_display\_column\_' . $post\_type] = 1; |
  | 2778 | 2807 | $lists['wpms\_public\_name\_' . $post\_type]    = ''; |
  | 2779 | 2808 | $lists['wpms\_sitemap\_' . $post\_type]        = array(); |
  | 2780 | 2809 | } |
  | 2781 | 2810 | } |
  | 2782 | 2811 |  |
  | 2783 | 2812 | $lists['wpms\_display\_column\_customUrl'] = 1; |
  | 2784 | 2813 | $lists['wpms\_public\_name\_customUrl']    = ''; |
  | 2785 | 2814 | $lists['wpms\_sitemap\_customUrl']        = array(); |
  | 2786 | 2815 | } |
  | 2787 | 2816 |  |
  | 2788 | 2817 | $wpms\_display\_column\_menus = json\_decode(stripslashes($\_POST['wpms\_display\_column\_menus']), true); |
  | 2789 | 2818 | if (!empty($wpms\_display\_column\_menus)) { |
  | 2790 | 2819 | $settings\_sitemap['wpms\_display\_column\_menus'] = $wpms\_display\_column\_menus; |
  | 2791 | 2820 | } |
  | 2792 | 2821 |  |
  | 2793 | 2822 | foreach ($lists as $k => $v) { |
  | 2794 | 2823 | if (isset($\_POST[$k])) { |
  | 2795 | 2824 | $settings\_sitemap[$k] = $\_POST[$k]; |
  | 2796 | 2825 | } else { |
  | 2797 | 2826 | $settings\_sitemap[$k] = $lists[$k]; |
  | 2798 | 2827 | } |
  | 2799 | 2828 | } |
  | 2800 | 2829 |  |
  | 2801 | 2830 | $lists\_selected = array( |
  | 2802 | 2831 | 'wpms\_sitemap\_posts' => array(), |
  | 2803 | 2832 | 'wpms\_sitemap\_pages' => array(), |
  | 2804 | 2833 | 'wpms\_sitemap\_menus' => array() |
  | 2805 | 2834 | ); |
  | 2806 | 2835 |  |
  | 2807 | 2836 | if (is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 2808 | 2837 | $custom\_post\_types = get\_post\_types( |
  | 2809 | 2838 | array( |
  | 2810 | 2839 | 'public'              => true, |
  | 2811 | 2840 | 'exclude\_from\_search' => false, |
  | 2812 | 2841 | '\_builtin'            => false |
  | 2813 | 2842 | ) |
  | 2814 | 2843 | ); |
  | 2815 | 2844 | if (!empty($custom\_post\_types)) { |
  | 2816 | 2845 | foreach ($custom\_post\_types as $post\_type => $label) { |
  | 2817 | 2846 | $lists\_selected['wpms\_sitemap\_' . $post\_type] = array(); |
  | 2818 | 2847 | } |
  | 2819 | 2848 | } |
  | 2820 | 2849 |  |
  | 2821 | 2850 | $lists\_selected['wpms\_sitemap\_customUrl'] = array(); |
  | 2822 | 2851 |  |
  | 2823 | 2852 | // save setting include lang |
  | 2824 | 2853 | if (isset($\_POST['wpms\_lang\_list']) && is\_array($\_POST['wpms\_lang\_list'])) { |
  | 2825 | 2854 | $settings\_sitemap['wpms\_sitemap\_include\_lang'] = $\_POST['wpms\_lang\_list']; |
  | 2826 | 2855 | } |
  | 2827 | 2856 | } |
  | 2828 | 2857 |  |
  | 2829 | 2858 | foreach ($lists\_selected as $k => $v) { |
  | 2830 | 2859 | if (isset($\_POST[$k]) && $\_POST[$k] !== '{}') { |
  | 2831 | 2860 | $values               = json\_decode(stripslashes($\_POST[$k]), true); |
  | 2832 | 2861 | $settings\_sitemap[$k] = $values; |
  | 2833 | 2862 | } else { |
  | 2834 | 2863 | $settings\_sitemap[$k] = array(); |
  | 2835 | 2864 | } |
  | 2836 | 2865 | } |
  | 2837 | 2866 |  |
  | 2838 | 2867 | if (isset($\_POST['wpms\_public\_name\_posts'])) { |
  | 2839 | 2868 | $settings\_sitemap['wpms\_public\_name\_posts'] = $\_POST['wpms\_public\_name\_posts']; |
  | 2840 | 2869 | } |
  | 2841 | 2870 |  |
  | 2842 | 2871 | if (isset($\_POST['wpms\_public\_name\_pages'])) { |
  | 2843 | 2872 | $settings\_sitemap['wpms\_public\_name\_pages'] = $\_POST['wpms\_public\_name\_pages']; |
  | 2844 | 2873 | } |
  | 2845 | 2874 |  |
  | 2846 | 2875 | update\_option('\_metaseo\_settings\_sitemap', $settings\_sitemap); |
  | 2847 | 2876 |  |
  | 2848 | 2877 | $this->updatePostInSitemapWithSelectAll(); |
  | 2849 | 2878 | /\*\* |
  | 2850 | 2879 | \* Save sitemap settings |
  | 2851 | 2880 | \* |
  | 2852 | 2881 | \* @param array Sitemap settings |
  | 2853 | 2882 | \*/ |
  | 2854 | 2883 | do\_action('wpms\_save\_sitemap\_settings', $settings\_sitemap); |
  | 2855 | 2884 | wp\_send\_json(true); |
  | 2856 | 2885 | } |
  | 2857 | 2886 |  |
  | 2858 | 2887 | /\*\* |
  | 2859 | 2888 | \* Update all post into sitemap with select all |
  | 2860 | 2889 | \* |
  | 2861 | 2890 | \* @return void |
  | 2862 | 2891 | \*/ |
  | 2863 | 2892 | public function updatePostInSitemapWithSelectAll() |
  | 2864 | 2893 | { |
  | 2865 | 2894 | global $sitepress; |
  | 2866 | 2895 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 2867 | 2896 | $post\_in\_category = array(); |
  | 2868 | 2897 | $post\_in\_sitemap = array(); |
  | 2869 | 2898 |  |
  | 2870 | 2899 | if (!empty($settings['wpms\_category\_select\_all'])) { |
  | 2871 | 2900 | if ($sitepress) { |
  | 2872 | 2901 | $sitepress->switch\_lang('all', false); |
  | 2873 | 2902 | } |
  | 2874 | 2903 |  |
  | 2875 | 2904 | foreach ($settings['wpms\_category\_select\_all'] as $cat\_id) { |
  | 2876 | 2905 | $args = array( |
  | 2877 | 2906 | 'numberposts' => -1, |
  | 2878 | 2907 | 'category' => $cat\_id, |
  | 2879 | 2908 | 'post\_type' => 'post' |
  | 2880 | 2909 | ); |
  | 2881 | 2910 |  |
  | 2882 | 2911 | $posts = get\_posts($args); |
  | 2883 | 2912 | if (!empty($posts)) { |
  | 2884 | 2913 | foreach ($posts as $post) { |
  | 2885 | 2914 | $post\_in\_category[] = $post->ID; |
  | 2886 | 2915 | } |
  | 2887 | 2916 | } |
  | 2888 | 2917 | } |
  | 2889 | 2918 | } |
  | 2890 | 2919 |  |
  | 2891 | 2920 | if (!empty($settings['wpms\_sitemap\_posts'])) { |
  | 2892 | 2921 | foreach ($settings['wpms\_sitemap\_posts'] as $value) { |
  | 2893 | 2922 | $post\_in\_sitemap[] = (int)$value['post\_id']; |
  | 2894 | 2923 | } |
  | 2895 | 2924 | } |
  | 2896 | 2925 |  |
  | 2897 | 2926 |  |
  | 2898 | 2927 | if (!empty($post\_in\_category)) { |
  | 2899 | 2928 | foreach ($post\_in\_category as $post) { |
  | 2900 | 2929 | if (in\_array($post, $post\_in\_sitemap)) { |
  | 2901 | 2930 | continue; |
  | 2902 | 2931 | } |
  | 2903 | 2932 |  |
  | 2904 | 2933 | $settings['wpms\_sitemap\_posts'][$post] = array( |
  | 2905 | 2934 | 'post\_id'   => $post, |
  | 2906 | 2935 | 'priority'  => '1', |
  | 2907 | 2936 | 'frequency' => 'monthly' |
  | 2908 | 2937 | ); |
  | 2909 | 2938 | } |
  | 2910 | 2939 | } |
  | 2911 | 2940 |  |
  | 2912 | 2941 | update\_option('\_metaseo\_settings\_sitemap', $settings); |
  | 2913 | 2942 | } |
  | 2914 | 2943 |  |
  | 2915 | 2944 | /\*\* |
  | 2916 | 2945 | \* Ajax generate sitemap |
  | 2917 | 2946 | \* |
  | 2918 | 2947 | \* @return void |
  | 2919 | 2948 | \*/ |
  | 2920 | 2949 | public function checkAllCategoryInSitemap() |
  | 2921 | 2950 | { |
  | 2922 | 2951 | if (empty($\_POST['wpms\_nonce']) |
  | 2923 | 2952 | || !wp\_verify\_nonce($\_POST['wpms\_nonce'], 'wpms\_nonce')) { |
  | 2924 | 2953 | die(); |
  | 2925 | 2954 | } |
  |  | 2955 | if (!current\_user\_can('manage\_options')) { |
  |  | 2956 | // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
  |  | 2957 | wp\_die(\_\_('There is no permission here', 'wp-meta-seo')); |
  |  | 2958 | } |
  | 2926 | 2959 | $post\_in\_category = array(); |
  | 2927 | 2960 | $post\_in\_sitemap = array(); |
  | 2928 | 2961 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 2929 | 2962 | $is\_all = $\_POST['wpms\_sitemap\_cateogry\_is\_all']; |
  | 2930 | 2963 | $cat\_id = $\_POST['wpms\_sitemap\_category\_id']; |
  | 2931 | 2964 |  |
  | 2932 | 2965 | if (isset($\_POST['wpms\_sitemap\_category\_id'])) { |
  | 2933 | 2966 | $args = array( |
  | 2934 | 2967 | 'numberposts' => -1, |
  | 2935 | 2968 | 'category' => $cat\_id, |
  | 2936 | 2969 | 'post\_type' => 'post' |
  | 2937 | 2970 | ); |
  | 2938 | 2971 |  |
  | 2939 | 2972 | $posts = get\_posts($args); |
  | 2940 | 2973 | if (!empty($posts)) { |
  | 2941 | 2974 | foreach ($posts as $post) { |
  | 2942 | 2975 | $post\_in\_category[] = $post->ID; |
  | 2943 | 2976 | } |
  | 2944 | 2977 | } |
  | 2945 | 2978 | } |
  | 2946 | 2979 |  |
  | 2947 | 2980 | if (!empty($settings['wpms\_sitemap\_posts'])) { |
  | 2948 | 2981 | foreach ($settings['wpms\_sitemap\_posts'] as $value) { |
  | 2949 | 2982 | $post\_in\_sitemap[] = (int)$value['post\_id']; |
  | 2950 | 2983 | } |
  | 2951 | 2984 | } |
  | 2952 | 2985 |  |
  | 2953 | 2986 | if ($is\_all) { |
  | 2954 | 2987 | if ($post\_in\_category) { |
  | 2955 | 2988 | foreach ($post\_in\_category as $post) { |
  | 2956 | 2989 | if (in\_array($post, $post\_in\_sitemap)) { |
  | 2957 | 2990 | continue; |
  | 2958 | 2991 | } |
  | 2959 | 2992 |  |
  | 2960 | 2993 | $settings['wpms\_sitemap\_posts'][$post] = array( |
  | 2961 | 2994 | 'post\_id'   => $post, |
  | 2962 | 2995 | 'priority'  => '1', |
  | 2963 | 2996 | 'frequency' => 'monthly' |
  | 2964 | 2997 | ); |
  | 2965 | 2998 | } |
  | 2966 | 2999 | } |
  | 2967 | 3000 |  |
  | 2968 | 3001 | array\_push($settings['wpms\_category\_select\_all'], $cat\_id); |
  | 2969 | 3002 | } else { |
  | 2970 | 3003 | if (!empty($post\_in\_sitemap)) { |
  | 2971 | 3004 | foreach ($post\_in\_sitemap as $v) { |
  | 2972 | 3005 | if (in\_array($v, $post\_in\_category)) { |
  | 2973 | 3006 | unset($settings['wpms\_sitemap\_posts'][$v]); |
  | 2974 | 3007 | } |
  | 2975 | 3008 | } |
  | 2976 | 3009 | } |
  | 2977 | 3010 |  |
  | 2978 | 3011 | foreach ($settings['wpms\_category\_select\_all'] as $k => $val) { |
  | 2979 | 3012 | if ((int)$val === (int)$cat\_id) { |
  | 2980 | 3013 | unset($settings['wpms\_category\_select\_all'][$k]); |
  | 2981 | 3014 | } |
  | 2982 | 3015 | } |
  | 2983 | 3016 | } |
  | 2984 | 3017 | $settings['wpms\_category\_select\_all'] = array\_unique($settings['wpms\_category\_select\_all']); |
  | 2985 | 3018 | update\_option('\_metaseo\_settings\_sitemap', $settings); |
  | 2986 | 3019 | $this->regenerateSitemaps(); |
  | 2987 | 3020 | } |
  | 2988 | 3021 |  |
  | 2989 | 3022 | /\*\* |
  | 2990 | 3023 | \* Disable default sitemap of wordpress |
  | 2991 | 3024 | \* |
  | 2992 | 3025 | \* @return void |
  | 2993 | 3026 | \*/ |
  | 2994 | 3027 | public function disableDefaultWPSitemap() |
  | 2995 | 3028 | { |
  | 2996 | 3029 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 2997 | 3030 |  |
  | 2998 | 3031 | if (!empty($settings['wpms\_sitemap\_enable\_core'])) { |
  | 2999 | 3032 | return; |
  | 3000 | 3033 | } |
  | 3001 | 3034 |  |
  | 3002 | 3035 | add\_filter('wp\_sitemaps\_enabled', '\_\_return\_false'); |
  | 3003 | 3036 |  |
  | 3004 | 3037 | if (isset($settings['sitemap'])) { |
  | 3005 | 3038 | add\_action('template\_redirect', array($this, 'redirectDefaultWPSitemap')); |
  | 3006 | 3039 | } |
  | 3007 | 3040 | } |
  | 3008 | 3041 |  |
  | 3009 | 3042 | /\*\* |
  | 3010 | 3043 | \* Redirects requests to the WordPress sitemap to wpmetaseo sitemap. |
  | 3011 | 3044 | \* |
  | 3012 | 3045 | \* @return void |
  | 3013 | 3046 | \*/ |
  | 3014 | 3047 | public function redirectDefaultWPSitemap() |
  | 3015 | 3048 | { |
  | 3016 | 3049 | $settings = get\_option('\_metaseo\_settings\_sitemap'); |
  | 3017 | 3050 | // If there is no path, return |
  | 3018 | 3051 | if (empty($\_SERVER['REQUEST\_URI'])) { |
  | 3019 | 3052 | return; |
  | 3020 | 3053 | } |
  | 3021 | 3054 |  |
  | 3022 | 3055 | $path = sanitize\_text\_field(wp\_unslash($\_SERVER['REQUEST\_URI'])); |
  | 3023 | 3056 |  |
  | 3024 | 3057 | if (strpos($path, '/wp-sitemap') === false) { |
  | 3025 | 3058 | return; |
  | 3026 | 3059 | } |
  | 3027 | 3060 |  |
  | 3028 | 3061 | if (is\_multisite()) { |
  | 3029 | 3062 | $home\_url = preg\_replace( |
  | 3030 | 3063 | '/[^a-zA-ZА-Яа-я0-9\s]/', |
  | 3031 | 3064 | '\_', |
  | 3032 | 3065 | str\_replace('http://', '', str\_replace('https://', '', site\_url())) |
  | 3033 | 3066 | ); |
  | 3034 | 3067 |  |
  | 3035 | 3068 | $location = network\_home\_url('', 'relative') . 'sitemap\_' . $home\_url . '.xml'; |
  | 3036 | 3069 | } else { |
  | 3037 | 3070 | $location = home\_url() . '/' . $this->wpms\_sitemap\_name; |
  | 3038 | 3071 | } |
  | 3039 | 3072 |  |
  | 3040 | 3073 | wp\_safe\_redirect($location, 302, 'WP Meta SEO'); |
  | 3041 | 3074 | exit; |
  | 3042 | 3075 | } |
  | 3043 | 3076 | } |
* ## [wp-meta-seo/trunk/readme.txt](/changeset/2870465/wp-meta-seo/trunk/readme.txt?old=2869205&old_path=wp-meta-seo%2Ftrunk%2Freadme.txt "Show the [2869205:2870465] differences restricted to wp-meta-seo/trunk/readme.txt")

  | [r2869205](/browser/wp-meta-seo/trunk/readme.txt?rev=2869205#L1 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/readme.txt?rev=2870465#L1 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === WP Meta SEO === |
  | 2 | 2 | Contributors: JoomUnited |
  | 3 | 3 | Tags: google, webmaster tools, keywords, meta, meta description, meta keywords, meta title, robots meta, search engine optimization, seo, wordpress seo, yahoo, image optimization, image resize, custom post seo, redirect, redirection, 301, broken link |
  | 4 | 4 | Requires at least: 4.7 |
  | 5 | 5 | Tested up to: 6.1 |
  | 6 |  | Stable tag: 4.5.~~3~~ |
  |  | 6 | Stable tag: 4.5.4 |
  | 7 | 7 | Requires PHP: 5.6 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | 10 | 10 |  |
  | 11 | 11 | WP Meta SEO gives you the control over all your SEO optimization. Bulk SEO content and image SEO, on page content check, 404 and redirect |
  | 12 | 12 |  |
  | 13 | 13 | == Description == |
  | 14 | 14 |  |
  | 15 | 15 | ## WP Meta SEO plugin, main search engine optimization features |
  | 16 | 16 |  |
  | 17 | 17 | \* Bulk edit all website meta on a single view |
  | 18 | 18 | \* Edit meta in content with live SEO analysis |
  | 19 | 19 | \* Fix HTML image resizing in content |
  | 20 | 20 | \* Bulk edit image file name and meta |
  | 21 | 21 | \* Bulk edit SEO link title |
  | 22 | 22 | \* 404 errors redirect and internal broken link checker |
  | 23 | 23 | \* Add Google Analytics tracking information and display statistics on WordPress |
  | 24 | 24 | \* Generate XML and HTML sitemaps |
  | 25 | 25 | \* Facebook and Twitter social sharing custom elements per content |
  | 26 | 26 | \* Breadcrumb generator |
  | 27 | 27 | \* Gutenberg SEO content checker |
  | 28 | 28 | \* Canonical URL management for post, pages |
  | 29 | 29 | and categories |
  | 30 | 30 | \* Elementor full integration with live onPage SEO in the Elementor page editor |
  | 31 | 31 |  |
  | 32 | 32 |  |
  | 33 | 33 | ## WP Meta SEO Addon plugin (optional), additional search engine optimization |
  | 34 | 34 |  |
  | 35 | 35 | > \* Google Search Console keyword suggestion in content |
  | 36 | 36 | > \* Add local business information |
  | 37 | 37 | > \* Email SEO report: SEO data |
  | 38 | 38 | > \* Email SEO report: Google Analytics data |
  | 39 | 39 | > \* Duplicate meta check |
  | 40 | 40 | > \* Automatic schedule crawl content for broken links |
  | 41 | 41 | > \* Redirect URL based on rules |
  | 42 | 42 | > \* Add custom redirect, not only 404 errors |
  | 43 | 43 | > \* Custom post type in sitemaps |
  | 44 | 44 | > \* Sitemap crawl for errors |
  | 45 | 45 | > \* Automatic Google Search Console sitemap submission |
  | 46 | 46 | > \* Google Search Console error import and fix |
  | 47 | 47 | > \* And more! |
  | 48 | 48 |  |
  | 49 | 49 | <a href="https://www.joomunited.com/wordpress-products/wp-meta-seo" rel="friend">More information and feature details here!</a> |
  | 50 | 50 |  |
  | 51 | 51 |  |
  | 52 | 52 | ## Meta information bulk edition and image SEO = |
  | 53 | 53 |  |
  | 54 | 54 | Editing meta information on an existing website can be very long, open each post, edit, close it, open again and almost nobody was doing it. Especially if you need to edit content + image meta. |
  | 55 | 55 | WP Meta SEO is going to list all posts, pages, custom post types and all images. Type your meta content and fix image size and everything is AJAX saved. |
  | 56 | 56 | Plus, a bulk copy feature is available to save tons of time in your SEO optimization process: |
  | 57 | 57 |  |
  | 58 | 58 | \* Content title to All meta titles (optional meta keywords) |
  | 59 | 59 | \* Image name to Image title |
  | 60 | 60 | \* Image name to Image alt |
  | 61 | 61 | \* Optional keyword edition |
  | 62 | 62 |  |
  | 63 | 63 | A bunch of people reduce the size of the pictures in content using handles that results to a HTML resizing. And that's something wrong for SEO, for page loading time and for image quality. |
  | 64 | 64 | WP Meta SEO also include this feature in the bulk edition view, you are notified, and you can now optimize the size of your images in articles, click fix, and it's replaced in your content (no broken links). |
  | 65 | 65 |  |
  | 66 | 66 | ## On-page SEO optimization and content analysis |
  | 67 | 67 |  |
  | 68 | 68 | \* Content SEO smart analysis below content |
  | 69 | 69 | \* Google Search Console keyword suggestion in content |
  | 70 | 70 | \* Search engine snippet preview |
  | 71 | 71 | \* AJAX SEO analysis refresh |
  | 72 | 72 | \* 7 criteria of SEO analysis |
  | 73 | 73 | \* Force SEO criteria validation |
  | 74 | 74 | \* Check: Page title word in content heading |
  | 75 | 75 | \* Check: Page title word in content |
  | 76 | 76 | \* Check: Page URL matches with page title |
  | 77 | 77 | \* Check: Meta title filled |
  | 78 | 78 | \* Check: Meta description filled |
  | 79 | 79 | \* Check: Wrong image resizing |
  | 80 | 80 | \* Check: Image meta title or alt |
  | 81 | 81 | \* Check the Page builders content (Text, HTML, Heading content): |
  | 82 | 82 | Gutenberg, Visual composer, DIVI Builder, Beaver Builder, ACF, Site Origine, Themify builder, Live composer, Elementor |
  | 83 | 83 |  |
  | 84 | 84 | ## 404 and redirect manager |
  | 85 | 85 |  |
  | 86 | 86 | 404 errors are bad for user experience and for your backlinks, Google hates it too: this is something that has to be fixed to improve your SEO. |
  | 87 | 87 | The redirect manager will help you to fix all types of 404 errors you can encounter on your website. |
  | 88 | 88 |  |
  | 89 | 89 | \* Index all 404 errors from external source (external websites) |
  | 90 | 90 | \* Internal broken links check: index all broken links you got in your posts, pages, custom posts, comments |
  | 91 | 91 | \* Possibility to redirect URL, remove link, recheck link |
  | 92 | 92 | \* Redirect all 404 errors to home page |
  | 93 | 93 | \* Index all 404 types: URL and images |
  | 94 | 94 | \* Monitor the 404 hits number |
  | 95 | 95 | \* Flush existing indexed URLs and hits number |
  | 96 | 96 | \* Setup and redirect to a 404-custom page |
  | 97 | 97 |  |
  | 98 | 98 | ## Google Analytics connection |
  | 99 | 99 |  |
  | 100 | 100 | \* Enable analytics statistics in 2 clicks with token access |
  | 101 | 101 | \* Tracking options to exclude WordPress user groups |
  | 102 | 102 | \* File download statistics |
  | 103 | 103 | \* Display Analytics statistics: session, users, organic, page views, bounce, location, pages, referrer, searches, traffic, technology |
  | 104 | 104 |  |
  | 105 | 105 |  |
  | 106 | 106 | ## XML sitemap & HTML sitemap |
  | 107 | 107 |  |
  | 108 | 108 | \* Generate automatically xml sitemap |
  | 109 | 109 | \* Generate automatically HTML sitemap |
  | 110 | 110 | \* Sitemap source: menu selection (can be any content type), post, category of post, pages, author content |
  | 111 | 111 | \* Setup update frequency and priority for each sitemap link |
  | 112 | 112 | \* Crawl all sitemap URL for errors |
  | 113 | 113 |  |
  | 114 | 114 | ## Breadcrumb generator = |
  | 115 | 115 |  |
  | 116 | 116 | \* Rich snippet breadcrumb |
  | 117 | 117 | \* Control breadcrumb separator, links and display |
  | 118 | 118 | \* Generate breadcrumb shortcode |
  | 119 | 119 | \* Generate breadcrumb PHP shortcode |
  | 120 | 120 |  |
  | 121 | 121 | \*\*More details here:\*\* <a href="https://www.joomunited.com/wordpress-products/wp-meta-seo" rel="friend">http://www.joomunited.com/wordpress-products/wp-meta-seo</a> |
  | 122 | 122 |  |
  | 123 | 123 | = Video demo: = |
  | 124 | 124 | [vimeo https://vimeo.com/113695156] |
  | 125 | 125 |  |
  | 126 | 126 |  |
  | 127 | 127 | ## Other search engine optimization features |
  | 128 | 128 |  |
  | 129 | 129 | \* Reduce page weight by fixing HTML image resizing |
  | 130 | 130 | \* See all your snippet in one view |
  | 131 | 131 | \* Image name, title, description, and legend |
  | 132 | 132 | \* Dashboard SEO check |
  | 133 | 133 | \* Automatic AJAX saving SEO content on bulk edition |
  | 134 | 134 | \* On page analysis: fix SEO criteria |
  | 135 | 135 | \* Custom post type meta edition |
  | 136 | 136 | \* All custom post type and WooCommerce SEO optimization |
  | 137 | 137 | \* Yoast SEO meta information importer |
  | 138 | 138 | \* All in one SEO meta information importer |
  | 139 | 139 | \* ImageRecycle image compression integration |
  | 140 | 140 | \* Live Google snippet preview |
  | 141 | 141 | \* Content meta length limit (Google + Yahoo + Bing) |
  | 142 | 142 | \* SEO problem warning |
  | 143 | 143 | \* One click image title copy |
  | 144 | 144 | \* SEO bulk copy: Copy image name to image alt and/or image title |
  | 145 | 145 | \* SEO bulk copy: Copy content title to content meta title |
  | 146 | 146 | \* SEO 404 and redirect: all 404 errors monitoring |
  | 147 | 147 | \* SEO 404 and redirect: Redirect all 404 errors |
  | 148 | 148 | \* SEO 404 and redirect: Internal broken link checker |
  | 149 | 149 | \* SEO 404 and redirect: Custom 404 error page |
  | 150 | 150 | \* SEO 404 and redirect: Redirect all 404 in one click |
  | 151 | 151 | \* Check for SEO error: is robot.txt blocking search engine |
  | 152 | 152 | \* Bulk edit SEO link title in your content |
  | 153 | 153 | \* Follow/No follow on WordPress content |
  | 154 | 154 | \* Generate automatically XML sitemap |
  | 155 | 155 | \* Generate automatically HTML sitemap |
  | 156 | 156 | \* Sitemap source: menu, post, pages, category, and custom posts |
  | 157 | 157 | \* HTML sitemap display with 3 frontend layouts |
  | 158 | 158 |  |
  | 159 | 159 |  |
  | 160 | 160 | = Main plugins from JoomUnited: = |
  | 161 | 161 |  |
  | 162 | 162 | \* <a href="https://www.joomunited.com/wordpress-products/wp-media-folder" rel="friend">WP Media Folder:</a>  Supercharge your media library with folders |
  | 163 | 163 | \* <a href="https://www.joomunited.com/wordpress-products/wp-file-download" rel="friend">WP File Download: </a>  Best in class file and document manager |
  | 164 | 164 | \* <a href="https://www.joomunited.com/wordpress-products/wp-speed-of-light" rel="friend">WP Speed of Light: </a>  Speedup your website easily |
  | 165 | 165 | \* <a href="https://www.joomunited.com/wordpress-products/wp-latest-posts" rel="friend">WP Latest Posts: </a>  Super flexible latest posts and content |
  | 166 | 166 | \* <a href="https://www.joomunited.com/wordpress-products/wp-table-manager" rel="friend"> WP Table Manager: </a>  Create and manage tables with style |
  | 167 | 167 |  |
  | 168 | 168 |  |
  | 169 | 169 | = Support = |
  | 170 | 170 |  |
  | 171 | 171 | A HTML support document is provided with WP Meta SEO on JoomUnited website |
  | 172 | 172 | You are welcome to ask SEO questions on our forum or here in the support section |
  | 173 | 173 | \*\*Documentation here:\*\* <a href="https://www.joomunited.com/support/wordpress-plugins-documentation?extension=wp-meta-seo#document" rel="friend">https://www.joomunited.com/support/wordpress-plugins-documentation?extension=wp-meta-seo#document</a> |
  | 174 | 174 |  |
  | 175 | 175 | == Installation == |
  | 176 | 176 |  |
  | 177 | 177 | = To install the automatically: = |
  | 178 | 178 | \* Through WordPress admin, use the menu: Plugin > Add new |
  | 179 | 179 | \* Search for WP Meta SEO |
  | 180 | 180 | \* Click on install then click activate link |
  | 181 | 181 |  |
  | 182 | 182 | = To install the plugin manually: = |
  | 183 | 183 | \* Download and unzip the plugin wp-meta-seo.zip |
  | 184 | 184 | \* Upload the /wp-meta-seo directory to /wp-content/plugins/ |
  | 185 | 185 | \* Activate the plugin through the 'Plugins' menu on WordPress |
  | 186 | 186 | \* Use the WP Meta SEO WordPress left menu |
  | 187 | 187 |  |
  | 188 | 188 | Once the plugin is installed, open the bulk edition through the admin menu or open a content to load SEO on page analysis. |
  | 189 | 189 | The plugin will check on install if there's Yoast SEO or All in one SEO and ask for a meta import. Global parameter "Search engine visibility" is also checked to avoid SEO error. |
  | 190 | 190 |  |
  | 191 | 191 | == Frequently Asked Questions == |
  | 192 | 192 |  |
  | 193 | 193 | = Will the image rename bulk feature generate broken links? = |
  | 194 | 194 | Not at all, it would have been bad for SEO :) the image name is dynamically replaced in all your content. |
  | 195 | 195 |  |
  | 196 | 196 | = If I edit image title and alt text, will that information be loaded each time my image is in a content?  = |
  | 197 | 197 | There's an SEO option for that :) WP Meta SEO will detect that the image has missing information and once edit it, you will have a list of all the image instance and where it's loaded. |
  | 198 | 198 | So you'll be able to define SEO info for each instance. |
  | 199 | 199 |  |
  | 200 | 200 | = Is WP Meta SEO slowing down my website? = |
  | 201 | 201 | Nope :) All your SEO content is properly stored in the database and automatic SEO checks are also cached or run every 72 hours (unless you force the process) |
  | 202 | 202 |  |
  | 203 | 203 | = Is WP Meta SEO compatible with 3rd party plugins? = |
  | 204 | 204 | YES it is :) All plugins and themes that are using custom post type are compatible, and you'll be able to set up SEO for those content. Plus, Yoast SEO and All in one SEO content can also be imported. |
  | 205 | 205 |  |
  | 206 | 206 | = Is WP Meta SEO fixing 404 errors? = |
  | 207 | 207 | Yes, using a redirect manager tool. WP Meta SEO will index all the 404 you have in your content (internal broken links). |
  | 208 | 208 |  |
  | 209 | 209 | = Can I translate WP Meta SEO? = |
  | 210 | 210 | You're welcome! In the WP Meta SEO package, you got English and French included as standard .po/.mo files. Use the .pot file also available in the /language folder to create your own. |
  | 211 | 211 | You can contact us if you want it to be included in the WP Meta SEO package. |
  | 212 | 212 |  |
  | 213 | 213 | = How can I set up the Google Analytics to get statistics? = |
  | 214 | 214 | First create an account on Google Analytics associated to your domain. Then from the plugin connect your website with your analytics account by copy/pasting a token code. |
  | 215 | 215 |  |
  | 216 | 216 |  |
  | 217 | 217 | = Compatibility = |
  | 218 | 218 | What's the minimum version of WordPress required to run WP Meta SEO? WordPress 4.0 is required. WP Meta SEO may generate PHP errors if you tried to run it on an earlier version, and so it will simply refuse to activate on any version of WordPress that's older than 4.0 |
  | 219 | 219 |  |
  | 220 | 220 | = Where on WordPress does WP Meta SEO plugin should be displayed? = |
  | 221 | 221 | In the admin of WordPress, on the left menu named WP Meta SEO and its sub menu for SEO tools |
  | 222 | 222 |  |
  | 223 | 223 | = How do I uninstall WP Meta SEO? = |
  | 224 | 224 | Go to the Plugins > WP Meta SEO > Deactivate > Delete |
  | 225 | 225 | If you choose to install it later all your SEO data will remain in place (database stored) |
  | 226 | 226 |  |
  | 227 | 227 | = Which browsers work best with the WP Meta SEO administration interface? = |
  | 228 | 228 | WP Meta SEO is using HTML5 features so to be certain run the latest version of Chrome / Firefox / Safari or IE9+ |
  | 229 | 229 |  |
  | 230 | 230 | = Can I help with WP Meta SEO translation? = |
  | 231 | 231 | Yes! you can contact us on our forum. SEO as its language and expression, we would be happy to add yours. |
  | 232 | 232 |  |
  | 233 | 233 | = Why including meta keywords' edition as it's not a SEO rank criteria? = |
  | 234 | 234 | Because it may help in some case for SEO, mainly for multilingual website, it helps search engines to validate the page language. Some automatic SEO tool may use it too. |
  | 235 | 235 |  |
  | 236 | 236 | = Some criteria of the SEO on page analysis does not fit my content = |
  | 237 | 237 | Yes, it may be the case when, for example, you are calling 3rd party plugins in content or using specific page layouts. You have a global option to force validation of SEO criteria. |
  | 238 | 238 | This manual SEO validation on click on the reload analysis button. |
  | 239 | 239 |  |
  | 240 | 240 | = How do I submit my sitemap to the Google Search Console? = |
  | 241 | 241 | From the Sitemap section of the plugin, you got a link to the XML sitemap page. Just copy/paste the link in the Google Search Console. |
  | 242 | 242 | You can also use the link: www.your-website.com/sitemap.xml after checking the option to copy the sitemap to the WordPress install root. |
  | 243 | 243 |  |
  | 244 | 244 | = Is there a real interest for SEO to display a HTML sitemap? = |
  | 245 | 245 | It could be! If you have many pages that need to be indexed with no specific priority. Our advice is to keep only the main menus of your website in the HTML sitemap. |
  | 246 | 246 |  |
  | 247 | 247 | = Is it compatible with Gutenberg Editor? = |
  | 248 | 248 | Yes WP Meta SEO is compatible with Gutenberg editor since 3.7 version. |
  | 249 | 249 |  |
  | 250 | 250 | == Screenshots == |
  | 251 | 251 |  |
  | 252 | 252 | 1. Main dashboard of the plugin with SEO optimization check |
  | 253 | 253 | 1. On page dynamic SEO analysis for posts, pages, page builders and custom post type |
  | 254 | 254 | 1. Bulk content meta edition with AJAX saving |
  | 255 | 255 | 1. Bulk image SEO content edition: title, description, alt, legend text |
  | 256 | 256 | 1. Image resized in HTML (with handles) is automatically detected and can be resized |
  | 257 | 257 | 1. 404 and redirect tool + broken link checker |
  | 258 | 258 | 1. Google Search Console integration: Google keyword suggestions |
  | 259 | 259 | 1. Google Analytics integration with all main information and view selection |
  | 260 | 260 |  |
  | 261 | 261 | == Changelog == |
  | 262 | 262 |  |
  |  | 263 | = 4.5.4 = |
  |  | 264 | \* Fix : Security: Added current\_user\_can() and nonce checks to some functions |
  |  | 265 |  |
  | 263 | 266 | = 4.5.3 = |
  | 264 | 267 | \* Fix : Security: SQL injection by subscriber users |
  | 265 | 268 | \* Fix : Security: arbitrary redirect by subscriber users |
  | 266 | 269 |  |
  | 267 | 270 | = 4.5.2 = |
  | 268 | 271 | \* Fix : A fatal error with PHP 8 |
  | 269 | 272 | \* Fix : Analysis meta title error on WP Meta Seo dashboard when having many posts |
  | 270 | 273 |  |
  | 271 | 274 | = 4.5.1 = |
  | 272 | 275 | \* Add : Update JU translation tool with autosaving |
  | 273 | 276 | \* Add : Instant installation of translation and help texts |
  | 274 | 277 | \* Fix : Cleanup text for meta description |
  | 275 | 278 |  |
  | 276 | 279 | = 4.5.0 = |
  | 277 | 280 | \* Add : SEO optimization meta block for DIVI |
  | 278 | 281 | \* Add : New variables: %page%, %pagetotla%, %pagenumber% for blog pagination |
  | 279 | 282 |  |
  | 280 | 283 | = 4.4.9 = |
  | 281 | 284 | \* Fix : Security issue |
  | 282 | 285 |  |
  | 283 | 286 | = 4.4.8 = |
  | 284 | 287 | \* Fix : Google Analytics connection: update OAuth2 authorization |
  | 285 | 288 |  |
  | 286 | 289 | = 4.4.7 = |
  | 287 | 290 | \* Fix : Escape the breadcrumb separator before outputting it to the page |
  | 288 | 291 |  |
  | 289 | 292 | = 4.4.6 = |
  | 290 | 293 | \* Add : WP Meta Seo widget: Quick SEO Preview |
  | 291 | 294 |  |
  | 292 | 295 | = 4.4.5 = |
  | 293 | 296 | \* Add : Update Google API |
  | 294 | 297 | \* Fix : SEO checker on WP Meta SEO meta box |
  | 295 | 298 |  |
  | 296 | 299 | = 4.4.4 = |
  | 297 | 300 | \* Fix : Google search console on Elementor |
  | 298 | 301 |  |
  | 299 | 302 | = 4.4.3 = |
  | 300 | 303 | \* Add : Default post image setting for social meta |
  | 301 | 304 | \* Fix : SEO checker on Elementor Meta SEO meta box |
  | 302 | 305 |  |
  | 303 | 306 | = 4.4.2 = |
  | 304 | 307 | \* Fix : Remove social meta tags on front-end when they are not filled |
  | 305 | 308 |  |
  | 306 | 309 | = 4.4.1 = |
  | 307 | 310 | \* Fix : Removed unused assets |
  | 308 | 311 |  |
  | 309 | 312 | = 4.4.0 = |
  | 310 | 313 | \* Add : Meta SEO meta box on Elementor |
  | 311 | 314 | \* Add : Bulk editor for post/product categories |
  | 312 | 315 |  |
  | 313 | 316 | = 4.3.7 = |
  | 314 | 317 | \* Fix : The header title issue on some themes |
  | 315 | 318 |  |
  | 316 | 319 | = 4.3.6 = |
  | 317 | 320 | \* Fix : Update settings from old version to Google Analytics |
  | 318 | 321 |  |
  | 319 | 322 | = 4.3.5 = |
  | 320 | 323 | \* Add : New Google Analytics tracking UX |
  | 321 | 324 | \* Add : Support Google Analytics v4 property |
  | 322 | 325 | \* Add : Support Google Tag manager |
  | 323 | 326 | \* Fix : Update Meta SEO meta description length |
  | 324 | 327 | \* Fix : Remove HTML tags from WP Meta SEO meta tags |
  | 325 | 328 |  |
  | 326 | 329 | = 4.3.4 = |
  | 327 | 330 | \* Fix : Remove some jQuery deprecated functions |
  | 328 | 331 | \* Fix : Update Google Analytics library |
  | 329 | 332 |  |
  | 330 | 333 | = 4.3.3 = |
  | 331 | 334 | \* Fix : Update page SEO checker text |
  | 332 | 335 |  |
  | 333 | 336 | = 4.3.2 = |
  | 334 | 337 | \* Fix : Tooltips are going out of the screen on bulk lists |
  | 335 | 338 |  |
  | 336 | 339 | = 4.3.1 = |
  | 337 | 340 | \* Fix : Tooltip display incorrectly |
  | 338 | 341 | \* Fix : Use default WordPress canonical url for all pages when Canonical URL setting disabled |
  | 339 | 342 | \* Fix : Checkbox CSS color on admin panel |
  | 340 | 343 |  |
  | 341 | 344 | = 4.3.0 = |
  | 342 | 345 | \* Add : New content meta editor with direct edition |
  | 343 | 346 | \* Add : New content meta editor on bulk meta editor |
  | 344 | 347 | \* Add : SEO keywords field on post/page edition |
  | 345 | 348 | \* Add : SEO score and keywords in posts list |
  | 346 | 349 |  |
  | 347 | 350 | = 4.2.10 = |
  | 348 | 351 | \* Fix : Adding image alt not always working |
  | 349 | 352 |  |
  | 350 | 353 | = 4.2.9 = |
  | 351 | 354 | \* Fix : Conflict with the Enable jQuery Migrate Helper plugin |
  | 352 | 355 |  |
  | 353 | 356 | = 4.2.8 = |
  | 354 | 357 | \* Add : Disable WordPress core XML sitemap by default |
  | 355 | 358 | \* Fix : Tooltip is not shown on WordPress 5.5 |
  | 356 | 359 |  |
  | 357 | 360 | = 4.2.7 = |
  | 358 | 361 | \* Fix : Google Analytics chart display |
  | 359 | 362 | \* Fix : Some PHP warnings in debug.log |
  | 360 | 363 |  |
  | 361 | 364 | = 4.2.6 = |
  | 362 | 365 | \* Fix : Google Client libraries conflict with BackupBuddy plugin |
  | 363 | 366 |  |
  | 364 | 367 | = 4.2.5 = |
  | 365 | 368 | \* Add : Possibility to automatically add articles to sitemaps |
  | 366 | 369 | \* Fix : Select all posts in the sitemap |
  | 367 | 370 |  |
  | 368 | 371 | = 4.2.4 = |
  | 369 | 372 | \* Add : Possibility to remove category prefix |
  | 370 | 373 | \* Fix : The loader image to display incorrectly in the metabox |
  | 371 | 374 |  |
  | 372 | 375 | = 4.2.3 = |
  | 373 | 376 | \* Fix : Update successfully message after save settings |
  | 374 | 377 | \* Fix : See more posts in category in the sitemap |
  | 375 | 378 | \* Fix : Display XML sitemap link in multisite |
  | 376 | 379 |  |
  | 377 | 380 | = 4.2.2 = |
  | 378 | 381 | \* Fix : JS error in Gutenberg editor that prevent the metabox to be 100% loaded |
  | 379 | 382 |  |
  | 380 | 383 | = 4.2.1 = |
  | 381 | 384 | \* Fix : Translation sharing issue in some browsers |
  | 382 | 385 |  |
  | 383 | 386 | = 4.2.0 = |
  | 384 | 387 | \* Add : Description on admin on each WPMS topic |
  | 385 | 388 | \* Add : Generate automatically a sitemap before the first configuration |
  | 386 | 389 | \* Fix : Edit some styles and tooltips |
  | 387 | 390 | \* Fix : Conflict with other tabs in metabox |
  | 388 | 391 | \* Fix : Some minor errors in the sitemap page |
  | 389 | 392 |  |
  | 390 | 393 | = 4.1.0 = |
  | 391 | 394 | \* Add : Force a Canonical URL per content (post, page...) or category |
  | 392 | 395 | \* Add : Google Analytics update: update app and connexion method |
  | 393 | 396 | \* Add : Better admin responsive display |
  | 394 | 397 | \* Add : Consider publish state in meta bulk editor |
  | 395 | 398 |  |
  | 396 | 399 | = 4.0.13 = |
  | 397 | 400 | \* Fix : JS error when edit a post |
  | 398 | 401 | \* Fix : Exclude external link and replicate the custom link in sitemap |
  | 399 | 402 |  |
  | 400 | 403 | = 4.0.12 = |
  | 401 | 404 | \* Add : Compatibility with Google Search Console integration |
  | 402 | 405 |  |
  | 403 | 406 | = 4.0.11 = |
  | 404 | 407 | \* Fix : Material fonts missing |
  | 405 | 408 |  |
  | 406 | 409 | = 4.0.10 = |
  | 407 | 410 | \* Fix : Blank page when edit post tag & attribute |
  | 408 | 411 | \* Fix : Snippet for homepage is not properly checked |
  | 409 | 412 | \* Add : Opt In feedback on plugin first disabling & review message |
  | 410 | 413 |  |
  | 411 | 414 | = 4.0.9 = |
  | 412 | 415 | \* Fix : JuTranslation duplicate slash in language url |
  | 413 | 416 |  |
  | 414 | 417 | = 4.0.8 = |
  | 415 | 418 | \* Fix : Check version requirements |
  | 416 | 419 |  |
  | 417 | 420 | = 4.0.7 = |
  | 418 | 421 | \* Add : Link editor & Image editor compatible with Gutenberg blocks |
  | 419 | 422 | \* Fix : The sitemap generated ignore anchor links |
  | 420 | 423 |  |
  | 421 | 424 | = 4.0.6 = |
  | 422 | 425 | \* Add : Quick SEO content preview style for WordPress 5.2 |
  | 423 | 426 | \* Fix : Bulk action and meta bulk apply to all images |
  | 424 | 427 | \* Fix : Resize and edit meta information in image editor |
  | 425 | 428 | \* Fix : Put back the sitemap URL instead of the server path |
  | 426 | 429 | \* Fix : Add short description for WooCommerce in SEO analysis |
  | 427 | 430 |  |
  | 428 | 431 | = 4.0.5 = |
  | 429 | 432 | \* Fix : Add index to improve the query performance |
  | 430 | 433 | \* Fix : Rredirect link with xlink |
  | 431 | 434 | \* Fix : Display of HTML Sitemap theme with DIVI theme |
  | 432 | 435 | \* Fix : Redirect link in custom redirect |
  | 433 | 436 |  |
  | 434 | 437 | = 4.0.4 = |
  | 435 | 438 | \* Add : Compatible of the SEO checker and ACF fields |
  | 436 | 439 | \* Add : Change meta title and meta description length |
  | 437 | 440 | \* Fix : Conflict image alt info and Elementor builder |
  | 438 | 441 | \* Fix : Default image and priority of meta |
  | 439 | 442 | \* Fix : Conflict with other SEO plugin (WooCommerce Multivendor plugin) |
  | 440 | 443 | \* Fix : Save new term in product category |
  | 441 | 444 |  |
  | 442 | 445 | = 4.0.3 = |
  | 443 | 446 | \* Fix : XML Sitemap cannot be parsed in google console |
  | 444 | 447 | \* Fix : Resize images and check on dashboard |
  | 445 | 448 | \* Fix : Fix list image in image editor |
  | 446 | 449 | \* Fix : Fix an HTTP error when delete posts |
  | 447 | 450 |  |
  | 448 | 451 | = 4.0.2 = |
  | 449 | 452 | \* Fix : Title undefined in gutenberg editor |
  | 450 | 453 | \* Fix : Compatible with Oxygen Builder |
  | 451 | 454 | \* Fix : Error when save post |
  | 452 | 455 |  |
  | 453 | 456 | = 4.0.1 = |
  | 454 | 457 | \* Fix : Email report doesn't work |
  | 455 | 458 | \* Fix : Css conflict in meta box |
  | 456 | 459 |  |
  | 457 | 460 | = 4.0.0 = |
  | 458 | 461 | \* Add : New admin UX and design |
  | 459 | 462 | \* Add : Settings UX with AJAX search engine |
  | 460 | 463 | \* Add : Implement new plugin dashboard with new criteria checks |
  | 461 | 464 | \* Add : Implement bulk actions on meta bulk editor |
  | 462 | 465 | \* Add : Implement bulk actions on image information bulk editor |
  | 463 | 466 | \* Add : Implement bulk actions on the link title manager |
  | 464 | 467 | \* Add : Check color for meta lenght: check is meta is too short or too long |
  | 465 | 468 | \* Add : Plugin installer with quick configuration |
  | 466 | 469 | \* Add : Environment checker on install (PHP Version, PHP Extensions, Apache Modules) |
  | 467 | 470 | \* Add : System Check menu to notify of server configuration problems after install |
  | 468 | 471 | \* Fix : Sitemap display on frontend |
  | 469 | 472 |  |
  | 470 | 473 | = 3.7.7 = |
  | 471 | 474 | \* Add : Add actions and filters for developers |
  | 472 | 475 |  |
  | 473 | 476 | = 3.7.6 = |
  | 474 | 477 | \* Fix : Redirect to home page when WPMS Addon is not activated |
  | 475 | 478 |  |
  | 476 | 479 | = 3.7.5 = |
  | 477 | 480 | \* Fix : Warning returned on frontend |
  | 478 | 481 | \* Fix : Load Dashboard widget content using ajax method (large amount of data) |
  | 479 | 482 | \* Fix : PHP warning in redirect URL interface |
  | 480 | 483 |  |
  | 481 | 484 | = 3.7.4 = |
  | 482 | 485 | \* Fix : Update alt meta for Elementor image in content |
  | 483 | 486 | \* Fix : Redirect URL |
  | 484 | 487 |  |
  | 485 | 488 | = 3.7.3 = |
  | 486 | 489 | \* Fix : Enhance code readability and performance |
  | 487 | 490 |  |
  | 488 | 491 | = 3.7.2 = |
  | 489 | 492 | \* Fix : JUtranslation share with JoomUnited |
  | 490 | 493 |  |
  | 491 | 494 | = 3.7.1 = |
  | 492 | 495 | \* Fix : Sitemap categories not properly added |
  | 493 | 496 | \* Fix : Broken link display column header |
  | 494 | 497 | \* Fix : Render meta description on frontend |
  | 495 | 498 |  |
  | 496 | 499 | = 3.7.0 = |
  | 497 | 500 | \* Add : Compatible with Gutemberg editor |
  | 498 | 501 | \* Fix : Reload analysis in metabox |
  | 499 | 502 | \* Fix : Render title tag |
  | 500 | 503 |  |
  | 501 | 504 | = 3.6.8 = |
  | 502 | 505 | \* Fix : Conflict with Origin PageBuilder plugin |
  | 503 | 506 | \* Fix : Save post and page slow request |
  | 504 | 507 |  |
  | 505 | 508 | = 3.6.7 = |
  | 506 | 509 | \* Fix : Meta box not loaded on WordPress multisite |
  | 507 | 510 |  |
  | 508 | 511 | = 3.6.6 = |
  | 509 | 512 | \* Fix : Sitemap column display |
  | 510 | 513 | \* Fix : Reload Google Analytics data |
  | 511 | 514 |  |
  | 512 | 515 | = 3.6.5 = |
  | 513 | 516 | \* Fix : Compatibility with php 5.3 and 5.4 |
  | 514 | 517 |  |
  | 515 | 518 | = 3.6.4 = |
  | 516 | 519 | \* Fix : Google analytics tracking code removed some characters |
  | 517 | 520 | \* Fix : Send email (SEO report) |
  | 518 | 521 | \* Fix : Query duplicate meta |
  | 519 | 522 |  |
  | 520 | 523 | = 3.6.3 = |
  | 521 | 524 | \* Add : Change meta description max length (320 characters) |
  | 522 | 525 | \* Fix : Conflict with Antispam Bee plugin |
  | 523 | 526 | \* Fix : Page title word in content heading |
  | 524 | 527 |  |
  | 525 | 528 | = 3.6.2 = |
  | 526 | 529 | \* Fix : Saving translation does not apply |
  | 527 | 530 | \* Fix : JS error when edit a post (public false) |
  | 528 | 531 |  |
  | 529 | 532 | = 3.6.1 = |
  | 530 | 533 | \* Fix : Fatal error on frontend on certain configuration |
  | 531 | 534 |  |
  | 532 | 535 | = 3.6.0 = |
  | 533 | 536 | \* Add : Full code reformating  for better performance and code comments |
  | 534 | 537 | \* Add : Using PHPCS to make standard definitions |
  | 535 | 538 |  |
  | 536 | 539 | = 3.5.3 = |
  | 537 | 540 | \* Fix : Display WordPress page with sitemap |
  | 538 | 541 | \* Fix : Set default image for facebook and Twitter |
  | 539 | 542 | \* Fix : Return error when using undefined get\_term\_meta function |
  | 540 | 543 |  |
  | 541 | 544 | = 3.5.2 = |
  | 542 | 545 | \* Fix : Create robots.txt file for multisite |
  | 543 | 546 | \* Fix : Add meta tags og:type and fb:app\_id (Facebook page share) |
  | 544 | 547 |  |
  | 545 | 548 | = 3.5.1 = |
  | 546 | 549 | \* Language filter for meta, images and sitemap XML |
  | 547 | 550 | \* Fix : Encoding issue on dashboard page |
  | 548 | 551 | \* Fix : JS error when empty post content |
  | 549 | 552 |  |
  | 550 | 553 | = 3.5.0 = |
  | 551 | 554 | \* Fix : Check content of page builders: Visual composer, DIVI Builder, Beaver Builder, ACF, Site Origine, Themify builder, Live composer, Elementor plugins |
  | 552 | 555 | \* Add : Generate rich snippet breadcrumb shortcode and PHP code |
  | 553 | 556 | \* Fix : Redesign the image edition window |
  | 554 | 557 |  |
  | 555 | 558 | = 3.4.1 = |
  | 556 | 559 | \* Add : Meta keywords field in category meta edition |
  | 557 | 560 | \* Add : Update dashboard description and image compression layout |
  | 558 | 561 | \* Fix : Warning when 'wpio\_images' table does not exist |
  | 559 | 562 |  |
  | 560 | 563 | = 3.4.0 = |
  | 561 | 564 | \* Add : Simple Analytics tracking only based on UA or JS snippet |
  | 562 | 565 | \* Add : Add image indexation system for large websites (image bulk editor) |
  | 563 | 566 | \* Add : Apply material design over all plugin views |
  | 564 | 567 | \* Add : Image information: Filter only images that require optimization |
  | 565 | 568 | \* Fix : Conflict with WP Latest Posts plugin |
  | 566 | 569 |  |
  | 567 | 570 | = 3.3.2 = |
  | 568 | 571 | \* Fix : Remove custom redirect rule not applied |
  | 569 | 572 | \* Fix : Wrong value in meta description for category |
  | 570 | 573 | \* Fix : Custom post types alway displayed in HTML sitemaps |
  | 571 | 574 |  |
  | 572 | 575 | = 3.3.1 = |
  | 573 | 576 | \* Fix : Remove upgrade notification when the ADDON is installed |
  | 574 | 577 | \* Fix : Change style for dashboard widgets |
  | 575 | 578 | \* Fix : Change layout and fix criteria in SEO page optimization |
  | 576 | 579 |  |
  | 577 | 580 | = 3.3.0 = |
  | 578 | 581 | \* Add : If an image information are filled, add it by default if empty if image is re-used |
  | 579 | 582 | \* Add : Compatibility with WPML, Polylang for meta edition and Media SEO content |
  | 580 | 583 | \* Add : Possibility to edit meta information on categories |
  | 581 | 584 | \* Add : Pro version notifications of features in some views |
  | 582 | 585 | \* Add : Dashboard widget with 6 SEO criteria |
  | 583 | 586 | \* Fix : Change the 404 error page title to remove the plugin name by default |
  | 584 | 587 |  |
  | 585 | 588 | = 3.2.6 = |
  | 586 | 589 | \* Add : Add builtin translation tool |
  | 587 | 590 | \* Fix : Wrong function used to get description length |
  | 588 | 591 |  |
  | 589 | 592 | = 3.2.5 = |
  | 590 | 593 | \* Add : Check DOM PHP activation install to avoid fatal error |
  | 591 | 594 | \* Fix : Image information edition with greek characters |
  | 592 | 595 |  |
  | 593 | 596 | = 3.2.4 = |
  | 594 | 597 | \* Add : WP Meta SEO Addon compatibility |
  | 595 | 598 | \* Fix : Conflict with DIVI layout injector plugin |
  | 596 | 599 |  |
  | 597 | 600 | = 3.2.3 = |
  | 598 | 601 | \* Fix : Image resize list does not refresh |
  | 599 | 602 | \* Fix : Meta image text replaced by image information |
  | 600 | 603 | \* Fix : Dashboard Alexa rank display |
  | 601 | 604 | \* Fix : Sharp URL suffix are detected as 404 by the redirect manager |
  | 602 | 605 | \* Fix : Phone numbers with '+' are detected as 404 by the redirect manager |
  | 603 | 606 | \* Fix : German characters are broken in the link manager |
  | 604 | 607 |  |
  | 605 | 608 | = 3.2.2 = |
  | 606 | 609 | \* Fix : Image information edition with a quote becomes empty |
  | 607 | 610 | \* Fix : Meta edition character count does not refresh using AJAX |
  | 608 | 611 |  |
  | 609 | 612 | = 3.2.1 = |
  | 610 | 613 | \* Add : Compatibility with WP Speed of Light plugin: https://www.joomunited.com/wordpress-products/wp-speed-of-light |
  | 611 | 614 |  |
  | 612 | 615 | = 3.2.0 = |
  | 613 | 616 | \* Add : Enable Google Analytics tracking with token access |
  | 614 | 617 | \* Add : Tracking options to exclude WordPress user groups from analytics |
  | 615 | 618 | \* Add : File download statistics activation |
  | 616 | 619 | \* Add : Display Analytics statistics: session, users, organic... |
  | 617 | 620 |  |
  | 618 | 621 | = 3.0.2 = |
  | 619 | 622 | \* Add : Add Import meta from Yoast premium plugin |
  | 620 | 623 | \* Fix : Font called from http instead of https from dashboard |
  | 621 | 624 |  |
  | 622 | 625 | = 3.0.1 = |
  | 623 | 626 | \* Fix : XML menu generation don't handle menu levels |
  | 624 | 627 | \* Fix : Mailto links are indexed as 404 error in the redirect manager |
  | 625 | 628 | \* Fix : PHP warning when link editor is activated in editor |
  | 626 | 629 | \* Fix : Secure code |
  | 627 | 630 |  |
  | 628 | 631 | = 3.0.0 = |
  | 629 | 632 | \* Add : Add XML sitemap feature |
  | 630 | 633 | \* Add : Add HTML sitemap feature |
  | 631 | 634 | \* Add : Add sitemap source: menus (any content), post, page, category, author |
  | 632 | 635 | \* Add : Add HTML sitemap content position in page |
  | 633 | 636 | \* Add : Add XML sitemap copy option on root option |
  | 634 | 637 | \* Add : Add XML sitemap link in robot.txt option |
  | 635 | 638 | \* Add : Add help text for all the sitemap parameters |
  | 636 | 639 | \* Add : Add help text for all the global parameters |
  | 637 | 640 | \* Add : Add AJAX sitemap regeneration |
  | 638 | 641 |  |
  | 639 | 642 | = 2.2.1 = |
  | 640 | 643 | \* Add : Update sql sentences to improve query speed |
  | 641 | 644 |  |
  | 642 | 645 | = 2.2.0 = |
  | 643 | 646 | \* Add : Follow/Nofollow bulk link edition |
  | 644 | 647 | \* Add : Link re-index tool from the bulk link editor |
  | 645 | 648 | \* Add : Follow/Nofollow on Wordpress content (onpage SEO) |
  | 646 | 649 | \* Add : Index/Noindex on Wordpress content (onpage SEO) |
  | 647 | 650 |  |
  | 648 | 651 | = 2.1.0 = |
  | 649 | 652 | \* Add : Add ImageRecycle images and PDF compression integration (https://www.imagerecycle.com) |
  | 650 | 653 |  |
  | 651 | 654 | = 2.0.3 = |
  | 652 | 655 | \* Fix : On page analysis return wrong result on header title in content |
  | 653 | 656 | \* Fix : Update language on image bulk edit view |
  | 654 | 657 |  |
  | 655 | 658 | = 2.0.2 = |
  | 656 | 659 | \* Fix : Detect new type of 404 and add tooltip |
  | 657 | 660 | \* Fix : Comment content not detected |
  | 658 | 661 | \* Fix : Autosaving too fast in safari or firefox |
  | 659 | 662 |  |
  | 660 | 663 | = 2.0.1 = |
  | 661 | 664 | \* Fix : Google font style on Safari browser |
  | 662 | 665 |  |
  | 663 | 666 | = 2.0.0 = |
  | 664 | 667 | \* Add : Add 404 and redirect manager |
  | 665 | 668 | \* Add : Add Options to redirect all 404 to home page |
  | 666 | 669 | \* Add : Add Setup 404 page as: WP Meta SEO page, custom page, default page |
  | 667 | 670 |  |
  | 668 | 671 | = 1.7.3 = |
  | 669 | 672 | \* Fix : og: link broken (facebook) |
  | 670 | 673 |  |
  | 671 | 674 | = 1.7.2 = |
  | 672 | 675 | \* Add : Page title as content title or as SEO meta title (option) |
  | 673 | 676 |  |
  | 674 | 677 | = 1.7.1 = |
  | 675 | 678 | \* Add : Edit separately the content title from the meta title (for search engine) |
  | 676 | 679 | \* Fix : Fix RSS feed is broken with WP Meta SEO 1.7.0 |
  | 677 | 680 |  |
  | 678 | 681 | = 1.7.0 = |
  | 679 | 682 | \* Add : Add link SEO title field in link editor tool |
  | 680 | 683 | \* Add : Add a SEO bulk edition view on your links titles (of all your content) |
  | 681 | 684 | \* Add : Automatic meta SEO addition for category view: add category title as meta title and category description as meta description |
  | 682 | 685 | \* Add : Add SEO dashboard check for link titles |
  | 683 | 686 | \* Fix : WooCommerce meta description and title in category view (automatic) |
  | 684 | 687 | \* Fix : WP Meta SEO language to be conform to plugin directory translation tool |
  | 685 | 688 |  |
  | 686 | 689 | = 1.6.0 = |
  | 687 | 690 | \* Add : Add meta keywords edition in bulk editor |
  | 688 | 691 | \* Add : Add option to for SEO criteria validation |
  | 689 | 692 |  |
  | 690 | 693 | = 1.5.1 = |
  | 691 | 694 | \* Fix : Home page meta not working on some themes |
  | 692 | 695 | \* Fix : Break foreach when search title in SEO content (title in heading) |
  | 693 | 696 |  |
  | 694 | 697 | = 1.5.0 = |
  | 695 | 698 | \* Add : Add help tooltip to explain on page validation SEO criteria |
  | 696 | 699 | \* Add : Add help tooltip to explain dashboard SEO parameters |
  | 697 | 700 | \* Add : Put snippet preview title in a column on SEO bulk view edition |
  | 698 | 701 | \* Add : Add SEO and check notification for robot.txt that lock search engine |
  | 699 | 702 | \* Add : Update EN and FR language files |
  | 700 | 703 |  |
  | 701 | 704 | = 1.4.0 = |
  | 702 | 705 | \* Add : Bulk copy new option: content title to meta title |
  | 703 | 706 | \* Add : Bulk copy new option: image name to alt text |
  | 704 | 707 | \* Add : Bulk copy new option: image name to image title |
  | 705 | 708 | \* Fix : Twitter card on SEO on page optimization |
  | 706 | 709 | \* Fix : SEO meta empty in some themes |
  | 707 | 710 |  |
  | 708 | 711 | = 1.3.0 = |
  | 709 | 712 | \* Add : New SEO check dashboard |
  | 710 | 713 | \* Add : Check for SEO permalinks |
  | 711 | 714 | \* Add : Check for meta description |
  | 712 | 715 | \* Add : Check for image HTML resizing |
  | 713 | 716 | \* Add : Check for image SEO: title, alt and description |
  | 714 | 717 | \* Add : Check for new content |
  | 715 | 718 |  |
  | 716 | 719 | = 1.2.0 = |
  | 717 | 720 | \* Add : Change language to po/mo files |
  | 718 | 721 | \* Add : Include .pot file and French language |
  | 719 | 722 | \* Add : Setting for home page meta |
  | 720 | 723 | \* Add : Bigger edit meta boxes |
  | 721 | 724 | \* Add : Update icon of notification in meta view |
  | 722 | 725 |  |
  | 723 | 726 | = 1.1.0 = |
  | 724 | 727 | \* Add : On page SEO analysis |
  | 725 | 728 | \* Add : Social sharing custom content |
  | 726 | 729 |  |
  | 727 | 730 | = 1.0.4 = |
  | 728 | 731 | \* Fix : Check empty array |
  | 729 | 732 |  |
  | 730 | 733 | = 1.0.3 = |
  | 731 | 734 | \* Fix : Escape meta title and meta description |
  | 732 | 735 |  |
  | 733 | 736 | = 1.0.2 = |
  | 734 | 737 | \* Fix : Filter broken and icons broken |
  | 735 | 738 |  |
  | 736 | 739 | = 1.0.1 = |
  | 737 | 740 | \* Fix : display (no title) in column title if post is no titled |
  | 738 | 741 |  |
  | 739 | 742 | = 1.0.0 = |
  | 740 | 743 | \* Add : Initial release |
  | 741 | 744 |  |
  | 742 | 745 |  |
  | 743 | 746 |  |
  | 744 | 747 | == Upgrade Notice == |
  | 745 | 748 |  |
  | 746 | 749 | Update through the automatic WordPress updater, all WP Meta SEO content will remain in place. |
  | 747 | 750 | You WON'T lose any SEO content: meta, alt, titles |
  | 748 | 751 |  |
  | 749 | 752 |  |
  | 750 | 753 |  |
  | 751 | 754 | == Requirements == |
  | 752 | 755 |  |
  | 753 | 756 | = !!NEW in latest & fresh 3.0 version!! = |
  | 754 | 757 | Sitemap feature with XML for the Google Search Console and HTML with display option. |
  | 755 | 758 |  |
  | 756 | 759 | = SEO vision = |
  | 757 | 760 |  |
  | 758 | 761 | Search engines are a major source of traffic for most websites. That's why our users often ask us for SEO tips and plugins that can help improve SEO of their WordPress sites. |
  | 759 | 762 | WP Meta SEO has been created to give to professionals and final users some real SEO tools to get better SEO rank. We think that SEO has to be something logic and durable. Overall SEO optimization requires a lot of time for each website, each client. |
  | 760 | 763 |  |
  | 761 | 764 | WP Meta SEO provides some automatic tools to analyze your content and give to search engine a better content to analyze. |
  | 762 | 765 |  |
  | 763 | 766 | WP Meta SEO on each new version, will focus on both "On-page SEO" and "Global website SEO" factors: |
  | 764 | 767 | On-page SEO: Features that help you optimize a single page, e.g. the article you are working on (with a live analysis). Common functionality includes giving SEO scores to each article, content/meta comparison, page analysis tools and making recommendations how to improve the SEO of a post. |
  | 765 | 768 | Site-wide SEO: it's more about your whole site and structure between multiple articles. Common functionality includes title formatting, meta tag optimization as well as internal linking and redirects management. |
  | 766 | 769 |  |
  | 767 | 770 | And... don't forget to check each month your SEO dashboard :) |
  | 768 | 771 |  |
  | 769 | 772 | PHP 5.6+, WordPress 5.x |
* ## [wp-meta-seo/trunk/wp-meta-seo.php](/changeset/2870465/wp-meta-seo/trunk/wp-meta-seo.php?old=2869205&old_path=wp-meta-seo%2Ftrunk%2Fwp-meta-seo.php "Show the [2869205:2870465] differences restricted to wp-meta-seo/trunk/wp-meta-seo.php")

  | [r2869205](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2869205#L1 "Show revision 2869205 of this file in browser") | [r2870465](/browser/wp-meta-seo/trunk/wp-meta-seo.php?rev=2870465#L1 "Show revision 2870465 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | /\*\* |
  | 4 | 4 | \* Plugin Name: WP Meta SEO |
  | 5 | 5 | \* Plugin URI: http://www.joomunited.com/wordpress-products/wp-meta-seo |
  | 6 | 6 | \* Description: WP Meta SEO is a plugin for WordPress to fill meta for content, images and main SEO info in a single view. |
  | 7 |  | \* Version: 4.5.~~3~~ |
  |  | 7 | \* Version: 4.5.4 |
  | 8 | 8 | \* Text Domain: wp-meta-seo |
  | 9 | 9 | \* Domain Path: /languages |
  | 10 | 10 | \* Author: JoomUnited |
  | 11 | 11 | \* Author URI: http://www.joomunited.com |
  | 12 | 12 | \* License: GPL2 |
  | 13 | 13 | \*/ |
  | 14 | 14 | // Make sure we don't expose any info if called directly |
  | 15 | 15 | if (!function\_exists('add\_action')) { |
  | 16 | 16 | echo 'Hi there!  I\'m just a plugin, not much I can do when called directly.'; |
  | 17 | 17 | exit; |
  | 18 | 18 | } |
  | 19 | 19 |  |
  | 20 | 20 | if (version\_compare(PHP\_VERSION, '5.6', '<')) { |
  | 21 | 21 | if (!function\_exists('wpmsDisablePlugin')) { |
  | 22 | 22 | /\*\* |
  | 23 | 23 | \* Deactivate plugin |
  | 24 | 24 | \* |
  | 25 | 25 | \* @return void |
  | 26 | 26 | \*/ |
  | 27 | 27 | function wpmsDisablePlugin() |
  | 28 | 28 | { |
  | 29 | 29 | if (current\_user\_can('activate\_plugins') && is\_plugin\_active(plugin\_basename(\_\_FILE\_\_))) { |
  | 30 | 30 | deactivate\_plugins(\_\_FILE\_\_); |
  | 31 | 31 | //phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Do not load anything more |
  | 32 | 32 | unset($\_GET['activate']); |
  | 33 | 33 | } |
  | 34 | 34 | } |
  | 35 | 35 | } |
  | 36 | 36 |  |
  | 37 | 37 | if (!function\_exists('wpmsShowError')) { |
  | 38 | 38 | /\*\* |
  | 39 | 39 | \* Show notice |
  | 40 | 40 | \* |
  | 41 | 41 | \* @return void |
  | 42 | 42 | \*/ |
  | 43 | 43 | function wpmsShowError() |
  | 44 | 44 | { |
  | 45 | 45 | echo '<div class="error"><p><strong>WP Meta SEO</strong> |
  | 46 | 46 | need at least PHP 5.6 version, please update php before installing the plugin.</p></div>'; |
  | 47 | 47 | } |
  | 48 | 48 | } |
  | 49 | 49 |  |
  | 50 | 50 | //Add actions |
  | 51 | 51 | add\_action('admin\_init', 'wpmsDisablePlugin'); |
  | 52 | 52 | add\_action('admin\_notices', 'wpmsShowError'); |
  | 53 | 53 |  |
  | 54 | 54 | //Do not load anything more |
  | 55 | 55 | return; |
  | 56 | 56 | } |
  | 57 | 57 |  |
  | 58 | 58 | //Include the jutranslation helpers |
  | 59 | 59 | include\_once('jutranslation' . DIRECTORY\_SEPARATOR . 'jutranslation.php'); |
  | 60 | 60 | call\_user\_func( |
  | 61 | 61 | '\Joomunited\WPMetaSEO\Jutranslation\Jutranslation::init', |
  | 62 | 62 | \_\_FILE\_\_, |
  | 63 | 63 | 'wp-meta-seo', |
  | 64 | 64 | 'WP Meta SEO', |
  | 65 | 65 | 'wp-meta-seo', |
  | 66 | 66 | 'languages' . DIRECTORY\_SEPARATOR . 'wp-meta-seo-en\_US.mo' |
  | 67 | 67 | ); |
  | 68 | 68 |  |
  | 69 | 69 | // Include jufeedback helpers |
  | 70 | 70 | require\_once('jufeedback'. DIRECTORY\_SEPARATOR . 'jufeedback.php'); |
  | 71 | 71 | call\_user\_func( |
  | 72 | 72 | '\Joomunited\WPMetaSEO\Jufeedback\Jufeedback::init', |
  | 73 | 73 | \_\_FILE\_\_, |
  | 74 | 74 | 'wpms', |
  | 75 | 75 | 'wp-meta-seo', |
  | 76 | 76 | 'WP Meta Seo', |
  | 77 | 77 | 'wp-meta-seo' |
  | 78 | 78 | ); |
  | 79 | 79 |  |
  | 80 | 80 | if (!class\_exists('\Joomunited\WPMS\JUCheckRequirements')) { |
  | 81 | 81 | require\_once(trailingslashit(dirname(\_\_FILE\_\_)) . 'requirements.php'); |
  | 82 | 82 | } |
  | 83 | 83 |  |
  | 84 | 84 | if (class\_exists('\Joomunited\WPMS\JUCheckRequirements')) { |
  | 85 | 85 | // Plugins name for translate |
  | 86 | 86 | $args = array( |
  | 87 | 87 | 'plugin\_name' => esc\_html\_\_('WP Meta SEO', 'wp-meta-seo'), |
  | 88 | 88 | 'plugin\_path' => 'wp-meta-seo/wp-meta-seo.php', |
  | 89 | 89 | 'plugin\_textdomain' => 'wp-meta-seo', |
  | 90 | 90 | 'requirements' => array( |
  | 91 | 91 | 'php\_version' => '5.6', |
  | 92 | 92 | 'php\_modules' => array( |
  | 93 | 93 | 'curl' => 'warning', |
  | 94 | 94 | 'libxml' => 'warning' |
  | 95 | 95 | ), |
  | 96 | 96 | // Minimum addons version |
  | 97 | 97 | 'addons\_version' => array( |
  | 98 | 98 | 'wpmsAddons' => '1.3.7' |
  | 99 | 99 | ) |
  | 100 | 100 | ), |
  | 101 | 101 | ); |
  | 102 | 102 | $wpmsCheck = call\_user\_func('\Joomunited\WPMS\JUCheckRequirements::init', $args); |
  | 103 | 103 |  |
  | 104 | 104 | if (!$wpmsCheck['success']) { |
  | 105 | 105 | //phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Do not load anything more |
  | 106 | 106 | unset($\_GET['activate']); |
  | 107 | 107 | return; |
  | 108 | 108 | } |
  | 109 | 109 | } |
  | 110 | 110 |  |
  | 111 | 111 | if (!defined('WPMETASEO\_PLUGIN\_URL')) { |
  | 112 | 112 | /\*\* |
  | 113 | 113 | \* Url to WP Meta SEO plugin |
  | 114 | 114 | \*/ |
  | 115 | 115 | define('WPMETASEO\_PLUGIN\_URL', plugin\_dir\_url(\_\_FILE\_\_)); |
  | 116 | 116 | } |
  | 117 | 117 |  |
  | 118 | 118 | if (!defined('WPMETASEO\_PLUGIN\_DIR')) { |
  | 119 | 119 | /\*\* |
  | 120 | 120 | \* Path to WP Meta SEO plugin |
  | 121 | 121 | \*/ |
  | 122 | 122 | define('WPMETASEO\_PLUGIN\_DIR', plugin\_dir\_path(\_\_FILE\_\_)); |
  | 123 | 123 | } |
  | 124 | 124 |  |
  | 125 | 125 | if (!defined('URL')) { |
  | 126 | 126 | /\*\* |
  | 127 | 127 | \* Site url |
  | 128 | 128 | \*/ |
  | 129 | 129 | define('URL', get\_site\_url()); |
  | 130 | 130 | } |
  | 131 | 131 |  |
  | 132 | 132 | if (!defined('WPMSEO\_VERSION')) { |
  | 133 | 133 | /\*\* |
  | 134 | 134 | \* Plugin version |
  | 135 | 135 | \*/ |
  | 136 |  | define('WPMSEO\_VERSION', '4.5.~~3~~'); |
  |  | 136 | define('WPMSEO\_VERSION', '4.5.4'); |
  | 137 | 137 | } |
  | 138 | 138 |  |
  | 139 | 139 | if (!defined('WPMS\_CLIENTID')) { |
  | 140 | 140 | /\*\* |
  | 141 | 141 | \* Default client id to connect to google application |
  | 142 | 142 | \*/ |
  | 143 | 143 | define('WPMS\_CLIENTID', '992432963228-t8pc9ph1i7afaqocnhjl9cvoovc9oc7q.apps.googleusercontent.com'); |
  | 144 | 144 | } |
  | 145 | 145 |  |
  | 146 | 146 | if (!defined('WPMS\_CLIENTSECRET')) { |
  | 147 | 147 | /\*\* |
  | 148 | 148 | \* Default client secret to connect to google application |
  | 149 | 149 | \*/ |
  | 150 | 150 | define('WPMS\_CLIENTSECRET', 'tyF4XICemXdORWX2qjyazfqP'); |
  | 151 | 151 | } |
  | 152 | 152 |  |
  | 153 | 153 | if (!defined('MPMSCAT\_TITLE\_LENGTH')) { |
  | 154 | 154 | /\*\* |
  | 155 | 155 | \* Default meta title length |
  | 156 | 156 | \*/ |
  | 157 | 157 | define('MPMSCAT\_TITLE\_LENGTH', 60); |
  | 158 | 158 | } |
  | 159 | 159 |  |
  | 160 | 160 | if (!defined('MPMSCAT\_DESC\_LENGTH')) { |
  | 161 | 161 | /\*\* |
  | 162 | 162 | \* Default meta description length |
  | 163 | 163 | \*/ |
  | 164 | 164 | define('MPMSCAT\_DESC\_LENGTH', 158); |
  | 165 | 165 | } |
  | 166 | 166 |  |
  | 167 | 167 | if (!defined('MPMSCAT\_KEYWORDS\_LENGTH')) { |
  | 168 | 168 | /\*\* |
  | 169 | 169 | \* Default meta keywords length |
  | 170 | 170 | \*/ |
  | 171 | 171 | define('MPMSCAT\_KEYWORDS\_LENGTH', 256); |
  | 172 | 172 | } |
  | 173 | 173 |  |
  | 174 | 174 | if (!defined('WPMSEO\_FILE')) { |
  | 175 | 175 | /\*\* |
  | 176 | 176 | \* Path to this file |
  | 177 | 177 | \*/ |
  | 178 | 178 | define('WPMSEO\_FILE', \_\_FILE\_\_); |
  | 179 | 179 | } |
  | 180 | 180 |  |
  | 181 | 181 |  |
  | 182 | 182 | if (!defined('WPMSEO\_ADDON\_FILENAME')) { |
  | 183 | 183 | /\*\* |
  | 184 | 184 | \* WP Meta SEO addon file |
  | 185 | 185 | \*/ |
  | 186 | 186 | define('WPMSEO\_ADDON\_FILENAME', 'wp-meta-seo-addon/wp-meta-seo-addon.php'); |
  | 187 | 187 | } |
  | 188 | 188 |  |
  | 189 | 189 | if (!defined('WPMSEO\_TEMPLATE\_BREADCRUMB')) { |
  | 190 | 190 | /\*\* |
  | 191 | 191 | \* Default template for breadcrumb |
  | 192 | 192 | \*/ |
  | 193 | 193 | define( |
  | 194 | 194 | 'WPMSEO\_TEMPLATE\_BREADCRUMB', |
  | 195 | 195 | '<span property="itemListElement" typeof="ListItem"> |
  | 196 | 196 | <span property="name">%htitle%</span><meta property="position" content="%position%"></span>' |
  | 197 | 197 | ); |
  | 198 | 198 | } |
  | 199 | 199 | include\_once(ABSPATH . 'wp-admin/includes/plugin.php'); |
  | 200 | 200 | register\_activation\_hook(\_\_FILE\_\_, array('WpMetaSeo', 'pluginActivation')); |
  | 201 | 201 | register\_deactivation\_hook(\_\_FILE\_\_, array('WpMetaSeo', 'pluginDeactivation')); |
  | 202 | 202 |  |
  | 203 | 203 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.wp-metaseo.php'); |
  | 204 | 204 | add\_action('init', array('WpMetaSeo', 'init')); |
  | 205 | 205 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-sitemap.php'); |
  | 206 | 206 | $GLOBALS['metaseo\_sitemap'] = new MetaSeoSitemap; |
  | 207 | 207 | /\*\* |
  | 208 | 208 | \* Get default settings |
  | 209 | 209 | \* |
  | 210 | 210 | \* @return array |
  | 211 | 211 | \*/ |
  | 212 | 212 | function wpmsGetDefaultSettings() |
  | 213 | 213 | { |
  | 214 | 214 | return array( |
  | 215 | 215 | 'home\_meta\_active'       => 1, |
  | 216 | 216 | 'metaseo\_title\_home'     => '', |
  | 217 | 217 | 'metaseo\_desc\_home'      => '', |
  | 218 | 218 | 'metaseo\_showfacebook'   => '', |
  | 219 | 219 | 'metaseo\_showfbappid'    => '', |
  | 220 | 220 | 'metaseo\_showtwitter'    => '', |
  | 221 | 221 | 'metaseo\_twitter\_card'   => 'summary', |
  | 222 | 222 | 'metaseo\_showkeywords'   => 0, |
  | 223 | 223 | 'metaseo\_showtmetablock' => 1, |
  | 224 | 224 | 'metaseo\_showsocial'     => 1, |
  | 225 | 225 | 'metaseo\_seovalidate'    => 0, |
  | 226 | 226 | 'metaseo\_linkfield'      => 1, |
  | 227 | 227 | 'metaseo\_metatitle\_tab'  => 1, |
  | 228 | 228 | 'metaseo\_follow'         => 0, |
  | 229 | 229 | 'metaseo\_index'          => 0, |
  | 230 | 230 | 'metaseo\_overridemeta'   => 1, |
  | 231 | 231 | 'metaseo\_canonical' => 0, |
  | 232 | 232 | 'metaseo\_removecatprefix' => 0, |
  | 233 | 233 | 'metaseo\_specific\_keywords' => '', |
  | 234 | 234 | 'metaseo\_enable\_default\_fb\_image' => array( |
  | 235 | 235 | 'active' => 0, |
  | 236 | 236 | 'source' => 'featured', |
  | 237 | 237 | 'default\_set' => '' |
  | 238 | 238 | ), |
  | 239 | 239 | 'metaseo\_enable\_default\_twitter\_image' => array( |
  | 240 | 240 | 'active' => 0, |
  | 241 | 241 | 'source' => 'featured', |
  | 242 | 242 | 'default\_set' => '' |
  | 243 | 243 | ), |
  | 244 | 244 | ); |
  | 245 | 245 | } |
  | 246 | 246 |  |
  | 247 | 247 | /\*\* |
  | 248 | 248 | \* Retrieve the date of the post/page/cpt for use as replacement string |
  | 249 | 249 | \* |
  | 250 | 250 | \* @param object $current\_post Current post info |
  | 251 | 251 | \* |
  | 252 | 252 | \* @return string|null |
  | 253 | 253 | \*/ |
  | 254 | 254 | function wpmsRetrieveDate($current\_post) |
  | 255 | 255 | { |
  | 256 | 256 | $replacement = null; |
  | 257 | 257 | if (isset($current\_post->post\_date) && $current\_post->post\_date !== '') { |
  | 258 | 258 | $replacement = mysql2date(get\_option('date\_format'), $current\_post->post\_date, true); |
  | 259 | 259 | } else { |
  | 260 | 260 | if (get\_query\_var('day') && get\_query\_var('day') !== '') { |
  | 261 | 261 | $replacement = get\_the\_date(); |
  | 262 | 262 | } else { |
  | 263 | 263 | if (single\_month\_title(' ', false) && single\_month\_title(' ', false) !== '') { |
  | 264 | 264 | $replacement = single\_month\_title(' ', false); |
  | 265 | 265 | } elseif (get\_query\_var('year') !== '') { |
  | 266 | 266 | $replacement = get\_query\_var('year'); |
  | 267 | 267 | } |
  | 268 | 268 | } |
  | 269 | 269 | } |
  | 270 | 270 |  |
  | 271 | 271 | return $replacement; |
  | 272 | 272 | } |
  | 273 | 273 |  |
  | 274 | 274 | /\*\* |
  | 275 | 275 | \* Extract specific HTML tags and their attributes from a string. |
  | 276 | 276 | \* |
  | 277 | 277 | \* You can either specify one tag, an array of tag names, or a regular expression that matches the tag name(s). |
  | 278 | 278 | \* If multiple tags are specified you must also set the $selfclosing parameter and it must be the same for |
  | 279 | 279 | \* all specified tags (so you can't extract both normal and self-closing tags in one go). |
  | 280 | 280 | \* |
  | 281 | 281 | \* The function returns a numerically indexed array of extracted tags. Each entry is an associative array |
  | 282 | 282 | \* with these keys : |
  | 283 | 283 | \*    tag\_name    - the name of the extracted tag, e.g. "a" or "img". |
  | 284 | 284 | \*    offset        - the numberic offset of the first character of the tag within the HTML source. |
  | 285 | 285 | \*    contents    - the inner HTML of the tag. This is always empty for self-closing tags. |
  | 286 | 286 | \*    attributes    - a name -> value array of the tag's attributes, or an empty array if the tag has none. |
  | 287 | 287 | \*    full\_tag    - the entire matched tag, e.g. '<a href="http://example.com">example.com</a>'. This key |
  | 288 | 288 | \*                  will only be present if you set $return\_the\_entire\_tag to true. |
  | 289 | 289 | \* |
  | 290 | 290 | \* @param string       $html                  The HTML code to search for tags. |
  | 291 | 291 | \* @param string|array $tag                   The tag(s) to extract. |
  | 292 | 292 | \* @param boolean      $selfclosing           Whether the tag is self-closing or not. |
  | 293 | 293 | \*                                            Setting it to null will force the script to try and make an educated guess. |
  | 294 | 294 | \* @param boolean      $return\_the\_entire\_tag Return the entire matched tag in 'full\_tag' key of the results array. |
  | 295 | 295 | \* @param string       $charset               The character set of the HTML code. Defaults to ISO-8859-1. |
  | 296 | 296 | \* |
  | 297 | 297 | \* @return array An array of extracted tags, or an empty array if no matching tags were found. |
  | 298 | 298 | \*/ |
  | 299 | 299 | function wpmsExtractTags( |
  | 300 | 300 | $html, |
  | 301 | 301 | $tag, |
  | 302 | 302 | $selfclosing = null, |
  | 303 | 303 | $return\_the\_entire\_tag = false, |
  | 304 | 304 | $charset = 'ISO-8859-1' |
  | 305 | 305 | ) { |
  | 306 | 306 |  |
  | 307 | 307 | if (is\_array($tag)) { |
  | 308 | 308 | $tag = implode('|', $tag); |
  | 309 | 309 | } |
  | 310 | 310 |  |
  | 311 | 311 | $selfclosing\_tags = array( |
  | 312 | 312 | 'area', |
  | 313 | 313 | 'base', |
  | 314 | 314 | 'basefont', |
  | 315 | 315 | 'br', |
  | 316 | 316 | 'hr', |
  | 317 | 317 | 'input', |
  | 318 | 318 | 'img', |
  | 319 | 319 | 'link', |
  | 320 | 320 | 'meta', |
  | 321 | 321 | 'col', |
  | 322 | 322 | 'param' |
  | 323 | 323 | ); |
  | 324 | 324 | if (is\_null($selfclosing)) { |
  | 325 | 325 | $selfclosing = in\_array($tag, $selfclosing\_tags); |
  | 326 | 326 | } |
  | 327 | 327 |  |
  | 328 | 328 | if ($selfclosing) { |
  | 329 | 329 | $tag\_pattern = '@<(?P<tag>' . $tag . ')         # <tag |
  | 330 | 330 | (?P<attributes>\s[^>]+)?        # attributes, if any |
  | 331 | 331 | \s\*/?>                          # /> or just >, being lenient here |
  | 332 | 332 | @xsi'; |
  | 333 | 333 | } else { |
  | 334 | 334 | $tag\_pattern = '@<(?P<tag>' . $tag . ')         # <tag |
  | 335 | 335 | (?P<attributes>\s[^>]+)?        # attributes, if any |
  | 336 | 336 | \s\*>                            # > |
  | 337 | 337 | (?P<contents>.\*?)               # tag contents |
  | 338 | 338 | </(?P=tag)>                     # the closing </tag> |
  | 339 | 339 | @xsi'; |
  | 340 | 340 | } |
  | 341 | 341 |  |
  | 342 | 342 | $attribute\_pattern = '@ |
  | 343 | 343 | (?P<name>\w+)                                           # attribute name |
  | 344 | 344 | \s\*=\s\* |
  | 345 | 345 | ( |
  | 346 | 346 | (?P<quote>[\"\'])(?P<value\_quoted>.\*?)(?P=quote)    # a quoted value |
  | 347 | 347 | |                           # or |
  | 348 | 348 | (?P<value\_unquoted>[^\s"\']+?)(?:\s+|$)  # an unquoted value (terminated by whitespace or EOF) |
  | 349 | 349 | ) |
  | 350 | 350 | @xsi'; |
  | 351 | 351 |  |
  | 352 | 352 | //Find all tags |
  | 353 | 353 | if (!preg\_match\_all($tag\_pattern, $html, $matches, PREG\_SET\_ORDER | PREG\_OFFSET\_CAPTURE)) { |
  | 354 | 354 | //Return an empty array if we didn't find anything |
  | 355 | 355 | return array(); |
  | 356 | 356 | } |
  | 357 | 357 |  |
  | 358 | 358 | $tags = array(); |
  | 359 | 359 | foreach ($matches as $match) { |
  | 360 | 360 | //Parse tag attributes, if any |
  | 361 | 361 | $attributes = array(); |
  | 362 | 362 | if (!empty($match['attributes'][0])) { |
  | 363 | 363 | if (preg\_match\_all($attribute\_pattern, $match['attributes'][0], $attribute\_data, PREG\_SET\_ORDER)) { |
  | 364 | 364 | //Turn the attribute data into a name->value array |
  | 365 | 365 | foreach ($attribute\_data as $attr) { |
  | 366 | 366 | if (!empty($attr['value\_quoted'])) { |
  | 367 | 367 | $value = $attr['value\_quoted']; |
  | 368 | 368 | } elseif (!empty($attr['value\_unquoted'])) { |
  | 369 | 369 | $value = $attr['value\_unquoted']; |
  | 370 | 370 | } else { |
  | 371 | 371 | $value = ''; |
  | 372 | 372 | } |
  | 373 | 373 |  |
  | 374 | 374 | //Passing the value through html\_entity\_decode is handy when you want |
  | 375 | 375 | //to extract link URLs or something like that. You might want to remove |
  | 376 | 376 | //or modify this call if it doesn't fit your situation. |
  | 377 | 377 | $value = html\_entity\_decode($value, ENT\_QUOTES, $charset); |
  | 378 | 378 |  |
  | 379 | 379 | $attributes[$attr['name']] = $value; |
  | 380 | 380 | } |
  | 381 | 381 | } |
  | 382 | 382 | } |
  | 383 | 383 |  |
  | 384 | 384 | $tag = array( |
  | 385 | 385 | 'tag\_name'   => $match['tag'][0], |
  | 386 | 386 | 'offset'     => $match[0][1], |
  | 387 | 387 | 'contents'   => !empty($match['contents']) ? $match['contents'][0] : '', //empty for self-closing tags |
  | 388 | 388 | 'attributes' => $attributes, |
  | 389 | 389 | ); |
  | 390 | 390 | if ($return\_the\_entire\_tag) { |
  | 391 | 391 | $tag['full\_tag'] = $match[0][0]; |
  | 392 | 392 | } |
  | 393 | 393 |  |
  | 394 | 394 | $tags[] = $tag; |
  | 395 | 395 | } |
  | 396 | 396 |  |
  | 397 | 397 | return $tags; |
  | 398 | 398 | } |
  | 399 | 399 |  |
  | 400 | 400 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-rewrite.php'); |
  | 401 | 401 | $settings  = get\_option('\_metaseo\_settings'); |
  | 402 | 402 | if (isset($settings['metaseo\_removecatprefix']) && $settings['metaseo\_removecatprefix'] === '1') { |
  | 403 | 403 | $GLOBALS['metaseo\_rewrite'] = new MetaSeoRewrite; |
  | 404 | 404 | } |
  | 405 | 405 |  |
  | 406 | 406 | if (is\_admin()) { |
  | 407 | 407 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-content-list-table.php'); |
  | 408 | 408 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-category-meta-table.php'); |
  | 409 | 409 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-image-list-table.php'); |
  | 410 | 410 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-dashboard.php'); |
  | 411 | 411 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-broken-link-table.php'); |
  | 412 | 412 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-google-analytics.php'); |
  | 413 | 413 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-admin.php'); |
  | 414 | 414 | add\_action('plugins\_loaded', 'wpmsAdminInit', 15); |
  | 415 | 415 |  |
  | 416 | 416 | /\*\* |
  | 417 | 417 | \* Admin init |
  | 418 | 418 | \* |
  | 419 | 419 | \* @return void |
  | 420 | 420 | \*/ |
  | 421 | 421 | function wpmsAdminInit() |
  | 422 | 422 | { |
  | 423 | 423 | $GLOBALS['metaseo\_admin'] = new MetaSeoAdmin; |
  | 424 | 424 | } |
  | 425 | 425 |  |
  | 426 | 426 | /\*add\_filter('wp\_prepare\_attachment\_for\_js', array('MetaSeoImageListTable', 'addMoreAttachmentSizes'), 10, 2); |
  | 427 | 427 | add\_filter('image\_size\_names\_choose', array('MetaSeoImageListTable', 'addMoreAttachmentSizesChoose'), 10, 1);\*/ |
  | 428 | 428 | add\_filter('user\_contactmethods', 'metaseoContactuser', 10, 1); |
  | 429 | 429 |  |
  | 430 | 430 | /\*\* |
  | 431 | 431 | \* Custom field for user profile |
  | 432 | 432 | \* |
  | 433 | 433 | \* @param array $contactusers List contact users |
  | 434 | 434 | \* |
  | 435 | 435 | \* @return mixed |
  | 436 | 436 | \*/ |
  | 437 | 437 | function metaseoContactuser($contactusers) |
  | 438 | 438 | { |
  | 439 | 439 | $contactusers['mtwitter']  = esc\_html\_\_('Twitter username (without @)', 'wp-meta-seo'); |
  | 440 | 440 | $contactusers['mfacebook'] = esc\_html\_\_('Facebook profile URL', 'wp-meta-seo'); |
  | 441 | 441 | return $contactusers; |
  | 442 | 442 | } |
  | 443 | 443 |  |
  | 444 | 444 | include\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/google\_analytics/wpmsga.php'); |
  | 445 | 445 | // phpcs:disable WordPress.Security.NonceVerification.Recommended -- Not a form, nonce is not required |
  | 446 | 446 | if (isset($\_GET['task']) && $\_GET['task'] === 'wpms\_ga') { |
  | 447 | 447 | if (!empty($\_GET['code'])) { |
  | 448 | 448 | $google\_analytics =  get\_option('wpms\_google\_alanytics'); |
  | 449 | 449 |  |
  | 450 | 450 | if (is\_array($google\_analytics)) { |
  | 451 | 451 | $google\_analytics['code'] = $\_GET['code']; |
  | 452 | 452 |  |
  | 453 | 453 | require\_once WPMETASEO\_PLUGIN\_DIR . 'inc/google\_analytics/wpmstools.php'; |
  | 454 | 454 | $ggClient = WpmsGaTools::initClient($google\_analytics['wpmsga\_dash\_clientid'], $google\_analytics['wpmsga\_dash\_clientsecret']); |
  | 455 | 455 |  |
  | 456 | 456 | try { |
  | 457 | 457 | $ggClient->authenticate($google\_analytics['code']); |
  | 458 | 458 | $getAccessToken = $ggClient->getAccessToken(); |
  | 459 | 459 |  |
  | 460 | 460 | if ($getAccessToken) { |
  | 461 | 461 | $ggClient->setAccessToken($getAccessToken); |
  | 462 | 462 | $google\_analytics['googleCredentials'] = $getAccessToken; |
  | 463 | 463 |  |
  | 464 | 464 | if (empty($google\_alanytics['profile\_list'])) { |
  | 465 | 465 | $service          = new WPMSGoogle\_Service\_Analytics($ggClient); |
  | 466 | 466 | $midnight      = strtotime('tomorrow 00:00:00'); // UTC midnight |
  | 467 | 467 | $midnight      = $midnight + 8 \* 3600; // UTC 8 AM |
  | 468 | 468 | $error\_timeout = $midnight - time(); |
  | 469 | 469 |  |
  | 470 | 470 | $profiles = WpmsGaTools::refreshProfiles($service, $getAccessToken['access\_token'], $error\_timeout); |
  | 471 | 471 | $google\_analytics['profile\_list'] = $profiles; |
  | 472 | 472 | } |
  | 473 | 473 |  |
  | 474 | 474 | update\_option('wpms\_google\_alanytics', $google\_analytics); |
  | 475 | 475 | // Do redirect |
  | 476 | 476 | $redirectUrl = admin\_url('admin.php?page=metaseo\_google\_analytics&view=wpms\_gg\_service\_data'); |
  | 477 | 477 | header('Location: '.$redirectUrl, true, 302); |
  | 478 | 478 | exit; |
  | 479 | 479 | } |
  | 480 | 480 | } catch (WPMSGoogle\Service\Exception $e) { |
  | 481 | 481 | // phpcs:ignore WordPress.PHP.DevelopmentFunctions.error\_log\_error\_log -- Log error for debug |
  | 482 | 482 | error\_log($e->getMessage()); |
  | 483 | 483 | } catch (Exception $e) { |
  | 484 | 484 | // phpcs:ignore WordPress.PHP.DevelopmentFunctions.error\_log\_error\_log -- Log error for debug |
  | 485 | 485 | error\_log($e->getMessage()); |
  | 486 | 486 | } |
  | 487 | 487 | } |
  | 488 | 488 | } |
  | 489 | 489 | // phpcs:enable |
  | 490 | 490 | } |
  | 491 | 491 | } else { |
  | 492 | 492 | /\*\* |
  | 493 | 493 | \* Outputs the breadcrumb |
  | 494 | 494 | \* |
  | 495 | 495 | \* @param boolean $return  Whether to return or echo the trail. (optional) |
  | 496 | 496 | \* @param boolean $reverse Whether to reverse the output or not. (optional) |
  | 497 | 497 | \* |
  | 498 | 498 | \* @return string |
  | 499 | 499 | \*/ |
  | 500 | 500 | function wpmsBreadcrumb($return = false, $reverse = false) |
  | 501 | 501 | { |
  | 502 | 502 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/breadcrumb/class.metaseo-breadcrumb.php'); |
  | 503 | 503 | $breadcrumb = new MetaSeoBreadcrumb; |
  | 504 | 504 | if ($breadcrumb !== null) { |
  | 505 | 505 | $breadcrumb->checkPosts(); |
  | 506 | 506 | return $breadcrumb->breadcrumbDisplay($return, $reverse); |
  | 507 | 507 | } |
  | 508 | 508 | return ''; |
  | 509 | 509 | } |
  | 510 | 510 |  |
  | 511 | 511 | /\* |
  | 512 | 512 | \* shortcode for breadcrumb |
  | 513 | 513 | \*/ |
  | 514 | 514 | add\_shortcode('wpms\_breadcrumb', 'wpmsBreadcrumbShortcode'); |
  | 515 | 515 |  |
  | 516 | 516 | if (!function\_exists('wpmsBreadcrumbShortcode')) { |
  | 517 | 517 | /\*\* |
  | 518 | 518 | \* Create shortcode for breadcrumb |
  | 519 | 519 | \* |
  | 520 | 520 | \* @param array $params Shortcode attribute |
  | 521 | 521 | \* |
  | 522 | 522 | \* @return string |
  | 523 | 523 | \*/ |
  | 524 | 524 | function wpmsBreadcrumbShortcode($params) |
  | 525 | 525 | { |
  | 526 | 526 | $html = '<div class="breadcrumbs" typeof="BreadcrumbList" vocab="https://schema.org/">'; |
  | 527 | 527 | if (isset($params['reverse']) && (int)$params['reverse'] === 1) { |
  | 528 | 528 | $html .= wpmsBreadcrumb(true, true); |
  | 529 | 529 | } else { |
  | 530 | 530 | $html .= wpmsBreadcrumb(true, false); |
  | 531 | 531 | } |
  | 532 | 532 | $html .= '</div>'; |
  | 533 | 533 |  |
  | 534 | 534 | return $html; |
  | 535 | 535 | } |
  | 536 | 536 | } |
  | 537 | 537 |  |
  | 538 | 538 | // Check again and modify title, meta title, meta description before output |
  | 539 | 539 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-opengraph.php'); |
  | 540 | 540 |  |
  | 541 | 541 | add\_action('wpmsseo\_head', 'wpmsopengraph', 30); |
  | 542 | 542 | // Remove actions that we will handle through our wpseo\_head call, and probably change the output of. |
  | 543 | 543 | remove\_action('wp\_head', 'rel\_canonical'); |
  | 544 | 544 | /\*\* |
  | 545 | 545 | \* Render graph meta tag |
  | 546 | 546 | \* |
  | 547 | 547 | \* @return void |
  | 548 | 548 | \*/ |
  | 549 | 549 | function wpmsopengraph() |
  | 550 | 550 | { |
  | 551 | 551 | global $wp\_query; |
  | 552 | 552 | $is\_shop = false; |
  | 553 | 553 | if (function\_exists('is\_shop')) { |
  | 554 | 554 | if (is\_shop()) { |
  | 555 | 555 | $is\_shop = true; |
  | 556 | 556 | $id      = wc\_get\_page\_id('shop'); |
  | 557 | 557 | $post    = get\_post($id); |
  | 558 | 558 | $content = $post->post\_content; |
  | 559 | 559 | } else { |
  | 560 | 560 | if (empty($wp\_query->post)) { |
  | 561 | 561 | return; |
  | 562 | 562 | } |
  | 563 | 563 | $id      = $wp\_query->post->ID; |
  | 564 | 564 | $content = $wp\_query->post->post\_content; |
  | 565 | 565 | } |
  | 566 | 566 | } else { |
  | 567 | 567 | if (empty($wp\_query->post)) { |
  | 568 | 568 | return; |
  | 569 | 569 | } |
  | 570 | 570 | $id      = $wp\_query->post->ID; |
  | 571 | 571 | $content = $wp\_query->post->post\_content; |
  | 572 | 572 | } |
  | 573 | 573 | wp\_reset\_query(); |
  | 574 | 574 |  |
  | 575 | 575 | $default\_settings = wpmsGetDefaultSettings(); |
  | 576 | 576 | $settings         = get\_option('\_metaseo\_settings'); |
  | 577 | 577 | if (is\_array($settings)) { |
  | 578 | 578 | $settings = array\_merge($default\_settings, $settings); |
  | 579 | 579 | } else { |
  | 580 | 580 | $settings = $default\_settings; |
  | 581 | 581 | } |
  | 582 | 582 |  |
  | 583 | 583 | // get meta title |
  | 584 | 584 | $opengraph      = new MetaSeoOpenGraph(); |
  | 585 | 585 | $meta\_title     = $opengraph->getTitle($is\_shop, $id); |
  | 586 | 586 | $meta\_title\_esc = $opengraph->getMetaTitle($settings, $meta\_title); |
  | 587 | 587 | // get meta description |
  | 588 | 588 | $meta\_desc\_esc = $opengraph->getDesc($settings, $id, $content); |
  | 589 | 589 | // get meta keyword |
  | 590 | 590 | $meta\_keywords\_esc = $opengraph->getKeyword($settings, $id); |
  | 591 | 591 |  |
  | 592 | 592 | $page\_follow       = get\_post\_meta($id, '\_metaseo\_metafollow', true); |
  | 593 | 593 | $page\_index        = get\_post\_meta($id, '\_metaseo\_metaindex', true); |
  | 594 | 594 | // get meta title for twitter |
  | 595 | 595 | $meta\_twtitle = $opengraph->getTwtitle($id); |
  | 596 | 596 | // get meta description for twitter |
  | 597 | 597 | $meta\_twdesc = $opengraph->getTwdesc($id); |
  | 598 | 598 | // get twiter card |
  | 599 | 599 | $meta\_twcard = $opengraph->getTwCard($settings); |
  | 600 | 600 |  |
  | 601 | 601 | // get facebook admin and twiter site meta |
  | 602 | 602 | $usermeta          = $opengraph->getUserMeta($settings, $id); |
  | 603 | 603 | $meta\_twitter\_site = $usermeta['meta\_twitter\_site']; |
  | 604 | 604 | $facebook\_admin    = $usermeta['facebook\_admin']; |
  | 605 | 605 | $sitename          = get\_bloginfo('name'); |
  | 606 | 606 |  |
  | 607 | 607 | // get meta title for facebook |
  | 608 | 608 | $meta\_fbtitle = $opengraph->getFbtitle($id); |
  | 609 | 609 | // get meta description for facebook |
  | 610 | 610 | $meta\_fbdesc = $opengraph->getFbdesc($id); |
  | 611 | 611 | // get facebook app id |
  | 612 | 612 | if (isset($settings['metaseo\_showfbappid'])) { |
  | 613 | 613 | $fbapp\_id = esc\_attr($settings['metaseo\_showfbappid']); |
  | 614 | 614 | } else { |
  | 615 | 615 | $fbapp\_id = ''; |
  | 616 | 616 | } |
  | 617 | 617 | // get meta image for facebook & twiter |
  | 618 | 618 | $images       = $opengraph->getImage($id, $settings); |
  | 619 | 619 | $meta\_fbimage = $images[0]; |
  | 620 | 620 | $meta\_twimage = $images[1]; |
  | 621 | 621 |  |
  | 622 | 622 | $current\_url      = $opengraph->getCurentUrl($settings, $id); |
  | 623 | 623 | $type             = $opengraph->getType(); |
  | 624 | 624 | $home\_meta\_active = wpmsGetOption('home\_meta\_active'); |
  | 625 | 625 | // check homepage is latest post |
  | 626 | 626 | if (is\_home() && !empty($home\_meta\_active)) { |
  | 627 | 627 | $metas          = $opengraph->getHome($settings); |
  | 628 | 628 | $meta\_title\_esc = $metas['title']; |
  | 629 | 629 | $meta\_twtitle   = $metas['title']; |
  | 630 | 630 | $meta\_fbtitle   = $metas['title']; |
  | 631 | 631 | if ($metas['desc']) { |
  | 632 | 632 | $meta\_desc\_esc = $metas['desc']; |
  | 633 | 633 | $meta\_twdesc   = $metas['desc']; |
  | 634 | 634 | $meta\_fbdesc   = $metas['desc']; |
  | 635 | 635 | } |
  | 636 | 636 | $page\_follow = $metas['page\_follow']; |
  | 637 | 637 | $page\_index  = $metas['page\_index']; |
  | 638 | 638 | } |
  | 639 | 639 |  |
  | 640 | 640 | // is front page |
  | 641 | 641 | if (is\_front\_page() && 'page' === get\_option('show\_on\_front') && is\_page(get\_option('page\_on\_front'))) { |
  | 642 | 642 | $metas          = $opengraph->getFrontPageMeta($settings, $id); |
  | 643 | 643 | $meta\_title\_esc = $metas['title']; |
  | 644 | 644 | $meta\_twtitle   = $metas['title']; |
  | 645 | 645 | $meta\_fbtitle   = $metas['title']; |
  | 646 | 646 | if ($metas['desc']) { |
  | 647 | 647 | $meta\_desc\_esc  = $metas['desc']; |
  | 648 | 648 | $meta\_twdesc    = $metas['desc']; |
  | 649 | 649 | $meta\_fbdesc    = $metas['desc']; |
  | 650 | 650 | } |
  | 651 | 651 |  |
  | 652 | 652 | $page\_follow    = $metas['page\_follow']; |
  | 653 | 653 | $page\_index     = $metas['page\_index']; |
  | 654 | 654 | } |
  | 655 | 655 |  |
  | 656 | 656 | if (is\_category() || is\_tag() || is\_tax()) { |
  | 657 | 657 | $metas             = $opengraph->getTagMeta($wp\_query, $settings); |
  | 658 | 658 | $meta\_keywords\_esc = $metas['keyword']; |
  | 659 | 659 | $meta\_title\_esc    = $metas['title']; |
  | 660 | 660 | $meta\_fbtitle      = $metas['title']; |
  | 661 | 661 | $meta\_twtitle      = $metas['title']; |
  | 662 | 662 | $meta\_desc\_esc     = $metas['desc']; |
  | 663 | 663 | $meta\_fbdesc       = $metas['desc']; |
  | 664 | 664 | $meta\_twdesc       = $metas['desc']; |
  | 665 | 665 | if (!empty($metas['canonical'])) { |
  | 666 | 666 | $current\_url = $metas['canonical']; |
  | 667 | 667 | } |
  | 668 | 668 | $page\_follow       = 'follow'; |
  | 669 | 669 | } |
  | 670 | 670 |  |
  | 671 | 671 | if (empty($page\_index)) { |
  | 672 | 672 | $page\_index = 'index'; |
  | 673 | 673 | } |
  | 674 | 674 |  |
  | 675 | 675 | if (empty($page\_follow)) { |
  | 676 | 676 | $page\_follow = 'follow'; |
  | 677 | 677 | } |
  | 678 | 678 |  |
  | 679 | 679 | // Create canonical meta link |
  | 680 | 680 | $canonical\_meta = $opengraph->getCanonical($id, $settings, $current\_url, $page\_index); |
  | 681 | 681 | if (!empty($canonical\_meta)) { |
  | 682 | 682 | // phpcs:ignore WordPress.Security.EscapeOutput -- Content escaped in some method in class MetaSeoOpenGraph |
  | 683 | 683 | echo $canonical\_meta; |
  | 684 | 684 | } |
  | 685 | 685 |  |
  | 686 | 686 | $patterns = $opengraph->getPatterns( |
  | 687 | 687 | $id, |
  | 688 | 688 | $settings, |
  | 689 | 689 | $meta\_twimage, |
  | 690 | 690 | $meta\_twcard, |
  | 691 | 691 | $meta\_twitter\_site, |
  | 692 | 692 | $sitename, |
  | 693 | 693 | strip\_tags(html\_entity\_decode($meta\_twdesc, ENT\_COMPAT, 'UTF-8')), |
  | 694 | 694 | strip\_tags(html\_entity\_decode($meta\_twtitle, ENT\_COMPAT, 'UTF-8')), |
  | 695 | 695 | $facebook\_admin, |
  | 696 | 696 | $meta\_fbimage, |
  | 697 | 697 | strip\_tags(html\_entity\_decode($meta\_fbdesc, ENT\_COMPAT, 'UTF-8')), |
  | 698 | 698 | $current\_url, |
  | 699 | 699 | $type, |
  | 700 | 700 | $fbapp\_id, |
  | 701 | 701 | strip\_tags(html\_entity\_decode($meta\_fbtitle, ENT\_COMPAT, 'UTF-8')), |
  | 702 | 702 | esc\_html($meta\_desc\_esc, 'wp-meta-seo'), |
  | 703 | 703 | esc\_html($meta\_keywords\_esc, 'wp-meta-seo'), |
  | 704 | 704 | strip\_tags(html\_entity\_decode($meta\_title\_esc, ENT\_COMPAT, 'UTF-8')), |
  | 705 | 705 | $page\_index, |
  | 706 | 706 | $page\_follow |
  | 707 | 707 | ); |
  | 708 | 708 |  |
  | 709 | 709 | foreach ($patterns as $k => $pattern) { |
  | 710 | 710 | // phpcs:ignore WordPress.Security.EscapeOutput -- Content escaped in some method in class MetaSeoOpenGraph |
  | 711 | 711 | echo $pattern[1]; |
  | 712 | 712 | } |
  | 713 | 713 | } |
  | 714 | 714 |  |
  | 715 | 715 | add\_action('wp\_head', 'wpmshead', 30); |
  | 716 | 716 | /\*\* |
  | 717 | 717 | \* WPMS frontend head |
  | 718 | 718 | \* |
  | 719 | 719 | \* @return void |
  | 720 | 720 | \*/ |
  | 721 | 721 | function wpmshead() |
  | 722 | 722 | { |
  | 723 | 723 | global $wp\_query; |
  | 724 | 724 |  |
  | 725 | 725 | $old\_wp\_query = null; |
  | 726 | 726 |  |
  | 727 | 727 | if (!$wp\_query->is\_main\_query()) { |
  | 728 | 728 | $old\_wp\_query = $wp\_query; |
  | 729 | 729 | wp\_reset\_query(); |
  | 730 | 730 | } |
  | 731 | 731 |  |
  | 732 | 732 | do\_action('wpmsseo\_head'); |
  | 733 | 733 |  |
  | 734 | 734 | if (!empty($old\_wp\_query)) { |
  | 735 | 735 | // phpcs:ignore WordPress.WP.GlobalVariablesOverride.Prohibited -- This combines all the output on the frontend |
  | 736 | 736 | $GLOBALS['wp\_query'] = $old\_wp\_query; |
  | 737 | 737 | unset($old\_wp\_query); |
  | 738 | 738 | } |
  | 739 | 739 | } |
  | 740 | 740 |  |
  | 741 | 741 | add\_filter('pre\_get\_document\_title', 'wpmstitle', 15); |
  | 742 | 742 | add\_filter('wp\_title', 'wpmstitle', 15, 3); |
  | 743 | 743 | add\_filter('thematic\_doctitle', 'wpmstitle', 15); |
  | 744 | 744 | add\_filter('woo\_title', 'wpmstitle', 99); |
  | 745 | 745 | /\*\* |
  | 746 | 746 | \* Render meta title tag |
  | 747 | 747 | \* |
  | 748 | 748 | \* @param string $title Title |
  | 749 | 749 | \* |
  | 750 | 750 | \* @return mixed|string |
  | 751 | 751 | \*/ |
  | 752 | 752 | function wpmstitle($title) |
  | 753 | 753 | { |
  | 754 | 754 | global $wp\_query; |
  | 755 | 755 | $default\_settings = wpmsGetDefaultSettings(); |
  | 756 | 756 | $settings         = get\_option('\_metaseo\_settings'); |
  | 757 | 757 | if (is\_array($settings)) { |
  | 758 | 758 | $settings = array\_merge($default\_settings, $settings); |
  | 759 | 759 | } else { |
  | 760 | 760 | $settings = $default\_settings; |
  | 761 | 761 | } |
  | 762 | 762 | if (empty($settings)) { |
  | 763 | 763 | return esc\_html($title); |
  | 764 | 764 | } |
  | 765 | 765 |  |
  | 766 | 766 | if (empty($settings['metaseo\_metatitle\_tab'])) { |
  | 767 | 767 | return esc\_html($title); |
  | 768 | 768 | } |
  | 769 | 769 | if (empty($wp\_query->post)) { |
  | 770 | 770 | return esc\_html($title); |
  | 771 | 771 | } |
  | 772 | 772 |  |
  | 773 | 773 | $is\_shop = false; |
  | 774 | 774 | if (function\_exists('is\_shop')) { |
  | 775 | 775 | if (is\_shop()) { |
  | 776 | 776 | $is\_shop = true; |
  | 777 | 777 | $id      = wc\_get\_page\_id('shop'); |
  | 778 | 778 | } else { |
  | 779 | 779 | $id = $wp\_query->post->ID; |
  | 780 | 780 | } |
  | 781 | 781 | } else { |
  | 782 | 782 | $id = $wp\_query->post->ID; |
  | 783 | 783 | } |
  | 784 | 784 |  |
  | 785 | 785 | $opengraph  = new MetaSeoOpenGraph(); |
  | 786 | 786 | $meta\_title = $opengraph->getTitle($is\_shop, $id); |
  | 787 | 787 |  |
  | 788 | 788 | if (is\_home()) { |
  | 789 | 789 | $metas      = $opengraph->getHome($settings); |
  | 790 | 790 | $meta\_title = $metas['title']; |
  | 791 | 791 | } |
  | 792 | 792 |  |
  | 793 | 793 | // is front page |
  | 794 | 794 | if (is\_front\_page() && 'page' === get\_option('show\_on\_front') && is\_page(get\_option('page\_on\_front'))) { |
  | 795 | 795 | $metas      = $opengraph->getFrontPageMeta($settings, $id); |
  | 796 | 796 | $meta\_title = $metas['title']; |
  | 797 | 797 | } |
  | 798 | 798 |  |
  | 799 | 799 | $term = $wp\_query->get\_queried\_object(); |
  | 800 | 800 | if (is\_category() || is\_tag() || is\_tax()) { |
  | 801 | 801 | if (function\_exists('get\_term\_meta')) { |
  | 802 | 802 | $meta\_title = get\_term\_meta($term->term\_id, 'wpms\_category\_metatitle', true); |
  | 803 | 803 | } else { |
  | 804 | 804 | $meta\_title = get\_metadata('term', $term->term\_id, 'wpms\_category\_metatitle', true); |
  | 805 | 805 | } |
  | 806 | 806 |  |
  | 807 | 807 | $meta\_title = $opengraph->replaceSnippet($meta\_title, null, $term); |
  | 808 | 808 | } |
  | 809 | 809 |  |
  | 810 | 810 | if (empty($meta\_title)) { |
  | 811 | 811 | $meta\_title = $title; |
  | 812 | 812 | } |
  | 813 | 813 |  |
  | 814 | 814 | return esc\_html($meta\_title); |
  | 815 | 815 | } |
  | 816 | 816 |  |
  | 817 | 817 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/class.metaseo-front\_end.php'); |
  | 818 | 818 | $GLOBALS['metaseo\_front'] = new MetaSeoFront; |
  | 819 | 819 |  |
  | 820 | 820 | /\*     \* \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* \*/ |
  | 821 | 821 | } |
  | 822 | 822 |  |
  | 823 | 823 | /\*\* |
  | 824 | 824 | \* Set a option |
  | 825 | 825 | \* |
  | 826 | 826 | \* @param string              $option\_name Option name |
  | 827 | 827 | \* @param string|array|object $value       Value of option |
  | 828 | 828 | \* |
  | 829 | 829 | \* @return void |
  | 830 | 830 | \*/ |
  | 831 | 831 | function wpmsSetOption($option\_name, $value) |
  | 832 | 832 | { |
  | 833 | 833 | $settings = get\_option('\_metaseo\_settings'); |
  | 834 | 834 | if (empty($settings)) { |
  | 835 | 835 | $settings               = array(); |
  | 836 | 836 | $settings[$option\_name] = $value; |
  | 837 | 837 | } else { |
  | 838 | 838 | $settings[$option\_name] = $value; |
  | 839 | 839 | } |
  | 840 | 840 |  |
  | 841 | 841 | update\_option('\_metaseo\_settings', $settings); |
  | 842 | 842 | } |
  | 843 | 843 |  |
  | 844 | 844 | /\*\* |
  | 845 | 845 | \* Get a option |
  | 846 | 846 | \* |
  | 847 | 847 | \* @param string $option\_name Option name |
  | 848 | 848 | \* |
  | 849 | 849 | \* @return mixed |
  | 850 | 850 | \*/ |
  | 851 | 851 | function wpmsGetOption($option\_name) |
  | 852 | 852 | { |
  | 853 | 853 | $default\_settings = wpmsGetDefaultSettings(); |
  | 854 | 854 | $settings         = get\_option('\_metaseo\_settings'); |
  | 855 | 855 | if (isset($settings) && isset($settings[$option\_name])) { |
  | 856 | 856 | return $settings[$option\_name]; |
  | 857 | 857 | } |
  | 858 | 858 |  |
  | 859 | 859 | return $default\_settings[$option\_name]; |
  | 860 | 860 | } |
  | 861 | 861 |  |
  | 862 | 862 | /\* \* \*\*\*\*\*\* Check and import meta data from other installed plugins for SEO \*\*\*\*\*\*\* \*/ |
  | 863 | 863 |  |
  | 864 | 864 | /\*\* |
  | 865 | 865 | \* Handle import of meta data from other installed plugins for SEO |
  | 866 | 866 | \* |
  | 867 | 867 | \* @return void |
  | 868 | 868 | \*/ |
  | 869 | 869 | function wpmsYoastMessage() |
  | 870 | 870 | { |
  | 871 | 871 | $activated = 0; |
  | 872 | 872 | // Check if All In One Pack is active |
  | 873 | 873 | if (!get\_option('\_aio\_import\_notice\_flag')) { |
  | 874 | 874 | if (is\_plugin\_active('all-in-one-seo-pack/all\_in\_one\_seo\_pack.php')) { |
  | 875 | 875 | add\_action('admin\_notices', 'wpmsImportMetaNotice', 2); |
  | 876 | 876 | $activated ++; |
  | 877 | 877 | } |
  | 878 | 878 |  |
  | 879 | 879 | if (get\_option('\_aio\_import\_notice\_flag') === false) { |
  | 880 | 880 | update\_option('\_aio\_import\_notice\_flag', 0); |
  | 881 | 881 | } |
  | 882 | 882 | } |
  | 883 | 883 | // Check if Yoast is active |
  | 884 | 884 | if (!get\_option('\_yoast\_import\_notice\_flag', false)) { |
  | 885 | 885 | if (is\_plugin\_active('wordpress-seo/wp-seo.php') |
  | 886 | 886 | || is\_plugin\_active('Yoast-SEO-Premium/wp-seo-premium.php') || class\_exists('WPSEO\_Premium')) { |
  | 887 | 887 | add\_action('admin\_notices', 'wpmsImportYoastMetaNotice', 3); |
  | 888 | 888 | $activated ++; |
  | 889 | 889 | } |
  | 890 | 890 |  |
  | 891 | 891 | if (get\_option('\_yoast\_import\_notice\_flag') === false) { |
  | 892 | 892 | update\_option('\_yoast\_import\_notice\_flag', 0); |
  | 893 | 893 | } |
  | 894 | 894 | } |
  | 895 | 895 |  |
  | 896 | 896 | if ($activated === 2 && !get\_option('plugin\_to\_sync\_with', false)) { |
  | 897 | 897 | add\_action('admin\_notices', 'wpmsNoticeSameFeature', 1); |
  | 898 | 898 | } |
  | 899 | 899 | } |
  | 900 | 900 |  |
  | 901 | 901 | /\*\* |
  | 902 | 902 | \* Show notice |
  | 903 | 903 | \* |
  | 904 | 904 | \* @return void |
  | 905 | 905 | \*/ |
  | 906 | 906 | function wpmsNoticeSameFeature() |
  | 907 | 907 | { |
  | 908 | 908 | echo '<div class="error metaseo-import-wrn"><p>' . esc\_html\_\_('Be careful you installed 2 extensions doing almost the same thing, please deactivate AIOSEO or Yoast in order to work more clearly!', 'wp-meta-seo') . '</p></div>'; |
  | 909 | 909 | } |
  | 910 | 910 |  |
  | 911 | 911 | add\_action('admin\_init', 'wpmsYoastMessage'); |
  | 912 | 912 |  |
  | 913 | 913 | /\*\* |
  | 914 | 914 | \* Notice import meta |
  | 915 | 915 | \* |
  | 916 | 916 | \* @return void |
  | 917 | 917 | \*/ |
  | 918 | 918 | function wpmsImportMetaNotice() |
  | 919 | 919 | { |
  | 920 | 920 | echo '<div class="error metaseo-import-wrn"><p>' . sprintf(esc\_html\_\_('We have found that you&#39;re using |
  | 921 | 921 | All In One Pack Plugin, WP Meta SEO can import the meta |
  | 922 | 922 | from this plugin, %s', 'wp-meta-seo'), '<a href="#" class="button mseo-import-action" |
  | 923 | 923 | style="position:relative" onclick="importMetaData(this, event)" id="\_aio\_"> |
  | 924 | 924 | <span class="spinner-light"></span>Import now</a> or |
  | 925 | 925 | <a href="#" class="dissmiss-import">dismiss this</a>') . '</p></div>'; |
  | 926 | 926 | } |
  | 927 | 927 |  |
  | 928 | 928 | /\*\* |
  | 929 | 929 | \* Notice import Yoast meta |
  | 930 | 930 | \* |
  | 931 | 931 | \* @return void |
  | 932 | 932 | \*/ |
  | 933 | 933 | function wpmsImportYoastMetaNotice() |
  | 934 | 934 | { |
  | 935 | 935 | echo '<div class="error metaseo-import-wrn"><p>' . sprintf(esc\_html\_\_('We have found that you&#39;re using Yoast SEO Plugin, |
  | 936 | 936 | WP Meta SEO can import the meta from this plugin, %s', 'wp-meta-seo'), '<a href="#" |
  | 937 | 937 | class="button mseo-import-action" style="position:relative" |
  | 938 | 938 | onclick="importMetaData(this, event)" id="\_yoast\_">Import now<span class="spinner-light"></span></a> |
  | 939 | 939 | or <a href="#" class="dissmiss-import">dismiss this</a>') . '</p></div>'; |
  | 940 | 940 | } |
  | 941 | 941 |  |
  | 942 | 942 | /\*\* |
  | 943 | 943 | \* Encode or decode all values in string format of an array |
  | 944 | 944 | \* |
  | 945 | 945 | \* @param array  $obj    List string |
  | 946 | 946 | \* @param string $action Action |
  | 947 | 947 | \* |
  | 948 | 948 | \* @return mixed |
  | 949 | 949 | \*/ |
  | 950 | 950 | function wpmsUtf8($obj, $action = 'encode') |
  | 951 | 951 | { |
  | 952 | 952 | $action = strtolower(trim($action)); |
  | 953 | 953 | $fn     = 'utf8\_' . $action; |
  | 954 | 954 | if (is\_array($obj)) { |
  | 955 | 955 | foreach ($obj as &$el) { |
  | 956 | 956 | if (is\_array($el)) { |
  | 957 | 957 | if (is\_callable($fn)) { |
  | 958 | 958 | $el = wpmsUtf8($el, $action); |
  | 959 | 959 | } |
  | 960 | 960 | } elseif (is\_string($el)) { |
  | 961 | 961 | $isASCII = mb\_detect\_encoding($el, 'ASCII'); |
  | 962 | 962 | if ($action === 'encode' && !$isASCII) { |
  | 963 | 963 | $el = mb\_convert\_encoding($el, 'UTF-8', 'auto'); |
  | 964 | 964 | } |
  | 965 | 965 |  |
  | 966 | 966 | $el = $fn($el); |
  | 967 | 967 | } |
  | 968 | 968 | } |
  | 969 | 969 | } elseif (is\_object($obj)) { |
  | 970 | 970 | $vars = array\_keys(get\_object\_vars($obj)); |
  | 971 | 971 | foreach ($vars as $var) { |
  | 972 | 972 | wpmsUtf8($obj->$var, $action); |
  | 973 | 973 | } |
  | 974 | 974 | } |
  | 975 | 975 |  |
  | 976 | 976 | return $obj; |
  | 977 | 977 | } |
  | 978 | 978 |  |
  | 979 | 979 | /\*\* |
  | 980 | 980 | \* Cmb render text link |
  | 981 | 981 | \* |
  | 982 | 982 | \* @param array  $field Field |
  | 983 | 983 | \* @param string $meta  Meta value |
  | 984 | 984 | \* |
  | 985 | 985 | \* @return void |
  | 986 | 986 | \*/ |
  | 987 | 987 | function textLink($field, $meta) |
  | 988 | 988 | { |
  | 989 | 989 | echo '<input class="cmb\_text\_link" type="text" size="45" id="', esc\_html($field['id']), '" |
  | 990 | 990 | name="', esc\_html($field['id']), '" value="', esc\_html($meta), '" />'; |
  | 991 | 991 | echo '<input class="cmb\_link\_button button" type="button" |
  | 992 | 992 | value="Voeg link toe" />', '<p class="cmb\_metabox\_description">', esc\_html($field['desc']), '</p>'; |
  | 993 | 993 | } |
  | 994 | 994 |  |
  | 995 | 995 | add\_action('cmb\_render\_text\_link', 'textLink', 10, 2); |
  | 996 | 996 | add\_action('template\_redirect', 'wpmsTemplateRedirect'); |
  | 997 | 997 |  |
  | 998 | 998 | /\*\* |
  | 999 | 999 | \* Redirect 404 url and insert url to database |
  | 1000 | 1000 | \* |
  | 1001 | 1001 | \* @return void |
  | 1002 | 1002 | \*/ |
  | 1003 | 1003 | function wpmsTemplateRedirect() |
  | 1004 | 1004 | { |
  | 1005 | 1005 | global $wpdb; |
  | 1006 | 1006 | // redirect by rule |
  | 1007 | 1007 | $url = ''; |
  | 1008 | 1008 | if (isset($\_SERVER['REQUEST\_URI'])) { |
  | 1009 | 1009 | $url = $\_SERVER['REQUEST\_URI']; |
  | 1010 | 1010 | } |
  | 1011 | 1011 |  |
  | 1012 | 1012 | if (!is\_home() && !is\_front\_page()) { |
  | 1013 | 1013 | $redirects       = $wpdb->get\_results($wpdb->prepare('SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE (link\_url = %s AND link\_url != "/") OR type = "add\_rule" OR type = "add\_custom"', array( |
  | 1014 | 1014 | $url |
  | 1015 | 1015 | ))); |
  | 1016 | 1016 | $target          = ''; |
  | 1017 | 1017 | $status\_redirect = 302; |
  | 1018 | 1018 | foreach ($redirects as $link) { |
  | 1019 | 1019 | // If redirect success, not redirect again |
  | 1020 | 1020 | $parse\_url = parse\_url($link->link\_url\_redirect); |
  | 1021 | 1021 | if (isset($parse\_url['path'])) { |
  | 1022 | 1022 | if (rtrim($parse\_url['path'], '/') === rtrim($url, '/')) { |
  | 1023 | 1023 | break; |
  | 1024 | 1024 | } |
  | 1025 | 1025 | } |
  | 1026 | 1026 | // Fix with xlink |
  | 1027 | 1027 | $query\_str = parse\_url($url, PHP\_URL\_QUERY); |
  | 1028 | 1028 | if (!empty($query\_str) && strpos($query\_str, 'xlink') !== false) { |
  | 1029 | 1029 | break; |
  | 1030 | 1030 | } |
  | 1031 | 1031 |  |
  | 1032 | 1032 | $link->link\_url = str\_replace(' ', '%20', $link->link\_url); |
  | 1033 | 1033 | $matches        = false; |
  | 1034 | 1034 | // phpcs:ignore Generic.PHP.NoSilencedErrors.Discouraged -- remove warning if match the URL |
  | 1035 | 1035 | if ((($link->link\_url === $url || $link->link\_url === rtrim($url, '/') || $link->link\_url === urldecode($url))) || (@preg\_match('@' . str\_replace('@', '\\@', $link->link\_url) . '@', $url, $matches) > 0) || (@preg\_match('@' . str\_replace('@', '\\@', $link->link\_url) . '@', urldecode($url), $matches) > 0)) { |
  | 1036 | 1036 | $target = $link->link\_url\_redirect; |
  | 1037 | 1037 | if ($link->type === 'add\_custom') { |
  | 1038 | 1038 | if (!is\_plugin\_active(WPMSEO\_ADDON\_FILENAME)) { |
  | 1039 | 1039 | return; |
  | 1040 | 1040 | } |
  | 1041 | 1041 | $status\_redirect = $link->meta\_title; |
  | 1042 | 1042 | } |
  | 1043 | 1043 |  |
  | 1044 | 1044 | break; |
  | 1045 | 1045 | } |
  | 1046 | 1046 | } |
  | 1047 | 1047 |  |
  | 1048 | 1048 | if ($target) { |
  | 1049 | 1049 | if (empty($status\_redirect) && !in\_array($status\_redirect, array(301, 302, 307))) { |
  | 1050 | 1050 | $status\_redirect = 302; |
  | 1051 | 1051 | } |
  | 1052 | 1052 | wp\_redirect($target, $status\_redirect); |
  | 1053 | 1053 | exit(); |
  | 1054 | 1054 | } else { |
  | 1055 | 1055 | if (is\_404()) { |
  | 1056 | 1056 | if (isset($\_SERVER['REQUEST\_URI'])) { |
  | 1057 | 1057 | $path\_infos = pathinfo($\_SERVER['REQUEST\_URI']); |
  | 1058 | 1058 | if (isset($path\_infos['extension'])) { |
  | 1059 | 1059 | return; |
  | 1060 | 1060 | } |
  | 1061 | 1061 |  |
  | 1062 | 1062 | $url = $\_SERVER['HTTP\_HOST'] . $\_SERVER['REQUEST\_URI']; |
  | 1063 | 1063 | if (isset($\_SERVER['HTTPS']) && |
  | 1064 | 1064 | ($\_SERVER['HTTPS'] === 'on' || (int) $\_SERVER['HTTPS'] === 1) || |
  | 1065 | 1065 | isset($\_SERVER['HTTP\_X\_FORWARDED\_PROTO']) && |
  | 1066 | 1066 | $\_SERVER['HTTP\_X\_FORWARDED\_PROTO'] === 'https') { |
  | 1067 | 1067 | $protocol = 'https://'; |
  | 1068 | 1068 | } else { |
  | 1069 | 1069 | $protocol = 'http://'; |
  | 1070 | 1070 | } |
  | 1071 | 1071 | $esc\_url = str\_replace(array('http://', 'https://'), $protocol, esc\_url($url)); |
  | 1072 | 1072 | $check   = $wpdb->get\_results($wpdb->prepare( |
  | 1073 | 1073 | 'SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE (link\_url=%s OR link\_url=%s OR link\_url=%s)', |
  | 1074 | 1074 | array( |
  | 1075 | 1075 | $url, |
  | 1076 | 1076 | $esc\_url, |
  | 1077 | 1077 | $\_SERVER['REQUEST\_URI'] |
  | 1078 | 1078 | ) |
  | 1079 | 1079 | )); |
  | 1080 | 1080 |  |
  | 1081 | 1081 | // get referer url |
  | 1082 | 1082 | if (wp\_get\_raw\_referer()) { |
  | 1083 | 1083 | $referer\_url = wp\_get\_raw\_referer(); |
  | 1084 | 1084 | } else { |
  | 1085 | 1085 | $referer\_url = get\_home\_url(); |
  | 1086 | 1086 | } |
  | 1087 | 1087 |  |
  | 1088 | 1088 | if ($referer\_url === '') { |
  | 1089 | 1089 | $referer\_url = get\_home\_url(); |
  | 1090 | 1090 | } |
  | 1091 | 1091 | if (count($check) === 0) { |
  | 1092 | 1092 | if (!function\_exists('wp\_validate\_redirect')) { |
  | 1093 | 1093 | require\_once(ABSPATH . 'wp-includes/pluggable.php'); |
  | 1094 | 1094 | } |
  | 1095 | 1095 |  |
  | 1096 | 1096 | // insert url |
  | 1097 | 1097 | $insert = array( |
  | 1098 | 1098 | 'link\_url'        => ($url), |
  | 1099 | 1099 | 'status\_code'     => '404 Not Found', |
  | 1100 | 1100 | 'status\_text'     => '404 Not Found', |
  | 1101 | 1101 | 'type'            => '404\_automaticaly', |
  | 1102 | 1102 | 'broken\_indexed'  => 1, |
  | 1103 | 1103 | 'broken\_internal' => 0, |
  | 1104 | 1104 | 'warning'         => 0, |
  | 1105 | 1105 | 'dismissed'       => 0, |
  | 1106 | 1106 | 'referrer'        => $referer\_url |
  | 1107 | 1107 | ); |
  | 1108 | 1108 |  |
  | 1109 | 1109 | $wpdb->insert($wpdb->prefix . 'wpms\_links', $insert); |
  | 1110 | 1110 | } else { |
  | 1111 | 1111 | // update url |
  | 1112 | 1112 | $links\_broken = $wpdb->get\_row($wpdb->prepare( |
  | 1113 | 1113 | 'SELECT \* FROM ' . $wpdb->prefix . 'wpms\_links WHERE (link\_url=%s OR link\_url=%s OR link\_url=%s) ', |
  | 1114 | 1114 | array( |
  | 1115 | 1115 | $url, |
  | 1116 | 1116 | $esc\_url, |
  | 1117 | 1117 | $\_SERVER['REQUEST\_URI'] |
  | 1118 | 1118 | ) |
  | 1119 | 1119 | )); |
  | 1120 | 1120 |  |
  | 1121 | 1121 | if (!empty($links\_broken)) { |
  | 1122 | 1122 | $list\_referrers = explode('||', $links\_broken->referrer); |
  | 1123 | 1123 | if (!in\_array($referer\_url, $list\_referrers)) { |
  | 1124 | 1124 | $list\_referrers[] = $referer\_url; |
  | 1125 | 1125 | } |
  | 1126 | 1126 |  |
  | 1127 | 1127 | $referrers = implode('||', $list\_referrers); |
  | 1128 | 1128 | $referrers = trim($referrers, '||'); |
  | 1129 | 1129 | $value     = array( |
  | 1130 | 1130 | 'hit'      => (int) $links\_broken->hit + 1, |
  | 1131 | 1131 | 'referrer' => $referrers |
  | 1132 | 1132 | ); |
  | 1133 | 1133 |  |
  | 1134 | 1134 | $wpdb->update( |
  | 1135 | 1135 | $wpdb->prefix . 'wpms\_links', |
  | 1136 | 1136 | $value, |
  | 1137 | 1137 | array('id' => $links\_broken->id), |
  | 1138 | 1138 | array('%d', '%s'), |
  | 1139 | 1139 | array('%d') |
  | 1140 | 1140 | ); |
  | 1141 | 1141 |  |
  | 1142 | 1142 | if (($url === $links\_broken->link\_url || esc\_url($url) === $links\_broken->link\_url) |
  | 1143 | 1143 | && $links\_broken->link\_url\_redirect !== '') { |
  | 1144 | 1144 | if (!empty($links\_broken->meta\_title)) { |
  | 1145 | 1145 | $status\_redirect = $links\_broken->meta\_title; |
  | 1146 | 1146 | } else { |
  | 1147 | 1147 | $status\_redirect = 302; |
  | 1148 | 1148 | } |
  | 1149 | 1149 |  |
  | 1150 | 1150 | if (empty($status\_redirect) && !in\_array($status\_redirect, array(301, 302, 307))) { |
  | 1151 | 1151 | $status\_redirect = 302; |
  | 1152 | 1152 | } |
  | 1153 | 1153 |  |
  | 1154 | 1154 | wp\_redirect($links\_broken->link\_url\_redirect, $status\_redirect); |
  | 1155 | 1155 | exit(); |
  | 1156 | 1156 | } |
  | 1157 | 1157 | } |
  | 1158 | 1158 | } |
  | 1159 | 1159 | } |
  | 1160 | 1160 |  |
  | 1161 | 1161 | $defaul\_settings\_404 = array( |
  | 1162 | 1162 | 'wpms\_redirect\_homepage' => 0, |
  | 1163 | 1163 | 'wpms\_type\_404'          => 'none', |
  | 1164 | 1164 | 'wpms\_page\_redirected'   => 'none' |
  | 1165 | 1165 | ); |
  | 1166 | 1166 | $wpms\_settings\_404   = get\_option('wpms\_settings\_404'); |
  | 1167 | 1167 |  |
  | 1168 | 1168 | if (is\_array($wpms\_settings\_404)) { |
  | 1169 | 1169 | $defaul\_settings\_404 = array\_merge($defaul\_settings\_404, $wpms\_settings\_404); |
  | 1170 | 1170 | } |
  | 1171 | 1171 |  |
  | 1172 | 1172 | // redirect url by settings |
  | 1173 | 1173 | if (isset($defaul\_settings\_404['wpms\_redirect\_homepage']) |
  | 1174 | 1174 | && (int) $defaul\_settings\_404['wpms\_redirect\_homepage'] === 1) { |
  | 1175 | 1175 | wp\_redirect(get\_home\_url()); |
  | 1176 | 1176 | exit(); |
  | 1177 | 1177 | } else { |
  | 1178 | 1178 | if (isset($defaul\_settings\_404['wpms\_type\_404'])) { |
  | 1179 | 1179 | switch ($defaul\_settings\_404['wpms\_type\_404']) { |
  | 1180 | 1180 | case 'wp-meta-seo-page': |
  | 1181 | 1181 | global $wpdb; |
  | 1182 | 1182 | $wpms\_page = $wpdb->get\_row($wpdb->prepare( |
  | 1183 | 1183 | 'SELECT \* FROM ' . $wpdb->prefix . 'posts WHERE post\_title = %s AND post\_excerpt = %s', |
  | 1184 | 1184 | array( |
  | 1185 | 1185 | '404 Error, content does not exist anymore', |
  | 1186 | 1186 | 'metaseo\_404\_page' |
  | 1187 | 1187 | ) |
  | 1188 | 1188 | )); |
  | 1189 | 1189 | if (!empty($wpms\_page)) { |
  | 1190 | 1190 | $link\_redirect = get\_permalink($wpms\_page->ID); |
  | 1191 | 1191 | if ($link\_redirect) { |
  | 1192 | 1192 | wp\_redirect($link\_redirect); |
  | 1193 | 1193 | exit(); |
  | 1194 | 1194 | } |
  | 1195 | 1195 | } |
  | 1196 | 1196 | break; |
  | 1197 | 1197 |  |
  | 1198 | 1198 | case 'custom\_page': |
  | 1199 | 1199 | if (isset($defaul\_settings\_404['wpms\_page\_redirected']) |
  | 1200 | 1200 | && $defaul\_settings\_404['wpms\_page\_redirected'] !== 'none') { |
  | 1201 | 1201 | $link\_redirect = get\_permalink($defaul\_settings\_404['wpms\_page\_redirected']); |
  | 1202 | 1202 | if ($link\_redirect) { |
  | 1203 | 1203 | wp\_redirect($link\_redirect); |
  | 1204 | 1204 | exit(); |
  | 1205 | 1205 | } |
  | 1206 | 1206 | } |
  | 1207 | 1207 | break; |
  | 1208 | 1208 | } |
  | 1209 | 1209 | } |
  | 1210 | 1210 | } |
  | 1211 | 1211 | } |
  | 1212 | 1212 | } |
  | 1213 | 1213 | } |
  | 1214 | 1214 | } |
  | 1215 | 1215 |  |
  | 1216 | 1216 | add\_action( |
  | 1217 | 1217 | 'after\_setup\_theme', |
  | 1218 | 1218 | function () { |
  | 1219 | 1219 | //phpcs:ignore WordPress.Security.NonceVerification.Recommended -- No action, no need verification |
  | 1220 | 1220 | if (defined('ET\_CORE') && !empty($\_GET['et\_fb'])) { |
  | 1221 | 1221 | require\_once(WPMETASEO\_PLUGIN\_DIR . 'inc/divi-seo/divi.php'); |
  | 1222 | 1222 | new Divi; |
  | 1223 | 1223 | } |
  | 1224 | 1224 | }, |
  | 1225 | 1225 | 11 |
  | 1226 | 1226 | ); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2870465&old=2869205&new_path=%2Fwp-meta-seo%2Ftrunk&old_path=%2Fwp-meta-seo%2Ftrunk)
* [Zip Archive](?format=zip&new=2870465&old=2869205&new_path=%2Fwp-meta-seo%2Ftrunk&old_path=%2Fwp-meta-seo%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_ea9c4f68_20250114_212147.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WP Meta SEO <= 4.5.3 - Missing Authorization in 'wpmsGGSaveInformation'

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WP Meta SEO <= 4.5.3 - Missing Authorization in 'wpmsGGSaveInformation'

5.4

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:L)

| CVE | [CVE-2023-1022](https://www.cve.org/CVERecord?id=CVE-2023-1022) |
| --- | --- |
| CVSS | 5.4 (Medium) |
| Publicly Published | February 24, 2023 |
| Last Updated | February 28, 2023 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The WP Meta SEO plugin for WordPress is vulnerable to unauthorized options update due to a missing capability check on the wpmsGGSaveInformation function in versions up to, and including, 4.5.3. This makes it possible for authenticated attackers with subscriber-level access to update google analytics options maintained by the plugin. This vulnerability occurred as a result of the plugin relying on nonce checks as a means of access control, and that nonce being accessible to all authenticated users regardless of role.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2870465/wp-meta-seo/trunk?contextall=1&old=2869205&old_path=%2Fwp-meta-seo%2Ftrunk#file2)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=2870465%40wp-meta-seo&new=2870465%40wp-meta-seo&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-meta-seo%2Fwp-meta-seo-453-missing-authorization-in-wpmsggsaveinformation&t=WP%20Meta%20SEO%20%3C%3D%204.5.3%20-%20Missing%20Authorization%20in%20%27wpmsGGSaveInformation%27 "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-meta-seo%2Fwp-meta-seo-453-missing-authorization-in-wpmsggsaveinformation&text=WP%20Meta%20SEO%20%3C%3D%204.5.3%20-%20Missing%20Authorization%20in%20%27wpmsGGSaveInformation%27 "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-meta-seo%2Fwp-meta-seo-453-missing-authorization-in-wpmsggsaveinformation "LinkedIn")
Email

## Vulnerability Details for WP Meta SEO

#### [WP Meta SEO](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-meta-seo)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-meta-seo [(view on wordpress.org)](https://wordpress.org/plugins/wp-meta-seo) |
| Patched? | Yes |
| Remediation | Update to version 4.5.4, or a newer patched version |
| Affected Version | * <= 4.5.3 |
| Patched Version | * 4.5.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


