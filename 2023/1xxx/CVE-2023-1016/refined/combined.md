=== Content from www.wordfence.com_b9f99bf5_20250115_085901.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Intuitive Custom Post Order <= 3.1.4.1 - Authenticated (Admin+) SQL Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Intuitive Custom Post Order <= 3.1.4.1 - Authenticated (Admin+) SQL Injection

6.6

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-1016](https://www.cve.org/CVERecord?id=CVE-2023-1016) |
| --- | --- |
| CVSS | 6.6 (Medium) |
| Publicly Published | January 25, 2023 |
| Last Updated | January 22, 2024 |

### Description

The Intuitive Custom Post Order plugin for WordPress is vulnerable to SQL Injection in versions up to, and including, 3.1.4.1, due to insufficient escaping on the user supplied 'objects' and 'tags' parameters and lack of sufficient preparation in the 'update\_options' function as well as the 'refresh' function which runs queries on the same values. This allows authenticated attackers, with administrator permissions, to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database. Note that this attack may only be practical on configurations where it is possible to bypass addslashes due to the database using a nonstandard character set such as GBK.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php?rev=2530122)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3012639%40intuitive-custom-post-order&new=3012639%40intuitive-custom-post-order&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fintuitive-custom-post-order%2Fintuitive-custom-post-order-313-authenticated-admin-sql-injection&t=Intuitive%20Custom%20Post%20Order%20%3C%3D%203.1.4.1%20-%20Authenticated%20%28Admin%2B%29%20SQL%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fintuitive-custom-post-order%2Fintuitive-custom-post-order-313-authenticated-admin-sql-injection&text=Intuitive%20Custom%20Post%20Order%20%3C%3D%203.1.4.1%20-%20Authenticated%20%28Admin%2B%29%20SQL%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fintuitive-custom-post-order%2Fintuitive-custom-post-order-313-authenticated-admin-sql-injection "LinkedIn")
Email

## Vulnerability Details for Intuitive Custom Post Order

#### [Intuitive Custom Post Order](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/intuitive-custom-post-order)

| Software Type | Plugin |
| --- | --- |
| Software Slug | intuitive-custom-post-order [(view on wordpress.org)](https://wordpress.org/plugins/intuitive-custom-post-order) |
| Patched? | Yes |
| Remediation | Update to version 3.1.5, or a newer patched version |
| Affected Version | * <= 3.1.4 |
| Patched Version | * 3.1.5 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_82871a27_20250115_085900.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fintuitive-custom-post-order%2Ftrunk%2Fintuitive-custom-post-order.php%3Frev%3D2530122)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php?rev=2448854 "Revision 2448854")
* [Latest Revision](/browser/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php)
* [Next Revision](/browser/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php?rev=2859143 "Revision 2859143") →
* [Blame](/browser/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php?annotate=blame&rev=2530122 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php?rev=2530122)

---

# [source:](/browser?rev=2530122&order=name "Go to repository root") [intuitive-custom-post-order](/browser/intuitive-custom-post-order?rev=2530122&order=name "View intuitive-custom-post-order")/[trunk](/browser/intuitive-custom-post-order/trunk?rev=2530122&order=name "View trunk")/[intuitive-custom-post-order.php](/browser/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php?rev=2530122&order=name "View intuitive-custom-post-order.php") @ [2530122](/changeset/2530122/ "View changeset 2530122")

View diff against:

View revision:

| [Last change](/changeset/2530122/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php "View differences") on this file since 2530122 was [2530122](/changeset/2530122/ "View changeset 2530122"), checked in by hijiri, [4 years ago](/timeline?from=2021-05-12T04%3A19%3A42Z&precision=second "See timeline at 05/12/2021 04:19:42 AM") |
| --- |
| v3.1.3 |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 26.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | \* Plugin Name: Intuitive Custom Post Order |
| [4](#L4) | \* Plugin URI: http://hijiriworld.com/web/plugins/intuitive-custom-post-order/ |
| [5](#L5) | \* Description: Intuitively, Order Items( Posts, Pages, ,Custom Post Types, Custom Taxonomies, Sites ) using a Drag and Drop Sortable JavaScript. |
| [6](#L6) | \* Version: 3.1.3 |
| [7](#L7) | \* Author: hijiri |
| [8](#L8) | \* Author URI: http://hijiriworld.com/web/ |
| [9](#L9) | \* Text Domain: intuitive-custom-post-order |
| [10](#L10) | \* Domain Path: /languages |
| [11](#L11) | \* License: GPLv2 or later |
| [12](#L12) | \* License URI: http://www.gnu.org/licenses/gpl-2.0.html |
| [13](#L13) | \*/ |
| [14](#L14) |  |
| [15](#L15) | /\*\* |
| [16](#L16) | \* Define |
| [17](#L17) | \*/ |
| [18](#L18) |  |
| [19](#L19) | define( 'HICPO\_URL', plugins\_url( '', \_\_FILE\_\_ ) ); |
| [20](#L20) | define( 'HICPO\_DIR', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
| [21](#L21) | define( 'HICPO\_VER', '3.1.3' ); |
| [22](#L22) |  |
| [23](#L23) | /\*\* |
| [24](#L24) | \* Uninstall hook |
| [25](#L25) | \*/ |
| [26](#L26) |  |
| [27](#L27) | register\_uninstall\_hook( \_\_FILE\_\_, 'hicpo\_uninstall' ); |
| [28](#L28) | function hicpo\_uninstall() |
| [29](#L29) | { |
| [30](#L30) | global $wpdb; |
| [31](#L31) | if ( function\_exists( 'is\_multisite' ) && is\_multisite() ) |
| [32](#L32) | { |
| [33](#L33) | $curr\_blog = $wpdb->blogid; |
| [34](#L34) | $blogids = $wpdb->get\_col( "SELECT blog\_id FROM $wpdb->blogs" ); |
| [35](#L35) | foreach( $blogids as $blog\_id ) { |
| [36](#L36) | switch\_to\_blog( $blog\_id ); |
| [37](#L37) | hicpo\_uninstall\_db\_terms(); |
| [38](#L38) | } |
| [39](#L39) | switch\_to\_blog( $curr\_blog ); |
| [40](#L40) | hicpo\_uninstall\_db\_blogs(); |
| [41](#L41) | } else { |
| [42](#L42) | hicpo\_uninstall\_db\_terms(); |
| [43](#L43) | } |
| [44](#L44) | delete\_option( 'hicpo\_activation' ); // old version before than 3.1.0 |
| [45](#L45) | delete\_option( 'hicpo\_ver' ); |
| [46](#L46) | } |
| [47](#L47) |  |
| [48](#L48) | // drop term\_order COLUMN to $wpdb->terms TABLE |
| [49](#L49) | function hicpo\_uninstall\_db\_terms() |
| [50](#L50) | { |
| [51](#L51) | global $wpdb; |
| [52](#L52) | $result = $wpdb->query( "DESCRIBE $wpdb->terms `term\_order`" ); |
| [53](#L53) | if ( $result ){ |
| [54](#L54) | $query = "ALTER TABLE $wpdb->terms DROP `term\_order`"; |
| [55](#L55) | $result = $wpdb->query( $query ); |
| [56](#L56) | } |
| [57](#L57) | } |
| [58](#L58) | // drop menu\_order COLUMN to $wpdb->blogs TABLE |
| [59](#L59) | function hicpo\_uninstall\_db\_blogs() |
| [60](#L60) | { |
| [61](#L61) | global $wpdb; |
| [62](#L62) | $result = $wpdb->query( "DESCRIBE $wpdb->blogs `menu\_order`" ); |
| [63](#L63) | if ( $result ) { |
| [64](#L64) | $query = "ALTER TABLE $wpdb->blogs DROP `menu\_order`"; |
| [65](#L65) | $result = $wpdb->query( $query ); |
| [66](#L66) | } |
| [67](#L67) | } |
| [68](#L68) |  |
| [69](#L69) | /\*\* |
| [70](#L70) | \* Class & Method |
| [71](#L71) | \*/ |
| [72](#L72) |  |
| [73](#L73) | $hicpo = new Hicpo(); |
| [74](#L74) |  |
| [75](#L75) | class Hicpo |
| [76](#L76) | { |
| [77](#L77) | /\*\* |
| [78](#L78) | \* Construct |
| [79](#L79) | \*/ |
| [80](#L80) | function \_\_construct() |
| [81](#L81) | { |
| [82](#L82) | // activation |
| [83](#L83) | $hicpo\_ver = get\_option( 'hicpo\_ver' ); |
| [84](#L84) | if ( version\_compare( $hicpo\_ver, HICPO\_VER ) < 0 ) $this->hicpo\_activation(); |
| [85](#L85) |  |
| [86](#L86) | // textdomain |
| [87](#L87) | add\_action( 'plugins\_loaded', array( $this, 'my\_plugin\_load\_plugin\_textdomain' ) ); |
| [88](#L88) |  |
| [89](#L89) | // add menu |
| [90](#L90) | add\_action( 'admin\_menu', array( $this, 'admin\_menu') ); |
| [91](#L91) |  |
| [92](#L92) | // admin init |
| [93](#L93) | if ( empty($\_GET) ) { |
| [94](#L94) | add\_action( 'admin\_init', array( $this, 'refresh' ) ); |
| [95](#L95) | } |
| [96](#L96) | add\_action( 'admin\_init', array( $this, 'update\_options') ); |
| [97](#L97) | add\_action( 'admin\_init', array( $this, 'load\_script\_css' ) ); |
| [98](#L98) |  |
| [99](#L99) | // sortable ajax action |
| [100](#L100) | add\_action( 'wp\_ajax\_update-menu-order', array( $this, 'update\_menu\_order' ) ); |
| [101](#L101) | add\_action( 'wp\_ajax\_update-menu-order-tags', array( $this, 'update\_menu\_order\_tags' ) ); |
| [102](#L102) |  |
| [103](#L103) | // reorder post types |
| [104](#L104) | add\_action( 'pre\_get\_posts', array( $this, 'hicpo\_pre\_get\_posts' ) ); |
| [105](#L105) |  |
| [106](#L106) | add\_filter( 'get\_previous\_post\_where', array( $this, 'hicpo\_previous\_post\_where' ) ); |
| [107](#L107) | add\_filter( 'get\_previous\_post\_sort', array( $this, 'hicpo\_previous\_post\_sort' ) ); |
| [108](#L108) | add\_filter( 'get\_next\_post\_where', array( $this, 'hocpo\_next\_post\_where' ) ); |
| [109](#L109) | add\_filter( 'get\_next\_post\_sort', array( $this, 'hicpo\_next\_post\_sort' ) ); |
| [110](#L110) |  |
| [111](#L111) | // reorder taxonomies |
| [112](#L112) | add\_filter( 'get\_terms\_orderby', array( $this, 'hicpo\_get\_terms\_orderby' ), 10, 3 ); |
| [113](#L113) | add\_filter( 'wp\_get\_object\_terms', array( $this, 'hicpo\_get\_object\_terms' ), 10, 3 ); |
| [114](#L114) | add\_filter( 'get\_terms', array( $this, 'hicpo\_get\_object\_terms' ), 10, 3 ); |
| [115](#L115) |  |
| [116](#L116) | // reorder sites |
| [117](#L117) | if ( function\_exists( 'is\_multisite' ) && is\_multisite() ) |
| [118](#L118) | { |
| [119](#L119) | add\_action( 'network\_admin\_menu', array( $this, 'network\_admin\_menu' ) ); |
| [120](#L120) | add\_action( 'admin\_init', array( $this, 'update\_network\_options' ) ); |
| [121](#L121) | add\_action( 'wp\_ajax\_update-menu-order-sites', array( $this, 'update\_menu\_order\_sites' ) ); |
| [122](#L122) |  |
| [123](#L123) | // networkadmin サイト削除時はサイト並び替え除外 |
| [124](#L124) | if( empty( $\_SERVER['QUERY\_STRING'] ) || |
| [125](#L125) | ( |
| [126](#L126) | !empty( $\_SERVER['QUERY\_STRING'] ) && |
| [127](#L127) | 'action=deleteblog' !== $\_SERVER['QUERY\_STRING'] &&    // delete |
| [128](#L128) | 'action=allblogs' !== $\_SERVER['QUERY\_STRING']         // delete all |
| [129](#L129) | ) |
| [130](#L130) | ) { |
| [131](#L131) |  |
| [132](#L132) | // call from 'get\_sites' |
| [133](#L133) | add\_filter( 'sites\_clauses', array( $this, 'hicpo\_sites\_clauses' ), 10, 1 ); |
| [134](#L134) |  |
| [135](#L135) | add\_action( 'admin\_init', array( $this, 'refresh\_network' ) ); |
| [136](#L136) |  |
| [137](#L137) | // adminbar sites reorder |
| [138](#L138) | add\_filter( 'get\_blogs\_of\_user', array( $this, 'hicpo\_get\_blogs\_of\_user' ), 10, 3 ); |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | // before wp v4.6.0 \* wp\_get\_sites |
| [142](#L142) | add\_action( 'init', array( $this, 'refresh\_front\_network' ) ); |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | /\*\* |
| [147](#L147) | \* Method |
| [148](#L148) | \*/ |
| [149](#L149) | function hicpo\_activation() |
| [150](#L150) | { |
| [151](#L151) | global $wpdb; |
| [152](#L152) |  |
| [153](#L153) | // add term\_order COLUMN to $wpdb->terms TABLE |
| [154](#L154) | $result = $wpdb->query( "DESCRIBE $wpdb->terms `term\_order`" ); |
| [155](#L155) | if ( !$result ) { |
| [156](#L156) | $query = "ALTER TABLE $wpdb->terms ADD `term\_order` INT( 4 ) NULL DEFAULT '0'"; |
| [157](#L157) | $result = $wpdb->query( $query ); |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | if ( function\_exists( 'is\_multisite' ) && is\_multisite() ) { |
| [161](#L161) | // add menu\_order COLUMN to $wpdb->blogs TABLE |
| [162](#L162) | $result = $wpdb->query( "DESCRIBE $wpdb->blogs `menu\_order`" ); |
| [163](#L163) | if ( !$result ) { |
| [164](#L164) | $query = "ALTER TABLE $wpdb->blogs ADD `menu\_order` INT( 4 ) NULL DEFAULT '0'"; |
| [165](#L165) | $result = $wpdb->query( $query ); |
| [166](#L166) | } |
| [167](#L167) | } |
| [168](#L168) | update\_option( 'hicpo\_ver', HICPO\_VER ); |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | function my\_plugin\_load\_plugin\_textdomain() |
| [172](#L172) | { |
| [173](#L173) | load\_plugin\_textdomain( 'intuitive-custom-post-order', false, basename( dirname( \_\_FILE\_\_ ) ).'/languages/' ); |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | function admin\_menu() |
| [177](#L177) | { |
| [178](#L178) | add\_options\_page( \_\_( 'Intuitive CPO', 'intuitive-custom-post-order' ), \_\_( 'Intuitive CPO', 'intuitive-custom-post-order' ), 'manage\_options', 'hicpo-settings', array( $this,'admin\_page' ) ); |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) | function admin\_page() |
| [182](#L182) | { |
| [183](#L183) | require HICPO\_DIR.'admin/settings.php'; |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | function network\_admin\_menu() |
| [187](#L187) | { |
| [188](#L188) | add\_submenu\_page( 'settings.php', \_\_( 'Intuitive CPO', 'hicpo' ), \_\_( 'Intuitive CPO', 'hicpo' ), 'manage\_options', 'hicpo-network-settings', array( $this, 'network\_admin\_page' ) ); |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) | function network\_admin\_page() |
| [192](#L192) | { |
| [193](#L193) | require HICPO\_DIR.'admin/settings-network.php'; |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | function \_check\_load\_script\_css() |
| [197](#L197) | { |
| [198](#L198) | global $pagenow, $typenow; |
| [199](#L199) |  |
| [200](#L200) | $active = false; |
| [201](#L201) |  |
| [202](#L202) | // multisite > sites |
| [203](#L203) | if ( |
| [204](#L204) | function\_exists( 'is\_multisite' ) |
| [205](#L205) | && is\_multisite() |
| [206](#L206) | && $pagenow == 'sites.php' |
| [207](#L207) | && get\_option( 'hicpo\_network\_sites' ) |
| [208](#L208) | ) |
| [209](#L209) | { |
| [210](#L210) | return true; |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | $objects = $this->get\_hicpo\_options\_objects(); |
| [214](#L214) | $tags = $this->get\_hicpo\_options\_tags(); |
| [215](#L215) |  |
| [216](#L216) | if ( empty( $objects ) && empty( $tags ) ) return false; |
| [217](#L217) |  |
| [218](#L218) | // exclude (sorting, addnew page, edit page) |
| [219](#L219) | if ( isset( $\_GET['orderby'] ) || strstr( $\_SERVER['REQUEST\_URI'], 'action=edit' ) || strstr( $\_SERVER['REQUEST\_URI'], 'wp-admin/post-new.php' ) ) return false; |
| [220](#L220) |  |
| [221](#L221) | if ( !empty( $objects ) ) { |
| [222](#L222) | if ( isset( $\_GET['post\_type'] ) && !isset( $\_GET['taxonomy'] ) && in\_array( $\_GET['post\_type'], $objects ) ) { // if page or custom post types |
| [223](#L223) | $active = true; |
| [224](#L224) | } |
| [225](#L225) | if ( !isset( $\_GET['post\_type'] ) && strstr( $\_SERVER['REQUEST\_URI'], 'wp-admin/edit.php' ) && in\_array( 'post', $objects ) ) { // if post |
| [226](#L226) | $active = true; |
| [227](#L227) | } |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | if ( !empty( $tags ) ) { |
| [231](#L231) | if ( isset( $\_GET['taxonomy'] ) && in\_array( $\_GET['taxonomy'], $tags ) ) { |
| [232](#L232) | $active = true; |
| [233](#L233) | } |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | return $active; |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | function load\_script\_css() |
| [240](#L240) | { |
| [241](#L241) | if ( $this->\_check\_load\_script\_css() ) { |
| [242](#L242) | wp\_enqueue\_script( 'jquery' ); |
| [243](#L243) | wp\_enqueue\_script( 'jquery-ui-sortable' ); |
| [244](#L244) | wp\_enqueue\_script( 'hicpojs', HICPO\_URL.'/js/hicpo.js', array( 'jquery' ), null, true ); |
| [245](#L245) |  |
| [246](#L246) | wp\_enqueue\_style( 'hicpo', HICPO\_URL.'/css/hicpo.css', array(), null ); |
| [247](#L247) | } |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | function refresh() |
| [251](#L251) | { |
| [252](#L252) | global $wpdb; |
| [253](#L253) | $objects = $this->get\_hicpo\_options\_objects(); |
| [254](#L254) | $tags = $this->get\_hicpo\_options\_tags(); |
| [255](#L255) |  |
| [256](#L256) | if ( !empty( $objects ) ) { |
| [257](#L257) | foreach( $objects as $object) { |
| [258](#L258) | $result = $wpdb->get\_results( " |
| [259](#L259) | SELECT count(\*) as cnt, max(menu\_order) as max, min(menu\_order) as min |
| [260](#L260) | FROM $wpdb->posts |
| [261](#L261) | WHERE post\_type = '".$object."' AND post\_status IN ('publish', 'pending', 'draft', 'private', 'future') |
| [262](#L262) | " ); |
| [263](#L263) | if ( $result[0]->cnt == 0 || $result[0]->cnt == $result[0]->max ) continue; |
| [264](#L264) |  |
| [265](#L265) | $results = $wpdb->get\_results( " |
| [266](#L266) | SELECT ID |
| [267](#L267) | FROM $wpdb->posts |
| [268](#L268) | WHERE post\_type = '".$object."' AND post\_status IN ('publish', 'pending', 'draft', 'private', 'future') |
| [269](#L269) | ORDER BY menu\_order ASC |
| [270](#L270) | " ); |
| [271](#L271) | foreach( $results as $key => $result ) { |
| [272](#L272) | $wpdb->update( $wpdb->posts, array( 'menu\_order' => $key+1 ), array( 'ID' => $result->ID ) ); |
| [273](#L273) | } |
| [274](#L274) | } |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | if ( !empty( $tags ) ) { |
| [278](#L278) | foreach( $tags as $taxonomy ) { |
| [279](#L279) | $result = $wpdb->get\_results( " |
| [280](#L280) | SELECT count(\*) as cnt, max(term\_order) as max, min(term\_order) as min |
| [281](#L281) | FROM $wpdb->terms AS terms |
| [282](#L282) | INNER JOIN $wpdb->term\_taxonomy AS term\_taxonomy ON ( terms.term\_id = term\_taxonomy.term\_id ) |
| [283](#L283) | WHERE term\_taxonomy.taxonomy = '".$taxonomy."' |
| [284](#L284) | " ); |
| [285](#L285) | if ( $result[0]->cnt == 0 || $result[0]->cnt == $result[0]->max ) continue; |
| [286](#L286) |  |
| [287](#L287) | $results = $wpdb->get\_results( " |
| [288](#L288) | SELECT terms.term\_id |
| [289](#L289) | FROM $wpdb->terms AS terms |
| [290](#L290) | INNER JOIN $wpdb->term\_taxonomy AS term\_taxonomy ON ( terms.term\_id = term\_taxonomy.term\_id ) |
| [291](#L291) | WHERE term\_taxonomy.taxonomy = '".$taxonomy."' |
| [292](#L292) | ORDER BY term\_order ASC |
| [293](#L293) | " ); |
| [294](#L294) | foreach( $results as $key => $result ) { |
| [295](#L295) | $wpdb->update( $wpdb->terms, array( 'term\_order' => $key+1 ), array( 'term\_id' => $result->term\_id ) ); |
| [296](#L296) | } |
| [297](#L297) | } |
| [298](#L298) | } |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | function refresh\_network() |
| [302](#L302) | { |
| [303](#L303) | global $pagenow; |
| [304](#L304) | if( 'sites.php' === $pagenow && !isset( $\_GET['orderby'] ) ) { |
| [305](#L305) | add\_filter( 'query', array( $this, 'refresh\_network\_2' ) ); |
| [306](#L306) | } |
| [307](#L307) | } |
| [308](#L308) |  |
| [309](#L309) | function refresh\_network\_2( $query ) |
| [310](#L310) | { |
| [311](#L311) | global $wpdb, $wp\_version, $blog\_id; |
| [312](#L312) |  |
| [313](#L313) | /\*\* |
| [314](#L314) | \* after wp4.7.0 |
| [315](#L315) | \* ブログのステータスが公開以外の際、$blog\_id=1以外のoptionを取得しようとする処理のSQLを除外する |
| [316](#L316) | \* eq.) SELECT option\_name, option\_value FROM wp\_11\_options WHERE autoload = 'yes' |
| [317](#L317) | \*/ |
| [318](#L318) |  |
| [319](#L319) | // $wpdb->get\_varやswitch\_to\_blog(1)からのget\_optionでは処理が止まるため、$blog\_idで判別 |
| [320](#L320) | if ( version\_compare( $wp\_version, '4.7.0' ) >= 0 ) { |
| [321](#L321) | if( 1 !== $blog\_id ) { |
| [322](#L322) | return $query; |
| [323](#L323) | } |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | $hicpo\_network\_sites = get\_option( 'hicpo\_network\_sites' ); |
| [327](#L327) | if( !$hicpo\_network\_sites ) return $query; |
| [328](#L328) |  |
| [329](#L329) |  |
| [330](#L330) | if( false !== strpos( $query, "SELECT \* FROM $wpdb->blogs WHERE site\_id = '1'" ) || |
| [331](#L331) | false !== strpos( $query, "SQL\_CALC\_FOUND\_ROWS blog\_id FROM $wpdb->blogs  WHERE site\_id = 1" ) |
| [332](#L332) | ) { |
| [333](#L333) | if ( false !== strpos( $query, " LIMIT " ) ) { |
| [334](#L334) | $query = preg\_replace( '/^(.\*) LIMIT(.\*)$/', '$1 ORDER BY menu\_order ASC LIMIT $2', $query ); |
| [335](#L335) | } else { |
| [336](#L336) | $query .= " ORDER BY menu\_order ASC"; |
| [337](#L337) | } |
| [338](#L338) | } |
| [339](#L339) | return $query; |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | function update\_menu\_order() |
| [343](#L343) | { |
| [344](#L344) | global $wpdb; |
| [345](#L345) |  |
| [346](#L346) | parse\_str( $\_POST['order'], $data ); |
| [347](#L347) |  |
| [348](#L348) | if ( !is\_array( $data ) ) return false; |
| [349](#L349) |  |
| [350](#L350) | // get objects per now page |
| [351](#L351) | $id\_arr = array(); |
| [352](#L352) | foreach( $data as $key => $values ) { |
| [353](#L353) | foreach( $values as $position => $id ) { |
| [354](#L354) | $id\_arr[] = $id; |
| [355](#L355) | } |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | // get menu\_order of objects per now page |
| [359](#L359) | $menu\_order\_arr = array(); |
| [360](#L360) | foreach( $id\_arr as $key => $id ) { |
| [361](#L361) | $results = $wpdb->get\_results( "SELECT menu\_order FROM $wpdb->posts WHERE ID = ".intval( $id ) ); |
| [362](#L362) | foreach( $results as $result ) { |
| [363](#L363) | $menu\_order\_arr[] = $result->menu\_order; |
| [364](#L364) | } |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) | // maintains key association = no |
| [368](#L368) | sort( $menu\_order\_arr ); |
| [369](#L369) |  |
| [370](#L370) | foreach( $data as $key => $values ) { |
| [371](#L371) | foreach( $values as $position => $id ) { |
| [372](#L372) | $wpdb->update( $wpdb->posts, array( 'menu\_order' => $menu\_order\_arr[$position] ), array( 'ID' => intval( $id ) ) ); |
| [373](#L373) | } |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) | // same number check |
| [377](#L377) | $post\_type = get\_post\_type($id); |
| [378](#L378) | $sql = "SELECT COUNT(menu\_order) AS mo\_count, post\_type, menu\_order FROM $wpdb->posts |
| [379](#L379) | WHERE post\_type = '{$post\_type}' AND post\_status IN ('publish', 'pending', 'draft', 'private', 'future') |
| [380](#L380) | AND menu\_order > 0 GROUP BY post\_type, menu\_order HAVING (mo\_count) > 1"; |
| [381](#L381) | $results = $wpdb->get\_results( $sql ); |
| [382](#L382) | if(count($results) > 0) { |
| [383](#L383) | // menu\_order refresh |
| [384](#L384) | $sql = "SELECT ID, menu\_order FROM $wpdb->posts |
| [385](#L385) | WHERE post\_type = '{$post\_type}' AND post\_status IN ('publish', 'pending', 'draft', 'private', 'future') |
| [386](#L386) | AND menu\_order > 0 ORDER BY menu\_order"; |
| [387](#L387) | $results = $wpdb->get\_results( $sql ); |
| [388](#L388) | foreach( $results as $key => $result ) { |
| [389](#L389) | $view\_posi = array\_search($result->ID, $id\_arr, true); |
| [390](#L390) | if( $view\_posi === false) { |
| [391](#L391) | $view\_posi = 999; |
| [392](#L392) | } |
| [393](#L393) | $sort\_key = ($result->menu\_order \* 1000) + $view\_posi; |
| [394](#L394) | $sort\_ids[$sort\_key] = $result->ID; |
| [395](#L395) | } |
| [396](#L396) | ksort($sort\_ids); |
| [397](#L397) | $oreder\_no = 0; |
| [398](#L398) | foreach( $sort\_ids as $key => $id ) { |
| [399](#L399) | $oreder\_no = $oreder\_no + 1; |
| [400](#L400) | $wpdb->update( $wpdb->posts, array( 'menu\_order' => $oreder\_no ), array( 'ID' => intval( $id ) ) ); |
| [401](#L401) | } |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | function update\_menu\_order\_tags() |
| [407](#L407) | { |
| [408](#L408) | global $wpdb; |
| [409](#L409) |  |
| [410](#L410) | parse\_str( $\_POST['order'], $data ); |
| [411](#L411) |  |
| [412](#L412) | if ( !is\_array( $data ) ) return false; |
| [413](#L413) |  |
| [414](#L414) | $id\_arr = array(); |
| [415](#L415) | foreach( $data as $key => $values ) { |
| [416](#L416) | foreach( $values as $position => $id ) { |
| [417](#L417) | $id\_arr[] = $id; |
| [418](#L418) | } |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | $menu\_order\_arr = array(); |
| [422](#L422) | foreach( $id\_arr as $key => $id ) { |
| [423](#L423) | $results = $wpdb->get\_results( "SELECT term\_order FROM $wpdb->terms WHERE term\_id = ".intval( $id ) ); |
| [424](#L424) | foreach( $results as $result ) { |
| [425](#L425) | $menu\_order\_arr[] = $result->term\_order; |
| [426](#L426) | } |
| [427](#L427) | } |
| [428](#L428) | sort( $menu\_order\_arr ); |
| [429](#L429) |  |
| [430](#L430) | foreach( $data as $key => $values ) { |
| [431](#L431) | foreach( $values as $position => $id ) { |
| [432](#L432) | $wpdb->update( $wpdb->terms, array( 'term\_order' => $menu\_order\_arr[$position] ), array( 'term\_id' => intval( $id ) ) ); |
| [433](#L433) | } |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | // same number check |
| [437](#L437) | $term = get\_term($id); |
| [438](#L438) | $taxonomy = $term->taxonomy; |
| [439](#L439) | $sql = "SELECT COUNT(term\_order) AS to\_count, term\_order |
| [440](#L440) | FROM $wpdb->terms AS terms |
| [441](#L441) | INNER JOIN $wpdb->term\_taxonomy AS term\_taxonomy ON ( terms.term\_id = term\_taxonomy.term\_id ) |
| [442](#L442) | WHERE term\_taxonomy.taxonomy = '".$taxonomy."'GROUP BY taxonomy, term\_order HAVING (to\_count) > 1"; |
| [443](#L443) | $results = $wpdb->get\_results( $sql ); |
| [444](#L444) | if(count($results) > 0) { |
| [445](#L445) | // term\_order refresh |
| [446](#L446) | $sql = "SELECT terms.term\_id, term\_order |
| [447](#L447) | FROM $wpdb->terms AS terms |
| [448](#L448) | INNER JOIN $wpdb->term\_taxonomy AS term\_taxonomy ON ( terms.term\_id = term\_taxonomy.term\_id ) |
| [449](#L449) | WHERE term\_taxonomy.taxonomy = '".$taxonomy."' |
| [450](#L450) | ORDER BY term\_order ASC"; |
| [451](#L451) | $results = $wpdb->get\_results( $sql ); |
| [452](#L452) | foreach( $results as $key => $result ) { |
| [453](#L453) | $view\_posi = array\_search($result->term\_id, $id\_arr, true); |
| [454](#L454) | if( $view\_posi === false) { |
| [455](#L455) | $view\_posi = 999; |
| [456](#L456) | } |
| [457](#L457) | $sort\_key = ($result->term\_order \* 1000) + $view\_posi; |
| [458](#L458) | $sort\_ids[$sort\_key] = $result->term\_id; |
| [459](#L459) | } |
| [460](#L460) | ksort($sort\_ids); |
| [461](#L461) | $oreder\_no = 0; |
| [462](#L462) | foreach( $sort\_ids as $key => $id ) { |
| [463](#L463) | $oreder\_no = $oreder\_no + 1; |
| [464](#L464) | $wpdb->update( $wpdb->terms, array( 'term\_order' => $oreder\_no ), array( 'term\_id' => $id ) ); |
| [465](#L465) | } |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | function update\_menu\_order\_sites() |
| [471](#L471) | { |
| [472](#L472) | global $wpdb; |
| [473](#L473) |  |
| [474](#L474) | parse\_str( $\_POST['order'], $data ); |
| [475](#L475) |  |
| [476](#L476) | if ( !is\_array( $data ) ) return false; |
| [477](#L477) |  |
| [478](#L478) | $id\_arr = array(); |
| [479](#L479) | foreach( $data as $key => $values ) { |
| [480](#L480) | foreach( $values as $position => $id ) { |
| [481](#L481) | $id\_arr[] = $id; |
| [482](#L482) | } |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) | foreach( $data as $key => $values ) { |
| [486](#L486) | foreach( $values as $position => $id ) { |
| [487](#L487) | $wpdb->update( $wpdb->blogs, array( 'menu\_order' => $position+1 ), array( 'blog\_id' => intval( $id ) ) ); |
| [488](#L488) | } |
| [489](#L489) | } |
| [490](#L490) | } |
| [491](#L491) |  |
| [492](#L492) | /\*\* |
| [493](#L493) | \* はじめて有効化されたオブジェクトは、ディフォルトの order に従って menu\_order セットする |
| [494](#L494) | \* |
| [495](#L495) | \* post\_type: orderby=post\_date, order=DESC |
| [496](#L496) | \* page: orderby=menu\_order, post\_title, order=ASC |
| [497](#L497) | \* taxonomy: orderby=name, order=ASC |
| [498](#L498) | \* |
| [499](#L499) | \* 判定は: アイテム数が 0 以上で menu\_order の最大値とアイテム数が同じではないオブジェクト |
| [500](#L500) | \*/ |
| [501](#L501) |  |
| [502](#L502) | function update\_options() |
| [503](#L503) | { |
| [504](#L504) | global $wpdb; |
| [505](#L505) |  |
| [506](#L506) | if ( !isset( $\_POST['hicpo\_submit'] ) ) return false; |
| [507](#L507) |  |
| [508](#L508) | check\_admin\_referer( 'nonce\_hicpo' ); |
| [509](#L509) |  |
| [510](#L510) | $input\_options = array(); |
| [511](#L511) | $input\_options['objects'] = isset( $\_POST['objects'] ) ? $\_POST['objects'] : ''; |
| [512](#L512) | $input\_options['tags'] = isset( $\_POST['tags'] ) ? $\_POST['tags'] : ''; |
| [513](#L513) |  |
| [514](#L514) | update\_option( 'hicpo\_options', $input\_options ); |
| [515](#L515) |  |
| [516](#L516) | $objects = $this->get\_hicpo\_options\_objects(); |
| [517](#L517) | $tags = $this->get\_hicpo\_options\_tags(); |
| [518](#L518) |  |
| [519](#L519) | if ( !empty( $objects ) ) { |
| [520](#L520) | foreach( $objects as $object ) { |
| [521](#L521) | $result = $wpdb->get\_results( " |
| [522](#L522) | SELECT count(\*) as cnt, max(menu\_order) as max, min(menu\_order) as min |
| [523](#L523) | FROM $wpdb->posts |
| [524](#L524) | WHERE post\_type = '".$object."' AND post\_status IN ('publish', 'pending', 'draft', 'private', 'future') |
| [525](#L525) | " ); |
| [526](#L526) | if ( $result[0]->cnt == 0 || $result[0]->cnt == $result[0]->max ) continue; |
| [527](#L527) |  |
| [528](#L528) | if ( $object == 'page' ) { |
| [529](#L529) | $results = $wpdb->get\_results( " |
| [530](#L530) | SELECT ID |
| [531](#L531) | FROM $wpdb->posts |
| [532](#L532) | WHERE post\_type = '".$object."' AND post\_status IN ('publish', 'pending', 'draft', 'private', 'future') |
| [533](#L533) | ORDER BY menu\_order, post\_title ASC |
| [534](#L534) | " ); |
| [535](#L535) | } else { |
| [536](#L536) | $results = $wpdb->get\_results( " |
| [537](#L537) | SELECT ID |
| [538](#L538) | FROM $wpdb->posts |
| [539](#L539) | WHERE post\_type = '".$object."' AND post\_status IN ('publish', 'pending', 'draft', 'private', 'future') |
| [540](#L540) | ORDER BY post\_date DESC |
| [541](#L541) | " ); |
| [542](#L542) | } |
| [543](#L543) | foreach( $results as $key => $result ) { |
| [544](#L544) | $wpdb->update( $wpdb->posts, array( 'menu\_order' => $key+1 ), array( 'ID' => $result->ID ) ); |
| [545](#L545) | } |
| [546](#L546) | } |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | if ( !empty( $tags ) ) { |
| [550](#L550) | foreach( $tags as $taxonomy ) { |
| [551](#L551) | $result = $wpdb->get\_results( " |
| [552](#L552) | SELECT count(\*) as cnt, max(term\_order) as max, min(term\_order) as min |
| [553](#L553) | FROM $wpdb->terms AS terms |
| [554](#L554) | INNER JOIN $wpdb->term\_taxonomy AS term\_taxonomy ON ( terms.term\_id = term\_taxonomy.term\_id ) |
| [555](#L555) | WHERE term\_taxonomy.taxonomy = '".$taxonomy."' |
| [556](#L556) | " ); |
| [557](#L557) | if ( $result[0]->cnt == 0 || $result[0]->cnt == $result[0]->max ) continue; |
| [558](#L558) |  |
| [559](#L559) | $results = $wpdb->get\_results( " |
| [560](#L560) | SELECT terms.term\_id |
| [561](#L561) | FROM $wpdb->terms AS terms |
| [562](#L562) | INNER JOIN $wpdb->term\_taxonomy AS term\_taxonomy ON ( terms.term\_id = term\_taxonomy.term\_id ) |
| [563](#L563) | WHERE term\_taxonomy.taxonomy = '".$taxonomy."' |
| [564](#L564) | ORDER BY name ASC |
| [565](#L565) | " ); |
| [566](#L566) | foreach( $results as $key => $result ) { |
| [567](#L567) | $wpdb->update( $wpdb->terms, array( 'term\_order' => $key+1 ), array( 'term\_id' => $result->term\_id ) ); |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | wp\_redirect( 'admin.php?page=hicpo-settings&msg=update' ); |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | function update\_network\_options() |
| [576](#L576) | { |
| [577](#L577) | global $wpdb; |
| [578](#L578) |  |
| [579](#L579) | if ( !isset( $\_POST['hicpo\_network\_submit' ] ) ) return false; |
| [580](#L580) |  |
| [581](#L581) | check\_admin\_referer( 'nonce\_hicpo' ); |
| [582](#L582) |  |
| [583](#L583) | $hicpo\_network\_sites = isset( $\_POST['sites'] ) ? $\_POST['sites'] : 0; |
| [584](#L584) |  |
| [585](#L585) | update\_option( 'hicpo\_network\_sites', $hicpo\_network\_sites ); |
| [586](#L586) |  |
| [587](#L587) | // Initial |
| [588](#L588) | $result = $wpdb->get\_results( " |
| [589](#L589) | SELECT count(\*) as cnt, max(menu\_order) as max, min(menu\_order) as min |
| [590](#L590) | FROM $wpdb->blogs |
| [591](#L591) | " ); |
| [592](#L592) | if ( $result[0]->cnt == 0 || $result[0]->cnt == $result[0]->max ) { |
| [593](#L593) |  |
| [594](#L594) | } else { |
| [595](#L595) | $results = $wpdb->get\_results( " |
| [596](#L596) | SELECT blog\_id |
| [597](#L597) | FROM $wpdb->blogs |
| [598](#L598) | ORDER BY blog\_id ASC |
| [599](#L599) | " ); |
| [600](#L600) | foreach( $results as $key => $result ) { |
| [601](#L601) | $wpdb->update( $wpdb->blogs, array( 'menu\_order' => $key+1 ), array( 'blog\_id' => $result->blog\_id ) ); |
| [602](#L602) | } |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | wp\_redirect( 'settings.php?page=hicpo-network-settings&msg=update' ); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | function hicpo\_previous\_post\_where( $where ) |
| [609](#L609) | { |
| [610](#L610) | global $post; |
| [611](#L611) |  |
| [612](#L612) | $objects = $this->get\_hicpo\_options\_objects(); |
| [613](#L613) | if ( empty( $objects ) ) return $where; |
| [614](#L614) |  |
| [615](#L615) | if ( isset( $post->post\_type ) && in\_array( $post->post\_type, $objects ) ) { |
| [616](#L616) | $current\_menu\_order = $post->menu\_order; |
| [617](#L617) | $where = str\_replace( "p.post\_date < '".$post->post\_date."'", "p.menu\_order > '".$current\_menu\_order."'", $where ); |
| [618](#L618) | } |
| [619](#L619) | return $where; |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | function hicpo\_previous\_post\_sort( $orderby ) |
| [623](#L623) | { |
| [624](#L624) | global $post; |
| [625](#L625) |  |
| [626](#L626) | $objects = $this->get\_hicpo\_options\_objects(); |
| [627](#L627) | if ( empty( $objects ) ) return $orderby; |
| [628](#L628) |  |
| [629](#L629) | if ( isset( $post->post\_type ) && in\_array( $post->post\_type, $objects ) ) { |
| [630](#L630) | $orderby = 'ORDER BY p.menu\_order ASC LIMIT 1'; |
| [631](#L631) | } |
| [632](#L632) | return $orderby; |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | function hocpo\_next\_post\_where( $where ) |
| [636](#L636) | { |
| [637](#L637) | global $post; |
| [638](#L638) |  |
| [639](#L639) | $objects = $this->get\_hicpo\_options\_objects(); |
| [640](#L640) | if ( empty( $objects ) ) return $where; |
| [641](#L641) |  |
| [642](#L642) | if ( isset( $post->post\_type ) && in\_array( $post->post\_type, $objects ) ) { |
| [643](#L643) | $current\_menu\_order = $post->menu\_order; |
| [644](#L644) | $where = str\_replace( "p.post\_date > '".$post->post\_date."'", "p.menu\_order < '".$current\_menu\_order."'", $where ); |
| [645](#L645) | } |
| [646](#L646) | return $where; |
| [647](#L647) | } |
| [648](#L648) |  |
| [649](#L649) | function hicpo\_next\_post\_sort( $orderby ) |
| [650](#L650) | { |
| [651](#L651) | global $post; |
| [652](#L652) |  |
| [653](#L653) | $objects = $this->get\_hicpo\_options\_objects(); |
| [654](#L654) | if ( empty( $objects ) ) return $orderby; |
| [655](#L655) |  |
| [656](#L656) | if ( isset( $post->post\_type ) && in\_array( $post->post\_type, $objects ) ) { |
| [657](#L657) | $orderby = 'ORDER BY p.menu\_order DESC LIMIT 1'; |
| [658](#L658) | } |
| [659](#L659) | return $orderby; |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | function hicpo\_pre\_get\_posts( $wp\_query ) |
| [663](#L663) | { |
| [664](#L664) | $objects = $this->get\_hicpo\_options\_objects(); |
| [665](#L665) | if ( empty( $objects ) ) return false; |
| [666](#L666) |  |
| [667](#L667) | /\*\* |
| [668](#L668) | \* for Admin |
| [669](#L669) | \* |
| [670](#L670) | \* @default |
| [671](#L671) | \* post cpt: [order] => null(desc) [orderby] => null(date) |
| [672](#L672) | \* page: [order] => asc [orderby] => menu\_order title |
| [673](#L673) | \* |
| [674](#L674) | \*/ |
| [675](#L675) |  |
| [676](#L676) | if ( is\_admin() ) { |
| [677](#L677) |  |
| [678](#L678) | // adminの場合 $wp\_query->query['post\_type']=post も渡される |
| [679](#L679) | if ( isset( $wp\_query->query['post\_type'] ) && !isset( $\_GET['orderby'] ) ) { |
| [680](#L680) | if ( in\_array( $wp\_query->query['post\_type'], $objects ) ) { |
| [681](#L681) | $wp\_query->set( 'orderby', 'menu\_order' ); |
| [682](#L682) | $wp\_query->set( 'order', 'ASC' ); |
| [683](#L683) | } |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) | /\*\* |
| [687](#L687) | \* for Front End |
| [688](#L688) | \*/ |
| [689](#L689) |  |
| [690](#L690) | } else { |
| [691](#L691) |  |
| [692](#L692) | $active = false; |
| [693](#L693) |  |
| [694](#L694) | // page or custom post types |
| [695](#L695) | if ( isset( $wp\_query->query['post\_type'] ) ) { |
| [696](#L696) | // exclude array() |
| [697](#L697) | if ( !is\_array( $wp\_query->query['post\_type'] ) ) { |
| [698](#L698) | if ( in\_array( $wp\_query->query['post\_type'], $objects ) ) { |
| [699](#L699) | $active = true; |
| [700](#L700) | } |
| [701](#L701) | } |
| [702](#L702) | // post |
| [703](#L703) | } else { |
| [704](#L704) | if ( in\_array( 'post', $objects ) ) { |
| [705](#L705) | $active = true; |
| [706](#L706) | } |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | if ( !$active ) return false; |
| [710](#L710) |  |
| [711](#L711) | // get\_posts() |
| [712](#L712) | if ( isset( $wp\_query->query['suppress\_filters'] ) ) { |
| [713](#L713) | if ( $wp\_query->get( 'orderby' ) == 'date' || $wp\_query->get( 'orderby' ) == 'menu\_order' ) { |
| [714](#L714) | $wp\_query->set( 'orderby', 'menu\_order' ); |
| [715](#L715) | $wp\_query->set( 'order', 'ASC' ); |
| [716](#L716) | } elseif($wp\_query->get( 'orderby' ) == 'default\_date') { |
| [717](#L717) | $wp\_query->set( 'orderby', 'date' ); |
| [718](#L718) | } |
| [719](#L719) | // WP\_Query( contain main\_query ) |
| [720](#L720) | } else { |
| [721](#L721) | if ( !$wp\_query->get( 'orderby' ) )  $wp\_query->set( 'orderby', 'menu\_order' ); |
| [722](#L722) | if ( !$wp\_query->get( 'order' ) ) $wp\_query->set( 'order', 'ASC' ); |
| [723](#L723) | } |
| [724](#L724) | } |
| [725](#L725) | } |
| [726](#L726) |  |
| [727](#L727) | function hicpo\_get\_terms\_orderby( $orderby, $args ) |
| [728](#L728) | { |
| [729](#L729) | if ( is\_admin() ) return $orderby; |
| [730](#L730) |  |
| [731](#L731) | $tags = $this->get\_hicpo\_options\_tags(); |
| [732](#L732) |  |
| [733](#L733) | if( !isset( $args['taxonomy'] ) ) return $orderby; |
| [734](#L734) |  |
| [735](#L735) | $taxonomy = $args['taxonomy']; |
| [736](#L736) | if ( !in\_array( $taxonomy, $tags ) ) return $orderby; |
| [737](#L737) |  |
| [738](#L738) | $orderby = 't.term\_order'; |
| [739](#L739) | return $orderby; |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | function hicpo\_get\_object\_terms( $terms ) |
| [743](#L743) | { |
| [744](#L744) | $tags = $this->get\_hicpo\_options\_tags(); |
| [745](#L745) |  |
| [746](#L746) | if ( is\_admin() && isset( $\_GET['orderby'] ) ) return $terms; |
| [747](#L747) |  |
| [748](#L748) | foreach( $terms as $key => $term ) { |
| [749](#L749) | if ( is\_object( $term ) && isset( $term->taxonomy ) ) { |
| [750](#L750) | $taxonomy = $term->taxonomy; |
| [751](#L751) | if ( !in\_array( $taxonomy, $tags ) ) return $terms; |
| [752](#L752) | } else { |
| [753](#L753) | return $terms; |
| [754](#L754) | } |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | usort( $terms, array( $this, 'taxcmp' ) ); |
| [758](#L758) | return $terms; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | function taxcmp( $a, $b ) |
| [762](#L762) | { |
| [763](#L763) | if ( $a->term\_order ==  $b->term\_order ) return 0; |
| [764](#L764) | return ( $a->term\_order < $b->term\_order ) ? -1 : 1; |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | function hicpo\_sites\_clauses( $pieces = array() ) |
| [768](#L768) | { |
| [769](#L769) | global $blog\_id; |
| [770](#L770) |  |
| [771](#L771) | if ( is\_admin() ) return $pieces; |
| [772](#L772) | if ( 1 != $blog\_id ) { |
| [773](#L773) | $current = $blog\_id; |
| [774](#L774) | switch\_to\_blog(1); |
| [775](#L775) | $hicpo\_network\_sites = get\_option( 'hicpo\_network\_sites' ); |
| [776](#L776) | switch\_to\_blog($current); |
| [777](#L777) | if ( !$hicpo\_network\_sites ) return $pieces; |
| [778](#L778) | } else { |
| [779](#L779) | if ( !get\_option( 'hicpo\_network\_sites' ) ) return $pieces; |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | global $wp\_version; |
| [783](#L783) | if ( version\_compare( $wp\_version, '4.6.0' ) >= 0 ) { |
| [784](#L784) | // サイト並び替え指定がデフォルトの場合のみ並び替え |
| [785](#L785) | if( 'blog\_id ASC' === $pieces['orderby'] ) { |
| [786](#L786) | $pieces['orderby'] = 'menu\_order ASC'; |
| [787](#L787) | } |
| [788](#L788) | } |
| [789](#L789) | return $pieces; |
| [790](#L790) | } |
| [791](#L791) |  |
| [792](#L792) | function hicpo\_get\_blogs\_of\_user( $blogs ) |
| [793](#L793) | { |
| [794](#L794) | global $blog\_id; |
| [795](#L795) | if ( 1 != $blog\_id ) { |
| [796](#L796) | $current = $blog\_id; |
| [797](#L797) | switch\_to\_blog(1); |
| [798](#L798) | $hicpo\_network\_sites = get\_option( 'hicpo\_network\_sites' ); |
| [799](#L799) | switch\_to\_blog($current); |
| [800](#L800) | if ( !$hicpo\_network\_sites ) return $blogs; |
| [801](#L801) | } else { |
| [802](#L802) | if ( !get\_option( 'hicpo\_network\_sites' ) ) return $blogs; |
| [803](#L803) | } |
| [804](#L804) | global $wpdb, $wp\_version; |
| [805](#L805) |  |
| [806](#L806) | if ( version\_compare( $wp\_version, '4.6.0' ) >= 0 ) { |
| [807](#L807) | $sites = get\_sites( array() ); |
| [808](#L808) | $sort\_keys = array(); |
| [809](#L809) | foreach( $sites as $k => $v ) { |
| [810](#L810) | $sort\_keys[] = $v->menu\_order; |
| [811](#L811) | } |
| [812](#L812) | array\_multisort( $sort\_keys, SORT\_ASC, $sites ); |
| [813](#L813) |  |
| [814](#L814) | $blog\_list = array(); |
| [815](#L815) | foreach( $blogs as $k => $v ) { |
| [816](#L816) | $blog\_list[$v->userblog\_id] = $v; |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | $new = array(); |
| [820](#L820) | foreach( $sites as $k => $v ) { |
| [821](#L821) | if ( isset($v->blog\_id) && |
| [822](#L822) | isset($blog\_list[$v->blog\_id]) && |
| [823](#L823) | is\_object( $blog\_list[$v->blog\_id] ) ) { |
| [824](#L824) | $new[] = $blog\_list[$v->blog\_id]; |
| [825](#L825) | } |
| [826](#L826) | } |
| [827](#L827) | } else { |
| [828](#L828) | $sites = wp\_get\_sites( array( 'limit' => 9999 ) ); |
| [829](#L829) | $sort\_keys = array(); |
| [830](#L830) | foreach( $sites as $k => $v ) { |
| [831](#L831) | $sort\_keys[] = $v['menu\_order']; |
| [832](#L832) | } |
| [833](#L833) | array\_multisort( $sort\_keys, SORT\_ASC, $sites ); |
| [834](#L834) |  |
| [835](#L835) | $blog\_list = array(); |
| [836](#L836) | foreach( $blogs as $k => $v ) { |
| [837](#L837) | $blog\_list[$v->userblog\_id] = $v; |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | $new = array(); |
| [841](#L841) | foreach( $sites as $k => $v ) { |
| [842](#L842) | if ( isset($v['blog\_id']) && |
| [843](#L843) | isset($blog\_list[$v['blog\_id']]) && |
| [844](#L844) | is\_object( $blog\_list[$v['blog\_id']] ) ) { |
| [845](#L845) | $new[] = $blog\_list[$v['blog\_id']]; |
| [846](#L846) | } |
| [847](#L847) | } |
| [848](#L848) | } |
| [849](#L849) | return $new; |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | /\* before wp v4.6.0 \*/ |
| [853](#L853) | function refresh\_front\_network() |
| [854](#L854) | { |
| [855](#L855) | global $wp\_version; |
| [856](#L856) | if ( version\_compare( $wp\_version, '4.6.0' ) < 0 ) { |
| [857](#L857) | global $blog\_id; |
| [858](#L858) | if ( 1 != $blog\_id ) { |
| [859](#L859) | $current = $blog\_id; |
| [860](#L860) | switch\_to\_blog(1); |
| [861](#L861) | $hicpo\_network\_sites = get\_option( 'hicpo\_network\_sites' ); |
| [862](#L862) | switch\_to\_blog($current); |
| [863](#L863) | if ( !$hicpo\_network\_sites ) return; |
| [864](#L864) | } else { |
| [865](#L865) | if ( !get\_option( 'hicpo\_network\_sites' ) ) return; |
| [866](#L866) | } |
| [867](#L867) | add\_filter( 'query', array( $this, 'refresh\_front\_network\_2' ) ); |
| [868](#L868) | } |
| [869](#L869) | } |
| [870](#L870) | function refresh\_front\_network\_2( $query ) |
| [871](#L871) | { |
| [872](#L872) | global $wpdb; |
| [873](#L873) | if ( false !== strpos( $query, "SELECT  blog\_id FROM $wpdb->blogs    ORDER BY blog\_id ASC" ) ) { |
| [874](#L874) | $query = str\_replace( 'ORDER BY blog\_id ASC', '', $query ); |
| [875](#L875) | if ( false !== strpos( $query, " LIMIT " ) ) { |
| [876](#L876) | $query = preg\_replace( '/^(.\*) LIMIT(.\*)$/', '$1 ORDER BY menu\_order ASC LIMIT $2', $query ); |
| [877](#L877) | } else { |
| [878](#L878) | $query .= " ORDER BY menu\_order ASC"; |
| [879](#L879) | } |
| [880](#L880) | } elseif ( false !== strpos( $query, "SELECT \* FROM $wpdb->blogs WHERE 1=1 AND site\_id IN (1)" ) ) { |
| [881](#L881) | if ( false !== strpos( $query, " LIMIT " ) ) { |
| [882](#L882) | $query = preg\_replace( '/^(.\*) LIMIT(.\*)$/', '$1 ORDER BY menu\_order ASC LIMIT $2', $query ); |
| [883](#L883) | } else { |
| [884](#L884) | $query .= " ORDER BY menu\_order ASC"; |
| [885](#L885) | } |
| [886](#L886) | } |
| [887](#L887) | return $query; |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) | function get\_hicpo\_options\_objects() |
| [891](#L891) | { |
| [892](#L892) | $hicpo\_options = get\_option( 'hicpo\_options' ) ? get\_option( 'hicpo\_options' ) : array(); |
| [893](#L893) | $objects = isset( $hicpo\_options['objects'] ) && is\_array( $hicpo\_options['objects'] ) ? $hicpo\_options['objects'] : array(); |
| [894](#L894) | return $objects; |
| [895](#L895) | } |
| [896](#L896) | function get\_hicpo\_options\_tags() |
| [897](#L897) | { |
| [898](#L898) | $hicpo\_options = get\_option( 'hicpo\_options' ) ? get\_option( 'hicpo\_options' ) : array(); |
| [899](#L899) | $tags = isset( $hicpo\_options['tags'] ) && is\_array( $hicpo\_options['tags'] ) ? $hicpo\_options['tags'] : array(); |
| [900](#L900) | return $tags; |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php?rev=2530122&format=txt)
* [Original Format](/export/2530122/intuitive-custom-post-order/trunk/intuitive-custom-post-order.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


