=== Content from plugins.trac.wordpress.org_f3931c58_20250115_082829.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2893158%2Fwp-fastest-cache%2Ftrunk%2FwpFastestCache.php%3Fcontextall%3D1)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2886944/wp-fastest-cache/trunk/wpFastestCache.php "Changeset 2886944 for wp-fastest-cache/trunk/wpFastestCache.php")
* [Next Change](/changeset/2895483/wp-fastest-cache/trunk/wpFastestCache.php "Changeset 2895483 for wp-fastest-cache/trunk/wpFastestCache.php") →

---

# Changeset [2893158](/changeset/2893158 "Show full changeset") for [wp-fastest-cache/trunk/wpFastestCache.php](/browser/wp-fastest-cache/trunk/wpFastestCache.php?rev=2893158 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
04/03/2023 10:53:10 PM
([22 months](/timeline?from=2023-04-03T22%3A53%3A10Z&precision=second "See timeline at 04/03/2023 10:53:10 PM") ago)

Author:
emrevona
Message:

to add securtiy checking for deleteCacheToolbar deleteCssAndJsCacheToolbar wpfc\_clear\_cache\_of\_allsites\_callback wpfc\_toolbar\_save\_settings\_callback wpfc\_remove\_cdn\_integration\_ajax\_request\_callback wpfc\_pause\_cdn\_integration\_ajax\_request\_callback wpfc\_start\_cdn\_integration\_ajax\_request\_callback wpfc\_save\_cdn\_integration\_ajax\_request\_callback wpfc\_db\_statics\_callback wpfc\_purgecache\_varnish\_callback wpfc\_preload\_single\_save\_settings\_callback wpfc\_preload\_single\_callback

File:

1 edited

* [wp-fastest-cache/trunk/wpFastestCache.php](/browser/wp-fastest-cache/trunk/wpFastestCache.php?rev=2893158 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-fastest-cache/trunk/wpFastestCache.php](/changeset/2893158/wp-fastest-cache/trunk/wpFastestCache.php "Show the changeset 2893158 restricted to wp-fastest-cache/trunk/wpFastestCache.php")

  | [r2886944](/browser/wp-fastest-cache/trunk/wpFastestCache.php?rev=2886944#L1 "Show revision 2886944 of this file in browser") | [r2893158](/browser/wp-fastest-cache/trunk/wpFastestCache.php?rev=2893158#L1 "Show revision 2893158 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | /\* |
  | 3 | 3 | Plugin Name: WP Fastest Cache |
  | 4 | 4 | Plugin URI: http://wordpress.org/plugins/wp-fastest-cache/ |
  | 5 | 5 | Description: The simplest and fastest WP Cache system |
  | 6 | 6 | Version: 1.1.2 |
  | 7 | 7 | Author: Emre Vona |
  | 8 | 8 | Author URI: https://www.wpfastestcache.com/ |
  | 9 | 9 | Text Domain: wp-fastest-cache |
  | 10 | 10 | Domain Path: /languages/ |
  | 11 | 11 |  |
  | 12 | 12 | Copyright (C)2013 Emre Vona |
  | 13 | 13 |  |
  | 14 | 14 | This program is free software; you can redistribute it and/or |
  | 15 | 15 | modify it under the terms of the GNU General Public License |
  | 16 | 16 | as published by the Free Software Foundation; either version 2 |
  | 17 | 17 | of the License, or (at your option) any later version. |
  | 18 | 18 |  |
  | 19 | 19 | This program is distributed in the hope that it will be useful, |
  | 20 | 20 | but WITHOUT ANY WARRANTY; without even the implied warranty of |
  | 21 | 21 | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the |
  | 22 | 22 | GNU General Public License for more details. |
  | 23 | 23 | \*/ |
  | 24 | 24 |  |
  | 25 | 25 | if (!defined('WPFC\_WP\_CONTENT\_BASENAME')) { |
  | 26 | 26 | if (!defined('WPFC\_WP\_PLUGIN\_DIR')) { |
  | 27 | 27 | if(preg\_match("/(\/trunk\/|\/wp-fastest-cache\/)$/", plugin\_dir\_path( \_\_FILE\_\_ ))){ |
  | 28 | 28 | define("WPFC\_WP\_PLUGIN\_DIR", preg\_replace("/(\/trunk\/|\/wp-fastest-cache\/)$/", "", plugin\_dir\_path( \_\_FILE\_\_ ))); |
  | 29 | 29 | }else if(preg\_match("/\\\wp-fastest-cache\/$/", plugin\_dir\_path( \_\_FILE\_\_ ))){ |
  | 30 | 30 | //D:\hosting\LINEapp\public\_html\wp-content\plugins\wp-fastest-cache/ |
  | 31 | 31 | define("WPFC\_WP\_PLUGIN\_DIR", preg\_replace("/\\\wp-fastest-cache\/$/", "", plugin\_dir\_path( \_\_FILE\_\_ ))); |
  | 32 | 32 | } |
  | 33 | 33 | } |
  | 34 | 34 | define("WPFC\_WP\_CONTENT\_DIR", dirname(WPFC\_WP\_PLUGIN\_DIR)); |
  | 35 | 35 | define("WPFC\_WP\_CONTENT\_BASENAME", basename(WPFC\_WP\_CONTENT\_DIR)); |
  | 36 | 36 | } |
  | 37 | 37 |  |
  | 38 | 38 | if (!defined('WPFC\_MAIN\_PATH')) { |
  | 39 | 39 | define("WPFC\_MAIN\_PATH", plugin\_dir\_path( \_\_FILE\_\_ )); |
  | 40 | 40 | } |
  | 41 | 41 |  |
  | 42 | 42 | if(!isset($GLOBALS["wp\_fastest\_cache\_options"])){ |
  | 43 | 43 | if($wp\_fastest\_cache\_options = get\_option("WpFastestCache")){ |
  | 44 | 44 | $GLOBALS["wp\_fastest\_cache\_options"] = json\_decode($wp\_fastest\_cache\_options); |
  | 45 | 45 | }else{ |
  | 46 | 46 | $GLOBALS["wp\_fastest\_cache\_options"] = array(); |
  | 47 | 47 | } |
  | 48 | 48 | } |
  | 49 | 49 |  |
  | 50 | 50 | function wpfastestcache\_activate(){ |
  | 51 | 51 | if($options = get\_option("WpFastestCache")){ |
  | 52 | 52 | $post = json\_decode($options, true); |
  | 53 | 53 |  |
  | 54 | 54 | include\_once('inc/admin.php'); |
  | 55 | 55 | $wpfc = new WpFastestCacheAdmin(); |
  | 56 | 56 | $wpfc->modifyHtaccess($post); |
  | 57 | 57 | } |
  | 58 | 58 | } |
  | 59 | 59 |  |
  | 60 | 60 | function wpfastestcache\_deactivate(){ |
  | 61 | 61 | $wpfc = new WpFastestCache(); |
  | 62 | 62 |  |
  | 63 | 63 | $path = ABSPATH; |
  | 64 | 64 |  |
  | 65 | 65 | if($wpfc->is\_subdirectory\_install()){ |
  | 66 | 66 | $path = $wpfc->getABSPATH(); |
  | 67 | 67 | } |
  | 68 | 68 |  |
  | 69 | 69 | if(is\_file($path.".htaccess") && is\_writable($path.".htaccess")){ |
  | 70 | 70 | $htaccess = file\_get\_contents($path.".htaccess"); |
  | 71 | 71 | $htaccess = preg\_replace("/#\s?BEGIN\s?WpFastestCache.\*?#\s?END\s?WpFastestCache/s", "", $htaccess); |
  | 72 | 72 | $htaccess = preg\_replace("/#\s?BEGIN\s?GzipWpFastestCache.\*?#\s?END\s?GzipWpFastestCache/s", "", $htaccess); |
  | 73 | 73 | $htaccess = preg\_replace("/#\s?BEGIN\s?LBCWpFastestCache.\*?#\s?END\s?LBCWpFastestCache/s", "", $htaccess); |
  | 74 | 74 | $htaccess = preg\_replace("/#\s?BEGIN\s?WEBPWpFastestCache.\*?#\s?END\s?WEBPWpFastestCache/s", "", $htaccess); |
  | 75 | 75 | @file\_put\_contents($path.".htaccess", $htaccess); |
  | 76 | 76 | } |
  | 77 | 77 |  |
  | 78 | 78 | $wpfc->deleteCache(); |
  | 79 | 79 | } |
  | 80 | 80 |  |
  | 81 | 81 | register\_activation\_hook( \_\_FILE\_\_, "wpfastestcache\_activate"); |
  | 82 | 82 | register\_deactivation\_hook( \_\_FILE\_\_, "wpfastestcache\_deactivate"); |
  | 83 | 83 |  |
  | 84 | 84 | class WpFastestCache{ |
  | 85 | 85 | private $systemMessage = ""; |
  | 86 | 86 | private $options = array(); |
  | 87 | 87 | public $noscript = ""; |
  | 88 | 88 | public $content\_url = ""; |
  | 89 | 89 | public $deleted\_before = false; |
  | 90 | 90 |  |
  | 91 | 91 | public function \_\_construct(){ |
  | 92 | 92 | $this->set\_content\_url(); |
  | 93 | 93 |  |
  | 94 | 94 | $optimize\_image\_ajax\_requests = array("wpfc\_revert\_image\_ajax\_request", |
  | 95 | 95 | "wpfc\_statics\_ajax\_request", |
  | 96 | 96 | "wpfc\_optimize\_image\_ajax\_request", |
  | 97 | 97 | "wpfc\_update\_image\_list\_ajax\_request" |
  | 98 | 98 | ); |
  | 99 | 99 |  |
  | 100 | 100 | add\_action('wp\_ajax\_wpfc\_delete\_cache', array($this, "deleteCacheToolbar")); |
  | 101 | 101 | add\_action('wp\_ajax\_wpfc\_delete\_cache\_and\_minified', array($this, "deleteCssAndJsCacheToolbar")); |
  | 102 | 102 | add\_action('wp\_ajax\_wpfc\_delete\_current\_page\_cache', array($this, "delete\_current\_page\_cache")); |
  | 103 | 103 |  |
  | 104 | 104 | add\_action('wp\_ajax\_wpfc\_clear\_cache\_of\_allsites', array($this, "wpfc\_clear\_cache\_of\_allsites\_callback")); |
  | 105 | 105 |  |
  | 106 | 106 | add\_action('wp\_ajax\_wpfc\_toolbar\_save\_settings', array($this, "wpfc\_toolbar\_save\_settings\_callback")); |
  | 107 | 107 | add\_action('wp\_ajax\_wpfc\_toolbar\_get\_settings', array($this, "wpfc\_toolbar\_get\_settings\_callback")); |
  | 108 | 108 |  |
  | 109 | 109 | //add\_action('wp\_ajax\_wpfc\_cache\_path\_save\_settings', array($this, "wpfc\_cache\_path\_save\_settings\_callback")); |
  | 110 | 110 |  |
  | 111 | 111 | add\_action( 'wp\_ajax\_wpfc\_save\_timeout\_pages', array($this, 'wpfc\_save\_timeout\_pages\_callback')); |
  | 112 | 112 | add\_action( 'wp\_ajax\_wpfc\_save\_exclude\_pages', array($this, 'wpfc\_save\_exclude\_pages\_callback')); |
  | 113 | 113 | add\_action( 'wp\_ajax\_wpfc\_cdn\_options', array($this, 'wpfc\_cdn\_options\_ajax\_request\_callback')); |
  | 114 | 114 | add\_action( 'wp\_ajax\_wpfc\_remove\_cdn\_integration', array($this, 'wpfc\_remove\_cdn\_integration\_ajax\_request\_callback')); |
  | 115 | 115 | add\_action( 'wp\_ajax\_wpfc\_pause\_cdn\_integration', array($this, 'wpfc\_pause\_cdn\_integration\_ajax\_request\_callback')); |
  | 116 | 116 | add\_action( 'wp\_ajax\_wpfc\_start\_cdn\_integration', array($this, 'wpfc\_start\_cdn\_integration\_ajax\_request\_callback')); |
  | 117 | 117 | add\_action( 'wp\_ajax\_wpfc\_save\_cdn\_integration', array($this, 'wpfc\_save\_cdn\_integration\_ajax\_request\_callback')); |
  | 118 | 118 | add\_action( 'wp\_ajax\_wpfc\_cdn\_template', array($this, 'wpfc\_cdn\_template\_ajax\_request\_callback')); |
  | 119 | 119 | add\_action( 'wp\_ajax\_wpfc\_check\_url', array($this, 'wpfc\_check\_url\_ajax\_request\_callback')); |
  | 120 | 120 | add\_action( 'wp\_ajax\_wpfc\_cache\_statics\_get', array($this, 'wpfc\_cache\_statics\_get\_callback')); |
  | 121 | 121 | add\_action( 'wp\_ajax\_wpfc\_db\_statics', array($this, 'wpfc\_db\_statics\_callback')); |
  | 122 | 122 | add\_action( 'wp\_ajax\_wpfc\_db\_fix', array($this, 'wpfc\_db\_fix\_callback')); |
  | 123 | 123 | add\_action( 'rate\_post', array($this, 'wp\_postratings\_clear\_fastest\_cache'), 10, 2); |
  | 124 | 124 | add\_action( 'user\_register', array($this, 'modify\_htaccess\_for\_new\_user'), 10, 1); |
  | 125 | 125 | add\_action( 'profile\_update', array($this, 'modify\_htaccess\_for\_new\_user'), 10, 1); |
  | 126 | 126 | add\_action( 'edit\_terms', array($this, 'delete\_cache\_of\_term'), 10, 1); |
  | 127 | 127 |  |
  | 128 | 128 | add\_action( 'wp\_ajax\_wpfc\_save\_csp', array($this, 'wpfc\_save\_csp\_callback')); |
  | 129 | 129 | add\_action( 'wp\_ajax\_wpfc\_remove\_csp', array($this, 'wpfc\_remove\_csp\_callback')); |
  | 130 | 130 | add\_action( 'wp\_ajax\_wpfc\_get\_list\_csp', array($this, 'wpfc\_get\_list\_csp\_callback')); |
  | 131 | 131 |  |
  | 132 | 132 |  |
  | 133 | 133 | add\_action( 'wp\_ajax\_wpfc\_save\_varnish', array($this, 'wpfc\_save\_varnish\_callback')); |
  | 134 | 134 | add\_action( 'wp\_ajax\_wpfc\_remove\_varnish', array($this, 'wpfc\_remove\_varnish\_callback')); |
  | 135 | 135 | add\_action( 'wp\_ajax\_wpfc\_pause\_varnish', array($this, 'wpfc\_pause\_varnish\_callback')); |
  | 136 | 136 | add\_action( 'wp\_ajax\_wpfc\_start\_varnish', array($this, 'wpfc\_start\_varnish\_callback')); |
  | 137 | 137 | add\_action( 'wp\_ajax\_wpfc\_purgecache\_varnish', array($this, 'wpfc\_purgecache\_varnish\_callback')); |
  | 138 | 138 |  |
  | 139 | 139 |  |
  | 140 | 140 | if(defined("WPFC\_CLEAR\_CACHE\_AFTER\_SWITCH\_THEME") && WPFC\_CLEAR\_CACHE\_AFTER\_SWITCH\_THEME){ |
  | 141 | 141 | add\_action('after\_switch\_theme', array($this, 'clear\_cache\_after\_switch\_theme')); |
  | 142 | 142 | } |
  | 143 | 143 |  |
  | 144 | 144 | if(defined("WPFC\_CLEAR\_CACHE\_AFTER\_ACTIVATE\_DEACTIVATE\_PLUGIN") && WPFC\_CLEAR\_CACHE\_AFTER\_ACTIVATE\_DEACTIVATE\_PLUGIN){ |
  | 145 | 145 | add\_action('activate\_plugin', array($this, 'clear\_cache\_after\_activate\_plugin')); |
  | 146 | 146 | add\_action('deactivate\_plugin', array($this, 'clear\_cache\_after\_deactivate\_plugin')); |
  | 147 | 147 | } |
  | 148 | 148 |  |
  | 149 | 149 |  |
  | 150 | 150 | add\_action('upgrader\_process\_complete', array($this, 'clear\_cache\_after\_update\_plugin'), 10, 2); |
  | 151 | 151 | add\_action('upgrader\_process\_complete', array($this, 'clear\_cache\_after\_update\_theme'), 10, 2); |
  | 152 | 152 |  |
  | 153 | 153 |  |
  | 154 | 154 | if(defined("WPFC\_DISABLE\_CLEARING\_CACHE\_AFTER\_WOOCOMMERCE\_CHECKOUT\_ORDER\_PROCESSED") && WPFC\_DISABLE\_CLEARING\_CACHE\_AFTER\_WOOCOMMERCE\_CHECKOUT\_ORDER\_PROCESSED){ |
  | 155 | 155 | }else if(defined("WPFC\_DISABLE\_CLEARING\_CACHE\_AFTER\_WOOCOMMERCE\_ORDER\_STATUS\_CHANGED") && WPFC\_DISABLE\_CLEARING\_CACHE\_AFTER\_WOOCOMMERCE\_ORDER\_STATUS\_CHANGED){ |
  | 156 | 156 | }else{ |
  | 157 | 157 | // to clear cache after new Woocommerce orders |
  | 158 | 158 | add\_action('woocommerce\_order\_status\_changed', array($this, 'clear\_cache\_after\_woocommerce\_order\_status\_changed'), 1, 1); |
  | 159 | 159 | } |
  | 160 | 160 |  |
  | 161 | 161 |  |
  | 162 | 162 | // kk Star Ratings: to clear the cache of the post after voting |
  | 163 | 163 | add\_action('kksr\_rate', array($this, 'clear\_cache\_on\_kksr\_rate')); |
  | 164 | 164 |  |
  | 165 | 165 | // Elementor: to clear cache after Maintenance Mode activation/deactivation |
  | 166 | 166 | add\_action('elementor/maintenance\_mode/mode\_changed', array($this, 'deleteCache')); |
  | 167 | 167 |  |
  | 168 | 168 | // clearing cache hooks |
  | 169 | 169 | add\_action("wpfc\_clear\_all\_cache", array($this, 'deleteCache'), 10, 1); |
  | 170 | 170 | add\_action("wpfc\_clear\_all\_site\_cache", array($this, 'wpfc\_clear\_cache\_of\_allsites\_callback')); |
  | 171 | 171 | add\_action("wpfc\_clear\_post\_cache\_by\_id", array($this, 'singleDeleteCache'), 10, 2); |
  | 172 | 172 |  |
  | 173 | 173 | // to enable Auto Cache Panel for the classic editor |
  | 174 | 174 | add\_action( 'admin\_init', array($this, 'enable\_auto\_cache\_settings\_panel')); |
  | 175 | 175 |  |
  | 176 | 176 | // to add settings link |
  | 177 | 177 | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( \_\_FILE\_\_ ), array($this, 'action\_links')); |
  | 178 | 178 |  |
  | 179 | 179 | // to clear cache after ajax request by other plugins |
  | 180 | 180 | if(isset($\_POST["action"])){ |
  | 181 | 181 | // All In One Schema.org Rich Snippets |
  | 182 | 182 | if(preg\_match("/bsf\_(update|submit)\_rating/i", $\_POST["action"])){ |
  | 183 | 183 | if(isset($\_POST["post\_id"])){ |
  | 184 | 184 | $this->singleDeleteCache(false, $\_POST["post\_id"]); |
  | 185 | 185 | } |
  | 186 | 186 | } |
  | 187 | 187 |  |
  | 188 | 188 | // Yet Another Stars Rating |
  | 189 | 189 | if($\_POST["action"] == "yasr\_send\_visitor\_rating"){ |
  | 190 | 190 | if(isset($\_POST["post\_id"])){ |
  | 191 | 191 | // to need call like that because get\_permalink() does not work if we call singleDeleteCache() directly |
  | 192 | 192 | add\_action('init', array($this, "singleDeleteCache")); |
  | 193 | 193 | } |
  | 194 | 194 | } |
  | 195 | 195 | } |
  | 196 | 196 |  |
  | 197 | 197 | // to clear /tmpWpfc folder |
  | 198 | 198 | if(is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 199 | 199 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/tmpWpfc")); |
  | 200 | 200 | } |
  | 201 | 201 |  |
  | 202 | 202 |  |
  | 203 | 203 | if($this->isPluginActive('wp-polls/wp-polls.php')){ |
  | 204 | 204 | //for WP-Polls |
  | 205 | 205 | require\_once "inc/wp-polls.php"; |
  | 206 | 206 | $wp\_polls = new WpPollsForWpFc(); |
  | 207 | 207 | $wp\_polls->hook(); |
  | 208 | 208 | } |
  | 209 | 209 |  |
  | 210 | 210 | if(isset($\_GET) && isset($\_GET["action"]) && in\_array($\_GET["action"], $optimize\_image\_ajax\_requests)){ |
  | 211 | 211 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 212 | 212 | include\_once $this->get\_premium\_path("image.php"); |
  | 213 | 213 | $img = new WpFastestCacheImageOptimisation(); |
  | 214 | 214 | $img->hook(); |
  | 215 | 215 | } |
  | 216 | 216 | }else if(isset($\_GET) && isset($\_GET["action"])  && $\_GET["action"] == "wpfastestcache"){ |
  | 217 | 217 | if(isset($\_GET) && isset($\_GET["type"])  && $\_GET["type"] == "preload"){ |
  | 218 | 218 | // /?action=wpfastestcache&type=preload |
  | 219 | 219 |  |
  | 220 | 220 | add\_action('init', array($this, "create\_preload\_cache"), 11); |
  | 221 | 221 | } |
  | 222 | 222 |  |
  | 223 | 223 | if(isset($\_GET) && isset($\_GET["type"]) && preg\_match("/^clearcache(andminified|allsites)\*$/i", $\_GET["type"])){ |
  | 224 | 224 | // /?action=wpfastestcache&type=clearcache&token=123 |
  | 225 | 225 | // /?action=wpfastestcache&type=clearcacheandminified&token=123 |
  | 226 | 226 |  |
  | 227 | 227 | if(isset($\_GET["token"]) && $\_GET["token"]){ |
  | 228 | 228 | if(defined("WPFC\_CLEAR\_CACHE\_URL\_TOKEN") && WPFC\_CLEAR\_CACHE\_URL\_TOKEN){ |
  | 229 | 229 | if(WPFC\_CLEAR\_CACHE\_URL\_TOKEN == $\_GET["token"]){ |
  | 230 | 230 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 231 | 231 | include\_once $this->get\_premium\_path("mobile-cache.php"); |
  | 232 | 232 | } |
  | 233 | 233 |  |
  | 234 | 234 | if($\_GET["type"] == "clearcache"){ |
  | 235 | 235 | $this->deleteCache(); |
  | 236 | 236 | } |
  | 237 | 237 |  |
  | 238 | 238 | if($\_GET["type"] == "clearcacheandminified"){ |
  | 239 | 239 | $this->deleteCache(true); |
  | 240 | 240 | } |
  | 241 | 241 |  |
  | 242 | 242 | if($\_GET["type"] == "clearcacheallsites"){ |
  | 243 | 243 | $this->wpfc\_clear\_cache\_of\_allsites\_callback(); |
  | 244 | 244 | } |
  | 245 | 245 |  |
  | 246 | 246 | die("Done"); |
  | 247 | 247 | }else{ |
  | 248 | 248 | die("Wrong token"); |
  | 249 | 249 | } |
  | 250 | 250 | }else{ |
  | 251 | 251 | die("WPFC\_CLEAR\_CACHE\_URL\_TOKEN must be defined"); |
  | 252 | 252 | } |
  | 253 | 253 | }else{ |
  | 254 | 254 | die("Security token must be set."); |
  | 255 | 255 | } |
  | 256 | 256 | } |
  | 257 | 257 | }else{ |
  | 258 | 258 | $this->setCustomInterval(); |
  | 259 | 259 |  |
  | 260 | 260 | $this->options = $this->getOptions(); |
  | 261 | 261 |  |
  | 262 | 262 | add\_action('transition\_post\_status',  array($this, 'on\_all\_status\_transitions'), 10, 3 ); |
  | 263 | 263 |  |
  | 264 | 264 | // when the regular price is updated, the "transition\_post\_status" action cannot catch it |
  | 265 | 265 | add\_action('woocommerce\_update\_product',  array($this, 'clear\_cache\_after\_woocommerce\_update\_product'), 10, 1); |
  | 266 | 266 |  |
  | 267 | 267 | $this->commentHooks(); |
  | 268 | 268 |  |
  | 269 | 269 | $this->checkCronTime(); |
  | 270 | 270 |  |
  | 271 | 271 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 272 | 272 | include\_once $this->get\_premium\_path("mobile-cache.php"); |
  | 273 | 273 |  |
  | 274 | 274 | if(file\_exists(WPFC\_WP\_PLUGIN\_DIR."/wp-fastest-cache-premium/pro/library/statics.php")){ |
  | 275 | 275 | include\_once $this->get\_premium\_path("statics.php"); |
  | 276 | 276 | } |
  | 277 | 277 |  |
  | 278 | 278 | if(!defined('DOING\_AJAX')){ |
  | 279 | 279 | include\_once $this->get\_premium\_path("powerful-html.php"); |
  | 280 | 280 | } |
  | 281 | 281 | } |
  | 282 | 282 |  |
  | 283 | 283 | if(is\_admin()){ |
  | 284 | 284 | add\_action('wp\_loaded', array($this, "load\_column")); |
  | 285 | 285 |  |
  | 286 | 286 | if(defined('DOING\_AJAX') && DOING\_AJAX){ |
  | 287 | 287 | //do nothing |
  | 288 | 288 | }else{ |
  | 289 | 289 | // to avoid loading menu and optionPage() twice |
  | 290 | 290 | if(!class\_exists("WpFastestCacheAdmin")){ |
  | 291 | 291 | //for wp-panel |
  | 292 | 292 |  |
  | 293 | 293 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 294 | 294 | include\_once $this->get\_premium\_path("image.php"); |
  | 295 | 295 | } |
  | 296 | 296 |  |
  | 297 | 297 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 298 | 298 | include\_once $this->get\_premium\_path("logs.php"); |
  | 299 | 299 | } |
  | 300 | 300 |  |
  | 301 | 301 | add\_action('plugins\_loaded', array($this, 'wpfc\_load\_plugin\_textdomain')); |
  | 302 | 302 | add\_action('wp\_loaded', array($this, "load\_admin\_toolbar")); |
  | 303 | 303 |  |
  | 304 | 304 | $this->admin(); |
  | 305 | 305 | } |
  | 306 | 306 | } |
  | 307 | 307 | }else{ |
  | 308 | 308 | if(preg\_match("/\/([^\/]+)\/([^\/]+(\.css|\.js))(\?.+)?$/", $this->current\_url(), $path)){ |
  | 309 | 309 | // for security |
  | 310 | 310 | if(preg\_match("/\.{2,}/", $this->current\_url())){ |
  | 311 | 311 | die("May be Directory Traversal Attack"); |
  | 312 | 312 | } |
  | 313 | 313 |  |
  | 314 | 314 | if(is\_dir($this->getWpContentDir("/cache/wpfc-minified/").$path[1])){ |
  | 315 | 315 | if($sources = @scandir($this->getWpContentDir("/cache/wpfc-minified/").$path[1], 1)){ |
  | 316 | 316 | if(isset($sources[0])){ |
  | 317 | 317 | // $exist\_url = str\_replace($path[2], $sources[0], $this->current\_url()); |
  | 318 | 318 | // header('Location: ' . $exist\_url, true, 301); |
  | 319 | 319 | // exit; |
  | 320 | 320 |  |
  | 321 | 321 | if(preg\_match("/\.css/", $this->current\_url())){ |
  | 322 | 322 | header('Content-type: text/css'); |
  | 323 | 323 | }else if(preg\_match("/\.js/", $this->current\_url())){ |
  | 324 | 324 | header('Content-type: text/js'); |
  | 325 | 325 | } |
  | 326 | 326 |  |
  | 327 | 327 | echo file\_get\_contents($this->getWpContentDir("/cache/wpfc-minified/").$path[1]."/".$sources[0]); |
  | 328 | 328 | exit; |
  | 329 | 329 | } |
  | 330 | 330 | } |
  | 331 | 331 | } |
  | 332 | 332 |  |
  | 333 | 333 |  |
  | 334 | 334 | if(preg\_match("/".basename($this->getWpContentDir("/cache/wpfc-minified/"))."/i", $this->current\_url())){ |
  | 335 | 335 | //for non-exists minified files |
  | 336 | 336 | if(preg\_match("/\.css/", $this->current\_url())){ |
  | 337 | 337 | header('Content-type: text/css'); |
  | 338 | 338 | die("/\* File not found \*/"); |
  | 339 | 339 | }else if(preg\_match("/\.js/", $this->current\_url())){ |
  | 340 | 340 | header('Content-type: text/js'); |
  | 341 | 341 | die("//File not found"); |
  | 342 | 342 | } |
  | 343 | 343 | } |
  | 344 | 344 |  |
  | 345 | 345 | }else{ |
  | 346 | 346 | // to show if the user is logged-in |
  | 347 | 347 | add\_action('wp\_loaded', array($this, "load\_admin\_toolbar")); |
  | 348 | 348 |  |
  | 349 | 349 | //for cache |
  | 350 | 350 | $this->cache(); |
  | 351 | 351 | } |
  | 352 | 352 | } |
  | 353 | 353 | } |
  | 354 | 354 | } |
  | 355 | 355 |  |
  | 356 | 356 | public function enable\_auto\_cache\_settings\_panel(){ |
  | 357 | 357 | if($this->isPluginActive('classic-editor/classic-editor.php') || $this->isPluginActive('disable-gutenberg/disable-gutenberg.php') || has\_filter("use\_block\_editor\_for\_post", "\_\_return\_false")){ |
  | 358 | 358 | add\_action("add\_meta\_boxes", array($this, "add\_meta\_box"), 10, 2); |
  | 359 | 359 | add\_action('admin\_notices', array($this, 'single\_preload\_inline\_js')); |
  | 360 | 360 | add\_action('wp\_ajax\_wpfc\_preload\_single\_save\_settings', array($this, "wpfc\_preload\_single\_save\_settings\_callback")); |
  | 361 | 361 | add\_action('wp\_ajax\_wpfc\_preload\_single', array($this, "wpfc\_preload\_single\_callback")); |
  | 362 | 362 | } |
  | 363 | 363 | } |
  | 364 | 364 |  |
  | 365 | 365 | public function clear\_cache\_after\_activate\_plugin(){ |
  | 366 | 366 | $this->deleteCache(true); |
  | 367 | 367 | } |
  | 368 | 368 |  |
  | 369 | 369 | public function clear\_cache\_after\_deactivate\_plugin(){ |
  | 370 | 370 | $this->deleteCache(true); |
  | 371 | 371 | } |
  | 372 | 372 |  |
  | 373 | 373 | public function clear\_cache\_after\_switch\_theme(){ |
  | 374 | 374 | $this->deleteCache(true); |
  | 375 | 375 | } |
  | 376 | 376 |  |
  | 377 | 377 | public function clear\_cache\_after\_update\_plugin($upgrader\_object, $options){ |
  | 378 | 378 | if($options['action'] == 'update'){ |
  | 379 | 379 | if($options['type'] == 'plugin' && (isset($options['plugins']) || isset($options['plugin']))){ |
  | 380 | 380 |  |
  | 381 | 381 | $options\_json = json\_encode($options); |
  | 382 | 382 |  |
  | 383 | 383 | if(preg\_match("/elementor\\\\\/elementor\.php/i", $options\_json)){ |
  | 384 | 384 | $this->deleteCache(true); |
  | 385 | 385 | } |
  | 386 | 386 |  |
  | 387 | 387 | if(defined("WPFC\_CLEAR\_CACHE\_AFTER\_PLUGIN\_UPDATE") && WPFC\_CLEAR\_CACHE\_AFTER\_PLUGIN\_UPDATE){ |
  | 388 | 388 | $this->deleteCache(true); |
  | 389 | 389 | } |
  | 390 | 390 | } |
  | 391 | 391 | } |
  | 392 | 392 | } |
  | 393 | 393 |  |
  | 394 | 394 | public function clear\_cache\_after\_update\_theme($upgrader\_object, $options){ |
  | 395 | 395 | if($options['action'] == 'update'){ |
  | 396 | 396 | if($options['type'] == 'theme' && isset($options['themes'])){ |
  | 397 | 397 |  |
  | 398 | 398 | if(defined("WPFC\_CLEAR\_CACHE\_AFTER\_THEME\_UPDATE") && WPFC\_CLEAR\_CACHE\_AFTER\_THEME\_UPDATE){ |
  | 399 | 399 | $this->deleteCache(true); |
  | 400 | 400 | } |
  | 401 | 401 |  |
  | 402 | 402 | } |
  | 403 | 403 | } |
  | 404 | 404 | } |
  | 405 | 405 |  |
  | 406 | 406 | public function action\_links($actions){ |
  | 407 | 407 | $actions['powered\_settings'] = sprintf(\_\_( '<a href="%s">Settings</a>', 'wp-fastest-cache'), esc\_url( admin\_url( 'admin.php?page=wpfastestcacheoptions'))); |
  | 408 | 408 | return array\_reverse($actions); |
  | 409 | 409 | } |
  | 410 | 410 |  |
  | 411 | 411 | public function wpfc\_preload\_single\_callback(){ |
  |  | 412 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'wpfc')){ |
  |  | 413 | die( 'Security check' ); |
  |  | 414 | } |
  |  | 415 |  |
  | 412 | 416 | include\_once('inc/single-preload.php'); |
  | 413 | 417 | SinglePreloadWPFC::create\_cache(); |
  | 414 | 418 | } |
  | 415 | 419 |  |
  | 416 | 420 | public function single\_preload\_inline\_js(){ |
  | 417 | 421 | include\_once('inc/single-preload.php'); |
  | 418 | 422 | SinglePreloadWPFC::init(); |
  | 419 | 423 | SinglePreloadWPFC::put\_inline\_js(); |
  | 420 | 424 | } |
  | 421 | 425 | public function add\_meta\_box(){ |
  | 422 | 426 | include\_once('inc/single-preload.php'); |
  | 423 | 427 | SinglePreloadWPFC::add\_meta\_box(); |
  | 424 | 428 | } |
  | 425 | 429 |  |
  | 426 | 430 | public function wpfc\_preload\_single\_save\_settings\_callback(){ |
  |  | 431 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'wpfc')){ |
  |  | 432 | die( 'Security check' ); |
  |  | 433 | } |
  |  | 434 |  |
  | 427 | 435 | include\_once('inc/single-preload.php'); |
  | 428 | 436 | SinglePreloadWPFC::save\_settings(); |
  | 429 | 437 | } |
  | 430 | 438 |  |
  | 431 | 439 | public function notify($message = array()){ |
  | 432 | 440 | if(isset($message[0]) && $message[0]){ |
  | 433 | 441 | if(function\_exists("add\_settings\_error")){ |
  | 434 | 442 | add\_settings\_error('wpfc-notice', esc\_attr( 'settings\_updated' ), $message[0], $message[1]); |
  | 435 | 443 | } |
  | 436 | 444 | } |
  | 437 | 445 | } |
  | 438 | 446 |  |
  | 439 | 447 | public function set\_content\_url(){ |
  | 440 | 448 | $content\_url = content\_url(); |
  | 441 | 449 |  |
  | 442 | 450 | // Hide My WP |
  | 443 | 451 | if($this->isPluginActive('hide\_my\_wp/hide-my-wp.php')){ |
  | 444 | 452 | $hide\_my\_wp = get\_option("hide\_my\_wp"); |
  | 445 | 453 |  |
  | 446 | 454 | if(isset($hide\_my\_wp["new\_content\_path"]) && $hide\_my\_wp["new\_content\_path"]){ |
  | 447 | 455 | $hide\_my\_wp["new\_content\_path"] = trim($hide\_my\_wp["new\_content\_path"], "/"); |
  | 448 | 456 | $content\_url = str\_replace(basename(WPFC\_WP\_CONTENT\_DIR), $hide\_my\_wp["new\_content\_path"], $content\_url); |
  | 449 | 457 | } |
  | 450 | 458 | } |
  | 451 | 459 |  |
  | 452 | 460 | // to change content url if a different url is used for other langs |
  | 453 | 461 | if($this->isPluginActive('polylang/polylang.php')){ |
  | 454 | 462 | $url =  parse\_url($content\_url); |
  | 455 | 463 |  |
  | 456 | 464 | if($url["host"] != $\_SERVER['HTTP\_HOST']){ |
  | 457 | 465 | $protocol = ((!empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] != 'off') || $\_SERVER['SERVER\_PORT'] == 443) ? "https://" : "http://"; |
  | 458 | 466 | $content\_url = $protocol.$\_SERVER['HTTP\_HOST'].$url['path']; |
  | 459 | 467 | } |
  | 460 | 468 | } |
  | 461 | 469 |  |
  | 462 | 470 | if (!defined('WPFC\_WP\_CONTENT\_URL')) { |
  | 463 | 471 | define("WPFC\_WP\_CONTENT\_URL", $content\_url); |
  | 464 | 472 | } |
  | 465 | 473 |  |
  | 466 | 474 | $this->content\_url = $content\_url; |
  | 467 | 475 | } |
  | 468 | 476 |  |
  | 469 | 477 | public function clear\_cache\_on\_kksr\_rate($id){ |
  | 470 | 478 | $this->singleDeleteCache(false, $id); |
  | 471 | 479 | } |
  | 472 | 480 |  |
  | 473 | 481 | public function clear\_cache\_after\_woocommerce\_order\_status\_changed($order\_id = false){ |
  | 474 | 482 | if(function\_exists("wc\_get\_order")){ |
  | 475 | 483 | if($order\_id){ |
  | 476 | 484 | $order = wc\_get\_order($order\_id); |
  | 477 | 485 |  |
  | 478 | 486 | if($order){ |
  | 479 | 487 | foreach($order->get\_items() as $item\_key => $item\_values ){ |
  | 480 | 488 | if(method\_exists($item\_values, 'get\_product\_id')){ |
  | 481 | 489 | $this->singleDeleteCache(false, $item\_values->get\_product\_id()); |
  | 482 | 490 | } |
  | 483 | 491 | } |
  | 484 | 492 | } |
  | 485 | 493 | } |
  | 486 | 494 | } |
  | 487 | 495 | } |
  | 488 | 496 |  |
  | 489 | 497 | public function wpfc\_db\_fix\_callback(){ |
  | 490 | 498 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 491 | 499 | include\_once $this->get\_premium\_path("db.php"); |
  | 492 | 500 |  |
  | 493 | 501 | if(class\_exists("WpFastestCacheDatabaseCleanup")){ |
  | 494 | 502 | WpFastestCacheDatabaseCleanup::clean($\_GET["type"]); |
  | 495 | 503 | }else{ |
  | 496 | 504 | die(json\_encode(array("success" => false, "showupdatewarning" => true, "message" => "Only available in Premium version"))); |
  | 497 | 505 | } |
  | 498 | 506 |  |
  | 499 | 507 | }else{ |
  | 500 | 508 | die(json\_encode(array("success" => false, "message" => "Only available in Premium version"))); |
  | 501 | 509 | } |
  | 502 | 510 | } |
  | 503 | 511 |  |
  | 504 | 512 | public function wpfc\_db\_statics\_callback(){ |
  |  | 513 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'wpfc')){ |
  |  | 514 | die( 'Security check' ); |
  |  | 515 | } |
  |  | 516 |  |
  | 505 | 517 | global $wpdb; |
  | 506 | 518 |  |
  | 507 | 519 | $statics = array("all\_warnings" => 0, |
  | 508 | 520 | "post\_revisions" => 0, |
  | 509 | 521 | "trashed\_contents" => 0, |
  | 510 | 522 | "trashed\_spam\_comments" => 0, |
  | 511 | 523 | "trackback\_pingback" => 0, |
  | 512 | 524 | "transient\_options" => 0 |
  | 513 | 525 | ); |
  | 514 | 526 |  |
  | 515 | 527 |  |
  | 516 | 528 | $statics["post\_revisions"] = $wpdb->get\_var("SELECT COUNT(\*) FROM `$wpdb->posts` WHERE post\_type = 'revision';"); |
  | 517 | 529 | $statics["all\_warnings"] = $statics["all\_warnings"] + $statics["post\_revisions"]; |
  | 518 | 530 |  |
  | 519 | 531 | $statics["trashed\_contents"] = $wpdb->get\_var("SELECT COUNT(\*) FROM `$wpdb->posts` WHERE post\_status = 'trash';"); |
  | 520 | 532 | $statics["all\_warnings"] = $statics["all\_warnings"] + $statics["trashed\_contents"]; |
  | 521 | 533 |  |
  | 522 | 534 | $statics["trashed\_spam\_comments"] = $wpdb->get\_var("SELECT COUNT(\*) FROM `$wpdb->comments` WHERE comment\_approved = 'spam' OR comment\_approved = 'trash' ;"); |
  | 523 | 535 | $statics["all\_warnings"] = $statics["all\_warnings"] + $statics["trashed\_spam\_comments"]; |
  | 524 | 536 |  |
  | 525 | 537 | $statics["trackback\_pingback"] = $wpdb->get\_var("SELECT COUNT(\*) FROM `$wpdb->comments` WHERE comment\_type = 'trackback' OR comment\_type = 'pingback' ;"); |
  | 526 | 538 | $statics["all\_warnings"] = $statics["all\_warnings"] + $statics["trackback\_pingback"]; |
  | 527 | 539 |  |
  | 528 | 540 | $element = "SELECT COUNT(\*) FROM `$wpdb->options` WHERE option\_name LIKE '%\\_transient\\_%' ;"; |
  | 529 | 541 | $statics["transient\_options"] = $wpdb->get\_var( $element ) > 100 ? $wpdb->get\_var( $element ) : 0; |
  | 530 | 542 | $statics["all\_warnings"] = $statics["all\_warnings"] + $statics["transient\_options"]; |
  | 531 | 543 |  |
  | 532 | 544 | die(json\_encode($statics)); |
  | 533 | 545 | } |
  | 534 | 546 |  |
  | 535 | 547 | public function is\_trailing\_slash(){ |
  | 536 | 548 | // no need to check if Custom Permalinks plugin is active (https://tr.wordpress.org/plugins/custom-permalinks/) |
  | 537 | 549 | if($this->isPluginActive("custom-permalinks/custom-permalinks.php")){ |
  | 538 | 550 | return false; |
  | 539 | 551 | } |
  | 540 | 552 |  |
  | 541 | 553 | if($permalink\_structure = get\_option('permalink\_structure')){ |
  | 542 | 554 | if(preg\_match("/\/$/", $permalink\_structure)){ |
  | 543 | 555 | return true; |
  | 544 | 556 | } |
  | 545 | 557 | } |
  | 546 | 558 |  |
  | 547 | 559 | return false; |
  | 548 | 560 | } |
  | 549 | 561 |  |
  | 550 | 562 | public function wpfc\_cache\_statics\_get\_callback(){ |
  | 551 | 563 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 552 | 564 | if(file\_exists(WPFC\_WP\_PLUGIN\_DIR."/wp-fastest-cache-premium/pro/library/statics.php")){ |
  | 553 | 565 | include\_once $this->get\_premium\_path("statics.php"); |
  | 554 | 566 |  |
  | 555 | 567 | $cache\_statics = new WpFastestCacheStatics(); |
  | 556 | 568 | $res = $cache\_statics->get(); |
  | 557 | 569 | echo json\_encode($res); |
  | 558 | 570 | exit; |
  | 559 | 571 | } |
  | 560 | 572 | } |
  | 561 | 573 | } |
  | 562 | 574 |  |
  | 563 | 575 | public function wpfc\_check\_url\_ajax\_request\_callback(){ |
  | 564 | 576 | include\_once('inc/cdn.php'); |
  | 565 | 577 | CdnWPFC::check\_url(); |
  | 566 | 578 | } |
  | 567 | 579 |  |
  | 568 | 580 | public function wpfc\_cdn\_template\_ajax\_request\_callback(){ |
  | 569 | 581 | include\_once('inc/cdn.php'); |
  | 570 | 582 | CdnWPFC::cdn\_template(); |
  | 571 | 583 | } |
  | 572 | 584 |  |
  | 573 | 585 | public function wpfc\_save\_cdn\_integration\_ajax\_request\_callback(){ |
  |  | 586 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'cdn-nonce')){ |
  |  | 587 | die( 'Security check' ); |
  |  | 588 | } |
  |  | 589 |  |
  | 574 | 590 | include\_once('inc/cdn.php'); |
  | 575 | 591 | CdnWPFC::save\_cdn\_integration(); |
  | 576 | 592 | } |
  | 577 | 593 |  |
  | 578 | 594 | public function wpfc\_start\_cdn\_integration\_ajax\_request\_callback(){ |
  |  | 595 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'cdn-nonce')){ |
  |  | 596 | die( 'Security check' ); |
  |  | 597 | } |
  |  | 598 |  |
  | 579 | 599 | include\_once('inc/cdn.php'); |
  | 580 | 600 | CdnWPFC::start\_cdn\_integration(); |
  | 581 | 601 | } |
  | 582 | 602 |  |
  | 583 | 603 | public function wpfc\_pause\_cdn\_integration\_ajax\_request\_callback(){ |
  |  | 604 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'cdn-nonce')){ |
  |  | 605 | die( 'Security check' ); |
  |  | 606 | } |
  |  | 607 |  |
  | 584 | 608 | include\_once('inc/cdn.php'); |
  | 585 | 609 | CdnWPFC::pause\_cdn\_integration(); |
  | 586 | 610 | } |
  | 587 | 611 |  |
  | 588 | 612 | public function wpfc\_remove\_cdn\_integration\_ajax\_request\_callback(){ |
  |  | 613 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'cdn-nonce')){ |
  |  | 614 | die( 'Security check' ); |
  |  | 615 | } |
  |  | 616 |  |
  | 589 | 617 | include\_once('inc/cdn.php'); |
  | 590 | 618 | CdnWPFC::remove\_cdn\_integration(); |
  | 591 | 619 | } |
  | 592 | 620 |  |
  | 593 | 621 | public function wpfc\_cdn\_options\_ajax\_request\_callback(){ |
  | 594 | 622 | include\_once('inc/cdn.php'); |
  | 595 | 623 | CdnWPFC::cdn\_options(); |
  | 596 | 624 | } |
  | 597 | 625 |  |
  | 598 | 626 | public function wpfc\_save\_exclude\_pages\_callback(){ |
  | 599 | 627 | if(!wp\_verify\_nonce($\_POST["security"], 'wpfc-save-exclude-ajax-nonce')){ |
  | 600 | 628 | die( 'Security check' ); |
  | 601 | 629 | } |
  | 602 | 630 |  |
  | 603 | 631 | if(current\_user\_can('manage\_options')){ |
  | 604 | 632 | if(isset($\_POST["rules"])){ |
  | 605 | 633 | foreach ($\_POST["rules"] as $key => &$value) { |
  | 606 | 634 | $value["prefix"] = strip\_tags($value["prefix"]); |
  | 607 | 635 | $value["content"] = strip\_tags($value["content"]); |
  | 608 | 636 |  |
  | 609 | 637 | $value["prefix"] = preg\_replace("/\'|\"/", "", $value["prefix"]); |
  | 610 | 638 |  |
  | 611 | 639 | if($value["prefix"] == "regex"){ |
  | 612 | 640 | $value["content"] = stripslashes($value["content"]); |
  | 613 | 641 |  |
  | 614 | 642 | $value["content"] = esc\_attr($value["content"]); |
  | 615 | 643 | }else{ |
  | 616 | 644 | $value["content"] = preg\_replace("/\'|\"/", "", $value["content"]); |
  | 617 | 645 | $value["content"] = preg\_replace("/(\#|\s|\(|\)|\\*)/", "", $value["content"]); |
  | 618 | 646 | } |
  | 619 | 647 |  |
  | 620 | 648 | if($value["prefix"] == "homepage"){ |
  | 621 | 649 | $this->deleteHomePageCache(false); |
  | 622 | 650 | } |
  | 623 | 651 | } |
  | 624 | 652 |  |
  | 625 | 653 | $data = json\_encode($\_POST["rules"]); |
  | 626 | 654 |  |
  | 627 | 655 | if(get\_option("WpFastestCacheExclude")){ |
  | 628 | 656 | update\_option("WpFastestCacheExclude", $data); |
  | 629 | 657 | }else{ |
  | 630 | 658 | add\_option("WpFastestCacheExclude", $data, null, "yes"); |
  | 631 | 659 | } |
  | 632 | 660 | }else{ |
  | 633 | 661 | delete\_option("WpFastestCacheExclude"); |
  | 634 | 662 | } |
  | 635 | 663 |  |
  | 636 | 664 | $this->modify\_htaccess\_for\_exclude(); |
  | 637 | 665 |  |
  | 638 | 666 | echo json\_encode(array("success" => true)); |
  | 639 | 667 | exit; |
  | 640 | 668 | }else{ |
  | 641 | 669 | wp\_die("Must be admin"); |
  | 642 | 670 | } |
  | 643 | 671 | } |
  | 644 | 672 |  |
  | 645 | 673 | public function modify\_htaccess\_for\_exclude(){ |
  | 646 | 674 | $path = ABSPATH; |
  | 647 | 675 |  |
  | 648 | 676 | if($this->is\_subdirectory\_install()){ |
  | 649 | 677 | $path = $this->getABSPATH(); |
  | 650 | 678 | } |
  | 651 | 679 |  |
  | 652 | 680 | $htaccess = @file\_get\_contents($path.".htaccess"); |
  | 653 | 681 |  |
  | 654 | 682 | if(preg\_match("/\#\s?Start\sWPFC\sExclude/", $htaccess)){ |
  | 655 | 683 | $exclude\_rules = $this->excludeRules(); |
  | 656 | 684 |  |
  | 657 | 685 | $htaccess = preg\_replace("/\#\s?Start\sWPFC\sExclude[^\#]\*\#\s?End\sWPFC\sExclude\s+/", $exclude\_rules, $htaccess); |
  | 658 | 686 | } |
  | 659 | 687 |  |
  | 660 | 688 | @file\_put\_contents($path.".htaccess", $htaccess); |
  | 661 | 689 | } |
  | 662 | 690 |  |
  | 663 | 691 | public function wpfc\_purgecache\_varnish\_callback(){ |
  |  | 692 | if(!wp\_verify\_nonce($\_REQUEST["security"], 'wpfc-varnish-ajax-nonce')){ |
  |  | 693 | die( 'Security check' ); |
  |  | 694 | } |
  |  | 695 |  |
  | 664 | 696 | if($varnish\_datas = get\_option("WpFastestCacheVarnish")){ |
  | 665 | 697 | include\_once('inc/varnish.php'); |
  | 666 | 698 | $res\_arr = VarnishWPFC::purge\_cache($varnish\_datas["server"]); |
  | 667 | 699 |  |
  | 668 | 700 | wp\_send\_json($res\_arr); |
  | 669 | 701 | } |
  | 670 | 702 | } |
  | 671 | 703 |  |
  | 672 | 704 | public function wpfc\_save\_varnish\_callback(){ |
  | 673 | 705 | include\_once('inc/varnish.php'); |
  | 674 | 706 | VarnishWPFC::save(); |
  | 675 | 707 | } |
  | 676 | 708 |  |
  | 677 | 709 | public function wpfc\_remove\_varnish\_callback(){ |
  | 678 | 710 | include\_once('inc/varnish.php'); |
  | 679 | 711 | VarnishWPFC::remove(); |
  | 680 | 712 | } |
  | 681 | 713 |  |
  | 682 | 714 | public function wpfc\_start\_varnish\_callback(){ |
  | 683 | 715 | include\_once('inc/varnish.php'); |
  | 684 | 716 | VarnishWPFC::start(); |
  | 685 | 717 | } |
  | 686 | 718 |  |
  | 687 | 719 | public function wpfc\_pause\_varnish\_callback(){ |
  | 688 | 720 | include\_once('inc/varnish.php'); |
  | 689 | 721 | VarnishWPFC::pause(); |
  | 690 | 722 | } |
  | 691 | 723 |  |
  | 692 | 724 | public function wpfc\_status\_varnish(){ |
  | 693 | 725 | include\_once('inc/varnish.php'); |
  | 694 | 726 | VarnishWPFC::status(); |
  | 695 | 727 | } |
  | 696 | 728 |  |
  | 697 | 729 | public function wpfc\_get\_list\_csp\_callback(){ |
  | 698 | 730 | include\_once('inc/clearing-specific-pages.php'); |
  | 699 | 731 | ClearingSpecificPagesWPFC::get\_list(); |
  | 700 | 732 | } |
  | 701 | 733 |  |
  | 702 | 734 | public function wpfc\_save\_csp\_callback(){ |
  | 703 | 735 | include\_once('inc/clearing-specific-pages.php'); |
  | 704 | 736 | ClearingSpecificPagesWPFC::save(); |
  | 705 | 737 | } |
  | 706 | 738 |  |
  | 707 | 739 | public function wpfc\_remove\_csp\_callback(){ |
  | 708 | 740 | include\_once('inc/clearing-specific-pages.php'); |
  | 709 | 741 | ClearingSpecificPagesWPFC::remove(); |
  | 710 | 742 | } |
  | 711 | 743 |  |
  | 712 | 744 | public function wpfc\_save\_timeout\_pages\_callback(){ |
  | 713 | 745 | if(!wp\_verify\_nonce($\_POST["security"], 'wpfc-save-timeout-ajax-nonce')){ |
  | 714 | 746 | die( 'Security check' ); |
  | 715 | 747 | } |
  | 716 | 748 |  |
  | 717 | 749 | if(current\_user\_can('manage\_options')){ |
  | 718 | 750 | $this->setCustomInterval(); |
  | 719 | 751 |  |
  | 720 | 752 | $crons = \_get\_cron\_array(); |
  | 721 | 753 |  |
  | 722 | 754 | foreach ($crons as $cron\_key => $cron\_value) { |
  | 723 | 755 | foreach ( (array) $cron\_value as $hook => $events ) { |
  | 724 | 756 | if(preg\_match("/^wp\\_fastest\\_cache(.\*)/", $hook, $id)){ |
  | 725 | 757 | if(!$id[1] || preg\_match("/^\\_(\d+)$/", $id[1])){ |
  | 726 | 758 | foreach ( (array) $events as $event\_key => $event ) { |
  | 727 | 759 | if($id[1]){ |
  | 728 | 760 | wp\_clear\_scheduled\_hook("wp\_fastest\_cache".$id[1], $event["args"]); |
  | 729 | 761 | }else{ |
  | 730 | 762 | wp\_clear\_scheduled\_hook("wp\_fastest\_cache", $event["args"]); |
  | 731 | 763 | } |
  | 732 | 764 | } |
  | 733 | 765 | } |
  | 734 | 766 | } |
  | 735 | 767 | } |
  | 736 | 768 | } |
  | 737 | 769 |  |
  | 738 | 770 | if(isset($\_POST["rules"]) && count($\_POST["rules"]) > 0){ |
  | 739 | 771 | $i = 0; |
  | 740 | 772 |  |
  | 741 | 773 | foreach ($\_POST["rules"] as $key => $value) { |
  | 742 | 774 | if(preg\_match("/^(daily|onceaday)$/i", $value["schedule"]) && isset($value["hour"]) && isset($value["minute"]) && strlen($value["hour"]) > 0 && strlen($value["minute"]) > 0){ |
  | 743 | 775 | $args = array("prefix" => $value["prefix"], "content" => $value["content"], "hour" => $value["hour"], "minute" => $value["minute"]); |
  | 744 | 776 |  |
  | 745 | 777 | $timestamp = mktime($value["hour"],$value["minute"],0,date("m"),date("d"),date("Y")); |
  | 746 | 778 |  |
  | 747 | 779 | $timestamp = $timestamp > time() ? $timestamp : $timestamp + 60\*60\*24; |
  | 748 | 780 | }else{ |
  | 749 | 781 | $args = array("prefix" => $value["prefix"], "content" => $value["content"]); |
  | 750 | 782 | $timestamp = time(); |
  | 751 | 783 | } |
  | 752 | 784 |  |
  | 753 | 785 | wp\_schedule\_event($timestamp, $value["schedule"], "wp\_fastest\_cache\_".$i, array(json\_encode($args))); |
  | 754 | 786 | $i = $i + 1; |
  | 755 | 787 | } |
  | 756 | 788 | } |
  | 757 | 789 |  |
  | 758 | 790 | echo json\_encode(array("success" => true)); |
  | 759 | 791 | exit; |
  | 760 | 792 | }else{ |
  | 761 | 793 | wp\_die("Must be admin"); |
  | 762 | 794 | } |
  | 763 | 795 | } |
  | 764 | 796 |  |
  | 765 | 797 | public function wp\_postratings\_clear\_fastest\_cache($rate\_userid, $post\_id){ |
  | 766 | 798 | // to remove cache if vote is from homepage or category page or tag |
  | 767 | 799 | if(isset($\_SERVER["HTTP\_REFERER"]) && $\_SERVER["HTTP\_REFERER"]){ |
  | 768 | 800 | $url =  parse\_url($\_SERVER["HTTP\_REFERER"]); |
  | 769 | 801 |  |
  | 770 | 802 | $url["path"] = isset($url["path"]) ? $url["path"] : "/index.html"; |
  | 771 | 803 |  |
  | 772 | 804 | if(isset($url["path"])){ |
  | 773 | 805 | if($url["path"] == "/"){ |
  | 774 | 806 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/all/index.html")); |
  | 775 | 807 | }else{ |
  | 776 | 808 | // to prevent changing path with ../ or with another method |
  | 777 | 809 | if($url["path"] == realpath(".".$url["path"])){ |
  | 778 | 810 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/all").$url["path"]); |
  | 779 | 811 | } |
  | 780 | 812 | } |
  | 781 | 813 | } |
  | 782 | 814 | } |
  | 783 | 815 |  |
  | 784 | 816 | if($post\_id){ |
  | 785 | 817 | $this->singleDeleteCache(false, $post\_id); |
  | 786 | 818 | } |
  | 787 | 819 | } |
  | 788 | 820 |  |
  | 789 | 821 | private function admin(){ |
  | 790 | 822 | if(isset($\_GET["page"]) && $\_GET["page"] == "wpfastestcacheoptions"){ |
  | 791 | 823 | include\_once('inc/admin.php'); |
  | 792 | 824 | $wpfc = new WpFastestCacheAdmin(); |
  | 793 | 825 | $wpfc->addMenuPage(); |
  | 794 | 826 | }else{ |
  | 795 | 827 | add\_action('admin\_menu', array($this, 'register\_my\_custom\_menu\_page')); |
  | 796 | 828 | } |
  | 797 | 829 | } |
  | 798 | 830 |  |
  | 799 | 831 | public function load\_column(){ |
  | 800 | 832 | if(!defined('WPFC\_HIDE\_CLEAR\_CACHE\_BUTTON') || (defined('WPFC\_HIDE\_CLEAR\_CACHE\_BUTTON') && !WPFC\_HIDE\_CLEAR\_CACHE\_BUTTON)){ |
  | 801 | 833 | include\_once plugin\_dir\_path(\_\_FILE\_\_)."inc/column.php"; |
  | 802 | 834 |  |
  | 803 | 835 | $column = new WpFastestCacheColumn(); |
  | 804 | 836 | $column->add(); |
  | 805 | 837 | } |
  | 806 | 838 | } |
  | 807 | 839 |  |
  | 808 | 840 | public function load\_admin\_toolbar(){ |
  | 809 | 841 | if(!defined('WPFC\_HIDE\_TOOLBAR') || (defined('WPFC\_HIDE\_TOOLBAR') && !WPFC\_HIDE\_TOOLBAR)){ |
  | 810 | 842 | $user = wp\_get\_current\_user(); |
  | 811 | 843 | $allowed\_roles = array('administrator'); |
  | 812 | 844 |  |
  | 813 | 845 | $wpfc\_role\_status = get\_option("WpFastestCacheToolbarSettings"); |
  | 814 | 846 | if(is\_array($wpfc\_role\_status) && !empty($wpfc\_role\_status)){ |
  | 815 | 847 | foreach ($wpfc\_role\_status as $key => $value){ |
  | 816 | 848 | $key = str\_replace("wpfc\_toolbar\_", "", $key); |
  | 817 | 849 | array\_push($allowed\_roles, strtolower($key)); |
  | 818 | 850 | } |
  | 819 | 851 | } |
  | 820 | 852 |  |
  | 821 | 853 |  |
  | 822 | 854 | if(array\_intersect($allowed\_roles, $user->roles)){ |
  | 823 | 855 | include\_once plugin\_dir\_path(\_\_FILE\_\_)."inc/admin-toolbar.php"; |
  | 824 | 856 |  |
  | 825 | 857 | if(preg\_match("/\/cache\/all/", $this->getWpContentDir("/cache/all"))){ |
  | 826 | 858 | $is\_multi = false; |
  | 827 | 859 | }else{ |
  | 828 | 860 | $is\_multi = true; |
  | 829 | 861 | } |
  | 830 | 862 |  |
  | 831 | 863 | $toolbar = new WpFastestCacheAdminToolbar($is\_multi); |
  | 832 | 864 | $toolbar->add(); |
  | 833 | 865 | } |
  | 834 | 866 | } |
  | 835 | 867 | } |
  | 836 | 868 |  |
  | 837 | 869 | public function tmp\_saveOption(){ |
  | 838 | 870 | if(!empty($\_POST)){ |
  | 839 | 871 | if(isset($\_POST["wpFastestCachePage"])){ |
  | 840 | 872 | include\_once('inc/admin.php'); |
  | 841 | 873 | $wpfc = new WpFastestCacheAdmin(); |
  | 842 | 874 | $wpfc->optionsPageRequest(); |
  | 843 | 875 | } |
  | 844 | 876 | } |
  | 845 | 877 | } |
  | 846 | 878 |  |
  | 847 | 879 | public function register\_mysettings(){ |
  | 848 | 880 | register\_setting('wpfc-group', 'wpfc-group', array($this, 'tmp\_saveOption')); |
  | 849 | 881 | } |
  | 850 | 882 |  |
  | 851 | 883 | public function register\_my\_custom\_menu\_page(){ |
  | 852 | 884 | if(function\_exists('add\_menu\_page')){ |
  | 853 | 885 | add\_menu\_page("WP Fastest Cache Settings", "WP Fastest Cache", 'manage\_options', "wpfastestcacheoptions", array($this, 'optionsPage'), plugins\_url("wp-fastest-cache/images/icon.svg")); |
  | 854 | 886 | add\_action('admin\_init', array($this, 'register\_mysettings')); |
  | 855 | 887 |  |
  | 856 | 888 | wp\_enqueue\_style("wp-fastest-cache", plugins\_url("wp-fastest-cache/css/style.css"), array(), time(), "all"); |
  | 857 | 889 | } |
  | 858 | 890 |  |
  | 859 | 891 | if(isset($\_GET["page"]) && $\_GET["page"] == "wpfastestcacheoptions"){ |
  | 860 | 892 | wp\_enqueue\_style("wp-fastest-cache-buycredit", plugins\_url("wp-fastest-cache/css/buycredit.css"), array(), time(), "all"); |
  | 861 | 893 | wp\_enqueue\_style("wp-fastest-cache-flaticon", plugins\_url("wp-fastest-cache/css/flaticon.css"), array(), time(), "all"); |
  | 862 | 894 | wp\_enqueue\_style("wp-fastest-cache-dialog", plugins\_url("wp-fastest-cache/css/dialog.css"), array(), time(), "all"); |
  | 863 | 895 | } |
  | 864 | 896 | } |
  | 865 | 897 |  |
  | 866 | 898 | public function deleteCacheToolbar(){ |
  |  | 899 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'wpfc')){ |
  |  | 900 | die( 'Security check' ); |
  |  | 901 | } |
  |  | 902 |  |
  | 867 | 903 | $this->deleteCache(); |
  | 868 | 904 | } |
  | 869 | 905 |  |
  | 870 | 906 | public function deleteCssAndJsCacheToolbar(){ |
  |  | 907 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'wpfc')){ |
  |  | 908 | die( 'Security check' ); |
  |  | 909 | } |
  |  | 910 |  |
  | 871 | 911 | $this->deleteCache(true); |
  | 872 | 912 | } |
  | 873 | 913 |  |
  | 874 | 914 | public function wpfc\_toolbar\_get\_settings\_callback(){ |
  | 875 | 915 | if(current\_user\_can('manage\_options')){ |
  | 876 | 916 | $result = array("success" => true, "roles" => false); |
  | 877 | 917 |  |
  | 878 | 918 | $wpfc\_role\_status = get\_option("WpFastestCacheToolbarSettings"); |
  | 879 | 919 | if(is\_array($wpfc\_role\_status) && !empty($wpfc\_role\_status)){ |
  | 880 | 920 | $result["roles"] = $wpfc\_role\_status; |
  | 881 | 921 | } |
  | 882 | 922 |  |
  | 883 | 923 | die(json\_encode($result)); |
  | 884 | 924 | }else{ |
  | 885 | 925 | wp\_die("Must be admin"); |
  | 886 | 926 | } |
  | 887 | 927 | } |
  | 888 | 928 |  |
  | 889 | 929 | public function wpfc\_cache\_path\_save\_settings\_callback(){ |
  | 890 | 930 | if(current\_user\_can('manage\_options')){ |
  | 891 | 931 | foreach($\_POST as $key => &$value){ |
  | 892 | 932 | $value = esc\_html(esc\_sql($value)); |
  | 893 | 933 | } |
  | 894 | 934 |  |
  | 895 | 935 | $path\_arr = array( |
  | 896 | 936 | "cachepath" => sanitize\_text\_field($\_POST["cachepath"]), |
  | 897 | 937 | "optimizedpath" => sanitize\_text\_field($\_POST["optimizedpath"]) |
  | 898 | 938 | ); |
  | 899 | 939 |  |
  | 900 | 940 | if(get\_option("WpFastestCachePathSettings") === false){ |
  | 901 | 941 | add\_option("WpFastestCachePathSettings", $path\_arr, 1, "no"); |
  | 902 | 942 | }else{ |
  | 903 | 943 | update\_option("WpFastestCachePathSettings", $path\_arr); |
  | 904 | 944 | } |
  | 905 | 945 |  |
  | 906 | 946 | die(json\_encode(array("success" => true))); |
  | 907 | 947 | }else{ |
  | 908 | 948 | wp\_die("Must be admin"); |
  | 909 | 949 | } |
  | 910 | 950 | } |
  | 911 | 951 |  |
  | 912 | 952 | public function wpfc\_toolbar\_save\_settings\_callback(){ |
  |  | 953 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'wpfc')){ |
  |  | 954 | die( 'Security check' ); |
  |  | 955 | } |
  |  | 956 |  |
  | 913 | 957 | if(current\_user\_can('manage\_options')){ |
  | 914 | 958 | if(is\_array($\_GET["roles"]) && !empty($\_GET["roles"])){ |
  | 915 | 959 | $roles\_arr = array(); |
  | 916 | 960 |  |
  | 917 | 961 | foreach($\_GET["roles"] as $key => $value){ |
  | 918 | 962 | $value = esc\_html(esc\_sql($value)); |
  | 919 | 963 | $key = esc\_html(esc\_sql($key)); |
  | 920 | 964 |  |
  | 921 | 965 | $roles\_arr[$key] = $value; |
  | 922 | 966 | } |
  | 923 | 967 |  |
  | 924 | 968 | if(get\_option("WpFastestCacheToolbarSettings") === false){ |
  | 925 | 969 | add\_option("WpFastestCacheToolbarSettings", $roles\_arr, 1, "no"); |
  | 926 | 970 | }else{ |
  | 927 | 971 | update\_option("WpFastestCacheToolbarSettings", $roles\_arr); |
  | 928 | 972 | } |
  | 929 | 973 | }else{ |
  | 930 | 974 | delete\_option("WpFastestCacheToolbarSettings"); |
  | 931 | 975 | } |
  | 932 | 976 |  |
  | 933 | 977 |  |
  | 934 | 978 | die(json\_encode(array("Saved","success"))); |
  | 935 | 979 | }else{ |
  | 936 | 980 | wp\_die("Must be admin"); |
  | 937 | 981 | } |
  | 938 | 982 | } |
  | 939 | 983 |  |
  | 940 | 984 | public function wpfc\_clear\_cache\_of\_allsites\_callback(){ |
  |  | 985 |  |
  |  | 986 | if(defined('DOING\_AJAX') && DOING\_AJAX){ |
  |  | 987 | if(!wp\_verify\_nonce($\_REQUEST["nonce"], 'wpfc')){ |
  |  | 988 | die( 'Security check' ); |
  |  | 989 | } |
  |  | 990 | } |
  |  | 991 |  |
  | 941 | 992 | include\_once('inc/cdn.php'); |
  | 942 | 993 | CdnWPFC::cloudflare\_clear\_cache(); |
  | 943 | 994 |  |
  | 944 | 995 | $path = $this->getWpContentDir("/cache/\*"); |
  | 945 | 996 |  |
  | 946 | 997 | $files = glob($this->getWpContentDir("/cache/\*")); |
  | 947 | 998 |  |
  | 948 | 999 | if(!is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 949 | 1000 | if(@mkdir($this->getWpContentDir("/cache/tmpWpfc"), 0755, true)){ |
  | 950 | 1001 | //tmpWpfc has been created |
  | 951 | 1002 | } |
  | 952 | 1003 | } |
  | 953 | 1004 |  |
  | 954 | 1005 | foreach ((array)$files as $file){ |
  | 955 | 1006 | @rename($file, $this->getWpContentDir("/cache/tmpWpfc/").basename($file)."-".time()); |
  | 956 | 1007 | } |
  | 957 | 1008 |  |
  | 958 | 1009 | if (is\_admin() && defined('DOING\_AJAX') && DOING\_AJAX){ |
  | 959 | 1010 | die(json\_encode(array("The cache of page has been cleared","success"))); |
  | 960 | 1011 | } |
  | 961 | 1012 | } |
  | 962 | 1013 |  |
  | 963 | 1014 | public function delete\_current\_page\_cache(){ |
  | 964 | 1015 | if(!wp\_verify\_nonce($\_GET["nonce"], "wpfc")){ |
  | 965 | 1016 | die(json\_encode(array("Security Error!", "error", "alert"))); |
  | 966 | 1017 | } |
  | 967 | 1018 |  |
  | 968 | 1019 | if($varnish\_datas = get\_option("WpFastestCacheVarnish")){ |
  | 969 | 1020 | include\_once('inc/varnish.php'); |
  | 970 | 1021 | VarnishWPFC::purge\_cache($varnish\_datas); |
  | 971 | 1022 | } |
  | 972 | 1023 |  |
  | 973 | 1024 | include\_once('inc/cdn.php'); |
  | 974 | 1025 | CdnWPFC::cloudflare\_clear\_cache(); |
  | 975 | 1026 |  |
  | 976 | 1027 | if(isset($\_GET["path"])){ |
  | 977 | 1028 | if($\_GET["path"]){ |
  | 978 | 1029 | if($\_GET["path"] == "/"){ |
  | 979 | 1030 | $\_GET["path"] = $\_GET["path"]."index.html"; |
  | 980 | 1031 | } |
  | 981 | 1032 | }else{ |
  | 982 | 1033 | $\_GET["path"] = "/index.html"; |
  | 983 | 1034 | } |
  | 984 | 1035 |  |
  | 985 | 1036 | $\_GET["path"] = urldecode(esc\_url\_raw($\_GET["path"])); |
  | 986 | 1037 |  |
  | 987 | 1038 | // for security |
  | 988 | 1039 | if(preg\_match("/\.{2,}/", $\_GET["path"])){ |
  | 989 | 1040 | die("May be Directory Traversal Attack"); |
  | 990 | 1041 | } |
  | 991 | 1042 |  |
  | 992 | 1043 | $paths = array(); |
  | 993 | 1044 |  |
  | 994 | 1045 | array\_push($paths, $this->getWpContentDir("/cache/all").$\_GET["path"]); |
  | 995 | 1046 |  |
  | 996 | 1047 | if(class\_exists("WpFcMobileCache")){ |
  | 997 | 1048 | $wpfc\_mobile = new WpFcMobileCache(); |
  | 998 | 1049 | array\_push($paths, $this->getWpContentDir("/cache/wpfc-mobile-cache").$\_GET["path"]); |
  | 999 | 1050 | } |
  | 1000 | 1051 |  |
  | 1001 | 1052 | foreach ($paths as $key => $value){ |
  | 1002 | 1053 | if(file\_exists($value)){ |
  | 1003 | 1054 | if(preg\_match("/\/(all|wpfc-mobile-cache)\/index\.html$/i", $value)){ |
  | 1004 | 1055 | @unlink($value); |
  | 1005 | 1056 | }else{ |
  | 1006 | 1057 | $this->rm\_folder\_recursively($value); |
  | 1007 | 1058 | } |
  | 1008 | 1059 | } |
  | 1009 | 1060 | } |
  | 1010 | 1061 |  |
  | 1011 | 1062 | $this->delete\_multiple\_domain\_mapping\_cache(); |
  | 1012 | 1063 |  |
  | 1013 | 1064 | die(json\_encode(array("The cache of page has been cleared","success"))); |
  | 1014 | 1065 | }else{ |
  | 1015 | 1066 | die(json\_encode(array("Path has NOT been defined", "error", "alert"))); |
  | 1016 | 1067 | } |
  | 1017 | 1068 |  |
  | 1018 | 1069 | exit; |
  | 1019 | 1070 | } |
  | 1020 | 1071 |  |
  | 1021 | 1072 | private function cache(){ |
  | 1022 | 1073 | if(isset($\_SERVER['HTTP\_HOST']) && $\_SERVER['HTTP\_HOST']){ |
  | 1023 | 1074 | include\_once('inc/cache.php'); |
  | 1024 | 1075 | $wpfc = new WpFastestCacheCreateCache(); |
  | 1025 | 1076 | $wpfc->createCache(); |
  | 1026 | 1077 | } |
  | 1027 | 1078 | } |
  | 1028 | 1079 |  |
  | 1029 | 1080 | protected function slug(){ |
  | 1030 | 1081 | return "wp\_fastest\_cache"; |
  | 1031 | 1082 | } |
  | 1032 | 1083 |  |
  | 1033 | 1084 | public function getWpContentDir($path = false){ |
  | 1034 | 1085 | /\* |
  | 1035 | 1086 | Sample Paths; |
  | 1036 | 1087 |  |
  | 1037 | 1088 | /cache/ |
  | 1038 | 1089 |  |
  | 1039 | 1090 | /cache/all/ |
  | 1040 | 1091 | /cache/all |
  | 1041 | 1092 | /cache/all/page |
  | 1042 | 1093 | /cache/all/index.html |
  | 1043 | 1094 |  |
  | 1044 | 1095 | /cache/wpfc-minified |
  | 1045 | 1096 |  |
  | 1046 | 1097 | /cache/wpfc-widget-cache |
  | 1047 | 1098 |  |
  | 1048 | 1099 | /cache/wpfc-mobile-cache/ |
  | 1049 | 1100 | /cache/wpfc-mobile-cache/page |
  | 1050 | 1101 | /cache/wpfc-mobile-cache/index.html |
  | 1051 | 1102 |  |
  | 1052 | 1103 | /cache/tmpWpfc |
  | 1053 | 1104 | /cache/tmpWpfc/ |
  | 1054 | 1105 | /cache/tmpWpfc/mobile\_ |
  | 1055 | 1106 | /cache/tmpWpfc/m |
  | 1056 | 1107 | /cache/tmpWpfc/w |
  | 1057 | 1108 |  |
  | 1058 | 1109 |  |
  | 1059 | 1110 | /cache/testWpFc/ |
  | 1060 | 1111 |  |
  | 1061 | 1112 | /cache/all/testWpFc/ |
  | 1062 | 1113 |  |
  | 1063 | 1114 | /cache/wpfc-widget-cache/ |
  | 1064 | 1115 | /cache/wpfc-widget-cache |
  | 1065 | 1116 | /cache/wpfc-widget-cache/".$args["widget\_id"].".html |
  | 1066 | 1117 | \*/ |
  | 1067 | 1118 |  |
  | 1068 | 1119 | if($path){ |
  | 1069 | 1120 | if(preg\_match("/\/cache\/(all|wpfc-minified|wpfc-widget-cache|wpfc-mobile-cache)/", $path)){ |
  | 1070 | 1121 | //WPML language switch |
  | 1071 | 1122 | //https://wpml.org/forums/topic/wpml-language-switch-wp-fastest-cache-issue/ |
  | 1072 | 1123 | $language\_negotiation\_type = apply\_filters('wpml\_setting', false, 'language\_negotiation\_type'); |
  | 1073 | 1124 | if(($language\_negotiation\_type == 2) && $this->isPluginActive('sitepress-multilingual-cms/sitepress.php')){ |
  | 1074 | 1125 | $my\_home\_url = apply\_filters('wpml\_home\_url', get\_option('home')); |
  | 1075 | 1126 | $my\_home\_url = preg\_replace("/https?\:\/\//i", "", $my\_home\_url); |
  | 1076 | 1127 | $my\_home\_url = trim($my\_home\_url, "/"); |
  | 1077 | 1128 |  |
  | 1078 | 1129 | $path = preg\_replace("/\/cache\/(all|wpfc-minified|wpfc-widget-cache|wpfc-mobile-cache)/", "/cache/".$my\_home\_url."/$1", $path); |
  | 1079 | 1130 | }else if(($language\_negotiation\_type == 1) && $this->isPluginActive('sitepress-multilingual-cms/sitepress.php')){ |
  | 1080 | 1131 | $my\_current\_lang = apply\_filters('wpml\_current\_language', NULL); |
  | 1081 | 1132 |  |
  | 1082 | 1133 | if($my\_current\_lang){ |
  | 1083 | 1134 | $path = preg\_replace("/\/cache\/wpfc-widget-cache\/(.+)/", "/cache/wpfc-widget-cache/".$my\_current\_lang."-"."$1", $path); |
  | 1084 | 1135 | } |
  | 1085 | 1136 | } |
  | 1086 | 1137 |  |
  | 1087 | 1138 | if($this->isPluginActive('multiple-domain-mapping-on-single-site/multidomainmapping.php')){ |
  | 1088 | 1139 | $path = preg\_replace("/\/cache\/(all|wpfc-minified|wpfc-widget-cache|wpfc-mobile-cache)/", "/cache/".$\_SERVER['HTTP\_HOST']."/$1", $path); |
  | 1089 | 1140 | } |
  | 1090 | 1141 |  |
  | 1091 | 1142 | if($this->isPluginActive('polylang/polylang.php')){ |
  | 1092 | 1143 | $path = preg\_replace("/\/cache\/(all|wpfc-minified|wpfc-widget-cache|wpfc-mobile-cache)/", "/cache/".$\_SERVER['HTTP\_HOST']."/$1", $path); |
  | 1093 | 1144 | } |
  | 1094 | 1145 |  |
  | 1095 | 1146 | if($this->isPluginActive('multiple-domain/multiple-domain.php')){ |
  | 1096 | 1147 | $path = preg\_replace("/\/cache\/(all|wpfc-minified|wpfc-widget-cache|wpfc-mobile-cache)/", "/cache/".$\_SERVER['HTTP\_HOST']."/$1", $path); |
  | 1097 | 1148 | } |
  | 1098 | 1149 |  |
  | 1099 | 1150 | if(is\_multisite()){ |
  | 1100 | 1151 | $path = preg\_replace("/\/cache\/(all|wpfc-minified|wpfc-widget-cache|wpfc-mobile-cache)/", "/cache/".$\_SERVER['HTTP\_HOST']."/$1", $path); |
  | 1101 | 1152 | } |
  | 1102 | 1153 | } |
  | 1103 | 1154 |  |
  | 1104 | 1155 | return WPFC\_WP\_CONTENT\_DIR.$path; |
  | 1105 | 1156 | }else{ |
  | 1106 | 1157 | return WPFC\_WP\_CONTENT\_DIR; |
  | 1107 | 1158 | } |
  | 1108 | 1159 | } |
  | 1109 | 1160 |  |
  | 1110 | 1161 | protected function getOptions(){ |
  | 1111 | 1162 | return $GLOBALS["wp\_fastest\_cache\_options"]; |
  | 1112 | 1163 | } |
  | 1113 | 1164 |  |
  | 1114 | 1165 | protected function getSystemMessage(){ |
  | 1115 | 1166 | return $this->systemMessage; |
  | 1116 | 1167 | } |
  | 1117 | 1168 |  |
  | 1118 | 1169 | protected function get\_excluded\_useragent(){ |
  | 1119 | 1170 | return "facebookexternalhit|WP\_FASTEST\_CACHE\_CSS\_VALIDATOR|Twitterbot|LinkedInBot|WhatsApp|Mediatoolkitbot"; |
  | 1120 | 1171 | } |
  | 1121 | 1172 |  |
  | 1122 | 1173 | // protected function detectNewPost(){ |
  | 1123 | 1174 | //  if(isset($this->options->wpFastestCacheNewPost) && isset($this->options->wpFastestCacheStatus)){ |
  | 1124 | 1175 | //      add\_filter ('save\_post', array($this, 'deleteCache')); |
  | 1125 | 1176 | //  } |
  | 1126 | 1177 | // } |
  | 1127 | 1178 |  |
  | 1128 | 1179 | public function deleteWidgetCache(){ |
  | 1129 | 1180 | $widget\_cache\_path = $this->getWpContentDir("/cache/wpfc-widget-cache"); |
  | 1130 | 1181 |  |
  | 1131 | 1182 | if(is\_dir($widget\_cache\_path)){ |
  | 1132 | 1183 | if(!is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 1133 | 1184 | if(@mkdir($this->getWpContentDir("/cache/tmpWpfc"), 0755, true)){ |
  | 1134 | 1185 | //tmpWpfc has been created |
  | 1135 | 1186 | } |
  | 1136 | 1187 | } |
  | 1137 | 1188 |  |
  | 1138 | 1189 | if(@rename($widget\_cache\_path, $this->getWpContentDir("/cache/tmpWpfc/w").time())){ |
  | 1139 | 1190 | //DONE |
  | 1140 | 1191 | } |
  | 1141 | 1192 | } |
  | 1142 | 1193 | } |
  | 1143 | 1194 |  |
  | 1144 | 1195 | public function clear\_cache\_after\_woocommerce\_update\_product($product\_id){ |
  | 1145 | 1196 | if(!$this->deleted\_before){ |
  | 1146 | 1197 | $this->singleDeleteCache(false, $product\_id); |
  | 1147 | 1198 | } |
  | 1148 | 1199 | } |
  | 1149 | 1200 |  |
  | 1150 | 1201 | public function on\_all\_status\_transitions($new\_status, $old\_status, $post){ |
  | 1151 | 1202 | $this->deleted\_before = true; |
  | 1152 | 1203 |  |
  | 1153 | 1204 | if(!wp\_is\_post\_revision($post->ID)){ |
  | 1154 | 1205 | if(isset($post->post\_type)){ |
  | 1155 | 1206 | if($post->post\_type == "nf\_sub"){ |
  | 1156 | 1207 | return 0; |
  | 1157 | 1208 | } |
  | 1158 | 1209 | } |
  | 1159 | 1210 |  |
  | 1160 | 1211 | if($new\_status == "publish" && $old\_status != "publish"){ |
  | 1161 | 1212 |  |
  | 1162 | 1213 | $this->specificDeleteCache(); |
  | 1163 | 1214 |  |
  | 1164 | 1215 | if(isset($this->options->wpFastestCacheNewPost) && isset($this->options->wpFastestCacheStatus)){ |
  | 1165 | 1216 | if(isset($this->options->wpFastestCacheNewPost\_type) && $this->options->wpFastestCacheNewPost\_type){ |
  | 1166 | 1217 | if($this->options->wpFastestCacheNewPost\_type == "all"){ |
  | 1167 | 1218 | $this->deleteCache(); |
  | 1168 | 1219 | }else if($this->options->wpFastestCacheNewPost\_type == "homepage"){ |
  | 1169 | 1220 | $this->deleteHomePageCache(); |
  | 1170 | 1221 |  |
  | 1171 | 1222 | //to clear category cache and tag cache |
  | 1172 | 1223 | $this->singleDeleteCache(false, $post->ID); |
  | 1173 | 1224 |  |
  | 1174 | 1225 | //to clear widget cache |
  | 1175 | 1226 | $this->deleteWidgetCache(); |
  | 1176 | 1227 | } |
  | 1177 | 1228 | }else{ |
  | 1178 | 1229 | $this->deleteCache(); |
  | 1179 | 1230 | } |
  | 1180 | 1231 | } |
  | 1181 | 1232 | } |
  | 1182 | 1233 |  |
  | 1183 | 1234 | if(isset($this->options->wpFastestCacheStatus) && $new\_status == "publish" && $old\_status == "publish"){ |
  | 1184 | 1235 |  |
  | 1185 | 1236 | // if(isset($this->options->wpFastestCacheUpdatePost) && isset($this->options->wpFastestCacheStatus)){ |
  | 1186 | 1237 |  |
  | 1187 | 1238 | //  if($this->options->wpFastestCacheUpdatePost\_type == "post"){ |
  | 1188 | 1239 | //      $this->singleDeleteCache(false, $post->ID); |
  | 1189 | 1240 | //  }else if($this->options->wpFastestCacheUpdatePost\_type == "all"){ |
  | 1190 | 1241 | //      $this->deleteCache(); |
  | 1191 | 1242 | //  } |
  | 1192 | 1243 |  |
  | 1193 | 1244 | // } |
  | 1194 | 1245 |  |
  | 1195 | 1246 | $this->specificDeleteCache(); |
  | 1196 | 1247 |  |
  | 1197 | 1248 | if(isset($this->options->wpFastestCacheUpdatePost)){ |
  | 1198 | 1249 |  |
  | 1199 | 1250 | if($this->options->wpFastestCacheUpdatePost\_type == "post"){ |
  | 1200 | 1251 | $this->singleDeleteCache(false, $post->ID); |
  | 1201 | 1252 | }else if($this->options->wpFastestCacheUpdatePost\_type == "all"){ |
  | 1202 | 1253 | $this->deleteCache(); |
  | 1203 | 1254 | } |
  | 1204 | 1255 |  |
  | 1205 | 1256 | }else{ |
  | 1206 | 1257 | // to clear only cache of content even though the "update post" option is disabled |
  | 1207 | 1258 | $this->singleDeleteCache(false, $post->ID, false); |
  | 1208 | 1259 | } |
  | 1209 | 1260 | } |
  | 1210 | 1261 |  |
  | 1211 | 1262 | if($new\_status == "trash" && $old\_status == "publish"){ |
  | 1212 | 1263 | $this->singleDeleteCache(false, $post->ID); |
  | 1213 | 1264 | }else if(($new\_status == "draft" || $new\_status == "pending" || $new\_status == "private") && $old\_status == "publish"){ |
  | 1214 | 1265 | $this->deleteCache(); |
  | 1215 | 1266 | } |
  | 1216 | 1267 | } |
  | 1217 | 1268 | } |
  | 1218 | 1269 |  |
  | 1219 | 1270 | protected function commentHooks(){ |
  | 1220 | 1271 | //it works when the status of a comment changes |
  | 1221 | 1272 | add\_action('wp\_set\_comment\_status', array($this, 'singleDeleteCache'), 10, 1); |
  | 1222 | 1273 |  |
  | 1223 | 1274 | //it works when a comment is saved in the database |
  | 1224 | 1275 | add\_action('comment\_post', array($this, 'detectNewComment'), 10, 2); |
  | 1225 | 1276 |  |
  | 1226 | 1277 | // it work when a commens is updated |
  | 1227 | 1278 | add\_action('edit\_comment', array($this, 'detectEditComment'), 10, 2); |
  | 1228 | 1279 | } |
  | 1229 | 1280 |  |
  | 1230 | 1281 | public function detectEditComment($comment\_id, $comment\_data){ |
  | 1231 | 1282 | if($comment\_data["comment\_approved"] == 1){ |
  | 1232 | 1283 | $this->singleDeleteCache($comment\_id); |
  | 1233 | 1284 | } |
  | 1234 | 1285 | } |
  | 1235 | 1286 |  |
  | 1236 | 1287 | public function detectNewComment($comment\_id, $comment\_approved){ |
  | 1237 | 1288 | // if(current\_user\_can( 'manage\_options') || !get\_option('comment\_moderation')){ |
  | 1238 | 1289 | if($comment\_approved === 1){ |
  | 1239 | 1290 | $this->singleDeleteCache($comment\_id); |
  | 1240 | 1291 | } |
  | 1241 | 1292 | } |
  | 1242 | 1293 |  |
  | 1243 | 1294 | public function specificDeleteCache(){ |
  | 1244 | 1295 | $urls = get\_option("WpFastestCacheCSP"); |
  | 1245 | 1296 | $files = array(); |
  | 1246 | 1297 |  |
  | 1247 | 1298 | if(!empty($urls)){ |
  | 1248 | 1299 | foreach ($urls as $key => $value) { |
  | 1249 | 1300 |  |
  | 1250 | 1301 | if(preg\_match("/https?:\/\/[^\/]+\/(.+)/", $value->url, $out)){ |
  | 1251 | 1302 |  |
  | 1252 | 1303 | if(preg\_match("/\/\(\.\\*\)/", $out[1])){ |
  | 1253 | 1304 | $out[1] = str\_replace("(.\*)", "", $out[1]); |
  | 1254 | 1305 |  |
  | 1255 | 1306 | $path = $this->getWpContentDir("/cache/all/").$out[1]; |
  | 1256 | 1307 | $mobile\_path = $this->getWpContentDir("/cache/wpfc-mobile-cache/").$out[1]; |
  | 1257 | 1308 | }else{ |
  | 1258 | 1309 | $out[1] = $out[1]."index.html"; |
  | 1259 | 1310 |  |
  | 1260 | 1311 | $path = $this->getWpContentDir("/cache/all/").$out[1]; |
  | 1261 | 1312 | $mobile\_path = $this->getWpContentDir("/cache/wpfc-mobile-cache/").$out[1]; |
  | 1262 | 1313 | } |
  | 1263 | 1314 |  |
  | 1264 | 1315 | if(!is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 1265 | 1316 | @mkdir($this->getWpContentDir("/cache/tmpWpfc"), 0755, true); |
  | 1266 | 1317 | } |
  | 1267 | 1318 |  |
  | 1268 | 1319 |  |
  | 1269 | 1320 | rename($path, $this->getWpContentDir("/cache/tmpWpfc/").time()); |
  | 1270 | 1321 | rename($mobile\_path, $this->getWpContentDir("/cache/tmpWpfc/mobile\_").time()); |
  | 1271 | 1322 |  |
  | 1272 | 1323 | } |
  | 1273 | 1324 |  |
  | 1274 | 1325 | } |
  | 1275 | 1326 | } |
  | 1276 | 1327 | } |
  | 1277 | 1328 |  |
  | 1278 | 1329 | public function singleDeleteCache($comment\_id = false, $post\_id = false, $to\_clear\_parents = true){ |
  | 1279 | 1330 | if($varnish\_datas = get\_option("WpFastestCacheVarnish")){ |
  | 1280 | 1331 | include\_once('inc/varnish.php'); |
  | 1281 | 1332 | VarnishWPFC::purge\_cache($varnish\_datas); |
  | 1282 | 1333 | } |
  | 1283 | 1334 |  |
  | 1284 | 1335 | include\_once('inc/cdn.php'); |
  | 1285 | 1336 | CdnWPFC::cloudflare\_clear\_cache(); |
  | 1286 | 1337 |  |
  | 1287 | 1338 | $to\_clear\_feed = true; |
  | 1288 | 1339 |  |
  | 1289 | 1340 | // not to clear cache of homepage/cats/tags after ajax request by other plugins |
  | 1290 | 1341 | if(isset($\_POST) && isset($\_POST["action"])){ |
  | 1291 | 1342 | // kk Star Rating |
  | 1292 | 1343 | if($\_POST["action"] == "kksr\_ajax"){ |
  | 1293 | 1344 | $to\_clear\_parents = false; |
  | 1294 | 1345 | } |
  | 1295 | 1346 |  |
  | 1296 | 1347 | // All In One Schema.org Rich Snippets |
  | 1297 | 1348 | if(preg\_match("/bsf\_(update|submit)\_rating/i", $\_POST["action"])){ |
  | 1298 | 1349 | $to\_clear\_parents = false; |
  | 1299 | 1350 | } |
  | 1300 | 1351 |  |
  | 1301 | 1352 | // Yet Another Stars Rating |
  | 1302 | 1353 | if($\_POST["action"] == "yasr\_send\_visitor\_rating"){ |
  | 1303 | 1354 | $to\_clear\_parents = false; |
  | 1304 | 1355 | $post\_id = sanitize\_text\_field($\_POST["post\_id"]); |
  | 1305 | 1356 | } |
  | 1306 | 1357 |  |
  | 1307 | 1358 | // All In One Schema.org Rich Snippets |
  | 1308 | 1359 | if(preg\_match("/bsf\_(update|submit)\_rating/i", $\_POST["action"])){ |
  | 1309 | 1360 | $to\_clear\_feed = false; |
  | 1310 | 1361 | } |
  | 1311 | 1362 | } |
  | 1312 | 1363 |  |
  | 1313 | 1364 | if($comment\_id){ |
  | 1314 | 1365 | $comment\_id = intval($comment\_id); |
  | 1315 | 1366 |  |
  | 1316 | 1367 | $comment = get\_comment($comment\_id); |
  | 1317 | 1368 |  |
  | 1318 | 1369 | if($comment && $comment->comment\_post\_ID){ |
  | 1319 | 1370 | $post\_id = $comment->comment\_post\_ID; |
  | 1320 | 1371 | } |
  | 1321 | 1372 | } |
  | 1322 | 1373 |  |
  | 1323 | 1374 | if($post\_id){ |
  | 1324 | 1375 | $post\_id = intval($post\_id); |
  | 1325 | 1376 |  |
  | 1326 | 1377 | $permalink = get\_permalink($post\_id); |
  | 1327 | 1378 |  |
  | 1328 | 1379 | $permalink = urldecode(get\_permalink($post\_id)); |
  | 1329 | 1380 |  |
  | 1330 | 1381 |  |
  | 1331 | 1382 |  |
  | 1332 | 1383 | //for trash contents |
  | 1333 | 1384 | if(preg\_match("/\/\?p\=\d+/i", $permalink)){ |
  | 1334 | 1385 | $post = get\_post($post\_id); |
  | 1335 | 1386 |  |
  | 1336 | 1387 | $clone\_post = clone $post; |
  | 1337 | 1388 | $clone\_post->post\_status = 'publish'; |
  | 1338 | 1389 |  |
  | 1339 | 1390 | $permalink = get\_permalink($clone\_post); |
  | 1340 | 1391 | $permalink = rtrim($permalink, "/"); |
  | 1341 | 1392 |  |
  | 1342 | 1393 | $permalink = preg\_replace("/\_\_trashed$/", "", $permalink); |
  | 1343 | 1394 | //for /%postname%/%post\_id% : sample-url\_\_trashed/57595 |
  | 1344 | 1395 | $permalink = preg\_replace("/\_\_trashed\/(\d+)$/", "/$1", $permalink); |
  | 1345 | 1396 | } |
  | 1346 | 1397 |  |
  | 1347 | 1398 |  |
  | 1348 | 1399 |  |
  | 1349 | 1400 | if(preg\_match("/https?:\/\/[^\/]+\/(.+)/", $permalink, $out)){ |
  | 1350 | 1401 | $path = $this->getWpContentDir("/cache/all/").$out[1]; |
  | 1351 | 1402 | $mobile\_path = $this->getWpContentDir("/cache/wpfc-mobile-cache/").$out[1]; |
  | 1352 | 1403 |  |
  | 1353 | 1404 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 1354 | 1405 | include\_once $this->get\_premium\_path("logs.php"); |
  | 1355 | 1406 | $log = new WpFastestCacheLogs("delete"); |
  | 1356 | 1407 | $log->action(); |
  | 1357 | 1408 | } |
  | 1358 | 1409 |  |
  | 1359 | 1410 | $files = array(); |
  | 1360 | 1411 |  |
  | 1361 | 1412 | if(is\_dir($path)){ |
  | 1362 | 1413 | array\_push($files, $path); |
  | 1363 | 1414 | } |
  | 1364 | 1415 |  |
  | 1365 | 1416 | if(is\_dir($mobile\_path)){ |
  | 1366 | 1417 | array\_push($files, $mobile\_path); |
  | 1367 | 1418 | } |
  | 1368 | 1419 |  |
  | 1369 | 1420 | if(defined('WPFC\_CACHE\_QUERYSTRING') && WPFC\_CACHE\_QUERYSTRING){ |
  | 1370 | 1421 | $files\_with\_query\_string = glob($path."\?\*"); |
  | 1371 | 1422 | $mobile\_files\_with\_query\_string = glob($mobile\_path."\?\*"); |
  | 1372 | 1423 |  |
  | 1373 | 1424 | if(is\_array($files\_with\_query\_string) && (count($files\_with\_query\_string) > 0)){ |
  | 1374 | 1425 | $files = array\_merge($files, $files\_with\_query\_string); |
  | 1375 | 1426 | } |
  | 1376 | 1427 |  |
  | 1377 | 1428 | if(is\_array($mobile\_files\_with\_query\_string) && (count($mobile\_files\_with\_query\_string) > 0)){ |
  | 1378 | 1429 | $files = array\_merge($files, $mobile\_files\_with\_query\_string); |
  | 1379 | 1430 | } |
  | 1380 | 1431 | } |
  | 1381 | 1432 |  |
  | 1382 | 1433 | if($to\_clear\_feed){ |
  | 1383 | 1434 | // to clear cache of /feed |
  | 1384 | 1435 | if(preg\_match("/https?:\/\/[^\/]+\/(.+)/", get\_feed\_link(), $feed\_out)){ |
  | 1385 | 1436 | array\_push($files, $this->getWpContentDir("/cache/all/").$feed\_out[1]); |
  | 1386 | 1437 | } |
  | 1387 | 1438 |  |
  | 1388 | 1439 | // to clear cache of /comments/feed/ |
  | 1389 | 1440 | if(preg\_match("/https?:\/\/[^\/]+\/(.+)/", get\_feed\_link("comments\_"), $comment\_feed\_out)){ |
  | 1390 | 1441 | array\_push($files, $this->getWpContentDir("/cache/all/").$comment\_feed\_out[1]); |
  | 1391 | 1442 | } |
  | 1392 | 1443 | } |
  | 1393 | 1444 |  |
  | 1394 | 1445 | foreach((array)$files as $file){ |
  | 1395 | 1446 | $this->rm\_folder\_recursively($file); |
  | 1396 | 1447 | } |
  | 1397 | 1448 | } |
  | 1398 | 1449 |  |
  | 1399 | 1450 | if($to\_clear\_parents){ |
  | 1400 | 1451 | // to clear cache of homepage |
  | 1401 | 1452 | $this->deleteHomePageCache(); |
  | 1402 | 1453 |  |
  | 1403 | 1454 | // to clear cache of author page |
  | 1404 | 1455 | $this->delete\_author\_page\_cache($post\_id); |
  | 1405 | 1456 |  |
  | 1406 | 1457 | // to clear sitemap cache |
  | 1407 | 1458 | $this->delete\_sitemap\_cache(); |
  | 1408 | 1459 |  |
  | 1409 | 1460 | // to clear cache of next post and cache of prev post |
  | 1410 | 1461 | $this->delete\_next\_prev\_cache($post\_id); |
  | 1411 | 1462 |  |
  | 1412 | 1463 | // to clear cache of cats and  tags which contains the post (only first page) |
  | 1413 | 1464 | global $wpdb; |
  | 1414 | 1465 | $terms = $wpdb->get\_results("SELECT \* FROM `".$wpdb->prefix."term\_relationships` WHERE `object\_id`=".$post\_id, ARRAY\_A); |
  | 1415 | 1466 |  |
  | 1416 | 1467 | foreach ($terms as $term\_key => $term\_val){ |
  | 1417 | 1468 | $this->delete\_cache\_of\_term($term\_val["term\_taxonomy\_id"]); |
  | 1418 | 1469 | } |
  | 1419 | 1470 | } |
  | 1420 | 1471 |  |
  | 1421 | 1472 | $this->delete\_multiple\_domain\_mapping\_cache(); |
  | 1422 | 1473 | } |
  | 1423 | 1474 | } |
  | 1424 | 1475 |  |
  | 1425 | 1476 | public function delete\_next\_prev\_cache($post\_id){ |
  | 1426 | 1477 | global $wpdb; |
  | 1427 | 1478 |  |
  | 1428 | 1479 | $post = get\_post($post\_id); |
  | 1429 | 1480 |  |
  | 1430 | 1481 | $next\_post\_query = "SELECT \* FROM `".$wpdb->prefix."posts` WHERE ID = (SELECT min(ID) FROM `".$wpdb->prefix."posts` where ID > ".$post\_id." AND `post\_type` = '".$post->post\_type."' AND `post\_status` = 'publish')"; |
  | 1431 | 1482 | $prev\_post\_query = "SELECT \* FROM `".$wpdb->prefix."posts` WHERE ID = (SELECT max(ID) FROM `".$wpdb->prefix."posts` where ID < ".$post\_id." AND `post\_type` = '".$post->post\_type."' AND `post\_status` = 'publish')"; |
  | 1432 | 1483 |  |
  | 1433 | 1484 | $res = $wpdb->get\_results($next\_post\_query." UNION ".$prev\_post\_query); |
  | 1434 | 1485 |  |
  | 1435 | 1486 | if(isset($res[0])){ |
  | 1436 | 1487 |  |
  | 1437 | 1488 | foreach ($res as $key => $value) { |
  | 1438 | 1489 | $permalink = urldecode(get\_permalink($value->ID)); |
  | 1439 | 1490 |  |
  | 1440 | 1491 | if(preg\_match("/https?:\/\/[^\/]+\/(.+)/", $permalink, $out)){ |
  | 1441 | 1492 | $path = $this->getWpContentDir("/cache/all/").$out[1]; |
  | 1442 | 1493 | $mobile\_path = $this->getWpContentDir("/cache/wpfc-mobile-cache/").$out[1]; |
  | 1443 | 1494 |  |
  | 1444 | 1495 | if(is\_dir($path)){ |
  | 1445 | 1496 | $this->rm\_folder\_recursively($path); |
  | 1446 | 1497 | } |
  | 1447 | 1498 |  |
  | 1448 | 1499 | if(is\_dir($mobile\_path)){ |
  | 1449 | 1500 | $this->rm\_folder\_recursively($mobile\_path); |
  | 1450 | 1501 | } |
  | 1451 | 1502 | } |
  | 1452 | 1503 | } |
  | 1453 | 1504 |  |
  | 1454 | 1505 | } |
  | 1455 | 1506 |  |
  | 1456 | 1507 |  |
  | 1457 | 1508 | } |
  | 1458 | 1509 |  |
  | 1459 | 1510 | public function delete\_sitemap\_cache(){ |
  | 1460 | 1511 | //to clear sitemap.xml and sitemap-(.+).xml |
  | 1461 | 1512 | $files = array\_merge(glob($this->getWpContentDir("/cache/all/")."sitemap\*.xml"), glob($this->getWpContentDir("/cache/wpfc-mobile-cache/")."sitemap\*.xml")); |
  | 1462 | 1513 |  |
  | 1463 | 1514 | foreach((array)$files as $file){ |
  | 1464 | 1515 | $this->rm\_folder\_recursively($file); |
  | 1465 | 1516 | } |
  | 1466 | 1517 | } |
  | 1467 | 1518 |  |
  | 1468 | 1519 | public function delete\_multiple\_domain\_mapping\_cache($minified = false){ |
  | 1469 | 1520 | //https://wordpress.org/plugins/multiple-domain-mapping-on-single-site/ |
  | 1470 | 1521 | if($this->isPluginActive("multiple-domain-mapping-on-single-site/multidomainmapping.php")){ |
  | 1471 | 1522 | $multiple\_arr = get\_option('falke\_mdm\_mappings'); |
  | 1472 | 1523 |  |
  | 1473 | 1524 | if(isset($multiple\_arr) && isset($multiple\_arr["mappings"]) && isset($multiple\_arr["mappings"][0])){ |
  | 1474 | 1525 | foreach($multiple\_arr["mappings"] as $mapping\_key => $mapping\_value){ |
  | 1475 | 1526 | if($minified){ |
  | 1476 | 1527 | $mapping\_domain\_path = preg\_replace("/(\/cache\/[^\/]+\/all\/)/", "/cache/".$mapping\_value["domain"]."/", $this->getWpContentDir("/cache/all/")); |
  | 1477 | 1528 |  |
  | 1478 | 1529 | if(is\_dir($mapping\_domain\_path)){ |
  | 1479 | 1530 | if(@rename($mapping\_domain\_path, $this->getWpContentDir("/cache/tmpWpfc/").$mapping\_value["domain"]."\_".time())){ |
  | 1480 | 1531 |  |
  | 1481 | 1532 | } |
  | 1482 | 1533 | } |
  | 1483 | 1534 | }else{ |
  | 1484 | 1535 | $mapping\_domain\_path = preg\_replace("/(\/cache\/[^\/]+\/all)/", "/cache/".$mapping\_value["domain"]."/all", $this->getWpContentDir("/cache/all/index.html")); |
  | 1485 | 1536 |  |
  | 1486 | 1537 | @unlink($mapping\_domain\_path); |
  | 1487 | 1538 | } |
  | 1488 | 1539 | } |
  | 1489 | 1540 | } |
  | 1490 | 1541 | } |
  | 1491 | 1542 | } |
  | 1492 | 1543 |  |
  | 1493 | 1544 | public function delete\_author\_page\_cache($post\_id){ |
  | 1494 | 1545 | $author\_id = get\_post\_field ('post\_author', $post\_id); |
  | 1495 | 1546 | $permalink = get\_author\_posts\_url($author\_id); |
  | 1496 | 1547 |  |
  | 1497 | 1548 | if(preg\_match("/https?:\/\/[^\/]+\/(.+)/", $permalink, $out)){ |
  | 1498 | 1549 | $path = $this->getWpContentDir("/cache/all/").$out[1]; |
  | 1499 | 1550 | $mobile\_path = $this->getWpContentDir("/cache/wpfc-mobile-cache/").$out[1]; |
  | 1500 | 1551 |  |
  | 1501 | 1552 | $this->move\_folder\_to\_tmpWpfc($path); |
  | 1502 | 1553 | $this->move\_folder\_to\_tmpWpfc($mobile\_path); |
  | 1503 | 1554 | } |
  | 1504 | 1555 | } |
  | 1505 | 1556 |  |
  | 1506 | 1557 | public function move\_folder\_to\_tmpWpfc($path = false){ |
  | 1507 | 1558 | if(!is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 1508 | 1559 | @mkdir($this->getWpContentDir("/cache/tmpWpfc"), 0755, true); |
  | 1509 | 1560 | } |
  | 1510 | 1561 |  |
  | 1511 | 1562 | if(!$path){ |
  | 1512 | 1563 | return false; |
  | 1513 | 1564 | } |
  | 1514 | 1565 |  |
  | 1515 | 1566 | if(!is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 1516 | 1567 | return false; |
  | 1517 | 1568 | } |
  | 1518 | 1569 |  |
  | 1519 | 1570 | if(is\_dir($path)){ |
  | 1520 | 1571 | preg\_match("/\/([^\/]+)\/?$/", $path, $type); |
  | 1521 | 1572 |  |
  | 1522 | 1573 | if(isset($type[1])){ |
  | 1523 | 1574 | if(preg\_match("/\/cache\/wpfc-mobile-cache\//", $path)){ |
  | 1524 | 1575 | $type[1] = "m\_".$type[1]; |
  | 1525 | 1576 | } |
  | 1526 | 1577 |  |
  | 1527 | 1578 | $move\_to = $this->getWpContentDir("/cache/tmpWpfc/").$type[1]."\_".time(); |
  | 1528 | 1579 |  |
  | 1529 | 1580 | rename($path, $move\_to); |
  | 1530 | 1581 | } |
  | 1531 | 1582 | } |
  | 1532 | 1583 | } |
  | 1533 | 1584 |  |
  | 1534 | 1585 | public function delete\_cache\_of\_term($term\_taxonomy\_id){ |
  | 1535 | 1586 | $term = get\_term\_by("term\_taxonomy\_id", $term\_taxonomy\_id); |
  | 1536 | 1587 |  |
  | 1537 | 1588 | if(!$term || is\_wp\_error($term)){ |
  | 1538 | 1589 | return false; |
  | 1539 | 1590 | } |
  | 1540 | 1591 |  |
  | 1541 | 1592 | //if(preg\_match("/cat|tag|store|listing/", $term->taxonomy)){} |
  | 1542 | 1593 |  |
  | 1543 | 1594 | $url = get\_term\_link($term->term\_id, $term->taxonomy); |
  | 1544 | 1595 |  |
  | 1545 | 1596 | if(preg\_match("/^http/", $url)){ |
  | 1546 | 1597 | $path = preg\_replace("/https?\:\/\/[^\/]+/i", "", $url); |
  | 1547 | 1598 | $path = trim($path, "/"); |
  | 1548 | 1599 | $path = urldecode($path); |
  | 1549 | 1600 |  |
  | 1550 | 1601 | // to remove the cache of tag/cat |
  | 1551 | 1602 | if(file\_exists($this->getWpContentDir("/cache/all/").$path."/index.html")){ |
  | 1552 | 1603 | @unlink($this->getWpContentDir("/cache/all/").$path."/index.html"); |
  | 1553 | 1604 | } |
  | 1554 | 1605 |  |
  | 1555 | 1606 | if(file\_exists($this->getWpContentDir("/cache/wpfc-mobile-cache/").$path."/index.html")){ |
  | 1556 | 1607 | @unlink($this->getWpContentDir("/cache/wpfc-mobile-cache/").$path."/index.html"); |
  | 1557 | 1608 | } |
  | 1558 | 1609 |  |
  | 1559 | 1610 |  |
  | 1560 | 1611 | // to remove the cache of the pages |
  | 1561 | 1612 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/all/").$path."/page"); |
  | 1562 | 1613 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/wpfc-mobile-cache/").$path."/page"); |
  | 1563 | 1614 |  |
  | 1564 | 1615 | // to remove the cache of the feeds |
  | 1565 | 1616 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/all/").$path."/feed"); |
  | 1566 | 1617 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/wpfc-mobile-cache/").$path."/feed"); |
  | 1567 | 1618 | } |
  | 1568 | 1619 |  |
  | 1569 | 1620 | if($term->parent > 0){ |
  | 1570 | 1621 | $parent = get\_term\_by("id", $term->parent, $term->taxonomy); |
  | 1571 | 1622 | $this->delete\_cache\_of\_term($parent->term\_taxonomy\_id); |
  | 1572 | 1623 | } |
  | 1573 | 1624 | } |
  | 1574 | 1625 |  |
  | 1575 | 1626 | public function unlink($path){ |
  | 1576 | 1627 | if(file\_exists($path)){ |
  | 1577 | 1628 | unlink($path); |
  | 1578 | 1629 | } |
  | 1579 | 1630 | } |
  | 1580 | 1631 |  |
  | 1581 | 1632 | public function deleteHomePageCache($log = true){ |
  | 1582 | 1633 | if($varnish\_datas = get\_option("WpFastestCacheVarnish")){ |
  | 1583 | 1634 | include\_once('inc/varnish.php'); |
  | 1584 | 1635 | VarnishWPFC::purge\_cache($varnish\_datas); |
  | 1585 | 1636 | } |
  | 1586 | 1637 |  |
  | 1587 | 1638 | include\_once('inc/cdn.php'); |
  | 1588 | 1639 | CdnWPFC::cloudflare\_clear\_cache(); |
  | 1589 | 1640 |  |
  | 1590 | 1641 | $site\_url\_path = preg\_replace("/https?\:\/\/[^\/]+/i", "", site\_url()); |
  | 1591 | 1642 | $home\_url\_path = preg\_replace("/https?\:\/\/[^\/]+/i", "", home\_url()); |
  | 1592 | 1643 |  |
  | 1593 | 1644 | if($site\_url\_path){ |
  | 1594 | 1645 | $site\_url\_path = trim($site\_url\_path, "/"); |
  | 1595 | 1646 |  |
  | 1596 | 1647 | if($site\_url\_path){ |
  | 1597 | 1648 | $this->unlink($this->getWpContentDir("/cache/all/").$site\_url\_path."/index.html"); |
  | 1598 | 1649 | $this->unlink($this->getWpContentDir("/cache/wpfc-mobile-cache/").$site\_url\_path."/index.html"); |
  | 1599 | 1650 |  |
  | 1600 | 1651 | //to clear pagination of homepage cache |
  | 1601 | 1652 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/all/").$site\_url\_path."/page"); |
  | 1602 | 1653 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/wpfc-mobile-cache/").$site\_url\_path."/page"); |
  | 1603 | 1654 | } |
  | 1604 | 1655 | } |
  | 1605 | 1656 |  |
  | 1606 | 1657 | if($home\_url\_path){ |
  | 1607 | 1658 | $home\_url\_path = trim($home\_url\_path, "/"); |
  | 1608 | 1659 |  |
  | 1609 | 1660 | if($home\_url\_path){ |
  | 1610 | 1661 | $this->unlink($this->getWpContentDir("/cache/all/").$home\_url\_path."/index.html"); |
  | 1611 | 1662 | $this->unlink($this->getWpContentDir("/cache/wpfc-mobile-cache/").$home\_url\_path."/index.html"); |
  | 1612 | 1663 |  |
  | 1613 | 1664 | //to clear pagination of homepage cache |
  | 1614 | 1665 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/all/").$home\_url\_path."/page"); |
  | 1615 | 1666 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/wpfc-mobile-cache/").$home\_url\_path."/page"); |
  | 1616 | 1667 | } |
  | 1617 | 1668 | } |
  | 1618 | 1669 |  |
  | 1619 | 1670 | if(function\_exists("wc\_get\_page\_id")){ |
  | 1620 | 1671 | if($shop\_id = wc\_get\_page\_id('shop')){ |
  | 1621 | 1672 | $store\_url\_path = preg\_replace("/https?\:\/\/[^\/]+/i", "", get\_permalink($shop\_id)); |
  | 1622 | 1673 |  |
  | 1623 | 1674 | if($store\_url\_path){ |
  | 1624 | 1675 | $store\_url\_path = trim($store\_url\_path, "/"); |
  | 1625 | 1676 |  |
  | 1626 | 1677 | if($store\_url\_path){ |
  | 1627 | 1678 | if(file\_exists($this->getWpContentDir("/cache/all/").$store\_url\_path."/index.html")){ |
  | 1628 | 1679 | @unlink($this->getWpContentDir("/cache/all/").$store\_url\_path."/index.html"); |
  | 1629 | 1680 | } |
  | 1630 | 1681 |  |
  | 1631 | 1682 | if(file\_exists($this->getWpContentDir("/cache/wpfc-mobile-cache/").$store\_url\_path."/index.html")){ |
  | 1632 | 1683 | @unlink($this->getWpContentDir("/cache/wpfc-mobile-cache/").$store\_url\_path."/index.html"); |
  | 1633 | 1684 | } |
  | 1634 | 1685 |  |
  | 1635 | 1686 | //to clear pagination of store homepage cache |
  | 1636 | 1687 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/all/").$store\_url\_path."/page"); |
  | 1637 | 1688 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/wpfc-mobile-cache/").$store\_url\_path."/page"); |
  | 1638 | 1689 | } |
  | 1639 | 1690 | } |
  | 1640 | 1691 | } |
  | 1641 | 1692 | } |
  | 1642 | 1693 |  |
  | 1643 | 1694 | $this->unlink($this->getWpContentDir("/cache/all/index.html")); |
  | 1644 | 1695 | $this->unlink($this->getWpContentDir("/cache/wpfc-mobile-cache/index.html")); |
  | 1645 | 1696 |  |
  | 1646 | 1697 | //to clear pagination of homepage cache |
  | 1647 | 1698 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/all/page")); |
  | 1648 | 1699 | $this->rm\_folder\_recursively($this->getWpContentDir("/cache/wpfc-mobile-cache/page")); |
  | 1649 | 1700 |  |
  | 1650 | 1701 | // options-reading.php - static posts page |
  | 1651 | 1702 | if($page\_for\_posts\_id = get\_option('page\_for\_posts')){ |
  | 1652 | 1703 | $page\_for\_posts\_permalink = urldecode(get\_permalink($page\_for\_posts\_id)); |
  | 1653 | 1704 |  |
  | 1654 | 1705 | $page\_for\_posts\_permalink = rtrim($page\_for\_posts\_permalink, "/"); |
  | 1655 | 1706 | $page\_for\_posts\_permalink = preg\_replace("/\_\_trashed$/", "", $page\_for\_posts\_permalink); |
  | 1656 | 1707 | //for /%postname%/%post\_id% : sample-url\_\_trashed/57595 |
  | 1657 | 1708 | $page\_for\_posts\_permalink = preg\_replace("/\_\_trashed\/(\d+)$/", "/$1", $page\_for\_posts\_permalink); |
  | 1658 | 1709 |  |
  | 1659 | 1710 | if(preg\_match("/https?:\/\/[^\/]+\/(.+)/", $page\_for\_posts\_permalink, $out)){ |
  | 1660 | 1711 | $page\_for\_posts\_path = $this->getWpContentDir("/cache/all/").$out[1]; |
  | 1661 | 1712 | $page\_for\_posts\_mobile\_path = $this->getWpContentDir("/cache/wpfc-mobile-cache/").$out[1]; |
  | 1662 | 1713 |  |
  | 1663 | 1714 | $this->rm\_folder\_recursively($page\_for\_posts\_path); |
  | 1664 | 1715 | $this->rm\_folder\_recursively($page\_for\_posts\_mobile\_path); |
  | 1665 | 1716 | } |
  | 1666 | 1717 | } |
  | 1667 | 1718 |  |
  | 1668 | 1719 |  |
  | 1669 | 1720 | if($log){ |
  | 1670 | 1721 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 1671 | 1722 | include\_once $this->get\_premium\_path("logs.php"); |
  | 1672 | 1723 |  |
  | 1673 | 1724 | $log = new WpFastestCacheLogs("delete"); |
  | 1674 | 1725 | $log->action(); |
  | 1675 | 1726 | } |
  | 1676 | 1727 | } |
  | 1677 | 1728 | } |
  | 1678 | 1729 |  |
  | 1679 | 1730 | public function deleteCache($minified = false){ |
  | 1680 | 1731 | if($varnish\_datas = get\_option("WpFastestCacheVarnish")){ |
  | 1681 | 1732 | include\_once('inc/varnish.php'); |
  | 1682 | 1733 | VarnishWPFC::purge\_cache($varnish\_datas); |
  | 1683 | 1734 | } |
  | 1684 | 1735 |  |
  | 1685 | 1736 | include\_once('inc/cdn.php'); |
  | 1686 | 1737 | CdnWPFC::cloudflare\_clear\_cache(); |
  | 1687 | 1738 |  |
  | 1688 | 1739 | $this->set\_preload(); |
  | 1689 | 1740 |  |
  | 1690 | 1741 | $created\_tmpWpfc = false; |
  | 1691 | 1742 | $cache\_deleted = false; |
  | 1692 | 1743 | $minifed\_deleted = false; |
  | 1693 | 1744 |  |
  | 1694 | 1745 | $cache\_path = $this->getWpContentDir("/cache/all"); |
  | 1695 | 1746 | $minified\_cache\_path = $this->getWpContentDir("/cache/wpfc-minified"); |
  | 1696 | 1747 |  |
  | 1697 | 1748 | if(class\_exists("WpFcMobileCache")){ |
  | 1698 | 1749 |  |
  | 1699 | 1750 |  |
  | 1700 | 1751 |  |
  | 1701 | 1752 |  |
  | 1702 | 1753 | if(is\_dir($this->getWpContentDir("/cache/wpfc-mobile-cache"))){ |
  | 1703 | 1754 | if(is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 1704 | 1755 | rename($this->getWpContentDir("/cache/wpfc-mobile-cache"), $this->getWpContentDir("/cache/tmpWpfc/mobile\_").time()); |
  | 1705 | 1756 | }else if(@mkdir($this->getWpContentDir("/cache/tmpWpfc"), 0755, true)){ |
  | 1706 | 1757 | rename($this->getWpContentDir("/cache/wpfc-mobile-cache"), $this->getWpContentDir("/cache/tmpWpfc/mobile\_").time()); |
  | 1707 | 1758 | } |
  | 1708 | 1759 | } |
  | 1709 | 1760 |  |
  | 1710 | 1761 |  |
  | 1711 | 1762 | } |
  | 1712 | 1763 |  |
  | 1713 | 1764 | if(!is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 1714 | 1765 | if(@mkdir($this->getWpContentDir("/cache/tmpWpfc"), 0755, true)){ |
  | 1715 | 1766 | $created\_tmpWpfc = true; |
  | 1716 | 1767 | }else{ |
  | 1717 | 1768 | $created\_tmpWpfc = false; |
  | 1718 | 1769 | //$this->systemMessage = array("Permission of <strong>/wp-content/cache</strong> must be <strong>755</strong>", "error"); |
  | 1719 | 1770 | } |
  | 1720 | 1771 | }else{ |
  | 1721 | 1772 | $created\_tmpWpfc = true; |
  | 1722 | 1773 | } |
  | 1723 | 1774 |  |
  | 1724 | 1775 | //to clear widget cache path |
  | 1725 | 1776 | $this->deleteWidgetCache(); |
  | 1726 | 1777 |  |
  | 1727 | 1778 | $this->delete\_multiple\_domain\_mapping\_cache($minified); |
  | 1728 | 1779 |  |
  | 1729 | 1780 | if(is\_dir($cache\_path)){ |
  | 1730 | 1781 | if(@rename($cache\_path, $this->getWpContentDir("/cache/tmpWpfc/").time())){ |
  | 1731 | 1782 | delete\_option("WpFastestCacheHTML"); |
  | 1732 | 1783 | delete\_option("WpFastestCacheHTMLSIZE"); |
  | 1733 | 1784 | delete\_option("WpFastestCacheMOBILE"); |
  | 1734 | 1785 | delete\_option("WpFastestCacheMOBILESIZE"); |
  | 1735 | 1786 |  |
  | 1736 | 1787 | $cache\_deleted = true; |
  | 1737 | 1788 | } |
  | 1738 | 1789 | }else{ |
  | 1739 | 1790 | $cache\_deleted = true; |
  | 1740 | 1791 | } |
  | 1741 | 1792 |  |
  | 1742 | 1793 | if($minified){ |
  | 1743 | 1794 | if(is\_dir($minified\_cache\_path)){ |
  | 1744 | 1795 | if(@rename($minified\_cache\_path, $this->getWpContentDir("/cache/tmpWpfc/m").time())){ |
  | 1745 | 1796 | delete\_option("WpFastestCacheCSS"); |
  | 1746 | 1797 | delete\_option("WpFastestCacheCSSSIZE"); |
  | 1747 | 1798 | delete\_option("WpFastestCacheJS"); |
  | 1748 | 1799 | delete\_option("WpFastestCacheJSSIZE"); |
  | 1749 | 1800 |  |
  | 1750 | 1801 | $minifed\_deleted = true; |
  | 1751 | 1802 | } |
  | 1752 | 1803 | }else{ |
  | 1753 | 1804 | $minifed\_deleted = true; |
  | 1754 | 1805 | } |
  | 1755 | 1806 | }else{ |
  | 1756 | 1807 | $minifed\_deleted = true; |
  | 1757 | 1808 | } |
  | 1758 | 1809 |  |
  | 1759 | 1810 | if($created\_tmpWpfc && $cache\_deleted && $minifed\_deleted){ |
  | 1760 | 1811 | do\_action('wpfc\_delete\_cache'); |
  | 1761 | 1812 |  |
  | 1762 | 1813 | $this->notify(array("All cache files have been deleted", "updated")); |
  | 1763 | 1814 |  |
  | 1764 | 1815 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 1765 | 1816 | include\_once $this->get\_premium\_path("logs.php"); |
  | 1766 | 1817 |  |
  | 1767 | 1818 | $log = new WpFastestCacheLogs("delete"); |
  | 1768 | 1819 | $log->action(); |
  | 1769 | 1820 | } |
  | 1770 | 1821 | }else{ |
  | 1771 | 1822 | $this->notify(array("Permissions Problem: <a href='http://www.wpfastestcache.com/warnings/delete-cache-problem-related-to-permission/' target='\_blank'>Read More</a>", "error")); |
  | 1772 | 1823 | } |
  | 1773 | 1824 |  |
  | 1774 | 1825 | // for ajax request |
  | 1775 | 1826 | if(isset($\_GET["action"]) && in\_array($\_GET["action"], array("wpfc\_delete\_cache", "wpfc\_delete\_cache\_and\_minified"))){ |
  | 1776 | 1827 | die(json\_encode($this->systemMessage)); |
  | 1777 | 1828 | } |
  | 1778 | 1829 | } |
  | 1779 | 1830 |  |
  | 1780 | 1831 | public function checkCronTime(){ |
  | 1781 | 1832 | $crons = \_get\_cron\_array(); |
  | 1782 | 1833 |  |
  | 1783 | 1834 | foreach ((array)$crons as $cron\_key => $cron\_value) { |
  | 1784 | 1835 | foreach ( (array) $cron\_value as $hook => $events ) { |
  | 1785 | 1836 | if(preg\_match("/^wp\\_fastest\\_cache(.\*)/", $hook, $id)){ |
  | 1786 | 1837 | if(!$id[1] || preg\_match("/^\\_(\d+)$/", $id[1])){ |
  | 1787 | 1838 | foreach ( (array) $events as $event\_key => $event ) { |
  | 1788 | 1839 | add\_action("wp\_fastest\_cache".$id[1],  array($this, 'setSchedule')); |
  | 1789 | 1840 | } |
  | 1790 | 1841 | } |
  | 1791 | 1842 | } |
  | 1792 | 1843 | } |
  | 1793 | 1844 | } |
  | 1794 | 1845 |  |
  | 1795 | 1846 | add\_action($this->slug()."\_Preload",  array($this, 'create\_preload\_cache'), 11); |
  | 1796 | 1847 | } |
  | 1797 | 1848 |  |
  | 1798 | 1849 | public function set\_preload(){ |
  | 1799 | 1850 | include\_once('inc/preload.php'); |
  | 1800 | 1851 | PreloadWPFC::set\_preload($this->slug()); |
  | 1801 | 1852 | } |
  | 1802 | 1853 |  |
  | 1803 | 1854 | public function create\_preload\_cache(){ |
  | 1804 | 1855 | $this->options = $this->getOptions(); |
  | 1805 | 1856 |  |
  | 1806 | 1857 | include\_once('inc/preload.php'); |
  | 1807 | 1858 | PreloadWPFC::create\_preload\_cache($this->options); |
  | 1808 | 1859 | } |
  | 1809 | 1860 |  |
  | 1810 | 1861 | public function wpfc\_remote\_get($url, $user\_agent){ |
  | 1811 | 1862 | //$response = wp\_remote\_get($url, array('timeout' => 10, 'sslverify' => false, 'headers' => array("cache-control" => array("no-store, no-cache, must-revalidate", "post-check=0, pre-check=0"),'user-agent' => $user\_agent))); |
  | 1812 | 1863 | $response = wp\_remote\_get($url, array('user-agent' => $user\_agent, 'timeout' => 10, 'sslverify' => false, 'headers' => array("cache-control" => "no-store, no-cache, must-revalidate, post-check=0, pre-check=0"))); |
  | 1813 | 1864 |  |
  | 1814 | 1865 | if (!$response || is\_wp\_error($response)){ |
  | 1815 | 1866 | echo $response->get\_error\_message()." - "; |
  | 1816 | 1867 |  |
  | 1817 | 1868 | return false; |
  | 1818 | 1869 | }else{ |
  | 1819 | 1870 | if(wp\_remote\_retrieve\_response\_code($response) != 200){ |
  | 1820 | 1871 | return false; |
  | 1821 | 1872 | } |
  | 1822 | 1873 | } |
  | 1823 | 1874 |  |
  | 1824 | 1875 | return true; |
  | 1825 | 1876 | } |
  | 1826 | 1877 |  |
  | 1827 | 1878 | public function setSchedule($args = ""){ |
  | 1828 | 1879 | if($args){ |
  | 1829 | 1880 | $rule = json\_decode($args); |
  | 1830 | 1881 |  |
  | 1831 | 1882 | if($rule->prefix == "all"){ |
  | 1832 | 1883 | $this->deleteCache(); |
  | 1833 | 1884 | }else if($rule->prefix == "homepage"){ |
  | 1834 | 1885 | @unlink($this->getWpContentDir("/cache/all/index.html")); |
  | 1835 | 1886 | @unlink($this->getWpContentDir("/cache/wpfc-mobile-cache/index.html")); |
  | 1836 | 1887 |  |
  | 1837 | 1888 | if(isset($this->options->wpFastestCachePreload\_homepage) && $this->options->wpFastestCachePreload\_homepage){ |
  | 1838 | 1889 | $this->wpfc\_remote\_get(get\_option("home"), "WP Fastest Cache Preload Bot - After Cache Timeout"); |
  | 1839 | 1890 | $this->wpfc\_remote\_get(get\_option("home"), "WP Fastest Cache Preload iPhone Mobile Bot - After Cache Timeout"); |
  | 1840 | 1891 | } |
  | 1841 | 1892 | }else if($rule->prefix == "startwith"){ |
  | 1842 | 1893 | if(!is\_dir($this->getWpContentDir("/cache/tmpWpfc"))){ |
  | 1843 | 1894 | if(@mkdir($this->getWpContentDir("/cache/tmpWpfc"), 0755, true)){} |
  | 1844 | 1895 | } |
  | 1845 | 1896 |  |
  | 1846 | 1897 | $rule->content = trim($rule->content, "/"); |
  | 1847 | 1898 |  |
  | 1848 | 1899 | $files = glob($this->getWpContentDir("/cache/all/").$rule->content."\*"); |
  | 1849 | 1900 |  |
  | 1850 | 1901 | foreach ((array)$files as $file) { |
  | 1851 | 1902 | $mobile\_file = str\_replace("/cache/all/", "/cache/wpfc-mobile-cache/", $file); |
  | 1852 | 1903 |  |
  | 1853 | 1904 | @rename($file, $this->getWpContentDir("/cache/tmpWpfc/").time()); |
  | 1854 | 1905 | @rename($mobile\_file, $this->getWpContentDir("/cache/tmpWpfc/mobile\_").time()); |
  | 1855 | 1906 | } |
  | 1856 | 1907 | }else if($rule->prefix == "exact"){ |
  | 1857 | 1908 | $rule->content = trim($rule->content, "/"); |
  | 1858 | 1909 |  |
  | 1859 | 1910 | @unlink($this->getWpContentDir("/cache/all/").$rule->content."/index.html"); |
  | 1860 | 1911 | @unlink($this->getWpContentDir("/cache/wpfc-mobile-cache/").$rule->content."/index.html"); |
  | 1861 | 1912 | } |
  | 1862 | 1913 |  |
  | 1863 | 1914 | if($rule->prefix != "all"){ |
  | 1864 | 1915 | if($this->isPluginActive("wp-fastest-cache-premium/wpFastestCachePremium.php")){ |
  | 1865 | 1916 | include\_once $this->get\_premium\_path("logs.php"); |
  | 1866 | 1917 | $log = new WpFastestCacheLogs("delete"); |
  | 1867 | 1918 | $log->action($rule); |
  | 1868 | 1919 | } |
  | 1869 | 1920 | } |
  | 1870 | 1921 | }else{ |
  | 1871 | 1922 | //for old cron job |
  | 1872 | 1923 | $this->deleteCache(); |
  | 1873 | 1924 | } |
  | 1874 | 1925 | } |
  | 1875 | 1926 |  |
  | 1876 | 1927 | public function modify\_htaccess\_for\_new\_user($user\_id){ |
  | 1877 | 1928 | $path = ABSPATH; |
  | 1878 | 1929 |  |
  | 1879 | 1930 | if($this->is\_subdirectory\_install()){ |
  | 1880 | 1931 | $path = $this->getABSPATH(); |
  | 1881 | 1932 | } |
  | 1882 | 1933 |  |
  | 1883 | 1934 | $htaccess = @file\_get\_contents($path.".htaccess"); |
  | 1884 | 1935 |  |
  | 1885 | 1936 | if(preg\_match("/\#\s?Start\_WPFC\_Exclude\_Admin\_Cookie/", $htaccess)){ |
  | 1886 | 1937 | $rules = $this->excludeAdminCookie(); |
  | 1887 | 1938 |  |
  | 1888 | 1939 | $htaccess = preg\_replace("/\#\s?Start\_WPFC\_Exclude\_Admin\_Cookie[^\#]\*\#\s?End\_WPFC\_Exclude\_Admin\_Cookie\s+/", $rules, $htaccess); |
  | 1889 | 1940 | } |
  | 1890 | 1941 |  |
  | 1891 | 1942 | @file\_put\_contents($path.".htaccess", $htaccess); |
  | 1892 | 1943 | } |
  | 1893 | 1944 |  |
  | 1894 | 1945 | public function excludeAdminCookie(){ |
  | 1895 | 1946 | $rules = ""; |
  | 1896 | 1947 | $users\_groups = array\_chunk(get\_users(array("role" => "administrator", "fields" => array("user\_login"))), 5); |
  | 1897 | 1948 |  |
  | 1898 | 1949 | foreach ($users\_groups as $group\_key => $group) { |
  | 1899 | 1950 | $tmp\_users = ""; |
  | 1900 | 1951 | $tmp\_rule = ""; |
  | 1901 | 1952 |  |
  | 1902 | 1953 | foreach ($group as $key => $value) { |
  | 1903 | 1954 | if($tmp\_users){ |
  | 1904 | 1955 | $tmp\_users = $tmp\_users."|".sanitize\_user(wp\_unslash($value->user\_login), true); |
  | 1905 | 1956 | }else{ |
  | 1906 | 1957 | $tmp\_users = sanitize\_user(wp\_unslash($value->user\_login), true); |
  | 1907 | 1958 | } |
  | 1908 | 1959 |  |
  | 1909 | 1960 | // to replace spaces with \s |
  | 1910 | 1961 | $tmp\_users = preg\_replace("/\s/", "\s", $tmp\_users); |
  | 1911 | 1962 |  |
  | 1912 | 1963 | if(!next($group)){ |
  | 1913 | 1964 | $tmp\_rule = "RewriteCond %{HTTP:Cookie} !wordpress\_logged\_in\_[^\=]+\=".$tmp\_users; |
  | 1914 | 1965 | } |
  | 1915 | 1966 | } |
  | 1916 | 1967 |  |
  | 1917 | 1968 | if($rules){ |
  | 1918 | 1969 | $rules = $rules."\n".$tmp\_rule; |
  | 1919 | 1970 | }else{ |
  | 1920 | 1971 | $rules = $tmp\_rule; |
  | 1921 | 1972 | } |
  | 1922 | 1973 | } |
  | 1923 | 1974 |  |
  | 1924 | 1975 | return "# Start\_WPFC\_Exclude\_Admin\_Cookie\n".$rules."\n# End\_WPFC\_Exclude\_Admin\_Cookie\n"; |
  | 1925 | 1976 | } |
  | 1926 | 1977 |  |
  | 1927 | 1978 | public function excludeRules(){ |
  | 1928 | 1979 | $htaccess\_page\_rules = ""; |
  | 1929 | 1980 | $htaccess\_page\_useragent = ""; |
  | 1930 | 1981 | $htaccess\_page\_cookie = ""; |
  | 1931 | 1982 |  |
  | 1932 | 1983 | if($rules\_json = get\_option("WpFastestCacheExclude")){ |
  | 1933 | 1984 | if($rules\_json != "null"){ |
  | 1934 | 1985 | $rules\_std = json\_decode($rules\_json); |
  | 1935 | 1986 |  |
  | 1936 | 1987 | foreach ($rules\_std as $key => $value) { |
  | 1937 | 1988 | $value->type = isset($value->type) ? $value->type : "page"; |
  | 1938 | 1989 |  |
  | 1939 | 1990 | // escape the chars |
  | 1940 | 1991 | $value->content = str\_replace("?", "\?", $value->content); |
  | 1941 | 1992 |  |
  | 1942 | 1993 | if($value->type == "page"){ |
  | 1943 | 1994 | if($value->prefix == "startwith"){ |
  | 1944 | 1995 | $value->content = ltrim($value->content, "/"); |
  | 1945 | 1996 |  |
  | 1946 | 1997 | $htaccess\_page\_rules = $htaccess\_page\_rules."RewriteCond %{REQUEST\_URI} !^/".$value->content." [NC]\n"; |
  | 1947 | 1998 | } |
  | 1948 | 1999 |  |
  | 1949 | 2000 | if($value->prefix == "contain"){ |
  | 1950 | 2001 | $htaccess\_page\_rules = $htaccess\_page\_rules."RewriteCond %{REQUEST\_URI} !".$value->content." [NC]\n"; |
  | 1951 | 2002 | } |
  | 1952 | 2003 |  |
  | 1953 | 2004 | if($value->prefix == "exact"){ |
  | 1954 | 2005 | $value->content = trim($value->content, "/"); |
  | 1955 | 2006 |  |
  | 1956 | 2007 | $htaccess\_page\_rules = $htaccess\_page\_rules."RewriteCond %{REQUEST\_URI} !\/".$value->content." [NC]\n"; |
  | 1957 | 2008 | } |
  | 1958 | 2009 | }else if($value->type == "useragent"){ |
  | 1959 | 2010 | $htaccess\_page\_useragent = $htaccess\_page\_useragent."RewriteCond %{HTTP\_USER\_AGENT} !".$value->content." [NC]\n"; |
  | 1960 | 2011 | }else if($value->type == "cookie"){ |
  | 1961 | 2012 | $htaccess\_page\_cookie = $htaccess\_page\_cookie."RewriteCond %{HTTP:Cookie} !".$value->content." [NC]\n"; |
  | 1962 | 2013 | } |
  | 1963 | 2014 | } |
  | 1964 | 2015 | } |
  | 1965 | 2016 | } |
  | 1966 | 2017 |  |
  | 1967 | 2018 | return "# Start WPFC Exclude\n".$htaccess\_page\_rules.$htaccess\_page\_useragent.$htaccess\_page\_cookie."# End WPFC Exclude\n"; |
  | 1968 | 2019 | } |
  | 1969 | 2020 |  |
  | 1970 | 2021 | public function getABSPATH(){ |
  | 1971 | 2022 | $path = ABSPATH; |
  | 1972 | 2023 | $siteUrl = site\_url(); |
  | 1973 | 2024 | $homeUrl = home\_url(); |
  | 1974 | 2025 | $diff = str\_replace($homeUrl, "", $siteUrl); |
  | 1975 | 2026 | $diff = trim($diff,"/"); |
  | 1976 | 2027 |  |
  | 1977 | 2028 | $pos = strrpos($path, $diff); |
  | 1978 | 2029 |  |
  | 1979 | 2030 | if($pos !== false){ |
  | 1980 | 2031 | $path = substr\_replace($path, "", $pos, strlen($diff)); |
  | 1981 | 2032 | $path = trim($path,"/"); |
  | 1982 | 2033 | $path = "/".$path."/"; |
  | 1983 | 2034 | } |
  | 1984 | 2035 | return $path; |
  | 1985 | 2036 | } |
  | 1986 | 2037 |  |
  | 1987 | 2038 | public function rm\_folder\_recursively($dir, $i = 1) { |
  | 1988 | 2039 | if(is\_dir($dir)){ |
  | 1989 | 2040 | $files = @scandir($dir); |
  | 1990 | 2041 | foreach((array)$files as $file) { |
  | 1991 | 2042 | if($i > 50 && !preg\_match("/wp-fastest-cache-premium/i", $dir)){ |
  | 1992 | 2043 | return true; |
  | 1993 | 2044 | }else{ |
  | 1994 | 2045 | $i++; |
  | 1995 | 2046 | } |
  | 1996 | 2047 | if ('.' === $file || '..' === $file) continue; |
  | 1997 | 2048 | if (is\_dir("$dir/$file")){ |
  | 1998 | 2049 | $this->rm\_folder\_recursively("$dir/$file", $i); |
  | 1999 | 2050 | }else{ |
  | 2000 | 2051 | if(file\_exists("$dir/$file")){ |
  | 2001 | 2052 | @unlink("$dir/$file"); |
  | 2002 | 2053 | } |
  | 2003 | 2054 | } |
  | 2004 | 2055 | } |
  | 2005 | 2056 | } |
  | 2006 | 2057 |  |
  | 2007 | 2058 | if(is\_dir($dir)){ |
  | 2008 | 2059 | $files\_tmp = @scandir($dir); |
  | 2009 | 2060 |  |
  | 2010 | 2061 | if(!isset($files\_tmp[2])){ |
  | 2011 | 2062 | @rmdir($dir); |
  | 2012 | 2063 | } |
  | 2013 | 2064 | } |
  | 2014 | 2065 |  |
  | 2015 | 2066 | return true; |
  | 2016 | 2067 | } |
  | 2017 | 2068 |  |
  | 2018 | 2069 | public function is\_subdirectory\_install(){ |
  | 2019 | 2070 | if(strlen(site\_url()) > strlen(home\_url())){ |
  | 2020 | 2071 | return true; |
  | 2021 | 2072 | } |
  | 2022 | 2073 | return false; |
  | 2023 | 2074 | } |
  | 2024 | 2075 |  |
  | 2025 | 2076 | protected function getMobileUserAgents(){ |
  | 2026 | 2077 | return implode("|", $this->get\_mobile\_browsers())."|".implode("|", $this->get\_operating\_systems()); |
  | 2027 | 2078 | } |
  | 2028 | 2079 |  |
  | 2029 | 2080 | public function get\_premium\_path($name){ |
  | 2030 | 2081 | return WPFC\_WP\_PLUGIN\_DIR."/wp-fastest-cache-premium/pro/library/".$name; |
  | 2031 | 2082 | } |
  | 2032 | 2083 |  |
  | 2033 | 2084 | public function cron\_add\_minute( $schedules ) { |
  | 2034 | 2085 | $schedules['everyminute'] = array( |
  | 2035 | 2086 | 'interval' => 60\*1, |
  | 2036 | 2087 | 'display' => \_\_( 'Once Every 1 Minute' ), |
  | 2037 | 2088 | 'wpfc' => true |
  | 2038 | 2089 | ); |
  | 2039 | 2090 |  |
  | 2040 | 2091 | $schedules['everyfiveminute'] = array( |
  | 2041 | 2092 | 'interval' => 60\*5, |
  | 2042 | 2093 | 'display' => \_\_( 'Once Every 5 Minutes' ), |
  | 2043 | 2094 | 'wpfc' => true |
  | 2044 | 2095 | ); |
  | 2045 | 2096 |  |
  | 2046 | 2097 | $schedules['everyfifteenminute'] = array( |
  | 2047 | 2098 | 'interval' => 60\*15, |
  | 2048 | 2099 | 'display' => \_\_( 'Once Every 15 Minutes' ), |
  | 2049 | 2100 | 'wpfc' => true |
  | 2050 | 2101 | ); |
  | 2051 | 2102 |  |
  | 2052 | 2103 | $schedules['twiceanhour'] = array( |
  | 2053 | 2104 | 'interval' => 60\*30, |
  | 2054 | 2105 | 'display' => \_\_( 'Twice an Hour' ), |
  | 2055 | 2106 | 'wpfc' => true |
  | 2056 | 2107 | ); |
  | 2057 | 2108 |  |
  | 2058 | 2109 | $schedules['onceanhour'] = array( |
  | 2059 | 2110 | 'interval' => 60\*60, |
  | 2060 | 2111 | 'display' => \_\_( 'Once an Hour' ), |
  | 2061 | 2112 | 'wpfc' => true |
  | 2062 | 2113 | ); |
  | 2063 | 2114 |  |
  | 2064 | 2115 | $schedules['everytwohours'] = array( |
  | 2065 | 2116 | 'interval' => 60\*60\*2, |
  | 2066 | 2117 | 'display' => \_\_( 'Once Every 2 Hours' ), |
  | 2067 | 2118 | 'wpfc' => true |
  | 2068 | 2119 | ); |
  | 2069 | 2120 |  |
  | 2070 | 2121 | $schedules['everythreehours'] = array( |
  | 2071 | 2122 | 'interval' => 60\*60\*3, |
  | 2072 | 2123 | 'display' => \_\_( 'Once Every 3 Hours' ), |
  | 2073 | 2124 | 'wpfc' => true |
  | 2074 | 2125 | ); |
  | 2075 | 2126 |  |
  | 2076 | 2127 | $schedules['everyfourhours'] = array( |
  | 2077 | 2128 | 'interval' => 60\*60\*4, |
  | 2078 | 2129 | 'display' => \_\_( 'Once Every 4 Hours' ), |
  | 2079 | 2130 | 'wpfc' => true |
  | 2080 | 2131 | ); |
  | 2081 | 2132 |  |
  | 2082 | 2133 | $schedules['everyfivehours'] = array( |
  | 2083 | 2134 | 'interval' => 60\*60\*5, |
  | 2084 | 2135 | 'display' => \_\_( 'Once Every 5 Hours' ), |
  | 2085 | 2136 | 'wpfc' => true |
  | 2086 | 2137 | ); |
  | 2087 | 2138 |  |
  | 2088 | 2139 | $schedules['everysixhours'] = array( |
  | 2089 | 2140 | 'interval' => 60\*60\*6, |
  | 2090 | 2141 | 'display' => \_\_( 'Once Every 6 Hours' ), |
  | 2091 | 2142 | 'wpfc' => true |
  | 2092 | 2143 | ); |
  | 2093 | 2144 |  |
  | 2094 | 2145 | $schedules['everysevenhours'] = array( |
  | 2095 | 2146 | 'interval' => 60\*60\*7, |
  | 2096 | 2147 | 'display' => \_\_( 'Once Every 7 Hours' ), |
  | 2097 | 2148 | 'wpfc' => true |
  | 2098 | 2149 | ); |
  | 2099 | 2150 |  |
  | 2100 | 2151 | $schedules['everyeighthours'] = array( |
  | 2101 | 2152 | 'interval' => 60\*60\*8, |
  | 2102 | 2153 | 'display' => \_\_( 'Once Every 8 Hours' ), |
  | 2103 | 2154 | 'wpfc' => true |
  | 2104 | 2155 | ); |
  | 2105 | 2156 |  |
  | 2106 | 2157 | $schedules['everyninehours'] = array( |
  | 2107 | 2158 | 'interval' => 60\*60\*9, |
  | 2108 | 2159 | 'display' => \_\_( 'Once Every 9 Hours' ), |
  | 2109 | 2160 | 'wpfc' => true |
  | 2110 | 2161 | ); |
  | 2111 | 2162 |  |
  | 2112 | 2163 | $schedules['everytenhours'] = array( |
  | 2113 | 2164 | 'interval' => 60\*60\*10, |
  | 2114 | 2165 | 'display' => \_\_( 'Once Every 10 Hours' ), |
  | 2115 | 2166 | 'wpfc' => true |
  | 2116 | 2167 | ); |
  | 2117 | 2168 |  |
  | 2118 | 2169 | $schedules['onceaday'] = array( |
  | 2119 | 2170 | 'interval' => 60\*60\*24, |
  | 2120 | 2171 | 'display' => \_\_( 'Once a Day' ), |
  | 2121 | 2172 | 'wpfc' => true |
  | 2122 | 2173 | ); |
  | 2123 | 2174 |  |
  | 2124 | 2175 | $schedules['everythreedays'] = array( |
  | 2125 | 2176 | 'interval' => 60\*60\*24\*3, |
  | 2126 | 2177 | 'display' => \_\_( 'Once Every 3 Days' ), |
  | 2127 | 2178 | 'wpfc' => true |
  | 2128 | 2179 | ); |
  | 2129 | 2180 |  |
  | 2130 | 2181 | $schedules['everysevendays'] = array( |
  | 2131 | 2182 | 'interval' => 60\*60\*24\*7, |
  | 2132 | 2183 | 'display' => \_\_( 'Once Every 7 Days' ), |
  | 2133 | 2184 | 'wpfc' => true |
  | 2134 | 2185 | ); |
  | 2135 | 2186 |  |
  | 2136 | 2187 | $schedules['everytendays'] = array( |
  | 2137 | 2188 | 'interval' => 60\*60\*24\*10, |
  | 2138 | 2189 | 'display' => \_\_( 'Once Every 10 Days' ), |
  | 2139 | 2190 | 'wpfc' => true |
  | 2140 | 2191 | ); |
  | 2141 | 2192 |  |
  | 2142 | 2193 | $schedules['everyfifteendays'] = array( |
  | 2143 | 2194 | 'interval' => 60\*60\*24\*15, |
  | 2144 | 2195 | 'display' => \_\_( 'Once Every 15 Days' ), |
  | 2145 | 2196 | 'wpfc' => true |
  | 2146 | 2197 | ); |
  | 2147 | 2198 |  |
  | 2148 | 2199 | $schedules['montly'] = array( |
  | 2149 | 2200 | 'interval' => 60\*60\*24\*30, |
  | 2150 | 2201 | 'display' => \_\_( 'Once a Month' ), |
  | 2151 | 2202 | 'wpfc' => true |
  | 2152 | 2203 | ); |
  | 2153 | 2204 |  |
  | 2154 | 2205 | $schedules['yearly'] = array( |
  | 2155 | 2206 | 'interval' => 60\*60\*24\*30\*12, |
  | 2156 | 2207 | 'display' => \_\_( 'Once a Year' ), |
  | 2157 | 2208 | 'wpfc' => true |
  | 2158 | 2209 | ); |
  | 2159 | 2210 |  |
  | 2160 | 2211 | return $schedules; |
  | 2161 | 2212 | } |
  | 2162 | 2213 |  |
  | 2163 | 2214 | public function setCustomInterval(){ |
  | 2164 | 2215 | add\_filter( 'cron\_schedules', array($this, 'cron\_add\_minute')); |
  | 2165 | 2216 | } |
  | 2166 | 2217 |  |
  | 2167 | 2218 | public function isPluginActive( $plugin ) { |
  | 2168 | 2219 | return in\_array( $plugin, (array) get\_option( 'active\_plugins', array() ) ) || $this->isPluginActiveForNetwork( $plugin ); |
  | 2169 | 2220 | } |
  | 2170 | 2221 |  |
  | 2171 | 2222 | public function isPluginActiveForNetwork( $plugin ) { |
  | 2172 | 2223 | if ( !is\_multisite() ) |
  | 2173 | 2224 | return false; |
  | 2174 | 2225 |  |
  | 2175 | 2226 | $plugins = get\_site\_option( 'active\_sitewide\_plugins'); |
  | 2176 | 2227 | if ( isset($plugins[$plugin]) ) |
  | 2177 | 2228 | return true; |
  | 2178 | 2229 |  |
  | 2179 | 2230 | return false; |
  | 2180 | 2231 | } |
  | 2181 | 2232 |  |
  | 2182 | 2233 | public function current\_url(){ |
  | 2183 | 2234 | global $wp; |
  | 2184 | 2235 | $current\_url = home\_url($\_SERVER['REQUEST\_URI']); |
  | 2185 | 2236 |  |
  | 2186 | 2237 | return $current\_url; |
  | 2187 | 2238 |  |
  | 2188 | 2239 |  |
  | 2189 | 2240 | // if(defined('WP\_CLI')){ |
  | 2190 | 2241 | //  $\_SERVER["SERVER\_NAME"] = isset($\_SERVER["SERVER\_NAME"]) ? $\_SERVER["SERVER\_NAME"] : ""; |
  | 2191 | 2242 | //  $\_SERVER["SERVER\_PORT"] = isset($\_SERVER["SERVER\_PORT"]) ? $\_SERVER["SERVER\_PORT"] : 80; |
  | 2192 | 2243 | // } |
  | 2193 | 2244 |  |
  | 2194 | 2245 | //    $pageURL = 'http'; |
  | 2195 | 2246 |  |
  | 2196 | 2247 | //    if(isset($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] == 'on'){ |
  | 2197 | 2248 | //        $pageURL .= 's'; |
  | 2198 | 2249 | //    } |
  | 2199 | 2250 |  |
  | 2200 | 2251 | //    $pageURL .= '://'; |
  | 2201 | 2252 |  |
  | 2202 | 2253 | //    if($\_SERVER['SERVER\_PORT'] != '80'){ |
  | 2203 | 2254 | //        $pageURL .= $\_SERVER['SERVER\_NAME'].':'.$\_SERVER['SERVER\_PORT'].$\_SERVER['REQUEST\_URI']; |
  | 2204 | 2255 | //    }else{ |
  | 2205 | 2256 | //        $pageURL .= $\_SERVER['SERVER\_NAME'].$\_SERVER['REQUEST\_URI']; |
  | 2206 | 2257 | //    } |
  | 2207 | 2258 |  |
  | 2208 | 2259 | //    return $pageURL; |
  | 2209 | 2260 | } |
  | 2210 | 2261 |  |
  | 2211 | 2262 | public function wpfc\_load\_plugin\_textdomain(){ |
  | 2212 | 2263 | load\_plugin\_textdomain('wp-fastest-cache', FALSE, basename( dirname( \_\_FILE\_\_ ) ) . '/languages/' ); |
  | 2213 | 2264 | } |
  | 2214 | 2265 |  |
  | 2215 | 2266 | public function cdn\_replace\_urls($matches){ |
  | 2216 | 2267 | if(count($this->cdn) > 0){ |
  | 2217 | 2268 | foreach ($this->cdn as $key => $cdn) { |
  | 2218 | 2269 | if($cdn->id == "cloudflare"){ |
  | 2219 | 2270 | continue; |
  | 2220 | 2271 | } |
  | 2221 | 2272 |  |
  | 2222 | 2273 | if(isset($cdn->status) && $cdn->status == "pause"){ |
  | 2223 | 2274 | continue; |
  | 2224 | 2275 | } |
  | 2225 | 2276 |  |
  | 2226 | 2277 | if(preg\_match("/manifest\.json\.php/i", $matches[0])){ |
  | 2227 | 2278 | return $matches[0]; |
  | 2228 | 2279 | } |
  | 2229 | 2280 |  |
  | 2230 | 2281 | //https://site.com?brizy\_media=AttachmentName.jpg&brizy\_crop=CropSizes&brizy\_post=TheCurrentPost |
  | 2231 | 2282 | if(preg\_match("/brizy\_media\=/i", $matches[0])){ |
  | 2232 | 2283 | return $matches[0]; |
  | 2233 | 2284 | } |
  | 2234 | 2285 |  |
  | 2235 | 2286 | //https://cdn.shortpixel.ai/client/q\_glossy,ret\_img,w\_736/http://wpfc.com/stories.png |
  | 2236 | 2287 | if(preg\_match("/cdn\.shortpixel\.ai\/client/i", $matches[0])){ |
  | 2237 | 2288 | return $matches[0]; |
  | 2238 | 2289 | } |
  | 2239 | 2290 |  |
  | 2240 | 2291 |  |
  | 2241 | 2292 | if(preg\_match("/^\/\/random/", $cdn->cdnurl) || preg\_match("/\/\/i\d\.wp\.com/", $cdn->cdnurl)){ |
  | 2242 | 2293 | // Photon will no longer be supported |
  | 2243 | 2294 | continue; |
  | 2244 | 2295 | } |
  | 2245 | 2296 |  |
  | 2246 | 2297 | $cdnurl = $cdn->cdnurl; |
  | 2247 | 2298 |  |
  | 2248 | 2299 | $cdn->file\_types = str\_replace(",", "|", $cdn->file\_types); |
  | 2249 | 2300 |  |
  | 2250 | 2301 | if(preg\_match("/\.(".$cdn->file\_types.")(\"|\'|\?|\)|\s|\&quot\;)/i", $matches[0])){ |
  | 2251 | 2302 | //nothing |
  | 2252 | 2303 | }else{ |
  | 2253 | 2304 | if(preg\_match("/js/", $cdn->file\_types)){ |
  | 2254 | 2305 | if(!preg\_match("/\/revslider\/public\/assets\/js/", $matches[0])){ |
  | 2255 | 2306 | continue; |
  | 2256 | 2307 | } |
  | 2257 | 2308 | }else{ |
  | 2258 | 2309 | continue; |
  | 2259 | 2310 | } |
  | 2260 | 2311 | } |
  | 2261 | 2312 |  |
  | 2262 | 2313 | if($cdn->keywords){ |
  | 2263 | 2314 | $cdn->keywords = str\_replace(",", "|", $cdn->keywords); |
  | 2264 | 2315 |  |
  | 2265 | 2316 | if(!preg\_match("/".preg\_quote($cdn->keywords, "/")."/i", $matches[0])){ |
  | 2266 | 2317 | continue; |
  | 2267 | 2318 | } |
  | 2268 | 2319 | } |
  | 2269 | 2320 |  |
  | 2270 | 2321 | if(isset($cdn->excludekeywords) && $cdn->excludekeywords){ |
  | 2271 | 2322 | $cdn->excludekeywords = str\_replace(",", "|", $cdn->excludekeywords); |
  | 2272 | 2323 |  |
  | 2273 | 2324 | if(preg\_match("/".preg\_quote($cdn->excludekeywords, "/")."/i", $matches[0])){ |
  | 2274 | 2325 | continue; |
  | 2275 | 2326 | } |
  | 2276 | 2327 | } |
  | 2277 | 2328 |  |
  | 2278 | 2329 | if(preg\_match("/(data-product\_variations|data-siteorigin-parallax)\=[\"\'][^\"\']+[\"\']/i", $matches[0])){ |
  | 2279 | 2330 | $cdnurl = preg\_replace("/(https?\:)?(\/\/)(www\.)?/", "", $cdnurl); |
  | 2280 | 2331 |  |
  | 2281 | 2332 | // if(preg\_match("/i\d\.wp\.com/i", $cdnurl)){ |
  | 2282 | 2333 | //  $matches[0] = preg\_replace("/(quot\;|\s)(https?\:)?(\\\\\/\\\\\/|\/\/)(www\.)?".$cdn->originurl."/i", "$1$2$3".$cdnurl, $matches[0]); |
  | 2283 | 2334 | // }else{ |
  | 2284 | 2335 | //  $matches[0] = preg\_replace("/(quot\;|\s)(https?\:)?(\\\\\/\\\\\/|\/\/)(www\.)?".$cdn->originurl."/i", "$1$2$3$4".$cdnurl, $matches[0]); |
  | 2285 | 2336 | // } |
  | 2286 | 2337 |  |
  | 2287 | 2338 | $matches[0] = preg\_replace("/(quot\;|\s)(https?\:)?(\\\\\/\\\\\/|\/\/)(www\.)?".$cdn->originurl."/i", '${1}${2}${3}'.$cdnurl, $matches[0]); |
  | 2288 | 2339 |  |
  | 2289 | 2340 |  |
  | 2290 | 2341 | }else if(preg\_match("/\{\"concatemoji\"\:\"[^\"]+\"\}/i", $matches[0])){ |
  | 2291 | 2342 | $matches[0] = preg\_replace("/(http(s?)\:)?".preg\_quote("\/\/", "/")."(www\.)?/i", "", $matches[0]); |
  | 2292 | 2343 | $matches[0] = preg\_replace("/".preg\_quote($cdn->originurl, "/")."/i", $cdnurl, $matches[0]); |
  | 2293 | 2344 | }else if(isset($matches[2]) && preg\_match("/".preg\_quote($cdn->originurl, "/")."/", $matches[2])){ |
  | 2294 | 2345 | $matches[0] = preg\_replace("/(http(s?)\:)?\/\/(www\.)?".preg\_quote($cdn->originurl, "/")."/i", $cdnurl, $matches[0]); |
  | 2295 | 2346 | }else if(isset($matches[2]) && preg\_match("/^(\/?)(wp-includes|wp-content)/", $matches[2])){ |
  | 2296 | 2347 | $matches[0] = preg\_replace("/(\/?)(wp-includes|wp-content)/i", $cdnurl."/"."$2", $matches[0]); |
  | 2297 | 2348 | }else if(preg\_match("/[\"\']https?\:\\\\\/\\\\\/[^\"\']+[\"\']/i", $matches[0])){ |
  | 2298 | 2349 | if(preg\_match("/^(logo|url|image)$/i", $matches[1])){ |
  | 2299 | 2350 | //If the url is called with "//", it causes an error on https://search.google.com/structured-data/testing-tool/u/0/ |
  | 2300 | 2351 | //<script type="application/ld+json">"logo":{"@type":"ImageObject","url":"\/\/cdn.site.com\/image.png"}</script> |
  | 2301 | 2352 | //<script type="application/ld+json">{"logo":"\/\/cdn.site.com\/image.png"}</script> |
  | 2302 | 2353 | //<script type="application/ld+json">{"image":"\/\/cdn.site.com\/image.jpg"}</script> |
  | 2303 | 2354 | }else{ |
  | 2304 | 2355 | //<script>var loaderRandomImages=["https:\/\/www.site.com\/wp-content\/uploads\/2016\/12\/image.jpg"];</script> |
  | 2305 | 2356 | $matches[0] = preg\_replace("/\\\\\//", "/", $matches[0]); |
  | 2306 | 2357 |  |
  | 2307 | 2358 | if(preg\_match("/".preg\_quote($cdn->originurl, "/")."/", $matches[0])){ |
  | 2308 | 2359 | $matches[0] = preg\_replace("/(http(s?)\:)?\/\/(www\.)?".preg\_quote($cdn->originurl, "/")."/i", $cdnurl, $matches[0]); |
  | 2309 | 2360 | $matches[0] = preg\_replace("/\//", "\/", $matches[0]); |
  | 2310 | 2361 | } |
  | 2311 | 2362 | } |
  | 2312 | 2363 | } |
  | 2313 | 2364 | } |
  | 2314 | 2365 | } |
  | 2315 | 2366 |  |
  | 2316 | 2367 | return $matches[0]; |
  | 2317 | 2368 | } |
  | 2318 | 2369 |  |
  | 2319 | 2370 | public function read\_file($url){ |
  | 2320 | 2371 | if(!preg\_match("/\.php/", $url)){ |
  | 2321 | 2372 | $url = preg\_replace("/\?.\*/", "", $url); |
  | 2322 | 2373 |  |
  | 2323 | 2374 | if(preg\_match("/wp-content/", $url)){ |
  | 2324 | 2375 | $path = preg\_replace("/.+\/wp-content\/(.+)/", WPFC\_WP\_CONTENT\_DIR."/"."$1", $url); |
  | 2325 | 2376 | }else if(preg\_match("/wp-includes/", $url)){ |
  | 2326 | 2377 | $path = preg\_replace("/.+\/wp-includes\/(.+)/", ABSPATH."wp-includes/"."$1", $url); |
  | 2327 | 2378 | } |
  | 2328 | 2379 |  |
  | 2329 | 2380 | if(isset($path)){ |
  | 2330 | 2381 | if(@file\_exists($path)){ |
  | 2331 | 2382 | $filesize = filesize($path); |
  | 2332 | 2383 |  |
  | 2333 | 2384 | if($filesize > 0){ |
  | 2334 | 2385 | $myfile = fopen($path, "r") or die("Unable to open file!"); |
  | 2335 | 2386 | $data = fread($myfile, $filesize); |
  | 2336 | 2387 | fclose($myfile); |
  | 2337 | 2388 |  |
  | 2338 | 2389 | return $data; |
  | 2339 | 2390 | }else{ |
  | 2340 | 2391 | return false; |
  | 2341 | 2392 | } |
  | 2342 | 2393 | } |
  | 2343 | 2394 | } |
  | 2344 | 2395 |  |
  | 2345 | 2396 |  |
  | 2346 | 2397 | } |
  | 2347 | 2398 |  |
  | 2348 | 2399 | return false; |
  | 2349 | 2400 | } |
  | 2350 | 2401 |  |
  | 2351 | 2402 | public function get\_operating\_systems(){ |
  | 2352 | 2403 | $operating\_systems  = array( |
  | 2353 | 2404 | 'Android', |
  | 2354 | 2405 | 'blackberry|\bBB10\b|rim\stablet\sos', |
  | 2355 | 2406 | 'PalmOS|avantgo|blazer|elaine|hiptop|palm|plucker|xiino', |
  | 2356 | 2407 | 'Symbian|SymbOS|Series60|Series40|SYB-[0-9]+|\bS60\b', |
  | 2357 | 2408 | 'Windows\sCE.\*(PPC|Smartphone|Mobile|[0-9]{3}x[0-9]{3})|Window\sMobile|Windows\sPhone\s[0-9.]+|WCE;', |
  | 2358 | 2409 | 'Windows\sPhone\s10.0|Windows\sPhone\s8.1|Windows\sPhone\s8.0|Windows\sPhone\sOS|XBLWP7|ZuneWP7|Windows\sNT\s6\.[23]\;\sARM\;', |
  | 2359 | 2410 | '\biPhone.\*Mobile|\biPod|\biPad', |
  | 2360 | 2411 | 'Apple-iPhone7C2', |
  | 2361 | 2412 | 'MeeGo', |
  | 2362 | 2413 | 'Maemo', |
  | 2363 | 2414 | 'J2ME\/|\bMIDP\b|\bCLDC\b', // '|Java/' produces bug #135 |
  | 2364 | 2415 | 'webOS|hpwOS', |
  | 2365 | 2416 | '\bBada\b', |
  | 2366 | 2417 | 'BREW' |
  | 2367 | 2418 | ); |
  | 2368 | 2419 | return $operating\_systems; |
  | 2369 | 2420 | } |
  | 2370 | 2421 |  |
  | 2371 | 2422 | public function get\_mobile\_browsers(){ |
  | 2372 | 2423 | $mobile\_browsers  = array( |
  | 2373 | 2424 | '\bCrMo\b|CriOS|Android.\*Chrome\/[.0-9]\*\s(Mobile)?', |
  | 2374 | 2425 | '\bDolfin\b', |
  | 2375 | 2426 | 'Opera.\*Mini|Opera.\*Mobi|Android.\*Opera|Mobile.\*OPR\/[0-9.]+|Coast\/[0-9.]+', |
  | 2376 | 2427 | 'Skyfire', |
  | 2377 | 2428 | 'Mobile\sSafari\/[.0-9]\*\sEdge', |
  | 2378 | 2429 | 'IEMobile|MSIEMobile', // |Trident/[.0-9]+ |
  | 2379 | 2430 | 'fennec|firefox.\*maemo|(Mobile|Tablet).\*Firefox|Firefox.\*Mobile|FxiOS', |
  | 2380 | 2431 | 'bolt', |
  | 2381 | 2432 | 'teashark', |
  | 2382 | 2433 | 'Blazer', |
  | 2383 | 2434 | 'Version.\*Mobile.\*Safari|Safari.\*Mobile|MobileSafari', |
  | 2384 | 2435 | 'Tizen', |
  | 2385 | 2436 | 'UC.\*Browser|UCWEB', |
  | 2386 | 2437 | 'baiduboxapp', |
  | 2387 | 2438 | 'baidubrowser', |
  | 2388 | 2439 | 'DiigoBrowser', |
  | 2389 | 2440 | 'Puffin', |
  | 2390 | 2441 | '\bMercury\b', |
  | 2391 | 2442 | 'Obigo', |
  | 2392 | 2443 | 'NF-Browser', |
  | 2393 | 2444 | 'NokiaBrowser|OviBrowser|OneBrowser|TwonkyBeamBrowser|SEMC.\*Browser|FlyFlow|Minimo|NetFront|Novarra-Vision|MQQBrowser|MicroMessenger', |
  | 2394 | 2445 | 'Android.\*PaleMoon|Mobile.\*PaleMoon' |
  | 2395 | 2446 | ); |
  | 2396 | 2447 | return $mobile\_browsers; |
  | 2397 | 2448 | } |
  | 2398 | 2449 |  |
  | 2399 | 2450 |  |
  | 2400 | 2451 | } |
  | 2401 | 2452 |  |
  | 2402 | 2453 | // Load WP CLI command(s) on demand. |
  | 2403 | 2454 | if ( defined( 'WP\_CLI' ) && WP\_CLI ) { |
  | 2404 | 2455 | require\_once "inc/cli.php"; |
  | 2405 | 2456 | } |
  | 2406 | 2457 |  |
  | 2407 | 2458 | function wpfc\_clear\_all\_site\_cache(){ |
  | 2408 | 2459 | if(defined('WPFC\_DISABLE\_HOOK\_CLEAR\_ALL\_CACHE') && WPFC\_DISABLE\_HOOK\_CLEAR\_ALL\_CACHE){ |
  | 2409 | 2460 | return array("success" => false, "message" => "Clearing Cache Hook system has been disabled"); |
  | 2410 | 2461 | } |
  | 2411 | 2462 |  |
  | 2412 | 2463 | do\_action("wpfc\_clear\_all\_cache"); |
  | 2413 | 2464 | } |
  | 2414 | 2465 |  |
  | 2415 | 2466 | function wpfc\_clear\_all\_cache($minified = false){ |
  | 2416 | 2467 | if(defined('WPFC\_DISABLE\_HOOK\_CLEAR\_ALL\_CACHE') && WPFC\_DISABLE\_HOOK\_CLEAR\_ALL\_CACHE){ |
  | 2417 | 2468 | return array("success" => false, "message" => "Clearing Cache Hook system has been disabled"); |
  | 2418 | 2469 | } |
  | 2419 | 2470 |  |
  | 2420 | 2471 | do\_action("wpfc\_clear\_all\_cache", $minified); |
  | 2421 | 2472 | } |
  | 2422 | 2473 |  |
  | 2423 | 2474 | function wpfc\_exclude\_current\_page(){ |
  | 2424 | 2475 | do\_action("wpfc\_exclude\_current\_page"); |
  | 2425 | 2476 | } |
  | 2426 | 2477 |  |
  | 2427 | 2478 | function wpfc\_clear\_post\_cache\_by\_id($post\_id = false){ |
  | 2428 | 2479 | if($post\_id){ |
  | 2429 | 2480 | do\_action("wpfc\_clear\_post\_cache\_by\_id", false, $post\_id); |
  | 2430 | 2481 | } |
  | 2431 | 2482 | } |
  | 2432 | 2483 |  |
  | 2433 | 2484 | $GLOBALS["wp\_fastest\_cache"] = new WpFastestCache(); |
  | 2434 | 2485 | ?> |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2893158)
* [Zip Archive](?format=zip&new=2893158)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_87f5c0f3_20250115_082830.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WP Fastest Cache <= 1.1.2 - Missing Authorization in 'wpfc\_preload\_single\_callback'

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WP Fastest Cache <= 1.1.2 - Missing Authorization in 'wpfc\_preload\_single\_callback'

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2023-1928](https://www.cve.org/CVERecord?id=CVE-2023-1928) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | April 6, 2023 |
| Last Updated | April 7, 2023 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The WP Fastest Cache plugin for WordPress is vulnerable to unauthorized data modification due to a missing capability check on the wpfc\_preload\_single\_callback function in versions up to, and including, 1.1.2. This makes it possible for authenticated attackers with subscriber-level access to initiate cache creation.

Wordfence blocked **1,718 attacks** targeting this vulnerability in the past 24 hours.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2893158/wp-fastest-cache/trunk/wpFastestCache.php?contextall=1)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-fastest-cache%2Fwp-fastest-cache-112-missing-authorization-in-wpfc-preload-single-callback&t=WP%20Fastest%20Cache%20%3C%3D%201.1.2%20-%20Missing%20Authorization%20in%20%27wpfc_preload_single_callback%27 "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-fastest-cache%2Fwp-fastest-cache-112-missing-authorization-in-wpfc-preload-single-callback&text=WP%20Fastest%20Cache%20%3C%3D%201.1.2%20-%20Missing%20Authorization%20in%20%27wpfc_preload_single_callback%27 "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-fastest-cache%2Fwp-fastest-cache-112-missing-authorization-in-wpfc-preload-single-callback "LinkedIn")
Email

## Vulnerability Details for WP Fastest Cache

#### [WP Fastest Cache](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-fastest-cache)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-fastest-cache [(view on wordpress.org)](https://wordpress.org/plugins/wp-fastest-cache) |
| Patched? | Yes |
| Remediation | Update to version 1.1.3, or a newer patched version |
| Affected Version | * <= 1.1.2 |
| Patched Version | * 1.1.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


