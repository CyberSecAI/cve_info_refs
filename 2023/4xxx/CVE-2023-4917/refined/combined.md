=== Content from www.wordfence.com_352adcaa_20250114_191535.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Leyka <= 3.30.7 - Authenticated (Subscriber+) Sensitive Information Exposure

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Leyka <= 3.30.7 - Authenticated (Subscriber+) Sensitive Information Exposure

5.3

**Exposure of Sensitive Information to an Unauthorized Actor**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:N/A:N)

| CVE | [CVE-2023-4917](https://www.cve.org/CVERecord?id=CVE-2023-4917) |
| --- | --- |
| CVSS | 5.3 (Medium) |
| Publicly Published | September 12, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Leyka plugin for WordPress is vulnerable to Sensitive Information Exposure in versions up to, and including, 3.30.7 via the 'leyka\_ajax\_get\_env\_and\_options' function. This can allow authenticated attackers with subscriber-level permissions or above to extract sensitive data including Sberbank API key and password, PayPal Client Secret, and more keys and passwords.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/leyka/tags/3.30.3/inc/leyka-ajax.php#L393)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2990146/leyka)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fleyka%2Fleyka-3303-authenticated-subscriber-sensitive-information-exposure&t=Leyka%20%3C%3D%203.30.7%20-%20Authenticated%20%28Subscriber%2B%29%20Sensitive%20Information%20Exposure "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fleyka%2Fleyka-3303-authenticated-subscriber-sensitive-information-exposure&text=Leyka%20%3C%3D%203.30.7%20-%20Authenticated%20%28Subscriber%2B%29%20Sensitive%20Information%20Exposure "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fleyka%2Fleyka-3303-authenticated-subscriber-sensitive-information-exposure "LinkedIn")
Email

## Vulnerability Details for Leyka

#### [Leyka](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/leyka)

| Software Type | Plugin |
| --- | --- |
| Software Slug | leyka [(view on wordpress.org)](https://wordpress.org/plugins/leyka) |
| Patched? | Yes |
| Remediation | Update to version 3.30.7.1, or a newer patched version |
| Affected Version | * <= 3.30.7 |
| Patched Version | * 3.30.7.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_ccd1b862_20250114_191534.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fleyka%2Ftags%2F3.30.3%2Finc%2Fleyka-ajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/leyka/tags/3.30.3/inc/leyka-ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/leyka/tags/3.30.3/inc/leyka-ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [leyka](/browser/leyka?order=name "View leyka")/[tags](/browser/leyka/tags?order=name "View tags")/[3.30.3](/browser/leyka/tags/3.30.3?order=name "View 3.30.3")/[inc](/browser/leyka/tags/3.30.3/inc?order=name "View inc")/[leyka-ajax.php](/browser/leyka/tags/3.30.3/inc/leyka-ajax.php?order=name "View leyka-ajax.php")

View diff against:

View revision:

| [Last change](/changeset/2931924/leyka/tags/3.30.3/inc/leyka-ajax.php "View differences") on this file was [2931924](/changeset/2931924/ "View changeset 2931924"), checked in by Ahaenor, [19 months ago](/timeline?from=2023-06-28T15%3A52%3A58Z&precision=second "See timeline at 06/28/2023 03:52:58 PM") |
| --- |
| * V.3.30.3 - release. |
| **File size:** 60.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php if( !defined('WPINC') ) die; |
| [2](#L2) | /\*\* Different ajax handler functions \*/ |
| [3](#L3) |  |
| [4](#L4) | /\*\* @todo Check if this handler & its request are still in use \*/ |
| [5](#L5) | function leyka\_ajax\_get\_campaigns\_list() { |
| [6](#L6) |  |
| [7](#L7) | if(empty($\_REQUEST['nonce']) || !wp\_verify\_nonce($\_REQUEST['nonce'], 'leyka\_get\_campaigns\_list\_nonce')) { |
| [8](#L8) | die(json\_encode([])); |
| [9](#L9) | } |
| [10](#L10) |  |
| [11](#L11) | $\_REQUEST['term'] = empty($\_REQUEST['term']) ? '' : trim($\_REQUEST['term']); |
| [12](#L12) |  |
| [13](#L13) | $campaigns = leyka\_get\_campaigns\_list([ |
| [14](#L14) | 'posts\_per\_page' => 10, |
| [15](#L15) | 'meta\_query' => [[ |
| [16](#L16) | 'key' => 'payment\_title', 'value' => $\_REQUEST['term'], 'compare' => 'LIKE', 'type' => 'CHAR', |
| [17](#L17) | ]], |
| [18](#L18) | ], false); |
| [19](#L19) |  |
| [20](#L20) | $ids\_found = []; |
| [21](#L21) | $count = count($campaigns); |
| [22](#L22) | for($i = 0; $i < $count; $i++) { |
| [23](#L23) |  |
| [24](#L24) | $ids\_found[] = $campaigns[$i]->id; |
| [25](#L25) | $campaigns[$i] = [ |
| [26](#L26) | 'value' => $campaigns[$i]->id, |
| [27](#L27) | 'label' => $campaigns[$i]->title, |
| [28](#L28) | 'payment\_title' => $campaigns[$i]->payment\_title, |
| [29](#L29) | ]; |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | $campaigns\_tmp = leyka\_get\_campaigns\_list([ |
| [33](#L33) | 's' => $\_REQUEST['term'], |
| [34](#L34) | 'posts\_per\_page' => 10, |
| [35](#L35) | 'post\_\_not\_in' => $ids\_found, |
| [36](#L36) | ], false); |
| [37](#L37) |  |
| [38](#L38) | foreach($campaigns\_tmp as $campaign) { // Any criteria search - low priority |
| [39](#L39) | if( !in\_array($campaign->id, $ids\_found) ) { |
| [40](#L40) | $campaigns[] = [ |
| [41](#L41) | 'value' => $campaign->id, |
| [42](#L42) | 'label' => $campaign->title, |
| [43](#L43) | 'payment\_title' => $campaign->payment\_title, |
| [44](#L44) | ]; |
| [45](#L45) | } |
| [46](#L46) | } |
| [47](#L47) |  |
| [48](#L48) | die(json\_encode($campaigns)); |
| [49](#L49) |  |
| [50](#L50) | } |
| [51](#L51) | add\_action('wp\_ajax\_leyka\_get\_campaigns\_list', 'leyka\_ajax\_get\_campaigns\_list'); |
| [52](#L52) | add\_action('wp\_ajax\_nopriv\_leyka\_get\_campaigns\_list', 'leyka\_ajax\_get\_campaigns\_list'); |
| [53](#L53) |  |
| [54](#L54) | function leyka\_recalculate\_total\_funded\_action(){ |
| [55](#L55) |  |
| [56](#L56) | if( !wp\_verify\_nonce($\_GET['nonce'], 'leyka\_recalculate\_total\_funded\_amount') ) { |
| [57](#L57) | wp\_die(\_\_('Error: incorrect request parameters', 'leyka')); |
| [58](#L58) | } |
| [59](#L59) |  |
| [60](#L60) | if(empty($\_GET['campaign\_id'])) { |
| [61](#L61) | wp\_die(\_\_('Error: campaign ID is missing', 'leyka')); |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) | $campaign = new Leyka\_Campaign(absint($\_GET['campaign\_id'])); |
| [65](#L65) | $campaign->update\_total\_funded\_amount(); |
| [66](#L66) |  |
| [67](#L67) | wp\_die($campaign->total\_funded); |
| [68](#L68) |  |
| [69](#L69) | } |
| [70](#L70) | add\_action('wp\_ajax\_leyka\_recalculate\_total\_funded\_amount', 'leyka\_recalculate\_total\_funded\_action'); |
| [71](#L71) | add\_action('wp\_ajax\_nopriv\_leyka\_recalculate\_total\_funded\_amount', 'leyka\_recalculate\_total\_funded\_action'); |
| [72](#L72) |  |
| [73](#L73) |  |
| [74](#L74) | function leyka\_get\_gateway\_redirect\_data(){ |
| [75](#L75) |  |
| [76](#L76) | leyka()->clear\_session\_errors(); // Clear all previous submits errors, if there are some |
| [77](#L77) |  |
| [78](#L78) | $form\_errors = Leyka\_Payment\_Form::is\_form\_fields\_valid(); |
| [79](#L79) | if(is\_array($form\_errors) && count($form\_errors) > 0) { |
| [80](#L80) |  |
| [81](#L81) | $form\_errors = reset($form\_errors); // Return only the first error in the list |
| [82](#L82) |  |
| [83](#L83) | /\*\* @var WP\_Error $form\_errors \*/ |
| [84](#L84) | die(json\_encode(['status' => 1, 'message' => $form\_errors->get\_error\_message(),])); |
| [85](#L85) |  |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | $pm = leyka\_pf\_get\_payment\_method\_value(); |
| [89](#L89) |  |
| [90](#L90) | if(empty($\_POST['without\_form\_submission'])) { // Normal donation submit procedure |
| [91](#L91) |  |
| [92](#L92) | $donation\_id = leyka()->log\_submission(); |
| [93](#L93) |  |
| [94](#L94) | if( !is\_wp\_error($donation\_id) ) { |
| [95](#L95) |  |
| [96](#L96) | leyka\_remember\_donation\_data(['donation\_id' => $donation\_id,]); |
| [97](#L97) |  |
| [98](#L98) | do\_action( |
| [99](#L99) | 'leyka\_payment\_form\_submission-'.$pm['gateway\_id'], |
| [100](#L100) | $pm['gateway\_id'], |
| [101](#L101) | implode('-', array\_slice($pm, 1)), |
| [102](#L102) | $donation\_id, |
| [103](#L103) | $\_POST |
| [104](#L104) | ); |
| [105](#L105) |  |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | $payment\_vars = [ |
| [109](#L109) | 'status' => 0, |
| [110](#L110) | 'payment\_url' => apply\_filters('leyka\_submission\_redirect\_url-'.$pm['gateway\_id'], '', $pm['payment\_method\_id']), |
| [111](#L111) | 'submission\_redirect\_type' => apply\_filters( |
| [112](#L112) | 'leyka\_submission\_redirect\_type-'.$pm['gateway\_id'], |
| [113](#L113) | 'auto', $pm['payment\_method\_id'], $donation\_id |
| [114](#L114) | ), |
| [115](#L115) | ]; |
| [116](#L116) |  |
| [117](#L117) | if(is\_wp\_error($donation\_id)) { |
| [118](#L118) |  |
| [119](#L119) | $payment\_vars['errors'] = $donation\_id; |
| [120](#L120) | $payment\_vars['message'] = $donation\_id->get\_error\_message(); |
| [121](#L121) | $payment\_vars['status'] = 1; |
| [122](#L122) |  |
| [123](#L123) | } else if(leyka()->payment\_form\_has\_errors()) { |
| [124](#L124) |  |
| [125](#L125) | $error = leyka()->get\_payment\_form\_errors(); |
| [126](#L126) | $error = reset($error); |
| [127](#L127) |  |
| [128](#L128) | $payment\_vars['errors'] = $error; |
| [129](#L129) | $payment\_vars['message'] = $error->get\_error\_message(); |
| [130](#L130) | $payment\_vars['status'] = 1; |
| [131](#L131) |  |
| [132](#L132) | } else { // Donation created successfully |
| [133](#L133) |  |
| [134](#L134) | $payment\_vars['donation\_id'] = $donation\_id; |
| [135](#L135) | $donation = Leyka\_Donations::get\_instance()->get($donation\_id); |
| [136](#L136) |  |
| [137](#L137) | if( // Direct integration with GUA - checkout event: |
| [138](#L138) | leyka\_options()->opt('use\_gtm\_ua\_integration') === 'enchanced\_ua\_only' |
| [139](#L139) | && leyka\_options()->opt('gtm\_ua\_tracking\_id') |
| [140](#L140) | ) { |
| [141](#L141) |  |
| [142](#L142) | require\_once LEYKA\_PLUGIN\_DIR.'vendor/autoload.php'; |
| [143](#L143) |  |
| [144](#L144) | $analytics = new TheIconic\Tracking\GoogleAnalytics\Analytics(true); |
| [145](#L145) | $analytics // Main params: |
| [146](#L146) | ->setProtocolVersion('1') |
| [147](#L147) | ->setTrackingId(leyka\_options()->opt('gtm\_ua\_tracking\_id')) |
| [148](#L148) | ->setClientId($donation->ga\_client\_id ? $donation->ga\_client\_id : leyka\_gua\_get\_client\_id()) |
| [149](#L149) | ->setDocumentLocationUrl(get\_permalink($donation->campaign\_id)) |
| [150](#L150) | // Transaction params: |
| [151](#L151) | ->setTransactionId($donation\_id) |
| [152](#L152) | ->setAffiliation(get\_bloginfo('name')) |
| [153](#L153) | ->setRevenue($donation->amount) |
| [154](#L154) | ->addProduct([ // Donation params |
| [155](#L155) | 'name' => $donation->payment\_title, |
| [156](#L156) | 'price' => $donation->amount, |
| [157](#L157) | 'brand' => get\_bloginfo('name'), // Mb, it won't work with it |
| [158](#L158) | 'category' => $donation->type\_label, // Mb, it won't work with it |
| [159](#L159) | 'quantity' => 1, |
| [160](#L160) | ]) |
| [161](#L161) | ->setProductActionToCheckout() |
| [162](#L162) | ->setCheckoutStep(1) |
| [163](#L163) | ->setCheckoutStepOption($donation->pm\_label) |
| [164](#L164) | ->setEventCategory('Checkout') |
| [165](#L165) | ->setEventAction('Checkout') // 'Purchase' |
| [166](#L166) | ->sendEvent(); |
| [167](#L167) |  |
| [168](#L168) | } // Direct integration with GUA - checkout event END |
| [169](#L169) |  |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | $payment\_vars = array\_merge( |
| [173](#L173) | apply\_filters('leyka\_submission\_form\_data-'.$pm['gateway\_id'], $\_POST, $pm['payment\_method\_id'], $donation\_id), |
| [174](#L174) | $payment\_vars |
| [175](#L175) | ); |
| [176](#L176) |  |
| [177](#L177) | } else { // Get payment vars without donation submit |
| [178](#L178) | $payment\_vars = array\_merge( |
| [179](#L179) | apply\_filters('leyka\_submission\_form\_data-'.$pm['gateway\_id'], $\_POST, $pm['payment\_method\_id'], false), |
| [180](#L180) | [ |
| [181](#L181) | 'status' => 0, |
| [182](#L182) | 'payment\_url' => apply\_filters('leyka\_submission\_redirect\_url-'.$pm['gateway\_id'], '', $pm['payment\_method\_id']), |
| [183](#L183) | ] |
| [184](#L184) | ); |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | die(json\_encode($payment\_vars)); |
| [188](#L188) |  |
| [189](#L189) | } |
| [190](#L190) | add\_action('wp\_ajax\_leyka\_ajax\_get\_gateway\_redirect\_data', 'leyka\_get\_gateway\_redirect\_data'); |
| [191](#L191) | add\_action('wp\_ajax\_nopriv\_leyka\_ajax\_get\_gateway\_redirect\_data', 'leyka\_get\_gateway\_redirect\_data'); |
| [192](#L192) |  |
| [193](#L193) | function leyka\_process\_success\_form(){ |
| [194](#L194) |  |
| [195](#L195) | if( |
| [196](#L196) | leyka\_options()->opt('check\_nonce\_on\_public\_donor\_actions') |
| [197](#L197) | && (empty($\_POST['\_wpnonce']) || !wp\_verify\_nonce($\_POST['\_wpnonce'], 'leyka\_donor\_subscription')) |
| [198](#L198) | ) { |
| [199](#L199) | die(json\_encode([ |
| [200](#L200) | 'status' => 1, |
| [201](#L201) | 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'), |
| [202](#L202) | ])); |
| [203](#L203) | } else if(empty($\_POST['leyka\_donation\_id'])) { |
| [204](#L204) | die(json\_encode(['status' => 1, 'message' => \_\_('No donation ID found in the submitted data', 'leyka'),])); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | $donation = Leyka\_Donations::get\_instance()->get($\_POST['leyka\_donation\_id']); |
| [208](#L208) | if( !$donation ) { |
| [209](#L209) | die(json\_encode(['status' => 1, 'message' => \_\_('Wrong donation ID in the submitted data', 'leyka'),])); |
| [210](#L210) | } |
| [211](#L211) |  |
| [212](#L212) | if(isset($\_POST['leyka\_donor\_name']) && leyka\_validate\_donor\_name($\_POST['leyka\_donor\_name'])) { |
| [213](#L213) | $donation->donor\_name = $\_POST['leyka\_donor\_name']; |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | if(isset($\_POST['leyka\_donor\_email']) && leyka\_validate\_email($\_POST['leyka\_donor\_email'])) { |
| [217](#L217) |  |
| [218](#L218) | $donation->donor\_email = $donation->donor\_email ? $donation->donor\_email : $\_POST['leyka\_donor\_email']; |
| [219](#L219) | $donation->donor\_subscription\_email = $\_POST['leyka\_donor\_email']; |
| [220](#L220) | $donation->donor\_subscribed = $donation->campaign\_id; |
| [221](#L221) |  |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | leyka\_remembered\_data('donation\_id', false, true); // Delete the donor data cookie |
| [225](#L225) |  |
| [226](#L226) | die(json\_encode(['status' => 0,])); |
| [227](#L227) |  |
| [228](#L228) | } |
| [229](#L229) | add\_action('wp\_ajax\_leyka\_donor\_subscription', 'leyka\_process\_success\_form'); |
| [230](#L230) | add\_action('wp\_ajax\_nopriv\_leyka\_donor\_subscription', 'leyka\_process\_success\_form'); |
| [231](#L231) |  |
| [232](#L232) | function leyka\_set\_campaign\_photo(){ |
| [233](#L233) |  |
| [234](#L234) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'set-campaign-photo')) { |
| [235](#L235) | die(json\_encode([ |
| [236](#L236) | 'status' => 'error', |
| [237](#L237) | 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'), |
| [238](#L238) | ])); |
| [239](#L239) | } else if(empty($\_POST['campaign\_id'])) { |
| [240](#L240) | die(json\_encode([ |
| [241](#L241) | 'status' => 'error', |
| [242](#L242) | 'message' => \_\_('Error: campaign ID is missing', 'leyka'), |
| [243](#L243) | ])); |
| [244](#L244) | } |
| [245](#L245) |  |
| [246](#L246) | $attachment\_id = absint($\_POST['attachment\_id']); |
| [247](#L247) | $campaign\_id = absint($\_POST['campaign\_id']); |
| [248](#L248) |  |
| [249](#L249) | update\_post\_meta($campaign\_id, '\_thumbnail\_id', $attachment\_id); |
| [250](#L250) | sleep(1); |
| [251](#L251) |  |
| [252](#L252) | die(json\_encode(['status' => 'ok', 'post' => $\_POST,])); |
| [253](#L253) |  |
| [254](#L254) | } |
| [255](#L255) | add\_action('wp\_ajax\_leyka\_set\_campaign\_photo', 'leyka\_set\_campaign\_photo'); |
| [256](#L256) |  |
| [257](#L257) | function leyka\_set\_campaign\_attachment(){ |
| [258](#L258) |  |
| [259](#L259) | $\_POST['campaign\_id'] = empty($\_POST['campaign\_id']) ? false : absint($\_POST['campaign\_id']); |
| [260](#L260) | $\_POST['attachment\_id'] = empty($\_POST['attachment\_id']) ? false : absint($\_POST['attachment\_id']); |
| [261](#L261) |  |
| [262](#L262) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'set-campaign-attachment')) { |
| [263](#L263) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [264](#L264) | } else if(empty($\_POST['campaign\_id'])) { |
| [265](#L265) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: campaign ID is missing', 'leyka'),])); |
| [266](#L266) | } else if(empty($\_POST['field\_name'])) { |
| [267](#L267) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: field name is missing', 'leyka'),])); |
| [268](#L268) | } |
| [269](#L269) |  |
| [270](#L270) | update\_post\_meta($\_POST['campaign\_id'], esc\_attr($\_POST['field\_name']), $\_POST['attachment\_id']); |
| [271](#L271) | sleep(1); |
| [272](#L272) |  |
| [273](#L273) | die(json\_encode([ |
| [274](#L274) | 'status' => 'ok', |
| [275](#L275) | 'post' => $\_POST, |
| [276](#L276) | 'img\_url' => wp\_get\_attachment\_image\_url(absint($\_POST['attachment\_id']), 'thumbnail'), |
| [277](#L277) | ])); |
| [278](#L278) |  |
| [279](#L279) | } |
| [280](#L280) | add\_action('wp\_ajax\_leyka\_set\_campaign\_attachment', 'leyka\_set\_campaign\_attachment'); |
| [281](#L281) |  |
| [282](#L282) | function leyka\_set\_campaign\_template(){ |
| [283](#L283) |  |
| [284](#L284) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'set-campaign-template')) { |
| [285](#L285) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [286](#L286) | } else if(empty($\_POST['campaign\_id'])) { |
| [287](#L287) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: campaign ID is missing', 'leyka'),])); |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | update\_post\_meta(absint($\_POST['campaign\_id']), 'campaign\_template', $\_POST['template']); |
| [291](#L291) |  |
| [292](#L292) | die(json\_encode(['status' => 'ok', 'post' => $\_POST,])); |
| [293](#L293) |  |
| [294](#L294) | } |
| [295](#L295) | add\_action('wp\_ajax\_leyka\_set\_campaign\_template', 'leyka\_set\_campaign\_template'); |
| [296](#L296) |  |
| [297](#L297) | function leyka\_edit\_campaign\_slug(){ |
| [298](#L298) |  |
| [299](#L299) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka-edit-campaign-slug')) { |
| [300](#L300) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [301](#L301) | } else if(empty($\_POST['campaign\_id']) || empty($\_POST['slug'])) { |
| [302](#L302) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: the campaign data needed are missing', 'leyka'),])); |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | $campaign = get\_post($\_POST['campaign\_id']); |
| [306](#L306) | if( !$campaign || $campaign->post\_type !== Leyka\_Campaign\_Management::$post\_type ) { |
| [307](#L307) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: wrong campaign ID given', 'leyka'),])); |
| [308](#L308) | } |
| [309](#L309) |  |
| [310](#L310) | $\_POST['slug'] = wp\_unique\_post\_slug(sanitize\_title($\_POST['slug']), $\_POST['campaign\_id'], $campaign->post\_status, $campaign->post\_type, null); |
| [311](#L311) |  |
| [312](#L312) | $res = wp\_update\_post([ |
| [313](#L313) | 'ID' => absint($\_POST['campaign\_id']), |
| [314](#L314) | 'post\_name' => $\_POST['slug'], |
| [315](#L315) | ]); |
| [316](#L316) |  |
| [317](#L317) | if($res) { |
| [318](#L318) | die(json\_encode(['status' => 'ok', 'slug' => $\_POST['slug'],])); |
| [319](#L319) | } else { |
| [320](#L320) | die(json\_encode(['status' => 'error', 'message' => \_\_("Error: the campaign slug wasn't updated", 'leyka'),])); |
| [321](#L321) | } |
| [322](#L322) |  |
| [323](#L323) | } |
| [324](#L324) | add\_action('wp\_ajax\_leyka\_edit\_campaign\_slug', 'leyka\_edit\_campaign\_slug'); |
| [325](#L325) |  |
| [326](#L326) | function leyka\_update\_pm\_list(){ |
| [327](#L327) |  |
| [328](#L328) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka-update-pm-order')) { |
| [329](#L329) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [330](#L330) | } else if(empty($\_POST['pm\_order'])) { |
| [331](#L331) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: PM order value is missing', 'leyka'),])); |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | leyka\_options()->opt('pm\_order', $\_POST['pm\_order']); |
| [335](#L335) | leyka\_options()->opt('pm\_available', explode('&', str\_replace('pm\_order[]=', '', $\_POST['pm\_order']))); |
| [336](#L336) |  |
| [337](#L337) | if( !empty($\_POST['pm\_labels']) && is\_array($\_POST['pm\_labels']) ) { |
| [338](#L338) | foreach($\_POST['pm\_labels'] as $pm\_full\_id => $pm\_label) { |
| [339](#L339) | leyka\_options()->opt($pm\_full\_id, $pm\_label); |
| [340](#L340) | } |
| [341](#L341) | } |
| [342](#L342) |  |
| [343](#L343) | die(json\_encode(['status' => 'ok',])); |
| [344](#L344) |  |
| [345](#L345) | } |
| [346](#L346) | add\_action('wp\_ajax\_leyka\_update\_pm\_list', 'leyka\_update\_pm\_list'); |
| [347](#L347) |  |
| [348](#L348) | function leyka\_upload\_l10n(){ |
| [349](#L349) |  |
| [350](#L350) | $url = 'https://translate.wordpress.org/projects/wp-plugins/leyka/stable/ru/default/export-translations?format=mo'; |
| [351](#L351) | $file = download\_url($url, 60); |
| [352](#L352) |  |
| [353](#L353) | $res = null; |
| [354](#L354) |  |
| [355](#L355) | if(is\_wp\_error($file)) { |
| [356](#L356) | $res = ['status' => 'error', 'message' => 'Ошибка! Не удалось скачать файл локализации. '.$file->get\_error\_message()]; |
| [357](#L357) | } else { |
| [358](#L358) |  |
| [359](#L359) | if( !is\_dir(WP\_CONTENT\_DIR."/languages") ) { |
| [360](#L360) | $res = ['status' => 'error', 'message' => sprintf('Ошибка! Папка локализации не найдена: %s', WP\_CONTENT\_DIR.'/languages')]; |
| [361](#L361) | } else if( !is\_dir(WP\_CONTENT\_DIR.'/languages/plugins') ) { |
| [362](#L362) | $res = [ |
| [363](#L363) | 'status' => 'error', |
| [364](#L364) | 'message' => sprintf('Ошибка! Папка локализации плагинов не найдена: %s', WP\_CONTENT\_DIR.'/languages/plugins') |
| [365](#L365) | ]; |
| [366](#L366) | } else { |
| [367](#L367) |  |
| [368](#L368) | try { |
| [369](#L369) | if(copy($file, WP\_CONTENT\_DIR.'/languages/plugins/leyka-ru\_RU.mo')) { |
| [370](#L370) | unlink($file); |
| [371](#L371) | } else { |
| [372](#L372) | $res = [ |
| [373](#L373) | 'status' => 'error', |
| [374](#L374) | 'message' => sprintf('Ошибка! Нет прав для записи в папку %s', WP\_CONTENT\_DIR.'/languages/plugins') |
| [375](#L375) | ]; |
| [376](#L376) | } |
| [377](#L377) | } catch(Exception $ex) { |
| [378](#L378) | $res = ['status' => 'error', 'message' => 'Ошибка! Не удалось установить файл локализации! '.$ex->getMessage()]; |
| [379](#L379) | } |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | if( !$res ) { |
| [385](#L385) | $res = ['status' => 'ok', 'message' => 'Перевод успешно загружен',]; |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | die(json\_encode($res)); |
| [389](#L389) |  |
| [390](#L390) | } |
| [391](#L391) | add\_action('wp\_ajax\_leyka\_upload\_l10n', 'leyka\_upload\_l10n'); |
| [392](#L392) |  |
| [393](#L393) | function leyka\_ajax\_get\_env\_and\_options(){ |
| [394](#L394) | die('<pre>'.format\_debug\_data(humanaize\_debug\_data(leyka\_get\_env\_and\_options())).'</pre>'); |
| [395](#L395) | } |
| [396](#L396) | add\_action('wp\_ajax\_leyka\_get\_env\_and\_options', 'leyka\_ajax\_get\_env\_and\_options'); |
| [397](#L397) |  |
| [398](#L398) | function leyka\_setup\_donor\_password(){ |
| [399](#L399) |  |
| [400](#L400) | $res = ['status' => 'ok', 'message' => \_\_('The password is set. Welcome to your personal account!', 'leyka')]; |
| [401](#L401) |  |
| [402](#L402) | if( |
| [403](#L403) | leyka\_options()->opt('check\_nonce\_on\_public\_donor\_actions') |
| [404](#L404) | && (empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_account\_password\_setup')) |
| [405](#L405) | ) { |
| [406](#L406) | $res = [ |
| [407](#L407) | 'status' => 'error', |
| [408](#L408) | 'message' => sprintf(\_\_('Wrong request. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [409](#L409) | ]; |
| [410](#L410) | } else if( |
| [411](#L411) | empty($\_POST['leyka\_donor\_pass']) |
| [412](#L412) | || empty($\_POST['leyka\_donor\_pass2']) |
| [413](#L413) | || $\_POST['leyka\_donor\_pass'] !== $\_POST['leyka\_donor\_pass2'] |
| [414](#L414) | || empty($\_POST['donor\_account\_email']) |
| [415](#L415) | || !leyka\_is\_email($\_POST['donor\_account\_email']) |
| [416](#L416) | ) { |
| [417](#L417) | $res = ['status' => 'error', 'message' => sprintf(\_\_('Wrong request data. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email())]; |
| [418](#L418) | } else { |
| [419](#L419) |  |
| [420](#L420) | $donor\_account = get\_user\_by('email', $\_POST['donor\_account\_email']); |
| [421](#L421) | if( !$donor\_account ) { |
| [422](#L422) |  |
| [423](#L423) | die(json\_encode([ |
| [424](#L424) | 'status' => 'error', |
| [425](#L425) | 'message' => sprintf(\_\_('Wrong request data. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [426](#L426) | ])); |
| [427](#L427) |  |
| [428](#L428) | } else if( |
| [429](#L429) | !$donor\_account->user\_login |
| [430](#L430) | || !is\_a(check\_password\_reset\_key( |
| [431](#L431) | (empty($\_POST['donor\_account\_password\_reset\_code']) ? '' : $\_POST['donor\_account\_password\_reset\_code']), |
| [432](#L432) | $donor\_account->user\_login |
| [433](#L433) | ), 'WP\_User') |
| [434](#L434) | ) { |
| [435](#L435) |  |
| [436](#L436) | die(json\_encode([ |
| [437](#L437) | 'status' => 'error', |
| [438](#L438) | 'message' => sprintf(\_\_('Wrong request data. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [439](#L439) | ])); |
| [440](#L440) |  |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | try { |
| [444](#L444) | $donor = new Leyka\_Donor($\_POST['donor\_account\_email']); |
| [445](#L445) | } catch(Exception $e) { |
| [446](#L446) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong Donor ID given', 'leyka')])); |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | $donor->password = $\_POST['leyka\_donor\_pass']; |
| [450](#L450) | $donor->account\_activation\_code = false; |
| [451](#L451) |  |
| [452](#L452) | if( !empty($\_POST['auto-login']) ) { // Password initial setup (account activation) |
| [453](#L453) |  |
| [454](#L454) | $donor\_logged\_in = $donor->login($\_POST['leyka\_donor\_pass'], true); |
| [455](#L455) |  |
| [456](#L456) | if(is\_wp\_error($donor\_logged\_in)) { /\*\* @var $donor\_logged\_in WP\_Error \*/ |
| [457](#L457) | $res = ['status' => 'error', 'message' => strip\_tags($donor\_logged\_in->get\_error\_message()),]; |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | } else { // Password resetting |
| [461](#L461) | $res = ['status' => 'ok', 'message' => sprintf(\_\_('The password is changed. You may <a href="%s">log in</a>', 'leyka'), home\_url('/donor-account/login/'))]; |
| [462](#L462) | } |
| [463](#L463) |  |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | die(json\_encode($res)); |
| [467](#L467) |  |
| [468](#L468) | } |
| [469](#L469) | add\_action('wp\_ajax\_leyka\_setup\_donor\_password', 'leyka\_setup\_donor\_password'); |
| [470](#L470) | add\_action('wp\_ajax\_nopriv\_leyka\_setup\_donor\_password', 'leyka\_setup\_donor\_password'); |
| [471](#L471) |  |
| [472](#L472) | function leyka\_donor\_login(){ |
| [473](#L473) |  |
| [474](#L474) | $res = ['status' => 'ok', 'message' => \_\_('You are logged in and will be redirected in a moment. Welcome to your personal account :)', 'leyka')]; |
| [475](#L475) |  |
| [476](#L476) | if( |
| [477](#L477) | leyka\_options()->opt('check\_nonce\_on\_public\_donor\_actions') |
| [478](#L478) | && (empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_donor\_login')) |
| [479](#L479) | ) { |
| [480](#L480) | $res = [ |
| [481](#L481) | 'status' => 'error', |
| [482](#L482) | 'message' => sprintf(\_\_('Wrong request. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [483](#L483) | ]; |
| [484](#L484) | } else if( |
| [485](#L485) | empty($\_POST['leyka\_donor\_email']) |
| [486](#L486) | || !is\_email($\_POST['leyka\_donor\_email']) |
| [487](#L487) | || empty($\_POST['leyka\_donor\_pass']) |
| [488](#L488) | ) { |
| [489](#L489) | $res = [ |
| [490](#L490) | 'status' => 'error', |
| [491](#L491) | 'message' => sprintf(\_\_('Wrong request data. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [492](#L492) | ]; |
| [493](#L493) | } else { |
| [494](#L494) |  |
| [495](#L495) | try { |
| [496](#L496) | $donor = new Leyka\_Donor($\_POST['leyka\_donor\_email']); |
| [497](#L497) | } catch(Exception $e) { |
| [498](#L498) | $donor = false; |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | if( !$donor ) { |
| [502](#L502) | $res = ['status' => 'error', 'message' => \_\_('Incorrect email or password.', 'leyka'),]; |
| [503](#L503) | } else if( !$donor->has\_account\_access ) { |
| [504](#L504) | $res = ['status' => 'error', 'message' => \_\_("You don't have an access for the donor account yet.", 'leyka'),]; |
| [505](#L505) | } else { |
| [506](#L506) |  |
| [507](#L507) | $donor\_logged\_in = $donor->login($\_POST['leyka\_donor\_pass'], true); |
| [508](#L508) |  |
| [509](#L509) | if(is\_wp\_error($donor\_logged\_in)) { |
| [510](#L510) | $res = ['status' => 'error', 'message' => strip\_tags($donor\_logged\_in->get\_error\_message()),]; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | die(json\_encode($res)); |
| [518](#L518) |  |
| [519](#L519) | } |
| [520](#L520) | add\_action('wp\_ajax\_leyka\_donor\_login', 'leyka\_donor\_login'); |
| [521](#L521) | add\_action('wp\_ajax\_nopriv\_leyka\_donor\_login', 'leyka\_donor\_login'); |
| [522](#L522) |  |
| [523](#L523) | function leyka\_donor\_password\_reset\_request(){ |
| [524](#L524) |  |
| [525](#L525) | $res = ['status' => 'ok', 'message' => \_\_('Your password is ready to reset! Check your email for the confirmation link.', 'leyka')]; |
| [526](#L526) |  |
| [527](#L527) | if( |
| [528](#L528) | leyka\_options()->opt('check\_nonce\_on\_public\_donor\_actions') |
| [529](#L529) | && (empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_donor\_password\_reset')) |
| [530](#L530) | ) { |
| [531](#L531) | $res = [ |
| [532](#L532) | 'status' => 'error', |
| [533](#L533) | 'message' => sprintf(\_\_('Wrong request. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [534](#L534) | ]; |
| [535](#L535) | } else if(empty($\_POST['leyka\_donor\_email']) || !is\_email($\_POST['leyka\_donor\_email'])) { |
| [536](#L536) | $res = [ |
| [537](#L537) | 'status' => 'error', |
| [538](#L538) | 'message' => sprintf(\_\_('Wrong request data. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [539](#L539) | ]; |
| [540](#L540) | } else { |
| [541](#L541) |  |
| [542](#L542) | try { |
| [543](#L543) | $donor = new Leyka\_Donor($\_POST['leyka\_donor\_email']); |
| [544](#L544) | } catch(Exception $e) { |
| [545](#L545) | $donor = false; |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | if( !$donor ) { |
| [549](#L549) | $res = ['status' => 'error', 'message' => \_\_('Incorrect email.', 'leyka'),]; |
| [550](#L550) | } else { |
| [551](#L551) |  |
| [552](#L552) | $pass\_reset\_key = $donor->get\_password\_reset\_key(); |
| [553](#L553) |  |
| [554](#L554) | if($pass\_reset\_key && !is\_wp\_error($pass\_reset\_key)) { |
| [555](#L555) |  |
| [556](#L556) | $email\_text = sprintf( |
| [557](#L557) | \_\_("Hello, %s!\n\nYou received this email because someone asked to reset your email on the <a href='%s'>%s</a> website.\n\nIf it was not you, just ignore this email and nothing will happen.\n\n If you really wish to reset your password, click <a href='%s' target='\_blank'>here</a>.\n\nGood day to you!", 'leyka'), |
| [558](#L558) | $donor->display\_name, |
| [559](#L559) | home\_url(), |
| [560](#L560) | get\_bloginfo('name'), |
| [561](#L561) | home\_url('/donor-account/reset-password/?code='.$pass\_reset\_key.'&donor='.urlencode($\_POST['leyka\_donor\_email'])) |
| [562](#L562) | ); |
| [563](#L563) |  |
| [564](#L564) | add\_filter('wp\_mail\_content\_type', 'leyka\_set\_html\_content\_type'); |
| [565](#L565) |  |
| [566](#L566) | $email\_sent = wp\_mail( |
| [567](#L567) | $\_POST['leyka\_donor\_email'], |
| [568](#L568) | apply\_filters('leyka\_email\_donor\_password\_reset\_title', \_\_('Your account access resetting', 'leyka'), $donor), |
| [569](#L569) | wpautop(apply\_filters('leyka\_email\_donor\_password\_reset\_text', $email\_text, $donor)), |
| [570](#L570) | [ |
| [571](#L571) | 'From: '.apply\_filters( |
| [572](#L572) | 'leyka\_email\_from\_name', |
| [573](#L573) | leyka\_options()->opt\_safe('email\_from\_name'), |
| [574](#L574) | $donor |
| [575](#L575) | ).' <'.leyka\_options()->opt\_safe('email\_from').'>', |
| [576](#L576) | ] |
| [577](#L577) | ); |
| [578](#L578) | if( !$email\_sent ) { |
| [579](#L579) | $res = [ |
| [580](#L580) | 'status' => 'error', |
| [581](#L581) | 'message' => sprintf(\_\_('Sorry, we could not send the password resetting email to you. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [582](#L582) | ]; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | remove\_filter('wp\_mail\_content\_type', 'leyka\_set\_html\_content\_type'); |
| [586](#L586) |  |
| [587](#L587) | } else { |
| [588](#L588) | $res = ['status' => 'error', 'message' => \_\_("Can't get the password reset key.", 'leyka'),]; |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | } |
| [592](#L592) |  |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | die(json\_encode($res)); |
| [596](#L596) |  |
| [597](#L597) | } |
| [598](#L598) | add\_action('wp\_ajax\_leyka\_donor\_password\_reset\_request', 'leyka\_donor\_password\_reset\_request'); |
| [599](#L599) | add\_action('wp\_ajax\_nopriv\_leyka\_donor\_password\_reset\_request', 'leyka\_donor\_password\_reset\_request'); |
| [600](#L600) |  |
| [601](#L601) | function leyka\_get\_donations\_history\_page() { |
| [602](#L602) |  |
| [603](#L603) | $res = ['status' => 'ok', 'items\_html' => '']; |
| [604](#L604) |  |
| [605](#L605) | if( |
| [606](#L606) | leyka\_options()->opt('check\_nonce\_on\_public\_donor\_actions') |
| [607](#L607) | && (empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_get\_donor\_donations\_history')) |
| [608](#L608) | ) { |
| [609](#L609) | die(json\_encode(['status' => 'error',])); |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | if(empty($\_POST['donor\_id']) || empty($\_POST['page'])) { |
| [613](#L613) | die(json\_encode(['status' => 'error',])); |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | try { |
| [617](#L617) | $donor = new Leyka\_Donor(absint($\_POST['donor\_id'])); |
| [618](#L618) | } catch(Exception $e) { |
| [619](#L619) | die(json\_encode(['status' => 'error',])); |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | foreach($donor->get\_donations(absint($\_POST['page'])) as $donation) { |
| [623](#L623) | $res['items\_html'] .= leyka\_get\_donor\_account\_donations\_list\_item\_html(false, $donation)."\n"; |
| [624](#L624) | } |
| [625](#L625) |  |
| [626](#L626) | die(json\_encode($res)); |
| [627](#L627) |  |
| [628](#L628) | } |
| [629](#L629) | add\_action('wp\_ajax\_leyka\_get\_donations\_history\_page', 'leyka\_get\_donations\_history\_page'); |
| [630](#L630) | add\_action('wp\_ajax\_nopriv\_leyka\_get\_donations\_history\_page', 'leyka\_get\_donations\_history\_page'); |
| [631](#L631) |  |
| [632](#L632) | function leyka\_cancel\_recurring\_subscription(){ |
| [633](#L633) |  |
| [634](#L634) | if( |
| [635](#L635) | leyka\_options()->opt('check\_nonce\_on\_public\_donor\_actions') |
| [636](#L636) | && (empty($\_POST['\_wpnonce']) || !wp\_verify\_nonce($\_POST['\_wpnonce'], 'leyka\_cancel\_subscription')) |
| [637](#L637) | ) { |
| [638](#L638) | die(json\_encode([ |
| [639](#L639) | 'status' => 'error', |
| [640](#L640) | 'message' => sprintf(\_\_('Wrong request. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_options()->opt('tech\_support\_email')) |
| [641](#L641) | ])); |
| [642](#L642) | } else if(empty($\_POST['leyka\_campaign\_id']) || empty($\_POST['leyka\_donation\_id'])) { |
| [643](#L643) | die(json\_encode([ |
| [644](#L644) | 'status' => 'error', |
| [645](#L645) | 'message' => sprintf(\_\_('Wrong request data. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka\_options()->opt('tech\_support\_email')) |
| [646](#L646) | ])); |
| [647](#L647) | } |
| [648](#L648) |  |
| [649](#L649) | $campaign\_id = absint($\_POST['leyka\_campaign\_id']); |
| [650](#L650) | $donation\_id = absint($\_POST['leyka\_donation\_id']); |
| [651](#L651) |  |
| [652](#L652) | try { |
| [653](#L653) | $donor = new Leyka\_Donor(get\_current\_user\_id()); |
| [654](#L654) | } catch(Exception $e) { |
| [655](#L655) | $donor = false; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | $campaign = new Leyka\_Campaign($campaign\_id); |
| [659](#L659) | $init\_recurring\_donation = Leyka\_Donations::get\_instance()->get($donation\_id); |
| [660](#L660) |  |
| [661](#L661) | $cancel\_reasons = is\_array($\_POST['leyka\_cancel\_subscription\_reason']) ? |
| [662](#L662) | $\_POST['leyka\_cancel\_subscription\_reason'] : [$\_POST['leyka\_cancel\_subscription\_reason']]; |
| [663](#L663) |  |
| [664](#L664) | if($cancel\_reasons) { |
| [665](#L665) |  |
| [666](#L666) | $leyka\_possible\_reasons = leyka\_get\_recurring\_subscription\_cancelling\_reasons(); |
| [667](#L667) | $reason\_text\_lines = []; |
| [668](#L668) |  |
| [669](#L669) | foreach($cancel\_reasons as $reason) { |
| [670](#L670) |  |
| [671](#L671) | if($reason === 'other') { |
| [672](#L672) | $line = sprintf(\_\_('Other reason: %s', 'leyka'), isset($\_POST['leyka\_donor\_custom\_reason']) ? $\_POST['leyka\_donor\_custom\_reason'] : ''); |
| [673](#L673) | } else { |
| [674](#L674) | $line = $leyka\_possible\_reasons[$reason]; |
| [675](#L675) | } |
| [676](#L676) |  |
| [677](#L677) | $reason\_text\_lines[] = $line; |
| [678](#L678) |  |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | $reason\_text = implode("\n", $reason\_text\_lines); |
| [682](#L682) |  |
| [683](#L683) | } else { |
| [684](#L684) | $reason\_text = ''; |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | if( !$donor || !$donor->has\_account\_access ) { |
| [688](#L688) | die(json\_encode([ |
| [689](#L689) | 'status' => 'error', |
| [690](#L690) | 'message' => \_\_('This operation is allowed only for registered donors.', 'leyka'), |
| [691](#L691) | ])); |
| [692](#L692) | } else if( !$campaign ) { |
| [693](#L693) | die(json\_encode([ |
| [694](#L694) | 'status' => 'error', |
| [695](#L695) | 'message' => sprintf(\_\_('The campaign #%s is not found. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), $campaign\_id, leyka()->opt('tech\_support\_email')) |
| [696](#L696) | ])); |
| [697](#L697) | } else if( !$init\_recurring\_donation ) { |
| [698](#L698) | die(json\_encode([ |
| [699](#L699) | 'status' => 'error', |
| [700](#L700) | 'message' => sprintf(\_\_('Donation #%s is not found. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), $donation\_id, leyka()->opt('tech\_support\_email')) |
| [701](#L701) | ])); |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | $res = ['status' => 'ok', 'message' => \_\_('Your request to unsubscribe accepted.', 'leyka')]; |
| [705](#L705) |  |
| [706](#L706) | $donation\_gateway = leyka\_get\_gateway\_by\_id($init\_recurring\_donation->gateway\_id); |
| [707](#L707) | if($donation\_gateway->has\_recurring\_auto\_cancelling\_support) { // Recurring auto-cancelling supported - do it |
| [708](#L708) |  |
| [709](#L709) | $cancelling\_result = $donation\_gateway->cancel\_recurring\_subscription($init\_recurring\_donation); |
| [710](#L710) |  |
| [711](#L711) | if(is\_wp\_error($cancelling\_result)) { /\*\* @var $cancelling\_result WP\_Error \*/ |
| [712](#L712) | die( json\_encode(['status' => 'error', 'message' => $cancelling\_result->get\_error\_message()]) ); |
| [713](#L713) | } else if( !$cancelling\_result ) { |
| [714](#L714) | die(json\_encode([ |
| [715](#L715) | 'status' => 'error', |
| [716](#L716) | 'message' => sprintf(\_\_('Error while trying to cancel the recurring subscription.<br><br>Please, email abount this to the <a href="mailto:%s" target="\_blank">website tech. support</a>.<br><br>We are very sorry for inconvenience.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [717](#L717) | ])); |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | $init\_recurring\_donation->recurring\_cancel\_reason = $reason\_text; |
| [721](#L721) |  |
| [722](#L722) | $res['message'] = \_\_('Your recurring subscription cancelled.', 'leyka'); |
| [723](#L723) |  |
| [724](#L724) | } else { // We can only "request to cancel a recurring subscription", so the website admin could cancel it manually |
| [725](#L725) |  |
| [726](#L726) | $init\_recurring\_donation->cancel\_recurring\_requested = true; // Save unsubscribe request flag |
| [727](#L727) |  |
| [728](#L728) | $email\_text = sprintf( |
| [729](#L729) | \_\_("Hello!\n\nDonor %s with email %s and ID %s would like to unsubscribe from campaign <a href='%s'>%s</a> with ID %s on the <a href='%s'>%s</a> website.\n\nLink to subscription: %s\n\nThe reasons are:\n%s", 'leyka'), |
| [730](#L730) | $donor->name, |
| [731](#L731) | $donor->email, |
| [732](#L732) | $donor->id, |
| [733](#L733) | $campaign->permalink, |
| [734](#L734) | $campaign->title, |
| [735](#L735) | $campaign->ID, |
| [736](#L736) | home\_url(), |
| [737](#L737) | get\_bloginfo('name'), |
| [738](#L738) | admin\_url('admin.php?page=leyka\_donation\_info&donation='.$init\_recurring\_donation->id), |
| [739](#L739) | $reason\_text |
| [740](#L740) | ); |
| [741](#L741) | add\_filter('wp\_mail\_content\_type', 'leyka\_set\_html\_content\_type'); |
| [742](#L742) |  |
| [743](#L743) | $email\_sent = wp\_mail( |
| [744](#L744) | leyka\_get\_dm\_list\_or\_alternatives(), |
| [745](#L745) | apply\_filters('leyka\_email\_manager\_cancel\_subscription\_title', \_\_('New cancel campaign subscription request', 'leyka'), $donor, $campaign), |
| [746](#L746) | wpautop(apply\_filters('leyka\_email\_manager\_cancel\_subscription\_text', $email\_text, $donor, $campaign)), |
| [747](#L747) | [ |
| [748](#L748) | 'From: '.apply\_filters('leyka\_email\_from\_name', leyka\_options()->opt\_safe('email\_from\_name'), $donor) |
| [749](#L749) | .' <'.leyka\_options()->opt\_safe('email\_from').'>', |
| [750](#L750) | ] |
| [751](#L751) | ); |
| [752](#L752) |  |
| [753](#L753) | if( !$email\_sent ) { |
| [754](#L754) | $res = [ |
| [755](#L755) | 'status' => 'error', |
| [756](#L756) | 'message' => sprintf(\_\_('Sorry, we could not send unsubscription request. Please, <a href="mailto:%s" target="\_blank">contact the website tech. support</a> about it.', 'leyka'), leyka()->opt('tech\_support\_email')) |
| [757](#L757) | ]; |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | remove\_filter('wp\_mail\_content\_type', 'leyka\_set\_html\_content\_type'); |
| [761](#L761) |  |
| [762](#L762) | } |
| [763](#L763) |  |
| [764](#L764) | if(in\_array('uncomfortable\_pm', $cancel\_reasons) || in\_array('too\_much', $cancel\_reasons)) { |
| [765](#L765) | $res['redirect\_to'] = $campaign->url; |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | die(json\_encode($res)); |
| [769](#L769) |  |
| [770](#L770) | } |
| [771](#L771) | add\_action('wp\_ajax\_leyka\_cancel\_recurring', 'leyka\_cancel\_recurring\_subscription'); // leyka\_unsubscribe\_persistent\_campaign |
| [772](#L772) | add\_action('wp\_ajax\_nopriv\_leyka\_cancel\_recurring', 'leyka\_cancel\_recurring\_subscription'); |
| [773](#L773) |  |
| [774](#L774) | function leyka\_cancel\_recurring\_subscription\_by\_manager(){ |
| [775](#L775) |  |
| [776](#L776) | $donation\_id = absint($\_POST['donation\_id']); |
| [777](#L777) | $init\_recurring\_donation = Leyka\_Donations::get\_instance()->get($donation\_id); |
| [778](#L778) |  |
| [779](#L779) | if( $\_POST['state'] === 'true' && !$init\_recurring\_donation->recurring\_is\_active ) { |
| [780](#L780) | $init\_recurring\_donation->recurring\_is\_active = 'true'; |
| [781](#L781) | } else if( $\_POST['state'] !== 'true' && $init\_recurring\_donation->recurring\_is\_active ) { |
| [782](#L782) |  |
| [783](#L783) | $donation\_gateway = leyka\_get\_gateway\_by\_id($init\_recurring\_donation->gateway\_id); |
| [784](#L784) | $donation\_gateway->cancel\_recurring\_subscription($init\_recurring\_donation); |
| [785](#L785) |  |
| [786](#L786) | } |
| [787](#L787) |  |
| [788](#L788) | die(json\_encode(['status' => 'ok'])); |
| [789](#L789) |  |
| [790](#L790) | } |
| [791](#L791) | add\_action('wp\_ajax\_leyka\_cancel\_recurring\_by\_manager', 'leyka\_cancel\_recurring\_subscription\_by\_manager'); |
| [792](#L792) |  |
| [793](#L793) | function leyka\_reset\_campaign\_attachment(){ |
| [794](#L794) |  |
| [795](#L795) | $\_POST['campaign\_id'] = empty($\_POST['campaign\_id']) ? false : absint($\_POST['campaign\_id']); |
| [796](#L796) | $\_POST['attachment\_id'] = empty($\_POST['attachment\_id']) ? false : absint($\_POST['attachment\_id']); |
| [797](#L797) |  |
| [798](#L798) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'reset-campaign-attachment')) { |
| [799](#L799) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [800](#L800) | } else if(empty($\_POST['campaign\_id'])) { |
| [801](#L801) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: campaign ID is missing', 'leyka'),])); |
| [802](#L802) | } else if(empty($\_POST['img\_mission'])) { |
| [803](#L803) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: field name is missing', 'leyka'),])); |
| [804](#L804) | } |
| [805](#L805) |  |
| [806](#L806) | delete\_post\_meta($\_POST['campaign\_id'], 'campaign\_'.esc\_attr(sanitize\_text\_field($\_POST['img\_mission']))); |
| [807](#L807) |  |
| [808](#L808) | die(json\_encode(['status' => 'ok',])); |
| [809](#L809) |  |
| [810](#L810) | } |
| [811](#L811) | add\_action('wp\_ajax\_leyka\_reset\_campaign\_attachment', 'leyka\_reset\_campaign\_attachment'); |
| [812](#L812) |  |
| [813](#L813) | function leyka\_usage\_stats\_y(){ |
| [814](#L814) |  |
| [815](#L815) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'usage\_stats\_y')) { |
| [816](#L816) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | update\_option('leyka\_plugin\_stats\_option\_needs\_sync', time()); |
| [820](#L820) | $stats\_option\_synch\_res = leyka\_sync\_plugin\_stats\_option(); |
| [821](#L821) |  |
| [822](#L822) | if(is\_wp\_error($stats\_option\_synch\_res)) { |
| [823](#L823) | die(json\_encode([ |
| [824](#L824) | 'status' => 'error', |
| [825](#L825) | 'message' => \_\_('Connection to leyka statistics server failed!', 'leyka'), |
| [826](#L826) | ])); |
| [827](#L827) | } else { |
| [828](#L828) |  |
| [829](#L829) | delete\_option('leyka\_plugin\_stats\_option\_needs\_sync'); |
| [830](#L830) | update\_option('leyka\_plugin\_stats\_option\_sync\_done', time()); |
| [831](#L831) |  |
| [832](#L832) | leyka()->opt('send\_plugin\_stats', 'y'); |
| [833](#L833) |  |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | die(json\_encode(['status' => 'ok', 'message' => \_\_('Thank you!', 'leyka'),])); |
| [837](#L837) |  |
| [838](#L838) | } |
| [839](#L839) | add\_action('wp\_ajax\_leyka\_usage\_stats\_y', 'leyka\_usage\_stats\_y'); |
| [840](#L840) |  |
| [841](#L841) | function leyka\_donors\_autocomplete(){ |
| [842](#L842) |  |
| [843](#L843) | $search\_query = isset($\_GET['term']) ? sanitize\_text\_field($\_GET['term']) : ''; |
| [844](#L844) | $res = []; |
| [845](#L845) |  |
| [846](#L846) | if( !$search\_query ) { |
| [847](#L847) | die(json\_encode($res)); |
| [848](#L848) | } |
| [849](#L849) |  |
| [850](#L850) | if(isset($\_GET['type']) && $\_GET['type'] === 'users') { // Search for donors in user accounts |
| [851](#L851) |  |
| [852](#L852) | $donors = get\_users([ |
| [853](#L853) | 'role\_\_in' => [Leyka\_Donor::DONOR\_USER\_ROLE,], |
| [854](#L854) | 'number' => 10, |
| [855](#L855) | 'search' => '\*'.str\_replace('\*', '', $search\_query).'\*', |
| [856](#L856) | 'search\_columns' => ['login', 'nicename', 'email'], |
| [857](#L857) | ]); |
| [858](#L858) |  |
| [859](#L859) | foreach($donors as $donor) { |
| [860](#L860) | $res[] = [ |
| [861](#L861) | 'label' => sprintf('%s (%s)', $donor->display\_name, $donor->user\_email), |
| [862](#L862) | 'value' => $donor->user\_email |
| [863](#L863) | ]; |
| [864](#L864) | } |
| [865](#L865) |  |
| [866](#L866) | } else { // Search for donors in Donations fields values |
| [867](#L867) |  |
| [868](#L868) | $donations = Leyka\_Donations::get\_instance()->get([ |
| [869](#L869) | 'status' => 'funded', |
| [870](#L870) | 'results\_limit' => 10, |
| [871](#L871) | 'donor\_name\_email' => '%'.$search\_query, |
| [872](#L872) | ]); |
| [873](#L873) |  |
| [874](#L874) | //        get\_posts([ |
| [875](#L875) | //            'post\_type' => Leyka\_Donation\_Management::$post\_type, |
| [876](#L876) | //            'post\_status' => 'funded', |
| [877](#L877) | //            'posts\_per\_page' => 10, |
| [878](#L878) | //            'meta\_query' => [ |
| [879](#L879) | //                'relation' => 'OR', |
| [880](#L880) | //                ['key' => 'leyka\_donor\_name', 'value' => $search\_query, 'compare' => 'LIKE',], |
| [881](#L881) | //                ['key' => 'leyka\_donor\_email', 'value' => $search\_query, 'compare' => 'LIKE',], |
| [882](#L882) | //            ] |
| [883](#L883) | //        ]); |
| [884](#L884) |  |
| [885](#L885) | $tmp\_res = []; // Find unique emails |
| [886](#L886) | foreach($donations as $donation) { |
| [887](#L887) |  |
| [888](#L888) | $donation = Leyka\_Donations::get\_instance()->get\_donation($donation); |
| [889](#L889) | if( !array\_key\_exists($donation->donor\_email, $tmp\_res) ) { |
| [890](#L890) | $tmp\_res[$donation->donor\_email] = $donation->donor\_name; |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | } |
| [894](#L894) | foreach($tmp\_res as $email => $name) { |
| [895](#L895) | $res[] = ['label' => sprintf('%s (%s)', $name, $email), 'value' => $email]; |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | } |
| [899](#L899) |  |
| [900](#L900) | die(json\_encode($res)); |
| [901](#L901) |  |
| [902](#L902) | } |
| [903](#L903) | add\_action('wp\_ajax\_leyka\_donors\_autocomplete', 'leyka\_donors\_autocomplete'); |
| [904](#L904) |  |
| [905](#L905) | function leyka\_gateways\_autocomplete(){ |
| [906](#L906) |  |
| [907](#L907) | $res = []; |
| [908](#L908) |  |
| [909](#L909) | $pm\_list = leyka\_get\_pm\_list(); |
| [910](#L910) | foreach($pm\_list as $pm) { |
| [911](#L911) | $res[] = ['label' => sprintf("%s (%s)", $pm->title, $pm->gateway->title), 'value' => $pm->full\_id]; |
| [912](#L912) | } |
| [913](#L913) |  |
| [914](#L914) | die(json\_encode($res)); |
| [915](#L915) |  |
| [916](#L916) | } |
| [917](#L917) | add\_action('wp\_ajax\_leyka\_gateways\_autocomplete', 'leyka\_gateways\_autocomplete'); |
| [918](#L918) |  |
| [919](#L919) | function leyka\_campaigns\_autocomplete(){ |
| [920](#L920) |  |
| [921](#L921) | $filter = isset($\_GET['term']) ? sanitize\_text\_field($\_GET['term']) : ''; |
| [922](#L922) | $res = []; |
| [923](#L923) |  |
| [924](#L924) | $campaigns = leyka\_get\_campaigns\_list(['s' => $filter,], false); |
| [925](#L925) |  |
| [926](#L926) | foreach($campaigns as $campaign) { |
| [927](#L927) | $res[] = ['value' => $campaign->id, 'label' => $campaign->title, 'payment\_title' => $campaign->payment\_title,]; |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | die(json\_encode($res)); |
| [931](#L931) |  |
| [932](#L932) | } |
| [933](#L933) | add\_action('wp\_ajax\_leyka\_campaigns\_autocomplete', 'leyka\_campaigns\_autocomplete'); |
| [934](#L934) |  |
| [935](#L935) | function leyka\_donors\_tags\_autocomplete(){ |
| [936](#L936) |  |
| [937](#L937) | $filter = isset($\_GET['term']) ? sanitize\_text\_field($\_GET['term']) : ''; |
| [938](#L938) |  |
| [939](#L939) | $res = []; |
| [940](#L940) |  |
| [941](#L941) | if($filter) { |
| [942](#L942) | $donors\_tags = get\_terms( |
| [943](#L943) | Leyka\_Donor::DONORS\_TAGS\_TAXONOMY\_NAME, |
| [944](#L944) | ['hide\_empty' => false, 'orderby' => 'name', 'order' => 'ASC', 'search' => $filter,] |
| [945](#L945) | ); |
| [946](#L946) | } else { |
| [947](#L947) | $donors\_tags = get\_terms( |
| [948](#L948) | Leyka\_Donor::DONORS\_TAGS\_TAXONOMY\_NAME, |
| [949](#L949) | ['hide\_empty' => false, 'orderby' => 'count', 'order' => 'DESC', 'count' => 10,] |
| [950](#L950) | ); |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | foreach($donors\_tags as $tag) { |
| [954](#L954) | $res[] = ['label' => $tag->name, 'value' => $tag->term\_id,]; |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | die(json\_encode($res)); |
| [958](#L958) |  |
| [959](#L959) | } |
| [960](#L960) | add\_action('wp\_ajax\_leyka\_donors\_tags\_autocomplete', 'leyka\_donors\_tags\_autocomplete'); |
| [961](#L961) |  |
| [962](#L962) | function leyka\_add\_donor\_comment(){ |
| [963](#L963) |  |
| [964](#L964) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_add\_donor\_comment')) { |
| [965](#L965) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | try { |
| [969](#L969) | $donor = new Leyka\_Donor(absint($\_POST['donor'])); |
| [970](#L970) | } catch(Exception $e) { |
| [971](#L971) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: donor not found', 'leyka'),])); |
| [972](#L972) | } |
| [973](#L973) |  |
| [974](#L974) | if(empty($\_POST['comment'])) { |
| [975](#L975) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: empty comment', 'leyka'),])); |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) | $comment\_text = sanitize\_text\_field($\_POST['comment']); |
| [979](#L979) | $donor->add\_comment($comment\_text); |
| [980](#L980) |  |
| [981](#L981) | $comments = $donor->get\_comments(); |
| [982](#L982) | $comment\_id = 0; |
| [983](#L983) | $comment = []; |
| [984](#L984) |  |
| [985](#L985) | foreach($comments as $donor\_comment\_id => $donor\_comment) { |
| [986](#L986) | $comment\_id = $donor\_comment\_id; |
| [987](#L987) | $comment = $donor\_comment; |
| [988](#L988) | } |
| [989](#L989) |  |
| [990](#L990) | $comment = [ |
| [991](#L991) | 'id' => $comment\_id, |
| [992](#L992) | 'text' => stripslashes(esc\_html($comment['text'])), |
| [993](#L993) | 'date' => time(), |
| [994](#L994) | 'author\_name' => $comment['author\_name'], |
| [995](#L995) | ]; |
| [996](#L996) |  |
| [997](#L997) | $comment\_table\_row\_html = leyka\_admin\_get\_donor\_comment\_table\_row($comment\_id, $comment); |
| [998](#L998) |  |
| [999](#L999) | die(json\_encode(['status' => 'ok', 'comment\_html' => $comment\_table\_row\_html])); |
| [1000](#L1000) |  |
| [1001](#L1001) | } |
| [1002](#L1002) | add\_action('wp\_ajax\_leyka\_add\_donor\_comment', 'leyka\_add\_donor\_comment'); |
| [1003](#L1003) |  |
| [1004](#L1004) | function leyka\_delete\_donor\_comment(){ |
| [1005](#L1005) |  |
| [1006](#L1006) | if(empty($\_POST['comment\_id'])) { |
| [1007](#L1007) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: undefined comment id', 'leyka'),])); |
| [1008](#L1008) | } |
| [1009](#L1009) |  |
| [1010](#L1010) | $\_POST['comment\_id'] = absint($\_POST['comment\_id']); |
| [1011](#L1011) |  |
| [1012](#L1012) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_delete\_donor\_comment')) { |
| [1013](#L1013) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | try { |
| [1017](#L1017) | $donor = new Leyka\_Donor(absint($\_POST['donor'])); |
| [1018](#L1018) | } catch(Exception $e) { |
| [1019](#L1019) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: donor not found', 'leyka'),])); |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) | try { |
| [1023](#L1023) | $donor->delete\_comment($\_POST['comment\_id']); |
| [1024](#L1024) | } catch(Exception $ex) { |
| [1025](#L1025) | die(json\_encode([ |
| [1026](#L1026) | 'status' => 'error', |
| [1027](#L1027) | 'message' => $ex->getMessage() |
| [1028](#L1028) | ])); |
| [1029](#L1029) | } |
| [1030](#L1030) |  |
| [1031](#L1031) | die(json\_encode(['status' => 'ok',])); |
| [1032](#L1032) |  |
| [1033](#L1033) | } |
| [1034](#L1034) | add\_action('wp\_ajax\_leyka\_delete\_donor\_comment', 'leyka\_delete\_donor\_comment'); |
| [1035](#L1035) |  |
| [1036](#L1036) | function leyka\_save\_editable\_comment(){ |
| [1037](#L1037) |  |
| [1038](#L1038) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_save\_editable\_str')) { |
| [1039](#L1039) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1040](#L1040) | } |
| [1041](#L1041) |  |
| [1042](#L1042) | try { |
| [1043](#L1043) | $donor = new Leyka\_Donor(absint($\_POST['donor'])); |
| [1044](#L1044) | } catch(Exception $e) { |
| [1045](#L1045) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: donor not found', 'leyka'),])); |
| [1046](#L1046) | } |
| [1047](#L1047) |  |
| [1048](#L1048) | if(empty($\_POST['text\_item\_id'])) { |
| [1049](#L1049) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: empty comment id', 'leyka'),])); |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | if(empty($\_POST['text'])) { |
| [1053](#L1053) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: empty text', 'leyka'),])); |
| [1054](#L1054) | } |
| [1055](#L1055) |  |
| [1056](#L1056) | $comment\_text = sanitize\_text\_field($\_POST['text']); |
| [1057](#L1057) | $donor->update\_comment(absint($\_POST['text\_item\_id']), $comment\_text); |
| [1058](#L1058) |  |
| [1059](#L1059) | die(json\_encode([ |
| [1060](#L1060) | 'status' => 'ok', |
| [1061](#L1061) | 'saved\_text' => stripcslashes(stripcslashes(htmlspecialchars\_decode($comment\_text))), |
| [1062](#L1062) | ])); |
| [1063](#L1063) |  |
| [1064](#L1064) | } |
| [1065](#L1065) | add\_action('wp\_ajax\_leyka\_save\_editable\_comment', 'leyka\_save\_editable\_comment'); |
| [1066](#L1066) |  |
| [1067](#L1067) | // Donor's Donations data table AJAX data source: |
| [1068](#L1068) | function leyka\_admin\_get\_donor\_donations(){ |
| [1069](#L1069) |  |
| [1070](#L1070) | try { |
| [1071](#L1071) | $donor = new Leyka\_Donor(absint($\_POST['donor\_id'])); |
| [1072](#L1072) | } catch(Exception $e) { |
| [1073](#L1073) | die( json\_encode(['draw' => (int)$\_POST['draw'], 'error' => $e->getMessage()]) ); |
| [1074](#L1074) | } |
| [1075](#L1075) |  |
| [1076](#L1076) | $\_POST['start'] = empty($\_POST['start']) ? 0 : absint($\_POST['start']); // Result record number to start from |
| [1077](#L1077) | $\_POST['length'] = empty($\_POST['length']) ? 10 : absint($\_POST['length']); // Donations per table "page" |
| [1078](#L1078) |  |
| [1079](#L1079) | $total\_donor\_donations = $donor->get\_donations\_count(); |
| [1080](#L1080) | $page\_number = ($\_POST['start']/$\_POST['length']) + 1; |
| [1081](#L1081) |  |
| [1082](#L1082) | $result = [ |
| [1083](#L1083) | 'draw' => (int)$\_POST['draw'], |
| [1084](#L1084) | 'recordsTotal' => $total\_donor\_donations, |
| [1085](#L1085) | 'recordsFiltered' => $total\_donor\_donations, |
| [1086](#L1086) | 'data' => [], |
| [1087](#L1087) | ]; |
| [1088](#L1088) |  |
| [1089](#L1089) | foreach($donor->get\_donations($page\_number, $\_POST['length']) as $donation) { |
| [1090](#L1090) |  |
| [1091](#L1091) | $gateway = leyka\_get\_gateway\_by\_id($donation->gateway\_id); |
| [1092](#L1092) |  |
| [1093](#L1093) | $result['data'][] = [ |
| [1094](#L1094) | 'donation\_id' => $donation->id, |
| [1095](#L1095) | 'payment\_type' => [ |
| [1096](#L1096) | 'id' => $donation->is\_init\_recurring\_donation ? 'rebill-init' : $donation->payment\_type, |
| [1097](#L1097) | 'label' => $donation->payment\_type\_label, |
| [1098](#L1098) | ], |
| [1099](#L1099) | 'date' => $donation->date\_time\_label, |
| [1100](#L1100) | 'status' => [ |
| [1101](#L1101) | 'id' => $donation->status, |
| [1102](#L1102) | 'label' => $donation->status\_label, |
| [1103](#L1103) | 'description' => $donation->status\_description, |
| [1104](#L1104) | ], |
| [1105](#L1105) | 'campaign\_title' => $donation->campaign\_title, |
| [1106](#L1106) | 'gateway\_pm' => [ |
| [1107](#L1107) | 'gateway\_icon\_url' => $gateway ? $gateway->icon\_url : '', |
| [1108](#L1108) | 'gateway\_label' => $donation->gateway\_label, |
| [1109](#L1109) | 'pm\_label' => $donation->pm\_label, |
| [1110](#L1110) | ], |
| [1111](#L1111) | 'amount' => [ |
| [1112](#L1112) | 'amount\_formatted' => $donation->main\_currency\_amount, |
| [1113](#L1113) | 'amount\_total\_formatted' => $donation->main\_currency\_amount\_total, |
| [1114](#L1114) | 'currency\_label' => leyka\_get\_currency\_label(), |
| [1115](#L1115) | ], |
| [1116](#L1116) | ]; |
| [1117](#L1117) |  |
| [1118](#L1118) | } |
| [1119](#L1119) |  |
| [1120](#L1120) | die(json\_encode($result)); |
| [1121](#L1121) |  |
| [1122](#L1122) | } |
| [1123](#L1123) | add\_action('wp\_ajax\_leyka\_get\_donor\_donations', 'leyka\_admin\_get\_donor\_donations'); |
| [1124](#L1124) | // Donor's Donations data table AJAX data source - END |
| [1125](#L1125) |  |
| [1126](#L1126) | // Campaign Donations data table AJAX data source: |
| [1127](#L1127) | function leyka\_admin\_get\_campaign\_donations(){ |
| [1128](#L1128) |  |
| [1129](#L1129) | $campaign = new Leyka\_Campaign($\_POST['campaign\_id']); |
| [1130](#L1130) |  |
| [1131](#L1131) | //    die( json\_encode([('draw' => (int)$\_POST['draw'], 'error' => $e->getMessage()]) ); |
| [1132](#L1132) |  |
| [1133](#L1133) | $\_POST['start'] = empty($\_POST['start']) ? 0 : absint($\_POST['start']); // Result record number to start from |
| [1134](#L1134) | $\_POST['length'] = empty($\_POST['length']) ? 10 : absint($\_POST['length']); // Donations per table "page" |
| [1135](#L1135) |  |
| [1136](#L1136) | $total\_campaign\_donations = $campaign->get\_donations\_count(); |
| [1137](#L1137) | $page\_number = ($\_POST['start'] / $\_POST['length']) + 1; |
| [1138](#L1138) |  |
| [1139](#L1139) | $result = [ |
| [1140](#L1140) | 'draw' => (int)$\_POST['draw'], |
| [1141](#L1141) | 'recordsTotal' => $total\_campaign\_donations, |
| [1142](#L1142) | 'recordsFiltered' => $total\_campaign\_donations, |
| [1143](#L1143) | 'data' => [], |
| [1144](#L1144) | ]; |
| [1145](#L1145) |  |
| [1146](#L1146) | $campaign\_donations = Leyka\_Donations::get\_instance()->get([ |
| [1147](#L1147) | 'status' => ['submitted', 'funded', 'refunded', 'failed',], |
| [1148](#L1148) | 'campaign\_id' => $campaign->id, |
| [1149](#L1149) | 'results\_limit' => $\_POST['length'], |
| [1150](#L1150) | 'page' => $page\_number, |
| [1151](#L1151) | 'orderby' => 'ID', |
| [1152](#L1152) | 'order' => 'DESC', |
| [1153](#L1153) | ]); |
| [1154](#L1154) |  |
| [1155](#L1155) | foreach($campaign\_donations as $donation) { |
| [1156](#L1156) |  |
| [1157](#L1157) | $gateway = leyka\_get\_gateway\_by\_id($donation->gateway\_id); |
| [1158](#L1158) |  |
| [1159](#L1159) | $result['data'][] = [ |
| [1160](#L1160) | 'donation\_id' => $donation->id, |
| [1161](#L1161) | 'payment\_type' => [ |
| [1162](#L1162) | 'id' => $donation->is\_init\_recurring\_donation ? 'rebill-init' : $donation->payment\_type, |
| [1163](#L1163) | 'label' => $donation->payment\_type\_label, |
| [1164](#L1164) | ], |
| [1165](#L1165) | 'donor' => [ |
| [1166](#L1166) | 'name' => $donation->donor\_name, |
| [1167](#L1167) | 'email' => $donation->donor\_email, |
| [1168](#L1168) | 'id' => leyka\_options()->opt('donor\_management\_available') && $donation->donor\_id ? $donation->donor\_id : 0, |
| [1169](#L1169) | ], |
| [1170](#L1170) | 'amount' => [ |
| [1171](#L1171) | 'amount' => $donation->amount, |
| [1172](#L1172) | 'formatted' => $donation->amount\_formatted, |
| [1173](#L1173) | 'total' => $donation->amount\_total, |
| [1174](#L1174) | 'total\_formatted' => $donation->amount\_total\_formatted, |
| [1175](#L1175) | 'currency\_label' => $donation->currency\_label, |
| [1176](#L1176) | ], |
| [1177](#L1177) | 'status' => [ |
| [1178](#L1178) | 'id' => $donation->status, |
| [1179](#L1179) | 'label' => $donation->status\_label, |
| [1180](#L1180) | 'description' => $donation->status\_description, |
| [1181](#L1181) | ], |
| [1182](#L1182) | 'date' => $donation->date\_time\_label, |
| [1183](#L1183) | 'gateway\_pm' => [ |
| [1184](#L1184) | 'gateway\_icon\_url' => $gateway ? $gateway->icon\_url : '', |
| [1185](#L1185) | 'gateway\_label' => $donation->gateway\_id == 'correction' ? |
| [1186](#L1186) | \_\_('Custom payment info', 'leyka') : $donation->gateway\_label, |
| [1187](#L1187) | 'pm\_label' => $donation->pm\_label, |
| [1188](#L1188) | ], |
| [1189](#L1189) | ]; |
| [1190](#L1190) |  |
| [1191](#L1191) | } |
| [1192](#L1192) |  |
| [1193](#L1193) | die(json\_encode($result)); |
| [1194](#L1194) |  |
| [1195](#L1195) | } |
| [1196](#L1196) | add\_action('wp\_ajax\_leyka\_get\_campaign\_donations', 'leyka\_admin\_get\_campaign\_donations'); |
| [1197](#L1197) | // Campaign Donations data table AJAX data source - END |
| [1198](#L1198) |  |
| [1199](#L1199) | // Recurring subscription Donations data table AJAX data source: |
| [1200](#L1200) | function leyka\_admin\_get\_recurring\_subscription\_donations(){ |
| [1201](#L1201) |  |
| [1202](#L1202) | $\_POST['recurring\_subscription\_id'] = absint($\_POST['recurring\_subscription\_id']); |
| [1203](#L1203) | if( !$\_POST['recurring\_subscription\_id'] ) { |
| [1204](#L1204) | die( json\_encode(['draw' => (int)$\_POST['draw'], 'error' => \_\_('Incorrect recurring subscription ID given', 'leyka')]) ); |
| [1205](#L1205) | } |
| [1206](#L1206) |  |
| [1207](#L1207) | try { |
| [1208](#L1208) | $recurring\_subscription = Leyka\_Donations::get\_instance()->get($\_POST['recurring\_subscription\_id']); |
| [1209](#L1209) | } catch(Exception $ex) { |
| [1210](#L1210) | die( json\_encode(['draw' => (int)$\_POST['draw'], 'error' => $ex->getMessage()]) ); |
| [1211](#L1211) | } |
| [1212](#L1212) |  |
| [1213](#L1213) | if( !$recurring\_subscription->is\_init\_recurring\_donation ) { |
| [1214](#L1214) | die( json\_encode(['draw' => (int)$\_POST['draw'], 'error' => \_\_('ID given is not of a recurring subscription', 'leyka')]) ); |
| [1215](#L1215) | } |
| [1216](#L1216) |  |
| [1217](#L1217) | $\_POST['start'] = empty($\_POST['start']) ? 0 : absint($\_POST['start']); // Result record number to start from |
| [1218](#L1218) | $\_POST['length'] = empty($\_POST['length']) ? 10 : absint($\_POST['length']); // Donations per table "page" |
| [1219](#L1219) |  |
| [1220](#L1220) | $total\_recurring\_donations = Leyka\_Donations::get\_instance()->get\_count([ |
| [1221](#L1221) | 'status' => ['submitted', 'funded', 'refunded', 'failed',], |
| [1222](#L1222) | 'recurring\_rebills\_of' => $recurring\_subscription->id, |
| [1223](#L1223) | 'get\_all' => true, |
| [1224](#L1224) | ]); |
| [1225](#L1225) | $page\_number = ($\_POST['start'] / $\_POST['length']) + 1; |
| [1226](#L1226) |  |
| [1227](#L1227) | $result = [ |
| [1228](#L1228) | 'draw' => (int)$\_POST['draw'], |
| [1229](#L1229) | 'recordsTotal' => $total\_recurring\_donations, |
| [1230](#L1230) | 'recordsFiltered' => $total\_recurring\_donations, |
| [1231](#L1231) | 'data' => [], |
| [1232](#L1232) | ]; |
| [1233](#L1233) |  |
| [1234](#L1234) | $donations = Leyka\_Donations::get\_instance()->get([ |
| [1235](#L1235) | 'status' => ['submitted', 'funded', 'refunded', 'failed',], |
| [1236](#L1236) | 'recurring\_rebills\_of' => $recurring\_subscription->id, |
| [1237](#L1237) | 'results\_limit' => $\_POST['length'], |
| [1238](#L1238) | 'page' => $page\_number, |
| [1239](#L1239) | 'orderby' => 'ID', |
| [1240](#L1240) | 'order' => 'DESC', |
| [1241](#L1241) | ]); |
| [1242](#L1242) |  |
| [1243](#L1243) | foreach($donations as $donation) { |
| [1244](#L1244) |  |
| [1245](#L1245) | $gateway = leyka\_get\_gateway\_by\_id($donation->gateway\_id); |
| [1246](#L1246) | $pm = $donation->gateway\_id && $donation->gateway\_id !== 'correction' ? |
| [1247](#L1247) | leyka\_get\_pm\_by\_id($donation->pm\_full\_id, true) : $donation->pm\_id; |
| [1248](#L1248) |  |
| [1249](#L1249) | if($donation->status === 'failed') { |
| [1250](#L1250) |  |
| [1251](#L1251) | $error = $donation->error; /\*\* @var $error Leyka\_Donation\_Error \*/ |
| [1252](#L1252) | $error = is\_a($error, 'Leyka\_Donation\_Error') ? |
| [1253](#L1253) | $error : Leyka\_Donations\_Errors::get\_instance()->get\_error\_by\_id(false); |
| [1254](#L1254) |  |
| [1255](#L1255) | } |
| [1256](#L1256) |  |
| [1257](#L1257) | $result['data'][] = [ |
| [1258](#L1258) | 'donation\_id' => $donation->id, |
| [1259](#L1259) | 'type' => [ |
| [1260](#L1260) | 'name' => $donation->type, |
| [1261](#L1261) | 'label' => $donation->type\_label |
| [1262](#L1262) | ], |
| [1263](#L1263) | 'donor' => [ |
| [1264](#L1264) | 'name' => $donation->donor\_name, |
| [1265](#L1265) | 'email' => $donation->donor\_email, |
| [1266](#L1266) | 'id' => leyka\_options()->opt('donor\_management\_available') && $donation->donor\_id ? $donation->donor\_id : 0, |
| [1267](#L1267) | 'email\_sent' => (bool)$donation->donor\_email\_date, |
| [1268](#L1268) | 'email\_date' => $donation->donor\_email\_date ? date('d.m.Y', $donation->donor\_email\_date) : '', |
| [1269](#L1269) | 'wp\_nonce' => wp\_create\_nonce('leyka\_donor\_email') |
| [1270](#L1270) | ], |
| [1271](#L1271) | 'date' => [ |
| [1272](#L1272) | 'date\_label' => $donation->date\_label, |
| [1273](#L1273) | 'time\_label' => $donation->time\_label |
| [1274](#L1274) | ], |
| [1275](#L1275) | 'amount' => [ |
| [1276](#L1276) | 'amount' => $donation->amount, |
| [1277](#L1277) | 'formatted' => $donation->amount\_formatted, |
| [1278](#L1278) | 'total' => $donation->amount\_total, |
| [1279](#L1279) | 'total\_formatted' => $donation->amount\_total\_formatted, |
| [1280](#L1280) | 'currency\_label' => $donation->currency\_label, |
| [1281](#L1281) | ], |
| [1282](#L1282) | 'status' => [ |
| [1283](#L1283) | 'id' => $donation->status, |
| [1284](#L1284) | 'label' => $donation->status\_label, |
| [1285](#L1285) | 'description' => $donation->status\_description, |
| [1286](#L1286) | 'error' => [ |
| [1287](#L1287) | 'id' => $donation->status === 'failed' ? $error->id : '', |
| [1288](#L1288) | 'name' => $donation->status === 'failed' ? $error->name : '', |
| [1289](#L1289) | 'full\_info' => $donation->status === 'failed' ? leyka\_show\_donation\_error\_full\_info($error, true) : '' |
| [1290](#L1290) | ] |
| [1291](#L1291) | ], |
| [1292](#L1292) | 'gateway\_pm' => [ |
| [1293](#L1293) | 'leyka\_plugin\_base\_url' => LEYKA\_PLUGIN\_BASE\_URL, // TODO: Получить в JS? |
| [1294](#L1294) | 'gateway' => [ |
| [1295](#L1295) | 'icon\_url' => $gateway ? $gateway->icon\_url : '', |
| [1296](#L1296) | 'label' => $donation->gateway\_id == 'correction' ? |
| [1297](#L1297) | \_\_('Custom payment info', 'leyka') : $donation->gateway\_label |
| [1298](#L1298) | ], |
| [1299](#L1299) | 'pm' => [ |
| [1300](#L1300) | 'label' => is\_a($pm, 'Leyka\_Payment\_Method') ? $donation->pm\_label : '', |
| [1301](#L1301) | 'admin\_icon\_url' => is\_a($pm, 'Leyka\_Payment\_Method') ? $pm->admin\_icon\_url : '' |
| [1302](#L1302) | ] |
| [1303](#L1303) | ] |
| [1304](#L1304) | ]; |
| [1305](#L1305) |  |
| [1306](#L1306) | } |
| [1307](#L1307) |  |
| [1308](#L1308) | die(json\_encode($result)); |
| [1309](#L1309) |  |
| [1310](#L1310) | } |
| [1311](#L1311) | add\_action('wp\_ajax\_leyka\_get\_recurring\_subscription\_donations', 'leyka\_admin\_get\_recurring\_subscription\_donations'); |
| [1312](#L1312) | // Recurring subscription Donations data table AJAX data source - END |
| [1313](#L1313) |  |
| [1314](#L1314) | function leyka\_save\_donor\_description(){ |
| [1315](#L1315) |  |
| [1316](#L1316) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_save\_editable\_str')) { |
| [1317](#L1317) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1318](#L1318) | } |
| [1319](#L1319) |  |
| [1320](#L1320) | try { |
| [1321](#L1321) | $donor = new Leyka\_Donor(absint($\_POST['donor'])); |
| [1322](#L1322) | } catch(Exception $e) { |
| [1323](#L1323) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: donor not found', 'leyka'),])); |
| [1324](#L1324) | } |
| [1325](#L1325) |  |
| [1326](#L1326) | $donor->description = !empty($\_POST['text']) ? sanitize\_text\_field($\_POST['text']) : ""; |
| [1327](#L1327) |  |
| [1328](#L1328) | die(json\_encode([ |
| [1329](#L1329) | 'status' => 'ok', |
| [1330](#L1330) | 'saved\_text' => stripcslashes(stripcslashes(htmlspecialchars\_decode($donor->description))), |
| [1331](#L1331) | ])); |
| [1332](#L1332) |  |
| [1333](#L1333) | } |
| [1334](#L1334) | add\_action('wp\_ajax\_leyka\_save\_donor\_description', 'leyka\_save\_donor\_description'); |
| [1335](#L1335) |  |
| [1336](#L1336) | function leyka\_save\_donor\_name(){ |
| [1337](#L1337) |  |
| [1338](#L1338) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_save\_editable\_str')) { |
| [1339](#L1339) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1340](#L1340) | } |
| [1341](#L1341) |  |
| [1342](#L1342) | try { |
| [1343](#L1343) | $donor = new Leyka\_Donor(absint($\_POST['donor'])); |
| [1344](#L1344) | } catch(Exception $e) { |
| [1345](#L1345) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: donor not found', 'leyka'),])); |
| [1346](#L1346) | } |
| [1347](#L1347) |  |
| [1348](#L1348) | $donor->name = !empty($\_POST['text']) ? sanitize\_text\_field($\_POST['text']) : ''; |
| [1349](#L1349) |  |
| [1350](#L1350) | die(json\_encode([ |
| [1351](#L1351) | 'status' => 'ok', |
| [1352](#L1352) | 'saved\_text' => stripcslashes(stripcslashes(htmlspecialchars\_decode($donor->name))), |
| [1353](#L1353) | ])); |
| [1354](#L1354) |  |
| [1355](#L1355) | } |
| [1356](#L1356) | add\_action('wp\_ajax\_leyka\_save\_donor\_name', 'leyka\_save\_donor\_name'); |
| [1357](#L1357) |  |
| [1358](#L1358) | function leyka\_save\_donor\_tags(){ |
| [1359](#L1359) |  |
| [1360](#L1360) | if(empty($\_POST['nonce']) || !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_save\_donor\_tags')) { |
| [1361](#L1361) | die(json\_encode(['status' => 'error', 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1362](#L1362) | } |
| [1363](#L1363) |  |
| [1364](#L1364) | try { |
| [1365](#L1365) | $donor = new Leyka\_Donor(absint($\_POST['donor'])); |
| [1366](#L1366) | } catch(Exception $e) { |
| [1367](#L1367) | die(json\_encode(['status' => 'error', 'message' => \_\_('Error: donor not found', 'leyka'),])); |
| [1368](#L1368) | } |
| [1369](#L1369) |  |
| [1370](#L1370) | $tags = !empty($\_POST['tags']) ? explode(',', sanitize\_text\_field($\_POST['tags'])) : ''; |
| [1371](#L1371) | wp\_set\_object\_terms($donor->id, $tags, Leyka\_Donor::DONORS\_TAGS\_TAXONOMY\_NAME); |
| [1372](#L1372) |  |
| [1373](#L1373) | die(json\_encode(['status' => 'ok',])); |
| [1374](#L1374) |  |
| [1375](#L1375) | } |
| [1376](#L1376) | add\_action('wp\_ajax\_leyka\_save\_donor\_tags', 'leyka\_save\_donor\_tags'); |
| [1377](#L1377) |  |
| [1378](#L1378) | function leyka\_close\_dashboard\_banner(){ |
| [1379](#L1379) |  |
| [1380](#L1380) | if(empty($\_POST['banner\_id'])) { |
| [1381](#L1381) | die(json\_encode(['status' => 'error',])); |
| [1382](#L1382) | } |
| [1383](#L1383) |  |
| [1384](#L1384) | try { |
| [1385](#L1385) | update\_user\_meta(get\_current\_user\_id(), 'leyka\_dashboard\_banner\_closed-'.$\_POST['banner\_id'], true); |
| [1386](#L1386) | } catch(Exception $e) { |
| [1387](#L1387) | die(json\_encode(['status' => 'error',])); |
| [1388](#L1388) | } |
| [1389](#L1389) |  |
| [1390](#L1390) | die(json\_encode(['status' => 'ok',])); |
| [1391](#L1391) |  |
| [1392](#L1392) | } |
| [1393](#L1393) | add\_action('wp\_ajax\_leyka\_close\_dashboard\_banner', 'leyka\_close\_dashboard\_banner'); |
| [1394](#L1394) |  |
| [1395](#L1395) | // Ajax files uploading handler (admin only): |
| [1396](#L1396) | function leyka\_files\_upload(){ |
| [1397](#L1397) |  |
| [1398](#L1398) | $data = array\_merge(isset($\_POST) ? $\_POST : [], isset($\_FILES) ? $\_FILES : []); |
| [1399](#L1399) |  |
| [1400](#L1400) | if( !wp\_verify\_nonce($data['nonce'], 'leyka-upload-'.$data['option\_id']) ) { |
| [1401](#L1401) | die(json\_encode(['status' => -1, 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1402](#L1402) | } |
| [1403](#L1403) |  |
| [1404](#L1404) | $uploaded\_file = wp\_handle\_upload($data['files'], ['test\_form' => false,]); |
| [1405](#L1405) |  |
| [1406](#L1406) | if($uploaded\_file && !isset($uploaded\_file['error'])) { |
| [1407](#L1407) |  |
| [1408](#L1408) | $upload\_dir\_base\_path = wp\_upload\_dir(); |
| [1409](#L1409) | $upload\_dir\_base\_path = $upload\_dir\_base\_path['basedir']; |
| [1410](#L1410) | $filename = basename($uploaded\_file['url']); |
| [1411](#L1411) |  |
| [1412](#L1412) | $response = [ |
| [1413](#L1413) | 'status' => 0, |
| [1414](#L1414) | 'filename' => $filename, |
| [1415](#L1415) | 'url' => $uploaded\_file['url'], |
| [1416](#L1416) | 'path' => str\_replace($upload\_dir\_base\_path, '', $uploaded\_file['file']), |
| [1417](#L1417) | 'type' => $uploaded\_file['type'], |
| [1418](#L1418) | ]; |
| [1419](#L1419) |  |
| [1420](#L1420) | } else { |
| [1421](#L1421) | $response = ['status' => -1, 'error' => $uploaded\_file['error'],]; |
| [1422](#L1422) | } |
| [1423](#L1423) |  |
| [1424](#L1424) | die(json\_encode($response)); |
| [1425](#L1425) |  |
| [1426](#L1426) | } |
| [1427](#L1427) | add\_action('wp\_ajax\_leyka\_files\_upload', 'leyka\_files\_upload'); |
| [1428](#L1428) |  |
| [1429](#L1429) | // Ajax handler for Donors bulk edit (admin only): |
| [1430](#L1430) | function leyka\_bulk\_edit\_donors(){ |
| [1431](#L1431) |  |
| [1432](#L1432) | if( !wp\_verify\_nonce($\_POST['nonce'], 'leyka-bulk-edit-donors') ) { |
| [1433](#L1433) | die(json\_encode(['status' => -1, 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1434](#L1434) | } |
| [1435](#L1435) |  |
| [1436](#L1436) | $\_POST['bulk-edit-action'] = empty($\_POST['bulk-edit-action']) || !in\_array($\_POST['bulk-edit-action'], ['add', 'remove', 'replace']) ? |
| [1437](#L1437) | 'add' : trim($\_POST['bulk-edit-action']); |
| [1438](#L1438) |  |
| [1439](#L1439) | if( !empty($\_POST['donors']) && !empty($\_POST['donors-bulk-tags']) ) { |
| [1440](#L1440) | foreach((array)$\_POST['donors'] as $donor\_user\_id) { |
| [1441](#L1441) |  |
| [1442](#L1442) | array\_walk($\_POST['donors-bulk-tags'], function( &$value ){ |
| [1443](#L1443) | $value = absint($value); |
| [1444](#L1444) | }); |
| [1445](#L1445) |  |
| [1446](#L1446) | if($\_POST['bulk-edit-action'] === 'add' || $\_POST['bulk-edit-action'] === 'replace') { |
| [1447](#L1447) | $result = wp\_set\_object\_terms($donor\_user\_id, $\_POST['donors-bulk-tags'], Leyka\_Donor::DONORS\_TAGS\_TAXONOMY\_NAME, $\_POST['bulk-edit-action'] === 'add'); |
| [1448](#L1448) | } else if($\_POST['bulk-edit-action'] === 'remove') { |
| [1449](#L1449) | $result = wp\_remove\_object\_terms($donor\_user\_id, $\_POST['donors-bulk-tags'], Leyka\_Donor::DONORS\_TAGS\_TAXONOMY\_NAME); |
| [1450](#L1450) | } |
| [1451](#L1451) |  |
| [1452](#L1452) | if( !empty($result) && is\_wp\_error($result)) { |
| [1453](#L1453) |  |
| [1454](#L1454) | $response = ['status' => -1, 'error' => $result->get\_error\_message(),]; |
| [1455](#L1455) | break; |
| [1456](#L1456) |  |
| [1457](#L1457) | } |
| [1458](#L1458) |  |
| [1459](#L1459) | } |
| [1460](#L1460) | } |
| [1461](#L1461) |  |
| [1462](#L1462) | die(json\_encode(['status' => 'ok',])); |
| [1463](#L1463) |  |
| [1464](#L1464) | } |
| [1465](#L1465) | add\_action('wp\_ajax\_leyka\_bulk\_edit\_donors', 'leyka\_bulk\_edit\_donors'); |
| [1466](#L1466) |  |
| [1467](#L1467) | function leyka\_delete\_extension(){ |
| [1468](#L1468) |  |
| [1469](#L1469) | if(empty($\_POST['extension\_id']) || !Leyka\_Extension::get\_by\_id($\_POST['extension\_id'])) { |
| [1470](#L1470) | die(json\_encode(['status' => -1, 'message' => \_\_('Cannot found given extension', 'leyka'),])); |
| [1471](#L1471) | } else if( !wp\_verify\_nonce($\_POST['nonce'], 'leyka\_delete\_extension\_'.$\_POST['extension\_id']) ) { |
| [1472](#L1472) | die(json\_encode(['status' => -1, 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1473](#L1473) | } |
| [1474](#L1474) |  |
| [1475](#L1475) | $extension = Leyka\_Extension::get\_by\_id($\_POST['extension\_id']); |
| [1476](#L1476) |  |
| [1477](#L1477) | if( !$extension->folder || !file\_exists($extension->folder) || !is\_dir($extension->folder) ) { |
| [1478](#L1478) | die(json\_encode(['status' => -1, 'message' => \_\_('Cannot found the extension folder', 'leyka'),])); |
| [1479](#L1479) | } |
| [1480](#L1480) |  |
| [1481](#L1481) | if( !leyka\_delete\_dir($extension->folder) ) { |
| [1482](#L1482) | die(json\_encode([ |
| [1483](#L1483) | 'status' => -1, |
| [1484](#L1484) | 'message' => sprintf(\_\_('Cannot delete the extension. Please report this problem to the <a href="mailto:%s" target="\_blank">Leyka technical support</a>.', 'leyka'), leyka\_get\_website\_tech\_support\_email()) |
| [1485](#L1485) | ])); |
| [1486](#L1486) | } |
| [1487](#L1487) |  |
| [1488](#L1488) | die(json\_encode(['status' => 0,])); |
| [1489](#L1489) |  |
| [1490](#L1490) | } |
| [1491](#L1491) | add\_action('wp\_ajax\_leyka\_delete\_extension', 'leyka\_delete\_extension'); |
| [1492](#L1492) |  |
| [1493](#L1493) | function leyka\_support\_packages\_set\_no\_campaign\_behavior(){ |
| [1494](#L1494) |  |
| [1495](#L1495) | if( !wp\_verify\_nonce($\_POST['nonce'], 'support-packages-no-campaign-behavior') ) { |
| [1496](#L1496) | die(json\_encode(['status' => -1, 'message' => \_\_('Wrong nonce in the submitted data', 'leyka'),])); |
| [1497](#L1497) | } |
| [1498](#L1498) |  |
| [1499](#L1499) | if(empty($\_POST['behavior'])) { |
| [1500](#L1500) | die(json\_encode(['status' => -1, 'message' => \_\_('No new behavior is given for the Support packages', 'leyka'),])); |
| [1501](#L1501) | } else if( !in\_array($\_POST['behavior'], ['another-campaign', 'content-open', 'content-closed',])) { |
| [1502](#L1502) | die(json\_encode(['status' => -1, 'message' => \_\_('Incorrect behavior is given for the Support packages', 'leyka'),])); |
| [1503](#L1503) | } |
| [1504](#L1504) |  |
| [1505](#L1505) | if($\_POST['behavior'] === 'another-campaign') { |
| [1506](#L1506) |  |
| [1507](#L1507) | if( !absint($\_POST['campaign\_id']) ) { |
| [1508](#L1508) | die(json\_encode(['status' => -1, 'message' => \_\_('No new campaign is given for the Support packages', 'leyka'),])); |
| [1509](#L1509) | } |
| [1510](#L1510) |  |
| [1511](#L1511) | leyka\_options()->opt('support\_packages\_campaign', absint($\_POST['campaign\_id'])); |
| [1512](#L1512) | delete\_option('leyka\_support\_packages\_no\_campaign\_behavior'); |
| [1513](#L1513) |  |
| [1514](#L1514) | } else if($\_POST['behavior'] === 'content-open') { |
| [1515](#L1515) | update\_option('leyka\_support\_packages\_no\_campaign\_behavior', 'content-open'); |
| [1516](#L1516) | } else if($\_POST['behavior'] === 'content-closed') { |
| [1517](#L1517) | update\_option('leyka\_support\_packages\_no\_campaign\_behavior', 'content-closed'); |
| [1518](#L1518) | } |
| [1519](#L1519) |  |
| [1520](#L1520) | die(json\_encode(['status' => 0,])); |
| [1521](#L1521) |  |
| [1522](#L1522) | } |
| [1523](#L1523) | add\_action('wp\_ajax\_leyka\_support\_packages\_set\_no\_campaign\_behavior', 'leyka\_support\_packages\_set\_no\_campaign\_behavior'); |
| [1524](#L1524) |  |
| [1525](#L1525) | function leyka\_ajax\_get\_currencies\_rates() { |
| [1526](#L1526) | die(json\_encode(leyka\_get\_currencies\_rates())); |
| [1527](#L1527) | } |
| [1528](#L1528) | add\_action('wp\_ajax\_leyka\_get\_currencies\_rates', 'leyka\_ajax\_get\_currencies\_rates'); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/leyka/tags/3.30.3/inc/leyka-ajax.php?format=txt)
* [Original Format](/export/3222448/leyka/tags/3.30.3/inc/leyka-ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


