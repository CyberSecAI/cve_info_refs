=== Content from www.wordfence.com_c11d3fef_20250114_212727.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Donation Forms by Charitable <= 1.7.0.12 - Unauthenticated Privilege Escalation

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Donation Forms by Charitable <= 1.7.0.12 - Unauthenticated Privilege Escalation

9.8

**Improper Privilege Management**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-4404](https://www.cve.org/CVERecord?id=CVE-2023-4404) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | August 17, 2023 |
| Last Updated | August 23, 2023 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Donation Forms by Charitable plugin for WordPress is vulnerable to privilege escalation in versions up to, and including, 1.7.0.12 due to insufficient restriction on the 'update\_core\_user' function. This makes it possible for unauthenticated attackers to specify their user role by supplying the 'role' parameter during a registration.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/charitable/tags/1.7.0.12/includes/users/class-charitable-user.php#L866)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcharitable%2Fdonation-forms-by-charitable-17012-unauthenticated-privilege-escalation&t=Donation%20Forms%20by%20Charitable%20%3C%3D%201.7.0.12%20-%20Unauthenticated%20Privilege%20Escalation "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcharitable%2Fdonation-forms-by-charitable-17012-unauthenticated-privilege-escalation&text=Donation%20Forms%20by%20Charitable%20%3C%3D%201.7.0.12%20-%20Unauthenticated%20Privilege%20Escalation "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcharitable%2Fdonation-forms-by-charitable-17012-unauthenticated-privilege-escalation "LinkedIn")
Email

## Vulnerability Details for Charitable – Donation Plugin for WordPress – Fundraising with Recurring Donations & More

#### [Charitable – Donation Plugin for WordPress – Fundraising with Recurring Donations & More](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/charitable)

| Software Type | Plugin |
| --- | --- |
| Software Slug | charitable [(view on wordpress.org)](https://wordpress.org/plugins/charitable) |
| Patched? | Yes |
| Remediation | Update to version 1.7.0.13, or a newer patched version |
| Affected Version | * <= 1.7.0.12 |
| Patched Version | * 1.7.0.13 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_1a9a123f_20250114_212725.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcharitable%2Ftags%2F1.7.0.12%2Fincludes%2Fusers%2Fclass-charitable-user.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/charitable/trunk/includes/users/class-charitable-user.php?rev=2870049 "Revision 2870049")
* [Next Revision](/browser/charitable/trunk/includes/users/class-charitable-user.php?rev=2955065 "Revision 2955065") →
* [Blame](/browser/charitable/trunk/includes/users/class-charitable-user.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/charitable/tags/1.7.0.12/includes/users/class-charitable-user.php)

---

# [source:](/browser?order=name "Go to repository root") [charitable](/browser/charitable?order=name "View charitable")/[tags](/browser/charitable/tags?order=name "View tags")/[1.7.0.12](/browser/charitable/tags/1.7.0.12?order=name "View 1.7.0.12")/[includes](/browser/charitable/tags/1.7.0.12/includes?order=name "View includes")/[users](/browser/charitable/tags/1.7.0.12/includes/users?order=name "View users")/[class-charitable-user.php](/browser/charitable/tags/1.7.0.12/includes/users/class-charitable-user.php?order=name "View class-charitable-user.php")

View diff against:

View revision:

| [Last change](/changeset/2870393/charitable/trunk/includes/users/class-charitable-user.php "View differences") on this file was [2870393](/changeset/2870393/ "View changeset 2870393"), checked in by dimensionmedia, [23 months ago](/timeline?from=2023-02-24T03%3A39%3A46Z&precision=second "See timeline at 02/24/2023 03:39:46 AM") |
| --- |
| Update to 1.7.0.10 |
| **File size:** 28.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Contains the class that models users in Charitable. |
| [4](#L4) | \* |
| [5](#L5) | \* There are several different user roles in Charitable, and one user |
| [6](#L6) | \* may be more than one. People who make donations get the "donor" role; |
| [7](#L7) | \* people who create campaigns (via Charitable Ambassadors) get |
| [8](#L8) | \* the "campaign\_creator" role; people who create fundraisers for campaigns |
| [9](#L9) | \* get the "fundraiser" role. |
| [10](#L10) | \* |
| [11](#L11) | \* @package   Charitable/Classes/Charitable\_User |
| [12](#L12) | \* @author    David Bisset |
| [13](#L13) | \* @copyright Copyright (c) 2022, WP Charitable LLC |
| [14](#L14) | \* @license   http://opensource.org/licenses/gpl-2.0.php GNU Public License |
| [15](#L15) | \* @since     1.0.0 |
| [16](#L16) | \* @version   1.6.44 |
| [17](#L17) | \*/ |
| [18](#L18) |  |
| [19](#L19) | // Exit if accessed directly. |
| [20](#L20) | if ( ! defined( 'ABSPATH' ) ) { |
| [21](#L21) | exit; |
| [22](#L22) | } |
| [23](#L23) |  |
| [24](#L24) | if ( ! class\_exists( 'Charitable\_User' ) ) : |
| [25](#L25) |  |
| [26](#L26) | /\*\* |
| [27](#L27) | \* Charitable\_User |
| [28](#L28) | \* |
| [29](#L29) | \* @since 1.0.0 |
| [30](#L30) | \* |
| [31](#L31) | \* @property string $nickname |
| [32](#L32) | \* @property string $description |
| [33](#L33) | \* @property string $user\_description |
| [34](#L34) | \* @property string $first\_name |
| [35](#L35) | \* @property string $user\_firstname |
| [36](#L36) | \* @property string $last\_name |
| [37](#L37) | \* @property string $user\_lastname |
| [38](#L38) | \* @property string $user\_login |
| [39](#L39) | \* @property string $user\_pass |
| [40](#L40) | \* @property string $user\_nicename |
| [41](#L41) | \* @property string $user\_email |
| [42](#L42) | \* @property string $user\_url |
| [43](#L43) | \* @property string $user\_registered |
| [44](#L44) | \* @property string $user\_activation\_key |
| [45](#L45) | \* @property string $user\_status |
| [46](#L46) | \* @property int    $user\_level |
| [47](#L47) | \* @property string $display\_name |
| [48](#L48) | \* @property string $spam |
| [49](#L49) | \* @property string $deleted |
| [50](#L50) | \* @property string $locale |
| [51](#L51) | \*/ |
| [52](#L52) | class Charitable\_User extends WP\_User { |
| [53](#L53) |  |
| [54](#L54) | /\*\* |
| [55](#L55) | \* The donor ID. |
| [56](#L56) | \* |
| [57](#L57) | \* NOTE: This is not the same as the user ID. |
| [58](#L58) | \* |
| [59](#L59) | \* @since 1.0.0 |
| [60](#L60) | \* |
| [61](#L61) | \* @var   int |
| [62](#L62) | \*/ |
| [63](#L63) | protected $donor\_id; |
| [64](#L64) |  |
| [65](#L65) | /\*\* |
| [66](#L66) | \* A mapping of user keys. |
| [67](#L67) | \* |
| [68](#L68) | \* @since 1.4.0 |
| [69](#L69) | \* |
| [70](#L70) | \* @var   string[] |
| [71](#L71) | \*/ |
| [72](#L72) | protected $mapped\_keys; |
| [73](#L73) |  |
| [74](#L74) | /\*\* |
| [75](#L75) | \* Core keys. |
| [76](#L76) | \* |
| [77](#L77) | \* @since  1.4.0 |
| [78](#L78) | \* |
| [79](#L79) | \* @var   string[] |
| [80](#L80) | \*/ |
| [81](#L81) | protected $core\_keys; |
| [82](#L82) |  |
| [83](#L83) | /\*\* |
| [84](#L84) | \* Create class object. |
| [85](#L85) | \* |
| [86](#L86) | \* @since  1.0.0 |
| [87](#L87) | \* |
| [88](#L88) | \* @param  int|string|stdClass|WP\_User $id      User's ID, a WP\_User object, or a user object from the DB. |
| [89](#L89) | \* @param  string                      $name    Optional. User's username. |
| [90](#L90) | \* @param  int                         $blog\_id Optional Blog ID, defaults to current blog. |
| [91](#L91) | \* @return void |
| [92](#L92) | \*/ |
| [93](#L93) | public function \_\_construct( $id = 0, $name = '', $blog\_id = '' ) { |
| [94](#L94) | parent::\_\_construct( $id, $name, $blog\_id ); |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | /\*\* |
| [98](#L98) | \* Create object using a donor ID. |
| [99](#L99) | \* |
| [100](#L100) | \* @since  1.0.0 |
| [101](#L101) | \* |
| [102](#L102) | \* @param  int $donor\_id The donor ID. |
| [103](#L103) | \* @return Charitable\_user |
| [104](#L104) | \*/ |
| [105](#L105) | public static function init\_with\_donor( $donor\_id ) { |
| [106](#L106) | $user\_id = charitable\_get\_table( 'donors' )->get\_user\_id( $donor\_id ); |
| [107](#L107) | $user    = charitable\_get\_user( $user\_id ); |
| [108](#L108) | $user->set\_donor\_id( $donor\_id ); |
| [109](#L109) | return $user; |
| [110](#L110) | } |
| [111](#L111) |  |
| [112](#L112) | /\*\* |
| [113](#L113) | \* Magic getter method. Looks for the specified key in the mapped keys before using WP\_User's \_\_get method. |
| [114](#L114) | \* |
| [115](#L115) | \* @since  1.0.0 |
| [116](#L116) | \* |
| [117](#L117) | \* @param  string $key The key to retrieve. |
| [118](#L118) | \* @return mixed |
| [119](#L119) | \*/ |
| [120](#L120) | public function \_\_get( $key ) { |
| [121](#L121) | return parent::\_\_get( $this->map\_key( $key ) ); |
| [122](#L122) | } |
| [123](#L123) |  |
| [124](#L124) | /\*\* |
| [125](#L125) | \* Display the donor name when printing the object. |
| [126](#L126) | \* |
| [127](#L127) | \* @since  1.0.0 |
| [128](#L128) | \* |
| [129](#L129) | \* @return string |
| [130](#L130) | \*/ |
| [131](#L131) | public function \_\_toString() { |
| [132](#L132) | return $this->get\_name(); |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) | /\*\* |
| [136](#L136) | \* Determine whether a property or meta key is set |
| [137](#L137) | \* |
| [138](#L138) | \* Consults the users and usermeta tables. |
| [139](#L139) | \* |
| [140](#L140) | \* @since  1.5.0 |
| [141](#L141) | \* |
| [142](#L142) | \* @param  string $key Property. |
| [143](#L143) | \* @return boolean |
| [144](#L144) | \*/ |
| [145](#L145) | public function has\_prop( $key ) { |
| [146](#L146) | return parent::has\_prop( $this->map\_key( $key ) ); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | /\*\* |
| [150](#L150) | \* Returns whether the user is logged in. |
| [151](#L151) | \* |
| [152](#L152) | \* @since  1.0.0 |
| [153](#L153) | \* |
| [154](#L154) | \* @return boolean |
| [155](#L155) | \*/ |
| [156](#L156) | public function is\_logged\_in() { |
| [157](#L157) | return 0 !== $this->ID; |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | /\*\* |
| [161](#L161) | \* Set the donor ID of this user. |
| [162](#L162) | \* |
| [163](#L163) | \* @since  1.0.0 |
| [164](#L164) | \* |
| [165](#L165) | \* @param  int $donor\_id The Donor ID. |
| [166](#L166) | \* @return void |
| [167](#L167) | \*/ |
| [168](#L168) | public function set\_donor\_id( $donor\_id ) { |
| [169](#L169) | $this->donor\_id = $donor\_id; |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | /\*\* |
| [173](#L173) | \* Return the donor ID of this user. |
| [174](#L174) | \* |
| [175](#L175) | \* @since  1.0.0 |
| [176](#L176) | \* |
| [177](#L177) | \* @return int|false $donor\_id |
| [178](#L178) | \*/ |
| [179](#L179) | public function get\_donor\_id() { |
| [180](#L180) | if ( isset( $this->donor\_id ) || ! is\_null( $this->get\_donor() ) ) { |
| [181](#L181) | return $this->donor\_id; |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | return false; |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | /\*\* |
| [188](#L188) | \* Return the donor record. |
| [189](#L189) | \* |
| [190](#L190) | \* @since  1.0.0 |
| [191](#L191) | \* |
| [192](#L192) | \* @return Object|null Object if a donor record could be matched. null if user is logged out or no donor record found. |
| [193](#L193) | \*/ |
| [194](#L194) | public function get\_donor() { |
| [195](#L195) | if ( ! $this->is\_logged\_in() && ! isset( $this->donor\_id ) ) { |
| [196](#L196) | return null; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | if ( isset( $this->donor\_id ) ) { |
| [200](#L200) |  |
| [201](#L201) | $donor = wp\_cache\_get( $this->donor\_id, 'donors' ); |
| [202](#L202) |  |
| [203](#L203) | if ( is\_object( $donor ) ) { |
| [204](#L204) | return $donor; |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | $donor = charitable\_get\_table( 'donors' )->get( $this->donor\_id ); |
| [208](#L208) |  |
| [209](#L209) | } else { |
| [210](#L210) |  |
| [211](#L211) | $donor = charitable\_get\_table( 'donors' )->get\_by( 'email', $this->get( 'user\_email' ) ); |
| [212](#L212) |  |
| [213](#L213) | if ( ! is\_object( $donor ) ) { |
| [214](#L214) | return null; |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | $this->donor\_id = $donor->donor\_id; |
| [218](#L218) |  |
| [219](#L219) | }//end if |
| [220](#L220) |  |
| [221](#L221) | wp\_cache\_add( $this->donor\_id, $donor, 'donors' ); |
| [222](#L222) |  |
| [223](#L223) | return $donor; |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) | /\*\* |
| [227](#L227) | \* Returns whether the user has ever made a donation. |
| [228](#L228) | \* |
| [229](#L229) | \* @since  1.0.0 |
| [230](#L230) | \* |
| [231](#L231) | \* @return boolean |
| [232](#L232) | \*/ |
| [233](#L233) | public function is\_donor() { |
| [234](#L234) | return ! is\_null( $this->get\_donor() ); |
| [235](#L235) | } |
| [236](#L236) |  |
| [237](#L237) | /\*\* |
| [238](#L238) | \* Returns whether the user has verified their email address. |
| [239](#L239) | \* |
| [240](#L240) | \* @since  1.5.0 |
| [241](#L241) | \* |
| [242](#L242) | \* @return int If verified, return 1. Otherwise return 0. |
| [243](#L243) | \*/ |
| [244](#L244) | public function is\_verified() { |
| [245](#L245) | return absint( get\_user\_meta( $this->ID, '\_charitable\_user\_verified', true ) ); |
| [246](#L246) | } |
| [247](#L247) |  |
| [248](#L248) | /\*\* |
| [249](#L249) | \* Mark a user as verified. |
| [250](#L250) | \* |
| [251](#L251) | \* @since  1.5.0 |
| [252](#L252) | \* |
| [253](#L253) | \* @param  boolean $verified Whether the user is verified. |
| [254](#L254) | \* @return int|boolean Meta ID if the key didn't exist, true on successful update, false on failure. |
| [255](#L255) | \*/ |
| [256](#L256) | public function mark\_as\_verified( $verified ) { |
| [257](#L257) | $verified = update\_user\_meta( $this->ID, '\_charitable\_user\_verified', $verified ); |
| [258](#L258) |  |
| [259](#L259) | if ( ! $verified ) { |
| [260](#L260) | return $verified; |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | /\* Delete the time that the verification email was sent. \*/ |
| [264](#L264) | delete\_user\_meta( $this->ID, '\_charitable\_email\_verification\_email\_send\_time' ); |
| [265](#L265) |  |
| [266](#L266) | /\* Check for a notice about having sent a verification email and remove it. \*/ |
| [267](#L267) | charitable\_get\_notices()->clear\_notice( "/We have sent you an email to confirm your email address. Haven\'t received the email\?/" ); |
| [268](#L268) |  |
| [269](#L269) | /\* Check for an existing donor account. \*/ |
| [270](#L270) | $donor\_id = $this->get\_donor\_id(); |
| [271](#L271) |  |
| [272](#L272) | if ( $donor\_id ) { |
| [273](#L273) | $donor = new Charitable\_Donor( $donor\_id ); |
| [274](#L274) | $donor->set\_user\_id( $this->ID ); |
| [275](#L275) | } |
| [276](#L276) |  |
| [277](#L277) | /\*\* |
| [278](#L278) | \* Do something when a user is verified. |
| [279](#L279) | \* |
| [280](#L280) | \* @since 1.6.23 |
| [281](#L281) | \* |
| [282](#L282) | \* @param Charitable\_User $user The user object. |
| [283](#L283) | \*/ |
| [284](#L284) | do\_action( 'charitable\_user\_verified', $this ); |
| [285](#L285) |  |
| [286](#L286) | return $verified; |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | /\*\* |
| [290](#L290) | \* Returns the email address of the donor. |
| [291](#L291) | \* |
| [292](#L292) | \* @since  1.0.0 |
| [293](#L293) | \* |
| [294](#L294) | \* @return string |
| [295](#L295) | \*/ |
| [296](#L296) | public function get\_email() { |
| [297](#L297) | if ( $this->get\_donor() ) { |
| [298](#L298) | $email = $this->get\_donor()->email; |
| [299](#L299) | } else { |
| [300](#L300) | $email = $this->get( 'user\_email' ); |
| [301](#L301) | } |
| [302](#L302) |  |
| [303](#L303) | /\*\* |
| [304](#L304) | \* Filter the user email address. |
| [305](#L305) | \* |
| [306](#L306) | \* @since 1.0.0 |
| [307](#L307) | \* |
| [308](#L308) | \* @param string          $email The email address. |
| [309](#L309) | \* @param Charitable\_User $user  This instance of `Charitable\_User`. |
| [310](#L310) | \*/ |
| [311](#L311) | return apply\_filters( 'charitable\_user\_email', $email, $this ); |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | /\*\* |
| [315](#L315) | \* Returns the display name of the user. |
| [316](#L316) | \* |
| [317](#L317) | \* @since  1.0.0 |
| [318](#L318) | \* |
| [319](#L319) | \* @return string |
| [320](#L320) | \*/ |
| [321](#L321) | public function get\_name() { |
| [322](#L322) | if ( $this->is\_donor() ) { |
| [323](#L323) | $name = rtrim( sprintf( '%s %s', $this->get\_donor()->first\_name, $this->get\_donor()->last\_name ) ); |
| [324](#L324) | } else { |
| [325](#L325) | $name = $this->display\_name; |
| [326](#L326) | } |
| [327](#L327) |  |
| [328](#L328) | if ( ! $name ) { |
| [329](#L329) | $name = ''; |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | return apply\_filters( 'charitable\_user\_name', $name, $this ); |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | /\*\* |
| [336](#L336) | \* Returns the first name of the user. |
| [337](#L337) | \* |
| [338](#L338) | \* @since  1.1.0 |
| [339](#L339) | \* |
| [340](#L340) | \* @return string |
| [341](#L341) | \*/ |
| [342](#L342) | public function get\_first\_name() { |
| [343](#L343) | if ( $this->is\_donor() && $this->get\_donor()->first\_name ) { |
| [344](#L344) | $name = $this->get\_donor()->first\_name; |
| [345](#L345) | } else { |
| [346](#L346) | $name = $this->first\_name; |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | return apply\_filters( 'charitable\_user\_first\_name', $name, $this ); |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | /\*\* |
| [353](#L353) | \* Returns the last name of the user. |
| [354](#L354) | \* |
| [355](#L355) | \* @since  1.1.0 |
| [356](#L356) | \* |
| [357](#L357) | \* @return string |
| [358](#L358) | \*/ |
| [359](#L359) | public function get\_last\_name() { |
| [360](#L360) | if ( $this->is\_donor() && $this->get\_donor()->last\_name ) { |
| [361](#L361) | $name = $this->get\_donor()->last\_name; |
| [362](#L362) | } else { |
| [363](#L363) | $name = $this->last\_name; |
| [364](#L364) | } |
| [365](#L365) | return apply\_filters( 'charitable\_user\_last\_name', $name, $this ); |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | /\*\* |
| [369](#L369) | \* Returns the user's location. |
| [370](#L370) | \* |
| [371](#L371) | \* @since  1.0.0 |
| [372](#L372) | \* |
| [373](#L373) | \* @return string |
| [374](#L374) | \*/ |
| [375](#L375) | public function get\_location() { |
| [376](#L376) | $city     = $this->get( 'donor\_city' ); |
| [377](#L377) | $state    = $this->get( 'donor\_state' ); |
| [378](#L378) | $country  = $this->get( 'donor\_country' ); |
| [379](#L379) | $location = ''; |
| [380](#L380) |  |
| [381](#L381) | if ( strlen( $city ) || strlen( $state ) ) { |
| [382](#L382) | $region = strlen( $city ) ? $city : $state; |
| [383](#L383) |  |
| [384](#L384) | if ( strlen( $country ) ) { |
| [385](#L385) | $location = sprintf( '%s, %s', $region, $country ); |
| [386](#L386) | } else { |
| [387](#L387) | $location = $region; |
| [388](#L388) | } |
| [389](#L389) | } elseif ( strlen( $country ) ) { |
| [390](#L390) | $location = $country; |
| [391](#L391) | } |
| [392](#L392) |  |
| [393](#L393) | return apply\_filters( 'charitable\_user\_location', $location, $this ); |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | /\*\* |
| [397](#L397) | \* Returns printable address of donor. |
| [398](#L398) | \* |
| [399](#L399) | \* @since  1.0.0 |
| [400](#L400) | \* |
| [401](#L401) | \* @param  int $donation\_id Optional. If set, will return the address provided for the specific donation. Otherwise, returns the current address for the user. |
| [402](#L402) | \* @return string |
| [403](#L403) | \*/ |
| [404](#L404) | public function get\_address( $donation\_id = '' ) { |
| [405](#L405) | $address\_details = false; |
| [406](#L406) |  |
| [407](#L407) | if ( $donation\_id ) { |
| [408](#L408) | $address\_details = get\_post\_meta( $donation\_id, 'donor', true ); |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | /\* If the address fields were not set by the check above, get them from the user meta. \*/ |
| [412](#L412) | if ( ! is\_array( $address\_details ) ) { |
| [413](#L413) |  |
| [414](#L414) | $address\_details = array( |
| [415](#L415) | 'first\_name' => $this->get( 'first\_name' ), |
| [416](#L416) | 'last\_name'  => $this->get( 'last\_name' ), |
| [417](#L417) | 'company'    => $this->get( 'donor\_company' ), |
| [418](#L418) | 'address'    => $this->get( 'donor\_address' ), |
| [419](#L419) | 'address\_2'  => $this->get( 'donor\_address\_2' ), |
| [420](#L420) | 'city'       => $this->get( 'donor\_city' ), |
| [421](#L421) | 'state'      => $this->get( 'donor\_state' ), |
| [422](#L422) | 'postcode'   => $this->get( 'donor\_postcode' ), |
| [423](#L423) | 'country'    => $this->get( 'donor\_country' ), |
| [424](#L424) | ); |
| [425](#L425) |  |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | /\*\* |
| [429](#L429) | \* Filter the address details for the current user. |
| [430](#L430) | \* |
| [431](#L431) | \* Please note that prior to 1.6.44, the hook used here was `charitable\_user\_address\_fields`, |
| [432](#L432) | \* which is used elsewhere in a different context and thus resulted in unexpected results. |
| [433](#L433) | \* |
| [434](#L434) | \* @since 1.6.44 |
| [435](#L435) | \* |
| [436](#L436) | \* @param array           $address\_details The address details. |
| [437](#L437) | \* @param Charitable\_User $user            The user object. |
| [438](#L438) | \* @param int             $donation\_id     The donation ID. |
| [439](#L439) | \*/ |
| [440](#L440) | $address\_details = apply\_filters( 'charitable\_user\_address\_details', $address\_details, $this, $donation\_id ); |
| [441](#L441) |  |
| [442](#L442) | return charitable\_get\_location\_helper()->get\_formatted\_address( $address\_details ); |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | /\*\* |
| [446](#L446) | \* Return all donations made by donor. |
| [447](#L447) | \* |
| [448](#L448) | \* @since  1.0.0 |
| [449](#L449) | \* |
| [450](#L450) | \* @param  boolean $distinct\_donations If true, will only count unique donations. |
| [451](#L451) | \* @return object[] |
| [452](#L452) | \*/ |
| [453](#L453) | public function get\_donations( $distinct\_donations = false ) { |
| [454](#L454) | return charitable\_get\_table( 'campaign\_donations' )->get\_donations\_by\_donor( $this->get\_donor\_id(), $distinct\_donations ); |
| [455](#L455) | } |
| [456](#L456) |  |
| [457](#L457) | /\*\* |
| [458](#L458) | \* Return the number of donations made by the donor. |
| [459](#L459) | \* |
| [460](#L460) | \* @since  1.0.0 |
| [461](#L461) | \* |
| [462](#L462) | \* @param  boolean $distinct\_donations If true, will only count unique donations. |
| [463](#L463) | \* @return int |
| [464](#L464) | \*/ |
| [465](#L465) | public function count\_donations( $distinct\_donations = false ) { |
| [466](#L466) | return charitable\_get\_table( 'campaign\_donations' )->count\_donations\_by\_donor( $this->get\_donor\_id(), $distinct\_donations ); |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Return the number of campaigns that the donor has supported. |
| [471](#L471) | \* |
| [472](#L472) | \* @since  1.0.0 |
| [473](#L473) | \* |
| [474](#L474) | \* @return int |
| [475](#L475) | \*/ |
| [476](#L476) | public function count\_campaigns\_supported() { |
| [477](#L477) | return charitable\_get\_table( 'campaign\_donations' )->count\_campaigns\_supported\_by\_donor( $this->get\_donor\_id() ); |
| [478](#L478) | } |
| [479](#L479) |  |
| [480](#L480) | /\*\* |
| [481](#L481) | \* Return the total amount donated by the donor. |
| [482](#L482) | \* |
| [483](#L483) | \* @since  1.0.0 |
| [484](#L484) | \* |
| [485](#L485) | \* @param  int $campaign\_id Optional. If set, returns total donated to this particular campaign. |
| [486](#L486) | \* @return float |
| [487](#L487) | \*/ |
| [488](#L488) | public function get\_total\_donated( $campaign\_id = false ) { |
| [489](#L489) | $amount = wp\_cache\_get( $this->get\_donor\_id(), 'charitable\_donor\_total\_donation\_amount\_' . $campaign\_id ); |
| [490](#L490) |  |
| [491](#L491) | if ( false === $amount ) { |
| [492](#L492) |  |
| [493](#L493) | $args = apply\_filters( |
| [494](#L494) | 'charitable\_user\_total\_donated\_query\_args', |
| [495](#L495) | array( |
| [496](#L496) | 'output'          => 'raw', |
| [497](#L497) | 'donor\_id'        => $this->get\_donor\_id(), |
| [498](#L498) | 'distinct\_donors' => true, |
| [499](#L499) | 'fields'          => 'amount', |
| [500](#L500) | 'campaign'        => (int) $campaign\_id, |
| [501](#L501) | ), |
| [502](#L502) | $this |
| [503](#L503) | ); |
| [504](#L504) |  |
| [505](#L505) | $query = new Charitable\_Donor\_Query( $args ); |
| [506](#L506) |  |
| [507](#L507) | $amount = $query->current()->amount; |
| [508](#L508) |  |
| [509](#L509) | wp\_cache\_set( $this->get\_donor\_id(), $amount, 'charitable\_donor\_total\_donation\_amount\_' . $campaign\_id ); |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | return (float) $amount; |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | /\*\* |
| [516](#L516) | \* Returns the user's avatar as a fully formatted <img> tag. |
| [517](#L517) | \* |
| [518](#L518) | \* By default, this will return the gravatar, but it can |
| [519](#L519) | \* be extended to add support for locally hosted avatars. |
| [520](#L520) | \* |
| [521](#L521) | \* @since  1.0.0 |
| [522](#L522) | \* |
| [523](#L523) | \* @param  int $size The length and width of the avatar. |
| [524](#L524) | \* @return string |
| [525](#L525) | \*/ |
| [526](#L526) | public function get\_avatar( $size = 100, $donor\_id = false ) { |
| [527](#L527) | /\*\*If you use this filter, return an attachment ID. \*/ |
| [528](#L528) |  |
| [529](#L529) | $avatar\_attachment\_id = get\_user\_meta( $this->ID, 'avatar', true ); |
| [530](#L530) |  |
| [531](#L531) | $avatar\_attachment\_id = apply\_filters( 'charitable\_user\_avatar', $avatar\_attachment\_id, $this ); |
| [532](#L532) |  |
| [533](#L533) | /\* If we don't have an attachment ID, display the gravatar. \*/ |
| [534](#L534) | if ( ! $avatar\_attachment\_id ) { |
| [535](#L535) | return get\_avatar( $this->ID, $size ); |
| [536](#L536) | } |
| [537](#L537) |  |
| [538](#L538) | $img\_size = apply\_filters( 'charitable\_user\_avatar\_media\_size', array( $size, $size ), $size ); |
| [539](#L539) |  |
| [540](#L540) | $attachment\_src = wp\_get\_attachment\_image\_src( $avatar\_attachment\_id, $img\_size ); |
| [541](#L541) |  |
| [542](#L542) | /\* No image for the given attachment ID? Fall back to the gravatar. \*/ |
| [543](#L543) | if ( ! $attachment\_src ) { |
| [544](#L544) | return get\_avatar( $this->ID, $size ); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | return apply\_filters( |
| [548](#L548) | 'charitable\_user\_avatar\_custom', |
| [549](#L549) | sprintf( |
| [550](#L550) | '<img src="%s" alt="%s" class="avatar photo" width="%s" height="%s" />', |
| [551](#L551) | $attachment\_src[0], |
| [552](#L552) | esc\_attr( $this->display\_name ), |
| [553](#L553) | $attachment\_src[1], |
| [554](#L554) | $attachment\_src[2] |
| [555](#L555) | ), |
| [556](#L556) | $avatar\_attachment\_id, |
| [557](#L557) | $size, |
| [558](#L558) | $this |
| [559](#L559) | ); |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) | /\*\* |
| [563](#L563) | \* Return the src of the avatar. |
| [564](#L564) | \* |
| [565](#L565) | \* @since  1.0.0 |
| [566](#L566) | \* |
| [567](#L567) | \* @param  int $size The length and the width of the avatar. |
| [568](#L568) | \* @return string |
| [569](#L569) | \*/ |
| [570](#L570) | public function get\_avatar\_src( $size = 100 ) { |
| [571](#L571) | /\* If this returns something, we don't need to deal with the gravatar. \*/ |
| [572](#L572) | $avatar = apply\_filters( 'charitable\_user\_avatar\_src', false, $this, $size ); |
| [573](#L573) |  |
| [574](#L574) | if ( false === $avatar ) { |
| [575](#L575) |  |
| [576](#L576) | /\* The gravatars are returned as fully formatted img tags, so we need to pull out the src. \*/ |
| [577](#L577) | $gravatar = get\_avatar( $this->ID, $size ); |
| [578](#L578) |  |
| [579](#L579) | preg\_match( "@src='([^']+)'@", $gravatar, $matches ); |
| [580](#L580) |  |
| [581](#L581) | $avatar = array\_pop( $matches ); |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) | return $avatar; |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | /\*\* |
| [588](#L588) | \* Return the campaigns created by the user. |
| [589](#L589) | \* |
| [590](#L590) | \* @since  1.0.0 |
| [591](#L591) | \* |
| [592](#L592) | \* @param  array $args Optional. Any arguments accepted by WP\_Query. |
| [593](#L593) | \* @return WP\_Query |
| [594](#L594) | \*/ |
| [595](#L595) | public function get\_campaigns( $args = array() ) { |
| [596](#L596) | $defaults = array( |
| [597](#L597) | 'author' => $this->ID, |
| [598](#L598) | ); |
| [599](#L599) |  |
| [600](#L600) | $args = wp\_parse\_args( $args, $defaults ); |
| [601](#L601) |  |
| [602](#L602) | return Charitable\_Campaigns::query( $args ); |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | /\*\* |
| [606](#L606) | \* Checks whether the user has any current campaigns (i.e. non-expired). |
| [607](#L607) | \* |
| [608](#L608) | \* @since  1.0.0 |
| [609](#L609) | \* |
| [610](#L610) | \* @param  array $args Query arguments. |
| [611](#L611) | \* @return WP\_Query |
| [612](#L612) | \*/ |
| [613](#L613) | public function get\_current\_campaigns( $args = array() ) { |
| [614](#L614) | $defaults = array( |
| [615](#L615) | 'author'     => $this->ID, |
| [616](#L616) | 'meta\_query' => array( |
| [617](#L617) | 'relation' => 'OR', |
| [618](#L618) | array( |
| [619](#L619) | 'key'     => '\_campaign\_end\_date', |
| [620](#L620) | 'value'   => date( 'Y-m-d H:i:s' ), |
| [621](#L621) | 'compare' => '>=', |
| [622](#L622) | 'type'    => 'datetime', |
| [623](#L623) | ), |
| [624](#L624) | array( |
| [625](#L625) | 'key'   => '\_campaign\_end\_date', |
| [626](#L626) | 'value' => '0', |
| [627](#L627) | ), |
| [628](#L628) | ), |
| [629](#L629) | ); |
| [630](#L630) |  |
| [631](#L631) | $args = wp\_parse\_args( $args, $defaults ); |
| [632](#L632) |  |
| [633](#L633) | return Charitable\_Campaigns::query( $args ); |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) | /\*\* |
| [637](#L637) | \* Returns all current campaigns by the user. |
| [638](#L638) | \* |
| [639](#L639) | \* @since  1.0.0 |
| [640](#L640) | \* |
| [641](#L641) | \* @return WP\_Query |
| [642](#L642) | \*/ |
| [643](#L643) | public function has\_current\_campaigns() { |
| [644](#L644) | return $this->get\_current\_campaigns()->found\_posts; |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | /\*\* |
| [648](#L648) | \* Returns the user's donation and campaign creation activity. |
| [649](#L649) | \* |
| [650](#L650) | \* @see     WP\_Query |
| [651](#L651) | \* @since  1.0.0 |
| [652](#L652) | \* |
| [653](#L653) | \* @param  array $args Optional. Any arguments accepted by WP\_Query. |
| [654](#L654) | \* @return WP\_Query |
| [655](#L655) | \*/ |
| [656](#L656) | public function get\_activity( $args = array() ) { |
| [657](#L657) | $defaults = array( |
| [658](#L658) | 'author'      => $this->ID, |
| [659](#L659) | 'post\_status' => array( 'charitable-completed', 'charitable-preapproved', 'publish' ), |
| [660](#L660) | 'post\_type'   => array( 'donation', 'campaign' ), |
| [661](#L661) | 'order'       => 'DESC', |
| [662](#L662) | 'orderby'     => 'date', |
| [663](#L663) | ); |
| [664](#L664) |  |
| [665](#L665) | $args = wp\_parse\_args( $args, $defaults ); |
| [666](#L666) |  |
| [667](#L667) | $args = apply\_filters( 'charitable\_user\_activity\_args', $args, $this ); |
| [668](#L668) |  |
| [669](#L669) | return new WP\_Query( $args ); |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) | /\*\* |
| [673](#L673) | \* Add a new donor. This may also create a user account for them. |
| [674](#L674) | \* |
| [675](#L675) | \* @since  1.0.0 |
| [676](#L676) | \* |
| [677](#L677) | \* @param  array $submitted Values submitted by the user. |
| [678](#L678) | \* @return int   $donor\_id  Donor ID. |
| [679](#L679) | \*/ |
| [680](#L680) | public function add\_donor( $submitted = array() ) { |
| [681](#L681) | $email = false; |
| [682](#L682) |  |
| [683](#L683) | if ( isset( $submitted['email'] ) ) { |
| [684](#L684) | $email = $submitted['email']; |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | if ( ! $email && $this->is\_logged\_in() ) { |
| [688](#L688) | $email = $this->user\_email; |
| [689](#L689) | } |
| [690](#L690) |  |
| [691](#L691) | /\*\* |
| [692](#L692) | \* Filter whether donors can be added without an email address. |
| [693](#L693) | \* |
| [694](#L694) | \* Prior to Charitable 1.6, this was never permitted. As of Charitable 1.6, donors |
| [695](#L695) | \* without an email address can be added by default, primarily to support manual |
| [696](#L696) | \* donations without an email address. Use this filter to disable that ability. |
| [697](#L697) | \* |
| [698](#L698) | \* NOTE: By default, the public donation form still requires an email address, so this |
| [699](#L699) | \* primarily affects programmatically created donors, or donors created via manual |
| [700](#L700) | \* donations in the admin. |
| [701](#L701) | \* |
| [702](#L702) | \* @see https://github.com/Charitable/Charitable/issues/535 |
| [703](#L703) | \* |
| [704](#L704) | \* @since 1.6.0 |
| [705](#L705) | \* |
| [706](#L706) | \* @param boolean $permitted Whether donors can be added without an email address. |
| [707](#L707) | \*/ |
| [708](#L708) | if ( ! $email && ! charitable\_permit\_donor\_without\_email() ) { |
| [709](#L709) | charitable\_get\_deprecated()->doing\_it\_wrong( |
| [710](#L710) | \_\_METHOD\_\_, |
| [711](#L711) | \_\_( 'Unable to add donor. Email not set for logged out user.', 'charitable' ), |
| [712](#L712) | '1.0.0' |
| [713](#L713) | ); |
| [714](#L714) |  |
| [715](#L715) | return 0; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | /\*\* |
| [719](#L719) | \* Filter the donor values. |
| [720](#L720) | \* |
| [721](#L721) | \* @since 1.0.0 |
| [722](#L722) | \* |
| [723](#L723) | \* @param array           $donor\_values The donor values. |
| [724](#L724) | \* @param Charitable\_User $user         This instance of `Charitable\_User`. |
| [725](#L725) | \* @param array           $submitted    Submitted values. |
| [726](#L726) | \*/ |
| [727](#L727) | $donor\_values = apply\_filters( |
| [728](#L728) | 'charitable\_donor\_values', |
| [729](#L729) | array( |
| [730](#L730) | 'user\_id'    => $this->ID, |
| [731](#L731) | 'email'      => $email, |
| [732](#L732) | 'first\_name' => array\_key\_exists( 'first\_name', $submitted ) ? $submitted['first\_name'] : $this->first\_name, |
| [733](#L733) | 'last\_name'  => array\_key\_exists( 'last\_name', $submitted ) ? $submitted['last\_name'] : $this->last\_name, |
| [734](#L734) | ), |
| [735](#L735) | $this, |
| [736](#L736) | $submitted |
| [737](#L737) | ); |
| [738](#L738) |  |
| [739](#L739) | $donor\_id = charitable\_get\_table( 'donors' )->insert( $donor\_values ); |
| [740](#L740) |  |
| [741](#L741) | /\*\* |
| [742](#L742) | \* If the user is logged in, add the "Donor" role to their account. |
| [743](#L743) | \*/ |
| [744](#L744) | if ( $this->is\_logged\_in() ) { |
| [745](#L745) | $this->add\_role( 'donor' ); |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | do\_action( 'charitable\_after\_insert\_donor', $donor\_id, $this ); |
| [749](#L749) |  |
| [750](#L750) | return $donor\_id; |
| [751](#L751) | } |
| [752](#L752) |  |
| [753](#L753) | /\*\* |
| [754](#L754) | \* Insert a new donor with submitted values. |
| [755](#L755) | \* |
| [756](#L756) | \* @since  1.4.0 |
| [757](#L757) | \* |
| [758](#L758) | \* @param  array $submitted The submitted values. |
| [759](#L759) | \* @param  array $keys The keys of fields that are to be updated. |
| [760](#L760) | \* @return int |
| [761](#L761) | \*/ |
| [762](#L762) | public static function create\_profile( $submitted = array(), $keys = array() ) { |
| [763](#L763) | $user    = new Charitable\_User(); |
| [764](#L764) | $user\_id = $user->update\_profile( $submitted, $keys ); |
| [765](#L765) | return new Charitable\_User( $user\_id ); |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | /\*\* |
| [769](#L769) | \* Update the user's details with submitted values. |
| [770](#L770) | \* |
| [771](#L771) | \* @since  1.0.0 |
| [772](#L772) | \* |
| [773](#L773) | \* @param  array $submitted The submitted values. |
| [774](#L774) | \* @param  array $keys The keys of fields that are to be updated. |
| [775](#L775) | \* @return int |
| [776](#L776) | \*/ |
| [777](#L777) | public function update\_profile( $submitted = array(), $keys = array() ) { |
| [778](#L778) | if ( empty( $submitted ) ) { |
| [779](#L779) | $submitted = $\_POST; |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | if ( empty( $keys ) ) { |
| [783](#L783) | $keys = array\_keys( $submitted ); |
| [784](#L784) | } |
| [785](#L785) |  |
| [786](#L786) | $user\_id = $this->update\_core\_user( $submitted ); |
| [787](#L787) |  |
| [788](#L788) | /\* If there were problems with creating the user, stop here. \*/ |
| [789](#L789) | if ( ! $user\_id ) { |
| [790](#L790) | return $user\_id; |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | /\* Create or update the user's donor record. \*/ |
| [794](#L794) | $this->update\_donor\_record( $submitted, $keys ); |
| [795](#L795) |  |
| [796](#L796) | $this->update\_user\_meta( $submitted, $keys ); |
| [797](#L797) |  |
| [798](#L798) | return $user\_id; |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | /\*\* |
| [802](#L802) | \* Create or update a donor record for the current user. |
| [803](#L803) | \* |
| [804](#L804) | \* @since  1.6.2 |
| [805](#L805) | \* |
| [806](#L806) | \* @param  array $submitted The submitted values. |
| [807](#L807) | \* @param  array $keys      The keys of fields that are to be updated. |
| [808](#L808) | \* @return int The donor ID, or 0 if none was created or edited. |
| [809](#L809) | \*/ |
| [810](#L810) | public function update\_donor\_record( $submitted, $keys ) { |
| [811](#L811) | $donor\_fields = array\_intersect( $keys, charitable\_get\_donor\_keys() ); |
| [812](#L812) |  |
| [813](#L813) | if ( array\_key\_exists( 'user\_email', $submitted ) ) { |
| [814](#L814) | $donor\_fields[]     = 'email'; |
| [815](#L815) | $submitted['email'] = $submitted['user\_email']; |
| [816](#L816) | } |
| [817](#L817) |  |
| [818](#L818) | if ( empty( $donor\_fields ) ) { |
| [819](#L819) | return 0; |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | $donor\_data = array( |
| [823](#L823) | 'user\_id' => $this->ID, |
| [824](#L824) | ); |
| [825](#L825) |  |
| [826](#L826) | foreach ( $donor\_fields as $field ) { |
| [827](#L827) | if ( array\_key\_exists( $field, $submitted ) ) { |
| [828](#L828) | $value = $submitted[ $field ]; |
| [829](#L829) | } elseif ( 'contact\_consent' == $field ) { |
| [830](#L830) | $value = 0; |
| [831](#L831) | } else { |
| [832](#L832) | $value = ''; |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | $donor\_data[ $field ] = $value; |
| [836](#L836) | } |
| [837](#L837) |  |
| [838](#L838) | if ( array\_key\_exists( 'donor\_id', $donor\_data ) ) { |
| [839](#L839) | $donor\_id = $donor\_data['donor\_id']; |
| [840](#L840) | } else { |
| [841](#L841) | $donor\_id = $this->get\_donor\_id(); |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) | /\* Clear out the cache \*/ |
| [845](#L845) | wp\_cache\_delete( $donor\_id, 'donors' ); |
| [846](#L846) |  |
| [847](#L847) | if ( $donor\_id ) { |
| [848](#L848) | charitable\_get\_table( 'donors' )->update( $donor\_id, $donor\_data ); |
| [849](#L849) |  |
| [850](#L850) | return $donor\_id; |
| [851](#L851) | } |
| [852](#L852) |  |
| [853](#L853) | return charitable\_get\_table( 'donors' )->insert( $donor\_data ); |
| [854](#L854) | } |
| [855](#L855) |  |
| [856](#L856) | /\*\* |
| [857](#L857) | \* Save core fields of the user (i.e. the wp\_users data) |
| [858](#L858) | \* |
| [859](#L859) | \* @uses   wp\_insert\_user |
| [860](#L860) | \* |
| [861](#L861) | \* @since  1.0.0 |
| [862](#L862) | \* |
| [863](#L863) | \* @param  array $submitted Values submitted by the user. |
| [864](#L864) | \* @return int User ID |
| [865](#L865) | \*/ |
| [866](#L866) | public function update\_core\_user( $submitted ) { |
| [867](#L867) | $core\_fields = array\_intersect( array\_keys( $submitted ), $this->get\_core\_keys() ); |
| [868](#L868) |  |
| [869](#L869) | if ( empty( $core\_fields ) ) { |
| [870](#L870) | return 0; |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | $values = array(); |
| [874](#L874) |  |
| [875](#L875) | /\* If we're updating an active user, set the ID \*/ |
| [876](#L876) | if ( 0 !== $this->ID ) { |
| [877](#L877) | $values['ID'] = $this->ID; |
| [878](#L878) | } |
| [879](#L879) |  |
| [880](#L880) | foreach ( $core\_fields as $field ) { |
| [881](#L881) | $values[ $field ] = $submitted[ $field ]; |
| [882](#L882) | } |
| [883](#L883) |  |
| [884](#L884) | /\* Set the user's display name based on their name. \*/ |
| [885](#L885) | $display\_name = $this->sanitize\_display\_name( $values ); |
| [886](#L886) |  |
| [887](#L887) | if ( $display\_name ) { |
| [888](#L888) | $values['display\_name'] = $display\_name; |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | /\* Insert the user \*/ |
| [892](#L892) | if ( 0 == $this->ID ) { |
| [893](#L893) |  |
| [894](#L894) | if ( ! isset( $values['user\_pass'] ) || strlen( $values['user\_pass'] ) == 0 ) { |
| [895](#L895) | charitable\_get\_notices()->add\_error( '<strong>ERROR:</strong> Password field is required.' ); |
| [896](#L896) | return false; |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | if ( ! isset( $values['user\_login'] ) ) { |
| [900](#L900) | $values['user\_login'] = $values['user\_email']; |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | /\*\* |
| [904](#L904) | \* `wp\_insert\_user` calls `sanitize\_user` internally - make the |
| [905](#L905) | \* same call here so `$values['user\_login']` matches what is |
| [906](#L906) | \* eventually saved to the database |
| [907](#L907) | \*/ |
| [908](#L908) | $values['user\_login'] = sanitize\_user( $values['user\_login'], true ); |
| [909](#L909) |  |
| [910](#L910) | $user\_id = wp\_insert\_user( $values ); |
| [911](#L911) |  |
| [912](#L912) | if ( is\_wp\_error( $user\_id ) ) { |
| [913](#L913) | charitable\_get\_notices()->add\_errors\_from\_wp\_error( $user\_id ); |
| [914](#L914) | return false; |
| [915](#L915) | } |
| [916](#L916) |  |
| [917](#L917) | $this->init( self::get\_data\_by( 'id', $user\_id ) ); |
| [918](#L918) |  |
| [919](#L919) | $signon = Charitable\_User::signon( $values['user\_login'], $values['user\_pass'] ); |
| [920](#L920) |  |
| [921](#L921) | if ( is\_wp\_error( $signon ) ) { |
| [922](#L922) | charitable\_get\_notices()->add\_errors\_from\_wp\_error( $signon ); |
| [923](#L923) | return false; |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | /\*\* |
| [927](#L927) | \* Do something after a user has been registered. |
| [928](#L928) | \* |
| [929](#L929) | \* @since 1.0.0 |
| [930](#L930) | \* |
| [931](#L931) | \* @param int   $user\_id The new user's ID. |
| [932](#L932) | \* @param array $values  Values submitted to register user. |
| [933](#L933) | \*/ |
| [934](#L934) | do\_action( 'charitable\_after\_insert\_user', $user\_id, $values ); |
| [935](#L935) |  |
| [936](#L936) | } else { |
| [937](#L937) | $values['ID'] = $this->ID; |
| [938](#L938) | $user\_id      = wp\_update\_user( $values ); |
| [939](#L939) | }//end if |
| [940](#L940) |  |
| [941](#L941) | /\* If there was an error when inserting or updating the user, lodge the error. \*/ |
| [942](#L942) | if ( is\_wp\_error( $user\_id ) ) { |
| [943](#L943) | charitable\_get\_notices()->add\_errors\_from\_wp\_error( $user\_id ); |
| [944](#L944) | return false; |
| [945](#L945) | } |
| [946](#L946) |  |
| [947](#L947) | /\*\* |
| [948](#L948) | \* Do something after a user's account has been updated or created. |
| [949](#L949) | \* |
| [950](#L950) | \* @since 1.0.0 |
| [951](#L951) | \* |
| [952](#L952) | \* @param int   $user\_id The user's ID. |
| [953](#L953) | \* @param array $values  Values submitted to save user. |
| [954](#L954) | \*/ |
| [955](#L955) | do\_action( 'charitable\_after\_save\_user', $user\_id, $values ); |
| [956](#L956) |  |
| [957](#L957) | return $user\_id; |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | /\*\* |
| [961](#L961) | \* Save the user's meta fields. |
| [962](#L962) | \* |
| [963](#L963) | \* @since  1.0.0 |
| [964](#L964) | \* |
| [965](#L965) | \* @param  array $submitted The submitted values. |
| [966](#L966) | \* @param  array $keys      The keys of fields that are to be updated. |
| [967](#L967) | \* @return int Number of fields updated. |
| [968](#L968) | \*/ |
| [969](#L969) | public function update\_user\_meta( $submitted, $keys ) { |
| [970](#L970) | /\* Exclude the core keys \*/ |
| [971](#L971) | $meta\_fields = array\_diff( $keys, $this->get\_core\_keys() ); |
| [972](#L972) | $updated     = 0; |
| [973](#L973) |  |
| [974](#L974) | foreach ( $meta\_fields as $field ) { |
| [975](#L975) |  |
| [976](#L976) | if ( isset( $submitted[ $field ] ) ) { |
| [977](#L977) | $meta\_key   = $this->map\_key( $field ); |
| [978](#L978) | $meta\_value = sanitize\_meta( $meta\_key, $submitted[ $field ], 'user' ); |
| [979](#L979) |  |
| [980](#L980) | update\_user\_meta( $this->ID, $meta\_key, $meta\_value ); |
| [981](#L981) |  |
| [982](#L982) | $updated++; |
| [983](#L983) | } |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | return $updated; |
| [987](#L987) | } |
| [988](#L988) |  |
| [989](#L989) | /\*\* |
| [990](#L990) | \* Log a user is with their username and password. |
| [991](#L991) | \* |
| [992](#L992) | \* @since  1.0.0 |
| [993](#L993) | \* |
| [994](#L994) | \* @param  string $username The user's username. |
| [995](#L995) | \* @param  string $password User password. |
| [996](#L996) | \* @return WP\_User|WP\_Error|false WP\_User on login, WP\_Error on failure. False if feature is disabled. |
| [997](#L997) | \*/ |
| [998](#L998) | public static function signon( $username, $password ) { |
| [999](#L999) | if ( ! apply\_filters( 'charitable\_auto\_login\_after\_registration', true, $username ) ) { |
| [1000](#L1000) | return false; |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | if ( is\_user\_logged\_in() ) { |
| [1004](#L1004) | return false; |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | $creds = array( |
| [1008](#L1008) | 'user\_login'    => $username, |
| [1009](#L1009) | 'user\_password' => $password, |
| [1010](#L1010) | 'remember'      => true, |
| [1011](#L1011) | ); |
| [1012](#L1012) |  |
| [1013](#L1013) | return wp\_signon( $creds, false ); |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | /\*\* |
| [1017](#L1017) | \* Return a display name for the user. |
| [1018](#L1018) | \* |
| [1019](#L1019) | \* @since  1.5.2 |
| [1020](#L1020) | \* |
| [1021](#L1021) | \* @param  array $values Submitted values. |
| [1022](#L1022) | \* @return string|false String if we received a display\_name |
| [1023](#L1023) | \*                      or had a first name or last name. |
| [1024](#L1024) | \*/ |
| [1025](#L1025) | public function sanitize\_display\_name( $values ) { |
| [1026](#L1026) | if ( array\_key\_exists( 'display\_name', $values ) ) { |
| [1027](#L1027) | return $values['display\_name']; |
| [1028](#L1028) | } |
| [1029](#L1029) |  |
| [1030](#L1030) | $first\_name = array\_key\_exists( 'first\_name', $values ) ? $values['first\_name'] : $this->first\_name; |
| [1031](#L1031) | $last\_name  = array\_key\_exists( 'last\_name', $values ) ? $values['last\_name'] : $this->last\_name; |
| [1032](#L1032) | $display    = trim( sprintf( '%s %s', $first\_name, $last\_name ) ); |
| [1033](#L1033) |  |
| [1034](#L1034) | return strlen( $display ) ? $display : false; |
| [1035](#L1035) | } |
| [1036](#L1036) |  |
| [1037](#L1037) | /\*\* |
| [1038](#L1038) | \* Return the array of mapped keys, where the key is mapped to a meta\_key in the user meta table. |
| [1039](#L1039) | \* |
| [1040](#L1040) | \* @since  1.0.0 |
| [1041](#L1041) | \* |
| [1042](#L1042) | \* @return array |
| [1043](#L1043) | \*/ |
| [1044](#L1044) | public function get\_mapped\_keys() { |
| [1045](#L1045) | if ( ! isset( $this->mapped\_keys ) ) { |
| [1046](#L1046) | $this->mapped\_keys = charitable\_get\_user\_mapped\_keys(); |
| [1047](#L1047) | } |
| [1048](#L1048) |  |
| [1049](#L1049) | return $this->mapped\_keys; |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | /\*\* |
| [1053](#L1053) | \* Given a key, returns the mapped key or itself if it is not mapped. |
| [1054](#L1054) | \* |
| [1055](#L1055) | \* @since  1.5.0 |
| [1056](#L1056) | \* |
| [1057](#L1057) | \* @param  string $key The key to map. |
| [1058](#L1058) | \* @return string |
| [1059](#L1059) | \*/ |
| [1060](#L1060) | public function map\_key( $key ) { |
| [1061](#L1061) | $mapped\_keys = $this->get\_mapped\_keys(); |
| [1062](#L1062) |  |
| [1063](#L1063) | return array\_key\_exists( $key, $mapped\_keys ) ? $mapped\_keys[ $key ] : $key; |
| [1064](#L1064) | } |
| [1065](#L1065) |  |
| [1066](#L1066) | /\*\* |
| [1067](#L1067) | \* Return the array of core keys. |
| [1068](#L1068) | \* |
| [1069](#L1069) | \* @since  1.0.0 |
| [1070](#L1070) | \* |
| [1071](#L1071) | \* @return array |
| [1072](#L1072) | \*/ |
| [1073](#L1073) | public function get\_core\_keys() { |
| [1074](#L1074) | if ( ! isset( $this->core\_keys ) ) { |
| [1075](#L1075) | $this->core\_keys = charitable\_get\_user\_core\_keys(); |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | return $this->core\_keys; |
| [1079](#L1079) | } |
| [1080](#L1080) |  |
| [1081](#L1081) | /\*\* |
| [1082](#L1082) | \* Deprecated function. |
| [1083](#L1083) | \* |
| [1084](#L1084) | \* Return an array of fields used for the address. |
| [1085](#L1085) | \* |
| [1086](#L1086) | \* @deprecated 2.2.0 |
| [1087](#L1087) | \* |
| [1088](#L1088) | \* @since  1.0.0 |
| [1089](#L1089) | \* @since  1.6.44 Deprecated. |
| [1090](#L1090) | \* |
| [1091](#L1091) | \* @return array |
| [1092](#L1092) | \*/ |
| [1093](#L1093) | public function get\_address\_fields() { |
| [1094](#L1094) | charitable\_get\_deprecated()->deprecated\_function( |
| [1095](#L1095) | \_\_METHOD\_\_, |
| [1096](#L1096) | '1.6.44', |
| [1097](#L1097) | '' |
| [1098](#L1098) | ); |
| [1099](#L1099) |  |
| [1100](#L1100) | /\*\* |
| [1101](#L1101) | \* Deprecated filter in deprecated method. |
| [1102](#L1102) | \* |
| [1103](#L1103) | \* Please note that prior to 1.6.44, the hook used here was `charitable\_user\_address\_fields`, |
| [1104](#L1104) | \* which is used elsewhere in a different context and thus resulted in unexpected results. |
| [1105](#L1105) | \* |
| [1106](#L1106) | \* @since 1.6.44 |
| [1107](#L1107) | \* |
| [1108](#L1108) | \* @param array $address\_fields The address fields. |
| [1109](#L1109) | \*/ |
| [1110](#L1110) | return apply\_filters( |
| [1111](#L1111) | 'charitable\_user\_address\_fields\_deprecated', |
| [1112](#L1112) | array( |
| [1113](#L1113) | 'donor\_address', |
| [1114](#L1114) | 'donor\_address\_2', |
| [1115](#L1115) | 'donor\_city', |
| [1116](#L1116) | 'donor\_state', |
| [1117](#L1117) | 'donor\_postcode', |
| [1118](#L1118) | 'donor\_country', |
| [1119](#L1119) | ) |
| [1120](#L1120) | ); |
| [1121](#L1121) | } |
| [1122](#L1122) |  |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | endif; |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/charitable/tags/1.7.0.12/includes/users/class-charitable-user.php?format=txt)
* [Original Format](/export/3222480/charitable/tags/1.7.0.12/includes/users/class-charitable-user.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


