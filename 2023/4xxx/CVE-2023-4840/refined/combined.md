=== Content from plugins.trac.wordpress.org_41c79b2c_20250115_085451.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmappress-google-maps-for-wordpress%2Ftags%2F2.88.5%2Fmappress.php%3Frev%3D2965022)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← Previous Revision
* [Latest Revision](/browser/mappress-google-maps-for-wordpress/tags/2.88.5/mappress.php)
* Next Revision →
* [Blame](/browser/mappress-google-maps-for-wordpress/tags/2.88.5/mappress.php?annotate=blame&rev=2965022 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/mappress-google-maps-for-wordpress/tags/2.88.5/mappress.php?rev=2965022)

---

# [source:](/browser?rev=2965022&order=name "Go to repository root") [mappress-google-maps-for-wordpress](/browser/mappress-google-maps-for-wordpress?rev=2965022&order=name "View mappress-google-maps-for-wordpress")/[tags](/browser/mappress-google-maps-for-wordpress/tags?rev=2965022&order=name "View tags")/[2.88.5](/browser/mappress-google-maps-for-wordpress/tags/2.88.5?rev=2965022&order=name "View 2.88.5")/[mappress.php](/browser/mappress-google-maps-for-wordpress/tags/2.88.5/mappress.php?rev=2965022&order=name "View mappress.php") @ [2965022](/changeset/2965022/ "View changeset 2965022")

View diff against:

View revision:

| [Last change](/changeset/2965022/mappress-google-maps-for-wordpress/tags/2.88.5/mappress.php "View differences") on this file since 2965022 was [2965022](/changeset/2965022/ "View changeset 2965022"), checked in by chrisvrichardson, [16 months ago](/timeline?from=2023-09-11T00%3A31%3A00Z&precision=second "See timeline at 09/11/2023 12:31:00 AM") |
| --- |
| 2.88.5 |
| **File size:** 46.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: MapPress Google Maps and Leaflet Maps |
| [4](#L4) | Plugin URI: https://www.mappresspro.com |
| [5](#L5) | Author URI: https://www.mappresspro.com |
| [6](#L6) | Pro Update URI: https://www.mappresspro.com |
| [7](#L7) | Description: MapPress makes it easy to add Google Maps and Leaflet Maps to WordPress |
| [8](#L8) | Version: 2.88.5 |
| [9](#L9) | Author: Chris Richardson |
| [10](#L10) | Text Domain: mappress-google-maps-for-wordpress |
| [11](#L11) | Thanks to all the translators and to Scott DeJonge for his wonderful icons |
| [12](#L12) | \*/ |
| [13](#L13) |  |
| [14](#L14) | /\* |
| [15](#L15) | This program is distributed in the hope that it will be useful, |
| [16](#L16) | but WITHOUT ANY WARRANTY; without even the implied warranty of |
| [17](#L17) | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the license.txt file for details. |
| [18](#L18) | \*/ |
| [19](#L19) |  |
| [20](#L20) | require\_once dirname( \_\_FILE\_\_ ) . '/mappress\_api.php'; |
| [21](#L21) | require\_once dirname( \_\_FILE\_\_ ) . '/mappress\_compliance.php'; |
| [22](#L22) | require\_once dirname( \_\_FILE\_\_ ) . '/mappress\_db.php'; |
| [23](#L23) | require\_once dirname( \_\_FILE\_\_ ) . '/mappress\_obj.php'; |
| [24](#L24) | require\_once dirname( \_\_FILE\_\_ ) . '/mappress\_poi.php'; |
| [25](#L25) | require\_once dirname( \_\_FILE\_\_ ) . '/mappress\_map.php'; |
| [26](#L26) | require\_once dirname( \_\_FILE\_\_ ) . '/mappress\_settings.php'; |
| [27](#L27) | include\_once dirname( \_\_FILE\_\_ ) . '/mappress\_template.php'; |
| [28](#L28) | include\_once dirname( \_\_FILE\_\_ ) . '/mappress\_wpml.php'; |
| [29](#L29) |  |
| [30](#L30) | if (is\_dir(dirname( \_\_FILE\_\_ ) . '/pro')) { |
| [31](#L31) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_filter.php'; |
| [32](#L32) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_frontend.php'; |
| [33](#L33) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_geocoder.php'; |
| [34](#L34) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_icons.php'; |
| [35](#L35) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_import.php'; |
| [36](#L36) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_meta.php'; |
| [37](#L37) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_query.php'; |
| [38](#L38) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_updater.php'; |
| [39](#L39) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_widget.php'; |
| [40](#L40) | include\_once dirname( \_\_FILE\_\_ ) . '/pro/mappress\_widget\_map.php'; |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | class Mappress { |
| [44](#L44) | const VERSION = '2.88.5'; |
| [45](#L45) |  |
| [46](#L46) | static |
| [47](#L47) | $api, |
| [48](#L48) | $baseurl, |
| [49](#L49) | $basename, |
| [50](#L50) | $basedir, |
| [51](#L51) | $block\_category = 'text', |
| [52](#L52) | $debug, |
| [53](#L53) | $loaded, |
| [54](#L54) | $options, |
| [55](#L55) | $notices, |
| [56](#L56) | $pages, |
| [57](#L57) | $pro, |
| [58](#L58) | $updater, |
| [59](#L59) | $version |
| [60](#L60) | ; |
| [61](#L61) |  |
| [62](#L62) | function \_\_construct()  { |
| [63](#L63) | global $wp\_version; |
| [64](#L64) | self::$basedir = dirname(\_\_FILE\_\_); |
| [65](#L65) | self::$basename = plugin\_basename(\_\_FILE\_\_); |
| [66](#L66) | self::$baseurl = plugins\_url('', \_\_FILE\_\_); |
| [67](#L67) | self::$options = Mappress\_Options::get(); |
| [68](#L68) | self::$pro = is\_dir(dirname( \_\_FILE\_\_ ) . '/pro'); |
| [69](#L69) | self::$version = (self::$pro) ? self::VERSION . "PRO" : self::VERSION; |
| [70](#L70) | self::$version = (defined('MAPPRESS\_DEV') && MAPPRESS\_DEV) ? self::$version . '-' . rand(0,99999) : self::$version; |
| [71](#L71) | self::$api = new Mappress\_Api(); |
| [72](#L72) |  |
| [73](#L73) | self::debugging(); |
| [74](#L74) |  |
| [75](#L75) | if (self::$pro) |
| [76](#L76) | self::$updater = new Mappress\_Updater(self::$basename, 'mappress', self::VERSION, self::$options->license, self::$options->betas); |
| [77](#L77) |  |
| [78](#L78) | add\_action('admin\_menu', array(\_\_CLASS\_\_, 'admin\_menu')); |
| [79](#L79) | add\_action('init', array(\_\_CLASS\_\_, 'init'), 0);        // Priority 0 required for widgets\_init hook |
| [80](#L80) | add\_action('plugins\_loaded', array(\_\_CLASS\_\_, 'plugins\_loaded')); |
| [81](#L81) |  |
| [82](#L82) | add\_shortcode('mappress', array(\_\_CLASS\_\_, 'shortcode\_map')); |
| [83](#L83) | add\_action('admin\_notices', array(\_\_CLASS\_\_, 'admin\_notices')); |
| [84](#L84) |  |
| [85](#L85) | // Filter to automatically add maps to post/page content |
| [86](#L86) | add\_filter('the\_content', array(\_\_CLASS\_\_, 'the\_content'), 2); |
| [87](#L87) |  |
| [88](#L88) | // Namespace |
| [89](#L89) | add\_action('wp\_head', array(\_\_CLASS\_\_, 'wp\_head'), 0); |
| [90](#L90) | add\_action('admin\_head', array(\_\_CLASS\_\_, 'wp\_head'), 0); |
| [91](#L91) |  |
| [92](#L92) | // Scripts and stylesheets |
| [93](#L93) | add\_action('wp\_enqueue\_scripts', array(\_\_CLASS\_\_, 'wp\_enqueue\_scripts')); |
| [94](#L94) | add\_action('admin\_enqueue\_scripts', array(\_\_CLASS\_\_, 'admin\_enqueue\_scripts')); |
| [95](#L95) |  |
| [96](#L96) | // Plugin action links |
| [97](#L97) | add\_filter("plugin\_action\_links\_" . self::$basename, array(\_\_CLASS\_\_, 'plugin\_action\_links'), 10, 2); |
| [98](#L98) |  |
| [99](#L99) | if (self::$pro) |
| [100](#L100) | add\_shortcode('mashup', array(\_\_CLASS\_\_, 'shortcode\_mashup')); |
| [101](#L101) |  |
| [102](#L102) | // Adjust google script tag |
| [103](#L103) | if (self::$options->engine == 'google') |
| [104](#L104) | add\_filter('script\_loader\_tag', array(\_\_CLASS\_\_, 'script\_loader\_tag'), PHP\_INT\_MAX, 3); |
| [105](#L105) |  |
| [106](#L106) | // Slow heartbeat |
| [107](#L107) | if (self::$debug) |
| [108](#L108) | add\_filter( 'heartbeat\_settings', array(\_\_CLASS\_\_, 'heartbeat\_settings')); |
| [109](#L109) |  |
| [110](#L110) | // Dismissible notices |
| [111](#L111) | add\_action('wp\_ajax\_mapp\_dismiss', array(\_\_CLASS\_\_, 'ajax\_dismiss' )); |
| [112](#L112) |  |
| [113](#L113) | // Add block category |
| [114](#L114) | if ( version\_compare( $wp\_version, '5.8-RC4', '>=' ) ) |
| [115](#L115) | add\_filter( 'block\_categories\_all', array(\_\_CLASS\_\_, 'block\_categories'), 10, 2); |
| [116](#L116) | else |
| [117](#L117) | add\_filter( 'block\_categories', array(\_\_CLASS\_\_, 'block\_categories'), 10, 2 ); |
| [118](#L118) |  |
| [119](#L119) | add\_filter('mime\_types', array(\_\_CLASS\_\_, 'mime\_types')); |
| [120](#L120) | add\_action('deactivate\_' . self::$basename, array(\_\_CLASS\_\_, 'deactivate')); |
| [121](#L121) |  |
| [122](#L122) | // Welcome |
| [123](#L123) | add\_action('activate\_' . self::$basename, array(\_\_CLASS\_\_, 'activate'), 10, 2); |
| [124](#L124) | add\_action('admin\_init', array(\_\_CLASS\_\_, 'admin\_init'), 10, 2); |
| [125](#L125) |  |
| [126](#L126) | // Iframes |
| [127](#L127) | if (isset($\_GET['mappress']) && $\_GET['mappress'] = 'embed') |
| [128](#L128) | add\_action('template\_redirect', array(\_\_CLASS\_\_, 'template\_redirect')); |
| [129](#L129) |  |
| [130](#L130) | // Temporary fix for https://core.trac.wordpress.org/ticket/56969 |
| [131](#L131) | if (version\_compare( $wp\_version, '6.1.1', '<' ) ) |
| [132](#L132) | add\_filter( 'wp\_img\_tag\_add\_decoding\_attr', array(\_\_CLASS\_\_, 'wp\_img\_tag\_add\_decoding\_attr'), 10, 3); |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) | static function wp\_img\_tag\_add\_decoding\_attr( $value, $filtered\_image, $context) { |
| [136](#L136) | return false; |
| [137](#L137) | } |
| [138](#L138) |  |
| [139](#L139) | static function activate($network\_wide = false) { |
| [140](#L140) | $current\_version = get\_option('mappress\_version'); |
| [141](#L141) | if (!$current\_version) |
| [142](#L142) | set\_transient('\_mappress\_activation\_redirect', 'wizard', 30); |
| [143](#L143) | else |
| [144](#L144) | set\_transient('\_mappress\_activation\_redirect', true, 30); |
| [145](#L145) | } |
| [146](#L146) |  |
| [147](#L147) | static function admin\_init() { |
| [148](#L148) | $redirect = get\_transient('\_mappress\_activation\_redirect'); |
| [149](#L149) | if ($redirect) { |
| [150](#L150) | delete\_transient('\_mappress\_activation\_redirect'); |
| [151](#L151) | if (is\_network\_admin() || isset( $\_GET['activate-multi'])) { |
| [152](#L152) | return; |
| [153](#L153) | } else { |
| [154](#L154) | $args = array('page' => 'mappress\_support', 'wizard' => ($redirect == 'wizard') ? 1 : 0); |
| [155](#L155) | wp\_safe\_redirect(add\_query\_arg($args, admin\_url('admin.php'))); |
| [156](#L156) | } |
| [157](#L157) | } |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | // Scripts & styles for admin |
| [161](#L161) | // CSS is always loaded from the plugin directory |
| [162](#L162) | static function admin\_enqueue\_scripts($hook) { |
| [163](#L163) | // Some plugins call this without setting $hook |
| [164](#L164) | if (empty($hook)) |
| [165](#L165) | return; |
| [166](#L166) |  |
| [167](#L167) | $pages = (self::$pages) ? self::$pages : array(); |
| [168](#L168) | $admin\_pages = array( |
| [169](#L169) | 'appearance\_page\_gutenberg-widgets', |
| [170](#L170) | 'appearance\_page\_gutenberg-edit-site', |
| [171](#L171) | 'customize.php', |
| [172](#L172) | 'plugins.php', |
| [173](#L173) | 'post.php', |
| [174](#L174) | 'post-new.php', |
| [175](#L175) | 'site-editor.php', |
| [176](#L176) | 'widgets.php' |
| [177](#L177) | ); |
| [178](#L178) |  |
| [179](#L179) | if ($hook) { |
| [180](#L180) | self::styles\_enqueue('backend'); |
| [181](#L181) | if (isset($pages['main']) && $hook == $pages['main']) { |
| [182](#L182) | self::scripts\_enqueue('settings'); |
| [183](#L183) | } else if (in\_array($hook, $pages) || in\_array($hook, $admin\_pages)) { |
| [184](#L184) | self::scripts\_enqueue('backend'); |
| [185](#L185) | } |
| [186](#L186) | } |
| [187](#L187) | } |
| [188](#L188) |  |
| [189](#L189) | static function admin\_menu() { |
| [190](#L190) | $upgrade = Mappress\_Db::upgrade\_check(); |
| [191](#L191) | $parent = ($upgrade) ? null : 'mappress'; |
| [192](#L192) |  |
| [193](#L193) | self::$pages['main'] = add\_menu\_page('MapPress', 'MapPress', 'manage\_options', 'mappress', array('Mappress\_Settings', 'options\_page'), 'dashicons-location'); |
| [194](#L194) | self::$pages['settings'] = add\_submenu\_page($parent, \_\_('Settings', 'mappress-google-maps-for-wordpress'), \_\_('Settings', 'mappress-google-maps-for-wordpress'), 'manage\_options', 'mappress', array('Mappress\_Settings', 'options\_page')); |
| [195](#L195) | self::$pages['maps'] = add\_submenu\_page($parent, \_\_('Maps', 'mappress-google-maps-for-wordpress'), \_\_('Maps', 'mappress-google-maps-for-wordpress'), 'edit\_posts', 'mappress\_maps', array(\_\_CLASS\_\_, 'map\_library')); |
| [196](#L196) | if (self::$pro) |
| [197](#L197) | self::$pages['import'] = add\_submenu\_page($parent, \_\_('Import', 'mappress-google-maps-for-wordpress'), \_\_('Import', 'mappress-google-maps-for-wordpress'), 'manage\_options', 'mappress\_import', array('Mappress\_Import', 'import\_page')); |
| [198](#L198) | self::$pages['support'] = add\_submenu\_page($parent, \_\_('Support', 'mappress-google-maps-for-wordpress'), \_\_('Support', 'mappress-google-maps-for-wordpress'), 'manage\_options', 'mappress\_support', array('Mappress\_Settings', 'support\_page')); |
| [199](#L199) |  |
| [200](#L200) | if ($upgrade) |
| [201](#L201) | self::$pages['upgrade'] = add\_submenu\_page('mappress', \_\_('Upgrade', 'mappress-google-maps-for-wordpress'), \_\_('Upgrade', 'mappress-google-maps-for-wordpress'), 'manage\_options', 'mappress\_db', array('Mappress\_Db', 'upgrade\_page')); |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | static function admin\_notices() { |
| [205](#L205) | global $wpdb; |
| [206](#L206) | $current\_screen = get\_current\_screen(); |
| [207](#L207) |  |
| [208](#L208) | $error =  "<div class='notice notice-error'><p>%s</p></div>"; |
| [209](#L209) | $maps\_table = $wpdb->prefix . "mapp\_maps"; |
| [210](#L210) | $exists = $wpdb->get\_var("show tables like '$maps\_table'"); |
| [211](#L211) |  |
| [212](#L212) | // Non-dismissible notices |
| [213](#L213) | if (!$exists) { |
| [214](#L214) | printf($error, \_\_("MapPress database tables are missing.  Please deactivate the plugin and activate it again to fix this.", 'mappress-google-maps-for-wordpress')); |
| [215](#L215) | return; |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | if (self::$options->engine != 'leaflet' && !self::get\_api\_keys()->browser) |
| [219](#L219) | printf($error, sprintf("%s. %s <a href='%s'>%s</a>.", \_\_("A Google Maps API key is required", 'mappress-google-maps-for-wordpress'), \_\_("Please update your", 'mappress-google-maps-for-wordpress'), admin\_url('admin.php?page=mappress'), \_\_('MapPress Settings', 'mappress-google-maps-for-wordpress'))); |
| [220](#L220) |  |
| [221](#L221) | // Notice to upgrade DB |
| [222](#L222) | if (Mappress\_Db::upgrade\_check() && (!$current\_screen || $current\_screen->id != self::$pages['upgrade'])) { |
| [223](#L223) | $url = admin\_url('admin.php?page=mappress\_db'); |
| [224](#L224) | $link = sprintf('<a href="%s">%s</a>', $url, \_\_("Upgrade Now", 'mappress-google-maps-for-wordpress')); |
| [225](#L225) | printf($error, sprintf('<strong>' . \_\_('Your MapPress data must be upgraded!  Please %s.' . '</strong>', 'mappress-google-maps-for-wordpress'), $link)); |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | // Dismissibles |
| [229](#L229) | if (is\_super\_admin()) { |
| [230](#L230) | $content =  "<div class='notice notice-%s is-dismissible' data-mapp-dismiss='%s'><p>%s</p></div>"; |
| [231](#L231) | $dismissed = array\_filter( explode( ',', (string) get\_user\_meta( get\_current\_user\_id(), 'mappress\_dismissed', true ) ) ); |
| [232](#L232) | $notices = (self::$notices) ? array\_diff\_key(self::$notices, array\_flip($dismissed)) : array(); |
| [233](#L233) |  |
| [234](#L234) | foreach($notices as $key => $notice) |
| [235](#L235) | printf($content, $notice[0], $key, $notice[1]); |
| [236](#L236) |  |
| [237](#L237) | if ($notices) { |
| [238](#L238) | echo Mappress::script("jQuery('[data-mapp-dismiss]').on('click', '.notice-dismiss, .mapp-dismiss', function(e) { |
| [239](#L239) | var key = jQuery(this).closest('.notice').attr('data-mapp-dismiss'); |
| [240](#L240) | jQuery(this).closest('[data-mapp-dismiss]').remove(); |
| [241](#L241) | jQuery.post(ajaxurl, { action : 'mapp\_dismiss', key : key }); |
| [242](#L242) | });"); |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | /\*\* |
| [248](#L248) | \* Dismiss/undismiss admin notices |
| [249](#L249) | \* |
| [250](#L250) | \* @param mixed $key - notice to dismiss/undismiss |
| [251](#L251) | \* @param mixed $dismiss - true to dismiss, false to undismiss |
| [252](#L252) | \* @return mixed |
| [253](#L253) | \*/ |
| [254](#L254) | static function admin\_notices\_dismiss($key, $dismiss) { |
| [255](#L255) | if (!$key) |
| [256](#L256) | return; |
| [257](#L257) |  |
| [258](#L258) | $dismissed = array\_filter( explode( ',', (string) get\_user\_meta( get\_current\_user\_id(), 'mappress\_dismissed', true ) ) ); |
| [259](#L259) | if ($dismiss) |
| [260](#L260) | $dismissed[] = $key; |
| [261](#L261) | else |
| [262](#L262) | unset($dismissed[$key]); |
| [263](#L263) | update\_user\_meta( get\_current\_user\_id(), 'mappress\_dismissed', implode( ',', $dismissed )); |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | static function ajax\_dismiss() { |
| [267](#L267) | // Still sent via jQuery |
| [268](#L268) | $key = (isset($\_POST['key'])) ? $\_POST['key'] : null; |
| [269](#L269) | if (!$key || sanitize\_key( $key) != $key) |
| [270](#L270) | wp\_die( 0 ); |
| [271](#L271) | self::admin\_notices\_dismiss($key, true); |
| [272](#L272) | self::ajax\_response('OK'); |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) | static function ajax\_response($status, $data=null) { |
| [276](#L276) | $output = trim(ob\_get\_clean());         // Ignore whitespace, any other output is an error |
| [277](#L277) | header( "Content-Type: application/json" ); |
| [278](#L278) |  |
| [279](#L279) | // WP bug: when zlib active, warning messages are generated, which corrupt JSON output |
| [280](#L280) | // Ticket has been open for 9 years.  Workaround is to disable flush when providing json response - may cause other conflicts! |
| [281](#L281) | // https://core.trac.wordpress.org/ticket/22430, https://core.trac.wordpress.org/ticket/18525 |
| [282](#L282) | if (ini\_get('zlib.output\_compression')) |
| [283](#L283) | remove\_action( 'shutdown', 'wp\_ob\_end\_flush\_all', 1 ); |
| [284](#L284) |  |
| [285](#L285) | $response = json\_encode(array('status' => $status, 'output' => $output, 'data' => $data)); |
| [286](#L286) | die ($response); |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | // 5.8 version of block\_categories hook |
| [290](#L290) | // Older GT versions send ($categories, $post) instead of ($categories, $context) |
| [291](#L291) | static function block\_categories($categories, $context) { |
| [292](#L292) | self::$block\_category = 'mappress'; |
| [293](#L293) | return array\_merge( |
| [294](#L294) | $categories, |
| [295](#L295) | array( |
| [296](#L296) | array( |
| [297](#L297) | 'slug' => 'mappress', |
| [298](#L298) | 'title' => 'MapPress' |
| [299](#L299) | ), |
| [300](#L300) | ) |
| [301](#L301) | ); |
| [302](#L302) | } |
| [303](#L303) |  |
| [304](#L304) | static function deactivate() { |
| [305](#L305) | $reason = (isset($\_REQUEST['mapp\_reason'])) ? $\_REQUEST['mapp\_reason'] : null; |
| [306](#L306) | $reason\_text = (isset($\_REQUEST['mapp\_reason\_text'])) ? $\_REQUEST['mapp\_reason\_text'] : null; |
| [307](#L307) |  |
| [308](#L308) | if (!$reason || $reason == 'private' || $reason == 'temporary') |
| [309](#L309) | return; |
| [310](#L310) |  |
| [311](#L311) | // Don't bother if there's no reason text |
| [312](#L312) | if (empty($reason\_text)) |
| [313](#L313) | return; |
| [314](#L314) |  |
| [315](#L315) | // Call API (static functions can't use api\_call()) |
| [316](#L316) | $args = array( |
| [317](#L317) | 'api\_action' => 'feedback', |
| [318](#L318) | 'network\_url' => (is\_multisite()) ? trim(network\_home\_url()) : trim(home\_url()), |
| [319](#L319) | 'plugin' => 'mappress', |
| [320](#L320) | 'reason' => $reason, |
| [321](#L321) | 'reason\_text' => $reason\_text, |
| [322](#L322) | 'url' => trim(home\_url()), |
| [323](#L323) | ); |
| [324](#L324) | $response = wp\_remote\_post('https://mappresspro.com', array('timeout' => 15, 'sslverify' => false, 'body' => (array) $args)); |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | static function debugging() { |
| [328](#L328) | global $wpdb; |
| [329](#L329) |  |
| [330](#L330) | if (isset($\_GET['mp\_info'])) { |
| [331](#L331) | echo "<b>Plugin</b> " . self::$version; |
| [332](#L332) | $maps\_table = $wpdb->prefix . 'mapp\_maps'; |
| [333](#L333) | $results = $wpdb->get\_results("SELECT otype, oid, mapid FROM $maps\_table"); |
| [334](#L334) | echo "<br/>otype/oid => mapid<br/>"; |
| [335](#L335) | foreach($results as $i => $result) { |
| [336](#L336) | if ($i > 50) |
| [337](#L337) | break; |
| [338](#L338) | echo "<br/>$result->otype / $result->oid => $result->mapid"; |
| [339](#L339) | } |
| [340](#L340) | $options = Mappress\_Options::get(); |
| [341](#L341) | unset($options->mapbox, $options->license, $options->apiKey, $options->apiKeyServer); |
| [342](#L342) | echo str\_replace(array("\r", "\n"), array('<br/>', '<br/>'), print\_r($options, true)); |
| [343](#L343) | die(); |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | if (isset($\_REQUEST['mp\_debug'])) |
| [347](#L347) | self::$debug = max(1, (int) $\_REQUEST['mp\_debug']); |
| [348](#L348) | else if (defined('MAPPRESS\_DEBUG') && MAPPRESS\_DEBUG) |
| [349](#L349) | self::$debug = true; |
| [350](#L350) |  |
| [351](#L351) | if (self::$debug) { |
| [352](#L352) | error\_reporting(E\_ALL); |
| [353](#L353) | ini\_set('error\_reporting', E\_ALL); |
| [354](#L354) | ini\_set('display\_errors','On'); |
| [355](#L355) | $wpdb->show\_errors(); |
| [356](#L356) | } |
| [357](#L357) | } |
| [358](#L358) |  |
| [359](#L359) | static function get\_api\_keys() { |
| [360](#L360) | $results = (object) array( |
| [361](#L361) | 'browser' => self::$options->apiKey, |
| [362](#L362) | 'server' => self::$options->apiKeyServer, |
| [363](#L363) | 'liq' => self::$options->liq, |
| [364](#L364) | 'mapbox' => self::$options->mapbox |
| [365](#L365) | ); |
| [366](#L366) | if (empty($results->browser) && defined('MAPPRESS\_APIKEY')) |
| [367](#L367) | $results->browser = MAPPRESS\_APIKEY; |
| [368](#L368) | if (empty($results->server) && defined('MAPPRESS\_APIKEY\_SERVER')) |
| [369](#L369) | $results->server = MAPPRESS\_APIKEY\_SERVER; |
| [370](#L370) | if (empty($results->mapbox) && defined('MAPPRESS\_APIKEY\_MAPBOX')) |
| [371](#L371) | $results->mapbox = MAPPRESS\_APIKEY\_MAPBOX; |
| [372](#L372) | return $results; |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | static function get\_iframe($map) { |
| [376](#L376) | $styles = new WP\_Styles(); |
| [377](#L377) | $scripts = new WP\_Scripts(); |
| [378](#L378) | self::scripts\_register($scripts); |
| [379](#L379) | self::scripts\_enqueue('frontend', $scripts); |
| [380](#L380) | self::styles\_register($styles); |
| [381](#L381) | self::styles\_enqueue('frontend', $styles); |
| [382](#L382) |  |
| [383](#L383) | $content = $map->display(null, true); |
| [384](#L384) |  |
| [385](#L385) | ob\_start(); |
| [386](#L386) | ?> |
| [387](#L387) | <!doctype html> |
| [388](#L388) | <html class='mapp-iframe-html' <?php language\_attributes(); ?>> |
| [389](#L389) | <head> |
| [390](#L390) | <title>MapPress</title> |
| [391](#L391) | <?php Mappress::wp\_head(); ?> |
| [392](#L392) | <?php $styles->do\_items(array('mappress', 'mappress-custom')); ?> |
| [393](#L393) | </head> |
| [394](#L394) | <body class='mapp-iframe-body'> |
| [395](#L395) | <?php echo $content; ?> |
| [396](#L396) | <?php $scripts->do\_items('mappress'); ?> |
| [397](#L397) | <?php Mappress\_Template::print\_footer\_templates(); ?> |
| [398](#L398) | <script type='javascript'>mappload();</script> |
| [399](#L399) | </body> |
| [400](#L400) | </html> |
| [401](#L401) | <?php |
| [402](#L402) | $html = ob\_get\_clean(); |
| [403](#L403) | return $html; |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | /\*\* |
| [407](#L407) | \* Get language using settings/WPML/qTrans |
| [408](#L408) | \* |
| [409](#L409) | \*/ |
| [410](#L410) | static function get\_language() { |
| [411](#L411) | // WPML |
| [412](#L412) | if (defined('ICL\_LANGUAGE\_CODE')) |
| [413](#L413) | $lang = ICL\_LANGUAGE\_CODE; |
| [414](#L414) |  |
| [415](#L415) | // qTranslate |
| [416](#L416) | else if (function\_exists('qtrans\_getLanguage')) |
| [417](#L417) | $lang = qtrans\_getLanguage(); |
| [418](#L418) |  |
| [419](#L419) | else |
| [420](#L420) | $lang = self::$options->language; |
| [421](#L421) |  |
| [422](#L422) | return ($lang) ? $lang : null; |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) | /\*\* |
| [426](#L426) | \* Get a mashup - used by shortcode and widget |
| [427](#L427) | \* |
| [428](#L428) | \* @param mixed $atts |
| [429](#L429) | \*/ |
| [430](#L430) | static function get\_mashup($atts) { |
| [431](#L431) | global $wp\_query; |
| [432](#L432) |  |
| [433](#L433) | $mashup = new Mappress\_Map($atts); |
| [434](#L434) | $mashup->otype = (isset($atts['otype']) && $atts['otype'] == 'user') ? 'user' : 'post'; |
| [435](#L435) | $mashup->query = Mappress\_Query::parse\_query($atts); |
| [436](#L436) |  |
| [437](#L437) | // If parameter test="true", output the query result (or global query) without using a map |
| [438](#L438) | if (isset($\_GET['mp\_test']) || (isset($atts['test']) && $atts['test'])) { |
| [439](#L439) | $wpq = ($mashup->query) ? new WP\_Query($mashup->query) : $wp\_query; |
| [440](#L440) | return "<pre>" . print\_r($wpq, true) . "</pre>"; |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | // If 'hideEmpty' is set, try to suppress the map if there are no POIs |
| [444](#L444) | if ($mashup->hideEmpty) { |
| [445](#L445) | if (Mappress\_Query::is\_empty($mashup->query)) |
| [446](#L446) | return ""; |
| [447](#L447) | } |
| [448](#L448) | return $mashup->display(); |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) | static function heartbeat\_settings( $settings ) { |
| [452](#L452) | $settings['minimalInterval'] = 600; |
| [453](#L453) | return $settings; |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | /\*\* |
| [457](#L457) | \* There are several WP bugs that prevent correct activation in multisitie: |
| [458](#L458) | \*   http://core.trac.wordpress.org/ticket/14170 |
| [459](#L459) | \*   http://core.trac.wordpress.org/ticket/14718) |
| [460](#L460) | \* |
| [461](#L461) | \*/ |
| [462](#L462) | static function init() { |
| [463](#L463) | Mappress\_Compliance::register(); |
| [464](#L464) | Mappress\_Db::register(); |
| [465](#L465) | Mappress\_Map::register(); |
| [466](#L466) | Mappress\_Settings::register(); |
| [467](#L467) | Mappress\_Template::register(); |
| [468](#L468) | Mappress\_WPML::register(); |
| [469](#L469) |  |
| [470](#L470) | if (self::$pro) { |
| [471](#L471) | Mappress\_Filter::register(); |
| [472](#L472) | Mappress\_Frontend::register(); |
| [473](#L473) | Mappress\_Icons::register(); |
| [474](#L474) | Mappress\_Import::register(); |
| [475](#L475) | Mappress\_Meta::register(); |
| [476](#L476) | Mappress\_Query::register(); |
| [477](#L477) | Mappress\_Widget::register(); |
| [478](#L478) | Mappress\_Widget\_Map::register(); |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | self::styles\_register(); |
| [482](#L482) | self::scripts\_register(); |
| [483](#L483) |  |
| [484](#L484) | // Register Gutenberg block types and load GT scripts |
| [485](#L485) | if (function\_exists('register\_block\_type')) { |
| [486](#L486) | register\_block\_type('mappress/map', array( |
| [487](#L487) | 'render\_callback' => array(\_\_CLASS\_\_, 'shortcode\_map'), |
| [488](#L488) | 'editor\_script' => array('mappress\_admin'), |
| [489](#L489) | 'style' => 'mappress', |
| [490](#L490) | 'editor\_style' => 'mappress-admin' |
| [491](#L491) | )); |
| [492](#L492) | if (self::$pro) { |
| [493](#L493) | register\_block\_type('mappress/mashup', array( |
| [494](#L494) | 'render\_callback' => array(\_\_CLASS\_\_, 'shortcode\_mashup'), |
| [495](#L495) | 'editor\_script' => array('mappress\_admin'), |
| [496](#L496) | 'style' => 'mappress', |
| [497](#L497) | 'editor\_style' => 'mappress-admin' |
| [498](#L498) | )); |
| [499](#L499) | } |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | // Check if upgrade is needed |
| [503](#L503) | $current\_version = get\_option('mappress\_version'); |
| [504](#L504) |  |
| [505](#L505) | if (empty($current\_version)) { |
| [506](#L506) | $args = array( |
| [507](#L507) | 'api\_action' => 'feedback', |
| [508](#L508) | 'network\_url' => (is\_multisite()) ? trim(network\_home\_url()) : trim(home\_url()), |
| [509](#L509) | 'plugin' => 'mappress', |
| [510](#L510) | 'reason' => 'new', |
| [511](#L511) | 'reason\_text' => '', |
| [512](#L512) | 'url' => trim(home\_url()), |
| [513](#L513) | ); |
| [514](#L514) | $response = wp\_remote\_post('https://mappresspro.com', array('timeout' => 15, 'sslverify' => false, 'body' => (array) $args)); |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | // Algolia geocoder discontinued since 2.69.3 |
| [518](#L518) | if (empty(self::$options->geocoder || self::$options->geocoder == 'algolia')) { |
| [519](#L519) | self::$options->geocoder = 'nominatim'; |
| [520](#L520) | self::$options->save(); |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | // Check for license expired |
| [524](#L524) | if (self::$pro && self::$options->license) { |
| [525](#L525) | $last\_check = get\_option('mappress\_license\_check'); |
| [526](#L526) | if (!$last\_check || time() > $last\_check + (60 \* 60 \* 24 \* 7)) { |
| [527](#L527) | $status = Mappress::$updater->get\_status(); |
| [528](#L528) | if ($status == 'inactive') { |
| [529](#L529) | $renew\_link = sprintf("<a target='\_blank' href='https://mappresspro.com/account'>%s</a>", \_\_('Renew your license', 'mappress-google-maps-for-wordpress')); |
| [530](#L530) | self::admin\_notices\_dismiss('expiredlicense', false); |
| [531](#L531) | self::$notices['expiredlicense'] = sprintf(\_\_('Your MapPress license has expired.  %s to get the latest updates and prevent errors.', 'mappress-google-maps-for-wordpress'), $renew\_link); |
| [532](#L532) | } |
| [533](#L533) | update\_option('mappress\_license\_check', time()); |
| [534](#L534) | return; |
| [535](#L535) | } |
| [536](#L536) | } |
| [537](#L537) |  |
| [538](#L538) | // Missing license |
| [539](#L539) | if (self::$pro && empty(self::$options->license) && (!is\_multisite() || (is\_super\_admin() && is\_main\_site()))) |
| [540](#L540) | self::$notices['nolicense'] = array('warning', \_\_('Please enter your MapPress license key to enable plugin updates', 'mappress-google-maps-for-wordpress')); |
| [541](#L541) |  |
| [542](#L542) | if (self::VERSION >= '2.55' && version\_compare(get\_bloginfo('version'),'5.3', '<') ) |
| [543](#L543) | self::$notices['255\_min\_version'] = array('error', \_\_('MapPress Gutenberg blocks require WordPress 5.3 or the latest Gutenberg Plugin. Please update if using the block editor.', 'mappress-google-maps-for-wordpress')); |
| [544](#L544) |  |
| [545](#L545) | if ($current\_version && $current\_version < '2.55' && self::VERSION >= '2.55') |
| [546](#L546) | self::$notices['255\_whats\_new'] = array('info', sprintf(\_\_('MapPress has many new features!  %s.', 'mappress-google-maps-for-wordpress'), '<a target="\_blank" href="https://mappresspro.com/whats-new">' . \_\_("Learn more", 'mappress-google-maps-for-wordpress') . '</a>')); |
| [547](#L547) |  |
| [548](#L548) | if ($current\_version && $current\_version < '2.60' && self::VERSION >= '2.60') |
| [549](#L549) | self::$notices['260\_whats\_new'] = array('warning', sprintf(\_\_('MapPress templates have changed!  Please update custom templates to the new format. %s.', 'mappress-google-maps-for-wordpress'), '<a target="\_blank" href="https://mappresspro.com/whats-new">' . \_\_("Learn more", 'mappress-google-maps-for-wordpress') . '</a>')); |
| [550](#L550) |  |
| [551](#L551) | // Upgrades |
| [552](#L552) | if ($current\_version) { |
| [553](#L553) | if (version\_compare($current\_version, '2.63', '<')) { |
| [554](#L554) | // New list templates |
| [555](#L555) | self::$notices['263\_whats\_new'] = array('warning', sprintf(\_\_('MapPress templates and filters have changed.  Please update custom templates and filters. %s.', 'mappress-google-maps-for-wordpress'), '<a target="\_blank" href="https://mappresspro.com/whats-new">' . \_\_("Learn more", 'mappress-google-maps-for-wordpress') . '</a>')); |
| [556](#L556) |  |
| [557](#L557) | // Convert filters to array |
| [558](#L558) | if (self::$options->filter) { |
| [559](#L559) | self::$options->filters = array(array('key' => self::$options->filter)); |
| [560](#L560) | self::$options->save(); |
| [561](#L561) | } |
| [562](#L562) |  |
| [563](#L563) | // Convert styles to indexed arrays |
| [564](#L564) | if (self::$options->styles && is\_array(self::$options->styles)) { |
| [565](#L565) | self::$options->stylesGoogle = array(); |
| [566](#L566) | self::$options->stylesMapbox = array(); |
| [567](#L567) | foreach(self::$options->styles as $name => $json) |
| [568](#L568) | self::$options->stylesGoogle[] = array('id' => $name, 'name' => $name, 'url' => null, 'json' => $json, 'imageUrl' => self::$baseurl . '/images/roadmap.png'); |
| [569](#L569) | foreach(self::$options->mapboxStyles as $name => $url) { |
| [570](#L570) | $parts = explode('?', strtolower($url)); |
| [571](#L571) | $short\_url = str\_ireplace(array('.html', 'https://api.mapbox.com/styles/v1/', 'mapbox://styles/'), '', $parts[0]); |
| [572](#L572) | $parts = explode('/', $short\_url); |
| [573](#L573) | if (count($parts) == 2) |
| [574](#L574) | self::$options->stylesMapbox[] = array('url' => $url, 'provider' => 'mapbox', 'user' => $parts[0], 'id' => $name, 'mapboxid' => $parts[1], 'name' => $name); |
| [575](#L575) | } |
| [576](#L576) | self::$options->save(); |
| [577](#L577) | } |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | // 2.73 Add a type to all filters |
| [581](#L581) | if (version\_compare($current\_version, '2.73', '<')) { |
| [582](#L582) | foreach(self::$options->filters as &$filter) { |
| [583](#L583) | if (empty($filter['type'])) |
| [584](#L584) | $filter['type'] = 'tax'; |
| [585](#L585) | } |
| [586](#L586) | self::$options->save(); |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | // 2.76 New templates |
| [590](#L590) | if (version\_compare($current\_version, '2.76', '<')) |
| [591](#L591) | self::$notices['276\_whats\_new'] = array('warning', sprintf(\_\_('MapPress templates have changed!  Please update custom templates to the new format. %s.', 'mappress-google-maps-for-wordpress'), '<a target="\_blank" href="https://mappresspro.com/whats-new">' . \_\_("Learn more", 'mappress-google-maps-for-wordpress') . '</a>')); |
| [592](#L592) |  |
| [593](#L593) | // 2.80 - DB upgrade, filters and meta |
| [594](#L594) | if (version\_compare($current\_version, '2.80', '<')) { |
| [595](#L595) | // Convert filters and meta to include users |
| [596](#L596) | self::$options->filters = array('post' => self::$options->filters, 'user' => array()); |
| [597](#L597) | self::$options->metaKeys = array('post' => self::$options->metaKeys, 'user' => array()); |
| [598](#L598) | self::$options->save(); |
| [599](#L599) |  |
| [600](#L600) | // trigger DB ugprade by setting db\_version lower than current version |
| [601](#L601) | update\_option('mappress\_db\_version', '2.79'); |
| [602](#L602) | Mappress\_Db::upgrade(); |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | // 2.84 - copy mashupbody setting => mashupthumbs (poi | post) |
| [606](#L606) | if (version\_compare($current\_version, '2.84', '<')) |
| [607](#L607) | self::$options->mashupThumbs = self::$options->mashupBody; |
| [608](#L608) |  |
| [609](#L609) | // 2.85 - rename filters type checkbox=>checkboxes and radio=>radios |
| [610](#L610) | if (version\_compare($current\_version, '2.85', '<')) { |
| [611](#L611) | foreach(['post', 'user'] as $type) { |
| [612](#L612) | $filters = self::$options->filters[$type] ?? []; |
| [613](#L613) | foreach($filters as &$filter) { |
| [614](#L614) | if ($filter['format'] == 'radio') |
| [615](#L615) | $filter['format'] = 'radios'; |
| [616](#L616) | else if ($filter['format'] == 'checkbox') |
| [617](#L617) | $filter['format'] = 'checkboxes'; |
| [618](#L618) | } |
| [619](#L619) | self::$options->filters[$type] = $filters; |
| [620](#L620) | } |
| [621](#L621) | self::$options->save(); |
| [622](#L622) | } |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) | update\_option('mappress\_version', self::VERSION); |
| [626](#L626) | } |
| [627](#L627) |  |
| [628](#L628) | // Prevent shortcodes on admin screens |
| [629](#L629) | static function is\_admin() { |
| [630](#L630) | $ajax = defined('DOING\_AJAX') && DOING\_AJAX; |
| [631](#L631) | $rest = defined('REST\_REQUEST') && REST\_REQUEST; |
| [632](#L632) | return (is\_admin() && !$ajax) || $rest; |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | static function is\_dev() { |
| [636](#L636) | if (defined('MAPPRESS\_DEV') && MAPPRESS\_DEV) |
| [637](#L637) | return MAPPRESS\_DEV; |
| [638](#L638) | else if (isset($\_REQUEST['mp\_dev'])) |
| [639](#L639) | return ($\_REQUEST['mp\_dev']) ? $\_REQUEST['mp\_dev'] : 'dev'; |
| [640](#L640) | else |
| [641](#L641) | return false; |
| [642](#L642) | } |
| [643](#L643) |  |
| [644](#L644) | static function is\_footer() { |
| [645](#L645) | if (defined('DOING\_AJAX') && DOING\_AJAX) |
| [646](#L646) | return false; |
| [647](#L647) | if (defined('REST\_REQUEST') && REST\_REQUEST) |
| [648](#L648) | return true; |
| [649](#L649) | if (is\_admin()) |
| [650](#L650) | return true; |
| [651](#L651) | return self::$options->footer; |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | static function is\_localhost() { |
| [655](#L655) | return !filter\_var($\_SERVER['SERVER\_ADDR'], FILTER\_VALIDATE\_IP, FILTER\_FLAG\_NO\_PRIV\_RANGE | FILTER\_FLAG\_NO\_RES\_RANGE); |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | static function is\_plugin\_active($plugin) { |
| [659](#L659) | $plugins = array('complianz' => 'complianz-gdpr/complianz-gpdr.php', 'amp' => 'amp/amp.php'); |
| [660](#L660) | if (array\_key\_exists($plugin, $plugins)) |
| [661](#L661) | $plugin = $plugins[$plugin]; |
| [662](#L662) |  |
| [663](#L663) | // Can't use WP's is\_plugin\_active on frontend w/o including WP files |
| [664](#L664) | if (in\_array($plugin, (array) get\_option('active\_plugins', array()), true)) |
| [665](#L665) | return true; |
| [666](#L666) | if (is\_multisite() && in\_array($plugin, (array) get\_option('active\_sitewide\_plugins', array()), true)) |
| [667](#L667) | return true; |
| [668](#L668) | return false; |
| [669](#L669) | } |
| [670](#L670) |  |
| [671](#L671) | static function is\_ssl() { |
| [672](#L672) | return (is\_ssl() || !filter\_var($\_SERVER['REMOTE\_ADDR'], FILTER\_VALIDATE\_IP, FILTER\_FLAG\_NO\_PRIV\_RANGE | FILTER\_FLAG\_NO\_RES\_RANGE)); |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | static function l10n() { |
| [676](#L676) | global $post, $is\_IE; |
| [677](#L677) |  |
| [678](#L678) | $l10n = array('delete\_prompt' => \_\_('Are you sure you want to delete?', 'mappress-google-maps-for-wordpress')); |
| [679](#L679) |  |
| [680](#L680) | // Globals |
| [681](#L681) | $l10n['options'] = array( |
| [682](#L682) | 'admin' => current\_user\_can('administrator'), |
| [683](#L683) | 'adminurl' => admin\_url(), |
| [684](#L684) | 'ajaxurl' => admin\_url('admin-ajax.php'), |
| [685](#L685) | 'apikey' => self::get\_api\_keys()->browser, |
| [686](#L686) | 'baseurl' => self::$baseurl, |
| [687](#L687) | 'blockCategory' => self::$block\_category, |
| [688](#L688) | 'debug' => self::$debug, |
| [689](#L689) | 'editurl' => admin\_url('post.php'), |
| [690](#L690) | 'filterParams' => (class\_exists('Mappress\_Filter')) ? Mappress\_Filter::get\_url\_params() : array(), |
| [691](#L691) | 'iconsUrl' => (self::$pro) ? Mappress\_Icons::$icons\_url : null, |
| [692](#L692) | 'isIE' => $is\_IE, |
| [693](#L693) | 'language' => self::get\_language(), |
| [694](#L694) | 'liq' => self::get\_api\_keys()->liq, |
| [695](#L695) | 'mapbox' => self::get\_api\_keys()->mapbox, |
| [696](#L696) | 'nonce' => wp\_create\_nonce('mappress'), |
| [697](#L697) | 'oid' => ($post) ? $post->ID : null,    // Note: GT => numeric, classic => string |
| [698](#L698) | 'otype' => ($post) ? 'post' : null,             // Not for users yet |
| [699](#L699) | 'pro' => self::$pro, |
| [700](#L700) | 'ssl' => self::is\_ssl(),                // SSL is needed for 'your location' in directions |
| [701](#L701) | 'standardIcons' => (self::$pro) ? Mappress\_Icons::$standard\_icons : null, |
| [702](#L702) | 'standardIconsUrl' => (self::$pro) ? Mappress\_Icons::$standard\_icons\_url : null, |
| [703](#L703) | 'userStyles' => (self::$options->engine == 'leaflet') ? self::$options->stylesMapbox : self::$options->stylesGoogle, |
| [704](#L704) | 'userIcons' => (self::$pro) ? Mappress\_Icons::get\_user\_icons() : null, |
| [705](#L705) | 'version' => self::$version |
| [706](#L706) | ); |
| [707](#L707) |  |
| [708](#L708) | // Tile providers |
| [709](#L709) | $l10n['options']['tileProviders'] = array( |
| [710](#L710) | 'mapbox' => array( |
| [711](#L711) | 'accessToken' => self::get\_api\_keys()->mapbox, |
| [712](#L712) | 'attribution' => ['<a href="https://www.mapbox.com/about/maps" target="\_blank">&copy; Mapbox</a>', '<a href="https://www.openstreetmap.org/about/" target="\_blank">&copy; OpenStreetMap</a>' ], |
| [713](#L713) | 'url' => 'https://api.mapbox.com/styles/v1/{user}/{mapboxid}/tiles/256/{z}/{x}/{y}{r}?access\_token={accessToken}&fresh=true', |
| [714](#L714) | 'zoomOffset' => 0 |
| [715](#L715) | ), |
| [716](#L716) | 'osm' => array( |
| [717](#L717) | 'attribution' => ['<a href="https://openstreetmap.org" target="\_blank">&copy; OpenStreetMap</a>'], |
| [718](#L718) | 'url' => 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' |
| [719](#L719) | ) |
| [720](#L720) | ); |
| [721](#L721) |  |
| [722](#L722) | // Default styles |
| [723](#L723) | if (Mappress::$options->engine == 'leaflet') { |
| [724](#L724) | if (Mappress::get\_api\_keys()->mapbox) { |
| [725](#L725) | $styles = array( |
| [726](#L726) | array('id' => 'streets', 'type' => 'standard', 'provider' => 'mapbox', 'user' => 'mapbox', 'mapboxid' => 'streets-v11', 'name' => \_\_('Streets', 'mappress-google-maps-for-wordpress')), |
| [727](#L727) | array('id' => 'outdoors', 'type' => 'standard', 'provider' => 'mapbox', 'user' => 'mapbox', 'mapboxid' => 'outdoors-v11', 'name' => \_\_('Outdoors', 'mappress-google-maps-for-wordpress')), |
| [728](#L728) | array('id' => 'light', 'type' => 'standard', 'provider' => 'mapbox', 'user' => 'mapbox', 'mapboxid' => 'light-v10', 'name' => \_\_('Light', 'mappress-google-maps-for-wordpress')), |
| [729](#L729) | array('id' => 'dark', 'type' => 'standard', 'provider' => 'mapbox', 'user' => 'mapbox', 'mapboxid' => 'dark-v10', 'name' => \_\_('Dark', 'mappress-google-maps-for-wordpress')), |
| [730](#L730) | array('id' => 'satellite', 'type' => 'standard', 'provider' => 'mapbox', 'user' => 'mapbox', 'mapboxid' => 'satellite-v9', 'name' => \_\_('Satellite', 'mappress-google-maps-for-wordpress')), |
| [731](#L731) | array('id' => 'satellite-streets', 'type' => 'standard', 'provider' => 'mapbox', 'user' => 'mapbox', 'mapboxid' => 'satellite-streets-v11', 'name' => \_\_('Satellite Streets', 'mappress-google-maps-for-wordpress')) |
| [732](#L732) | ); |
| [733](#L733) | } else { |
| [734](#L734) | $styles = array( |
| [735](#L735) | array('id' => 'osm', 'type' => 'standard', 'provider' => 'osm', 'name' => \_\_('Streets', 'mappress-google-maps-for-wordpress')) |
| [736](#L736) | ); |
| [737](#L737) | } |
| [738](#L738) | } else { |
| [739](#L739) | // Google styles |
| [740](#L740) | $styles = array( |
| [741](#L741) | array( 'id' => 'roadmap', 'type' => 'standard', 'name' => \_\_('Roadmap', 'mappress-google-maps-for-wordpress'), 'imageUrl' => Mappress::$baseurl . '/images/roadmap.png'), |
| [742](#L742) | array( 'id' => 'terrain', 'type' => 'standard', 'name' => \_\_('Terrain', 'mappress-google-maps-for-wordpress'), 'imageUrl' => Mappress::$baseurl . '/images/terrain.png'), |
| [743](#L743) | array( 'id' => 'satellite', 'type' => 'standard', 'name' => \_\_('Satellite', 'mappress-google-maps-for-wordpress'), 'imageUrl' => Mappress::$baseurl . '/images/satellite.png'), |
| [744](#L744) | array( 'id' => 'hybrid', 'type' => 'standard', 'name' => \_\_('Hybrid', 'mappress-google-maps-for-wordpress'), 'imageUrl' => Mappress::$baseurl . '/images/hybrid.png'), |
| [745](#L745) | ); |
| [746](#L746) | } |
| [747](#L747) | $l10n['options']['standardStyles'] = $styles; |
| [748](#L748) |  |
| [749](#L749) | // Global settings |
| [750](#L750) | $options = array('alignment', 'betaPoiFields', 'clustering', 'clusteringOptions', 'country', 'defaultIcon', 'directions', 'directionsList', |
| [751](#L751) | 'directionsPopup', 'directionsServer', 'engine', 'filters', 'filtersPos', 'geocoder', 'geolocate', |
| [752](#L752) | 'highlight', 'highlightIcon', 'iconScale', 'initialOpenInfo', 'layout', 'lines', 'lineOpts', |
| [753](#L753) | 'mashupClick', 'mini', 'poiFields', 'poiList', 'poiListOpen', 'poiListPageSize', 'poiListViewport', 'poiZoom', 'radius', 'scrollWheel', 'search', |
| [754](#L754) | 'searchBox', 'searchParam', 'searchPlaceholder', 'size', 'sizes', 'sort', 'style', 'thumbHeight', 'thumbWidth', 'thumbs', 'thumbsList', 'thumbsPopup', |
| [755](#L755) | 'tooltips', 'units', 'userLocation', 'webComponent'); |
| [756](#L756) |  |
| [757](#L757) | foreach($options as $option) { |
| [758](#L758) | if (isset(self::$options->$option)) { |
| [759](#L759) | $l10n['options'][$option] = self::$options->$option; |
| [760](#L760) | } |
| [761](#L761) | } |
| [762](#L762) |  |
| [763](#L763) | return apply\_filters('mappress\_options', $l10n); |
| [764](#L764) | } |
| [765](#L765) |  |
| [766](#L766) | static function map\_library() { |
| [767](#L767) | self::scripts\_enqueue('backend'); |
| [768](#L768) | echo '<div id="mapp-library" class="mapp-library"></div>'; |
| [769](#L769) | wp\_editor('', 'mapp-library-tinymce'); |
| [770](#L770) | } |
| [771](#L771) |  |
| [772](#L772) | /\*\* |
| [773](#L773) | \* Add KML/KMZ as valid mime types |
| [774](#L774) | \* |
| [775](#L775) | \* @param mixed $mimes |
| [776](#L776) | \*/ |
| [777](#L777) | static function mime\_types($mimes) { |
| [778](#L778) | // Additional entries must match WP, which use finfo\_file(), e.g. KML => text/xml |
| [779](#L779) | $mimes['kml'] = 'text/xml';                     // Real type: 'application/vnd.google-earth.kml+xml'; |
| [780](#L780) | $mimes['kmz'] = 'application/zip';      // Real type: 'application/vnd.google-earth.kmz'; |
| [781](#L781) | return $mimes; |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | static function plugin\_action\_links($links, $file) { |
| [785](#L785) | $settings\_link = "<a href='" . admin\_url("admin.php?page=mappress") . "'>" . \_\_('Settings', 'mappress-google-maps-for-wordpress') . "</a>"; |
| [786](#L786) | $whatsnew\_link = "<a href='https://mappresspro.com/whats-new/' target='\_blank'>" . \_\_("What's new", 'mappress-google-maps-for-wordpress') . "</a>"; |
| [787](#L787) | array\_unshift( $links, $whatsnew\_link ); |
| [788](#L788) | array\_unshift( $links, $settings\_link); |
| [789](#L789) | return $links; |
| [790](#L790) | } |
| [791](#L791) |  |
| [792](#L792) | static function plugins\_loaded() { |
| [793](#L793) | load\_plugin\_textdomain('mappress-google-maps-for-wordpress', false, dirname(self::$basename) . '/languages'); |
| [794](#L794) | } |
| [795](#L795) |  |
| [796](#L796) | static function script($script) { |
| [797](#L797) | return "\r\n<script type='text/javascript'>\r\n$script\r\n</script>"; |
| [798](#L798) | } |
| [799](#L799) |  |
| [800](#L800) | static function script\_loader\_tag($tag, $handle, $src) { |
| [801](#L801) | // Deregister |
| [802](#L802) | if (self::$options->engine == 'google' && self::$options->deregister && self::$loaded && ($handle != 'mappress-google' && (stripos($src, 'maps.googleapis.com') !== false || stripos($src, 'maps.google.com')))) |
| [803](#L803) | return ''; |
| [804](#L804) | // Re-register |
| [805](#L805) | else if ($handle == 'mappress-google' && empty($tag)) |
| [806](#L806) | return sprintf("<script src='%s' id='mappress-google-js-fixed'></script>\n", self::scripts\_google\_tag()); |
| [807](#L807) | else |
| [808](#L808) | return $tag; |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | static function scripts\_enqueue($type = 'frontend', $scripts = null) { |
| [812](#L812) | if (self::$loaded) |
| [813](#L813) | return; |
| [814](#L814) | else |
| [815](#L815) | self::$loaded = true; |
| [816](#L816) |  |
| [817](#L817) | // Don't output frontend scripts if using iframes |
| [818](#L818) | if (!$scripts && $type == 'frontend' && self::$options->iframes) |
| [819](#L819) | return; |
| [820](#L820) |  |
| [821](#L821) | if ($scripts) { |
| [822](#L822) | // Some plugins add 'defer' using script\_loader\_tag, which interferes with script loading, so remove it |
| [823](#L823) | $nodefer = function ($tag, $handle) { return str\_ireplace('defer="defer"', '', $tag); }; |
| [824](#L824) | add\_filter('script\_loader\_tag', $nodefer, 999); |
| [825](#L825) | $scripts->enqueue('mappress'); |
| [826](#L826) | $scripts->localize('mappress', 'mappl10n', self::l10n()); |
| [827](#L827) | remove\_filter('script\_loader\_tag', $nodefer, 999); |
| [828](#L828) | } else { |
| [829](#L829) | wp\_enqueue\_script('mappress'); |
| [830](#L830) | wp\_localize\_script('mappress', 'mappl10n', self::l10n()); |
| [831](#L831) |  |
| [832](#L832) | if ($type == 'backend' || $type == 'settings') |
| [833](#L833) | wp\_enqueue\_script('mappress\_admin'); |
| [834](#L834) |  |
| [835](#L835) | if ($type == 'settings') { |
| [836](#L836) | if (function\_exists('wp\_enqueue\_code\_editor')) |
| [837](#L837) | wp\_enqueue\_code\_editor(array( 'type' => 'php' )); |
| [838](#L838) | } |
| [839](#L839) | } |
| [840](#L840) |  |
| [841](#L841) | // Templates (iframes always queue in footer) |
| [842](#L842) | $footer = ($scripts) ? true : self::is\_footer(); |
| [843](#L843) | $templates = array('map-item', 'map-popup', 'mashup-popup', 'mashup-item', 'user-mashup-item', 'user-mashup-popup'); |
| [844](#L844) | foreach($templates as $template\_name) |
| [845](#L845) | Mappress\_Template::enqueue\_template($template\_name, $footer); |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | static function scripts\_register($scripts = null) { |
| [849](#L849) | $dev = self::is\_dev(); |
| [850](#L850) | $footer = ($scripts) ? false : self::is\_footer(); |
| [851](#L851) |  |
| [852](#L852) | // Directories |
| [853](#L853) | $lib = ($dev) ? "https://localhost/$dev/wp-content/plugins/mappress-google-maps-for-wordpress/lib" : self::$baseurl . '/lib'; |
| [854](#L854) | $js = ($dev) ? "https://localhost/$dev/wp-content/plugins/mappress-google-maps-for-wordpress/build" : self::$baseurl . '/build'; |
| [855](#L855) |  |
| [856](#L856) | // Dependencies |
| [857](#L857) | $deps = array('react', 'react-dom', 'wp-i18n'); |
| [858](#L858) | if (self::$options->engine == 'leaflet') |
| [859](#L859) | $deps = array\_merge(array('mappress-leaflet', 'mappress-leaflet-omnivore'), $deps); |
| [860](#L860) | if (self::$options->engine != 'leaflet' || self::$options->geocoder == 'google') |
| [861](#L861) | $deps[] = 'mappress-google'; |
| [862](#L862) | if (self::$options->clustering) |
| [863](#L863) | $deps[] = (self::$options->engine == 'leaflet') ? 'mappress-leaflet-markercluster' : 'mappress-markerclusterer'; |
| [864](#L864) | $admin\_deps = array('mappress', 'wp-blocks', 'wp-components', 'wp-compose', 'wp-core-data', 'wp-element', 'wp-media-utils', 'wp-i18n', 'wp-notices', 'wp-url'); |
| [865](#L865) |  |
| [866](#L866) | // Clustering ( https://github.com/googlemaps/js-markerclusterer | https://github.com/Leaflet/Leaflet.markercluster ) |
| [867](#L867) | $register = array( |
| [868](#L868) | array("mappress-leaflet", $lib . '/leaflet/leaflet.js', null, null, $footer), |
| [869](#L869) | array("mappress-leaflet-omnivore", $lib . '/leaflet/leaflet-omnivore.min.js', null, null, $footer), |
| [870](#L870) | array("mappress-google", self::scripts\_google\_tag(), null, null, $footer), |
| [871](#L871) | array('mappress-markerclusterer', self::unpkg('markerclusterer', 'index.min.js'), null, null, $footer), |
| [872](#L872) | array('mappress-leaflet-markercluster', $lib . '/leaflet/leaflet.markercluster.js', null, null, $footer), |
| [873](#L873) | array('mappress', $js . "/index\_mappress.js", $deps, self::$version, $footer), |
| [874](#L874) | array('mappress\_admin', $js . "/index\_mappress\_admin.js", $admin\_deps, self::$version, $footer) |
| [875](#L875) | ); |
| [876](#L876) |  |
| [877](#L877) | foreach($register as $script) { |
| [878](#L878) | if ($scripts) |
| [879](#L879) | $scripts->add($script[0], $script[1], $script[2], $script[3], $script[4]); |
| [880](#L880) | else |
| [881](#L881) | wp\_register\_script($script[0], $script[1], $script[2], $script[3], $script[4]); |
| [882](#L882) | } |
| [883](#L883) |  |
| [884](#L884) | // I18N |
| [885](#L885) | if (function\_exists('wp\_set\_script\_translations')) { |
| [886](#L886) | if ($scripts) { |
| [887](#L887) | $scripts->set\_translations('mappress', 'mappress-google-maps-for-wordpress', self::$basedir . '/languages'); |
| [888](#L888) | $scripts->set\_translations('mappress\_admin', 'mappress-google-maps-for-wordpress', self::$basedir . '/languages'); |
| [889](#L889) | } else { |
| [890](#L890) | wp\_set\_script\_translations('mappress', 'mappress-google-maps-for-wordpress', self::$basedir . '/languages'); |
| [891](#L891) | wp\_set\_script\_translations('mappress\_admin', 'mappress-google-maps-for-wordpress', self::$basedir . '/languages'); |
| [892](#L892) | } |
| [893](#L893) | } |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | static function scripts\_google\_tag() { |
| [897](#L897) | $dev = self::is\_dev(); |
| [898](#L898) | $language = self::get\_language(); |
| [899](#L899) | $language = ($language) ? "&language=$language" : ''; |
| [900](#L900) | $apiversion = ($dev) ? '&v=beta' : '&v=3'; |
| [901](#L901) | $apikey = "&key=" . self::get\_api\_keys()->browser; |
| [902](#L902) | $libs = '&libraries=places,drawing'; |
| [903](#L903) | return "https://maps.googleapis.com/maps/api/js?callback=Function.prototype{$apiversion}{$language}{$libs}{$apikey}"; |
| [904](#L904) | } |
| [905](#L905) |  |
| [906](#L906) | /\*\* |
| [907](#L907) | \* Scrub attributes |
| [908](#L908) | \* The WordPress shortcode API passes shortcode attributes in lowercase and with boolean values as strings (e.g. "true") |
| [909](#L909) | \* Converts atts to lowercase, replaces boolean strings with booleans, and creates arrays from comma-separated attributes |
| [910](#L910) | \* |
| [911](#L911) | \* Returns empty array if $atts is empty or not an array |
| [912](#L912) | \*/ |
| [913](#L913) | static function scrub\_atts($atts=null) { |
| [914](#L914) | if (!$atts || !is\_array($atts)) |
| [915](#L915) | return array(); |
| [916](#L916) |  |
| [917](#L917) | // Sanitize, single quotes could be used for xss JS |
| [918](#L918) | foreach($atts as $key => $value) |
| [919](#L919) | $atts[$key] = esc\_attr($value); |
| [920](#L920) |  |
| [921](#L921) | $atts = self::string\_to\_boolean($atts); |
| [922](#L922) |  |
| [923](#L923) | // Shortcode attributes are lowercase so convert everything to lowercase |
| [924](#L924) | $atts = array\_change\_key\_case($atts); |
| [925](#L925) |  |
| [926](#L926) | // Map options - includes both leaflet and Google |
| [927](#L927) | foreach(array('disableDefaultUI', 'disableDoubleClickZoom', 'draggable', 'dragging', 'fullscreenControl', 'geolocate', 'keyboard', |
| [928](#L928) | 'keyboardShortcuts', 'mapTypeControl', 'maxZoom', 'minZoom', 'panControl', 'rotateControl', 'scaleControl', |
| [929](#L929) | 'scrollwheel', 'scrollWheelZoom', 'streetViewControl', 'zoomControl') as $opt) { |
| [930](#L930) | $lcopt = strtolower($opt); |
| [931](#L931) | if (isset($atts[$lcopt])) { |
| [932](#L932) | $atts['mapopts'][$opt] = $atts[$lcopt]; |
| [933](#L933) | unset($atts[$lcopt]); |
| [934](#L934) | } |
| [935](#L935) | } |
| [936](#L936) |  |
| [937](#L937) | // For center = 'post', use location of first poi in first map |
| [938](#L938) | if (isset($atts['center']) && $atts['center'] == 'post') { |
| [939](#L939) | global $post; |
| [940](#L940) | $maps = Mappress\_Map::get\_list('post', $post->ID, 'ids'); |
| [941](#L941) | $map = ($maps) ? Mappress\_Map::get($maps[0]) : null; |
| [942](#L942) | $atts['center'] = ($map && $map->pois) ? $map->pois[0]->point['lat'] . ',' . $map->pois[0]->point['lng'] : null; |
| [943](#L943) | } |
| [944](#L944) |  |
| [945](#L945) | // Conver GT 'align' to 'alignment' |
| [946](#L946) | if (isset($atts['align'])) |
| [947](#L947) | $atts['alignment'] = $atts['align']; |
| [948](#L948) |  |
| [949](#L949) | // Change legacy center='user' to geolocation='true' |
| [950](#L950) | if (isset($atts['center']) && strtolower($atts['center']) == 'user') { |
| [951](#L951) | $atts['center'] = null; |
| [952](#L952) | $atts['geolocate'] = true; |
| [953](#L953) | } |
| [954](#L954) |  |
| [955](#L955) | return $atts; |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | /\*\* |
| [959](#L959) | \* Map shortcode |
| [960](#L960) | \* |
| [961](#L961) | \*/ |
| [962](#L962) | static function shortcode\_map($atts='') { |
| [963](#L963) | global $post; |
| [964](#L964) |  |
| [965](#L965) | if (self::is\_admin() || is\_feed()) |
| [966](#L966) | return; |
| [967](#L967) |  |
| [968](#L968) | $atts = self::scrub\_atts($atts); |
| [969](#L969) |  |
| [970](#L970) | // Determine what to show |
| [971](#L971) | $mapid = (isset($atts['mapid'])) ? $atts['mapid'] : null; |
| [972](#L972) |  |
| [973](#L973) | // On archive pages, $post isn't set |
| [974](#L974) | if (!$mapid && !$post) |
| [975](#L975) | return; |
| [976](#L976) |  |
| [977](#L977) | if ($mapid) { |
| [978](#L978) | // Show map by mapid |
| [979](#L979) | $map = Mappress\_Map::get($mapid); |
| [980](#L980) | } else { |
| [981](#L981) | // Get the first map attached to the post |
| [982](#L982) | $maps = Mappress\_Map::get\_list('post', $post->ID); |
| [983](#L983) | $map = (isset ($maps[0]) ? $maps[0] : false); |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | if (!$map) |
| [987](#L987) | return; |
| [988](#L988) |  |
| [989](#L989) | return $map->display($atts); |
| [990](#L990) | } |
| [991](#L991) |  |
| [992](#L992) | /\*\* |
| [993](#L993) | \* Mashup shortcode |
| [994](#L994) | \* |
| [995](#L995) | \*/ |
| [996](#L996) | static function shortcode\_mashup($atts='') { |
| [997](#L997) | if (self::is\_admin() || is\_feed()) |
| [998](#L998) | return; |
| [999](#L999) |  |
| [1000](#L1000) | $atts = self::scrub\_atts($atts); |
| [1001](#L1001) | return self::get\_mashup($atts); |
| [1002](#L1002) | } |
| [1003](#L1003) |  |
| [1004](#L1004) | static function string\_to\_boolean($data) { |
| [1005](#L1005) | if ($data === 'false') |
| [1006](#L1006) | return false; |
| [1007](#L1007) |  |
| [1008](#L1008) | if ($data === 'true') |
| [1009](#L1009) | return true; |
| [1010](#L1010) |  |
| [1011](#L1011) | if (is\_array($data)) { |
| [1012](#L1012) | foreach($data as &$datum) |
| [1013](#L1013) | $datum = self::string\_to\_boolean($datum); |
| [1014](#L1014) | } |
| [1015](#L1015) | return $data; |
| [1016](#L1016) | } |
| [1017](#L1017) |  |
| [1018](#L1018) | static function styles\_enqueue($type, $styles = null) { |
| [1019](#L1019) | global $wp\_styles; |
| [1020](#L1020) | $styles = ($styles) ? $styles : $wp\_styles; |
| [1021](#L1021) |  |
| [1022](#L1022) | $styles->enqueue('mappress-leaflet'); |
| [1023](#L1023) | $styles->enqueue('mappress-leaflet-markercluster-default'); |
| [1024](#L1024) | $styles->enqueue('mappress-leaflet-markercluster'); |
| [1025](#L1025) | $styles->enqueue('mappress'); |
| [1026](#L1026) |  |
| [1027](#L1027) | if ($type == 'frontend') |
| [1028](#L1028) | $styles->enqueue('mappress-custom'); |
| [1029](#L1029) | else if ($type == 'backend' || $type == 'settings') |
| [1030](#L1030) | $styles->enqueue('mappress-admin'); |
| [1031](#L1031) | } |
| [1032](#L1032) |  |
| [1033](#L1033) | static function styles\_register($styles = null) { |
| [1034](#L1034) | $styles = ($styles) ? $styles : wp\_styles(); |
| [1035](#L1035) |  |
| [1036](#L1036) | $deps = array(); |
| [1037](#L1037) |  |
| [1038](#L1038) | // Leaflet CSS |
| [1039](#L1039) | if (self::$options->engine == 'leaflet') { |
| [1040](#L1040) | $styles->add('mappress-leaflet', self::$baseurl . '/lib/leaflet/leaflet.css', null, '1.7.1'); |
| [1041](#L1041) | $deps[] = 'mappress-leaflet'; |
| [1042](#L1042) | if (self::$options->clustering) { |
| [1043](#L1043) | $styles->add('mappress-leaflet-markercluster-default', self::$baseurl . "/lib/leaflet/MarkerCluster.Default.css", null, '1.4.1'); |
| [1044](#L1044) | $deps[] = 'mappress-leaflet-markercluster-default'; |
| [1045](#L1045) | $styles->add('mappress-leaflet-markercluster', self::$baseurl . "/lib/leaflet/MarkerCluster.css", null, '1.4.1'); |
| [1046](#L1046) | $deps[] = 'mappress-leaflet-markercluster'; |
| [1047](#L1047) | } |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | // Frontend |
| [1051](#L1051) | $styles->add('mappress', self::$baseurl . '/css/mappress.css', $deps, self::$version); |
| [1052](#L1052) |  |
| [1053](#L1053) | // Admin CSS |
| [1054](#L1054) | $styles->add('mappress-admin', self::$baseurl . '/css/mappress\_admin.css', array('mappress', 'wp-edit-blocks'), self::$version); |
| [1055](#L1055) |  |
| [1056](#L1056) | // Mappress CSS from theme directory |
| [1057](#L1057) | if ( @file\_exists( get\_stylesheet\_directory() . '/mappress.css' ) ) |
| [1058](#L1058) | $file = get\_stylesheet\_directory\_uri() . '/mappress.css'; |
| [1059](#L1059) | elseif ( @file\_exists( get\_template\_directory() . '/mappress.css' ) ) |
| [1060](#L1060) | $file = get\_template\_directory\_uri() . '/mappress.css'; |
| [1061](#L1061) | if (isset($file)) { |
| [1062](#L1062) | $styles->add('mappress-custom', $file, array('mappress'), self::$version); |
| [1063](#L1063) | } |
| [1064](#L1064) | } |
| [1065](#L1065) |  |
| [1066](#L1066) | static function template\_redirect() { |
| [1067](#L1067) | header("HTTP/1.1 200 OK"); |
| [1068](#L1068) |  |
| [1069](#L1069) | // Convert strings to booleans |
| [1070](#L1070) | $args = array\_map(function($arg) { if ($arg  == 'true') return true; if ($arg == 'false') return false; return $arg; }, $\_GET); |
| [1071](#L1071) |  |
| [1072](#L1072) | if (isset($args['mapid'])) { |
| [1073](#L1073) | $map = Mappress\_Map::get($args['mapid']); |
| [1074](#L1074) | if (!$map) |
| [1075](#L1075) | die("<html><body><!-- Bad mapid --></body></html>"); |
| [1076](#L1076) | } elseif (isset($args['transient'])) { |
| [1077](#L1077) | $mapdata = get\_transient($args['transient']); |
| [1078](#L1078) | if (!$mapdata) |
| [1079](#L1079) | die("<html><body><!-- Bad map transient --></body></html>"); |
| [1080](#L1080) | $map = new Mappress\_Map($mapdata); |
| [1081](#L1081) | } else { |
| [1082](#L1082) | $map = new Mappress\_Map(); |
| [1083](#L1083) | } |
| [1084](#L1084) |  |
| [1085](#L1085) | $map->update($args); |
| [1086](#L1086) | $map->layout = 'left'; |
| [1087](#L1087) |  |
| [1088](#L1088) | // Hydrate POIs for mashups |
| [1089](#L1089) | if ($map->query) { |
| [1090](#L1090) | $result = Mappress\_Query::query(array('query' => $map->query)); |
| [1091](#L1091) | $map->pois = $result->pois; |
| [1092](#L1092) | } |
| [1093](#L1093) |  |
| [1094](#L1094) | echo self::get\_iframe($map); |
| [1095](#L1095) | die(); |
| [1096](#L1096) | } |
| [1097](#L1097) |  |
| [1098](#L1098) | /\*\* |
| [1099](#L1099) | \* Automatic map display. |
| [1100](#L1100) | \* If set, the [mappress] shortcode will be prepended/appended to the post body, once for each map |
| [1101](#L1101) | \* The shortcode is used so it can be filtered - for example WordPress will remove it in excerpts by default. |
| [1102](#L1102) | \* |
| [1103](#L1103) | \* @param mixed $content |
| [1104](#L1104) | \*/ |
| [1105](#L1105) | static function the\_content($content="") { |
| [1106](#L1106) | global $post; |
| [1107](#L1107) | global $wp\_current\_filter; |
| [1108](#L1108) |  |
| [1109](#L1109) | $autodisplay = self::$options->autodisplay; |
| [1110](#L1110) |  |
| [1111](#L1111) | // No auto display |
| [1112](#L1112) | if (!$autodisplay || $autodisplay == 'none') |
| [1113](#L1113) | return $content; |
| [1114](#L1114) |  |
| [1115](#L1115) | // Check if in the loop, to prevent conflicts with JetPack - see http://wordpress.org/support/topic/easy-adsense-lite-and-jetpack |
| [1116](#L1116) | if (!in\_the\_loop()) |
| [1117](#L1117) | return $content; |
| [1118](#L1118) |  |
| [1119](#L1119) | // Don't add the shortcode for feeds or admin screens |
| [1120](#L1120) | if (is\_feed() || self::is\_admin()) |
| [1121](#L1121) | return $content; |
| [1122](#L1122) |  |
| [1123](#L1123) | // No shortcode if post is password protected |
| [1124](#L1124) | if (post\_password\_required()) |
| [1125](#L1125) | return $content; |
| [1126](#L1126) |  |
| [1127](#L1127) | // If this is an excerpt don't attempt to add the map to it |
| [1128](#L1128) | if (in\_array('get\_the\_excerpt', $wp\_current\_filter)) |
| [1129](#L1129) | return $content; |
| [1130](#L1130) |  |
| [1131](#L1131) | // Don't auto display if the post already contains a MapPress shortcode |
| [1132](#L1132) | if (stristr($content, '[mappress') !== false || stristr($content, '[mashup') !== false) |
| [1133](#L1133) | return $content; |
| [1134](#L1134) |  |
| [1135](#L1135) | // Don't auto display if the post already contains GT block |
| [1136](#L1136) | if (stristr($content, 'wp:mappress/map') !== false) |
| [1137](#L1137) | return $content; |
| [1138](#L1138) |  |
| [1139](#L1139) | // Get maps associated with post |
| [1140](#L1140) | $mapids = Mappress\_Map::get\_list('post', $post->ID, 'ids'); |
| [1141](#L1141) | if (empty($mapids)) |
| [1142](#L1142) | return $content; |
| [1143](#L1143) |  |
| [1144](#L1144) | // Add the shortcode once for each map |
| [1145](#L1145) | $shortcodes = ""; |
| [1146](#L1146) | foreach($mapids as $mapid) |
| [1147](#L1147) | $shortcodes .= '<p>[mappress mapid="' . $mapid . '"]</p>'; |
| [1148](#L1148) |  |
| [1149](#L1149) | if ($autodisplay == 'top') |
| [1150](#L1150) | return $shortcodes . $content; |
| [1151](#L1151) | else |
| [1152](#L1152) | return $content . $shortcodes; |
| [1153](#L1153) | } |
| [1154](#L1154) |  |
| [1155](#L1155) | static function to\_atts($vars) { |
| [1156](#L1156) | $vars = is\_object($vars) ? $vars : (object) $vars; |
| [1157](#L1157) | $results = array(); |
| [1158](#L1158) | foreach($vars as $name => $value) { |
| [1159](#L1159) | if ($value === null || $value === '') |
| [1160](#L1160) | continue; |
| [1161](#L1161) |  |
| [1162](#L1162) | $lcname = strtolower($name);        // Only lowercase is allowed |
| [1163](#L1163) |  |
| [1164](#L1164) | if (is\_object($value) || is\_array($value)) |
| [1165](#L1165) | $results[] = sprintf("%s='%s'", $lcname, json\_encode($value, JSON\_HEX\_APOS)); |
| [1166](#L1166) | else |
| [1167](#L1167) | $results[] = "$lcname='" . str\_replace('&quot;', '"', $value) . "'"; |
| [1168](#L1168) | } |
| [1169](#L1169) | return join(' ', $results); |
| [1170](#L1170) | } |
| [1171](#L1171) |  |
| [1172](#L1172) | static function unpkg($package, $filename) { |
| [1173](#L1173) | $urls = array( |
| [1174](#L1174) | 'markerclusterer' => 'https://unpkg.com/@googlemaps/markerclusterer@%s/dist', |
| [1175](#L1175) | ); |
| [1176](#L1176) | $versions = array( |
| [1177](#L1177) | 'markerclusterer' => '2.0.11', |
| [1178](#L1178) | ); |
| [1179](#L1179) |  |
| [1180](#L1180) | $url = $urls[$package]; |
| [1181](#L1181) | $version = $versions[$package]; |
| [1182](#L1182) | return apply\_filters('mappress\_unpkg', sprintf($url, $version) . "/$filename", $package, $filename); |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) | /\*\* |
| [1186](#L1186) | \* Scripts & styles for frontend |
| [1187](#L1187) | \* CSS is loaded from: child theme, theme, or plugin directory |
| [1188](#L1188) | \*/ |
| [1189](#L1189) | static function wp\_enqueue\_scripts() { |
| [1190](#L1190) | self::styles\_enqueue('frontend'); |
| [1191](#L1191) |  |
| [1192](#L1192) | // Load scripts in header if needed |
| [1193](#L1193) | if (!self::is\_footer()) |
| [1194](#L1194) | self::scripts\_enqueue(); |
| [1195](#L1195) | } |
| [1196](#L1196) |  |
| [1197](#L1197) | static function wp\_head() { |
| [1198](#L1198) | echo "\r\n<!-- MapPress Easy Google Maps " . \_\_('Version', 'mappress-google-maps-for-wordpress') . ':' . self::$version . " (https://www.mappresspro.com) -->\r\n"; |
| [1199](#L1199) | } |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | $mappress = new Mappress(); |
| [1203](#L1203) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/mappress-google-maps-for-wordpress/tags/2.88.5/mappress.php?rev=2965022&format=txt)
* [Original Format](/export/2965022/mappress-google-maps-for-wordpress/tags/2.88.5/mappress.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_2504cf1a_20250115_085453.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# MapPress Maps for WordPress <= 2.88.4 - Authenticated (Contributor+) Stored Cross-Site Scripting via Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   MapPress Maps for WordPress <= 2.88.4 - Authenticated (Contributor+) Stored Cross-Site Scripting via Shortcode

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2023-4840](https://www.cve.org/CVERecord?id=CVE-2023-4840) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | September 11, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The MapPress Maps for WordPress plugin for WordPress is vulnerable to Stored Cross-Site Scripting via 'mappress' shortcode in versions up to, and including, 2.88.4 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers with contributor-level and above permissions to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/mappress-google-maps-for-wordpress/tags/2.88.4/mappress_map.php#L381)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/mappress-google-maps-for-wordpress/tags/2.88.5/mappress.php?rev=2965022#L919)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmappress-google-maps-for-wordpress%2Fmappress-maps-for-wordpress-2884-authenticated-contributor-stored-cross-site-scripting-via-shortcode&t=MapPress%20Maps%20for%20WordPress%20%3C%3D%202.88.4%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmappress-google-maps-for-wordpress%2Fmappress-maps-for-wordpress-2884-authenticated-contributor-stored-cross-site-scripting-via-shortcode&text=MapPress%20Maps%20for%20WordPress%20%3C%3D%202.88.4%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmappress-google-maps-for-wordpress%2Fmappress-maps-for-wordpress-2884-authenticated-contributor-stored-cross-site-scripting-via-shortcode "LinkedIn")
Email

## Vulnerability Details for MapPress Maps for WordPress

#### [MapPress Maps for WordPress](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/mappress-google-maps-for-wordpress)

| Software Type | Plugin |
| --- | --- |
| Software Slug | mappress-google-maps-for-wordpress [(view on wordpress.org)](https://wordpress.org/plugins/mappress-google-maps-for-wordpress) |
| Patched? | Yes |
| Remediation | Update to version 2.88.5, or a newer patched version |
| Affected Version | * <= 2.88.4 |
| Patched Version | * 2.88.5 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_45a3239f_20250115_085438.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmappress-google-maps-for-wordpress%2Ftags%2F2.88.4%2Fmappress_map.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/mappress-google-maps-for-wordpress/tags/2.88.4/mappress_map.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/mappress-google-maps-for-wordpress/tags/2.88.4/mappress_map.php)

---

# [source:](/browser?order=name "Go to repository root") [mappress-google-maps-for-wordpress](/browser/mappress-google-maps-for-wordpress?order=name "View mappress-google-maps-for-wordpress")/[tags](/browser/mappress-google-maps-for-wordpress/tags?order=name "View tags")/[2.88.4](/browser/mappress-google-maps-for-wordpress/tags/2.88.4?order=name "View 2.88.4")/[mappress\_map.php](/browser/mappress-google-maps-for-wordpress/tags/2.88.4/mappress_map.php?order=name "View mappress_map.php")

View diff against:

View revision:

| [Last change](/changeset/2956467/mappress-google-maps-for-wordpress/tags/2.88.4/mappress_map.php "View differences") on this file was [2956467](/changeset/2956467/ "View changeset 2956467"), checked in by chrisvrichardson, [17 months ago](/timeline?from=2023-08-22T01%3A19%3A10Z&precision=second "See timeline at 08/22/2023 01:19:10 AM") |
| --- |
| 2.88.4 |
| **File size:** 17.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class Mappress\_Map extends Mappress\_Obj { |
| [3](#L3) | var $alignment, |
| [4](#L4) | $center, |
| [5](#L5) | $class, |
| [6](#L6) | $filter, |
| [7](#L7) | $geolocate, |
| [8](#L8) | $height, |
| [9](#L9) | $hideEmpty, |
| [10](#L10) | $initialOpenInfo, |
| [11](#L11) | $layers, |
| [12](#L12) | $layout, |
| [13](#L13) | $lines, |
| [14](#L14) | $linesOpts, |
| [15](#L15) | $mapid, |
| [16](#L16) | $mapOpts, |
| [17](#L17) | $mapTypeId, |
| [18](#L18) | $metaKey, |
| [19](#L19) | $name, |
| [20](#L20) | $oid, |
| [21](#L21) | $otitle, |
| [22](#L22) | $otype, |
| [23](#L23) | $poiList, |
| [24](#L24) | $query, |
| [25](#L25) | $search, |
| [26](#L26) | $status, |
| [27](#L27) | $style, |
| [28](#L28) | $title, |
| [29](#L29) | $width, |
| [30](#L30) | $zoom |
| [31](#L31) | ; |
| [32](#L32) |  |
| [33](#L33) | var $pois = array(); |
| [34](#L34) |  |
| [35](#L35) | function to\_html() { |
| [36](#L36) | // Exclude a few fields that don't need to be in the web component (pois are determined later) |
| [37](#L37) | $vars = array\_diff\_key(get\_object\_vars($this), array('otitle' => '', 'pois' => '', 'status' => '', 'title' => '')); |
| [38](#L38) |  |
| [39](#L39) | // Convert center from object to string for display in attributes |
| [40](#L40) | $vars['center'] = (isset($this->center) && is\_object($this->center)) ? $this->center->lat . ',' . $this->center->lng : ''; |
| [41](#L41) |  |
| [42](#L42) | // Force left layout |
| [43](#L43) | $vars['layout'] = 'left'; |
| [44](#L44) |  |
| [45](#L45) | $atts = Mappress::to\_atts($vars); |
| [46](#L46) | $pois = join('', array\_map(function($poi) { return $poi->to\_html(); }, $this->pois)); |
| [47](#L47) | return "\r\n<mappress-map {$atts}>\r\n$pois\r\n</mappress-map>\r\n"; |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | function to\_json() { |
| [51](#L51) | $json\_pois = array(); |
| [52](#L52) | foreach($this->pois as $poi) |
| [53](#L53) | $json\_pois[] = $poi->to\_json(); |
| [54](#L54) |  |
| [55](#L55) | return array( |
| [56](#L56) | 'mapid' => $this->mapid, |
| [57](#L57) | 'otype' => $this->otype, |
| [58](#L58) | 'oid' => $this->oid, |
| [59](#L59) | 'center' => $this->center, |
| [60](#L60) | 'filter' => $this->filter, |
| [61](#L61) | 'height' => $this->height, |
| [62](#L62) | 'mapTypeId' => $this->mapTypeId, |
| [63](#L63) | 'metaKey' => $this->metaKey, |
| [64](#L64) | 'pois' => $json\_pois, |
| [65](#L65) | 'search' => $this->search, |
| [66](#L66) | 'status' => $this->status, |
| [67](#L67) | 'title' => $this->title, |
| [68](#L68) | 'width' => $this->width, |
| [69](#L69) | 'zoom' => $this->zoom |
| [70](#L70) | ); |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | function \_\_construct($atts = null) { |
| [74](#L74) | $this->update($atts); |
| [75](#L75) |  |
| [76](#L76) | // Convert POIs from arrays to objects if needed |
| [77](#L77) | foreach((array)$this->pois as $index => $poi) { |
| [78](#L78) | if (!$poi instanceof Mappress\_Poi) |
| [79](#L79) | $this->pois[$index] = new Mappress\_Poi($poi); |
| [80](#L80) | } |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | static function register() { |
| [84](#L84) | global $wpdb; |
| [85](#L85) |  |
| [86](#L86) | add\_action('wp\_ajax\_mapp\_get\_post', array(\_\_CLASS\_\_, 'ajax\_get\_post')); |
| [87](#L87) | add\_action('wp\_ajax\_nopriv\_mapp\_get\_post', array(\_\_CLASS\_\_, 'ajax\_get\_post')); |
| [88](#L88) |  |
| [89](#L89) | add\_action('deleted\_post', array(\_\_CLASS\_\_, 'deleted\_post')); |
| [90](#L90) | add\_action('trashed\_post', array(\_\_CLASS\_\_, 'trashed\_post')); |
| [91](#L91) | add\_action('media\_buttons', array(\_\_CLASS\_\_, 'media\_buttons')); |
| [92](#L92) |  |
| [93](#L93) | add\_action('show\_user\_profile', array(\_\_CLASS\_\_, 'display\_user\_map')); |
| [94](#L94) | add\_action('edit\_user\_profile', array(\_\_CLASS\_\_, 'display\_user\_map')); |
| [95](#L95) | add\_action('deleted\_user', array(\_\_CLASS\_\_, 'deleted\_user')); |
| [96](#L96) | } |
| [97](#L97) |  |
| [98](#L98) | static function ajax\_get\_post() { |
| [99](#L99) | global $post; |
| [100](#L100) |  |
| [101](#L101) | check\_ajax\_referer('mappress', 'nonce'); |
| [102](#L102) | ob\_start(); |
| [103](#L103) | $oid = (isset($\_GET['oid'])) ? $\_GET['oid']  : null; |
| [104](#L104) | $post = get\_post( $oid ); |
| [105](#L105) |  |
| [106](#L106) | if (!$post) |
| [107](#L107) | die(sprintf(\_\_('Post not found', 'mappress-google-maps-for-wordpress'), $oid)); |
| [108](#L108) |  |
| [109](#L109) | setup\_postdata($post); |
| [110](#L110) | $html = Mappress\_Template::get\_template('mashup-modal'); |
| [111](#L111) | die($html); |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | /\*\* |
| [115](#L115) | \* Autoicons |
| [116](#L116) | \*/ |
| [117](#L117) | function autoicons() { |
| [118](#L118) | global $post; |
| [119](#L119) |  |
| [120](#L120) | // Posts only |
| [121](#L121) | if ($this->otype != 'post') |
| [122](#L122) | return; |
| [123](#L123) |  |
| [124](#L124) | // Only 1 rule allowed |
| [125](#L125) | $rule = (object) wp\_parse\_args(Mappress::$options->autoicons, array('key' => null, 'values' => array())); |
| [126](#L126) |  |
| [127](#L127) | foreach($rule->values as $value => $iconid) { |
| [128](#L128) | // Get all post IDs that match the current key & value |
| [129](#L129) | if ($rule->key == 'post\_type') { |
| [130](#L130) | $wpq = new WP\_Query(array('post\_type' => $value, 'fields' => 'ids', 'posts\_per\_page' => -1)); |
| [131](#L131) | $postids = $wpq->posts; |
| [132](#L132) | } else { |
| [133](#L133) | $term = get\_term\_by('slug', $value, $rule->key); |
| [134](#L134) | if (!is\_object($term)) |
| [135](#L135) | continue; |
| [136](#L136) |  |
| [137](#L137) | $objects = get\_objects\_in\_term($term->term\_id, $rule->key); |
| [138](#L138) | if (!is\_array($objects)) |
| [139](#L139) | continue; |
| [140](#L140) |  |
| [141](#L141) | $postids = array\_keys(array\_flip($objects)); |
| [142](#L142) | } |
| [143](#L143) |  |
| [144](#L144) | // Check each post ID to see if it's in the map's POIs, if so set iconid |
| [145](#L145) | $current\_post = ($post) ? $post->ID : null; |
| [146](#L146) | foreach($this->pois as &$poi) { |
| [147](#L147) | $postid = ($poi->oid) ? $poi->oid : $current\_post; |
| [148](#L148) | if (in\_array($postid, $postids)) |
| [149](#L149) | $poi->iconid = $iconid; |
| [150](#L150) | } |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | // Filter |
| [154](#L154) | foreach($this->pois as &$poi) |
| [155](#L155) | $poi->iconid = apply\_filters('mappress\_poi\_iconid', $poi->iconid, $poi); |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | /\*\* |
| [159](#L159) | \* Compare two POIs by title |
| [160](#L160) | \* HTML tags are stripped - until URL is separated from title this is the only way to |
| [161](#L161) | \* sort titles with HTML |
| [162](#L162) | \* |
| [163](#L163) | \* @param mixed $a |
| [164](#L164) | \* @param mixed $b |
| [165](#L165) | \* @return mixed |
| [166](#L166) | \*/ |
| [167](#L167) | static function compare\_title($a, $b) { |
| [168](#L168) | return strcasecmp(strip\_tags($a->title), strip\_tags($b->title)); |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Delete a map and all of its post assignments |
| [173](#L173) | \* |
| [174](#L174) | \* @param mixed $mapid |
| [175](#L175) | \*/ |
| [176](#L176) | static function delete($mapid) { |
| [177](#L177) | global $wpdb; |
| [178](#L178) | $maps\_table = $wpdb->prefix . 'mapp\_maps'; |
| [179](#L179) |  |
| [180](#L180) | $result = $wpdb->query($wpdb->prepare("DELETE FROM $maps\_table WHERE mapid = %d", $mapid)); |
| [181](#L181) | if ($result === false) |
| [182](#L182) | return false; |
| [183](#L183) |  |
| [184](#L184) | $wpdb->query("COMMIT"); |
| [185](#L185) | do\_action('mappress\_map\_delete', $mapid);       // Use for your own developments |
| [186](#L186) | return true; |
| [187](#L187) | } |
| [188](#L188) |  |
| [189](#L189) | /\*\* |
| [190](#L190) | \* When a post is deleted, trash attached maps |
| [191](#L191) | \*/ |
| [192](#L192) | static function deleted\_post($postid) { |
| [193](#L193) | $mapids = self::get\_list('post', $postid, 'ids'); |
| [194](#L194) | foreach($mapids as $mapid) |
| [195](#L195) | self::mutate($mapid, array('status' => 'trashed', 'oid' => 0)); |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) | /\*\* |
| [199](#L199) | \* When a user is deleted, delete attached maps |
| [200](#L200) | \*/ |
| [201](#L201) | static function deleted\_user($userid) { |
| [202](#L202) | $mapids = self::get\_list('user', $userid, 'ids'); |
| [203](#L203) | $result = true; |
| [204](#L204) | foreach($mapids as $mapid) |
| [205](#L205) | $result = $result && self::delete($mapid); |
| [206](#L206) | return $result; |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) | /\*\* |
| [210](#L210) | \* Display a map |
| [211](#L211) | \* |
| [212](#L212) | \* @param mixed $atts - override attributes.  Attributes applied from options -> map -> $atts |
| [213](#L213) | \*/ |
| [214](#L214) | function display($atts = null, $in\_iframe = false) { |
| [215](#L215) | static $div = 0; |
| [216](#L216) |  |
| [217](#L217) | $this->update($atts); |
| [218](#L218) |  |
| [219](#L219) | // Assign a map name, if none was provided.  Uniqid is used for for ajax to prevent repeating ids |
| [220](#L220) | if (empty($this->name)) { |
| [221](#L221) | $this->name = (defined('DOING\_AJAX') && DOING\_AJAX) ? "mapp" . uniqid() : "mapp$div"; |
| [222](#L222) | $div++; |
| [223](#L223) | } else { |
| [224](#L224) | // Sanitize name, could be provided by user in iframe URL |
| [225](#L225) | $this->name = sanitize\_text\_field($this->name); |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | if (Mappress::$options->webComponent) |
| [229](#L229) | return $this->display\_web\_component(null, $in\_iframe); |
| [230](#L230) |  |
| [231](#L231) | // iframe container |
| [232](#L232) | if (Mappress::$options->iframes && !$in\_iframe) { |
| [233](#L233) | // Convert booleans to strings |
| [234](#L234) | $args = array\_map(function($arg) { if (is\_bool($arg)) return ($arg) ? "true" : "false"; else return $arg; }, (array) $this); |
| [235](#L235) |  |
| [236](#L236) | // Query or mapid - no POIs in iframe URL |
| [237](#L237) | if ($this->query || $this->mapid) { |
| [238](#L238) | unset($args['pois']); |
| [239](#L239) | } else { |
| [240](#L240) | // Programmatic - URL contains only transient id |
| [241](#L241) | $transient = 'mapp-iframe-' . md5(json\_encode($this)); |
| [242](#L242) | set\_transient($transient, $this, 30); |
| [243](#L243) | $args = array('transient' => $transient); |
| [244](#L244) | } |
| [245](#L245) |  |
| [246](#L246) | $url = get\_home\_url() . '?mappress=embed&' . http\_build\_query($args); |
| [247](#L247) |  |
| [248](#L248) | // Width + height attributes are required for Google AMP |
| [249](#L249) | $iframe = "<iframe height='100%' width='100%' class='mapp-iframe' src='$url' scrolling='no' loading='lazy'></iframe>"; |
| [250](#L250) | return $this->get\_layout($iframe); |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | // Prepare POIs |
| [254](#L254) | $this->prepare(); |
| [255](#L255) |  |
| [256](#L256) | // Last chance to alter map before display |
| [257](#L257) | do\_action('mappress\_map\_display', $this); |
| [258](#L258) |  |
| [259](#L259) | // Map data |
| [260](#L260) | $script = Mappress::script( |
| [261](#L261) | "window.mapp = window.mapp || {}; mapp.data = mapp.data || [];\r\n" |
| [262](#L262) | . "mapp.data.push( " . json\_encode($this) . " ); \r\nif (typeof mapp.load != 'undefined') { mapp.load(); };" |
| [263](#L263) | ); |
| [264](#L264) |  |
| [265](#L265) | if ($in\_iframe) { |
| [266](#L266) | return "<div id='{$this->name}' class='mapp-content'></div>". $script; |
| [267](#L267) | } else { |
| [268](#L268) | Mappress::scripts\_enqueue(); |
| [269](#L269) | return $this->get\_layout() . $script; |
| [270](#L270) | } |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | /\*\* |
| [274](#L274) | \* Display a map web component |
| [275](#L275) | \* |
| [276](#L276) | \* @param mixed $atts - override attributes.  Attributes applied from options -> map -> $atts |
| [277](#L277) | \*/ |
| [278](#L278) | function display\_web\_component($atts = null, $in\_iframe = false) { |
| [279](#L279) | $alignment = ($this->alignment) ? $this->alignment : Mappress::$options->alignment; |
| [280](#L280) | $alignment\_class = ($alignment) ? ' align' . $alignment. ' mapp-align-' . $alignment : ''; |
| [281](#L281) |  |
| [282](#L282) | $dims = $this->get\_dims(); |
| [283](#L283) | $style = sprintf("width: %s;", ($this->alignment == 'full') ? "auto" : $dims->width); |
| [284](#L284) | $style .= (stristr($dims->height, '%')) ? sprintf("height: auto; aspect-ratio: 100/%d;", (int) $dims->height)  : "height: {$dims->height};"; |
| [285](#L285) |  |
| [286](#L286) | // iframe container |
| [287](#L287) | if (Mappress::$options->iframes && !$in\_iframe) { |
| [288](#L288) | // Convert booleans to strings for iframe atts |
| [289](#L289) | $args = array\_map(function($arg) { if (is\_bool($arg)) return ($arg) ? "true" : "false"; else return $arg; }, (array) $this); |
| [290](#L290) |  |
| [291](#L291) | // Query or mapid - no POIs in iframe URL |
| [292](#L292) | if ($this->query || $this->mapid) { |
| [293](#L293) | unset($args['pois']); |
| [294](#L294) | } else { |
| [295](#L295) | // Programmatic - URL contains only transient id |
| [296](#L296) | $transient = 'mapp-iframe-' . md5(json\_encode($this)); |
| [297](#L297) | set\_transient($transient, $this, 30); |
| [298](#L298) | $args = array('transient' => $transient); |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | $url = get\_home\_url() . '?mappress=embed&' . http\_build\_query($args); |
| [302](#L302) |  |
| [303](#L303) | // Note that width + height attributes are required for Google AMP |
| [304](#L304) | $layout\_atts = Mappress::to\_atts($atts); |
| [305](#L305) |  |
| [306](#L306) | // Iframes don't size like divs, so require a wrapper div |
| [307](#L307) | $wrapper\_class = 'mapp-layout mapp-has-iframe' . $alignment\_class; |
| [308](#L308) | return "<div id='{$this->name}' class='$wrapper\_class' style='$style'>" |
| [309](#L309) | . "<iframe class='mapp-iframe ' src='$url' scrolling='no' loading='lazy'></iframe>" |
| [310](#L310) | . "</div>"; |
| [311](#L311) | } else { |
| [312](#L312) | // Prepare POIs |
| [313](#L313) | $this->prepare(); |
| [314](#L314) |  |
| [315](#L315) | if ($in\_iframe) { |
| [316](#L316) | // For Component inside iframe, alignment class and style (height/width) are applied to wrapper, not component |
| [317](#L317) | $this->class = 'mapp-layout'; |
| [318](#L318) | $this->style = 'height: 100%'; |
| [319](#L319) | } else { |
| [320](#L320) | $this->class = 'mapp-layout ' . $alignment\_class; |
| [321](#L321) | $this->style = $style; |
| [322](#L322) | } |
| [323](#L323) |  |
| [324](#L324) | // Last chance to alter map before display |
| [325](#L325) | do\_action('mappress\_map\_display', $this); |
| [326](#L326) |  |
| [327](#L327) | Mappress::scripts\_enqueue(); |
| [328](#L328) | return $this->to\_html(); |
| [329](#L329) | } |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | static function display\_user\_map($user) { |
| [333](#L333) | $error = get\_user\_meta($user->ID, 'mappress\_error', true); |
| [334](#L334) | if ($error) |
| [335](#L335) | echo "<div class='mapp-help-error'>" . sprintf(\_\_('Geocoding error: %s', 'mappress-google-maps-for-wordpress'), $error) . "</div>"; |
| [336](#L336) |  |
| [337](#L337) | $maps = Mappress\_Map::get\_list('user', $user->ID); |
| [338](#L338) | if (empty($maps)) |
| [339](#L339) | return; |
| [340](#L340) |  |
| [341](#L341) | echo "<h2>" . \_\_('Location', 'mappress-google-maps-for-wordpress') . "</h2><table class='form-table'><tbody>"; |
| [342](#L342) |  |
| [343](#L343) | foreach($maps as $map) { |
| [344](#L344) | if ($map->status == 'trashed') |
| [345](#L345) | continue; |
| [346](#L346) | $map->poiList = false; |
| [347](#L347) | $map->width = '80%'; |
| [348](#L348) | $map->height = '350px'; |
| [349](#L349) | echo "<tr><th></th><td>" . $map->display() . "</td></tr>"; |
| [350](#L350) | } |
| [351](#L351) | echo "</tbody></table>"; |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | function get\_dims() { |
| [355](#L355) | $suffix = function($dim) { |
| [356](#L356) | return (is\_string($dim) && (stristr($dim, 'px') || stristr($dim, '%') || stristr($dim, 'vh') || stristr($dim, 'vw'))) ? $dim : ($dim . 'px'); |
| [357](#L357) | }; |
| [358](#L358) | $defaultSize = (isset(Mappress::$options->sizes[Mappress::$options->size])) ? (object) Mappress::$options->sizes[Mappress::$options->size] : (object) Mappress::$options->sizes[0]; |
| [359](#L359) | return (object) array( |
| [360](#L360) | 'width' => ($this->width) ? $suffix($this->width) : $suffix($defaultSize->width), |
| [361](#L361) | 'height' => ($this->height) ? $suffix($this->height) : $suffix($defaultSize->height) |
| [362](#L362) | ); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | function get\_layout($content = '') { |
| [366](#L366) | $layoutClass = 'mapp-layout'; |
| [367](#L367) | $layoutClass .= (Mappress::$options->iframes) ? ' mapp-has-iframe' : ''; |
| [368](#L368) |  |
| [369](#L369) | $alignment = ($this->alignment) ? $this->alignment : Mappress::$options->alignment; |
| [370](#L370) | if ($alignment) { |
| [371](#L371) | $layoutClass .= ' align' . $alignment; |
| [372](#L372) | $layoutClass .= ' mapp-align-' . $alignment; |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | $dims = $this->get\_dims(); |
| [376](#L376) | $layoutStyle = ($this->alignment == 'full') ? "width: auto" : "width: {$dims->width}"; |
| [377](#L377) |  |
| [378](#L378) | $wrapperClass = 'mapp-wrapper'; |
| [379](#L379) | $wrapperStyle = "padding-bottom: {$dims->height}"; |
| [380](#L380) |  |
| [381](#L381) | return "<div id='{$this->name}' class='$layoutClass' style='$layoutStyle'><div class='$wrapperClass' style='$wrapperStyle'>$content</div></div>"; |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | /\*\* |
| [385](#L385) | \* Get a map.  Output is 'raw' or 'object' |
| [386](#L386) | \*/ |
| [387](#L387) | static function get($mapid) { |
| [388](#L388) | global $wpdb; |
| [389](#L389) | $maps\_table = $wpdb->prefix . 'mapp\_maps'; |
| [390](#L390) |  |
| [391](#L391) | $sql = $wpdb->prepare("SELECT \* FROM $maps\_table WHERE mapid=%d", $mapid); |
| [392](#L392) | $result = $wpdb->get\_row($sql); |
| [393](#L393) |  |
| [394](#L394) | if (!$result) |
| [395](#L395) | return false; |
| [396](#L396) |  |
| [397](#L397) | $mapdata = json\_decode($result->obj); |
| [398](#L398) | if (!$mapdata) |
| [399](#L399) | return false; |
| [400](#L400) |  |
| [401](#L401) | $mapdata->mapid = $result->mapid; |
| [402](#L402) | $mapdata->otype = $result->otype; |
| [403](#L403) | $mapdata->oid = $result->oid; |
| [404](#L404) | $mapdata->status = $result->status; |
| [405](#L405) | $mapdata->title = $result->title; |
| [406](#L406) |  |
| [407](#L407) | // Object title is needed for editor |
| [408](#L408) | if ($mapdata->oid) { |
| [409](#L409) | $obj = ($mapdata->otype == 'user') ? wp\_get\_current\_user($mapdata->oid) : get\_post($mapdata->oid); |
| [410](#L410) | if ($obj) |
| [411](#L411) | $mapdata->otitle = ($mapdata->otype == 'user') ? $obj->user\_nicename : $obj->post\_title; |
| [412](#L412) | } |
| [413](#L413) |  |
| [414](#L414) | $map = new Mappress\_Map($mapdata); |
| [415](#L415) | return $map; |
| [416](#L416) | } |
| [417](#L417) |  |
| [418](#L418) | /\*\* |
| [419](#L419) | \* Get list of mapids for a post or all maps |
| [420](#L420) | \* |
| [421](#L421) | \* @return array of mapids | empty array |
| [422](#L422) | \* |
| [423](#L423) | \*/ |
| [424](#L424) | static function get\_list($otype, $oid = null, $output = 'objects') { |
| [425](#L425) | global $wpdb; |
| [426](#L426) | $maps\_table = $wpdb->prefix . 'mapp\_maps'; |
| [427](#L427) |  |
| [428](#L428) | $otype = ($otype) ? $otype : 'post'; |
| [429](#L429) | $where = $wpdb->prepare("WHERE otype=%s", $otype); |
| [430](#L430) | if ($oid) |
| [431](#L431) | $where .= $wpdb->prepare(" AND oid=%d", $oid); |
| [432](#L432) |  |
| [433](#L433) | $mapids = $wpdb->get\_col("SELECT mapid FROM $maps\_table $where"); |
| [434](#L434) | if (!$mapids) |
| [435](#L435) | return array(); |
| [436](#L436) |  |
| [437](#L437) | if ($output == 'ids') { |
| [438](#L438) | return $mapids; |
| [439](#L439) | } else { |
| [440](#L440) | $maps = array(); |
| [441](#L441) | foreach($mapids as $mapid) { |
| [442](#L442) | $map = Mappress\_Map::get($mapid); |
| [443](#L443) | if ($map) |
| [444](#L444) | $maps[] = $map; |
| [445](#L445) | } |
| [446](#L446) | return $maps; |
| [447](#L447) | } |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | static function media\_buttons($editor\_id) { |
| [451](#L451) | $button = sprintf("<button type='button' class='button wp-media-buttons-icon mapp-classic-button'><span class='dashicons dashicons-location'></span>%s</button>", \_\_('MapPress', 'mappress-google-maps-for-wordpress')); |
| [452](#L452) | echo "<div class='mapp-classic'>$button</div>"; |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | static function mutate($mapid, $mapdata) { |
| [456](#L456) | if (!$mapid || !$mapdata) |
| [457](#L457) | return false; |
| [458](#L458) |  |
| [459](#L459) | $map = self::get($mapid); |
| [460](#L460) | if (!$map) |
| [461](#L461) | return false; |
| [462](#L462) |  |
| [463](#L463) | $map->update($mapdata); |
| [464](#L464) | $result = $map->save(); |
| [465](#L465) | return ($result) ? true : false; |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | /\*\* |
| [469](#L469) | \* Prepare map for output |
| [470](#L470) | \* |
| [471](#L471) | \*/ |
| [472](#L472) | function prepare() { |
| [473](#L473) | global $post, $wp\_embed; |
| [474](#L474) |  |
| [475](#L475) | // Parse custom tokens from templates |
| [476](#L476) | $custom\_tokens = Mappress\_Template::get\_custom\_tokens($this->otype); |
| [477](#L477) |  |
| [478](#L478) | foreach($this->pois as $poi) { |
| [479](#L479) |  |
| [480](#L480) | // Add props |
| [481](#L481) | $oid = ($poi->oid) ? $poi->oid : $this->oid; |
| [482](#L482) | $poi->props = Mappress\_Template::get\_poi\_props($poi, $this->otype, $oid, $custom\_tokens); |
| [483](#L483) |  |
| [484](#L484) | // Populate user fields |
| [485](#L485) | if ($this->otype == 'user') { |
| [486](#L486) | $user = get\_userdata($oid); |
| [487](#L487) | $poi->email = $user->data->user\_email; |
| [488](#L488) | $poi->name = $user->data->display\_name; |
| [489](#L489) | $poi->images = array( (object) array('id' => $user->ID, 'type' => 'avatar')); |
| [490](#L490) | $poi->url = get\_author\_posts\_url($user->ID); |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) | // Process oembeds and embed shortcodes ([embed], etc) |
| [494](#L494) | if ($poi->body) { |
| [495](#L495) | $poi->body = do\_shortcode($poi->body); |
| [496](#L496) | $poi->body = $wp\_embed->autoembed($poi->body); |
| [497](#L497) | $poi->body = $wp\_embed->run\_shortcode($poi->body); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | // Update image URLs |
| [501](#L501) | $poi->update\_images(); |
| [502](#L502) | } |
| [503](#L503) |  |
| [504](#L504) | // Autoicons & sort |
| [505](#L505) | if ($this->otype == 'post') |
| [506](#L506) | $this->autoicons(); |
| [507](#L507) |  |
| [508](#L508) | if (!Mappress::$options->sort && !isset($this->query['orderby'])) |
| [509](#L509) | do\_action('mappress\_sort\_pois', $this); |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | function save() { |
| [513](#L513) | global $wpdb; |
| [514](#L514) | $maps\_table = $wpdb->prefix . 'mapp\_maps'; |
| [515](#L515) |  |
| [516](#L516) | // Apply wpautop to POI bodies |
| [517](#L517) | foreach($this->pois as &$poi) |
| [518](#L518) | $poi->body = wpautop($poi->body); |
| [519](#L519) |  |
| [520](#L520) | // Filter out poi field data that is no longer present in settings |
| [521](#L521) | foreach($this->pois as &$poi) { |
| [522](#L522) | if (Mappress::$options->poiFields) { |
| [523](#L523) | $keys = array\_map(function($entry) { return $entry['key']; }, Mappress::$options->poiFields); |
| [524](#L524) | $data = (array) $poi->data; |
| [525](#L525) | $poi->data = (object) array\_intersect\_key($data, array\_combine($keys, $keys)); |
| [526](#L526) | } else { |
| [527](#L527) | $poi->data = null; |
| [528](#L528) | } |
| [529](#L529) | } |
| [530](#L530) |  |
| [531](#L531) | $obj = json\_encode($this->to\_json()); |
| [532](#L532) |  |
| [533](#L533) | // Insert if no ID, else update |
| [534](#L534) | if (!$this->mapid) { |
| [535](#L535) | $sql = "INSERT INTO $maps\_table (otype, oid, status, title, obj) VALUES(%s, %d, %s, %s, %s)"; |
| [536](#L536) | $result = $wpdb->query($wpdb->prepare($sql, $this->otype, $this->oid, $this->status, $this->title, $obj)); |
| [537](#L537) | $this->mapid = $wpdb->get\_var("SELECT LAST\_INSERT\_ID()"); |
| [538](#L538) | } else { |
| [539](#L539) | $sql = "INSERT INTO $maps\_table (mapid, otype, oid, status, title, obj) VALUES(%d, %s, %d, %s, %s, %s) " |
| [540](#L540) | . " ON DUPLICATE KEY UPDATE mapid=%d, otype=%s, oid=%d, status=%s, title=%s, obj=%s "; |
| [541](#L541) | $result = $wpdb->query($wpdb->prepare($sql, $this->mapid, $this->otype, $this->oid, $this->status, $this->title, $obj, |
| [542](#L542) | $this->mapid, $this->otype, $this->oid, $this->status, $this->title, $obj)); |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | if ($result === false || !$this->mapid) |
| [546](#L546) | return false; |
| [547](#L547) |  |
| [548](#L548) | $wpdb->query("COMMIT"); |
| [549](#L549) | do\_action('mappress\_map\_save', $this);  // Use for your own developments |
| [550](#L550) | return true; |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | /\*\* |
| [554](#L554) | \* When a post is trashed, trash attached maps |
| [555](#L555) | \*/ |
| [556](#L556) | static function trashed\_post($postid) { |
| [557](#L557) | $mapids = self::get\_list('post', $postid, 'ids'); |
| [558](#L558) | foreach($mapids as $mapid) |
| [559](#L559) | self::mutate($mapid, array('status' => 'trashed')); |
| [560](#L560) | } |
| [561](#L561) | } |
| [562](#L562) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/mappress-google-maps-for-wordpress/tags/2.88.4/mappress_map.php?format=txt)
* [Original Format](/export/3222693/mappress-google-maps-for-wordpress/tags/2.88.4/mappress_map.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


