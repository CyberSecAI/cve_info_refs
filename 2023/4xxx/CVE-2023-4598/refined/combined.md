=== Content from plugins.trac.wordpress.org_d34f5c11_20250114_192558.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2959452%2540wp-slimstat%26old%3D2959452%2540wp-slimstat)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2958208/wp-slimstat "Changeset 2958208 for wp-slimstat")
* [Next Change](/changeset/2959722/wp-slimstat "Changeset 2959722 for wp-slimstat") →

---

# Changeset [2959452](/changeset/2959452 "Show full changeset") for [wp-slimstat](/browser/wp-slimstat?rev=2959452 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/28/2023 03:11:31 PM
([17 months](/timeline?from=2023-08-28T15%3A11%3A31Z&precision=second "See timeline at 08/28/2023 03:11:31 PM") ago)

Author:
mostafa.s1990
Message:

Update to version 5.0.10 from GitHub

Location:
[wp-slimstat](/browser/wp-slimstat?rev=2959452)
Files:

8 edited
1 copied

* [tags/5.0.10](/browser/wp-slimstat/tags/5.0.10?rev=2959452 "Show entry in browser")
  (copied)
  *(copied from [wp-slimstat/trunk](/browser/wp-slimstat/trunk?rev=2958208 "Show original file (revision 2959451)"))*
* [tags/5.0.10/admin/view/right-now.php](/browser/wp-slimstat/tags/5.0.10/admin/view/right-now.php?rev=2959452 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [tags/5.0.10/admin/view/wp-slimstat-db.php](/browser/wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php?rev=2959452 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [tags/5.0.10/readme.txt](/browser/wp-slimstat/tags/5.0.10/readme.txt?rev=2959452 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [tags/5.0.10/wp-slimstat.php](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452 "Show entry in browser")
  (modified)
  ([5 diffs](#file4 "Show differences"))
* [trunk/admin/view/right-now.php](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2959452 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [trunk/admin/view/wp-slimstat-db.php](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2959452 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [trunk/readme.txt](/browser/wp-slimstat/trunk/readme.txt?rev=2959452 "Show entry in browser")
  (modified)
  ([2 diffs](#file7 "Show differences"))
* [trunk/wp-slimstat.php](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452 "Show entry in browser")
  (modified)
  ([5 diffs](#file8 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-slimstat/tags/5.0.10/admin/view/right-now.php](/changeset/2959452/wp-slimstat/tags/5.0.10/admin/view/right-now.php "Show the changeset 2959452 restricted to wp-slimstat/tags/5.0.10/admin/view/right-now.php")

  | [r2939166](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2939166#L34 "Show revision 2939166 of this file in browser") | [r2959452](/browser/wp-slimstat/tags/5.0.10/admin/view/right-now.php?rev=2959452#L34 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 | } |
  | 35 | 35 |  |
  | 36 |  | $results = array\_slice( |
  |  | 36 | $results = array\_slice( |
  | 37 | 37 | $all\_results, |
  | 38 | 38 | wp\_slimstat\_db::$filters\_normalized['misc']['start\_from'], |
  | […](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2939166#L82) | […](/browser/wp-slimstat/tags/5.0.10/admin/view/right-now.php?rev=2959452#L82) |  |
  | 82 | 82 | // Print visit header? |
  | 83 | 83 | if ($i == 0 || $results[$i - 1]['visit\_id'] != $results[$i]['visit\_id'] || $results[$i - 1]['ip'] != $results[$i]['ip'] || $results[$i - 1]['browser'] != $results[$i]['browser'] || $results[$i - 1]['platform'] != $results[$i]['platform'] || $results[$i - 1]['username'] != $results[$i]['username']) { |
  |  | 84 |  |
  |  | 85 | // Skip error responses |
  |  | 86 | if (empty($results[$i]['referer'])) { |
  |  | 87 | continue; |
  |  | 88 | } |
  | 84 | 89 |  |
  | 85 | 90 | // Color-coded headers |
* ## [wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php](/changeset/2959452/wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php "Show the changeset 2959452 restricted to wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php")

  | [r2945907](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2945907#L820 "Show revision 2945907 of this file in browser") | [r2959452](/browser/wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php?rev=2959452#L820 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 820 | 820 | ORDER BY counthits DESC |
  | 821 | 821 | LIMIT 0, %d", self::$filters\_normalized['misc']['limit\_results']); |
  | 822 |  | return self::get\_results($sql, $\_args['group\_by'],$\_args['group\_by'] . ' ASC'); |
  |  | 822 | return self::get\_results($sql, $\_args['group\_by'], $\_args['group\_by'] . ' ASC'); |
  | 823 | 823 | } |
  | 824 | 824 |  |
* ## [wp-slimstat/tags/5.0.10/readme.txt](/changeset/2959452/wp-slimstat/tags/5.0.10/readme.txt "Show the changeset 2959452 restricted to wp-slimstat/tags/5.0.10/readme.txt")

  | [r2958208](/browser/wp-slimstat/trunk/readme.txt?rev=2958208#L6 "Show revision 2958208 of this file in browser") | [r2959452](/browser/wp-slimstat/tags/5.0.10/readme.txt?rev=2959452#L6 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Requires PHP: 7.4+ |
  | 7 | 7 | Tested up to: 6.3 |
  | 8 |  | Stable tag: 5.0.~~9~~ |
  |  | 8 | Stable tag: 5.0.10 |
  | 9 | 9 |  |
  | 10 | 10 | == Description == |
  | […](/browser/wp-slimstat/trunk/readme.txt?rev=2958208#L49) | […](/browser/wp-slimstat/tags/5.0.10/readme.txt?rev=2959452#L49) |  |
  | 49 | 49 |  |
  | 50 | 50 | == Changelog == |
  |  | 51 | = 5.0.10 = |
  |  | 52 | \* [Fix] Skip Error Responses: Handling Empty Referer in Results Array |
  |  | 53 | \* [Fix] Escape shortcode attributes |
  |  | 54 | \* [Fix] Skip to accept the invalid argus in shortcode |
  |  | 55 | \* [Fix] Minor improvements & Hardened plugin security |
  |  | 56 |  |
  | 51 | 57 | = 5.0.9 = |
  | 52 | 58 | \* [Fix] Hardened plugin security and sanitization of GeoIP argument |
* ## [wp-slimstat/tags/5.0.10/wp-slimstat.php](/changeset/2959452/wp-slimstat/tags/5.0.10/wp-slimstat.php "Show the changeset 2959452 restricted to wp-slimstat/tags/5.0.10/wp-slimstat.php")

  | [r2958208](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L4 "Show revision 2958208 of this file in browser") | [r2959452](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L4 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://wp-slimstat.com/ |
  | 5 | 5 | Description: The leading web analytics plugin for WordPress |
  | 6 |  | Version: 5.0.~~9~~ |
  |  | 6 | Version: 5.0.10 |
  | 7 | 7 | Author: Jason Crouse, VeronaLabs |
  | 8 | 8 | Text Domain: wp-slimstat |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L18) | […](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L18) |  |
  | 18 | 18 | class wp\_slimstat |
  | 19 | 19 | { |
  | 20 |  | public static $version = '5.0.~~9~~'; |
  |  | 20 | public static $version = '5.0.10'; |
  | 21 | 21 | public static $settings = array(); |
  | 22 | 22 |  |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L747) | […](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L747) |  |
  | 747 | 747 | } |
  | 748 | 748 |  |
  |  | 749 | // Validation the parameter w |
  |  | 750 | if (in\_array($w, array('count', 'display\_name', 'hostname', 'post\_link', 'post\_link\_no\_qs', 'dt', 'username', 'post\_link')) == false) { |
  |  | 751 | return '<!-- Slimstat Shortcode Error: invalid parameter for w -->'; |
  |  | 752 | } |
  |  | 753 |  |
  | 749 | 754 | // Include the Reports Library, but don't initialize the database, since we will do that separately later |
  | 750 | 755 | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/view/wp-slimstat-reports.php'); |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L797) | […](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L802) |  |
  | 797 | 802 | } |
  | 798 | 803 |  |
  |  | 804 | $w = esc\_html($w); |
  | 799 | 805 | $w = self::string\_to\_array($w); |
  | 800 | 806 |  |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L882) | […](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L888) |  |
  | 882 | 888 |  |
  | 883 | 889 | default: |
  | 884 |  | $output[$result\_idx][$a\_column] .= ~~$a\_result[$a\_column]~~; |
  |  | 890 | $output[$result\_idx][$a\_column] .= isset($a\_result[$a\_column]) ? $a\_result[$a\_column] : ''; |
  | 885 | 891 | break; |
  | 886 | 892 | } |
* ## [wp-slimstat/trunk/admin/view/right-now.php](/changeset/2959452/wp-slimstat/trunk/admin/view/right-now.php "Show the changeset 2959452 restricted to wp-slimstat/trunk/admin/view/right-now.php")

  | [r2939166](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2939166#L34 "Show revision 2939166 of this file in browser") | [r2959452](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2959452#L34 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 | } |
  | 35 | 35 |  |
  | 36 |  | $results = array\_slice( |
  |  | 36 | $results = array\_slice( |
  | 37 | 37 | $all\_results, |
  | 38 | 38 | wp\_slimstat\_db::$filters\_normalized['misc']['start\_from'], |
  | […](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2939166#L82) | […](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2959452#L82) |  |
  | 82 | 82 | // Print visit header? |
  | 83 | 83 | if ($i == 0 || $results[$i - 1]['visit\_id'] != $results[$i]['visit\_id'] || $results[$i - 1]['ip'] != $results[$i]['ip'] || $results[$i - 1]['browser'] != $results[$i]['browser'] || $results[$i - 1]['platform'] != $results[$i]['platform'] || $results[$i - 1]['username'] != $results[$i]['username']) { |
  |  | 84 |  |
  |  | 85 | // Skip error responses |
  |  | 86 | if (empty($results[$i]['referer'])) { |
  |  | 87 | continue; |
  |  | 88 | } |
  | 84 | 89 |  |
  | 85 | 90 | // Color-coded headers |
* ## [wp-slimstat/trunk/admin/view/wp-slimstat-db.php](/changeset/2959452/wp-slimstat/trunk/admin/view/wp-slimstat-db.php "Show the changeset 2959452 restricted to wp-slimstat/trunk/admin/view/wp-slimstat-db.php")

  | [r2945907](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2945907#L820 "Show revision 2945907 of this file in browser") | [r2959452](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2959452#L820 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 820 | 820 | ORDER BY counthits DESC |
  | 821 | 821 | LIMIT 0, %d", self::$filters\_normalized['misc']['limit\_results']); |
  | 822 |  | return self::get\_results($sql, $\_args['group\_by'],$\_args['group\_by'] . ' ASC'); |
  |  | 822 | return self::get\_results($sql, $\_args['group\_by'], $\_args['group\_by'] . ' ASC'); |
  | 823 | 823 | } |
  | 824 | 824 |  |
* ## [wp-slimstat/trunk/readme.txt](/changeset/2959452/wp-slimstat/trunk/readme.txt "Show the changeset 2959452 restricted to wp-slimstat/trunk/readme.txt")

  | [r2958208](/browser/wp-slimstat/trunk/readme.txt?rev=2958208#L6 "Show revision 2958208 of this file in browser") | [r2959452](/browser/wp-slimstat/trunk/readme.txt?rev=2959452#L6 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Requires PHP: 7.4+ |
  | 7 | 7 | Tested up to: 6.3 |
  | 8 |  | Stable tag: 5.0.~~9~~ |
  |  | 8 | Stable tag: 5.0.10 |
  | 9 | 9 |  |
  | 10 | 10 | == Description == |
  | […](/browser/wp-slimstat/trunk/readme.txt?rev=2958208#L49) | […](/browser/wp-slimstat/trunk/readme.txt?rev=2959452#L49) |  |
  | 49 | 49 |  |
  | 50 | 50 | == Changelog == |
  |  | 51 | = 5.0.10 = |
  |  | 52 | \* [Fix] Skip Error Responses: Handling Empty Referer in Results Array |
  |  | 53 | \* [Fix] Escape shortcode attributes |
  |  | 54 | \* [Fix] Skip to accept the invalid argus in shortcode |
  |  | 55 | \* [Fix] Minor improvements & Hardened plugin security |
  |  | 56 |  |
  | 51 | 57 | = 5.0.9 = |
  | 52 | 58 | \* [Fix] Hardened plugin security and sanitization of GeoIP argument |
* ## [wp-slimstat/trunk/wp-slimstat.php](/changeset/2959452/wp-slimstat/trunk/wp-slimstat.php "Show the changeset 2959452 restricted to wp-slimstat/trunk/wp-slimstat.php")

  | [r2958208](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L4 "Show revision 2958208 of this file in browser") | [r2959452](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L4 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://wp-slimstat.com/ |
  | 5 | 5 | Description: The leading web analytics plugin for WordPress |
  | 6 |  | Version: 5.0.~~9~~ |
  |  | 6 | Version: 5.0.10 |
  | 7 | 7 | Author: Jason Crouse, VeronaLabs |
  | 8 | 8 | Text Domain: wp-slimstat |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L18) | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L18) |  |
  | 18 | 18 | class wp\_slimstat |
  | 19 | 19 | { |
  | 20 |  | public static $version = '5.0.~~9~~'; |
  |  | 20 | public static $version = '5.0.10'; |
  | 21 | 21 | public static $settings = array(); |
  | 22 | 22 |  |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L747) | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L747) |  |
  | 747 | 747 | } |
  | 748 | 748 |  |
  |  | 749 | // Validation the parameter w |
  |  | 750 | if (in\_array($w, array('count', 'display\_name', 'hostname', 'post\_link', 'post\_link\_no\_qs', 'dt', 'username', 'post\_link')) == false) { |
  |  | 751 | return '<!-- Slimstat Shortcode Error: invalid parameter for w -->'; |
  |  | 752 | } |
  |  | 753 |  |
  | 749 | 754 | // Include the Reports Library, but don't initialize the database, since we will do that separately later |
  | 750 | 755 | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/view/wp-slimstat-reports.php'); |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L797) | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L802) |  |
  | 797 | 802 | } |
  | 798 | 803 |  |
  |  | 804 | $w = esc\_html($w); |
  | 799 | 805 | $w = self::string\_to\_array($w); |
  | 800 | 806 |  |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L882) | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L888) |  |
  | 882 | 888 |  |
  | 883 | 889 | default: |
  | 884 |  | $output[$result\_idx][$a\_column] .= ~~$a\_result[$a\_column]~~; |
  |  | 890 | $output[$result\_idx][$a\_column] .= isset($a\_result[$a\_column]) ? $a\_result[$a\_column] : ''; |
  | 885 | 891 | break; |
  | 886 | 892 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2959452)
* [Zip Archive](?format=zip&new=2959452)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_9d8fc435_20250114_192559.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Slimstat Analytics <= 5.0.9 - Authenticated (Contributor+) Blind SQL Injection via Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Slimstat Analytics <= 5.0.9 - Authenticated (Contributor+) Blind SQL Injection via Shortcode

8.8

**Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-4598](https://www.cve.org/CVERecord?id=CVE-2023-4598) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | September 11, 2023 |
| Last Updated | January 22, 2024 |
| Researchers | [Chloe Chamberland - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/chloe-chamberland)  [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Slimstat Analytics plugin for WordPress is vulnerable to SQL Injection via the plugin's shortcode in versions up to, and including, 5.0.9 due to insufficient escaping on the user supplied parameter and lack of sufficient preparation on the existing SQL query. This makes it possible for authenticated attackers with contributor-level and above permissions to append additional SQL queries into already existing queries that can be used to extract sensitive information from the database.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-slimstat/tags/5.0.8/admin/view/wp-slimstat-db.php#L970)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=2959452%40wp-slimstat&new=2959452%40wp-slimstat&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-slimstat%2Fslimstat-analytics-509-authenticated-contributor-blind-sql-injection-via-shortcode&t=Slimstat%20Analytics%20%3C%3D%205.0.9%20-%20Authenticated%20%28Contributor%2B%29%20Blind%20SQL%20Injection%20via%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-slimstat%2Fslimstat-analytics-509-authenticated-contributor-blind-sql-injection-via-shortcode&text=Slimstat%20Analytics%20%3C%3D%205.0.9%20-%20Authenticated%20%28Contributor%2B%29%20Blind%20SQL%20Injection%20via%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-slimstat%2Fslimstat-analytics-509-authenticated-contributor-blind-sql-injection-via-shortcode "LinkedIn")
Email

## Vulnerability Details for SlimStat Analytics

#### [SlimStat Analytics](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-slimstat)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-slimstat [(view on wordpress.org)](https://wordpress.org/plugins/wp-slimstat) |
| Patched? | Yes |
| Remediation | Update to version 5.0.10, or a newer patched version |
| Affected Version | * <= 5.0.9 |
| Patched Version | * 5.0.10 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_1bc10b56_20250114_192556.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-slimstat%2Ftags%2F5.0.8%2Fadmin%2Fview%2Fwp-slimstat-db.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2911894 "Revision 2911894")
* [Next Revision](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2959452 "Revision 2959452") →
* [Blame](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-slimstat/tags/5.0.8/admin/view/wp-slimstat-db.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-slimstat](/browser/wp-slimstat?order=name "View wp-slimstat")/[tags](/browser/wp-slimstat/tags?order=name "View tags")/[5.0.8](/browser/wp-slimstat/tags/5.0.8?order=name "View 5.0.8")/[admin](/browser/wp-slimstat/tags/5.0.8/admin?order=name "View admin")/[view](/browser/wp-slimstat/tags/5.0.8/admin/view?order=name "View view")/[wp-slimstat-db.php](/browser/wp-slimstat/tags/5.0.8/admin/view/wp-slimstat-db.php?order=name "View wp-slimstat-db.php")

View diff against:

View revision:

| [Last change](/changeset/2945907/wp-slimstat/trunk/admin/view/wp-slimstat-db.php "View differences") on this file was [2945907](/changeset/2945907/ "View changeset 2945907"), checked in by mostafa.s1990, [18 months ago](/timeline?from=2023-08-01T09%3A05%3A51Z&precision=second "See timeline at 08/01/2023 09:05:51 AM") |
| --- |
| Update to version 5.0.7 from GitHub |
| **File size:** 61.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | // Let's define the main class with all the methods that we need |
| [4](#L4) | class wp\_slimstat\_db |
| [5](#L5) | { |
| [6](#L6) | // Filters |
| [7](#L7) | public static $columns\_names = array(); |
| [8](#L8) | public static $operator\_names = array(); |
| [9](#L9) | public static $filters\_normalized = array(); |
| [10](#L10) |  |
| [11](#L11) | // Structure that maps filters to SQL information (table names, clauses, lookup tables, etc) |
| [12](#L12) | public static $sql\_where = array('columns' => '', 'time\_range' => ''); |
| [13](#L13) |  |
| [14](#L14) | // Filters that are not visible in the dropdown |
| [15](#L15) | public static $all\_columns\_names = array(); |
| [16](#L16) |  |
| [17](#L17) | // Debug message |
| [18](#L18) | public static $debug\_message = ''; |
| [19](#L19) |  |
| [20](#L20) | // Useful data for the reports |
| [21](#L21) | public static $pageviews = 0; |
| [22](#L22) |  |
| [23](#L23) | /\* |
| [24](#L24) | \* Sets the filters and other structures needed to store the data retrieved from the DB |
| [25](#L25) | \*/ |
| [26](#L26) | public static function init($\_filters = '') |
| [27](#L27) | { |
| [28](#L28) | // List of supported filters and their user-friendly names |
| [29](#L29) | self::$columns\_names = array( |
| [30](#L30) | 'browser'              => array(\_\_('Browser', 'wp-slimstat'), 'varchar'), |
| [31](#L31) | 'country'              => array(\_\_('Country Code', 'wp-slimstat'), 'varchar'), |
| [32](#L32) | 'ip'                   => array(\_\_('IP Address', 'wp-slimstat'), 'varchar'), |
| [33](#L33) | 'searchterms'          => array(\_\_('Search Terms', 'wp-slimstat'), 'varchar'), |
| [34](#L34) | 'language'             => array(\_\_('Language', 'wp-slimstat'), 'varchar'), |
| [35](#L35) | 'platform'             => array(\_\_('Operating System', 'wp-slimstat'), 'varchar'), |
| [36](#L36) | 'resource'             => array(\_\_('Permalink', 'wp-slimstat'), 'varchar'), |
| [37](#L37) | 'referer'              => array(\_\_('Referer', 'wp-slimstat'), 'varchar'), |
| [38](#L38) | 'username'             => array(\_\_('Visitor\'s Username', 'wp-slimstat'), 'varchar'), |
| [39](#L39) | 'email'                => array(\_\_('Visitor\'s Email', 'wp-slimstat'), 'varchar'), |
| [40](#L40) | 'outbound\_resource'    => array(\_\_('Outbound Link', 'wp-slimstat'), 'varchar'), |
| [41](#L41) | 'tz\_offset'            => array(\_\_('Timezone Offset', 'wp-slimstat'), 'int'), |
| [42](#L42) | 'fingerprint'          => array(\_\_('Fingerprint', 'wp-slimstat'), 'varchar'), |
| [43](#L43) | 'page\_performance'     => array(\_\_('Page Speed', 'wp-slimstat'), 'int'), |
| [44](#L44) | 'no\_filter\_selected\_2' => array('', 'none'), |
| [45](#L45) | 'no\_filter\_selected\_3' => array(\_\_('-- Advanced filters --', 'wp-slimstat'), 'none'), |
| [46](#L46) | 'browser\_version'      => array(\_\_('Browser Version', 'wp-slimstat'), 'varchar'), |
| [47](#L47) | 'browser\_type'         => array(\_\_('Browser Type', 'wp-slimstat'), 'int'), |
| [48](#L48) | 'user\_agent'           => array(\_\_('User Agent', 'wp-slimstat'), 'varchar'), |
| [49](#L49) | 'city'                 => array(\_\_('City', 'wp-slimstat'), 'varchar'), |
| [50](#L50) | 'location'             => array(\_\_('Coordinates', 'wp-slimstat'), 'varchar'), |
| [51](#L51) | 'notes'                => array(\_\_('Annotations', 'wp-slimstat'), 'varchar'), |
| [52](#L52) | 'server\_latency'       => array(\_\_('Server Latency', 'wp-slimstat'), 'int'), |
| [53](#L53) | 'author'               => array(\_\_('Post Author', 'wp-slimstat'), 'varchar'), |
| [54](#L54) | 'category'             => array(\_\_('Post Category ID', 'wp-slimstat'), 'varchar'), |
| [55](#L55) | 'other\_ip'             => array(\_\_('Originating IP', 'wp-slimstat'), 'varchar'), |
| [56](#L56) | 'content\_type'         => array(\_\_('Resource Content Type', 'wp-slimstat'), 'varchar'), |
| [57](#L57) | 'content\_id'           => array(\_\_('Resource ID', 'wp-slimstat'), 'int'), |
| [58](#L58) | 'screen\_width'         => array(\_\_('Screen Width', 'wp-slimstat'), 'int'), |
| [59](#L59) | 'screen\_height'        => array(\_\_('Screen Height', 'wp-slimstat'), 'int'), |
| [60](#L60) | 'resolution'           => array(\_\_('Viewport Size', 'wp-slimstat'), 'varchar'), |
| [61](#L61) | 'visit\_id'             => array(\_\_('Visit ID', 'wp-slimstat'), 'int') |
| [62](#L62) | ); |
| [63](#L63) |  |
| [64](#L64) | if (wp\_slimstat::$settings['geolocation\_country'] == 'on') { |
| [65](#L65) | unset(self::$columns\_names['city']); |
| [66](#L66) | unset(self::$columns\_names['location']); |
| [67](#L67) | } |
| [68](#L68) |  |
| [69](#L69) | // List of supported filters and their friendly names |
| [70](#L70) | self::$operator\_names = array( |
| [71](#L71) | 'equals'           => \_\_('equals', 'wp-slimstat'), |
| [72](#L72) | 'is\_not\_equal\_to'  => \_\_('is not equal to', 'wp-slimstat'), |
| [73](#L73) | 'contains'         => \_\_('contains', 'wp-slimstat'), |
| [74](#L74) | 'includes\_in\_set'  => \_\_('is included in', 'wp-slimstat'), |
| [75](#L75) | 'does\_not\_contain' => \_\_('does not contain', 'wp-slimstat'), |
| [76](#L76) | 'starts\_with'      => \_\_('starts with', 'wp-slimstat'), |
| [77](#L77) | 'ends\_with'        => \_\_('ends with', 'wp-slimstat'), |
| [78](#L78) | 'sounds\_like'      => \_\_('sounds like', 'wp-slimstat'), |
| [79](#L79) | 'is\_greater\_than'  => \_\_('is greater than', 'wp-slimstat'), |
| [80](#L80) | 'is\_less\_than'     => \_\_('is less than', 'wp-slimstat'), |
| [81](#L81) | 'between'          => \_\_('is between (x,y)', 'wp-slimstat'), |
| [82](#L82) | 'matches'          => \_\_('matches', 'wp-slimstat'), |
| [83](#L83) | 'does\_not\_match'   => \_\_('does not match', 'wp-slimstat'), |
| [84](#L84) | 'is\_empty'         => \_\_('is empty', 'wp-slimstat'), |
| [85](#L85) | 'is\_not\_empty'     => \_\_('is not empty', 'wp-slimstat'), |
| [86](#L86) | ); |
| [87](#L87) |  |
| [88](#L88) | // The following filters will not be displayed in the dropdown |
| [89](#L89) | self::$all\_columns\_names = array\_merge(array( |
| [90](#L90) | // Date and Time |
| [91](#L91) | 'minute'            => array(\_\_('Minute', 'wp-slimstat'), 'int'), |
| [92](#L92) | 'hour'              => array(\_\_('Hour', 'wp-slimstat'), 'int'), |
| [93](#L93) | 'day'               => array(\_\_('Day', 'wp-slimstat'), 'int'), |
| [94](#L94) | 'month'             => array(\_\_('Month', 'wp-slimstat'), 'int'), |
| [95](#L95) | 'year'              => array(\_\_('Year', 'wp-slimstat'), 'int'), |
| [96](#L96) | 'interval'          => array(\_\_('days', 'wp-slimstat'), 'int'), |
| [97](#L97) | 'interval\_hours'    => array(\_\_('hours', 'wp-slimstat'), 'int'), |
| [98](#L98) | 'interval\_minutes'  => array(\_\_('minutes', 'wp-slimstat'), 'int'), |
| [99](#L99) | 'dt'                => array(\_\_('Timestamp', 'wp-slimstat'), 'int'), |
| [100](#L100) | 'dt\_out'            => array(\_\_('Exit Timestamp', 'wp-slimstat'), 'int'), |
| [101](#L101) |  |
| [102](#L102) | // Other columns |
| [103](#L103) | 'metric'            => array(\_\_('Metric', 'wp-slimstat'), 'varchar'), |
| [104](#L104) | 'value'             => array(\_\_('Value', 'wp-slimstat'), 'varchar'), |
| [105](#L105) | 'counthits'         => array(\_\_('Hits', 'wp-slimstat'), 'int'), |
| [106](#L106) | 'column\_group'      => array(\_\_('Grouped Value', 'wp-slimstat'), 'varchar'), |
| [107](#L107) | 'percentage'        => array(\_\_('Percentage', 'wp-slimstat'), 'int'), |
| [108](#L108) | 'tooltip'           => array(\_\_('Notes', 'wp-slimstat'), 'varchar'), |
| [109](#L109) | 'details'           => array(\_\_('Notes', 'wp-slimstat'), 'varchar'), |
| [110](#L110) |  |
| [111](#L111) | // Events |
| [112](#L112) | 'event\_id'          => array(\_\_('Event ID', 'wp-slimstat'), 'int'), |
| [113](#L113) | 'type'              => array(\_\_('Type', 'wp-slimstat'), 'int'), |
| [114](#L114) | 'event\_description' => array(\_\_('Event Description', 'wp-slimstat'), 'varchar'), |
| [115](#L115) | 'position'          => array(\_\_('Event Coordinates', 'wp-slimstat'), 'int'), |
| [116](#L116) |  |
| [117](#L117) | 'limit\_results' => array(\_\_('Max Results', 'wp-slimstat'), 'int'), |
| [118](#L118) | 'start\_from'    => array(\_\_('Offset', 'wp-slimstat'), 'int'), |
| [119](#L119) |  |
| [120](#L120) | // Misc Filters |
| [121](#L121) | 'strtotime'     => array(0, 'int') |
| [122](#L122) | ), self::$columns\_names); |
| [123](#L123) |  |
| [124](#L124) | // Allow third party plugins to add even more column names to the array |
| [125](#L125) | self::$all\_columns\_names = apply\_filters('slimstat\_column\_names', self::$all\_columns\_names); |
| [126](#L126) |  |
| [127](#L127) | // Filters use the following format: browser equals Firefox&&&country contains gb |
| [128](#L128) | $filters\_array = array(); |
| [129](#L129) |  |
| [130](#L130) | // Filters are set via javascript as hidden fields and submitted as a POST request. They override anything passed through the regular input fields |
| [131](#L131) | if (!empty($\_REQUEST['fs']) && is\_array($\_REQUEST['fs'])) { |
| [132](#L132) | foreach ($\_REQUEST['fs'] as $a\_request\_filter\_name => $a\_request\_filter\_value) { |
| [133](#L133) | $filters\_array[htmlspecialchars($a\_request\_filter\_name)] = "$a\_request\_filter\_name $a\_request\_filter\_value"; |
| [134](#L134) | } |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | // Date filters (input fields) - Please note: interval\_minutes is not exposed via the web interface, that's why it's not listed here below |
| [138](#L138) | foreach (array('hour', 'day', 'month', 'year', 'interval', 'interval\_hours') as $a\_date\_time\_filter\_name) { |
| [139](#L139) | if (isset($\_POST[$a\_date\_time\_filter\_name]) && strlen($\_POST[$a\_date\_time\_filter\_name]) > 0) { // here we use isset instead of !empty to handle ZERO as a valid input value |
| [140](#L140) | $filters\_array[$a\_date\_time\_filter\_name] = "$a\_date\_time\_filter\_name equals " . intval($\_POST[$a\_date\_time\_filter\_name]); |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) |  |
| [144](#L144) | // Fields and drop downs |
| [145](#L145) | if (!empty($\_POST['f']) && !empty($\_POST['o'])) { |
| [146](#L146) | $filters\_array[htmlspecialchars($\_POST['f'])] = "{$\_POST[ 'f' ]} {$\_POST[ 'o' ]} " . (isset($\_POST['v']) ? $\_POST['v'] : ''); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | // Filters set via the plugin options |
| [150](#L150) | if (wp\_slimstat::$settings['restrict\_authors\_view'] == 'on' && !current\_user\_can('manage\_options') && !empty($GLOBALS['current\_user']->user\_login)) { |
| [151](#L151) | $filters\_array['author'] = 'author equals ' . $GLOBALS['current\_user']->user\_login; |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | if (!empty($filters\_array)) { |
| [155](#L155) | $filters\_raw = implode('&&&', $filters\_array); |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | // Filters are defined as: browser equals Chrome&&&country starts\_with en |
| [159](#L159) | if (!isset($filters\_raw) || !is\_string($filters\_raw)) { |
| [160](#L160) | $filters\_raw = ''; |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | if (!empty($\_filters) && is\_string($\_filters)) { |
| [164](#L164) | if (!empty($filters\_raw)) { |
| [165](#L165) | $filters\_raw = empty($filters\_raw) ? $\_filters : $\_filters . '&&&' . $filters\_raw; |
| [166](#L166) | } else { |
| [167](#L167) | $filters\_raw = $\_filters; |
| [168](#L168) | } |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | // Hook for the... filters |
| [172](#L172) | $filters\_raw = apply\_filters('slimstat\_db\_pre\_filters', $filters\_raw); |
| [173](#L173) |  |
| [174](#L174) | // Normalize the filters |
| [175](#L175) | self::$filters\_normalized = self::init\_filters($filters\_raw); |
| [176](#L176) |  |
| [177](#L177) | // Retrieve data that will be used by multiple reports |
| [178](#L178) | if (empty($\_REQUEST['page']) || strpos($\_REQUEST['page'], 'slimview') !== false) { |
| [179](#L179) | self::$pageviews = wp\_slimstat\_db::count\_records(); |
| [180](#L180) | } |
| [181](#L181) | } |
| [182](#L182) | // end init |
| [183](#L183) |  |
| [184](#L184) | /\*\* |
| [185](#L185) | \* Builds the array of WHERE clauses to be used later in our SQL queries |
| [186](#L186) | \*/ |
| [187](#L187) | protected static function \_get\_sql\_where($\_filters\_normalized = array(), $\_slim\_stats\_table\_alias = '') |
| [188](#L188) | { |
| [189](#L189) | $sql\_array = array(); |
| [190](#L190) |  |
| [191](#L191) | foreach ($\_filters\_normalized as $a\_filter\_column => $a\_filter\_data) { |
| [192](#L192) | // Add-ons can set their own custom filters, which are ignored here |
| [193](#L193) | if (strpos($a\_filter\_column, 'addon\_') !== false) { |
| [194](#L194) | continue; |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | $sql\_array[] = self::get\_single\_where\_clause($a\_filter\_column, $a\_filter\_data[0], $a\_filter\_data[1], $\_slim\_stats\_table\_alias); |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | // Flatten array |
| [201](#L201) | if (!empty($sql\_array)) { |
| [202](#L202) | return implode(' AND ', $sql\_array); |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | return ''; |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | public static function get\_combined\_where($\_where = '', $\_column = '\*', $\_use\_date\_filters = true, $\_slim\_stats\_table\_alias = '') |
| [209](#L209) | { |
| [210](#L210) | $dt\_with\_alias = 'dt'; |
| [211](#L211) | if (!empty($\_slim\_stats\_table\_alias)) { |
| [212](#L212) | $dt\_with\_alias = $\_slim\_stats\_table\_alias . '.' . $dt\_with\_alias; |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | $time\_range\_condition = ''; |
| [216](#L216) | if (empty($\_where)) { |
| [217](#L217) | if (!empty(self::$filters\_normalized['columns'])) { |
| [218](#L218) | $\_where = self::\_get\_sql\_where(self::$filters\_normalized['columns'], $\_slim\_stats\_table\_alias); |
| [219](#L219) |  |
| [220](#L220) | if ($\_use\_date\_filters) { |
| [221](#L221) | $time\_range\_condition = "$dt\_with\_alias BETWEEN " . self::$filters\_normalized['utime']['start'] . ' AND ' . self::$filters\_normalized['utime']['end']; |
| [222](#L222) | } |
| [223](#L223) | } elseif ($\_use\_date\_filters) { |
| [224](#L224) | $time\_range\_condition = "$dt\_with\_alias BETWEEN " . self::$filters\_normalized['utime']['start'] . ' AND ' . self::$filters\_normalized['utime']['end']; |
| [225](#L225) | } |
| [226](#L226) |  |
| [227](#L227) | // This could happen if we have custom filters (add-ons, third party tools) |
| [228](#L228) | if (empty($\_where)) { |
| [229](#L229) | $\_where = '1=1'; |
| [230](#L230) | } |
| [231](#L231) | } else { |
| [232](#L232) | if ($\_where != '1=1' && !empty(self::$filters\_normalized['columns'])) { |
| [233](#L233) | $new\_clause = self::\_get\_sql\_where(self::$filters\_normalized['columns'], $\_slim\_stats\_table\_alias); |
| [234](#L234) |  |
| [235](#L235) | // This condition could be empty if it's related to a custom column |
| [236](#L236) | if (!empty($new\_clause)) { |
| [237](#L237) | $\_where .= ' AND ' . $new\_clause; |
| [238](#L238) | } |
| [239](#L239) | } |
| [240](#L240) | if ($\_use\_date\_filters) { |
| [241](#L241) | $time\_range\_condition = "$dt\_with\_alias BETWEEN " . self::$filters\_normalized['utime']['start'] . ' AND ' . self::$filters\_normalized['utime']['end']; |
| [242](#L242) | } |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | if (!empty($\_where) && !empty($time\_range\_condition)) { |
| [246](#L246) | $\_where = "$\_where AND $time\_range\_condition"; |
| [247](#L247) | } else { |
| [248](#L248) | $\_where = trim("$\_where $time\_range\_condition"); |
| [249](#L249) | } |
| [250](#L250) |  |
| [251](#L251) | if (!empty($\_column) && !empty(self::$columns\_names[$\_column])) { |
| [252](#L252) | $column\_with\_alias = $\_column; |
| [253](#L253) | if (!empty($\_slim\_stats\_table\_alias)) { |
| [254](#L254) | $column\_with\_alias = $\_slim\_stats\_table\_alias . '.' . $column\_with\_alias; |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | $filter\_empty     = "$column\_with\_alias " . ((self::$columns\_names[$\_column] [1] == 'varchar') ? 'IS NULL' : '= 0'); |
| [258](#L258) | $filter\_not\_empty = "$column\_with\_alias " . ((self::$columns\_names[$\_column] [1] == 'varchar') ? 'IS NOT NULL' : '<> 0'); |
| [259](#L259) |  |
| [260](#L260) | if (strpos($\_where, $filter\_empty) === false && strpos($\_where, $filter\_not\_empty) === false) { |
| [261](#L261) | $\_where = "$filter\_not\_empty AND $\_where"; |
| [262](#L262) | } |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | return $\_where; |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | /\*\* |
| [269](#L269) | \* Translates user-friendly operators into SQL conditions |
| [270](#L270) | \*/ |
| [271](#L271) | public static function get\_single\_where\_clause($\_dimension = 'id', $\_operator = 'equals', $\_value = '', $\_slim\_stats\_table\_alias = '') |
| [272](#L272) | { |
| [273](#L273) | $filter\_empty     = (!empty(self::$columns\_names[$\_dimension]) && self::$columns\_names[$\_dimension] [1] == 'varchar') ? 'IS NULL' : '= 0'; |
| [274](#L274) | $filter\_not\_empty = (!empty(self::$columns\_names[$\_dimension]) && self::$columns\_names[$\_dimension] [1] == 'varchar') ? 'IS NOT NULL' : '<> 0'; |
| [275](#L275) |  |
| [276](#L276) | $column\_with\_alias = $\_dimension; |
| [277](#L277) | if (!empty($\_slim\_stats\_table\_alias)) { |
| [278](#L278) | $column\_with\_alias = $\_slim\_stats\_table\_alias . '.' . $\_dimension; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | switch ($\_dimension) { |
| [282](#L282) | case 'ip': |
| [283](#L283) | case 'other\_ip': |
| [284](#L284) | $filter\_empty = '= "0.0.0.0"'; |
| [285](#L285) | break; |
| [286](#L286) | default: |
| [287](#L287) | break; |
| [288](#L288) | } |
| [289](#L289) |  |
| [290](#L290) | if ($\_dimension == 'resource') { |
| [291](#L291) | $\_value = implode('/', array\_map('urlencode', explode('/', $\_value))); |
| [292](#L292) | } |
| [293](#L293) |  |
| [294](#L294) | $where = array('', htmlentities($\_value, ENT\_QUOTES, 'UTF-8')); |
| [295](#L295) |  |
| [296](#L296) | switch ($\_operator) { |
| [297](#L297) | case 'is\_not\_equal\_to': |
| [298](#L298) | $where[0] = "$column\_with\_alias <> %s"; |
| [299](#L299) | break; |
| [300](#L300) |  |
| [301](#L301) | case 'contains': |
| [302](#L302) | $where = array("$column\_with\_alias LIKE %s", '%' . $\_value . '%'); |
| [303](#L303) | break; |
| [304](#L304) |  |
| [305](#L305) | case 'includes\_in\_set': |
| [306](#L306) | case 'included\_in\_set': |
| [307](#L307) | $where[0] = "FIND\_IN\_SET( $column\_with\_alias, %s ) > 0"; |
| [308](#L308) | break; |
| [309](#L309) |  |
| [310](#L310) | case 'does\_not\_contain': |
| [311](#L311) | $where = array("$column\_with\_alias NOT LIKE %s", '%' . $\_value . '%'); |
| [312](#L312) | break; |
| [313](#L313) |  |
| [314](#L314) | case 'starts\_with': |
| [315](#L315) | $where = array("$column\_with\_alias LIKE %s", $\_value . '%'); |
| [316](#L316) | break; |
| [317](#L317) |  |
| [318](#L318) | case 'ends\_with': |
| [319](#L319) | $where = array("$column\_with\_alias LIKE %s", '%' . $\_value); |
| [320](#L320) | break; |
| [321](#L321) |  |
| [322](#L322) | case 'sounds\_like': |
| [323](#L323) | $where[0] = "SOUNDEX( $column\_with\_alias ) = SOUNDEX( %s )"; |
| [324](#L324) | break; |
| [325](#L325) |  |
| [326](#L326) | case 'is\_empty': |
| [327](#L327) | $where = array("$column\_with\_alias $filter\_empty", ''); |
| [328](#L328) | break; |
| [329](#L329) |  |
| [330](#L330) | case 'is\_not\_empty': |
| [331](#L331) | $where = array("$column\_with\_alias $filter\_not\_empty", ''); |
| [332](#L332) | break; |
| [333](#L333) |  |
| [334](#L334) | case 'is\_greater\_than': |
| [335](#L335) | $where[0] = "$column\_with\_alias > %d"; |
| [336](#L336) | break; |
| [337](#L337) |  |
| [338](#L338) | case 'is\_less\_than': |
| [339](#L339) | $where[0] = "$column\_with\_alias < %d"; |
| [340](#L340) | break; |
| [341](#L341) |  |
| [342](#L342) | case 'between': |
| [343](#L343) | $range = explode(',', $\_value); |
| [344](#L344) | $where = array("$column\_with\_alias BETWEEN %d AND %d", array($range[0], $range[1])); |
| [345](#L345) | break; |
| [346](#L346) |  |
| [347](#L347) | case 'matches': |
| [348](#L348) | $where[0] = "$column\_with\_alias REGEXP %s"; |
| [349](#L349) | break; |
| [350](#L350) |  |
| [351](#L351) | case 'does\_not\_match': |
| [352](#L352) | $where[0] = "$column\_with\_alias NOT REGEXP %s"; |
| [353](#L353) | break; |
| [354](#L354) |  |
| [355](#L355) | default: |
| [356](#L356) | $where[0] = "$column\_with\_alias = %s"; |
| [357](#L357) | break; |
| [358](#L358) | } |
| [359](#L359) |  |
| [360](#L360) | if (isset($where[1]) && $where[1] != '') { |
| [361](#L361) | return $GLOBALS['wpdb']->prepare($where[0], $where[1]); |
| [362](#L362) | } else { |
| [363](#L363) | return $where[0]; |
| [364](#L364) | } |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) | public static function get\_results($\_sql = '', $\_select\_no\_aggregate\_values = '', $\_order\_by = '', $\_group\_by = '', $\_aggregate\_values\_add = '') |
| [368](#L368) | { |
| [369](#L369) | $\_sql = apply\_filters('slimstat\_get\_results\_sql', $\_sql, $\_select\_no\_aggregate\_values, $\_order\_by, $\_group\_by, $\_aggregate\_values\_add); |
| [370](#L370) |  |
| [371](#L371) | if (wp\_slimstat::$settings['show\_sql\_debug'] == 'on') { |
| [372](#L372) | self::$debug\_message .= "<p class='debug'>$\_sql</p>"; |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | $cached\_results = wp\_cache\_get(md5($\_sql), 'wp-slimstat'); |
| [376](#L376) |  |
| [377](#L377) | // Save the results of this query in our object cache |
| [378](#L378) | if (empty($cached\_results)) { |
| [379](#L379) | $cached\_results = wp\_slimstat::$wpdb->get\_results($\_sql, ARRAY\_A); |
| [380](#L380) | wp\_cache\_add(md5($\_sql), $cached\_results, 'wp-slimstat'); |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) | return $cached\_results; |
| [384](#L384) | } |
| [385](#L385) |  |
| [386](#L386) | public static function get\_var($\_sql = '', $\_aggregate\_value = '') |
| [387](#L387) | { |
| [388](#L388) | $\_sql = apply\_filters('slimstat\_get\_var\_sql', $\_sql, $\_aggregate\_value); |
| [389](#L389) |  |
| [390](#L390) | if (wp\_slimstat::$settings['show\_sql\_debug'] == 'on') { |
| [391](#L391) | self::$debug\_message .= "<p class='debug'>$\_sql</p>"; |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | // Save the results of this query in our object cache |
| [395](#L395) | if (empty(wp\_cache\_get(md5($\_sql), 'wp-slimstat'))) { |
| [396](#L396) | wp\_cache\_add(md5($\_sql), wp\_slimstat::$wpdb->get\_var($\_sql), 'wp-slimstat'); |
| [397](#L397) | } |
| [398](#L398) |  |
| [399](#L399) | return wp\_cache\_get(md5($\_sql), 'wp-slimstat'); |
| [400](#L400) | } |
| [401](#L401) |  |
| [402](#L402) | public static function parse\_filters($\_filters\_raw) |
| [403](#L403) | { |
| [404](#L404) | $filters\_parsed = array( |
| [405](#L405) | 'columns' => array(), |
| [406](#L406) | 'date'    => array() |
| [407](#L407) | ); |
| [408](#L408) |  |
| [409](#L409) | if (!empty($\_filters\_raw)) { |
| [410](#L410) | $matches = explode('&&&', $\_filters\_raw); |
| [411](#L411) |  |
| [412](#L412) | foreach ($matches as $idx => $a\_match) { |
| [413](#L413) | preg\_match('/([^\s]+)\s([^\s]+)\s(.+)?/', urldecode($a\_match), $a\_filter); |
| [414](#L414) |  |
| [415](#L415) | if (empty($a\_filter) || ((!array\_key\_exists($a\_filter[1], self::$all\_columns\_names) || strpos($a\_filter[1], 'no\_filter') !== false) && strpos($a\_filter[1], 'addon\_') === false)) { |
| [416](#L416) | continue; |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | switch ($a\_filter[1]) { |
| [420](#L420) | case 'strtotime': |
| [421](#L421) | $custom\_date = strtotime($a\_filter[3], wp\_slimstat::date\_i18n('U')); |
| [422](#L422) |  |
| [423](#L423) | $filters\_parsed['date']['minute'] = intval(date('i', $custom\_date)); |
| [424](#L424) | $filters\_parsed['date']['hour']   = intval(date('H', $custom\_date)); |
| [425](#L425) | $filters\_parsed['date']['day']    = intval(date('j', $custom\_date)); |
| [426](#L426) | $filters\_parsed['date']['month']  = intval(date('n', $custom\_date)); |
| [427](#L427) | $filters\_parsed['date']['year']   = intval(date('Y', $custom\_date)); |
| [428](#L428) | break; |
| [429](#L429) |  |
| [430](#L430) | case 'minute': |
| [431](#L431) | case 'hour': |
| [432](#L432) | case 'day': |
| [433](#L433) | case 'month': |
| [434](#L434) | case 'year': |
| [435](#L435) | if (is\_numeric($a\_filter[3])) { |
| [436](#L436) | $filters\_parsed['date'][$a\_filter[1]] = intval($a\_filter[3]); |
| [437](#L437) | } else { |
| [438](#L438) | // Try to apply strtotime to value |
| [439](#L439) | self::toggle\_date\_i18n\_filters(false); |
| [440](#L440) | switch ($a\_filter[1]) { |
| [441](#L441) | case 'minute': |
| [442](#L442) | $filters\_parsed['date']['minute'] = intval(date('i', strtotime($a\_filter[3], date\_i18n('U')))); |
| [443](#L443) | break; |
| [444](#L444) |  |
| [445](#L445) | case 'hour': |
| [446](#L446) | $filters\_parsed['date']['hour'] = intval(date('H', strtotime($a\_filter[3], date\_i18n('U')))); |
| [447](#L447) | break; |
| [448](#L448) |  |
| [449](#L449) | case 'day': |
| [450](#L450) | $filters\_parsed['date']['day'] = intval(date('j', strtotime($a\_filter[3], date\_i18n('U')))); |
| [451](#L451) | break; |
| [452](#L452) |  |
| [453](#L453) | case 'month': |
| [454](#L454) | $filters\_parsed['date']['month'] = intval(date('n', strtotime($a\_filter[3], date\_i18n('U')))); |
| [455](#L455) | break; |
| [456](#L456) |  |
| [457](#L457) | case 'year': |
| [458](#L458) | $filters\_parsed['date']['year'] = intval(date('Y', strtotime($a\_filter[3], date\_i18n('U')))); |
| [459](#L459) | break; |
| [460](#L460) |  |
| [461](#L461) | default: |
| [462](#L462) | break; |
| [463](#L463) | } |
| [464](#L464) | self::toggle\_date\_i18n\_filters(true); |
| [465](#L465) |  |
| [466](#L466) | if ($filters\_parsed['date'][$a\_filter[1]] === false) { |
| [467](#L467) | unset($filters\_parsed['date'][$a\_filter[1]]); |
| [468](#L468) | } |
| [469](#L469) | } |
| [470](#L470) | break; |
| [471](#L471) |  |
| [472](#L472) | case 'interval': |
| [473](#L473) | case 'interval\_hours': |
| [474](#L474) | case 'interval\_minutes': |
| [475](#L475) | $filters\_parsed['date'][$a\_filter[1]] = intval($a\_filter[3]); |
| [476](#L476) | break; |
| [477](#L477) |  |
| [478](#L478) | case 'limit\_results': |
| [479](#L479) | case 'start\_from': |
| [480](#L480) | $filters\_parsed['misc'][$a\_filter[1]] = str\_replace('\\', '', htmlspecialchars\_decode($a\_filter[3])); |
| [481](#L481) | break; |
| [482](#L482) |  |
| [483](#L483) | case 'content\_id': |
| [484](#L484) | if (!empty($a\_filter[3])) { |
| [485](#L485) | $content\_id                              = ($a\_filter[3] == 'current' && !empty($GLOBALS['post']->ID)) ? $GLOBALS['post']->ID : $a\_filter[3]; |
| [486](#L486) | $filters\_parsed['columns'][$a\_filter[1]] = array($a\_filter[2], $content\_id); |
| [487](#L487) | break; |
| [488](#L488) | } |
| [489](#L489) | // no break here: if value IS numeric, go to the default parser here below |
| [490](#L490) |  |
| [491](#L491) | default: |
| [492](#L492) | $filters\_parsed['columns'][$a\_filter[1]] = array($a\_filter[2], isset($a\_filter[3]) ? str\_replace('\\', '', htmlspecialchars\_decode($a\_filter[3])) : ''); |
| [493](#L493) | break; |
| [494](#L494) | } |
| [495](#L495) | } |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | return $filters\_parsed; |
| [499](#L499) | } |
| [500](#L500) |  |
| [501](#L501) | public static function init\_filters($\_filters\_raw = '') |
| [502](#L502) | { |
| [503](#L503) | $fn = self::parse\_filters($\_filters\_raw); |
| [504](#L504) |  |
| [505](#L505) | // Initialize default values |
| [506](#L506) | if (empty($fn['misc']['limit\_results'])) { |
| [507](#L507) | $fn['misc']['limit\_results'] = wp\_slimstat::$settings['limit\_results']; |
| [508](#L508) | } |
| [509](#L509) | if (empty($fn['misc']['start\_from'])) { |
| [510](#L510) | $fn['misc']['start\_from'] = 0; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | $fn['utime'] = array( |
| [514](#L514) | 'start' => 0, |
| [515](#L515) | 'end'   => 0 |
| [516](#L516) | ); |
| [517](#L517) |  |
| [518](#L518) | // Normalize the various date values |
| [519](#L519) | wp\_slimstat::toggle\_date\_i18n\_filters(false); |
| [520](#L520) |  |
| [521](#L521) | // Intervals |
| [522](#L522) | // If neither an interval nor interval\_hours were specified... |
| [523](#L523) | if (!isset($fn['date']['interval\_minutes']) && !isset($fn['date']['interval\_hours']) && !isset($fn['date']['interval'])) { |
| [524](#L524) | $fn['date']['interval\_minutes'] = 0; |
| [525](#L525) | $fn['date']['interval\_hours']   = 0; |
| [526](#L526) |  |
| [527](#L527) | // If a day has been specified, then interval = 1 (show only that day) |
| [528](#L528) | if (!empty($fn['date']['day'])) { |
| [529](#L529) | $fn['date']['interval'] = -1; |
| [530](#L530) | } // Show last X days, if the corresponding setting is enabled |
| [531](#L531) | else if (empty(wp\_slimstat::$settings['use\_current\_month\_timespan']) || wp\_slimstat::$settings['use\_current\_month\_timespan'] != 'on') { |
| [532](#L532) | $fn['date']['interval'] = -abs(wp\_slimstat::$settings['posts\_column\_day\_interval']); |
| [533](#L533) | } // Otherwise, the interval is the number of days from the beginning of the month (current month view) |
| [534](#L534) | else { |
| [535](#L535) | $fn['date']['interval'] = -intval(date\_i18n('j')); |
| [536](#L536) | } |
| [537](#L537) | } else { |
| [538](#L538) | if (empty($fn['date']['interval\_minutes'])) { |
| [539](#L539) | // interval was set, but not interval\_hours |
| [540](#L540) | $fn['date']['interval\_minutes'] = 0; |
| [541](#L541) | } |
| [542](#L542) | if (empty($fn['date']['interval\_hours'])) { |
| [543](#L543) | // interval\_hours was set, but not interval |
| [544](#L544) | $fn['date']['interval\_hours'] = 0; |
| [545](#L545) | } |
| [546](#L546) | if (empty($fn['date']['interval'])) { |
| [547](#L547) | // interval\_hours was set, but not interval |
| [548](#L548) | $fn['date']['interval'] = 0; |
| [549](#L549) | } |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | $fn['utime']['range'] = $fn['date']['interval'] \* 86400 + $fn['date']['interval\_hours'] \* 3600 + $fn['date']['interval\_minutes'] \* 60; |
| [553](#L553) |  |
| [554](#L554) | // Day |
| [555](#L555) | if (empty($fn['date']['day'])) { |
| [556](#L556) | $fn['date']['day'] = intval(date\_i18n('j')); |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | // Month |
| [560](#L560) | if (empty($fn['date']['month'])) { |
| [561](#L561) | $fn['date']['month'] = intval(date\_i18n('n')); |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | // Year |
| [565](#L565) | if (empty($fn['date']['year'])) { |
| [566](#L566) | $fn['date']['year'] = intval(date\_i18n('Y')); |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | if ($fn['utime']['range'] < 0) { |
| [570](#L570) | $fn['utime']['end'] = mktime( |
| [571](#L571) | !empty($fn['date']['hour']) ? $fn['date']['hour'] : 23, |
| [572](#L572) | !empty($fn['date']['minute']) ? $fn['date']['minute'] : 59, |
| [573](#L573) | 59, |
| [574](#L574) | $fn['date']['month'], |
| [575](#L575) | $fn['date']['day'], |
| [576](#L576) | $fn['date']['year'] |
| [577](#L577) | ); |
| [578](#L578) |  |
| [579](#L579) | // If end is in the future and the level of granularity is hours, set it to now |
| [580](#L580) | if (!empty($fn['date']['interval\_hours']) && $fn['utime']['end'] > date\_i18n('U')) { |
| [581](#L581) | $fn['utime']['end'] = intval(date\_i18n('U')); |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) | $fn['utime']['range'] = $fn['utime']['range'] + 1; |
| [585](#L585) | $fn['utime']['start'] = $fn['utime']['end'] + $fn['utime']['range']; |
| [586](#L586) |  |
| [587](#L587) | // Store the absolute value for later (chart) |
| [588](#L588) | $fn['utime']['range'] = -$fn['utime']['range']; |
| [589](#L589) | } else { |
| [590](#L590) | $fn['utime']['start'] = mktime( |
| [591](#L591) | !empty($fn['date']['hour']) ? $fn['date']['hour'] : 0, |
| [592](#L592) | !empty($fn['date']['minute']) ? $fn['date']['minute'] : 0, |
| [593](#L593) | 0, |
| [594](#L594) | $fn['date']['month'], |
| [595](#L595) | $fn['date']['day'], |
| [596](#L596) | $fn['date']['year'] |
| [597](#L597) | ); |
| [598](#L598) |  |
| [599](#L599) | $fn['utime']['range'] = $fn['utime']['range'] - 1; |
| [600](#L600) | $fn['utime']['end']   = $fn['utime']['start'] + $fn['utime']['range']; |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | // If end is in the future, set it to now |
| [604](#L604) | if ($fn['utime']['end'] > date\_i18n('U')) { |
| [605](#L605) | $fn['utime']['end'] = intval(date\_i18n('U')); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | // Turn the date\_i18n filters back on |
| [609](#L609) | wp\_slimstat::toggle\_date\_i18n\_filters(true); |
| [610](#L610) |  |
| [611](#L611) | // Apply third-party filters |
| [612](#L612) | $fn = apply\_filters('slimstat\_db\_filters\_normalized', $fn, $\_filters\_raw); |
| [613](#L613) |  |
| [614](#L614) | return $fn; |
| [615](#L615) | } |
| [616](#L616) |  |
| [617](#L617) | // The following methods retrieve the information from the database |
| [618](#L618) |  |
| [619](#L619) | public static function count\_bouncing\_pages() |
| [620](#L620) | { |
| [621](#L621) | $where = self::get\_combined\_where('visit\_id > 0 AND content\_type <> "404"', 'resource'); |
| [622](#L622) |  |
| [623](#L623) | return intval(self::get\_var(" |
| [624](#L624) | SELECT COUNT(\*) counthits |
| [625](#L625) | FROM ( |
| [626](#L626) | SELECT resource, visit\_id |
| [627](#L627) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [628](#L628) | WHERE $where |
| [629](#L629) | GROUP BY resource |
| [630](#L630) | HAVING COUNT(visit\_id) = 1 |
| [631](#L631) | ) as ts1", |
| [632](#L632) | 'SUM(counthits) AS counthits')); |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | public static function count\_exit\_pages() |
| [636](#L636) | { |
| [637](#L637) | $where = self::get\_combined\_where('visit\_id > 0', 'resource'); |
| [638](#L638) |  |
| [639](#L639) | return intval(self::get\_var(" |
| [640](#L640) | SELECT COUNT(\*) counthits |
| [641](#L641) | FROM ( |
| [642](#L642) | SELECT resource, dt |
| [643](#L643) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [644](#L644) | WHERE $where |
| [645](#L645) | GROUP BY resource |
| [646](#L646) | HAVING dt = MAX(dt) |
| [647](#L647) | ) AS ts1", |
| [648](#L648) | 'SUM(counthits) AS counthits')); |
| [649](#L649) | } |
| [650](#L650) |  |
| [651](#L651) | public static function count\_records($\_column = 'id', $\_where = '', $\_use\_date\_filters = true) |
| [652](#L652) | { |
| [653](#L653) | // Validating the column |
| [654](#L654) | if (in\_array($\_column, ['id', 'ip', 'other\_ip', 'username', 'email', 'country', 'location', 'city', 'referer', 'resource', 'searchterms', 'notes', 'visit\_id', 'server\_latency', 'page\_performance', 'browser', 'browser\_version', 'browser\_type', 'platform', 'language', 'fingerprint', 'user\_agent', 'resolution', 'screen\_width', 'screen\_height', 'content\_type', 'category', 'author', 'content\_id', 'outbound\_resource', 'tz\_offset', 'dt\_out', 'dt']) === false) { |
| [655](#L655) | return; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | $distinct\_column = ($\_column != 'id') ? "DISTINCT $\_column" : $\_column; |
| [659](#L659) | $\_where          = self::get\_combined\_where($\_where, $\_column, $\_use\_date\_filters); |
| [660](#L660) |  |
| [661](#L661) | return intval(self::get\_var(" |
| [662](#L662) | SELECT COUNT($distinct\_column) counthits |
| [663](#L663) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [664](#L664) | WHERE $\_where", |
| [665](#L665) | 'SUM(counthits) AS counthits')); |
| [666](#L666) | } |
| [667](#L667) |  |
| [668](#L668) | public static function count\_records\_having($\_column = 'id', $\_where = '', $\_having = '') |
| [669](#L669) | { |
| [670](#L670) | $distinct\_column = ($\_column != 'id') ? "DISTINCT $\_column" : $\_column; |
| [671](#L671) | $\_where          = self::get\_combined\_where($\_where, $\_column); |
| [672](#L672) |  |
| [673](#L673) | return intval(self::get\_var(" |
| [674](#L674) | SELECT COUNT(\*) counthits FROM ( |
| [675](#L675) | SELECT $distinct\_column |
| [676](#L676) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [677](#L677) | WHERE $\_where |
| [678](#L678) | GROUP BY $\_column |
| [679](#L679) | HAVING $\_having |
| [680](#L680) | ) AS ts1", |
| [681](#L681) | 'SUM(counthits) AS counthits')); |
| [682](#L682) | } |
| [683](#L683) |  |
| [684](#L684) | public static function get\_data\_for\_chart($\_args = array()) |
| [685](#L685) | { |
| [686](#L686) | // Determine the chart granularity based on the date range |
| [687](#L687) | // - Up to 24 hours (86400 seconds): HOURLY |
| [688](#L688) | // - Up to 120 days (10368000 seconds): DAILY |
| [689](#L689) | // - Otherwise: MONTHLY |
| [690](#L690) | $params = array(); |
| [691](#L691) |  |
| [692](#L692) | if (self::$filters\_normalized['utime']['range'] < 86400) { |
| [693](#L693) | $params['group\_by']          = "DAY(CONVERT\_TZ(FROM\_UNIXTIME(dt), @@session.time\_zone, '+00:00')), HOUR(CONVERT\_TZ(FROM\_UNIXTIME(dt), @@session.time\_zone, '+00:00'))"; |
| [694](#L694) | $params['data\_points\_label'] = (strpos(number\_format\_i18n(1000), '.') === false) ? 'h a' : 'H'; |
| [695](#L695) | $params['data\_points\_count'] = ceil(self::$filters\_normalized['utime']['range'] / 3600); |
| [696](#L696) | $params['granularity']       = 'HOUR'; |
| [697](#L697) | } else if (self::$filters\_normalized['utime']['range'] < 10368000) { |
| [698](#L698) | $params['group\_by']          = "MONTH(CONVERT\_TZ(FROM\_UNIXTIME(dt), @@session.time\_zone, '+00:00')), DAY(CONVERT\_TZ(FROM\_UNIXTIME(dt), @@session.time\_zone, '+00:00'))"; |
| [699](#L699) | $params['data\_points\_label'] = (strpos(number\_format\_i18n(1000), '.') === false) ? 'm/d' : 'd/m'; |
| [700](#L700) | $params['data\_points\_count'] = ceil(self::$filters\_normalized['utime']['range'] / 86400); |
| [701](#L701) | $params['granularity']       = 'DAY'; |
| [702](#L702) | } else { |
| [703](#L703) | $params['group\_by']          = "YEAR(CONVERT\_TZ(FROM\_UNIXTIME(dt), @@session.time\_zone, '+00:00')), MONTH(CONVERT\_TZ(FROM\_UNIXTIME(dt), @@session.time\_zone, '+00:00'))"; |
| [704](#L704) | $params['data\_points\_label'] = 'm/y'; |
| [705](#L705) | $params['data\_points\_count'] = self::count\_months\_between(self::$filters\_normalized['utime']['start'], self::$filters\_normalized['utime']['end']); |
| [706](#L706) | $params['granularity']       = 'MONTH'; |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | // Calculate the "previous/comparison" time range |
| [710](#L710) | $params['previous\_end']   = self::$filters\_normalized['utime']['start'] - 1; |
| [711](#L711) | $params['previous\_start'] = $params['previous\_end'] - self::$filters\_normalized['utime']['range']; |
| [712](#L712) |  |
| [713](#L713) | // Build the SQL query |
| [714](#L714) | if (empty($\_args['where'])) { |
| [715](#L715) | $\_args['where'] = ''; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | $sql = " |
| [719](#L719) | SELECT MIN(dt) AS dt, {$\_args[ 'data1' ]} AS v1, {$\_args[ 'data2' ]} AS v2 |
| [720](#L720) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [721](#L721) | WHERE " . self::get\_combined\_where($\_args['where'], '\*', false) . " AND (dt BETWEEN {$params[ 'previous\_start' ]} AND {$params[ 'previous\_end' ]} OR dt BETWEEN " . self::$filters\_normalized['utime']['start'] . ' AND ' . self::$filters\_normalized['utime']['end'] . ") |
| [722](#L722) | GROUP BY {$params[ 'group\_by' ]}"; |
| [723](#L723) |  |
| [724](#L724) | // Get the data |
| [725](#L725) | $results = self::get\_results( |
| [726](#L726) | $sql, |
| [727](#L727) | 'dt', |
| [728](#L728) | '', |
| [729](#L729) | $params['group\_by'], 'SUM(v1) AS v1, SUM(v2) AS v2' |
| [730](#L730) | ); |
| [731](#L731) |  |
| [732](#L732) | $output = array( |
| [733](#L733) | 'keys'     => array(), |
| [734](#L734) | 'labels'   => array(), |
| [735](#L735) | 'datasets' => array( |
| [736](#L736) | 'v1' => array(), |
| [737](#L737) | 'v2' => array(), |
| [738](#L738) | 'v3' => array(), |
| [739](#L739) | 'v4' => array() |
| [740](#L740) | ) |
| [741](#L741) | ); |
| [742](#L742) |  |
| [743](#L743) | // No data? No problem! |
| [744](#L744) | if (!is\_array($results) || empty($results)) { |
| [745](#L745) | return $output; |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | // Generate the output array (sent to the chart library) by combining all the data collected so far |
| [749](#L749) |  |
| [750](#L750) | // Let's start by initializing all the data points to zero |
| [751](#L751) | for ($i = 0; $i < $params['data\_points\_count']; $i++) { |
| [752](#L752) | $v1\_label = date($params['data\_points\_label'], strtotime("+$i {$params[ 'granularity' ]}", self::$filters\_normalized['utime']['start'])); |
| [753](#L753) | $v3\_label = date($params['data\_points\_label'], strtotime("+$i {$params[ 'granularity' ]}", $params['previous\_start'])); |
| [754](#L754) |  |
| [755](#L755) | $output['keys'][$v1\_label] = $i; |
| [756](#L756) | $output['keys'][$v3\_label] = $i; |
| [757](#L757) |  |
| [758](#L758) | $output['labels'][] = "'$v1\_label'"; |
| [759](#L759) |  |
| [760](#L760) | // This is how AmCharts expects the data to be formatted |
| [761](#L761) | $output['datasets']['v1'][] = $output['datasets']['v2'][] = $output['datasets']['v3'][] = $output['datasets']['v4'][] = 0; |
| [762](#L762) | } |
| [763](#L763) |  |
| [764](#L764) | // Now populate all the data points |
| [765](#L765) | foreach ($results as $a\_result) { |
| [766](#L766) | $label = date($params['data\_points\_label'], $a\_result['dt']); |
| [767](#L767) |  |
| [768](#L768) | // Data out of range? |
| [769](#L769) | if (!isset($output['keys'][$label])) { |
| [770](#L770) | continue; |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | // Does this value belong to the "current" range? |
| [774](#L774) | if ($a\_result['dt'] >= self::$filters\_normalized['utime']['start'] && $a\_result['dt'] <= self::$filters\_normalized['utime']['end']) { |
| [775](#L775) | $output['datasets']['v1'][$output['keys'][$label]] = intval($a\_result['v1']); |
| [776](#L776) | $output['datasets']['v2'][$output['keys'][$label]] = intval($a\_result['v2']); |
| [777](#L777) | } else { |
| [778](#L778) | $output['datasets']['v3'][$output['keys'][$label]] = intval($a\_result['v1']); |
| [779](#L779) | $output['datasets']['v4'][$output['keys'][$label]] = intval($a\_result['v2']); |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) |  |
| [783](#L783) | return $output; |
| [784](#L784) | } |
| [785](#L785) |  |
| [786](#L786) | public static function get\_data\_size() |
| [787](#L787) | { |
| [788](#L788) | $suffix = 'KB'; |
| [789](#L789) |  |
| [790](#L790) | $sql           = 'SHOW TABLE STATUS LIKE "' . $GLOBALS['wpdb']->prefix . 'slim\_stats"'; |
| [791](#L791) | $table\_details = wp\_slimstat::$wpdb->get\_row($sql, 'ARRAY\_A', 0); |
| [792](#L792) |  |
| [793](#L793) | $table\_size = ($table\_details['Data\_length'] / 1024) + ($table\_details['Index\_length'] / 1024); |
| [794](#L794) |  |
| [795](#L795) | if ($table\_size > 1024) { |
| [796](#L796) | $table\_size /= 1024; |
| [797](#L797) | $suffix     = 'MB'; |
| [798](#L798) | } |
| [799](#L799) | return number\_format\_i18n($table\_size, 2) . ' ' . $suffix; |
| [800](#L800) | } |
| [801](#L801) |  |
| [802](#L802) | public static function get\_group\_by($\_args = array()) |
| [803](#L803) | { |
| [804](#L804) | $where = self::get\_combined\_where(); |
| [805](#L805) |  |
| [806](#L806) | if (empty($\_args['column\_group'])) { |
| [807](#L807) | $\_args['column\_group'] = 'id'; |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | if (empty($\_args['group\_by'])) { |
| [811](#L811) | $\_args['group\_by'] = 'id'; |
| [812](#L812) | } |
| [813](#L813) |  |
| [814](#L814) | // prepare the query |
| [815](#L815) | $sql = $GLOBALS['wpdb']->prepare(" |
| [816](#L816) | SELECT {$\_args[ 'group\_by' ]}, COUNT(\*) AS counthits, GROUP\_CONCAT( DISTINCT {$\_args[ 'column\_group' ]} SEPARATOR ';;;' ) as column\_group |
| [817](#L817) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [818](#L818) | WHERE $where AND {$\_args[ 'group\_by' ]} IS NOT NULL |
| [819](#L819) | GROUP BY {$\_args[ 'group\_by' ]} |
| [820](#L820) | ORDER BY counthits DESC |
| [821](#L821) | LIMIT 0, %d", self::$filters\_normalized['misc']['limit\_results']); |
| [822](#L822) | return self::get\_results($sql, $\_args['group\_by'],$\_args['group\_by'] . ' ASC'); |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | public static function get\_max\_and\_average\_pages\_per\_visit() |
| [826](#L826) | { |
| [827](#L827) | $where = self::get\_combined\_where('visit\_id > 0'); |
| [828](#L828) |  |
| [829](#L829) | return self::get\_results(" |
| [830](#L830) | SELECT AVG(ts1.counthits) AS avghits, MAX(ts1.counthits) AS maxhits FROM ( |
| [831](#L831) | SELECT count(ip) counthits, visit\_id |
| [832](#L832) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [833](#L833) | WHERE $where |
| [834](#L834) | GROUP BY visit\_id |
| [835](#L835) | ) AS ts1", |
| [836](#L836) | 'blog\_id', |
| [837](#L837) | '', |
| [838](#L838) | '', |
| [839](#L839) | 'AVG(avghits) AS avghits, MAX(maxhits) AS maxhits'); |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | public static function get\_oldest\_visit() |
| [843](#L843) | { |
| [844](#L844) | return self::get\_var(" |
| [845](#L845) | SELECT dt |
| [846](#L846) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [847](#L847) | ORDER BY dt ASC |
| [848](#L848) | LIMIT 0, 1", |
| [849](#L849) | 'MIN(dt)'); |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | public static function get\_overview\_summary() |
| [853](#L853) | { |
| [854](#L854) | $days\_in\_range = ceil((wp\_slimstat\_db::$filters\_normalized['utime']['end'] - wp\_slimstat\_db::$filters\_normalized['utime']['start']) / 86400); |
| [855](#L855) | $results       = array(); |
| [856](#L856) |  |
| [857](#L857) | // Turn date\_i18n filters off |
| [858](#L858) | wp\_slimstat::toggle\_date\_i18n\_filters(false); |
| [859](#L859) |  |
| [860](#L860) | $results[0]['metric']  = \_\_('Pageviews', 'wp-slimstat'); |
| [861](#L861) | $results[0]['value']   = number\_format\_i18n(self::$pageviews, 0); |
| [862](#L862) | $results[0]['tooltip'] = \_\_('A pageview is a request to load a single HTML page on your website.', 'wp-slimstat'); |
| [863](#L863) |  |
| [864](#L864) | $results[1]['metric'] = \_\_('Days in Range', 'wp-slimstat'); |
| [865](#L865) | $results[1]['value']  = $days\_in\_range; |
| [866](#L866) |  |
| [867](#L867) | $results[2]['metric']  = \_\_('Average Daily Pageviews', 'wp-slimstat'); |
| [868](#L868) | $results[2]['value']   = number\_format\_i18n(round(self::$pageviews / $days\_in\_range, 0)); |
| [869](#L869) | $results[2]['tooltip'] = \_\_('How many daily pageviews have been generated on average.', 'wp-slimstat'); |
| [870](#L870) |  |
| [871](#L871) | $results[3]['metric']  = \_\_('From Any SERP', 'wp-slimstat'); |
| [872](#L872) | $results[3]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('id', 'searchterms IS NOT NULL')); |
| [873](#L873) | $results[3]['tooltip'] = \_\_('Visitors who landed on your site after searching for a keyword on a search engine and clicking on the corresponding search result link. This value includes both internal and external search result pages.', 'wp-slimstat'); |
| [874](#L874) |  |
| [875](#L875) | $results[4]['metric']  = \_\_('Unique IPs', 'wp-slimstat'); |
| [876](#L876) | $results[4]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('ip')); |
| [877](#L877) | $results[4]['tooltip'] = \_\_('Used to differentiate between multiple requests to download a file from one internet address (IP) and requests originating from many distinct addresses.', 'wp-slimstat'); |
| [878](#L878) |  |
| [879](#L879) | $results[5]['metric'] = \_\_('Last 30 minutes', 'wp-slimstat'); |
| [880](#L880) | $results[5]['value']  = number\_format\_i18n(wp\_slimstat\_db::count\_records('id', 'dt > ' . (date\_i18n('U') - 1800), false)); |
| [881](#L881) |  |
| [882](#L882) | $results[6]['metric'] = \_\_('Today', 'wp-slimstat'); |
| [883](#L883) | $results[6]['value']  = number\_format\_i18n(wp\_slimstat\_db::count\_records('id', 'dt > ' . (date\_i18n('U', mktime(0, 0, 0, date\_i18n('m'), date\_i18n('d'), date\_i18n('Y')))), false)); |
| [884](#L884) |  |
| [885](#L885) | $results[7]['metric'] = \_\_('Yesterday', 'wp-slimstat'); |
| [886](#L886) | $results[7]['value']  = number\_format\_i18n(wp\_slimstat\_db::count\_records('id', 'dt BETWEEN ' . (date\_i18n('U', mktime(0, 0, 0, date\_i18n('m'), date\_i18n('d') - 1, date\_i18n('Y')))) . ' AND ' . (date\_i18n('U', mktime(23, 59, 59, date\_i18n('m'), date\_i18n('d') - 1, date\_i18n('Y')))), false)); |
| [887](#L887) |  |
| [888](#L888) | // Turn date\_i18n filters back on |
| [889](#L889) | wp\_slimstat::toggle\_date\_i18n\_filters(true); |
| [890](#L890) |  |
| [891](#L891) | return $results; |
| [892](#L892) | } |
| [893](#L893) |  |
| [894](#L894) | public static function get\_recent($\_column = 'id', $\_where = '', $\_having = '', $\_use\_date\_filters = true, $\_as\_column = '', $\_more\_columns = '', $\_order\_by = 'dt DESC') |
| [895](#L895) | { |
| [896](#L896) | // This function can be passed individual arguments, or an array of arguments |
| [897](#L897) | if (is\_array($\_column)) { |
| [898](#L898) | $\_where            = !empty($\_column['where']) ? $\_column['where'] : ''; |
| [899](#L899) | $\_having           = !empty($\_column['having']) ? $\_column['having'] : ''; |
| [900](#L900) | $\_use\_date\_filters = isset($\_column['use\_date\_filters']) ? $\_column['use\_date\_filters'] : true; |
| [901](#L901) | $\_as\_column        = !empty($\_column['as\_column']) ? $\_column['as\_column'] : ''; |
| [902](#L902) | $\_more\_columns     = !empty($\_column['more\_columns']) ? $\_column['more\_columns'] : ''; |
| [903](#L903) | $\_order\_by         = !empty($\_column['order\_by']) ? $\_column['order\_by'] : 'dt DESC'; |
| [904](#L904) | $\_column           = $\_column['columns']; |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | $columns = $\_column; |
| [908](#L908) | if (!empty($\_as\_column)) { |
| [909](#L909) | $columns = "$\_column AS $\_as\_column"; |
| [910](#L910) | } |
| [911](#L911) |  |
| [912](#L912) | // Add the IP column, used to display details about that visit |
| [913](#L913) | if ($\_column != 'ip') { |
| [914](#L914) | $columns .= ', ip'; |
| [915](#L915) | } |
| [916](#L916) |  |
| [917](#L917) | if ($\_column != '\*') { |
| [918](#L918) | $columns  .= ', dt'; |
| [919](#L919) | $group\_by = 'GROUP BY ' . $\_column; |
| [920](#L920) | } else { |
| [921](#L921) | $columns  = 'id, ip, other\_ip, username, email, country, city, location, referer, resource, searchterms, notes, visit\_id, server\_latency, page\_performance, browser, browser\_version, browser\_type, platform, language, fingerprint, user\_agent, resolution, screen\_width, screen\_height, content\_type, category, author, content\_id, outbound\_resource, tz\_offset, dt\_out, dt'; |
| [922](#L922) | $group\_by = ''; |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | if (!empty($\_more\_columns)) { |
| [926](#L926) | $columns .= ', ' . $\_more\_columns; |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | $\_where = self::get\_combined\_where($\_where, $\_column, $\_use\_date\_filters); |
| [930](#L930) |  |
| [931](#L931) | // prepare the query |
| [932](#L932) | $sql = $GLOBALS['wpdb']->prepare(" |
| [933](#L933) | SELECT $columns |
| [934](#L934) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [935](#L935) | WHERE $\_where |
| [936](#L936) | $group\_by |
| [937](#L937) | ORDER BY $\_order\_by |
| [938](#L938) | LIMIT 0, %d", self::$filters\_normalized['misc']['limit\_results']); |
| [939](#L939) | return self::get\_results($sql, $columns, 'dt DESC'); |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | public static function get\_recent\_events() |
| [943](#L943) | { |
| [944](#L944) | return self::get\_results(" |
| [945](#L945) | SELECT te.\*, t1.ip, t1.resource |
| [946](#L946) | FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_events te INNER JOIN {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats t1 ON te.id = t1.id |
| [947](#L947) | WHERE " . wp\_slimstat\_db::get\_combined\_where('te.notes NOT LIKE "\_ype:click%"', 'te.notes', true, 't1') . " |
| [948](#L948) | ORDER BY te.dt DESC", |
| [949](#L949) | 'te.\*, t1.resource', |
| [950](#L950) | 'dt DESC' |
| [951](#L951) | ); |
| [952](#L952) | } |
| [953](#L953) |  |
| [954](#L954) | public static function get\_recent\_outbound() |
| [955](#L955) | { |
| [956](#L956) | $mixed\_outbound\_resources = self::get\_recent('outbound\_resource'); |
| [957](#L957) | $clean\_outbound\_resources = array(); |
| [958](#L958) |  |
| [959](#L959) | foreach ($mixed\_outbound\_resources as $a\_mixed\_resource) { |
| [960](#L960) | $exploded\_resources = explode(';;;', $a\_mixed\_resource['outbound\_resource']); |
| [961](#L961) | foreach ($exploded\_resources as $a\_exploded\_resource) { |
| [962](#L962) | $a\_mixed\_resource['outbound\_resource'] = $a\_exploded\_resource; |
| [963](#L963) | $clean\_outbound\_resources[]            = $a\_mixed\_resource; |
| [964](#L964) | } |
| [965](#L965) | } |
| [966](#L966) |  |
| [967](#L967) | return $clean\_outbound\_resources; |
| [968](#L968) | } |
| [969](#L969) |  |
| [970](#L970) | public static function get\_top($\_column = 'id', $\_where = '', $\_having = '', $\_use\_date\_filters = true, $\_as\_column = '') |
| [971](#L971) | { |
| [972](#L972) | // This function can be passed individual arguments, or an array of arguments |
| [973](#L973) | if (is\_array($\_column)) { |
| [974](#L974) | $\_where            = !empty($\_column['where']) ? $\_column['where'] : ''; |
| [975](#L975) | $\_having           = !empty($\_column['having']) ? $\_column['having'] : ''; |
| [976](#L976) | $\_use\_date\_filters = !empty($\_column['use\_date\_filters']) ? $\_column['use\_date\_filters'] : true; |
| [977](#L977) | $\_as\_column        = !empty($\_column['as\_column']) ? $\_column['as\_column'] : ''; |
| [978](#L978) | $\_column           = $\_column['columns']; |
| [979](#L979) | } |
| [980](#L980) |  |
| [981](#L981) | $group\_by\_column = $\_column; |
| [982](#L982) |  |
| [983](#L983) | if (!empty($\_as\_column)) { |
| [984](#L984) | $\_column = "$\_column AS $\_as\_column"; |
| [985](#L985) | } else { |
| [986](#L986) | $\_as\_column = $\_column; |
| [987](#L987) | } |
| [988](#L988) |  |
| [989](#L989) | $\_where = self::get\_combined\_where($\_where, $\_as\_column, $\_use\_date\_filters); |
| [990](#L990) |  |
| [991](#L991) | // prepare the query |
| [992](#L992) | $sql = $GLOBALS['wpdb']->prepare(" |
| [993](#L993) | SELECT $\_column, COUNT(\*) counthits |
| [994](#L994) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [995](#L995) | WHERE $\_where |
| [996](#L996) | GROUP BY $group\_by\_column $\_having |
| [997](#L997) | ORDER BY counthits DESC |
| [998](#L998) | LIMIT 0, %d", self::$filters\_normalized['misc']['limit\_results']); |
| [999](#L999) | return self::get\_results($sql, ((!empty($\_as\_column) && $\_as\_column != $\_column) ? $\_as\_column : $\_column), |
| [1000](#L1000) | 'counthits DESC', ((!empty($\_as\_column) && $\_as\_column != $\_column) ? $\_as\_column : $\_column), |
| [1001](#L1001) | 'SUM(counthits) AS counthits'); |
| [1002](#L1002) | } |
| [1003](#L1003) |  |
| [1004](#L1004) | public static function get\_top\_aggr($\_column = 'id', $\_where = '', $\_outer\_select\_column = '', $\_aggr\_function = 'MAX') |
| [1005](#L1005) | { |
| [1006](#L1006) | if (is\_array($\_column)) { |
| [1007](#L1007) | $\_where               = !empty($\_column['where']) ? $\_column['where'] : ''; |
| [1008](#L1008) | $\_having              = !empty($\_column['having']) ? $\_column['having'] : ''; |
| [1009](#L1009) | $\_use\_date\_filters    = !empty($\_column['use\_date\_filters']) ? $\_column['use\_date\_filters'] : true; |
| [1010](#L1010) | $\_as\_column           = !empty($\_column['as\_column']) ? $\_column['as\_column'] : ''; |
| [1011](#L1011) | $\_outer\_select\_column = !empty($\_column['outer\_select\_column']) ? $\_column['outer\_select\_column'] : ''; |
| [1012](#L1012) | $\_aggr\_function       = !empty($\_column['aggr\_function']) ? $\_column['aggr\_function'] : ''; |
| [1013](#L1013) | $\_column              = $\_column['columns']; |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | if (!empty($\_as\_column)) { |
| [1017](#L1017) | $\_column = "$\_column AS $\_as\_column"; |
| [1018](#L1018) | } else { |
| [1019](#L1019) | $\_as\_column = $\_column; |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) | $\_where = self::get\_combined\_where($\_where, $\_column); |
| [1023](#L1023) |  |
| [1024](#L1024) | // prepare the query |
| [1025](#L1025) | $sql = $GLOBALS['wpdb']->prepare(" |
| [1026](#L1026) | SELECT $\_outer\_select\_column, ts1.aggrid as $\_column, COUNT(\*) counthits |
| [1027](#L1027) | FROM ( |
| [1028](#L1028) | SELECT $\_column, $\_aggr\_function(id) aggrid |
| [1029](#L1029) | FROM {$GLOBALS['wpdb']->prefix}slim\_stats |
| [1030](#L1030) | WHERE $\_where |
| [1031](#L1031) | GROUP BY $\_column |
| [1032](#L1032) | ) AS ts1 JOIN {$GLOBALS['wpdb']->prefix}slim\_stats t1 ON ts1.aggrid = t1.id |
| [1033](#L1033) | GROUP BY $\_outer\_select\_column |
| [1034](#L1034) | ORDER BY counthits DESC |
| [1035](#L1035) | LIMIT 0, %d", self::$filters\_normalized['misc']['limit\_results']); |
| [1036](#L1036) | return self::get\_results($sql, $\_outer\_select\_column, 'counthits DESC', $\_outer\_select\_column, "$\_aggr\_function(aggrid), SUM(counthits)"); |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | public static function get\_top\_events() |
| [1040](#L1040) | { |
| [1041](#L1041) | if (empty(self::$filters\_normalized['columns'])) { |
| [1042](#L1042) | $from  = "{$GLOBALS['wpdb']->prefix}slim\_events te"; |
| [1043](#L1043) | $where = wp\_slimstat\_db::get\_combined\_where('notes NOT LIKE "type:click%"', 'notes'); |
| [1044](#L1044) | } else { |
| [1045](#L1045) | $from  = "{$GLOBALS['wpdb']->prefix}slim\_events te INNER JOIN {$GLOBALS['wpdb']->prefix}slim\_stats t1 ON te.id = t1.id"; |
| [1046](#L1046) | $where = wp\_slimstat\_db::get\_combined\_where('notes NOT LIKE "\_ype:click%"', 'notes', true, 't1'); |
| [1047](#L1047) | } |
| [1048](#L1048) |  |
| [1049](#L1049) | return self::get\_results(" |
| [1050](#L1050) | SELECT te.notes, COUNT(\*) counthits |
| [1051](#L1051) | FROM $from |
| [1052](#L1052) | WHERE $where |
| [1053](#L1053) | GROUP BY te.notes |
| [1054](#L1054) | ORDER BY counthits DESC", |
| [1055](#L1055) | 'notes', |
| [1056](#L1056) | 'counthits DESC', |
| [1057](#L1057) | 'notes', |
| [1058](#L1058) | 'SUM(counthits) AS counthits' |
| [1059](#L1059) | ); |
| [1060](#L1060) | } |
| [1061](#L1061) |  |
| [1062](#L1062) | public static function get\_top\_outbound() |
| [1063](#L1063) | { |
| [1064](#L1064) | $mixed\_outbound\_resources = self::get\_recent('outbound\_resource'); |
| [1065](#L1065) | $clean\_outbound\_resources = array(); |
| [1066](#L1066) |  |
| [1067](#L1067) | foreach ($mixed\_outbound\_resources as $a\_mixed\_resource) { |
| [1068](#L1068) | $exploded\_resources = explode(';;;', $a\_mixed\_resource['outbound\_resource']); |
| [1069](#L1069) | foreach ($exploded\_resources as $a\_exploded\_resource) { |
| [1070](#L1070) | $clean\_outbound\_resources[] = $a\_exploded\_resource; |
| [1071](#L1071) | } |
| [1072](#L1072) | } |
| [1073](#L1073) |  |
| [1074](#L1074) | $clean\_outbound\_resources = array\_count\_values($clean\_outbound\_resources); |
| [1075](#L1075) | arsort($clean\_outbound\_resources); |
| [1076](#L1076) |  |
| [1077](#L1077) | $sorted\_outbound\_resources = array(); |
| [1078](#L1078) | foreach ($clean\_outbound\_resources as $a\_resource => $a\_count) { |
| [1079](#L1079) | $sorted\_outbound\_resources[] = array( |
| [1080](#L1080) | 'outbound\_resource' => $a\_resource, |
| [1081](#L1081) | 'counthits'         => $a\_count |
| [1082](#L1082) | ); |
| [1083](#L1083) | } |
| [1084](#L1084) |  |
| [1085](#L1085) | return $sorted\_outbound\_resources; |
| [1086](#L1086) | } |
| [1087](#L1087) |  |
| [1088](#L1088) | public static function get\_traffic\_sources\_summary() |
| [1089](#L1089) | { |
| [1090](#L1090) | $results           = array(); |
| [1091](#L1091) | $total\_human\_hits  = wp\_slimstat\_db::count\_records('id', 'visit\_id > 0 AND browser\_type <> 1'); |
| [1092](#L1092) | $new\_visitors      = wp\_slimstat\_db::count\_records\_having('ip', 'visit\_id > 0', 'COUNT(visit\_id) = 1'); |
| [1093](#L1093) | $new\_visitors\_rate = ($total\_human\_hits > 0) ? sprintf("%01.2f", (100 \* $new\_visitors / $total\_human\_hits)) : 0; |
| [1094](#L1094) | $server\_name       = sanitize\_text\_field(wp\_unslash($\_SERVER['SERVER\_NAME'])); |
| [1095](#L1095) |  |
| [1096](#L1096) | if (intval($new\_visitors\_rate) > 99) { |
| [1097](#L1097) | $new\_visitors\_rate = '100'; |
| [1098](#L1098) | } |
| [1099](#L1099) |  |
| [1100](#L1100) | $results[0]['metric']  = \_\_('Pageviews', 'wp-slimstat'); |
| [1101](#L1101) | $results[0]['value']   = number\_format\_i18n(self::$pageviews); |
| [1102](#L1102) | $results[0]['tooltip'] = \_\_('A pageview is a request to load a single HTML page on your website.', 'wp-slimstat'); |
| [1103](#L1103) |  |
| [1104](#L1104) | $results[1]['metric']  = \_\_('Unique Referrers', 'wp-slimstat'); |
| [1105](#L1105) | $results[1]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('referer', "referer NOT LIKE '%{$server\_name}%'")); |
| [1106](#L1106) | $results[1]['tooltip'] = \_\_('A referrer (or referring site) is a site that a visitor previously visited before following a link to your site.', 'wp-slimstat'); |
| [1107](#L1107) |  |
| [1108](#L1108) | $results[2]['metric']  = \_\_('Direct Pageviews', 'wp-slimstat'); |
| [1109](#L1109) | $results[2]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('id', 'resource IS NULL')); |
| [1110](#L1110) | $results[2]['tooltip'] = \_\_("Visitors who typed your website URL directly into their browser address bar. It can also refer to visitors who clicked on one of their bookmarked links, untagged links within emails, or links in documents that don't include tracking variables.", 'wp-slimstat'); |
| [1111](#L1111) |  |
| [1112](#L1112) | $results[3]['metric']  = \_\_('From External SERP', 'wp-slimstat'); |
| [1113](#L1113) | $results[3]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('id', "searchterms IS NOT NULL AND referer IS NOT NULL AND referer NOT LIKE '%" . home\_url() . "%'")); |
| [1114](#L1114) | $results[3]['tooltip'] = \_\_("Visitors who clicked on a link to your website listed on a search engine result page (SERP). This metric only counts visits coming from EXTERNAL search pages.", 'wp-slimstat'); |
| [1115](#L1115) |  |
| [1116](#L1116) | $results[4]['metric']  = \_\_('Unique Landing Pages', 'wp-slimstat'); |
| [1117](#L1117) | $results[4]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('resource')); |
| [1118](#L1118) | $results[4]['tooltip'] = \_\_("A landing page is the first page on your website that a visitors opens, also known as <em>entrance page</em>. For example, if they search for 'Brooklyn Office Space,' and they land on a page on your website, this page gets counted (for that visit) as a landing page.", 'wp-slimstat'); |
| [1119](#L1119) |  |
| [1120](#L1120) | $results[5]['metric']  = \_\_('Bounce Pages', 'wp-slimstat'); |
| [1121](#L1121) | $results[5]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_bouncing\_pages()); |
| [1122](#L1122) | $results[5]['tooltip'] = \_\_('Number of single-page visits tracked over the selected period of time.', 'wp-slimstat'); |
| [1123](#L1123) |  |
| [1124](#L1124) | $results[6]['metric']  = \_\_('New Visitors Rate', 'wp-slimstat'); |
| [1125](#L1125) | $results[6]['value']   = number\_format\_i18n($new\_visitors\_rate, 2); |
| [1126](#L1126) | $results[6]['tooltip'] = \_\_('Percentage of single-page visits, i.e. visits in which the person left your site from the entrance page.', 'wp-slimstat'); |
| [1127](#L1127) |  |
| [1128](#L1128) | $results[7]['metric']  = \_\_('Currently from search engines', 'wp-slimstat'); |
| [1129](#L1129) | $results[7]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('id', "searchterms IS NOT NULL  AND referer IS NOT NULL AND referer NOT LIKE '%" . home\_url() . "%' AND dt > UNIX\_TIMESTAMP() - 300", false)); |
| [1130](#L1130) | $results[7]['tooltip'] = \_\_('Visitors who clicked on a link to your website listed on a search engine result page (SERP), tracked in the last 5 minutes.', 'wp-slimstat'); |
| [1131](#L1131) |  |
| [1132](#L1132) | return $results; |
| [1133](#L1133) | } |
| [1134](#L1134) |  |
| [1135](#L1135) | public static function get\_visits\_duration() |
| [1136](#L1136) | { |
| [1137](#L1137) | $total\_human\_visits = wp\_slimstat\_db::count\_records('visit\_id', 'visit\_id > 0 AND browser\_type <> 1'); |
| [1138](#L1138) | $results            = array(); |
| [1139](#L1139) |  |
| [1140](#L1140) | $count\_results         = wp\_slimstat\_db::count\_records\_having('visit\_id', 'visit\_id > 0 AND browser\_type <> 1', '       GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) >= 0 AND GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) <= 30'); |
| [1141](#L1141) | $average\_time          = 30 \* $count\_results; |
| [1142](#L1142) | $results[0]['metric']  = \_\_('0 - 30 seconds', 'wp-slimstat'); |
| [1143](#L1143) | $results[0]['value']   = (($total\_human\_visits > 0) ? number\_format\_i18n((100 \* $count\_results / $total\_human\_visits), 2) : 0) . '%'; |
| [1144](#L1144) | $results[0]['details'] = \_\_('Hits', 'wp-slimstat') . ": $count\_results"; |
| [1145](#L1145) |  |
| [1146](#L1146) | $count\_results         = wp\_slimstat\_db::count\_records\_having('visit\_id', 'visit\_id > 0 AND browser\_type <> 1', 'GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) > 30 AND GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) <= 60'); |
| [1147](#L1147) | $average\_time          += 60 \* $count\_results; |
| [1148](#L1148) | $results[1]['metric']  = \_\_('31 - 60 seconds', 'wp-slimstat'); |
| [1149](#L1149) | $results[1]['value']   = (($total\_human\_visits > 0) ? number\_format\_i18n((100 \* $count\_results / $total\_human\_visits), 2) : 0) . '%'; |
| [1150](#L1150) | $results[1]['details'] = \_\_('Hits', 'wp-slimstat') . ": $count\_results"; |
| [1151](#L1151) |  |
| [1152](#L1152) | $count\_results         = wp\_slimstat\_db::count\_records\_having('visit\_id', 'visit\_id > 0 AND browser\_type <> 1', 'GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) > 60 AND GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) <= 180'); |
| [1153](#L1153) | $average\_time          += 180 \* $count\_results; |
| [1154](#L1154) | $results[2]['metric']  = \_\_('1 - 3 minutes', 'wp-slimstat'); |
| [1155](#L1155) | $results[2]['value']   = (($total\_human\_visits > 0) ? number\_format\_i18n((100 \* $count\_results / $total\_human\_visits), 2) : 0) . '%'; |
| [1156](#L1156) | $results[2]['details'] = \_\_('Hits', 'wp-slimstat') . ": $count\_results"; |
| [1157](#L1157) |  |
| [1158](#L1158) | $count\_results         = wp\_slimstat\_db::count\_records\_having('visit\_id', 'visit\_id > 0 AND browser\_type <> 1', 'GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) > 180 AND GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) <= 300'); |
| [1159](#L1159) | $average\_time          += 300 \* $count\_results; |
| [1160](#L1160) | $results[3]['metric']  = \_\_('3 - 5 minutes', 'wp-slimstat'); |
| [1161](#L1161) | $results[3]['value']   = (($total\_human\_visits > 0) ? number\_format\_i18n((100 \* $count\_results / $total\_human\_visits), 2) : 0) . '%'; |
| [1162](#L1162) | $results[3]['details'] = \_\_('Hits', 'wp-slimstat') . ": $count\_results"; |
| [1163](#L1163) |  |
| [1164](#L1164) | $count\_results         = wp\_slimstat\_db::count\_records\_having('visit\_id', 'visit\_id > 0 AND browser\_type <> 1', 'GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) > 300 AND GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) <= 420'); |
| [1165](#L1165) | $average\_time          += 420 \* $count\_results; |
| [1166](#L1166) | $results[4]['metric']  = \_\_('5 - 7 minutes', 'wp-slimstat'); |
| [1167](#L1167) | $results[4]['value']   = (($total\_human\_visits > 0) ? number\_format\_i18n((100 \* $count\_results / $total\_human\_visits), 2) : 0) . '%'; |
| [1168](#L1168) | $results[4]['details'] = \_\_('Hits', 'wp-slimstat') . ": $count\_results"; |
| [1169](#L1169) |  |
| [1170](#L1170) | $count\_results         = wp\_slimstat\_db::count\_records\_having('visit\_id', 'visit\_id > 0 AND browser\_type <> 1', 'GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) > 420 AND GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) <= 600'); |
| [1171](#L1171) | $average\_time          += 600 \* $count\_results; |
| [1172](#L1172) | $results[5]['metric']  = \_\_('7 - 10 minutes', 'wp-slimstat'); |
| [1173](#L1173) | $results[5]['value']   = (($total\_human\_visits > 0) ? number\_format\_i18n((100 \* $count\_results / $total\_human\_visits), 2) : 0) . '%'; |
| [1174](#L1174) | $results[5]['details'] = \_\_('Hits', 'wp-slimstat') . ": $count\_results"; |
| [1175](#L1175) |  |
| [1176](#L1176) | $count\_results         = wp\_slimstat\_db::count\_records\_having('visit\_id', 'visit\_id > 0 AND browser\_type <> 1', 'GREATEST( MAX( dt ), MAX( dt\_out ) ) - MIN( dt ) > 600'); |
| [1177](#L1177) | $average\_time          += 900 \* $count\_results; |
| [1178](#L1178) | $results[6]['metric']  = \_\_('More than 10 minutes', 'wp-slimstat'); |
| [1179](#L1179) | $results[6]['value']   = (($total\_human\_visits > 0) ? number\_format\_i18n((100 \* $count\_results / $total\_human\_visits), 2) : 0) . '%'; |
| [1180](#L1180) | $results[6]['details'] = \_\_('Hits', 'wp-slimstat') . ": $count\_results"; |
| [1181](#L1181) |  |
| [1182](#L1182) | if ($total\_human\_visits > 0) { |
| [1183](#L1183) | $average\_time /= $total\_human\_visits; |
| [1184](#L1184) | $average\_time = date('m:s', intval($average\_time)); |
| [1185](#L1185) | } else { |
| [1186](#L1186) | $average\_time = '0:00'; |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | $results[7]['metric']  = \_\_('Average Visit Duration', 'wp-slimstat'); |
| [1190](#L1190) | $results[7]['value']   = $average\_time; |
| [1191](#L1191) | $results[7]['details'] = ''; |
| [1192](#L1192) |  |
| [1193](#L1193) | return $results; |
| [1194](#L1194) | } |
| [1195](#L1195) |  |
| [1196](#L1196) | public static function get\_visitors\_summary() |
| [1197](#L1197) | { |
| [1198](#L1198) | $results            = array(); |
| [1199](#L1199) | $total\_visits       = wp\_slimstat\_db::count\_records('visit\_id', 'browser\_type <> 1'); |
| [1200](#L1200) | $single\_page\_visits = wp\_slimstat\_db::count\_records\_having('visit\_id', 'browser\_type <> 1', 'COUNT(id) = 1'); |
| [1201](#L1201) |  |
| [1202](#L1202) | $bounce\_rate       = ($total\_visits > 0) ? (100 \* $single\_page\_visits / $total\_visits) : 0; |
| [1203](#L1203) | $metrics\_per\_visit = wp\_slimstat\_db::get\_max\_and\_average\_pages\_per\_visit(); |
| [1204](#L1204) | if (empty($metrics\_per\_visit[0])) { |
| [1205](#L1205) | $metrics\_per\_visit[0] = array('avghits' => 0, 'maxhits' => 0); |
| [1206](#L1206) | } |
| [1207](#L1207) | if (intval($bounce\_rate) > 99) { |
| [1208](#L1208) | $bounce\_rate = '100'; |
| [1209](#L1209) | } |
| [1210](#L1210) |  |
| [1211](#L1211) | $results[0]['metric']  = \_\_('Visits', 'wp-slimstat'); |
| [1212](#L1212) | $results[0]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('visit\_id', 'visit\_id > 0 AND browser\_type <> 1')); |
| [1213](#L1213) | $results[0]['tooltip'] = \_\_('A visit is a group of pageviews within a 30-minute time span. Returning visitors are counted multiple times if they start a new visit.', 'wp-slimstat'); |
| [1214](#L1214) |  |
| [1215](#L1215) | $results[1]['metric']  = \_\_('Unique IPs', 'wp-slimstat'); |
| [1216](#L1216) | $results[1]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('ip', 'visit\_id > 0 AND browser\_type <> 1')); |
| [1217](#L1217) | $results[1]['tooltip'] = \_\_('It includes only traffic generated by human visitors.', 'wp-slimstat'); |
| [1218](#L1218) |  |
| [1219](#L1219) | $results[2]['metric']  = \_\_('Bounce rate', 'wp-slimstat'); |
| [1220](#L1220) | $results[2]['value']   = number\_format\_i18n($bounce\_rate, 2); |
| [1221](#L1221) | $results[2]['tooltip'] = \_\_('Total number of one-page visits divided by the total number of entries to a website. Please see the <a href="https://support.google.com/analytics/answer/1009409?hl=en" target="\_blank">official Google docs</a> for more information.', 'wp-slimstat'); |
| [1222](#L1222) |  |
| [1223](#L1223) | $results[3]['metric']  = \_\_('Known visitors', 'wp-slimstat'); |
| [1224](#L1224) | $results[3]['value']   = number\_format\_i18n(wp\_slimstat\_db::count\_records('username')); |
| [1225](#L1225) | $results[3]['tooltip'] = \_\_('Visitors who have previously left a comment on your blog.', 'wp-slimstat'); |
| [1226](#L1226) |  |
| [1227](#L1227) | $results[4]['metric']  = \_\_('Single-page Visits', 'wp-slimstat'); |
| [1228](#L1228) | $results[4]['value']   = number\_format\_i18n($single\_page\_visits); |
| [1229](#L1229) | $results[4]['tooltip'] = \_\_('Human users that generated one single page view on your website.', 'wp-slimstat'); |
| [1230](#L1230) |  |
| [1231](#L1231) | $results[5]['metric'] = \_\_('Bots', 'wp-slimstat'); |
| [1232](#L1232) | $results[5]['value']  = number\_format\_i18n(wp\_slimstat\_db::count\_records('id', 'browser\_type = 1')); |
| [1233](#L1233) |  |
| [1234](#L1234) | $results[6]['metric'] = \_\_('Pageviews per visit', 'wp-slimstat'); |
| [1235](#L1235) | $results[6]['value']  = number\_format\_i18n($metrics\_per\_visit[0]['avghits'], 2); |
| [1236](#L1236) |  |
| [1237](#L1237) | $results[7]['metric'] = \_\_('Longest visit', 'wp-slimstat'); |
| [1238](#L1238) | $results[7]['value']  = number\_format\_i18n($metrics\_per\_visit[0]['maxhits']) . ' ' . \_\_('hits', 'wp-slimstat'); |
| [1239](#L1239) |  |
| [1240](#L1240) | return $results; |
| [1241](#L1241) | } |
| [1242](#L1242) |  |
| [1243](#L1243) | public static function get\_your\_blog() |
| [1244](#L1244) | { |
| [1245](#L1245) | if (false === ($results = get\_transient('slimstat\_your\_content'))) { |
| [1246](#L1246) | $results = array(); |
| [1247](#L1247) |  |
| [1248](#L1248) | $results[0]['metric']  = \_\_('Content Items', 'wp-slimstat'); |
| [1249](#L1249) | $results[0]['value']   = number\_format\_i18n($GLOBALS['wpdb']->get\_var("SELECT COUNT(\*) FROM {$GLOBALS['wpdb']->posts} WHERE post\_type <> 'revision' AND post\_status <> 'auto-draft'")); |
| [1250](#L1250) | $results[0]['tooltip'] = \_\_('This value includes not only posts and pages, but any custom post type, regardless of their status.', 'wp-slimstat'); |
| [1251](#L1251) |  |
| [1252](#L1252) | $results[1]['metric'] = \_\_('Posts', 'wp-slimstat'); |
| [1253](#L1253) | $results[1]['value']  = $GLOBALS['wpdb']->get\_var("SELECT COUNT(\*) FROM {$GLOBALS['wpdb']->posts} WHERE post\_type = 'post'"); |
| [1254](#L1254) |  |
| [1255](#L1255) | $results[2]['metric'] = \_\_('Pages', 'wp-slimstat'); |
| [1256](#L1256) | $results[2]['value']  = number\_format\_i18n($GLOBALS['wpdb']->get\_var("SELECT COUNT(\*) FROM {$GLOBALS['wpdb']->posts} WHERE post\_type = 'page'")); |
| [1257](#L1257) |  |
| [1258](#L1258) | $results[3]['metric'] = \_\_('Attachments', 'wp-slimstat'); |
| [1259](#L1259) | $results[3]['value']  = number\_format\_i18n($GLOBALS['wpdb']->get\_var("SELECT COUNT(\*) FROM {$GLOBALS['wpdb']->posts} WHERE post\_type = 'attachment'")); |
| [1260](#L1260) |  |
| [1261](#L1261) | $results[4]['metric'] = \_\_('Revisions', 'wp-slimstat'); |
| [1262](#L1262) | $results[4]['value']  = number\_format\_i18n($GLOBALS['wpdb']->get\_var("SELECT COUNT(\*) FROM {$GLOBALS['wpdb']->posts} WHERE post\_type = 'revision'")); |
| [1263](#L1263) |  |
| [1264](#L1264) | $results[5]['metric'] = \_\_('Comments', 'wp-slimstat'); |
| [1265](#L1265) | $results[5]['value']  = $GLOBALS['wpdb']->get\_var("SELECT COUNT( \* ) FROM {$GLOBALS[ 'wpdb' ]->comments}"); |
| [1266](#L1266) |  |
| [1267](#L1267) | $results[6]['metric'] = \_\_('Avg Comments per Post', 'wp-slimstat'); |
| [1268](#L1268) | $results[6]['value']  = !empty($results[1]['value']) ? number\_format\_i18n($results[5]['value'] / $results[1]['value']) : 0; |
| [1269](#L1269) |  |
| [1270](#L1270) | $results[7]['metric']  = \_\_('Avg Server Latency', 'wp-slimstat'); |
| [1271](#L1271) | $results[7]['value']   = number\_format\_i18n(wp\_slimstat::$wpdb->get\_var("SELECT AVG(server\_latency) FROM {$GLOBALS[ 'wpdb' ]->prefix }slim\_stats WHERE server\_latency <> 0")); |
| [1272](#L1272) | $results[7]['tooltip'] = \_\_('Latency is the amount of time it takes for the host server to receive and process a request for a page object. The amount of latency depends largely on how far away the user is from the server.', 'wp-slimstat'); |
| [1273](#L1273) |  |
| [1274](#L1274) | $results[1]['value'] = number\_format\_i18n($results[1]['value']); |
| [1275](#L1275) | $results[5]['value'] = number\_format\_i18n($results[5]['value']); |
| [1276](#L1276) |  |
| [1277](#L1277) | // Store values as transients for 30 minutes |
| [1278](#L1278) | set\_transient('slimstat\_your\_content', $results, 1800); |
| [1279](#L1279) | } |
| [1280](#L1280) |  |
| [1281](#L1281) | return $results; |
| [1282](#L1282) | } |
| [1283](#L1283) |  |
| [1284](#L1284) | protected static function count\_months\_between($min\_timestamp = 0, $max\_timestamp = 0) |
| [1285](#L1285) | { |
| [1286](#L1286) | $i         = 0; |
| [1287](#L1287) | $min\_month = date('Ym', $min\_timestamp); |
| [1288](#L1288) | $max\_month = date('Ym', $max\_timestamp); |
| [1289](#L1289) |  |
| [1290](#L1290) | while ($min\_month <= $max\_month) { |
| [1291](#L1291) | $min\_timestamp = strtotime("+1 month", $min\_timestamp); |
| [1292](#L1292) | $min\_month     = date('Ym', $min\_timestamp); |
| [1293](#L1293) | $i++; |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) | return $i; |
| [1297](#L1297) | } |
| [1298](#L1298) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-slimstat/tags/5.0.8/admin/view/wp-slimstat-db.php?format=txt)
* [Original Format](/export/3222454/wp-slimstat/tags/5.0.8/admin/view/wp-slimstat-db.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


