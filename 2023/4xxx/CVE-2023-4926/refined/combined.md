=== Content from plugins.trac.wordpress.org_00390e2b_20250115_082010.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwoo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php?rev=2970262 "Revision 2970262")
* Next Revision →
* [Blame](/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/woo-bulk-editor/trunk/ext/bulk/bulk.php)

---

# [source:](/browser?order=name "Go to repository root") [woo-bulk-editor](/browser/woo-bulk-editor?order=name "View woo-bulk-editor")/[trunk](/browser/woo-bulk-editor/trunk?order=name "View trunk")/[ext](/browser/woo-bulk-editor/trunk/ext?order=name "View ext")/[bulk](/browser/woo-bulk-editor/trunk/ext/bulk?order=name "View bulk")/[bulk.php](/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php?order=name "View bulk.php")

View diff against:

View revision:

| [Last change](/changeset/3031584/woo-bulk-editor/trunk/ext/bulk/bulk.php "View differences") on this file was [3031584](/changeset/3031584/ "View changeset 3031584"), checked in by RealMag777, [11 months ago](/timeline?from=2024-02-05T11%3A56%3A07Z&precision=second "See timeline at 02/05/2024 11:56:07 AM") |
| --- |
| [​https://bulk-editor.com/update-v-2-1-4-2-v-1-1-4-2/](https://bulk-editor.com/update-v-2-1-4-2-v-1-1-4-2/) |
| **File size:** 48.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (!defined('ABSPATH')) { |
| [3](#L3) | exit; // Exit if accessed directly |
| [4](#L4) | } |
| [5](#L5) |  |
| [6](#L6) | final class WOOBE\_BULK extends WOOBE\_EXT { |
| [7](#L7) |  |
| [8](#L8) | protected $slug = 'bulk'; //unique |
| [9](#L9) | public $text\_keys = array(); |
| [10](#L10) | public $num\_keys = array(); |
| [11](#L11) | public $other\_keys = array(); |
| [12](#L12) |  |
| [13](#L13) | public function \_\_construct() { |
| [14](#L14) |  |
| [15](#L15) | $this->init\_bulk\_keys(); |
| [16](#L16) |  |
| [17](#L17) | add\_action('woobe\_ext\_scripts', array($this, 'woobe\_ext\_scripts'), 1); |
| [18](#L18) | add\_action('woobe\_tools\_panel\_buttons\_end', array($this, 'woobe\_tools\_panel\_buttons\_end'), 1); |
| [19](#L19) |  |
| [20](#L20) | //ajax |
| [21](#L21) | add\_action('wp\_ajax\_woobe\_bulk\_products\_count', array($this, 'woobe\_bulk\_products\_count'), 1); |
| [22](#L22) | add\_action('wp\_ajax\_woobe\_bulk\_products', array($this, 'woobe\_bulk\_products'), 1); |
| [23](#L23) | add\_action('wp\_ajax\_woobe\_bulk\_finish', array($this, 'woobe\_bulk\_finish'), 1); |
| [24](#L24) | add\_action('wp\_ajax\_woobe\_bulk\_draw\_gallery\_btn', array($this, 'woobe\_bulk\_draw\_gallery\_btn'), 1); |
| [25](#L25) | add\_action('wp\_ajax\_woobe\_bulk\_draw\_download\_files\_btn', array($this, 'woobe\_bulk\_draw\_download\_files\_btn'), 1); |
| [26](#L26) | add\_action('wp\_ajax\_woobe\_bulk\_draw\_cross\_sells\_btn', array($this, 'woobe\_bulk\_draw\_cross\_sells\_btn'), 1); |
| [27](#L27) | add\_action('wp\_ajax\_woobe\_bulk\_draw\_upsell\_ids\_btn', array($this, 'woobe\_bulk\_draw\_upsell\_ids\_btn'), 1); |
| [28](#L28) | add\_action('wp\_ajax\_woobe\_bulk\_draw\_grouped\_ids\_btn', array($this, 'woobe\_bulk\_draw\_grouped\_ids\_btn'), 1); |
| [29](#L29) | add\_action('wp\_ajax\_woobe\_bulk\_get\_att\_terms', array($this, 'woobe\_bulk\_get\_att\_terms'), 1); |
| [30](#L30) |  |
| [31](#L31) | add\_action('wp\_ajax\_woobe\_bulk\_delete\_products\_count', array($this, 'woobe\_bulk\_delete\_products\_count'), 1); |
| [32](#L32) | add\_action('wp\_ajax\_woobe\_bulk\_delete\_products', array($this, 'woobe\_bulk\_delete\_products'), 1); |
| [33](#L33) |  |
| [34](#L34) | add\_action('woobe\_bulk\_going', array($this, 'woobe\_bulk\_going'), 10, 2); |
| [35](#L35) |  |
| [36](#L36) | //tabs |
| [37](#L37) | $this->add\_tab($this->slug, 'top\_panel', esc\_html\_\_('Bulk Edit', 'woo-bulk-editor'), 'pencil'); |
| [38](#L38) | add\_action('woobe\_ext\_top\_panel\_' . $this->slug, array($this, 'woobe\_ext\_panel'), 1); |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | public function woobe\_ext\_scripts() { |
| [42](#L42) | wp\_enqueue\_script('woobe\_ext\_' . $this->slug, $this->get\_ext\_link() . 'assets/js/' . $this->slug . '.js', array(), WOOBE\_VERSION); |
| [43](#L43) | wp\_enqueue\_style('woobe\_ext\_' . $this->slug, $this->get\_ext\_link() . 'assets/css/' . $this->slug . '.css', array(), WOOBE\_VERSION); |
| [44](#L44) | ?> |
| [45](#L45) | <script> |
| [46](#L46) | lang.<?php echo $this->slug ?> = {}; |
| [47](#L47) | lang.<?php echo $this->slug ?>.want\_to\_bulk = "<?php echo esc\_html\_\_('Will be edited next:', 'woo-bulk-editor') ?>"; |
| [48](#L48) | lang.<?php echo $this->slug ?>.want\_to\_delete = "<?php echo esc\_html\_\_('Sure? Delete products?', 'woo-bulk-editor') ?>"; |
| [49](#L49) | lang.<?php echo $this->slug ?>.deleting = "<?php echo esc\_html\_\_('Bulk deleting', 'woo-bulk-editor') ?>"; |
| [50](#L50) | lang.<?php echo $this->slug ?>.deleted = "<?php echo esc\_html\_\_('Product(s) deleted!', 'woo-bulk-editor') ?>"; |
| [51](#L51) | lang.<?php echo $this->slug ?>.bulking = "<?php echo esc\_html\_\_('Bulk editing', 'woo-bulk-editor') ?> ..."; |
| [52](#L52) | lang.<?php echo $this->slug ?>.bulked = "<?php echo esc\_html\_\_('Product(s) edited! Table redrawing ...', 'woo-bulk-editor') ?>"; |
| [53](#L53) | lang.<?php echo $this->slug ?>.bulked2 = "<?php echo esc\_html\_\_('Product(s) edited!', 'woo-bulk-editor') ?>"; |
| [54](#L54) | lang.<?php echo $this->slug ?>.bulk\_is\_going = "<?php echo esc\_html\_\_('ATTENTION: Bulk operation is going!', 'woo-bulk-editor') ?>"; |
| [55](#L55) | lang.<?php echo $this->slug ?>.attention\_all\_products = "<?php echo esc\_html\_\_('ATTENTION: You have not applied a filter and have not selected any products. This operation will be applied to all products in your database.', 'woo-bulk-editor') ?>"; |
| [56](#L56) | </script> |
| [57](#L57) | <?php |
| [58](#L58) | } |
| [59](#L59) |  |
| [60](#L60) | public function woobe\_tools\_panel\_buttons\_end() { |
| [61](#L61) | global $WOOBE; |
| [62](#L62) | ?> |
| [63](#L63) | &nbsp;|&nbsp;<span> |
| [64](#L64) | <?php echo WOOBE\_HELPER::draw\_advanced\_switcher(0, 'woobe\_bind\_editing', '', array('true' => esc\_html\_\_('binded editing', 'woo-bulk-editor'), 'false' => esc\_html\_\_('binded editing', 'woo-bulk-editor')), array('true' => 1, 'false' => 0), 'js\_check\_woobe\_bind\_editing', 'woobe\_bind\_editing'); ?> |
| [65](#L65) |  |
| [66](#L66) | <?php |
| [67](#L67) | $bind\_tooltip = ''; |
| [68](#L68) | if ($WOOBE->show\_notes) { |
| [69](#L69) | $fields = $WOOBE->settings->get\_fields(); |
| [70](#L70) | if (!empty($fields)) { |
| [71](#L71) | $bind\_tooltip = []; |
| [72](#L72) | foreach ($fields as $field\_key => $f) { |
| [73](#L73) | if ($f['direct']) { |
| [74](#L74) | $t = strip\_tags($f['title']); |
| [75](#L75) | if (!empty($t) AND $field\_key != 'ID') { |
| [76](#L76) | $bind\_tooltip[] = $t; |
| [77](#L77) | } |
| [78](#L78) | } |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) | $bind\_tooltip = sprintf(esc\_html\_\_('In FREE version of the plugin you can change only next fields: %s', 'woo-bulk-editor'), implode(', ', $bind\_tooltip)); |
| [82](#L82) | } |
| [83](#L83) | } |
| [84](#L84) | ?> |
| [85](#L85) |  |
| [86](#L86) | <?php echo WOOBE\_HELPER::draw\_tooltip(esc\_html\_\_('In this mode to the all selected products will be set the value of a product field which been edited', 'woo-bulk-editor') . '. ' . $bind\_tooltip) ?> |
| [87](#L87) |  |
| [88](#L88) | </span> |
| [89](#L89) | <?php |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | public function woobe\_ext\_panel() { |
| [93](#L93) | $data = array(); |
| [94](#L94) | $data['shop\_manager\_visibility'] = $this->settings->get\_shop\_manager\_visibility(); |
| [95](#L95) | $data['text\_keys'] = $this->text\_keys; |
| [96](#L96) | $data['num\_keys'] = $this->num\_keys; |
| [97](#L97) | $data['other\_keys'] = $this->other\_keys; |
| [98](#L98) | $data['settings\_fields'] = $this->settings->get\_fields(); |
| [99](#L99) | echo WOOBE\_HELPER::render\_html($this->get\_ext\_path() . 'views/panel.php', $data); |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | //ajax |
| [103](#L103) | public function woobe\_bulk\_products\_count() { |
| [104](#L104) | if (!current\_user\_can('manage\_woocommerce')) { |
| [105](#L105) | die('0'); |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | if (!isset($\_REQUEST['bulk\_form\_nonce']) || !wp\_verify\_nonce($\_REQUEST['bulk\_form\_nonce'], 'woobe\_bulk\_form\_nonce')) { |
| [109](#L109) | die('0'); |
| [110](#L110) | } |
| [111](#L111) | //\*\*\* |
| [112](#L112) |  |
| [113](#L113) | $bulk\_data = array(); |
| [114](#L114) |  |
| [115](#L115) | if (!isset($\_REQUEST['woobe\_bind\_editing'])) { |
| [116](#L116) | parse\_str($\_REQUEST['bulk\_data'], $bulk\_data); |
| [117](#L117) |  |
| [118](#L118) | $bulk\_data = WOOBE\_HELPER::sanitize\_array($bulk\_data); |
| [119](#L119) | } else { |
| [120](#L120) | //binded editing operation works |
| [121](#L121) | if (is\_array($\_REQUEST['val'])) { |
| [122](#L122) | $value = WOOBE\_HELPER::sanitize\_array($\_REQUEST['val']); |
| [123](#L123) | } else { |
| [124](#L124) | $value = wp\_kses($\_REQUEST['val'], wp\_kses\_allowed\_html('post')); |
| [125](#L125) | $value = str\_replace("&amp;", "&", $value); |
| [126](#L126) | } |
| [127](#L127) |  |
| [128](#L128) |  |
| [129](#L129) | $field\_key = sanitize\_text\_field($\_REQUEST['field']); |
| [130](#L130) |  |
| [131](#L131) | //\*\*\* |
| [132](#L132) |  |
| [133](#L133) | $bulk\_data['woobe\_bulk'] = array( |
| [134](#L134) | 'is' => array( |
| [135](#L135) | $field\_key => 1 |
| [136](#L136) | ), |
| [137](#L137) | $field\_key => array( |
| [138](#L138) | 'value' => $value, |
| [139](#L139) | 'behavior' => sanitize\_text\_field($\_REQUEST['behavior']) |
| [140](#L140) | ) |
| [141](#L141) | ); |
| [142](#L142) | } |
| [143](#L143) |  |
| [144](#L144) |  |
| [145](#L145) | $this->storage->set\_val('woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key']), $bulk\_data['woobe\_bulk']); |
| [146](#L146) |  |
| [147](#L147) | if (!isset($\_REQUEST['no\_filter'])) { |
| [148](#L148) | //get count of filtered - doesn work if bulk for checked products |
| [149](#L149) | $products = $this->products->gets(array( |
| [150](#L150) | 'fields' => 'ids', |
| [151](#L151) | 'no\_found\_rows' => true |
| [152](#L152) | )); |
| [153](#L153) | echo json\_encode($products->posts); |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | //\*\*\* |
| [157](#L157) |  |
| [158](#L158) | do\_action('woobe\_bulk\_started', WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key'])); |
| [159](#L159) |  |
| [160](#L160) | exit; |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | public function woobe\_bulk\_delete\_products\_count() { |
| [164](#L164) | if (!current\_user\_can('manage\_woocommerce')) { |
| [165](#L165) | die('0'); |
| [166](#L166) | } |
| [167](#L167) | if (!isset($\_REQUEST['bulk\_form\_nonce']) || !wp\_verify\_nonce($\_REQUEST['bulk\_form\_nonce'], 'woobe\_bulk\_form\_nonce')) { |
| [168](#L168) | die('0'); |
| [169](#L169) | } |
| [170](#L170) | $bulk\_data = array(); |
| [171](#L171) |  |
| [172](#L172) | if (!isset($\_REQUEST['woobe\_bind\_editing'])) { |
| [173](#L173) | parse\_str($\_REQUEST['bulk\_data'], $bulk\_data); |
| [174](#L174) | $bulk\_data = WOOBE\_HELPER::sanitize\_array($bulk\_data); |
| [175](#L175) | } else { |
| [176](#L176) | //binded editing operation works |
| [177](#L177) | if (is\_array($\_REQUEST['val'])) { |
| [178](#L178) | $value = WOOBE\_HELPER::sanitize\_array($\_REQUEST['val']); |
| [179](#L179) | } else { |
| [180](#L180) | $value = wp\_kses($\_REQUEST['val'], wp\_kses\_allowed\_html('post')); |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | $field\_key = sanitize\_text\_field($\_REQUEST['field']); |
| [184](#L184) |  |
| [185](#L185) | //\*\*\* |
| [186](#L186) |  |
| [187](#L187) | $bulk\_data['woobe\_bulk'] = array( |
| [188](#L188) | 'is' => array( |
| [189](#L189) | $field\_key => 1 |
| [190](#L190) | ), |
| [191](#L191) | $field\_key => array( |
| [192](#L192) | 'value' => $value, |
| [193](#L193) | 'behavior' => sanitize\_text\_field($\_REQUEST['behavior']) |
| [194](#L194) | ) |
| [195](#L195) | ); |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) |  |
| [199](#L199) | $this->storage->set\_val('woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key']), $bulk\_data['woobe\_bulk']); |
| [200](#L200) |  |
| [201](#L201) | if (!isset($\_REQUEST['no\_filter'])) { |
| [202](#L202) | //get count of filtered - doesn work if bulk for checked products |
| [203](#L203) | $products = $this->products->gets(array( |
| [204](#L204) | 'fields' => 'ids', |
| [205](#L205) | 'no\_found\_rows' => true |
| [206](#L206) | )); |
| [207](#L207) | echo json\_encode($products->posts); |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | exit; |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | public function woobe\_bulk\_delete\_products() { |
| [214](#L214) | if (!current\_user\_can('manage\_woocommerce')) { |
| [215](#L215) | die('0'); |
| [216](#L216) | } |
| [217](#L217) | if (!isset($\_REQUEST['products\_ids'])) { |
| [218](#L218) | die('0'); |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | if (!isset($\_REQUEST['bulk\_form\_nonce']) || !wp\_verify\_nonce($\_REQUEST['bulk\_form\_nonce'], 'woobe\_bulk\_form\_nonce')) { |
| [222](#L222) | die('0'); |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | if (is\_array($\_REQUEST['products\_ids'])) { |
| [226](#L226) | $is\_variations\_solo = intval($\_REQUEST['woobe\_show\_variations']); |
| [227](#L227) |  |
| [228](#L228) | $products\_ids = array\_map(function ($item) { |
| [229](#L229) | return intval($item); //sanitize intval |
| [230](#L230) | }, $\_REQUEST['products\_ids']); |
| [231](#L231) |  |
| [232](#L232) | //as we want to change variations only but have ids of parents - lets get variations ids |
| [233](#L233) | if ($is\_variations\_solo AND!empty($products\_ids)) { |
| [234](#L234) | $vars\_ids = array(); |
| [235](#L235) | foreach ($products\_ids as $product\_id) { |
| [236](#L236) | $product = $this->products->get\_product($product\_id); |
| [237](#L237) | if ($product->is\_type('variable')) { |
| [238](#L238) | $children = $product->get\_children(); |
| [239](#L239) | if (!empty($children)) { |
| [240](#L240) | $vars\_ids = array\_merge($vars\_ids, $children); |
| [241](#L241) | } |
| [242](#L242) | } |
| [243](#L243) | } |
| [244](#L244) | $products\_ids = array\_unique(array\_merge($products\_ids, $vars\_ids)); |
| [245](#L245) | } |
| [246](#L246) | $woobe\_bulk = $this->storage->get\_val('woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key'])); |
| [247](#L247) |  |
| [248](#L248) | foreach ($products\_ids as $id) { |
| [249](#L249) | if ($is\_variations\_solo) { |
| [250](#L250) |  |
| [251](#L251) | //lets check that currenct variation has the same attributes combination |
| [252](#L252) | if (isset($woobe\_bulk['combination\_attributes']) AND!empty($woobe\_bulk['combination\_attributes'])) { |
| [253](#L253) |  |
| [254](#L254) | $variation = $this->products->get\_product($id); |
| [255](#L255) | $attributes = $variation->get\_attributes(); |
| [256](#L256) |  |
| [257](#L257) | //\*\*\* |
| [258](#L258) |  |
| [259](#L259) | $go = FALSE; |
| [260](#L260) |  |
| [261](#L261) | //\*\*\* |
| [262](#L262) |  |
| [263](#L263) | if (!empty($attributes)) { |
| [264](#L264) | foreach ($woobe\_bulk['combination\_attributes'] as $comb) { |
| [265](#L265) | //lets look is $attributes the same set of attributes as in $comb |
| [266](#L266) | $ak\_att = array\_keys($attributes); |
| [267](#L267) | $ak\_cv = array\_keys($comb); |
| [268](#L268) |  |
| [269](#L269) | //fix for non-latin symbols |
| [270](#L270) | if (!empty($ak\_att)) { |
| [271](#L271) | $ak\_att = array\_map('urldecode', $ak\_att); |
| [272](#L272) | } |
| [273](#L273) |  |
| [274](#L274) | //fix for non-latin symbols |
| [275](#L275) | if (!empty($ak\_cv)) { |
| [276](#L276) | $ak\_cv = array\_map('urldecode', $ak\_cv); |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | sort($ak\_att); |
| [280](#L280) | sort($ak\_cv); |
| [281](#L281) |  |
| [282](#L282) | if ($ak\_att === $ak\_cv) { |
| [283](#L283) |  |
| [284](#L284) | $new\_attributes = $attributes; |
| [285](#L285) | $new\_comb = $comb; |
| [286](#L286) | if (in\_array('-1',$comb)){ |
| [287](#L287) | $delete\_keys = array\_keys($comb, '-1',); |
| [288](#L288) |  |
| [289](#L289) | foreach ($delete\_keys as $d\_key) { |
| [290](#L290) | if (isset($new\_attributes[$d\_key])) { |
| [291](#L291) | unset($new\_attributes[$d\_key]); |
| [292](#L292) | unset($new\_comb[$d\_key]); |
| [293](#L293) | } |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | } |
| [297](#L297) |  |
| [298](#L298) | $av\_att = array\_values($new\_attributes); |
| [299](#L299) | $av\_cv = array\_values($new\_comb); |
| [300](#L300) |  |
| [301](#L301) | //fix for non-latin symbols |
| [302](#L302) | if (!empty($ak\_att)) { |
| [303](#L303) | $av\_att = array\_map('urldecode', $av\_att); |
| [304](#L304) | } |
| [305](#L305) |  |
| [306](#L306) |  |
| [307](#L307) | if (!empty($av\_cv)) { |
| [308](#L308) | $av\_cv = array\_map('urldecode', $av\_cv); |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | sort($av\_att); |
| [312](#L312) | sort($av\_cv); |
| [313](#L313) |  |
| [314](#L314) | if ($av\_att === $av\_cv) { |
| [315](#L315) | $go = TRUE; |
| [316](#L316) | break; |
| [317](#L317) | } |
| [318](#L318) | } |
| [319](#L319) | } |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) | //\*\*\* |
| [323](#L323) |  |
| [324](#L324) | if (!$go) { |
| [325](#L325) | continue; |
| [326](#L326) | } |
| [327](#L327) | } |
| [328](#L328) | } |
| [329](#L329) | //wp\_delete\_post($id,false); |
| [330](#L330) | wp\_trash\_post(intval($id)); |
| [331](#L331) | } |
| [332](#L332) | } else { |
| [333](#L333) | die('0'); |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | die(json\_encode($\_REQUEST['products\_ids'])); |
| [337](#L337) | exit; |
| [338](#L338) | } |
| [339](#L339) |  |
| [340](#L340) | //ajax |
| [341](#L341) | public function woobe\_bulk\_products() { |
| [342](#L342) | if (!current\_user\_can('manage\_woocommerce')) { |
| [343](#L343) | die('0'); |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | if (!isset($\_REQUEST['products\_ids'])) { |
| [347](#L347) | die('0'); |
| [348](#L348) | } |
| [349](#L349) | if (!isset($\_REQUEST['bulk\_form\_nonce']) || !wp\_verify\_nonce($\_REQUEST['bulk\_form\_nonce'], 'woobe\_bulk\_form\_nonce')) { |
| [350](#L350) | die('0'); |
| [351](#L351) | } |
| [352](#L352) | //\*\*\* |
| [353](#L353) |  |
| [354](#L354) | $fields = $this->settings->get\_fields(); |
| [355](#L355) | $woobe\_bulk = $this->storage->get\_val('woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key'])); |
| [356](#L356) | //key for history bulk opearation, not related to products keys |
| [357](#L357) | $\_REQUEST['woobe\_bulk\_key'] = WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key']); |
| [358](#L358) |  |
| [359](#L359) | $is\_variations\_solo = intval($\_REQUEST['woobe\_show\_variations']); |
| [360](#L360) | $products\_ids = $\_REQUEST['products\_ids']; //sanitize in cycle below |
| [361](#L361) | //\*\*\* |
| [362](#L362) | //as we want to change variations only but have ids of parents - lets get variations ids |
| [363](#L363) | if ($is\_variations\_solo AND!empty($products\_ids)) { |
| [364](#L364) | $vars\_ids = array(); |
| [365](#L365) | foreach ($products\_ids as $product\_id) { |
| [366](#L366) | $product\_id = intval($product\_id); //sanitize |
| [367](#L367) |  |
| [368](#L368) | $product = $this->products->get\_product($product\_id); |
| [369](#L369) | if ($product->is\_type('variable')) { |
| [370](#L370) | $children = $product->get\_children(); |
| [371](#L371) | if (!empty($children)) { |
| [372](#L372) | $vars\_ids = array\_merge($vars\_ids, $children); |
| [373](#L373) | } |
| [374](#L374) | } |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | $products\_ids = array\_unique(array\_merge($products\_ids, $vars\_ids)); |
| [378](#L378) | } |
| [379](#L379) |  |
| [380](#L380) | //\*\*\* |
| [381](#L381) |  |
| [382](#L382) | if (isset($woobe\_bulk['is']) AND!empty($woobe\_bulk['is']) AND!empty($products\_ids)) { |
| [383](#L383) |  |
| [384](#L384) | //\*\*\* |
| [385](#L385) |  |
| [386](#L386) | foreach ($woobe\_bulk['is'] as $field\_key => $is) { |
| [387](#L387) |  |
| [388](#L388) | if ($fields[$field\_key]['edit\_view'] === 'calendar') { |
| [389](#L389) |  |
| [390](#L390) |  |
| [391](#L391) | if (!is\_int($woobe\_bulk[$field\_key]['value']) AND (isset($fields[$field\_key]["field\_type"]) AND $fields[$field\_key]["field\_type"] == "meta")) { |
| [392](#L392) | $woobe\_bulk[$field\_key]['value'] = strtotime($woobe\_bulk[$field\_key]['value']); // - wrong way |
| [393](#L393) | } else { |
| [394](#L394) | $woobe\_bulk[$field\_key]['value'] = $this->products->normalize\_calendar\_date($woobe\_bulk[$field\_key]['value'], $field\_key); |
| [395](#L395) | } |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | //\*\*\* |
| [399](#L399) | //speedfix |
| [400](#L400) | wp\_defer\_term\_counting(false); |
| [401](#L401) | wp\_defer\_comment\_counting(true); |
| [402](#L402) |  |
| [403](#L403) | //\*\*\* |
| [404](#L404) |  |
| [405](#L405) | if (intval($is) === 1) { |
| [406](#L406) |  |
| [407](#L407) | foreach ($products\_ids as $product\_id) { |
| [408](#L408) |  |
| [409](#L409) | if ($is\_variations\_solo) { |
| [410](#L410) | //if enabled editing of variations only parent-products are ignored |
| [411](#L411) | $product = $this->products->get\_product($product\_id); |
| [412](#L412) | if (!$product->is\_type('variation')) { |
| [413](#L413) | continue; |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | //lets check that currenct variation has the same attributes combination |
| [417](#L417) | if (isset($woobe\_bulk['combination\_attributes']) AND!empty($woobe\_bulk['combination\_attributes'])) { |
| [418](#L418) |  |
| [419](#L419) | $variation = $this->products->get\_product($product\_id); |
| [420](#L420) | $attributes = $variation->get\_attributes(); |
| [421](#L421) |  |
| [422](#L422) | //\*\*\* |
| [423](#L423) |  |
| [424](#L424) | $go = FALSE; |
| [425](#L425) |  |
| [426](#L426) | //\*\*\* |
| [427](#L427) |  |
| [428](#L428) | if (!empty($attributes)) { |
| [429](#L429) | foreach ($woobe\_bulk['combination\_attributes'] as $comb) { |
| [430](#L430) | //lets look is $attributes the same set of attributes as in $comb |
| [431](#L431) | $ak\_att = array\_keys($attributes); |
| [432](#L432) | $ak\_cv = array\_keys($comb); |
| [433](#L433) |  |
| [434](#L434) | //fix for non-latin symbols |
| [435](#L435) | if (!empty($ak\_att)) { |
| [436](#L436) | $ak\_att = array\_map('urldecode', $ak\_att); |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | //fix for non-latin symbols |
| [440](#L440) | if (!empty($ak\_cv)) { |
| [441](#L441) | $ak\_cv = array\_map('urldecode', $ak\_cv); |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | sort($ak\_att); |
| [445](#L445) | sort($ak\_cv); |
| [446](#L446) |  |
| [447](#L447) | if ($ak\_att === $ak\_cv) { |
| [448](#L448) | $new\_attributes = $attributes; |
| [449](#L449) | $new\_comb = $comb; |
| [450](#L450) | if (in\_array('-1',$comb)){ |
| [451](#L451) | $delete\_keys = array\_keys($comb, '-1',); |
| [452](#L452) |  |
| [453](#L453) | foreach ($delete\_keys as $d\_key) { |
| [454](#L454) | if (isset($new\_attributes[$d\_key])) { |
| [455](#L455) | unset($new\_attributes[$d\_key]); |
| [456](#L456) | unset($new\_comb[$d\_key]); |
| [457](#L457) | } |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | $av\_att = array\_values($new\_attributes); |
| [463](#L463) | $av\_cv = array\_values($new\_comb); |
| [464](#L464) |  |
| [465](#L465) | //fix for non-latin symbols |
| [466](#L466) | if (!empty($ak\_att)) { |
| [467](#L467) | $av\_att = array\_map('urldecode', $av\_att); |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | if (!empty($av\_cv)) { |
| [471](#L471) | $av\_cv = array\_map('urldecode', $av\_cv); |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | sort($av\_att); |
| [475](#L475) | sort($av\_cv); |
| [476](#L476) | if ($av\_att === $av\_cv) { |
| [477](#L477) | $go = TRUE; |
| [478](#L478) | break; |
| [479](#L479) | } |
| [480](#L480) | } |
| [481](#L481) | } |
| [482](#L482) | } |
| [483](#L483) |  |
| [484](#L484) | //\*\*\* |
| [485](#L485) |  |
| [486](#L486) | if (!$go) { |
| [487](#L487) | continue; |
| [488](#L488) | } |
| [489](#L489) | } |
| [490](#L490) | } |
| [491](#L491) |  |
| [492](#L492) | //\*\*\* |
| [493](#L493) |  |
| [494](#L494) |  |
| [495](#L495) | switch ($field\_key) { |
| [496](#L496) | case 'post\_title': |
| [497](#L497) | case 'post\_content': |
| [498](#L498) | case 'post\_excerpt': |
| [499](#L499) | case 'post\_name': |
| [500](#L500) | case 'purchase\_note': |
| [501](#L501) | case 'sku': |
| [502](#L502) | case 'tax\_class': |
| [503](#L503) | case 'backorders': |
| [504](#L504) | case 'sold\_individually': |
| [505](#L505) | case 'reviews\_allowed': |
| [506](#L506) | case 'product\_url': |
| [507](#L507) | case 'button\_text': |
| [508](#L508) | $this->\_process\_text\_data($woobe\_bulk, $field\_key, $product\_id); |
| [509](#L509) | break; |
| [510](#L510) |  |
| [511](#L511) | case 'post\_status': |
| [512](#L512) | case 'stock\_status': |
| [513](#L513) | case 'manage\_stock': |
| [514](#L514) | case 'tax\_status': |
| [515](#L515) | case 'catalog\_visibility': |
| [516](#L516) | case 'product\_type': |
| [517](#L517) | case 'featured': |
| [518](#L518) | case 'virtual': |
| [519](#L519) | case 'downloadable': |
| [520](#L520) | case 'download\_files': |
| [521](#L521) | case 'gallery': |
| [522](#L522) | case 'upsell\_ids': |
| [523](#L523) | case 'cross\_sell\_ids': |
| [524](#L524) | case 'grouped\_ids': |
| [525](#L525) | case 'post\_date': |
| [526](#L526) | if (intval($woobe\_bulk[$field\_key]['value']) !== -1) { |
| [527](#L527) | $this->products->update\_page\_field($product\_id, $field\_key, $woobe\_bulk[$field\_key]['value']); |
| [528](#L528) | } |
| [529](#L529) | break; |
| [530](#L530) | case 'attribute\_visibility': |
| [531](#L531) |  |
| [532](#L532) | if (!isset($woobe\_bulk[$field\_key]['value']) OR!is\_array($woobe\_bulk[$field\_key]['value'])) { |
| [533](#L533) |  |
| [534](#L534) | $woobe\_bulk[$field\_key]['value'] = array(); |
| [535](#L535) | } |
| [536](#L536) | if (!isset($woobe\_bulk[$field\_key]['visible'])) { |
| [537](#L537) | $woobe\_bulk[$field\_key]['visible'] = 1; |
| [538](#L538) | } |
| [539](#L539) | $this->products->set\_product\_attributes\_visible($product\_id, $woobe\_bulk[$field\_key]['value'], $woobe\_bulk[$field\_key]['visible']); |
| [540](#L540) |  |
| [541](#L541) | break; |
| [542](#L542) | case 'regular\_price': |
| [543](#L543) | case 'sale\_price': |
| [544](#L544) | case 'stock\_quantity': |
| [545](#L545) | case 'download\_expiry': |
| [546](#L546) | case 'download\_limit': |
| [547](#L547) | case 'date\_on\_sale\_from': |
| [548](#L548) | case 'date\_on\_sale\_to': |
| [549](#L549) | case 'weight': |
| [550](#L550) | case 'length': |
| [551](#L551) | case 'width': |
| [552](#L552) | case 'height': |
| [553](#L553) | case 'product\_shipping\_class': |
| [554](#L554) | case 'menu\_order': |
| [555](#L555) | case 'post\_author': |
| [556](#L556) | case 'total\_sales': |
| [557](#L557) | case 'review\_count': |
| [558](#L558) | case 'average\_rating': |
| [559](#L559) | $this->\_process\_number\_data($woobe\_bulk, $field\_key, $product\_id); |
| [560](#L560) | break; |
| [561](#L561) |  |
| [562](#L562) | default: |
| [563](#L563) | break; |
| [564](#L564) | } |
| [565](#L565) |  |
| [566](#L566) | //\*\*\* |
| [567](#L567) |  |
| [568](#L568) | if (isset($fields[$field\_key]) AND $fields[$field\_key]['field\_type'] === 'taxonomy') { |
| [569](#L569) | //if (!empty($woobe\_bulk[$field\_key]['value'])) { |
| [570](#L570) | do\_action('woobe\_before\_update\_page\_field', $field\_key, $product\_id, 0); //for the History |
| [571](#L571) | if (!isset($woobe\_bulk[$field\_key]['behavior'])) { |
| [572](#L572) | $woobe\_bulk[$field\_key]['behavior'] = ""; |
| [573](#L573) | } |
| [574](#L574) | switch ($woobe\_bulk[$field\_key]['behavior']) { |
| [575](#L575) | case 'append': |
| [576](#L576) | if (is\_taxonomy\_hierarchical($field\_key)) { |
| [577](#L577) | wp\_set\_post\_terms($product\_id, $woobe\_bulk[$field\_key]['value'], $field\_key, true); |
| [578](#L578) | } else { |
| [579](#L579) | //product\_tag for example |
| [580](#L580) | foreach ($woobe\_bulk[$field\_key]['value'] as $term\_id) { |
| [581](#L581) | $t = get\_term\_by('id', $term\_id, $field\_key); |
| [582](#L582) | wp\_set\_post\_terms($product\_id, $t->slug, $field\_key, true); |
| [583](#L583) | } |
| [584](#L584) | } |
| [585](#L585) | break; |
| [586](#L586) | case 'replace': |
| [587](#L587) | case 'new': |
| [588](#L588) | if (is\_taxonomy\_hierarchical($field\_key)) { |
| [589](#L589) | wp\_set\_post\_terms($product\_id, $woobe\_bulk[$field\_key]['value'], $field\_key, false); |
| [590](#L590) | } else { |
| [591](#L591) | //product\_tag for example |
| [592](#L592) | $append = false; //clean previous by first one then append |
| [593](#L593) | if (!empty($woobe\_bulk[$field\_key]['value']) AND is\_array($woobe\_bulk[$field\_key]['value'])) { |
| [594](#L594) | foreach ($woobe\_bulk[$field\_key]['value'] as $term\_id) { |
| [595](#L595) | $t = get\_term\_by('id', $term\_id, $field\_key); |
| [596](#L596) | wp\_set\_post\_terms($product\_id, $t->slug, $field\_key, $append); |
| [597](#L597) | $append = true; |
| [598](#L598) | } |
| [599](#L599) | } |
| [600](#L600) | } |
| [601](#L601) | break; |
| [602](#L602) | case 'remove': |
| [603](#L603) | foreach ($woobe\_bulk[$field\_key]['value'] as $term\_id) { |
| [604](#L604) | $t = get\_term\_by('id', $term\_id, $field\_key); |
| [605](#L605) | wp\_remove\_object\_terms($product\_id, $t->slug, $field\_key); |
| [606](#L606) | } |
| [607](#L607) | break; |
| [608](#L608) | } |
| [609](#L609) | //} |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | //\*\*\* |
| [613](#L613) |  |
| [614](#L614) | if (isset($fields[$field\_key]) AND $fields[$field\_key]['field\_type'] === 'attribute') { |
| [615](#L615) | if (!isset($woobe\_bulk[$field\_key]['value'])) { |
| [616](#L616) | $woobe\_bulk[$field\_key]['value'] = ''; |
| [617](#L617) | } |
| [618](#L618) | do\_action('woobe\_before\_update\_page\_field', $field\_key, $product\_id, 0); //for the History |
| [619](#L619) | $this->products->set\_product\_attributes($product\_id, $field\_key, $woobe\_bulk[$field\_key]['value'], $woobe\_bulk[$field\_key]['behavior']); |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | //\*\*\* |
| [623](#L623) |  |
| [624](#L624) | if (isset($fields[$field\_key]) AND $fields[$field\_key]['field\_type'] === 'meta') { |
| [625](#L625) | switch ($fields[$field\_key]['type']) { |
| [626](#L626) | case 'string': |
| [627](#L627) |  |
| [628](#L628) | //if data is serialized in ine string |
| [629](#L629) | if ($fields[$field\_key]['edit\_view'] == 'meta\_popup\_editor') { |
| [630](#L630) | if (!is\_array($woobe\_bulk[$field\_key]['value'])) { |
| [631](#L631) |  |
| [632](#L632) | //if not else parsed |
| [633](#L633) | parse\_str($woobe\_bulk[$field\_key]['value'], $meta\_val); |
| [634](#L634) |  |
| [635](#L635) | $woobe\_bulk[$field\_key]['value'] = $this->products->process\_jsoned\_meta\_data($meta\_val); |
| [636](#L636) | } |
| [637](#L637) | } |
| [638](#L638) | //\*\*\* |
| [639](#L639) | if ($fields[$field\_key]['edit\_view'] == 'gallery\_popup\_editor') { |
| [640](#L640) |  |
| [641](#L641) | if (!is\_array($woobe\_bulk[$field\_key]['value'])) { |
| [642](#L642) | //if not else parsed |
| [643](#L643) | parse\_str($woobe\_bulk[$field\_key]['value'], $meta\_val); |
| [644](#L644) | if (!empty($meta\_val['woobe\_gallery\_images'])) { |
| [645](#L645) | $woobe\_bulk[$field\_key]['value'] = $meta\_val; |
| [646](#L646) | } |
| [647](#L647) | } |
| [648](#L648) |  |
| [649](#L649) | } |
| [650](#L650) | //\*\*\* |
| [651](#L651) |  |
| [652](#L652) | if ($fields[$field\_key]['edit\_view'] !== 'switcher') { |
| [653](#L653) | $this->\_process\_text\_data($woobe\_bulk, $field\_key, $product\_id); |
| [654](#L654) | } else { |
| [655](#L655) | if (intval($woobe\_bulk[$field\_key]['value']) !== -1) { |
| [656](#L656) | $this->products->update\_page\_field($product\_id, $field\_key, intval($woobe\_bulk[$field\_key]['value'])); |
| [657](#L657) | } |
| [658](#L658) | } |
| [659](#L659) | break; |
| [660](#L660) |  |
| [661](#L661) | case 'number': |
| [662](#L662) | $this->\_process\_number\_data($woobe\_bulk, $field\_key, $product\_id); |
| [663](#L663) | break; |
| [664](#L664) |  |
| [665](#L665) | default: |
| [666](#L666) | break; |
| [667](#L667) | } |
| [668](#L668) | } |
| [669](#L669) | } |
| [670](#L670) | } |
| [671](#L671) | } |
| [672](#L672) |  |
| [673](#L673) | do\_action('woobe\_bulk\_going', sanitize\_text\_field($\_REQUEST['woobe\_bulk\_key']), count($products\_ids)); |
| [674](#L674) | } |
| [675](#L675) |  |
| [676](#L676) |  |
| [677](#L677) |  |
| [678](#L678) | die('done'); |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | public function woobe\_bulk\_going($bulk\_key, $products\_count) { |
| [682](#L682) | $count\_key = 'woobe\_bulk\_' . strtolower($bulk\_key) . '\_count'; |
| [683](#L683) | $count\_now = intval($this->storage->get\_val($count\_key)); |
| [684](#L684) | $this->storage->set\_val($count\_key, $products\_count + $count\_now); |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | private function \_process\_text\_data($woobe\_bulk, $field\_key, $product\_id) { |
| [688](#L688) | //if (!empty($woobe\_bulk[$field\_key]['value'])) { |
| [689](#L689) | $val = $this->products->get\_post\_field($product\_id, $field\_key); |
| [690](#L690) | $woobe\_bulk[$field\_key]['value'] = $this->products->string\_macros($woobe\_bulk[$field\_key]['value'], $field\_key, $product\_id); |
| [691](#L691) | switch ($woobe\_bulk[$field\_key]['behavior']) { |
| [692](#L692) | case 'append': |
| [693](#L693) | $val = $this->products->string\_replacer($val . $woobe\_bulk[$field\_key]['value'], $product\_id); |
| [694](#L694) | break; |
| [695](#L695) | case 'prepend': |
| [696](#L696) | $val = $this->products->string\_replacer($woobe\_bulk[$field\_key]['value'] . $val, $product\_id); |
| [697](#L697) | break; |
| [698](#L698) | case 'new': |
| [699](#L699) | $val = $this->products->string\_replacer($woobe\_bulk[$field\_key]['value'], $product\_id); |
| [700](#L700) | break; |
| [701](#L701) | case 'replace': |
| [702](#L702) | $replace\_to = $this->products->string\_replacer($woobe\_bulk[$field\_key]['replace\_to'], $product\_id); |
| [703](#L703) | $replace\_from = $this->products->string\_replacer($woobe\_bulk[$field\_key]['value'], $product\_id); |
| [704](#L704) |  |
| [705](#L705) | //fix  for  apostrophe |
| [706](#L706) | $replace\_from = str\_replace("\'", "'", $replace\_from); |
| [707](#L707) |  |
| [708](#L708) | if ($woobe\_bulk[$field\_key]['case'] == 'ignore') { |
| [709](#L709) | $val = str\_ireplace($replace\_from, $replace\_to, $val); |
| [710](#L710) | } else { |
| [711](#L711) | $val = str\_replace($replace\_from, $replace\_to, $val); |
| [712](#L712) | /\* |
| [713](#L713) | \* https://stackoverflow.com/questions/19317493/php-preg-replace-case-insensitive-match-with-case-sensitive-replacement |
| [714](#L714) | $val = preg\_replace\_callback('/\b' . $replace\_from . '\b/i', function($matches) use ($replace\_to) { |
| [715](#L715) | $i = 0; |
| [716](#L716) | return join('', array\_map(function($char) use ($matches, &$i) { |
| [717](#L717) | return ctype\_lower($matches[0][$i++]) ? strtolower($char) : strtoupper($char); |
| [718](#L718) | }, str\_split($replace\_to))); |
| [719](#L719) | }, $val); |
| [720](#L720) | \* |
| [721](#L721) | \*/ |
| [722](#L722) | } |
| [723](#L723) |  |
| [724](#L724) | break; |
| [725](#L725) | } |
| [726](#L726) |  |
| [727](#L727) | //\*\*\* |
| [728](#L728) | $empty\_exceptions = array('tax\_class'); //setting empty values is possible with this fields |
| [729](#L729) |  |
| [730](#L730) | $can = true; //!empty($val); |
| [731](#L731) |  |
| [732](#L732) | if (in\_array($field\_key, $empty\_exceptions)) { |
| [733](#L733) | $can = true; |
| [734](#L734) | } |
| [735](#L735) |  |
| [736](#L736) | if ($can) { |
| [737](#L737) |  |
| [738](#L738) | $val = $this->products->update\_page\_field($product\_id, $field\_key, $val); |
| [739](#L739) | } |
| [740](#L740) | //} |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | private function \_process\_number\_data($woobe\_bulk, $field\_key, $product\_id) { |
| [744](#L744) | if ($woobe\_bulk[$field\_key]['behavior'] != 'new') { |
| [745](#L745) | $val = floatval($this->products->get\_post\_field($product\_id, $field\_key)); |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | //\*\*\* |
| [749](#L749) |  |
| [750](#L750) | switch ($woobe\_bulk[$field\_key]['behavior']) { |
| [751](#L751) | case 'new': |
| [752](#L752) | $val = floatval($woobe\_bulk[$field\_key]['value']); |
| [753](#L753) | break; |
| [754](#L754) |  |
| [755](#L755) | case 'invalue': |
| [756](#L756) | $val += floatval($woobe\_bulk[$field\_key]['value']); |
| [757](#L757) | break; |
| [758](#L758) |  |
| [759](#L759) | case 'devalue': |
| [760](#L760) | $val -= floatval($woobe\_bulk[$field\_key]['value']); |
| [761](#L761) | break; |
| [762](#L762) |  |
| [763](#L763) | case 'inpercent': |
| [764](#L764) | $val = $val + $val \* floatval($woobe\_bulk[$field\_key]['value']) / 100; |
| [765](#L765) | break; |
| [766](#L766) |  |
| [767](#L767) | case 'depercent': |
| [768](#L768) | $val = $val - $val \* floatval($woobe\_bulk[$field\_key]['value']) / 100; |
| [769](#L769) | break; |
| [770](#L770) |  |
| [771](#L771) | case 'devalue\_regular\_price': |
| [772](#L772) | //for sale\_price only |
| [773](#L773) | $val = floatval($this->products->get\_post\_field($product\_id, 'regular\_price')) - floatval($woobe\_bulk[$field\_key]['value']); |
| [774](#L774) | break; |
| [775](#L775) |  |
| [776](#L776) | case 'depercent\_regular\_price': |
| [777](#L777) | //for sale\_price only |
| [778](#L778) | $val = floatval($this->products->get\_post\_field($product\_id, 'regular\_price')); |
| [779](#L779) | $val = $val - $val \* floatval($woobe\_bulk[$field\_key]['value']) / 100; |
| [780](#L780) | break; |
| [781](#L781) |  |
| [782](#L782) | case 'invalue\_sale\_price': |
| [783](#L783) | //for regular\_price only |
| [784](#L784) | $val = floatval($this->products->get\_post\_field($product\_id, 'sale\_price') + floatval($woobe\_bulk[$field\_key]['value'])); |
| [785](#L785) | break; |
| [786](#L786) |  |
| [787](#L787) | case 'inpercent\_sale\_price': |
| [788](#L788) | //for regular\_price only |
| [789](#L789) | $val =  floatval($this->products->get\_post\_field($product\_id, 'sale\_price')); |
| [790](#L790) | $val = $val + $val \* floatval($woobe\_bulk[$field\_key]['value']) / 100; |
| [791](#L791) | break; |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) | if (isset($\_REQUEST['num\_formula\_action']) AND isset($\_REQUEST['num\_formula\_value']) AND $\_REQUEST['num\_formula\_value'] != '-1') { |
| [795](#L795) | $v\_key = esc\_textarea($\_REQUEST['num\_formula\_value']); |
| [796](#L796) | $action = esc\_textarea($\_REQUEST['num\_formula\_action']); |
| [797](#L797) | $v\_data = floatval(get\_post\_meta($product\_id, $v\_key, true)); |
| [798](#L798) |  |
| [799](#L799) | switch ($action) { |
| [800](#L800) | case '-': |
| [801](#L801) | $val = $val - $v\_data; |
| [802](#L802) | break; |
| [803](#L803) | case '\*': |
| [804](#L804) | $val = $val \* $v\_data; |
| [805](#L805) | break; |
| [806](#L806) | case '/': |
| [807](#L807) | if ($v\_data == 0) { |
| [808](#L808) | $v\_data = 1; |
| [809](#L809) | } |
| [810](#L810) | $val = $val / $v\_data; |
| [811](#L811) | break; |
| [812](#L812) |  |
| [813](#L813) | default: |
| [814](#L814) | $val = $val + $v\_data; |
| [815](#L815) | break; |
| [816](#L816) | } |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | if (isset($\_REQUEST['num\_rand\_data']) && is\_array($\_REQUEST['num\_rand\_data'])) { |
| [820](#L820) | $rand\_data = wc\_clean($\_REQUEST['num\_rand\_data']); |
| [821](#L821) | if (isset($rand\_data['from']) && isset($rand\_data['to']) && ($rand\_data['from'] != $rand\_data['to']) && ($rand\_data['from'] < $rand\_data['to'])) { |
| [822](#L822) | $from = (float)$rand\_data['from']; |
| [823](#L823) | $to = (float)$rand\_data['to']; |
| [824](#L824) | $decimal = 1; |
| [825](#L825) | if (isset($rand\_data['decimal'])) { |
| [826](#L826) | $decimal = (int)$rand\_data['decimal']; |
| [827](#L827) | } |
| [828](#L828) | $action = '+'; |
| [829](#L829) | if (isset($rand\_data['action'])) { |
| [830](#L830) | $action = $rand\_data['action']; |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | $rand\_val = rand($from \* $decimal, $to \* $decimal)/$decimal; |
| [834](#L834) | switch ($action) { |
| [835](#L835) | case '-': |
| [836](#L836) | $val = $val - $rand\_val; |
| [837](#L837) | break; |
| [838](#L838) | case '\*': |
| [839](#L839) | $val = $val \* $rand\_val; |
| [840](#L840) | break; |
| [841](#L841) | case '/': |
| [842](#L842) | if ($rand\_val == 0) { |
| [843](#L843) | $rand\_val = 1; |
| [844](#L844) | } |
| [845](#L845) | $val = $val / $rand\_val; |
| [846](#L846) | break; |
| [847](#L847) |  |
| [848](#L848) | default: |
| [849](#L849) | $val = $val + $rand\_val; |
| [850](#L850) | break; |
| [851](#L851) | } |
| [852](#L852) |  |
| [853](#L853) | } |
| [854](#L854) | } |
| [855](#L855) |  |
| [856](#L856) | //\*\*\* |
| [857](#L857) |  |
| [858](#L858) | $convert = TRUE; |
| [859](#L859) | if ($field\_key == 'sale\_price') { |
| [860](#L860) | //sale price CAN NOT be more OR even equal to the regular price |
| [861](#L861) | if ($val >= $this->products->get\_post\_field($product\_id, 'regular\_price')) { |
| [862](#L862) | $convert = FALSE; |
| [863](#L863) | } |
| [864](#L864) | //to delete sale price |
| [865](#L865) | if ($val <= 0) { |
| [866](#L866) | $val = -1; |
| [867](#L867) | $val = $this->products->update\_page\_field($product\_id, $field\_key, $val); |
| [868](#L868) | $convert = FALSE; |
| [869](#L869) | } |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | //\*\*\* |
| [873](#L873) |  |
| [874](#L874) | if ($convert) { |
| [875](#L875) | $val = $this->products->update\_page\_field($product\_id, $field\_key, floatval($val)); |
| [876](#L876) | } |
| [877](#L877) | } |
| [878](#L878) |  |
| [879](#L879) | public function woobe\_bulk\_finish() { |
| [880](#L880) | do\_action('woobe\_bulk\_finished', WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key'])); |
| [881](#L881) | $count\_key = 'woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key']) . '\_count'; |
| [882](#L882) | die($this->storage->get\_val($count\_key) . ''); |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | private function init\_bulk\_keys() { |
| [886](#L886) |  |
| [887](#L887) | $fields = woobe\_get\_fields(); |
| [888](#L888) |  |
| [889](#L889) | $this->text\_keys = array( |
| [890](#L890) | 'post\_title' => array( |
| [891](#L891) | 'title' => esc\_html\_\_('title', 'woo-bulk-editor'), |
| [892](#L892) | 'css\_classes' => isset($fields['post\_title']['css\_classes']) ? $fields['post\_title']['css\_classes'] : '' |
| [893](#L893) | ), |
| [894](#L894) | 'post\_content' => array( |
| [895](#L895) | 'title' => esc\_html\_\_('description', 'woo-bulk-editor'), |
| [896](#L896) | 'css\_classes' => isset($fields['post\_content']['css\_classes']) ? $fields['post\_content']['css\_classes'] : '' |
| [897](#L897) | ), |
| [898](#L898) | 'post\_excerpt' => array( |
| [899](#L899) | 'title' => esc\_html\_\_('short description', 'woo-bulk-editor'), |
| [900](#L900) | 'css\_classes' => isset($fields['post\_excerpt']['css\_classes']) ? $fields['post\_excerpt']['css\_classes'] : '' |
| [901](#L901) | ), |
| [902](#L902) | 'post\_name' => array( |
| [903](#L903) | 'title' => esc\_html\_\_('product slug', 'woo-bulk-editor'), |
| [904](#L904) | 'css\_classes' => isset($fields['post\_name']['css\_classes']) ? $fields['post\_name']['css\_classes'] : '' |
| [905](#L905) | ), |
| [906](#L906) | 'sku' => array( |
| [907](#L907) | 'title' => esc\_html\_\_('SKU', 'woo-bulk-editor'), |
| [908](#L908) | 'css\_classes' => isset($fields['sku']['css\_classes']) ? $fields['sku']['css\_classes'] : '' |
| [909](#L909) | ) |
| [910](#L910) | ); |
| [911](#L911) |  |
| [912](#L912) | $this->other\_keys = array( |
| [913](#L913) | 'post\_status' => array( |
| [914](#L914) | 'title' => esc\_html\_\_('post status', 'woo-bulk-editor'), |
| [915](#L915) | 'options' => $fields['post\_status']['select\_options'], |
| [916](#L916) | 'direct' => $fields['post\_status']['direct'], |
| [917](#L917) | 'css\_classes' => isset($fields['post\_status']['css\_classes']) ? $fields['post\_status']['css\_classes'] : '' |
| [918](#L918) | ), |
| [919](#L919) | 'stock\_status' => array( |
| [920](#L920) | 'title' => esc\_html\_\_('stock status', 'woo-bulk-editor'), |
| [921](#L921) | 'options' => $fields['stock\_status']['select\_options'], |
| [922](#L922) | 'direct' => $fields['stock\_status']['direct'], |
| [923](#L923) | 'css\_classes' => isset($fields['stock\_status']['css\_classes']) ? $fields['stock\_status']['css\_classes'] : '' |
| [924](#L924) | ), |
| [925](#L925) | 'tax\_status' => array( |
| [926](#L926) | 'title' => esc\_html\_\_('tax status', 'woo-bulk-editor'), |
| [927](#L927) | 'options' => $fields['tax\_status']['select\_options'], |
| [928](#L928) | 'direct' => $fields['tax\_status']['direct'], |
| [929](#L929) | 'css\_classes' => isset($fields['tax\_status']['css\_classes']) ? $fields['tax\_status']['css\_classes'] : '' |
| [930](#L930) | ), |
| [931](#L931) | 'catalog\_visibility' => array( |
| [932](#L932) | 'title' => esc\_html\_\_('catalog visibility', 'woo-bulk-editor'), |
| [933](#L933) | 'options' => $fields['catalog\_visibility']['select\_options'], |
| [934](#L934) | 'direct' => $fields['catalog\_visibility']['direct'], |
| [935](#L935) | 'css\_classes' => isset($fields['catalog\_visibility']['css\_classes']) ? $fields['catalog\_visibility']['css\_classes'] : '' |
| [936](#L936) | ), |
| [937](#L937) | 'product\_type' => array( |
| [938](#L938) | 'title' => esc\_html\_\_('product type', 'woo-bulk-editor'), |
| [939](#L939) | 'options' => $fields['product\_type']['select\_options'], |
| [940](#L940) | 'direct' => $fields['product\_type']['direct'], |
| [941](#L941) | 'css\_classes' => isset($fields['product\_type']['css\_classes']) ? $fields['product\_type']['css\_classes'] : '' |
| [942](#L942) | ), |
| [943](#L943) | 'featured' => array( |
| [944](#L944) | 'title' => esc\_html\_\_('featured', 'woo-bulk-editor'), |
| [945](#L945) | 'options' => $fields['featured']['select\_options'], |
| [946](#L946) | 'direct' => $fields['featured']['direct'], |
| [947](#L947) | 'css\_classes' => isset($fields['featured']['css\_classes']) ? $fields['featured']['css\_classes'] : '' |
| [948](#L948) | ), |
| [949](#L949) | ); |
| [950](#L950) | //\*\*\* |
| [951](#L951) |  |
| [952](#L952) | $options1 = array( |
| [953](#L953) | 'invalue' => esc\_html\_\_('increase by value', 'woo-bulk-editor'), |
| [954](#L954) | 'devalue' => esc\_html\_\_('decrease by value', 'woo-bulk-editor'), |
| [955](#L955) | 'inpercent' => esc\_html\_\_('increase by %', 'woo-bulk-editor'), |
| [956](#L956) | 'depercent' => esc\_html\_\_('decrease by %', 'woo-bulk-editor'), |
| [957](#L957) | 'new' => esc\_html\_\_('set new', 'woo-bulk-editor') |
| [958](#L958) | ); |
| [959](#L959) |  |
| [960](#L960) | $options2 = array( |
| [961](#L961) | 'invalue' => esc\_html\_\_('increase by value', 'woo-bulk-editor'), |
| [962](#L962) | 'devalue' => esc\_html\_\_('decrease by value', 'woo-bulk-editor'), |
| [963](#L963) | 'delete' => esc\_html\_\_('delete', 'woo-bulk-editor'), |
| [964](#L964) | 'new' => esc\_html\_\_('set new', 'woo-bulk-editor') |
| [965](#L965) | ); |
| [966](#L966) |  |
| [967](#L967) | //\*\*\* |
| [968](#L968) |  |
| [969](#L969) | $this->num\_keys = array( |
| [970](#L970) | 'regular\_price' => array( |
| [971](#L971) | 'title' => esc\_html\_\_('regular price', 'woo-bulk-editor'), |
| [972](#L972) | 'direct' => $fields['regular\_price']['direct'], |
| [973](#L973) | 'options' => array( |
| [974](#L974) | 'invalue' => esc\_html\_\_('increase by value', 'woo-bulk-editor'), |
| [975](#L975) | 'devalue' => esc\_html\_\_('decrease by value', 'woo-bulk-editor'), |
| [976](#L976) | 'inpercent' => esc\_html\_\_('increase by %', 'woo-bulk-editor'), |
| [977](#L977) | 'depercent' => esc\_html\_\_('decrease by %', 'woo-bulk-editor'), |
| [978](#L978) | 'inpercent\_sale\_price' => esc\_html\_\_('sale price plus %', 'woo-bulk-editor'), |
| [979](#L979) | 'invalue\_sale\_price' => esc\_html\_\_('sale price plus value', 'woo-bulk-editor'), |
| [980](#L980) | 'new' => esc\_html\_\_('set new', 'woo-bulk-editor') |
| [981](#L981) | ), |
| [982](#L982) | 'css\_classes' => isset($fields['regular\_price']['css\_classes']) ? $fields['regular\_price']['css\_classes'] : '' |
| [983](#L983) | ), |
| [984](#L984) | 'sale\_price' => array( |
| [985](#L985) | 'title' => esc\_html\_\_('sale price', 'woo-bulk-editor'), |
| [986](#L986) | 'direct' => $fields['sale\_price']['direct'], |
| [987](#L987) | 'options' => array( |
| [988](#L988) | 'invalue' => esc\_html\_\_('increase by value', 'woo-bulk-editor'), |
| [989](#L989) | 'devalue' => esc\_html\_\_('decrease by value', 'woo-bulk-editor'), |
| [990](#L990) | 'inpercent' => esc\_html\_\_('increase by %', 'woo-bulk-editor'), |
| [991](#L991) | 'depercent' => esc\_html\_\_('decrease by %', 'woo-bulk-editor'), |
| [992](#L992) | 'depercent\_regular\_price' => esc\_html\_\_('regular price minus %', 'woo-bulk-editor'), |
| [993](#L993) | 'devalue\_regular\_price' => esc\_html\_\_('regular price minus value', 'woo-bulk-editor'), |
| [994](#L994) | 'new' => esc\_html\_\_('set new', 'woo-bulk-editor') |
| [995](#L995) | ), |
| [996](#L996) | 'css\_classes' => isset($fields['sale\_price']['css\_classes']) ? $fields['sale\_price']['css\_classes'] : '' |
| [997](#L997) | ), |
| [998](#L998) | 'stock\_quantity' => array( |
| [999](#L999) | 'title' => esc\_html\_\_('in stock quantity', 'woo-bulk-editor'), |
| [1000](#L1000) | 'direct' => $fields['stock\_quantity']['direct'], |
| [1001](#L1001) | 'options' => $options2, |
| [1002](#L1002) | 'css\_classes' => isset($fields['stock\_quantity']['css\_classes']) ? $fields['stock\_quantity']['css\_classes'] : '' |
| [1003](#L1003) | ), |
| [1004](#L1004) | 'download\_expiry' => array( |
| [1005](#L1005) | 'title' => esc\_html\_\_('download expiry', 'woo-bulk-editor'), |
| [1006](#L1006) | 'direct' => $fields['download\_expiry']['direct'], |
| [1007](#L1007) | 'options' => $options2, |
| [1008](#L1008) | 'css\_classes' => isset($fields['download\_expiry']['css\_classes']) ? $fields['download\_expiry']['css\_classes'] : '' |
| [1009](#L1009) | ), |
| [1010](#L1010) | 'download\_limit' => array( |
| [1011](#L1011) | 'title' => esc\_html\_\_('download limit', 'woo-bulk-editor'), |
| [1012](#L1012) | 'direct' => $fields['download\_limit']['direct'], |
| [1013](#L1013) | 'options' => $options2, |
| [1014](#L1014) | 'css\_classes' => isset($fields['download\_limit']['css\_classes']) ? $fields['download\_limit']['css\_classes'] : '' |
| [1015](#L1015) | ) |
| [1016](#L1016) | ); |
| [1017](#L1017) | } |
| [1018](#L1018) |  |
| [1019](#L1019) | //ajax |
| [1020](#L1020) | public function woobe\_bulk\_draw\_gallery\_btn() { |
| [1021](#L1021) | $images = []; |
| [1022](#L1022) | parse\_str($\_REQUEST['images'], $images); //sanitize below in array\_map |
| [1023](#L1023) | $data = array(); |
| [1024](#L1024) | $woobe\_gallery\_images = isset($images['woobe\_gallery\_images']) ? $images['woobe\_gallery\_images'] : array(); |
| [1025](#L1025) | //sanitizing to intval |
| [1026](#L1026) | $woobe\_gallery\_images = array\_map(function ($item) { |
| [1027](#L1027) | return intval($item); //sanitize intval |
| [1028](#L1028) | }, $woobe\_gallery\_images); |
| [1029](#L1029) |  |
| [1030](#L1030) | $data['html'] = WOOBE\_HELPER::draw\_gallery\_popup\_editor\_btn(sanitize\_text\_field($\_REQUEST['field']), 0, $woobe\_gallery\_images); |
| [1031](#L1031) | $data['images\_ids'] = implode(',', $woobe\_gallery\_images); //for any case, but now we not need it because updating of products applies by serialized data |
| [1032](#L1032) |  |
| [1033](#L1033) |  |
| [1034](#L1034) | die(json\_encode($data)); |
| [1035](#L1035) | } |
| [1036](#L1036) |  |
| [1037](#L1037) | //ajax |
| [1038](#L1038) | public function woobe\_bulk\_draw\_download\_files\_btn() { |
| [1039](#L1039) | $files = []; |
| [1040](#L1040) | parse\_str($\_REQUEST['files'], $files); |
| [1041](#L1041) | $files = WOOBE\_HELPER::sanitize\_array($files); |
| [1042](#L1042) | $count = 0; |
| [1043](#L1043) |  |
| [1044](#L1044) | if (isset($files['\_wc\_file\_names'])) { |
| [1045](#L1045) | $count = count($files['\_wc\_file\_names']); |
| [1046](#L1046) | } |
| [1047](#L1047) |  |
| [1048](#L1048) | echo WOOBE\_HELPER::draw\_downloads\_popup\_editor\_btn(sanitize\_text\_field($\_REQUEST['field']), 0, $count); |
| [1049](#L1049) |  |
| [1050](#L1050) | exit; |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | //ajax |
| [1054](#L1054) | public function woobe\_bulk\_draw\_cross\_sells\_btn() { |
| [1055](#L1055) | $products = []; |
| [1056](#L1056) | parse\_str($\_REQUEST['products'], $products); |
| [1057](#L1057) |  |
| [1058](#L1058) | $ids = array(); |
| [1059](#L1059) | if (isset($products['woobe\_prod\_ids'])) { |
| [1060](#L1060) | $ids = $products['woobe\_prod\_ids']; |
| [1061](#L1061) | } |
| [1062](#L1062) |  |
| [1063](#L1063) | $ids = array\_map(function ($item) { |
| [1064](#L1064) | return intval($item); //sanitize intval |
| [1065](#L1065) | }, $ids); |
| [1066](#L1066) |  |
| [1067](#L1067) | echo WOOBE\_HELPER::draw\_cross\_sells\_popup\_editor\_btn(sanitize\_text\_field($\_REQUEST['field']), 0, $ids); |
| [1068](#L1068) |  |
| [1069](#L1069) | exit; |
| [1070](#L1070) | } |
| [1071](#L1071) |  |
| [1072](#L1072) | //ajax |
| [1073](#L1073) | public function woobe\_bulk\_draw\_upsell\_ids\_btn() { |
| [1074](#L1074) | $products = []; |
| [1075](#L1075) | parse\_str($\_REQUEST['products'], $products); |
| [1076](#L1076) |  |
| [1077](#L1077) | $ids = array(); |
| [1078](#L1078) | if (isset($products['woobe\_prod\_ids'])) { |
| [1079](#L1079) | $ids = array\_map(function ($item) { |
| [1080](#L1080) | return intval($item); //sanitize intval |
| [1081](#L1081) | }, $products['woobe\_prod\_ids']); |
| [1082](#L1082) | } |
| [1083](#L1083) |  |
| [1084](#L1084) | echo WOOBE\_HELPER::draw\_upsells\_popup\_editor\_btn($\_REQUEST['field'], 0, $ids); |
| [1085](#L1085) |  |
| [1086](#L1086) | exit; |
| [1087](#L1087) | } |
| [1088](#L1088) |  |
| [1089](#L1089) | //ajax |
| [1090](#L1090) | public function woobe\_bulk\_draw\_grouped\_ids\_btn() { |
| [1091](#L1091) | $products = []; |
| [1092](#L1092) | parse\_str($\_REQUEST['products'], $products); //sanitize below |
| [1093](#L1093) |  |
| [1094](#L1094) | $ids = array(); |
| [1095](#L1095) | if (isset($products['woobe\_prod\_ids'])) { |
| [1096](#L1096) | $ids = array\_map(function ($item) { |
| [1097](#L1097) | return intval($item); //sanitize intval |
| [1098](#L1098) | }, $products['woobe\_prod\_ids']); |
| [1099](#L1099) | } |
| [1100](#L1100) |  |
| [1101](#L1101) | echo WOOBE\_HELPER::draw\_grouped\_popup\_editor\_btn(sanitize\_text\_field($\_REQUEST['field']), 0, $ids); |
| [1102](#L1102) |  |
| [1103](#L1103) | exit; |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) | //ajax |
| [1107](#L1107) | public function woobe\_bulk\_get\_att\_terms() { |
| [1108](#L1108) |  |
| [1109](#L1109) | $drop\_downs = ''; |
| [1110](#L1110) | if (!empty($\_REQUEST['attributes'])) { |
| [1111](#L1111) | foreach ($\_REQUEST['attributes'] as $pa) { |
| [1112](#L1112) | $pa = sanitize\_text\_field($pa); //sanitize attribute name |
| [1113](#L1113) |  |
| [1114](#L1114) | $terms = WOOBE\_HELPER::get\_taxonomies\_terms\_hierarchy($pa); |
| [1115](#L1115) | if (!empty($terms)) { |
| [1116](#L1116) | $options = array(); |
| [1117](#L1117) | $options[''] = esc\_html\_\_('not selected', 'woo-bulk-editor'); |
| [1118](#L1118) | $options['-1'] = esc\_html\_\_('Any', 'woo-bulk-editor'); |
| [1119](#L1119) | foreach ($terms as $t) { |
| [1120](#L1120) | $options[$t['slug']] = $t['name']; |
| [1121](#L1121) | } |
| [1122](#L1122) |  |
| [1123](#L1123) | $drop\_downs .= WOOBE\_HELPER::draw\_select(array( |
| [1124](#L1124) | 'field' => 0, |
| [1125](#L1125) | 'product\_id' => 0, |
| [1126](#L1126) | 'class' => '', |
| [1127](#L1127) | 'options' => $options, |
| [1128](#L1128) | 'name' => 'woobe\_bulk[combination\_attributes][' . sanitize\_text\_field($\_REQUEST['hash\_key']) . '][' . $pa . ']' |
| [1129](#L1129) | )); |
| [1130](#L1130) | } |
| [1131](#L1131) | } |
| [1132](#L1132) | } |
| [1133](#L1133) |  |
| [1134](#L1134) | die($drop\_downs); |
| [1135](#L1135) | } |
| [1136](#L1136) |  |
| [1137](#L1137) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php?format=txt)
* [Original Format](/export/3222674/woo-bulk-editor/trunk/ext/bulk/bulk.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_c3dd90d2_20250115_082015.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# BEAR <= 1.1.3.3 - Cross-Site Request Forgery to Product Deletion

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   BEAR <= 1.1.3.3 - Cross-Site Request Forgery to Product Deletion

5.4

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:L)

| CVE | [CVE-2023-4926](https://www.cve.org/CVERecord?id=CVE-2023-4926) |
| --- | --- |
| CVSS | 5.4 (Medium) |
| Publicly Published | September 25, 2023 |
| Last Updated | October 20, 2023 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The BEAR for WordPress is vulnerable to Cross-Site Request Forgery in versions up to, and including, 1.1.3.3. This is due to missing or incorrect nonce validation on the woobe\_bulk\_delete\_products function. This makes it possible for unauthenticated attackers to delete products via a forged request granted they can trick a site administrator into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php#L159)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2970262/woo-bulk-editor/trunk/ext/bulk/bulk.php?contextall=1&old=2844667&old_path=%2Fwoo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-bulk-editor%2Fbear-1133-cross-site-request-forgery-to-product-deletion-1&t=BEAR%20%3C%3D%201.1.3.3%20-%20Cross-Site%20Request%20Forgery%20to%20Product%20Deletion "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-bulk-editor%2Fbear-1133-cross-site-request-forgery-to-product-deletion-1&text=BEAR%20%3C%3D%201.1.3.3%20-%20Cross-Site%20Request%20Forgery%20to%20Product%20Deletion "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-bulk-editor%2Fbear-1133-cross-site-request-forgery-to-product-deletion-1 "LinkedIn")
Email

## Vulnerability Details for BEAR – Bulk Editor and Products Manager Professional for WooCommerce by Pluginus.Net

#### [BEAR – Bulk Editor and Products Manager Professional for WooCommerce by Pluginus.Net](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/woo-bulk-editor)

| Software Type | Plugin |
| --- | --- |
| Software Slug | woo-bulk-editor [(view on wordpress.org)](https://wordpress.org/plugins/woo-bulk-editor) |
| Patched? | Yes |
| Remediation | Update to version 1.1.4, or a newer patched version |
| Affected Version | * <= 1.1.3.3 |
| Patched Version | * 1.1.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_47f3b94d_20250115_082014.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2970262%2Fwoo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php%3Fcontextall%3D1%26old%3D2844667%26old_path%3D%252Fwoo-bulk-editor%252Ftrunk%252Fext%252Fbulk%252Fbulk.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2844667/woo-bulk-editor/trunk/ext/bulk/bulk.php?old=2970262&old_path=%2Fwoo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php)

---

# Changes in [woo-bulk-editor/trunk/ext/bulk/bulk.php](/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php?rev=2970262 "Show entry in browser") [[2844667:2970262]](/log/woo-bulk-editor/trunk/ext/bulk/bulk.php?rev=2970262&stop_rev=2844667 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [woo-bulk-editor/trunk/ext/bulk/bulk.php](/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php?rev=2970262 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [woo-bulk-editor/trunk/ext/bulk/bulk.php](/changeset/2970262/woo-bulk-editor/trunk/ext/bulk/bulk.php?old=2844667&old_path=woo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php "Show the [2844667:2970262] differences restricted to woo-bulk-editor/trunk/ext/bulk/bulk.php")

  | [r2844667](/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php?rev=2844667#L1 "Show revision 2844667 of this file in browser") | [r2970262](/browser/woo-bulk-editor/trunk/ext/bulk/bulk.php?rev=2970262#L1 "Show revision 2970262 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | if (!defined('ABSPATH')) { |
  | 3 | 3 | exit; // Exit if accessed directly |
  | 4 | 4 | } |
  | 5 | 5 |  |
  | 6 | 6 | final class WOOBE\_BULK extends WOOBE\_EXT { |
  | 7 | 7 |  |
  | 8 | 8 | protected $slug = 'bulk'; //unique |
  | 9 | 9 | public $text\_keys = array(); |
  | 10 | 10 | public $num\_keys = array(); |
  | 11 | 11 | public $other\_keys = array(); |
  | 12 | 12 |  |
  | 13 | 13 | public function \_\_construct() { |
  | 14 | 14 |  |
  | 15 | 15 | $this->init\_bulk\_keys(); |
  | 16 | 16 |  |
  | 17 | 17 | add\_action('woobe\_ext\_scripts', array($this, 'woobe\_ext\_scripts'), 1); |
  | 18 | 18 | add\_action('woobe\_tools\_panel\_buttons\_end', array($this, 'woobe\_tools\_panel\_buttons\_end'), 1); |
  | 19 | 19 |  |
  | 20 | 20 | //ajax |
  | 21 | 21 | add\_action('wp\_ajax\_woobe\_bulk\_products\_count', array($this, 'woobe\_bulk\_products\_count'), 1); |
  | 22 | 22 | add\_action('wp\_ajax\_woobe\_bulk\_products', array($this, 'woobe\_bulk\_products'), 1); |
  | 23 | 23 | add\_action('wp\_ajax\_woobe\_bulk\_finish', array($this, 'woobe\_bulk\_finish'), 1); |
  | 24 | 24 | add\_action('wp\_ajax\_woobe\_bulk\_draw\_gallery\_btn', array($this, 'woobe\_bulk\_draw\_gallery\_btn'), 1); |
  | 25 | 25 | add\_action('wp\_ajax\_woobe\_bulk\_draw\_download\_files\_btn', array($this, 'woobe\_bulk\_draw\_download\_files\_btn'), 1); |
  | 26 | 26 | add\_action('wp\_ajax\_woobe\_bulk\_draw\_cross\_sells\_btn', array($this, 'woobe\_bulk\_draw\_cross\_sells\_btn'), 1); |
  | 27 | 27 | add\_action('wp\_ajax\_woobe\_bulk\_draw\_upsell\_ids\_btn', array($this, 'woobe\_bulk\_draw\_upsell\_ids\_btn'), 1); |
  | 28 | 28 | add\_action('wp\_ajax\_woobe\_bulk\_draw\_grouped\_ids\_btn', array($this, 'woobe\_bulk\_draw\_grouped\_ids\_btn'), 1); |
  | 29 | 29 | add\_action('wp\_ajax\_woobe\_bulk\_get\_att\_terms', array($this, 'woobe\_bulk\_get\_att\_terms'), 1); |
  | 30 | 30 |  |
  | 31 | 31 | add\_action('wp\_ajax\_woobe\_bulk\_delete\_products\_count', array($this, 'woobe\_bulk\_delete\_products\_count'), 1); |
  | 32 | 32 | add\_action('wp\_ajax\_woobe\_bulk\_delete\_products', array($this, 'woobe\_bulk\_delete\_products'), 1); |
  | 33 | 33 |  |
  | 34 | 34 | add\_action('woobe\_bulk\_going', array($this, 'woobe\_bulk\_going'), 10, 2); |
  | 35 | 35 |  |
  | 36 | 36 | //tabs |
  | 37 | 37 | $this->add\_tab($this->slug, 'top\_panel', esc\_html\_\_('Bulk Edit', 'woo-bulk-editor'), 'pencil'); |
  | 38 | 38 | add\_action('woobe\_ext\_top\_panel\_' . $this->slug, array($this, 'woobe\_ext\_panel'), 1); |
  | 39 | 39 | } |
  | 40 | 40 |  |
  | 41 | 41 | public function woobe\_ext\_scripts() { |
  | 42 | 42 | wp\_enqueue\_script('woobe\_ext\_' . $this->slug, $this->get\_ext\_link() . 'assets/js/' . $this->slug . '.js', array(), WOOBE\_VERSION); |
  | 43 | 43 | wp\_enqueue\_style('woobe\_ext\_' . $this->slug, $this->get\_ext\_link() . 'assets/css/' . $this->slug . '.css', array(), WOOBE\_VERSION); |
  | 44 | 44 | ?> |
  | 45 | 45 | <script> |
  | 46 | 46 | lang.<?php echo $this->slug ?> = {}; |
  | 47 | 47 | lang.<?php echo $this->slug ?>.want\_to\_bulk = "<?php echo esc\_html\_\_('Will be edited next:', 'woo-bulk-editor') ?>"; |
  | 48 | 48 | lang.<?php echo $this->slug ?>.want\_to\_delete = "<?php echo esc\_html\_\_('Sure? Delete products?', 'woo-bulk-editor') ?>"; |
  | 49 | 49 | lang.<?php echo $this->slug ?>.deleting = "<?php echo esc\_html\_\_('Bulk deleting', 'woo-bulk-editor') ?>"; |
  | 50 | 50 | lang.<?php echo $this->slug ?>.deleted = "<?php echo esc\_html\_\_('Product(s) deleted!', 'woo-bulk-editor') ?>"; |
  | 51 | 51 | lang.<?php echo $this->slug ?>.bulking = "<?php echo esc\_html\_\_('Bulk editing', 'woo-bulk-editor') ?> ..."; |
  | 52 | 52 | lang.<?php echo $this->slug ?>.bulked = "<?php echo esc\_html\_\_('Product(s) edited! Table redrawing ...', 'woo-bulk-editor') ?>"; |
  | 53 | 53 | lang.<?php echo $this->slug ?>.bulked2 = "<?php echo esc\_html\_\_('Product(s) edited!', 'woo-bulk-editor') ?>"; |
  | 54 | 54 | lang.<?php echo $this->slug ?>.bulk\_is\_going = "<?php echo esc\_html\_\_('ATTENTION: Bulk operation is going!', 'woo-bulk-editor') ?>"; |
  | 55 | 55 | </script> |
  | 56 | 56 | <?php |
  | 57 | 57 | } |
  | 58 | 58 |  |
  | 59 | 59 | public function woobe\_tools\_panel\_buttons\_end() { |
  | 60 | 60 | global $WOOBE; |
  | 61 | 61 | ?> |
  | 62 | 62 | &nbsp;|&nbsp;<span> |
  | 63 | 63 | <?php echo WOOBE\_HELPER::draw\_advanced\_switcher(0, 'woobe\_bind\_editing', '', array('true' => esc\_html\_\_('binded editing', 'woo-bulk-editor'), 'false' => esc\_html\_\_('binded editing', 'woo-bulk-editor')), array('true' => 1, 'false' => 0), 'js\_check\_woobe\_bind\_editing', 'woobe\_bind\_editing'); ?> |
  | 64 | 64 |  |
  | 65 | 65 | <?php |
  | 66 | 66 | $bind\_tooltip = ''; |
  | 67 | 67 | if ($WOOBE->show\_notes) { |
  | 68 | 68 | $fields = $WOOBE->settings->get\_fields(); |
  | 69 | 69 | if (!empty($fields)) { |
  | 70 | 70 | $bind\_tooltip = []; |
  | 71 | 71 | foreach ($fields as $field\_key => $f) { |
  | 72 | 72 | if ($f['direct']) { |
  | 73 | 73 | $t = strip\_tags($f['title']); |
  | 74 | 74 | if (!empty($t) AND $field\_key != 'ID') { |
  | 75 | 75 | $bind\_tooltip[] = $t; |
  | 76 | 76 | } |
  | 77 | 77 | } |
  | 78 | 78 | } |
  | 79 | 79 |  |
  | 80 | 80 | $bind\_tooltip = sprintf(esc\_html\_\_('In FREE version of the plugin you can change only next fields: %s', 'woo-bulk-editor'), implode(', ', $bind\_tooltip)); |
  | 81 | 81 | } |
  | 82 | 82 | } |
  | 83 | 83 | ?> |
  | 84 | 84 |  |
  | 85 | 85 | <?php echo WOOBE\_HELPER::draw\_tooltip(esc\_html\_\_('In this mode to the all selected products will be set the value of a product field which been edited', 'woo-bulk-editor') . '. ' . $bind\_tooltip) ?> |
  | 86 | 86 |  |
  | 87 | 87 | </span> |
  | 88 | 88 | <?php |
  | 89 | 89 | } |
  | 90 | 90 |  |
  | 91 | 91 | public function woobe\_ext\_panel() { |
  | 92 | 92 | $data = array(); |
  | 93 | 93 | $data['shop\_manager\_visibility'] = $this->settings->get\_shop\_manager\_visibility(); |
  | 94 | 94 | $data['text\_keys'] = $this->text\_keys; |
  | 95 | 95 | $data['num\_keys'] = $this->num\_keys; |
  | 96 | 96 | $data['other\_keys'] = $this->other\_keys; |
  | 97 | 97 | $data['settings\_fields'] = $this->settings->get\_fields(); |
  | 98 | 98 | echo WOOBE\_HELPER::render\_html($this->get\_ext\_path() . 'views/panel.php', $data); |
  | 99 | 99 | } |
  | 100 | 100 |  |
  | 101 | 101 | //ajax |
  | 102 | 102 | public function woobe\_bulk\_products\_count() { |
  | 103 | 103 | if (!current\_user\_can('manage\_woocommerce')) { |
  | 104 | 104 | die('0'); |
  | 105 | 105 | } |
  | 106 | 106 |  |
  |  | 107 | if (!isset($\_REQUEST['bulk\_form\_nonce']) || !wp\_verify\_nonce($\_REQUEST['bulk\_form\_nonce'], 'woobe\_bulk\_form\_nonce')) { |
  |  | 108 | die('0'); |
  |  | 109 | } |
  | 107 | 110 | //\*\*\* |
  | 108 | 111 |  |
  | 109 | 112 | $bulk\_data = array(); |
  | 110 | 113 |  |
  | 111 | 114 | if (!isset($\_REQUEST['woobe\_bind\_editing'])) { |
  | 112 | 115 | parse\_str($\_REQUEST['bulk\_data'], $bulk\_data); |
  | 113 | 116 |  |
  | 114 | 117 | $bulk\_data = WOOBE\_HELPER::sanitize\_array($bulk\_data); |
  | 115 | 118 | } else { |
  | 116 | 119 | //binded editing operation works |
  | 117 | 120 | if (is\_array($\_REQUEST['val'])) { |
  | 118 | 121 | $value = WOOBE\_HELPER::sanitize\_array($\_REQUEST['val']); |
  | 119 | 122 | } else { |
  | 120 | 123 | $value = wp\_kses($\_REQUEST['val'], wp\_kses\_allowed\_html('post')); |
  | 121 | 124 | $value = str\_replace("&amp;", "&", $value); |
  | 122 | 125 | } |
  | 123 | 126 |  |
  | 124 | 127 |  |
  | 125 | 128 | $field\_key = sanitize\_text\_field($\_REQUEST['field']); |
  | 126 | 129 |  |
  | 127 | 130 | //\*\*\* |
  | 128 | 131 |  |
  | 129 | 132 | $bulk\_data['woobe\_bulk'] = array( |
  | 130 | 133 | 'is' => array( |
  | 131 | 134 | $field\_key => 1 |
  | 132 | 135 | ), |
  | 133 | 136 | $field\_key => array( |
  | 134 | 137 | 'value' => $value, |
  | 135 | 138 | 'behavior' => sanitize\_text\_field($\_REQUEST['behavior']) |
  | 136 | 139 | ) |
  | 137 | 140 | ); |
  | 138 | 141 | } |
  | 139 | 142 |  |
  | 140 | 143 |  |
  | 141 | 144 | $this->storage->set\_val('woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key']), $bulk\_data['woobe\_bulk']); |
  | 142 | 145 |  |
  | 143 | 146 | if (!isset($\_REQUEST['no\_filter'])) { |
  | 144 | 147 | //get count of filtered - doesn work if bulk for checked products |
  | 145 | 148 | $products = $this->products->gets(array( |
  | 146 | 149 | 'fields' => 'ids', |
  | 147 | 150 | 'no\_found\_rows' => true |
  | 148 | 151 | )); |
  | 149 | 152 | echo json\_encode($products->posts); |
  | 150 | 153 | } |
  | 151 | 154 |  |
  | 152 | 155 | //\*\*\* |
  | 153 | 156 |  |
  | 154 | 157 | do\_action('woobe\_bulk\_started', WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key'])); |
  | 155 | 158 |  |
  | 156 | 159 | exit; |
  | 157 | 160 | } |
  | 158 | 161 |  |
  | 159 | 162 | public function woobe\_bulk\_delete\_products\_count() { |
  | 160 | 163 | if (!current\_user\_can('manage\_woocommerce')) { |
  | 161 | 164 | die('0'); |
  | 162 | 165 | } |
  | 163 |  |  |
  |  | 166 | if (!isset($\_REQUEST['bulk\_form\_nonce']) || !wp\_verify\_nonce($\_REQUEST['bulk\_form\_nonce'], 'woobe\_bulk\_form\_nonce')) { |
  |  | 167 | die('0'); |
  |  | 168 | } |
  | 164 | 169 | $bulk\_data = array(); |
  | 165 | 170 |  |
  | 166 | 171 | if (!isset($\_REQUEST['woobe\_bind\_editing'])) { |
  | 167 | 172 | parse\_str($\_REQUEST['bulk\_data'], $bulk\_data); |
  | 168 | 173 | $bulk\_data = WOOBE\_HELPER::sanitize\_array($bulk\_data); |
  | 169 | 174 | } else { |
  | 170 | 175 | //binded editing operation works |
  | 171 | 176 | if (is\_array($\_REQUEST['val'])) { |
  | 172 | 177 | $value = WOOBE\_HELPER::sanitize\_array($\_REQUEST['val']); |
  | 173 | 178 | } else { |
  | 174 | 179 | $value = wp\_kses($\_REQUEST['val'], wp\_kses\_allowed\_html('post')); |
  | 175 | 180 | } |
  | 176 | 181 |  |
  | 177 | 182 | $field\_key = sanitize\_text\_field($\_REQUEST['field']); |
  | 178 | 183 |  |
  | 179 | 184 | //\*\*\* |
  | 180 | 185 |  |
  | 181 | 186 | $bulk\_data['woobe\_bulk'] = array( |
  | 182 | 187 | 'is' => array( |
  | 183 | 188 | $field\_key => 1 |
  | 184 | 189 | ), |
  | 185 | 190 | $field\_key => array( |
  | 186 | 191 | 'value' => $value, |
  | 187 | 192 | 'behavior' => sanitize\_text\_field($\_REQUEST['behavior']) |
  | 188 | 193 | ) |
  | 189 | 194 | ); |
  | 190 | 195 | } |
  | 191 | 196 |  |
  | 192 | 197 |  |
  | 193 | 198 | $this->storage->set\_val('woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key']), $bulk\_data['woobe\_bulk']); |
  | 194 | 199 |  |
  | 195 | 200 | if (!isset($\_REQUEST['no\_filter'])) { |
  | 196 | 201 | //get count of filtered - doesn work if bulk for checked products |
  | 197 | 202 | $products = $this->products->gets(array( |
  | 198 | 203 | 'fields' => 'ids', |
  | 199 | 204 | 'no\_found\_rows' => true |
  | 200 | 205 | )); |
  | 201 | 206 | echo json\_encode($products->posts); |
  | 202 | 207 | } |
  | 203 | 208 |  |
  | 204 | 209 | exit; |
  | 205 | 210 | } |
  | 206 | 211 |  |
  | 207 | 212 | public function woobe\_bulk\_delete\_products() { |
  | 208 | 213 | if (!current\_user\_can('manage\_woocommerce')) { |
  | 209 | 214 | die('0'); |
  | 210 | 215 | } |
  | 211 | 216 | if (!isset($\_REQUEST['products\_ids'])) { |
  | 212 | 217 | die('0'); |
  | 213 | 218 | } |
  |  | 219 |  |
  |  | 220 | if (!isset($\_REQUEST['bulk\_form\_nonce']) || !wp\_verify\_nonce($\_REQUEST['bulk\_form\_nonce'], 'woobe\_bulk\_form\_nonce')) { |
  |  | 221 | die('0'); |
  |  | 222 | } |
  | 214 | 223 |  |
  | 215 | 224 | if (is\_array($\_REQUEST['products\_ids'])) { |
  | 216 | 225 | $is\_variations\_solo = intval($\_REQUEST['woobe\_show\_variations']); |
  | 217 | 226 |  |
  | 218 | 227 | $products\_ids = array\_map(function ($item) { |
  | 219 | 228 | return intval($item); //sanitize intval |
  | 220 | 229 | }, $\_REQUEST['products\_ids']); |
  | 221 | 230 |  |
  | 222 | 231 | //as we want to change variations only but have ids of parents - lets get variations ids |
  | 223 | 232 | if ($is\_variations\_solo AND!empty($products\_ids)) { |
  | 224 | 233 | $vars\_ids = array(); |
  | 225 | 234 | foreach ($products\_ids as $product\_id) { |
  | 226 | 235 | $product = $this->products->get\_product($product\_id); |
  | 227 | 236 | if ($product->is\_type('variable')) { |
  | 228 | 237 | $children = $product->get\_children(); |
  | 229 | 238 | if (!empty($children)) { |
  | 230 | 239 | $vars\_ids = array\_merge($vars\_ids, $children); |
  | 231 | 240 | } |
  | 232 | 241 | } |
  | 233 | 242 | } |
  | 234 | 243 | $products\_ids = array\_unique(array\_merge($products\_ids, $vars\_ids)); |
  | 235 | 244 | } |
  | 236 | 245 | $woobe\_bulk = $this->storage->get\_val('woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key'])); |
  | 237 | 246 |  |
  | 238 | 247 | foreach ($products\_ids as $id) { |
  | 239 | 248 | if ($is\_variations\_solo) { |
  | 240 | 249 |  |
  | 241 | 250 | //lets check that currenct variation has the same attributes combination |
  | 242 | 251 | if (isset($woobe\_bulk['combination\_attributes']) AND!empty($woobe\_bulk['combination\_attributes'])) { |
  | 243 | 252 |  |
  | 244 | 253 | $variation = $this->products->get\_product($id); |
  | 245 | 254 | $attributes = $variation->get\_attributes(); |
  | 246 | 255 |  |
  | 247 | 256 | //\*\*\* |
  | 248 | 257 |  |
  | 249 | 258 | $go = FALSE; |
  | 250 | 259 |  |
  | 251 | 260 | //\*\*\* |
  | 252 | 261 |  |
  | 253 | 262 | if (!empty($attributes)) { |
  | 254 | 263 | foreach ($woobe\_bulk['combination\_attributes'] as $comb) { |
  | 255 | 264 | //lets look is $attributes the same set of attributes as in $comb |
  | 256 | 265 | $ak\_att = array\_keys($attributes); |
  | 257 | 266 | $ak\_cv = array\_keys($comb); |
  | 258 | 267 |  |
  | 259 | 268 | //fix for non-latin symbols |
  | 260 | 269 | if (!empty($ak\_att)) { |
  | 261 | 270 | $ak\_att = array\_map('urldecode', $ak\_att); |
  | 262 | 271 | } |
  | 263 | 272 |  |
  | 264 | 273 | //fix for non-latin symbols |
  | 265 | 274 | if (!empty($ak\_cv)) { |
  | 266 | 275 | $ak\_cv = array\_map('urldecode', $ak\_cv); |
  | 267 | 276 | } |
  | 268 | 277 |  |
  | 269 | 278 | sort($ak\_att); |
  | 270 | 279 | sort($ak\_cv); |
  | 271 | 280 |  |
  | 272 | 281 | if ($ak\_att === $ak\_cv) { |
  | 273 |  | $av\_att = array\_values($attributes); |
  | 274 |  | $av\_cv = array\_values($comb); |
  |  | 282 |  |
  |  | 283 | $new\_attributes = $attributes; |
  |  | 284 | $new\_comb = $comb; |
  |  | 285 | if (in\_array('-1',$comb)){ |
  |  | 286 | $delete\_keys = array\_keys($comb, '-1',); |
  |  | 287 |  |
  |  | 288 | foreach ($delete\_keys as $d\_key) { |
  |  | 289 | if (isset($new\_attributes[$d\_key])) { |
  |  | 290 | unset($new\_attributes[$d\_key]); |
  |  | 291 | unset($new\_comb[$d\_key]); |
  |  | 292 | } |
  |  | 293 | } |
  |  | 294 |  |
  |  | 295 | } |
  |  | 296 |  |
  |  | 297 | $av\_att = array\_values($new\_attributes); |
  |  | 298 | $av\_cv = array\_values($new\_comb); |
  | 275 | 299 |  |
  | 276 | 300 | //fix for non-latin symbols |
  | 277 | 301 | if (!empty($ak\_att)) { |
  | 278 | 302 | $av\_att = array\_map('urldecode', $av\_att); |
  | 279 | 303 | } |
  | 280 | 304 |  |
  | 281 | 305 |  |
  | 282 | 306 | if (!empty($av\_cv)) { |
  | 283 | 307 | $av\_cv = array\_map('urldecode', $av\_cv); |
  | 284 | 308 | } |
  | 285 | 309 |  |
  | 286 | 310 | sort($av\_att); |
  | 287 | 311 | sort($av\_cv); |
  |  | 312 |  |
  | 288 | 313 | if ($av\_att === $av\_cv) { |
  | 289 | 314 | $go = TRUE; |
  | 290 | 315 | break; |
  | 291 | 316 | } |
  | 292 | 317 | } |
  | 293 | 318 | } |
  | 294 | 319 | } |
  | 295 | 320 |  |
  | 296 | 321 | //\*\*\* |
  | 297 | 322 |  |
  | 298 | 323 | if (!$go) { |
  | 299 | 324 | continue; |
  | 300 | 325 | } |
  | 301 | 326 | } |
  | 302 | 327 | } |
  | 303 | 328 | //wp\_delete\_post($id,false); |
  | 304 | 329 | wp\_trash\_post(intval($id)); |
  | 305 | 330 | } |
  | 306 | 331 | } else { |
  | 307 | 332 | die('0'); |
  | 308 | 333 | } |
  | 309 | 334 |  |
  | 310 | 335 | die(json\_encode($\_REQUEST['products\_ids'])); |
  | 311 | 336 | exit; |
  | 312 | 337 | } |
  | 313 | 338 |  |
  | 314 | 339 | //ajax |
  | 315 | 340 | public function woobe\_bulk\_products() { |
  | 316 | 341 | if (!current\_user\_can('manage\_woocommerce')) { |
  | 317 | 342 | die('0'); |
  | 318 | 343 | } |
  | 319 | 344 |  |
  | 320 | 345 | if (!isset($\_REQUEST['products\_ids'])) { |
  | 321 | 346 | die('0'); |
  | 322 | 347 | } |
  | 323 |  |  |
  |  | 348 | if (!isset($\_REQUEST['bulk\_form\_nonce']) || !wp\_verify\_nonce($\_REQUEST['bulk\_form\_nonce'], 'woobe\_bulk\_form\_nonce')) { |
  |  | 349 | die('0'); |
  |  | 350 | } |
  | 324 | 351 | //\*\*\* |
  | 325 | 352 |  |
  | 326 | 353 | $fields = $this->settings->get\_fields(); |
  | 327 | 354 | $woobe\_bulk = $this->storage->get\_val('woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key'])); |
  | 328 | 355 | //key for history bulk opearation, not related to products keys |
  | 329 | 356 | $\_REQUEST['woobe\_bulk\_key'] = WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key']); |
  | 330 | 357 |  |
  | 331 | 358 | $is\_variations\_solo = intval($\_REQUEST['woobe\_show\_variations']); |
  | 332 | 359 | $products\_ids = $\_REQUEST['products\_ids']; //sanitize in cycle below |
  | 333 | 360 | //\*\*\* |
  | 334 | 361 | //as we want to change variations only but have ids of parents - lets get variations ids |
  | 335 | 362 | if ($is\_variations\_solo AND!empty($products\_ids)) { |
  | 336 | 363 | $vars\_ids = array(); |
  | 337 | 364 | foreach ($products\_ids as $product\_id) { |
  | 338 | 365 | $product\_id = intval($product\_id); //sanitize |
  | 339 | 366 |  |
  | 340 | 367 | $product = $this->products->get\_product($product\_id); |
  | 341 | 368 | if ($product->is\_type('variable')) { |
  | 342 | 369 | $children = $product->get\_children(); |
  | 343 | 370 | if (!empty($children)) { |
  | 344 | 371 | $vars\_ids = array\_merge($vars\_ids, $children); |
  | 345 | 372 | } |
  | 346 | 373 | } |
  | 347 | 374 | } |
  | 348 | 375 |  |
  | 349 | 376 | $products\_ids = array\_unique(array\_merge($products\_ids, $vars\_ids)); |
  | 350 | 377 | } |
  | 351 | 378 |  |
  | 352 | 379 | //\*\*\* |
  | 353 | 380 |  |
  | 354 | 381 | if (isset($woobe\_bulk['is']) AND!empty($woobe\_bulk['is']) AND!empty($products\_ids)) { |
  | 355 | 382 |  |
  | 356 | 383 | //\*\*\* |
  | 357 | 384 |  |
  | 358 | 385 | foreach ($woobe\_bulk['is'] as $field\_key => $is) { |
  | 359 | 386 |  |
  | 360 | 387 | if ($fields[$field\_key]['edit\_view'] === 'calendar') { |
  | 361 | 388 |  |
  | 362 | 389 |  |
  | 363 | 390 | if (!is\_int($woobe\_bulk[$field\_key]['value']) AND (isset($fields[$field\_key]["field\_type"]) AND $fields[$field\_key]["field\_type"] == "meta")) { |
  | 364 | 391 | $woobe\_bulk[$field\_key]['value'] = strtotime($woobe\_bulk[$field\_key]['value']); // - wrong way |
  | 365 | 392 | } else { |
  | 366 | 393 | $woobe\_bulk[$field\_key]['value'] = $this->products->normalize\_calendar\_date($woobe\_bulk[$field\_key]['value'], $field\_key); |
  | 367 | 394 | } |
  | 368 | 395 | } |
  | 369 | 396 |  |
  | 370 | 397 | //\*\*\* |
  | 371 | 398 | //speedfix |
  | 372 | 399 | wp\_defer\_term\_counting(false); |
  | 373 | 400 | wp\_defer\_comment\_counting(true); |
  | 374 | 401 |  |
  | 375 | 402 | //\*\*\* |
  | 376 | 403 |  |
  | 377 | 404 | if (intval($is) === 1) { |
  | 378 | 405 |  |
  | 379 | 406 | foreach ($products\_ids as $product\_id) { |
  | 380 | 407 |  |
  | 381 | 408 | if ($is\_variations\_solo) { |
  | 382 | 409 | //if enabled editing of variations only parent-products are ignored |
  | 383 | 410 | $product = $this->products->get\_product($product\_id); |
  | 384 | 411 | if (!$product->is\_type('variation')) { |
  | 385 | 412 | continue; |
  | 386 | 413 | } |
  | 387 | 414 |  |
  | 388 | 415 | //lets check that currenct variation has the same attributes combination |
  | 389 | 416 | if (isset($woobe\_bulk['combination\_attributes']) AND!empty($woobe\_bulk['combination\_attributes'])) { |
  | 390 | 417 |  |
  | 391 | 418 | $variation = $this->products->get\_product($product\_id); |
  | 392 | 419 | $attributes = $variation->get\_attributes(); |
  | 393 | 420 |  |
  | 394 | 421 | //\*\*\* |
  | 395 | 422 |  |
  | 396 | 423 | $go = FALSE; |
  | 397 | 424 |  |
  | 398 | 425 | //\*\*\* |
  | 399 | 426 |  |
  | 400 | 427 | if (!empty($attributes)) { |
  | 401 | 428 | foreach ($woobe\_bulk['combination\_attributes'] as $comb) { |
  | 402 | 429 | //lets look is $attributes the same set of attributes as in $comb |
  | 403 | 430 | $ak\_att = array\_keys($attributes); |
  | 404 | 431 | $ak\_cv = array\_keys($comb); |
  | 405 | 432 |  |
  | 406 | 433 | //fix for non-latin symbols |
  | 407 | 434 | if (!empty($ak\_att)) { |
  | 408 | 435 | $ak\_att = array\_map('urldecode', $ak\_att); |
  | 409 | 436 | } |
  | 410 | 437 |  |
  | 411 | 438 | //fix for non-latin symbols |
  | 412 | 439 | if (!empty($ak\_cv)) { |
  | 413 | 440 | $ak\_cv = array\_map('urldecode', $ak\_cv); |
  | 414 | 441 | } |
  | 415 | 442 |  |
  | 416 | 443 | sort($ak\_att); |
  | 417 | 444 | sort($ak\_cv); |
  | 418 | 445 |  |
  | 419 | 446 | if ($ak\_att === $ak\_cv) { |
  | 420 | 447 | $new\_attributes = $attributes; |
  | 421 | 448 | $new\_comb = $comb; |
  | 422 | 449 | if (in\_array('-1',$comb)){ |
  | 423 | 450 | $delete\_keys = array\_keys($comb, '-1',); |
  | 424 | 451 |  |
  | 425 | 452 | foreach ($delete\_keys as $d\_key) { |
  | 426 | 453 | if (isset($new\_attributes[$d\_key])) { |
  | 427 | 454 | unset($new\_attributes[$d\_key]); |
  | 428 | 455 | unset($new\_comb[$d\_key]); |
  | 429 | 456 | } |
  | 430 | 457 | } |
  | 431 | 458 |  |
  | 432 | 459 | } |
  | 433 | 460 |  |
  | 434 | 461 | $av\_att = array\_values($new\_attributes); |
  | 435 | 462 | $av\_cv = array\_values($new\_comb); |
  | 436 | 463 |  |
  | 437 | 464 | //fix for non-latin symbols |
  | 438 | 465 | if (!empty($ak\_att)) { |
  | 439 | 466 | $av\_att = array\_map('urldecode', $av\_att); |
  | 440 | 467 | } |
  | 441 | 468 |  |
  | 442 | 469 | if (!empty($av\_cv)) { |
  | 443 | 470 | $av\_cv = array\_map('urldecode', $av\_cv); |
  | 444 | 471 | } |
  | 445 | 472 |  |
  | 446 | 473 | sort($av\_att); |
  | 447 | 474 | sort($av\_cv); |
  | 448 | 475 | if ($av\_att === $av\_cv) { |
  | 449 | 476 | $go = TRUE; |
  | 450 | 477 | break; |
  | 451 | 478 | } |
  | 452 | 479 | } |
  | 453 | 480 | } |
  | 454 | 481 | } |
  | 455 | 482 |  |
  | 456 | 483 | //\*\*\* |
  | 457 | 484 |  |
  | 458 | 485 | if (!$go) { |
  | 459 | 486 | continue; |
  | 460 | 487 | } |
  | 461 | 488 | } |
  | 462 | 489 | } |
  | 463 | 490 |  |
  | 464 | 491 | //\*\*\* |
  | 465 | 492 |  |
  | 466 | 493 |  |
  | 467 | 494 | switch ($field\_key) { |
  | 468 | 495 | case 'post\_title': |
  | 469 | 496 | case 'post\_content': |
  | 470 | 497 | case 'post\_excerpt': |
  | 471 | 498 | case 'post\_name': |
  | 472 | 499 | case 'purchase\_note': |
  | 473 | 500 | case 'sku': |
  | 474 | 501 | case 'tax\_class': |
  | 475 | 502 | case 'backorders': |
  | 476 | 503 | case 'sold\_individually': |
  | 477 | 504 | case 'reviews\_allowed': |
  | 478 | 505 | case 'product\_url': |
  | 479 | 506 | case 'button\_text': |
  | 480 | 507 | $this->\_process\_text\_data($woobe\_bulk, $field\_key, $product\_id); |
  | 481 | 508 | break; |
  | 482 | 509 |  |
  | 483 | 510 | case 'post\_status': |
  | 484 | 511 | case 'stock\_status': |
  | 485 | 512 | case 'manage\_stock': |
  | 486 | 513 | case 'tax\_status': |
  | 487 | 514 | case 'catalog\_visibility': |
  | 488 | 515 | case 'product\_type': |
  | 489 | 516 | case 'featured': |
  | 490 | 517 | case 'virtual': |
  | 491 | 518 | case 'downloadable': |
  | 492 | 519 | case 'download\_files': |
  | 493 | 520 | case 'gallery': |
  | 494 | 521 | case 'upsell\_ids': |
  | 495 | 522 | case 'cross\_sell\_ids': |
  | 496 | 523 | case 'grouped\_ids': |
  | 497 | 524 | case 'post\_date': |
  | 498 | 525 | if (intval($woobe\_bulk[$field\_key]['value']) !== -1) { |
  | 499 | 526 | $this->products->update\_page\_field($product\_id, $field\_key, $woobe\_bulk[$field\_key]['value']); |
  | 500 | 527 | } |
  | 501 | 528 | break; |
  | 502 | 529 | case 'attribute\_visibility': |
  | 503 | 530 |  |
  | 504 | 531 | if (!isset($woobe\_bulk[$field\_key]['value']) OR!is\_array($woobe\_bulk[$field\_key]['value'])) { |
  | 505 | 532 |  |
  | 506 | 533 | $woobe\_bulk[$field\_key]['value'] = array(); |
  | 507 | 534 | } |
  | 508 | 535 | if (!isset($woobe\_bulk[$field\_key]['visible'])) { |
  | 509 | 536 | $woobe\_bulk[$field\_key]['visible'] = 1; |
  | 510 | 537 | } |
  | 511 | 538 | $this->products->set\_product\_attributes\_visible($product\_id, $woobe\_bulk[$field\_key]['value'], $woobe\_bulk[$field\_key]['visible']); |
  | 512 | 539 |  |
  | 513 | 540 | break; |
  | 514 | 541 | case 'regular\_price': |
  | 515 | 542 | case 'sale\_price': |
  | 516 | 543 | case 'stock\_quantity': |
  | 517 | 544 | case 'download\_expiry': |
  | 518 | 545 | case 'download\_limit': |
  | 519 | 546 | case 'date\_on\_sale\_from': |
  | 520 | 547 | case 'date\_on\_sale\_to': |
  | 521 | 548 | case 'weight': |
  | 522 | 549 | case 'length': |
  | 523 | 550 | case 'width': |
  | 524 | 551 | case 'height': |
  | 525 | 552 | case 'product\_shipping\_class': |
  | 526 | 553 | case 'menu\_order': |
  | 527 | 554 | case 'post\_author': |
  | 528 | 555 | case 'total\_sales': |
  | 529 | 556 | case 'review\_count': |
  | 530 | 557 | case 'average\_rating': |
  | 531 | 558 | $this->\_process\_number\_data($woobe\_bulk, $field\_key, $product\_id); |
  | 532 | 559 | break; |
  | 533 | 560 |  |
  | 534 | 561 | default: |
  | 535 | 562 | break; |
  | 536 | 563 | } |
  | 537 | 564 |  |
  | 538 | 565 | //\*\*\* |
  | 539 | 566 |  |
  | 540 | 567 | if (isset($fields[$field\_key]) AND $fields[$field\_key]['field\_type'] === 'taxonomy') { |
  | 541 | 568 | //if (!empty($woobe\_bulk[$field\_key]['value'])) { |
  | 542 | 569 | do\_action('woobe\_before\_update\_page\_field', $field\_key, $product\_id, 0); //for the History |
  | 543 | 570 | if (!isset($woobe\_bulk[$field\_key]['behavior'])) { |
  | 544 | 571 | $woobe\_bulk[$field\_key]['behavior'] = ""; |
  | 545 | 572 | } |
  | 546 | 573 | switch ($woobe\_bulk[$field\_key]['behavior']) { |
  | 547 | 574 | case 'append': |
  | 548 | 575 | if (is\_taxonomy\_hierarchical($field\_key)) { |
  | 549 | 576 | wp\_set\_post\_terms($product\_id, $woobe\_bulk[$field\_key]['value'], $field\_key, true); |
  | 550 | 577 | } else { |
  | 551 | 578 | //product\_tag for example |
  | 552 | 579 | foreach ($woobe\_bulk[$field\_key]['value'] as $term\_id) { |
  | 553 | 580 | $t = get\_term\_by('id', $term\_id, $field\_key); |
  | 554 | 581 | wp\_set\_post\_terms($product\_id, $t->slug, $field\_key, true); |
  | 555 | 582 | } |
  | 556 | 583 | } |
  | 557 | 584 | break; |
  | 558 | 585 | case 'replace': |
  | 559 | 586 | case 'new': |
  | 560 | 587 | if (is\_taxonomy\_hierarchical($field\_key)) { |
  | 561 | 588 | wp\_set\_post\_terms($product\_id, $woobe\_bulk[$field\_key]['value'], $field\_key, false); |
  | 562 | 589 | } else { |
  | 563 | 590 | //product\_tag for example |
  | 564 | 591 | $append = false; //clean previous by first one then append |
  | 565 | 592 | if (!empty($woobe\_bulk[$field\_key]['value']) AND is\_array($woobe\_bulk[$field\_key]['value'])) { |
  | 566 | 593 | foreach ($woobe\_bulk[$field\_key]['value'] as $term\_id) { |
  | 567 | 594 | $t = get\_term\_by('id', $term\_id, $field\_key); |
  | 568 | 595 | wp\_set\_post\_terms($product\_id, $t->slug, $field\_key, $append); |
  | 569 | 596 | $append = true; |
  | 570 | 597 | } |
  | 571 | 598 | } |
  | 572 | 599 | } |
  | 573 | 600 | break; |
  | 574 | 601 | case 'remove': |
  | 575 | 602 | foreach ($woobe\_bulk[$field\_key]['value'] as $term\_id) { |
  | 576 | 603 | $t = get\_term\_by('id', $term\_id, $field\_key); |
  | 577 | 604 | wp\_remove\_object\_terms($product\_id, $t->slug, $field\_key); |
  | 578 | 605 | } |
  | 579 | 606 | break; |
  | 580 | 607 | } |
  | 581 | 608 | //} |
  | 582 | 609 | } |
  | 583 | 610 |  |
  | 584 | 611 | //\*\*\* |
  | 585 | 612 |  |
  | 586 | 613 | if (isset($fields[$field\_key]) AND $fields[$field\_key]['field\_type'] === 'attribute') { |
  | 587 | 614 | if (!isset($woobe\_bulk[$field\_key]['value'])) { |
  | 588 | 615 | $woobe\_bulk[$field\_key]['value'] = ''; |
  | 589 | 616 | } |
  | 590 | 617 | do\_action('woobe\_before\_update\_page\_field', $field\_key, $product\_id, 0); //for the History |
  | 591 | 618 | $this->products->set\_product\_attributes($product\_id, $field\_key, $woobe\_bulk[$field\_key]['value'], $woobe\_bulk[$field\_key]['behavior']); |
  | 592 | 619 | } |
  | 593 | 620 |  |
  | 594 | 621 | //\*\*\* |
  | 595 | 622 |  |
  | 596 | 623 | if (isset($fields[$field\_key]) AND $fields[$field\_key]['field\_type'] === 'meta') { |
  | 597 | 624 | switch ($fields[$field\_key]['type']) { |
  | 598 | 625 | case 'string': |
  | 599 | 626 |  |
  | 600 | 627 | //if data is serialized in ine string |
  | 601 | 628 | if ($fields[$field\_key]['edit\_view'] == 'meta\_popup\_editor') { |
  | 602 | 629 | if (!is\_array($woobe\_bulk[$field\_key]['value'])) { |
  | 603 | 630 |  |
  | 604 | 631 | //if not else parsed |
  | 605 | 632 | parse\_str($woobe\_bulk[$field\_key]['value'], $meta\_val); |
  | 606 | 633 |  |
  | 607 | 634 | $woobe\_bulk[$field\_key]['value'] = $this->products->process\_jsoned\_meta\_data($meta\_val); |
  | 608 | 635 | } |
  | 609 | 636 | } |
  | 610 | 637 | //\*\*\* |
  | 611 | 638 | if ($fields[$field\_key]['edit\_view'] == 'gallery\_popup\_editor') { |
  | 612 | 639 |  |
  | 613 | 640 | if (!is\_array($woobe\_bulk[$field\_key]['value'])) { |
  | 614 | 641 | //if not else parsed |
  | 615 | 642 | parse\_str($woobe\_bulk[$field\_key]['value'], $meta\_val); |
  | 616 | 643 | if (!empty($meta\_val['woobe\_gallery\_images'])) { |
  | 617 | 644 | $woobe\_bulk[$field\_key]['value'] = $meta\_val; |
  | 618 | 645 | } |
  | 619 | 646 | } |
  | 620 | 647 |  |
  | 621 | 648 | } |
  | 622 | 649 | //\*\*\* |
  | 623 | 650 |  |
  | 624 | 651 | if ($fields[$field\_key]['edit\_view'] !== 'switcher') { |
  | 625 | 652 | $this->\_process\_text\_data($woobe\_bulk, $field\_key, $product\_id); |
  | 626 | 653 | } else { |
  | 627 | 654 | if (intval($woobe\_bulk[$field\_key]['value']) !== -1) { |
  | 628 | 655 | $this->products->update\_page\_field($product\_id, $field\_key, intval($woobe\_bulk[$field\_key]['value'])); |
  | 629 | 656 | } |
  | 630 | 657 | } |
  | 631 | 658 | break; |
  | 632 | 659 |  |
  | 633 | 660 | case 'number': |
  | 634 | 661 | $this->\_process\_number\_data($woobe\_bulk, $field\_key, $product\_id); |
  | 635 | 662 | break; |
  | 636 | 663 |  |
  | 637 | 664 | default: |
  | 638 | 665 | break; |
  | 639 | 666 | } |
  | 640 | 667 | } |
  | 641 | 668 | } |
  | 642 | 669 | } |
  | 643 | 670 | } |
  | 644 | 671 |  |
  | 645 | 672 | do\_action('woobe\_bulk\_going', sanitize\_text\_field($\_REQUEST['woobe\_bulk\_key']), count($products\_ids)); |
  | 646 | 673 | } |
  | 647 | 674 |  |
  | 648 | 675 |  |
  | 649 | 676 |  |
  | 650 | 677 | die('done'); |
  | 651 | 678 | } |
  | 652 | 679 |  |
  | 653 | 680 | public function woobe\_bulk\_going($bulk\_key, $products\_count) { |
  | 654 | 681 | $count\_key = 'woobe\_bulk\_' . strtolower($bulk\_key) . '\_count'; |
  | 655 | 682 | $count\_now = intval($this->storage->get\_val($count\_key)); |
  | 656 | 683 | $this->storage->set\_val($count\_key, $products\_count + $count\_now); |
  | 657 | 684 | } |
  | 658 | 685 |  |
  | 659 | 686 | private function \_process\_text\_data($woobe\_bulk, $field\_key, $product\_id) { |
  | 660 | 687 | //if (!empty($woobe\_bulk[$field\_key]['value'])) { |
  | 661 | 688 | $val = $this->products->get\_post\_field($product\_id, $field\_key); |
  | 662 | 689 | $woobe\_bulk[$field\_key]['value'] = $this->products->string\_macros($woobe\_bulk[$field\_key]['value'], $field\_key, $product\_id); |
  | 663 | 690 | switch ($woobe\_bulk[$field\_key]['behavior']) { |
  | 664 | 691 | case 'append': |
  | 665 | 692 | $val = $this->products->string\_replacer($val . $woobe\_bulk[$field\_key]['value'], $product\_id); |
  | 666 | 693 | break; |
  | 667 | 694 | case 'prepend': |
  | 668 | 695 | $val = $this->products->string\_replacer($woobe\_bulk[$field\_key]['value'] . $val, $product\_id); |
  | 669 | 696 | break; |
  | 670 | 697 | case 'new': |
  | 671 | 698 | $val = $this->products->string\_replacer($woobe\_bulk[$field\_key]['value'], $product\_id); |
  | 672 | 699 | break; |
  | 673 | 700 | case 'replace': |
  | 674 | 701 | $replace\_to = $this->products->string\_replacer($woobe\_bulk[$field\_key]['replace\_to'], $product\_id); |
  | 675 | 702 | $replace\_from = $this->products->string\_replacer($woobe\_bulk[$field\_key]['value'], $product\_id); |
  | 676 | 703 |  |
  | 677 | 704 | //fix  for  apostrophe |
  | 678 | 705 | $replace\_from = str\_replace("\'", "'", $replace\_from); |
  | 679 | 706 |  |
  | 680 | 707 | if ($woobe\_bulk[$field\_key]['case'] == 'ignore') { |
  | 681 | 708 | $val = str\_ireplace($replace\_from, $replace\_to, $val); |
  | 682 | 709 | } else { |
  | 683 | 710 | $val = str\_replace($replace\_from, $replace\_to, $val); |
  | 684 | 711 | /\* |
  | 685 | 712 | \* https://stackoverflow.com/questions/19317493/php-preg-replace-case-insensitive-match-with-case-sensitive-replacement |
  | 686 | 713 | $val = preg\_replace\_callback('/\b' . $replace\_from . '\b/i', function($matches) use ($replace\_to) { |
  | 687 | 714 | $i = 0; |
  | 688 | 715 | return join('', array\_map(function($char) use ($matches, &$i) { |
  | 689 | 716 | return ctype\_lower($matches[0][$i++]) ? strtolower($char) : strtoupper($char); |
  | 690 | 717 | }, str\_split($replace\_to))); |
  | 691 | 718 | }, $val); |
  | 692 | 719 | \* |
  | 693 | 720 | \*/ |
  | 694 | 721 | } |
  | 695 | 722 |  |
  | 696 | 723 | break; |
  | 697 | 724 | } |
  | 698 | 725 |  |
  | 699 | 726 | //\*\*\* |
  | 700 | 727 | $empty\_exceptions = array('tax\_class'); //setting empty values is possible with this fields |
  | 701 | 728 |  |
  | 702 | 729 | $can = true; //!empty($val); |
  | 703 | 730 |  |
  | 704 | 731 | if (in\_array($field\_key, $empty\_exceptions)) { |
  | 705 | 732 | $can = true; |
  | 706 | 733 | } |
  | 707 | 734 |  |
  | 708 | 735 | if ($can) { |
  | 709 | 736 |  |
  | 710 | 737 | $val = $this->products->update\_page\_field($product\_id, $field\_key, $val); |
  | 711 | 738 | } |
  | 712 | 739 | //} |
  | 713 | 740 | } |
  | 714 | 741 |  |
  | 715 | 742 | private function \_process\_number\_data($woobe\_bulk, $field\_key, $product\_id) { |
  | 716 | 743 | if ($woobe\_bulk[$field\_key]['behavior'] != 'new') { |
  | 717 | 744 | $val = floatval($this->products->get\_post\_field($product\_id, $field\_key)); |
  | 718 | 745 | } |
  | 719 | 746 |  |
  | 720 | 747 | //\*\*\* |
  | 721 | 748 |  |
  | 722 | 749 | switch ($woobe\_bulk[$field\_key]['behavior']) { |
  | 723 | 750 | case 'new': |
  | 724 | 751 | $val = floatval($woobe\_bulk[$field\_key]['value']); |
  | 725 | 752 | break; |
  | 726 | 753 |  |
  | 727 | 754 | case 'invalue': |
  | 728 | 755 | $val += floatval($woobe\_bulk[$field\_key]['value']); |
  | 729 | 756 | break; |
  | 730 | 757 |  |
  | 731 | 758 | case 'devalue': |
  | 732 | 759 | $val -= floatval($woobe\_bulk[$field\_key]['value']); |
  | 733 | 760 | break; |
  | 734 | 761 |  |
  | 735 | 762 | case 'inpercent': |
  | 736 | 763 | $val = $val + $val \* floatval($woobe\_bulk[$field\_key]['value']) / 100; |
  | 737 | 764 | break; |
  | 738 | 765 |  |
  | 739 | 766 | case 'depercent': |
  | 740 | 767 | $val = $val - $val \* floatval($woobe\_bulk[$field\_key]['value']) / 100; |
  | 741 | 768 | break; |
  | 742 | 769 |  |
  | 743 | 770 | case 'devalue\_regular\_price': |
  | 744 | 771 | //for sale\_price only |
  | 745 |  | $val = ~~$this->products->get\_post\_field($product\_id, 'regular\_price'~~) - floatval($woobe\_bulk[$field\_key]['value']); |
  |  | 772 | $val = floatval($this->products->get\_post\_field($product\_id, 'regular\_price')) - floatval($woobe\_bulk[$field\_key]['value']); |
  | 746 | 773 | break; |
  | 747 | 774 |  |
  | 748 | 775 | case 'depercent\_regular\_price': |
  | 749 | 776 | //for sale\_price only |
  | 750 |  | $val = ~~$this->products->get\_post\_field($product\_id, 'regular\_price'~~); |
  |  | 777 | $val = floatval($this->products->get\_post\_field($product\_id, 'regular\_price')); |
  | 751 | 778 | $val = $val - $val \* floatval($woobe\_bulk[$field\_key]['value']) / 100; |
  | 752 | 779 | break; |
  | 753 | 780 |  |
  | 754 | 781 | case 'invalue\_sale\_price': |
  | 755 | 782 | //for regular\_price only |
  | 756 |  | $val = ~~$this->products->get\_post\_field($product\_id, 'sale\_price') + floatval($woobe\_bulk[$field\_key]['value']~~); |
  |  | 783 | $val = floatval($this->products->get\_post\_field($product\_id, 'sale\_price') + floatval($woobe\_bulk[$field\_key]['value'])); |
  | 757 | 784 | break; |
  | 758 | 785 |  |
  | 759 | 786 | case 'inpercent\_sale\_price': |
  | 760 | 787 | //for regular\_price only |
  | 761 |  | $val = ~~$this->products->get\_post\_field($product\_id, 'sale\_price'~~); |
  |  | 788 | $val =  floatval($this->products->get\_post\_field($product\_id, 'sale\_price')); |
  | 762 | 789 | $val = $val + $val \* floatval($woobe\_bulk[$field\_key]['value']) / 100; |
  | 763 | 790 | break; |
  | 764 | 791 | } |
  | 765 | 792 |  |
  | 766 | 793 | if (isset($\_REQUEST['num\_formula\_action']) AND isset($\_REQUEST['num\_formula\_value']) AND $\_REQUEST['num\_formula\_value'] != '-1') { |
  | 767 | 794 | $v\_key = esc\_textarea($\_REQUEST['num\_formula\_value']); |
  | 768 | 795 | $action = esc\_textarea($\_REQUEST['num\_formula\_action']); |
  | 769 | 796 | $v\_data = floatval(get\_post\_meta($product\_id, $v\_key, true)); |
  | 770 | 797 |  |
  | 771 | 798 | switch ($action) { |
  | 772 | 799 | case '-': |
  | 773 | 800 | $val = $val - $v\_data; |
  | 774 | 801 | break; |
  | 775 | 802 | case '\*': |
  | 776 | 803 | $val = $val \* $v\_data; |
  | 777 | 804 | break; |
  | 778 | 805 | case '/': |
  | 779 | 806 | if ($v\_data == 0) { |
  | 780 | 807 | $v\_data = 1; |
  | 781 | 808 | } |
  | 782 | 809 | $val = $val / $v\_data; |
  | 783 | 810 | break; |
  | 784 | 811 |  |
  | 785 | 812 | default: |
  | 786 | 813 | $val = $val + $v\_data; |
  | 787 | 814 | break; |
  | 788 | 815 | } |
  | 789 | 816 | } |
  | 790 | 817 |  |
  | 791 | 818 | if (isset($\_REQUEST['num\_rand\_data']) && is\_array($\_REQUEST['num\_rand\_data'])) { |
  | 792 | 819 | $rand\_data = wc\_clean($\_REQUEST['num\_rand\_data']); |
  | 793 | 820 | if (isset($rand\_data['from']) && isset($rand\_data['to']) && ($rand\_data['from'] != $rand\_data['to']) && ($rand\_data['from'] < $rand\_data['to'])) { |
  | 794 | 821 | $from = (float)$rand\_data['from']; |
  | 795 | 822 | $to = (float)$rand\_data['to']; |
  | 796 | 823 | $decimal = 1; |
  | 797 | 824 | if (isset($rand\_data['decimal'])) { |
  | 798 | 825 | $decimal = (int)$rand\_data['decimal']; |
  | 799 | 826 | } |
  | 800 | 827 | $action = '+'; |
  | 801 | 828 | if (isset($rand\_data['action'])) { |
  | 802 | 829 | $action = $rand\_data['action']; |
  | 803 | 830 | } |
  | 804 | 831 |  |
  | 805 | 832 | $rand\_val = rand($from \* $decimal, $to \* $decimal)/$decimal; |
  | 806 | 833 | switch ($action) { |
  | 807 | 834 | case '-': |
  | 808 | 835 | $val = $val - $rand\_val; |
  | 809 | 836 | break; |
  | 810 | 837 | case '\*': |
  | 811 | 838 | $val = $val \* $rand\_val; |
  | 812 | 839 | break; |
  | 813 | 840 | case '/': |
  | 814 | 841 | if ($rand\_val == 0) { |
  | 815 | 842 | $rand\_val = 1; |
  | 816 | 843 | } |
  | 817 | 844 | $val = $val / $rand\_val; |
  | 818 | 845 | break; |
  | 819 | 846 |  |
  | 820 | 847 | default: |
  | 821 | 848 | $val = $val + $rand\_val; |
  | 822 | 849 | break; |
  | 823 | 850 | } |
  | 824 | 851 |  |
  | 825 | 852 | } |
  | 826 | 853 | } |
  | 827 | 854 |  |
  | 828 | 855 | //\*\*\* |
  | 829 | 856 |  |
  | 830 | 857 | $convert = TRUE; |
  | 831 | 858 | if ($field\_key == 'sale\_price') { |
  | 832 | 859 | //sale price CAN NOT be more OR even equal to the regular price |
  | 833 | 860 | if ($val >= $this->products->get\_post\_field($product\_id, 'regular\_price')) { |
  | 834 | 861 | $convert = FALSE; |
  | 835 | 862 | } |
  | 836 | 863 | //to delete sale price |
  | 837 | 864 | if ($val <= 0) { |
  | 838 | 865 | $val = -1; |
  | 839 | 866 | $val = $this->products->update\_page\_field($product\_id, $field\_key, $val); |
  | 840 | 867 | $convert = FALSE; |
  | 841 | 868 | } |
  | 842 | 869 | } |
  | 843 | 870 |  |
  | 844 | 871 | //\*\*\* |
  | 845 | 872 |  |
  | 846 | 873 | if ($convert) { |
  | 847 | 874 | $val = $this->products->update\_page\_field($product\_id, $field\_key, floatval($val)); |
  | 848 | 875 | } |
  | 849 | 876 | } |
  | 850 | 877 |  |
  | 851 | 878 | public function woobe\_bulk\_finish() { |
  | 852 | 879 | do\_action('woobe\_bulk\_finished', WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key'])); |
  | 853 | 880 | $count\_key = 'woobe\_bulk\_' . WOOBE\_HELPER::sanitize\_bulk\_key($\_REQUEST['bulk\_key']) . '\_count'; |
  | 854 | 881 | die($this->storage->get\_val($count\_key) . ''); |
  | 855 | 882 | } |
  | 856 | 883 |  |
  | 857 | 884 | private function init\_bulk\_keys() { |
  | 858 | 885 |  |
  | 859 | 886 | $fields = woobe\_get\_fields(); |
  | 860 | 887 |  |
  | 861 | 888 | $this->text\_keys = array( |
  | 862 | 889 | 'post\_title' => array( |
  | 863 | 890 | 'title' => esc\_html\_\_('title', 'woo-bulk-editor'), |
  | 864 | 891 | 'css\_classes' => isset($fields['post\_title']['css\_classes']) ? $fields['post\_title']['css\_classes'] : '' |
  | 865 | 892 | ), |
  | 866 | 893 | 'post\_content' => array( |
  | 867 | 894 | 'title' => esc\_html\_\_('description', 'woo-bulk-editor'), |
  | 868 | 895 | 'css\_classes' => isset($fields['post\_content']['css\_classes']) ? $fields['post\_content']['css\_classes'] : '' |
  | 869 | 896 | ), |
  | 870 | 897 | 'post\_excerpt' => array( |
  | 871 | 898 | 'title' => esc\_html\_\_('short description', 'woo-bulk-editor'), |
  | 872 | 899 | 'css\_classes' => isset($fields['post\_excerpt']['css\_classes']) ? $fields['post\_excerpt']['css\_classes'] : '' |
  | 873 | 900 | ), |
  | 874 | 901 | 'post\_name' => array( |
  | 875 | 902 | 'title' => esc\_html\_\_('product slug', 'woo-bulk-editor'), |
  | 876 | 903 | 'css\_classes' => isset($fields['post\_name']['css\_classes']) ? $fields['post\_name']['css\_classes'] : '' |
  | 877 | 904 | ), |
  | 878 | 905 | 'sku' => array( |
  | 879 | 906 | 'title' => esc\_html\_\_('SKU', 'woo-bulk-editor'), |
  | 880 | 907 | 'css\_classes' => isset($fields['sku']['css\_classes']) ? $fields['sku']['css\_classes'] : '' |
  | 881 | 908 | ) |
  | 882 | 909 | ); |
  | 883 | 910 |  |
  | 884 | 911 | $this->other\_keys = array( |
  | 885 | 912 | 'post\_status' => array( |
  | 886 | 913 | 'title' => esc\_html\_\_('post status', 'woo-bulk-editor'), |
  | 887 | 914 | 'options' => $fields['post\_status']['select\_options'], |
  | 888 | 915 | 'direct' => $fields['post\_status']['direct'], |
  | 889 | 916 | 'css\_classes' => isset($fields['post\_status']['css\_classes']) ? $fields['post\_status']['css\_classes'] : '' |
  | 890 | 917 | ), |
  | 891 | 918 | 'stock\_status' => array( |
  | 892 | 919 | 'title' => esc\_html\_\_('stock status', 'woo-bulk-editor'), |
  | 893 | 920 | 'options' => $fields['stock\_status']['select\_options'], |
  | 894 | 921 | 'direct' => $fields['stock\_status']['direct'], |
  | 895 | 922 | 'css\_classes' => isset($fields['stock\_status']['css\_classes']) ? $fields['stock\_status']['css\_classes'] : '' |
  | 896 | 923 | ), |
  | 897 | 924 | 'tax\_status' => array( |
  | 898 | 925 | 'title' => esc\_html\_\_('tax status', 'woo-bulk-editor'), |
  | 899 | 926 | 'options' => $fields['tax\_status']['select\_options'], |
  | 900 | 927 | 'direct' => $fields['tax\_status']['direct'], |
  | 901 | 928 | 'css\_classes' => isset($fields['tax\_status']['css\_classes']) ? $fields['tax\_status']['css\_classes'] : '' |
  | 902 | 929 | ), |
  | 903 | 930 | 'catalog\_visibility' => array( |
  | 904 | 931 | 'title' => esc\_html\_\_('catalog visibility', 'woo-bulk-editor'), |
  | 905 | 932 | 'options' => $fields['catalog\_visibility']['select\_options'], |
  | 906 | 933 | 'direct' => $fields['catalog\_visibility']['direct'], |
  | 907 | 934 | 'css\_classes' => isset($fields['catalog\_visibility']['css\_classes']) ? $fields['catalog\_visibility']['css\_classes'] : '' |
  | 908 | 935 | ), |
  | 909 | 936 | 'product\_type' => array( |
  | 910 | 937 | 'title' => esc\_html\_\_('product type', 'woo-bulk-editor'), |
  | 911 | 938 | 'options' => $fields['product\_type']['select\_options'], |
  | 912 | 939 | 'direct' => $fields['product\_type']['direct'], |
  | 913 | 940 | 'css\_classes' => isset($fields['product\_type']['css\_classes']) ? $fields['product\_type']['css\_classes'] : '' |
  | 914 | 941 | ), |
  | 915 | 942 | 'featured' => array( |
  | 916 | 943 | 'title' => esc\_html\_\_('featured', 'woo-bulk-editor'), |
  | 917 | 944 | 'options' => $fields['featured']['select\_options'], |
  | 918 | 945 | 'direct' => $fields['featured']['direct'], |
  | 919 | 946 | 'css\_classes' => isset($fields['featured']['css\_classes']) ? $fields['featured']['css\_classes'] : '' |
  | 920 | 947 | ), |
  | 921 | 948 | ); |
  | 922 | 949 | //\*\*\* |
  | 923 | 950 |  |
  | 924 | 951 | $options1 = array( |
  | 925 | 952 | 'invalue' => esc\_html\_\_('increase by value', 'woo-bulk-editor'), |
  | 926 | 953 | 'devalue' => esc\_html\_\_('decrease by value', 'woo-bulk-editor'), |
  | 927 | 954 | 'inpercent' => esc\_html\_\_('increase by %', 'woo-bulk-editor'), |
  | 928 | 955 | 'depercent' => esc\_html\_\_('decrease by %', 'woo-bulk-editor'), |
  | 929 | 956 | 'new' => esc\_html\_\_('set new', 'woo-bulk-editor') |
  | 930 | 957 | ); |
  | 931 | 958 |  |
  | 932 | 959 | $options2 = array( |
  | 933 | 960 | 'invalue' => esc\_html\_\_('increase by value', 'woo-bulk-editor'), |
  | 934 | 961 | 'devalue' => esc\_html\_\_('decrease by value', 'woo-bulk-editor'), |
  | 935 | 962 | 'delete' => esc\_html\_\_('delete', 'woo-bulk-editor'), |
  | 936 | 963 | 'new' => esc\_html\_\_('set new', 'woo-bulk-editor') |
  | 937 | 964 | ); |
  | 938 | 965 |  |
  | 939 | 966 | //\*\*\* |
  | 940 | 967 |  |
  | 941 | 968 | $this->num\_keys = array( |
  | 942 | 969 | 'regular\_price' => array( |
  | 943 | 970 | 'title' => esc\_html\_\_('regular price', 'woo-bulk-editor'), |
  | 944 | 971 | 'direct' => $fields['regular\_price']['direct'], |
  | 945 | 972 | 'options' => array( |
  | 946 | 973 | 'invalue' => esc\_html\_\_('increase by value', 'woo-bulk-editor'), |
  | 947 | 974 | 'devalue' => esc\_html\_\_('decrease by value', 'woo-bulk-editor'), |
  | 948 | 975 | 'inpercent' => esc\_html\_\_('increase by %', 'woo-bulk-editor'), |
  | 949 | 976 | 'depercent' => esc\_html\_\_('decrease by %', 'woo-bulk-editor'), |
  | 950 | 977 | 'inpercent\_sale\_price' => esc\_html\_\_('sale price plus %', 'woo-bulk-editor'), |
  | 951 | 978 | 'invalue\_sale\_price' => esc\_html\_\_('sale price plus value', 'woo-bulk-editor'), |
  | 952 | 979 | 'new' => esc\_html\_\_('set new', 'woo-bulk-editor') |
  | 953 | 980 | ), |
  | 954 | 981 | 'css\_classes' => isset($fields['regular\_price']['css\_classes']) ? $fields['regular\_price']['css\_classes'] : '' |
  | 955 | 982 | ), |
  | 956 | 983 | 'sale\_price' => array( |
  | 957 | 984 | 'title' => esc\_html\_\_('sale price', 'woo-bulk-editor'), |
  | 958 | 985 | 'direct' => $fields['sale\_price']['direct'], |
  | 959 | 986 | 'options' => array( |
  | 960 | 987 | 'invalue' => esc\_html\_\_('increase by value', 'woo-bulk-editor'), |
  | 961 | 988 | 'devalue' => esc\_html\_\_('decrease by value', 'woo-bulk-editor'), |
  | 962 | 989 | 'inpercent' => esc\_html\_\_('increase by %', 'woo-bulk-editor'), |
  | 963 | 990 | 'depercent' => esc\_html\_\_('decrease by %', 'woo-bulk-editor'), |
  | 964 | 991 | 'depercent\_regular\_price' => esc\_html\_\_('regular price minus %', 'woo-bulk-editor'), |
  | 965 | 992 | 'devalue\_regular\_price' => esc\_html\_\_('regular price minus value', 'woo-bulk-editor'), |
  | 966 | 993 | 'new' => esc\_html\_\_('set new', 'woo-bulk-editor') |
  | 967 | 994 | ), |
  | 968 | 995 | 'css\_classes' => isset($fields['sale\_price']['css\_classes']) ? $fields['sale\_price']['css\_classes'] : '' |
  | 969 | 996 | ), |
  | 970 | 997 | 'stock\_quantity' => array( |
  | 971 | 998 | 'title' => esc\_html\_\_('in stock quantity', 'woo-bulk-editor'), |
  | 972 | 999 | 'direct' => $fields['stock\_quantity']['direct'], |
  | 973 | 1000 | 'options' => $options2, |
  | 974 | 1001 | 'css\_classes' => isset($fields['stock\_quantity']['css\_classes']) ? $fields['stock\_quantity']['css\_classes'] : '' |
  | 975 | 1002 | ), |
  | 976 | 1003 | 'download\_expiry' => array( |
  | 977 | 1004 | 'title' => esc\_html\_\_('download expiry', 'woo-bulk-editor'), |
  | 978 | 1005 | 'direct' => $fields['download\_expiry']['direct'], |
  | 979 | 1006 | 'options' => $options2, |
  | 980 | 1007 | 'css\_classes' => isset($fields['download\_expiry']['css\_classes']) ? $fields['download\_expiry']['css\_classes'] : '' |
  | 981 | 1008 | ), |
  | 982 | 1009 | 'download\_limit' => array( |
  | 983 | 1010 | 'title' => esc\_html\_\_('download limit', 'woo-bulk-editor'), |
  | 984 | 1011 | 'direct' => $fields['download\_limit']['direct'], |
  | 985 | 1012 | 'options' => $options2, |
  | 986 | 1013 | 'css\_classes' => isset($fields['download\_limit']['css\_classes']) ? $fields['download\_limit']['css\_classes'] : '' |
  | 987 | 1014 | ) |
  | 988 | 1015 | ); |
  | 989 | 1016 | } |
  | 990 | 1017 |  |
  | 991 | 1018 | //ajax |
  | 992 | 1019 | public function woobe\_bulk\_draw\_gallery\_btn() { |
  | 993 | 1020 | $images = []; |
  | 994 | 1021 | parse\_str($\_REQUEST['images'], $images); //sanitize below in array\_map |
  | 995 | 1022 | $data = array(); |
  | 996 | 1023 | $woobe\_gallery\_images = isset($images['woobe\_gallery\_images']) ? $images['woobe\_gallery\_images'] : array(); |
  | 997 | 1024 | //sanitizing to intval |
  | 998 | 1025 | $woobe\_gallery\_images = array\_map(function ($item) { |
  | 999 | 1026 | return intval($item); //sanitize intval |
  | 1000 | 1027 | }, $woobe\_gallery\_images); |
  | 1001 | 1028 |  |
  | 1002 | 1029 | $data['html'] = WOOBE\_HELPER::draw\_gallery\_popup\_editor\_btn(sanitize\_text\_field($\_REQUEST['field']), 0, $woobe\_gallery\_images); |
  | 1003 | 1030 | $data['images\_ids'] = implode(',', $woobe\_gallery\_images); //for any case, but now we not need it because updating of products applies by serialized data |
  | 1004 | 1031 |  |
  | 1005 | 1032 |  |
  | 1006 | 1033 | die(json\_encode($data)); |
  | 1007 | 1034 | } |
  | 1008 | 1035 |  |
  | 1009 | 1036 | //ajax |
  | 1010 | 1037 | public function woobe\_bulk\_draw\_download\_files\_btn() { |
  | 1011 | 1038 | $files = []; |
  | 1012 | 1039 | parse\_str($\_REQUEST['files'], $files); |
  | 1013 | 1040 | $files = WOOBE\_HELPER::sanitize\_array($files); |
  | 1014 | 1041 | $count = 0; |
  | 1015 | 1042 |  |
  | 1016 | 1043 | if (isset($files['\_wc\_file\_names'])) { |
  | 1017 | 1044 | $count = count($files['\_wc\_file\_names']); |
  | 1018 | 1045 | } |
  | 1019 | 1046 |  |
  | 1020 | 1047 | echo WOOBE\_HELPER::draw\_downloads\_popup\_editor\_btn(sanitize\_text\_field($\_REQUEST['field']), 0, $count); |
  | 1021 | 1048 |  |
  | 1022 | 1049 | exit; |
  | 1023 | 1050 | } |
  | 1024 | 1051 |  |
  | 1025 | 1052 | //ajax |
  | 1026 | 1053 | public function woobe\_bulk\_draw\_cross\_sells\_btn() { |
  | 1027 | 1054 | $products = []; |
  | 1028 | 1055 | parse\_str($\_REQUEST['products'], $products); |
  | 1029 | 1056 |  |
  | 1030 | 1057 | $ids = array(); |
  | 1031 | 1058 | if (isset($products['woobe\_prod\_ids'])) { |
  | 1032 | 1059 | $ids = $products['woobe\_prod\_ids']; |
  | 1033 | 1060 | } |
  | 1034 | 1061 |  |
  | 1035 | 1062 | $ids = array\_map(function ($item) { |
  | 1036 | 1063 | return intval($item); //sanitize intval |
  | 1037 | 1064 | }, $ids); |
  | 1038 | 1065 |  |
  | 1039 | 1066 | echo WOOBE\_HELPER::draw\_cross\_sells\_popup\_editor\_btn(sanitize\_text\_field($\_REQUEST['field']), 0, $ids); |
  | 1040 | 1067 |  |
  | 1041 | 1068 | exit; |
  | 1042 | 1069 | } |
  | 1043 | 1070 |  |
  | 1044 | 1071 | //ajax |
  | 1045 | 1072 | public function woobe\_bulk\_draw\_upsell\_ids\_btn() { |
  | 1046 | 1073 | $products = []; |
  | 1047 | 1074 | parse\_str($\_REQUEST['products'], $products); |
  | 1048 | 1075 |  |
  | 1049 | 1076 | $ids = array(); |
  | 1050 | 1077 | if (isset($products['woobe\_prod\_ids'])) { |
  | 1051 | 1078 | $ids = array\_map(function ($item) { |
  | 1052 | 1079 | return intval($item); //sanitize intval |
  | 1053 | 1080 | }, $products['woobe\_prod\_ids']); |
  | 1054 | 1081 | } |
  | 1055 | 1082 |  |
  | 1056 | 1083 | echo WOOBE\_HELPER::draw\_upsells\_popup\_editor\_btn($\_REQUEST['field'], 0, $ids); |
  | 1057 | 1084 |  |
  | 1058 | 1085 | exit; |
  | 1059 | 1086 | } |
  | 1060 | 1087 |  |
  | 1061 | 1088 | //ajax |
  | 1062 | 1089 | public function woobe\_bulk\_draw\_grouped\_ids\_btn() { |
  | 1063 | 1090 | $products = []; |
  | 1064 | 1091 | parse\_str($\_REQUEST['products'], $products); //sanitize below |
  | 1065 | 1092 |  |
  | 1066 | 1093 | $ids = array(); |
  | 1067 | 1094 | if (isset($products['woobe\_prod\_ids'])) { |
  | 1068 | 1095 | $ids = array\_map(function ($item) { |
  | 1069 | 1096 | return intval($item); //sanitize intval |
  | 1070 | 1097 | }, $products['woobe\_prod\_ids']); |
  | 1071 | 1098 | } |
  | 1072 | 1099 |  |
  | 1073 | 1100 | echo WOOBE\_HELPER::draw\_grouped\_popup\_editor\_btn(sanitize\_text\_field($\_REQUEST['field']), 0, $ids); |
  | 1074 | 1101 |  |
  | 1075 | 1102 | exit; |
  | 1076 | 1103 | } |
  | 1077 | 1104 |  |
  | 1078 | 1105 | //ajax |
  | 1079 | 1106 | public function woobe\_bulk\_get\_att\_terms() { |
  | 1080 | 1107 |  |
  | 1081 | 1108 | $drop\_downs = ''; |
  | 1082 | 1109 | if (!empty($\_REQUEST['attributes'])) { |
  | 1083 | 1110 | foreach ($\_REQUEST['attributes'] as $pa) { |
  | 1084 | 1111 | $pa = sanitize\_text\_field($pa); //sanitize attribute name |
  | 1085 | 1112 |  |
  | 1086 | 1113 | $terms = WOOBE\_HELPER::get\_taxonomies\_terms\_hierarchy($pa); |
  | 1087 | 1114 | if (!empty($terms)) { |
  | 1088 | 1115 | $options = array(); |
  | 1089 | 1116 | $options[''] = esc\_html\_\_('not selected', 'woo-bulk-editor'); |
  | 1090 | 1117 | $options['-1'] = esc\_html\_\_('Any', 'woo-bulk-editor'); |
  | 1091 | 1118 | foreach ($terms as $t) { |
  | 1092 | 1119 | $options[$t['slug']] = $t['name']; |
  | 1093 | 1120 | } |
  | 1094 | 1121 |  |
  | 1095 | 1122 | $drop\_downs .= WOOBE\_HELPER::draw\_select(array( |
  | 1096 | 1123 | 'field' => 0, |
  | 1097 | 1124 | 'product\_id' => 0, |
  | 1098 | 1125 | 'class' => '', |
  | 1099 | 1126 | 'options' => $options, |
  | 1100 | 1127 | 'name' => 'woobe\_bulk[combination\_attributes][' . sanitize\_text\_field($\_REQUEST['hash\_key']) . '][' . $pa . ']' |
  | 1101 | 1128 | )); |
  | 1102 | 1129 | } |
  | 1103 | 1130 | } |
  | 1104 | 1131 | } |
  | 1105 | 1132 |  |
  | 1106 | 1133 | die($drop\_downs); |
  | 1107 | 1134 | } |
  | 1108 | 1135 |  |
  | 1109 | 1136 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2970262&old=2844667&new_path=%2Fwoo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php&old_path=%2Fwoo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php)
* [Zip Archive](?format=zip&new=2970262&old=2844667&new_path=%2Fwoo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php&old_path=%2Fwoo-bulk-editor%2Ftrunk%2Fext%2Fbulk%2Fbulk.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


