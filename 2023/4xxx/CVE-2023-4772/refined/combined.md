=== Content from www.wordfence.com_0d86ce33_20250114_192149.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Newsletter <= 7.8.9 - Authenticated (Contributor+) Stored Cross-Site Scripting via Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Newsletter <= 7.8.9 - Authenticated (Contributor+) Stored Cross-Site Scripting via Shortcode

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2023-4772](https://www.cve.org/CVERecord?id=CVE-2023-4772) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | August 17, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Newsletter plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the 'newsletter\_form' shortcode in versions up to, and including, 7.8.9 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers with contributor-level and above permissions to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/newsletter/tags/7.8.9/subscription/subscription.php#L1653)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2955097/newsletter#file21)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fnewsletter%2Fnewsletter-789-authenticated-contributor-stored-cross-site-scripting-via-shortcode&t=Newsletter%20%3C%3D%207.8.9%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fnewsletter%2Fnewsletter-789-authenticated-contributor-stored-cross-site-scripting-via-shortcode&text=Newsletter%20%3C%3D%207.8.9%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fnewsletter%2Fnewsletter-789-authenticated-contributor-stored-cross-site-scripting-via-shortcode "LinkedIn")
Email

## Vulnerability Details for Newsletter – Send awesome emails from WordPress

#### [Newsletter – Send awesome emails from WordPress](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/newsletter)

| Software Type | Plugin |
| --- | --- |
| Software Slug | newsletter [(view on wordpress.org)](https://wordpress.org/plugins/newsletter) |
| Patched? | Yes |
| Remediation | Update to version 7.9.0, or a newer patched version |
| Affected Version | * <= 7.8.9 |
| Patched Version | * 7.9.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_434afe4e_20250114_192147.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2955097%2Fnewsletter)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2943508/newsletter "Changeset 2943508 for newsletter")
* [Next Change](/changeset/2957338/newsletter "Changeset 2957338 for newsletter") →

---

# Changeset [2955097](/changeset/2955097 "Show full changeset") for [newsletter](/browser/newsletter?rev=2955097 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/17/2023 07:31:44 PM
([17 months](/timeline?from=2023-08-17T19%3A31%3A44Z&precision=second "See timeline at 08/17/2023 07:31:44 PM") ago)

Author:
satollo
Message:

Version 7.9.0

Location:
[newsletter](/browser/newsletter?rev=2955097)
Files:

31 edited
15 copied

* [tags/7.9.0](/browser/newsletter/tags/7.9.0?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk](/browser/newsletter/trunk?rev=2932112 "Show original file (revision 2943506)"))*
* [tags/7.9.0/emails/blocks/hero/block-full.php](/browser/newsletter/tags/7.9.0/emails/blocks/hero/block-full.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [tags/7.9.0/emails/blocks/hero/block-left.php](/browser/newsletter/tags/7.9.0/emails/blocks/hero/block-left.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [tags/7.9.0/emails/blocks/hero/block-right.php](/browser/newsletter/tags/7.9.0/emails/blocks/hero/block-right.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [tags/7.9.0/emails/blocks/posts/layout-big-image.php](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-big-image.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [tags/7.9.0/emails/blocks/posts/layout-full-post.php](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-full-post.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [tags/7.9.0/emails/blocks/posts/layout-one-2.php](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-one-2.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [tags/7.9.0/emails/blocks/posts/layout-one.php](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-one.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file7 "Show differences"))
* [tags/7.9.0/emails/blocks/posts/layout-two.php](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-two.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [tags/7.9.0/emails/blocks/text/options.php](/browser/newsletter/tags/7.9.0/emails/blocks/text/options.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/emails/blocks/text/options.php](/browser/newsletter/trunk/emails/blocks/text/options.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/emails/emails.php](/browser/newsletter/tags/7.9.0/emails/emails.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file10 "Show differences"))
* [tags/7.9.0/emails/index.php](/browser/newsletter/tags/7.9.0/emails/index.php?rev=2955097 "Show entry in browser")
  (modified)
  ([3 diffs](#file11 "Show differences"))
* [tags/7.9.0/includes/addon.php](/browser/newsletter/tags/7.9.0/includes/addon.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/includes/addon.php](/browser/newsletter/trunk/includes/addon.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/includes/composer-class.php](/browser/newsletter/tags/7.9.0/includes/composer-class.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/includes/composer-class.php](/browser/newsletter/trunk/includes/composer-class.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/includes/fields.php](/browser/newsletter/tags/7.9.0/includes/fields.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/includes/fields.php](/browser/newsletter/trunk/includes/fields.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/includes/helper.php](/browser/newsletter/tags/7.9.0/includes/helper.php?rev=2955097 "Show entry in browser")
  (modified)
  ([2 diffs](#file15 "Show differences"))
* [tags/7.9.0/includes/module-admin.php](/browser/newsletter/tags/7.9.0/includes/module-admin.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file16 "Show differences"))
* [tags/7.9.0/plugin.php](/browser/newsletter/tags/7.9.0/plugin.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/plugin.php](/browser/newsletter/trunk/plugin.php?rev=2943508 "Show original file (revision 2943508)"))*
  ([3 diffs](#file17 "Show differences"))
* [tags/7.9.0/readme.txt](/browser/newsletter/tags/7.9.0/readme.txt?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/readme.txt](/browser/newsletter/trunk/readme.txt?rev=2943508 "Show original file (revision 2943508)"))*
  ([2 diffs](#file18 "Show differences"))
* [tags/7.9.0/subscription/customfields.php](/browser/newsletter/tags/7.9.0/subscription/customfields.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/subscription/customfields.php](/browser/newsletter/trunk/subscription/customfields.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/subscription/options.php](/browser/newsletter/tags/7.9.0/subscription/options.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file20 "Show differences"))
* [tags/7.9.0/subscription/subscription.php](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/subscription/subscription.php](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508 "Show original file (revision 2943508)"))*
  ([8 diffs](#file21 "Show differences"))
* [tags/7.9.0/subscription/template.php](/browser/newsletter/tags/7.9.0/subscription/template.php?rev=2955097 "Show entry in browser")
  (modified)
  ([2 diffs](#file22 "Show differences"))
* [tags/7.9.0/system/status.php](/browser/newsletter/tags/7.9.0/system/status.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/system/status.php](/browser/newsletter/trunk/system/status.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/users/edit-nav.php](/browser/newsletter/tags/7.9.0/users/edit-nav.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/users/edit-nav.php](/browser/newsletter/trunk/users/edit-nav.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/users/edit.php](/browser/newsletter/tags/7.9.0/users/edit.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/users/edit.php](/browser/newsletter/trunk/users/edit.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/users/logs.php](/browser/newsletter/tags/7.9.0/users/logs.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/users/logs.php](/browser/newsletter/trunk/users/logs.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/users/newsletters.php](/browser/newsletter/tags/7.9.0/users/newsletters.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/users/newsletters.php](/browser/newsletter/trunk/users/newsletters.php?rev=2943508 "Show original file (revision 2943508)"))*
* [tags/7.9.0/users/users-admin.php](/browser/newsletter/tags/7.9.0/users/users-admin.php?rev=2955097 "Show entry in browser")
  (copied)
  *(copied from [newsletter/trunk/users/users-admin.php](/browser/newsletter/trunk/users/users-admin.php?rev=2943508 "Show original file (revision 2943508)"))*
* [trunk/emails/blocks/hero/block-full.php](/browser/newsletter/trunk/emails/blocks/hero/block-full.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file29 "Show differences"))
* [trunk/emails/blocks/hero/block-left.php](/browser/newsletter/trunk/emails/blocks/hero/block-left.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file30 "Show differences"))
* [trunk/emails/blocks/hero/block-right.php](/browser/newsletter/trunk/emails/blocks/hero/block-right.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file31 "Show differences"))
* [trunk/emails/blocks/posts/layout-big-image.php](/browser/newsletter/trunk/emails/blocks/posts/layout-big-image.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file32 "Show differences"))
* [trunk/emails/blocks/posts/layout-full-post.php](/browser/newsletter/trunk/emails/blocks/posts/layout-full-post.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file33 "Show differences"))
* [trunk/emails/blocks/posts/layout-one-2.php](/browser/newsletter/trunk/emails/blocks/posts/layout-one-2.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file34 "Show differences"))
* [trunk/emails/blocks/posts/layout-one.php](/browser/newsletter/trunk/emails/blocks/posts/layout-one.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file35 "Show differences"))
* [trunk/emails/blocks/posts/layout-two.php](/browser/newsletter/trunk/emails/blocks/posts/layout-two.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file36 "Show differences"))
* [trunk/emails/emails.php](/browser/newsletter/trunk/emails/emails.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file37 "Show differences"))
* [trunk/emails/index.php](/browser/newsletter/trunk/emails/index.php?rev=2955097 "Show entry in browser")
  (modified)
  ([3 diffs](#file38 "Show differences"))
* [trunk/includes/helper.php](/browser/newsletter/trunk/includes/helper.php?rev=2955097 "Show entry in browser")
  (modified)
  ([2 diffs](#file39 "Show differences"))
* [trunk/includes/module-admin.php](/browser/newsletter/trunk/includes/module-admin.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file40 "Show differences"))
* [trunk/plugin.php](/browser/newsletter/trunk/plugin.php?rev=2955097 "Show entry in browser")
  (modified)
  ([3 diffs](#file41 "Show differences"))
* [trunk/readme.txt](/browser/newsletter/trunk/readme.txt?rev=2955097 "Show entry in browser")
  (modified)
  ([2 diffs](#file42 "Show differences"))
* [trunk/subscription/options.php](/browser/newsletter/trunk/subscription/options.php?rev=2955097 "Show entry in browser")
  (modified)
  ([1 diff](#file43 "Show differences"))
* [trunk/subscription/subscription.php](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097 "Show entry in browser")
  (modified)
  ([8 diffs](#file44 "Show differences"))
* [trunk/subscription/template.php](/browser/newsletter/trunk/subscription/template.php?rev=2955097 "Show entry in browser")
  (modified)
  ([2 diffs](#file45 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [newsletter/tags/7.9.0/emails/blocks/hero/block-full.php](/changeset/2955097/newsletter/tags/7.9.0/emails/blocks/hero/block-full.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/blocks/hero/block-full.php")

  | [r2929338](/browser/newsletter/trunk/emails/blocks/hero/block-full.php?rev=2929338#L13 "Show revision 2929338 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/blocks/hero/block-full.php?rev=2955097#L13 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 | padding: 0 0 20px 0; |
  | 14 | 14 |  |
  | 15 |  | line-height: 1.5~~em~~; |
  |  | 15 | line-height: 1.5; |
  | 16 | 16 | margin: 0; |
  | 17 | 17 | } |
* ## [newsletter/tags/7.9.0/emails/blocks/hero/block-left.php](/changeset/2955097/newsletter/tags/7.9.0/emails/blocks/hero/block-left.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/blocks/hero/block-left.php")

  | [r2929338](/browser/newsletter/trunk/emails/blocks/hero/block-left.php?rev=2929338#L17 "Show revision 2929338 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/blocks/hero/block-left.php?rev=2955097#L17 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 17 | 17 | <?php $text\_style->echo\_css()?> |
  | 18 | 18 | padding: 0 0 15px; |
  | 19 |  | line-height: 1.5~~em~~; |
  |  | 19 | line-height: 1.5; |
  | 20 | 20 | margin: 0; |
  | 21 | 21 | } |
* ## [newsletter/tags/7.9.0/emails/blocks/hero/block-right.php](/changeset/2955097/newsletter/tags/7.9.0/emails/blocks/hero/block-right.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/blocks/hero/block-right.php")

  | [r2929338](/browser/newsletter/trunk/emails/blocks/hero/block-right.php?rev=2929338#L16 "Show revision 2929338 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/blocks/hero/block-right.php?rev=2955097#L16 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | <?php $text\_style->echo\_css()?> |
  | 17 | 17 | padding: 0 0 15px; |
  | 18 |  | line-height: 1.5~~em~~; |
  |  | 18 | line-height: 1.5; |
  | 19 | 19 | margin: 0; |
  | 20 | 20 | } |
* ## [newsletter/tags/7.9.0/emails/blocks/posts/layout-big-image.php](/changeset/2955097/newsletter/tags/7.9.0/emails/blocks/posts/layout-big-image.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/blocks/posts/layout-big-image.php")

  | [r2864600](/browser/newsletter/trunk/emails/blocks/posts/layout-big-image.php?rev=2864600#L18 "Show revision 2864600 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-big-image.php?rev=2955097#L18 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 | .excerpt { |
  | 19 | 19 | <?php echo $text\_style->echo\_css() ?> |
  | 20 |  | line-height: 1.5~~em~~!important; |
  |  | 20 | line-height: 1.5 !important; |
  | 21 | 21 | text-decoration: none; |
  | 22 | 22 | } |
* ## [newsletter/tags/7.9.0/emails/blocks/posts/layout-full-post.php](/changeset/2955097/newsletter/tags/7.9.0/emails/blocks/posts/layout-full-post.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/blocks/posts/layout-full-post.php")

  | [r2869252](/browser/newsletter/trunk/emails/blocks/posts/layout-full-post.php?rev=2869252#L20 "Show revision 2869252 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-full-post.php?rev=2955097#L20 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 20 | 20 | .p { |
  | 21 | 21 | <?php $text\_style->echo\_css() ?> |
  | 22 |  | line-height: 1.5~~em~~!important; |
  |  | 22 | line-height: 1.5 !important; |
  | 23 | 23 | } |
  | 24 | 24 |  |
* ## [newsletter/tags/7.9.0/emails/blocks/posts/layout-one-2.php](/changeset/2955097/newsletter/tags/7.9.0/emails/blocks/posts/layout-one-2.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/blocks/posts/layout-one-2.php")

  | [r2864600](/browser/newsletter/trunk/emails/blocks/posts/layout-one-2.php?rev=2864600#L20 "Show revision 2864600 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-one-2.php?rev=2955097#L20 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 20 | 20 | .excerpt { |
  | 21 | 21 | <?php $text\_style->echo\_css() ?> |
  | 22 |  | line-height: 1.5~~em~~; |
  |  | 22 | line-height: 1.5; |
  | 23 | 23 | text-decoration: none; |
  | 24 | 24 | } |
* ## [newsletter/tags/7.9.0/emails/blocks/posts/layout-one.php](/changeset/2955097/newsletter/tags/7.9.0/emails/blocks/posts/layout-one.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/blocks/posts/layout-one.php")

  | [r2878889](/browser/newsletter/trunk/emails/blocks/posts/layout-one.php?rev=2878889#L18 "Show revision 2878889 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-one.php?rev=2955097#L18 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 | .excerpt { |
  | 19 | 19 | <?php $text\_style->echo\_css() ?> |
  | 20 |  | line-height: 1.5~~em~~ !important; |
  |  | 20 | line-height: 1.5 !important; |
  | 21 | 21 | text-decoration: none; |
  | 22 | 22 | } |
* ## [newsletter/tags/7.9.0/emails/blocks/posts/layout-two.php](/changeset/2955097/newsletter/tags/7.9.0/emails/blocks/posts/layout-two.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/blocks/posts/layout-two.php")

  | [r2855901](/browser/newsletter/trunk/emails/blocks/posts/layout-two.php?rev=2855901#L12 "Show revision 2855901 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/blocks/posts/layout-two.php?rev=2955097#L12 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 12 | 12 | .title { |
  | 13 | 13 | <?php $title\_style->echo\_css()?> |
  | 14 |  | line-height: 1.3~~em~~; |
  |  | 14 | line-height: 1.3; |
  | 15 | 15 | padding: 15px 0 0 0; |
  | 16 | 16 | } |
* ## [newsletter/tags/7.9.0/emails/emails.php](/changeset/2955097/newsletter/tags/7.9.0/emails/emails.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/emails.php")

  | [r2922963](/browser/newsletter/trunk/emails/emails.php?rev=2922963#L185 "Show revision 2922963 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/emails.php?rev=2955097#L185 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 185 | 185 | header('X-Robots-Tag: noindex,nofollow,noarchive'); |
  | 186 | 186 | header('Cache-Control: no-cache,no-store,private'); |
  | 187 |  |  |
  | 188 |  | echo apply\_filters('newsletter\_view\_message', $this->replace($email->message, $user, $email)); |
  |  | 187 |  |
  |  | 188 | $message = $this->replace($email->message, $user, $email); |
  |  | 189 | if (Newsletter::instance()->get\_option('do\_shortcodes')) { |
  |  | 190 | $message = do\_shortcode($message); |
  |  | 191 | } |
  |  | 192 | echo apply\_filters('newsletter\_view\_message', $message); |
  | 189 | 193 |  |
  | 190 | 194 | die(); |
* ## [newsletter/tags/7.9.0/emails/index.php](/changeset/2955097/newsletter/tags/7.9.0/emails/index.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/emails/index.php")

  | [r2922655](/browser/newsletter/trunk/emails/index.php?rev=2922655#L62 "Show revision 2922655 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/emails/index.php?rev=2955097#L62 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 62 | 62 | <thead> |
  | 63 | 63 | <tr> |
  | 64 |  | <th><input type="checkbox" onchange="jQuery('input.tnp-selector').prop('checked', this.checked)"></th> |
  |  | 64 | <th style="text-align: center"><input type="checkbox" onchange="jQuery('input.tnp-selector').prop('checked', this.checked)"></th> |
  | 65 | 65 | <th>Id</th> |
  | 66 | 66 | <th><?php \_e('Subject', 'newsletter') ?></th> |
  | […](/browser/newsletter/trunk/emails/index.php?rev=2922655#L68) | […](/browser/newsletter/tags/7.9.0/emails/index.php?rev=2955097#L68) |  |
  | 68 | 68 | <th><?php \_e('Progress', 'newsletter') ?>&nbsp;(\*)</th> |
  | 69 | 69 | <th><?php \_e('Date', 'newsletter') ?></th> |
  | 70 |  | ~~<th>&nbsp;</th>~~ |
  | 71 |  | ~~<th>&nbsp;</th>~~ |
  | 72 | 70 | <th>&nbsp;</th> |
  | 73 | 71 | <th>&nbsp;</th> |
  | […](/browser/newsletter/trunk/emails/index.php?rev=2922655#L79) | […](/browser/newsletter/tags/7.9.0/emails/index.php?rev=2955097#L77) |  |
  | 79 | 77 | <?php foreach ($emails as $email) { ?> |
  | 80 | 78 | <tr> |
  | 81 |  | <td> |
  |  | 79 | <td style="text-align: center"> |
  | 82 | 80 | <input type="checkbox" class="tnp-selector" name="ids[]" value="<?php echo $email->id; ?>"> |
  | 83 | 81 | </td> |
* ## [newsletter/tags/7.9.0/includes/helper.php](/changeset/2955097/newsletter/tags/7.9.0/includes/helper.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/includes/helper.php")

  | [r2924171](/browser/newsletter/trunk/includes/helper.php?rev=2924171#L302 "Show revision 2924171 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/includes/helper.php?rev=2955097#L302 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 302 | 302 | return \_tnp\_get\_default\_media($media\_id, $size); |
  | 303 | 303 | } |
  | 304 |  |  |
  | 305 |  | $relative\_thumb = $pathinfo['dirname'] . '/' . $pathinfo['filename'] . '-' . $width . 'x' . $height . ($crop ? '-c' : '') . '.' . $pathinfo['extension']; |
  |  | 304 |  |
  |  | 305 | $file\_ext  = strtolower($pathinfo['extension']); |
  |  | 306 | $out\_mimetype = null; |
  |  | 307 |  |
  |  | 308 | if ($file\_ext === 'webp') { |
  |  | 309 | $file\_ext = 'jpg'; |
  |  | 310 | $out\_mimetype = 'image/jpeg'; |
  |  | 311 | } |
  |  | 312 |  |
  |  | 313 | $relative\_thumb = $pathinfo['dirname'] . '/' . $pathinfo['filename'] . '-' . $width . 'x' . $height . ($crop ? '-c' : '') . '.' . $file\_ext; |
  | 306 | 314 | $absolute\_thumb = $uploads['basedir'] . '/newsletter/thumbnails/' . $relative\_thumb; |
  | 307 | 315 |  |
  | […](/browser/newsletter/trunk/includes/helper.php?rev=2924171#L341) | […](/browser/newsletter/tags/7.9.0/includes/helper.php?rev=2955097#L349) |  |
  | 341 | 349 | return \_tnp\_get\_default\_media($media\_id, $size); |
  | 342 | 350 | } |
  | 343 |  |  |
  | 344 |  | $saved = $editor->save($absolute\_thumb); |
  |  | 351 |  |
  |  | 352 | $saved = $editor->save($absolute\_thumb, $out\_mimetype); |
  | 345 | 353 | if (is\_wp\_error($saved)) { |
  | 346 | 354 | Newsletter::instance()->logger->error($saved); |
* ## [newsletter/tags/7.9.0/includes/module-admin.php](/changeset/2955097/newsletter/tags/7.9.0/includes/module-admin.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/includes/module-admin.php")

  | [r2925806](/browser/newsletter/trunk/includes/module-admin.php?rev=2925806#L749 "Show revision 2925806 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/includes/module-admin.php?rev=2955097#L749 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 749 | 749 | } else if (function\_exists('pll\_languages\_list')) { |
  | 750 | 750 | $languages = pll\_languages\_list(['fields' => '']); |
  | 751 |  | ~~//var\_dump($languages);~~ |
  | 752 | 751 | foreach ($languages as $data) { |
  | 753 | 752 | $language\_options[$data->slug] = $data->name; |
* ## [newsletter/tags/7.9.0/plugin.php](/changeset/2955097/newsletter/tags/7.9.0/plugin.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/plugin.php")

  | [r2943508](/browser/newsletter/trunk/plugin.php?rev=2943508#L5 "Show revision 2943508 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/plugin.php?rev=2955097#L5 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Plugin URI: https://www.thenewsletterplugin.com/plugins/newsletter |
  | 6 | 6 | Description: Newsletter is a cool plugin to create your own subscriber list, to send newsletters, to build your business. <strong>Before update give a look to <a href="https://www.thenewsletterplugin.com/category/release">this page</a> to know what's changed.</strong> |
  | 7 |  | Version: 7.~~8.9~~ |
  |  | 7 | Version: 7.9.0 |
  | 8 | 8 | Author: Stefano Lissa & The Newsletter Team |
  | 9 | 9 | Author URI: https://www.thenewsletterplugin.com |
  | […](/browser/newsletter/trunk/plugin.php?rev=2943508#L12) | […](/browser/newsletter/tags/7.9.0/plugin.php?rev=2955097#L12) |  |
  | 12 | 12 | License: GPLv2 or later |
  | 13 | 13 | Requires at least: 4.6 |
  | 14 |  | Requires PHP: ~~5.6~~ |
  |  | 14 | Requires PHP: 7.0 |
  | 15 | 15 |  |
  | 16 | 16 | Copyright 2009-2023 The Newsletter Team (email: info@thenewsletterplugin.com, web: https://www.thenewsletterplugin.com) |
  | […](/browser/newsletter/trunk/plugin.php?rev=2943508#L38) | […](/browser/newsletter/tags/7.9.0/plugin.php?rev=2955097#L38) |  |
  | 38 | 38 | } |
  | 39 | 39 |  |
  | 40 |  | define('NEWSLETTER\_VERSION', '7.~~8.9~~'); |
  |  | 40 | define('NEWSLETTER\_VERSION', '7.9.0'); |
  | 41 | 41 |  |
  | 42 | 42 | global $newsletter, $wpdb; |
* ## [newsletter/tags/7.9.0/readme.txt](/changeset/2955097/newsletter/tags/7.9.0/readme.txt "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/readme.txt")

  | [r2943508](/browser/newsletter/trunk/readme.txt?rev=2943508#L1 "Show revision 2943508 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/readme.txt?rev=2955097#L1 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === Newsletter - Send awesome emails from WordPress === |
  | 2 | 2 | Tags: newsletter, email marketing, welcome email, signup forms, lead generation, marketing automation |
  | 3 |  | Tested up to: 6.~~2.2~~ |
  | 4 |  | Stable tag: 7.~~8.9~~ |
  |  | 3 | Tested up to: 6.3 |
  |  | 4 | Stable tag: 7.9.0 |
  | 5 | 5 | Contributors: satollo,webagile,michael-travan |
  | 6 | 6 | License: GPLv2 or later |
  | […](/browser/newsletter/trunk/readme.txt?rev=2943508#L127) | […](/browser/newsletter/tags/7.9.0/readme.txt?rev=2955097#L127) |  |
  | 127 | 127 | == Changelog == |
  | 128 | 128 |  |
  |  | 129 | = 7.9.0 = |
  |  | 130 |  |
  |  | 131 | \* Fixed some line heights |
  |  | 132 | \* Added registration of shortcodes under the AJAX context |
  |  | 133 | \* Added shortcode management on newsletter online view |
  |  | 134 | \* Fixed line-height for Outlook on some blocks |
  |  | 135 | \* Fixed the template message test |
  |  | 136 | \* Added webp images check since Outlook does not support that format |
  |  | 137 | \* Fixed error text field on subscription panel not displaying when customized |
  |  | 138 | \* Security fix on minimal form shortcode |
  |  | 139 | \* Removed the "before" and "after" attributes of the main shortcode |
  |  | 140 |  |
  | 129 | 141 | = 7.8.9 = |
  | 130 | 142 |  |
* ## [newsletter/tags/7.9.0/subscription/options.php](/changeset/2955097/newsletter/tags/7.9.0/subscription/options.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/subscription/options.php")

  | [r2924171](/browser/newsletter/trunk/subscription/options.php?rev=2924171#L80 "Show revision 2924171 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/subscription/options.php?rev=2955097#L80 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 80 | 80 | //$this->dump($controls->data); |
  | 81 | 81 |  |
  | 82 |  | foreach (['confirmed\_text', 'confirmed\_message', 'confirmation\_text', 'confirmation\_message', 'subscription\_text'] as $key) { |
  |  | 82 | foreach (['confirmed\_text', 'confirmed\_message', 'confirmation\_text', 'confirmation\_message', 'subscription\_text', 'error\_text'] as $key) { |
  | 83 | 83 | if (!empty($controls->data[$key])) { |
  | 84 | 84 | $controls->data[$key . '\_custom'] = '1'; |
* ## [newsletter/tags/7.9.0/subscription/subscription.php](/changeset/2955097/newsletter/tags/7.9.0/subscription/subscription.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/subscription/subscription.php")

  | [r2943508](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L32 "Show revision 2943508 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097#L32 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 32 | 32 | function hook\_init() { |
  | 33 | 33 | add\_action('newsletter\_action', array($this, 'hook\_newsletter\_action'), 10, 3); |
  | 34 |  | if (!is\_admin()) { |
  |  | 34 | if (!is\_admin() || defined('DOING\_AJAX') && DOING\_AJAX) { |
  | 35 | 35 | // Shortcode for the Newsletter page |
  | 36 | 36 | add\_shortcode('newsletter', array($this, 'shortcode\_newsletter')); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L38) | […](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097#L38) |  |
  | 38 | 38 | add\_shortcode('newsletter\_field', array($this, 'shortcode\_newsletter\_field')); |
  | 39 | 39 | } |
  | 40 |  | ~~}~~ |
  | 41 |  |  |
  | 42 |  | ~~function get\_options($set = '', $language = null) {~~ |
  | 43 |  | ~~// This is a patch for addon using the "profile" set which originally contained the~~ |
  | 44 |  | ~~// form options. This patch can create a problem if someone calls this method to get the actual~~ |
  | 45 |  | ~~// "profile" set which is the configuration of the profile page.~~ |
  | 46 |  | ~~// The correct call would be NewsletterProfile::instance()->get\_options().~~ |
  | 47 |  | ~~if ($set === 'profile') {~~ |
  | 48 |  | ~~$set = 'form';~~ |
  | 49 |  | ~~}~~ |
  | 50 |  | ~~return parent::get\_options($set, $language);~~ |
  | 51 | 40 | } |
  | 52 | 41 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L194) | […](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097#L183) |  |
  | 194 | 183 | } |
  | 195 | 184 | } |
  |  | 185 |  |
  |  | 186 | function get\_options($set = '', $language = null) { |
  |  | 187 | // This is a patch for addon using the "profile" set which originally contained the |
  |  | 188 | // form options. This patch can create a problem if someone calls this method to get the actual |
  |  | 189 | // "profile" set which is the configuration of the profile page. |
  |  | 190 | // The correct call would be NewsletterProfile::instance()->get\_options(). |
  |  | 191 | if ($set === 'profile') { |
  |  | 192 | $set = 'form'; |
  |  | 193 | } |
  |  | 194 | return parent::get\_options($set, $language); |
  |  | 195 | } |
  | 196 | 196 |  |
  | 197 | 197 | function get\_form\_options() { |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1505) | […](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097#L1505) |  |
  | 1505 | 1505 | } |
  | 1506 | 1506 |  |
  | 1507 |  | if (isset($attrs['before'])) { |
  | 1508 |  | $buffer .= $attrs['before']; |
  | 1509 |  | } else { |
  | 1510 |  | if (isset($attrs['class'])) { |
  | 1511 |  | $buffer .= '<div class="tnp tnp-subscription ' . $attrs['class'] . '">' . "\n"; |
  | 1512 |  | } else { |
  | 1513 |  | $buffer .= '<div class="tnp tnp-subscription">' . "\n"; |
  | 1514 |  | } |
  |  | 1507 |  |
  |  | 1508 | if (isset($attrs['class'])) { |
  |  | 1509 | $buffer .= '<div class="tnp tnp-subscription ' . esc\_attr($attrs['class']) . '">' . "\n"; |
  |  | 1510 | } else { |
  |  | 1511 | $buffer .= '<div class="tnp tnp-subscription">' . "\n"; |
  | 1515 | 1512 | } |
  | 1516 | 1513 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1568) | […](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097#L1565) |  |
  | 1568 | 1565 | } |
  | 1569 | 1566 |  |
  | 1570 |  |  |
  | 1571 | 1567 | $buffer .= '<input class="tnp-submit" type="submit" value="' . esc\_attr($this->get\_form\_text('subscribe')) . '" ' . $button\_style . '>' . "\n"; |
  | 1572 | 1568 |  |
  | 1573 | 1569 | $buffer .= "</div>\n</form>\n"; |
  | 1574 | 1570 |  |
  | 1575 |  | if (isset($attrs['after'])) { |
  | 1576 |  | $buffer .= $attrs['after']; |
  | 1577 |  | } else { |
  | 1578 |  | $buffer .= "</div>\n"; |
  | 1579 |  | } |
  |  | 1571 | $buffer .= "</div>\n"; |
  | 1580 | 1572 |  |
  | 1581 | 1573 | return $buffer; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1592) | […](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097#L1584) |  |
  | 1592 | 1584 |  |
  | 1593 | 1585 | if (stripos($form, '<form') === false) { |
  | 1594 |  | $form = '<form method="post" action="' . ~~$action~~ . '">' . $form . '</form>'; |
  |  | 1586 | $form = '<form method="post" action="' . esc\_attr($action) . '">' . $form . '</form>'; |
  | 1595 | 1587 | } |
  | 1596 | 1588 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1613) | […](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097#L1605) |  |
  | 1613 | 1605 | $lists = $this->get\_lists\_for\_subscription(); |
  | 1614 | 1606 | foreach ($lists as $list) { |
  | 1615 |  | $checkboxes .= '<input type="checkbox" name="nl[]" value="' . ~~$list->id . '"> ' . $list->name~~ . '<br />'; |
  |  | 1607 | $checkboxes .= '<input type="checkbox" name="nl[]" value="' . esc\_attr($list->id) . '"> ' . esc\_attr($list->name) . '<br />'; |
  | 1616 | 1608 | } |
  | 1617 | 1609 | $buffer = str\_replace('{lists}', $checkboxes, $buffer); |
  | 1618 |  | $buffer = str\_replace('{preferences}', $checkboxes, $buffer); |
  |  | 1610 | $buffer = str\_replace('{preferences}', $checkboxes, $buffer); // For compatibility |
  | 1619 | 1611 | return $buffer; |
  | 1620 | 1612 | } |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1651) | […](/browser/newsletter/tags/7.9.0/subscription/subscription.php?rev=2955097#L1643) |  |
  | 1651 | 1643 | $form = ''; |
  | 1652 | 1644 |  |
  | 1653 |  | $form .= '<div class="tnp tnp-subscription-minimal ' . ~~$attrs['class']~~ . '">'; |
  |  | 1645 | $form .= '<div class="tnp tnp-subscription-minimal ' . esc\_attr($attrs['class']) . '">'; |
  | 1654 | 1646 | $form .= '<form action="' . esc\_attr($this->build\_action\_url('s')) . '" method="post"'; |
  | 1655 | 1647 | if (!empty($attrs['id'])) { |
* ## [newsletter/tags/7.9.0/subscription/template.php](/changeset/2955097/newsletter/tags/7.9.0/subscription/template.php "Show the changeset 2955097 restricted to newsletter/tags/7.9.0/subscription/template.php")

  | [r2922655](/browser/newsletter/trunk/subscription/template.php?rev=2922655#L22 "Show revision 2922655 of this file in browser") | [r2955097](/browser/newsletter/tags/7.9.0/subscription/template.php?rev=2955097#L22 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | if ($controls->is\_action('test')) { |
  | 23 | 23 |  |
  | 24 |  | $users = $~~module~~->get\_test\_users(); |
  |  | 24 | $users = $this->get\_test\_users(); |
  | 25 | 25 | if (count($users) == 0) { |
  | 26 | 26 | $controls->errors = \_\_('No test subscribers found.', 'newsletter') . ' <a href="https://www.thenewsletterplugin.com/plugins/newsletter/subscribers-module#test" target="\_blank"><i class="fas fa-info-circle"></i></a>'; |
  | […](/browser/newsletter/trunk/subscription/template.php?rev=2922655#L40) | […](/browser/newsletter/tags/7.9.0/subscription/template.php?rev=2955097#L40) |  |
  | 40 | 40 | foreach ($users as $user) { |
  | 41 | 41 | $addresses[] = $user->email; |
  | 42 |  | Newsletter::instance()->mail($user->email, 'Newsletter Messages Template Test', $~~module~~->replace($message, $user)); |
  |  | 42 | Newsletter::instance()->mail($user->email, 'Newsletter Messages Template Test', $this->replace($message, $user)); |
  | 43 | 43 | } |
  | 44 | 44 | $controls->messages .= 'Test emails sent to ' . count($users) . ' test subscribers: ' . |
* ## [newsletter/trunk/emails/blocks/hero/block-full.php](/changeset/2955097/newsletter/trunk/emails/blocks/hero/block-full.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/blocks/hero/block-full.php")

  | [r2929338](/browser/newsletter/trunk/emails/blocks/hero/block-full.php?rev=2929338#L13 "Show revision 2929338 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/blocks/hero/block-full.php?rev=2955097#L13 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 | padding: 0 0 20px 0; |
  | 14 | 14 |  |
  | 15 |  | line-height: 1.5~~em~~; |
  |  | 15 | line-height: 1.5; |
  | 16 | 16 | margin: 0; |
  | 17 | 17 | } |
* ## [newsletter/trunk/emails/blocks/hero/block-left.php](/changeset/2955097/newsletter/trunk/emails/blocks/hero/block-left.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/blocks/hero/block-left.php")

  | [r2929338](/browser/newsletter/trunk/emails/blocks/hero/block-left.php?rev=2929338#L17 "Show revision 2929338 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/blocks/hero/block-left.php?rev=2955097#L17 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 17 | 17 | <?php $text\_style->echo\_css()?> |
  | 18 | 18 | padding: 0 0 15px; |
  | 19 |  | line-height: 1.5~~em~~; |
  |  | 19 | line-height: 1.5; |
  | 20 | 20 | margin: 0; |
  | 21 | 21 | } |
* ## [newsletter/trunk/emails/blocks/hero/block-right.php](/changeset/2955097/newsletter/trunk/emails/blocks/hero/block-right.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/blocks/hero/block-right.php")

  | [r2929338](/browser/newsletter/trunk/emails/blocks/hero/block-right.php?rev=2929338#L16 "Show revision 2929338 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/blocks/hero/block-right.php?rev=2955097#L16 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | <?php $text\_style->echo\_css()?> |
  | 17 | 17 | padding: 0 0 15px; |
  | 18 |  | line-height: 1.5~~em~~; |
  |  | 18 | line-height: 1.5; |
  | 19 | 19 | margin: 0; |
  | 20 | 20 | } |
* ## [newsletter/trunk/emails/blocks/posts/layout-big-image.php](/changeset/2955097/newsletter/trunk/emails/blocks/posts/layout-big-image.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/blocks/posts/layout-big-image.php")

  | [r2864600](/browser/newsletter/trunk/emails/blocks/posts/layout-big-image.php?rev=2864600#L18 "Show revision 2864600 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/blocks/posts/layout-big-image.php?rev=2955097#L18 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 | .excerpt { |
  | 19 | 19 | <?php echo $text\_style->echo\_css() ?> |
  | 20 |  | line-height: 1.5~~em~~!important; |
  |  | 20 | line-height: 1.5 !important; |
  | 21 | 21 | text-decoration: none; |
  | 22 | 22 | } |
* ## [newsletter/trunk/emails/blocks/posts/layout-full-post.php](/changeset/2955097/newsletter/trunk/emails/blocks/posts/layout-full-post.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/blocks/posts/layout-full-post.php")

  | [r2869252](/browser/newsletter/trunk/emails/blocks/posts/layout-full-post.php?rev=2869252#L20 "Show revision 2869252 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/blocks/posts/layout-full-post.php?rev=2955097#L20 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 20 | 20 | .p { |
  | 21 | 21 | <?php $text\_style->echo\_css() ?> |
  | 22 |  | line-height: 1.5~~em~~!important; |
  |  | 22 | line-height: 1.5 !important; |
  | 23 | 23 | } |
  | 24 | 24 |  |
* ## [newsletter/trunk/emails/blocks/posts/layout-one-2.php](/changeset/2955097/newsletter/trunk/emails/blocks/posts/layout-one-2.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/blocks/posts/layout-one-2.php")

  | [r2864600](/browser/newsletter/trunk/emails/blocks/posts/layout-one-2.php?rev=2864600#L20 "Show revision 2864600 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/blocks/posts/layout-one-2.php?rev=2955097#L20 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 20 | 20 | .excerpt { |
  | 21 | 21 | <?php $text\_style->echo\_css() ?> |
  | 22 |  | line-height: 1.5~~em~~; |
  |  | 22 | line-height: 1.5; |
  | 23 | 23 | text-decoration: none; |
  | 24 | 24 | } |
* ## [newsletter/trunk/emails/blocks/posts/layout-one.php](/changeset/2955097/newsletter/trunk/emails/blocks/posts/layout-one.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/blocks/posts/layout-one.php")

  | [r2878889](/browser/newsletter/trunk/emails/blocks/posts/layout-one.php?rev=2878889#L18 "Show revision 2878889 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/blocks/posts/layout-one.php?rev=2955097#L18 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 | .excerpt { |
  | 19 | 19 | <?php $text\_style->echo\_css() ?> |
  | 20 |  | line-height: 1.5~~em~~ !important; |
  |  | 20 | line-height: 1.5 !important; |
  | 21 | 21 | text-decoration: none; |
  | 22 | 22 | } |
* ## [newsletter/trunk/emails/blocks/posts/layout-two.php](/changeset/2955097/newsletter/trunk/emails/blocks/posts/layout-two.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/blocks/posts/layout-two.php")

  | [r2855901](/browser/newsletter/trunk/emails/blocks/posts/layout-two.php?rev=2855901#L12 "Show revision 2855901 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/blocks/posts/layout-two.php?rev=2955097#L12 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 12 | 12 | .title { |
  | 13 | 13 | <?php $title\_style->echo\_css()?> |
  | 14 |  | line-height: 1.3~~em~~; |
  |  | 14 | line-height: 1.3; |
  | 15 | 15 | padding: 15px 0 0 0; |
  | 16 | 16 | } |
* ## [newsletter/trunk/emails/emails.php](/changeset/2955097/newsletter/trunk/emails/emails.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/emails.php")

  | [r2922963](/browser/newsletter/trunk/emails/emails.php?rev=2922963#L185 "Show revision 2922963 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/emails.php?rev=2955097#L185 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 185 | 185 | header('X-Robots-Tag: noindex,nofollow,noarchive'); |
  | 186 | 186 | header('Cache-Control: no-cache,no-store,private'); |
  | 187 |  |  |
  | 188 |  | echo apply\_filters('newsletter\_view\_message', $this->replace($email->message, $user, $email)); |
  |  | 187 |  |
  |  | 188 | $message = $this->replace($email->message, $user, $email); |
  |  | 189 | if (Newsletter::instance()->get\_option('do\_shortcodes')) { |
  |  | 190 | $message = do\_shortcode($message); |
  |  | 191 | } |
  |  | 192 | echo apply\_filters('newsletter\_view\_message', $message); |
  | 189 | 193 |  |
  | 190 | 194 | die(); |
* ## [newsletter/trunk/emails/index.php](/changeset/2955097/newsletter/trunk/emails/index.php "Show the changeset 2955097 restricted to newsletter/trunk/emails/index.php")

  | [r2922655](/browser/newsletter/trunk/emails/index.php?rev=2922655#L62 "Show revision 2922655 of this file in browser") | [r2955097](/browser/newsletter/trunk/emails/index.php?rev=2955097#L62 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 62 | 62 | <thead> |
  | 63 | 63 | <tr> |
  | 64 |  | <th><input type="checkbox" onchange="jQuery('input.tnp-selector').prop('checked', this.checked)"></th> |
  |  | 64 | <th style="text-align: center"><input type="checkbox" onchange="jQuery('input.tnp-selector').prop('checked', this.checked)"></th> |
  | 65 | 65 | <th>Id</th> |
  | 66 | 66 | <th><?php \_e('Subject', 'newsletter') ?></th> |
  | […](/browser/newsletter/trunk/emails/index.php?rev=2922655#L68) | […](/browser/newsletter/trunk/emails/index.php?rev=2955097#L68) |  |
  | 68 | 68 | <th><?php \_e('Progress', 'newsletter') ?>&nbsp;(\*)</th> |
  | 69 | 69 | <th><?php \_e('Date', 'newsletter') ?></th> |
  | 70 |  | ~~<th>&nbsp;</th>~~ |
  | 71 |  | ~~<th>&nbsp;</th>~~ |
  | 72 | 70 | <th>&nbsp;</th> |
  | 73 | 71 | <th>&nbsp;</th> |
  | […](/browser/newsletter/trunk/emails/index.php?rev=2922655#L79) | […](/browser/newsletter/trunk/emails/index.php?rev=2955097#L77) |  |
  | 79 | 77 | <?php foreach ($emails as $email) { ?> |
  | 80 | 78 | <tr> |
  | 81 |  | <td> |
  |  | 79 | <td style="text-align: center"> |
  | 82 | 80 | <input type="checkbox" class="tnp-selector" name="ids[]" value="<?php echo $email->id; ?>"> |
  | 83 | 81 | </td> |
* ## [newsletter/trunk/includes/helper.php](/changeset/2955097/newsletter/trunk/includes/helper.php "Show the changeset 2955097 restricted to newsletter/trunk/includes/helper.php")

  | [r2924171](/browser/newsletter/trunk/includes/helper.php?rev=2924171#L302 "Show revision 2924171 of this file in browser") | [r2955097](/browser/newsletter/trunk/includes/helper.php?rev=2955097#L302 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 302 | 302 | return \_tnp\_get\_default\_media($media\_id, $size); |
  | 303 | 303 | } |
  | 304 |  |  |
  | 305 |  | $relative\_thumb = $pathinfo['dirname'] . '/' . $pathinfo['filename'] . '-' . $width . 'x' . $height . ($crop ? '-c' : '') . '.' . $pathinfo['extension']; |
  |  | 304 |  |
  |  | 305 | $file\_ext  = strtolower($pathinfo['extension']); |
  |  | 306 | $out\_mimetype = null; |
  |  | 307 |  |
  |  | 308 | if ($file\_ext === 'webp') { |
  |  | 309 | $file\_ext = 'jpg'; |
  |  | 310 | $out\_mimetype = 'image/jpeg'; |
  |  | 311 | } |
  |  | 312 |  |
  |  | 313 | $relative\_thumb = $pathinfo['dirname'] . '/' . $pathinfo['filename'] . '-' . $width . 'x' . $height . ($crop ? '-c' : '') . '.' . $file\_ext; |
  | 306 | 314 | $absolute\_thumb = $uploads['basedir'] . '/newsletter/thumbnails/' . $relative\_thumb; |
  | 307 | 315 |  |
  | […](/browser/newsletter/trunk/includes/helper.php?rev=2924171#L341) | […](/browser/newsletter/trunk/includes/helper.php?rev=2955097#L349) |  |
  | 341 | 349 | return \_tnp\_get\_default\_media($media\_id, $size); |
  | 342 | 350 | } |
  | 343 |  |  |
  | 344 |  | $saved = $editor->save($absolute\_thumb); |
  |  | 351 |  |
  |  | 352 | $saved = $editor->save($absolute\_thumb, $out\_mimetype); |
  | 345 | 353 | if (is\_wp\_error($saved)) { |
  | 346 | 354 | Newsletter::instance()->logger->error($saved); |
* ## [newsletter/trunk/includes/module-admin.php](/changeset/2955097/newsletter/trunk/includes/module-admin.php "Show the changeset 2955097 restricted to newsletter/trunk/includes/module-admin.php")

  | [r2925806](/browser/newsletter/trunk/includes/module-admin.php?rev=2925806#L749 "Show revision 2925806 of this file in browser") | [r2955097](/browser/newsletter/trunk/includes/module-admin.php?rev=2955097#L749 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 749 | 749 | } else if (function\_exists('pll\_languages\_list')) { |
  | 750 | 750 | $languages = pll\_languages\_list(['fields' => '']); |
  | 751 |  | ~~//var\_dump($languages);~~ |
  | 752 | 751 | foreach ($languages as $data) { |
  | 753 | 752 | $language\_options[$data->slug] = $data->name; |
* ## [newsletter/trunk/plugin.php](/changeset/2955097/newsletter/trunk/plugin.php "Show the changeset 2955097 restricted to newsletter/trunk/plugin.php")

  | [r2943508](/browser/newsletter/trunk/plugin.php?rev=2943508#L5 "Show revision 2943508 of this file in browser") | [r2955097](/browser/newsletter/trunk/plugin.php?rev=2955097#L5 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Plugin URI: https://www.thenewsletterplugin.com/plugins/newsletter |
  | 6 | 6 | Description: Newsletter is a cool plugin to create your own subscriber list, to send newsletters, to build your business. <strong>Before update give a look to <a href="https://www.thenewsletterplugin.com/category/release">this page</a> to know what's changed.</strong> |
  | 7 |  | Version: 7.~~8.9~~ |
  |  | 7 | Version: 7.9.0 |
  | 8 | 8 | Author: Stefano Lissa & The Newsletter Team |
  | 9 | 9 | Author URI: https://www.thenewsletterplugin.com |
  | […](/browser/newsletter/trunk/plugin.php?rev=2943508#L12) | […](/browser/newsletter/trunk/plugin.php?rev=2955097#L12) |  |
  | 12 | 12 | License: GPLv2 or later |
  | 13 | 13 | Requires at least: 4.6 |
  | 14 |  | Requires PHP: ~~5.6~~ |
  |  | 14 | Requires PHP: 7.0 |
  | 15 | 15 |  |
  | 16 | 16 | Copyright 2009-2023 The Newsletter Team (email: info@thenewsletterplugin.com, web: https://www.thenewsletterplugin.com) |
  | […](/browser/newsletter/trunk/plugin.php?rev=2943508#L38) | […](/browser/newsletter/trunk/plugin.php?rev=2955097#L38) |  |
  | 38 | 38 | } |
  | 39 | 39 |  |
  | 40 |  | define('NEWSLETTER\_VERSION', '7.~~8.9~~'); |
  |  | 40 | define('NEWSLETTER\_VERSION', '7.9.0'); |
  | 41 | 41 |  |
  | 42 | 42 | global $newsletter, $wpdb; |
* ## [newsletter/trunk/readme.txt](/changeset/2955097/newsletter/trunk/readme.txt "Show the changeset 2955097 restricted to newsletter/trunk/readme.txt")

  | [r2943508](/browser/newsletter/trunk/readme.txt?rev=2943508#L1 "Show revision 2943508 of this file in browser") | [r2955097](/browser/newsletter/trunk/readme.txt?rev=2955097#L1 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === Newsletter - Send awesome emails from WordPress === |
  | 2 | 2 | Tags: newsletter, email marketing, welcome email, signup forms, lead generation, marketing automation |
  | 3 |  | Tested up to: 6.~~2.2~~ |
  | 4 |  | Stable tag: 7.~~8.9~~ |
  |  | 3 | Tested up to: 6.3 |
  |  | 4 | Stable tag: 7.9.0 |
  | 5 | 5 | Contributors: satollo,webagile,michael-travan |
  | 6 | 6 | License: GPLv2 or later |
  | […](/browser/newsletter/trunk/readme.txt?rev=2943508#L127) | […](/browser/newsletter/trunk/readme.txt?rev=2955097#L127) |  |
  | 127 | 127 | == Changelog == |
  | 128 | 128 |  |
  |  | 129 | = 7.9.0 = |
  |  | 130 |  |
  |  | 131 | \* Fixed some line heights |
  |  | 132 | \* Added registration of shortcodes under the AJAX context |
  |  | 133 | \* Added shortcode management on newsletter online view |
  |  | 134 | \* Fixed line-height for Outlook on some blocks |
  |  | 135 | \* Fixed the template message test |
  |  | 136 | \* Added webp images check since Outlook does not support that format |
  |  | 137 | \* Fixed error text field on subscription panel not displaying when customized |
  |  | 138 | \* Security fix on minimal form shortcode |
  |  | 139 | \* Removed the "before" and "after" attributes of the main shortcode |
  |  | 140 |  |
  | 129 | 141 | = 7.8.9 = |
  | 130 | 142 |  |
* ## [newsletter/trunk/subscription/options.php](/changeset/2955097/newsletter/trunk/subscription/options.php "Show the changeset 2955097 restricted to newsletter/trunk/subscription/options.php")

  | [r2924171](/browser/newsletter/trunk/subscription/options.php?rev=2924171#L80 "Show revision 2924171 of this file in browser") | [r2955097](/browser/newsletter/trunk/subscription/options.php?rev=2955097#L80 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 80 | 80 | //$this->dump($controls->data); |
  | 81 | 81 |  |
  | 82 |  | foreach (['confirmed\_text', 'confirmed\_message', 'confirmation\_text', 'confirmation\_message', 'subscription\_text'] as $key) { |
  |  | 82 | foreach (['confirmed\_text', 'confirmed\_message', 'confirmation\_text', 'confirmation\_message', 'subscription\_text', 'error\_text'] as $key) { |
  | 83 | 83 | if (!empty($controls->data[$key])) { |
  | 84 | 84 | $controls->data[$key . '\_custom'] = '1'; |
* ## [newsletter/trunk/subscription/subscription.php](/changeset/2955097/newsletter/trunk/subscription/subscription.php "Show the changeset 2955097 restricted to newsletter/trunk/subscription/subscription.php")

  | [r2943508](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L32 "Show revision 2943508 of this file in browser") | [r2955097](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097#L32 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 32 | 32 | function hook\_init() { |
  | 33 | 33 | add\_action('newsletter\_action', array($this, 'hook\_newsletter\_action'), 10, 3); |
  | 34 |  | if (!is\_admin()) { |
  |  | 34 | if (!is\_admin() || defined('DOING\_AJAX') && DOING\_AJAX) { |
  | 35 | 35 | // Shortcode for the Newsletter page |
  | 36 | 36 | add\_shortcode('newsletter', array($this, 'shortcode\_newsletter')); |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L38) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097#L38) |  |
  | 38 | 38 | add\_shortcode('newsletter\_field', array($this, 'shortcode\_newsletter\_field')); |
  | 39 | 39 | } |
  | 40 |  | ~~}~~ |
  | 41 |  |  |
  | 42 |  | ~~function get\_options($set = '', $language = null) {~~ |
  | 43 |  | ~~// This is a patch for addon using the "profile" set which originally contained the~~ |
  | 44 |  | ~~// form options. This patch can create a problem if someone calls this method to get the actual~~ |
  | 45 |  | ~~// "profile" set which is the configuration of the profile page.~~ |
  | 46 |  | ~~// The correct call would be NewsletterProfile::instance()->get\_options().~~ |
  | 47 |  | ~~if ($set === 'profile') {~~ |
  | 48 |  | ~~$set = 'form';~~ |
  | 49 |  | ~~}~~ |
  | 50 |  | ~~return parent::get\_options($set, $language);~~ |
  | 51 | 40 | } |
  | 52 | 41 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L194) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097#L183) |  |
  | 194 | 183 | } |
  | 195 | 184 | } |
  |  | 185 |  |
  |  | 186 | function get\_options($set = '', $language = null) { |
  |  | 187 | // This is a patch for addon using the "profile" set which originally contained the |
  |  | 188 | // form options. This patch can create a problem if someone calls this method to get the actual |
  |  | 189 | // "profile" set which is the configuration of the profile page. |
  |  | 190 | // The correct call would be NewsletterProfile::instance()->get\_options(). |
  |  | 191 | if ($set === 'profile') { |
  |  | 192 | $set = 'form'; |
  |  | 193 | } |
  |  | 194 | return parent::get\_options($set, $language); |
  |  | 195 | } |
  | 196 | 196 |  |
  | 197 | 197 | function get\_form\_options() { |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1505) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097#L1505) |  |
  | 1505 | 1505 | } |
  | 1506 | 1506 |  |
  | 1507 |  | if (isset($attrs['before'])) { |
  | 1508 |  | $buffer .= $attrs['before']; |
  | 1509 |  | } else { |
  | 1510 |  | if (isset($attrs['class'])) { |
  | 1511 |  | $buffer .= '<div class="tnp tnp-subscription ' . $attrs['class'] . '">' . "\n"; |
  | 1512 |  | } else { |
  | 1513 |  | $buffer .= '<div class="tnp tnp-subscription">' . "\n"; |
  | 1514 |  | } |
  |  | 1507 |  |
  |  | 1508 | if (isset($attrs['class'])) { |
  |  | 1509 | $buffer .= '<div class="tnp tnp-subscription ' . esc\_attr($attrs['class']) . '">' . "\n"; |
  |  | 1510 | } else { |
  |  | 1511 | $buffer .= '<div class="tnp tnp-subscription">' . "\n"; |
  | 1515 | 1512 | } |
  | 1516 | 1513 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1568) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097#L1565) |  |
  | 1568 | 1565 | } |
  | 1569 | 1566 |  |
  | 1570 |  |  |
  | 1571 | 1567 | $buffer .= '<input class="tnp-submit" type="submit" value="' . esc\_attr($this->get\_form\_text('subscribe')) . '" ' . $button\_style . '>' . "\n"; |
  | 1572 | 1568 |  |
  | 1573 | 1569 | $buffer .= "</div>\n</form>\n"; |
  | 1574 | 1570 |  |
  | 1575 |  | if (isset($attrs['after'])) { |
  | 1576 |  | $buffer .= $attrs['after']; |
  | 1577 |  | } else { |
  | 1578 |  | $buffer .= "</div>\n"; |
  | 1579 |  | } |
  |  | 1571 | $buffer .= "</div>\n"; |
  | 1580 | 1572 |  |
  | 1581 | 1573 | return $buffer; |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1592) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097#L1584) |  |
  | 1592 | 1584 |  |
  | 1593 | 1585 | if (stripos($form, '<form') === false) { |
  | 1594 |  | $form = '<form method="post" action="' . ~~$action~~ . '">' . $form . '</form>'; |
  |  | 1586 | $form = '<form method="post" action="' . esc\_attr($action) . '">' . $form . '</form>'; |
  | 1595 | 1587 | } |
  | 1596 | 1588 |  |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1613) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097#L1605) |  |
  | 1613 | 1605 | $lists = $this->get\_lists\_for\_subscription(); |
  | 1614 | 1606 | foreach ($lists as $list) { |
  | 1615 |  | $checkboxes .= '<input type="checkbox" name="nl[]" value="' . ~~$list->id . '"> ' . $list->name~~ . '<br />'; |
  |  | 1607 | $checkboxes .= '<input type="checkbox" name="nl[]" value="' . esc\_attr($list->id) . '"> ' . esc\_attr($list->name) . '<br />'; |
  | 1616 | 1608 | } |
  | 1617 | 1609 | $buffer = str\_replace('{lists}', $checkboxes, $buffer); |
  | 1618 |  | $buffer = str\_replace('{preferences}', $checkboxes, $buffer); |
  |  | 1610 | $buffer = str\_replace('{preferences}', $checkboxes, $buffer); // For compatibility |
  | 1619 | 1611 | return $buffer; |
  | 1620 | 1612 | } |
  | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2943508#L1651) | […](/browser/newsletter/trunk/subscription/subscription.php?rev=2955097#L1643) |  |
  | 1651 | 1643 | $form = ''; |
  | 1652 | 1644 |  |
  | 1653 |  | $form .= '<div class="tnp tnp-subscription-minimal ' . ~~$attrs['class']~~ . '">'; |
  |  | 1645 | $form .= '<div class="tnp tnp-subscription-minimal ' . esc\_attr($attrs['class']) . '">'; |
  | 1654 | 1646 | $form .= '<form action="' . esc\_attr($this->build\_action\_url('s')) . '" method="post"'; |
  | 1655 | 1647 | if (!empty($attrs['id'])) { |
* ## [newsletter/trunk/subscription/template.php](/changeset/2955097/newsletter/trunk/subscription/template.php "Show the changeset 2955097 restricted to newsletter/trunk/subscription/template.php")

  | [r2922655](/browser/newsletter/trunk/subscription/template.php?rev=2922655#L22 "Show revision 2922655 of this file in browser") | [r2955097](/browser/newsletter/trunk/subscription/template.php?rev=2955097#L22 "Show revision 2955097 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | if ($controls->is\_action('test')) { |
  | 23 | 23 |  |
  | 24 |  | $users = $~~module~~->get\_test\_users(); |
  |  | 24 | $users = $this->get\_test\_users(); |
  | 25 | 25 | if (count($users) == 0) { |
  | 26 | 26 | $controls->errors = \_\_('No test subscribers found.', 'newsletter') . ' <a href="https://www.thenewsletterplugin.com/plugins/newsletter/subscribers-module#test" target="\_blank"><i class="fas fa-info-circle"></i></a>'; |
  | […](/browser/newsletter/trunk/subscription/template.php?rev=2922655#L40) | […](/browser/newsletter/trunk/subscription/template.php?rev=2955097#L40) |  |
  | 40 | 40 | foreach ($users as $user) { |
  | 41 | 41 | $addresses[] = $user->email; |
  | 42 |  | Newsletter::instance()->mail($user->email, 'Newsletter Messages Template Test', $~~module~~->replace($message, $user)); |
  |  | 42 | Newsletter::instance()->mail($user->email, 'Newsletter Messages Template Test', $this->replace($message, $user)); |
  | 43 | 43 | } |
  | 44 | 44 | $controls->messages .= 'Test emails sent to ' . count($users) . ' test subscribers: ' . |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2955097)
* [Zip Archive](?format=zip&new=2955097)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_7d0f633b_20250114_192142.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fnewsletter%2Ftags%2F7.8.9%2Fsubscription%2Fsubscription.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/newsletter/tags/7.8.9/subscription/subscription.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/newsletter/tags/7.8.9/subscription/subscription.php)

---

# [source:](/browser?order=name "Go to repository root") [newsletter](/browser/newsletter?order=name "View newsletter")/[tags](/browser/newsletter/tags?order=name "View tags")/[7.8.9](/browser/newsletter/tags/7.8.9?order=name "View 7.8.9")/[subscription](/browser/newsletter/tags/7.8.9/subscription?order=name "View subscription")/[subscription.php](/browser/newsletter/tags/7.8.9/subscription/subscription.php?order=name "View subscription.php")

View diff against:

View revision:

| [Last change](/changeset/2943508/newsletter/tags/7.8.9/subscription/subscription.php "View differences") on this file was [2943508](/changeset/2943508/ "View changeset 2943508"), checked in by satollo, [18 months ago](/timeline?from=2023-07-26T09%3A06%3A16Z&precision=second "See timeline at 07/26/2023 09:06:16 AM") |
| --- |
| Version 7.8.9 |
| **File size:** 65.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | defined('ABSPATH') || exit; |
| [4](#L4) |  |
| [5](#L5) | class NewsletterSubscription extends NewsletterModule { |
| [6](#L6) |  |
| [7](#L7) | const MESSAGE\_CONFIRMED = 'confirmed'; |
| [8](#L8) | const OPTIN\_DOUBLE = 0; |
| [9](#L9) | const OPTIN\_SINGLE = 1; |
| [10](#L10) |  |
| [11](#L11) | static $instance; |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* @return NewsletterSubscription |
| [15](#L15) | \*/ |
| [16](#L16) | static function instance() { |
| [17](#L17) | if (self::$instance == null) { |
| [18](#L18) | self::$instance = new self(); |
| [19](#L19) | } |
| [20](#L20) | return self::$instance; |
| [21](#L21) | } |
| [22](#L22) |  |
| [23](#L23) | function \_\_construct() { |
| [24](#L24) |  |
| [25](#L25) | parent::\_\_construct('subscription'); |
| [26](#L26) |  |
| [27](#L27) | // Must be called after the Newsletter::hook\_init, since some constants are defined |
| [28](#L28) | // there. |
| [29](#L29) | add\_action('init', [$this, 'hook\_init'], 90); |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | function hook\_init() { |
| [33](#L33) | add\_action('newsletter\_action', array($this, 'hook\_newsletter\_action'), 10, 3); |
| [34](#L34) | if (!is\_admin()) { |
| [35](#L35) | // Shortcode for the Newsletter page |
| [36](#L36) | add\_shortcode('newsletter', array($this, 'shortcode\_newsletter')); |
| [37](#L37) | add\_shortcode('newsletter\_form', array($this, 'shortcode\_newsletter\_form')); |
| [38](#L38) | add\_shortcode('newsletter\_field', array($this, 'shortcode\_newsletter\_field')); |
| [39](#L39) | } |
| [40](#L40) | } |
| [41](#L41) |  |
| [42](#L42) | function get\_options($set = '', $language = null) { |
| [43](#L43) | // This is a patch for addon using the "profile" set which originally contained the |
| [44](#L44) | // form options. This patch can create a problem if someone calls this method to get the actual |
| [45](#L45) | // "profile" set which is the configuration of the profile page. |
| [46](#L46) | // The correct call would be NewsletterProfile::instance()->get\_options(). |
| [47](#L47) | if ($set === 'profile') { |
| [48](#L48) | $set = 'form'; |
| [49](#L49) | } |
| [50](#L50) | return parent::get\_options($set, $language); |
| [51](#L51) | } |
| [52](#L52) |  |
| [53](#L53) | /\*\* |
| [54](#L54) | \* |
| [55](#L55) | \* @global wpdb $wpdb |
| [56](#L56) | \* @return mixed |
| [57](#L57) | \*/ |
| [58](#L58) | function hook\_newsletter\_action($action, $user, $email) { |
| [59](#L59) | switch ($action) { |
| [60](#L60) | case 'profile-change': |
| [61](#L61) | if ($this->antibot\_form\_check()) { |
| [62](#L62) |  |
| [63](#L63) | if (!$user || $user->status != TNP\_user::STATUS\_CONFIRMED) { |
| [64](#L64) | $this->dienow('Subscriber not found or not confirmed.', 'Even the wrong subscriber token can lead to this error.', 404); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | if (!$email) { |
| [68](#L68) | $this->dienow('Newsletter not found', 'The newsletter containing the link has been deleted.', 404); |
| [69](#L69) | } |
| [70](#L70) |  |
| [71](#L71) | if (isset($\_REQUEST['list'])) { |
| [72](#L72) | $list\_id = (int) $\_REQUEST['list']; |
| [73](#L73) |  |
| [74](#L74) | // Check if the list is public |
| [75](#L75) | $list = $this->get\_list($list\_id); |
| [76](#L76) | if (!$list || $list->status == TNP\_List::STATUS\_PRIVATE) { |
| [77](#L77) | $this->dienow('List change not allowed.', 'Please check if the list is marked as "private".', 400); |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | if (empty($\_REQUEST['redirect'])) { |
| [81](#L81) | $url = home\_url(); |
| [82](#L82) | } else { |
| [83](#L83) | $url = esc\_url\_raw($\_REQUEST['redirect']); |
| [84](#L84) | } |
| [85](#L85) | $this->set\_user\_list($user, $list\_id, $\_REQUEST['value']); |
| [86](#L86) |  |
| [87](#L87) | $user = $this->get\_user($user->id); |
| [88](#L88) | $this->add\_user\_log($user, 'cta'); |
| [89](#L89) | NewsletterStatistics::instance()->add\_click($url, $user->id, $email->id); |
| [90](#L90) | wp\_redirect($url); |
| [91](#L91) | die(); |
| [92](#L92) | } |
| [93](#L93) | } else { |
| [94](#L94) | $this->request\_to\_antibot\_form('Continue'); |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | die(); |
| [98](#L98) |  |
| [99](#L99) | case 'm': |
| [100](#L100) | case 'message': |
| [101](#L101) | include \_\_DIR\_\_ . '/page.php'; |
| [102](#L102) | die(); |
| [103](#L103) |  |
| [104](#L104) | // normal subscription |
| [105](#L105) | case 's': |
| [106](#L106) | case 'subscribe': |
| [107](#L107) |  |
| [108](#L108) | if ($\_SERVER['REQUEST\_METHOD'] !== 'POST') { |
| [109](#L109) | $this->dienow('Invalid request', 'The subscription request was not made with a HTTP POST', 400); |
| [110](#L110) | } |
| [111](#L111) |  |
| [112](#L112) | $options\_antibot = $this->get\_options('antispam'); |
| [113](#L113) |  |
| [114](#L114) | $captcha = !empty($options\_antibot['captcha']); |
| [115](#L115) |  |
| [116](#L116) | if (!empty($\_GET['\_wp\_amp\_action\_xhr\_converted']) || !empty($options\_antibot['disabled']) || $this->antibot\_form\_check($captcha)) { |
| [117](#L117) |  |
| [118](#L118) | $subscription = $this->build\_subscription(); |
| [119](#L119) |  |
| [120](#L120) | $user = $this->subscribe2($subscription); |
| [121](#L121) |  |
| [122](#L122) | if (is\_wp\_error($user)) { |
| [123](#L123) | if ($user->get\_error\_code() === 'exists') { |
| [124](#L124) | $this->dienow($this->get\_text('error\_text'), $user->get\_error\_message(), 200); |
| [125](#L125) | } |
| [126](#L126) | $this->dienow('Registration failed.', $user->get\_error\_message(), 400); |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
| [130](#L130) | $this->show\_message('confirmed', $user); |
| [131](#L131) | } |
| [132](#L132) | if ($user->status == TNP\_User::STATUS\_NOT\_CONFIRMED) { |
| [133](#L133) | $this->show\_message('confirmation', $user); |
| [134](#L134) | } |
| [135](#L135) | } else { |
| [136](#L136) | $language = isset($\_REQUEST['nlang']) ? $\_REQUEST['nlang'] : ''; |
| [137](#L137) | Newsletter::instance()->switch\_language($language); |
| [138](#L138) | $this->request\_to\_antibot\_form($this->get\_form\_text('subscribe'), $captcha); |
| [139](#L139) | } |
| [140](#L140) | die(); |
| [141](#L141) |  |
| [142](#L142) | // AJAX subscription |
| [143](#L143) | case 'ajaxsub': |
| [144](#L144) |  |
| [145](#L145) | if ($\_SERVER['REQUEST\_METHOD'] !== 'POST') { |
| [146](#L146) | $this->dienow('Invalid request'); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | $subscription = $this->build\_subscription(); |
| [150](#L150) |  |
| [151](#L151) | $user = $this->subscribe2($subscription); |
| [152](#L152) |  |
| [153](#L153) | if (is\_wp\_error($user)) { |
| [154](#L154) | if ($user->get\_error\_code() === 'exists') { |
| [155](#L155) | echo $this->get\_text('error\_text'); |
| [156](#L156) | die(); |
| [157](#L157) | } else { |
| [158](#L158) | $this->dienow('Registration failed.', $user->get\_error\_message(), 400); |
| [159](#L159) | } |
| [160](#L160) | } else { |
| [161](#L161) | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
| [162](#L162) | $key = 'confirmed'; |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | if ($user->status == TNP\_User::STATUS\_NOT\_CONFIRMED) { |
| [166](#L166) | $key = 'confirmation'; |
| [167](#L167) | } |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) | $this->switch\_language($user->language); |
| [171](#L171) | $message = $this->replace($this->get\_text($key . '\_text'), $user); |
| [172](#L172) | $message .= $this->get\_option($key . '\_tracking'); |
| [173](#L173) | echo $message; |
| [174](#L174) | die(); |
| [175](#L175) |  |
| [176](#L176) | case 'c': |
| [177](#L177) | case 'confirm': |
| [178](#L178) | if (!$user) { |
| [179](#L179) | $this->dienow(\_\_('Subscriber not found.', 'newsletter'), 'Or it is not present or the secret key does not match.', 404); |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | if ($this->antibot\_form\_check()) { |
| [183](#L183) | $user = $this->confirm($user); |
| [184](#L184) | $this->set\_user\_cookie($user); |
| [185](#L185) | $this->show\_message('confirmed', $user); |
| [186](#L186) | } else { |
| [187](#L187) | $this->request\_to\_antibot\_form('Confirm'); |
| [188](#L188) | } |
| [189](#L189) | die(); |
| [190](#L190) | break; |
| [191](#L191) |  |
| [192](#L192) | default: |
| [193](#L193) | return; |
| [194](#L194) | } |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | function get\_form\_options() { |
| [198](#L198) | return $this->get\_options('form'); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | function get\_form\_option($key) { |
| [202](#L202) | return $this->get\_option($key, 'form'); |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | function get\_form\_text($key) { |
| [206](#L206) | return $this->get\_text($key, 'form'); |
| [207](#L207) | } |
| [208](#L208) |  |
| [209](#L209) | function set\_updated($user, $time = 0, $ip = '') { |
| [210](#L210) | global $wpdb; |
| [211](#L211) | if (!$time) { |
| [212](#L212) | $time = time(); |
| [213](#L213) | } |
| [214](#L214) |  |
| [215](#L215) | if (!$ip) { |
| [216](#L216) | $ip = $this->get\_remote\_ip(); |
| [217](#L217) | } |
| [218](#L218) | $ip = $this->process\_ip($ip); |
| [219](#L219) |  |
| [220](#L220) | if (is\_object($user)) { |
| [221](#L221) | $id = $user->id; |
| [222](#L222) | } else if (is\_array($user)) { |
| [223](#L223) | $id = $user['id']; |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) | $id = (int) $id; |
| [227](#L227) |  |
| [228](#L228) | $wpdb->update(NEWSLETTER\_USERS\_TABLE, array('updated' => $time, 'ip' => $ip, 'geo' => 0), array('id' => $id)); |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | /\*\* |
| [232](#L232) | \* Sanitize the subscription data collected before process them. Cleanup the lists, the optin mode, email, first name, |
| [233](#L233) | \* last name, adds mandatory lists, get (if not provided) and process the IP. |
| [234](#L234) | \* |
| [235](#L235) | \* @param TNP\_Subscription\_Data $data |
| [236](#L236) | \*/ |
| [237](#L237) | private function sanitize($data) { |
| [238](#L238) | $data->email = $this->normalize\_email($data->email); |
| [239](#L239) | if (!empty($data->name)) { |
| [240](#L240) | $data->name = $this->normalize\_name($data->name); |
| [241](#L241) | } |
| [242](#L242) | if (!empty($data->surname)) { |
| [243](#L243) | $data->surname = $this->normalize\_name($data->surname); |
| [244](#L244) | } |
| [245](#L245) |  |
| [246](#L246) | if (empty($data->ip)) { |
| [247](#L247) | $data->ip = $this->get\_remote\_ip(); |
| [248](#L248) | } |
| [249](#L249) | $data->ip = $this->process\_ip($data->ip); |
| [250](#L250) |  |
| [251](#L251) | if (isset($data->http\_referer)) { |
| [252](#L252) | $data->http\_referer = mb\_substr(strip\_tags($data->http\_referer), 0, 200); |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | if (isset($data->sex)) { |
| [256](#L256) | $data->sex = $this->sanitize\_gender($data->sex); |
| [257](#L257) | } |
| [258](#L258) |  |
| [259](#L259) | if (!isset($data->language)) { |
| [260](#L260) | $data->language = $this->language(); |
| [261](#L261) | } else { |
| [262](#L262) | $data->language = strtolower(strip\_tags($data->language)); |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
| [266](#L266) | $key = 'profile\_' . $i; |
| [267](#L267) | if (isset($data->$key)) { |
| [268](#L268) | $data->$key = trim($data->$key); |
| [269](#L269) | } |
| [270](#L270) | } |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | /\*\* |
| [274](#L274) | \* Builds a default subscription object to be used to collect data and subscription options. |
| [275](#L275) | \* |
| [276](#L276) | \* @return TNP\_Subscription |
| [277](#L277) | \*/ |
| [278](#L278) | function get\_default\_subscription($language = null) { |
| [279](#L279) | $subscription = new TNP\_Subscription(); |
| [280](#L280) |  |
| [281](#L281) | $language = is\_null($language) ? $this->language() : $language; |
| [282](#L282) |  |
| [283](#L283) | $subscription->data->language = $language; |
| [284](#L284) | $subscription->optin = $this->is\_double\_optin() ? 'double' : 'single'; |
| [285](#L285) |  |
| [286](#L286) | $multiple = (int) $this->get\_option('multiple'); |
| [287](#L287) |  |
| [288](#L288) | switch ($multiple) { |
| [289](#L289) | case 0: $subscription->if\_exists = TNP\_Subscription::EXISTING\_ERROR; |
| [290](#L290) | break; |
| [291](#L291) | case 1: $subscription->if\_exists = TNP\_Subscription::EXISTING\_MERGE; |
| [292](#L292) | break; |
| [293](#L293) | case 2: $subscription->if\_exists = TNP\_Subscription::EXISTING\_SINGLE\_OPTIN; |
| [294](#L294) | } |
| [295](#L295) |  |
| [296](#L296) | $lists = $this->get\_lists(); |
| [297](#L297) | foreach ($lists as $list) { |
| [298](#L298) | if ($list->forced) { |
| [299](#L299) | $subscription->data->lists['' . $list->id] = 1; |
| [300](#L300) | continue; |
| [301](#L301) | } |
| [302](#L302) | // Enforced by language |
| [303](#L303) | if ($language && in\_array($language, $list->languages)) { |
| [304](#L304) | $subscription->data->lists['' . $list->id] = 1; |
| [305](#L305) | } |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | return $subscription; |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | /\*\* |
| [312](#L312) | \* |
| [313](#L313) | \* @param TNP\_Subscription $subscription |
| [314](#L314) | \* |
| [315](#L315) | \* @return TNP\_User|WP\_Error |
| [316](#L316) | \*/ |
| [317](#L317) | function subscribe2(TNP\_Subscription $subscription) { |
| [318](#L318) |  |
| [319](#L319) | $this->logger->debug($subscription); |
| [320](#L320) |  |
| [321](#L321) | $this->sanitize($subscription->data); |
| [322](#L322) |  |
| [323](#L323) | if (empty($subscription->data->email)) { |
| [324](#L324) | return new WP\_Error('email', 'Wrong email address'); |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | if (!empty($subscription->data->country) && strlen($subscription->data->country) != 2) { |
| [328](#L328) | return new WP\_Error('country', 'Country code length error. ISO 3166-1 alpha-2 format (2 letters)'); |
| [329](#L329) | } |
| [330](#L330) |  |
| [331](#L331) | // Here we should have a clean subscription data |
| [332](#L332) | // Filter? |
| [333](#L333) |  |
| [334](#L334) | if ($subscription->spamcheck) { |
| [335](#L335) | // TODO: Use autoload |
| [336](#L336) | require\_once NEWSLETTER\_INCLUDES\_DIR . '/antispam.php'; |
| [337](#L337) | $antispam = NewsletterAntispam::instance(); |
| [338](#L338) | if ($antispam->is\_spam($subscription)) { |
| [339](#L339) | return new WP\_Error('spam', 'This looks like a spam subscription'); |
| [340](#L340) | } |
| [341](#L341) | } |
| [342](#L342) |  |
| [343](#L343) | // Exists? |
| [344](#L344) | $user = $this->get\_user\_by\_email($subscription->data->email); |
| [345](#L345) |  |
| [346](#L346) | $subscription = apply\_filters('newsletter\_subscription', $subscription, $user); |
| [347](#L347) |  |
| [348](#L348) | // Do we accept repeated subscriptions? |
| [349](#L349) | if ($user != null && $subscription->if\_exists === TNP\_Subscription::EXISTING\_ERROR) { |
| [350](#L350) | //$this->show\_message('error', $user); |
| [351](#L351) | return new WP\_Error('exists', 'Email address already registered and Newsletter sets to block repeated registrations. You can change this behavior or the user message above on subscription configuration panel.'); |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) |  |
| [355](#L355) | if ($user != null) { |
| [356](#L356) |  |
| [357](#L357) | $this->logger->info('Subscription of an address with status ' . $user->status); |
| [358](#L358) |  |
| [359](#L359) | // We cannot communicate with bounced addresses, there is no reason to proceed |
| [360](#L360) | // TODO: Evaluate if the bounce status is very old, possible reset it |
| [361](#L361) | if ($user->status == TNP\_User::STATUS\_BOUNCED || $user->status == TNP\_User::STATUS\_COMPLAINED) { |
| [362](#L362) | return new WP\_Error('bounced', 'Subscriber present and blocked'); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | if ($user->status == TNP\_User::STATUS\_UNSUBSCRIBED) { |
| [366](#L366) | // Special behavior? |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | if ($subscription->optin == 'single') { |
| [370](#L370) | $user->status = TNP\_User::STATUS\_CONFIRMED; |
| [371](#L371) | } else { |
| [372](#L372) | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
| [373](#L373) |  |
| [374](#L374) | set\_transient('newsletter\_subscription\_' . $user->id, $subscription->data, 3600 \* 48); |
| [375](#L375) |  |
| [376](#L376) | // This status is \*not\* stored it indicate a temporary status to show the correct messages |
| [377](#L377) | $user->status = TNP\_User::STATUS\_NOT\_CONFIRMED; |
| [378](#L378) |  |
| [379](#L379) | $this->send\_message('confirmation', $user); |
| [380](#L380) |  |
| [381](#L381) | return $user; |
| [382](#L382) | } else { |
| [383](#L383) | $user->status = TNP\_User::STATUS\_NOT\_CONFIRMED; |
| [384](#L384) | } |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | // Can be updated on the fly? |
| [388](#L388) | $subscription->data->merge\_in($user); |
| [389](#L389) | } else { |
| [390](#L390) | $this->logger->info('New subscriber'); |
| [391](#L391) |  |
| [392](#L392) | $user = new TNP\_User(); |
| [393](#L393) | $subscription->data->merge\_in($user); |
| [394](#L394) |  |
| [395](#L395) | $user->token = $this->get\_token(); |
| [396](#L396) |  |
| [397](#L397) | $user->status = $subscription->optin == 'single' ? TNP\_User::STATUS\_CONFIRMED : TNP\_User::STATUS\_NOT\_CONFIRMED; |
| [398](#L398) | $user->updated = time(); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | $user->ip = $this->process\_ip($user->ip); |
| [402](#L402) |  |
| [403](#L403) | $user = apply\_filters('newsletter\_user\_subscribe', $user); |
| [404](#L404) |  |
| [405](#L405) | $user = $this->save\_user($user); |
| [406](#L406) |  |
| [407](#L407) | $this->add\_user\_log($user, 'subscribe'); |
| [408](#L408) |  |
| [409](#L409) | // Notification to admin (only for new confirmed subscriptions) |
| [410](#L410) | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
| [411](#L411) | do\_action('newsletter\_user\_confirmed', $user); |
| [412](#L412) | $this->notify\_admin\_on\_subscription($user); |
| [413](#L413) | setcookie('newsletter', $user->id . '-' . $user->token, time() + 60 \* 60 \* 24 \* 365, '/'); |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | if ($subscription->send\_emails) { |
| [417](#L417) | $this->send\_message(($user->status == TNP\_User::STATUS\_CONFIRMED) ? 'confirmed' : 'confirmation', $user); |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | // Used by Autoresponder (probably) |
| [421](#L421) | do\_action('newsletter\_user\_post\_subscribe', $user); |
| [422](#L422) |  |
| [423](#L423) | return $user; |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | /\*\* |
| [427](#L427) | \* Create a subscription using the $\_REQUEST data. Does security checks. |
| [428](#L428) | \* |
| [429](#L429) | \* @deprecated since version 6.9.0 |
| [430](#L430) | \* @param string $status The status to use for this subscription (confirmed, not confirmed, ...) |
| [431](#L431) | \* @param bool $emails If the confirmation/welcome email should be sent or the subscription should be silent |
| [432](#L432) | \* @return TNP\_User |
| [433](#L433) | \* |
| [434](#L434) | \* @deprecated |
| [435](#L435) | \*/ |
| [436](#L436) | function subscribe($status = null, $emails = true) { |
| [437](#L437) |  |
| [438](#L438) | $this->logger->debug('Subscription start'); |
| [439](#L439) |  |
| [440](#L440) | // Validation |
| [441](#L441) | $ip = $this->get\_remote\_ip(); |
| [442](#L442) | $email = $this->normalize\_email(stripslashes($\_REQUEST['ne'])); |
| [443](#L443) | $first\_name = ''; |
| [444](#L444) | if (isset($\_REQUEST['nn'])) { |
| [445](#L445) | $first\_name = $this->normalize\_name(stripslashes($\_REQUEST['nn'])); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | $last\_name = ''; |
| [449](#L449) | if (isset($\_REQUEST['ns'])) { |
| [450](#L450) | $last\_name = $this->normalize\_name(stripslashes($\_REQUEST['ns'])); |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | $opt\_in = (int) $this->get\_option('noconfirmation'); // 0 - double, 1 - single |
| [454](#L454) | if (!empty($this->get\_option('optin\_override')) && isset($\_REQUEST['optin'])) { |
| [455](#L455) | switch ($\_REQUEST['optin']) { |
| [456](#L456) | case 'single': $opt\_in = self::OPTIN\_SINGLE; |
| [457](#L457) | break; |
| [458](#L458) | case 'double': $opt\_in = self::OPTIN\_DOUBLE; |
| [459](#L459) | break; |
| [460](#L460) | } |
| [461](#L461) | } |
| [462](#L462) |  |
| [463](#L463) | if ($status != null) { |
| [464](#L464) | // If a status is forced and it is requested to be "confirmed" is like a single opt in |
| [465](#L465) | // $status here can only be confirmed or not confirmed |
| [466](#L466) | // TODO: Add a check on status values |
| [467](#L467) | if ($status == TNP\_User::STATUS\_CONFIRMED) { |
| [468](#L468) | $opt\_in = self::OPTIN\_SINGLE; |
| [469](#L469) | } else { |
| [470](#L470) | $opt\_in = self::OPTIN\_DOUBLE; |
| [471](#L471) | } |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | $user = $this->get\_user($email); |
| [475](#L475) |  |
| [476](#L476) | if ($user != null) { |
| [477](#L477) | // Email already registered in our database |
| [478](#L478) | $this->logger->info('Subscription of an address with status ' . $user->status); |
| [479](#L479) |  |
| [480](#L480) | // Bounced |
| [481](#L481) | // TODO: Manage other cases when added |
| [482](#L482) | if ($user->status == 'B') { |
| [483](#L483) | // Non persistent status to decide which message to show (error) |
| [484](#L484) | $user->status = 'E'; |
| [485](#L485) | return $user; |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | // Is there any relevant data change? If so we can proceed otherwise if repeated subscriptions are disabled |
| [489](#L489) | // show an already subscribed message |
| [490](#L490) |  |
| [491](#L491) | if (empty($this->options['multiple'])) { |
| [492](#L492) | $user->status = 'E'; |
| [493](#L493) | return $user; |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | // If the subscriber is confirmed, we cannot change his data in double opt in mode, we need to |
| [497](#L497) | // temporary store and wait for activation |
| [498](#L498) | if ($user->status == TNP\_User::STATUS\_CONFIRMED && $opt\_in == self::OPTIN\_DOUBLE) { |
| [499](#L499) |  |
| [500](#L500) | set\_transient($this->get\_user\_key($user), $\_REQUEST, 3600 \* 48); |
| [501](#L501) |  |
| [502](#L502) | // This status is \*not\* stored it indicate a temporary status to show the correct messages |
| [503](#L503) | $user->status = 'S'; |
| [504](#L504) |  |
| [505](#L505) | $this->send\_message('confirmation', $user); |
| [506](#L506) |  |
| [507](#L507) | return $user; |
| [508](#L508) | } |
| [509](#L509) | } |
| [510](#L510) |  |
| [511](#L511) | // Here we have a new subscription or we can process the subscription even with a pre-existant user for example |
| [512](#L512) | // because it is not confirmed |
| [513](#L513) | if ($user != null) { |
| [514](#L514) | $this->logger->info("Email address subscribed but not confirmed"); |
| [515](#L515) | $user = array('id' => $user->id); |
| [516](#L516) | } else { |
| [517](#L517) | $this->logger->info("New email address"); |
| [518](#L518) | $user = array('email' => $email); |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | $user = $this->update\_user\_from\_request($user); |
| [522](#L522) |  |
| [523](#L523) | $user['token'] = $this->get\_token(); |
| [524](#L524) | $ip = $this->process\_ip($ip); |
| [525](#L525) | $user['ip'] = $ip; |
| [526](#L526) | $user['geo'] = 0; |
| [527](#L527) | $user['status'] = $opt\_in == self::OPTIN\_SINGLE ? TNP\_User::STATUS\_CONFIRMED : TNP\_User::STATUS\_NOT\_CONFIRMED; |
| [528](#L528) |  |
| [529](#L529) | $user['updated'] = time(); |
| [530](#L530) |  |
| [531](#L531) | $user = apply\_filters('newsletter\_user\_subscribe', $user); |
| [532](#L532) |  |
| [533](#L533) | $user = $this->save\_user($user); |
| [534](#L534) |  |
| [535](#L535) | $this->add\_user\_log($user, 'subscribe'); |
| [536](#L536) |  |
| [537](#L537) | // Notification to admin (only for new confirmed subscriptions) |
| [538](#L538) | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
| [539](#L539) | do\_action('newsletter\_user\_confirmed', $user); |
| [540](#L540) | $this->notify\_admin\_on\_subscription($user); |
| [541](#L541) | setcookie('newsletter', $user->id . '-' . $user->token, time() + 60 \* 60 \* 24 \* 365, '/'); |
| [542](#L542) | } |
| [543](#L543) |  |
| [544](#L544) | if ($emails) { |
| [545](#L545) | $this->send\_message(($user->status == TNP\_User::STATUS\_CONFIRMED) ? 'confirmed' : 'confirmation', $user); |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | $user = apply\_filters('newsletter\_user\_post\_subscribe', $user); |
| [549](#L549) |  |
| [550](#L550) | return $user; |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | function add\_microdata($message) { |
| [554](#L554) | return $message . '<span itemscope itemtype="http://schema.org/EmailMessage"><span itemprop="description" content="Email address confirmation"></span><span itemprop="action" itemscope itemtype="http://schema.org/ConfirmAction"><meta itemprop="name" content="Confirm Subscription"><span itemprop="handler" itemscope itemtype="http://schema.org/HttpActionHandler"><meta itemprop="url" content="{subscription\_confirm\_url}"><link itemprop="method" href="http://schema.org/HttpRequestMethod/POST"></span></span></span>'; |
| [555](#L555) | } |
| [556](#L556) |  |
| [557](#L557) | function get\_language\_from\_request() { |
| [558](#L558) | return isset($\_REQUEST['nlang']) ? trim(strip\_tags($\_REQUEST['nlang'])) : $this->language(); |
| [559](#L559) | } |
| [560](#L560) |  |
| [561](#L561) | /\*\* |
| [562](#L562) | \* Builds a subscription object starting from values in the $\_REQUEST |
| [563](#L563) | \* global variable. It DOES NOT sanitizie or formally check the values. |
| [564](#L564) | \* Usually data comes from a form submission. |
| [565](#L565) | \* https://www.thenewsletterplugin.com/documentation/subscription/newsletter-forms/ |
| [566](#L566) | \* |
| [567](#L567) | \* @return TNP\_Subscription |
| [568](#L568) | \*/ |
| [569](#L569) | function build\_subscription() { |
| [570](#L570) |  |
| [571](#L571) | $language = ''; |
| [572](#L572) | if (!empty($\_REQUEST['nlang'])) { |
| [573](#L573) | $language = $\_REQUEST['nlang']; |
| [574](#L574) | } else { |
| [575](#L575) | $language = $this->language(); |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | $subscription = $this->get\_default\_subscription($language); |
| [579](#L579) | $data = $subscription->data; |
| [580](#L580) |  |
| [581](#L581) | $data->email = $\_REQUEST['ne']; |
| [582](#L582) |  |
| [583](#L583) | // TODO: Remove and let it be controlled by integrations |
| [584](#L584) | //die($\_REQUEST['nsrc']); |
| [585](#L585) | if (isset($\_REQUEST['nsrc'])) { |
| [586](#L586) | $data->source = trim(stripslashes($\_REQUEST['nsrc'])); |
| [587](#L587) | } else { |
| [588](#L588) | $data->source = ''; |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | if (isset($\_REQUEST['nn'])) { |
| [592](#L592) | $data->name = stripslashes($\_REQUEST['nn']); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | if (isset($\_REQUEST['ns'])) { |
| [596](#L596) | $data->surname = stripslashes($\_REQUEST['ns']); |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | if (!empty($\_REQUEST['nx'])) { |
| [600](#L600) | $data->sex = $this->sanitize\_gender($\_REQUEST['nx']); |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | if (isset($\_REQUEST['nr'])) { |
| [604](#L604) | $data->referrer = $\_REQUEST['nr']; |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | // From the antibot form |
| [608](#L608) | if (isset($\_REQUEST['nhr'])) { |
| [609](#L609) | $data->http\_referer = stripslashes($\_REQUEST['nhr']); |
| [610](#L610) | } else if (isset($\_SERVER['HTTP\_REFERER'])) { |
| [611](#L611) | $data->http\_referer = $\_SERVER['HTTP\_REFERER']; |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) | // New profiles |
| [615](#L615) | $customfields = $this->get\_options('customfields'); |
| [616](#L616) | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
| [617](#L617) | // Private custom field? |
| [618](#L618) | if (empty($customfields['profile\_' . $i . '\_status'])) { |
| [619](#L619) | continue; |
| [620](#L620) | } |
| [621](#L621) | if (isset($\_REQUEST['np' . $i])) { |
| [622](#L622) | $data->profiles['' . $i] = stripslashes($\_REQUEST['np' . $i]); |
| [623](#L623) | } |
| [624](#L624) | } |
| [625](#L625) |  |
| [626](#L626) | // Lists (field name is nl[] and values the list number so special forms with radio button can work) |
| [627](#L627) | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
| [628](#L628) | $this->logger->debug($\_REQUEST['nl']); |
| [629](#L629) | foreach ($\_REQUEST['nl'] as $list\_id) { |
| [630](#L630) | $list = $this->get\_list($list\_id); |
| [631](#L631) | if (!$list || $list->is\_private()) { |
| [632](#L632) | // To administrator show an error to make him aware of the wrong form configuration |
| [633](#L633) | if (current\_user\_can('administrator')) { |
| [634](#L634) | $this->dienow('Invalid list', 'List ' . $list\_id . ' has been submitted but it is set as private. Please fix the subscription form.'); |
| [635](#L635) | } |
| [636](#L636) | // Ignore this list |
| [637](#L637) | continue; |
| [638](#L638) | } |
| [639](#L639) | $data->lists['' . $list\_id] = 1; |
| [640](#L640) | } |
| [641](#L641) | } else { |
| [642](#L642) | $this->logger->debug('No lists received'); |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | // Opt-in mode |
| [646](#L646) | if (!empty($this->options['optin\_override']) && isset($\_REQUEST['optin'])) { |
| [647](#L647) | switch ($\_REQUEST['optin']) { |
| [648](#L648) | case 'single': $subscription->optin = 'single'; |
| [649](#L649) | break; |
| [650](#L650) | case 'double': $subscription->optin = 'double'; |
| [651](#L651) | break; |
| [652](#L652) | } |
| [653](#L653) | } |
| [654](#L654) |  |
| [655](#L655) | return $subscription; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | /\*\* |
| [659](#L659) | \* Processes the request and fill in the \*array\* representing a subscriber with submitted values |
| [660](#L660) | \* (filtering when necessary). |
| [661](#L661) | \* |
| [662](#L662) | \* @deprecated since version 6.9.0 |
| [663](#L663) | \* @param array $user An array partially filled with subscriber data |
| [664](#L664) | \* @return array The filled array representing a subscriber |
| [665](#L665) | \*/ |
| [666](#L666) | function update\_user\_from\_request($user) { |
| [667](#L667) |  |
| [668](#L668) | if (isset($\_REQUEST['nn'])) { |
| [669](#L669) | $user['name'] = $this->normalize\_name(stripslashes($\_REQUEST['nn'])); |
| [670](#L670) | } |
| [671](#L671) | // TODO: required checking |
| [672](#L672) |  |
| [673](#L673) | if (isset($\_REQUEST['ns'])) { |
| [674](#L674) | $user['surname'] = $this->normalize\_name(stripslashes($\_REQUEST['ns'])); |
| [675](#L675) | } |
| [676](#L676) | // TODO: required checking |
| [677](#L677) |  |
| [678](#L678) | if (!empty($\_REQUEST['nx'])) { |
| [679](#L679) | $user['sex'] = $this->sanitize\_gender($\_REQUEST['nx']); |
| [680](#L680) | } |
| [681](#L681) | // TODO: valid values check |
| [682](#L682) |  |
| [683](#L683) | if (isset($\_REQUEST['nr'])) { |
| [684](#L684) | $user['referrer'] = strip\_tags(trim($\_REQUEST['nr'])); |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | $language = ''; |
| [688](#L688) | if (!empty($\_REQUEST['nlang'])) { |
| [689](#L689) | $language = strtolower(strip\_tags($\_REQUEST['nlang'])); |
| [690](#L690) | // TODO: Check if it's an allowed language code |
| [691](#L691) | $user['language'] = $language; |
| [692](#L692) | } else { |
| [693](#L693) | $language = $this->get\_current\_language(); |
| [694](#L694) | $user['language'] = $language; |
| [695](#L695) | } |
| [696](#L696) |  |
| [697](#L697) | // From the antibot form |
| [698](#L698) | if (isset($\_REQUEST['nhr'])) { |
| [699](#L699) | $user['http\_referer'] = strip\_tags(trim($\_REQUEST['nhr'])); |
| [700](#L700) | } else if (isset($\_SERVER['HTTP\_REFERER'])) { |
| [701](#L701) | $user['http\_referer'] = strip\_tags(trim($\_SERVER['HTTP\_REFERER'])); |
| [702](#L702) | } |
| [703](#L703) |  |
| [704](#L704) | if (strlen($user['http\_referer']) > 200) { |
| [705](#L705) | $user['http\_referer'] = mb\_substr($user['http\_referer'], 0, 200); |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) | // New profiles |
| [709](#L709) | for ($i = 1; $i <= NEWSLETTER\_PROFILE\_MAX; $i++) { |
| [710](#L710) | // If the profile cannot be set by  subscriber, skip it. |
| [711](#L711) | if ($this->options\_profile['profile\_' . $i . '\_status'] == 0) { |
| [712](#L712) | continue; |
| [713](#L713) | } |
| [714](#L714) | if (isset($\_REQUEST['np' . $i])) { |
| [715](#L715) | $user['profile\_' . $i] = trim(stripslashes($\_REQUEST['np' . $i])); |
| [716](#L716) | } |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | // Extra validation to explain the administrator while the submitted data could |
| [720](#L720) | // be interpreted only partially |
| [721](#L721) | if (current\_user\_can('administrator')) { |
| [722](#L722) | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
| [723](#L723) | foreach ($\_REQUEST['nl'] as $list\_id) { |
| [724](#L724) | $list = $this->get\_list($list\_id); |
| [725](#L725) | if ($list && $list->status == TNP\_List::STATUS\_PRIVATE) { |
| [726](#L726) | $this->dienow('Invalid list', '[old] List ' . $list\_id . ' has been submitted but it is set as private. Please fix the subscription form.'); |
| [727](#L727) | } |
| [728](#L728) | } |
| [729](#L729) | } |
| [730](#L730) | } |
| [731](#L731) | // Preferences (field names are nl[] and values the list number so special forms with radio button can work) |
| [732](#L732) | // Permetto l'aggiunta solo delle liste pubbliche |
| [733](#L733) | if (isset($\_REQUEST['nl']) && is\_array($\_REQUEST['nl'])) { |
| [734](#L734) | $lists = $this->get\_lists\_public(); |
| [735](#L735) | //$this->logger->debug($\_REQUEST['nl']); |
| [736](#L736) | foreach ($lists as $list) { |
| [737](#L737) | if (in\_array('' . $list->id, $\_REQUEST['nl'])) { |
| [738](#L738) | $user['list\_' . $list->id] = 1; |
| [739](#L739) | } |
| [740](#L740) | } |
| [741](#L741) | } else { |
| [742](#L742) | $this->logger->debug('No lists received'); |
| [743](#L743) | } |
| [744](#L744) |  |
| [745](#L745) | // Forced lists (general or by language) |
| [746](#L746) | // Forzo l'aggiunta delle liste forzate |
| [747](#L747) | $lists = $this->get\_lists(); |
| [748](#L748) | foreach ($lists as $list) { |
| [749](#L749) | if ($list->forced) { |
| [750](#L750) | $user['list\_' . $list->id] = 1; |
| [751](#L751) | } |
| [752](#L752) | if (in\_array($language, $list->languages)) { |
| [753](#L753) | $user['list\_' . $list->id] = 1; |
| [754](#L754) | } |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | // TODO: should be removed!!! |
| [758](#L758) | if (defined('NEWSLETTER\_FEED\_VERSION')) { |
| [759](#L759) | $options\_feed = get\_option('newsletter\_feed', array()); |
| [760](#L760) | if ($options\_feed['add\_new'] == 1) { |
| [761](#L761) | $user['feed'] = 1; |
| [762](#L762) | } |
| [763](#L763) | } |
| [764](#L764) | return $user; |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | /\*\* |
| [768](#L768) | \* Sends a service message applying the template to the HTML part |
| [769](#L769) | \* |
| [770](#L770) | \* @param TNP\_User $user |
| [771](#L771) | \* @param string $subject |
| [772](#L772) | \* @param string|array $message If string it is considered HTML, if array it should contains the key "html" and "text" |
| [773](#L773) | \* @return type |
| [774](#L774) | \*/ |
| [775](#L775) | function mail($user, $subject, $message) { |
| [776](#L776) | $this->switch\_language($user->language); |
| [777](#L777) |  |
| [778](#L778) | $options\_template = $this->get\_options('template'); |
| [779](#L779) |  |
| [780](#L780) | $template = trim($options\_template['template']); |
| [781](#L781) | if (empty($template) || strpos($template, '{message}') === false) { |
| [782](#L782) | $template = '{message}'; |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | if (is\_array($message)) { |
| [786](#L786) | $message['html'] = str\_replace('{message}', $message['html'], $template); |
| [787](#L787) | $message['html'] = $this->replace($message['html'], $user); |
| [788](#L788) | $message['text'] = $this->replace($message['text'], $user); |
| [789](#L789) | } else { |
| [790](#L790) | $message = str\_replace('{message}', $message, $template); |
| [791](#L791) | $message = $this->replace($message, $user); |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) | $headers = []; |
| [795](#L795) |  |
| [796](#L796) | // Replaces tags from the template |
| [797](#L797) |  |
| [798](#L798) | $subject = $this->replace($subject, $user); |
| [799](#L799) |  |
| [800](#L800) | return Newsletter::instance()->mail($user->email, $subject, $message, $headers); |
| [801](#L801) | } |
| [802](#L802) |  |
| [803](#L803) | /\*\* |
| [804](#L804) | \* Confirms a subscription changing the user status and, possibly, merging the |
| [805](#L805) | \* temporary data if present. |
| [806](#L806) | \* |
| [807](#L807) | \* @param TNP\_User $user Optionally it can be null (user search from requests paramaters, but deprecated, or a user id) |
| [808](#L808) | \* @return TNP\_User |
| [809](#L809) | \*/ |
| [810](#L810) | function confirm($user = null, $emails = true) { |
| [811](#L811) |  |
| [812](#L812) | // Compatibility with WP Registration Addon |
| [813](#L813) | if (!$user) { |
| [814](#L814) | $user = $this->get\_user\_from\_request(true); |
| [815](#L815) | } else if (is\_numeric($user)) { |
| [816](#L816) | $user = $this->get\_user($user); |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | if (!$user) { |
| [820](#L820) | $this->dienow('Subscriber not found', '', 404); |
| [821](#L821) | } |
| [822](#L822) | // End compatibility |
| [823](#L823) | // Should be merged? |
| [824](#L824) | $data = get\_transient('newsletter\_subscription\_' . $user->id); |
| [825](#L825) | if ($data !== false) { |
| [826](#L826) | $data->merge\_in($user); |
| [827](#L827) | //$this->merge($user, $data); |
| [828](#L828) | $user = $this->save\_user($user); |
| [829](#L829) | $user->status = TNP\_User::STATUS\_NOT\_CONFIRMED; |
| [830](#L830) | delete\_transient('newsletter\_subscription\_' . $user->id); |
| [831](#L831) | } else { |
| [832](#L832) | $new\_email = get\_transient('newsletter\_user\_' . $user->id . '\_email'); |
| [833](#L833) | if ($new\_email) { |
| [834](#L834) | $data = ['id' => $user->id, 'email' => $new\_email]; |
| [835](#L835) | $this->save\_user($data); |
| [836](#L836) | delete\_transient('newsletter\_user\_' . $user->id . '\_email'); |
| [837](#L837) | } |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) |  |
| [841](#L841) | $this->update\_user\_last\_activity($user); |
| [842](#L842) |  |
| [843](#L843) | setcookie('newsletter', $user->id . '-' . $user->token, time() + 60 \* 60 \* 24 \* 365, '/'); |
| [844](#L844) |  |
| [845](#L845) | if ($user->status == TNP\_User::STATUS\_CONFIRMED) { |
| [846](#L846) | $this->add\_user\_log($user, 'activate'); |
| [847](#L847) | do\_action('newsletter\_user\_confirmed', $user); |
| [848](#L848) | return $user; |
| [849](#L849) | } |
| [850](#L850) |  |
| [851](#L851) | $this->set\_user\_status($user, TNP\_User::STATUS\_CONFIRMED); |
| [852](#L852) |  |
| [853](#L853) | $user = $this->get\_user($user); |
| [854](#L854) |  |
| [855](#L855) | $this->add\_user\_log($user, 'activate'); |
| [856](#L856) |  |
| [857](#L857) | do\_action('newsletter\_user\_confirmed', $user); |
| [858](#L858) | $this->notify\_admin\_on\_subscription($user); |
| [859](#L859) |  |
| [860](#L860) | if ($emails) { |
| [861](#L861) | $this->send\_message('confirmed', $user); |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | return $user; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | /\*\* |
| [868](#L868) | \* Sends a message (activation, welcome, cancellation, ...) with the correct template |
| [869](#L869) | \* and checking if the message itself is disabled |
| [870](#L870) | \* |
| [871](#L871) | \* @param string $type |
| [872](#L872) | \* @param TNP\_User $user |
| [873](#L873) | \*/ |
| [874](#L874) | function send\_message($type, $user, $force = false) { |
| [875](#L875) |  |
| [876](#L876) | $this->logger->debug('Send message: ' . $type); |
| [877](#L877) |  |
| [878](#L878) | if ($type === 'confirmed') { |
| [879](#L879) |  |
| [880](#L880) | if ($res = apply\_filters('newsletter\_welcome\_email', 0, $user)) { |
| [881](#L881) | $this->logger->debug('Filter result: ' . $res); |
| [882](#L882) | if ($res === -1) { |
| [883](#L883) | $this->logger->debug('Asked to not proceed'); |
| [884](#L884) | return; |
| [885](#L885) | } |
| [886](#L886) | if (is\_numeric($res)) { |
| [887](#L887) | $email = $this->get\_email($res); |
| [888](#L888) | if ($email) { |
| [889](#L889) | $this->logger->debug('Welcome email found'); |
| [890](#L890) | Newsletter::instance()->send($email, [$user]); |
| [891](#L891) | return; |
| [892](#L892) | } else { |
| [893](#L893) | $this->logger->debug('No welcome email found'); |
| [894](#L894) | } |
| [895](#L895) | } |
| [896](#L896) | } |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | if ($type === 'confirmation') { |
| [900](#L900) | // TODO |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) |  |
| [904](#L904) | if (!$force && !empty($this->options[$type . '\_disabled'])) { |
| [905](#L905) | return true; |
| [906](#L906) | } |
| [907](#L907) |  |
| [908](#L908) | $this->switch\_language($user->language); |
| [909](#L909) |  |
| [910](#L910) | $message = []; |
| [911](#L911) | $message['html'] = do\_shortcode($this->get\_text($type . '\_message')); |
| [912](#L912) | $message['text'] = $this->get\_text\_message($type); |
| [913](#L913) | if ($user->status == TNP\_User::STATUS\_NOT\_CONFIRMED) { |
| [914](#L914) | $message['html'] = $this->add\_microdata($message['html']); |
| [915](#L915) | } |
| [916](#L916) | $subject = $this->get\_text($type . '\_subject'); |
| [917](#L917) |  |
| [918](#L918) | return $this->mail($user, $subject, $message); |
| [919](#L919) | } |
| [920](#L920) |  |
| [921](#L921) | /\*\* |
| [922](#L922) | \* @todo Move texts in the \_get\_default\_text() method |
| [923](#L923) | \*/ |
| [924](#L924) | function get\_text\_message($type) { |
| [925](#L925) | switch ($type) { |
| [926](#L926) | case 'confirmation': |
| [927](#L927) | return \_\_('To confirm your subscription follow the link below.', 'newsletter') . "\n\n{subscription\_confirm\_url}"; |
| [928](#L928) | case 'confirmed': |
| [929](#L929) | return \_\_('Your subscription has been confirmed.', 'newsletter'); |
| [930](#L930) | } |
| [931](#L931) | return ''; |
| [932](#L932) | } |
| [933](#L933) |  |
| [934](#L934) | function is\_double\_optin() { |
| [935](#L935) | return $this->get\_option('noconfirmation') == 0; |
| [936](#L936) | } |
| [937](#L937) |  |
| [938](#L938) | /\*\* |
| [939](#L939) | \* Sends the activation email without conditions. |
| [940](#L940) | \* |
| [941](#L941) | \* @param stdClass $user |
| [942](#L942) | \* @return bool |
| [943](#L943) | \*/ |
| [944](#L944) | function send\_activation\_email($user) { |
| [945](#L945) | // TODO: Add filter |
| [946](#L946) | if ($res = apply\_filters('newsletter\_activation\_email', false, $user)) { |
| [947](#L947) | if ($res === true) |
| [948](#L948) | return; |
| [949](#L949) | if (is\_int($res)) { |
| [950](#L950) | $email = $this->get\_email($res); |
| [951](#L951) | if ($email) { |
| [952](#L952) | Newsletter::instance()->send($email, [$user]); |
| [953](#L953) | } |
| [954](#L954) | } |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | return $this->send\_message('confirmation', $user, true); |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | /\*\* |
| [961](#L961) | \* Finds the right way to show the message identified by $key (welcome, unsubscription, ...) redirecting the user to the |
| [962](#L962) | \* WordPress page or loading the configured url or activating the standard page. |
| [963](#L963) | \*/ |
| [964](#L964) | function show\_message($key, $user, $alert = '', $email = null) { |
| [965](#L965) | $url = ''; |
| [966](#L966) |  |
| [967](#L967) | if (isset($\_REQUEST['ncu'])) { |
| [968](#L968) | // Custom URL from the form |
| [969](#L969) | $url = $\_REQUEST['ncu']; |
| [970](#L970) | } else { |
| [971](#L971) | // Per message custom URL from configuration (language variants could not be supported) |
| [972](#L972) | $url = $this->get\_option($key . '\_url'); |
| [973](#L973) | } |
| [974](#L974) |  |
| [975](#L975) | if ($key === 'confirmed') { |
| [976](#L976) | $url = apply\_filters('newsletter\_welcome\_url', $url, $user); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | $url = Newsletter::instance()->build\_message\_url($url, $key, $user, $email, $alert); |
| [980](#L980) | wp\_redirect($url); |
| [981](#L981) |  |
| [982](#L982) | die(); |
| [983](#L983) | } |
| [984](#L984) |  |
| [985](#L985) | function get\_message\_key\_from\_request() { |
| [986](#L986) | if (empty($\_GET['nm'])) { |
| [987](#L987) | return 'subscription'; |
| [988](#L988) | } |
| [989](#L989) | $key = $\_GET['nm']; |
| [990](#L990) | switch ($key) { |
| [991](#L991) | case 's': return 'confirmation'; |
| [992](#L992) | case 'c': return 'confirmed'; |
| [993](#L993) | case 'u': return 'unsubscription'; |
| [994](#L994) | case 'uc': return 'unsubscribed'; |
| [995](#L995) | case 'p': |
| [996](#L996) | case 'pe': |
| [997](#L997) | return 'profile'; |
| [998](#L998) | default: return $key; |
| [999](#L999) | } |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | var $privacy\_url = false; |
| [1003](#L1003) |  |
| [1004](#L1004) | /\*\* |
| [1005](#L1005) | \* Generates the privacy URL and cache it. |
| [1006](#L1006) | \* |
| [1007](#L1007) | \* @return string |
| [1008](#L1008) | \*/ |
| [1009](#L1009) | function get\_privacy\_url() { |
| [1010](#L1010) | if ($this->privacy\_url === false) { |
| [1011](#L1011) | if (!empty($this->get\_option('privacy\_use\_wp\_url', 'form')) && function\_exists('get\_privacy\_policy\_url')) { |
| [1012](#L1012) | $this->privacy\_url = get\_privacy\_policy\_url(); |
| [1013](#L1013) | } else { |
| [1014](#L1014) | $this->privacy\_url = $this->get\_option('privacy\_url', 'form'); |
| [1015](#L1015) | } |
| [1016](#L1016) | } |
| [1017](#L1017) | return $this->privacy\_url; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | function get\_form\_javascript() { |
| [1021](#L1021) |  |
| [1022](#L1022) | } |
| [1023](#L1023) |  |
| [1024](#L1024) | /\*\* |
| [1025](#L1025) | \* Manages the custom forms made with [newsletter\_form] and internal [newsletter\_field] shortcodes. |
| [1026](#L1026) | \* |
| [1027](#L1027) | \* @param array $attrs |
| [1028](#L1028) | \* @param string $content |
| [1029](#L1029) | \* @return string |
| [1030](#L1030) | \*/ |
| [1031](#L1031) | function get\_subscription\_form\_custom($attrs = [], $content = '') { |
| [1032](#L1032) | if (!is\_array($attrs)) { |
| [1033](#L1033) | $attrs = []; |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) | $attrs = array\_merge(['class' => 'tnp-subscription', 'style' => '', 'id' => ''], $attrs); |
| [1037](#L1037) |  |
| [1038](#L1038) | $action = esc\_attr($this->build\_action\_url('s')); |
| [1039](#L1039) | $class = esc\_attr($attrs['class']); |
| [1040](#L1040) | $style = esc\_attr($attrs['style']); |
| [1041](#L1041) |  |
| [1042](#L1042) | $buffer = '<form method="post" action="' . $action . '" class="' . $class . '" style="' . $style . '"'; |
| [1043](#L1043) | if (!empty($attrs['id'])) { |
| [1044](#L1044) | $buffer .= ' id="' . esc\_attr($attrs['id']) . '"'; |
| [1045](#L1045) | } |
| [1046](#L1046) | $buffer .= '>' . "\n"; |
| [1047](#L1047) |  |
| [1048](#L1048) | $buffer .= $this->get\_form\_hidden\_fields($attrs); |
| [1049](#L1049) |  |
| [1050](#L1050) | $buffer .= do\_shortcode($content); |
| [1051](#L1051) |  |
| [1052](#L1052) | if (isset($attrs['button\_label'])) { |
| [1053](#L1053) | $label = $attrs['button\_label']; |
| [1054](#L1054) | } else { |
| [1055](#L1055) | $label = $this->get\_form\_text('subscribe'); |
| [1056](#L1056) | } |
| [1057](#L1057) |  |
| [1058](#L1058) | if (!empty($label)) { |
| [1059](#L1059) | $buffer .= '<div class="tnp-field tnp-field-button">'; |
| [1060](#L1060) | $buffer .= '<input class="tnp-submit" type="submit" value="' . esc\_attr($label) . '">'; |
| [1061](#L1061) | $buffer .= '</div>'; |
| [1062](#L1062) | } |
| [1063](#L1063) |  |
| [1064](#L1064) | $buffer .= '</form>'; |
| [1065](#L1065) |  |
| [1066](#L1066) | return $buffer; |
| [1067](#L1067) | } |
| [1068](#L1068) |  |
| [1069](#L1069) | /\*\* Generates the hidden field for lists which should be implicitely set with a subscription form. |
| [1070](#L1070) | \* |
| [1071](#L1071) | \* @param string $lists Comma separated directly from the shortcode "lists" attribute |
| [1072](#L1072) | \* @param string $language ??? |
| [1073](#L1073) | \* @return string |
| [1074](#L1074) | \*/ |
| [1075](#L1075) | function get\_form\_implicit\_lists($lists, $language = '') { |
| [1076](#L1076) | $buffer = ''; |
| [1077](#L1077) |  |
| [1078](#L1078) | if (is\_array($lists)) { |
| [1079](#L1079) | $arr = $lists; |
| [1080](#L1080) | } else { |
| [1081](#L1081) | $arr = explode(',', $lists); |
| [1082](#L1082) | } |
| [1083](#L1083) |  |
| [1084](#L1084) | foreach ($arr as $a) { |
| [1085](#L1085) | $a = trim($a); |
| [1086](#L1086) | if (empty($a)) { |
| [1087](#L1087) | continue; |
| [1088](#L1088) | } |
| [1089](#L1089) |  |
| [1090](#L1090) | $list = $this->get\_list($a); |
| [1091](#L1091) | if (!$list) { |
| [1092](#L1092) | $buffer .= $this->build\_field\_admin\_notice('List "' . $a . '" added to the form is not configured, skipped.'); |
| [1093](#L1093) | continue; |
| [1094](#L1094) | } |
| [1095](#L1095) |  |
| [1096](#L1096) | if ($list->is\_private()) { |
| [1097](#L1097) | $buffer .= $this->build\_field\_admin\_notice('List ' . $a . ' is private cannot be used in a public form.'); |
| [1098](#L1098) | continue; |
| [1099](#L1099) | } |
| [1100](#L1100) |  |
| [1101](#L1101) | if ($list->forced) { |
| [1102](#L1102) | $buffer .= $this->build\_field\_admin\_notice('List ' . $a . ' is already enforced on every subscription there is no need to specify it.'); |
| [1103](#L1103) | continue; |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) | $buffer .= "<input type='hidden' name='nl[]' value='" . esc\_attr($a) . "'>\n"; |
| [1107](#L1107) | } |
| [1108](#L1108) | return $buffer; |
| [1109](#L1109) | } |
| [1110](#L1110) |  |
| [1111](#L1111) | /\*\* |
| [1112](#L1112) | \* Builds all the hidden fields of a subscription form. Implicit lists, confirmation url, |
| [1113](#L1113) | \* referrer, language, ... |
| [1114](#L1114) | \* |
| [1115](#L1115) | \* @param array $attrs Attributes of form shortcode |
| [1116](#L1116) | \* @return string HTML with the hidden fields |
| [1117](#L1117) | \*/ |
| [1118](#L1118) | function get\_form\_hidden\_fields($attrs) { |
| [1119](#L1119) | $b = ''; |
| [1120](#L1120) |  |
| [1121](#L1121) | // Compatibility |
| [1122](#L1122) | if (isset($attrs['list'])) { |
| [1123](#L1123) | $attrs['lists'] = $attrs['list']; |
| [1124](#L1124) | } |
| [1125](#L1125) | if (isset($attrs['lists'])) { |
| [1126](#L1126) | $b .= $this->get\_form\_implicit\_lists($attrs['lists']); |
| [1127](#L1127) | } |
| [1128](#L1128) |  |
| [1129](#L1129) | if (isset($attrs['referrer'])) { |
| [1130](#L1130) | $b .= '<input type="hidden" name="nr" value="' . esc\_attr($attrs['referrer']) . '">'; |
| [1131](#L1131) | } |
| [1132](#L1132) |  |
| [1133](#L1133) | if (isset($attrs['confirmation\_url'])) { |
| [1134](#L1134) | if ($attrs['confirmation\_url'] === '#') { |
| [1135](#L1135) | $attrs['confirmation\_url'] = esc\_url\_raw($\_SERVER['REQUEST\_URI']); |
| [1136](#L1136) | } |
| [1137](#L1137) |  |
| [1138](#L1138) | $b .= '<input type="hidden" name="ncu" value="' . esc\_attr($attrs['confirmation\_url']) . '">'; |
| [1139](#L1139) | } |
| [1140](#L1140) |  |
| [1141](#L1141) | if (isset($attrs['optin'])) { |
| [1142](#L1142) | $optin = trim(strtolower($attrs['optin'])); |
| [1143](#L1143) | if ($optin !== 'double' && $optin !== 'single') { |
| [1144](#L1144) | $b .= $this->build\_field\_admin\_notice('The optin is set to an invalid value.'); |
| [1145](#L1145) | } else { |
| [1146](#L1146) | if ($optin !== 'double' && $this->is\_double\_optin() && empty($this->get\_option('optin\_override'))) { |
| [1147](#L1147) | $b .= $this->build\_field\_admin\_notice('The optin is specified but cannot be overridden (see the subscription configiraton page).'); |
| [1148](#L1148) | } else { |
| [1149](#L1149) | $b .= '<input type="hidden" name="optin" value="' . esc\_attr($optin) . '">'; |
| [1150](#L1150) | } |
| [1151](#L1151) | } |
| [1152](#L1152) | } |
| [1153](#L1153) |  |
| [1154](#L1154) | $b .= '<input type="hidden" name="nlang" value="' . esc\_attr($this->language()) . '">'; |
| [1155](#L1155) |  |
| [1156](#L1156) | return $b; |
| [1157](#L1157) | } |
| [1158](#L1158) |  |
| [1159](#L1159) | /\*\* |
| [1160](#L1160) | \* Internal use only |
| [1161](#L1161) | \* |
| [1162](#L1162) | \* @param type $name |
| [1163](#L1163) | \* @param type $attrs |
| [1164](#L1164) | \* @return string |
| [1165](#L1165) | \*/ |
| [1166](#L1166) | private function \_shortcode\_label($name, $attrs) { |
| [1167](#L1167) |  |
| [1168](#L1168) | // When set but empty: no label |
| [1169](#L1169) | if (isset($attrs['label']) && empty($attrs['label'])) { |
| [1170](#L1170) | return; |
| [1171](#L1171) | } |
| [1172](#L1172) |  |
| [1173](#L1173) | $buffer = '<label for="' . esc\_attr($attrs['id']) . '">'; |
| [1174](#L1174) | if (isset($attrs['label'])) { |
| [1175](#L1175) | $buffer .= esc\_html($attrs['label']); |
| [1176](#L1176) | } else { |
| [1177](#L1177) | if ($name !== 'lists') { |
| [1178](#L1178) | $buffer .= esc\_html($this->get\_form\_text($name)); |
| [1179](#L1179) | } |
| [1180](#L1180) | } |
| [1181](#L1181) | $buffer .= "</label>\n"; |
| [1182](#L1182) | return $buffer; |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) | /\*\* |
| [1186](#L1186) | \* Creates a notices to be displayed near a subscription form field to inform of worng configurations. |
| [1187](#L1187) | \* It is created only if the current user looking at the form is the administrator. |
| [1188](#L1188) | \* |
| [1189](#L1189) | \* @param string $message |
| [1190](#L1190) | \* @return string |
| [1191](#L1191) | \*/ |
| [1192](#L1192) | function build\_field\_admin\_notice($message) { |
| [1193](#L1193) | if (!current\_user\_can('administrator')) { |
| [1194](#L1194) | return ''; |
| [1195](#L1195) | } |
| [1196](#L1196) | return '<p style="background-color: #eee; color: #000; padding: 10px; margin: 10px 0">' . $message . ' <strong>This notice is shown only to administrators to help with configuration.</strong></p>'; |
| [1197](#L1197) | } |
| [1198](#L1198) |  |
| [1199](#L1199) | function shortcode\_newsletter\_field($attrs, $content = '') { |
| [1200](#L1200) | // Counter to create unique ID for checkbox and labels |
| [1201](#L1201) | static $idx = 0; |
| [1202](#L1202) |  |
| [1203](#L1203) | $idx++; |
| [1204](#L1204) | $attrs['id'] = 'tnp-' . $idx; |
| [1205](#L1205) |  |
| [1206](#L1206) | $name = $attrs['name']; |
| [1207](#L1207) |  |
| [1208](#L1208) | $buffer = ''; |
| [1209](#L1209) |  |
| [1210](#L1210) | if ($name == 'email') { |
| [1211](#L1211) | $buffer .= '<div class="tnp-field tnp-field-email">'; |
| [1212](#L1212) |  |
| [1213](#L1213) | $buffer .= $this->\_shortcode\_label('email', $attrs); |
| [1214](#L1214) |  |
| [1215](#L1215) | $buffer .= '<input class="tnp-email" type="email" name="ne" id="' . esc\_attr($attrs['id']) . '" value=""'; |
| [1216](#L1216) | if (isset($attrs['placeholder'])) { |
| [1217](#L1217) | $buffer .= ' placeholder="' . esc\_attr($attrs['placeholder']) . '"'; |
| [1218](#L1218) | } |
| [1219](#L1219) | $buffer .= ' required>'; |
| [1220](#L1220) | if (isset($attrs['button\_label'])) { |
| [1221](#L1221) | $label = $attrs['button\_label']; |
| [1222](#L1222) | $buffer .= ' <input class="tnp-submit" type="submit" value="' . esc\_attr($label) . '" style="width: 29%">'; |
| [1223](#L1223) | } |
| [1224](#L1224) | $buffer .= "</div>\n"; |
| [1225](#L1225) | return $buffer; |
| [1226](#L1226) | } |
| [1227](#L1227) |  |
| [1228](#L1228) | if ($name == 'first\_name' || $name == 'name') { |
| [1229](#L1229) | $buffer .= '<div class="tnp-field tnp-field-firstname">'; |
| [1230](#L1230) | $buffer .= $this->\_shortcode\_label('name', $attrs); |
| [1231](#L1231) |  |
| [1232](#L1232) | $buffer .= '<input class="tnp-name" type="text" name="nn" id="' . esc\_attr($attrs['id']) . '" value=""'; |
| [1233](#L1233) | if (isset($attrs['placeholder'])) { |
| [1234](#L1234) | $buffer .= ' placeholder="' . esc\_attr($attrs['placeholder']) . '"'; |
| [1235](#L1235) | } |
| [1236](#L1236) | if ($this->get\_form\_option('name\_rules') == 1) { |
| [1237](#L1237) | $buffer .= ' required'; |
| [1238](#L1238) | } |
| [1239](#L1239) | $buffer .= '>'; |
| [1240](#L1240) | $buffer .= "</div>\n"; |
| [1241](#L1241) | return $buffer; |
| [1242](#L1242) | } |
| [1243](#L1243) |  |
| [1244](#L1244) | if ($name == 'last\_name' || $name == 'surname') { |
| [1245](#L1245) | $buffer .= '<div class="tnp-field tnp-field-surname">'; |
| [1246](#L1246) | $buffer .= $this->\_shortcode\_label('surname', $attrs); |
| [1247](#L1247) |  |
| [1248](#L1248) | $buffer .= '<input class="tnp-surname" type="text" name="ns" id="' . esc\_attr($attrs['id']) . '" value=""'; |
| [1249](#L1249) | if (isset($attrs['placeholder'])) { |
| [1250](#L1250) | $buffer .= ' placeholder="' . esc\_attr($attrs['placeholder']) . '"'; |
| [1251](#L1251) | } |
| [1252](#L1252) | if ($this->get\_form\_option('surname\_rules') == 1) { |
| [1253](#L1253) | $buffer .= ' required'; |
| [1254](#L1254) | } |
| [1255](#L1255) | $buffer .= '>'; |
| [1256](#L1256) | $buffer .= '</div>'; |
| [1257](#L1257) | return $buffer; |
| [1258](#L1258) | } |
| [1259](#L1259) |  |
| [1260](#L1260) | // Single list |
| [1261](#L1261) | if ($name == 'preference' || $name == 'list') { |
| [1262](#L1262) | if (!isset($attrs['number'])) { |
| [1263](#L1263) | return $this->build\_field\_admin\_notice('List number not specified.'); |
| [1264](#L1264) | } |
| [1265](#L1265) | $number = (int) $attrs['number']; |
| [1266](#L1266) | $list = $this->get\_list($number); |
| [1267](#L1267) | if (!$list) { |
| [1268](#L1268) | return $this->build\_field\_admin\_notice('List ' . $number . ' is not configured, cannot be shown.'); |
| [1269](#L1269) | } |
| [1270](#L1270) |  |
| [1271](#L1271) | if ($list->status == 0 || $list->forced) { |
| [1272](#L1272) | return $this->build\_field\_admin\_notice('List ' . $number . ' is private or enforced cannot be shown.'); |
| [1273](#L1273) | } |
| [1274](#L1274) |  |
| [1275](#L1275) | if (isset($attrs['hidden'])) { |
| [1276](#L1276) | return '<input type="hidden" name="nl[]" value="' . esc\_attr($list->id) . '">'; |
| [1277](#L1277) | } |
| [1278](#L1278) |  |
| [1279](#L1279) | $idx++; |
| [1280](#L1280) | $buffer .= '<div class="tnp-field tnp-field-checkbox tnp-field-list"><label for="tnp-' . $idx . '">'; |
| [1281](#L1281) | $buffer .= '<input type="checkbox" id="tnp-' . $idx . '" name="nl[]" value="' . esc\_attr($list->id) . '"'; |
| [1282](#L1282) | if (isset($attrs['checked'])) { |
| [1283](#L1283) | $buffer .= ' checked'; |
| [1284](#L1284) | } |
| [1285](#L1285) | $buffer .= '> '; |
| [1286](#L1286) | if (isset($attrs['label'])) { |
| [1287](#L1287) | if ($attrs['label'] != '') { |
| [1288](#L1288) | $buffer .= esc\_html($attrs['label']) . '</label>'; |
| [1289](#L1289) | } |
| [1290](#L1290) | } else { |
| [1291](#L1291) | $buffer .= esc\_html($list->name) . '</label>'; |
| [1292](#L1292) | } |
| [1293](#L1293) | $buffer .= "</div>\n"; |
| [1294](#L1294) |  |
| [1295](#L1295) | return $buffer; |
| [1296](#L1296) | } |
| [1297](#L1297) |  |
| [1298](#L1298) | // All lists |
| [1299](#L1299) | if ($name == 'lists' || $name == 'preferences') { |
| [1300](#L1300) | $list\_ids = $this->get\_form\_option('lists'); |
| [1301](#L1301) | if (!empty($list\_ids)) { |
| [1302](#L1302) |  |
| [1303](#L1303) | $checked\_ids = $this->get\_form\_option('lists\_checked'); |
| [1304](#L1304) |  |
| [1305](#L1305) | if (isset($attrs['layout']) && $attrs['layout'] === 'dropdown') { |
| [1306](#L1306) |  |
| [1307](#L1307) | $buffer .= '<div class="tnp-field tnp-lists">'; |
| [1308](#L1308) | // There is not a default "label" for the block of lists, so it can only be specified in the shortcode attrs as "label" |
| [1309](#L1309) | $buffer .= $this->\_shortcode\_label('lists', $attrs); |
| [1310](#L1310) | $buffer .= '<select class="tnp-lists" name="nl[]" required>'; |
| [1311](#L1311) |  |
| [1312](#L1312) | if (!empty($attrs['first\_option\_label'])) { |
| [1313](#L1313) | $buffer .= '<option value="" selected="true" disabled="disabled">' . esc\_html($attrs['first\_option\_label']) . '</option>'; |
| [1314](#L1314) | } |
| [1315](#L1315) |  |
| [1316](#L1316) | foreach ($list\_ids as $list\_id) { |
| [1317](#L1317) | $list = $this->get\_list($list\_id); |
| [1318](#L1318) | $buffer .= '<option value="' . esc\_attr($list->id) . '">' . esc\_html($list->name) . '</option>'; |
| [1319](#L1319) | } |
| [1320](#L1320) | $buffer .= '</select>'; |
| [1321](#L1321) | $buffer .= '</div>'; |
| [1322](#L1322) | } else { |
| [1323](#L1323) |  |
| [1324](#L1324) | $buffer .= '<div class="tnp-field tnp-lists">'; |
| [1325](#L1325) | //                    if (!empty($attrs['label'])) { |
| [1326](#L1326) | //                        $buffer .= '<p>' . $attrs['label'] . '</p>'; |
| [1327](#L1327) | //                    } |
| [1328](#L1328) | foreach ($list\_ids as $list\_id) { |
| [1329](#L1329) | $list = $this->get\_list($list\_id); |
| [1330](#L1330) | $idx++; |
| [1331](#L1331) | $buffer .= '<div class="tnp-field tnp-field-checkbox tnp-field-list"><label for="nl' . $idx . '">'; |
| [1332](#L1332) | $buffer .= '<input type="checkbox" id="nl' . $idx . '" name="nl[]" value="' . esc\_attr($list->id) . '"'; |
| [1333](#L1333) | if (in\_array($list\_id, $checked\_ids)) { |
| [1334](#L1334) | $buffer .= ' checked'; |
| [1335](#L1335) | } |
| [1336](#L1336) | $buffer .= '> ' . esc\_html($list->name) . '</label>'; |
| [1337](#L1337) | $buffer .= "</div>\n"; |
| [1338](#L1338) | } |
| [1339](#L1339) | $buffer .= '</div>'; |
| [1340](#L1340) | } |
| [1341](#L1341) | } |
| [1342](#L1342) | return $buffer; |
| [1343](#L1343) | } |
| [1344](#L1344) |  |
| [1345](#L1345) | if ($name === 'sex' || $name === 'gender') { |
| [1346](#L1346) | $buffer .= '<div class="tnp-field tnp-field-gender">'; |
| [1347](#L1347) | $buffer .= $this->\_shortcode\_label('sex', $attrs); |
| [1348](#L1348) |  |
| [1349](#L1349) | $buffer .= '<select name="nx" class="tnp-gender" id="tnp-gender"'; |
| [1350](#L1350) | if ($this->get\_form\_option('sex\_rules')) { |
| [1351](#L1351) | $buffer .= ' required '; |
| [1352](#L1352) | } |
| [1353](#L1353) | $buffer .= '>'; |
| [1354](#L1354) | if ($this->get\_form\_option('sex\_rules')) { |
| [1355](#L1355) | $buffer .= '<option value=""></option>'; |
| [1356](#L1356) | } |
| [1357](#L1357) | $buffer .= '<option value="n">' . esc\_html($this->get\_form\_text('sex\_none')) . '</option>'; |
| [1358](#L1358) | $buffer .= '<option value="f">' . esc\_html($this->get\_form\_text('sex\_female')) . '</option>'; |
| [1359](#L1359) | $buffer .= '<option value="m">' . esc\_html($this->get\_form\_text('sex\_male')) . '</option>'; |
| [1360](#L1360) | $buffer .= '</select>'; |
| [1361](#L1361) | $buffer .= "</div>\n"; |
| [1362](#L1362) | return $buffer; |
| [1363](#L1363) | } |
| [1364](#L1364) |  |
| [1365](#L1365) | if ($name === 'profile' || $name === 'customfield') { |
| [1366](#L1366) | if (!isset($attrs['number'])) { |
| [1367](#L1367) | return $this->build\_field\_admin\_notice('Extra profile number not specified.'); |
| [1368](#L1368) | } |
| [1369](#L1369) |  |
| [1370](#L1370) | $number = (int) $attrs['number']; |
| [1371](#L1371) |  |
| [1372](#L1372) | $profile = $this->get\_customfield($number); |
| [1373](#L1373) |  |
| [1374](#L1374) | if (!$profile) { |
| [1375](#L1375) | return $this->build\_field\_admin\_notice('Custom field ' . $number . ' is not configured and cannot be shown.'); |
| [1376](#L1376) | } |
| [1377](#L1377) |  |
| [1378](#L1378) | if ($profile->is\_private()) { |
| [1379](#L1379) | return $this->build\_field\_admin\_notice('Custom field ' . $number . ' is private and cannot be shown.'); |
| [1380](#L1380) | } |
| [1381](#L1381) |  |
| [1382](#L1382) | $size = isset($attrs['size']) ? $attrs['size'] : ''; |
| [1383](#L1383) | if (!isset($attrs['label'])) { |
| [1384](#L1384) | $attrs['label'] = $profile->name; |
| [1385](#L1385) | } |
| [1386](#L1386) | $buffer .= '<div class="tnp-field tnp-field-profile">'; |
| [1387](#L1387) | $buffer .= $this->\_shortcode\_label('profile\_' . $profile->id, $attrs); |
| [1388](#L1388) |  |
| [1389](#L1389) | $placeholder = isset($attrs['placeholder']) ? $attrs['placeholder'] : $profile->placeholder; |
| [1390](#L1390) |  |
| [1391](#L1391) | // Text field |
| [1392](#L1392) | if ($profile->type == TNP\_Profile::TYPE\_TEXT) { |
| [1393](#L1393) | $buffer .= '<input class="tnp-profile tnp-profile-' . $number . '" id="tnp-profile\_' . $number . '" type="text" size="' . esc\_attr($size) . '" name="np' . $number . '" placeholder="' . esc\_attr($placeholder) . '"'; |
| [1394](#L1394) | if ($profile->is\_required()) { |
| [1395](#L1395) | $buffer .= ' required'; |
| [1396](#L1396) | } |
| [1397](#L1397) | $buffer .= '>'; |
| [1398](#L1398) | } |
| [1399](#L1399) |  |
| [1400](#L1400) | // Select field |
| [1401](#L1401) | if ($profile->type == TNP\_Profile::TYPE\_SELECT) { |
| [1402](#L1402) | $buffer .= '<select class="tnp-profile tnp-profile-' . $number . '" id="tnp-profile\_' . $number . '" name="np' . $number . '"'; |
| [1403](#L1403) | if ($profile->is\_required()) { |
| [1404](#L1404) | $buffer .= ' required'; |
| [1405](#L1405) | } |
| [1406](#L1406) | $buffer .= '>'; |
| [1407](#L1407) | if (!empty($placeholder)) { |
| [1408](#L1408) | $buffer .= '<option value="" selected disabled>' . esc\_html($placeholder) . '</option>'; |
| [1409](#L1409) | } |
| [1410](#L1410) | foreach ($profile->options as $option) { |
| [1411](#L1411) | $buffer .= '<option>' . esc\_html(trim($option)) . '</option>'; |
| [1412](#L1412) | } |
| [1413](#L1413) | $buffer .= "</select>\n"; |
| [1414](#L1414) | } |
| [1415](#L1415) |  |
| [1416](#L1416) | $buffer .= "</div>\n"; |
| [1417](#L1417) |  |
| [1418](#L1418) | return $buffer; |
| [1419](#L1419) | } |
| [1420](#L1420) |  |
| [1421](#L1421) | if (strpos($name, 'privacy') === 0) { |
| [1422](#L1422) | if (!isset($attrs['url'])) { |
| [1423](#L1423) | $attrs['url'] = $this->get\_privacy\_url(); |
| [1424](#L1424) | } |
| [1425](#L1425) |  |
| [1426](#L1426) | if (!isset($attrs['label'])) { |
| [1427](#L1427) | $attrs['label'] = $this->get\_form\_text('privacy'); |
| [1428](#L1428) | } |
| [1429](#L1429) |  |
| [1430](#L1430) | $buffer .= '<div class="tnp-field tnp-field-checkbox tnp-field-privacy">'; |
| [1431](#L1431) |  |
| [1432](#L1432) | $idx++; |
| [1433](#L1433) | $buffer .= '<input type="checkbox" name="ny" required class="tnp-privacy" id="tnp-' . $idx . '"> '; |
| [1434](#L1434) | $buffer .= '<label for="tnp-' . $idx . '">'; |
| [1435](#L1435) | if (!empty($attrs['url'])) { |
| [1436](#L1436) | $buffer .= '<a target="\_blank" href="' . esc\_attr($attrs['url']) . '">'; |
| [1437](#L1437) | } |
| [1438](#L1438) | $buffer .= $attrs['label']; |
| [1439](#L1439) | if (!empty($attrs['url'])) { |
| [1440](#L1440) | $buffer .= '</a>'; |
| [1441](#L1441) | } |
| [1442](#L1442) | $buffer .= '</label>'; |
| [1443](#L1443) | $buffer .= '</div>'; |
| [1444](#L1444) |  |
| [1445](#L1445) | return $buffer; |
| [1446](#L1446) | } |
| [1447](#L1447) | } |
| [1448](#L1448) |  |
| [1449](#L1449) | /\*\* |
| [1450](#L1450) | \* Builds the privacy field only for completely generated forms. |
| [1451](#L1451) | \* |
| [1452](#L1452) | \* @return string Empty id the privacy filed is not configured |
| [1453](#L1453) | \*/ |
| [1454](#L1454) | function get\_privacy\_field($pre\_html = '', $post\_html = '') { |
| [1455](#L1455) |  |
| [1456](#L1456) | $privacy\_status = (int) $this->get\_option('privacy\_status', 'form'); |
| [1457](#L1457) | if (empty($privacy\_status)) { |
| [1458](#L1458) | return ''; |
| [1459](#L1459) | } |
| [1460](#L1460) |  |
| [1461](#L1461) | $buffer = '<label>'; |
| [1462](#L1462) | if ($privacy\_status === 1) { |
| [1463](#L1463) | $buffer .= '<input type="checkbox" name="ny" required class="tnp-privacy"> '; |
| [1464](#L1464) | } |
| [1465](#L1465) | $url = $this->get\_privacy\_url(); |
| [1466](#L1466) | if (!empty($url)) { |
| [1467](#L1467) | $buffer .= '<a target="\_blank" href="' . esc\_attr($url) . '">'; |
| [1468](#L1468) | $buffer .= esc\_html($this->get\_form\_text('privacy')) . '</a>'; |
| [1469](#L1469) | } else { |
| [1470](#L1470) | $buffer .= esc\_html($this->get\_form\_text('privacy')); |
| [1471](#L1471) | } |
| [1472](#L1472) |  |
| [1473](#L1473) | $buffer .= "</label>"; |
| [1474](#L1474) |  |
| [1475](#L1475) | return $pre\_html . $buffer . $post\_html; |
| [1476](#L1476) | } |
| [1477](#L1477) |  |
| [1478](#L1478) | /\*\* |
| [1479](#L1479) | \* The new standard form. |
| [1480](#L1480) | \* |
| [1481](#L1481) | \* @param string $referrer Deprecated since 6.9.1, use the "referrer" key on $attrs |
| [1482](#L1482) | \* @param string $action |
| [1483](#L1483) | \* @param string $attrs |
| [1484](#L1484) | \* @return string The full HTML form |
| [1485](#L1485) | \*/ |
| [1486](#L1486) | function get\_subscription\_form($referrer = '', $action = null, $attrs = []) { |
| [1487](#L1487) | $buffer = ''; |
| [1488](#L1488) |  |
| [1489](#L1489) | if (!is\_array($attrs)) { |
| [1490](#L1490) | $attrs = []; |
| [1491](#L1491) | } |
| [1492](#L1492) |  |
| [1493](#L1493) | // Possible alternative form actions (used by...?) |
| [1494](#L1494) | if (isset($attrs['action'])) { |
| [1495](#L1495) | $action = $attrs['action']; |
| [1496](#L1496) | } |
| [1497](#L1497) |  |
| [1498](#L1498) | // The referrer parameter is deprecated |
| [1499](#L1499) | if (!empty($referrer)) { |
| [1500](#L1500) | $attrs['referrer'] = $referrer; |
| [1501](#L1501) | } |
| [1502](#L1502) |  |
| [1503](#L1503) | if (empty($action)) { |
| [1504](#L1504) | $action = $this->build\_action\_url('s'); |
| [1505](#L1505) | } |
| [1506](#L1506) |  |
| [1507](#L1507) | if (isset($attrs['before'])) { |
| [1508](#L1508) | $buffer .= $attrs['before']; |
| [1509](#L1509) | } else { |
| [1510](#L1510) | if (isset($attrs['class'])) { |
| [1511](#L1511) | $buffer .= '<div class="tnp tnp-subscription ' . $attrs['class'] . '">' . "\n"; |
| [1512](#L1512) | } else { |
| [1513](#L1513) | $buffer .= '<div class="tnp tnp-subscription">' . "\n"; |
| [1514](#L1514) | } |
| [1515](#L1515) | } |
| [1516](#L1516) |  |
| [1517](#L1517) | $buffer .= '<form method="post" action="' . esc\_attr($action) . '"'; |
| [1518](#L1518) |  |
| [1519](#L1519) | if (!empty($attrs['id'])) { |
| [1520](#L1520) | $buffer .= ' id="' . esc\_attr($attrs['id']) . '"'; |
| [1521](#L1521) | } |
| [1522](#L1522) |  |
| [1523](#L1523) | $buffer .= '>' . "\n\n"; |
| [1524](#L1524) |  |
| [1525](#L1525) | $buffer .= $this->get\_form\_hidden\_fields($attrs); |
| [1526](#L1526) |  |
| [1527](#L1527) | if (!empty($this->get\_form\_option('name\_status'))) { |
| [1528](#L1528) | $buffer .= $this->shortcode\_newsletter\_field(['name' => 'first\_name']); |
| [1529](#L1529) | } |
| [1530](#L1530) |  |
| [1531](#L1531) | if ($this->get\_form\_option('surname\_status')) { |
| [1532](#L1532) | $buffer .= $this->shortcode\_newsletter\_field(['name' => 'last\_name']); |
| [1533](#L1533) | } |
| [1534](#L1534) |  |
| [1535](#L1535) | $buffer .= $this->shortcode\_newsletter\_field(['name' => 'email']); |
| [1536](#L1536) |  |
| [1537](#L1537) | if ($this->get\_form\_option('sex\_status')) { |
| [1538](#L1538) | $buffer .= $this->shortcode\_newsletter\_field(['name' => 'gender']); |
| [1539](#L1539) | } |
| [1540](#L1540) |  |
| [1541](#L1541) | // Custom fields |
| [1542](#L1542) | $ids = $this->get\_form\_option('customfields'); |
| [1543](#L1543) | if (is\_array($ids)) { |
| [1544](#L1544) | foreach ($ids as $id) { |
| [1545](#L1545) | $buffer .= $this->shortcode\_newsletter\_field(['name' => 'customfield', 'number' => $id]); |
| [1546](#L1546) | } |
| [1547](#L1547) | } |
| [1548](#L1548) |  |
| [1549](#L1549) | if (empty($attrs['lists\_field\_label'])) { |
| [1550](#L1550) | $attrs['lists\_field\_label'] = ''; |
| [1551](#L1551) | } |
| [1552](#L1552) | if (!empty($attrs['lists\_field\_layout']) && $attrs['lists\_field\_layout'] === 'dropdown') { |
| [1553](#L1553) | if (empty($attrs['lists\_field\_empty\_label'])) { |
| [1554](#L1554) | $attrs['lists\_field\_empty\_label'] = ''; |
| [1555](#L1555) | } |
| [1556](#L1556) | $buffer .= $this->shortcode\_newsletter\_field(['name' => 'lists', 'layout' => 'dropdown', 'first\_option\_label' => $attrs['lists\_field\_empty\_label'], 'label' => $attrs['lists\_field\_label']]); |
| [1557](#L1557) | } else { |
| [1558](#L1558) | $buffer .= $this->shortcode\_newsletter\_field(['name' => 'lists', 'label' => $attrs['lists\_field\_label']]); |
| [1559](#L1559) | } |
| [1560](#L1560) |  |
| [1561](#L1561) | $buffer .= $this->get\_privacy\_field('<div class="tnp-field tnp-privacy-field">', '</div>'); |
| [1562](#L1562) |  |
| [1563](#L1563) | $buffer .= '<div class="tnp-field tnp-field-button">'; |
| [1564](#L1564) |  |
| [1565](#L1565) | $button\_style = ''; |
| [1566](#L1566) | if (!empty($attrs['button\_color'])) { |
| [1567](#L1567) | $button\_style = 'style="background-color:' . esc\_attr($attrs['button\_color']) . '"'; |
| [1568](#L1568) | } |
| [1569](#L1569) |  |
| [1570](#L1570) |  |
| [1571](#L1571) | $buffer .= '<input class="tnp-submit" type="submit" value="' . esc\_attr($this->get\_form\_text('subscribe')) . '" ' . $button\_style . '>' . "\n"; |
| [1572](#L1572) |  |
| [1573](#L1573) | $buffer .= "</div>\n</form>\n"; |
| [1574](#L1574) |  |
| [1575](#L1575) | if (isset($attrs['after'])) { |
| [1576](#L1576) | $buffer .= $attrs['after']; |
| [1577](#L1577) | } else { |
| [1578](#L1578) | $buffer .= "</div>\n"; |
| [1579](#L1579) | } |
| [1580](#L1580) |  |
| [1581](#L1581) | return $buffer; |
| [1582](#L1582) | } |
| [1583](#L1583) |  |
| [1584](#L1584) | function get\_form($number) { |
| [1585](#L1585) | $options = $this->get\_options('htmlforms'); |
| [1586](#L1586) |  |
| [1587](#L1587) | $form = $options['form\_' . $number]; |
| [1588](#L1588) |  |
| [1589](#L1589) | $form = do\_shortcode($form); |
| [1590](#L1590) |  |
| [1591](#L1591) | $action = $this->build\_action\_url('s'); |
| [1592](#L1592) |  |
| [1593](#L1593) | if (stripos($form, '<form') === false) { |
| [1594](#L1594) | $form = '<form method="post" action="' . $action . '">' . $form . '</form>'; |
| [1595](#L1595) | } |
| [1596](#L1596) |  |
| [1597](#L1597) | // For compatibility |
| [1598](#L1598) | $form = str\_replace('{newsletter\_url}', $action, $form); |
| [1599](#L1599) |  |
| [1600](#L1600) | $form = $this->replace\_lists($form); |
| [1601](#L1601) |  |
| [1602](#L1602) | return $form; |
| [1603](#L1603) | } |
| [1604](#L1604) |  |
| [1605](#L1605) | /\*\* Replaces on passed text the special tag {lists} that can be used to show the preferences as a list of checkbox. |
| [1606](#L1606) | \* They are called lists but on configuration panel they are named preferences! |
| [1607](#L1607) | \* |
| [1608](#L1608) | \* @param string $buffer |
| [1609](#L1609) | \* @return string |
| [1610](#L1610) | \*/ |
| [1611](#L1611) | function replace\_lists($buffer) { |
| [1612](#L1612) | $checkboxes = ''; |
| [1613](#L1613) | $lists = $this->get\_lists\_for\_subscription(); |
| [1614](#L1614) | foreach ($lists as $list) { |
| [1615](#L1615) | $checkboxes .= '<input type="checkbox" name="nl[]" value="' . $list->id . '"> ' . $list->name . '<br />'; |
| [1616](#L1616) | } |
| [1617](#L1617) | $buffer = str\_replace('{lists}', $checkboxes, $buffer); |
| [1618](#L1618) | $buffer = str\_replace('{preferences}', $checkboxes, $buffer); |
| [1619](#L1619) | return $buffer; |
| [1620](#L1620) | } |
| [1621](#L1621) |  |
| [1622](#L1622) | function notify\_admin\_on\_subscription($user) { |
| [1623](#L1623) |  |
| [1624](#L1624) | if (empty($this->get\_option('notify'))) { |
| [1625](#L1625) | return; |
| [1626](#L1626) | } |
| [1627](#L1627) |  |
| [1628](#L1628) | $message = $this->generate\_admin\_notification\_message($user); |
| [1629](#L1629) | $email = trim($this->get\_option('notify\_email')); |
| [1630](#L1630) | $subject = $this->generate\_admin\_notification\_subject('New subscription'); |
| [1631](#L1631) |  |
| [1632](#L1632) | Newsletter::instance()->mail($email, $subject, ['html' => $message]); |
| [1633](#L1633) | } |
| [1634](#L1634) |  |
| [1635](#L1635) | /\*\* |
| [1636](#L1636) | \* Builds the minimal subscription form, with only the email field and inline |
| [1637](#L1637) | \* submit button. If enabled the privacy checkbox is added. |
| [1638](#L1638) | \* |
| [1639](#L1639) | \* @param type $attrs |
| [1640](#L1640) | \* @return string |
| [1641](#L1641) | \*/ |
| [1642](#L1642) | function get\_subscription\_form\_minimal($attrs) { |
| [1643](#L1643) | if (!is\_array($attrs)) { |
| [1644](#L1644) | $attrs = []; |
| [1645](#L1645) | } |
| [1646](#L1646) |  |
| [1647](#L1647) | $attrs = array\_merge(array('class' => '', 'referrer' => 'minimal', |
| [1648](#L1648) | 'button' => $this->get\_text('subscribe', 'form'), 'button\_color' => '', |
| [1649](#L1649) | 'button\_radius' => '', 'placeholder' => $this->get\_text('email', 'form')), $attrs); |
| [1650](#L1650) |  |
| [1651](#L1651) | $form = ''; |
| [1652](#L1652) |  |
| [1653](#L1653) | $form .= '<div class="tnp tnp-subscription-minimal ' . $attrs['class'] . '">'; |
| [1654](#L1654) | $form .= '<form action="' . esc\_attr($this->build\_action\_url('s')) . '" method="post"'; |
| [1655](#L1655) | if (!empty($attrs['id'])) { |
| [1656](#L1656) | $form .= ' id="' . esc\_attr($attrs['id']) . '"'; |
| [1657](#L1657) | } |
| [1658](#L1658) | $form .= '>'; |
| [1659](#L1659) |  |
| [1660](#L1660) | $form .= $this->get\_form\_hidden\_fields($attrs); |
| [1661](#L1661) |  |
| [1662](#L1662) | $form .= '<input class="tnp-email" type="email" required name="ne" value="" placeholder="' . esc\_attr($attrs['placeholder']) . '">'; |
| [1663](#L1663) |  |
| [1664](#L1664) | if (isset($attrs['button\_label'])) { |
| [1665](#L1665) | $label = $attrs['button\_label']; |
| [1666](#L1666) | } else if (isset($attrs['button'])) { // Backward compatibility |
| [1667](#L1667) | $label = $attrs['button']; |
| [1668](#L1668) | } else { |
| [1669](#L1669) | $label = $this->get\_text('subscribe', 'form'); |
| [1670](#L1670) | } |
| [1671](#L1671) |  |
| [1672](#L1672) | $form .= '<input class="tnp-submit" type="submit" value="' . esc\_attr($attrs['button']) . '"' |
| [1673](#L1673) | . ' style="background-color:' . esc\_attr($attrs['button\_color']) . '">'; |
| [1674](#L1674) |  |
| [1675](#L1675) | $form .= $this->get\_privacy\_field('<div class="tnp-field tnp-privacy-field">', '</div>'); |
| [1676](#L1676) |  |
| [1677](#L1677) | $form .= "</form></div>\n"; |
| [1678](#L1678) |  |
| [1679](#L1679) | return $form; |
| [1680](#L1680) | } |
| [1681](#L1681) |  |
| [1682](#L1682) | function shortcode\_newsletter\_form($attrs, $content) { |
| [1683](#L1683) |  |
| [1684](#L1684) | if (isset($attrs['type']) && $attrs['type'] === 'minimal') { |
| [1685](#L1685) | return $this->get\_subscription\_form\_minimal($attrs); |
| [1686](#L1686) | } |
| [1687](#L1687) |  |
| [1688](#L1688) | // Custom form using the [newsletter\_field] shortcodes |
| [1689](#L1689) | if (!empty($content)) { |
| [1690](#L1690) | return $this->get\_subscription\_form\_custom($attrs, $content); |
| [1691](#L1691) | } |
| [1692](#L1692) |  |
| [1693](#L1693) | // Custom form hand coded and saved in the custom forms option |
| [1694](#L1694) | if (isset($attrs['form'])) { |
| [1695](#L1695) | return $this->get\_form((int) $attrs['form']); |
| [1696](#L1696) | } |
| [1697](#L1697) |  |
| [1698](#L1698) | // Custom hand coded form (as above, new syntax) |
| [1699](#L1699) | if (isset($attrs['number'])) { |
| [1700](#L1700) | return $this->get\_form((int) $attrs['number']); |
| [1701](#L1701) | } |
| [1702](#L1702) |  |
| [1703](#L1703) | return $this->get\_subscription\_form(null, null, $attrs); |
| [1704](#L1704) | } |
| [1705](#L1705) |  |
| [1706](#L1706) | /\*\* |
| [1707](#L1707) | \* The main shortcode to be used in the reserved page. |
| [1708](#L1708) | \* |
| [1709](#L1709) | \* @global wpdb $wpdb |
| [1710](#L1710) | \* @param array $attrs |
| [1711](#L1711) | \* @param string $content |
| [1712](#L1712) | \* @return string |
| [1713](#L1713) | \*/ |
| [1714](#L1714) | function shortcode\_newsletter($attrs, $content) { |
| [1715](#L1715) | static $executing = false; |
| [1716](#L1716) |  |
| [1717](#L1717) | // To avoid loops |
| [1718](#L1718) | if ($executing) { |
| [1719](#L1719) | return ''; |
| [1720](#L1720) | } |
| [1721](#L1721) |  |
| [1722](#L1722) |  |
| [1723](#L1723) | $executing = true; |
| [1724](#L1724) |  |
| [1725](#L1725) | $message\_key = $this->get\_message\_key\_from\_request(); |
| [1726](#L1726) | if ($message\_key == 'confirmation') { |
| [1727](#L1727) | $user = $this->get\_user\_from\_request(false, 'preconfirm'); |
| [1728](#L1728) | } else { |
| [1729](#L1729) | $user = $this->get\_user\_from\_request(); |
| [1730](#L1730) | } |
| [1731](#L1731) |  |
| [1732](#L1732) | if (NEWSLETTER\_DEBUG) { |
| [1733](#L1733) | //if ($user) echo 'Subscriber: ', $user->email; |
| [1734](#L1734) | //else echo 'Subscriber: [none]'; |
| [1735](#L1735) | } |
| [1736](#L1736) |  |
| [1737](#L1737) | $message = apply\_filters('newsletter\_page\_text', '', $message\_key, $user); |
| [1738](#L1738) |  |
| [1739](#L1739) | if (empty($message)) { |
| [1740](#L1740) | $message = $this->get\_text($message\_key . '\_text'); |
| [1741](#L1741) |  |
| [1742](#L1742) | // TODO: the if can be removed |
| [1743](#L1743) | if ($message\_key === 'confirmed') { |
| [1744](#L1744) | $message .= $this->get\_option($message\_key . '\_tracking'); |
| [1745](#L1745) | } |
| [1746](#L1746) | } |
| [1747](#L1747) |  |
| [1748](#L1748) | // Now check what form must be added |
| [1749](#L1749) | if ($message\_key == 'subscription') { |
| [1750](#L1750) | // Obsolete |
| [1751](#L1751) | if (isset($attrs['show\_form']) && $attrs['show\_form'] === 'false') { |
| [1752](#L1752) | //return $this->build\_field\_admin\_notice('The [newsletter] shortcode is configured to not show the subscription form.'); |
| [1753](#L1753) | return; |
| [1754](#L1754) | } |
| [1755](#L1755) |  |
| [1756](#L1756) | // Compatibility check |
| [1757](#L1757) | if (stripos($message, '<form') !== false) { |
| [1758](#L1758) | $message = str\_ireplace('<form', '<form method="post" action="' . esc\_attr($this->get\_subscribe\_url()) . '"', $message); |
| [1759](#L1759) | } else { |
| [1760](#L1760) |  |
| [1761](#L1761) | //                if (strpos($message, '{subscription\_form') === false) { |
| [1762](#L1762) | //                    $message .= '{subscription\_form}'; |
| [1763](#L1763) | //                } |
| [1764](#L1764) | // Old way to specify a HTML coded form |
| [1765](#L1765) | if (isset($attrs['form'])) { |
| [1766](#L1766) | //$message = str\_replace('{subscription\_form}', $this->get\_form($attrs['form']), $message); |
| [1767](#L1767) | $message = str\_replace('{subscription\_form}', '[newsletter\_form form="' . esc\_attr($attrs['form']) . '"]', $message); |
| [1768](#L1768) | } else { |
| [1769](#L1769) | //$message = str\_replace('{subscription\_form}', $this->get\_subscription\_form('page', null, $attrs), $message); |
| [1770](#L1770) | $message = str\_replace('{subscription\_form}', '[newsletter\_form]', $message); |
| [1771](#L1771) | } |
| [1772](#L1772) | } |
| [1773](#L1773) | } |
| [1774](#L1774) |  |
| [1775](#L1775) | $email = $this->get\_email\_from\_request(); |
| [1776](#L1776) |  |
| [1777](#L1777) | $message = $this->replace($message, $user, $email, 'page'); |
| [1778](#L1778) |  |
| [1779](#L1779) | $message = do\_shortcode($message); |
| [1780](#L1780) |  |
| [1781](#L1781) | if (isset($\_REQUEST['alert'])) { |
| [1782](#L1782) | // slashes are already added by wordpress! |
| [1783](#L1783) | $message .= '<script>alert("' . esc\_js(strip\_tags($\_REQUEST['alert'])) . '");</script>'; |
| [1784](#L1784) | } |
| [1785](#L1785) |  |
| [1786](#L1786) | return $message; |
| [1787](#L1787) | } |
| [1788](#L1788) |  |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | NewsletterSubscription::instance(); |
| [1792](#L1792) |  |
| [1793](#L1793) | // Compatibility code |
| [1794](#L1794) |  |
| [1795](#L1795) | /\*\* |
| [1796](#L1796) | \* @deprecated |
| [1797](#L1797) | \* @param int $number |
| [1798](#L1798) | \*/ |
| [1799](#L1799) | function newsletter\_form($number = null) { |
| [1800](#L1800) | if ($number != null) { |
| [1801](#L1801) | echo NewsletterSubscription::instance()->get\_form($number); |
| [1802](#L1802) | } else { |
| [1803](#L1803) | echo NewsletterSubscription::instance()->get\_subscription\_form(); |
| [1804](#L1804) | } |
| [1805](#L1805) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/newsletter/tags/7.8.9/subscription/subscription.php?format=txt)
* [Original Format](/export/3222452/newsletter/tags/7.8.9/subscription/subscription.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


