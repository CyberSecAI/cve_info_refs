Based on the provided content, here's a breakdown of the vulnerability:

**CVE ID:** CVE-2023-4779

**Root Cause of Vulnerability:**
The vulnerability stems from insufficient input sanitization and output escaping of user-supplied attributes within the `[usp_gallery]` shortcode, specifically the `before` attribute.

**Weaknesses/Vulnerabilities Present:**
- **Stored Cross-Site Scripting (XSS):** The plugin does not properly sanitize or escape user-provided input within the `before` attribute of the `[usp_gallery]` shortcode. This allows an attacker to inject malicious JavaScript code that is stored in the database and executed when a page containing the shortcode is rendered.

**Impact of Exploitation:**
- **Arbitrary Web Script Execution:** Successful exploitation allows an attacker to inject and execute arbitrary JavaScript code in the context of a user's browser when they visit a page with the vulnerable shortcode.
- **Privilege Escalation/Account Takeover:** The injected script could potentially perform actions on behalf of the user, such as redirecting to malicious sites, stealing cookies, or performing administrative tasks if the user has necessary privileges.

**Attack Vectors:**
- **Shortcode Injection:** An attacker injects malicious JavaScript code within the 'before' attribute of the `[usp_gallery]` shortcode, embedding the malicious code within a page or post.

**Required Attacker Capabilities/Position:**
- **Authenticated Contributor+ Role:** The attacker must have at least a Contributor role within the WordPress site. This allows them to create or modify posts/pages where they can embed the malicious shortcode.

**Technical Details:**
- The vulnerability lies in the `usp_get_images()` function and how it handles the `before` and `after` attributes when called by `[usp_gallery]` shortcode.
- The function uses `str_replace` to replace curly brackets with angle brackets. This is insufficient for preventing XSS as it doesn't sanitize the content in between.
- The patch involves sanitizing the output with `sanitize_url()` when constructing the HTML output of the gallery. Also, the shortcode attributes have been changed to `format`, `target` and `class` instead of `before` and `after`

**Additional Notes**
- The provided content includes details from the plugin's Trac, highlighting the changes made to fix the vulnerability. These changes involve a refactoring of the `usp_get_images()` function and the `[usp_gallery]` shortcode, addressing the XSS issue and changing the shortcode attributes.