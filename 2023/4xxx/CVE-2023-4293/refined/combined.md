=== Content from plugins.trac.wordpress.org_7a831df5_20250114_231027.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwpdm-premium-packages%2Ftags%2F5.7.4%2Fwpdm-premium-packages.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2945543 "Revision 2945543")
* [Next Revision](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2951917 "Revision 2951917") →
* [Blame](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wpdm-premium-packages/tags/5.7.4/wpdm-premium-packages.php)

---

# [source:](/browser?order=name "Go to repository root") [wpdm-premium-packages](/browser/wpdm-premium-packages?order=name "View wpdm-premium-packages")/[tags](/browser/wpdm-premium-packages/tags?order=name "View tags")/[5.7.4](/browser/wpdm-premium-packages/tags/5.7.4?order=name "View 5.7.4")/[wpdm-premium-packages.php](/browser/wpdm-premium-packages/tags/5.7.4/wpdm-premium-packages.php?order=name "View wpdm-premium-packages.php")

View diff against:

View revision:

| [Last change](/changeset/2949237/wpdm-premium-packages/trunk/wpdm-premium-packages.php "View differences") on this file was [2949237](/changeset/2949237/ "View changeset 2949237"), checked in by codename065, [18 months ago](/timeline?from=2023-08-08T09%3A53%3A42Z&precision=second "See timeline at 08/08/2023 09:53:42 AM") |
| --- |
| 5.7.4 - 2023.08.08  * Added option to resend order confirmation email * Improved admin order details page |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 63.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Plugin Name:  Premium Packages - Sell Digital Products Securely |
| [4](#L4) | \* Plugin URI: https://www.wpdownloadmanager.com/download/premium-package-complete-digital-store-solution/ |
| [5](#L5) | \* Description: Complete solution for selling digital products securely and easily |
| [6](#L6) | \* Version: 5.7.4 |
| [7](#L7) | \* Author: WordPress Download Manager |
| [8](#L8) | \* Text Domain: wpdm-premium-packages |
| [9](#L9) | \* Author URI: https://www.wpdownloadmanager.com/ |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | namespace WPDMPP; |
| [13](#L13) |  |
| [14](#L14) | use WPDM\\_\_\\_\_; |
| [15](#L15) | use WPDM\\_\_\\_\_MailUI; |
| [16](#L16) | use WPDM\\_\_\Email; |
| [17](#L17) | use WPDM\\_\_\Messages; |
| [18](#L18) | use WPDM\\_\_\Template; |
| [19](#L19) | use WPDM\\_\_\Crypt; |
| [20](#L20) | use WPDM\\_\_\FileSystem; |
| [21](#L21) | use WPDM\\_\_\Session; |
| [22](#L22) | use WPDM\Package\FileList; |
| [23](#L23) | use WPDMPP\Libs\BillingInfo; |
| [24](#L24) | use WPDMPP\Libs\Cart; |
| [25](#L25) | use WPDMPP\Libs\CouponCodes; |
| [26](#L26) | use WPDMPP\Libs\Order; |
| [27](#L27) | use WPDMPP\Libs\Payment; |
| [28](#L28) | use WPDMPP\Libs\ShortCodes; |
| [29](#L29) | use WPDMPP\Libs\User; |
| [30](#L30) | use WPDMPP\Libs\Withdraws; |
| [31](#L31) |  |
| [32](#L32) | if ( ! defined( 'ABSPATH' ) ) { |
| [33](#L33) | exit; |
| [34](#L34) | } |
| [35](#L35) |  |
| [36](#L36) | global $wpdmpp, $wpdmpp\_settings; |
| [37](#L37) |  |
| [38](#L38) | if ( ! class\_exists( 'WPDMPremiumPackage' ) ): |
| [39](#L39) | /\*\* |
| [40](#L40) | \* @class WPDMPremiumPackage |
| [41](#L41) | \*/ |
| [42](#L42) |  |
| [43](#L43) | define( 'WPDMPP\_VERSION', '5.7.4' ); |
| [44](#L44) | define( 'WPDMPP\_BASE\_DIR', dirname( \_\_FILE\_\_ ) . '/' ); |
| [45](#L45) | define( 'WPDMPP\_BASE\_URL', plugins\_url( 'wpdm-premium-packages/' ) ); |
| [46](#L46) | define( 'WPDMPP\_TEXT\_DOMAIN', 'wpdm-premium-packages' ); |
| [47](#L47) |  |
| [48](#L48) | if ( ! defined( 'WPDMPP\_MENU\_ACCESS\_CAP' ) ) { |
| [49](#L49) | define( 'WPDMPP\_MENU\_ACCESS\_CAP', 'manage\_categories' ); |
| [50](#L50) | } |
| [51](#L51) | if ( ! defined( 'WPDMPP\_ADMIN\_CAP' ) ) { |
| [52](#L52) | define( 'WPDMPP\_ADMIN\_CAP', 'manage\_categories' ); |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | if ( ! defined( 'WPDMPP\_TPL\_FALLBACK' ) ) { |
| [56](#L56) | define( 'WPDMPP\_TPL\_FALLBACK', dirname( \_\_FILE\_\_ ) . '/templates/' ); |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | if ( ! defined( 'WPDMPP\_TPL\_DIR' ) ) { |
| [60](#L60) | define( 'WPDMPP\_TPL\_DIR', dirname( \_\_FILE\_\_ ) . '/templates/' ); |
| [61](#L61) | } |
| [62](#L62) |  |
| [63](#L63) | class WPDMPremiumPackage { |
| [64](#L64) |  |
| [65](#L65) | /\*\* |
| [66](#L66) | \* @var Cart |
| [67](#L67) | \*/ |
| [68](#L68) | public $cart; |
| [69](#L69) | /\*\* |
| [70](#L70) | \* @var Order |
| [71](#L71) | \*/ |
| [72](#L72) | public $order; |
| [73](#L73) |  |
| [74](#L74) | /\*\* |
| [75](#L75) | \* @var Withdraws |
| [76](#L76) | \*/ |
| [77](#L77) | public $withdraws; |
| [78](#L78) |  |
| [79](#L79) | /\*\* |
| [80](#L80) | \* @var Payment |
| [81](#L81) | \*/ |
| [82](#L82) | public $payment; |
| [83](#L83) |  |
| [84](#L84) | /\*\* |
| [85](#L85) | \* @var CouponCodes |
| [86](#L86) | \*/ |
| [87](#L87) | public $couponCodes; |
| [88](#L88) |  |
| [89](#L89) | /\*\* |
| [90](#L90) | \* @var ShortCodes |
| [91](#L91) | \*/ |
| [92](#L92) | public $shortCodes; |
| [93](#L93) |  |
| [94](#L94) | function \_\_construct() { |
| [95](#L95) | global $wpdmpp\_settings, $payment\_methods; |
| [96](#L96) | $wpdmpp\_settings = maybe\_unserialize( get\_option( '\_wpdmpp\_settings' ) ); |
| [97](#L97) | $payment\_methods = [ 'TestPay', 'Paypal', 'Cash', 'Cheque' ]; |
| [98](#L98) |  |
| [99](#L99) | $this->init(); |
| [100](#L100) | $this->init\_hooks(); |
| [101](#L101) |  |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | private function init() { |
| [105](#L105) | global $sap; |
| [106](#L106) |  |
| [107](#L107) | if ( function\_exists( 'get\_option' ) ) { |
| [108](#L108) | $sap = ( get\_option( 'permalink\_structure' ) != '' ) ? '?' : '&'; |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | $this->include\_files(); |
| [112](#L112) |  |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | private function init\_hooks() { |
| [116](#L116) |  |
| [117](#L117) | register\_activation\_hook( \_\_FILE\_\_, [ '\WPDMPP\Libs\Installer', 'init' ] ); |
| [118](#L118) |  |
| [119](#L119) | add\_action( 'wp', [ $this, 'download' ], 1 ); |
| [120](#L120) |  |
| [121](#L121) | add\_action( 'wp\_login', [ new Cart(), 'onUserLogin' ], 10, 2 ); |
| [122](#L122) |  |
| [123](#L123) | add\_action( 'wpdm-package-form-left', [ $this, 'wpdmpp\_meta\_box\_pricing' ] ); |
| [124](#L124) | add\_filter( 'wpdm\_package\_settings\_tabs', [ $this, 'wpdmpp\_meta\_boxes' ] ); |
| [125](#L125) | add\_filter( 'add\_wpdm\_settings\_tab', [ $this, 'settings\_tab' ] ); |
| [126](#L126) | add\_filter( 'wpdm\_privacy\_settings\_panel', [ $this, 'privacy\_settings' ] ); |
| [127](#L127) |  |
| [128](#L128) | add\_action( 'wpdm\_template\_editor\_menu', [ $this, 'template\_editor\_menu' ] ); |
| [129](#L129) | //add\_action( 'wpdm\_template\_tag\_row', array( $this, 'template\_tag\_row' )); |
| [130](#L130) |  |
| [131](#L131) | add\_action( 'init', function () { |
| [132](#L132) | $this->dbTables(); |
| [133](#L133) | $this->wpdmpp\_languages(); |
| [134](#L134) | $this->clone\_order(); |
| [135](#L135) | $this->invoice(); |
| [136](#L136) | $this->wpdmpp\_process\_guest\_order(); |
| [137](#L137) | $this->paynow(); |
| [138](#L138) | $this->payment\_notification(); |
| [139](#L139) | $this->comeplete\_buynow\_action(); |
| [140](#L140) | $this->wpdmpp\_ajax\_payfront(); |
| [141](#L141) | $this->anync\_execute(); |
| [142](#L142) | $this->wpdmpp\_update\_profile(); |
| [143](#L143) | $this->freeDownload(); |
| [144](#L144) |  |
| [145](#L145) | } ); |
| [146](#L146) |  |
| [147](#L147) | /\* |
| [148](#L148) | add\_action( 'init', array( $this, 'wpdmpp\_languages' ) ); |
| [149](#L149) | add\_action( 'init', array( $this, 'invoice' ) ); |
| [150](#L150) | add\_action( 'init', array( $this, 'wpdmpp\_process\_guest\_order' ) ); |
| [151](#L151) | //add\_action( 'init', array( $this, 'wpdmpp\_download' ), 1); |
| [152](#L152) | add\_action( 'init', array( $this, 'paynow' ) ); |
| [153](#L153) | add\_action( 'init', array( $this, 'payment\_notification' ) ); |
| [154](#L154) | add\_action( 'init', array( $this, 'wpdmpp\_ajax\_payfront' ) ); |
| [155](#L155) | add\_action( 'init', array( $this, 'anync\_execute' ) ); |
| [156](#L156) | add\_action( 'init', array( $this, 'wpdmpp\_update\_profile' ) ); |
| [157](#L157) | add\_action( 'init', array( $this, 'freeDownload' ) ); |
| [158](#L158) | \*/ |
| [159](#L159) |  |
| [160](#L160) | add\_action( 'wpdm\_login\_form', array( $this, 'wpdmpp\_invoice\_field' ) ); |
| [161](#L161) | add\_action( 'wpdm\_register\_form', array( $this, 'wpdmpp\_invoice\_field' ) ); |
| [162](#L162) | add\_action( 'wp\_login', array( $this, 'wpdmpp\_associate\_invoice' ), 10, 2 ); |
| [163](#L163) | add\_action( 'user\_register', array( $this, 'wpdmpp\_associate\_invoice\_signup' ), 10, 1 ); |
| [164](#L164) |  |
| [165](#L165) | add\_action( 'wp\_ajax\_resolveorder', array( $this, 'wpdmpp\_resolveorder' ) ); |
| [166](#L166) |  |
| [167](#L167) | add\_action( 'wp\_ajax\_set\_payment\_method\_for\_order', array( $this, 'set\_payment\_method' ) ); |
| [168](#L168) | add\_action( 'wp\_ajax\_nopriv\_set\_payment\_method\_for\_order', array( $this, 'set\_payment\_method' ) ); |
| [169](#L169) |  |
| [170](#L170) | add\_action( 'wp\_ajax\_nopriv\_gettax', array( $this, 'calculate\_tax' ) ); |
| [171](#L171) | add\_action( 'wp\_ajax\_gettax', array( $this, 'calculate\_tax' ) ); |
| [172](#L172) |  |
| [173](#L173) | add\_action( 'wp\_ajax\_wpdmpp\_cancel\_subscription', array( $this, 'cancel\_subscription' ) ); |
| [174](#L174) |  |
| [175](#L175) | add\_action( 'wp\_ajax\_product\_sales\_overview', array( $this, 'wpdmpp\_meta\_box\_sales\_overview' ) ); |
| [176](#L176) |  |
| [177](#L177) | add\_action( 'wp\_ajax\_nopriv\_payment\_options', array( $this, 'payment\_options' ) ); |
| [178](#L178) | add\_action( 'wp\_ajax\_payment\_options', array( $this, 'payment\_options' ) ); |
| [179](#L179) |  |
| [180](#L180) | add\_action( 'wp\_ajax\_wpdmpp\_update\_withdraw\_status', array( $this, 'wpdmpp\_update\_withdraw\_status' ) ); |
| [181](#L181) |  |
| [182](#L182) | add\_action( 'wp\_ajax\_wpdmpp\_expire\_orders', array( $this, 'expire\_orders' ) ); |
| [183](#L183) |  |
| [184](#L184) | add\_action( 'wp\_ajax\_wpdmpp\_email\_payment\_link', array( $this, 'email\_payment\_link' ) ); |
| [185](#L185) |  |
| [186](#L186) | add\_action( 'wp\_enqueue\_scripts', array( $this, 'wpdmpp\_enqueue\_scripts' ) ); |
| [187](#L187) |  |
| [188](#L188) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'wpdmpp\_admin\_enqueue\_scripts' ) ); |
| [189](#L189) |  |
| [190](#L190) | if ( is\_admin() ) { |
| [191](#L191) | add\_action( 'wp\_ajax\_wpdmpp\_save\_settings', array( $this, 'saveSettings' ) ); |
| [192](#L192) | add\_action( 'wp\_ajax\_wpdmpp\_toggle\_auto\_renew', array( $this, 'toggleAutoRenew' ) ); |
| [193](#L193) | add\_action( 'wp\_ajax\_wpdmpp\_toggle\_manual\_renew', array( $this, 'toggleManualRenew' ) ); |
| [194](#L194) | add\_action( 'wp\_ajax\_wpdmpp\_async\_request', array( $this, 'wpdmpp\_async\_request' ) ); |
| [195](#L195) | add\_action( 'wp\_loaded', array( $this, 'wpdmpp\_hide\_notices' ) ); |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) | if ( ! is\_admin() ) { |
| [199](#L199) | add\_action( 'wpdm\_login\_form', array( $this, 'wpdmpp\_guest\_download\_link' ) ); |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | add\_filter( 'wpdm\_meta\_box', array( $this, 'add\_meta\_boxes' ) ); |
| [203](#L203) | add\_filter( 'wpdm\_user\_dashboard\_menu', array( $this, 'wpdmpp\_user\_dashboard\_menu' ) ); |
| [204](#L204) |  |
| [205](#L205) | add\_filter( 'wpdm\_after\_prepare\_package\_data', array( $this, 'fetchTemplateTag' ) ); |
| [206](#L206) | add\_filter( 'wdm\_before\_fetch\_template', array( $this, 'fetchTemplateTag' ) ); |
| [207](#L207) | add\_filter( 'wpdm\_download\_link', array( $this, 'downloadLink' ), 10, 2 ); |
| [208](#L208) | add\_filter( 'wpdm\_check\_lock', array( $this, 'lockDownload' ), 10, 2 ); |
| [209](#L209) | add\_filter( 'wpdm\_single\_file\_download\_link', array( $this, 'hideSingleFileDownloadLink' ), 10, 3 ); |
| [210](#L210) |  |
| [211](#L211) | //add\_action( 'activated\_plugin', array( $this, 'pp\_save\_error' ) ); |
| [212](#L212) |  |
| [213](#L213) | add\_action( 'init', array( $this, 'connect\_wizard' ) ); |
| [214](#L214) |  |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | function dbTables() { |
| [218](#L218) | global $wpdb; |
| [219](#L219) | $wpdb->wpdmpp\_orders           = "{$wpdb->prefix}ahm\_orders"; |
| [220](#L220) | $wpdb->wpdmpp\_order\_items      = "{$wpdb->prefix}ahm\_order\_items"; |
| [221](#L221) | $wpdb->wpdmpp\_coupons          = "{$wpdb->prefix}ahm\_coupons"; |
| [222](#L222) | $wpdb->wpdmpp\_abandoned\_orders = "{$wpdb->prefix}ahm\_acr\_emails"; |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) |  |
| [226](#L226) | function connect\_wizard() { |
| [227](#L227) | // Setup Wizard |
| [228](#L228) | if ( ! empty( $\_GET['page'] ) ) { |
| [229](#L229) | switch ( $\_GET['page'] ) { |
| [230](#L230) | case 'wpdmpp-setup' : |
| [231](#L231) | include\_once( dirname( \_\_FILE\_\_ ) . '/includes/settings/wizard/class.SetupWizard.php' ); |
| [232](#L232) | break; |
| [233](#L233) | } |
| [234](#L234) | } |
| [235](#L235) | } |
| [236](#L236) |  |
| [237](#L237) | function wpdmpp\_run\_setup\_wizard\_notice() { |
| [238](#L238) |  |
| [239](#L239) | if ( get\_option( 'wpdmpp\_setp\_wizard\_notice' ) == 'hide' ) { |
| [240](#L240) | return; |
| [241](#L241) | } |
| [242](#L242) | ?> |
| [243](#L243) | <div class="notice notice-info is-dismissible w3eden"> |
| [244](#L244) | <p class="wpdmpp-notice"><?php \_e( 'Thank you for installing Premium Package! You are almost ready to start selling.', 'wpdm-premium-packages' ); ?> |
| [245](#L245) | <a href="<?php echo esc\_url( admin\_url( 'admin.php?page=wpdmpp-setup' ) ); ?>" |
| [246](#L246) | class="btn btn-sm  btn-info"><?php \_e( 'Run the Setup Wizard', 'wpdm-premium-packages' ); ?></a> |
| [247](#L247) | <a class="btn btn-sm btn-warning" |
| [248](#L248) | href="<?php echo esc\_url( wp\_nonce\_url( add\_query\_arg( 'wpdmpp-hide-notice', 'wizard' ), 'wpdmpp\_hide\_notices\_nonce', '\_wpdmpp\_notice\_nonce' ) ); ?>"><?php \_e( 'Skip setup', 'wpdm-premium-packages' ); ?></a> |
| [249](#L249) | </p> |
| [250](#L250) | </div> |
| [251](#L251) | <?php |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | function wpdmpp\_hide\_notices() { |
| [255](#L255) | if ( isset( $\_GET['wpdmpp-hide-notice'] ) && isset( $\_GET['\_wpdmpp\_notice\_nonce'] ) ) { |
| [256](#L256) | if ( ! wp\_verify\_nonce( $\_GET['\_wpdmpp\_notice\_nonce'], 'wpdmpp\_hide\_notices\_nonce' ) ) { |
| [257](#L257) | wp\_die( \_\_( 'Action failed. Please refresh the page and retry.', 'wpdm-premium-packages' ) ); |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [261](#L261) | wp\_die( \_\_( 'Cheatin&#8217; huh?', 'wpdm-premium-packages' ) ); |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | $hide\_notice = sanitize\_text\_field( $\_GET['wpdmpp-hide-notice'] ); |
| [265](#L265) | if ( $hide\_notice == 'wizard' ) { |
| [266](#L266) | update\_option( 'wpdmpp\_setp\_wizard\_notice', 'hide' ); |
| [267](#L267) | } |
| [268](#L268) | } |
| [269](#L269) | } |
| [270](#L270) |  |
| [271](#L271) | function pp\_save\_error() { |
| [272](#L272) | file\_put\_contents( ABSPATH . 'pp-errors.txt', ob\_get\_contents() ); |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) | function wpdmpp\_languages() { |
| [276](#L276) | load\_plugin\_textdomain( 'wpdm-premium-packages', false, dirname( plugin\_basename( \_\_FILE\_\_ ) ) . '/languages/' ); |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | function include\_files() { |
| [280](#L280) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/functions.php" ); |
| [281](#L281) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/Installer.php" ); |
| [282](#L282) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/User.php" ); |
| [283](#L283) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/LicenseManager.php" ); |
| [284](#L284) |  |
| [285](#L285) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/Product.php" ); |
| [286](#L286) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/Cart.php" ); |
| [287](#L287) | $this->cart = new Cart(); |
| [288](#L288) |  |
| [289](#L289) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/Order.php" ); |
| [290](#L290) | $this->order = new Order(); |
| [291](#L291) |  |
| [292](#L292) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/Payment.php" ); |
| [293](#L293) | $this->payment = new Payment(); |
| [294](#L294) |  |
| [295](#L295) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/CustomActions.php" ); |
| [296](#L296) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/CustomColumns.php" ); |
| [297](#L297) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/Currencies.php" ); |
| [298](#L298) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/BillingInfo.php" ); |
| [299](#L299) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/DashboardWidgets.php" ); |
| [300](#L300) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/OrderNoteTemplates.php" ); |
| [301](#L301) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/Withdraws.php" ); |
| [302](#L302) | $this->withdraws = new Withdraws(); |
| [303](#L303) |  |
| [304](#L304) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/CouponCodes.php" ); |
| [305](#L305) | $this->couponCodes = new CouponCodes(); |
| [306](#L306) |  |
| [307](#L307) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/ShortCodes.php" ); |
| [308](#L308) | $this->shortCodes = new ShortCodes(); |
| [309](#L309) |  |
| [310](#L310) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/CronJobs.php" ); |
| [311](#L311) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/AbandonedOrderRecovery.php" ); |
| [312](#L312) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/cart-functions.php" ); |
| [313](#L313) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/hooks.php" ); |
| [314](#L314) |  |
| [315](#L315) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/menus/AdminMenus.php" ); |
| [316](#L316) |  |
| [317](#L317) | // Cart Widget |
| [318](#L318) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/widgets/widget-cart.php" ); |
| [319](#L319) |  |
| [320](#L320) | // Integrated payment mothods |
| [321](#L321) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/payment-methods/Cash/Cash.php" ); |
| [322](#L322) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/payment-methods/Cheque/Cheque.php" ); |
| [323](#L323) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/payment-methods/Paypal/Paypal.php" ); |
| [324](#L324) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/payment-methods/TestPay/TestPay.php" ); |
| [325](#L325) | include\_once( dirname( \_\_FILE\_\_ ) . "/includes/libs/SellerDashboard.php" ); |
| [326](#L326) |  |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | function calculate\_tax() { |
| [330](#L330) |  |
| [331](#L331) | $cartsubtotal = WPDMPP()->cart->cartTotal(); |
| [332](#L332) | $cartdiscount = WPDMPP()->cart->couponDiscount(); |
| [333](#L333) | $cartsubtotal -= $cartdiscount; |
| [334](#L334) |  |
| [335](#L335) | //$tax\_total = wpdmpp\_calculate\_tax2(); |
| [336](#L336) |  |
| [337](#L337) | $tax\_total = WPDMPP()->cart->calculateTax( $cartsubtotal, wpdm\_query\_var( 'country', 'txt' ), wpdm\_query\_var( 'state', 'txt' ) ); |
| [338](#L338) |  |
| [339](#L339) | $total\_including\_tax = $cartsubtotal + $tax\_total; |
| [340](#L340) |  |
| [341](#L341) | if ( Session::get( 'orderid' ) ) { |
| [342](#L342) | WPDMPP()->order->reCalculate( Session::get( 'orderid' ) ); |
| [343](#L343) | $customPayButton = ""; |
| [344](#L344) | if ( wpdm\_query\_var( 'payment\_method', 'txt' ) ) { |
| [345](#L345) | $payment = new Payment(); |
| [346](#L346) | $payment->initiateProcessor( wpdm\_query\_var( 'payment\_method', 'txt' ) ); |
| [347](#L347) | if ( method\_exists( $payment->Processor, 'customPayButton' ) ) { |
| [348](#L348) | $customPayButton = $payment->Processor->customPayButton(); |
| [349](#L349) | } |
| [350](#L350) | } |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | $updates = [ |
| [354](#L354) | 'tax'            => wpdmpp\_price\_format( $tax\_total ), |
| [355](#L355) | 'total'          => wpdmpp\_price\_format( $total\_including\_tax ), |
| [356](#L356) | 'subtotal'       => $cartsubtotal, |
| [357](#L357) | 'dis'            => $cartdiscount, |
| [358](#L358) | 'order'          => Session::get( 'orderid' ), |
| [359](#L359) | 'payment\_button' => $customPayButton |
| [360](#L360) | ]; |
| [361](#L361) |  |
| [362](#L362) | wp\_send\_json( $updates ); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) |  |
| [366](#L366) | /\*\* |
| [367](#L367) | \* Metabox content for Pricing and other Premium Pckage Settings |
| [368](#L368) | \*/ |
| [369](#L369) |  |
| [370](#L370) | function wpdmpp\_meta\_box\_sales\_overview\_loader() { |
| [371](#L371) | ?> |
| [372](#L372) | <div id="wpdmpp-sales-overview"> |
| [373](#L373) | <div style="padding: 50px 10px;text-align: center"><i |
| [374](#L374) | class="fas fa-sync fa-spin"></i> <?php \_e( 'Loading....', 'wpdm-premium-packages' ); ?></div> |
| [375](#L375) | </div> |
| [376](#L376) | <script> |
| [377](#L377) | jQuery(function ($) { |
| [378](#L378) | $('#wpdmpp-sales-overview').load(ajaxurl, { |
| [379](#L379) | action: 'product\_sales\_overview', |
| [380](#L380) | post: <?php echo wpdm\_query\_var( 'post' ); ?>}); |
| [381](#L381) | }); |
| [382](#L382) | </script> |
| [383](#L383) | <?php |
| [384](#L384) | } |
| [385](#L385) |  |
| [386](#L386) | function wpdmpp\_meta\_box\_sales\_overview() { |
| [387](#L387) | global $post; |
| [388](#L388) | $data = Session::get( 'sales\_overview\_html\_' . wpdm\_query\_var( 'post' ) ); |
| [389](#L389) | if ( $data ) { |
| [390](#L390) | echo $data; |
| [391](#L391) | die(); |
| [392](#L392) | } |
| [393](#L393) | ob\_start(); |
| [394](#L394) | include \_\_DIR\_\_ . '/includes/menus/templates/product-sales-overview.php'; |
| [395](#L395) | $data = ob\_get\_clean(); |
| [396](#L396) | Session::set( 'sales\_overview\_html\_' . wpdm\_query\_var( 'post' ), $data ); |
| [397](#L397) | echo $data; |
| [398](#L398) | die(); |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) |  |
| [402](#L402) | function payment\_options() { |
| [403](#L403) | global $post; |
| [404](#L404) | include \WPDM\\_\_\Template::locate( 'checkout-cart/checkout.php', dirname( \_\_FILE\_\_ ) . '/templates' ); |
| [405](#L405) | die(); |
| [406](#L406) | } |
| [407](#L407) |  |
| [408](#L408) | function add\_meta\_boxes( $metaboxes ) { |
| [409](#L409) | $pid   = wpdm\_query\_var( 'post' ); |
| [410](#L410) | $price = wpdmpp\_effective\_price( $pid ); |
| [411](#L411) | if ( $price > 0 ) { |
| [412](#L412) | $wpdmpp\_metaboxes['sales-overview'] = array( |
| [413](#L413) | 'title'    => \_\_( 'Sales Overview', "wpdm-premium-packages" ), |
| [414](#L414) | 'callback' => array( |
| [415](#L415) | $this, |
| [416](#L416) | 'wpdmpp\_meta\_box\_sales\_overview\_loader' |
| [417](#L417) | ), |
| [418](#L418) | 'position' => 'side', |
| [419](#L419) | 'priority' => 'core' |
| [420](#L420) | ); |
| [421](#L421) | $metaboxes                          = $wpdmpp\_metaboxes + $metaboxes; |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | return $metaboxes; |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | /\*\* |
| [428](#L428) | \* Metabox content for Pricing and other Premium Pckage Settings |
| [429](#L429) | \*/ |
| [430](#L430) | function wpdmpp\_meta\_box\_pricing() { |
| [431](#L431) | global $post; |
| [432](#L432) | include Template::locate( 'metaboxes/wpdm-pp-settings.php', WPDMPP\_TPL\_DIR ); |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | /\*\* |
| [436](#L436) | \* @param $tabs |
| [437](#L437) | \* |
| [438](#L438) | \* @return mixed |
| [439](#L439) | \* @usage Adding Premium Package Settings Metabox by applying WPDM's 'wpdm\_package\_settings\_tabs' filter |
| [440](#L440) | \*/ |
| [441](#L441) | function wpdmpp\_meta\_boxes( $tabs ) { |
| [442](#L442) | if ( is\_admin() ) { |
| [443](#L443) | $tabs['pricing'] = array( |
| [444](#L444) | 'name'     => \_\_( 'Pricing & Discounts', "wpdm-premium-packages" ), |
| [445](#L445) | 'callback' => array( $this, 'wpdmpp\_meta\_box\_pricing' ) |
| [446](#L446) | ); |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | return $tabs; |
| [450](#L450) | } |
| [451](#L451) |  |
| [452](#L452) |  |
| [453](#L453) | /\*\* |
| [454](#L454) | \*  Premium Package Settings Page |
| [455](#L455) | \*/ |
| [456](#L456) | function settings() { |
| [457](#L457) | include( "includes/settings/settings.php" ); |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | function settings\_tab( $tabs ) { |
| [461](#L461) | $tabs['ppsettings'] = wpdm\_create\_settings\_tab( 'ppsettings', 'Premium Package', array( |
| [462](#L462) | $this, |
| [463](#L463) | 'settings' |
| [464](#L464) | ), $icon = 'fa-solid fa-basket-shopping' ); |
| [465](#L465) |  |
| [466](#L466) | return $tabs; |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Generate Order Invoice op request |
| [471](#L471) | \*/ |
| [472](#L472) | function invoice() { |
| [473](#L473) | if ( isset( $\_GET['id'] ) && $\_GET['id'] != '' && isset( $\_GET['wpdminvoice'] ) ) { |
| [474](#L474) | ob\_start(); |
| [475](#L475) | wp\_register\_style( 'wpdm-front-bootstrap', WPDM\_BASE\_URL . 'assets/bootstrap/css/bootstrap.css' ); |
| [476](#L476) | wp\_register\_style( 'font-awesome', WPDM\_BASE\_URL . 'assets/font-awesome/css/font-awesome.min.css' ); |
| [477](#L477) | wp\_register\_style( 'wpdm-front', WPDM\_BASE\_URL . 'assets/css/front.css' ); |
| [478](#L478) | wp\_register\_style( 'wpdmpp-invoice', WPDMPP\_BASE\_URL . 'assets/css/invoice.css', array( |
| [479](#L479) | 'wpdm-front-bootstrap', |
| [480](#L480) | 'font-awesome', |
| [481](#L481) | 'wpdm-front' |
| [482](#L482) | ) ); |
| [483](#L483) | //include \WPDM\\_\_\Template::locate("wpdm-pp-invoice.php", WPDMPP\_TPL\_DIR); |
| [484](#L484) | include \WPDM\\_\_\Template::locate( "invoices/default/invoice.php", WPDMPP\_TPL\_DIR ); |
| [485](#L485) | $data = ob\_get\_clean(); |
| [486](#L486) |  |
| [487](#L487) | $oid = sanitize\_file\_name( $\_GET['id'] ); |
| [488](#L488) | echo $data; |
| [489](#L489) | die(); |
| [490](#L490) | } |
| [491](#L491) | } |
| [492](#L492) |  |
| [493](#L493) |  |
| [494](#L494) | function wpdmpp\_user\_dashboard\_menu( $menu ) { |
| [495](#L495) | $menu = array\_merge( array\_splice( $menu, 0, 1 ), array( |
| [496](#L496) | 'purchases' => array( |
| [497](#L497) | 'name'     => \_\_( 'Purchases', 'wpdm-premium-packages' ), |
| [498](#L498) | 'callback' => array( |
| [499](#L499) | $this, |
| [500](#L500) | 'wpdmpp\_purchased\_items' |
| [501](#L501) | ) |
| [502](#L502) | ) |
| [503](#L503) | ), $menu ); |
| [504](#L504) |  |
| [505](#L505) | return $menu; |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | function wpdmpp\_purchased\_items( $params = array() ) { |
| [509](#L509) | global $wpdb; |
| [510](#L510) | $current\_user = wp\_get\_current\_user(); |
| [511](#L511) | $uid          = $current\_user->ID; |
| [512](#L512) |  |
| [513](#L513) | //$purchased\_items = $wpdb->get\_results("select oi.\*,o.currency, o.date as odate, o.order\_status from {$wpdb->prefix}ahm\_order\_items oi,{$wpdb->prefix}ahm\_orders o where o.order\_id = oi.oid and o.uid = {$uid} and o.order\_status IN ('Expired', 'Completed') order by `date` desc"); |
| [514](#L514) |  |
| [515](#L515) | wpdmpp\_expiry\_check(); |
| [516](#L516) |  |
| [517](#L517) | ob\_start(); |
| [518](#L518) | if ( isset( $params[2] ) && $params[1] == 'order' ) { |
| [519](#L519) | Order::userOrderDetails( $params[2] ); |
| [520](#L520) | } else { |
| [521](#L521) | include\_once wpdm\_tpl\_path( 'partials/resolve-order.php', WPDMPP\_TPL\_DIR ); |
| [522](#L522) | include\_once wpdm\_tpl\_path( 'partials/user-orders-list.php', WPDMPP\_TPL\_DIR ); |
| [523](#L523) | } |
| [524](#L524) | //else |
| [525](#L525) | //    include wpdm\_tpl\_path('user-dashboard/purchased-items.php', WPDMPP\_TPL\_DIR); |
| [526](#L526) |  |
| [527](#L527) | return ob\_get\_clean(); |
| [528](#L528) | } |
| [529](#L529) |  |
| [530](#L530) |  |
| [531](#L531) | /\*\* |
| [532](#L532) | \* Process Guest Orders |
| [533](#L533) | \*/ |
| [534](#L534) | function wpdmpp\_process\_guest\_order() { |
| [535](#L535) |  |
| [536](#L536) | if ( wpdm\_query\_var( 'exitgo', 'int' ) ) { |
| [537](#L537) | Session::clear( 'guest\_order' ); |
| [538](#L538) | $return = isset( $\_SERVER['HTTP\_REFERER'] ) ? $\_SERVER['HTTP\_REFERER'] : home\_url( '/' ); |
| [539](#L539) | wp\_redirect( $return ); |
| [540](#L540) | die( 'ok' ); |
| [541](#L541) | } |
| [542](#L542) |  |
| [543](#L543) | if ( isset( $\_POST['\_\_wpdmpp\_go'] ) ) { |
| [544](#L544) |  |
| [545](#L545) | check\_ajax\_referer( NONCE\_KEY, '\_\_wpdmpp\_go\_nonce' ); |
| [546](#L546) |  |
| [547](#L547) | //if( ! Session::get('guest\_order\_init') ) { Session::set('guest\_order\_init', uniqid(), 18000); die('nosess'); } |
| [548](#L548) |  |
| [549](#L549) | $orderid    = sanitize\_text\_field( $\_POST['\_\_wpdmpp\_go']['order'] ); |
| [550](#L550) | $orderemail = sanitize\_email( $\_POST['\_\_wpdmpp\_go']['email'] ); |
| [551](#L551) |  |
| [552](#L552) | $o     = new Order(); |
| [553](#L553) | $order = $o->getOrder( $orderid ); |
| [554](#L554) |  |
| [555](#L555) | // No match for order id |
| [556](#L556) | if ( ! is\_object( $order ) || ! isset( $order->order\_id ) || $order->order\_id != $orderid ) { |
| [557](#L557) | die( 'noordr' ); |
| [558](#L558) | } |
| [559](#L559) |  |
| [560](#L560) | // Found a match for order id |
| [561](#L561) | $billing\_info  = unserialize( $order->billing\_info ); |
| [562](#L562) | $billing\_email = isset( $billing\_info['order\_email'] ) ? $billing\_info['order\_email'] : ''; |
| [563](#L563) |  |
| [564](#L564) | if ( is\_email( $orderemail ) && $orderemail == $billing\_email && $order->uid <= 0 ) { |
| [565](#L565) | Session::set( 'guest\_order', $orderid, 18000 ); |
| [566](#L566) | Session::set( 'order\_email', $billing\_email, 18000 ); |
| [567](#L567) | die( 'success' ); |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | // Order assigned to registered user, so no guest access, please login to access order |
| [571](#L571) | if ( $order->uid > 0 ) { |
| [572](#L572) | die( 'nogues' ); |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | die( 'noordr' ); |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) |  |
| [581](#L581) | /\*\* |
| [582](#L582) | \* Save admin settings options |
| [583](#L583) | \*/ |
| [584](#L584) | function saveSettings() { |
| [585](#L585) | if ( wp\_verify\_nonce( wpdm\_query\_var( '\_\_wpdms\_nonce' ), WPDMSET\_NONCE\_KEY ) && current\_user\_can( WPDMPP\_ADMIN\_CAP ) ) { |
| [586](#L586) | $settings = $\_POST['\_wpdmpp\_settings']; |
| [587](#L587) | $settings = wpdm\_sanitize\_array( $settings ); |
| [588](#L588) | $settings = apply\_filters( "wpdmpp\_before\_save\_settings", $settings ); |
| [589](#L589) | update\_option( '\_wpdmpp\_settings', $settings ); |
| [590](#L590) | do\_action( "wpdmpp\_after\_save\_settings" ); |
| [591](#L591) | die( \_\_( 'Settings Saved Successfully', "wpdm-premium-packages" ) ); |
| [592](#L592) | } |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) |  |
| [596](#L596) | static function authorize\_masterkey() { |
| [597](#L597) | if ( WPDM()->package->validateMasterKey( wpdm\_query\_var( 'wpdmdl' ), wpdm\_query\_var( 'masterkey' ) ) && (int) get\_wpdmpp\_option( 'authorize\_masterkey' ) === 1 ) { |
| [598](#L598) | return true; |
| [599](#L599) | } |
| [600](#L600) |  |
| [601](#L601) | return false; |
| [602](#L602) | } |
| [603](#L603) |  |
| [604](#L604) | function download() { |
| [605](#L605) |  |
| [606](#L606) | if ( wpdm\_query\_var( 'wpdmppd' ) !== '' || wpdm\_query\_var( 'wpdmppdl' ) !== '' ) { |
| [607](#L607) |  |
| [608](#L608) | $wpdmdd = wpdm\_query\_var( 'wpdmppd' ) !== '' ? Crypt::decrypt( wpdm\_query\_var( 'wpdmppd' ), true ) : wpdmppdl\_decode( wpdm\_query\_var( 'wpdmppdl' ) ); |
| [609](#L609) |  |
| [610](#L610) | if ( ! is\_array( $wpdmdd ) || ! isset( $wpdmdd['ID'], $wpdmdd['oid'] ) ) { |
| [611](#L611) | Messages::error( \_\_( "&mdash; Invalid download link &mdash;", "wpdm-premium-packages" ), 1 ); |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) | $package = get\_post( $wpdmdd['ID'], ARRAY\_A ); |
| [615](#L615) |  |
| [616](#L616) | $PID    = (int) $wpdmdd['ID']; // Product ID |
| [617](#L617) | $OID    = sanitize\_text\_field( $wpdmdd['oid'] ); // Order ID |
| [618](#L618) | $domain = isset( $wpdmdd['domain'] ) ? sanitize\_text\_field( $wpdmdd['domain'] ) : ''; |
| [619](#L619) |  |
| [620](#L620) | $\_REQUEST['oid'] = $OID; |
| [621](#L621) |  |
| [622](#L622) | /\* |
| [623](#L623) | if (wpdm\_query\_var('preact') === 'login') { |
| [624](#L624) | $user = wp\_signon(array('user\_login' => wpdm\_query\_var('user'), 'user\_password' => wpdm\_query\_var('pass'))); |
| [625](#L625) | if (!$user->ID) |
| [626](#L626) | \WPDM\_Messages::error(\_\_( "Login failed!", "wpdm-premium-packages" ), 1); |
| [627](#L627) | else { |
| [628](#L628) | wp\_set\_current\_user($user->ID); |
| [629](#L629) | Session::set('guest\_order', $OID, 18000); |
| [630](#L630) | } |
| [631](#L631) | } |
| [632](#L632) |  |
| [633](#L633) | if (wpdm\_query\_var('wpdm\_access\_token') != '') { |
| [634](#L634) | $at = wpdm\_query\_var('wpdm\_access\_token'); |
| [635](#L635) | if (!$at) die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [636](#L636) | $atx = explode("x", $at); |
| [637](#L637) | $uid = end($atx); |
| [638](#L638) | $uid = (int)$uid; |
| [639](#L639) | if (!$uid) die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [640](#L640) | $sat = get\_user\_meta($uid, '\_\_wpdm\_access\_token', true); |
| [641](#L641) | if ($sat === '') die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [642](#L642) | if ($sat === $at) |
| [643](#L643) | wp\_set\_current\_user($uid); |
| [644](#L644) | else |
| [645](#L645) | die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [646](#L646) | }\*/ |
| [647](#L647) |  |
| [648](#L648) |  |
| [649](#L649) | global $wpdb; |
| [650](#L650) | $current\_user = wp\_get\_current\_user(); |
| [651](#L651) | $settings     = get\_option( '\_wpdmpp\_settings' ); |
| [652](#L652) |  |
| [653](#L653) | $order = new Order(); |
| [654](#L654) | $odata = $order->getOrder( $OID ); |
| [655](#L655) | $items = array\_keys( unserialize( $odata->cart\_data ) ); |
| [656](#L656) | if ( $domain !== '' && $domain === wpdm\_query\_var( 'domain' ) ) { |
| [657](#L657) |  |
| [658](#L658) | if ( ! user\_can( $odata->uid, 'manage\_options' ) ) { |
| [659](#L659) | $current\_user = get\_user\_by( 'id', $odata->uid ); |
| [660](#L660) | wp\_set\_current\_user( $odata->uid ); |
| [661](#L661) | wp\_set\_auth\_cookie( $odata->uid ); |
| [662](#L662) | } |
| [663](#L663) | if ( ! is\_user\_logged\_in() ) { |
| [664](#L664) | $odata->uid = 0; |
| [665](#L665) | } |
| [666](#L666) | $settings['guest\_download'] = 1; |
| [667](#L667) | Session::set( 'guest\_order', $OID, 18000 ); |
| [668](#L668) |  |
| [669](#L669) | } |
| [670](#L670) |  |
| [671](#L671) |  |
| [672](#L672) | $expire\_date = $odata->expire\_date > 0 ? $odata->expire\_date : ( $odata->date + ( get\_wpdmpp\_option( 'order\_validity\_period', 365 ) \* 86400 ) ); |
| [673](#L673) |  |
| [674](#L674) | if ( $odata->uid != $current\_user->ID && ! Session::get( 'guest\_order' ) ) { |
| [675](#L675) | Messages::error( \_\_( "Invalid Access!", "wpdm-premium-packages" ), 1 ); |
| [676](#L676) | } |
| [677](#L677) | if ( $odata->order\_status === 'Expired' || time() > $expire\_date ) { |
| [678](#L678) | Messages::error( \_\_( "Sorry! Support and Update Access Period is Already Expired", "wpdm-premium-packages" ), 1 ); |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | $base\_price = get\_post\_meta( $PID, '\_\_wpdm\_base\_price', true ); |
| [682](#L682) |  |
| [683](#L683) |  |
| [684](#L684) | $package['files'] = WPDM()->package->getFiles( $PID, true ); |
| [685](#L685) |  |
| [686](#L686) | //wpdmdd($package); |
| [687](#L687) | $cart = maybe\_unserialize( $odata->cart\_data ); |
| [688](#L688) |  |
| [689](#L689) | $cfiles = array(); |
| [690](#L690) |  |
| [691](#L691) | if ( isset( $cart[ $PID ]['files'] ) && is\_array( $cart[ $PID ]['files'] ) && count( $cart[ $PID ]['files'] ) > 0 ) { |
| [692](#L692) | $files = $cart[ $PID ]['files']; |
| [693](#L693) | foreach ( $files as $fID ) { |
| [694](#L694) | if ( $fID && isset( $package['files'][ $fID ] ) ) { |
| [695](#L695) | $cfiles[ $fID ] = $package['files'][ $fID ]; |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | if ( count( $cfiles ) === 0 ) { |
| [701](#L701) | $all\_licenses = wpdmpp\_get\_licenses(); |
| [702](#L702) | $starter      = array\_keys( $all\_licenses )[0]; |
| [703](#L703) | $\_license     = wpdm\_valueof( $cart, "{$PID}/license/id" ); |
| [704](#L704) | if ( ! $\_license ) { |
| [705](#L705) | $\_license = $starter; |
| [706](#L706) | } |
| [707](#L707) | $license\_pack = get\_post\_meta( $PID, "\_\_wpdm\_license\_pack", true ); |
| [708](#L708) | $license\_pack = wpdm\_valueof( $license\_pack, $\_license ); |
| [709](#L709) | if ( is\_array( $license\_pack ) ) { |
| [710](#L710) | foreach ( $license\_pack as $fID ) { |
| [711](#L711) | $cfiles[ $fID ] = $package['files'][ $fID ]; |
| [712](#L712) | } |
| [713](#L713) | } |
| [714](#L714) | } |
| [715](#L715) |  |
| [716](#L716) | $package['individual\_file\_download'] = 1; |
| [717](#L717) |  |
| [718](#L718) | if ( $base\_price == 0 && $PID > 0 ) { |
| [719](#L719) | //for free items |
| [720](#L720) | $package['access'] = array( 'guest' ); |
| [721](#L721) | include( WPDM\_SRC\_DIR . "wpdm-start-download.php" ); |
| [722](#L722) | } |
| [723](#L723) |  |
| [724](#L724) |  |
| [725](#L725) | //Member's Download |
| [726](#L726) | if ( @in\_array( $PID, $items ) && $OID != '' && is\_user\_logged\_in() && $current\_user->ID == $odata->uid && $odata->order\_status == 'Completed' ) { |
| [727](#L727) | //for premium item |
| [728](#L728) |  |
| [729](#L729) | $order = new Order(); |
| [730](#L730) | $order->update( array( 'download' => 1 ), $OID ); |
| [731](#L731) |  |
| [732](#L732) | if ( count( $cfiles ) > 0 && ! isset( $cfiles[ wpdm\_query\_var( 'ind' ) ] ) ) { |
| [733](#L733) | if ( count( $cfiles ) > 1 ) { |
| [734](#L734) | $zipped = \WPDM\\_\_\FileSystem::zipFiles( $cfiles, $package['post\_title'] . " " . $odata->order\_id ); |
| [735](#L735) | \WPDM\\_\_\FileSystem::downloadFile( $zipped, basename( $zipped ) ); |
| [736](#L736) | } else { |
| [737](#L737) | $file = array\_shift( $cfiles ); |
| [738](#L738) | if ( ! file\_exists( $file ) ) { |
| [739](#L739) | $file = WPDM()->fileSystem->locateFile( $file ); |
| [740](#L740) | } |
| [741](#L741) | \WPDM\\_\_\FileSystem::downloadFile( $file, basename( $file ) ); |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) | die(); |
| [745](#L745) | } else { |
| [746](#L746) | Session::set( '\_\_wpdmpp\_authorized\_download', 1 ); |
| [747](#L747) | $package['access'] = array( 'guest' ); |
| [748](#L748) | include( WPDM\_SRC\_DIR . "wpdm-start-download.php" ); |
| [749](#L749) | } |
| [750](#L750) | } |
| [751](#L751) | //wpdmdd($odata); |
| [752](#L752) | //Guest's Download |
| [753](#L753) | if ( @in\_array( $PID, $items ) |
| [754](#L754) | && $OID != '' |
| [755](#L755) | && $odata->uid == 0 |
| [756](#L756) | && $odata->order\_status == 'Completed' |
| [757](#L757) | && isset( $settings['guest\_download'] ) |
| [758](#L758) | && Session::get( 'guest\_order' ) === $OID ) { |
| [759](#L759) | Session::set( '\_\_wpdmpp\_authorized\_download', 1 ); |
| [760](#L760) | $package['access'] = array( 'guest' ); |
| [761](#L761) | $order             = new Order(); |
| [762](#L762) | $order->Update( array( 'download' => 1 ), $OID ); |
| [763](#L763) | include( WPDM\_SRC\_DIR . "wpdm-start-download.php" ); |
| [764](#L764) |  |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | Messages::error( \_\_( "&mdash; Invalid download link &mdash;", "wpdm-premium-packages" ), 1 ); |
| [768](#L768) | } |
| [769](#L769) |  |
| [770](#L770) | if ( wpdm\_query\_var( 'wpdmpp\_file' ) ) { |
| [771](#L771) | $file        = wpdm\_query\_var( 'wpdmpp\_file' ); |
| [772](#L772) | $token       = wpdm\_query\_var( 'access\_token' ); |
| [773](#L773) | $\_token      = explode( "x", $token ); |
| [774](#L774) | $uid         = end( $\_token ); |
| [775](#L775) | $valid\_token = get\_user\_meta( $uid, "\_\_wpdm\_access\_token", true ); |
| [776](#L776) | if ( $token === $valid\_token ) { |
| [777](#L777) | $files     = WPDMPP()->order->getPurchasedFiles( $uid ); |
| [778](#L778) | $file\_path = wpdm\_valueof( $files, $file ); |
| [779](#L779) | if ( $file\_path !== '' ) { |
| [780](#L780) | WPDM()->fileSystem->downloadFile( $file\_path, basename( $file\_path ), 10240, 0 ); |
| [781](#L781) | die(); |
| [782](#L782) | } else { |
| [783](#L783) | die( 'Access Denied!' ); |
| [784](#L784) | } |
| [785](#L785) | } else { |
| [786](#L786) | die( 'Invalid Token!' ); |
| [787](#L787) | } |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | } |
| [791](#L791) |  |
| [792](#L792) | /\*\* |
| [793](#L793) | \* Create new Order |
| [794](#L794) | \*/ |
| [795](#L795) | function create\_order() { |
| [796](#L796) | $current\_user = wp\_get\_current\_user(); |
| [797](#L797) |  |
| [798](#L798) | //If session already contains an order ID |
| [799](#L799) | if ( Session::get( 'orderid' ) ) { |
| [800](#L800) | $order      = new Order(); |
| [801](#L801) | $order\_info = $order->getOrder( Session::get( 'orderid' ) ); |
| [802](#L802) | // Check it the order ID in session is valid |
| [803](#L803) | if ( is\_object( $order\_info ) && $order\_info->order\_id ) { |
| [804](#L804) | // Check if the order is not completed yet |
| [805](#L805) | if ( $order\_info->order\_status !== 'Completed' ) { |
| [806](#L806) | $items = WPDMPP()->cart->getItems(); |
| [807](#L807) | $data  = array( |
| [808](#L808) | 'cart\_data' => serialize( $items ), |
| [809](#L809) | 'items'     => serialize( array\_keys( $items ) ) |
| [810](#L810) | ); |
| [811](#L811) | $order->reCalculate( $order\_info->order\_id ); |
| [812](#L812) | $order->updateOrderItems( $items, $order\_info->order\_id ); |
| [813](#L813) | $order->Update( $data, $order\_info->order\_id ); |
| [814](#L814) | //Set the incomplete order ID as the current order ID |
| [815](#L815) | $order\_id = $order\_info->order\_id; |
| [816](#L816) | } else { |
| [817](#L817) | // The order is already completed, so clear the session and create a new order |
| [818](#L818) | Session::clear( 'orderid' ); |
| [819](#L819) | $order\_id = WPDMPP()->order->open(); |
| [820](#L820) | } |
| [821](#L821) | } else { |
| [822](#L822) | // The order ID in session is not valid, so create a new order |
| [823](#L823) | $order\_id = WPDMPP()->order->open(); |
| [824](#L824) | } |
| [825](#L825) |  |
| [826](#L826) | } else { |
| [827](#L827) | // No order ID in session, let's create a new order |
| [828](#L828) | $order\_id = WPDMPP()->order->open(); |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | return $order\_id; |
| [832](#L832) | } |
| [833](#L833) |  |
| [834](#L834) | /\*\* |
| [835](#L835) | \*  Set payment method for order |
| [836](#L836) | \*/ |
| [837](#L837) | function set\_payment\_method() { |
| [838](#L838) | $current\_user = wp\_get\_current\_user(); |
| [839](#L839) | if(wpdm\_query\_var('wpdm\_client') !== '') |
| [840](#L840) | Session::deviceID(wpdm\_query\_var('wpdm\_client')); |
| [841](#L841) | //wpdmdd(WPDMPP()->cart->getItems()); |
| [842](#L842) | if ( wpdm\_query\_var( 'method', 'txt' ) != '' ) { |
| [843](#L843) | //$order = new Order($\_SESSION['orderid']); |
| [844](#L844) | //$order->set('payment\_method', wpdm\_query\_var('method', 'txt')); |
| [845](#L845) | //$order->save(); |
| [846](#L846) | Session::set( 'payment\_method', wpdm\_query\_var( 'method', 'txt' ) ); |
| [847](#L847) | $payment = new Payment(); |
| [848](#L848) | $payment->initiateProcessor( wpdm\_query\_var( 'method', 'txt' ) ); |
| [849](#L849) |  |
| [850](#L850) | ob\_start(); |
| [851](#L851) | $billing\_required = isset( $payment->Processor->billing ) ? (int) $payment->Processor->billing : 0; |
| [852](#L852) | $billing          = array(); |
| [853](#L853) | if ( is\_user\_logged\_in() ) { |
| [854](#L854) | $billing = BillingInfo::get( get\_current\_user\_id() ); |
| [855](#L855) | } |
| [856](#L856) | // If you payment menthod requires to fill a custom form during checkout |
| [857](#L857) | if ( method\_exists( $payment->Processor, "checkoutForm" ) ) { |
| [858](#L858) | echo $payment->Processor->checkoutForm(); |
| [859](#L859) | } else { |
| [860](#L860) | if ( get\_wpdmpp\_option( 'billing\_address' ) == 1 || wpdmpp\_tax\_active() || $billing\_required ) { |
| [861](#L861) | // Ask Billing Address When Checkout |
| [862](#L862) | include \WPDM\\_\_\Template::locate( 'checkout-cart/checkout-billing-info.php', dirname( \_\_FILE\_\_ ) . '/templates' . WPDM()->bsversion . "/", WPDMPP\_TPL\_FALLBACK ); |
| [863](#L863) | } else { |
| [864](#L864) | // Ask only Name and Email When Checkout |
| [865](#L865) | include \WPDM\\_\_\Template::locate( 'checkout-cart/checkout-name-email.php', dirname( \_\_FILE\_\_ ) . '/templates' . WPDM()->bsversion . "/", WPDMPP\_TPL\_FALLBACK ); |
| [866](#L866) | } |
| [867](#L867) | } |
| [868](#L868) | $billing\_form = ob\_get\_clean(); |
| [869](#L869) |  |
| [870](#L870) | if ( method\_exists( $payment->Processor, 'customPayButton' ) ) { |
| [871](#L871) | $cb = $payment->Processor->customPayButton(); |
| [872](#L872) | if ( $cb != '' ) { |
| [873](#L873) | wp\_send\_json( array( 'button' => 'custom', 'html' => $cb, 'billing\_form' => $billing\_form ) ); |
| [874](#L874) | } |
| [875](#L875) | } |
| [876](#L876) | wp\_send\_json( array( 'button' => 'default', 'html' => '', 'billing\_form' => $billing\_form ) ); |
| [877](#L877) | } |
| [878](#L878) | } |
| [879](#L879) |  |
| [880](#L880) |  |
| [881](#L881) | /\*\* |
| [882](#L882) | \* Saving payment method info from checkout process |
| [883](#L883) | \*/ |
| [884](#L884) | function paynow() { |
| [885](#L885) | if ( isset( $\_REQUEST['task'] ) && $\_REQUEST['task'] == "paynow" ) { |
| [886](#L886) |  |
| [887](#L887) | if ( wpdmpp\_is\_cart\_empty() ) { |
| [888](#L888) | die( '<div class="alert alert-danger" data-title="ERROR!">' . \_\_( 'Cart is Empty!', 'wpdmp-premium-package' ) . '</div>' ); |
| [889](#L889) | } |
| [890](#L890) | if ( ! is\_user\_logged\_in() && ( ! isset( $\_POST['billing']['order\_email'] ) || ! is\_email( $\_POST['billing']['order\_email'] ) ) ) { |
| [891](#L891) | die( '<div class="alert alert-danger" data-title="ERROR!">' . \_\_( 'Please enter order confirmation email!', 'wpdmp-premium-package' ) . '</div>' ); |
| [892](#L892) | } |
| [893](#L893) |  |
| [894](#L894) | $current\_user = wp\_get\_current\_user(); |
| [895](#L895) |  |
| [896](#L896) | $order\_id = $this->create\_order(); |
| [897](#L897) |  |
| [898](#L898) | $order = new Order(); |
| [899](#L899) | $order->update( [ 'payment\_method' => wpdm\_query\_var( 'payment\_method', 'txt' ) ], $order\_id ); |
| [900](#L900) |  |
| [901](#L901) | //Update users billing info |
| [902](#L902) | if ( is\_user\_logged\_in() ) { |
| [903](#L903) | $billing\_info                = wpdm\_sanitize\_array( $\_POST['billing'] ); |
| [904](#L904) | $billing\_info['order\_email'] = sanitize\_email( $\_POST['billing']['order\_email'] ); |
| [905](#L905) | $billing\_info['email']       = sanitize\_email( $\_POST['billing']['order\_email'] ); |
| [906](#L906) | $billing\_info['phone']       = ''; |
| [907](#L907) | $customer\_billing\_address    = get\_user\_meta( $current\_user->ID, 'user\_billing\_shipping', true ); |
| [908](#L908) | if ( ! $customer\_billing\_address ) { |
| [909](#L909) | update\_user\_meta( $current\_user->ID, 'user\_billing\_shipping', serialize( array( 'billing' => $billing\_info ) ) ); |
| [910](#L910) | } |
| [911](#L911) | } |
| [912](#L912) | $this->place\_order( $order\_id ); |
| [913](#L913) | die(); |
| [914](#L914) | } |
| [915](#L915) | } |
| [916](#L916) |  |
| [917](#L917) |  |
| [918](#L918) | /\*\* |
| [919](#L919) | \* Placing order from checkout process |
| [920](#L920) | \*/ |
| [921](#L921) | function place\_order( $order\_id ) { |
| [922](#L922) | //if(floatval(wpdmpp\_get\_cart\_total()) <= 0 ) return; |
| [923](#L923) | global $wpdb; |
| [924](#L924) | $order       = new Order(); |
| [925](#L925) | $order       = $order->getOrder( $order\_id ); |
| [926](#L926) | $order\_total = $order->total; |
| [927](#L927) | $tax         = $order->tax; |
| [928](#L928) |  |
| [929](#L929) | $items = maybe\_unserialize( $order->cart\_data ); |
| [930](#L930) | //$cart\_data = wpdmpp\_get\_cart\_data(); |
| [931](#L931) |  |
| [932](#L932) | if ( ! is\_array( $items ) || count( $items ) == 0 ) { |
| [933](#L933) | Messages::Error( \_\_( "Cart is Empty!", "wpdm-premium-packages" ), 0 ); |
| [934](#L934) | die(); |
| [935](#L935) | } |
| [936](#L936) |  |
| [937](#L937) | $order\_title = $order->title; |
| [938](#L938) |  |
| [939](#L939) | do\_action( "wpdm\_before\_placing\_order", $order\_id ); |
| [940](#L940) |  |
| [941](#L941) | // If order total is not 0 then go to payment gateway |
| [942](#L942) | if ( $order\_total > 0 ) { |
| [943](#L943) |  |
| [944](#L944) | $payment = new Payment(); |
| [945](#L945) | $payment->initiateProcessor( wpdm\_query\_var( 'payment\_method', 'txt' ) ); |
| [946](#L946) | $payment->Processor->OrderTitle = $order\_title; |
| [947](#L947) | $payment->Processor->InvoiceNo  = $order\_id; |
| [948](#L948) | $payment->Processor->Custom     = $order\_id; |
| [949](#L949) | $payment->Processor->Amount     = number\_format( $order\_total, 2, ".", "" ); |
| [950](#L950) |  |
| [951](#L951) | echo $payment->Processor->showPaymentForm( 1 ); |
| [952](#L952) |  |
| [953](#L953) | if ( ! isset( $payment->Processor->EmptyCartOnPlaceOrder ) || $payment->Processor->EmptyCartOnPlaceOrder == true ) { |
| [954](#L954) | wpdmpp\_empty\_cart(); |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | die(); |
| [958](#L958) |  |
| [959](#L959) | } else { |
| [960](#L960) | // if order total is 0 then empty cart and redirect to home |
| [961](#L961) | Order::complete\_order( $order\_id ); |
| [962](#L962) | wpdmpp\_empty\_cart(); |
| [963](#L963) | wpdmpp\_js\_redirect( wpdmpp\_orders\_page( 'id=' . $order\_id ) ); |
| [964](#L964) | } |
| [965](#L965) | } |
| [966](#L966) |  |
| [967](#L967) | function clone\_order() { |
| [968](#L968) | if ( ! is\_user\_logged\_in() ) { |
| [969](#L969) | return; |
| [970](#L970) | } |
| [971](#L971) | $order = new Order( wpdm\_query\_var( 'clone\_order', 'txt' ) ); |
| [972](#L972) | if ( ! $order->order\_id || (int) $order->uid !== get\_current\_user\_id() ) { |
| [973](#L973) | return; |
| [974](#L974) | } |
| [975](#L975) | WPDMPP()->cart->clear(); |
| [976](#L976) | //wpdmdd($order->cart\_data); |
| [977](#L977) | foreach ( $order->cart\_data as $pid => $item ) { |
| [978](#L978) | WPDMPP()->cart->addItem( $pid, wpdm\_valueof( $item, 'license/id' ) ); |
| [979](#L979) | } |
| [980](#L980) | wpdmpp\_redirect( wpdmpp\_cart\_url() ); |
| [981](#L981) | //wpdmdd($cart\_data); |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | function is\_auto\_new\_active() { |
| [985](#L985) | global $wpdmpp\_settings; |
| [986](#L986) | $wpdmpp\_settings['order\_validity\_period'] = (int) $wpdmpp\_settings['order\_validity\_period'] > 0 ? (int) $wpdmpp\_settings['order\_validity\_period'] : 365; |
| [987](#L987) | if ( isset( $wpdmpp\_settings['auto\_renew'], $wpdmpp\_settings['order\_validity\_period'] ) && $wpdmpp\_settings['auto\_renew'] == 1 && $wpdmpp\_settings['order\_validity\_period'] > 0 ) { |
| [988](#L988) | return true; |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | return false; |
| [992](#L992) | } |
| [993](#L993) |  |
| [994](#L994) | /\*\* |
| [995](#L995) | \* Payment notification process/ IPN verification |
| [996](#L996) | \*/ |
| [997](#L997) | function payment\_notification() { |
| [998](#L998) | if ( isset( $\_REQUEST['action'] ) && $\_REQUEST['action'] == "wpdmpp-payment-notification" ) { |
| [999](#L999) |  |
| [1000](#L1000) | $payment\_gateway\_class = 'WPDMPP\Libs\PaymentMethods\\' . sanitize\_text\_field( $\_REQUEST['class'] ); |
| [1001](#L1001) | $payment\_method        = new $payment\_gateway\_class(); |
| [1002](#L1002) |  |
| [1003](#L1003) | //$payment\_method = new $\_REQUEST['class'](); |
| [1004](#L1004) |  |
| [1005](#L1005) | if ( $payment\_method->verifyNotification() ) { |
| [1006](#L1006) | do\_action( "wpdmpp\_payment\_completed", $payment\_method->InvoiceNo ); |
| [1007](#L1007) | Order::complete\_order( $payment\_method->InvoiceNo, true, $payment\_method ); |
| [1008](#L1008) | do\_action( "wpdm\_after\_checkout", $payment\_method->InvoiceNo ); |
| [1009](#L1009) | die( 'OK' ); |
| [1010](#L1010) | } |
| [1011](#L1011) | die( "FAILED" ); |
| [1012](#L1012) | } |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | /\*\* |
| [1016](#L1016) | \* Payment notification process/ IPN verification |
| [1017](#L1017) | \*/ |
| [1018](#L1018) | function comeplete\_buynow\_action() { |
| [1019](#L1019) | if ( wpdm\_query\_var( 'action', 'txt' ) === "wpdmpp-complete-buynow" ) { |
| [1020](#L1020) |  |
| [1021](#L1021) | $payment\_gateway\_class = 'WPDMPP\Libs\PaymentMethods\\' . sanitize\_text\_field( $\_REQUEST['class'] ); |
| [1022](#L1022) | $payment\_method        = new $payment\_gateway\_class(); |
| [1023](#L1023) | $payment\_method->completeBuyNow(); |
| [1024](#L1024) | } |
| [1025](#L1025) | } |
| [1026](#L1026) |  |
| [1027](#L1027) | function buy\_now( $product\_id, $license = '', $extras = array() ) { |
| [1028](#L1028) | global $wpdmpp; |
| [1029](#L1029) | $wpdmpp->add\_to\_cart( $product\_id ); |
| [1030](#L1030) | $wpdmpp->create\_order(); |
| [1031](#L1031) | $order = new Order( Session::get( 'orderid' ) ); |
| [1032](#L1032) |  |
| [1033](#L1033) | wpdmpp\_calculate\_discount(); |
| [1034](#L1034) | $order->updateOrderItems( wpdmpp\_get\_cart\_data(), Session::get( 'orderid' ) ); |
| [1035](#L1035) | $order\_total = $order->calcOrderTotal( Session::get( 'orderid' ) ); |
| [1036](#L1036) |  |
| [1037](#L1037) | $tax = 0; |
| [1038](#L1038) |  |
| [1039](#L1039) | foreach ( $pids as $pid ) { |
| [1040](#L1040) | $price = wpdmpp\_effective\_price( $pid ); |
| [1041](#L1041) | $total += $price; |
| [1042](#L1042) | } |
| [1043](#L1043) |  |
| [1044](#L1044) |  |
| [1045](#L1045) | $cart\_data[ $product\_id ] = array( |
| [1046](#L1046) | 'ID'              => $product\_id, |
| [1047](#L1047) | 'post\_title'      => get\_the\_title( $product\_id ), |
| [1048](#L1048) | 'quantity'        => 1, |
| [1049](#L1049) | 'variation'       => array(), |
| [1050](#L1050) | 'variations'      => array(), |
| [1051](#L1051) | 'files'           => array(), |
| [1052](#L1052) | 'price'           => $price, |
| [1053](#L1053) | 'prices'          => 0, |
| [1054](#L1054) | 'discount\_amount' => 0 |
| [1055](#L1055) | ); |
| [1056](#L1056) |  |
| [1057](#L1057) | $o->newOrder( wpdm\_query\_var( 'oid' ), 'Custom Order', $items, $total, 0, 'Completed', 'Completed', serialize( $cart\_data ) ); |
| [1058](#L1058) |  |
| [1059](#L1059) | Order::updateOrderItems( $cart\_data, wpdm\_query\_var( 'oid' ) ); |
| [1060](#L1060) |  |
| [1061](#L1061) | $subtotal = wpdmpp\_get\_cart\_subtotal(); |
| [1062](#L1062) | if ( wpdmpp\_tax\_active() && Session::get( 'tax' ) ) { |
| [1063](#L1063) | $tax         = Session::get( 'tax' ); |
| [1064](#L1064) | $order\_total = $subtotal + $tax; |
| [1065](#L1065) | } |
| [1066](#L1066) | $cart\_id = wpdmpp\_cart\_id(); |
| [1067](#L1067) | $coupon  = wpdmpp\_get\_cart\_coupon(); |
| [1068](#L1068) |  |
| [1069](#L1069) | $grand\_total = $order\_total - (double) wpdm\_valueof( $coupon, 'discount', 0 ); |
| [1070](#L1070) |  |
| [1071](#L1071) | $grand\_total = wpdmpp\_price\_format( $grand\_total, false, false ); |
| [1072](#L1072) | if ( is\_user\_logged\_in() && $order->uid == 0 ) { |
| [1073](#L1073) | $order->set( 'uid', get\_current\_user\_id() ); |
| [1074](#L1074) | } |
| [1075](#L1075) | $order->set( 'subtotal', $subtotal ); |
| [1076](#L1076) | $order->set( 'cart\_discount', 0 ); |
| [1077](#L1077) | $order->set( 'payment\_method', 'Paypal' ); |
| [1078](#L1078) | $order->set( 'coupon\_discount', $coupon['discount'] ); |
| [1079](#L1079) | $order->set( 'coupon\_code', $coupon['code'] ); |
| [1080](#L1080) | $order->set( 'tax', $tax ); |
| [1081](#L1081) | $order->set( 'order\_notes', '' ); |
| [1082](#L1082) | $order->set( 'total', $grand\_total ); |
| [1083](#L1083) | $order->save(); |
| [1084](#L1084) |  |
| [1085](#L1085) | } |
| [1086](#L1086) |  |
| [1087](#L1087) | /\*\* |
| [1088](#L1088) | \* Withdraw money from paypal notification |
| [1089](#L1089) | \*/ |
| [1090](#L1090) | function wpdmpp\_update\_withdraw\_status() { |
| [1091](#L1091) | if ( current\_user\_can( WPDMPP\_ADMIN\_CAP ) && wp\_verify\_nonce( wpdm\_query\_var( '\_\_wpdmppwn\_nonce' ), NONCE\_KEY ) ) { |
| [1092](#L1092) |  |
| [1093](#L1093) | global $wpdb; |
| [1094](#L1094) | $wpdb->update( |
| [1095](#L1095) | "{$wpdb->prefix}ahm\_withdraws", |
| [1096](#L1096) | array( |
| [1097](#L1097) | 'status' => 1 |
| [1098](#L1098) | ), |
| [1099](#L1099) | array( 'id' => sanitize\_text\_field( $\_REQUEST['wid'] ) ), |
| [1100](#L1100) | array( |
| [1101](#L1101) | '%d' |
| [1102](#L1102) | ), |
| [1103](#L1103) | array( '%d' ) |
| [1104](#L1104) | ); |
| [1105](#L1105) |  |
| [1106](#L1106) | wp\_send\_json( array( 'success' => 1 ) ); |
| [1107](#L1107) | die(); |
| [1108](#L1108) |  |
| [1109](#L1109) | } |
| [1110](#L1110) | } |
| [1111](#L1111) |  |
| [1112](#L1112) |  |
| [1113](#L1113) | /\*\* |
| [1114](#L1114) | \* Payment using ajax |
| [1115](#L1115) | \*/ |
| [1116](#L1116) | function wpdmpp\_ajax\_payfront() { |
| [1117](#L1117) | if ( isset( $\_POST['task'], $\_POST['action'] ) && $\_POST['task'] == "paymentfront" && $\_POST['action'] == "wpdmpp\_async\_request" ) { |
| [1118](#L1118) | $data['order\_id']       = sanitize\_text\_field( $\_POST['order\_id'] ); |
| [1119](#L1119) | $data['payment\_method'] = sanitize\_text\_field( $\_POST['payment\_method'] ); |
| [1120](#L1120) | wpdmpp\_pay\_now( $data ); |
| [1121](#L1121) | die(); |
| [1122](#L1122) | } |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | /\*\* |
| [1126](#L1126) | \* Dynamic function call using AJAX |
| [1127](#L1127) | \*/ |
| [1128](#L1128) | function wpdmpp\_async\_request() { |
| [1129](#L1129) | $CustomActions = new \WPDMPP\Libs\CustomActions(); |
| [1130](#L1130) | if ( method\_exists( $CustomActions, $\_POST['execute'] ) ) { |
| [1131](#L1131) | $method = sanitize\_text\_field( $\_POST['execute'] ); |
| [1132](#L1132) | echo $CustomActions->$method(); |
| [1133](#L1133) | die(); |
| [1134](#L1134) | } else { |
| [1135](#L1135) | die( "Function doesn't exist" ); |
| [1136](#L1136) | } |
| [1137](#L1137) | } |
| [1138](#L1138) |  |
| [1139](#L1139) | /\*\* |
| [1140](#L1140) | \* Execute Custom Action |
| [1141](#L1141) | \*/ |
| [1142](#L1142) | function anync\_execute() { |
| [1143](#L1143) | $CustomActions = new \WPDMPP\Libs\CustomActions(); |
| [1144](#L1144) | if ( isset( $\_POST['action'] ) && $\_POST['action'] == 'wpdmpp\_anync\_exec' ) { |
| [1145](#L1145) | if ( method\_exists( $CustomActions, $\_POST['execute'] ) ) { |
| [1146](#L1146) | $method = sanitize\_text\_field( $\_POST['execute'] ); |
| [1147](#L1147) | echo $CustomActions->$method(); |
| [1148](#L1148) | die(); |
| [1149](#L1149) | } |
| [1150](#L1150) | } |
| [1151](#L1151) |  |
| [1152](#L1152) | } |
| [1153](#L1153) |  |
| [1154](#L1154) |  |
| [1155](#L1155) | /\*\* |
| [1156](#L1156) | \* Update User Profile |
| [1157](#L1157) | \*/ |
| [1158](#L1158) | function wpdmpp\_update\_profile() { |
| [1159](#L1159) |  |
| [1160](#L1160) | if ( is\_user\_logged\_in() && wp\_verify\_nonce( wpdm\_query\_var( '\_\_upnonce' ), NONCE\_KEY ) && isset( $\_POST['profile'] ) ) { |
| [1161](#L1161) |  |
| [1162](#L1162) | $userdata       = $\_POST['profile']; |
| [1163](#L1163) | $userdata['ID'] = get\_current\_user\_id(); |
| [1164](#L1164) | if ( $\_POST['password'] == $\_POST['cpassword'] ) { |
| [1165](#L1165) | wp\_update\_user( $userdata ); |
| [1166](#L1166) | $userdata['user\_pass'] = $\_POST['password']; |
| [1167](#L1167) | update\_user\_meta( get\_current\_user\_id(), 'payment\_account', sanitize\_text\_field( $\_POST['payment\_account'] ) ); |
| [1168](#L1168) | update\_user\_meta( get\_current\_user\_id(), 'phone', sanitize\_text\_field( $\_POST['phone'] ) ); |
| [1169](#L1169) | Session::set( 'member\_success', \_\_( "Profile Updated Successfully", "wpdm-premium-packages" ) ); |
| [1170](#L1170) |  |
| [1171](#L1171) | } else { |
| [1172](#L1172) | $merror   = Session::get( 'member\_error' ); |
| [1173](#L1173) | $merror   = is\_array( $merror ) ? $merror : array(); |
| [1174](#L1174) | $merror[] = \_\_( "Confirm Password Not Matched. Profile Update Failed!", "wpdm-premium-packages" ); |
| [1175](#L1175) | Session::set( 'member\_error', $merror ); |
| [1176](#L1176) | } |
| [1177](#L1177) | update\_user\_meta( get\_current\_user\_id(), 'user\_billing\_shipping', serialize( wpdm\_sanitize\_array( $\_POST['checkout'] ) ) ); |
| [1178](#L1178) | $return = isset( $\_SERVER['HTTP\_REFERER'] ) ? $\_SERVER['HTTP\_REFERER'] : home\_url( '/' ); |
| [1179](#L1179) | wpdmpp\_redirect( $return ); |
| [1180](#L1180) | die(); |
| [1181](#L1181) | } |
| [1182](#L1182) |  |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) | /\*\* |
| [1186](#L1186) | \* Load Scripts and Styles |
| [1187](#L1187) | \* |
| [1188](#L1188) | \* @param $hook |
| [1189](#L1189) | \*/ |
| [1190](#L1190) | function wpdmpp\_enqueue\_scripts( $hook ) { |
| [1191](#L1191) |  |
| [1192](#L1192) | $settings  = get\_option( '\_wpdmpp\_settings' ); |
| [1193](#L1193) | $cart\_page = isset( $settings['page\_id'] ) ? $settings['page\_id'] : 0; |
| [1194](#L1194) |  |
| [1195](#L1195) | wp\_enqueue\_script( 'wpdm-pp-js', WPDMPP\_BASE\_URL . 'assets/js/wpdmpp-front.js', array( |
| [1196](#L1196) | 'jquery', |
| [1197](#L1197) | 'jquery-form' |
| [1198](#L1198) | ) ); |
| [1199](#L1199) | if ( ! isset( $settings['disable\_fron\_end\_css'] ) || (int) $settings['disable\_fron\_end\_css'] === 0 ) { |
| [1200](#L1200) | wp\_enqueue\_style( 'wpdmpp-front', WPDMPP\_BASE\_URL . 'assets/css/wpdmpp.css', 999999 ); |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | //if((int)$cart\_page === (int)get\_the\_ID()){ |
| [1204](#L1204) | //wp\_enqueue\_script('jquery-validate'); |
| [1205](#L1205) | //} |
| [1206](#L1206) |  |
| [1207](#L1207) | if ( get\_the\_ID() == wpdm\_valueof( $settings, "orders\_page\_id" ) || ( isset( $settings['guest\_order\_page\_id'] ) && get\_the\_ID() == $settings['guest\_order\_page\_id'] ) ) { |
| [1208](#L1208) | wp\_enqueue\_script( 'thickbox' ); |
| [1209](#L1209) | wp\_enqueue\_style( 'thickbox' ); |
| [1210](#L1210) | wp\_enqueue\_script( 'media-upload' ); |
| [1211](#L1211) | wp\_enqueue\_media(); |
| [1212](#L1212) | } |
| [1213](#L1213) | } |
| [1214](#L1214) |  |
| [1215](#L1215) | function wpdmpp\_admin\_enqueue\_scripts( $hook ) { |
| [1216](#L1216) | if ( get\_post\_type() == 'wpdmpro' || strstr( $hook, 'dmpro\_page' ) ) { |
| [1217](#L1217) | wp\_enqueue\_script( 'jquery' ); |
| [1218](#L1218) | wp\_enqueue\_script( 'jquery-form' ); |
| [1219](#L1219) | wp\_enqueue\_script( 'jquery-ui-core' ); |
| [1220](#L1220) | wp\_enqueue\_script( 'jquery-ui-datepicker' ); |
| [1221](#L1221) | wp\_enqueue\_script( 'jquery-ui-accordion' ); |
| [1222](#L1222) |  |
| [1223](#L1223) | wp\_enqueue\_style( 'wpdmpp-admin', WPDMPP\_BASE\_URL . 'assets/css/wpdmpp-admin.min.css' ); |
| [1224](#L1224) | wp\_enqueue\_script( 'wpdmpp-admin-js', WPDMPP\_BASE\_URL . 'assets/js/wpdmpp-admin.js', array( 'jquery' ) ); |
| [1225](#L1225) |  |
| [1226](#L1226) | // Load Download Manager Scripts |
| [1227](#L1227) | //wp\_enqueue\_style('wpdm-admin-bootstrap', WPDM\_BASE\_URL . 'assets/bootstrap3/css/bootstrap.css'); |
| [1228](#L1228) | //wp\_enqueue\_script('wpdm-admin-bootstrap', WPDM\_BASE\_URL . 'assets/bootstrap3/js/bootstrap.min.js', array('jquery')); |
| [1229](#L1229) | wp\_enqueue\_script( 'jquery-validate', WPDM\_BASE\_URL . 'assets/js/jquery.validate.min.js', array( 'jquery' ) ); |
| [1230](#L1230) | //wp\_enqueue\_script('wpdm-bootstrap-select', WPDM\_BASE\_URL.'assets/js/bootstrap-select.min.js',  array('jquery', 'wpdm-admin-bootstrap')); |
| [1231](#L1231) | //wp\_enqueue\_style('wpdm-bootstrap-select', WPDM\_BASE\_URL.'assets/css/bootstrap-select.min.css'); |
| [1232](#L1232) | } |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | /\*\* |
| [1236](#L1236) | \* Check if a Package is premium |
| [1237](#L1237) | \* |
| [1238](#L1238) | \* @param $pid |
| [1239](#L1239) | \* |
| [1240](#L1240) | \* @return bool |
| [1241](#L1241) | \*/ |
| [1242](#L1242) | public static function isPremium( $pid ) { |
| [1243](#L1243) | $price = wpdmpp\_product\_price( $pid ); |
| [1244](#L1244) | if ( $price > 0 ) { |
| [1245](#L1245) | return true; |
| [1246](#L1246) | } |
| [1247](#L1247) |  |
| [1248](#L1248) | return false; |
| [1249](#L1249) | } |
| [1250](#L1250) |  |
| [1251](#L1251) | /\*\* |
| [1252](#L1252) | \* @usage Check if user purchased an item |
| [1253](#L1253) | \* |
| [1254](#L1254) | \* @param $pid |
| [1255](#L1255) | \* @param int $uid |
| [1256](#L1256) | \* |
| [1257](#L1257) | \* @return bool|string|null |
| [1258](#L1258) | \*/ |
| [1259](#L1259) |  |
| [1260](#L1260) | public static function hasPurchased( $pid, $uid = 0 ) { |
| [1261](#L1261) | global $wpdb; |
| [1262](#L1262) | $current\_user = wp\_get\_current\_user(); |
| [1263](#L1263) | if ( ! is\_user\_logged\_in() && ! $uid ) { |
| [1264](#L1264) | return false; |
| [1265](#L1265) | } |
| [1266](#L1266) | $uid     = $uid ? $uid : $current\_user->ID; |
| [1267](#L1267) | $orderid = $wpdb->get\_var( "select o.order\_id from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi  where uid='{$uid}' and o.order\_id = oi.oid and oi.pid = {$pid} and order\_status='Completed'" ); |
| [1268](#L1268) |  |
| [1269](#L1269) | return $orderid; |
| [1270](#L1270) | } |
| [1271](#L1271) |  |
| [1272](#L1272) | /\*\* |
| [1273](#L1273) | \* Generate Download URL |
| [1274](#L1274) | \* |
| [1275](#L1275) | \* @param $id Package ID |
| [1276](#L1276) | \* |
| [1277](#L1277) | \* @return string |
| [1278](#L1278) | \*/ |
| [1279](#L1279) | static function customerDownloadLink( $id ) { |
| [1280](#L1280) | global $wpdmpp\_settings; |
| [1281](#L1281) | $downloadurl = self::customerDownloadURL( $id ); |
| [1282](#L1282) | $label       = get\_post\_meta( $id, '\_\_wpdm\_link\_label', true ); |
| [1283](#L1283) | $label       = $label ? $label : \_\_( 'Download', 'wpdm-premium-packages' ); |
| [1284](#L1284) | if ( $downloadurl ) { |
| [1285](#L1285) | return "<a class='btn btn-success btn-lg' href='{$downloadurl}'>{$label}</a>"; |
| [1286](#L1286) | } |
| [1287](#L1287) |  |
| [1288](#L1288) | return isset( $wpdmpp\_settings['cdl\_fallback'] ) && $wpdmpp\_settings['cdl\_fallback'] == '1' ? wpdmpp\_add\_to\_cart\_html( $id ) : ""; |
| [1289](#L1289) | } |
| [1290](#L1290) |  |
| [1291](#L1291) | /\*\* |
| [1292](#L1292) | \* @param $pid |
| [1293](#L1293) | \* @param null $orderid |
| [1294](#L1294) | \* @param array $extras |
| [1295](#L1295) | \* |
| [1296](#L1296) | \* @return string |
| [1297](#L1297) | \*/ |
| [1298](#L1298) | static function customerDownloadURL( $pid, $orderid = null, $extras = array() ) { |
| [1299](#L1299) | if ( ! $orderid ) { |
| [1300](#L1300) | $orderid = self::hasPurchased( $pid ); |
| [1301](#L1301) | } |
| [1302](#L1302) | if ( ! $orderid ) { |
| [1303](#L1303) | return null; |
| [1304](#L1304) | } |
| [1305](#L1305) | $params        = is\_array( $extras ) ? $extras : array(); |
| [1306](#L1306) | $params['ID']  = $pid; |
| [1307](#L1307) | $params['oid'] = $orderid; |
| [1308](#L1308) | if ( defined( 'WPDMPPD\_PERMALINK' ) && WPDMPPD\_PERMALINK === true ) { |
| [1309](#L1309) | $wpdmppd = wpdmppdl\_encode( $params ); |
| [1310](#L1310) |  |
| [1311](#L1311) | return home\_url( "/?wpdmppdl={$wpdmppd}" ); |
| [1312](#L1312) | } else { |
| [1313](#L1313) | $wpdmppd = Crypt::encrypt( $params ); |
| [1314](#L1314) |  |
| [1315](#L1315) | return home\_url( "/?wpdmppd={$wpdmppd}" ); |
| [1316](#L1316) | } |
| [1317](#L1317) | } |
| [1318](#L1318) |  |
| [1319](#L1319) | function hideSingleFileDownloadLink( $link, $fileID, $package ) { |
| [1320](#L1320) | if ( ! isset( $package['ID'] ) ) { |
| [1321](#L1321) | return $link; |
| [1322](#L1322) | } |
| [1323](#L1323) | $effective\_price = wpdmpp\_effective\_price( $package['ID'] ); |
| [1324](#L1324) | if ( $effective\_price > 0 ) { |
| [1325](#L1325) | $link = ''; |
| [1326](#L1326) | } |
| [1327](#L1327) |  |
| [1328](#L1328) | return $link; |
| [1329](#L1329) | } |
| [1330](#L1330) |  |
| [1331](#L1331) | public static function hasFreeFile( $id = null ) { |
| [1332](#L1332) | if ( ! $id ) { |
| [1333](#L1333) | $id = get\_the\_ID(); |
| [1334](#L1334) | } |
| [1335](#L1335) | $fd = maybe\_unserialize( get\_post\_meta( $id, '\_\_wpdm\_free\_downloads', true ) ); |
| [1336](#L1336) | if ( is\_array( $fd ) && count( $fd ) > 0 && $fd[0] != '' ) { |
| [1337](#L1337) | return $fd; |
| [1338](#L1338) | } |
| [1339](#L1339) |  |
| [1340](#L1340) | return false; |
| [1341](#L1341) | } |
| [1342](#L1342) |  |
| [1343](#L1343) | function freeDownload() { |
| [1344](#L1344) | if ( isset( $\_GET['wpdmdlfree'] ) ) { |
| [1345](#L1345) | $id        = (int) $\_GET['wpdmdlfree']; |
| [1346](#L1346) | $freefiles = self::hasFreeFile( $id ); |
| [1347](#L1347) |  |
| [1348](#L1348) | if ( ! $freefiles ) { |
| [1349](#L1349) | wp\_die( 'No free file found!' ); |
| [1350](#L1350) | } |
| [1351](#L1351) | $pack = array( 'ID' => $id ); |
| [1352](#L1352) | //do\_action("wpdm\_onstart\_download", $pack); |
| [1353](#L1353) |  |
| [1354](#L1354) | if ( count( $freefiles ) > 1 ) { |
| [1355](#L1355) | foreach ( $freefiles as &$freefile ) { |
| [1356](#L1356) | $freefile = str\_replace( site\_url( '/' ), ABSPATH, $freefile ); |
| [1357](#L1357) | } |
| [1358](#L1358) | $zipped = \WPDM\\_\_\FileSystem::zipFiles( $freefiles, get\_the\_title( $id ) ); |
| [1359](#L1359) | \WPDM\\_\_\FileSystem::downloadFile( $zipped, basename( $zipped ) ); |
| [1360](#L1360) | } else { |
| [1361](#L1361) | header( "location: " . array\_pop( $freefiles ) ); |
| [1362](#L1362) | } |
| [1363](#L1363) | die(); |
| [1364](#L1364) | } |
| [1365](#L1365) | } |
| [1366](#L1366) |  |
| [1367](#L1367) | /\*\* |
| [1368](#L1368) | \* @param $id |
| [1369](#L1369) | \* @param $link\_label |
| [1370](#L1370) | \* @param string $class |
| [1371](#L1371) | \* |
| [1372](#L1372) | \* @return string |
| [1373](#L1373) | \*/ |
| [1374](#L1374) | static function free\_download\_button( $id, $link\_label, $class = 'btn btn-lg btn-info btn-block' ) { |
| [1375](#L1375) | return "<a href='" . home\_url( '/?wpdmdlfree=' . $id ) . "' class='{$class}' >" . $link\_label . "</a>"; |
| [1376](#L1376) | } |
| [1377](#L1377) |  |
| [1378](#L1378) |  |
| [1379](#L1379) | function downloadLink( $link, $package ) { |
| [1380](#L1380) | $effective\_price = wpdmpp\_effective\_price( $package['ID'] ); |
| [1381](#L1381) | if ( $effective\_price > 0 ) { |
| [1382](#L1382) |  |
| [1383](#L1383) | if ( wpdm\_valueof( $package, 'template\_type' ) === 'link' ) { |
| [1384](#L1384) | return wpdmpp\_waytocart( $package ) . print\_r( $package, 1 ); |
| [1385](#L1385) | } else { |
| [1386](#L1386) | return wpdmpp\_add\_to\_cart\_html( $package['ID'] ); |
| [1387](#L1387) | } |
| [1388](#L1388) | } |
| [1389](#L1389) |  |
| [1390](#L1390) | return $link; |
| [1391](#L1391) | } |
| [1392](#L1392) |  |
| [1393](#L1393) |  |
| [1394](#L1394) | /\*\* |
| [1395](#L1395) | \* @param $vars |
| [1396](#L1396) | \* |
| [1397](#L1397) | \* @return mixed |
| [1398](#L1398) | \*/ |
| [1399](#L1399) | function fetchTemplateTag( $vars ) { |
| [1400](#L1400) | global $wpdb, $wpdmpp\_settings; |
| [1401](#L1401) |  |
| [1402](#L1402) | $effective\_price           = wpdmpp\_effective\_price( $vars['ID'] ); |
| [1403](#L1403) | $vars['effective\_price']   = $effective\_price; |
| [1404](#L1404) | $vars['currency']          = wpdmpp\_currency\_sign(); |
| [1405](#L1405) | $vars['currency\_code']     = wpdmpp\_currency\_code(); |
| [1406](#L1406) | $vars['free\_download\_btn'] = ""; |
| [1407](#L1407) |  |
| [1408](#L1408) | if ( ! isset( $vars['post\_author'] ) ) { |
| [1409](#L1409) | $product = (array) get\_post( $vars['ID'] ); |
| [1410](#L1410) | $vars    += $product; |
| [1411](#L1411) | } |
| [1412](#L1412) | $store = get\_user\_meta( $vars['post\_author'], '\_\_wpdm\_public\_profile', true ); |
| [1413](#L1413) | if ( ! isset( $vars['author\_name'] ) ) { |
| [1414](#L1414) | $author = get\_userdata( $vars['post\_author'] ); |
| [1415](#L1415) | if ( $author ) { |
| [1416](#L1416) | $vars['author\_name'] = $author->display\_name; |
| [1417](#L1417) | } |
| [1418](#L1418) | } |
| [1419](#L1419) | $vars['store\_name']  = isset( $store['title'] ) ? $store['title'] : $vars['author\_name']; |
| [1420](#L1420) | $vars['store\_intro'] = isset( $store['intro'] ) ? $store['intro'] : ''; |
| [1421](#L1421) | $vars['store\_logo']  = isset( $store['logo'] ) && $store['logo'] != '' ? "<img class='store-logo' src='{$store['logo']}' alt='{$vars['store\_name']}' />" : get\_avatar( $vars['post\_author'], 512 ); |
| [1422](#L1422) |  |
| [1423](#L1423) | if ( $effective\_price > 0 && self::hasFreeFile( $vars['ID'] ) ) { |
| [1424](#L1424) | $vars['free\_download\_btn'] = self::free\_download\_button( $vars['ID'], $vars['link\_label'] ); |
| [1425](#L1425) | $vars['free\_download\_url'] = home\_url( '/?wpdmdlfree=' . $vars['ID'] ); |
| [1426](#L1426) | } else { |
| [1427](#L1427) | $vars['free\_download\_btn'] = $vars['free\_download\_url'] = ''; |
| [1428](#L1428) | } |
| [1429](#L1429) | if ( $effective\_price > 0 || get\_post\_meta( $vars['ID'], '\_\_wpdm\_pay\_as\_you\_want', true ) == 1 ) { |
| [1430](#L1430) | $vars['base\_price']             = wpdmpp\_price\_format( get\_post\_meta( $vars['ID'], '\_\_wpdm\_base\_price', true ) ); |
| [1431](#L1431) | $vars['sales\_price']            = wpdmpp\_price\_format( get\_post\_meta( $vars['ID'], '\_\_wpdm\_sales\_price', true ) ); |
| [1432](#L1432) | $vars['addtocart\_url']          = wpdmpp\_cart\_page( array( 'addtocart' => $vars['ID'] ) ); |
| [1433](#L1433) | $vars['addtocart\_link']         = wpdmpp\_waytocart( $vars ); |
| [1434](#L1434) | $vars['addtocart\_button']       = $vars['addtocart\_link']; |
| [1435](#L1435) | $vars['addtocart\_form']         = wpdmpp\_add\_to\_cart\_html( $vars['ID'] ); |
| [1436](#L1436) | $vars['customer\_download\_link'] = $this->customerDownloadLink( $vars['ID'] ); |
| [1437](#L1437) | if ( isset( $vars['\_\_template\_type'] ) && $vars['\_\_template\_type'] == 'link' ) { |
| [1438](#L1438) | $vars['download\_link'] = $vars['addtocart\_button']; |
| [1439](#L1439) | } else { |
| [1440](#L1440) | $vars['download\_link'] = $vars['addtocart\_form']; |
| [1441](#L1441) | } |
| [1442](#L1442) | $vars['download\_link\_extended'] = $vars['addtocart\_form']; |
| [1443](#L1443) | $vars['download\_link\_popup']    = $vars['addtocart\_button']; |
| [1444](#L1444) | $vars['price\_range']            = wpdmpp\_price\_range( $vars['ID'] ); |
| [1445](#L1445) | } else { |
| [1446](#L1446) | $vars['addtocart\_url']          = $vars['download\_url']; |
| [1447](#L1447) | $vars['addtocart\_link']         = $vars['download\_link']; |
| [1448](#L1448) | $vars['addtocart\_form']         = $vars['download\_link']; |
| [1449](#L1449) | $vars['customer\_download\_link'] = $vars['download\_link']; |
| [1450](#L1450) | $vars['price\_range']            = wpdmpp\_currency\_sign() . '0.00'; |
| [1451](#L1451) | $vars['sales\_price']            = $vars['base\_price'] = ''; |
| [1452](#L1452) | } |
| [1453](#L1453) |  |
| [1454](#L1454) | return $vars; |
| [1455](#L1455) | } |
| [1456](#L1456) |  |
| [1457](#L1457) | function template\_editor\_menu() { |
| [1458](#L1458) | ?> |
| [1459](#L1459) | <li class="dropdown"> |
| [1460](#L1460) | <a href="#" id="droppp" role="button" class="dropdown-toggle" |
| [1461](#L1461) | data-toggle="dropdown"><?php \_e( 'Premium Package', 'wpdm-premium-packages' ); ?><b |
| [1462](#L1462) | class="caret"></b></a> |
| [1463](#L1463) | <ul class="dropdown-menu" role="menu" aria-labelledby="droppp"> |
| [1464](#L1464) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1465](#L1465) | href="#[addtocart\_url]"><?php \_e( 'AddToCart URL', 'wpdm-premium-packages' ); ?></a> |
| [1466](#L1466) | </li> |
| [1467](#L1467) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1468](#L1468) | href="#[addtocart\_link]"><?php \_e( 'AddToCart Link', 'wpdm-premium-packages' ); ?></a> |
| [1469](#L1469) | </li> |
| [1470](#L1470) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1471](#L1471) | href="#[addtocart\_form]"><?php \_e( 'AddToCart Form', 'wpdm-premium-packages' ); ?></a> |
| [1472](#L1472) | </li> |
| [1473](#L1473) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1474](#L1474) | href="#[customer\_download\_link]"><?php \_e( 'Customer Download Link', 'wpdm-premium-packages' ); ?></a> |
| [1475](#L1475) | </li> |
| [1476](#L1476) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1477](#L1477) | href="#[free\_download\_url]"><?php \_e( 'Free Download Button', 'wpdm-premium-packages' ); ?></a> |
| [1478](#L1478) | </li> |
| [1479](#L1479) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1480](#L1480) | href="#[free\_download\_btn]"><?php \_e( 'Free Download URL', 'wpdm-premium-packages' ); ?></a> |
| [1481](#L1481) | </li> |
| [1482](#L1482) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1483](#L1483) | href="#[price\_range]"><?php \_e( 'Price Range', 'wpdm-premium-packages' ); ?></a> |
| [1484](#L1484) | </li> |
| [1485](#L1485) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1486](#L1486) | href="#[premium\_file\_list]"><?php \_e( 'File List Price', 'wpdm-premium-packages' ); ?></a> |
| [1487](#L1487) | </li> |
| [1488](#L1488) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1489](#L1489) | href="#[effective\_price]"><?php \_e( 'Effective Item Price', 'wpdm-premium-packages' ); ?></a> |
| [1490](#L1490) | </li> |
| [1491](#L1491) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1492](#L1492) | href="#[currency\_code]"><?php \_e( 'Currency Code', 'wpdm-premium-packages' ); ?></a> |
| [1493](#L1493) | </li> |
| [1494](#L1494) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1495](#L1495) | href="#[currency]"><?php \_e( 'Currency Sign', 'wpdm-premium-packages' ); ?></a> |
| [1496](#L1496) | </li> |
| [1497](#L1497) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1498](#L1498) | href="#[base\_price]"><?php \_e( 'Base Price', 'wpdm-premium-packages' ); ?></a> |
| [1499](#L1499) | </li> |
| [1500](#L1500) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1501](#L1501) | href="#[sales\_price]"><?php \_e( 'Sales Price', 'wpdm-premium-packages' ); ?></a> |
| [1502](#L1502) | </li> |
| [1503](#L1503) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1504](#L1504) | href="#[store\_name]"><?php \_e( 'Shop Name', 'wpdm-premium-packages' ); ?></a> |
| [1505](#L1505) | </li> |
| [1506](#L1506) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1507](#L1507) | href="#[store\_intro]"><?php \_e( 'Shop Intro', 'wpdm-premium-packages' ); ?></a> |
| [1508](#L1508) | </li> |
| [1509](#L1509) | <li role="presentation"><a role="menuitem" tabindex="-1" |
| [1510](#L1510) | href="#[store\_logo]"><?php \_e( 'Shop Logo', 'wpdm-premium-packages' ); ?></a> |
| [1511](#L1511) | </li> |
| [1512](#L1512) | </ul> |
| [1513](#L1513) | </li> |
| [1514](#L1514) |  |
| [1515](#L1515) | <?php |
| [1516](#L1516) | } |
| [1517](#L1517) |  |
| [1518](#L1518) | function template\_tag\_row() { |
| [1519](#L1519) | ?> |
| [1520](#L1520) | <tr> |
| [1521](#L1521) | <td><input type="text" readonly="readonly" class="form-control" onclick="this.select()" |
| [1522](#L1522) | value="[addtocart\_url]" style="font-size:10px;width: 120px;text-align: center;"></td> |
| [1523](#L1523) | <td>- <?php echo \_\_( 'AddToCart URL for a package', 'wpdm-premium-packages' ); ?></td> |
| [1524](#L1524) | </tr> |
| [1525](#L1525) | <tr> |
| [1526](#L1526) | <td><input type="text" readonly="readonly" class="form-control" onclick="this.select()" |
| [1527](#L1527) | value="[addtocart\_link]" style="font-size:10px;width: 120px;text-align: center;"></td> |
| [1528](#L1528) | <td>- <?php echo \_\_( 'AddToCart Link for a package', 'wpdm-premium-packages' ); ?></td> |
| [1529](#L1529) | </tr> |
| [1530](#L1530) | <tr> |
| [1531](#L1531) | <td><input type="text" readonly="readonly" class="form-control" onclick="this.select()" |
| [1532](#L1532) | value="[addtocart\_form]" style="font-size:10px;width: 120px;text-align: center;"></td> |
| [1533](#L1533) | <td>- <?php echo \_\_( 'AddToCart Form', 'wpdm-premium-packages' ); ?></td> |
| [1534](#L1534) | </tr> |
| [1535](#L1535) | <tr> |
| [1536](#L1536) | <td><input type="text" readonly="readonly" class="form-control" onclick="this.select()" |
| [1537](#L1537) | value="[customer\_download\_link]" style="font-size:10px;width: 120px;text-align: center;"> |
| [1538](#L1538) | </td> |
| [1539](#L1539) | <td>- <?php echo \_\_( 'Customer Download Link', 'wpdm-premium-packages' ); ?></td> |
| [1540](#L1540) | </tr> |
| [1541](#L1541) | <tr> |
| [1542](#L1542) | <td><input type="text" readonly="readonly" class="form-control" onclick="this.select()" |
| [1543](#L1543) | value="[free\_download\_btn]" style="font-size:10px;width: 120px;text-align: center;"></td> |
| [1544](#L1544) | <td>- <?php echo \_\_( 'Free Download Button', 'wpdm-premium-packages' ); ?></td> |
| [1545](#L1545) | </tr> |
| [1546](#L1546) | <tr> |
| [1547](#L1547) | <td><input type="text" readonly="readonly" class="form-control" onclick="this.select()" |
| [1548](#L1548) | value="[free\_download\_url]" style="font-size:10px;width: 120px;text-align: center;"></td> |
| [1549](#L1549) | <td>- <?php echo \_\_( 'Free Download URL', 'wpdm-premium-packages' ); ?></td> |
| [1550](#L1550) | </tr> |
| [1551](#L1551) | <?php |
| [1552](#L1552) | } |
| [1553](#L1553) |  |
| [1554](#L1554) | /\*\* |
| [1555](#L1555) | \* Required for guest checkout |
| [1556](#L1556) | \*/ |
| [1557](#L1557) | function wpdmpp\_invoice\_field() { |
| [1558](#L1558) | $oid = Session::get( "orderid" ); |
| [1559](#L1559) | if ( $oid ) { |
| [1560](#L1560) | echo "<input type='hidden' name='invoice' value='" . sanitize\_text\_field( $oid ) . "' />"; |
| [1561](#L1561) | } |
| [1562](#L1562) | } |
| [1563](#L1563) |  |
| [1564](#L1564) | /\*\* |
| [1565](#L1565) | \* Link Guest Order when user logging in |
| [1566](#L1566) | \* |
| [1567](#L1567) | \* @param $user\_login |
| [1568](#L1568) | \* @param $user |
| [1569](#L1569) | \*/ |
| [1570](#L1570) | function wpdmpp\_associate\_invoice( $user\_login, $user ) { |
| [1571](#L1571) | if ( isset( $\_POST['invoice'] ) ) { |
| [1572](#L1572) | $order     = new Order(); |
| [1573](#L1573) | $orderdata = $order->getOrder( sanitize\_text\_field( $\_POST['invoice'] ) ); |
| [1574](#L1574) | if ( $orderdata && intval( $orderdata->uid ) == 0 ) { |
| [1575](#L1575) | Order::Update( array( 'uid' => $user->ID ), sanitize\_text\_field( $\_POST['invoice'] ) ); |
| [1576](#L1576) | } |
| [1577](#L1577) | } |
| [1578](#L1578) | } |
| [1579](#L1579) |  |
| [1580](#L1580) | /\*\* |
| [1581](#L1581) | \* Link Guest Order when user Signing Up |
| [1582](#L1582) | \* |
| [1583](#L1583) | \* @param $user\_id |
| [1584](#L1584) | \*/ |
| [1585](#L1585) | function wpdmpp\_associate\_invoice\_signup( $user\_id ) { |
| [1586](#L1586) | if ( isset( $\_POST['invoice'] ) ) { |
| [1587](#L1587) | $order     = new Order(); |
| [1588](#L1588) | $orderdata = $order->getOrder( sanitize\_text\_field( $\_POST['invoice'] ) ); |
| [1589](#L1589) | if ( $orderdata && intval( $orderdata->uid ) == 0 ) { |
| [1590](#L1590) | Order::Update( array( 'uid' => $user\_id ), sanitize\_text\_field( $\_POST['invoice'] ) ); |
| [1591](#L1591) | User::addCustomer( $user\_id ); |
| [1592](#L1592) | } |
| [1593](#L1593) | } |
| [1594](#L1594) | } |
| [1595](#L1595) |  |
| [1596](#L1596) | /\*\* |
| [1597](#L1597) | \* Resolve unassigned Order |
| [1598](#L1598) | \*/ |
| [1599](#L1599) | function wpdmpp\_resolveorder() { |
| [1600](#L1600) | $current\_user = wp\_get\_current\_user(); |
| [1601](#L1601) | $order        = new Order(); |
| [1602](#L1602) | $data         = $order->getOrder( sanitize\_text\_field( $\_REQUEST['orderid'] ) ); |
| [1603](#L1603) | if ( ! $data ) { |
| [1604](#L1604) | die( "Order not found!" ); |
| [1605](#L1605) | } |
| [1606](#L1606) | if ( $data->uid != 0 ) { |
| [1607](#L1607) | if ( $data->uid == $current\_user->ID ) { |
| [1608](#L1608) | die( "The order is already linked to your account!" ); |
| [1609](#L1609) | } else { |
| [1610](#L1610) | die( "The order is already linked to an account!" ); |
| [1611](#L1611) | } |
| [1612](#L1612) | } |
| [1613](#L1613) | Order::Update( array( 'uid' => $current\_user->ID ), $data->order\_id ); |
| [1614](#L1614) | User::addCustomer(); |
| [1615](#L1615) | die( "ok" ); |
| [1616](#L1616) | } |
| [1617](#L1617) |  |
| [1618](#L1618) | /\*\* |
| [1619](#L1619) | \* Filter for locked Downloads |
| [1620](#L1620) | \* |
| [1621](#L1621) | \* @param $lock |
| [1622](#L1622) | \* @param $id |
| [1623](#L1623) | \* |
| [1624](#L1624) | \* @return string |
| [1625](#L1625) | \*/ |
| [1626](#L1626) | function lockDownload( $lock, $id ) { |
| [1627](#L1627) | $effective\_price = wpdmpp\_effective\_price( $id ); |
| [1628](#L1628) | if ( intval( $effective\_price ) > 0 ) { |
| [1629](#L1629) | $lock = 'locked'; |
| [1630](#L1630) | } |
| [1631](#L1631) |  |
| [1632](#L1632) | return $lock; |
| [1633](#L1633) | } |
| [1634](#L1634) |  |
| [1635](#L1635) | function wpdmpp\_guest\_download\_link() { |
| [1636](#L1636) | global $wp\_query; |
| [1637](#L1637) |  |
| [1638](#L1638) | if ( isset( $wp\_query->query\_vars['udb\_page'] ) && strstr( $wp\_query->query\_vars['udb\_page'], 'purchases' ) && wpdmpp\_guest\_order\_page() ): |
| [1639](#L1639) | include\_once \WPDM\\_\_\Template::locate( "partials/guest\_order\_page\_link.php", WPDMPP\_TPL\_DIR ); |
| [1640](#L1640) | endif; |
| [1641](#L1641) | } |
| [1642](#L1642) |  |
| [1643](#L1643) | function toggleAutoRenew() { |
| [1644](#L1644) | if ( isset( $\_REQUEST['\_\_arnonce'] ) && wp\_verify\_nonce( $\_REQUEST['\_\_arnonce'], NONCE\_KEY ) ) { |
| [1645](#L1645) | $order = new Order( sanitize\_text\_field( $\_REQUEST['orderid'] ) ); |
| [1646](#L1646) | $renew = (int)$order->auto\_renew === 1 ? 0 : 1; |
| [1647](#L1647) | $order->set( 'auto\_renew', $renew ); |
| [1648](#L1648) | $order->save(); |
| [1649](#L1649) | $dt = array( 'renew' => $renew ); |
| [1650](#L1650) | $pm = "\WPDMPP\Libs\PaymentMethods\\" . $order->payment\_method; |
| [1651](#L1651) | if ( class\_exists( $pm ) && $renew == 0 ) { |
| [1652](#L1652) | $pm                   = new $pm(); |
| [1653](#L1653) | $dt['payment\_method'] = $order->payment\_method; |
| [1654](#L1654) | if ( method\_exists( $pm, 'cancelSubscription' ) ) { |
| [1655](#L1655) | $pm->cancelSubscription( $order->order\_id ); |
| [1656](#L1656) | $dt['canceled'] = 1; |
| [1657](#L1657) | } |
| [1658](#L1658) |  |
| [1659](#L1659) | } |
| [1660](#L1660) | header( "Content-type: application/json" ); |
| [1661](#L1661) | echo json\_encode( $dt ); |
| [1662](#L1662) | } else { |
| [1663](#L1663) | echo json\_encode( array( 'error' => 'Session Expired!' ) ); |
| [1664](#L1664) | } |
| [1665](#L1665) | die(); |
| [1666](#L1666) | } |
| [1667](#L1667) |  |
| [1668](#L1668) | function toggleManualRenew() { |
| [1669](#L1669) | if ( isset( $\_REQUEST['\_\_mrnonce'] ) && wp\_verify\_nonce( $\_REQUEST['\_\_mrnonce'], NONCE\_KEY ) ) { |
| [1670](#L1670) | $orderID = sanitize\_text\_field( $\_REQUEST['orderid'] ); |
| [1671](#L1671) | $mrenew  = (int) Order::getMeta( $orderID, 'manual\_renew' ); |
| [1672](#L1672) | $mrenew  = $mrenew ? 0 : 1; |
| [1673](#L1673) | Order::updateMeta( $orderID, 'manual\_renew', $mrenew ); |
| [1674](#L1674) | wp\_send\_json( [ 'success' => true, 'mrenew' => $mrenew ] ); |
| [1675](#L1675) | } else { |
| [1676](#L1676) | wp\_send\_json( [  'error' => 'Session Expired!' ] ); |
| [1677](#L1677) | } |
| [1678](#L1678) | die(); |
| [1679](#L1679) | } |
| [1680](#L1680) |  |
| [1681](#L1681) | function cancel\_subscription() { |
| [1682](#L1682) | if ( isset( $\_REQUEST['\_\_cansub'] ) && wp\_verify\_nonce( $\_REQUEST['\_\_cansub'], NONCE\_KEY ) ) { |
| [1683](#L1683) | $order = new Order( sanitize\_text\_field( $\_REQUEST['orderid'] ) ); |
| [1684](#L1684) | $renew = 0; |
| [1685](#L1685) | $order->set( 'auto\_renew', $renew ); |
| [1686](#L1686) | $order->save(); |
| [1687](#L1687) | $dt = array( 'renew' => $renew ); |
| [1688](#L1688) | $pm = "\WPDMPP\Libs\PaymentMethods\\" . $order->payment\_method; |
| [1689](#L1689) | if ( class\_exists( $pm ) ) { |
| [1690](#L1690) | $pm                   = new $pm(); |
| [1691](#L1691) | $dt['payment\_method'] = $order->payment\_method; |
| [1692](#L1692) | if ( method\_exists( $pm, 'cancelSubscription' ) ) { |
| [1693](#L1693) | $pm->cancelSubscription( $order->order\_id ); |
| [1694](#L1694) | $dt['canceled'] = 1; |
| [1695](#L1695) | } |
| [1696](#L1696) |  |
| [1697](#L1697) | } |
| [1698](#L1698) | $message = "Subscription Canceled For Order# {$order->oid}<br/><a style='background-color:#19B999;border:none;border-radius:3px;color:#ffffff !important;display:inline-block;font-size:14px;font-weight:bold;outline:none!important;padding:5px 15px;margin:10px auto;text-decoration:none;' href='" . admin\_url( "/edit.php?post\_type=wpdmpro&page=orders&task=vieworder&id={$order->oid}" ) . "'>View Order</a>"; |
| [1699](#L1699) | $params  = array( |
| [1700](#L1700) | 'subject'  => "Subscription Canceled: Order# {$order->oid}", |
| [1701](#L1701) | 'to\_email' => get\_option( "admin\_email" ), |
| [1702](#L1702) | 'message'  => $message |
| [1703](#L1703) | ); |
| [1704](#L1704) | \WPDM\\_\_\Email::send( 'default', $params ); |
| [1705](#L1705) | header( "Content-type: application/json" ); |
| [1706](#L1706) | echo json\_encode( $dt ); |
| [1707](#L1707) | die(); |
| [1708](#L1708) | } else { |
| [1709](#L1709) | echo json\_encode( array( 'error' => 'Session Expired!' ) ); |
| [1710](#L1710) | } |
| [1711](#L1711) | die(); |
| [1712](#L1712) | } |
| [1713](#L1713) |  |
| [1714](#L1714) |  |
| [1715](#L1715) | function privacy\_settings() { |
| [1716](#L1716) | ?> |
| [1717](#L1717) | <div class="panel panel-default"> |
| [1718](#L1718) | <div class="panel-heading"><?php \_e( 'Checkout Settings', 'wpdm-premium-packages' ); ?></div> |
| [1719](#L1719) | <div class="panel-body"> |
| [1720](#L1720) |  |
| [1721](#L1721) | <div class="form-group"> |
| [1722](#L1722) | <input type="hidden" value="0" name="\_\_wpdm\_checkout\_privacy"/> |
| [1723](#L1723) | <label><input style="margin: 0 10px 0 0" |
| [1724](#L1724) | type="checkbox" <?php checked( get\_option( '\_\_wpdm\_checkout\_privacy' ), 1 ); ?> |
| [1725](#L1725) | value="1" |
| [1726](#L1726) | name="\_\_wpdm\_checkout\_privacy"><?php \_e( 'Must agree with privacy policy before checkout', 'wpdm-premium-packages' ); ?> |
| [1727](#L1727) | </label><br/> |
| [1728](#L1728) | <em><?php \_e( 'User must agree with privacy policy before they purchase any item', 'wpdm-premium-packages' ); ?></em> |
| [1729](#L1729) | </div> |
| [1730](#L1730) | <div class="form-group"> |
| [1731](#L1731) | <label><?php \_e( 'Privacy policy label:', 'wpdm-premium-packages' ); ?></label> |
| [1732](#L1732) | <input type="text" class="form-control" |
| [1733](#L1733) | value="<?php echo get\_option( '\_\_wpdm\_checkout\_privacy\_label' ); ?>" |
| [1734](#L1734) | name="\_\_wpdm\_checkout\_privacy\_label"> |
| [1735](#L1735) | </div> |
| [1736](#L1736) |  |
| [1737](#L1737) | </div> |
| [1738](#L1738) | </div> |
| [1739](#L1739) |  |
| [1740](#L1740) | <?php |
| [1741](#L1741) | } |
| [1742](#L1742) |  |
| [1743](#L1743) |  |
| [1744](#L1744) | function expire\_orders() { |
| [1745](#L1745) | if ( current\_user\_can( WPDMPP\_ADMIN\_CAP ) ) { |
| [1746](#L1746) | $oids = $\_REQUEST['oids']; |
| [1747](#L1747) | foreach ( $oids as $oid ) { |
| [1748](#L1748) | Order::expireOrder( $oid ); |
| [1749](#L1749) | } |
| [1750](#L1750) | } |
| [1751](#L1751) | die( 'Done!' ); |
| [1752](#L1752) | } |
| [1753](#L1753) |  |
| [1754](#L1754) | function email\_payment\_link() { |
| [1755](#L1755) | $price       = \_\_::query\_var( 'price', 'double' ); |
| [1756](#L1756) | $name        = \_\_::query\_var( 'name', 'txt' ); |
| [1757](#L1757) | $desc        = \_\_::query\_var( 'desc', 'txt' ); |
| [1758](#L1758) | $plink       = home\_url( "/??addtocart=dynamic&price={$price}&name={$name}&desc={$desc}&recurring=0" ); |
| [1759](#L1759) | $paymentinfo = "<small style='color: #aaaaaa'>" . \_\_( 'Reason', WPDMPP\_TEXT\_DOMAIN ) . "</small><br/>{$name}<hr style='border-top:0;border-bottom: 1px solid #dddddd;box-shadow: none'/><small style='color: #aaaaaa'>" . \_\_( 'Description', WPDMPP\_TEXT\_DOMAIN ) . "</small><br/>{$desc}<hr style='border-top:0;border-bottom: 1px solid #dddddd;box-shadow: none'/><small style='color: #aaaaaa'>" . \_\_( 'Payment Amount', WPDMPP\_TEXT\_DOMAIN ) . "</small><h3 style='margin: 0'>" . wpdmpp\_price\_format( $price ) . "</h3>"; |
| [1760](#L1760) | $msg         = \_\_MailUI::panel( \_\_( 'Payment request', WPDMPP\_TEXT\_DOMAIN ), [ wpautop( \_\_::query\_var( 'msg', 'kses' ) ) ] ) . "<div style='height: 15px;display: block'></div>"; |
| [1761](#L1761) | $msg         .= \_\_MailUI::panel( \_\_( 'Payment details', WPDMPP\_TEXT\_DOMAIN ), [ $paymentinfo ] ) . '<a class="button" style="display:block;text-align:center" href="' . $plink . '">' . \_\_( 'Proceed to payment', WPDMPP\_TEXT\_DOMAIN ) . '</a>'; |
| [1762](#L1762) | $params      = [ |
| [1763](#L1763) | 'to\_email' => \_\_::query\_var( 'emails', 'txt' ), |
| [1764](#L1764) | 'subject'  => sprintf( \_\_( 'Payment request from %s', WPDMPP\_TEXT\_DOMAIN ), get\_option( 'blogname' ) ), |
| [1765](#L1765) | 'message'  => $msg |
| [1766](#L1766) | ]; |
| [1767](#L1767) | Email::send( "default", $params ); |
| [1768](#L1768) | wp\_send\_json( [ 'success' => true ] ); |
| [1769](#L1769) | } |
| [1770](#L1770) |  |
| [1771](#L1771) | function active\_payment\_gateways() { |
| [1772](#L1772) | global $payment\_methods; |
| [1773](#L1773) | $settings        = maybe\_unserialize( get\_option( '\_wpdmpp\_settings' ) ); |
| [1774](#L1774) | $payment\_methods = apply\_filters( 'payment\_method', $payment\_methods ); |
| [1775](#L1775) | $payment\_methods = isset( $settings['pmorders'] ) && count( $settings['pmorders'] ) == count( $payment\_methods ) ? $settings['pmorders'] : $payment\_methods; |
| [1776](#L1776) |  |
| [1777](#L1777) | return $payment\_methods; |
| [1778](#L1778) | } |
| [1779](#L1779) |  |
| [1780](#L1780) |  |
| [1781](#L1781) | } |
| [1782](#L1782) |  |
| [1783](#L1783) | endif; |
| [1784](#L1784) |  |
| [1785](#L1785) | if ( defined( 'WPDM\_VERSION' ) ) |
| [1786](#L1786) | $wpdmpp = new WPDMPremiumPackage(); |
| [1787](#L1787) | else { |
| [1788](#L1788) | class RequireWPDM { |
| [1789](#L1789) |  |
| [1790](#L1790) | function \_\_construct() { |
| [1791](#L1791) | add\_action( 'admin\_notices', array( $this, 'check' ) ); |
| [1792](#L1792) | } |
| [1793](#L1793) |  |
| [1794](#L1794) | function check() { |
| [1795](#L1795) | $class   = 'notice notice-error'; |
| [1796](#L1796) | $message = '<strong>Missing a required plugin!</strong><br/>Please install/activate <a href="' . admin\_url( '/plugin-install.php?tab=favorites&user=codename065' ) . '" target="\_blank"><strong>WordPress Download Manager</strong></a> to use WPDM - Premium Packages plugin'; |
| [1797](#L1797) | printf( '<div class="%1$s"><p>%2$s</p></div>', esc\_attr( $class ), ( $message ) ); |
| [1798](#L1798) | } |
| [1799](#L1799) | } |
| [1800](#L1800) |  |
| [1801](#L1801) | new RequireWPDM(); |
| [1802](#L1802) | } |
| [1803](#L1803) |  |
| [1804](#L1804) |  |
| [1805](#L1805) |  |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wpdm-premium-packages/tags/5.7.4/wpdm-premium-packages.php?format=txt)
* [Original Format](/export/3222508/wpdm-premium-packages/tags/5.7.4/wpdm-premium-packages.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_4a999300_20250114_231030.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Premium Packages - Sell Digital Products Securely <= 5.7.4 - Arbitrary User Meta Update to Authenticated (Subscriber+) Privilege Escalation

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Premium Packages - Sell Digital Products Securely <= 5.7.4 - Arbitrary User Meta Update to Authenticated (Subscriber+) Privilege Escalation

8.8

**Improper Privilege Management**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-4293](https://www.cve.org/CVERecord?id=CVE-2023-4293) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | August 11, 2023 |
| Last Updated | August 12, 2023 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Premium Packages - Sell Digital Products Securely plugin for WordPress is vulnerable to privilege escalation in versions up to, and including, 5.7.4 due to insufficient restriction on the 'wpdmpp\_update\_profile' function. This makes it possible for authenticated attackers, with minimal permissions such as a subscriber, to modify their user role by supplying the 'profile[role]' parameter during a profile update.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wpdm-premium-packages/tags/5.7.4/wpdm-premium-packages.php#L1158)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2951917/wpdm-premium-packages#file5)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdm-premium-packages%2Fpremium-packages-sell-digital-products-securely-574-arbitrary-user-meta-update-to-authenticated-subscriber-privilege-escalation&t=Premium%20Packages%20-%20Sell%20Digital%20Products%20Securely%20%3C%3D%205.7.4%20-%20Arbitrary%20User%20Meta%20Update%20to%20Authenticated%20%28Subscriber%2B%29%20Privilege%20Escalation "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdm-premium-packages%2Fpremium-packages-sell-digital-products-securely-574-arbitrary-user-meta-update-to-authenticated-subscriber-privilege-escalation&text=Premium%20Packages%20-%20Sell%20Digital%20Products%20Securely%20%3C%3D%205.7.4%20-%20Arbitrary%20User%20Meta%20Update%20to%20Authenticated%20%28Subscriber%2B%29%20Privilege%20Escalation "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdm-premium-packages%2Fpremium-packages-sell-digital-products-securely-574-arbitrary-user-meta-update-to-authenticated-subscriber-privilege-escalation "LinkedIn")
Email

## Vulnerability Details for Premium Packages – Sell Digital Products Securely

#### [Premium Packages – Sell Digital Products Securely](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wpdm-premium-packages)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wpdm-premium-packages [(view on wordpress.org)](https://wordpress.org/plugins/wpdm-premium-packages) |
| Patched? | Yes |
| Remediation | Update to version 5.7.5, or a newer patched version |
| Affected Version | * <= 5.7.4 |
| Patched Version | * 5.7.5 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_4add0667_20250114_231029.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2951917%2Fwpdm-premium-packages)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2949238/wpdm-premium-packages "Changeset 2949238 for wpdm-premium-packages")
* [Next Change](/changeset/2951918/wpdm-premium-packages "Changeset 2951918 for wpdm-premium-packages") →

---

# Changeset [2951917](/changeset/2951917 "Show full changeset") for [wpdm-premium-packages](/browser/wpdm-premium-packages?rev=2951917 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/11/2023 03:39:31 AM
([17 months](/timeline?from=2023-08-11T03%3A39%3A31Z&precision=second "See timeline at 08/11/2023 03:39:31 AM") ago)

Author:
codename065
Message:
# 5.7.5 - 2023.08.11

* Fixed a PHP 8.2 compatibility issue
* Fixed an arbitrary user meta update vulnerability issue, reported by Wordfance

Location:
[wpdm-premium-packages/trunk](/browser/wpdm-premium-packages/trunk?rev=2951917)
Files:

1 deleted
5 edited

* [includes/libs/CustomActions.php](/browser/wpdm-premium-packages/trunk/includes/libs/CustomActions.php?rev=2951917 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [includes/libs/ShortCodes.php](/browser/wpdm-premium-packages/trunk/includes/libs/ShortCodes.php?rev=2951917 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [readme.txt](/browser/wpdm-premium-packages/trunk/readme.txt?rev=2951917 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [templates/partials/user-order-details.php](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2951917 "Show entry in browser")
  (modified)
  ([4 diffs](#file3 "Show differences"))
* [templates/wpdm-pp-edit-profile.php](/browser/wpdm-premium-packages/trunk/templates/wpdm-pp-edit-profile.php?rev=2695298 "Show what was removed (content at revision 2951916)")
  (deleted)
* [wpdm-premium-packages.php](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2951917 "Show entry in browser")
  (modified)
  ([5 diffs](#file5 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wpdm-premium-packages/trunk/includes/libs/CustomActions.php](/changeset/2951917/wpdm-premium-packages/trunk/includes/libs/CustomActions.php "Show the changeset 2951917 restricted to wpdm-premium-packages/trunk/includes/libs/CustomActions.php")

  | [r2949237](/browser/wpdm-premium-packages/trunk/includes/libs/CustomActions.php?rev=2949237#L262 "Show revision 2949237 of this file in browser") | [r2951917](/browser/wpdm-premium-packages/trunk/includes/libs/CustomActions.php?rev=2951917#L262 "Show revision 2951917 of this file in browser") |  |
  | --- | --- | --- |
  | 262 | 262 | ob\_start(); |
  | 263 | 263 | $billing\_required = isset($payment->Processor->billing) ? (int)$payment->Processor->billing : 0; |
  | 264 |  | $billing = ~~array()~~; |
  |  | 264 | $billing = []; |
  | 265 | 265 | if(is\_user\_logged\_in()) { |
  | 266 | 266 | $billing          = maybe\_unserialize( get\_user\_meta( get\_current\_user\_id(), 'user\_billing\_shipping', true ) ); |
  | 267 | 267 | $billing          = is\_array( $billing ) && isset( $billing['billing'] ) ? $billing['billing'] : $billing; |
  |  | 268 | if(!is\_array($billing)) $billing = []; |
  | 268 | 269 | $billing['email'] = isset( $billing['email'] ) ? $billing['email'] : $current\_user->user\_email; |
  | 269 | 270 | } |
* ## [wpdm-premium-packages/trunk/includes/libs/ShortCodes.php](/changeset/2951917/wpdm-premium-packages/trunk/includes/libs/ShortCodes.php "Show the changeset 2951917 restricted to wpdm-premium-packages/trunk/includes/libs/ShortCodes.php")

  | [r2876891](/browser/wpdm-premium-packages/trunk/includes/libs/ShortCodes.php?rev=2876891#L22 "Show revision 2876891 of this file in browser") | [r2951917](/browser/wpdm-premium-packages/trunk/includes/libs/ShortCodes.php?rev=2951917#L22 "Show revision 2951917 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | add\_shortcode( 'wpdmpp\_purchases',          array( $this, 'userPurchases' ) ); |
  | 23 | 23 | add\_shortcode( 'wpdmpp\_guest\_orders',       array( $this, 'guestOrders' ) ); |
  | 24 |  | ~~add\_shortcode( 'wpdmpp\_edit\_profile' ,      array( $this, 'editProfile' ) );~~ |
  | 25 | 24 | add\_shortcode( 'wpdmpp\_buynow' ,            array( $this, 'buyNowHTML' ) ); |
  | 26 | 25 | add\_shortcode( 'wpdmpp\_withdraws' ,      [ new Withdraws(), 'requests' ] ); |
  | […](/browser/wpdm-premium-packages/trunk/includes/libs/ShortCodes.php?rev=2876891#L109) | […](/browser/wpdm-premium-packages/trunk/includes/libs/ShortCodes.php?rev=2951917#L108) |  |
  | 109 | 108 | } |
  | 110 | 109 |  |
  | 111 |  | ~~/\*\*~~ |
  | 112 |  | ~~\* Edit Profile Shortcode Function~~ |
  | 113 |  | ~~\*/~~ |
  | 114 |  | ~~function editProfile()~~ |
  | 115 |  | ~~{~~ |
  | 116 |  | ~~include  Template::locate("wpdm-pp-edit-profile.php", WPDMPP\_TPL\_DIR);~~ |
  | 117 |  | ~~}~~ |
  | 118 |  |  |
  | 119 |  |  |
  | 120 | 110 | function buyNowHTML($params = array()){ |
  | 121 | 111 | ob\_start(); |
* ## [wpdm-premium-packages/trunk/readme.txt](/changeset/2951917/wpdm-premium-packages/trunk/readme.txt "Show the changeset 2951917 restricted to wpdm-premium-packages/trunk/readme.txt")

  | [r2949237](/browser/wpdm-premium-packages/trunk/readme.txt?rev=2949237#L5 "Show revision 2949237 of this file in browser") | [r2951917](/browser/wpdm-premium-packages/trunk/readme.txt?rev=2951917#L5 "Show revision 2951917 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 5.3 |
  | 6 | 6 | Tested up to: 6.3 |
  | 7 |  | Stable tag: 5.7.~~4~~ |
  |  | 7 | Stable tag: 5.7.5 |
  | 8 | 8 |  |
  | 9 | 9 |  |
  | […](/browser/wpdm-premium-packages/trunk/readme.txt?rev=2949237#L112) | […](/browser/wpdm-premium-packages/trunk/readme.txt?rev=2951917#L112) |  |
  | 112 | 112 | == Changelog == |
  | 113 | 113 |  |
  |  | 114 | = 5.7.5 - 2023.08.11 = |
  |  | 115 | \* Fixed a PHP 8.2 compatibility issue |
  |  | 116 | \* Fixed an arbitrary user meta update vulnerability issue, reported by Wordfance |
  |  | 117 |  |
  | 114 | 118 | = 5.7.4 - 2023.08.08 = |
  | 115 | 119 | \* Added option to resend order confirmation email |
* ## [wpdm-premium-packages/trunk/templates/partials/user-order-details.php](/changeset/2951917/wpdm-premium-packages/trunk/templates/partials/user-order-details.php "Show the changeset 2951917 restricted to wpdm-premium-packages/trunk/templates/partials/user-order-details.php")

  | [r2949237](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2949237#L11 "Show revision 2949237 of this file in browser") | [r2951917](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2951917#L11 "Show revision 2951917 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | exit; // Exit if accessed directly |
  | 12 | 12 | } |
  |  | 13 | global $wpdmpp\_settings; |
  | 13 | 14 | $current\_user = wp\_get\_current\_user(); |
  | 14 | 15 | $download\_button\_label = esc\_attr\_\_( 'Download', 'download-manager' ); |
  | […](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2949237#L72) | […](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2951917#L73) |  |
  | 72 | 73 |  |
  | 73 | 74 | foreach ($items as $item) { |
  | 74 |  | $ditem = get\_post($item['pid']); |
  |  | 75 | $ditem = null; |
  |  | 76 | if(wpdm\_valueof($item, 'product\_type') !== 'dynamic') |
  |  | 77 | $ditem = get\_post($item['pid']); |
  | 75 | 78 |  |
  | 76 | 79 | $discount\_r     = $item['role\_discount']; |
  | […](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2949237#L124) | […](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2951917#L127) |  |
  | 124 | 127 | $\_license = wpdm\_valueof($cart, "{$item['pid']}/license/id"); |
  | 125 | 128 | if(!$\_license) $\_license = $starter; |
  | 126 |  | $license\_pack = ~~get\_post\_meta($item['pid'], "\_\_wpdm\_license\_pack", true)~~; |
  |  | 129 | $license\_pack = $ditem ? get\_post\_meta($item['pid'], "\_\_wpdm\_license\_pack", true) : ''; |
  | 127 | 130 | $license\_pack = wpdm\_valueof($license\_pack, $\_license); |
  | 128 | 131 | if(is\_array($license\_pack)) { |
  | […](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2949237#L143) | […](/browser/wpdm-premium-packages/trunk/templates/partials/user-order-details.php?rev=2951917#L146) |  |
  | 143 | 146 |  |
  | 144 | 147 | foreach ($files as $ind => $ff) { |
  | 145 |  | $data = ~~get\_post\_meta($ditem->ID,'\_\_wpdm\_fileinfo', true)~~; |
  |  | 148 | $data = $ditem ? get\_post\_meta($ditem->ID,'\_\_wpdm\_fileinfo', true) : []; |
  | 146 | 149 | $title = isset($data[$ind], $data[$ind]['title']) && !empty($data[$ind]['title']) ? $data[$ind]['title'] : basename($ff); |
  | 147 | 150 | $index = $ind; |
* ## [wpdm-premium-packages/trunk/wpdm-premium-packages.php](/changeset/2951917/wpdm-premium-packages/trunk/wpdm-premium-packages.php "Show the changeset 2951917 restricted to wpdm-premium-packages/trunk/wpdm-premium-packages.php")

  | [r2949237](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2949237#L4 "Show revision 2949237 of this file in browser") | [r2951917](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2951917#L4 "Show revision 2951917 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://www.wpdownloadmanager.com/download/premium-package-complete-digital-store-solution/ |
  | 5 | 5 | \* Description: Complete solution for selling digital products securely and easily |
  | 6 |  | \* Version: 5.7.~~4~~ |
  |  | 6 | \* Version: 5.7.5 |
  | 7 | 7 | \* Author: WordPress Download Manager |
  | 8 | 8 | \* Text Domain: wpdm-premium-packages |
  | […](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2949237#L41) | […](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2951917#L41) |  |
  | 41 | 41 | \*/ |
  | 42 | 42 |  |
  | 43 |  | define( 'WPDMPP\_VERSION', '5.7.~~4~~' ); |
  |  | 43 | define( 'WPDMPP\_VERSION', '5.7.5' ); |
  | 44 | 44 | define( 'WPDMPP\_BASE\_DIR', dirname( \_\_FILE\_\_ ) . '/' ); |
  | 45 | 45 | define( 'WPDMPP\_BASE\_URL', plugins\_url( 'wpdm-premium-packages/' ) ); |
  | […](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2949237#L127) | […](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2951917#L127) |  |
  | 127 | 127 |  |
  | 128 | 128 | add\_action( 'wpdm\_template\_editor\_menu', [ $this, 'template\_editor\_menu' ] ); |
  | 129 |  | //add\_action( 'wpdm\_template\_tag\_row', array( $this, 'template\_tag\_row' )); |
  |  | 129 |  |
  | 130 | 130 |  |
  | 131 | 131 | add\_action( 'init', function () { |
  | […](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2949237#L140) | […](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2951917#L140) |  |
  | 140 | 140 | $this->wpdmpp\_ajax\_payfront(); |
  | 141 | 141 | $this->anync\_execute(); |
  | 142 |  | ~~$this->wpdmpp\_update\_profile();~~ |
  | 143 | 142 | $this->freeDownload(); |
  | 144 | 143 |  |
  | 145 | 144 | } ); |
  | 146 | 145 |  |
  | 147 |  | /\* |
  | 148 |  | add\_action( 'init', array( $this, 'wpdmpp\_languages' ) ); |
  | 149 |  | add\_action( 'init', array( $this, 'invoice' ) ); |
  | 150 |  | add\_action( 'init', array( $this, 'wpdmpp\_process\_guest\_order' ) ); |
  | 151 |  | //add\_action( 'init', array( $this, 'wpdmpp\_download' ), 1); |
  | 152 |  | add\_action( 'init', array( $this, 'paynow' ) ); |
  | 153 |  | add\_action( 'init', array( $this, 'payment\_notification' ) ); |
  | 154 |  | add\_action( 'init', array( $this, 'wpdmpp\_ajax\_payfront' ) ); |
  | 155 |  | add\_action( 'init', array( $this, 'anync\_execute' ) ); |
  | 156 |  | add\_action( 'init', array( $this, 'wpdmpp\_update\_profile' ) ); |
  | 157 |  | add\_action( 'init', array( $this, 'freeDownload' ) ); |
  | 158 |  | \*/ |
  |  | 146 |  |
  | 159 | 147 |  |
  | 160 | 148 | add\_action( 'wpdm\_login\_form', array( $this, 'wpdmpp\_invoice\_field' ) ); |
  | […](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2949237#L1148) | […](/browser/wpdm-premium-packages/trunk/wpdm-premium-packages.php?rev=2951917#L1136) |  |
  | 1148 | 1136 | die(); |
  | 1149 | 1137 | } |
  | 1150 |  | ~~}~~ |
  | 1151 |  |  |
  | 1152 |  | ~~}~~ |
  | 1153 |  |  |
  | 1154 |  |  |
  | 1155 |  | ~~/\*\*~~ |
  | 1156 |  | ~~\* Update User Profile~~ |
  | 1157 |  | ~~\*/~~ |
  | 1158 |  | ~~function wpdmpp\_update\_profile() {~~ |
  | 1159 |  |  |
  | 1160 |  | ~~if ( is\_user\_logged\_in() && wp\_verify\_nonce( wpdm\_query\_var( '\_\_upnonce' ), NONCE\_KEY ) && isset( $\_POST['profile'] ) ) {~~ |
  | 1161 |  |  |
  | 1162 |  | ~~$userdata       = $\_POST['profile'];~~ |
  | 1163 |  | ~~$userdata['ID'] = get\_current\_user\_id();~~ |
  | 1164 |  | ~~if ( $\_POST['password'] == $\_POST['cpassword'] ) {~~ |
  | 1165 |  | ~~wp\_update\_user( $userdata );~~ |
  | 1166 |  | ~~$userdata['user\_pass'] = $\_POST['password'];~~ |
  | 1167 |  | ~~update\_user\_meta( get\_current\_user\_id(), 'payment\_account', sanitize\_text\_field( $\_POST['payment\_account'] ) );~~ |
  | 1168 |  | ~~update\_user\_meta( get\_current\_user\_id(), 'phone', sanitize\_text\_field( $\_POST['phone'] ) );~~ |
  | 1169 |  | ~~Session::set( 'member\_success', \_\_( "Profile Updated Successfully", "wpdm-premium-packages" ) );~~ |
  | 1170 |  |  |
  | 1171 |  | ~~} else {~~ |
  | 1172 |  | ~~$merror   = Session::get( 'member\_error' );~~ |
  | 1173 |  | ~~$merror   = is\_array( $merror ) ? $merror : array();~~ |
  | 1174 |  | ~~$merror[] = \_\_( "Confirm Password Not Matched. Profile Update Failed!", "wpdm-premium-packages" );~~ |
  | 1175 |  | ~~Session::set( 'member\_error', $merror );~~ |
  | 1176 |  | ~~}~~ |
  | 1177 |  | ~~update\_user\_meta( get\_current\_user\_id(), 'user\_billing\_shipping', serialize( wpdm\_sanitize\_array( $\_POST['checkout'] ) ) );~~ |
  | 1178 |  | ~~$return = isset( $\_SERVER['HTTP\_REFERER'] ) ? $\_SERVER['HTTP\_REFERER'] : home\_url( '/' );~~ |
  | 1179 |  | ~~wpdmpp\_redirect( $return );~~ |
  | 1180 |  | ~~die();~~ |
  | 1181 | 1138 | } |
  | 1182 | 1139 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2951917)
* [Zip Archive](?format=zip&new=2951917)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


