=== Content from plugins.trac.wordpress.org_e5c9fc1a_20250114_230936.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-slimstat%2Ftags%2F5.0.9%2Fwp-slimstat.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/wp-slimstat/tags/5.0.9/wp-slimstat.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-slimstat/tags/5.0.9/wp-slimstat.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-slimstat](/browser/wp-slimstat?order=name "View wp-slimstat")/[tags](/browser/wp-slimstat/tags?order=name "View tags")/[5.0.9](/browser/wp-slimstat/tags/5.0.9?order=name "View 5.0.9")/[wp-slimstat.php](/browser/wp-slimstat/tags/5.0.9/wp-slimstat.php?order=name "View wp-slimstat.php")

View diff against:

View revision:

| [Last change](/changeset/2958208/wp-slimstat/tags/5.0.9/wp-slimstat.php "View differences") on this file was [2958208](/changeset/2958208/ "View changeset 2958208"), checked in by mostafa.s1990, [17 months ago](/timeline?from=2023-08-25T07%3A42%3A52Z&precision=second "See timeline at 08/25/2023 07:42:52 AM") |
| --- |
| Update to version 5.0.9 from GitHub |
| **File size:** 86.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: Slimstat Analytics |
| [4](#L4) | Plugin URI: https://wp-slimstat.com/ |
| [5](#L5) | Description: The leading web analytics plugin for WordPress |
| [6](#L6) | Version: 5.0.9 |
| [7](#L7) | Author: Jason Crouse, VeronaLabs |
| [8](#L8) | Text Domain: wp-slimstat |
| [9](#L9) | Domain Path: /languages |
| [10](#L10) | Author URI: https://wp-slimstat.com/ |
| [11](#L11) | Requires PHP: 7.4 |
| [12](#L12) | \*/ |
| [13](#L13) |  |
| [14](#L14) | if (!empty(wp\_slimstat::$settings)) { |
| [15](#L15) | return true; |
| [16](#L16) | } |
| [17](#L17) |  |
| [18](#L18) | class wp\_slimstat |
| [19](#L19) | { |
| [20](#L20) | public static $version = '5.0.9'; |
| [21](#L21) | public static $settings = array(); |
| [22](#L22) |  |
| [23](#L23) | public static $wpdb = ''; |
| [24](#L24) | public static $upload\_dir = ''; |
| [25](#L25) |  |
| [26](#L26) | public static $update\_checker = array(); |
| [27](#L27) | public static $raw\_post\_array = array(); |
| [28](#L28) |  |
| [29](#L29) | protected static $data\_js = array('id' => 0); |
| [30](#L30) | protected static $stat = array(); |
| [31](#L31) | protected static $date\_i18n\_filters = array(); |
| [32](#L32) |  |
| [33](#L33) | /\*\* |
| [34](#L34) | \* Initializes variables and actions |
| [35](#L35) | \*/ |
| [36](#L36) | public static function init() |
| [37](#L37) | { |
| [38](#L38) |  |
| [39](#L39) | // Load all the settings |
| [40](#L40) | if (is\_network\_admin() && (empty($\_GET['page']) || strpos($\_GET['page'], 'slimview') === false)) { |
| [41](#L41) | self::$settings = get\_site\_option('slimstat\_options', array()); |
| [42](#L42) | } else { |
| [43](#L43) | self::$settings = get\_option('slimstat\_options', array()); |
| [44](#L44) | } |
| [45](#L45) |  |
| [46](#L46) | if (empty(self::$settings)) { |
| [47](#L47) | // Save the default values in the database |
| [48](#L48) | self::update\_option('slimstat\_options', self::init\_options()); |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | self::$settings = array\_merge(self::init\_options(), self::$settings); |
| [52](#L52) |  |
| [53](#L53) | // Allow third party tools to edit the options |
| [54](#L54) | self::$settings = apply\_filters('slimstat\_init\_options', self::$settings); |
| [55](#L55) |  |
| [56](#L56) | // Allow third-party tools to use a custom database for Slimstat |
| [57](#L57) | self::$wpdb = apply\_filters('slimstat\_custom\_wpdb', $GLOBALS['wpdb']); |
| [58](#L58) |  |
| [59](#L59) | // Define the folder where to store the geolocation database (shared among sites in a network, by default) |
| [60](#L60) | if (defined('UPLOADS')) { |
| [61](#L61) | self::$upload\_dir = ABSPATH . UPLOADS; |
| [62](#L62) | } else { |
| [63](#L63) | self::$upload\_dir = wp\_upload\_dir(); |
| [64](#L64) | self::$upload\_dir = self::$upload\_dir['basedir']; |
| [65](#L65) | if (is\_multisite() && !(is\_main\_network() && is\_main\_site() && defined('MULTISITE'))) { |
| [66](#L66) | self::$upload\_dir = str\_replace('/sites/' . get\_current\_blog\_id(), '', self::$upload\_dir); |
| [67](#L67) | } |
| [68](#L68) | self::$upload\_dir .= '/wp-slimstat'; |
| [69](#L69) | self::$upload\_dir = apply\_filters('slimstat\_maxmind\_path', self::$upload\_dir); |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | // Allow add-ons to turn off the tracker based on other conditions |
| [73](#L73) | $is\_tracking\_filter    = apply\_filters('slimstat\_filter\_pre\_tracking', strpos(self::get\_request\_uri(), 'wp-admin/admin-ajax.php') === false); |
| [74](#L74) | $is\_tracking\_filter\_js = apply\_filters('slimstat\_filter\_pre\_tracking\_js', true); |
| [75](#L75) |  |
| [76](#L76) | // Enable the tracker (both server- and client-side) |
| [77](#L77) | if ((!is\_admin() || self::$settings['track\_admin\_pages'] == 'on') && self::$settings['is\_tracking'] == 'on' && $is\_tracking\_filter) { |
| [78](#L78) |  |
| [79](#L79) | // Is server-side tracking active? |
| [80](#L80) | if (self::$settings['javascript\_mode'] != 'on') { |
| [81](#L81) | add\_action(is\_admin() ? 'admin\_init' : 'wp', array(\_\_CLASS\_\_, 'slimtrack'), 5); |
| [82](#L82) |  |
| [83](#L83) | if (self::$settings['ignore\_wp\_users'] != 'on') { |
| [84](#L84) | add\_action('login\_init', array(\_\_CLASS\_\_, 'slimtrack'), 10); |
| [85](#L85) | } |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | // Slimstat tracks screen resolutions, outbound links and other client-side information using a client-side tracker |
| [89](#L89) | add\_action(is\_admin() ? 'admin\_enqueue\_scripts' : 'wp\_enqueue\_scripts', array(\_\_CLASS\_\_, 'enqueue\_tracker'), 15); |
| [90](#L90) | if (self::$settings['ignore\_wp\_users'] != 'on') { |
| [91](#L91) | add\_action('login\_enqueue\_scripts', array(\_\_CLASS\_\_, 'enqueue\_tracker'), 10); |
| [92](#L92) | } |
| [93](#L93) |  |
| [94](#L94) | add\_filter('script\_loader\_tag', array(\_\_CLASS\_\_, 'add\_defer\_to\_script\_tag'), 10, 2); |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | // Hook a DB clean-up routine to the daily cronjob |
| [98](#L98) | add\_action('wp\_slimstat\_purge', array(\_\_CLASS\_\_, 'wp\_slimstat\_purge')); |
| [99](#L99) |  |
| [100](#L100) | // Allow external domains on CORS requests |
| [101](#L101) | add\_filter('allowed\_http\_origins', array(\_\_CLASS\_\_, 'open\_cors\_admin\_ajax')); |
| [102](#L102) |  |
| [103](#L103) | // GDPR: Opt-out Ajax Handler |
| [104](#L104) | add\_action('wp\_ajax\_slimstat\_optout\_html', array(\_\_CLASS\_\_, 'get\_optout\_html')); |
| [105](#L105) | add\_action('wp\_ajax\_nopriv\_slimstat\_optout\_html', array(\_\_CLASS\_\_, 'get\_optout\_html')); |
| [106](#L106) |  |
| [107](#L107) | // If this request was a redirect, we should update the content type accordingly |
| [108](#L108) | add\_filter('wp\_redirect\_status', array(\_\_CLASS\_\_, 'update\_content\_type'), 10, 2); |
| [109](#L109) |  |
| [110](#L110) | // Shortcodes |
| [111](#L111) | add\_shortcode('slimstat', array(\_\_CLASS\_\_, 'slimstat\_shortcode'), 15); |
| [112](#L112) |  |
| [113](#L113) | // Include our browser detector library |
| [114](#L114) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'vendor/browscap.php'); |
| [115](#L115) | add\_action('init', array('slim\_browser', 'init')); |
| [116](#L116) |  |
| [117](#L117) | // REST API Support |
| [118](#L118) | add\_action('rest\_api\_init', array(\_\_CLASS\_\_, 'register\_rest\_route')); |
| [119](#L119) |  |
| [120](#L120) | // Load the admin library |
| [121](#L121) | if (is\_user\_logged\_in()) { |
| [122](#L122) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/index.php'); |
| [123](#L123) | add\_action('init', array('wp\_slimstat\_admin', 'init'), 60); |
| [124](#L124) | } |
| [125](#L125) | } |
| [126](#L126) | // end init |
| [127](#L127) |  |
| [128](#L128) | /\*\* |
| [129](#L129) | \* Reads and processes the data received by the XHR tracker |
| [130](#L130) | \*/ |
| [131](#L131) | public static function slimtrack\_ajax() |
| [132](#L132) | { |
| [133](#L133) | // If the website is using a caching plugin, the tracking code might still be there, even if the user turned off tracking |
| [134](#L134) | if (self::$settings['is\_tracking'] != 'on') { |
| [135](#L135) | exit(self::\_log\_error(204)); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | $id = 0; |
| [139](#L139) |  |
| [140](#L140) | self::$data\_js = apply\_filters('slimstat\_filter\_pageview\_data\_js', self::$raw\_post\_array); |
| [141](#L141) | $site\_host     = parse\_url(get\_site\_url(), PHP\_URL\_HOST); |
| [142](#L142) |  |
| [143](#L143) | self::$stat['referer'] = ''; |
| [144](#L144) | if (!empty(self::$data\_js['ref'])) { |
| [145](#L145) | self::$stat['referer'] = self::\_base64\_url\_decode(self::$data\_js['ref']); |
| [146](#L146) |  |
| [147](#L147) | $parsed\_ref = parse\_url(self::$stat['referer'], PHP\_URL\_HOST); |
| [148](#L148) | if ($parsed\_ref === false) { |
| [149](#L149) | exit(self::\_log\_error(201)); |
| [150](#L150) | } |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | // Do we have an id for this request? If we do, we are either updating an existing pageview, or recording an event on the page |
| [154](#L154) | if (!empty(self::$data\_js['id'])) { |
| [155](#L155) |  |
| [156](#L156) | // Make sure that the control code is valid |
| [157](#L157) | self::$data\_js['id'] = self::\_get\_value\_without\_checksum(self::$data\_js['id']); |
| [158](#L158) |  |
| [159](#L159) | if (self::$data\_js['id'] === false) { |
| [160](#L160) | exit(self::\_log\_error(101)); |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | self::$stat['id'] = intval(self::$data\_js['id']); |
| [164](#L164) | if (self::$stat['id'] < 0) { |
| [165](#L165) | do\_action('slimstat\_track\_exit\_' . abs($intval\_id)); |
| [166](#L166) | exit(self::\_get\_value\_with\_checksum(self::$stat['id'])); |
| [167](#L167) | } |
| [168](#L168) |  |
| [169](#L169) | // If self::$data\_js[ 'pos' ] is empty, update an existing pageview with client-based information (resolution, server latency, etc) |
| [170](#L170) | if (empty(self::$data\_js['pos'])) { |
| [171](#L171) | self::\_set\_visit\_id(true); |
| [172](#L172) |  |
| [173](#L173) | // Retrieves all the client-side info (screen resolution, server latency, etc) and sets the corresponding entries in self::$stat |
| [174](#L174) | self::$stat = self::\_get\_client\_info(self::$data\_js, self::$stat); |
| [175](#L175) |  |
| [176](#L176) | // Visitor is still on this page, record the timestamp in the corresponding field if this WAS NOT a request to update a "server-side" pageview with client-side info |
| [177](#L177) | if (empty(self::$stat['resolution'])) { |
| [178](#L178) | self::$stat['dt\_out'] = self::date\_i18n('U'); |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) | // Is this a new visitor, based on his fingerprint? |
| [182](#L182) | if (!empty(self::$stat['fingerprint']) && self::\_is\_new\_visitor(self::$stat['fingerprint'])) { |
| [183](#L183) | self::$stat['notes'] = array('new:yes'); |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | $id = self::\_update\_row(self::$stat); |
| [187](#L187) | } // ... otherwise, is this an event: a click on a link (maybe a 'download'?) or other user action |
| [188](#L188) | else { |
| [189](#L189) | // Record the event |
| [190](#L190) | $event\_info = array( |
| [191](#L191) | 'position' => strip\_tags(trim(self::$data\_js['pos'])), |
| [192](#L192) | 'id'       => self::$stat['id'], |
| [193](#L193) | 'dt'       => self::date\_i18n('U') |
| [194](#L194) | ); |
| [195](#L195) |  |
| [196](#L196) | if (!empty(self::$data\_js['no'])) { |
| [197](#L197) | $event\_info['notes'] = self::\_base64\_url\_decode(self::$data\_js['no']); |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | self::\_insert\_row($event\_info, $GLOBALS['wpdb']->prefix . 'slim\_events'); |
| [201](#L201) |  |
| [202](#L202) | if (!empty(self::$data\_js['res'])) { |
| [203](#L203) | $resource        = self::\_base64\_url\_decode(self::$data\_js['res']); |
| [204](#L204) | $parsed\_resource = parse\_url($resource); |
| [205](#L205) |  |
| [206](#L206) | if ($parsed\_resource === false or empty($parsed\_resource['host'])) { |
| [207](#L207) | exit(self::\_log\_error(203)); |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | // Is this a download? If it is, add a new record to the database |
| [211](#L211) | if (!empty($parsed\_resource['path']) && in\_array(pathinfo($parsed\_resource['path'], PATHINFO\_EXTENSION), self::string\_to\_array(self::$settings['extensions\_to\_track']))) { |
| [212](#L212) | self::$stat['resource']     = $parsed\_resource['path'] . (!empty($parsed\_resource['query']) ? '?' . $parsed\_resource['query'] : ''); |
| [213](#L213) | self::$stat['content\_type'] = 'download'; |
| [214](#L214) |  |
| [215](#L215) | if (!empty(self::$data\_js['fh'])) { |
| [216](#L216) | self::$stat['fingerprint'] = sanitize\_text\_field(self::$data\_js['fh']); |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | $id = self::slimtrack(); |
| [220](#L220) | } // .. or outbound link? If so, update the pageview with the new info |
| [221](#L221) | else if ($parsed\_resource['host'] != $site\_host) { |
| [222](#L222) | self::$stat['outbound\_resource'] = $resource; |
| [223](#L223) |  |
| [224](#L224) | // Visitor is still on this page, record the timestamp in the corresponding field |
| [225](#L225) | self::$stat['dt\_out'] = self::date\_i18n('U'); |
| [226](#L226) |  |
| [227](#L227) | $id = self::\_update\_row(self::$stat); |
| [228](#L228) | } |
| [229](#L229) | } else { |
| [230](#L230) | // Visitor is still on this page, record the timestamp in the corresponding field |
| [231](#L231) | self::$stat['dt\_out'] = self::date\_i18n('U'); |
| [232](#L232) |  |
| [233](#L233) | $id = self::\_update\_row(self::$stat); |
| [234](#L234) | } |
| [235](#L235) | } |
| [236](#L236) | } // If self::$data\_js[ 'id' ] is empty, we are tracking a new pageview |
| [237](#L237) | else { |
| [238](#L238) | self::$stat['resource'] = ''; |
| [239](#L239) | if (!empty(self::$data\_js['res'])) { |
| [240](#L240) | self::$stat['resource'] = self::\_base64\_url\_decode(self::$data\_js['res']); |
| [241](#L241) |  |
| [242](#L242) | if (parse\_url(self::$stat['resource']) === false) { |
| [243](#L243) | exit(self::\_log\_error(203)); |
| [244](#L244) | } |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | // Retrieves all the client-side info (screen resolution, server latency, etc) and sets the corresponding entries in self::$stat |
| [248](#L248) | self::$stat = self::\_get\_client\_info(self::$data\_js, self::$stat); |
| [249](#L249) |  |
| [250](#L250) | if (!empty(self::$data\_js['ci'])) { |
| [251](#L251) | self::$data\_js['ci'] = self::\_get\_value\_without\_checksum(self::$data\_js['ci']); |
| [252](#L252) |  |
| [253](#L253) | if (self::$data\_js['ci'] === false) { |
| [254](#L254) | exit(self::\_log\_error(102)); |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | $content\_info = @unserialize(self::\_base64\_url\_decode(self::$data\_js['ci'])); |
| [258](#L258) |  |
| [259](#L259) | if (empty($content\_info) || !is\_array($content\_info)) { |
| [260](#L260) | exit(self::\_log\_error(103)); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | foreach (array('content\_type', 'category', 'content\_id', 'author') as $a\_key) { |
| [264](#L264) | if (!empty($content\_info[$a\_key])) { |
| [265](#L265) | self::$stat[$a\_key] = sanitize\_title($content\_info[$a\_key]); |
| [266](#L266) | } |
| [267](#L267) | } |
| [268](#L268) | } // ... otherwise we'll track this as an external page |
| [269](#L269) | else { |
| [270](#L270) | self::$stat['content\_type'] = 'external'; |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | // Is this a new visitor, based on his fingerprint? |
| [274](#L274) | if (!empty(self::$stat['fingerprint']) && self::\_is\_new\_visitor(self::$stat['fingerprint'])) { |
| [275](#L275) | self::$stat['notes'] = array('new:yes'); |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | // Track the rest of the information related to this pageview |
| [279](#L279) | $id = self::slimtrack(); |
| [280](#L280) | } |
| [281](#L281) |  |
| [282](#L282) | // Was this pageview tracked? |
| [283](#L283) | if (empty($id)) { |
| [284](#L284) | exit(0); |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | // Send the ID back to Javascript to track future interactions |
| [288](#L288) | do\_action('slimstat\_track\_success'); |
| [289](#L289) | exit(self::\_get\_value\_with\_checksum($id)); |
| [290](#L290) | } |
| [291](#L291) | // end slimtrack\_ajax |
| [292](#L292) |  |
| [293](#L293) | /\*\* |
| [294](#L294) | \* THE Slimstat tracker |
| [295](#L295) | \*/ |
| [296](#L296) | public static function slimtrack() |
| [297](#L297) | { |
| [298](#L298) | self::$stat['dt'] = self::date\_i18n('U'); |
| [299](#L299) |  |
| [300](#L300) | if (empty(self::$stat['notes'])) { |
| [301](#L301) | self::$stat['notes'] = array(); |
| [302](#L302) | } |
| [303](#L303) |  |
| [304](#L304) | // Allow third-party tools to initialize the stat array |
| [305](#L305) | self::$stat = apply\_filters('slimstat\_filter\_pageview\_stat\_init', self::$stat); |
| [306](#L306) |  |
| [307](#L307) | // Third-party tools can decide that this pageview should not be tracked, by setting its datestamp to zero |
| [308](#L308) | if (empty(self::$stat) || empty(self::$stat['dt'])) { |
| [309](#L309) | return false; |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | // Reset the pageview ID, if it's set for some obscure reason |
| [313](#L313) | unset(self::$stat['id']); |
| [314](#L314) |  |
| [315](#L315) | // Opt-out of tracking via cookie |
| [316](#L316) | if (self::$settings['display\_opt\_out'] == 'on') { |
| [317](#L317) | $cookie\_names = array('slimstat\_optout\_tracking' => 'true'); |
| [318](#L318) |  |
| [319](#L319) | if (!empty(self::$settings['opt\_out\_cookie\_names'])) { |
| [320](#L320) | $cookie\_names = array(); |
| [321](#L321) |  |
| [322](#L322) | foreach (self::string\_to\_array(self::$settings['opt\_out\_cookie\_names']) as $a\_cookie\_pair) { |
| [323](#L323) | list($name, $value) = explode('=', $a\_cookie\_pair); |
| [324](#L324) |  |
| [325](#L325) | if (!empty($name) && !empty($value)) { |
| [326](#L326) | $cookie\_names[$name] = $value; |
| [327](#L327) | } |
| [328](#L328) | } |
| [329](#L329) | } |
| [330](#L330) |  |
| [331](#L331) | foreach ($cookie\_names as $a\_name => $a\_value) { |
| [332](#L332) | if (isset($\_COOKIE[$a\_name]) && strpos($\_COOKIE[$a\_name], $a\_value) !== false) { |
| [333](#L333) | // remove slimstat cookie |
| [334](#L334) | unset($\_COOKIE['slimstat\_tracking\_code']); |
| [335](#L335) | @setcookie( |
| [336](#L336) | 'slimstat\_tracking\_code', |
| [337](#L337) | '', |
| [338](#L338) | time() - (15 \* 60), // invalidate |
| [339](#L339) | COOKIEPATH |
| [340](#L340) | ); |
| [341](#L341) | return false; |
| [342](#L342) | } |
| [343](#L343) | } |
| [344](#L344) | } |
| [345](#L345) |  |
| [346](#L346) | // Opt-in tracking via cookie (only those who have a cookie will be tracked) |
| [347](#L347) | if (!empty(self::$settings['opt\_in\_cookie\_names'])) { |
| [348](#L348) | $cookie\_names        = array(); |
| [349](#L349) | $opt\_in\_cookie\_names = self::string\_to\_array(self::$settings['opt\_in\_cookie\_names']); |
| [350](#L350) |  |
| [351](#L351) | foreach ($opt\_in\_cookie\_names as $a\_cookie\_pair) { |
| [352](#L352) | list($name, $value) = explode('=', $a\_cookie\_pair); |
| [353](#L353) |  |
| [354](#L354) | if (!empty($name) && !empty($value)) { |
| [355](#L355) | $cookie\_names[$name] = $value; |
| [356](#L356) | } |
| [357](#L357) | } |
| [358](#L358) |  |
| [359](#L359) | $cookie\_found = false; |
| [360](#L360) | foreach ($cookie\_names as $a\_name => $a\_value) { |
| [361](#L361) | if (isset($\_COOKIE[$a\_name]) && strpos($\_COOKIE[$a\_name], $a\_value) !== false) { |
| [362](#L362) | $cookie\_found = true; |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | if (!$cookie\_found) { |
| [367](#L367) | // remove slimstat cookie |
| [368](#L368) | unset($\_COOKIE['slimstat\_tracking\_code']); |
| [369](#L369) | @setcookie( |
| [370](#L370) | 'slimstat\_tracking\_code', |
| [371](#L371) | '', |
| [372](#L372) | time() - (15 \* 60), // invalidate |
| [373](#L373) | COOKIEPATH |
| [374](#L374) | ); |
| [375](#L375) | return false; |
| [376](#L376) | } |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | // IP address |
| [380](#L380) | list (self::$stat['ip'], self::$stat['other\_ip']) = self::\_get\_remote\_ip(); |
| [381](#L381) |  |
| [382](#L382) | if (empty(self::$stat['ip']) || self::$stat['ip'] == '0.0.0.0') { |
| [383](#L383) | $error = self::\_log\_error(202); |
| [384](#L384) | return false; |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | // Should we ignore this IP address? |
| [388](#L388) | foreach (self::string\_to\_array(self::$settings['ignore\_ip']) as $a\_ip\_range) { |
| [389](#L389) | $ip\_to\_ignore = $a\_ip\_range; |
| [390](#L390) |  |
| [391](#L391) | if (strpos($ip\_to\_ignore, '/') !== false) { |
| [392](#L392) | list($ip\_to\_ignore, $cidr\_mask) = explode('/', trim($ip\_to\_ignore)); |
| [393](#L393) | } else { |
| [394](#L394) | $cidr\_mask = self::\_get\_mask\_length($ip\_to\_ignore); |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | $long\_masked\_ip\_to\_ignore  = substr(self::\_dtr\_pton($ip\_to\_ignore), 0, $cidr\_mask); |
| [398](#L398) | $long\_masked\_user\_ip       = substr(self::\_dtr\_pton(self::$stat['ip']), 0, $cidr\_mask); |
| [399](#L399) | $long\_masked\_user\_other\_ip = substr(self::\_dtr\_pton(self::$stat['other\_ip']), 0, $cidr\_mask); |
| [400](#L400) |  |
| [401](#L401) | if ($long\_masked\_user\_ip === $long\_masked\_ip\_to\_ignore || $long\_masked\_user\_other\_ip === $long\_masked\_ip\_to\_ignore) { |
| [402](#L402) | return false; |
| [403](#L403) | } |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | // Do we need to anonymize this IP address? |
| [407](#L407) | if (self::$settings['anonymize\_ip'] == 'on') { |
| [408](#L408) | // IPv4 or IPv6 |
| [409](#L409) | $needle  = '.'; |
| [410](#L410) | $replace = '.0'; |
| [411](#L411) | if (self::\_get\_mask\_length(self::$stat['ip']) == 128) { |
| [412](#L412) | $needle  = ':'; |
| [413](#L413) | $replace = ':0000'; |
| [414](#L414) | } |
| [415](#L415) |  |
| [416](#L416) | self::$stat['ip'] = substr(self::$stat['ip'], 0, strrpos(self::$stat['ip'], $needle)) . $replace; |
| [417](#L417) |  |
| [418](#L418) | if (!empty(self::$stat['other\_ip'])) { |
| [419](#L419) | self::$stat['other\_ip'] = substr(self::$stat['other\_ip'], 0, strrpos(self::$stat['other\_ip'], $needle)) . $replace; |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | // Resource URL |
| [424](#L424) | if (!isset(self::$stat['resource'])) { |
| [425](#L425) | self::$stat['resource'] = self::get\_request\_uri(); |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | // Is this a 'seriously malformed' URL? |
| [429](#L429) | $parsed\_url = parse\_url(self::$stat['resource']); |
| [430](#L430) | if (!$parsed\_url) { |
| [431](#L431) | $error = self::\_log\_error(203); |
| [432](#L432) | return false; |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | // Don't store the domain name in the database |
| [436](#L436) | self::$stat['resource'] = $parsed\_url['path'] . (!empty($parsed\_url['query']) ? '?' . $parsed\_url['query'] : '') . (!empty($parsed\_url['fragment']) ? '#' . $parsed\_url['fragment'] : ''); |
| [437](#L437) |  |
| [438](#L438) | // Is this resource blacklisted? |
| [439](#L439) | if (!empty(self::$settings['ignore\_resources']) && self::\_is\_blacklisted(self::$stat['resource'], self::$settings['ignore\_resources'])) { |
| [440](#L440) | return false; |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | // Referrer URL |
| [444](#L444) | if (!isset(self::$stat['referer']) && !empty($\_SERVER['HTTP\_REFERER'])) { |
| [445](#L445) | self::$stat['referer'] = sanitize\_url(wp\_unslash($\_SERVER['HTTP\_REFERER'])); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | if (!empty(self::$stat['referer'])) { |
| [449](#L449) | // Is this a 'seriously malformed' URL? |
| [450](#L450) | $parsed\_url = parse\_url(self::$stat['referer']); |
| [451](#L451) | if (!$parsed\_url) { |
| [452](#L452) | $error = self::\_log\_error(201); |
| [453](#L453) | return false; |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | if (!empty($parsed\_url['scheme']) && !in\_array(strtolower($parsed\_url['scheme']), array('http', 'https', 'android-app'))) { |
| [457](#L457) | self::$stat['notes'][] = sprintf(\_\_('Attempted XSS Injection: %s', 'wp-slimstat'), self::$stat['referer']); |
| [458](#L458) | unset(self::$stat['referer']); |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | // Is this referer blacklisted? |
| [462](#L462) | if (!empty(self::$settings['ignore\_referers']) && self::\_is\_blacklisted(self::$stat['referer'], self::$settings['ignore\_referers'])) { |
| [463](#L463) | return false; |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | // Search terms |
| [467](#L467) | self::$stat['searchterms'] = self::\_get\_search\_terms(self::$stat['referer']); |
| [468](#L468) |  |
| [469](#L469) | // Are we storing internal referrers in the database? |
| [470](#L470) | $parsed\_site\_url = parse\_url(get\_site\_url(), PHP\_URL\_HOST); |
| [471](#L471) | if (!empty($parsed\_url['host']) && $parsed\_url['host'] == $parsed\_site\_url && self::$settings['track\_same\_domain\_referers'] != 'on') { |
| [472](#L472) | unset(self::$stat['referer']); |
| [473](#L473) | } |
| [474](#L474) | } |
| [475](#L475) |  |
| [476](#L476) | // Internal WP search? |
| [477](#L477) | if (empty(self::$stat['searchterms']) && !empty($\_POST['s'])) { |
| [478](#L478) | self::$stat['searchterms'] = sanitize\_text\_field(str\_replace('\\', '', $\_REQUEST['s'])); |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | // If this function was called by the js tracker (client mode), we've already determined this pageview's content information |
| [482](#L482) | if (!isset(self::$stat['content\_type'])) { |
| [483](#L483) | $content\_info = self::\_get\_content\_info(); |
| [484](#L484) |  |
| [485](#L485) | // Is this content type blacklisted? |
| [486](#L486) | if (!empty(self::$settings['ignore\_content\_types']) && self::\_is\_blacklisted($content\_info['content\_type'], self::$settings['ignore\_content\_types'])) { |
| [487](#L487) | return false; |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) | if (is\_array($content\_info)) { |
| [491](#L491) | self::$stat = self::$stat + $content\_info; |
| [492](#L492) | } |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | // Number of results from query\_posts |
| [496](#L496) | if ((is\_archive() || is\_search()) && !empty($GLOBALS['wp\_query']->found\_posts)) { |
| [497](#L497) | self::$stat['notes'][] = 'results:' . intval($GLOBALS['wp\_query']->found\_posts); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | // Do not track report pages in the admin |
| [501](#L501) | if ((!empty(self::$stat['resource']) && strpos(self::$stat['resource'], 'wp-admin/admin-ajax.php') !== false) || (!empty($\_GET['page']) && strpos($\_GET['page'], 'slimview') !== false)) { |
| [502](#L502) | return false; |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | // Should we ignore this user? |
| [506](#L506) | if (!empty($GLOBALS['current\_user']->ID)) { |
| [507](#L507) | // Don't track logged-in users, if the corresponding option is enabled |
| [508](#L508) | if (self::$settings['ignore\_wp\_users'] == 'on') { |
| [509](#L509) | return false; |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | // Don't track users with given capabilities |
| [513](#L513) | foreach ($GLOBALS['current\_user']->roles as $a\_capability) { |
| [514](#L514) | if (self::\_is\_blacklisted($a\_capability, self::$settings['ignore\_capabilities'])) { |
| [515](#L515) | return false; |
| [516](#L516) | } |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | // Is this user blacklisted? |
| [520](#L520) | if (!empty(self::$settings['ignore\_users']) && self::\_is\_blacklisted($GLOBALS['current\_user']->data->user\_login, self::$settings['ignore\_users'])) { |
| [521](#L521) | return false; |
| [522](#L522) | } |
| [523](#L523) |  |
| [524](#L524) | self::$stat['username'] = $GLOBALS['current\_user']->data->user\_login; |
| [525](#L525) | self::$stat['email']    = $GLOBALS['current\_user']->data->user\_email; |
| [526](#L526) | self::$stat['notes'][]  = 'user:' . $GLOBALS['current\_user']->data->ID; |
| [527](#L527) | $not\_spam               = true; |
| [528](#L528) | } elseif (isset($\_COOKIE['comment\_author\_' . COOKIEHASH])) { |
| [529](#L529) | // Is this a spammer? |
| [530](#L530) | $spam\_comment = self::$wpdb->get\_row(self::$wpdb->prepare(" |
| [531](#L531) | SELECT comment\_author, comment\_author\_email, COUNT(\*) comment\_count |
| [532](#L532) | FROM `" . DB\_NAME . "`.{$GLOBALS['wpdb']->comments} |
| [533](#L533) | WHERE comment\_author\_IP = %s AND comment\_approved = 'spam' |
| [534](#L534) | GROUP BY comment\_author |
| [535](#L535) | LIMIT 0,1", self::$stat['ip']), ARRAY\_A); |
| [536](#L536) |  |
| [537](#L537) | if (!empty($spam\_comment['comment\_count'])) { |
| [538](#L538) | if (self::$settings['ignore\_spammers'] == 'on') { |
| [539](#L539) | return false; |
| [540](#L540) | } else { |
| [541](#L541) | self::$stat['notes'][]  = 'spam:yes'; |
| [542](#L542) | self::$stat['username'] = $spam\_comment['comment\_author']; |
| [543](#L543) | self::$stat['email']    = $spam\_comment['comment\_author\_email']; |
| [544](#L544) | } |
| [545](#L545) | } else { |
| [546](#L546) | if (!empty($\_COOKIE['comment\_author\_' . COOKIEHASH])) { |
| [547](#L547) | self::$stat['username'] = sanitize\_user($\_COOKIE['comment\_author\_' . COOKIEHASH]); |
| [548](#L548) | } |
| [549](#L549) | if (!empty($\_COOKIE['comment\_author\_email\_' . COOKIEHASH])) { |
| [550](#L550) | self::$stat['email'] = sanitize\_email($\_COOKIE['comment\_author\_email\_' . COOKIEHASH]); |
| [551](#L551) | } |
| [552](#L552) | } |
| [553](#L553) | } |
| [554](#L554) |  |
| [555](#L555) | // Language |
| [556](#L556) | self::$stat['language'] = self::\_get\_language(); |
| [557](#L557) |  |
| [558](#L558) | // Is this language blacklisted? |
| [559](#L559) | if (!empty(self::$stat['language']) && !empty(self::$settings['ignore\_languages']) && stripos(self::$settings['ignore\_languages'], self::$stat['language']) !== false) { |
| [560](#L560) | return false; |
| [561](#L561) | } |
| [562](#L562) |  |
| [563](#L563) | // Geolocation |
| [564](#L564) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'vendor/maxmind.php'); |
| [565](#L565) | try { |
| [566](#L566) | $geolocation\_data = maxmind\_geolite2\_connector::get\_geolocation\_info(self::$stat['ip']); |
| [567](#L567) | } catch (Exception $e) { |
| [568](#L568) | // Invalid MaxMind data file |
| [569](#L569) | $error = self::\_log\_error(205); |
| [570](#L570) | return false; |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | if (!empty($geolocation\_data['country']['iso\_code']) && $geolocation\_data['country']['iso\_code'] != 'xx') { |
| [574](#L574) | self::$stat['country'] = strtolower($geolocation\_data['country']['iso\_code']); |
| [575](#L575) |  |
| [576](#L576) | if (!empty($geolocation\_data['city']['names']['en'])) { |
| [577](#L577) | self::$stat['city'] = $geolocation\_data['city']['names']['en']; |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | if (!empty($geolocation\_data['subdivisions'][0]['iso\_code']) && !empty(self::$stat['city'])) { |
| [581](#L581) | self::$stat['city'] .= ' (' . $geolocation\_data['subdivisions'][0]['iso\_code'] . ')'; |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) | if (!empty($geolocation\_data['location']['latitude']) && !empty($geolocation\_data['location']['longitude'])) { |
| [585](#L585) | self::$stat['location'] = $geolocation\_data['location']['latitude'] . ',' . $geolocation\_data['location']['longitude']; |
| [586](#L586) | } |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | // Is this country blacklisted? |
| [590](#L590) | if (!empty(self::$stat['country']) && !empty(self::$settings['ignore\_countries']) && stripos(self::$settings['ignore\_countries'], self::$stat['country']) !== false) { |
| [591](#L591) | return false; |
| [592](#L592) | } |
| [593](#L593) |  |
| [594](#L594) | // Mark or ignore Firefox/Safari prefetching requests (X-Moz: Prefetch and X-purpose: Preview) |
| [595](#L595) | if ((isset($\_SERVER['HTTP\_X\_MOZ']) && (strtolower($\_SERVER['HTTP\_X\_MOZ']) == 'prefetch')) || |
| [596](#L596) | (isset($\_SERVER['HTTP\_X\_PURPOSE']) && (strtolower($\_SERVER['HTTP\_X\_PURPOSE']) == 'preview'))) { |
| [597](#L597) | if (self::$settings['ignore\_prefetch'] == 'on') { |
| [598](#L598) | return false; |
| [599](#L599) | } else { |
| [600](#L600) | self::$stat['notes'][] = 'pre:yes'; |
| [601](#L601) | } |
| [602](#L602) | } |
| [603](#L603) |  |
| [604](#L604) | // User Agent |
| [605](#L605) | $browser = slim\_browser::get\_browser(); |
| [606](#L606) |  |
| [607](#L607) | // Are we ignoring bots? |
| [608](#L608) | if (self::$settings['ignore\_bots'] == 'on' && $browser['browser\_type'] == 1) { |
| [609](#L609) | return false; |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | // Is this browser blacklisted? |
| [613](#L613) | if (!empty(self::$settings['ignore\_browsers']) && self::\_is\_blacklisted(array($browser['browser'], $browser['user\_agent']), self::$settings['ignore\_browsers'])) { |
| [614](#L614) | return false; |
| [615](#L615) | } |
| [616](#L616) |  |
| [617](#L617) | // Is this operating system blacklisted? |
| [618](#L618) | if (!empty(self::$settings['ignore\_platforms']) && self::\_is\_blacklisted($browser['platform'], self::$settings['ignore\_platforms'])) { |
| [619](#L619) | return false; |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | self::$stat = self::$stat + $browser; |
| [623](#L623) |  |
| [624](#L624) | // Do we need to assign a visit\_id to this user? |
| [625](#L625) | $cookie\_has\_been\_set = self::\_set\_visit\_id(false); |
| [626](#L626) |  |
| [627](#L627) | // Allow third-party tools to modify all the data we've gathered so far |
| [628](#L628) | self::$stat = apply\_filters('slimstat\_filter\_pageview\_stat', self::$stat); |
| [629](#L629) | do\_action('slimstat\_track\_pageview', self::$stat); |
| [630](#L630) |  |
| [631](#L631) | // Third-party tools can decide that this pageview should not be tracked, by setting its datestamp to zero |
| [632](#L632) | if (empty(self::$stat) || empty(self::$stat['dt'])) { |
| [633](#L633) | return false; |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) | // Implode the notes |
| [637](#L637) | if (!empty(self::$stat['notes'])) { |
| [638](#L638) | self::$stat['notes'] = '[' . implode('][', self::$stat['notes']) . ']'; |
| [639](#L639) | } |
| [640](#L640) |  |
| [641](#L641) | // Remove empty values |
| [642](#L642) | self::$stat = array\_filter(self::$stat); |
| [643](#L643) |  |
| [644](#L644) | // Save this information in the database |
| [645](#L645) | self::$stat['id'] = self::\_insert\_row(self::$stat, $GLOBALS['wpdb']->prefix . 'slim\_stats'); |
| [646](#L646) |  |
| [647](#L647) | // Did something go wrong during the insert? |
| [648](#L648) | if (empty(self::$stat['id'])) { |
| [649](#L649) |  |
| [650](#L650) | // Attempt to init the environment (plugin just activated on a blog in a MU network?) |
| [651](#L651) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/index.php'); |
| [652](#L652) | wp\_slimstat\_admin::init\_environment(true); |
| [653](#L653) |  |
| [654](#L654) | // Now let's try again |
| [655](#L655) | self::$stat['id'] = self::\_insert\_row(self::$stat, $GLOBALS['wpdb']->prefix . 'slim\_stats'); |
| [656](#L656) |  |
| [657](#L657) | if (empty(self::$stat['id'])) { |
| [658](#L658) | $error = self::\_log\_error(200); |
| [659](#L659) | return false; |
| [660](#L660) | } |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | // Does this visitor have a visit\_id cookie? |
| [664](#L664) | $set\_cookie = apply\_filters('slimstat\_set\_visit\_cookie', (!empty(self::$settings['set\_tracker\_cookie']) && self::$settings['set\_tracker\_cookie'] == 'on')); |
| [665](#L665) | if ($set\_cookie) { |
| [666](#L666) | if (empty(self::$stat['visit\_id']) && !empty(self::$stat['id'])) { |
| [667](#L667) | // Set a cookie to track this visit (Google and other non-human engines will just ignore it) |
| [668](#L668) | @setcookie( |
| [669](#L669) | 'slimstat\_tracking\_code', |
| [670](#L670) | self::\_get\_value\_with\_checksum(self::$stat['id'] . 'id'), |
| [671](#L671) | time() + 2678400, // one month |
| [672](#L672) | COOKIEPATH |
| [673](#L673) | ); |
| [674](#L674) | } elseif (!$cookie\_has\_been\_set && self::$settings['extend\_session'] == 'on' && self::$stat['visit\_id'] > 0) { |
| [675](#L675) | @setcookie( |
| [676](#L676) | 'slimstat\_tracking\_code', |
| [677](#L677) | self::\_get\_value\_with\_checksum(self::$stat['visit\_id']), |
| [678](#L678) | time() + self::$settings['session\_duration'], |
| [679](#L679) | COOKIEPATH |
| [680](#L680) | ); |
| [681](#L681) | } |
| [682](#L682) | } |
| [683](#L683) |  |
| [684](#L684) | return self::$stat['id']; |
| [685](#L685) | } |
| [686](#L686) | // end slimtrack |
| [687](#L687) |  |
| [688](#L688) | /\*\* |
| [689](#L689) | \* Decodes the permalink |
| [690](#L690) | \*/ |
| [691](#L691) | public static function get\_request\_uri() |
| [692](#L692) | { |
| [693](#L693) | $request\_url = ''; |
| [694](#L694) |  |
| [695](#L695) | if (isset($\_SERVER['REQUEST\_URI'])) { |
| [696](#L696) | return urldecode(sanitize\_url(wp\_unslash($\_SERVER['REQUEST\_URI']))); |
| [697](#L697) | } else if (isset($\_SERVER['SCRIPT\_NAME'])) { |
| [698](#L698) | $request\_url = sanitize\_text\_field(wp\_unslash($\_SERVER['SCRIPT\_NAME'])); |
| [699](#L699) | } else if (isset($\_SERVER['PHP\_SELF'])) { |
| [700](#L700) | $request\_url = sanitize\_text\_field(wp\_unslash($\_SERVER['PHP\_SELF'])); |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | if (isset($\_SERVER['QUERY\_STRING'])) { |
| [704](#L704) | $request\_url .= '?' . sanitize\_text\_field(wp\_unslash($\_SERVER['QUERY\_STRING'])); |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | return $request\_url; |
| [708](#L708) | } |
| [709](#L709) |  |
| [710](#L710) | // end get\_request\_uri |
| [711](#L711) |  |
| [712](#L712) | public static function is\_local\_ip\_address($ip\_address = '') |
| [713](#L713) | { |
| [714](#L714) | if (!filter\_var($ip\_address, FILTER\_VALIDATE\_IP, FILTER\_FLAG\_NO\_PRIV\_RANGE | FILTER\_FLAG\_NO\_RES\_RANGE)) { |
| [715](#L715) | return true; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | return false; |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | /\*\* |
| [722](#L722) | \* Implements the Slimstat Shortcode API |
| [723](#L723) | \*/ |
| [724](#L724) | public static function slimstat\_shortcode($\_attributes = '', $\_content = '') |
| [725](#L725) | { |
| [726](#L726) | shortcode\_atts(array( |
| [727](#L727) | 'f' => '',    // recent, popular, count, widget |
| [728](#L728) | 'w' => '',    // column to use (for recent, popular and count) or widget to use |
| [729](#L729) | 's' => ' ',    // separator |
| [730](#L730) | 'o' => 0    // offset for counters |
| [731](#L731) | ), $\_attributes); |
| [732](#L732) |  |
| [733](#L733) | $f = isset($\_attributes['f']) ? $\_attributes['f'] : ''; |
| [734](#L734) | $w = isset($\_attributes['w']) ? $\_attributes['w'] : ''; |
| [735](#L735) | $s = isset($\_attributes['s']) ? $\_attributes['s'] : ''; |
| [736](#L736) | $o = isset($\_attributes['o']) ? $\_attributes['o'] : 0; |
| [737](#L737) |  |
| [738](#L738) | $output = $where = $as\_column = ''; |
| [739](#L739) | $s      = "<span class='slimstat-item-separator'>$s</span>"; |
| [740](#L740) |  |
| [741](#L741) | // Load the localization files (for languages, operating systems, etc) |
| [742](#L742) | load\_plugin\_textdomain('wp-slimstat', false, '/wp-slimstat/languages'); |
| [743](#L743) |  |
| [744](#L744) | // Look for required fields |
| [745](#L745) | if (empty($f) || empty($w)) { |
| [746](#L746) | return '<!-- Slimstat Shortcode Error: missing parameter -->'; |
| [747](#L747) | } |
| [748](#L748) |  |
| [749](#L749) | // Include the Reports Library, but don't initialize the database, since we will do that separately later |
| [750](#L750) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/view/wp-slimstat-reports.php'); |
| [751](#L751) | wp\_slimstat\_reports::init(); |
| [752](#L752) |  |
| [753](#L753) | /\*\* |
| [754](#L754) | \* @SecurityProfile https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-0630 |
| [755](#L755) | \* Disabled because of the report from WP Scan |
| [756](#L756) | \*/ |
| [757](#L757) | // Init the database library with the appropriate filters |
| [758](#L758) | /\*if ( strpos ( $\_content, 'WHERE:' ) !== false ) { |
| [759](#L759) | $where = html\_entity\_decode( str\_replace( 'WHERE:', '', $\_content ), ENT\_QUOTES, 'UTF-8' ); |
| [760](#L760) | } |
| [761](#L761) | else{\*/ |
| [762](#L762) | wp\_slimstat\_db::init(html\_entity\_decode($\_content, ENT\_QUOTES, 'UTF-8')); |
| [763](#L763) | //} |
| [764](#L764) |  |
| [765](#L765) | switch ($f) { |
| [766](#L766) | case 'count': |
| [767](#L767) | case 'count-all': |
| [768](#L768) | $output = wp\_slimstat\_db::count\_records($w, $where, strpos($f, 'all') === false) + $o; |
| [769](#L769) | break; |
| [770](#L770) |  |
| [771](#L771) | case 'widget': |
| [772](#L772) | if (empty(wp\_slimstat\_reports::$reports[$w])) { |
| [773](#L773) | return \_\_('Invalid Report ID', 'wp-slimstat'); |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | wp\_register\_style('wp-slimstat-frontend', plugins\_url('/admin/assets/css/slimstat.css', \_\_FILE\_\_)); |
| [777](#L777) | wp\_enqueue\_style('wp-slimstat-frontend'); |
| [778](#L778) |  |
| [779](#L779) | wp\_slimstat\_reports::$reports[$w]['callback\_args']['is\_widget'] = true; |
| [780](#L780) |  |
| [781](#L781) | ob\_start(); |
| [782](#L782) | echo wp\_slimstat\_reports::report\_header($w); |
| [783](#L783) | call\_user\_func(wp\_slimstat\_reports::$reports[$w]['callback'], wp\_slimstat\_reports::$reports[$w]['callback\_args']); |
| [784](#L784) | wp\_slimstat\_reports::report\_footer(); |
| [785](#L785) | $output = ob\_get\_contents(); |
| [786](#L786) | ob\_end\_clean(); |
| [787](#L787) | break; |
| [788](#L788) |  |
| [789](#L789) | case 'recent': |
| [790](#L790) | case 'recent-all': |
| [791](#L791) | case 'top': |
| [792](#L792) | case 'top-all': |
| [793](#L793) | $function = 'get\_' . str\_replace('-all', '', $f); |
| [794](#L794) |  |
| [795](#L795) | if ($w == '\*') { |
| [796](#L796) | $w = 'id'; |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | $w = self::string\_to\_array($w); |
| [800](#L800) |  |
| [801](#L801) | // Some columns are 'special' and need be removed from the list |
| [802](#L802) | $w\_clean = array\_diff($w, array('count', 'display\_name', 'hostname', 'post\_link', 'post\_link\_no\_qs', 'dt')); |
| [803](#L803) |  |
| [804](#L804) | // The special value 'display\_name' requires the username to be retrieved |
| [805](#L805) | if (in\_array('display\_name', $w)) { |
| [806](#L806) | $w\_clean[] = 'username'; |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | // The special value 'post\_list' requires the resource to be retrieved |
| [810](#L810) | if (in\_array('post\_link', $w)) { |
| [811](#L811) | $w\_clean[] = 'resource'; |
| [812](#L812) | } |
| [813](#L813) |  |
| [814](#L814) | // The special value 'post\_list\_no\_qs' requires a substring to be calculated |
| [815](#L815) | if (in\_array('post\_link\_no\_qs', $w)) { |
| [816](#L816) | $w\_clean   = array('SUBSTRING\_INDEX( resource, "' . (!get\_option('permalink\_structure') ? '&' : '?') . '", 1 )'); |
| [817](#L817) | $as\_column = 'resource'; |
| [818](#L818) | } |
| [819](#L819) |  |
| [820](#L820) | // Retrieve the data |
| [821](#L821) | $results = wp\_slimstat\_db::$function(implode(', ', $w\_clean), $where, '', strpos($f, 'all') === false, $as\_column); |
| [822](#L822) |  |
| [823](#L823) | // No data? No problem! |
| [824](#L824) | if (empty($results)) { |
| [825](#L825) | return '<!--  Slimstat Shortcode: No Data -->'; |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | // Are nice permalinks enabled? |
| [829](#L829) | $permalinks\_enabled = get\_option('permalink\_structure'); |
| [830](#L830) |  |
| [831](#L831) | // Format results |
| [832](#L832) | $output = array(); |
| [833](#L833) |  |
| [834](#L834) | foreach ($results as $result\_idx => $a\_result) { |
| [835](#L835) | foreach ($w as $a\_column) { |
| [836](#L836) | $output[$result\_idx][$a\_column] = "<span class='col-$a\_column'>"; |
| [837](#L837) |  |
| [838](#L838) | switch ($a\_column) { |
| [839](#L839) | case 'count': |
| [840](#L840) | $output[$result\_idx][$a\_column] .= $a\_result['counthits']; |
| [841](#L841) | break; |
| [842](#L842) |  |
| [843](#L843) | case 'country': |
| [844](#L844) | $output[$result\_idx][$a\_column] .= wp\_slimstat\_i18n::get\_string('c-' . $a\_result[$a\_column]); |
| [845](#L845) | break; |
| [846](#L846) |  |
| [847](#L847) | case 'display\_name': |
| [848](#L848) | $user\_details = get\_user\_by('login', $a\_result['username']); |
| [849](#L849) | if (!empty($user\_details)) { |
| [850](#L850) | $output[$result\_idx][$a\_column] .= $user\_details->display\_name; |
| [851](#L851) | } else { |
| [852](#L852) | $output[$result\_idx][$a\_column] .= $a\_result['username']; |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) | break; |
| [856](#L856) |  |
| [857](#L857) | case 'dt': |
| [858](#L858) | $output[$result\_idx][$a\_column] .= date\_i18n(get\_option('date\_format') . ' ' . get\_option('time\_format'), $a\_result['dt']); |
| [859](#L859) | break; |
| [860](#L860) |  |
| [861](#L861) | case 'hostname': |
| [862](#L862) | $output[$result\_idx][$a\_column] .= self::gethostbyaddr($a\_result['ip']); |
| [863](#L863) | break; |
| [864](#L864) |  |
| [865](#L865) | case 'language': |
| [866](#L866) | $output[$result\_idx][$a\_column] .= wp\_slimstat\_i18n::get\_string('l-' . $a\_result[$a\_column]); |
| [867](#L867) | break; |
| [868](#L868) |  |
| [869](#L869) | case 'platform': |
| [870](#L870) | $output[$result\_idx][$a\_column] .= wp\_slimstat\_i18n::get\_string($a\_result[$a\_column]); |
| [871](#L871) | break; |
| [872](#L872) |  |
| [873](#L873) | case 'post\_link': |
| [874](#L874) | case 'post\_link\_no\_qs': |
| [875](#L875) | $post\_id = url\_to\_postid($a\_result['resource']); |
| [876](#L876) | if ($post\_id > 0) { |
| [877](#L877) | $output[$result\_idx][$a\_column] .= "<a href='{$a\_result[ 'resource' ]}'>" . get\_the\_title($post\_id) . '</a>'; |
| [878](#L878) | } else { |
| [879](#L879) | $output[$result\_idx][$a\_column] .= "<a href='{$a\_result[ 'resource' ]}'>{$a\_result[ 'resource' ]}</a>"; |
| [880](#L880) | } |
| [881](#L881) | break; |
| [882](#L882) |  |
| [883](#L883) | default: |
| [884](#L884) | $output[$result\_idx][$a\_column] .= $a\_result[$a\_column]; |
| [885](#L885) | break; |
| [886](#L886) | } |
| [887](#L887) | $output[$result\_idx][$a\_column] .= '</span>'; |
| [888](#L888) | } |
| [889](#L889) | $output[$result\_idx] = '<li>' . implode($s, $output[$result\_idx]) . '</li>'; |
| [890](#L890) | } |
| [891](#L891) |  |
| [892](#L892) | $output = '<ul class="slimstat-shortcode ' . $f . implode('-', $w) . '">' . implode('', $output) . '</ul>'; |
| [893](#L893) | break; |
| [894](#L894) |  |
| [895](#L895) | default: |
| [896](#L896) | break; |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | return $output; |
| [900](#L900) | } |
| [901](#L901) | // end slimstat\_shortcode |
| [902](#L902) |  |
| [903](#L903) | /\*\* |
| [904](#L904) | \* Opens given domains during CORS requests to admin-ajax.php |
| [905](#L905) | \*/ |
| [906](#L906) | public static function open\_cors\_admin\_ajax($\_allowed\_origins = array()) |
| [907](#L907) | { |
| [908](#L908) | $exploded\_domains = self::string\_to\_array(self::$settings['external\_domains']); |
| [909](#L909) |  |
| [910](#L910) | if (!empty($exploded\_domains) && !empty($exploded\_domains[0])) { |
| [911](#L911) | $\_allowed\_origins = array\_merge($\_allowed\_origins, $exploded\_domains); |
| [912](#L912) | } |
| [913](#L913) |  |
| [914](#L914) | return $\_allowed\_origins; |
| [915](#L915) | } |
| [916](#L916) | // end open\_cors\_admin\_ajax |
| [917](#L917) |  |
| [918](#L918) | /\*\* |
| [919](#L919) | \* Implements a REST API interface to retrieve Slimstat reports and metrics |
| [920](#L920) | \*/ |
| [921](#L921) | public static function rest\_api\_response($\_request = array()) |
| [922](#L922) | { |
| [923](#L923) | $filters = ''; |
| [924](#L924) | if (!empty($\_request['filters'])) { |
| [925](#L925) | $filters = $\_request['filters']; |
| [926](#L926) | } |
| [927](#L927) |  |
| [928](#L928) | if (empty($\_request['dimension'])) { |
| [929](#L929) | return new WP\_Error('rest\_invalid', esc\_html\_\_('[REST API] The <code>dimension</code> parameter is required. Please review your request and try again.', 'wp-slimstat'), array('status' => 400)); |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | if (empty($\_request['function'])) { |
| [933](#L933) | return new WP\_Error('rest\_invalid', esc\_html\_\_('[REST API] The <code>function</code> parameter is required. Please review your request and try again.', 'wp-slimstat'), array('status' => 400)); |
| [934](#L934) | } |
| [935](#L935) |  |
| [936](#L936) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/view/wp-slimstat-db.php'); |
| [937](#L937) | wp\_slimstat\_db::init($filters); |
| [938](#L938) |  |
| [939](#L939) | $response = array( |
| [940](#L940) | 'function'  => htmlentities($\_request['function'], ENT\_QUOTES, 'UTF-8'), |
| [941](#L941) | 'dimension' => htmlentities($\_request['dimension'], ENT\_QUOTES, 'UTF-8'), |
| [942](#L942) |  |
| [943](#L943) | 'data' => 0 |
| [944](#L944) | ); |
| [945](#L945) |  |
| [946](#L946) | switch ($\_request['function']) { |
| [947](#L947) | case 'count': |
| [948](#L948) | case 'count-all': |
| [949](#L949) | $response['data'] = wp\_slimstat\_db::count\_records($\_request['dimension'], '', strpos($\_request['function'], '-all') === false); |
| [950](#L950) | break; |
| [951](#L951) |  |
| [952](#L952) | case 'recent': |
| [953](#L953) | case 'recent-all': |
| [954](#L954) | case 'top': |
| [955](#L955) | case 'top-all': |
| [956](#L956) | $function = 'get\_' . str\_replace('-all', '', $\_request['function']); |
| [957](#L957) |  |
| [958](#L958) | // Retrieve the data |
| [959](#L959) | $response['data'] = array\_values(wp\_slimstat\_db::$function($\_request['dimension'], '', '', strpos($\_request['function'], '-all') === false)); |
| [960](#L960) | break; |
| [961](#L961) |  |
| [962](#L962) | default: |
| [963](#L963) | // This should never happen, because of the 'enum' condition for this parameter. But never say never... |
| [964](#L964) | $response['data'] = new WP\_Error('rest\_invalid', esc\_html\_\_('[REST API] You sent an invalid request. Accepted function values include: <code>count, count-all, recent, recent-all, top and top-all</code>. Please review your request and try again.', 'wp-slimstat'), array('status' => 400)); |
| [965](#L965) | break; |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | return rest\_ensure\_response($response); |
| [969](#L969) | } |
| [970](#L970) | // end rest\_api\_response |
| [971](#L971) |  |
| [972](#L972) | /\*\* |
| [973](#L973) | \* Implements a REST API authentication mechanism via token |
| [974](#L974) | \*/ |
| [975](#L975) | public static function rest\_api\_authorization($\_request = array()) |
| [976](#L976) | { |
| [977](#L977) | if (empty($\_request['token'])) { |
| [978](#L978) | return new WP\_Error('rest\_invalid', esc\_html\_\_('[REST API] Please use a valid token in order to access the REST API endpoint at this URL.', 'wp-slimstat'), array('status' => 400)); |
| [979](#L979) | } |
| [980](#L980) |  |
| [981](#L981) | if (!in\_array($\_request['token'], self::string\_to\_array(self::$settings['rest\_api\_tokens']))) { |
| [982](#L982) | return false; |
| [983](#L983) | } |
| [984](#L984) |  |
| [985](#L985) | return true; |
| [986](#L986) | } |
| [987](#L987) | // end rest\_api\_authorization |
| [988](#L988) |  |
| [989](#L989) | /\*\* |
| [990](#L990) | \* Registers a new REST API route for the Slimstat endpoint |
| [991](#L991) | \*/ |
| [992](#L992) | public static function register\_rest\_route() |
| [993](#L993) | { |
| [994](#L994) | register\_rest\_route('slimstat/v1', '/get', array( |
| [995](#L995) | 'methods'             => WP\_REST\_Server::READABLE, |
| [996](#L996) | 'callback'            => array(\_\_CLASS\_\_, 'rest\_api\_response'), |
| [997](#L997) | 'permission\_callback' => array(\_\_CLASS\_\_, 'rest\_api\_authorization'), |
| [998](#L998) | 'args'                => array( |
| [999](#L999) | 'token'     => array( |
| [1000](#L1000) | 'description' => \_\_('You will need to specify a valid token to be able to query the data. Tokens are defined in Slimstat > Settings > Access Control.', 'wp-slimstat'), |
| [1001](#L1001) | 'type'        => 'string' |
| [1002](#L1002) | ), |
| [1003](#L1003) | 'function'  => array( |
| [1004](#L1004) | 'description' => \_\_('This parameter specifies the type of QUERY you would like to perform. Accepted funciton values include: count, count-all, recent, recent-all, top and top-all.', 'wp-slimstat'), |
| [1005](#L1005) | 'type'        => 'string', |
| [1006](#L1006) | 'enum'        => array('count', 'count-all', 'recent', 'recent-all', 'top', 'top-all') |
| [1007](#L1007) | ), |
| [1008](#L1008) | 'dimension' => array( |
| [1009](#L1009) | 'description' => \_\_('This parameter indicates what dimension to return: \* (all data), ip, resource, browser, operating system, etc. You can only specify one dimension at a time.', 'wp-slimstat'), |
| [1010](#L1010) | 'type'        => 'string', |
| [1011](#L1011) | 'enum'        => array('\*', 'id', 'ip', 'username', 'email', 'country', 'referer', 'resource', 'searchterms', 'browser', 'platform', 'language', 'resolution', 'content\_type', 'content\_id', 'tz\_offset', 'outbound\_resource') |
| [1012](#L1012) | ), |
| [1013](#L1013) | 'filters'   => array( |
| [1014](#L1014) | 'description' => \_\_('This parameter is used to filter a given dimension (resources, browsers, operating systems, etc) so that it satisfies certain conditions (i.e.: browser contains Chrome). Please make sure to urlencode this value, and to use the usual filter format: browser contains Chrome&&&referer contains slim (encoded: browser%20contains%20Chrome%26%26%26referer%20contains%20slim)', 'wp-slimstat'), |
| [1015](#L1015) | 'type'        => 'string' |
| [1016](#L1016) | ) |
| [1017](#L1017) | ) |
| [1018](#L1018) | )); |
| [1019](#L1019) | } |
| [1020](#L1020) | // end register\_rest\_route |
| [1021](#L1021) |  |
| [1022](#L1022) | /\*\* |
| [1023](#L1023) | \* Converts a series of comma separated values into an array |
| [1024](#L1024) | \*/ |
| [1025](#L1025) | public static function string\_to\_array($\_option = '') |
| [1026](#L1026) | { |
| [1027](#L1027) | if (empty($\_option) || !is\_string($\_option)) { |
| [1028](#L1028) | return array(); |
| [1029](#L1029) | } else { |
| [1030](#L1030) | return array\_filter(array\_map('trim', explode(',', $\_option))); |
| [1031](#L1031) | } |
| [1032](#L1032) | } |
| [1033](#L1033) | // end string\_to\_array |
| [1034](#L1034) |  |
| [1035](#L1035) | /\*\* |
| [1036](#L1036) | \* Toggles WordPress filters on date\_i18n function |
| [1037](#L1037) | \*/ |
| [1038](#L1038) | public static function toggle\_date\_i18n\_filters($\_turn\_on = true) |
| [1039](#L1039) | { |
| [1040](#L1040) | if ($\_turn\_on && !empty(self::$date\_i18n\_filters) && is\_array(self::$date\_i18n\_filters)) { |
| [1041](#L1041) | foreach (self::$date\_i18n\_filters as $i18n\_priority => $i18n\_func\_list) { |
| [1042](#L1042) | foreach ($i18n\_func\_list as $func\_name => $func\_args) { |
| [1043](#L1043) | if (!empty($func\_args['function']) && is\_string($func\_args['function'])) { |
| [1044](#L1044) | add\_filter('date\_i8n', $func\_args['function'], $i18n\_priority, intval($func\_args['accepted\_args'])); |
| [1045](#L1045) | } |
| [1046](#L1046) | } |
| [1047](#L1047) | } |
| [1048](#L1048) | } else if (!empty($GLOBALS['wp\_filter']['date\_i18n']['callbacks']) && is\_array($GLOBALS['wp\_filter']['date\_i18n']['callbacks'])) { |
| [1049](#L1049) | self::$date\_i18n\_filters = $GLOBALS['wp\_filter']['date\_i18n']['callbacks']; |
| [1050](#L1050) | remove\_all\_filters('date\_i18n'); |
| [1051](#L1051) | } |
| [1052](#L1052) | } |
| [1053](#L1053) | // end toggle\_date\_i18n\_filters |
| [1054](#L1054) |  |
| [1055](#L1055) | /\*\* |
| [1056](#L1056) | \* Calls the date\_i18n function without filters |
| [1057](#L1057) | \*/ |
| [1058](#L1058) | public static function date\_i18n($\_format) |
| [1059](#L1059) | { |
| [1060](#L1060) | self::toggle\_date\_i18n\_filters(false); |
| [1061](#L1061) | $date = date\_i18n($\_format); |
| [1062](#L1062) | self::toggle\_date\_i18n\_filters(true); |
| [1063](#L1063) |  |
| [1064](#L1064) | return $date; |
| [1065](#L1065) | } |
| [1066](#L1066) | // end date\_i18n |
| [1067](#L1067) |  |
| [1068](#L1068) | /\*\* |
| [1069](#L1069) | \* Sets the default values for all the options |
| [1070](#L1070) | \*/ |
| [1071](#L1071) | public static function init\_options() |
| [1072](#L1072) | { |
| [1073](#L1073) | return array( |
| [1074](#L1074) | 'version'                                => self::$version, |
| [1075](#L1075) | 'secret'                                 => wp\_hash(uniqid(time(), true)), |
| [1076](#L1076) | 'browscap\_last\_modified'                 => 0, |
| [1077](#L1077) |  |
| [1078](#L1078) | // General |
| [1079](#L1079) | // ----------------------------------------------------------------------- |
| [1080](#L1080) |  |
| [1081](#L1081) | // General - Tracker |
| [1082](#L1082) | 'is\_tracking'                            => 'on', |
| [1083](#L1083) | 'track\_admin\_pages'                      => 'no', |
| [1084](#L1084) | 'javascript\_mode'                        => 'on', |
| [1085](#L1085) |  |
| [1086](#L1086) | // General - WordPress Integration |
| [1087](#L1087) | 'add\_dashboard\_widgets'                  => 'on', |
| [1088](#L1088) | 'use\_separate\_menu'                      => 'no', |
| [1089](#L1089) | 'add\_posts\_column'                       => 'no', |
| [1090](#L1090) | 'posts\_column\_pageviews'                 => 'on', |
| [1091](#L1091) | 'hide\_addons'                            => 'no', |
| [1092](#L1092) |  |
| [1093](#L1093) | // General - Database |
| [1094](#L1094) | 'auto\_purge'                             => 0, |
| [1095](#L1095) | 'auto\_purge\_delete'                      => 'on', |
| [1096](#L1096) |  |
| [1097](#L1097) | // Tracker |
| [1098](#L1098) | // ----------------------------------------------------------------------- |
| [1099](#L1099) |  |
| [1100](#L1100) | // Tracker - Data Protection |
| [1101](#L1101) | 'anonymize\_ip'                           => 'no', |
| [1102](#L1102) | 'set\_tracker\_cookie'                     => 'on', |
| [1103](#L1103) | 'display\_opt\_out'                        => 'no', |
| [1104](#L1104) | 'opt\_out\_cookie\_names'                   => '', |
| [1105](#L1105) | 'opt\_in\_cookie\_names'                    => '', |
| [1106](#L1106) | 'opt\_out\_message'                        => '<p style="display:block;position:fixed;left:0;bottom:0;margin:0;padding:1em 2em;background-color:#eee;width:100%;z-index:99999;">This website stores cookies on your computer. These cookies are used to provide a more personalized experience and to track your whereabouts around our website in compliance with the European General Data Protection Regulation. If you decide to to opt-out of any future tracking, a cookie will be setup in your browser to remember this choice for one year.<br><br><a href="#" onclick="javascript:SlimStat.optout(event, false);">Accept</a> or <a href="#" onclick="javascript:SlimStat.optout(event, true);">Deny</a></p>', |
| [1107](#L1107) |  |
| [1108](#L1108) | // Tracker - Link Tracking |
| [1109](#L1109) | 'track\_same\_domain\_referers'             => 'no', |
| [1110](#L1110) | 'do\_not\_track\_outbound\_classes\_rel\_href' => 'noslimstat,ab-item', |
| [1111](#L1111) | 'extensions\_to\_track'                    => 'pdf,doc,xls,zip', |
| [1112](#L1112) |  |
| [1113](#L1113) | // Tracker - Advanced Options |
| [1114](#L1114) | 'geolocation\_country'                    => 'on', |
| [1115](#L1115) | 'session\_duration'                       => 1800, |
| [1116](#L1116) | 'extend\_session'                         => 'no', |
| [1117](#L1117) | 'enable\_cdn'                             => 'on', |
| [1118](#L1118) | 'ajax\_relative\_path'                     => 'no', |
| [1119](#L1119) |  |
| [1120](#L1120) | // Tracker - External Pages |
| [1121](#L1121) | 'external\_domains'                       => '', |
| [1122](#L1122) |  |
| [1123](#L1123) | // Reports |
| [1124](#L1124) | // ----------------------------------------------------------------------- |
| [1125](#L1125) |  |
| [1126](#L1126) | // Reports - Functionality |
| [1127](#L1127) | 'use\_current\_month\_timespan'             => 'no', |
| [1128](#L1128) | 'posts\_column\_day\_interval'              => 28, |
| [1129](#L1129) | 'rows\_to\_show'                           => '20', |
| [1130](#L1130) | 'show\_hits'                              => 'no', |
| [1131](#L1131) | 'ip\_lookup\_service'                      => 'https://www.infosniper.net/?ip\_address=', |
| [1132](#L1132) | 'comparison\_chart'                       => 'on', |
| [1133](#L1133) | 'show\_display\_name'                      => 'no', |
| [1134](#L1134) | 'convert\_resource\_urls\_to\_titles'        => 'on', |
| [1135](#L1135) | 'convert\_ip\_addresses'                   => 'no', |
| [1136](#L1136) |  |
| [1137](#L1137) | // Reports - Access Log and World Map |
| [1138](#L1138) | 'refresh\_interval'                       => '60', |
| [1139](#L1139) | 'number\_results\_raw\_data'                => '50', |
| [1140](#L1140) | 'max\_dots\_on\_map'                        => '50', |
| [1141](#L1141) |  |
| [1142](#L1142) | // Reports - Miscellaneous |
| [1143](#L1143) | 'custom\_css'                             => '', |
| [1144](#L1144) | 'chart\_colors'                           => '', |
| [1145](#L1145) | 'mozcom\_access\_id'                       => '', |
| [1146](#L1146) | 'mozcom\_secret\_key'                      => '', |
| [1147](#L1147) | 'show\_complete\_user\_agent\_tooltip'       => 'no', |
| [1148](#L1148) | 'async\_load'                             => 'no', |
| [1149](#L1149) | 'limit\_results'                          => '1000', |
| [1150](#L1150) | 'enable\_sov'                             => 'no', |
| [1151](#L1151) |  |
| [1152](#L1152) | // Exclusions |
| [1153](#L1153) | // ----------------------------------------------------------------------- |
| [1154](#L1154) |  |
| [1155](#L1155) | // Exclusions - User Properties |
| [1156](#L1156) | 'ignore\_wp\_users'                        => 'no', |
| [1157](#L1157) | 'ignore\_spammers'                        => 'on', |
| [1158](#L1158) | 'ignore\_bots'                            => 'no', |
| [1159](#L1159) | 'ignore\_prefetch'                        => 'on', |
| [1160](#L1160) | 'ignore\_users'                           => '', |
| [1161](#L1161) | 'ignore\_ip'                              => '', |
| [1162](#L1162) | 'ignore\_countries'                       => '', |
| [1163](#L1163) | 'ignore\_languages'                       => '', |
| [1164](#L1164) | 'ignore\_browsers'                        => '', |
| [1165](#L1165) | 'ignore\_platforms'                       => '', |
| [1166](#L1166) | 'ignore\_capabilities'                    => '', |
| [1167](#L1167) |  |
| [1168](#L1168) | // Exclusions - Page Properties |
| [1169](#L1169) | 'ignore\_resources'                       => '', |
| [1170](#L1170) | 'ignore\_referers'                        => '', |
| [1171](#L1171) | 'ignore\_content\_types'                   => '', |
| [1172](#L1172) |  |
| [1173](#L1173) | // Access Control |
| [1174](#L1174) | // ----------------------------------------------------------------------- |
| [1175](#L1175) |  |
| [1176](#L1176) | // Access Control - Reports |
| [1177](#L1177) | 'restrict\_authors\_view'                  => 'on', |
| [1178](#L1178) | 'capability\_can\_view'                    => 'manage\_options', |
| [1179](#L1179) | 'can\_view'                               => '', |
| [1180](#L1180) |  |
| [1181](#L1181) | // Access Control - Customizer |
| [1182](#L1182) | 'capability\_can\_customize'               => 'manage\_options', |
| [1183](#L1183) | 'can\_customize'                          => '', |
| [1184](#L1184) |  |
| [1185](#L1185) | // Access Control - Settings |
| [1186](#L1186) | 'capability\_can\_admin'                   => 'manage\_options', |
| [1187](#L1187) | 'can\_admin'                              => '', |
| [1188](#L1188) |  |
| [1189](#L1189) | // Access Control - REST API |
| [1190](#L1190) | 'rest\_api\_tokens'                        => wp\_hash(uniqid(time() - 3600, true)), |
| [1191](#L1191) |  |
| [1192](#L1192) | // Maintenance |
| [1193](#L1193) | // ----------------------------------------------------------------------- |
| [1194](#L1194) | 'last\_tracker\_error'                     => array(0, '', 0), |
| [1195](#L1195) | 'show\_sql\_debug'                         => 'no', |
| [1196](#L1196) | 'db\_indexes'                             => 'on', |
| [1197](#L1197) | 'enable\_maxmind'                         => 'no', |
| [1198](#L1198) | 'maxmind\_license\_key'                    => '', |
| [1199](#L1199) | 'enable\_browscap'                        => 'no', |
| [1200](#L1200) |  |
| [1201](#L1201) | // Notices |
| [1202](#L1202) | // ----------------------------------------------------------------------- |
| [1203](#L1203) | 'notice\_latest\_news'                     => 'on', |
| [1204](#L1204) | 'notice\_browscap'                        => 'on', |
| [1205](#L1205) | 'notice\_geolite'                         => 'on', |
| [1206](#L1206) | 'notice\_caching'                         => 'on', |
| [1207](#L1207) | 'notice\_translate'                       => 'on', |
| [1208](#L1208) |  |
| [1209](#L1209) | // Network-wide Settings |
| [1210](#L1210) | 'locked\_options'                         => '' |
| [1211](#L1211) | ); |
| [1212](#L1212) | } |
| [1213](#L1213) | // end init\_options |
| [1214](#L1214) |  |
| [1215](#L1215) | /\*\* |
| [1216](#L1216) | \* Saves a given option in the database |
| [1217](#L1217) | \*/ |
| [1218](#L1218) | public static function update\_option($\_key = '', $\_value = '') |
| [1219](#L1219) | { |
| [1220](#L1220) | if (!is\_network\_admin()) { |
| [1221](#L1221) | update\_option($\_key, $\_value); |
| [1222](#L1222) | } else { |
| [1223](#L1223) | update\_site\_option($\_key, $\_value); |
| [1224](#L1224) | } |
| [1225](#L1225) | } |
| [1226](#L1226) | // end update\_option |
| [1227](#L1227) |  |
| [1228](#L1228) | /\*\* |
| [1229](#L1229) | \* Attach a script to every page to track visitors' screen resolution and other browser-based information |
| [1230](#L1230) | \*/ |
| [1231](#L1231) | public static function enqueue\_tracker() |
| [1232](#L1232) | { |
| [1233](#L1233) | // Pass some information to the tracker |
| [1234](#L1234) | $params = array('ajaxurl' => admin\_url('admin-ajax.php')); |
| [1235](#L1235) |  |
| [1236](#L1236) | if (self::$settings['ajax\_relative\_path'] == 'on') { |
| [1237](#L1237) | $params['ajaxurl'] = admin\_url('admin-ajax.php', 'relative'); |
| [1238](#L1238) | } |
| [1239](#L1239) |  |
| [1240](#L1240) | $baseurl           = parse\_url(get\_home\_url()); |
| [1241](#L1241) | $params['baseurl'] = empty($baseurl['path']) ? '/' : $baseurl['path']; |
| [1242](#L1242) |  |
| [1243](#L1243) | if (!empty(self::$settings['do\_not\_track\_outbound\_classes\_rel\_href'])) { |
| [1244](#L1244) | $params['dnt'] = str\_replace(' ', '', self::$settings['do\_not\_track\_outbound\_classes\_rel\_href']); |
| [1245](#L1245) | } |
| [1246](#L1246) |  |
| [1247](#L1247) | // GDPR Compliance: test for third-party cookies to see if we need to display the opt-out message |
| [1248](#L1248) | if (self::$settings['display\_opt\_out'] == 'on') { |
| [1249](#L1249) | $params['oc'] = array('slimstat\_optout\_tracking'); |
| [1250](#L1250) | if (!empty(self::$settings['opt\_out\_cookie\_names'])) { |
| [1251](#L1251) | foreach (self::string\_to\_array(self::$settings['opt\_out\_cookie\_names']) as $a\_cookie\_pair) { |
| [1252](#L1252) | $params['oc'][] = substr($a\_cookie\_pair, 0, strpos($a\_cookie\_pair, '=')); |
| [1253](#L1253) | } |
| [1254](#L1254) | } |
| [1255](#L1255) |  |
| [1256](#L1256) | $params['oc'] = implode(',', $params['oc']); |
| [1257](#L1257) | } |
| [1258](#L1258) |  |
| [1259](#L1259) | if (self::$settings['javascript\_mode'] != 'on') { |
| [1260](#L1260) | // Do not enqueue the tracker if this page view was not tracked for some reason |
| [1261](#L1261) | if (empty(self::$stat['id']) || intval(self::$stat['id']) < 0) { |
| [1262](#L1262) | return false; |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | $params['id'] = self::\_get\_value\_with\_checksum(intval(self::$stat['id'])); |
| [1266](#L1266) | } else { |
| [1267](#L1267) | $params['ci'] = self::\_get\_value\_with\_checksum(self::\_base64\_url\_encode(serialize(self::\_get\_content\_info()))); |
| [1268](#L1268) | } |
| [1269](#L1269) |  |
| [1270](#L1270) | $params = apply\_filters('slimstat\_js\_params', $params); |
| [1271](#L1271) |  |
| [1272](#L1272) | if (self::$settings['enable\_cdn'] == 'on') { |
| [1273](#L1273) | wp\_register\_script('wp\_slimstat', 'https://cdn.jsdelivr.net/wp/wp-slimstat/tags/' . self::$version . '/wp-slimstat.min.js', array(), null, true); |
| [1274](#L1274) | } else { |
| [1275](#L1275) | $jstracker\_suffix = (defined('SCRIPT\_DEBUG') && is\_bool(SCRIPT\_DEBUG) && SCRIPT\_DEBUG) ? '' : '.min'; |
| [1276](#L1276) | wp\_register\_script('wp\_slimstat', plugins\_url("/wp-slimstat{$jstracker\_suffix}.js", \_\_FILE\_\_), array(), null, true); |
| [1277](#L1277) | } |
| [1278](#L1278) |  |
| [1279](#L1279) | wp\_enqueue\_script('wp\_slimstat'); |
| [1280](#L1280) | wp\_localize\_script('wp\_slimstat', 'SlimStatParams', $params); |
| [1281](#L1281) | } |
| [1282](#L1282) |  |
| [1283](#L1283) | // end enqueue\_tracker |
| [1284](#L1284) |  |
| [1285](#L1285) | public static function add\_defer\_to\_script\_tag($\_tag, $\_handle) |
| [1286](#L1286) | { |
| [1287](#L1287) | if ($\_handle === 'wp\_slimstat' && false === stripos($\_tag, 'defer')) { |
| [1288](#L1288) | $\_tag = str\_replace('<script ', '<script defer ', $\_tag); |
| [1289](#L1289) | } |
| [1290](#L1290) |  |
| [1291](#L1291) | return $\_tag; |
| [1292](#L1292) | } |
| [1293](#L1293) |  |
| [1294](#L1294) | /\*\* |
| [1295](#L1295) | \* Removes old entries from the main table and performs other daily tasks |
| [1296](#L1296) | \*/ |
| [1297](#L1297) | public static function wp\_slimstat\_purge() |
| [1298](#L1298) | { |
| [1299](#L1299) | $autopurge\_interval = intval(self::$settings['auto\_purge']); |
| [1300](#L1300) |  |
| [1301](#L1301) | if ($autopurge\_interval <= 0) { |
| [1302](#L1302) | return; |
| [1303](#L1303) | } |
| [1304](#L1304) |  |
| [1305](#L1305) | $days\_ago = strtotime(self::date\_i18n('Y-m-d H:i:s') . " -$autopurge\_interval days"); |
| [1306](#L1306) |  |
| [1307](#L1307) | // Copy entries to the archive table, if needed |
| [1308](#L1308) | if (self::$settings['auto\_purge\_delete'] != 'no') { |
| [1309](#L1309) | $is\_copy\_done = self::$wpdb->query(" |
| [1310](#L1310) | INSERT INTO {$GLOBALS['wpdb']->prefix}slim\_stats\_archive (id, ip, other\_ip, username, email, country, location, city, referer, resource, searchterms, notes, visit\_id, server\_latency, page\_performance, browser, browser\_version, browser\_type, platform, language, fingerprint, user\_agent, resolution, screen\_width, screen\_height, content\_type, category, author, content\_id, tz\_offset, outbound\_resource, dt\_out, dt) |
| [1311](#L1311) | SELECT id, ip, other\_ip, username, email, country, location, city, referer, resource, searchterms, notes, visit\_id, server\_latency, page\_performance, browser, browser\_version, browser\_type, platform, language, fingerprint, user\_agent, resolution, screen\_width, screen\_height, content\_type, category, author, content\_id, tz\_offset, outbound\_resource, dt\_out, dt |
| [1312](#L1312) | FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats |
| [1313](#L1313) | WHERE dt < $days\_ago"); |
| [1314](#L1314) |  |
| [1315](#L1315) | if ($is\_copy\_done !== false) { |
| [1316](#L1316) | self::$wpdb->query("DELETE ts FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats ts WHERE ts.dt < $days\_ago"); |
| [1317](#L1317) | } |
| [1318](#L1318) |  |
| [1319](#L1319) | $is\_copy\_done = self::$wpdb->query(" |
| [1320](#L1320) | INSERT INTO {$GLOBALS['wpdb']->prefix}slim\_events\_archive (type, event\_description, notes, position, id, dt) |
| [1321](#L1321) | SELECT type, event\_description, notes, position, id, dt |
| [1322](#L1322) | FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_events |
| [1323](#L1323) | WHERE dt < $days\_ago" |
| [1324](#L1324) | ); |
| [1325](#L1325) |  |
| [1326](#L1326) | if ($is\_copy\_done !== false) { |
| [1327](#L1327) | self::$wpdb->query("DELETE te FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_events te WHERE te.dt < $days\_ago"); |
| [1328](#L1328) | } |
| [1329](#L1329) | } else { |
| [1330](#L1330) | // Delete old entries |
| [1331](#L1331) | self::$wpdb->query("DELETE ts FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats ts WHERE ts.dt < $days\_ago"); |
| [1332](#L1332) | self::$wpdb->query("DELETE te FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_events te WHERE te.dt < $days\_ago"); |
| [1333](#L1333) | } |
| [1334](#L1334) |  |
| [1335](#L1335) | // Optimize tables |
| [1336](#L1336) | self::$wpdb->query("OPTIMIZE TABLE {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats"); |
| [1337](#L1337) | self::$wpdb->query("OPTIMIZE TABLE {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats\_archive"); |
| [1338](#L1338) | self::$wpdb->query("OPTIMIZE TABLE {$GLOBALS[ 'wpdb' ]->prefix}slim\_events"); |
| [1339](#L1339) | self::$wpdb->query("OPTIMIZE TABLE {$GLOBALS[ 'wpdb' ]->prefix}slim\_events\_archive"); |
| [1340](#L1340) | } |
| [1341](#L1341) |  |
| [1342](#L1342) | /\*\* |
| [1343](#L1343) | \* Displays the opt-out box via Ajax request |
| [1344](#L1344) | \*/ |
| [1345](#L1345) | public static function get\_optout\_html() |
| [1346](#L1346) | { |
| [1347](#L1347) | die(stripslashes(self::$settings['opt\_out\_message'])); |
| [1348](#L1348) | } |
| [1349](#L1349) |  |
| [1350](#L1350) | // end get\_optout\_html |
| [1351](#L1351) |  |
| [1352](#L1352) | public static function add\_plugin\_manual\_download\_link($\_links = array(), $\_plugin\_file = '') |
| [1353](#L1353) | { |
| [1354](#L1354) | $a\_clean\_slug = str\_replace(array('wp-slimstat-', '/index.php'), array('', ''), $\_plugin\_file); |
| [1355](#L1355) |  |
| [1356](#L1356) | if (false !== ($download\_url = get\_transient('wp-slimstat-download-link-' . $a\_clean\_slug))) { |
| [1357](#L1357) | $\_links[] = '<a href="' . $download\_url . '">Download ZIP</a>'; |
| [1358](#L1358) | } else { |
| [1359](#L1359) | $url      = 'https://www.wp-slimstat.com/update-checker/?slug=' . $a\_clean\_slug . '&key=' . urlencode(self::$settings['addon\_licenses']['wp-slimstat-' . $a\_clean\_slug]); |
| [1360](#L1360) | $response = wp\_safe\_remote\_get($url, array('timeout' => 300, 'user-agent' => 'Slimstat Analytics/' . self::$version . '; ' . home\_url())); |
| [1361](#L1361) |  |
| [1362](#L1362) | if (!is\_wp\_error($response) && 200 == wp\_remote\_retrieve\_response\_code($response)) { |
| [1363](#L1363) | $data = @json\_decode($response['body']); |
| [1364](#L1364) |  |
| [1365](#L1365) | if (is\_object($data)) { |
| [1366](#L1366) | $\_links[] = '<a href="' . $data->download\_url . '">Download ZIP</a>'; |
| [1367](#L1367) | set\_transient('wp-slimstat-download-link-' . $a\_clean\_slug, $data->download\_url, 172800); // 48 hours |
| [1368](#L1368) | } |
| [1369](#L1369) | } |
| [1370](#L1370) | } |
| [1371](#L1371) |  |
| [1372](#L1372) | return $\_links; |
| [1373](#L1373) | } |
| [1374](#L1374) |  |
| [1375](#L1375) | /\*\* |
| [1376](#L1376) | \* Resolves a given IP address, by keeping a local cache of hostnames to avoid multiple requests to the DNS server |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public static function gethostbyaddr($\_ip = '') |
| [1379](#L1379) | { |
| [1380](#L1380) | $hostname = get\_transient('slimstat\_' . $\_ip); |
| [1381](#L1381) |  |
| [1382](#L1382) | if (empty($hostname)) { |
| [1383](#L1383) | $hostname = gethostbyaddr($\_ip); |
| [1384](#L1384) | set\_transient('slimstat\_' . $\_ip, $hostname, HOUR\_IN\_SECONDS); |
| [1385](#L1385) | } |
| [1386](#L1386) |  |
| [1387](#L1387) | return $hostname; |
| [1388](#L1388) | } |
| [1389](#L1389) | // end gethostbyaddr |
| [1390](#L1390) |  |
| [1391](#L1391) | /\*\* |
| [1392](#L1392) | \* Registers the Slimstat widget |
| [1393](#L1393) | \*/ |
| [1394](#L1394) | public static function register\_widget() |
| [1395](#L1395) | { |
| [1396](#L1396) | return register\_widget("slimstat\_widget"); |
| [1397](#L1397) | } |
| [1398](#L1398) | // end register\_widget |
| [1399](#L1399) |  |
| [1400](#L1400) | /\*\* |
| [1401](#L1401) | \* Generates the key to see if a given host is listed as a search engine in the corresponding Json data file |
| [1402](#L1402) | \*/ |
| [1403](#L1403) | public static function get\_lossy\_url($\_url = '') |
| [1404](#L1404) | { |
| [1405](#L1405) | return preg\_replace( |
| [1406](#L1406) | array( |
| [1407](#L1407) | '/^(w+[0-9]\*|search)\./', |
| [1408](#L1408) | '/(^|\.)m\./', |
| [1409](#L1409) | '/(\.(com|org|net|co|it|edu))?\.(ad|ae|af|ag|ai|al|am|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bl|bm|bn|bo|bq|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cu|cv|cw|cx|cy|cz|de|dj|dk|dm|do|dz|ec|ee|eg|eh|er|es|et|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mf|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|ss|st|sv|sx|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tr|tt|tv|tw|tz|ua|ug|um|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw)(\/|$)/', |
| [1410](#L1410) | '/(^|\.)(ad|ae|af|ag|ai|al|am|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bl|bm|bn|bo|bq|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cu|cv|cw|cx|cy|cz|de|dj|dk|dm|do|dz|ec|ee|eg|eh|er|es|et|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mf|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|ss|st|sv|sx|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tr|tt|tv|tw|tz|ua|ug|um|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw)\./', |
| [1411](#L1411) | ), |
| [1412](#L1412) | array( |
| [1413](#L1413) | '', |
| [1414](#L1414) | '$1', |
| [1415](#L1415) | '.{}$4', |
| [1416](#L1416) | '$1{}.', |
| [1417](#L1417) | ), |
| [1418](#L1418) | $\_url); |
| [1419](#L1419) | } |
| [1420](#L1420) | // end get\_lossy\_url |
| [1421](#L1421) |  |
| [1422](#L1422) | /\*\* |
| [1423](#L1423) | \* Update content type as needed |
| [1424](#L1424) | \*/ |
| [1425](#L1425) | public static function update\_content\_type($\_status = 301, $\_location = '') |
| [1426](#L1426) | { |
| [1427](#L1427) | if ($\_status >= 300 && $\_status < 400) { |
| [1428](#L1428) | // SEE WHY THIS DOESN'T WORK?! |
| [1429](#L1429) | self::$stat['content\_type'] = 'redirect:' . intval($\_status); |
| [1430](#L1430) | self::\_update\_row(self::$stat); |
| [1431](#L1431) | } |
| [1432](#L1432) |  |
| [1433](#L1433) | return $\_status; |
| [1434](#L1434) | } |
| [1435](#L1435) | // end update\_content\_type |
| [1436](#L1436) |  |
| [1437](#L1437) | /\*\* |
| [1438](#L1438) | \* Stores the pageview information in the database and returns the ID associated to the new entry |
| [1439](#L1439) | \*/ |
| [1440](#L1440) | protected static function \_insert\_row($\_data = array(), $\_table = '') |
| [1441](#L1441) | { |
| [1442](#L1442) | if (empty($\_data) || empty($\_table)) { |
| [1443](#L1443) | return -1; |
| [1444](#L1444) | } |
| [1445](#L1445) |  |
| [1446](#L1446) | // Remove unwanted characters from keys (SQL injections, anyone?) |
| [1447](#L1447) | $data\_keys = array(); |
| [1448](#L1448) | foreach (array\_keys($\_data) as $a\_key) { |
| [1449](#L1449) | $data\_keys[] = sanitize\_key($a\_key); |
| [1450](#L1450) | } |
| [1451](#L1451) |  |
| [1452](#L1452) | // Remove unwanted characters from data (SQL injections, anyone?) |
| [1453](#L1453) | foreach ($\_data as $key => $value) { |
| [1454](#L1454) | if ($key == 'resource') { |
| [1455](#L1455) | $\_data[$key] = sanitize\_url($value); |
| [1456](#L1456) | } else { |
| [1457](#L1457) | $\_data[$key] = sanitize\_text\_field($value); |
| [1458](#L1458) | } |
| [1459](#L1459) | } |
| [1460](#L1460) |  |
| [1461](#L1461) | self::$wpdb->query(self::$wpdb->prepare(" |
| [1462](#L1462) | INSERT IGNORE INTO $\_table (" . implode(", ", $data\_keys) . ') |
| [1463](#L1463) | VALUES (' . substr(str\_repeat('%s,', count($\_data)), 0, -1) . ")", $\_data)); |
| [1464](#L1464) |  |
| [1465](#L1465) | return intval(self::$wpdb->insert\_id); |
| [1466](#L1466) | } |
| [1467](#L1467) | // end \_insert\_row |
| [1468](#L1468) |  |
| [1469](#L1469) | /\*\* |
| [1470](#L1470) | \* Updates an existing row |
| [1471](#L1471) | \*/ |
| [1472](#L1472) | protected static function \_update\_row($\_data = array()) |
| [1473](#L1473) | { |
| [1474](#L1474) | if (empty($\_data) || empty($\_data['id'])) { |
| [1475](#L1475) | return false; |
| [1476](#L1476) | } |
| [1477](#L1477) |  |
| [1478](#L1478) | // Extract the ID from the array |
| [1479](#L1479) | $id = abs(intval($\_data['id'])); |
| [1480](#L1480) | unset($\_data['id']); |
| [1481](#L1481) |  |
| [1482](#L1482) | // Sanitize column names (SQL/XSS injections, anyone?) |
| [1483](#L1483) | $\_data = array\_filter($\_data); |
| [1484](#L1484) |  |
| [1485](#L1485) | // The 'notes' column stores multiple comma-separated values: we need to append the new value to the existing ones |
| [1486](#L1486) | // Also, values are organized in an array, which we need to implode as a string |
| [1487](#L1487) | $notes = ''; |
| [1488](#L1488) | if (!empty($\_data['notes']) && is\_array($\_data['notes'])) { |
| [1489](#L1489) | $notes = (count($\_data) > 1 ? ',' : '') . "notes=CONCAT( IFNULL( notes, '' ), '[" . esc\_sql(implode('][', $\_data['notes'])) . "]' )"; |
| [1490](#L1490) | unset($\_data['notes']); |
| [1491](#L1491) | } |
| [1492](#L1492) |  |
| [1493](#L1493) | $prepared\_query = self::$wpdb->prepare(" |
| [1494](#L1494) | UPDATE IGNORE {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats |
| [1495](#L1495) | SET " . implode('=%s,', array\_keys($\_data)) . "=%s |
| [1496](#L1496) | WHERE id = $id |
| [1497](#L1497) | ", $\_data); |
| [1498](#L1498) |  |
| [1499](#L1499) | // Add the notes |
| [1500](#L1500) | if (!empty($notes)) { |
| [1501](#L1501) | $prepared\_query = str\_replace('WHERE id =', $notes . ' WHERE id =', $prepared\_query); |
| [1502](#L1502) | } |
| [1503](#L1503) |  |
| [1504](#L1504) | // Save the data in the database |
| [1505](#L1505) | self::$wpdb->query($prepared\_query); |
| [1506](#L1506) |  |
| [1507](#L1507) | return $id; |
| [1508](#L1508) | } |
| [1509](#L1509) | // end \_update\_row |
| [1510](#L1510) |  |
| [1511](#L1511) | /\*\* |
| [1512](#L1512) | \* Tries to find the user's REAL IP address |
| [1513](#L1513) | \*/ |
| [1514](#L1514) | protected static function \_get\_remote\_ip() |
| [1515](#L1515) | { |
| [1516](#L1516) | $ip\_array = array('', ''); |
| [1517](#L1517) |  |
| [1518](#L1518) | if (!empty($\_SERVER['REMOTE\_ADDR']) && filter\_var($\_SERVER['REMOTE\_ADDR'], FILTER\_VALIDATE\_IP) !== false) { |
| [1519](#L1519) | $ip\_array[0] = sanitize\_text\_field(wp\_unslash($\_SERVER['REMOTE\_ADDR'])); |
| [1520](#L1520) | } |
| [1521](#L1521) |  |
| [1522](#L1522) | $originating\_ip\_headers = array('X-Forwarded-For', 'HTTP\_X\_FORWARDED\_FOR', 'CF-Connecting-IP', 'HTTP\_CLIENT\_IP', 'HTTP\_X\_REAL\_IP', 'HTTP\_FORWARDED', 'HTTP\_X\_FORWARDED'); |
| [1523](#L1523) | foreach ($originating\_ip\_headers as $a\_header) { |
| [1524](#L1524) | if (!empty($\_SERVER[$a\_header])) { |
| [1525](#L1525) | foreach (explode(',', $\_SERVER[$a\_header]) as $a\_ip) { |
| [1526](#L1526) | if (filter\_var($a\_ip, FILTER\_VALIDATE\_IP) !== false && $a\_ip != $ip\_array[0]) { |
| [1527](#L1527) | $ip\_array[1] = $a\_ip; |
| [1528](#L1528) | break; |
| [1529](#L1529) | } |
| [1530](#L1530) | } |
| [1531](#L1531) | } |
| [1532](#L1532) | } |
| [1533](#L1533) |  |
| [1534](#L1534) | return apply\_filters('slimstat\_filter\_ip\_address', $ip\_array); |
| [1535](#L1535) | } |
| [1536](#L1536) | // end \_get\_remote\_ip |
| [1537](#L1537) |  |
| [1538](#L1538) | /\*\* |
| [1539](#L1539) | \* Extracts the accepted language from browser headers |
| [1540](#L1540) | \*/ |
| [1541](#L1541) | protected static function \_get\_language() |
| [1542](#L1542) | { |
| [1543](#L1543) | if (isset($\_SERVER['HTTP\_ACCEPT\_LANGUAGE'])) { |
| [1544](#L1544) |  |
| [1545](#L1545) | // Capture up to the first delimiter (, found in Safari) |
| [1546](#L1546) | preg\_match("/([^,;]\*)/", $\_SERVER['HTTP\_ACCEPT\_LANGUAGE'], $array\_languages); |
| [1547](#L1547) |  |
| [1548](#L1548) | // Fix some codes, the correct syntax is with minus (-) not underscore (\_) |
| [1549](#L1549) | return str\_replace('\_', '-', strtolower($array\_languages[0])); |
| [1550](#L1550) | } |
| [1551](#L1551) | return '';  // Indeterminable language |
| [1552](#L1552) | } |
| [1553](#L1553) | // end \_get\_language |
| [1554](#L1554) |  |
| [1555](#L1555) | /\*\* |
| [1556](#L1556) | \* Sniffs out referrals from search engines and tries to determine the query string |
| [1557](#L1557) | \*/ |
| [1558](#L1558) | protected static function \_get\_search\_terms($\_url = '') |
| [1559](#L1559) | { |
| [1560](#L1560) | if (empty($\_url)) { |
| [1561](#L1561) | return ''; |
| [1562](#L1562) | } |
| [1563](#L1563) |  |
| [1564](#L1564) | $searchterms = ''; |
| [1565](#L1565) |  |
| [1566](#L1566) | // Load the search engines list to mark pageviews accordingly |
| [1567](#L1567) | // Each entry contains the following attributes |
| [1568](#L1568) | // - params: which query string params is associated to the search keyword |
| [1569](#L1569) | // - backlink: format of the URL point to the search engine result page |
| [1570](#L1570) | // - charsets: list of charset used to encode the keywords |
| [1571](#L1571) | // |
| [1572](#L1572) | $search\_engines = file\_get\_contents(plugin\_dir\_path(\_\_FILE\_\_) . 'vendor/matomo-searchengine.json'); |
| [1573](#L1573) | $search\_engines = json\_decode($search\_engines, TRUE); |
| [1574](#L1574) |  |
| [1575](#L1575) | $parsed\_url = @parse\_url($\_url); |
| [1576](#L1576) |  |
| [1577](#L1577) | if (empty($search\_engines) || empty($parsed\_url) || empty($parsed\_url['host'])) { |
| [1578](#L1578) | return ''; |
| [1579](#L1579) | } |
| [1580](#L1580) |  |
| [1581](#L1581) | $sek = self::get\_lossy\_url($parsed\_url['host']); |
| [1582](#L1582) |  |
| [1583](#L1583) | if (!empty($search\_engines[$sek])) { |
| [1584](#L1584) | if (empty($search\_engines[$sek]['params'])) { |
| [1585](#L1585) | $search\_engines[$sek]['params'] = array('q'); |
| [1586](#L1586) | } |
| [1587](#L1587) |  |
| [1588](#L1588) | foreach ($search\_engines[$sek]['params'] as $a\_param) { |
| [1589](#L1589) | if (!empty($parsed\_url['query'])) { |
| [1590](#L1590) | $searchterms = self::\_get\_param\_from\_query\_string($parsed\_url['query'], $a\_param); |
| [1591](#L1591) | if (!empty($searchterms)) { |
| [1592](#L1592) | break; |
| [1593](#L1593) | } |
| [1594](#L1594) | } |
| [1595](#L1595) | } |
| [1596](#L1596) |  |
| [1597](#L1597) | // Make sure to use the appropriate charset, if specified |
| [1598](#L1598) | if (!empty($searchterms)) { |
| [1599](#L1599) | if (!empty($search\_engines['charsets']) && function\_exists('iconv')) { |
| [1600](#L1600) | $charset = $search\_engines['charsets'][0]; |
| [1601](#L1601) | if (count($search\_engines['charsets']) > 1 && function\_exists('mb\_detect\_encoding')) { |
| [1602](#L1602) | $charset = mb\_detect\_encoding($searchterms, $search\_engines['charsets']); |
| [1603](#L1603) | if ($charset === false) { |
| [1604](#L1604) | $charset = $search\_engines['charsets'][0]; |
| [1605](#L1605) | } |
| [1606](#L1606) | } |
| [1607](#L1607) |  |
| [1608](#L1608) | $new\_searchterms = @iconv($charset, 'UTF-8//IGNORE', $searchterms); |
| [1609](#L1609) | if (!empty($new\_searchterms)) { |
| [1610](#L1610) | $searchterms = $new\_searchterms; |
| [1611](#L1611) | } |
| [1612](#L1612) | } |
| [1613](#L1613) | } |
| [1614](#L1614) | } else if (!empty($parsed\_url['query'])) { |
| [1615](#L1615) | // We weren't lucky, but there's still hope |
| [1616](#L1616) | foreach (array('ask', 'k', 'q', 'qs', 'qt', 'query', 's', 'string') as $a\_param) { |
| [1617](#L1617) | $searchterms = self::\_get\_param\_from\_query\_string($parsed\_url['query'], $a\_param); |
| [1618](#L1618) | if (!empty($searchterms)) { |
| [1619](#L1619) | break; |
| [1620](#L1620) | } |
| [1621](#L1621) | } |
| [1622](#L1622) | } |
| [1623](#L1623) |  |
| [1624](#L1624) | return sanitize\_text\_field($searchterms); |
| [1625](#L1625) | } |
| [1626](#L1626) | // end \_get\_search\_terms |
| [1627](#L1627) |  |
| [1628](#L1628) | /\*\* |
| [1629](#L1629) | \* Retrieves a param value from a string treated as a URL query string |
| [1630](#L1630) | \*/ |
| [1631](#L1631) | protected static function \_get\_param\_from\_query\_string($\_query = '', $\_parameter = '') |
| [1632](#L1632) | { |
| [1633](#L1633) | if (empty($\_query)) { |
| [1634](#L1634) | return ''; |
| [1635](#L1635) | } |
| [1636](#L1636) |  |
| [1637](#L1637) | $parsed\_query = @parse\_str($\_query, $values); |
| [1638](#L1638) |  |
| [1639](#L1639) | return !empty($values[$\_parameter]) ? $values[$\_parameter] : ''; |
| [1640](#L1640) | } |
| [1641](#L1641) | // end \_get\_param\_from\_query\_string |
| [1642](#L1642) |  |
| [1643](#L1643) | /\*\* |
| [1644](#L1644) | \* Returns details about the resource being accessed |
| [1645](#L1645) | \*/ |
| [1646](#L1646) | protected static function \_get\_content\_info() |
| [1647](#L1647) | { |
| [1648](#L1648) | $content\_info = array('content\_type' => ''); |
| [1649](#L1649) |  |
| [1650](#L1650) | // Mark 404 pages |
| [1651](#L1651) | if (is\_404()) { |
| [1652](#L1652) | $content\_info['content\_type'] = '404'; |
| [1653](#L1653) | } // Type |
| [1654](#L1654) | else if (is\_single()) { |
| [1655](#L1655) | if (($post\_type = get\_post\_type()) != 'post') { |
| [1656](#L1656) | $post\_type = 'cpt:' . $post\_type; |
| [1657](#L1657) | } |
| [1658](#L1658) |  |
| [1659](#L1659) | $content\_info['content\_type'] = $post\_type; |
| [1660](#L1660) | $category\_ids                 = array(); |
| [1661](#L1661) | foreach (get\_object\_taxonomies($GLOBALS['post']) as $a\_taxonomy) { |
| [1662](#L1662) | $terms = get\_the\_terms($GLOBALS['post']->ID, $a\_taxonomy); |
| [1663](#L1663) | if (is\_array($terms)) { |
| [1664](#L1664) | foreach ($terms as $a\_term) { |
| [1665](#L1665) | $category\_ids[] = $a\_term->term\_id; |
| [1666](#L1666) | } |
| [1667](#L1667) | $content\_info['category'] = implode(',', $category\_ids); |
| [1668](#L1668) | } |
| [1669](#L1669) | } |
| [1670](#L1670) | $content\_info['content\_id'] = $GLOBALS['post']->ID; |
| [1671](#L1671) | } else if (is\_page()) { |
| [1672](#L1672) | $content\_info['content\_type'] = 'page'; |
| [1673](#L1673) | $content\_info['content\_id']   = $GLOBALS['post']->ID; |
| [1674](#L1674) | } elseif (is\_attachment()) { |
| [1675](#L1675) | $content\_info['content\_type'] = 'attachment'; |
| [1676](#L1676) | } elseif (is\_singular()) { |
| [1677](#L1677) | $content\_info['content\_type'] = 'singular'; |
| [1678](#L1678) | } elseif (is\_post\_type\_archive()) { |
| [1679](#L1679) | $content\_info['content\_type'] = 'post\_type\_archive'; |
| [1680](#L1680) | } elseif (is\_tag()) { |
| [1681](#L1681) | $content\_info['content\_type'] = 'tag'; |
| [1682](#L1682) | $list\_tags                    = get\_the\_tags(); |
| [1683](#L1683) | if (is\_array($list\_tags)) { |
| [1684](#L1684) | $tag\_info = array\_pop($list\_tags); |
| [1685](#L1685) | if (!empty($tag\_info)) { |
| [1686](#L1686) | $content\_info['category'] = $tag\_info->term\_id; |
| [1687](#L1687) | } |
| [1688](#L1688) | } |
| [1689](#L1689) | } elseif (is\_tax()) { |
| [1690](#L1690) | $content\_info['content\_type'] = 'taxonomy'; |
| [1691](#L1691) | } elseif (is\_category()) { |
| [1692](#L1692) | $content\_info['content\_type'] = 'category'; |
| [1693](#L1693) | $list\_categories              = get\_the\_category(); |
| [1694](#L1694) | if (is\_array($list\_categories)) { |
| [1695](#L1695) | $cat\_info = array\_pop($list\_categories); |
| [1696](#L1696) | if (!empty($cat\_info)) { |
| [1697](#L1697) | $content\_info['category'] = $cat\_info->term\_id; |
| [1698](#L1698) | } |
| [1699](#L1699) | } |
| [1700](#L1700) | } else if (is\_date()) { |
| [1701](#L1701) | $content\_info['content\_type'] = 'date'; |
| [1702](#L1702) | } else if (is\_author()) { |
| [1703](#L1703) | $content\_info['content\_type'] = 'author'; |
| [1704](#L1704) | } else if (is\_archive()) { |
| [1705](#L1705) | $content\_info['content\_type'] = 'archive'; |
| [1706](#L1706) | } else if (is\_search()) { |
| [1707](#L1707) | $content\_info['content\_type'] = 'search'; |
| [1708](#L1708) | } else if (is\_feed()) { |
| [1709](#L1709) | $content\_info['content\_type'] = 'feed'; |
| [1710](#L1710) | } else if (is\_home() || is\_front\_page()) { |
| [1711](#L1711) | $content\_info['content\_type'] = 'home'; |
| [1712](#L1712) | } else if (!empty($GLOBALS['pagenow']) && $GLOBALS['pagenow'] == 'wp-login.php') { |
| [1713](#L1713) | $content\_info['content\_type'] = 'login'; |
| [1714](#L1714) | } else if (!empty($GLOBALS['pagenow']) && $GLOBALS['pagenow'] == 'wp-register.php') { |
| [1715](#L1715) | $content\_info['content\_type'] = 'registration'; |
| [1716](#L1716) | } // WordPress sets is\_admin() to true for all ajax requests ( front-end or admin-side ) |
| [1717](#L1717) | elseif (is\_admin() && (!defined('DOING\_AJAX') || !DOING\_AJAX)) { |
| [1718](#L1718) | $content\_info['content\_type'] = 'admin'; |
| [1719](#L1719) | } |
| [1720](#L1720) |  |
| [1721](#L1721) | if (is\_paged()) { |
| [1722](#L1722) | $content\_info['content\_type'] .= ':paged'; |
| [1723](#L1723) | } |
| [1724](#L1724) |  |
| [1725](#L1725) | // Author |
| [1726](#L1726) | if (is\_singular()) { |
| [1727](#L1727) | $author = get\_the\_author\_meta('user\_login', $GLOBALS['post']->post\_author); |
| [1728](#L1728) | if (!empty($author)) { |
| [1729](#L1729) | $content\_info['author'] = $author; |
| [1730](#L1730) | } |
| [1731](#L1731) | } |
| [1732](#L1732) |  |
| [1733](#L1733) | return $content\_info; |
| [1734](#L1734) | } |
| [1735](#L1735) | // end \_get\_content\_info |
| [1736](#L1736) |  |
| [1737](#L1737) | /\*\* |
| [1738](#L1738) | \* Reads the information sent by the Javascript tracker and adds it to the $\_stat array |
| [1739](#L1739) | \*/ |
| [1740](#L1740) | protected static function \_get\_client\_info($\_data\_js = array(), $\_stat = array()) |
| [1741](#L1741) | { |
| [1742](#L1742) | if (!empty($\_data\_js['bw'])) { |
| [1743](#L1743) | $\_stat['resolution'] = strip\_tags(trim($\_data\_js['bw'] . 'x' . $\_data\_js['bh'])); |
| [1744](#L1744) | } |
| [1745](#L1745) | if (!empty($\_data\_js['sw'])) { |
| [1746](#L1746) | $\_stat['screen\_width'] = intval($\_data\_js['sw']); |
| [1747](#L1747) | } |
| [1748](#L1748) | if (!empty($\_data\_js['sh'])) { |
| [1749](#L1749) | $\_stat['screen\_height'] = intval($\_data\_js['sh']); |
| [1750](#L1750) | } |
| [1751](#L1751) | if (!empty($\_data\_js['sl']) && $\_data\_js['sl'] > 0 && $\_data\_js['sl'] < 60000) { |
| [1752](#L1752) | $\_stat['server\_latency'] = intval($\_data\_js['sl']); |
| [1753](#L1753) | } |
| [1754](#L1754) | if (!empty($\_data\_js['pp']) && $\_data\_js['pp'] > 0 && $\_data\_js['pp'] < 60000) { |
| [1755](#L1755) | $\_stat['page\_performance'] = intval($\_data\_js['pp']); |
| [1756](#L1756) | } |
| [1757](#L1757) | if (!empty($\_data\_js['fh']) && self::$settings['anonymize\_ip'] != 'on') { |
| [1758](#L1758) | $\_stat['fingerprint'] = sanitize\_text\_field($\_data\_js['fh']); |
| [1759](#L1759) | } |
| [1760](#L1760) | if (!empty($\_data\_js['tz'])) { |
| [1761](#L1761) | $\_stat['tz\_offset'] = intval($\_data\_js['tz']); |
| [1762](#L1762) | } |
| [1763](#L1763) |  |
| [1764](#L1764) | return $\_stat; |
| [1765](#L1765) | } |
| [1766](#L1766) | // end \_get\_client\_info |
| [1767](#L1767) |  |
| [1768](#L1768) | /\*\* |
| [1769](#L1769) | \* Reads the cookie to get the visit\_id and sets the variable accordingly |
| [1770](#L1770) | \*/ |
| [1771](#L1771) | protected static function \_set\_visit\_id($\_force\_assign = false) |
| [1772](#L1772) | { |
| [1773](#L1773) | $is\_new\_session = true; |
| [1774](#L1774) | $identifier     = 0; |
| [1775](#L1775) |  |
| [1776](#L1776) | if (isset($\_COOKIE['slimstat\_tracking\_code'])) { |
| [1777](#L1777) | // Make sure only authorized information is recorded |
| [1778](#L1778) | $identifier = self::\_get\_value\_without\_checksum($\_COOKIE['slimstat\_tracking\_code']); |
| [1779](#L1779) | if ($identifier === false) { |
| [1780](#L1780) | return false; |
| [1781](#L1781) | } |
| [1782](#L1782) |  |
| [1783](#L1783) | $is\_new\_session = (strpos($identifier, 'id') !== false); |
| [1784](#L1784) | $identifier     = intval($identifier); |
| [1785](#L1785) | } |
| [1786](#L1786) |  |
| [1787](#L1787) | // User doesn't have an active session |
| [1788](#L1788) | if ($is\_new\_session && ($\_force\_assign || self::$settings['javascript\_mode'] == 'on')) { |
| [1789](#L1789) | if (empty(self::$settings['session\_duration'])) { |
| [1790](#L1790) | self::$settings['session\_duration'] = 1800; |
| [1791](#L1791) | } |
| [1792](#L1792) |  |
| [1793](#L1793) | self::$stat['visit\_id'] = get\_transient('slimstat\_visit\_id'); |
| [1794](#L1794) | if (self::$stat['visit\_id'] === false) { |
| [1795](#L1795) | self::$stat['visit\_id'] = intval(self::$wpdb->get\_var("SELECT MAX( visit\_id ) FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats")); |
| [1796](#L1796) | } |
| [1797](#L1797) | self::$stat['visit\_id']++; |
| [1798](#L1798) | set\_transient('slimstat\_visit\_id', self::$stat['visit\_id']); |
| [1799](#L1799) |  |
| [1800](#L1800) | $set\_cookie = apply\_filters('slimstat\_set\_visit\_cookie', (!empty(self::$settings['set\_tracker\_cookie']) && self::$settings['set\_tracker\_cookie'] == 'on')); |
| [1801](#L1801) | if ($set\_cookie) { |
| [1802](#L1802) | @setcookie( |
| [1803](#L1803) | 'slimstat\_tracking\_code', |
| [1804](#L1804) | self::\_get\_value\_with\_checksum(self::$stat['visit\_id']), |
| [1805](#L1805) | time() + self::$settings['session\_duration'], |
| [1806](#L1806) | COOKIEPATH |
| [1807](#L1807) | ); |
| [1808](#L1808) | } |
| [1809](#L1809) |  |
| [1810](#L1810) | } elseif ($identifier > 0) { |
| [1811](#L1811) | self::$stat['visit\_id'] = $identifier; |
| [1812](#L1812) | } |
| [1813](#L1813) |  |
| [1814](#L1814) | if ($is\_new\_session && $identifier > 0) { |
| [1815](#L1815) | self::$wpdb->query(self::$wpdb->prepare(" |
| [1816](#L1816) | UPDATE {$GLOBALS['wpdb']->prefix}slim\_stats |
| [1817](#L1817) | SET visit\_id = %d |
| [1818](#L1818) | WHERE id = %d AND visit\_id = 0", self::$stat['visit\_id'], $identifier |
| [1819](#L1819) | )); |
| [1820](#L1820) | } |
| [1821](#L1821) | return ($is\_new\_session && ($\_force\_assign || self::$settings['javascript\_mode'] == 'on')); |
| [1822](#L1822) | } |
| [1823](#L1823) | // end \_set\_visit\_id |
| [1824](#L1824) |  |
| [1825](#L1825) | /\*\* |
| [1826](#L1826) | \* Saves an error detected by the tracker in the database |
| [1827](#L1827) | \*/ |
| [1828](#L1828) | protected static function \_log\_error($\_error\_code = 0) |
| [1829](#L1829) | { |
| [1830](#L1830) | // Save this error in the database |
| [1831](#L1831) | self::update\_option('slimstat\_tracker\_error', array($\_error\_code, self::date\_i18n('U'))); |
| [1832](#L1832) |  |
| [1833](#L1833) | // Allow third-party code to trigger actions based on this error |
| [1834](#L1834) | do\_action('slimstat\_track\_exit\_' . abs($\_error\_code), self::$stat); |
| [1835](#L1835) |  |
| [1836](#L1836) | return -$\_error\_code; |
| [1837](#L1837) | } |
| [1838](#L1838) |  |
| [1839](#L1839) | // end \_log\_error |
| [1840](#L1840) |  |
| [1841](#L1841) | protected static function \_get\_value\_with\_checksum($\_value = 0) |
| [1842](#L1842) | { |
| [1843](#L1843) | return $\_value . '.' . md5($\_value . self::$settings['secret']); |
| [1844](#L1844) | } |
| [1845](#L1845) |  |
| [1846](#L1846) | protected static function \_get\_value\_without\_checksum($\_value\_with\_checksum = '') |
| [1847](#L1847) | { |
| [1848](#L1848) | list($value, $checksum) = explode('.', $\_value\_with\_checksum); |
| [1849](#L1849) |  |
| [1850](#L1850) | if ($checksum === md5($value . self::$settings['secret'])) { |
| [1851](#L1851) | return $value; |
| [1852](#L1852) | } |
| [1853](#L1853) |  |
| [1854](#L1854) | return false; |
| [1855](#L1855) | } |
| [1856](#L1856) |  |
| [1857](#L1857) | /\*\* |
| [1858](#L1858) | \* Determines if a given string is listed in the corresponding 'exclusion' field |
| [1859](#L1859) | \*/ |
| [1860](#L1860) | protected static function \_is\_blacklisted($\_needles = array(), $\_haystack\_string = '') |
| [1861](#L1861) | { |
| [1862](#L1862) | foreach (self::string\_to\_array($\_haystack\_string) as $a\_item) { |
| [1863](#L1863) | $pattern = str\_replace(array('\\*', '\!'), array('(.\*)', '.'), preg\_quote($a\_item, '@')); |
| [1864](#L1864) |  |
| [1865](#L1865) | if (!is\_array($\_needles)) { |
| [1866](#L1866) | $\_needles = array($\_needles); |
| [1867](#L1867) | } |
| [1868](#L1868) |  |
| [1869](#L1869) | foreach ($\_needles as $a\_needle) { |
| [1870](#L1870) | if (preg\_match("@^$pattern$@i", $a\_needle)) { |
| [1871](#L1871) | return true; |
| [1872](#L1872) | } |
| [1873](#L1873) | } |
| [1874](#L1874) | } |
| [1875](#L1875) |  |
| [1876](#L1876) | return false; |
| [1877](#L1877) | } |
| [1878](#L1878) | // end \_is\_blacklisted |
| [1879](#L1879) |  |
| [1880](#L1880) | /\*\* |
| [1881](#L1881) | \* Determines if this is a new visitor, meaning that we've never seen this fingerprint before |
| [1882](#L1882) | \*/ |
| [1883](#L1883) | protected static function \_is\_new\_visitor($\_fingerprint = '') |
| [1884](#L1884) | { |
| [1885](#L1885) | // If the privacy option is enabled, all visitors would be considered "new"... |
| [1886](#L1886) | if (self::$settings['anonymize\_ip'] == 'on') { |
| [1887](#L1887) | return false; |
| [1888](#L1888) | } |
| [1889](#L1889) |  |
| [1890](#L1890) | $count\_fingerprint = self::$wpdb->get\_var(self::$wpdb->prepare(" |
| [1891](#L1891) | SELECT COUNT( id ) |
| [1892](#L1892) | FROM {$GLOBALS[ 'wpdb' ]->prefix}slim\_stats |
| [1893](#L1893) | WHERE fingerprint = %s", $\_fingerprint |
| [1894](#L1894) | )); |
| [1895](#L1895) |  |
| [1896](#L1896) | return $count\_fingerprint == 0; |
| [1897](#L1897) | } |
| [1898](#L1898) | // end \_is\_new\_visitor |
| [1899](#L1899) |  |
| [1900](#L1900) | /\*\* |
| [1901](#L1901) | \* Validates and unpacks an IP Address |
| [1902](#L1902) | \*/ |
| [1903](#L1903) | protected static function \_dtr\_pton($\_ip) |
| [1904](#L1904) | { |
| [1905](#L1905) | if (filter\_var($\_ip, FILTER\_VALIDATE\_IP, FILTER\_FLAG\_IPV4)) { |
| [1906](#L1906) | $unpacked = unpack('A4', inet\_pton($\_ip)); |
| [1907](#L1907) | } else if (filter\_var($\_ip, FILTER\_VALIDATE\_IP, FILTER\_FLAG\_IPV6) && defined('AF\_INET6')) { |
| [1908](#L1908) | $unpacked = unpack('A16', inet\_pton($\_ip)); |
| [1909](#L1909) | } |
| [1910](#L1910) |  |
| [1911](#L1911) | $binary\_ip = ''; |
| [1912](#L1912) | if (!empty($unpacked)) { |
| [1913](#L1913) | $unpacked = str\_split($unpacked[1]); |
| [1914](#L1914) | foreach ($unpacked as $char) { |
| [1915](#L1915) | $binary\_ip .= str\_pad(decbin(ord($char)), 8, '0', STR\_PAD\_LEFT); |
| [1916](#L1916) | } |
| [1917](#L1917) | } |
| [1918](#L1918) |  |
| [1919](#L1919) | return $binary\_ip; |
| [1920](#L1920) | } |
| [1921](#L1921) | // end \_dtr\_pton |
| [1922](#L1922) |  |
| [1923](#L1923) | /\*\* |
| [1924](#L1924) | \* Helper function to determine if we should ignore visits coming from this IP address |
| [1925](#L1925) | \*/ |
| [1926](#L1926) | protected static function \_get\_mask\_length($ip) |
| [1927](#L1927) | { |
| [1928](#L1928) | if (filter\_var($ip, FILTER\_VALIDATE\_IP, FILTER\_FLAG\_IPV4)) { |
| [1929](#L1929) | return 32; |
| [1930](#L1930) | } else if (filter\_var($ip, FILTER\_VALIDATE\_IP, FILTER\_FLAG\_IPV6)) { |
| [1931](#L1931) | return 128; |
| [1932](#L1932) | } |
| [1933](#L1933) |  |
| [1934](#L1934) | return false; |
| [1935](#L1935) | } |
| [1936](#L1936) | // end \_get\_mask\_length |
| [1937](#L1937) |  |
| [1938](#L1938) | /\*\* |
| [1939](#L1939) | \* These two functions here implement an URL-safe base64 string |
| [1940](#L1940) | \*/ |
| [1941](#L1941) | protected static function \_base64\_url\_encode($\_input = '') |
| [1942](#L1942) | { |
| [1943](#L1943) | return strtr(base64\_encode($\_input), '+/=', '.\_-'); |
| [1944](#L1944) | } |
| [1945](#L1945) |  |
| [1946](#L1946) | protected static function \_base64\_url\_decode($\_input = '') |
| [1947](#L1947) | { |
| [1948](#L1948) | return strip\_tags(trim(base64\_decode(strtr($\_input, '.\_-', '+/=')))); |
| [1949](#L1949) | } |
| [1950](#L1950) | // end \_base64\_url\_encode/decode |
| [1951](#L1951) | } |
| [1952](#L1952) |  |
| [1953](#L1953) | // end of class declaration |
| [1954](#L1954) |  |
| [1955](#L1955) | class slimstat\_widget extends WP\_Widget |
| [1956](#L1956) | { |
| [1957](#L1957) | /\*\* |
| [1958](#L1958) | \* Sets up the widgets name etc |
| [1959](#L1959) | \*/ |
| [1960](#L1960) | public function \_\_construct() |
| [1961](#L1961) | { |
| [1962](#L1962) | parent::\_\_construct('slimstat\_widget', 'Slimstat', array( |
| [1963](#L1963) | 'classname'   => 'slimstat\_widget', |
| [1964](#L1964) | 'description' => 'Add a Slimstat report to your sidebar', |
| [1965](#L1965) | )); |
| [1966](#L1966) | } |
| [1967](#L1967) |  |
| [1968](#L1968) | /\*\* |
| [1969](#L1969) | \* Outputs the content of the widget |
| [1970](#L1970) | \* |
| [1971](#L1971) | \* @param array $args |
| [1972](#L1972) | \* @param array $instance |
| [1973](#L1973) | \*/ |
| [1974](#L1974) | public function widget($\_args = array(), $\_instance = array()) |
| [1975](#L1975) | { |
| [1976](#L1976) | extract(shortcode\_atts(array( |
| [1977](#L1977) | 'slimstat\_widget\_id'      => '', |
| [1978](#L1978) | 'slimstat\_widget\_title'   => '', |
| [1979](#L1979) | 'slimstat\_widget\_filters' => '' |
| [1980](#L1980) | ), $\_instance)); |
| [1981](#L1981) |  |
| [1982](#L1982) | if (!empty($slimstat\_widget\_title)) { |
| [1983](#L1983) | echo (!empty($\_args['before\_title']) ? $\_args['before\_title'] : '<h2 class="widget-title">') . $slimstat\_widget\_title . (!empty($\_args['after\_title']) ? $\_args['after\_title'] : '</h2>'); |
| [1984](#L1984) | } |
| [1985](#L1985) | if (!empty($slimstat\_widget\_id)) { |
| [1986](#L1986) | echo do\_shortcode("[slimstat f='widget' w='{$slimstat\_widget\_id}']{$slimstat\_widget\_filters}[/slimstat]"); |
| [1987](#L1987) | } else { |
| [1988](#L1988) | echo ''; |
| [1989](#L1989) | } |
| [1990](#L1990) | } |
| [1991](#L1991) |  |
| [1992](#L1992) | /\*\* |
| [1993](#L1993) | \* Outputs the options form on admin |
| [1994](#L1994) | \* |
| [1995](#L1995) | \* @param array $instance The widget options |
| [1996](#L1996) | \*/ |
| [1997](#L1997) | public function form($\_instance) |
| [1998](#L1998) | { |
| [1999](#L1999) | extract(shortcode\_atts(array( |
| [2000](#L2000) | 'slimstat\_widget\_id'      => '', |
| [2001](#L2001) | 'slimstat\_widget\_title'   => '', |
| [2002](#L2002) | 'slimstat\_widget\_filters' => '' |
| [2003](#L2003) | ), $\_instance)); |
| [2004](#L2004) |  |
| [2005](#L2005) | // Let's build the dropdown |
| [2006](#L2006) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/view/wp-slimstat-reports.php'); |
| [2007](#L2007) | wp\_slimstat\_reports::init(); |
| [2008](#L2008) | $select\_options = ''; |
| [2009](#L2009) |  |
| [2010](#L2010) | foreach (wp\_slimstat\_reports::$reports as $a\_report\_id => $a\_report\_info) { |
| [2011](#L2011) | $select\_options .= "<option value='$a\_report\_id' " . (($slimstat\_widget\_id == $a\_report\_id) ? 'selected="selected"' : '') . ">{$a\_report\_info[ 'title' ]}</option>"; |
| [2012](#L2012) | } |
| [2013](#L2013) | ?> |
| [2014](#L2014) |  |
| [2015](#L2015) | <p> |
| [2016](#L2016) | <label for="<?php echo esc\_attr($this->get\_field\_id('slimstat\_widget\_id')); ?>"><?php \_e('Report', 'wp-slimstat') ?></label> |
| [2017](#L2017) | <select class="widefat" id="<?php echo esc\_attr($this->get\_field\_id('slimstat\_widget\_id')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('slimstat\_widget\_id')); ?>"> |
| [2018](#L2018) | <option value="">Select a widget</option> |
| [2019](#L2019) | <?php echo $select\_options ?> |
| [2020](#L2020) | </select> |
| [2021](#L2021) | </p> |
| [2022](#L2022) |  |
| [2023](#L2023) | <p> |
| [2024](#L2024) | <label for="<?php echo esc\_attr($this->get\_field\_id('slimstat\_widget\_title')); ?>"><?php \_e('Title', 'wp-slimstat') ?></label> |
| [2025](#L2025) | <input type="text" class="widefat" id="<?php echo esc\_attr($this->get\_field\_id('slimstat\_widget\_title')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('slimstat\_widget\_title')); ?>" value="<?php echo trim(strip\_tags($slimstat\_widget\_title)) ?>"> |
| [2026](#L2026) | </p> |
| [2027](#L2027) |  |
| [2028](#L2028) | <p> |
| [2029](#L2029) | <label for="<?php echo esc\_attr($this->get\_field\_id('slimstat\_widget\_filters')); ?>"><?php \_e('Optional filters', 'wp-slimstat'); ?></label> |
| [2030](#L2030) | <a href="https://slimstat.freshdesk.com/solution/articles/5000631833-what-is-the-syntax-of-a-slimstat-shortcode-#slimstat-operators" target="\_blank">[?]</a> |
| [2031](#L2031) | <textarea class="widefat" id="<?php echo esc\_attr($this->get\_field\_id('slimstat\_widget\_filters')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('slimstat\_widget\_filters')); ?>"><?php echo trim(strip\_tags($slimstat\_widget\_filters)) ?></textarea> |
| [2032](#L2032) | </p> |
| [2033](#L2033) | <?php |
| [2034](#L2034) | } |
| [2035](#L2035) |  |
| [2036](#L2036) | /\*\* |
| [2037](#L2037) | \* Processing widget options on save |
| [2038](#L2038) | \* |
| [2039](#L2039) | \* @param array $new\_instance The new options |
| [2040](#L2040) | \* @param array $old\_instance The previous options |
| [2041](#L2041) | \*/ |
| [2042](#L2042) | public function update($\_new\_instance, $\_old\_instance) |
| [2043](#L2043) | { |
| [2044](#L2044) | $instance = $\_old\_instance; |
| [2045](#L2045) |  |
| [2046](#L2046) | $instance['slimstat\_widget\_id']      = $\_new\_instance['slimstat\_widget\_id']; |
| [2047](#L2047) | $instance['slimstat\_widget\_title']   = $\_new\_instance['slimstat\_widget\_title']; |
| [2048](#L2048) | $instance['slimstat\_widget\_filters'] = $\_new\_instance['slimstat\_widget\_filters']; |
| [2049](#L2049) | return $instance; |
| [2050](#L2050) | } |
| [2051](#L2051) | } |
| [2052](#L2052) |  |
| [2053](#L2053) | // Ok, let's go, Sparky! |
| [2054](#L2054) | if (function\_exists('add\_action')) { |
| [2055](#L2055) | // Since we use sendBeacon, this function sends raw POST data, which does not populate the $\_POST variable automatically |
| [2056](#L2056) | if ((!empty($\_SERVER['HTTP\_CONTENT\_TYPE']) || !empty($\_SERVER['CONTENT\_TYPE'])) && empty($\_POST)) { |
| [2057](#L2057) | $raw\_post\_string = file\_get\_contents('php://input'); |
| [2058](#L2058) | parse\_str($raw\_post\_string, wp\_slimstat::$raw\_post\_array); |
| [2059](#L2059) | } else if (!empty($\_POST)) { |
| [2060](#L2060) | wp\_slimstat::$raw\_post\_array = $\_POST; |
| [2061](#L2061) | } |
| [2062](#L2062) |  |
| [2063](#L2063) | // Init the Ajax listener |
| [2064](#L2064) | if (!empty(wp\_slimstat::$raw\_post\_array['action']) && wp\_slimstat::$raw\_post\_array['action'] == 'slimtrack') { |
| [2065](#L2065) |  |
| [2066](#L2066) | // This is needed because admin-ajax.php is reading $\_REQUEST to fire the corresponding action |
| [2067](#L2067) | if (empty($\_POST['action'])) { |
| [2068](#L2068) | $\_POST['action'] = wp\_slimstat::$raw\_post\_array['action']; |
| [2069](#L2069) | } |
| [2070](#L2070) |  |
| [2071](#L2071) | add\_action('wp\_ajax\_nopriv\_slimtrack', array('wp\_slimstat', 'slimtrack\_ajax')); |
| [2072](#L2072) | add\_action('wp\_ajax\_slimtrack', array('wp\_slimstat', 'slimtrack\_ajax')); |
| [2073](#L2073) | } |
| [2074](#L2074) |  |
| [2075](#L2075) | // From the codex: You can't call register\_activation\_hook() inside a function hooked to the 'plugins\_loaded' or 'init' hooks (or any other hook). These hooks are called before the plugin is loaded or activated. |
| [2076](#L2076) | if (is\_admin()) { |
| [2077](#L2077) | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/index.php'); |
| [2078](#L2078) | register\_activation\_hook(\_\_FILE\_\_, array('wp\_slimstat\_admin', 'init\_environment')); |
| [2079](#L2079) | register\_deactivation\_hook(\_\_FILE\_\_, array('wp\_slimstat\_admin', 'deactivate')); |
| [2080](#L2080) | } |
| [2081](#L2081) |  |
| [2082](#L2082) | add\_action('widgets\_init', array('wp\_slimstat', 'register\_widget')); |
| [2083](#L2083) |  |
| [2084](#L2084) | // Add the appropriate actions |
| [2085](#L2085) | add\_action('plugins\_loaded', array('wp\_slimstat', 'init'), 20); |
| [2086](#L2086) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-slimstat/tags/5.0.9/wp-slimstat.php?format=txt)
* [Original Format](/export/3222508/wp-slimstat/tags/5.0.9/wp-slimstat.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from packetstormsecurity.com_eac5f58b_20250114_230921.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



=== Content from plugins.trac.wordpress.org_d34f5c11_20250114_230938.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2959452%2540wp-slimstat%26old%3D2959452%2540wp-slimstat)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2958208/wp-slimstat "Changeset 2958208 for wp-slimstat")
* [Next Change](/changeset/2959722/wp-slimstat "Changeset 2959722 for wp-slimstat") →

---

# Changeset [2959452](/changeset/2959452 "Show full changeset") for [wp-slimstat](/browser/wp-slimstat?rev=2959452 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/28/2023 03:11:31 PM
([17 months](/timeline?from=2023-08-28T15%3A11%3A31Z&precision=second "See timeline at 08/28/2023 03:11:31 PM") ago)

Author:
mostafa.s1990
Message:

Update to version 5.0.10 from GitHub

Location:
[wp-slimstat](/browser/wp-slimstat?rev=2959452)
Files:

8 edited
1 copied

* [tags/5.0.10](/browser/wp-slimstat/tags/5.0.10?rev=2959452 "Show entry in browser")
  (copied)
  *(copied from [wp-slimstat/trunk](/browser/wp-slimstat/trunk?rev=2958208 "Show original file (revision 2959451)"))*
* [tags/5.0.10/admin/view/right-now.php](/browser/wp-slimstat/tags/5.0.10/admin/view/right-now.php?rev=2959452 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [tags/5.0.10/admin/view/wp-slimstat-db.php](/browser/wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php?rev=2959452 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [tags/5.0.10/readme.txt](/browser/wp-slimstat/tags/5.0.10/readme.txt?rev=2959452 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [tags/5.0.10/wp-slimstat.php](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452 "Show entry in browser")
  (modified)
  ([5 diffs](#file4 "Show differences"))
* [trunk/admin/view/right-now.php](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2959452 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [trunk/admin/view/wp-slimstat-db.php](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2959452 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [trunk/readme.txt](/browser/wp-slimstat/trunk/readme.txt?rev=2959452 "Show entry in browser")
  (modified)
  ([2 diffs](#file7 "Show differences"))
* [trunk/wp-slimstat.php](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452 "Show entry in browser")
  (modified)
  ([5 diffs](#file8 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-slimstat/tags/5.0.10/admin/view/right-now.php](/changeset/2959452/wp-slimstat/tags/5.0.10/admin/view/right-now.php "Show the changeset 2959452 restricted to wp-slimstat/tags/5.0.10/admin/view/right-now.php")

  | [r2939166](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2939166#L34 "Show revision 2939166 of this file in browser") | [r2959452](/browser/wp-slimstat/tags/5.0.10/admin/view/right-now.php?rev=2959452#L34 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 | } |
  | 35 | 35 |  |
  | 36 |  | $results = array\_slice( |
  |  | 36 | $results = array\_slice( |
  | 37 | 37 | $all\_results, |
  | 38 | 38 | wp\_slimstat\_db::$filters\_normalized['misc']['start\_from'], |
  | […](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2939166#L82) | […](/browser/wp-slimstat/tags/5.0.10/admin/view/right-now.php?rev=2959452#L82) |  |
  | 82 | 82 | // Print visit header? |
  | 83 | 83 | if ($i == 0 || $results[$i - 1]['visit\_id'] != $results[$i]['visit\_id'] || $results[$i - 1]['ip'] != $results[$i]['ip'] || $results[$i - 1]['browser'] != $results[$i]['browser'] || $results[$i - 1]['platform'] != $results[$i]['platform'] || $results[$i - 1]['username'] != $results[$i]['username']) { |
  |  | 84 |  |
  |  | 85 | // Skip error responses |
  |  | 86 | if (empty($results[$i]['referer'])) { |
  |  | 87 | continue; |
  |  | 88 | } |
  | 84 | 89 |  |
  | 85 | 90 | // Color-coded headers |
* ## [wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php](/changeset/2959452/wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php "Show the changeset 2959452 restricted to wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php")

  | [r2945907](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2945907#L820 "Show revision 2945907 of this file in browser") | [r2959452](/browser/wp-slimstat/tags/5.0.10/admin/view/wp-slimstat-db.php?rev=2959452#L820 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 820 | 820 | ORDER BY counthits DESC |
  | 821 | 821 | LIMIT 0, %d", self::$filters\_normalized['misc']['limit\_results']); |
  | 822 |  | return self::get\_results($sql, $\_args['group\_by'],$\_args['group\_by'] . ' ASC'); |
  |  | 822 | return self::get\_results($sql, $\_args['group\_by'], $\_args['group\_by'] . ' ASC'); |
  | 823 | 823 | } |
  | 824 | 824 |  |
* ## [wp-slimstat/tags/5.0.10/readme.txt](/changeset/2959452/wp-slimstat/tags/5.0.10/readme.txt "Show the changeset 2959452 restricted to wp-slimstat/tags/5.0.10/readme.txt")

  | [r2958208](/browser/wp-slimstat/trunk/readme.txt?rev=2958208#L6 "Show revision 2958208 of this file in browser") | [r2959452](/browser/wp-slimstat/tags/5.0.10/readme.txt?rev=2959452#L6 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Requires PHP: 7.4+ |
  | 7 | 7 | Tested up to: 6.3 |
  | 8 |  | Stable tag: 5.0.~~9~~ |
  |  | 8 | Stable tag: 5.0.10 |
  | 9 | 9 |  |
  | 10 | 10 | == Description == |
  | […](/browser/wp-slimstat/trunk/readme.txt?rev=2958208#L49) | […](/browser/wp-slimstat/tags/5.0.10/readme.txt?rev=2959452#L49) |  |
  | 49 | 49 |  |
  | 50 | 50 | == Changelog == |
  |  | 51 | = 5.0.10 = |
  |  | 52 | \* [Fix] Skip Error Responses: Handling Empty Referer in Results Array |
  |  | 53 | \* [Fix] Escape shortcode attributes |
  |  | 54 | \* [Fix] Skip to accept the invalid argus in shortcode |
  |  | 55 | \* [Fix] Minor improvements & Hardened plugin security |
  |  | 56 |  |
  | 51 | 57 | = 5.0.9 = |
  | 52 | 58 | \* [Fix] Hardened plugin security and sanitization of GeoIP argument |
* ## [wp-slimstat/tags/5.0.10/wp-slimstat.php](/changeset/2959452/wp-slimstat/tags/5.0.10/wp-slimstat.php "Show the changeset 2959452 restricted to wp-slimstat/tags/5.0.10/wp-slimstat.php")

  | [r2958208](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L4 "Show revision 2958208 of this file in browser") | [r2959452](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L4 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://wp-slimstat.com/ |
  | 5 | 5 | Description: The leading web analytics plugin for WordPress |
  | 6 |  | Version: 5.0.~~9~~ |
  |  | 6 | Version: 5.0.10 |
  | 7 | 7 | Author: Jason Crouse, VeronaLabs |
  | 8 | 8 | Text Domain: wp-slimstat |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L18) | […](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L18) |  |
  | 18 | 18 | class wp\_slimstat |
  | 19 | 19 | { |
  | 20 |  | public static $version = '5.0.~~9~~'; |
  |  | 20 | public static $version = '5.0.10'; |
  | 21 | 21 | public static $settings = array(); |
  | 22 | 22 |  |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L747) | […](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L747) |  |
  | 747 | 747 | } |
  | 748 | 748 |  |
  |  | 749 | // Validation the parameter w |
  |  | 750 | if (in\_array($w, array('count', 'display\_name', 'hostname', 'post\_link', 'post\_link\_no\_qs', 'dt', 'username', 'post\_link')) == false) { |
  |  | 751 | return '<!-- Slimstat Shortcode Error: invalid parameter for w -->'; |
  |  | 752 | } |
  |  | 753 |  |
  | 749 | 754 | // Include the Reports Library, but don't initialize the database, since we will do that separately later |
  | 750 | 755 | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/view/wp-slimstat-reports.php'); |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L797) | […](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L802) |  |
  | 797 | 802 | } |
  | 798 | 803 |  |
  |  | 804 | $w = esc\_html($w); |
  | 799 | 805 | $w = self::string\_to\_array($w); |
  | 800 | 806 |  |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L882) | […](/browser/wp-slimstat/tags/5.0.10/wp-slimstat.php?rev=2959452#L888) |  |
  | 882 | 888 |  |
  | 883 | 889 | default: |
  | 884 |  | $output[$result\_idx][$a\_column] .= ~~$a\_result[$a\_column]~~; |
  |  | 890 | $output[$result\_idx][$a\_column] .= isset($a\_result[$a\_column]) ? $a\_result[$a\_column] : ''; |
  | 885 | 891 | break; |
  | 886 | 892 | } |
* ## [wp-slimstat/trunk/admin/view/right-now.php](/changeset/2959452/wp-slimstat/trunk/admin/view/right-now.php "Show the changeset 2959452 restricted to wp-slimstat/trunk/admin/view/right-now.php")

  | [r2939166](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2939166#L34 "Show revision 2939166 of this file in browser") | [r2959452](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2959452#L34 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 | } |
  | 35 | 35 |  |
  | 36 |  | $results = array\_slice( |
  |  | 36 | $results = array\_slice( |
  | 37 | 37 | $all\_results, |
  | 38 | 38 | wp\_slimstat\_db::$filters\_normalized['misc']['start\_from'], |
  | […](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2939166#L82) | […](/browser/wp-slimstat/trunk/admin/view/right-now.php?rev=2959452#L82) |  |
  | 82 | 82 | // Print visit header? |
  | 83 | 83 | if ($i == 0 || $results[$i - 1]['visit\_id'] != $results[$i]['visit\_id'] || $results[$i - 1]['ip'] != $results[$i]['ip'] || $results[$i - 1]['browser'] != $results[$i]['browser'] || $results[$i - 1]['platform'] != $results[$i]['platform'] || $results[$i - 1]['username'] != $results[$i]['username']) { |
  |  | 84 |  |
  |  | 85 | // Skip error responses |
  |  | 86 | if (empty($results[$i]['referer'])) { |
  |  | 87 | continue; |
  |  | 88 | } |
  | 84 | 89 |  |
  | 85 | 90 | // Color-coded headers |
* ## [wp-slimstat/trunk/admin/view/wp-slimstat-db.php](/changeset/2959452/wp-slimstat/trunk/admin/view/wp-slimstat-db.php "Show the changeset 2959452 restricted to wp-slimstat/trunk/admin/view/wp-slimstat-db.php")

  | [r2945907](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2945907#L820 "Show revision 2945907 of this file in browser") | [r2959452](/browser/wp-slimstat/trunk/admin/view/wp-slimstat-db.php?rev=2959452#L820 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 820 | 820 | ORDER BY counthits DESC |
  | 821 | 821 | LIMIT 0, %d", self::$filters\_normalized['misc']['limit\_results']); |
  | 822 |  | return self::get\_results($sql, $\_args['group\_by'],$\_args['group\_by'] . ' ASC'); |
  |  | 822 | return self::get\_results($sql, $\_args['group\_by'], $\_args['group\_by'] . ' ASC'); |
  | 823 | 823 | } |
  | 824 | 824 |  |
* ## [wp-slimstat/trunk/readme.txt](/changeset/2959452/wp-slimstat/trunk/readme.txt "Show the changeset 2959452 restricted to wp-slimstat/trunk/readme.txt")

  | [r2958208](/browser/wp-slimstat/trunk/readme.txt?rev=2958208#L6 "Show revision 2958208 of this file in browser") | [r2959452](/browser/wp-slimstat/trunk/readme.txt?rev=2959452#L6 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Requires PHP: 7.4+ |
  | 7 | 7 | Tested up to: 6.3 |
  | 8 |  | Stable tag: 5.0.~~9~~ |
  |  | 8 | Stable tag: 5.0.10 |
  | 9 | 9 |  |
  | 10 | 10 | == Description == |
  | […](/browser/wp-slimstat/trunk/readme.txt?rev=2958208#L49) | […](/browser/wp-slimstat/trunk/readme.txt?rev=2959452#L49) |  |
  | 49 | 49 |  |
  | 50 | 50 | == Changelog == |
  |  | 51 | = 5.0.10 = |
  |  | 52 | \* [Fix] Skip Error Responses: Handling Empty Referer in Results Array |
  |  | 53 | \* [Fix] Escape shortcode attributes |
  |  | 54 | \* [Fix] Skip to accept the invalid argus in shortcode |
  |  | 55 | \* [Fix] Minor improvements & Hardened plugin security |
  |  | 56 |  |
  | 51 | 57 | = 5.0.9 = |
  | 52 | 58 | \* [Fix] Hardened plugin security and sanitization of GeoIP argument |
* ## [wp-slimstat/trunk/wp-slimstat.php](/changeset/2959452/wp-slimstat/trunk/wp-slimstat.php "Show the changeset 2959452 restricted to wp-slimstat/trunk/wp-slimstat.php")

  | [r2958208](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L4 "Show revision 2958208 of this file in browser") | [r2959452](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L4 "Show revision 2959452 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://wp-slimstat.com/ |
  | 5 | 5 | Description: The leading web analytics plugin for WordPress |
  | 6 |  | Version: 5.0.~~9~~ |
  |  | 6 | Version: 5.0.10 |
  | 7 | 7 | Author: Jason Crouse, VeronaLabs |
  | 8 | 8 | Text Domain: wp-slimstat |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L18) | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L18) |  |
  | 18 | 18 | class wp\_slimstat |
  | 19 | 19 | { |
  | 20 |  | public static $version = '5.0.~~9~~'; |
  |  | 20 | public static $version = '5.0.10'; |
  | 21 | 21 | public static $settings = array(); |
  | 22 | 22 |  |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L747) | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L747) |  |
  | 747 | 747 | } |
  | 748 | 748 |  |
  |  | 749 | // Validation the parameter w |
  |  | 750 | if (in\_array($w, array('count', 'display\_name', 'hostname', 'post\_link', 'post\_link\_no\_qs', 'dt', 'username', 'post\_link')) == false) { |
  |  | 751 | return '<!-- Slimstat Shortcode Error: invalid parameter for w -->'; |
  |  | 752 | } |
  |  | 753 |  |
  | 749 | 754 | // Include the Reports Library, but don't initialize the database, since we will do that separately later |
  | 750 | 755 | include\_once(plugin\_dir\_path(\_\_FILE\_\_) . 'admin/view/wp-slimstat-reports.php'); |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L797) | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L802) |  |
  | 797 | 802 | } |
  | 798 | 803 |  |
  |  | 804 | $w = esc\_html($w); |
  | 799 | 805 | $w = self::string\_to\_array($w); |
  | 800 | 806 |  |
  | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2958208#L882) | […](/browser/wp-slimstat/trunk/wp-slimstat.php?rev=2959452#L888) |  |
  | 882 | 888 |  |
  | 883 | 889 | default: |
  | 884 |  | $output[$result\_idx][$a\_column] .= ~~$a\_result[$a\_column]~~; |
  |  | 890 | $output[$result\_idx][$a\_column] .= isset($a\_result[$a\_column]) ? $a\_result[$a\_column] : ''; |
  | 885 | 891 | break; |
  | 886 | 892 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2959452)
* [Zip Archive](?format=zip&new=2959452)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_ab17348a_20250114_230940.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Slimstat Analytics <= 5.0.9 - Authenticated (Contributor+) Stored Cross-Site Scripting via Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Slimstat Analytics <= 5.0.9 - Authenticated (Contributor+) Stored Cross-Site Scripting via Shortcode

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2023-4597](https://www.cve.org/CVERecord?id=CVE-2023-4597) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | August 28, 2023 |
| Last Updated | August 30, 2023 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Slimstat Analytics plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the 'slimstat' shortcode in versions up to, and including, 5.0.9 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers with contributor-level and above permissions to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-slimstat/tags/5.0.9/wp-slimstat.php#L892)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=2959452%40wp-slimstat&new=2959452%40wp-slimstat&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-slimstat%2Fslimstat-analytics-509-authenticated-contributor-stored-cross-site-scripting-via-shortcode&t=Slimstat%20Analytics%20%3C%3D%205.0.9%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-slimstat%2Fslimstat-analytics-509-authenticated-contributor-stored-cross-site-scripting-via-shortcode&text=Slimstat%20Analytics%20%3C%3D%205.0.9%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-slimstat%2Fslimstat-analytics-509-authenticated-contributor-stored-cross-site-scripting-via-shortcode "LinkedIn")
Email

## Vulnerability Details for SlimStat Analytics

#### [SlimStat Analytics](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-slimstat)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-slimstat [(view on wordpress.org)](https://wordpress.org/plugins/wp-slimstat) |
| Patched? | Yes |
| Remediation | Update to version 5.0.10, or a newer patched version |
| Affected Version | * <= 5.0.9 |
| Patched Version | * 5.0.10 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


