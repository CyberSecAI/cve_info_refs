=== Content from gist.github.com_565a95fd_20250114_200345.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2F8f3b6aa65e9d08f45b5236c6e9ab8d80)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2F8f3b6aa65e9d08f45b5236c6e9ab8d80&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2F8f3b6aa65e9d08f45b5236c6e9ab8d80) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2F8f3b6aa65e9d08f45b5236c6e9ab8d80&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@dmknght](https://avatars.githubusercontent.com/u/29118926?s=64&v=4)](/dmknght)

# [dmknght](/dmknght)/**[totolink\_bypass\_to\_rce.md](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80)**

Last active
October 26, 2023 00:05

Show Gist options

* [Download ZIP](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80/archive/2e8640d73bb555691f9024300d81eb391f54a55d.zip)

* [Star
  (1)
  1](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2F8f3b6aa65e9d08f45b5236c6e9ab8d80)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2F8f3b6aa65e9d08f45b5236c6e9ab8d80)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80.js&quot;&gt;&lt;/script&gt;
* Save dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80 to your computer and use it in GitHub Desktop.

[Code](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80)
[Revisions
40](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80/revisions)
[Stars
1](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80/stargazers)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80.js&quot;&gt;&lt;/script&gt;

Save dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80 to your computer and use it in GitHub Desktop.

[Download ZIP](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80/archive/2e8640d73bb555691f9024300d81eb391f54a55d.zip)

Use format string bypass Totolink's Validity\_check function, lead to remote OS command injection (CVE-2023-4746)

 [Raw](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80/raw/2e8640d73bb555691f9024300d81eb391f54a55d/totolink_bypass_to_rce.md)

[**totolink\_bypass\_to\_rce.md**](#file-totolink_bypass_to_rce-md)

# Firmware info

* Device name: **N200RE V5**
* Build version: **V9.3.5u.6437\_B20230519** (Update **2023-05-26**
* Download link: <https://www.totolink.net/home/menu/detail/menu_listtpl/download/id/204/ids/36.html>
* Authentication: Yes (Login as account on firmware's web interface)
* Affect: Unknown number of ToTotlink firmware that uses function `Validity_check`.

# Description and Impact

Totolink is using function `Validity_check` to fix OS command injection vulnerability. An attacker can bypass this filter using character `%`, exploit the format string at `snprintf` function to execute OS system commands.

# Root-casue

Function `Validity_check` finds blacklisted strings / characters such as `$ ` | ; &`
[![image](https://user-images.githubusercontent.com/29118926/263514301-c51e8208-7274-4d6b-9354-2584ff003751.png)](https://user-images.githubusercontent.com/29118926/263514301-c51e8208-7274-4d6b-9354-2584ff003751.png)

After the validation, the server executes system command when it can't find any blacklisted characters
[![image](https://user-images.githubusercontent.com/29118926/263514374-349ddd7e-cc47-4b13-b20a-3464827ce96f.png)](https://user-images.githubusercontent.com/29118926/263514374-349ddd7e-cc47-4b13-b20a-3464827ce96f.png)

The program is calling some external libraries

[![image](https://user-images.githubusercontent.com/29118926/264236665-ab80b75f-acc5-4a61-abdc-1d1f26d4f491.png)](https://user-images.githubusercontent.com/29118926/264236665-ab80b75f-acc5-4a61-abdc-1d1f26d4f491.png)

Function `doSystem` is using function `vsnprintf` to craft system command and then execute using `system`.

[![image](https://user-images.githubusercontent.com/29118926/264255635-77c10bd5-84c1-4263-a315-4f5bc5b68b58.png)](https://user-images.githubusercontent.com/29118926/264255635-77c10bd5-84c1-4263-a315-4f5bc5b68b58.png)

Functions`snprintf` and `vsnprintf` are vulnerable against format string attack (source: Format string attack | OWASP)
[![image](https://user-images.githubusercontent.com/29118926/264198279-fde14e10-cbe5-44bd-be35-03d84b88d3ab.png)](https://user-images.githubusercontent.com/29118926/264198279-fde14e10-cbe5-44bd-be35-03d84b88d3ab.png)

# Steps to reprocedure

when use the `ping` or `traceroute` feature, attacker can inject character `%x` in the IP address
[![image](https://user-images.githubusercontent.com/29118926/263514785-f372292d-8ef1-4f18-a1f4-cfe83a4100d3.png)](https://user-images.githubusercontent.com/29118926/263514785-f372292d-8ef1-4f18-a1f4-cfe83a4100d3.png)

The server responses with a hex value, suggesting it could be a format string vulnerability
[![image](https://user-images.githubusercontent.com/29118926/263514860-84bdcb59-ecd8-4762-8702-10030daca3a3.png)](https://user-images.githubusercontent.com/29118926/263514860-84bdcb59-ecd8-4762-8702-10030daca3a3.png)

When attacker uses payload `%whoami`, the server response busybox's output. It suggests that the string `whoami` was delivered to the `busybox` interpreter
[![image](https://user-images.githubusercontent.com/29118926/263514961-c69ae28f-cea0-4fed-acc9-3a446f45c5a4.png)](https://user-images.githubusercontent.com/29118926/263514961-c69ae28f-cea0-4fed-acc9-3a446f45c5a4.png)
[![image](https://user-images.githubusercontent.com/29118926/263515092-257a9885-65df-4a6b-aa40-d2cd82e72ba0.png)](https://user-images.githubusercontent.com/29118926/263515092-257a9885-65df-4a6b-aa40-d2cd82e72ba0.png)

When attacker sent the same payload to `traceroute`, the command was executed sucessfully
[![image](https://user-images.githubusercontent.com/29118926/263515163-250ff32e-cd39-4b5c-b7c3-eb74cf6a848a.png)](https://user-images.githubusercontent.com/29118926/263515163-250ff32e-cd39-4b5c-b7c3-eb74cf6a848a.png)
[![image](https://user-images.githubusercontent.com/29118926/263515169-fb86a243-86ed-4af1-a2e0-04adee7a4b13.png)](https://user-images.githubusercontent.com/29118926/263515169-fb86a243-86ed-4af1-a2e0-04adee7a4b13.png)

Due to limitation of the `%` as the string format, some command can't be executed. The reason is the first character
[![image](https://user-images.githubusercontent.com/29118926/263515325-09cfaf65-7ac8-49d1-b66e-f9d2090c714e.png)](https://user-images.githubusercontent.com/29118926/263515325-09cfaf65-7ac8-49d1-b66e-f9d2090c714e.png)
[![image](https://user-images.githubusercontent.com/29118926/263515328-0b0095e6-ecf9-490e-8c39-6a1226e654aa.png)](https://user-images.githubusercontent.com/29118926/263515328-0b0095e6-ecf9-490e-8c39-6a1226e654aa.png)

Attacker can use absolute path to bypass this issue, executing system command
[![image](https://user-images.githubusercontent.com/29118926/263515440-d15dc3ca-822b-490c-88fd-5190287aaea1.png)](https://user-images.githubusercontent.com/29118926/263515440-d15dc3ca-822b-490c-88fd-5190287aaea1.png)
[![image](https://user-images.githubusercontent.com/29118926/263515451-c7ccf54a-05a8-4313-b027-58bf484b00ff.png)](https://user-images.githubusercontent.com/29118926/263515451-c7ccf54a-05a8-4313-b027-58bf484b00ff.png)

When attacker uses ping feature to exploit, it might be command failed to run because the flag `-w` for command `ping` is hard-coded.
[![image](https://user-images.githubusercontent.com/29118926/263515550-df394454-9054-44d5-b780-ebe9b0f6da16.png)](https://user-images.githubusercontent.com/29118926/263515550-df394454-9054-44d5-b780-ebe9b0f6da16.png)
[![image](https://user-images.githubusercontent.com/29118926/263515561-7dfba0cb-b002-4ba8-9c04-b319eee2c3d2.png)](https://user-images.githubusercontent.com/29118926/263515561-7dfba0cb-b002-4ba8-9c04-b319eee2c3d2.png)

Attacker can use the syntax that calls `/bin/bash` or `/bin/sh` to execute the command that does not contain `-w`, therefore avoid the command execution error
[![image](https://user-images.githubusercontent.com/29118926/263515694-a073c6ed-8509-447b-9856-24bf6834642e.png)](https://user-images.githubusercontent.com/29118926/263515694-a073c6ed-8509-447b-9856-24bf6834642e.png)
[![image](https://user-images.githubusercontent.com/29118926/263515698-55127f26-5fc0-4c2a-849b-a7481befcdda.png)](https://user-images.githubusercontent.com/29118926/263515698-55127f26-5fc0-4c2a-849b-a7481befcdda.png)

# Recommends

* Add `%` to blacklist
* Check the logic of `doSystem` to avoid format string error.

# Reference

* <https://owasp.org/www-community/attacks/Format_string_attack>
* <https://www.cs.cornell.edu/courses/cs3410/2008fa/MIPS_Vol2.pdf>
* <https://en.wikibooks.org/wiki/MIPS_Assembly/Register_File>

[![@0xmanhnv](https://avatars.githubusercontent.com/u/18032641?s=80&v=4)](/0xmanhnv)

Copy link

### **[0xmanhnv](/0xmanhnv)** commented [Aug 27, 2023](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80?permalink_comment_id=4672982#gistcomment-4672982)

Này mà unauth nữa thì ngon =))))))))))))))))))))

Sorry, something went wrong.

[![@dmknght](https://avatars.githubusercontent.com/u/29118926?s=80&v=4)](/dmknght)

Copy link

Author

### **[dmknght](/dmknght)** commented [Aug 27, 2023](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80?permalink_comment_id=4673001#gistcomment-4673001)

> Này mà unauth nữa thì ngon =))))))))))))))))))))

Mấy bản nó vá đã có check authen rồi. Nhưng cái này affect cả những cái chưa vá -> sẽ có unauthen tùy version

Sorry, something went wrong.

[![@TH213](https://avatars.githubusercontent.com/u/30589196?s=80&v=4)](/TH213)

Copy link

### **[TH213](/TH213)** commented [Aug 27, 2023](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80?permalink_comment_id=4673005#gistcomment-4673005)

Má nó ngon :))

Sorry, something went wrong.

[![@dmknght](https://avatars.githubusercontent.com/u/29118926?s=80&v=4)](/dmknght)

Copy link

Author

### **[dmknght](/dmknght)** commented [Aug 30, 2023](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80?permalink_comment_id=4675757#gistcomment-4675757) • edited Loading

Update: the reason that the bug happened was the `snprintf` and C format string. Updating the `Root cause`

[![image](https://user-images.githubusercontent.com/29118926/264199849-3d16db08-149c-4691-b41a-d0754bd9064f.png)](https://user-images.githubusercontent.com/29118926/264199849-3d16db08-149c-4691-b41a-d0754bd9064f.png)

Sorry, something went wrong.

[![@dmknght](https://avatars.githubusercontent.com/u/29118926?s=80&v=4)](/dmknght)

Copy link

Author

### **[dmknght](/dmknght)** commented [Aug 30, 2023](/dmknght/8f3b6aa65e9d08f45b5236c6e9ab8d80?permalink_comment_id=4676007#gistcomment-4676007) • edited Loading

It appeared that when attacker used the payload `1.1.1.1%/bin/ps wlT`, the result showed `S 0 6002 6001 1512 372 0:0 14:21 00:00:00 /bin/sh -c /bin/ps wlT&>/var/log/traceRouteLog`. The payload after `%` was pushed to a new command. However, it's still unknown how it's possible in `doSystem`'s logic

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fdmknght%2F8f3b6aa65e9d08f45b5236c6e9ab8d80)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


