=== Content from github.com_60ff1bee_20250115_094533.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fflarum%2Fframework%2Fsecurity%2Fadvisories%2FGHSA-hph3-hv3c-7725)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fflarum%2Fframework%2Fsecurity%2Fadvisories%2FGHSA-hph3-hv3c-7725)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=flarum%2Fframework)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[flarum](/flarum)
/
**[framework](/flarum/framework)**
Public

* [Notifications](/login?return_to=%2Fflarum%2Fframework) You must be signed in to change notification settings
* [Fork
  838](/login?return_to=%2Fflarum%2Fframework)
* [Star
   6.4k](/login?return_to=%2Fflarum%2Fframework)

* [Code](/flarum/framework)
* [Issues
  43](/flarum/framework/issues)
* [Pull requests
  9](/flarum/framework/pulls)
* [Actions](/flarum/framework/actions)
* [Security](/flarum/framework/security)
* [Insights](/flarum/framework/pulse)

Additional navigation options

* [Code](/flarum/framework)
* [Issues](/flarum/framework/issues)
* [Pull requests](/flarum/framework/pulls)
* [Actions](/flarum/framework/actions)
* [Security](/flarum/framework/security)
* [Insights](/flarum/framework/pulse)

# Any user including unactivated can reply in public discussions whose first post was permanently deleted

Low

[SychO9](/SychO9)
published
GHSA-hph3-hv3c-7725
Jan 10, 2023

## Package

composer

flarum/core
([Composer](/advisories?query=ecosystem%3Acomposer))

## Affected versions

< 1.3.0

## Patched versions

1.6.3

## Description

If the first post of a discussion is permanently deleted but the discussion stays visible, any actor who can view the discussion is able to create a new reply via the REST API, no matter the reply permission or lock status.

This includes users that don't have a validated email.

Guests cannot successfully create a reply because the API will fail with a 500 error when the user ID 0 is inserted into the database. This should also be fixed to return the expected 401/403 status.

This happens because when the first post of a discussion is permanently deleted, the `first_post_id` attribute of the discussion becomes `null` which causes access control to be skipped for all new replies.

Flarum automatically makes discussions with zero comments invisible so an additional condition for this vulnerability is that the discussion must have at least one approved reply so that `discussions.comment_count` is still above zero after the post deletion.

### Impact

This can open the discussion to uncontrolled spam or just unintentional replies if users still had their tab open before the vulnerable discussion was locked and then post a reply when they shouldn't be able to.

In combination with the email notification settings, this could also be used as a way to send unsolicited emails.

Versions between `v1.3.0` and `v1.6.3` are impacted.

### Patches

The vulnerability has been fixed and published as flarum/core v1.6.3. All communities running Flarum should upgrade as soon as possible to v1.6.3 using:

```
composer update --prefer-dist --no-dev -a -W

```

You can then confirm you run the latest version using:

```
composer show flarum/core

```
### Workarounds

If you don't delete the first posts you are not affected. A workaround can be to delete the discussion itself, or amend the database to manually set a `first_post_id`.

### For more information

For any questions or comments on this vulnerability please visit <https://discuss.flarum.org/>

For support questions create a discussion at <https://discuss.flarum.org/t/support>.

A reminder that if you ever become aware of a security issue in Flarum, please report it to us privately by emailing security@flarum.org, and we will address it promptly.

### Severity

Low

3.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
Low

User interaction
Required

Scope
Unchanged

Confidentiality
None

Integrity
Low

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:N

### CVE ID

CVE-2023-22489

### Weaknesses

[CWE-862](/advisories?query=cwe%3A862)

### Credits

* [![@clarkwinkelmann](https://avatars.githubusercontent.com/u/5264300?s=40&v=4)](/clarkwinkelmann)
  [clarkwinkelmann](/clarkwinkelmann)
  Analyst

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_99955fc1_20250115_094532.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fflarum%2Fframework%2Freleases%2Ftag%2Fv1.6.3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fflarum%2Fframework%2Freleases%2Ftag%2Fv1.6.3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=flarum%2Fframework)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[flarum](/flarum)
/
**[framework](/flarum/framework)**
Public

* [Notifications](/login?return_to=%2Fflarum%2Fframework) You must be signed in to change notification settings
* [Fork
  838](/login?return_to=%2Fflarum%2Fframework)
* [Star
   6.4k](/login?return_to=%2Fflarum%2Fframework)

* [Code](/flarum/framework/tree/v1.6.3)
* [Issues
  43](/flarum/framework/issues)
* [Pull requests
  9](/flarum/framework/pulls)
* [Actions](/flarum/framework/actions)
* [Security](/flarum/framework/security)
* [Insights](/flarum/framework/pulse)

Additional navigation options

* [Code](/flarum/framework/tree/v1.6.3)
* [Issues](/flarum/framework/issues)
* [Pull requests](/flarum/framework/pulls)
* [Actions](/flarum/framework/actions)
* [Security](/flarum/framework/security)
* [Insights](/flarum/framework/pulse)

1. [Releases](/flarum/framework/releases)
2. [v1.6.3](/flarum/framework/releases/tag/v1.6.3)

# v1.6.3

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/flarum/framework/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v1.6.3)

 Loading

[View all tags](/flarum/framework/tags)

![@SychO9](https://avatars.githubusercontent.com/u/20267363?s=40&v=4)
[SychO9](/SychO9)
released this
10 Jan 14:23

[v1.6.3](/flarum/framework/tree/v1.6.3)

[`243bc13`](/flarum/framework/commit/243bc139b0fc6aea7526bf8e58e9d618920bb80c)

This commit was signed with the committer‚Äôs **verified signature**.

[![](https://avatars.githubusercontent.com/u/20267363?s=64&v=4)](/SychO9)
[SychO9](/SychO9)
Sami Mazouz

SSH Key Fingerprint: lTRowRYmvC12isbBHGIgFkG4/x7TWYjl9Cye+jd3ZN0
[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

### Fixed

* Post mentions can be used to read any post on the forum without access control ([ab1c868](https://github.com/flarum/framework/commit/ab1c868b978e8b0d09a5d682c54665dae17d0985)).
* Notifications can leak restricted content ([d0a2b95](https://github.com/flarum/framework/commit/d0a2b95dca57d3dae9a0d77b610b1cb1d0b1766a)).
* Any user including unactivated can reply in public discussions whose first post was permanently deleted ([12f1411](https://github.com/flarum/framework/commit/12f14112a0ecd1484d97330b82beb2a145919015)).
* (subscriptions) Post notifications not getting access checked ([e5f0516](https://github.com/flarum/framework/commit/e5f05166a062a9a6eb7c12e28728bfd5db7270e3)).

 Assets
2

 Loading

 üëç
5
 iamdarkle, lzx2209, zgq354, roveabainza, and blackandred reacted with thumbs up emoji
 ‚ù§Ô∏è
1
 blackandred reacted with heart emoji

All reactions

* üëç
  5 reactions
* ‚ù§Ô∏è
  1 reaction

 5 people reacted

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_3d669cbf_20250115_094531.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fflarum%2Fframework%2Fcommit%2F12f14112a0ecd1484d97330b82beb2a145919015)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fflarum%2Fframework%2Fcommit%2F12f14112a0ecd1484d97330b82beb2a145919015)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=flarum%2Fframework)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[flarum](/flarum)
/
**[framework](/flarum/framework)**
Public

* [Notifications](/login?return_to=%2Fflarum%2Fframework) You must be signed in to change notification settings
* [Fork
  838](/login?return_to=%2Fflarum%2Fframework)
* [Star
   6.4k](/login?return_to=%2Fflarum%2Fframework)

* [Code](/flarum/framework)
* [Issues
  43](/flarum/framework/issues)
* [Pull requests
  9](/flarum/framework/pulls)
* [Actions](/flarum/framework/actions)
* [Security](/flarum/framework/security)
* [Insights](/flarum/framework/pulse)

Additional navigation options

* [Code](/flarum/framework)
* [Issues](/flarum/framework/issues)
* [Pull requests](/flarum/framework/pulls)
* [Actions](/flarum/framework/actions)
* [Security](/flarum/framework/security)
* [Insights](/flarum/framework/pulse)

## Commit

[Permalink](/flarum/framework/commit/12f14112a0ecd1484d97330b82beb2a145919015)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-hph3-hv3c-7725](https://github.com/advisories/GHSA-hph3-hv3c-7725 "GHSA-hph3-hv3c-7725")

[Browse files](/flarum/framework/tree/12f14112a0ecd1484d97330b82beb2a145919015)
Browse the repository at this point in the history

```
* test: add reply creation tests

Signed-off-by: Sami Mazouz <sychocouldy@gmail.com>

* fix: access checking being bypassed for post creation when first post is deleted

Signed-off-by: Sami Mazouz <sychocouldy@gmail.com>

* chore: recover tests

Signed-off-by: Sami Mazouz <sychocouldy@gmail.com>

* chore: make provider public

Signed-off-by: Sami Mazouz <sychocouldy@gmail.com>

Signed-off-by: Sami Mazouz <sychocouldy@gmail.com>
```

* Loading branch information

[![@SychO9](https://avatars.githubusercontent.com/u/20267363?s=40&v=4)](/SychO9)

[SychO9](/flarum/framework/commits?author=SychO9 "View all commits by SychO9")
authored
Jan 10, 2023

1 parent
[e4a4ff5](/flarum/framework/commit/e4a4ff5d33e2fb6e58fa00ea9cb15a35238b0d87)

commit 12f1411

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**50 additions**
and
**9 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* framework/core

  + src

    - Discussion/Command

      * framework/core/src/Discussion/Command/StartDiscussionHandler.php
        [StartDiscussionHandler.php](#diff-490854d4816912184a292c7defc2a59c94dbe6288c5bb16264dd35b49d483166)
    - Post/Command

      * framework/core/src/Post/Command/PostReply.php
        [PostReply.php](#diff-922fdb086973233bd6a511589a57abd8a63cfd0dabbbd6d8ee2bc9c1646ee5a5)
      * framework/core/src/Post/Command/PostReplyHandler.php
        [PostReplyHandler.php](#diff-eeb7feacc10e4a62223b2b1e185f0d09b063ef2de2bfda059e71698d5525ede1)
  + tests/integration/api/posts

    - framework/core/tests/integration/api/posts/CreateTest.php
      [CreateTest.php](#diff-562cc9d52a09cb183499ac7a603b522411a7a69638d5522e5e716c686ecad13b)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[framework/core/src/Discussion/Command/StartDiscussionHandler.php](#diff-490854d4816912184a292c7defc2a59c94dbe6288c5bb16264dd35b49d483166 "framework/core/src/Discussion/Command/StartDiscussionHandler.php")

Show comments

[View file](/flarum/framework/blob/12f14112a0ecd1484d97330b82beb2a145919015/framework/core/src/Discussion/Command/StartDiscussionHandler.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -79,7 +79,7 @@ public function handle(StartDiscussion $command) |
|  |  | // We will do this by running the PostReply command. |
|  |  | try { |
|  |  | $post = $this->bus->dispatch( |
|  |  | new PostReply($discussion->id, $actor, $data, $ipAddress) |
|  |  | new PostReply($discussion->id, $actor, $data, $ipAddress, true) |
|  |  | ); |
|  |  | } catch (Exception $e) { |
|  |  | $discussion->delete(); |
| Expand Down | |  |

8 changes: 7 additions & 1 deletion

8
[framework/core/src/Post/Command/PostReply.php](#diff-922fdb086973233bd6a511589a57abd8a63cfd0dabbbd6d8ee2bc9c1646ee5a5 "framework/core/src/Post/Command/PostReply.php")

Show comments

[View file](/flarum/framework/blob/12f14112a0ecd1484d97330b82beb2a145919015/framework/core/src/Post/Command/PostReply.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -41,17 +41,23 @@ class PostReply |
|  |  | \*/ |
|  |  | public $ipAddress; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @var bool |
|  |  | \*/ |
|  |  | public $isFirstPost; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param int $discussionId The ID of the discussion to post the reply to. |
|  |  | \* @param User $actor The user who is performing the action. |
|  |  | \* @param array $data The attributes to assign to the new post. |
|  |  | \* @param string $ipAddress The IP address of the actor. |
|  |  | \*/ |
|  |  | public function \_\_construct($discussionId, User $actor, array $data, $ipAddress = null) |
|  |  | public function \_\_construct($discussionId, User $actor, array $data, $ipAddress = null, bool $isFirstPost = false) |
|  |  | { |
|  |  | $this->discussionId = $discussionId; |
|  |  | $this->actor = $actor; |
|  |  | $this->data = $data; |
|  |  | $this->ipAddress = $ipAddress; |
|  |  | $this->isFirstPost = $isFirstPost; |
|  |  | } |
|  |  | } |

2 changes: 1 addition & 1 deletion

2
[framework/core/src/Post/Command/PostReplyHandler.php](#diff-eeb7feacc10e4a62223b2b1e185f0d09b063ef2de2bfda059e71698d5525ede1 "framework/core/src/Post/Command/PostReplyHandler.php")

Show comments

[View file](/flarum/framework/blob/12f14112a0ecd1484d97330b82beb2a145919015/framework/core/src/Post/Command/PostReplyHandler.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -74,7 +74,7 @@ public function handle(PostReply $command) |
|  |  |  |
|  |  | // If this is the first post in the discussion, it's technically not a |
|  |  | // "reply", so we won't check for that permission. |
|  |  | if ($discussion->first\_post\_id !== null) { |
|  |  | if (! $command->isFirstPost) { |
|  |  | $actor->assertCan('reply', $discussion); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

47 changes: 41 additions & 6 deletions

47
[framework/core/tests/integration/api/posts/CreateTest.php](#diff-562cc9d52a09cb183499ac7a603b522411a7a69638d5522e5e716c686ecad13b "framework/core/tests/integration/api/posts/CreateTest.php")

Show comments

[View file](/flarum/framework/blob/12f14112a0ecd1484d97330b82beb2a145919015/framework/core/tests/integration/api/posts/CreateTest.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,6 +10,7 @@ |
|  |  | namespace Flarum\Tests\integration\api\posts; |
|  |  |  |
|  |  | use Carbon\Carbon; |
|  |  | use Flarum\Group\Group; |
|  |  | use Flarum\Testing\integration\RetrievesAuthorizedUsers; |
|  |  | use Flarum\Testing\integration\TestCase; |
|  |  |  |
| Expand All | | @@ -26,36 +27,70 @@ protected function setUp(): void |
|  |  |  |
|  |  | $this->prepareDatabase([ |
|  |  | 'discussions' => [ |
|  |  | ['id' => 1, 'title' => \_\_CLASS\_\_, 'created\_at' => Carbon::now()->toDateTimeString(), 'user\_id' => 2], |
|  |  | ['id' => 1, 'title' => \_\_CLASS\_\_, 'created\_at' => Carbon::now()->toDateTimeString(), 'user\_id' => 2, 'first\_post\_id' => 1], |
|  |  | // Discussion with deleted first post. |
|  |  | ['id' => 2, 'title' => \_\_CLASS\_\_, 'created\_at' => Carbon::now()->toDateTimeString(), 'user\_id' => 2, 'first\_post\_id' => null], |
|  |  | ], |
|  |  | 'posts' => [ |
|  |  | ['id' => 1, 'discussion\_id' => 1, 'number' => 1, 'created\_at' => Carbon::now()->subDay()->toDateTimeString(), 'user\_id' => 2, 'type' => 'comment', 'content' => '<t></t>'], |
|  |  | ], |
|  |  | 'users' => [ |
|  |  | $this->normalUser(), |
|  |  | ] |
|  |  | ['id' => 3, 'username' => 'restricted', 'email' => 'restricted@machine.local', 'is\_email\_confirmed' => 1], |
|  |  | ], |
|  |  | 'groups' => [ |
|  |  | ['id' => 40, 'name\_singular' => 'tess', 'name\_plural' => 'tess'], |
|  |  | ], |
|  |  | 'group\_user' => [ |
|  |  | ['group\_id' => 40, 'user\_id' => 3], |
|  |  | ], |
|  |  | 'group\_permission' => [ |
|  |  | ['group\_id' => 40, 'permission' => 'discussion.reply'], |
|  |  | ], |
|  |  | ]); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @dataProvider discussionRepliesPrvider |
|  |  | \* @test |
|  |  | \*/ |
|  |  | public function can\_create\_reply() |
|  |  | public function can\_create\_reply\_if\_allowed(int $actorId, int $discussionId, int $responseStatus) |
|  |  | { |
|  |  | // Reset permissions for normal users group. |
|  |  | $this->database() |
|  |  | ->table('group\_permission') |
|  |  | ->where('permission', 'discussion.reply') |
|  |  | ->where('group\_id', Group::MEMBER\_ID) |
|  |  | ->delete(); |
|  |  |  |
|  |  | $response = $this->send( |
|  |  | $this->request('POST', '/api/posts', [ |
|  |  | 'authenticatedAs' => 2, |
|  |  | 'authenticatedAs' => $actorId, |
|  |  | 'json' => [ |
|  |  | 'data' => [ |
|  |  | 'attributes' => [ |
|  |  | 'content' => 'reply with predetermined content for automated testing - too-obscure', |
|  |  | ], |
|  |  | 'relationships' => [ |
|  |  | 'discussion' => ['data' => ['id' => 1]], |
|  |  | 'discussion' => ['data' => ['id' => $discussionId]], |
|  |  | ], |
|  |  | ], |
|  |  | ], |
|  |  | ]) |
|  |  | ); |
|  |  |  |
|  |  | $this->assertEquals(201, $response->getStatusCode()); |
|  |  | $this->assertEquals($responseStatus, $response->getStatusCode()); |
|  |  | } |
|  |  |  |
|  |  | public function discussionRepliesPrvider(): array |
|  |  | { |
|  |  | return [ |
|  |  | // [$actorId, $discussionId, $responseStatus] |
|  |  | 'can\_create\_reply\_with\_ability' => [3, 1, 201], |
|  |  | 'cannot\_create\_reply\_without\_ability' => [2, 1, 403], |
|  |  | 'can\_create\_reply\_with\_ability\_when\_first\_post\_is\_deleted' => [3, 2, 201], |
|  |  | 'cannot\_create\_reply\_without\_ability\_when\_first\_post\_is\_deleted' => [2, 2, 403], |
|  |  | ]; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `12f1411`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fflarum%2Fframework%2Fcommit%2F12f14112a0ecd1484d97330b82beb2a145919015) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


