=== Content from gitlab.com_6489e58a_20250114_204531.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2023](/gitlab-org/cves/-/tree/master/2023)
* [**CVE-2023-0921.json**](/gitlab-org/cves/-/blob/master/2023/CVE-2023-0921.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2023/CVE-2023-0921.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2023/CVE-2023-0921.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![Michael Henriksen's avatar](/uploads/-/system/user/avatar/7539010/avatar.png?width=64 "Michael Henriksen")](/mhenriksen)

  Sep 30, 2024

  [4d03cee4](/gitlab-org/cves/-/commit/4d03cee424ee9d753361bb23addf161c2467b281)
  [Update titles on updated records](/gitlab-org/cves/-/commit/4d03cee424ee9d753361bb23addf161c2467b281)
  ·
  4d03cee4

  [Michael Henriksen](/mhenriksen) authored Sep 30, 2024

  4d03cee4

  [Update titles on updated records](/gitlab-org/cves/-/commit/4d03cee424ee9d753361bb23addf161c2467b281)
  [Michael Henriksen](/mhenriksen) authored Sep 30, 2024

Loading



=== Content from gitlab.com_baa75ecb_20250114_204533.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Denial of Service using multiple labels with arbitrarily large descriptions

# ⚠ Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.

**[HackerOne report #1869839](https://hackerone.com/reports/1869839)** by `cryptopone` on 2023-02-10, assigned to [@cmaxim](/cmaxim "Costel Maxim"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

Other reports that have attacked arbitrary long descriptions include #1685995 and #1544507.

After reviewing the fix for #1685995 it appears most features using description\_html now limit the amount of text in the description field to 1MB. However, labels were missed and are still able to accept arbitrarily long description text. Additionally, the group and project labels pages display multiple labels along with their descriptions and can be leveraged as a new attack vector. Both group and project labels pages normally limit the number of labels displayed to 20 per page, however this limit could be bypassed for project labels by using the "Prioritized Labels" feature (by calling /:namespace/:project/-/labels/set\_priorities with a list of ids) which will help apply additional stress on the GitLab instance when rendering the project labels page.

The end result is an attacker is able to load long description payloads into multiple labels, prioritize the affected labels on a project labels page, and then load the labels page N+1 times (GitLab worker threads + 1) to trigger server instability including out of memory errors and cpu resource exhaustion forcing the bundle processes to timeout. This action will negatively impact availability to other users accessing the GitLab instance resulting in 500/502 errors.

Note: In addition to the info above, opening the labels drop down inside of an issue/merge request is also a way to inadvertently trigger long server processing when labels contain long descriptions. Finally, exporting a project containing large label descriptions also pins a worker process with high cpu and memory consumption for a longer duration of time (bypassing the 60 second timeout limit for a single thread).

##### Steps to reproduce

To run the Python 3 scripts in the steps provided you will require two additional libraries from pip.

```
python3 -m pip install requests
python3 -m pip install urllib3
```

###### (Optional) Administrator - Apply Server Rate Limiting

1. Log into the GitLab instance as root.
2. Navigate to <http://gitlab.example.com/admin/application_settings/network>
3. Enable rate limits under "User and IP rate limits" and "Deprecated API rate limits" to demonstrate this attack is not affected by these configurable limits.

###### Attacker Setup:

1. Signin to GitLab using the attacker's credentials.
2. Navigate to <https://gitlab.example.com/projects/new> and create a new blank project using the attacker's namespace (ex. attacker/labeldos). Set the visibility to Public for ease of reproduction when using retrieve\_label.py.
3. Generate an API token via (<http://gitlab.example.com/-/profile/personal_access_tokens>) or obtain \_gitlab\_session from your web session and a csrf-token from a web page containing a form (such as the new project page from the previous step).
4. Run the python script "store\_label\_graphql.py" [store\_label\_graphql.py](https://h1.sec.gitlab.net/a/94452b91-5beb-46f2-888b-70233b4d50ae/store_label_graphql.py) supplying the project path and prefix when creating the labels. Running the script without arguments will prompt for each parameter before running the script.

```
python3 store_label_graphql.py --hostname http://gitlab.example.com --payload '&' --num-attempts 60 --post-size-mb 40 --delay 3 --tagPrefix MyLabel --projectPath attacker/labeldos --threadpool 3
```

It will take some time for this command to complete as the script will be limited by both the threadpool variable and ultimately the number of worker processes available on the GitLab instance. Using 3 threads expect it to take about 10 mins.

If the request is processed successfully the response will contain a gid link to the new label. Large payloads may result in a response that returns an error, if the graphQL error comes back with "Timeout on BaseMutation.errors" it's possible the label was still created successfully. Failures to create a label typically result in a response with a 500/502 status code.

Please Note: I have only found it possible to "promote" a label via a call to /:namespace/:project/-/labels/set\_priorities, as a result, it's only possible to automate this with the script when using \_gitlab\_session and X-CSRF-Token params (ie. Not an Personal Access Token/API key) and the script will attempt to output a list of label ids to promote manually.

###### Promote labels to bypass the 20 display limit (manually):

Note: This step should only be required if a personal access token was used to run "store\_label\_graphql.py".

1. Using a web browser proxying to burpsuite, navigate to the labels page (<http://gitlab.example.com/attacker/labeldos/-/labels>).
2. Turn on Intercept in BurpSuite -> Proxy -> Intercept tabs.
3. On the project labels page, click the star next to one of the labels.
4. Update the payload of the post request to "/attacker/labeldos/-/labels/set\_priorities" with a list of all the label ids. If you used store\_label\_graphql.py with a personal access token, the list of id's will be in the output from the script. Ensure "label\_ids" has double quotes around it to avoid a 400 Bad Request error. It is also possible to substitute a comma delimited list of ids that covers all ids between the first and last label id generated (invalid ids will be removed by the server automatically).
5. Load the labels page again (ie. <http://gitlab.example.com/attacker/labeldos/-/labels>). If more than 20 labels were prioritized, note they will now appear on a single page (instead of only displaying 20 per page).

Note: A video demonstrating this stage is provided

[Demo\_using\_store\_label\_graphql\_script\_with\_PAT\_and\_manual\_label\_promote.mp4](https://user-content.gitlab-static.net/9315981eedb02e4c812eb9544531ba00e709d1a0/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33386135353161652d643835302d343964622d393261352d6232363030363063623565362f44656d6f5f7573696e675f73746f72655f6c6162656c5f6772617068716c5f7363726970745f776974685f5041545f616e645f6d616e75616c5f6c6162656c5f70726f6d6f74652e6d7034 "Download 'Demo_using_store_label_graphql_script_with_PAT_and_manual_label_promote.mp4'")

###### Attacker Reproduction:

1. Confirm the number of worker threads used by GitLab (Omnibus and docker installs default to 4). When logged into an instance console the following command can be used:

```
cat /etc/gitlab/gitlab.rb | grep thread
```

And output on a GitLab supplied docker container shows these config commands are commented out suggesting threads are still set to 4:

```
root@gitlab:/# cat /etc/gitlab/gitlab.rb | grep thread
###  puma['min_threads'] = 4
###  puma['max_threads'] = 4
##### ! Redis threaded I/O
###  redis['io_threads'] = 4
###  redis['io_threads_do_reads'] = true
####  ! { "pack" => ["threads = 1"] }
###    { 'section': 'pack', 'key': 'threads', 'value': '4' }
```

2. Navigate to [http://gitlab.example.com/:namespace/:project/edit](http://gitlab.example.com/%3Anamespace/%3Aproject/edit) (ex. <https://gitlab.example.com/attacker/labeldos/edit>)
3. Expand the Advanced section and press the "Export Project" button or "Generate new export" to apply additional stress to the server to assist with reproducing this report.
4. Run the retrieve\_label.py script [retrieve\_label.py](https://h1.sec.gitlab.net/a/225bcda9-680d-4a2c-8072-b8af105d9d48/retrieve_label.py). Below are the arguments arguments I used for this report:

```
python3 retrieve_label.py --hostname http://gitlab.example.com --num-attempts 15 --delay 4 --projectPath attacker/labeldos --threadpool 4
```

Note: This "retrieve\_label.py" script makes consistent calls to <http://gitlab.example.com/attacker/labeldos/-/labels> to aid in reproduction which could be reproduced manually using multiple browser tabs.

###### Victim Reproduction:

1. Log into victim user account in a separate browser instance.
2. Perform actions (click a project to navigate to it, navigate between "Project information" and "Issues" pages, select user profile, etc) during the attack and wait for a response.
3. If a page completes loading successfully, initiate a new action (while the attack is ongoing) to try reproducing the server error.
4. Note the delays in server response, and if the Attacker is successful, the resulting error (500 or 502) or complete loss of server connection for connected clients.

Note: If possible, have an observer ssh into the server and review system resources via the "top" command. Note the high memory usage during the attack which could lead to bundle processes crashing as a result of "Out of Memory" errors. There is a chance one of the bundle threads crashing will result in immediate 500/502 errors for connected clients until the server is able to recover.

A video reproducing this report is provided

[Demo\_repro\_using\_retrieve\_label\_and\_project\_export.mp4](https://user-content.gitlab-static.net/14226ed22e6b424656013b7f9e4824d11f9f6ae3/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64356566383466352d623934362d343766622d383464332d3630383831366466396138362f44656d6f5f726570726f5f7573696e675f72657472696576655f6c6162656c5f616e645f70726f6a6563745f6578706f72742e6d7034 "Download 'Demo_repro_using_retrieve_label_and_project_export.mp4'")

##### Impact

Multiple requests to view a project's label page containing multiple labels with long description payloads can exhaust server resources, preventing unrelated users from completing requests or accessing the server instance.

Exporting a project containing multiple labels with large descriptions is an additional method to apply stress to a GitLab instance and can help create additional instability that can crash bundle processes on the server as a result of out of memory errors.

##### Examples

###### Sample Project

I exported an example project containing 60 labels with a 40MB payload of '&' characters (totals 2.4GB raw text). The export results in a 22MB tar.gz file that when extracted results in a 15.1GB labels.ndjson file (over 6x the size of the original payload). This attack can be scaled up or down as needed to overwhelm different hardware configurations.

[attacker\_labeldos\_export.tar.gz](https://h1.sec.gitlab.net/a/ca2fbbf0-4d14-4d28-9c8d-11f370d445d2/attacker_labeldos_export.tar.gz)

Note: GitLab will not import this project successfully due to the high compression of labels.nsjson.

###### Demonstrating use of store\_label\_graphql.py

Attached is a reproduction video demonstrating the script loading 5 labels with a Personal Access Token and then the attacker manually promotes these labels using the script output along with BurpSuite repeater.

[Demo\_using\_store\_label\_graphql\_script\_with\_PAT\_and\_manual\_label\_promote.mp4](https://user-content.gitlab-static.net/9315981eedb02e4c812eb9544531ba00e709d1a0/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33386135353161652d643835302d343964622d393261352d6232363030363063623565362f44656d6f5f7573696e675f73746f72655f6c6162656c5f6772617068716c5f7363726970745f776974685f5041545f616e645f6d616e75616c5f6c6162656c5f70726f6d6f74652e6d7034 "Download 'Demo_using_store_label_graphql_script_with_PAT_and_manual_label_promote.mp4'")

###### Repro using retrieve\_labels.py and project export

Attached is a reproduction video demonstrating how an attacker can overwhelm a GitLab instance using multiple labels with a large description payload. The high resource consumption during this attack renders a 502 response for a victum user.

[Demo\_repro\_using\_retrieve\_label\_and\_project\_export.mp4](https://user-content.gitlab-static.net/14226ed22e6b424656013b7f9e4824d11f9f6ae3/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64356566383466352d623934362d343766622d383464332d3630383831366466396138362f44656d6f5f726570726f5f7573696e675f72657472696576655f6c6162656c5f616e645f70726f6a6563745f6578706f72742e6d7034 "Download 'Demo_repro_using_retrieve_label_and_project_export.mp4'")

###### GitLab.com accepts labels with large descriptions

I verified GitLab.com will create labels with large descriptions (40MB payload using store\_label\_graphql.py). Only one label was uploaded and nothing else was done to avoid creating a DOS scenario.

The label is contained within a Private project - <https://gitlab.com/Cryptopone/jan2023testing/-/labels>

[![large_label_description_on_gitlab-com.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/b843173bacd3dfa2bc1cce4ddb0a9b5653bc38d0/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f66663763346562342d626635642d346436322d383533332d3235303663306261636463372f6c617267655f6c6162656c5f6465736372697074696f6e5f6f6e5f6769746c61622d636f6d2e706e67)

##### What is the current *bug* behavior?

The GitLab instance accepts and processes labels with arbitrarily long description payloads. When rendering the project labels page, the process generating the response will continue to run on the server until the timeout threshold is hit (defaults to 60 seconds on self-hosted) or crashes due to out of memory errors.

During this time other users attempting to access a GitLab instance could be negatively impacted and receive error responses from the server for valid requests.

##### What is the expected *correct* behavior?

Users accessing a GitLab instance should not be negatively impacted by malicious actors abusing label description sizes.

##### Relevant logs and/or screenshots

Demonstrating how Prioritized Labels bypass the 20 per page limit for labels on [http://gitlab.example.com/:namespace/:project/-/labels](http://gitlab.example.com/%3Anamespace/%3Aproject/-/labels)

These screenshots show 60 labels displayed on the page.

[![Project_With_60_Prioritized_Labels_One_Page_-_top.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/27864b94e260603feca40102e24f34503a2a55c1/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32353839356365342d613865392d343062312d613730632d6230333632333836643935622f50726f6a6563745f576974685f36305f5072696f726974697a65645f4c6162656c735f4f6e655f506167655f2d5f746f702e706e67)

[![Project_With_60_Prioritized_Labels_One_Page_-_bottom.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/6022a315ec7b6804665bab05e38e590be963b930/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f66653766653964302d353666382d343539652d616536332d3635356335376435646263352f50726f6a6563745f576974685f36305f5072696f726974697a65645f4c6162656c735f4f6e655f506167655f2d5f626f74746f6d2e706e67)

Screenshot demonstrating bundle processes crashing due to out of memory errors during reproduction.

[![crashing_bundle_processes.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/71bfbf63df64d7653289e63be921c819829979a6/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33646164363762322d306165372d343437332d623238302d3031346233383830616234322f6372617368696e675f62756e646c655f70726f6365737365732e706e67)

##### Output of checks

This bug happens on GitLab.com

Note: Only verified that a single label could be created, no DOS testing was performed.

###### Results of GitLab environment info

GitLab 15.8.1 docker container running within a 4 core cpu / 16 GB vm.

```
root@gitlab:/# gitlab-rake gitlab:env:info

System information
System:
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	2.7.7p221
Gem Version:	3.1.6
Bundler Version:2.3.15
Rake Version:	13.0.6
Redis Version:	6.2.8
Sidekiq Version:6.5.7
Go Version:	unknown

GitLab information
Version:	15.8.1-ee
Revision:	c49deff6e37
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	13.8
URL:		http://gitlab.example.com
HTTP Clone URL:	http://gitlab.example.com/some-group/some-project.git
SSH Clone URL:	git@gitlab.example.com:some-group/some-project.git
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	14.15.0
Repository storages:
- default: 	unix:/var/opt/gitlab/gitaly/gitaly.socket
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
```

#### Impact

Multiple requests to view a project's label page containing multiple labels with long description payloads can exhaust server resources, preventing unrelated users from completing requests or accessing the server instance.

Exporting a project containing multiple labels with large descriptions is an additional method to apply stress to a GitLab instance and can help create additional instability that can crash bundle processes on the server as a result of out of memory errors.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [Demo\_using\_store\_label\_graphql\_script\_with\_PAT\_and\_manual\_label\_promote.mp4](https://h1.sec.gitlab.net/a/38a551ae-d850-49db-92a5-b260060cb5e6/Demo_using_store_label_graphql_script_with_PAT_and_manual_label_promote.mp4)
* [Demo\_repro\_using\_retrieve\_label\_and\_project\_export.mp4](https://h1.sec.gitlab.net/a/d5ef84f5-b946-47fb-84d3-608816df9a86/Demo_repro_using_retrieve_label_and_project_export.mp4)
* [large\_label\_description\_on\_gitlab-com.png](https://h1.sec.gitlab.net/a/ff7c4eb4-bf5d-4d62-8533-2506c0bacdc7/large_label_description_on_gitlab-com.png)
* [Project\_With\_60\_Prioritized\_Labels\_One\_Page\_-\_top.png](https://h1.sec.gitlab.net/a/25895ce4-a8e9-40b1-a70c-b0362386d95b/Project_With_60_Prioritized_Labels_One_Page_-_top.png)
* [Project\_With\_60\_Prioritized\_Labels\_One\_Page\_-\_bottom.png](https://h1.sec.gitlab.net/a/fe7fe9d0-56f8-459e-ae63-655c57d5dbc5/Project_With_60_Prioritized_Labels_One_Page_-_bottom.png)
* [attacker\_labeldos\_export.tar.gz](https://h1.sec.gitlab.net/a/ca2fbbf0-4d14-4d28-9c8d-11f370d445d2/attacker_labeldos_export.tar.gz)
* [crashing\_bundle\_processes.png](https://h1.sec.gitlab.net/a/3dad67b2-0ae7-4473-b280-014b3880ab42/crashing_bundle_processes.png)
* [store\_label\_graphql.py](https://h1.sec.gitlab.net/a/94452b91-5beb-46f2-888b-70233b4d50ae/store_label_graphql.py)
* [retrieve\_label.py](https://h1.sec.gitlab.net/a/225bcda9-680d-4a2c-8072-b8af105d9d48/retrieve_label.py)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


