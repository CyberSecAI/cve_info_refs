=== Content from plugins.trac.wordpress.org_af93a6f1_20250114_201627.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fkraken-image-optimizer%2Ftags%2F2.6.6%2Fkraken.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/kraken-image-optimizer/tags/2.6.6/kraken.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/kraken-image-optimizer/tags/2.6.6/kraken.php)

---

# [source:](/browser?order=name "Go to repository root") [kraken-image-optimizer](/browser/kraken-image-optimizer?order=name "View kraken-image-optimizer")/[tags](/browser/kraken-image-optimizer/tags?order=name "View tags")/[2.6.6](/browser/kraken-image-optimizer/tags/2.6.6?order=name "View 2.6.6")/[kraken.php](/browser/kraken-image-optimizer/tags/2.6.6/kraken.php?order=name "View kraken.php")

View diff against:

View revision:

| [Last change](/changeset/2802730/kraken-image-optimizer/tags/2.6.6/kraken.php "View differences") on this file was [2802730](/changeset/2802730/ "View changeset 2802730"), checked in by karim79, [2 years ago](/timeline?from=2022-10-21T22%3A30%3A51Z&precision=second "See timeline at 10/21/2022 10:30:51 PM") |
| --- |
| tagging version 2.6.6 |
| * Property **svn:executable** set to   *`*`* | |
| **File size:** 54.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Copyright 2015  Karim Salman  (email : ksalman@kraken.io) |
| [4](#L4) |  |
| [5](#L5) | This program is free software; you can redistribute it and/or modify |
| [6](#L6) | it under the terms of the GNU General Public License, version 2, as |
| [7](#L7) | published by the Free Software Foundation. |
| [8](#L8) |  |
| [9](#L9) | This program is distributed in the hope that it will be useful, |
| [10](#L10) | but WITHOUT ANY WARRANTY; without even the implied warranty of |
| [11](#L11) | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the |
| [12](#L12) | GNU General Public License for more details. |
| [13](#L13) |  |
| [14](#L14) | You should have received a copy of the GNU General Public License |
| [15](#L15) | along with this program; if not, write to the Free Software |
| [16](#L16) | Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA |
| [17](#L17) | \*/ |
| [18](#L18) |  |
| [19](#L19) | /\* |
| [20](#L20) | \* Plugin Name: Kraken Image Optimizer |
| [21](#L21) | \* Plugin URI: http://wordpress.org/plugins/kraken-image-optimizer/ |
| [22](#L22) | \* Description: This plugin allows you to optimize your WordPress images through the Kraken API, the world's most advanced image optimization solution. |
| [23](#L23) | \* Author: Karim Salman |
| [24](#L24) | \* Version: 2.6.6 |
| [25](#L25) | \* Requires at least: 3.0.1 |
| [26](#L26) | \* Requires PHP: 5.0.0 |
| [27](#L27) | \* Stable Tag: 2.6.6 |
| [28](#L28) | \* Author URI: https://kraken.io |
| [29](#L29) | \* License GPL2 |
| [30](#L30) | \*/ |
| [31](#L31) |  |
| [32](#L32) |  |
| [33](#L33) | if ( !class\_exists( 'Wp\_Kraken' ) ) { |
| [34](#L34) |  |
| [35](#L35) | define( 'KRAKEN\_DEV\_MODE', false ); |
| [36](#L36) | class Wp\_Kraken { |
| [37](#L37) |  |
| [38](#L38) | private $id; |
| [39](#L39) |  |
| [40](#L40) | private $kraken\_settings = array(); |
| [41](#L41) |  |
| [42](#L42) | private $thumbs\_data = array(); |
| [43](#L43) |  |
| [44](#L44) | private $optimization\_type = 'lossy'; |
| [45](#L45) |  |
| [46](#L46) | public static $kraken\_plugin\_version = '2.6.4'; |
| [47](#L47) |  |
| [48](#L48) | function \_\_construct() { |
| [49](#L49) | $plugin\_dir\_path = dirname( \_\_FILE\_\_ ); |
| [50](#L50) | require\_once( $plugin\_dir\_path . '/lib/Kraken.php' ); |
| [51](#L51) | $this->kraken\_settings = get\_option( '\_kraken\_options' ); |
| [52](#L52) | $this->optimization\_type = $this->kraken\_settings['api\_lossy']; |
| [53](#L53) | add\_action( 'admin\_enqueue\_scripts', array( &$this, 'my\_enqueue' ) ); |
| [54](#L54) | add\_action( 'wp\_ajax\_kraken\_reset', array( &$this, 'kraken\_media\_library\_reset' ) ); |
| [55](#L55) | add\_action( 'wp\_ajax\_kraken\_optimize', array( &$this, 'kraken\_optimize' ) ); |
| [56](#L56) | add\_action( 'wp\_ajax\_kraken\_request', array( &$this, 'kraken\_media\_library\_ajax\_callback' ) ); |
| [57](#L57) | add\_action( 'wp\_ajax\_kraken\_reset\_all', array( &$this, 'kraken\_media\_library\_reset\_all' ) ); |
| [58](#L58) | add\_action( 'manage\_media\_custom\_column', array( &$this, 'fill\_media\_columns' ), 10, 2 ); |
| [59](#L59) | add\_filter( 'manage\_media\_columns', array( &$this, 'add\_media\_columns') ); |
| [60](#L60) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename(\_\_FILE\_\_), array( &$this, 'add\_settings\_link' ) ); |
| [61](#L61) |  |
| [62](#L62) | if ( ( !empty( $this->kraken\_settings ) && !empty( $this->kraken\_settings['auto\_optimize'] ) ) || !isset( $this->kraken\_settings['auto\_optimize'] ) ) { |
| [63](#L63) | add\_action( 'add\_attachment', array( &$this, 'kraken\_media\_uploader\_callback' ) ); |
| [64](#L64) | add\_filter( 'wp\_generate\_attachment\_metadata', array( &$this, 'optimize\_thumbnails' ) ); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | // in case settings were not resaved after update |
| [68](#L68) | if ( !isset( $this->kraken\_settings["optimize\_main\_image"] ) ) { |
| [69](#L69) | $this->kraken\_settings["optimize\_main\_image"] = 1; |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | // in case settings were not resaved after update |
| [73](#L73) | if ( !isset( $this->kraken\_settings["chroma"] ) ) { |
| [74](#L74) | $this->kraken\_settings["chroma"] = '4:2:0'; |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | add\_action( 'admin\_menu', array( &$this, 'kraken\_menu' ) ); |
| [78](#L78) | } |
| [79](#L79) |  |
| [80](#L80) | function preg\_array\_key\_exists( $pattern, $array ) { |
| [81](#L81) | $keys = array\_keys( $array ); |
| [82](#L82) | return (int) preg\_grep( $pattern,$keys ); |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | function isApiActive() { |
| [86](#L86) | $settings = $this->kraken\_settings; |
| [87](#L87) | $api\_key = isset( $settings['api\_key'] ) ? $settings['api\_key'] : ''; |
| [88](#L88) | $api\_secret = isset( $settings['api\_secret'] ) ? $settings['api\_secret'] : ''; |
| [89](#L89) | if ( empty( $api\_key ) || empty( $api\_secret) ) { |
| [90](#L90) | return false; |
| [91](#L91) | } |
| [92](#L92) | return true; |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | function kraken\_menu() { |
| [96](#L96) | add\_options\_page( 'Kraken Image Optimizer Settings', 'Kraken.io', 'manage\_options', 'wp-krakenio', array( &$this, 'kraken\_settings\_page' ) ); |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | function add\_settings\_link ( $links ) { |
| [100](#L100) | $mylinks = array( |
| [101](#L101) | '<a href="' . admin\_url( 'options-general.php?page=wp-krakenio' ) . '">Settings</a>', |
| [102](#L102) | ); |
| [103](#L103) | return array\_merge( $links, $mylinks ); |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | function kraken\_settings\_page() { |
| [107](#L107) |  |
| [108](#L108) | if ( !empty( $\_POST ) && isset( $\_POST['settings\_form\_nonce'] ) && wp\_verify\_nonce( $\_POST['settings\_form\_nonce'], 'settings\_form\_nonce' ) ) { |
| [109](#L109) | $options = $\_POST['\_kraken\_options']; |
| [110](#L110) | $result = $this->validate\_options( $options ); |
| [111](#L111) | update\_option( '\_kraken\_options', $result['valid'] ); |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | $form\_nonce = wp\_create\_nonce( 'settings\_form\_nonce' ); |
| [115](#L115) | $settings = get\_option( '\_kraken\_options' ); |
| [116](#L116) | $lossy = isset( $settings['api\_lossy'] ) ? $settings['api\_lossy'] : 'lossy'; |
| [117](#L117) | $auto\_optimize = isset( $settings['auto\_optimize'] ) ? $settings['auto\_optimize'] : 1; |
| [118](#L118) | $optimize\_main\_image = isset( $settings['optimize\_main\_image'] ) ? $settings['optimize\_main\_image'] : 1; |
| [119](#L119) | $api\_key = isset( $settings['api\_key'] ) ? $settings['api\_key'] : ''; |
| [120](#L120) | $api\_secret = isset( $settings['api\_secret'] ) ? $settings['api\_secret'] : ''; |
| [121](#L121) | $show\_reset = isset( $settings['show\_reset'] ) ? $settings['show\_reset'] : 0; |
| [122](#L122) | $bulk\_async\_limit = isset( $settings['bulk\_async\_limit'] ) ? $settings['bulk\_async\_limit'] : 4; |
| [123](#L123) | $preserve\_meta\_date = isset( $settings['preserve\_meta\_date'] ) ? $settings['preserve\_meta\_date'] : 0; |
| [124](#L124) | $preserve\_meta\_copyright = isset( $settings['preserve\_meta\_copyright'] ) ? $settings['preserve\_meta\_copyright'] : 0; |
| [125](#L125) | $preserve\_meta\_geotag = isset( $settings['preserve\_meta\_geotag'] ) ? $settings['preserve\_meta\_geotag'] : 0; |
| [126](#L126) | $preserve\_meta\_orientation = isset( $settings['preserve\_meta\_orientation'] ) ? $settings['preserve\_meta\_orientation'] : 0; |
| [127](#L127) | $preserve\_meta\_profile = isset( $settings['preserve\_meta\_profile'] ) ? $settings['preserve\_meta\_profile'] : 0; |
| [128](#L128) | $auto\_orient = isset( $settings['auto\_orient'] ) ? $settings['auto\_orient'] : 1; |
| [129](#L129) | $resize\_width = isset( $settings['resize\_width'] ) ? $settings['resize\_width'] : 0; |
| [130](#L130) | $resize\_height = isset( $settings['resize\_height'] ) ? $settings['resize\_height'] : 0; |
| [131](#L131) | $jpeg\_quality = isset( $settings['jpeg\_quality'] ) ? $settings['jpeg\_quality'] : 0; |
| [132](#L132) | $chroma\_subsampling = isset( $settings['chroma'] ) ? $settings['chroma'] : '4:2:0'; |
| [133](#L133) |  |
| [134](#L134) | $sizes = array\_keys($this->get\_image\_sizes()); |
| [135](#L135) | foreach ($sizes as $size) { |
| [136](#L136) | $valid['include\_size\_' . $size] = isset( $settings['include\_size\_' . $size]) ? $settings['include\_size\_' . $size] : 1; |
| [137](#L137) | } |
| [138](#L138) |  |
| [139](#L139) | $status = $this->get\_api\_status( $api\_key, $api\_secret ); |
| [140](#L140) |  |
| [141](#L141) | $icon\_url = admin\_url() . 'images/'; |
| [142](#L142) | if ( $status !== false && isset( $status['active'] ) && $status['active'] === true ) { |
| [143](#L143) | $icon\_url .= 'yes.png'; |
| [144](#L144) | $status\_html = '<p class="apiStatus">Your credentials are valid <span class="apiValid" style="background:url(' . "'$icon\_url') no-repeat 0 0" . '"></span></p>'; |
| [145](#L145) | } else { |
| [146](#L146) | $icon\_url .= 'no.png'; |
| [147](#L147) | $status\_html = '<p class="apiStatus">There is a problem with your credentials <span class="apiInvalid" style="background:url(' . "'$icon\_url') no-repeat 0 0" . '"></span></p>'; |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | ?>      <h1 class="kraken-admin-section-title">Kraken.io Settings</h1> |
| [151](#L151) | <?php if ( isset( $result['error'] ) ) { ?> |
| [152](#L152) | <div class="kraken error settings-error"> |
| [153](#L153) | <?php foreach( $result['error'] as $error ) { ?> |
| [154](#L154) | <p><?php echo $error; ?></p> |
| [155](#L155) | <?php } ?> |
| [156](#L156) | </div> |
| [157](#L157) | <?php } else if ( isset( $result['success'] ) ) { ?> |
| [158](#L158) | <div class="kraken updated settings-error"> |
| [159](#L159) | <p>Settings saved.</p> |
| [160](#L160) | </div> |
| [161](#L161) | <?php } ?> |
| [162](#L162) |  |
| [163](#L163) | <?php if ( !function\_exists( 'curl\_init' ) ) { ?> |
| [164](#L164) | <p class="curl-warning"><strong>Warning: </strong>CURL is not available. Please install CURL before using this plugin</p> |
| [165](#L165) | <?php } ?> |
| [166](#L166) |  |
| [167](#L167) | <form id="krakenSettings" method="post"> |
| [168](#L168) | <a href="http://kraken.io/account" target="\_blank" title="Log in to your Kraken.io account">Kraken.io</a> API settings |
| [169](#L169) | <table class="form-table"> |
| [170](#L170) | <tbody> |
| [171](#L171) | <tr> |
| [172](#L172) | <th scope="row">API Key:</th> |
| [173](#L173) | <td> |
| [174](#L174) | <input id="kraken\_api\_key" name="\_kraken\_options[api\_key]" type="text" value="<?php echo esc\_attr( $api\_key ); ?>" size="50"> |
| [175](#L175) | </td> |
| [176](#L176) | </tr> |
| [177](#L177) | <tr> |
| [178](#L178) | <th scope="row">API Secret:</th> |
| [179](#L179) | <td> |
| [180](#L180) | <input id="kraken\_api\_secret" name="\_kraken\_options[api\_secret]" type="text" value="<?php echo esc\_attr( $api\_secret ); ?>" size="50"> |
| [181](#L181) | </td> |
| [182](#L182) | </tr> |
| [183](#L183) | <tr> |
| [184](#L184) | <th scope="row">API status:</th> |
| [185](#L185) | <td> |
| [186](#L186) | <?php echo $status\_html ?> |
| [187](#L187) | </td> |
| [188](#L188) | </tr> |
| [189](#L189) | <tr class="with-tip"> |
| [190](#L190) | <th scope="row">Optimization mode:</th> |
| [191](#L191) | <td> |
| [192](#L192) | <input type="radio" id="kraken\_lossy" name="\_kraken\_options[api\_lossy]" value="lossy" <?php checked( 'lossy', $lossy, true ); ?>/> |
| [193](#L193) | <label for="kraken\_lossy">Intelligent Lossy</label> |
| [194](#L194) | <input style="margin-left:10px;" type="radio" id="kraken\_lossless" name="\_kraken\_options[api\_lossy]" value="lossless" <?php checked( 'lossless', $lossy, true ) ?>/> |
| [195](#L195) | <label for="kraken\_lossless">Lossless</label> |
| [196](#L196) | </td> |
| [197](#L197) | </tr> |
| [198](#L198) | <tr class="tip"> |
| [199](#L199) | <td colspan="2"> |
| [200](#L200) | <div> |
| [201](#L201) | The <strong>Intelligent Lossy</strong> mode will yield the greatest savings without perceivable reducing the quality of your images, and so we recommend this setting to users.<br /> |
| [202](#L202) | The <strong>Lossless</strong> mode will result in an unchanged image, however, will yield reduced savings as the image will not be recompressed. |
| [203](#L203) | </div> |
| [204](#L204) | </td> |
| [205](#L205) | </tr> |
| [206](#L206) | <tr class="with-tip"> |
| [207](#L207) | <th scope="row">Automatically optimize uploads:</th> |
| [208](#L208) | <td> |
| [209](#L209) | <input type="checkbox" id="auto\_optimize" name="\_kraken\_options[auto\_optimize]" value="1" <?php checked( 1, $auto\_optimize, true ); ?>/> |
| [210](#L210) | </td> |
| [211](#L211) | </tr> |
| [212](#L212) | <tr class="tip"> |
| [213](#L213) | <td colspan="2"> |
| [214](#L214) | <div> |
| [215](#L215) | Enabled by default. This setting causes images uploaded through the Media Uploader to be optimized on-the-fly.<br /> |
| [216](#L216) | If you do not wish to do this, or wish to optimize images later, disable this setting by unchecking the box. |
| [217](#L217) | </div> |
| [218](#L218) | </td> |
| [219](#L219) | </tr> |
| [220](#L220) | <tr class="with-tip"> |
| [221](#L221) | <th scope="row">Optimize main image:</th> |
| [222](#L222) | <td> |
| [223](#L223) | <input type="checkbox" id="optimize\_main\_image" name="\_kraken\_options[optimize\_main\_image]" value="1" <?php checked( 1, $optimize\_main\_image, true ); ?>/> |
| [224](#L224) | </td> |
| [225](#L225) | </tr> |
| [226](#L226) | <tr class="tip"> |
| [227](#L227) | <td colspan="2"> |
| [228](#L228) | <div> |
| [229](#L229) | Enabled by default. This option causes the image uploaded by the user to get optimized, as well as all sizes generated by WordPress.<br /> |
| [230](#L230) | Disabling this option results in faster uploading, since the main image is not sent to our system for optimization.<br /> |
| [231](#L231) | Disable this option if you never use the "main" image upload in your posts, or speed of image uploading is an issue. |
| [232](#L232) | </div> |
| [233](#L233) | </td> |
| [234](#L234) | </tr> |
| [235](#L235) | <tr class="with-tip"> |
| [236](#L236) | <th scope="row">Resize main image:</th> |
| [237](#L237) | <td> |
| [238](#L238) | Max Width (px):&nbsp;&nbsp;<input type="text" id="kraken\_maximum\_width" name="\_kraken\_options[resize\_width]" value="<?php echo esc\_attr( $resize\_width ); ?>" style="width:50px;" />&nbsp;&nbsp;&nbsp;Max Height (px):&nbsp;<input type="text" id="kraken\_maximum\_height" name="\_kraken\_options[resize\_height]" value="<?php echo esc\_attr( $resize\_height ); ?>" style="width:50px;" /> |
| [239](#L239) | </td> |
| [240](#L240) | </tr> |
| [241](#L241) | <tr class="tip"> |
| [242](#L242) | <td colspan="2"> |
| [243](#L243) | <div> |
| [244](#L244) | You can restrict the maximum dimensions of image uploads by width and/or height.<br /> |
| [245](#L245) | It is especially useful if you wish to prevent unnecessarily large photos with extremely high resolutions from being uploaded, for example, <br /> |
| [246](#L246) | photos shot with a recent-model iPhone. Note: you can restrict the dimenions by width, height, or both. A value of zero disables. |
| [247](#L247) | </div> |
| [248](#L248) | </td> |
| [249](#L249) | </tr> |
| [250](#L250) | <tr class="with-tip"> |
| [251](#L251) | <th scope="row">JPEG quality setting:</th> |
| [252](#L252) | <td> |
| [253](#L253) | <select name="\_kraken\_options[jpeg\_quality]"> |
| [254](#L254) | <?php $i = 0 ?> |
| [255](#L255) | <?php foreach ( range(100, 25) as $number ) { ?> |
| [256](#L256) | <?php if ( $i === 0 ) { ?> |
| [257](#L257) | <?php echo '<option value="0">Intelligent lossy (recommended)</option>'; ?> |
| [258](#L258) | <?php } ?> |
| [259](#L259) | <?php if ($i > 0) { ?> |
| [260](#L260) | <option value="<?php echo $number ?>" <?php selected( $jpeg\_quality, $number, true); ?>> |
| [261](#L261) | <?php echo $number; ?> |
| [262](#L262) | <?php } ?> |
| [263](#L263) | </option> |
| [264](#L264) | <?php $i++ ?> |
| [265](#L265) | <?php } ?> |
| [266](#L266) | </select> |
| [267](#L267) | </td> |
| [268](#L268) | </tr> |
| [269](#L269) | <tr class="tip"> |
| [270](#L270) | <td colspan="2"> |
| [271](#L271) | <div> |
| [272](#L272) | Advanced users can force the quality of JPEG images to a discrete "q" value between 25 and 100 using this setting <br /> |
| [273](#L273) | For example, forcing the quality to 60 or 70 might yield greater savings, but the resulting quality might be affected, depending on the image. <br /> |
| [274](#L274) | We therefore recommend keeping the <strong>Intelligent Lossy</strong> setting, which will not allow a resulting image of unacceptable quality.<br /> |
| [275](#L275) | This setting will be ignored when using the <strong>lossless</strong> optimization mode. |
| [276](#L276) | </div> |
| [277](#L277) | </td> |
| [278](#L278) | </tr> |
| [279](#L279) | <tr class="with-tip"> |
| [280](#L280) | <th scope="row">Chroma subsampling scheme:</th> |
| [281](#L281) | <td> |
| [282](#L282) | <input type="radio" id="kraken\_chroma\_420" name="\_kraken\_options[chroma]" value="4:2:0" <?php checked( '4:2:0', $chroma\_subsampling, true ); ?>/> |
| [283](#L283) | <label for="kraken\_chroma\_420">4:2:0 (default)</label> |
| [284](#L284) | <input style="margin-left:10px;" type="radio" id="kraken\_chroma\_422" name="\_kraken\_options[chroma]" value="4:2:2" <?php checked( '4:2:2', $chroma\_subsampling, true ) ?>/> |
| [285](#L285) | <label for="kraken\_chroma\_422">4:2:2</label> |
| [286](#L286) | <input style="margin-left:10px;" type="radio" id="kraken\_chroma\_444" name="\_kraken\_options[chroma]" value="4:4:4" <?php checked( '4:4:4', $chroma\_subsampling, true ) ?>/> |
| [287](#L287) | <label for="kraken\_chroma\_444">4:4:4 (no subsampling)</label> |
| [288](#L288) | </td> |
| [289](#L289) | </tr> |
| [290](#L290) | <tr class="tip"> |
| [291](#L291) | <td colspan="2"> |
| [292](#L292) | <div> |
| [293](#L293) | Advanced users can also set the resolution at which colour is encoded for JPEG images. In short, the default setting of <strong>4:2:0</strong> is suitable for most images,<br /> |
| [294](#L294) | and will result in the lowest possible optimized file size. Images containing high contrast text or bright red areas on flat backgrounds might benefit from disabling chroma subsampling<br /> |
| [295](#L295) | (by setting it to <strong>4:4:4</strong>). More information can be found in our <a href="https://kraken.io/docs/chroma-subsampling" target="\_blank">documentation</a>. |
| [296](#L296) | </div> |
| [297](#L297) | </td> |
| [298](#L298) | </tr> |
| [299](#L299) | <tr class="no-border"> |
| [300](#L300) | <td class="krakenAdvancedSettings"><h3><span class="kraken-advanced-settings-label">Advanced Settings</span></h3></td> |
| [301](#L301) | </tr> |
| [302](#L302) | <tr class="kraken-advanced-settings"> |
| [303](#L303) | <td colspan="2" class="krakenAdvancedSettingsDescription"><small>We recommend that you leave these settings at their default values</td> |
| [304](#L304) | </tr> |
| [305](#L305) | <tr class="kraken-advanced-settings"> |
| [306](#L306) | <th scope="row">Image Sizes to Krak:</th> |
| [307](#L307) | <td> |
| [308](#L308) | <?php $size\_count = count($sizes); ?> |
| [309](#L309) | <?php $i = 0; ?> |
| [310](#L310) | <?php foreach($sizes as $size) { ?> |
| [311](#L311) | <?php $size\_checked = isset( $valid['include\_size\_' . $size] ) ? $valid['include\_size\_' . $size] : 1; ?> |
| [312](#L312) | <label for="<?php echo "kraken\_size\_$size" ?>"><input type="checkbox" id="kraken\_size\_<?php echo $size ?>" name="\_kraken\_options[include\_size\_<?php echo $size ?>]" value="1" <?php checked( 1, $size\_checked, true ); ?>/>&nbsp;<?php echo $size ?></label>&nbsp;&nbsp;&nbsp;&nbsp; |
| [313](#L313) | <?php $i++ ?> |
| [314](#L314) | <?php if ($i % 3 == 0) { ?> |
| [315](#L315) | <br /> |
| [316](#L316) | <?php } ?> |
| [317](#L317) | <?php } ?> |
| [318](#L318) | </td> |
| [319](#L319) | </tr> |
| [320](#L320) | <tr class="kraken-advanced-settings"> |
| [321](#L321) | <th scope="row">Preserve EXIF Metadata:</th> |
| [322](#L322) | <td> |
| [323](#L323) | <label for="preserve\_meta\_date"><input type="checkbox" id="preserve\_meta\_date" name="\_kraken\_options[preserve\_meta\_date]" value="1" <?php checked( 1, $preserve\_meta\_date, true ); ?>/>&nbsp;Date</label>&nbsp;&nbsp;&nbsp;&nbsp; |
| [324](#L324) | <label for="preserve\_meta\_copyright"><input type="checkbox" id="preserve\_meta\_copyright" name="\_kraken\_options[preserve\_meta\_copyright]" value="1" <?php checked( 1, $preserve\_meta\_copyright, true ); ?>/>&nbsp;Copyright</label>&nbsp;&nbsp;&nbsp;&nbsp; |
| [325](#L325) | <label for="preserve\_meta\_geotag"><input type="checkbox" id="preserve\_meta\_geotag" name="\_kraken\_options[preserve\_meta\_geotag]" value="1" <?php checked( 1, $preserve\_meta\_geotag, true ); ?>/>&nbsp;Geotag</label>&nbsp;&nbsp;&nbsp;&nbsp; |
| [326](#L326) | <label for="preserve\_meta\_orientation"><input type="checkbox" id="preserve\_meta\_orientation" name="\_kraken\_options[preserve\_meta\_orientation]" value="1" <?php checked( 1, $preserve\_meta\_orientation, true ); ?>/>&nbsp;Orientation</label>&nbsp;&nbsp;&nbsp;&nbsp; |
| [327](#L327) | <label for="preserve\_meta\_profile"><input type="checkbox" id="preserve\_meta\_profile" name="\_kraken\_options[preserve\_meta\_profile]" value="1" <?php checked( 1, $preserve\_meta\_profile, true ); ?>/>&nbsp;Profile</label>&nbsp;&nbsp;&nbsp;&nbsp; |
| [328](#L328) | </td> |
| [329](#L329) | </tr> |
| [330](#L330) | <tr class="kraken-advanced-settings with-tip"> |
| [331](#L331) | <th scope="row">Automatically Orient Images:</th> |
| [332](#L332) | <td> |
| [333](#L333) | <input type="checkbox" id="auto\_orient" name="\_kraken\_options[auto\_orient]" value="1" <?php checked( 1, $auto\_orient, true ); ?>/> |
| [334](#L334) | </td> |
| [335](#L335) | </tr> |
| [336](#L336) | <tr class="tip"> |
| [337](#L337) | <td colspan="2"> |
| [338](#L338) | <div> |
| [339](#L339) | This setting will rotate the JPEG image according to its <strong>Orientation</strong> EXIF metadata such that it will always be correctly displayed in Web Browsers.<br /> |
| [340](#L340) | Enable this setting if many of your image uploads come from smart phones or digital cameras which set the orientation based on how they are held at the time of shooting. |
| [341](#L341) | </div> |
| [342](#L342) | </td> |
| [343](#L343) | </tr> |
| [344](#L344) | <tr class="kraken-advanced-settings with-tip"> |
| [345](#L345) | <th scope="row">Show metadata reset per image:</th> |
| [346](#L346) | <td> |
| [347](#L347) | <input type="checkbox" id="kraken\_show\_reset" name="\_kraken\_options[show\_reset]" value="1" <?php checked( 1, $show\_reset, true ); ?>/> |
| [348](#L348) | &nbsp;&nbsp;&nbsp;&nbsp;<span class="kraken-reset-all enabled">Reset All Images</span> |
| [349](#L349) | </td> |
| [350](#L350) | </tr> |
| [351](#L351) | <tr class="tip"> |
| [352](#L352) | <td colspan="2"> |
| [353](#L353) | <div> |
| [354](#L354) | Checking this option will add a Reset button in the "Show Details" popup in the Kraken Stats column for each optimized image.<br /> |
| [355](#L355) | Resetting an image will remove the Kraken.io metadata associated with it, effectively making your blog forget that it had been optimized in the first place, allowing further optimization in some cases.<br /> |
| [356](#L356) | If an image has been optimized using the lossless setting, lossless optimization will not yield any greater savings. If in doubt, please contact support@kraken.io |
| [357](#L357) | </div> |
| [358](#L358) | </td> |
| [359](#L359) | </tr> |
| [360](#L360) | <tr class="kraken-advanced-settings with-tip"> |
| [361](#L361) | <th scope="row">Bulk Concurrency:</th> |
| [362](#L362) | <td> |
| [363](#L363) | <select name="\_kraken\_options[bulk\_async\_limit]"> |
| [364](#L364) | <?php foreach ( range(1, 10) as $number ) { ?> |
| [365](#L365) | <option value="<?php echo $number ?>" <?php selected( $bulk\_async\_limit, $number, true); ?>> |
| [366](#L366) | <?php echo $number ?> |
| [367](#L367) | </option> |
| [368](#L368) | <?php } ?> |
| [369](#L369) | </select> |
| [370](#L370) | </td> |
| [371](#L371) | </tr> |
| [372](#L372) | <tr class="tip"> |
| [373](#L373) | <td colspan="2"> |
| [374](#L374) | <div> |
| [375](#L375) | This settings defines how many images can be processed at the same time using the bulk optimizer. The recommended (and default) value is 4. <br /> |
| [376](#L376) | For blogs on very small hosting plans, or with reduced connectivity, a lower number might be necessary to avoid hitting request limits. |
| [377](#L377) | </div> |
| [378](#L378) | </td> |
| [379](#L379) | </tr> |
| [380](#L380) | </tbody> |
| [381](#L381) | </table> |
| [382](#L382) | <input type="hidden"  name="settings\_form\_nonce" value="<?php echo $form\_nonce; ?>" /> |
| [383](#L383) | <input type="submit" name="kraken\_save" id="kraken\_save" class="button button-primary" value="Save All"/> |
| [384](#L384) | </form> |
| [385](#L385) | <?php |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | function validate\_options( $input ) { |
| [389](#L389) | $valid = array(); |
| [390](#L390) | $error = array(); |
| [391](#L391) | $valid['api\_lossy'] = $input['api\_lossy']; |
| [392](#L392) | $valid['auto\_optimize'] = isset( $input['auto\_optimize'] )? 1 : 0; |
| [393](#L393) | $valid['optimize\_main\_image'] = isset( $input['optimize\_main\_image'] ) ? 1 : 0; |
| [394](#L394) | $valid['preserve\_meta\_date'] = isset( $input['preserve\_meta\_date'] ) ? $input['preserve\_meta\_date'] : 0; |
| [395](#L395) | $valid['preserve\_meta\_copyright'] = isset( $input['preserve\_meta\_copyright'] ) ? $input['preserve\_meta\_copyright'] : 0; |
| [396](#L396) | $valid['preserve\_meta\_geotag'] = isset( $input['preserve\_meta\_geotag'] ) ? $input['preserve\_meta\_geotag'] : 0; |
| [397](#L397) | $valid['preserve\_meta\_orientation'] = isset( $input['preserve\_meta\_orientation'] ) ? $input['preserve\_meta\_orientation'] : 0; |
| [398](#L398) | $valid['preserve\_meta\_profile'] = isset( $input['preserve\_meta\_profile'] ) ? $input['preserve\_meta\_profile'] : 0; |
| [399](#L399) | $valid['auto\_orient'] = isset( $input['auto\_orient'] ) ? $input['auto\_orient'] : 0; |
| [400](#L400) | $valid['show\_reset'] = isset( $input['show\_reset'] ) ? 1 : 0; |
| [401](#L401) | $valid['bulk\_async\_limit'] = isset( $input['bulk\_async\_limit'] ) ? $input['bulk\_async\_limit'] : 4; |
| [402](#L402) | $valid['resize\_width'] = isset( $input['resize\_width'] ) ? (int) $input['resize\_width'] : 0; |
| [403](#L403) | $valid['resize\_height'] = isset( $input['resize\_height'] ) ? (int) $input['resize\_height'] : 0; |
| [404](#L404) | $valid['jpeg\_quality'] = isset( $input['jpeg\_quality'] ) ? (int) $input['jpeg\_quality'] : 0; |
| [405](#L405) | $valid['chroma'] = isset( $input['chroma'] ) ? $input['chroma'] : '4:2:0'; |
| [406](#L406) |  |
| [407](#L407) |  |
| [408](#L408) | $sizes = get\_intermediate\_image\_sizes(); |
| [409](#L409) | foreach ($sizes as $size) { |
| [410](#L410) | $valid['include\_size\_' . $size] = isset( $input['include\_size\_' . $size] ) ? 1 : 0; |
| [411](#L411) | } |
| [412](#L412) |  |
| [413](#L413) | if ( $valid['show\_reset'] ) { |
| [414](#L414) | $valid['show\_reset'] = $input['show\_reset']; |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | if ( empty( $input['api\_key']) || empty( $input['api\_secret'] ) ) { |
| [418](#L418) | $error[] = 'API Credentials must not be left blank.'; |
| [419](#L419) | } else { |
| [420](#L420) |  |
| [421](#L421) | $status = $this->get\_api\_status( $input['api\_key'], $input['api\_secret'] ); |
| [422](#L422) |  |
| [423](#L423) | if ( $status !== false ) { |
| [424](#L424) |  |
| [425](#L425) | if ( isset($status['active']) && $status['active'] === true ) { |
| [426](#L426) | if ( $status['plan\_name'] === 'Developers' ) { |
| [427](#L427) | $error[] = 'Developer API credentials cannot be used with this plugin.'; |
| [428](#L428) | } else { |
| [429](#L429) | $valid['api\_key'] = $input['api\_key']; |
| [430](#L430) | $valid['api\_secret'] = $input['api\_secret']; |
| [431](#L431) | } |
| [432](#L432) | } else { |
| [433](#L433) | $error[] = 'There is a problem with your credentials. Please check them from your Kraken.io account.'; |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | } else { |
| [437](#L437) | $error[] = 'Please enter a valid Kraken.io API key and secret.'; |
| [438](#L438) | } |
| [439](#L439) | } |
| [440](#L440) |  |
| [441](#L441) | if ( !empty( $error ) ) { |
| [442](#L442) | return array( 'success' => false, 'error' => $error, 'valid' => $valid ); |
| [443](#L443) | } else { |
| [444](#L444) | return array( 'success' => true, 'valid' => $valid ); |
| [445](#L445) | } |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | function my\_enqueue( $hook ) { |
| [449](#L449) |  |
| [450](#L450) | if ( $hook == 'options-media.php' || $hook == 'upload.php' || $hook == 'settings\_page\_wp-krakenio' ) { |
| [451](#L451) | wp\_enqueue\_script( 'jquery' ); |
| [452](#L452) | if ( KRAKEN\_DEV\_MODE === true ) { |
| [453](#L453) | wp\_enqueue\_script( 'async-js', plugins\_url( '/js/async.js', \_\_FILE\_\_ ) ); |
| [454](#L454) | wp\_enqueue\_script( 'tipsy-js', plugins\_url( '/js/jquery.tipsy.js', \_\_FILE\_\_ ), array( 'jquery' ) ); |
| [455](#L455) | wp\_enqueue\_script( 'modal-js', plugins\_url( '/js/jquery.modal.min.js', \_\_FILE\_\_ ), array( 'jquery' ) ); |
| [456](#L456) | wp\_enqueue\_script( 'ajax-script', plugins\_url( '/js/ajax.js', \_\_FILE\_\_ ), array( 'jquery' ) ); |
| [457](#L457) | wp\_localize\_script( 'ajax-script', 'ajax\_object', array( 'ajax\_url' => admin\_url( 'admin-ajax.php' ) ) ); |
| [458](#L458) | wp\_localize\_script( 'ajax-script', 'kraken\_settings', $this->kraken\_settings ); |
| [459](#L459) | wp\_enqueue\_style( 'kraken\_admin\_style', plugins\_url( 'css/admin.css', \_\_FILE\_\_ ) ); |
| [460](#L460) | wp\_enqueue\_style( 'tipsy-style', plugins\_url( 'css/tipsy.css', \_\_FILE\_\_ ) ); |
| [461](#L461) | wp\_enqueue\_style( 'modal-style', plugins\_url( 'css/jquery.modal.css', \_\_FILE\_\_ ) ); |
| [462](#L462) | } else { |
| [463](#L463) | wp\_enqueue\_script( 'kraken-js', plugins\_url( '/js/dist/kraken.min.js', \_\_FILE\_\_ ), array( 'jquery' ) ); |
| [464](#L464) | wp\_localize\_script( 'kraken-js', 'ajax\_object', array( 'ajax\_url' => admin\_url( 'admin-ajax.php' ) ) ); |
| [465](#L465) | wp\_localize\_script( 'kraken-js', 'kraken\_settings', $this->kraken\_settings ); |
| [466](#L466) | wp\_enqueue\_style( 'kraken-css', plugins\_url( 'css/dist/kraken.min.css', \_\_FILE\_\_ ) ); |
| [467](#L467) | } |
| [468](#L468) | } |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | function get\_api\_status( $api\_key, $api\_secret ) { |
| [472](#L472) |  |
| [473](#L473) | if ( !empty( $api\_key ) && !empty( $api\_secret ) ) { |
| [474](#L474) | $kraken = new Kraken( $api\_key, $api\_secret ); |
| [475](#L475) | $status = $kraken->status(); |
| [476](#L476) | return $status; |
| [477](#L477) | } |
| [478](#L478) | return false; |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \*      Converts an deserialized API result array into an array |
| [483](#L483) | \*      which this plugin will consume |
| [484](#L484) | \*/ |
| [485](#L485) | function get\_result\_arr( $result, $image\_id ) { |
| [486](#L486) | $rv = array(); |
| [487](#L487) | $rv['original\_size'] = $result['original\_size']; |
| [488](#L488) | $rv['kraked\_size'] = $result['kraked\_size']; |
| [489](#L489) | $rv['saved\_bytes'] = $result['saved\_bytes']; |
| [490](#L490) | $savings\_percentage = $result['saved\_bytes'] / $result['original\_size'] \* 100; |
| [491](#L491) | $rv['savings\_percent'] = round( $savings\_percentage, 2 ) . '%'; |
| [492](#L492) | $rv['type'] = $result['type']; |
| [493](#L493) | if ( !empty( $result['kraked\_width'] ) && !empty( $result['kraked\_height'] ) ) { |
| [494](#L494) | $rv['kraked\_width'] = $result['kraked\_width']; |
| [495](#L495) | $rv['kraked\_height'] = $result['kraked\_height']; |
| [496](#L496) | } |
| [497](#L497) | $rv['success'] = $result['success']; |
| [498](#L498) | $rv['meta'] = wp\_get\_attachment\_metadata( $image\_id ); |
| [499](#L499) | return $rv; |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) |  |
| [503](#L503) | /\*\* |
| [504](#L504) | \*  Handles optimizing already-uploaded images in the  Media Library |
| [505](#L505) | \*/ |
| [506](#L506) | function kraken\_media\_library\_ajax\_callback() { |
| [507](#L507) | $image\_id = (int) $\_POST['id']; |
| [508](#L508) | $type = false; |
| [509](#L509) |  |
| [510](#L510) | if ( isset( $\_POST['type'] ) ) { |
| [511](#L511) | $type = $\_POST['type']; |
| [512](#L512) | $this->optimization\_type = $type; |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | $this->id = $image\_id; |
| [516](#L516) |  |
| [517](#L517) | if ( wp\_attachment\_is\_image( $image\_id ) ) { |
| [518](#L518) |  |
| [519](#L519) | $settings = $this->kraken\_settings; |
| [520](#L520) |  |
| [521](#L521) | $image\_path = get\_attached\_file( $image\_id ); |
| [522](#L522) | $optimize\_main\_image = !empty( $settings['optimize\_main\_image'] ); |
| [523](#L523) | $api\_key = isset( $settings['api\_key'] ) ? $settings['api\_key'] : ''; |
| [524](#L524) | $api\_secret = isset( $settings['api\_secret'] ) ? $settings['api\_secret'] : ''; |
| [525](#L525) |  |
| [526](#L526) | $data = array(); |
| [527](#L527) |  |
| [528](#L528) | if ( empty( $api\_key ) && empty( $api\_secret ) ) { |
| [529](#L529) | $data['error'] = 'There is a problem with your credentials. Please check them in the Kraken.io settings section of Media Settings, and try again.'; |
| [530](#L530) | update\_post\_meta( $image\_id, '\_kraken\_size', $data ); |
| [531](#L531) | echo json\_encode( array( 'error' => $data['error'] ) ); |
| [532](#L532) | exit; |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | if ( $optimize\_main\_image ) { |
| [536](#L536) |  |
| [537](#L537) | // check if thumbs already optimized |
| [538](#L538) | $thumbs\_optimized = false; |
| [539](#L539) | $kraked\_thumbs\_data = get\_post\_meta( $image\_id, '\_kraked\_thumbs', true ); |
| [540](#L540) |  |
| [541](#L541) | if ( !empty ( $kraked\_thumbs\_data ) ) { |
| [542](#L542) | $thumbs\_optimized = true; |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | // get metadata for thumbnails |
| [546](#L546) | $image\_data = wp\_get\_attachment\_metadata( $image\_id ); |
| [547](#L547) |  |
| [548](#L548) | if ( !$thumbs\_optimized ) { |
| [549](#L549) | $this->optimize\_thumbnails( $image\_data ); |
| [550](#L550) | } else { |
| [551](#L551) |  |
| [552](#L552) | // re-optimize thumbs if mode has changed |
| [553](#L553) | $kraked\_thumbs\_mode = $kraked\_thumbs\_data[0]['type']; |
| [554](#L554) | if ( strcmp( $kraked\_thumbs\_mode, $this->optimization\_type ) !== 0 ) { |
| [555](#L555) | wp\_generate\_attachment\_metadata( $image\_id, $image\_path ); |
| [556](#L556) | $this->optimize\_thumbnails( $image\_data ); |
| [557](#L557) | } |
| [558](#L558) | } |
| [559](#L559) |  |
| [560](#L560) | $resize = false; |
| [561](#L561) | if ( !empty( $settings['resize\_width'] ) || !empty( $settings['resize\_height'] ) ) { |
| [562](#L562) | $resize = true; |
| [563](#L563) | } |
| [564](#L564) |  |
| [565](#L565) | $api\_result = $this->optimize\_image( $image\_path, $type, $resize ); |
| [566](#L566) |  |
| [567](#L567) | if ( !empty( $api\_result ) && !empty( $api\_result['success'] ) ) { |
| [568](#L568) | $data = $this->get\_result\_arr( $api\_result, $image\_id ); |
| [569](#L569) | if ( $this->replace\_image( $image\_path, $api\_result['kraked\_url'] ) ) { |
| [570](#L570) |  |
| [571](#L571) | if ( !empty( $data['kraked\_width'] ) && !empty( $data['kraked\_height'] ) ) { |
| [572](#L572) | $image\_data = wp\_get\_attachment\_metadata( $image\_id ); |
| [573](#L573) | $image\_data['width'] = $data['kraked\_width']; |
| [574](#L574) | $image\_data['height'] = $data['kraked\_height']; |
| [575](#L575) | wp\_update\_attachment\_metadata( $image\_id, $image\_data ); |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | // store kraked info to DB |
| [579](#L579) | update\_post\_meta( $image\_id, '\_kraken\_size', $data ); |
| [580](#L580) |  |
| [581](#L581) | // krak thumbnails, store that data too. This can be unset when there are no thumbs |
| [582](#L582) | $kraked\_thumbs\_data = get\_post\_meta( $image\_id, '\_kraked\_thumbs', true ); |
| [583](#L583) | if ( !empty( $kraked\_thumbs\_data ) ) { |
| [584](#L584) | $data['thumbs\_data'] = $kraked\_thumbs\_data; |
| [585](#L585) | $data['success'] = true; |
| [586](#L586) | } |
| [587](#L587) |  |
| [588](#L588) | $data['html'] = $this->generate\_stats\_summary( $image\_id ); |
| [589](#L589) | echo json\_encode( $data ); |
| [590](#L590) |  |
| [591](#L591) | } else { |
| [592](#L592) | echo json\_encode( array( 'error' => 'Could not overwrite original file. Please ensure that your files are writable by plugins.' ) ); |
| [593](#L593) | exit; |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | } else { |
| [597](#L597) | // error or no optimization |
| [598](#L598) | if ( file\_exists( $image\_path ) ) { |
| [599](#L599) | update\_post\_meta( $image\_id, '\_kraken\_size', $data ); |
| [600](#L600) | } else { |
| [601](#L601) | // file not found |
| [602](#L602) | } |
| [603](#L603) | echo json\_encode( array( 'error' => $api\_result['message'], '' ) ); |
| [604](#L604) | } |
| [605](#L605) | } else { |
| [606](#L606) | // get metadata for thumbnails |
| [607](#L607) | $image\_data = wp\_get\_attachment\_metadata( $image\_id ); |
| [608](#L608) | $this->optimize\_thumbnails( $image\_data ); |
| [609](#L609) |  |
| [610](#L610) | // krak thumbnails, store that data too. This can be unset when there are no thumbs |
| [611](#L611) | $kraked\_thumbs\_data = get\_post\_meta( $image\_id, '\_kraked\_thumbs', true ); |
| [612](#L612) |  |
| [613](#L613) | if ( !empty( $kraked\_thumbs\_data ) ) { |
| [614](#L614) | $data['thumbs\_data'] = $kraked\_thumbs\_data; |
| [615](#L615) | $data['success'] = true; |
| [616](#L616) | } |
| [617](#L617) | $data['html'] = $this->generate\_stats\_summary( $image\_id ); |
| [618](#L618) |  |
| [619](#L619) | echo json\_encode( $data ); |
| [620](#L620) | } |
| [621](#L621) | } |
| [622](#L622) | wp\_die(); |
| [623](#L623) | } |
| [624](#L624) |  |
| [625](#L625) |  |
| [626](#L626) | function is\_successful( $response ) {} |
| [627](#L627) |  |
| [628](#L628) | /\*\* |
| [629](#L629) | \*  Handles optimizing images uploaded through any of the media uploaders. |
| [630](#L630) | \*/ |
| [631](#L631) | function kraken\_media\_uploader\_callback( $image\_id ) { |
| [632](#L632) |  |
| [633](#L633) | $this->id = $image\_id; |
| [634](#L634) |  |
| [635](#L635) | if ( empty( $this->kraken\_settings['optimize\_main\_image'] ) ) { |
| [636](#L636) | return; |
| [637](#L637) | } |
| [638](#L638) |  |
| [639](#L639) | $settings = $this->kraken\_settings; |
| [640](#L640) | $type = $settings['api\_lossy']; |
| [641](#L641) |  |
| [642](#L642) | if ( !$this->isApiActive() ) { |
| [643](#L643) | remove\_filter( 'wp\_generate\_attachment\_metadata', array( &$this, 'optimize\_thumbnails') ); |
| [644](#L644) | remove\_action( 'add\_attachment', array( &$this, 'kraken\_media\_uploader\_callback' ) ); |
| [645](#L645) | return; |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | if ( wp\_attachment\_is\_image( $image\_id ) ) { |
| [649](#L649) |  |
| [650](#L650) | $image\_path = get\_attached\_file( $image\_id ); |
| [651](#L651) | $image\_backup\_path = $image\_path . '\_kraken\_' . md5( $image\_path ); |
| [652](#L652) | $backup\_created = false; |
| [653](#L653) |  |
| [654](#L654) | if ( copy( $image\_path, $image\_backup\_path ) ) { |
| [655](#L655) | $backup\_created = true; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | $resize = false; |
| [659](#L659) | if ( !empty( $settings['resize\_width'] ) || !empty( $settings['resize\_height'] ) ) { |
| [660](#L660) | $resize = true; |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | // optimize backup image |
| [664](#L664) | if ( $backup\_created ) { |
| [665](#L665) | $api\_result = $this->optimize\_image( $image\_backup\_path, $type, $resize ); |
| [666](#L666) | } else { |
| [667](#L667) | $api\_result = $this->optimize\_image( $image\_path, $type, $resize ); |
| [668](#L668) | } |
| [669](#L669) |  |
| [670](#L670) | $data = array(); |
| [671](#L671) |  |
| [672](#L672) | if ( !empty( $api\_result ) && !empty( $api\_result['success'] ) ) { |
| [673](#L673) | $data = $this->get\_result\_arr( $api\_result, $image\_id ); |
| [674](#L674) |  |
| [675](#L675) | if ( $backup\_created ) { |
| [676](#L676) | $data['optimized\_backup\_file'] = $image\_backup\_path; |
| [677](#L677) | if ( $data['saved\_bytes'] > 0 ) { |
| [678](#L678) | if ( $this->replace\_image( $image\_backup\_path, $api\_result['kraked\_url'] ) ) { |
| [679](#L679) | } else { |
| [680](#L680) | error\_log('Kraken.io: Could not replace local image with optimized image.'); |
| [681](#L681) | } |
| [682](#L682) | } |
| [683](#L683) | } else { |
| [684](#L684) | if ( $data['saved\_bytes'] > 0 ) { |
| [685](#L685) | if ( $this->replace\_image( $image\_path, $api\_result['kraked\_url'] ) ) { |
| [686](#L686) | } else { |
| [687](#L687) | error\_log('Kraken.io: Could not replace local image with optimized image.'); |
| [688](#L688) | } |
| [689](#L689) | } |
| [690](#L690) | } |
| [691](#L691) | update\_post\_meta( $image\_id, '\_kraken\_size', $data ); |
| [692](#L692) |  |
| [693](#L693) | } else { |
| [694](#L694) | // error or no optimization |
| [695](#L695) | if ( file\_exists( $image\_path ) ) { |
| [696](#L696) |  |
| [697](#L697) | $data['original\_size'] = filesize( $image\_path ); |
| [698](#L698) | $data['error'] = $api\_result['message']; |
| [699](#L699) | $data['type'] = $api\_result['type']; |
| [700](#L700) | update\_post\_meta( $image\_id, '\_kraken\_size', $data ); |
| [701](#L701) |  |
| [702](#L702) | } else { |
| [703](#L703) | // file not found |
| [704](#L704) | } |
| [705](#L705) | } |
| [706](#L706) | } |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | function kraken\_media\_library\_reset() { |
| [710](#L710) | $image\_id = (int) $\_POST['id']; |
| [711](#L711) | $image\_meta = get\_post\_meta( $image\_id, '\_kraken\_size', true ); |
| [712](#L712) | $original\_size = self::formatBytes( filesize( get\_attached\_file( $image\_id ) ) ); |
| [713](#L713) | delete\_post\_meta( $image\_id, '\_kraken\_size' ); |
| [714](#L714) | delete\_post\_meta( $image\_id, '\_kraked\_thumbs' ); |
| [715](#L715) | echo json\_encode( array( 'success' => true, 'original\_size' => $original\_size, 'html' => $this->optimize\_button\_html( $image\_id ) ) ); |
| [716](#L716) | wp\_die(); |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | function kraken\_media\_library\_reset\_all() { |
| [720](#L720) | $result = null; |
| [721](#L721) | delete\_post\_meta\_by\_key( '\_kraked\_thumbs' ); |
| [722](#L722) | delete\_post\_meta\_by\_key( '\_kraken\_size' ); |
| [723](#L723) | $result = json\_encode( array( 'success' => true ) ); |
| [724](#L724) | echo $result; |
| [725](#L725) | wp\_die(); |
| [726](#L726) | } |
| [727](#L727) |  |
| [728](#L728) |  |
| [729](#L729) | function optimize\_button\_html( $id )  { |
| [730](#L730) | $image\_url = wp\_get\_attachment\_url( $id ); |
| [731](#L731) | $filename = basename( $image\_url ); |
| [732](#L732) |  |
| [733](#L733) | $html = <<<EOD |
| [734](#L734) | <div class="buttonWrap"> |
| [735](#L735) | <button type="button" |
| [736](#L736) | data-setting="$this->optimization\_type" |
| [737](#L737) | class="kraken\_req" |
| [738](#L738) | data-id="$id" |
| [739](#L739) | id="krakenid-$id" |
| [740](#L740) | data-filename="$filename" |
| [741](#L741) | data-url="<$image\_url"> |
| [742](#L742) | Optimize This Image |
| [743](#L743) | </button> |
| [744](#L744) | <small class="krakenOptimizationType" style="display:none">$this->optimization\_type</small> |
| [745](#L745) | <span class="krakenSpinner"></span> |
| [746](#L746) | </div> |
| [747](#L747) | EOD; |
| [748](#L748) |  |
| [749](#L749) | return $html; |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) |  |
| [753](#L753) | function show\_credentials\_validity() { |
| [754](#L754) |  |
| [755](#L755) | $settings = $this->kraken\_settings; |
| [756](#L756) | $api\_key = isset( $settings['api\_key'] ) ? $settings['api\_key'] : ''; |
| [757](#L757) | $api\_secret = isset( $settings['api\_secret'] ) ? $settings['api\_secret'] : ''; |
| [758](#L758) |  |
| [759](#L759) | $status = $this->get\_api\_status( $api\_key, $api\_secret ); |
| [760](#L760) | $url = admin\_url() . 'images/'; |
| [761](#L761) |  |
| [762](#L762) | if ( $status !== false && isset( $status['active'] ) && $status['active'] === true ) { |
| [763](#L763) | $url .= 'yes.png'; |
| [764](#L764) | echo '<p class="apiStatus">Your credentials are valid <span class="apiValid" style="background:url(' . "'$url') no-repeat 0 0" . '"></span></p>'; |
| [765](#L765) | } else { |
| [766](#L766) | $url .= 'no.png'; |
| [767](#L767) | echo '<p class="apiStatus">There is a problem with your credentials <span class="apiInvalid" style="background:url(' . "'$url') no-repeat 0 0" . '"></span></p>'; |
| [768](#L768) | } |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | function show\_kraken\_image\_optimizer() { |
| [772](#L772) | echo '<a href="http://kraken.io" title="Visit Kraken.io Homepage">Kraken.io</a> API settings'; |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | function show\_api\_key() { |
| [776](#L776) | $settings = $this->kraken\_settings; |
| [777](#L777) | $value = isset( $settings['api\_key'] ) ? $settings['api\_key'] : ''; |
| [778](#L778) | ?> |
| [779](#L779) | <input id='kraken\_api\_key' name='\_kraken\_options[api\_key]' |
| [780](#L780) | type='text' value='<?php echo esc\_attr( $value ); ?>' size="50"/> |
| [781](#L781) | <?php |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) | function show\_api\_secret() { |
| [785](#L785) | $settings = $this->kraken\_settings; |
| [786](#L786) | $value = isset( $settings['api\_secret'] ) ? $settings['api\_secret'] : ''; |
| [787](#L787) | ?> |
| [788](#L788) | <input id='kraken\_api\_secret' name='\_kraken\_options[api\_secret]' |
| [789](#L789) | type='text' value='<?php echo esc\_attr( $value ); ?>' size="50"/> |
| [790](#L790) | <?php |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | function show\_lossy() { |
| [794](#L794) | $options = get\_option( '\_kraken\_options' ); |
| [795](#L795) | $value = isset( $options['api\_lossy'] ) ? $options['api\_lossy'] : 'lossy'; |
| [796](#L796) |  |
| [797](#L797) | $html = '<input type="radio" id="kraken\_lossy" name="\_kraken\_options[api\_lossy]" value="lossy"' . checked( 'lossy', $value, false ) . '/>'; |
| [798](#L798) | $html .= '<label for="kraken\_lossy">Lossy</label>'; |
| [799](#L799) |  |
| [800](#L800) | $html .= '<input style="margin-left:10px;" type="radio" id="kraken\_lossless" name="\_kraken\_options[api\_lossy]" value="lossless"' . checked( 'lossless', $value, false ) . '/>'; |
| [801](#L801) | $html .= '<label for="kraken\_lossless">Lossless</label>'; |
| [802](#L802) |  |
| [803](#L803) | echo $html; |
| [804](#L804) | } |
| [805](#L805) |  |
| [806](#L806) | function show\_auto\_optimize() { |
| [807](#L807) | $options = get\_option( '\_kraken\_options' ); |
| [808](#L808) | $auto\_optimize = isset( $options['auto\_optimize'] ) ? $options['auto\_optimize'] : 1; |
| [809](#L809) | ?> |
| [810](#L810) | <input type="checkbox" id="auto\_optimize" name="\_kraken\_options[auto\_optimize]" value="1" <?php checked( 1, $auto\_optimize, true ); ?>/> |
| [811](#L811) | <?php |
| [812](#L812) | } |
| [813](#L813) |  |
| [814](#L814) | function show\_reset\_field() { |
| [815](#L815) | $options = get\_option( '\_kraken\_options' ); |
| [816](#L816) | $show\_reset = isset( $options['show\_reset'] ) ? $options['show\_reset'] : 0; |
| [817](#L817) | ?> |
| [818](#L818) | <input type="checkbox" id="show\_reset" name="\_kraken\_options[show\_reset]" value="1" <?php checked( 1, $show\_reset, true ); ?>/> |
| [819](#L819) | <span class="kraken-reset-all enabled">Reset All Images</span> |
| [820](#L820) | <?php |
| [821](#L821) | } |
| [822](#L822) |  |
| [823](#L823) | function show\_bulk\_async\_limit() { |
| [824](#L824) | $options = get\_option( '\_kraken\_options' ); |
| [825](#L825) | $bulk\_limit = isset( $options['bulk\_async\_limit'] ) ? $options['bulk\_async\_limit'] : 4; |
| [826](#L826) | ?> |
| [827](#L827) | <select name="\_kraken\_options[bulk\_async\_limit]"> |
| [828](#L828) | <?php foreach ( range(1, 10) as $number ) { ?> |
| [829](#L829) | <option value="<?php echo $number ?>" <?php selected( $bulk\_limit, $number, true); ?>> |
| [830](#L830) | <?php echo $number ?> |
| [831](#L831) | </option> |
| [832](#L832) | <?php } ?> |
| [833](#L833) | </select> |
| [834](#L834) | <?php |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) | function add\_media\_columns( $columns ) { |
| [838](#L838) | $columns['original\_size'] = 'Original Size'; |
| [839](#L839) | $columns['kraked\_size'] = 'Kraken.io Stats'; |
| [840](#L840) | return $columns; |
| [841](#L841) | } |
| [842](#L842) |  |
| [843](#L843) |  |
| [844](#L844) | static function KBStringToBytes( $str ) { |
| [845](#L845) | $temp = floatVal( $str ); |
| [846](#L846) | $rv = false; |
| [847](#L847) | if ( 0 == $temp ) { |
| [848](#L848) | $rv = '0 bytes'; |
| [849](#L849) | } else { |
| [850](#L850) | $rv = self::formatBytes( ceil( floatval( $str) \* 1024 ) ); |
| [851](#L851) | } |
| [852](#L852) | return $rv; |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) |  |
| [856](#L856) | static function calculate\_savings( $meta ) { |
| [857](#L857) |  |
| [858](#L858) | if ( isset( $meta['original\_size'] ) ) { |
| [859](#L859) |  |
| [860](#L860) | $saved\_bytes = isset( $meta['saved\_bytes'] ) ? $meta['saved\_bytes'] : ''; |
| [861](#L861) | $savings\_percentage = $meta['savings\_percent']; |
| [862](#L862) |  |
| [863](#L863) | // convert old data format, where applicable |
| [864](#L864) | if ( stripos( $saved\_bytes, 'kb' ) !== false ) { |
| [865](#L865) | $saved\_bytes = self::KBStringToBytes( $saved\_bytes ); |
| [866](#L866) | } else { |
| [867](#L867) | if ( !$saved\_bytes ) { |
| [868](#L868) | $saved\_bytes = '0 bytes'; |
| [869](#L869) | } else { |
| [870](#L870) | $saved\_bytes = self::formatBytes( $saved\_bytes ); |
| [871](#L871) | } |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | return array( |
| [875](#L875) | 'saved\_bytes' => $saved\_bytes, |
| [876](#L876) | 'savings\_percentage' => $savings\_percentage |
| [877](#L877) | ); |
| [878](#L878) |  |
| [879](#L879) | } else if ( !empty( $meta ) ) { |
| [880](#L880) | $thumbs\_count = count( $meta ); |
| [881](#L881) | $total\_thumb\_byte\_savings = 0; |
| [882](#L882) | $total\_thumb\_size = 0; |
| [883](#L883) | $thumbs\_savings\_percentage = ''; |
| [884](#L884) | $total\_thumbs\_savings = ''; |
| [885](#L885) |  |
| [886](#L886) | foreach ( $meta as $k => $v ) { |
| [887](#L887) | $total\_thumb\_size += $v['original\_size']; |
| [888](#L888) | $thumb\_byte\_savings = $v['original\_size'] - $v['kraked\_size']; |
| [889](#L889) | $total\_thumb\_byte\_savings += $thumb\_byte\_savings; |
| [890](#L890) | } |
| [891](#L891) |  |
| [892](#L892) | $thumbs\_savings\_percentage = round( ( $total\_thumb\_byte\_savings / $total\_thumb\_size \* 100 ), 2 ) . '%'; |
| [893](#L893) | if ( $total\_thumb\_byte\_savings ) { |
| [894](#L894) | $total\_thumbs\_savings = self::formatBytes( $total\_thumb\_byte\_savings ); |
| [895](#L895) | } else { |
| [896](#L896) | $total\_thumbs\_savings = '0 bytes'; |
| [897](#L897) | } |
| [898](#L898) | return array( |
| [899](#L899) | 'savings\_percentage' => $thumbs\_savings\_percentage, |
| [900](#L900) | 'total\_savings' => $total\_thumbs\_savings |
| [901](#L901) | ); |
| [902](#L902) | } |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | function generate\_stats\_summary( $id ) { |
| [906](#L906) | $image\_meta = get\_post\_meta( $id, '\_kraken\_size', true ); |
| [907](#L907) | $thumbs\_meta = get\_post\_meta( $id, '\_kraked\_thumbs', true ); |
| [908](#L908) |  |
| [909](#L909) | $total\_original\_size = 0; |
| [910](#L910) | $total\_kraked\_size = 0; |
| [911](#L911) | $total\_saved\_bytes = 0; |
| [912](#L912) |  |
| [913](#L913) | $total\_savings\_percentage = 0; |
| [914](#L914) |  |
| [915](#L915) | // crap for backward compat |
| [916](#L916) | if ( isset( $image\_meta['original\_size'] ) ) { |
| [917](#L917) |  |
| [918](#L918) | $original\_size = $image\_meta['original\_size']; |
| [919](#L919) |  |
| [920](#L920) | if ( stripos( $original\_size, 'kb' ) !== false ) { |
| [921](#L921) | $total\_original\_size = ceil( floatval( $original\_size ) \* 1024 ); |
| [922](#L922) | } else { |
| [923](#L923) | $total\_original\_size = (int) $original\_size; |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | if ( isset( $image\_meta['saved\_bytes'] ) ) { |
| [927](#L927) | $saved\_bytes = $image\_meta['saved\_bytes']; |
| [928](#L928) | if ( is\_string( $saved\_bytes ) ) { |
| [929](#L929) | $total\_saved\_bytes = (int) ceil( floatval( $saved\_bytes ) \* 1024 ); |
| [930](#L930) | } else { |
| [931](#L931) | $total\_saved\_bytes = $saved\_bytes; |
| [932](#L932) | } |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | $total\_kraked\_size = $total\_original\_size - $total\_saved\_bytes; |
| [936](#L936) | } |
| [937](#L937) |  |
| [938](#L938) | if ( !empty( $thumbs\_meta ) ) { |
| [939](#L939) | $thumb\_saved\_bytes = 0; |
| [940](#L940) | $total\_thumb\_byte\_savings = 0; |
| [941](#L941) | $total\_thumb\_size = 0; |
| [942](#L942) |  |
| [943](#L943) | foreach ( $thumbs\_meta as $k => $v ) { |
| [944](#L944) | $total\_original\_size += $v['original\_size']; |
| [945](#L945) | $thumb\_saved\_bytes = $v['original\_size'] - $v['kraked\_size']; |
| [946](#L946) | $total\_saved\_bytes += $thumb\_saved\_bytes; |
| [947](#L947) | } |
| [948](#L948) |  |
| [949](#L949) | } |
| [950](#L950) | $total\_savings\_percentage = round( ( $total\_saved\_bytes / $total\_original\_size \* 100 ), 2 ) . '%'; |
| [951](#L951) | $summary\_string = ''; |
| [952](#L952) | if ( !$total\_saved\_bytes ) { |
| [953](#L953) | $summary\_string = 'No savings'; |
| [954](#L954) | } else { |
| [955](#L955) | $total\_savings = self::formatBytes( $total\_saved\_bytes ); |
| [956](#L956) | $detailed\_results\_html = $this->results\_html( $id ); |
| [957](#L957) | $summary\_string = '<div class="kraken-result-wrap">' . "Saved $total\_savings\_percentage ($total\_savings)"; |
| [958](#L958) | $summary\_string .= '<br /><small class="kraken-item-details" data-id="' . $id . '" original-title="' . htmlspecialchars($detailed\_results\_html) .'">Show details</small></div>'; |
| [959](#L959) | } |
| [960](#L960) | return $summary\_string; |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | function results\_html( $id ) { |
| [964](#L964) |  |
| [965](#L965) | $settings = $this->kraken\_settings; |
| [966](#L966) | $optimize\_main\_image = !empty( $settings['optimize\_main\_image'] ); |
| [967](#L967) |  |
| [968](#L968) | // get meta data for main post and thumbs |
| [969](#L969) | $image\_meta = get\_post\_meta( $id, '\_kraken\_size', true ); |
| [970](#L970) | $thumbs\_meta = get\_post\_meta( $id, '\_kraked\_thumbs', true ); |
| [971](#L971) | $main\_image\_optimized = !empty( $image\_meta ) && isset( $image\_meta['type'] ); |
| [972](#L972) | $thumbs\_optimized = !empty( $thumbs\_meta ) && count( $thumbs\_meta ) && isset( $thumbs\_meta[0]['type'] ); |
| [973](#L973) |  |
| [974](#L974) | $type = ''; |
| [975](#L975) | $kraked\_size = ''; |
| [976](#L976) | $savings\_percentage = ''; |
| [977](#L977) |  |
| [978](#L978) | if ( $main\_image\_optimized ) { |
| [979](#L979) | $type = $image\_meta['type']; |
| [980](#L980) | $kraked\_size = isset( $image\_meta['kraked\_size'] ) ? $image\_meta['kraked\_size'] : ''; |
| [981](#L981) | $savings\_percentage = $image\_meta['savings\_percent']; |
| [982](#L982) | $main\_image\_kraked\_stats = self::calculate\_savings( $image\_meta ); |
| [983](#L983) | } |
| [984](#L984) |  |
| [985](#L985) | if ( $thumbs\_optimized ) { |
| [986](#L986) | $type = $thumbs\_meta[0]['type']; |
| [987](#L987) | $thumbs\_kraked\_stats = self::calculate\_savings( $thumbs\_meta ); |
| [988](#L988) | $thumbs\_count = count( $thumbs\_meta ); |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | ob\_start(); |
| [992](#L992) | ?> |
| [993](#L993) | <?php if ( $main\_image\_optimized ) { ?> |
| [994](#L994) | <div class="kraken\_detailed\_results\_wrap"> |
| [995](#L995) | <span class=""><strong>Main image savings:</strong></span> |
| [996](#L996) | <br /> |
| [997](#L997) | <span style="display:inline-block;margin-bottom:5px"><?php echo $main\_image\_kraked\_stats['saved\_bytes']; ?> (<?php echo $main\_image\_kraked\_stats['savings\_percentage']; ?> saved)</span> |
| [998](#L998) | <?php } ?> |
| [999](#L999) | <?php if ( $main\_image\_optimized && $thumbs\_optimized ) { ?> |
| [1000](#L1000) | <br /> |
| [1001](#L1001) | <?php } ?> |
| [1002](#L1002) | <?php if ( $thumbs\_optimized ) { ?> |
| [1003](#L1003) | <span><strong>Savings on <?php echo $thumbs\_count; ?> thumbnails:</strong></span> |
| [1004](#L1004) | <br /> |
| [1005](#L1005) | <span style="display:inline-block;margin-bottom:5px"><?php echo $thumbs\_kraked\_stats['total\_savings']; ?> (<?php echo $thumbs\_kraked\_stats['savings\_percentage']; ?> saved)</span> |
| [1006](#L1006) | <?php } ?> |
| [1007](#L1007) | <br /> |
| [1008](#L1008) | <span><strong>Optimization mode:</strong></span> |
| [1009](#L1009) | <br /> |
| [1010](#L1010) | <span><?php echo ucfirst($type); ?></span> |
| [1011](#L1011) | <?php if ( !empty( $this->kraken\_settings['show\_reset'] ) ) { ?> |
| [1012](#L1012) | <br /> |
| [1013](#L1013) | <small |
| [1014](#L1014) | class="krakenReset" data-id="<?php echo $id; ?>" |
| [1015](#L1015) | title="Removes Kraken metadata associated with this image"> |
| [1016](#L1016) | Reset |
| [1017](#L1017) | </small> |
| [1018](#L1018) | <span class="krakenSpinner"></span> |
| [1019](#L1019) | </div> |
| [1020](#L1020) | <?php } ?> |
| [1021](#L1021) | <?php |
| [1022](#L1022) | $html = ob\_get\_clean(); |
| [1023](#L1023) | return $html; |
| [1024](#L1024) | } |
| [1025](#L1025) |  |
| [1026](#L1026) | function fill\_media\_columns( $column\_name, $id ) { |
| [1027](#L1027) |  |
| [1028](#L1028) | $settings = $this->kraken\_settings; |
| [1029](#L1029) | $optimize\_main\_image = !empty( $settings['optimize\_main\_image'] ); |
| [1030](#L1030) |  |
| [1031](#L1031) | $file = get\_attached\_file( $id ); |
| [1032](#L1032) | $original\_size = filesize( $file ); |
| [1033](#L1033) |  |
| [1034](#L1034) | // handle the case where file does not exist |
| [1035](#L1035) | if ( $original\_size === 0 || $original\_size === false ) { |
| [1036](#L1036) | echo '0 bytes'; |
| [1037](#L1037) | return; |
| [1038](#L1038) | } else { |
| [1039](#L1039) | $original\_size = self::formatBytes( $original\_size ); |
| [1040](#L1040) | } |
| [1041](#L1041) |  |
| [1042](#L1042) | $type = isset( $settings['api\_lossy'] ) ? $settings['api\_lossy'] : 'lossy'; |
| [1043](#L1043) |  |
| [1044](#L1044) | if ( strcmp( $column\_name, 'original\_size' ) === 0 ) { |
| [1045](#L1045) | if ( wp\_attachment\_is\_image( $id ) ) { |
| [1046](#L1046) |  |
| [1047](#L1047) | $meta = get\_post\_meta( $id, '\_kraken\_size', true ); |
| [1048](#L1048) |  |
| [1049](#L1049) | if ( isset( $meta['original\_size'] ) ) { |
| [1050](#L1050) |  |
| [1051](#L1051) | if ( stripos( $meta['original\_size'], 'kb' ) !== false ) { |
| [1052](#L1052) | echo self::formatBytes( ceil( floatval( $meta['original\_size']) \* 1024 ) ); |
| [1053](#L1053) | } else { |
| [1054](#L1054) | echo self::formatBytes( $meta['original\_size'] ); |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | } else { |
| [1058](#L1058) | echo $original\_size; |
| [1059](#L1059) | } |
| [1060](#L1060) | } else { |
| [1061](#L1061) | echo $original\_size; |
| [1062](#L1062) | } |
| [1063](#L1063) | } else if ( strcmp( $column\_name, 'kraked\_size' ) === 0 ) { |
| [1064](#L1064) | echo '<div class="kraken-wrap">'; |
| [1065](#L1065) | $image\_url = wp\_get\_attachment\_url( $id ); |
| [1066](#L1066) | $filename = basename( $image\_url ); |
| [1067](#L1067) | if ( wp\_attachment\_is\_image( $id ) ) { |
| [1068](#L1068) |  |
| [1069](#L1069) | $meta = get\_post\_meta( $id, '\_kraken\_size', true ); |
| [1070](#L1070) | $thumbs\_meta = get\_post\_meta( $id, '\_kraked\_thumbs', true ); |
| [1071](#L1071) |  |
| [1072](#L1072) | // Is it optimized? Show some stats |
| [1073](#L1073) | if ( ( isset( $meta['kraked\_size'] ) && empty( $meta['no\_savings'] ) ) || !empty( $thumbs\_meta ) ) { |
| [1074](#L1074) | if ( !isset( $meta['kraked\_size'] ) && $optimize\_main\_image ) { |
| [1075](#L1075) | echo '<div class="buttonWrap"><button data-setting="' . $type . '" type="button" class="kraken\_req" data-id="' . $id . '" id="krakenid-' . $id .'" data-filename="' . $filename . '" data-url="' . $image\_url . '">Optimize Main Image</button><span class="krakenSpinner"></span></div>'; |
| [1076](#L1076) | } |
| [1077](#L1077) | echo $this->generate\_stats\_summary( $id ); |
| [1078](#L1078) |  |
| [1079](#L1079) | // Were there no savings, or was there an error? |
| [1080](#L1080) | } else { |
| [1081](#L1081) | echo '<div class="buttonWrap"><button data-setting="' . $type . '" type="button" class="kraken\_req" data-id="' . $id . '" id="krakenid-' . $id .'" data-filename="' . $filename . '" data-url="' . $image\_url . '">Optimize This Image</button><span class="krakenSpinner"></span></div>'; |
| [1082](#L1082) | if ( !empty( $meta['no\_savings'] ) ) { |
| [1083](#L1083) | echo '<div class="noSavings"><strong>No savings found</strong><br /><small>Type:&nbsp;' . $meta['type'] . '</small></div>'; |
| [1084](#L1084) | } else if ( isset( $meta['error'] ) ) { |
| [1085](#L1085) | $error = $meta['error']; |
| [1086](#L1086) | echo '<div class="krakenErrorWrap"><a class="krakenError" title="' . $error . '">Failed! Hover here</a></div>'; |
| [1087](#L1087) | } |
| [1088](#L1088) | } |
| [1089](#L1089) | } else { |
| [1090](#L1090) | echo 'n/a'; |
| [1091](#L1091) | } |
| [1092](#L1092) | echo '</div>'; |
| [1093](#L1093) | } |
| [1094](#L1094) | } |
| [1095](#L1095) |  |
| [1096](#L1096) | function replace\_image( $image\_path, $kraked\_url ) { |
| [1097](#L1097) | $rv = false; |
| [1098](#L1098) | $ch =  curl\_init( $kraked\_url ); |
| [1099](#L1099) | curl\_setopt( $ch, CURLOPT\_RETURNTRANSFER, 1 ); |
| [1100](#L1100) | curl\_setopt( $ch, CURLOPT\_SSL\_VERIFYPEER, 0 ); |
| [1101](#L1101) | curl\_setopt( $ch, CURLOPT\_SSL\_VERIFYHOST, 0 ); |
| [1102](#L1102) | curl\_setopt( $ch, CURLOPT\_CONNECTTIMEOUT, 0 ); |
| [1103](#L1103) | curl\_setopt( $ch, CURLOPT\_TIMEOUT, 120 ); |
| [1104](#L1104) | curl\_setopt( $ch, CURLOPT\_USERAGENT, 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.85 Safari/537.36' ); |
| [1105](#L1105) | $result = curl\_exec( $ch ); |
| [1106](#L1106) |  |
| [1107](#L1107) | if ( $result ) { |
| [1108](#L1108) | $rv = file\_put\_contents( $image\_path, $result ); |
| [1109](#L1109) | } |
| [1110](#L1110) | return $rv !== false; |
| [1111](#L1111) | } |
| [1112](#L1112) |  |
| [1113](#L1113) | function optimize\_image( $image\_path, $type, $resize = false ) { |
| [1114](#L1114) | $settings = $this->kraken\_settings; |
| [1115](#L1115) | $kraken = new Kraken( $settings['api\_key'], $settings['api\_secret'] ); |
| [1116](#L1116) |  |
| [1117](#L1117) | if ( !empty( $type ) ) { |
| [1118](#L1118) | $lossy = $type === 'lossy'; |
| [1119](#L1119) | } else { |
| [1120](#L1120) | $lossy = $settings['api\_lossy'] === 'lossy'; |
| [1121](#L1121) | } |
| [1122](#L1122) |  |
| [1123](#L1123) | $params = array( |
| [1124](#L1124) | 'file' => $image\_path, |
| [1125](#L1125) | 'wait' => true, |
| [1126](#L1126) | 'lossy' => $lossy, |
| [1127](#L1127) | 'origin' => 'wp' |
| [1128](#L1128) | ); |
| [1129](#L1129) |  |
| [1130](#L1130) | $preserve\_meta\_arr = array(); |
| [1131](#L1131) | if ( $settings['preserve\_meta\_date'] ) { |
| [1132](#L1132) | $preserve\_meta\_arr[] = 'date'; |
| [1133](#L1133) | } |
| [1134](#L1134) | if ( $settings['preserve\_meta\_copyright'] ) { |
| [1135](#L1135) | $preserve\_meta\_arr[] = 'copyright'; |
| [1136](#L1136) | } |
| [1137](#L1137) | if ( $settings['preserve\_meta\_geotag'] ) { |
| [1138](#L1138) | $preserve\_meta\_arr[] = 'geotag'; |
| [1139](#L1139) | } |
| [1140](#L1140) | if ( $settings['preserve\_meta\_orientation'] ) { |
| [1141](#L1141) | $preserve\_meta\_arr[] = 'orientation'; |
| [1142](#L1142) | } |
| [1143](#L1143) | if ( $settings['preserve\_meta\_profile'] ) { |
| [1144](#L1144) | $preserve\_meta\_arr[] = 'profile'; |
| [1145](#L1145) | } |
| [1146](#L1146) | if ( $settings['chroma'] ) { |
| [1147](#L1147) | $params['sampling\_scheme'] = $settings['chroma']; |
| [1148](#L1148) | } |
| [1149](#L1149) |  |
| [1150](#L1150) | if ( count( $preserve\_meta\_arr ) ) { |
| [1151](#L1151) | $params['preserve\_meta'] = $preserve\_meta\_arr; |
| [1152](#L1152) | } |
| [1153](#L1153) |  |
| [1154](#L1154) | if ( $settings['auto\_orient'] ) { |
| [1155](#L1155) | $params['auto\_orient'] = true; |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | if ( $resize ) { |
| [1159](#L1159) | $width = (int) $settings['resize\_width']; |
| [1160](#L1160) | $height = (int) $settings['resize\_height']; |
| [1161](#L1161) | if ( $width && $height ) { |
| [1162](#L1162) | $params['resize'] = array('strategy' => 'auto', 'width' => $width, 'height' => $height ); |
| [1163](#L1163) | } elseif ( $width && !$height ) { |
| [1164](#L1164) | $params['resize'] = array('strategy' => 'landscape', 'width' => $width ); |
| [1165](#L1165) | } elseif ( $height && !$width ) { |
| [1166](#L1166) | $params['resize'] = array('strategy' => 'portrait', 'height' => $height ); |
| [1167](#L1167) | } |
| [1168](#L1168) | } |
| [1169](#L1169) |  |
| [1170](#L1170) | if ( isset( $settings['jpeg\_quality'] ) && $settings['jpeg\_quality'] > 0 ) { |
| [1171](#L1171) | $params['quality'] = (int) $settings['jpeg\_quality']; |
| [1172](#L1172) | } |
| [1173](#L1173) |  |
| [1174](#L1174) | set\_time\_limit(400); |
| [1175](#L1175) | $data = $kraken->upload( $params ); |
| [1176](#L1176) | $data['type'] = !empty( $type ) ? $type : $settings['api\_lossy']; |
| [1177](#L1177) | return $data; |
| [1178](#L1178) | } |
| [1179](#L1179) |  |
| [1180](#L1180) | function get\_sizes\_to\_krak() { |
| [1181](#L1181) | $settings = $this->kraken\_settings; |
| [1182](#L1182) | $rv = array(); |
| [1183](#L1183) |  |
| [1184](#L1184) | foreach( $settings as $key => $value ) { |
| [1185](#L1185) | if ( strpos( $key, 'include\_size' ) === 0 && !empty( $value ) ) { |
| [1186](#L1186) | $rv[] = $key; |
| [1187](#L1187) | } |
| [1188](#L1188) | } |
| [1189](#L1189) | return $rv; |
| [1190](#L1190) | } |
| [1191](#L1191) |  |
| [1192](#L1192) | function optimize\_thumbnails( $image\_data ) { |
| [1193](#L1193) |  |
| [1194](#L1194) | $image\_id = $this->id; |
| [1195](#L1195) | if ( empty( $image\_id ) ) { |
| [1196](#L1196) | global $wpdb; |
| [1197](#L1197) | $post = $wpdb->get\_row( $wpdb->prepare( "SELECT post\_id FROM $wpdb->postmeta WHERE meta\_value = %s LIMIT 1", $image\_data['file'] ) ); |
| [1198](#L1198) | $image\_id = $post->post\_id; |
| [1199](#L1199) | } |
| [1200](#L1200) |  |
| [1201](#L1201) | $kraken\_meta = get\_post\_meta( $image\_id, '\_kraken\_size', true ); |
| [1202](#L1202) | $image\_backup\_path = isset( $kraken\_meta['optimized\_backup\_file'] ) ? $kraken\_meta['optimized\_backup\_file'] : ''; |
| [1203](#L1203) |  |
| [1204](#L1204) | if ( $image\_backup\_path ) { |
| [1205](#L1205) | $original\_image\_path = get\_attached\_file( $image\_id ); |
| [1206](#L1206) | if ( copy( $image\_backup\_path, $original\_image\_path ) ) { |
| [1207](#L1207) | unlink( $image\_backup\_path ); |
| [1208](#L1208) | unset( $kraken\_meta['optimized\_backup\_file'] ); |
| [1209](#L1209) | update\_post\_meta( $image\_id, '\_kraken\_size', $kraken\_meta ); |
| [1210](#L1210) | } |
| [1211](#L1211) | } |
| [1212](#L1212) |  |
| [1213](#L1213) | if ( !$this->preg\_array\_key\_exists( '/^include\_size\_/', $this->kraken\_settings ) ) { |
| [1214](#L1214) |  |
| [1215](#L1215) | global $\_wp\_additional\_image\_sizes; |
| [1216](#L1216) | $sizes = array(); |
| [1217](#L1217) |  |
| [1218](#L1218) | foreach ( get\_intermediate\_image\_sizes() as $\_size ) { |
| [1219](#L1219) | if ( in\_array( $\_size, array('thumbnail', 'medium', 'medium\_large', 'large') ) ) { |
| [1220](#L1220) | $sizes[ $\_size ]['width']  = get\_option( "{$\_size}\_size\_w" ); |
| [1221](#L1221) | $sizes[ $\_size ]['height'] = get\_option( "{$\_size}\_size\_h" ); |
| [1222](#L1222) | $sizes[ $\_size ]['crop']   = (bool) get\_option( "{$\_size}\_crop" ); |
| [1223](#L1223) | } elseif ( isset( $\_wp\_additional\_image\_sizes[ $\_size ] ) ) { |
| [1224](#L1224) | $sizes[ $\_size ] = array( |
| [1225](#L1225) | 'width'  => $\_wp\_additional\_image\_sizes[ $\_size ]['width'], |
| [1226](#L1226) | 'height' => $\_wp\_additional\_image\_sizes[ $\_size ]['height'], |
| [1227](#L1227) | 'crop'   => $\_wp\_additional\_image\_sizes[ $\_size ]['crop'], |
| [1228](#L1228) | ); |
| [1229](#L1229) | } |
| [1230](#L1230) | } |
| [1231](#L1231) | $sizes = array\_keys( $sizes ); |
| [1232](#L1232) | foreach ($sizes as $size) { |
| [1233](#L1233) | $this->kraken\_settings['include\_size\_' . $size] = 1; |
| [1234](#L1234) | } |
| [1235](#L1235) | } |
| [1236](#L1236) |  |
| [1237](#L1237) | // when resizing has taken place via API, update the post metadata accordingly |
| [1238](#L1238) | if ( !empty( $kraken\_meta['kraked\_width'] ) && !empty( $kraken\_meta['kraked\_height'] ) ) { |
| [1239](#L1239) | $image\_data['width'] = $kraken\_meta['kraked\_width']; |
| [1240](#L1240) | $image\_data['height'] = $kraken\_meta['kraked\_height']; |
| [1241](#L1241) | } |
| [1242](#L1242) |  |
| [1243](#L1243) |  |
| [1244](#L1244) | $path\_parts = pathinfo( $image\_data['file'] ); |
| [1245](#L1245) |  |
| [1246](#L1246) | // e.g. 04/02, for use in getting correct path or URL |
| [1247](#L1247) | $upload\_subdir = $path\_parts['dirname']; |
| [1248](#L1248) |  |
| [1249](#L1249) | $upload\_dir = wp\_upload\_dir(); |
| [1250](#L1250) |  |
| [1251](#L1251) | // all the way up to /uploads |
| [1252](#L1252) | $upload\_base\_path = $upload\_dir['basedir']; |
| [1253](#L1253) | $upload\_full\_path = $upload\_base\_path . '/' . $upload\_subdir; |
| [1254](#L1254) |  |
| [1255](#L1255) | $sizes = array(); |
| [1256](#L1256) |  |
| [1257](#L1257) | if ( isset( $image\_data['sizes'] ) ) { |
| [1258](#L1258) | $sizes = $image\_data['sizes']; |
| [1259](#L1259) | } |
| [1260](#L1260) |  |
| [1261](#L1261) | if ( !empty( $sizes ) ) { |
| [1262](#L1262) |  |
| [1263](#L1263) | $sizes\_to\_krak = $this->get\_sizes\_to\_krak(); |
| [1264](#L1264) | $thumb\_path = ''; |
| [1265](#L1265) | $thumbs\_optimized\_store = array(); |
| [1266](#L1266) | $this\_thumb = array(); |
| [1267](#L1267) |  |
| [1268](#L1268) | foreach ( $sizes as $key => $size ) { |
| [1269](#L1269) |  |
| [1270](#L1270) | if ( !in\_array("include\_size\_$key", $sizes\_to\_krak) ) { |
| [1271](#L1271) | continue; |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | $thumb\_path = $upload\_full\_path . '/' . $size['file']; |
| [1275](#L1275) |  |
| [1276](#L1276) | if ( file\_exists( $thumb\_path ) !== false ) { |
| [1277](#L1277) | $result = $this->optimize\_image( $thumb\_path, $this->optimization\_type ); |
| [1278](#L1278) | if ( !empty( $result ) && isset( $result['success'] ) && isset( $result['kraked\_url'] ) ) { |
| [1279](#L1279) | $kraked\_url = $result['kraked\_url']; |
| [1280](#L1280) | if ( (int) $result['saved\_bytes'] !== 0 ) { |
| [1281](#L1281) | if ( $this->replace\_image( $thumb\_path, $kraked\_url ) ) { |
| [1282](#L1282) | $this\_thumb = array( 'thumb' => $key, 'file' => $size['file'], 'original\_size' => $result['original\_size'], 'kraked\_size' => $result['kraked\_size'], 'type' => $this->optimization\_type ); |
| [1283](#L1283) | $thumbs\_optimized\_store [] = $this\_thumb; |
| [1284](#L1284) | } |
| [1285](#L1285) | } else { |
| [1286](#L1286) | $this\_thumb = array( 'thumb' => $key, 'file' => $size['file'], 'original\_size' => $result['original\_size'], 'kraked\_size' => $result['original\_size'], 'type' => $this->optimization\_type ); |
| [1287](#L1287) | $thumbs\_optimized\_store [] = $this\_thumb; |
| [1288](#L1288) | } |
| [1289](#L1289) | } |
| [1290](#L1290) | } |
| [1291](#L1291) | } |
| [1292](#L1292) | } |
| [1293](#L1293) | if ( !empty( $thumbs\_optimized\_store ) ) { |
| [1294](#L1294) | update\_post\_meta( $image\_id, '\_kraked\_thumbs', $thumbs\_optimized\_store, false ); |
| [1295](#L1295) | } |
| [1296](#L1296) | return $image\_data; |
| [1297](#L1297) | } |
| [1298](#L1298) |  |
| [1299](#L1299) | function get\_image\_sizes() { |
| [1300](#L1300) | global $\_wp\_additional\_image\_sizes; |
| [1301](#L1301) |  |
| [1302](#L1302) | $sizes = array(); |
| [1303](#L1303) |  |
| [1304](#L1304) | foreach ( get\_intermediate\_image\_sizes() as $\_size ) { |
| [1305](#L1305) | if ( in\_array( $\_size, array('thumbnail', 'medium', 'medium\_large', 'large') ) ) { |
| [1306](#L1306) | $sizes[ $\_size ]['width']  = get\_option( "{$\_size}\_size\_w" ); |
| [1307](#L1307) | $sizes[ $\_size ]['height'] = get\_option( "{$\_size}\_size\_h" ); |
| [1308](#L1308) | $sizes[ $\_size ]['crop']   = (bool) get\_option( "{$\_size}\_crop" ); |
| [1309](#L1309) | } elseif ( isset( $\_wp\_additional\_image\_sizes[ $\_size ] ) ) { |
| [1310](#L1310) | $sizes[ $\_size ] = array( |
| [1311](#L1311) | 'width'  => $\_wp\_additional\_image\_sizes[ $\_size ]['width'], |
| [1312](#L1312) | 'height' => $\_wp\_additional\_image\_sizes[ $\_size ]['height'], |
| [1313](#L1313) | 'crop'   => $\_wp\_additional\_image\_sizes[ $\_size ]['crop'], |
| [1314](#L1314) | ); |
| [1315](#L1315) | } |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | return $sizes; |
| [1319](#L1319) | } |
| [1320](#L1320) |  |
| [1321](#L1321) |  |
| [1322](#L1322) | static function formatBytes( $size, $precision = 2 ) { |
| [1323](#L1323) | $base = log( $size, 1024 ); |
| [1324](#L1324) | $suffixes = array( ' bytes', 'KB', 'MB', 'GB', 'TB' ); |
| [1325](#L1325) | return round( pow( 1024, $base - floor( $base ) ), $precision ) . $suffixes[floor( $base )]; |
| [1326](#L1326) | } |
| [1327](#L1327) | } |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) | new Wp\_Kraken(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/kraken-image-optimizer/tags/2.6.6/kraken.php?format=txt)
* [Original Format](/export/3222465/kraken-image-optimizer/tags/2.6.6/kraken.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_3415205d_20250114_201629.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Kraken.io Image Optimizer <= 2.6.8 - Missing Authorization to Authenticated (Subscriber+) Plugin Options Update

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Kraken.io Image Optimizer <= 2.6.8 - Missing Authorization to Authenticated (Subscriber+) Plugin Options Update

6.5

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N)

| CVE | [CVE-2023-0619](https://www.cve.org/CVERecord?id=CVE-2023-0619) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | February 1, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The Kraken.io Image Optimizer plugin for WordPress is vulnerable to authorization bypass due to a missing capability check on its AJAX actions in versions up to, and including, 2.6.8. This makes it possible for authenticated attackers, with subscriber-level permissions and above, to reset image optimizations.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/kraken-image-optimizer/tags/2.6.6/kraken.php#L705)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkraken-image-optimizer%2Fkrakenio-image-optimizer-268-missing-authorization-to-authenticated-subscriber-plugin-options-update&t=Kraken.io%20Image%20Optimizer%20%3C%3D%202.6.8%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Plugin%20Options%20Update "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkraken-image-optimizer%2Fkrakenio-image-optimizer-268-missing-authorization-to-authenticated-subscriber-plugin-options-update&text=Kraken.io%20Image%20Optimizer%20%3C%3D%202.6.8%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Plugin%20Options%20Update "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkraken-image-optimizer%2Fkrakenio-image-optimizer-268-missing-authorization-to-authenticated-subscriber-plugin-options-update "LinkedIn")
Email

## Vulnerability Details for Kraken.io Image Optimizer

#### [Kraken.io Image Optimizer](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/kraken-image-optimizer)

| Software Type | Plugin |
| --- | --- |
| Software Slug | kraken-image-optimizer [(view on wordpress.org)](https://wordpress.org/plugins/kraken-image-optimizer) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 2.6.8 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


