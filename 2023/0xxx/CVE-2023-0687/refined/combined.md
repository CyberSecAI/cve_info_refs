=== Content from sourceware.org_2824c390_20250115_113508.html ===

[glibc wiki](/glibc/wiki/HomePage)

Search:

* [Login](/glibc/wiki/Security%20Process?action=login)

[Self](/glibc/wiki/HomePage)

* [Security Process](/glibc/wiki/Security%20Process)

* [HomePage](/glibc/wiki/HomePage)
* [RecentChanges](/glibc/wiki/RecentChanges)
* [FindPage](/glibc/wiki/FindPage)
* [HelpContents](/glibc/wiki/HelpContents)
* [Security Process](/glibc/wiki/Security%20Process)

---

* Immutable Page
* Comments
* [Info](/glibc/wiki/Security%20Process?action=info)
* [Attachments](/glibc/wiki/Security%20Process?action=AttachFile)
* More Actions:
  Raw Text
  Print View
  Render as Docbook
  Delete Cache
  ------------------------
  Check Spelling
  Like Pages
  Local Site Map
  ------------------------
  Rename Page
  Delete Page
  ------------------------
  Subscribe User
  ------------------------
  Remove Spam
  Revert to this revision
  Package Pages
  ------------------------
  Load
  Save
  SlideShow

The GNU C Library Security process is now maintained as [SECURITY.md](https://sourceware.org/git/?p=glibc.git;a=blob;f=SECURITY.md) in the git repository.

None: Security Process (last edited 2023-05-19 11:50:48 by [SiddheshPoyarekar](/glibc/wiki/SiddheshPoyarekar "SiddheshPoyarekar @ 142.113.138.85[142.113.138.85]"))

* Immutable Page
* Comments
* [Info](/glibc/wiki/Security%20Process?action=info)
* [Attachments](/glibc/wiki/Security%20Process?action=AttachFile)
* More Actions:
  Raw Text
  Print View
  Render as Docbook
  Delete Cache
  ------------------------
  Check Spelling
  Like Pages
  Local Site Map
  ------------------------
  Rename Page
  Delete Page
  ------------------------
  Subscribe User
  ------------------------
  Remove Spam
  Revert to this revision
  Package Pages
  ------------------------
  Load
  Save
  SlideShow

* [MoinMoin Powered](http://moinmo.in/ "This site uses the MoinMoin Wiki software.")
* [Python Powered](http://moinmo.in/Python "MoinMoin is written in Python.")
* [GPL licensed](http://moinmo.in/GPL "MoinMoin is GPL licensed.")
* [Valid HTML 4.01](http://validator.w3.org/check?uri=referer "Click here to validate this page.")



=== Content from sourceware.org_4a4b285e_20250115_113401.html ===


Sourceware Bugzilla – Bug 29444
gmon memory corruption due wrong calculation of required buffer size
Last modified: 2023-03-07 04:30:23 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=29444&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=29444&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 29444**](show_bug.cgi?id=29444)
- gmon memory corruption due wrong calculation of required buffer size

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
gmon memory corruption due wrong calculation of required buffer size

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | glibc | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=glibc "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | libc ([show other bugs](buglist.cgi?component=libc&product=glibc&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 2.38 | |  | | | [Importance](page.cgi?id=fields.html#importance): | P2 minor | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Not yet assigned to anyone | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2022-08-03 17:30 UTC by account disabled by myself since useless | | --- | --- | | Modified: | 2023-03-07 04:30 UTC ([History](show_activity.cgi?id=29444)) | | CC List: | 9 users (show)  adhemerval.zanella carnil dj drepper.fsp fweimer ismail jamborm linzhuorong siddhesh | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") | * [27576](show_bug.cgi?id=27576 "UNCONFIRMED - gmon.out not consistently created") | | [Host:](page.cgi?id=fields.html#cf_gcchost "A custom Free Text field in this installation of Bugzilla.") |  | | [Target:](page.cgi?id=fields.html#cf_gcctarget "A custom Free Text field in this installation of Bugzilla.") |  | | [Build:](page.cgi?id=fields.html#cf_gccbuild "A custom Free Text field in this installation of Bugzilla.") |  | | [Last reconfirmed:](page.cgi?id=fields.html#cf_reconfirmed_on "A custom Date/Time field in this installation of Bugzilla.") |  | |  | | | Flags: | siddhesh: security- | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**the patch**](attachment.cgi?id=14253 "View the content of the attachment") (1.44 KB, patch)  [2022-08-03 17:32 UTC](#attach_14253 "Go to the comment associated with the attachment"), account disabled by myself since useless | [Details](attachment.cgi?id=14253&action=edit) | [Diff](attachment.cgi?id=14253&action=diff) | | [View All](attachment.cgi?bugid=29444&action=viewall)  [Add an attachment](attachment.cgi?bugid=29444&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=29444&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=29444#c0)  account disabled by myself since useless    2022-08-03 17:30:56 UTC  ``` The `__monstartup()` allocates a buffer used to store all the data accumulated by the monitor.  The size of this buffer depends on the size of the internal structures used and the address range for which the monitor is activated, as well as on the maximum density of call instuctions and/or callable functions that could be potentially on a segment of executable code.  In particular a hash table of arcs is placed at the end of this buffer. The size of this hash table is calculated in bytes as `p->fromssize = p->textsize / HASHFRACTION`, but actually should be `p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms))`.  This results in writing beyond the end of the allocated buffer when an added arc corresponds to a call near from the end of the monitored address range, since `_mcount()` check the incoming caller address for monitored range but not the intermediate result hash-like index that uses to write into the table.  It should be noted that when the results are output to `gmon.out`, the table is read to the last element calculated from the allocated size in bytes, so the arcs stored outside the buffer boundary did not fall into `gprof` for analysis. Thus  this "feature" help me to found this bug during working with [Bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO").  Another minor error seems a related typo in the calculation of `kcountsize`. ```  [Comment 1](show_bug.cgi?id=29444#c1)  account disabled by myself since useless    2022-08-03 17:32:57 UTC  ``` Created [attachment 14253](attachment.cgi?id=14253&action=diff "the patch") [[details]](attachment.cgi?id=14253&action=edit "the patch") the patch ```  [Comment 2](show_bug.cgi?id=29444#c2)  account disabled by myself since useless    2022-08-03 20:10:42 UTC  ``` Just in case, I will explicitly note that the problem breaks the `make test t=gmon/tst-gmon-dso` added for [Bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO").  There, the arc of the `f3()` call disappears from the output, since in the DSO case, the call to `f3` is located close to the end of the monitored range. ```  [Comment 3](show_bug.cgi?id=29444#c3)  account disabled by myself since useless    2023-01-30 12:38:11 UTC  ``` Please review the attached patch and apply.  It just fixes an allocated buffer overrun issue, i.e. the memory corruption! ```  [Comment 4](show_bug.cgi?id=29444#c4)  Adhemerval Zanella    2023-01-30 16:24:24 UTC  ``` (In reply to Leo Yuriev from [comment #3](show_bug.cgi?id=29444#c3)) > Please review the attached patch and apply.  > It just fixes an allocated buffer overrun issue, i.e. the memory corruption!  Patch reviews are done through libc-alpha email list, could you please sent the patch following the contribution guidelines [1]?  [1] <https://sourceware.org/glibc/wiki/Contribution%20checklist> ```  [Comment 5](show_bug.cgi?id=29444#c5)  account disabled by myself since useless    2023-02-04 12:12:34 UTC  ``` [https://patchwork.sourceware.org/project/glibc/patch/20230204114138.5436-1-leo@yuriev.ru/](https://patchwork.sourceware.org/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/) ```  [Comment 6](show_bug.cgi?id=29444#c6)  account disabled by myself since useless    2023-02-06 17:43:57 UTC  ``` CVE-ID was requested via submission to VulDB. ```  [Comment 7](show_bug.cgi?id=29444#c7)  account disabled by myself since useless    2023-02-06 19:29:20 UTC  ``` CVE-2023-0687 <https://vuldb.com/?id.220246> ```  [Comment 8](show_bug.cgi?id=29444#c8)  Ismail Donmez    2023-02-07 08:40:25 UTC  ``` Will the glibc maintainers reject the assigned CVE? I don't see how this is exploitable. ```  [Comment 9](show_bug.cgi?id=29444#c9)  Florian Weimer    2023-02-07 08:41:58 UTC  ``` (In reply to Ismail Donmez from [comment #8](show_bug.cgi?id=29444#c8)) > Will the glibc maintainers reject the assigned CVE? I don't see how this is > exploitable.  Agreed. I expect us to file a DISPUTE request with MITRE later today. ```  [Comment 10](show_bug.cgi?id=29444#c10)  account disabled by myself since useless    2023-02-07 09:32:10 UTC  ``` (In reply to Florian Weimer from [comment #9](show_bug.cgi?id=29444#c9)) > (In reply to Ismail Donmez from [comment #8](show_bug.cgi?id=29444#c8)) > > Will the glibc maintainers reject the assigned CVE? I don't see how this is > > exploitable. >  > Agreed. I expect us to file a DISPUTE request with MITRE later today.  Yes, it is not exploitable in usual/common cases.  However, this bug can be exploited in rare specific scenarios when monstartup() and moncontrol() are called explicitly to collect statistics from a part of modules compiled with the corresponding options (nonetheless, I cannot disclose information about affected software either show the exploit).  During submission for CVE-ID, I noted about that the bug could be exploited only when gmon activated, but such note is not included into CVE for now. ```  [Comment 11](show_bug.cgi?id=29444#c11)  Siddhesh Poyarekar    2023-02-07 15:00:55 UTC  ``` The only way to induce this buffer overflow is to modify the callgraph of an application that is built with these options(In reply to Leo Yuriev from [comment #10](show_bug.cgi?id=29444#c10)) > (In reply to Florian Weimer from [comment #9](show_bug.cgi?id=29444#c9)) > > (In reply to Ismail Donmez from [comment #8](show_bug.cgi?id=29444#c8)) > > > Will the glibc maintainers reject the assigned CVE? I don't see how this is > > > exploitable. > >  > > Agreed. I expect us to file a DISPUTE request with MITRE later today. >  > Yes, it is not exploitable in usual/common cases. >  > However, this bug can be exploited in rare specific scenarios when > monstartup() and moncontrol() are called explicitly to collect statistics > from a part of modules compiled with the corresponding options (nonetheless, > I cannot disclose information about affected software either show the > exploit).  The inputs that induce this buffer overflow are basically addresses of the running application that is built with gmon enabled *and* with the patch for [bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO"), so it's basically trusted input or input that needs an actual security flaw to be compromised or controlled.  The bug needs to be fixed, but there's no security issue here. ```  [Comment 12](show_bug.cgi?id=29444#c12)  account disabled by myself since useless    2023-02-07 15:57:32 UTC  ``` (In reply to Siddhesh Poyarekar from [comment #11](show_bug.cgi?id=29444#c11)) > The inputs that induce this buffer overflow are basically addresses of the > running application that is built with gmon enabled *and* with the patch for > [bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO"), so it's basically trusted input or input that needs an actual > security flaw to be compromised or controlled.  The bug needs to be fixed, > but there's no security issue here.  The patch for [Bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO") not needed to exploitation, but gmon must be enabled. Initially I discovered this issue while working on [Bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO"). But later it was re-noticed in another environment, where it is exploitable.  Briefly: 1) Prerequirement:  - a web service users gmon to collect statistics on the performance of its module(s);  - OR an attacker can enable the collection of such statistics; 2) By manipulating requests, the attacker achieves a function call that is at the end of the monitored addresses and is usually never called. T 3) The attacker continue an attack using memory corruption.  Yes, this is a very specific scenario with a very low probability of exploitation. However, we reproduced it in a prepared environment. ```  [Comment 13](show_bug.cgi?id=29444#c13)  Siddhesh Poyarekar    2023-02-07 16:01:01 UTC  ``` (In reply to Leo Yuriev from [comment #12](show_bug.cgi?id=29444#c12)) > 2) By manipulating requests, the attacker achieves a function call that is > at the end of the monitored addresses and is usually never called. T  My point is that this step above needs specific knowledge of the address space *and* control over execution to make this happen.  Without such control, there's no exploitation vector. ```  [Comment 14](show_bug.cgi?id=29444#c14)  account disabled by myself since useless    2023-02-08 11:18:46 UTC  ``` (In reply to Siddhesh Poyarekar from [comment #13](show_bug.cgi?id=29444#c13)) > (In reply to Leo Yuriev from [comment #12](show_bug.cgi?id=29444#c12)) > > 2) By manipulating requests, the attacker achieves a function call that is > > at the end of the monitored addresses and is usually never called. >  > My point is that this step above needs specific knowledge of the address > space *and* control over execution to make this happen.  Without such > control, there's no exploitation vector.  There is the effect of a "critical mass" of vulnerabilities - when exploitation is possible only if there is a set of vulnerabilities, but not one or even two.  In my case, it took a couple more vulnerabilities in the application code to exploit this bug. However, without this issue, exploiting is also impossible.  My point is: we cannot assume all use cases and scenarios for a widely used library, therefore a use-after-free, off-by-one, buffer overflow, memory corruption, using/reading uninitialized, race condition, etc... in a such library is always a CVE. No options. ```  [Comment 15](show_bug.cgi?id=29444#c15)  Siddhesh Poyarekar    2023-02-08 11:51:07 UTC  ``` (In reply to Leo Yuriev from [comment #14](show_bug.cgi?id=29444#c14)) > There is the effect of a "critical mass" of vulnerabilities - when > exploitation is possible only if there is a set of vulnerabilities, but not > one or even two. >  > In my case, it took a couple more vulnerabilities in the application code to > exploit this bug. However, without this issue, exploiting is also impossible.  Please explain how, remember that the input has to be *untrusted* for it to be considered a security issue.  > My point is: we cannot assume all use cases and scenarios for a widely used > library, therefore a use-after-free, off-by-one, buffer overflow, memory > corruption, using/reading uninitialized, race condition, etc... in a such > library is always a CVE. > No options.  You're free to consider every memory or synchronization bug in libraries you use as a security issue and deal with it as such.  In the glibc project we have well defined rules as to what we consider security issues:  <https://sourceware.org/glibc/wiki/Security%20Process> ```  [Comment 16](show_bug.cgi?id=29444#c16)  account disabled by myself since useless    2023-02-08 12:03:36 UTC  ``` Sorry, but I don't have time for useless discuss. ```  [Comment 17](show_bug.cgi?id=29444#c17)  Siddhesh Poyarekar    2023-02-08 13:00:47 UTC  ``` Keeping the bug open since we obviously want to fix it. ```  [Comment 18](show_bug.cgi?id=29444#c18)  Salvatore Bonaccorso    2023-02-09 22:05:33 UTC  ``` Florian,  Regarding the DISPUTE (or reject?) for the CVE as mentioned in [https://sourceware.org/bugzilla/show_bug.cgi?id=29444#c9](show_bug.cgi?id=29444#c9 "RESOLVED FIXED - gmon memory corruption due wrong calculation of required buffer size") :   Schould the request actually go to VulDB instead of MITRE, as VulDB was the assigning CNA?  Regards, Salvatore ```  [Comment 19](show_bug.cgi?id=29444#c19)  Siddhesh Poyarekar    2023-02-09 22:27:21 UTC  ``` I already submitted the rejection request to Mitre.  VulDB has a login barrier to even view the CVE, so I didn't bother with it.  If Mitre refuses to handle it I'll retry with vuldb. ```  [Comment 20](show_bug.cgi?id=29444#c20)  account disabled by myself since useless    2023-02-23 07:36:27 UTC  ``` Fixed by commit 801af9fafd4689337ebf27260aa115335a0cb2bc <https://sourceware.org/git/?p=glibc.git;a=commit;h=801af9fafd4689337ebf27260aa115335a0cb2bc>  Thanks to DJ Delorie <dj@redhat.com>.  Please close as FIXED. ```  [Comment 21](show_bug.cgi?id=29444#c21)  dj@redhat.com    2023-02-23 18:13:28 UTC  ``` Fixed in rawhide. ```  [Comment 22](show_bug.cgi?id=29444#c22)  lin zhuorong    2023-03-04 10:44:05 UTC  ``` (In reply to account disabled by myself since useless from [comment #20](show_bug.cgi?id=29444#c20)) > Fixed by commit 801af9fafd4689337ebf27260aa115335a0cb2bc > <https://sourceware.org/git/?p=glibc.git;a=commit>; > h=801af9fafd4689337ebf27260aa115335a0cb2bc >  > Thanks to DJ Delorie <dj@redhat.com>. >  > Please close as FIXED.  This fix calls ROUNDUP to address memory alignment and does not limit the buffer size to the specified range. ```  [Comment 23](show_bug.cgi?id=29444#c23)  dj@redhat.com    2023-03-07 04:30:23 UTC  ``` Could you be more specific?  (In reply to lin zhuorong from [comment #22](show_bug.cgi?id=29444#c22)) > This fix calls ROUNDUP to address memory alignment and does not limit the > buffer size to the specified range.  Could you be more specific?  The fix increases the buffer size enough to prevent a partial record from being written past the end of the allocated buffer.  The memory alignment was already in there.  Which range should the buffer size be limited to? ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=29444)
* - [XML](show_bug.cgi?ctype=xml&id=29444)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=29444)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=29444&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=29444&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



=== Content from sourceware.org_6bc13996_20250115_113408.html ===

[![git](static/git-logo.png)](https://git-scm.com/ "git homepage")[git://sourceware.org](/git) / [glibc.git](/git?p=glibc.git;a=summary) / commit

commit
grep
author
committer
pickaxe
 [?](/git?p=glibc.git;a=search_help "search help") search:

re

[summary](/git?p=glibc.git;a=summary) | [shortlog](/git?p=glibc.git;a=shortlog;h=801af9fafd4689337ebf27260aa115335a0cb2bc) | [log](/git?p=glibc.git;a=log;h=801af9fafd4689337ebf27260aa115335a0cb2bc) | commit | [commitdiff](/git?p=glibc.git;a=commitdiff;h=801af9fafd4689337ebf27260aa115335a0cb2bc) | [tree](/git?p=glibc.git;a=tree;h=c4c94315eea86be5349777429272bb8391c157d0;hb=801af9fafd4689337ebf27260aa115335a0cb2bc)

(parent: [3f84f11](/git?p=glibc.git;a=commit;h=3f84f1159e9f3e9716eae46ba88616bb153fdd8c)) | [patch](/git?p=glibc.git;a=patch;h=801af9fafd4689337ebf27260aa115335a0cb2bc)

[gmon: Fix allocated buffer overflow (bug 29444)](/git?p=glibc.git;a=commitdiff;h=801af9fafd4689337ebf27260aa115335a0cb2bc)

| author | [Леонид Юрьев (Leonid Yuriev)](/git?p=glibc.git;a=search;h=801af9fafd4689337ebf27260aa115335a0cb2bc;s=%D0%9B%D0%B5%D0%BE%D0%BD%D0%B8%D0%B4+%D0%AE%D1%80%D1%8C%D0%B5%D0%B2+(Leonid+Yuriev);st=author "Search for commits authored by Леонид Юрьев (Leonid Yuriev)") [<leo@yuriev.ru>](/git?p=glibc.git;a=search;h=801af9fafd4689337ebf27260aa115335a0cb2bc;s=leo@yuriev.ru;st=author "Search for commits authored by leo@yuriev.ru") |  |
| --- | --- | --- |
|  | Sat, 4 Feb 2023 11:41:38 +0000 (14:41 +0300) |
| committer | [DJ Delorie](/git?p=glibc.git;a=search;h=801af9fafd4689337ebf27260aa115335a0cb2bc;s=DJ+Delorie;st=committer "Search for commits committed by DJ Delorie") [<dj@redhat.com>](/git?p=glibc.git;a=search;h=801af9fafd4689337ebf27260aa115335a0cb2bc;s=dj@redhat.com;st=committer "Search for commits committed by dj@redhat.com") |  |
|  | Wed, 22 Feb 2023 22:23:57 +0000 (17:23 -0500) |
| commit | 801af9fafd4689337ebf27260aa115335a0cb2bc |
| tree | [c4c94315eea86be5349777429272bb8391c157d0](/git?p=glibc.git;a=tree;h=c4c94315eea86be5349777429272bb8391c157d0;hb=801af9fafd4689337ebf27260aa115335a0cb2bc) | [tree](/git?p=glibc.git;a=tree;h=c4c94315eea86be5349777429272bb8391c157d0;hb=801af9fafd4689337ebf27260aa115335a0cb2bc) |
| parent | [3f84f1159e9f3e9716eae46ba88616bb153fdd8c](/git?p=glibc.git;a=commit;h=3f84f1159e9f3e9716eae46ba88616bb153fdd8c) | [commit](/git?p=glibc.git;a=commit;h=3f84f1159e9f3e9716eae46ba88616bb153fdd8c) | [diff](/git?p=glibc.git;a=commitdiff;h=801af9fafd4689337ebf27260aa115335a0cb2bc;hp=3f84f1159e9f3e9716eae46ba88616bb153fdd8c) |

gmon: Fix allocated buffer overflow (bug 29444)

The `\_\_monstartup()` allocates a buffer used to store all the data

accumulated by the monitor.

The size of this buffer depends on the size of the internal structures

used and the address range for which the monitor is activated, as well

as on the maximum density of call instructions and/or callable functions

that could be potentially on a segment of executable code.

In particular a hash table of arcs is placed at the end of this buffer.

The size of this hash table is calculated in bytes as

   p->fromssize = p->textsize / HASHFRACTION;

but actually should be

   p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(\*p->froms));

This results in writing beyond the end of the allocated buffer when an

added arc corresponds to a call near from the end of the monitored

address range, since `\_mcount()` check the incoming caller address for

monitored range but not the intermediate result hash-like index that

uses to write into the table.

It should be noted that when the results are output to `gmon.out`, the

table is read to the last element calculated from the allocated size in

bytes, so the arcs stored outside the buffer boundary did not fall into

`gprof` for analysis. Thus this "feature" help me to found this bug

during working with https://sourceware.org/bugzilla/show\_bug.cgi?id=29438

Just in case, I will explicitly note that the problem breaks the

`make test t=gmon/tst-gmon-dso` added for Bug 29438.

There, the arc of the `f3()` call disappears from the output, since in

the DSO case, the call to `f3` is located close to the end of the

monitored range.

Signed-off-by: Леонид Юрьев (Leonid Yuriev) <leo@yuriev.ru>

Another minor error seems a related typo in the calculation of

`kcountsize`, but since kcounts are smaller than froms, this is

actually to align the p->froms data.

Co-authored-by: DJ Delorie <dj@redhat.com>

Reviewed-by: Carlos O'Donell <carlos@redhat.com>

| [gmon/gmon.c](/git?p=glibc.git;a=blob;f=gmon/gmon.c;h=bf76358d5b1aa2da25093f3aa15cc209fe1e8993;hb=801af9fafd4689337ebf27260aa115335a0cb2bc) |  | [diff](/git?p=glibc.git;a=blobdiff;f=gmon/gmon.c;h=bf76358d5b1aa2da25093f3aa15cc209fe1e8993;hp=dee64803ada583d79ca9adc281beffce4300255f;hb=801af9fafd4689337ebf27260aa115335a0cb2bc;hpb=3f84f1159e9f3e9716eae46ba88616bb153fdd8c) | [blob](/git?p=glibc.git;a=blob;f=gmon/gmon.c;h=bf76358d5b1aa2da25093f3aa15cc209fe1e8993;hb=801af9fafd4689337ebf27260aa115335a0cb2bc) | [blame](/git?p=glibc.git;a=blame;f=gmon/gmon.c;hb=801af9fafd4689337ebf27260aa115335a0cb2bc) | [history](/git?p=glibc.git;a=history;f=gmon/gmon.c;hb=801af9fafd4689337ebf27260aa115335a0cb2bc) |
| --- | --- | --- |

GNU C Library master sources
[RSS](/git?p=glibc.git;a=rss "log RSS feed")
[Atom](/git?p=glibc.git;a=atom "log Atom feed")

This page took 1.799897 seconds  and 5 git commands to generate.



=== Content from sourceware.org_c563c002_20250114_185356.html ===


Sourceware Bugzilla – Bug 29444
gmon memory corruption due wrong calculation of required buffer size
Last modified: 2023-03-07 04:30:23 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=29444&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=29444&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 29444**](show_bug.cgi?id=29444)
- gmon memory corruption due wrong calculation of required buffer size

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
gmon memory corruption due wrong calculation of required buffer size

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | glibc | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=glibc "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | libc ([show other bugs](buglist.cgi?component=libc&product=glibc&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 2.38 | |  | | | [Importance](page.cgi?id=fields.html#importance): | P2 minor | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Not yet assigned to anyone | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2022-08-03 17:30 UTC by account disabled by myself since useless | | --- | --- | | Modified: | 2023-03-07 04:30 UTC ([History](show_activity.cgi?id=29444)) | | CC List: | 9 users (show)  adhemerval.zanella carnil dj drepper.fsp fweimer ismail jamborm linzhuorong siddhesh | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") | * [27576](show_bug.cgi?id=27576 "UNCONFIRMED - gmon.out not consistently created") | | [Host:](page.cgi?id=fields.html#cf_gcchost "A custom Free Text field in this installation of Bugzilla.") |  | | [Target:](page.cgi?id=fields.html#cf_gcctarget "A custom Free Text field in this installation of Bugzilla.") |  | | [Build:](page.cgi?id=fields.html#cf_gccbuild "A custom Free Text field in this installation of Bugzilla.") |  | | [Last reconfirmed:](page.cgi?id=fields.html#cf_reconfirmed_on "A custom Date/Time field in this installation of Bugzilla.") |  | |  | | | Flags: | siddhesh: security- | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**the patch**](attachment.cgi?id=14253 "View the content of the attachment") (1.44 KB, patch)  [2022-08-03 17:32 UTC](#attach_14253 "Go to the comment associated with the attachment"), account disabled by myself since useless | [Details](attachment.cgi?id=14253&action=edit) | [Diff](attachment.cgi?id=14253&action=diff) | | [View All](attachment.cgi?bugid=29444&action=viewall)  [Add an attachment](attachment.cgi?bugid=29444&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=29444&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=29444#c0)  account disabled by myself since useless    2022-08-03 17:30:56 UTC  ``` The `__monstartup()` allocates a buffer used to store all the data accumulated by the monitor.  The size of this buffer depends on the size of the internal structures used and the address range for which the monitor is activated, as well as on the maximum density of call instuctions and/or callable functions that could be potentially on a segment of executable code.  In particular a hash table of arcs is placed at the end of this buffer. The size of this hash table is calculated in bytes as `p->fromssize = p->textsize / HASHFRACTION`, but actually should be `p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms))`.  This results in writing beyond the end of the allocated buffer when an added arc corresponds to a call near from the end of the monitored address range, since `_mcount()` check the incoming caller address for monitored range but not the intermediate result hash-like index that uses to write into the table.  It should be noted that when the results are output to `gmon.out`, the table is read to the last element calculated from the allocated size in bytes, so the arcs stored outside the buffer boundary did not fall into `gprof` for analysis. Thus  this "feature" help me to found this bug during working with [Bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO").  Another minor error seems a related typo in the calculation of `kcountsize`. ```  [Comment 1](show_bug.cgi?id=29444#c1)  account disabled by myself since useless    2022-08-03 17:32:57 UTC  ``` Created [attachment 14253](attachment.cgi?id=14253&action=diff "the patch") [[details]](attachment.cgi?id=14253&action=edit "the patch") the patch ```  [Comment 2](show_bug.cgi?id=29444#c2)  account disabled by myself since useless    2022-08-03 20:10:42 UTC  ``` Just in case, I will explicitly note that the problem breaks the `make test t=gmon/tst-gmon-dso` added for [Bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO").  There, the arc of the `f3()` call disappears from the output, since in the DSO case, the call to `f3` is located close to the end of the monitored range. ```  [Comment 3](show_bug.cgi?id=29444#c3)  account disabled by myself since useless    2023-01-30 12:38:11 UTC  ``` Please review the attached patch and apply.  It just fixes an allocated buffer overrun issue, i.e. the memory corruption! ```  [Comment 4](show_bug.cgi?id=29444#c4)  Adhemerval Zanella    2023-01-30 16:24:24 UTC  ``` (In reply to Leo Yuriev from [comment #3](show_bug.cgi?id=29444#c3)) > Please review the attached patch and apply.  > It just fixes an allocated buffer overrun issue, i.e. the memory corruption!  Patch reviews are done through libc-alpha email list, could you please sent the patch following the contribution guidelines [1]?  [1] <https://sourceware.org/glibc/wiki/Contribution%20checklist> ```  [Comment 5](show_bug.cgi?id=29444#c5)  account disabled by myself since useless    2023-02-04 12:12:34 UTC  ``` [https://patchwork.sourceware.org/project/glibc/patch/20230204114138.5436-1-leo@yuriev.ru/](https://patchwork.sourceware.org/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/) ```  [Comment 6](show_bug.cgi?id=29444#c6)  account disabled by myself since useless    2023-02-06 17:43:57 UTC  ``` CVE-ID was requested via submission to VulDB. ```  [Comment 7](show_bug.cgi?id=29444#c7)  account disabled by myself since useless    2023-02-06 19:29:20 UTC  ``` CVE-2023-0687 <https://vuldb.com/?id.220246> ```  [Comment 8](show_bug.cgi?id=29444#c8)  Ismail Donmez    2023-02-07 08:40:25 UTC  ``` Will the glibc maintainers reject the assigned CVE? I don't see how this is exploitable. ```  [Comment 9](show_bug.cgi?id=29444#c9)  Florian Weimer    2023-02-07 08:41:58 UTC  ``` (In reply to Ismail Donmez from [comment #8](show_bug.cgi?id=29444#c8)) > Will the glibc maintainers reject the assigned CVE? I don't see how this is > exploitable.  Agreed. I expect us to file a DISPUTE request with MITRE later today. ```  [Comment 10](show_bug.cgi?id=29444#c10)  account disabled by myself since useless    2023-02-07 09:32:10 UTC  ``` (In reply to Florian Weimer from [comment #9](show_bug.cgi?id=29444#c9)) > (In reply to Ismail Donmez from [comment #8](show_bug.cgi?id=29444#c8)) > > Will the glibc maintainers reject the assigned CVE? I don't see how this is > > exploitable. >  > Agreed. I expect us to file a DISPUTE request with MITRE later today.  Yes, it is not exploitable in usual/common cases.  However, this bug can be exploited in rare specific scenarios when monstartup() and moncontrol() are called explicitly to collect statistics from a part of modules compiled with the corresponding options (nonetheless, I cannot disclose information about affected software either show the exploit).  During submission for CVE-ID, I noted about that the bug could be exploited only when gmon activated, but such note is not included into CVE for now. ```  [Comment 11](show_bug.cgi?id=29444#c11)  Siddhesh Poyarekar    2023-02-07 15:00:55 UTC  ``` The only way to induce this buffer overflow is to modify the callgraph of an application that is built with these options(In reply to Leo Yuriev from [comment #10](show_bug.cgi?id=29444#c10)) > (In reply to Florian Weimer from [comment #9](show_bug.cgi?id=29444#c9)) > > (In reply to Ismail Donmez from [comment #8](show_bug.cgi?id=29444#c8)) > > > Will the glibc maintainers reject the assigned CVE? I don't see how this is > > > exploitable. > >  > > Agreed. I expect us to file a DISPUTE request with MITRE later today. >  > Yes, it is not exploitable in usual/common cases. >  > However, this bug can be exploited in rare specific scenarios when > monstartup() and moncontrol() are called explicitly to collect statistics > from a part of modules compiled with the corresponding options (nonetheless, > I cannot disclose information about affected software either show the > exploit).  The inputs that induce this buffer overflow are basically addresses of the running application that is built with gmon enabled *and* with the patch for [bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO"), so it's basically trusted input or input that needs an actual security flaw to be compromised or controlled.  The bug needs to be fixed, but there's no security issue here. ```  [Comment 12](show_bug.cgi?id=29444#c12)  account disabled by myself since useless    2023-02-07 15:57:32 UTC  ``` (In reply to Siddhesh Poyarekar from [comment #11](show_bug.cgi?id=29444#c11)) > The inputs that induce this buffer overflow are basically addresses of the > running application that is built with gmon enabled *and* with the patch for > [bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO"), so it's basically trusted input or input that needs an actual > security flaw to be compromised or controlled.  The bug needs to be fixed, > but there's no security issue here.  The patch for [Bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO") not needed to exploitation, but gmon must be enabled. Initially I discovered this issue while working on [Bug 29438](show_bug.cgi?id=29438 "RESOLVED WONTFIX - enabling gmon for arbitrary DSO"). But later it was re-noticed in another environment, where it is exploitable.  Briefly: 1) Prerequirement:  - a web service users gmon to collect statistics on the performance of its module(s);  - OR an attacker can enable the collection of such statistics; 2) By manipulating requests, the attacker achieves a function call that is at the end of the monitored addresses and is usually never called. T 3) The attacker continue an attack using memory corruption.  Yes, this is a very specific scenario with a very low probability of exploitation. However, we reproduced it in a prepared environment. ```  [Comment 13](show_bug.cgi?id=29444#c13)  Siddhesh Poyarekar    2023-02-07 16:01:01 UTC  ``` (In reply to Leo Yuriev from [comment #12](show_bug.cgi?id=29444#c12)) > 2) By manipulating requests, the attacker achieves a function call that is > at the end of the monitored addresses and is usually never called. T  My point is that this step above needs specific knowledge of the address space *and* control over execution to make this happen.  Without such control, there's no exploitation vector. ```  [Comment 14](show_bug.cgi?id=29444#c14)  account disabled by myself since useless    2023-02-08 11:18:46 UTC  ``` (In reply to Siddhesh Poyarekar from [comment #13](show_bug.cgi?id=29444#c13)) > (In reply to Leo Yuriev from [comment #12](show_bug.cgi?id=29444#c12)) > > 2) By manipulating requests, the attacker achieves a function call that is > > at the end of the monitored addresses and is usually never called. >  > My point is that this step above needs specific knowledge of the address > space *and* control over execution to make this happen.  Without such > control, there's no exploitation vector.  There is the effect of a "critical mass" of vulnerabilities - when exploitation is possible only if there is a set of vulnerabilities, but not one or even two.  In my case, it took a couple more vulnerabilities in the application code to exploit this bug. However, without this issue, exploiting is also impossible.  My point is: we cannot assume all use cases and scenarios for a widely used library, therefore a use-after-free, off-by-one, buffer overflow, memory corruption, using/reading uninitialized, race condition, etc... in a such library is always a CVE. No options. ```  [Comment 15](show_bug.cgi?id=29444#c15)  Siddhesh Poyarekar    2023-02-08 11:51:07 UTC  ``` (In reply to Leo Yuriev from [comment #14](show_bug.cgi?id=29444#c14)) > There is the effect of a "critical mass" of vulnerabilities - when > exploitation is possible only if there is a set of vulnerabilities, but not > one or even two. >  > In my case, it took a couple more vulnerabilities in the application code to > exploit this bug. However, without this issue, exploiting is also impossible.  Please explain how, remember that the input has to be *untrusted* for it to be considered a security issue.  > My point is: we cannot assume all use cases and scenarios for a widely used > library, therefore a use-after-free, off-by-one, buffer overflow, memory > corruption, using/reading uninitialized, race condition, etc... in a such > library is always a CVE. > No options.  You're free to consider every memory or synchronization bug in libraries you use as a security issue and deal with it as such.  In the glibc project we have well defined rules as to what we consider security issues:  <https://sourceware.org/glibc/wiki/Security%20Process> ```  [Comment 16](show_bug.cgi?id=29444#c16)  account disabled by myself since useless    2023-02-08 12:03:36 UTC  ``` Sorry, but I don't have time for useless discuss. ```  [Comment 17](show_bug.cgi?id=29444#c17)  Siddhesh Poyarekar    2023-02-08 13:00:47 UTC  ``` Keeping the bug open since we obviously want to fix it. ```  [Comment 18](show_bug.cgi?id=29444#c18)  Salvatore Bonaccorso    2023-02-09 22:05:33 UTC  ``` Florian,  Regarding the DISPUTE (or reject?) for the CVE as mentioned in [https://sourceware.org/bugzilla/show_bug.cgi?id=29444#c9](show_bug.cgi?id=29444#c9 "RESOLVED FIXED - gmon memory corruption due wrong calculation of required buffer size") :   Schould the request actually go to VulDB instead of MITRE, as VulDB was the assigning CNA?  Regards, Salvatore ```  [Comment 19](show_bug.cgi?id=29444#c19)  Siddhesh Poyarekar    2023-02-09 22:27:21 UTC  ``` I already submitted the rejection request to Mitre.  VulDB has a login barrier to even view the CVE, so I didn't bother with it.  If Mitre refuses to handle it I'll retry with vuldb. ```  [Comment 20](show_bug.cgi?id=29444#c20)  account disabled by myself since useless    2023-02-23 07:36:27 UTC  ``` Fixed by commit 801af9fafd4689337ebf27260aa115335a0cb2bc <https://sourceware.org/git/?p=glibc.git;a=commit;h=801af9fafd4689337ebf27260aa115335a0cb2bc>  Thanks to DJ Delorie <dj@redhat.com>.  Please close as FIXED. ```  [Comment 21](show_bug.cgi?id=29444#c21)  dj@redhat.com    2023-02-23 18:13:28 UTC  ``` Fixed in rawhide. ```  [Comment 22](show_bug.cgi?id=29444#c22)  lin zhuorong    2023-03-04 10:44:05 UTC  ``` (In reply to account disabled by myself since useless from [comment #20](show_bug.cgi?id=29444#c20)) > Fixed by commit 801af9fafd4689337ebf27260aa115335a0cb2bc > <https://sourceware.org/git/?p=glibc.git;a=commit>; > h=801af9fafd4689337ebf27260aa115335a0cb2bc >  > Thanks to DJ Delorie <dj@redhat.com>. >  > Please close as FIXED.  This fix calls ROUNDUP to address memory alignment and does not limit the buffer size to the specified range. ```  [Comment 23](show_bug.cgi?id=29444#c23)  dj@redhat.com    2023-03-07 04:30:23 UTC  ``` Could you be more specific?  (In reply to lin zhuorong from [comment #22](show_bug.cgi?id=29444#c22)) > This fix calls ROUNDUP to address memory alignment and does not limit the > buffer size to the specified range.  Could you be more specific?  The fix increases the buffer size enough to prevent a partial record from being written past the end of the allocated buffer.  The memory alignment was already in there.  Which range should the buffer size be limited to? ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=29444)
* - [XML](show_bug.cgi?ctype=xml&id=29444)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=29444)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=29444&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=29444&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



=== Content from sourceware.org_4dbe1c1e_20250115_113446.html ===

[![git](static/git-logo.png)](https://git-scm.com/ "git homepage")[git://sourceware.org](/git) / [glibc.git](/git?p=glibc.git;a=summary) / commit

commit
grep
author
committer
pickaxe
 [?](/git?p=glibc.git;a=search_help "search help") search:

re

[summary](/git?p=glibc.git;a=summary) | [shortlog](/git?p=glibc.git;a=shortlog;h=HEAD) | [log](/git?p=glibc.git;a=log;h=HEAD) | commit | [commitdiff](/git?p=glibc.git;a=commitdiff;h=HEAD) | [tree](/git?p=glibc.git;a=tree;h=6ed4071be6ed71ea185c4d5c3af2f210a94a2f77;hb=HEAD)

(parent: [09ea1af](/git?p=glibc.git;a=commit;h=09ea1afec75ed0d41cb0da27a9df1b8c3dd56ddc)) | [patch](/git?p=glibc.git;a=patch)

[mach: Add missing error messages  [master](/git?p=glibc.git;a=shortlog;h=refs/heads/master)](/git?p=glibc.git;a=commitdiff;h=HEAD)

| author | [Samuel Thibault](/git?p=glibc.git;a=search;h=HEAD;s=Samuel+Thibault;st=author "Search for commits authored by Samuel Thibault") [<samuel.thibault@ens-lyon.org>](/git?p=glibc.git;a=search;h=HEAD;s=samuel.thibault@ens-lyon.org;st=author "Search for commits authored by samuel.thibault@ens-lyon.org") |  |
| --- | --- | --- |
|  | Tue, 14 Jan 2025 21:40:54 +0000 (22:40 +0100) |
| committer | [Samuel Thibault](/git?p=glibc.git;a=search;h=HEAD;s=Samuel+Thibault;st=committer "Search for commits committed by Samuel Thibault") [<samuel.thibault@ens-lyon.org>](/git?p=glibc.git;a=search;h=HEAD;s=samuel.thibault@ens-lyon.org;st=committer "Search for commits committed by samuel.thibault@ens-lyon.org") |  |
|  | Tue, 14 Jan 2025 21:41:03 +0000 (22:41 +0100) |
| commit | a402cae36d95a2141703df324b5de5b581868c5c |
| tree | [6ed4071be6ed71ea185c4d5c3af2f210a94a2f77](/git?p=glibc.git;a=tree;h=6ed4071be6ed71ea185c4d5c3af2f210a94a2f77;hb=HEAD) | [tree](/git?p=glibc.git;a=tree;h=6ed4071be6ed71ea185c4d5c3af2f210a94a2f77;hb=HEAD) |
| parent | [09ea1afec75ed0d41cb0da27a9df1b8c3dd56ddc](/git?p=glibc.git;a=commit;h=09ea1afec75ed0d41cb0da27a9df1b8c3dd56ddc) | [commit](/git?p=glibc.git;a=commit;h=09ea1afec75ed0d41cb0da27a9df1b8c3dd56ddc) | [diff](/git?p=glibc.git;a=commitdiff;h=HEAD;hp=09ea1afec75ed0d41cb0da27a9df1b8c3dd56ddc) |

mach: Add missing error messages

| [mach/err\_kern.sub](/git?p=glibc.git;a=blob;f=mach/err_kern.sub;h=df380fa414da5b9cff63753dcd8001ae5fcb9803;hb=HEAD) |  | [diff](/git?p=glibc.git;a=blobdiff;f=mach/err_kern.sub;h=df380fa414da5b9cff63753dcd8001ae5fcb9803;hp=42c38ebd5943f40c4671b4b8eb951e0386efb8a9;hb=HEAD;hpb=09ea1afec75ed0d41cb0da27a9df1b8c3dd56ddc) | [blob](/git?p=glibc.git;a=blob;f=mach/err_kern.sub;h=df380fa414da5b9cff63753dcd8001ae5fcb9803;hb=HEAD) | [blame](/git?p=glibc.git;a=blame;f=mach/err_kern.sub;hb=HEAD) | [history](/git?p=glibc.git;a=history;f=mach/err_kern.sub;hb=HEAD) |
| --- | --- | --- |

GNU C Library master sources
[RSS](/git?p=glibc.git;a=rss "log RSS feed")
[Atom](/git?p=glibc.git;a=atom "log Atom feed")

This page took 2.098981 seconds  and 5 git commands to generate.



=== Content from patchwork.sourceware.org_a944235d_20250115_113331.html ===

Toggle navigation

[Patchwork](/)
GNU C Library (glibc)

* [Patches](/project/glibc/list/)
* [Bundles](/project/glibc/bundles/)
* [About this project](/project/glibc/)

* [Login](/user/login/)
* [Register](/register/)
* [Mail settings](/mail/)

64295

[diff](/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/raw/ "Download patch diff")
[mbox](/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/mbox/ "Download patch mbox")
[series](/series/16752/mbox/ "Download patch mbox with dependencies")
# gmon: Fix allocated buffer overflow (bug 2944)

| Message ID | 20230204114138.5436-1-leo@yuriev.ru ([mailing list archive](https://inbox.sourceware.org/libc-alpha/20230204114138.5436-1-leo%40yuriev.ru)) |
| --- | --- |
| State | Superseded |
| Delegated to: | DJ Delorie |
| Headers | show ``` Return-Path: <libc-alpha-bounces+patchwork=sourceware.org@sourceware.org> X-Original-To: patchwork@sourceware.org Delivered-To: patchwork@sourceware.org Received: from server2.sourceware.org (localhost [IPv6:::1]) 	by sourceware.org (Postfix) with ESMTP id 4D9743857B93 	for <patchwork@sourceware.org>; Sat,  4 Feb 2023 11:45:02 +0000 (GMT) X-Original-To: libc-alpha@sourceware.org Delivered-To: libc-alpha@sourceware.org Received: from forward105j.mail.yandex.net (forward105j.mail.yandex.net  [5.45.198.248])  by sourceware.org (Postfix) with ESMTPS id EEBDA3858C52  for <libc-alpha@sourceware.org>; Sat,  4 Feb 2023 11:44:47 +0000 (GMT) DMARC-Filter: OpenDMARC Filter v1.4.2 sourceware.org EEBDA3858C52 Authentication-Results: sourceware.org;  dmarc=none (p=none dis=none) header.from=yuriev.ru Authentication-Results: sourceware.org; spf=pass smtp.mailfrom=yuriev.ru Received: from myt5-fc73f9af8654.qloud-c.yandex.net  (myt5-fc73f9af8654.qloud-c.yandex.net  [IPv6:2a02:6b8:c12:2898:0:640:fc73:f9af])  by forward105j.mail.yandex.net (Yandex) with ESMTP id CA0414EC9D41;  Sat,  4 Feb 2023 14:42:04 +0300 (MSK) Received: by myt5-fc73f9af8654.qloud-c.yandex.net (smtp/Yandex) with ESMTPSA  id 3gXq2nuYUeA1-Wq7BS5Pl; Sat, 04 Feb 2023 14:42:04 +0300 X-Yandex-Fwd: 1 DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=yuriev.ru; s=mail;  t=1675510924; bh=LuWTLecar1PYenEgGzogYr2tcw5irV5ynX8LLQqxkiM=;  h=Message-Id:Date:Cc:Subject:To:From;  b=LgHZzbyfIP+mKyV23CMp5Yudx15MlDvMdzZ3ufTM7fP0E3+8jpH2ETixzpXt5Vu8/  +4SZgPBSjc0DOaMs7HzL89V9Z+Erq7w5G4ieN8UQEdJYfRoXHW+khJzjsRby+nyBsQ  vXJbOiK1iP88HzK3arWlYlgsUtqMotGzwKiC1Mls= Authentication-Results: myt5-fc73f9af8654.qloud-c.yandex.net;  dkim=pass header.i=@yuriev.ru From: =?utf-8?b?0JvQtdC+0L3QuNC0INCu0YDRjNC10LIgKExlb25pZCBZdXJpZXYp?=  <leo@yuriev.ru> To: libc-alpha@sourceware.org Cc: drepper.fsp@gmail.com, =?utf-8?b?0JvQtdC+0L3QuNC0INCu0YDRjNC10LIgKExl?= 	=?utf-8?b?b25pZCBZdXJpZXYp?= <leo@yuriev.ru> Subject: [PATCH] gmon: Fix allocated buffer overflow (bug 2944) Date: Sat,  4 Feb 2023 14:41:38 +0300 Message-Id: <20230204114138.5436-1-leo@yuriev.ru> X-Mailer: git-send-email 2.34.1 MIME-Version: 1.0 Content-Type: text/plain; charset=UTF-8 Content-Transfer-Encoding: 8bit X-Spam-Status: No, score=-10.3 required=5.0 tests=BAYES_00, BODY_8BITS,  DKIM_INVALID, DKIM_SIGNED, GIT_PATCH_0, KAM_DMARC_STATUS, RCVD_IN_MSPIKE_H2,  SPF_HELO_NONE, SPF_PASS autolearn=ham autolearn_force=no version=3.4.6 X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on  server2.sourceware.org X-BeenThere: libc-alpha@sourceware.org X-Mailman-Version: 2.1.29 Precedence: list List-Id: Libc-alpha mailing list <libc-alpha.sourceware.org> List-Unsubscribe: <https://sourceware.org/mailman/options/libc-alpha>,  <mailto:libc-alpha-request@sourceware.org?subject=unsubscribe> List-Archive: <https://sourceware.org/pipermail/libc-alpha/> List-Post: <mailto:libc-alpha@sourceware.org> List-Help: <mailto:libc-alpha-request@sourceware.org?subject=help> List-Subscribe: <https://sourceware.org/mailman/listinfo/libc-alpha>,  <mailto:libc-alpha-request@sourceware.org?subject=subscribe> Errors-To: libc-alpha-bounces+patchwork=sourceware.org@sourceware.org Sender: "Libc-alpha"  <libc-alpha-bounces+patchwork=sourceware.org@sourceware.org> ``` |
| Series | [gmon: Fix allocated buffer overflow (bug 2944)](/project/glibc/list/?series=16752) | expand   * gmon: Fix allocated buffer overflow (bug 2944) |

## Checks

| Context | Check | Description |
| --- | --- | --- |
| dj/TryBot-apply\_patch | success | Patch applied to master at the time it was sent |
| dj/TryBot-32bit | success | Build for i686 |

## Commit Message

[Леонид Юрьев (Leonid Yuriev)](/project/glibc/list/?submitter=36069)
Feb. 4, 2023, 11:41 a.m. UTC
```

  The `__monstartup()` allocates a buffer used to store all the data
accumulated by the monitor.

The size of this buffer depends on the size of the internal structures
used and the address range for which the monitor is activated, as well
as on the maximum density of call instuctions and/or callable functions
that could be potentially on a segment of executable code.

In particular a hash table of arcs is placed at the end of this buffer.
The size of this hash table is calculated in bytes as
   p->fromssize = p->textsize / HASHFRACTION;

but actually should be
   p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));

Another minor error seems a related typo in the calculation of `kcountsize`.

This results in writing beyond the end of the allocated buffer when an
added arc corresponds to a call near from the end of the monitored
address range, since `_mcount()` check the incoming caller address for
monitored range but not the intermediate result hash-like index that
uses to write into the table.

It should be noted that when the results are output to `gmon.out`, the
table is read to the last element calculated from the allocated size in
bytes, so the arcs stored outside the buffer boundary did not fall into
`gprof` for analysis. Thus this "feature" help me to found this bug
during working with https://sourceware.org/bugzilla/show_bug.cgi?id=29438

Just in case, I will explicitly note that the problem breaks the
`make test t=gmon/tst-gmon-dso` added for Bug 29438.
There, the arc of the `f3()` call disappears from the output, since in
the DSO case, the call to `f3` is located close to the end of the
monitored range.
Signed-off-by: Леонид Юрьев (Leonid Yuriev) <leo@yuriev.ru>
---
 gmon/gmon.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

```
## Comments

[Carlos O'Donell](/project/glibc/list/?submitter=3)
Feb. 7, 2023, 2:22 p.m. UTC |
[#1](/comment/137898/)

Addressed

Unaddressed

```

On 2/4/23 06:41, Леонид Юрьев (Leonid Yuriev) wrote:
> The `__monstartup()` allocates a buffer used to store all the data
> accumulated by the monitor.

I haven't reviewed this yet, but the bug number is "29444" and is incorrectly
written in the Subject line.

Thanks for posting this. We talked briefly about this patch during the Monday
patch review and we're trying to find a developer to review it.

> The size of this buffer depends on the size of the internal structures
> used and the address range for which the monitor is activated, as well
> as on the maximum density of call instuctions and/or callable functions
> that could be potentially on a segment of executable code.
>
> In particular a hash table of arcs is placed at the end of this buffer.
> The size of this hash table is calculated in bytes as
>    p->fromssize = p->textsize / HASHFRACTION;
>
> but actually should be
>    p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));
>
> Another minor error seems a related typo in the calculation of `kcountsize`.
>
> This results in writing beyond the end of the allocated buffer when an
> added arc corresponds to a call near from the end of the monitored
> address range, since `_mcount()` check the incoming caller address for
> monitored range but not the intermediate result hash-like index that
> uses to write into the table.
>
> It should be noted that when the results are output to `gmon.out`, the
> table is read to the last element calculated from the allocated size in
> bytes, so the arcs stored outside the buffer boundary did not fall into
> `gprof` for analysis. Thus this "feature" help me to found this bug
> during working with https://sourceware.org/bugzilla/show_bug.cgi?id=29438
>
> Just in case, I will explicitly note that the problem breaks the
> `make test t=gmon/tst-gmon-dso` added for Bug 29438.
> There, the arc of the `f3()` call disappears from the output, since in
> the DSO case, the call to `f3` is located close to the end of the
> monitored range.
>
> Signed-off-by: Леонид Юрьев (Leonid Yuriev) <leo@yuriev.ru>
> ---
>  gmon/gmon.c | 4 ++--
>  1 file changed, 2 insertions(+), 2 deletions(-)
>
> diff --git a/gmon/gmon.c b/gmon/gmon.c
> index dee64803ad..4712d9f66b 100644
> --- a/gmon/gmon.c
> +++ b/gmon/gmon.c
> @@ -132,7 +132,7 @@ __monstartup (u_long lowpc, u_long highpc)
>    p->lowpc = ROUNDDOWN(lowpc, HISTFRACTION * sizeof(HISTCOUNTER));
>    p->highpc = ROUNDUP(highpc, HISTFRACTION * sizeof(HISTCOUNTER));
>    p->textsize = p->highpc - p->lowpc;
> -  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->froms));
> +  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->kcount));
>    p->hashfraction = HASHFRACTION;
>    p->log_hashfraction = -1;
>    /* The following test must be kept in sync with the corresponding
> @@ -142,7 +142,7 @@ __monstartup (u_long lowpc, u_long highpc)
>  	 instead of integer division.  Precompute shift amount. */
>        p->log_hashfraction = ffs(p->hashfraction * sizeof(*p->froms)) - 1;
>    }
> -  p->fromssize = p->textsize / HASHFRACTION;
> +  p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));
>    p->tolimit = p->textsize * ARCDENSITY / 100;
>    if (p->tolimit < MINARCS)
>      p->tolimit = MINARCS;

```

[Siddhesh Poyarekar](/project/glibc/list/?submitter=1946)
Feb. 7, 2023, 3:06 p.m. UTC |
[#2](/comment/137903/)

Addressed

Unaddressed

```

On 2023-02-04 06:41, Леонид Юрьев (Leonid Yuriev) wrote:
> The `__monstartup()` allocates a buffer used to store all the data
> accumulated by the monitor.
>
> The size of this buffer depends on the size of the internal structures
> used and the address range for which the monitor is activated, as well
> as on the maximum density of call instuctions and/or callable functions
> that could be potentially on a segment of executable code.
>
> In particular a hash table of arcs is placed at the end of this buffer.
> The size of this hash table is calculated in bytes as
>     p->fromssize = p->textsize / HASHFRACTION;
>
> but actually should be
>     p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));
>
> Another minor error seems a related typo in the calculation of `kcountsize`.
>
> This results in writing beyond the end of the allocated buffer when an
> added arc corresponds to a call near from the end of the monitored
> address range, since `_mcount()` check the incoming caller address for
> monitored range but not the intermediate result hash-like index that
> uses to write into the table.
>
> It should be noted that when the results are output to `gmon.out`, the
> table is read to the last element calculated from the allocated size in
> bytes, so the arcs stored outside the buffer boundary did not fall into
> `gprof` for analysis. Thus this "feature" help me to found this bug
> during working with https://sourceware.org/bugzilla/show_bug.cgi?id=29438
>
> Just in case, I will explicitly note that the problem breaks the
> `make test t=gmon/tst-gmon-dso` added for Bug 29438.
> There, the arc of the `f3()` call disappears from the output, since in
> the DSO case, the call to `f3` is located close to the end of the
> monitored range.
>
> Signed-off-by: Леонид Юрьев (Leonid Yuriev) <leo@yuriev.ru>

Adding a quick note here since this got raised as a security issue: this
is a bug, but I don't see any security impact here since the inputs that
cause this are trusted, coming from addresses of a profiled application.
We'll be rejecting this CVE.

I'll leave the actual patch review and fix incorporation to DJ, who has
volunteered to look at it.

Thanks,
Sid

```

[DJ Delorie](/project/glibc/list/?submitter=27)
Feb. 7, 2023, 10:12 p.m. UTC |
[#3](/comment/137924/)

Addressed

Unaddressed

```

›µ¾½¸´
®€Œµ² (Leonid Yuriev) <leo@yuriev.ru>
writes:
>    p->lowpc = ROUNDDOWN(lowpc, HISTFRACTION * sizeof(HISTCOUNTER));
>    p->highpc = ROUNDUP(highpc, HISTFRACTION * sizeof(HISTCOUNTER));
>    p->textsize = p->highpc - p->lowpc;
> -  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->froms));
> +  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->kcount));

I think the purpose here isn't to make sure the last entry fits, as that
it handled when lowpc and highpc are rounded.  I think the purpose here
is to make sure that the *next* portion of the buffer (p->froms) is
suitably aligned for its type.
> -  p->fromssize = p->textsize / HASHFRACTION;
> +  p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));

This part looks OK to me.

```

64295

[diff](/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/raw/ "Download patch diff")
[mbox](/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/mbox/ "Download patch mbox")
[series](/series/16752/mbox/ "Download patch mbox with dependencies")
## Patch

```

diff --git a/gmon/gmon.c b/gmon/gmon.c
index dee64803ad..4712d9f66b 100644
--- a/gmon/gmon.c
+++ b/gmon/gmon.c
@@ -132,7 +132,7 @@  __monstartup (u_long lowpc, u_long highpc)
   p->lowpc = ROUNDDOWN(lowpc, HISTFRACTION * sizeof(HISTCOUNTER));
   p->highpc = ROUNDUP(highpc, HISTFRACTION * sizeof(HISTCOUNTER));
   p->textsize = p->highpc - p->lowpc;
-  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->froms));
+  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->kcount));
   p->hashfraction = HASHFRACTION;
   p->log_hashfraction = -1;
   /* The following test must be kept in sync with the corresponding
@@ -142,7 +142,7 @@  __monstartup (u_long lowpc, u_long highpc)
 	 instead of integer division.  Precompute shift amount. */
       p->log_hashfraction = ffs(p->hashfraction * sizeof(*p->froms)) - 1;
   }
-  p->fromssize = p->textsize / HASHFRACTION;
+  p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));
   p->tolimit = p->textsize * ARCDENSITY / 100;
   if (p->tolimit < MINARCS)
     p->tolimit = MINARCS;

```

[patchwork](http://jk.ozlabs.org/projects/patchwork/) patch tracking system |
version v3.1.1.post23-gd11ea11 |
[about patchwork](/about/)



=== Content from patchwork.sourceware.org_0523b422_20250115_113333.html ===

Toggle navigation

[Patchwork](/)
GNU C Library (glibc)

* [Patches](/project/glibc/list/)
* [Bundles](/project/glibc/bundles/)
* [About this project](/project/glibc/)

* [Login](/user/login/)
* [Register](/register/)
* [Mail settings](/mail/)

64295

[diff](/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/raw/ "Download patch diff")
[mbox](/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/mbox/ "Download patch mbox")
[series](/series/16752/mbox/ "Download patch mbox with dependencies")
# gmon: Fix allocated buffer overflow (bug 2944)

| Message ID | 20230204114138.5436-1-leo@yuriev.ru ([mailing list archive](https://inbox.sourceware.org/libc-alpha/20230204114138.5436-1-leo%40yuriev.ru)) |
| --- | --- |
| State | Superseded |
| Delegated to: | DJ Delorie |
| Headers | show ``` Return-Path: <libc-alpha-bounces+patchwork=sourceware.org@sourceware.org> X-Original-To: patchwork@sourceware.org Delivered-To: patchwork@sourceware.org Received: from server2.sourceware.org (localhost [IPv6:::1]) 	by sourceware.org (Postfix) with ESMTP id 4D9743857B93 	for <patchwork@sourceware.org>; Sat,  4 Feb 2023 11:45:02 +0000 (GMT) X-Original-To: libc-alpha@sourceware.org Delivered-To: libc-alpha@sourceware.org Received: from forward105j.mail.yandex.net (forward105j.mail.yandex.net  [5.45.198.248])  by sourceware.org (Postfix) with ESMTPS id EEBDA3858C52  for <libc-alpha@sourceware.org>; Sat,  4 Feb 2023 11:44:47 +0000 (GMT) DMARC-Filter: OpenDMARC Filter v1.4.2 sourceware.org EEBDA3858C52 Authentication-Results: sourceware.org;  dmarc=none (p=none dis=none) header.from=yuriev.ru Authentication-Results: sourceware.org; spf=pass smtp.mailfrom=yuriev.ru Received: from myt5-fc73f9af8654.qloud-c.yandex.net  (myt5-fc73f9af8654.qloud-c.yandex.net  [IPv6:2a02:6b8:c12:2898:0:640:fc73:f9af])  by forward105j.mail.yandex.net (Yandex) with ESMTP id CA0414EC9D41;  Sat,  4 Feb 2023 14:42:04 +0300 (MSK) Received: by myt5-fc73f9af8654.qloud-c.yandex.net (smtp/Yandex) with ESMTPSA  id 3gXq2nuYUeA1-Wq7BS5Pl; Sat, 04 Feb 2023 14:42:04 +0300 X-Yandex-Fwd: 1 DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=yuriev.ru; s=mail;  t=1675510924; bh=LuWTLecar1PYenEgGzogYr2tcw5irV5ynX8LLQqxkiM=;  h=Message-Id:Date:Cc:Subject:To:From;  b=LgHZzbyfIP+mKyV23CMp5Yudx15MlDvMdzZ3ufTM7fP0E3+8jpH2ETixzpXt5Vu8/  +4SZgPBSjc0DOaMs7HzL89V9Z+Erq7w5G4ieN8UQEdJYfRoXHW+khJzjsRby+nyBsQ  vXJbOiK1iP88HzK3arWlYlgsUtqMotGzwKiC1Mls= Authentication-Results: myt5-fc73f9af8654.qloud-c.yandex.net;  dkim=pass header.i=@yuriev.ru From: =?utf-8?b?0JvQtdC+0L3QuNC0INCu0YDRjNC10LIgKExlb25pZCBZdXJpZXYp?=  <leo@yuriev.ru> To: libc-alpha@sourceware.org Cc: drepper.fsp@gmail.com, =?utf-8?b?0JvQtdC+0L3QuNC0INCu0YDRjNC10LIgKExl?= 	=?utf-8?b?b25pZCBZdXJpZXYp?= <leo@yuriev.ru> Subject: [PATCH] gmon: Fix allocated buffer overflow (bug 2944) Date: Sat,  4 Feb 2023 14:41:38 +0300 Message-Id: <20230204114138.5436-1-leo@yuriev.ru> X-Mailer: git-send-email 2.34.1 MIME-Version: 1.0 Content-Type: text/plain; charset=UTF-8 Content-Transfer-Encoding: 8bit X-Spam-Status: No, score=-10.3 required=5.0 tests=BAYES_00, BODY_8BITS,  DKIM_INVALID, DKIM_SIGNED, GIT_PATCH_0, KAM_DMARC_STATUS, RCVD_IN_MSPIKE_H2,  SPF_HELO_NONE, SPF_PASS autolearn=ham autolearn_force=no version=3.4.6 X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on  server2.sourceware.org X-BeenThere: libc-alpha@sourceware.org X-Mailman-Version: 2.1.29 Precedence: list List-Id: Libc-alpha mailing list <libc-alpha.sourceware.org> List-Unsubscribe: <https://sourceware.org/mailman/options/libc-alpha>,  <mailto:libc-alpha-request@sourceware.org?subject=unsubscribe> List-Archive: <https://sourceware.org/pipermail/libc-alpha/> List-Post: <mailto:libc-alpha@sourceware.org> List-Help: <mailto:libc-alpha-request@sourceware.org?subject=help> List-Subscribe: <https://sourceware.org/mailman/listinfo/libc-alpha>,  <mailto:libc-alpha-request@sourceware.org?subject=subscribe> Errors-To: libc-alpha-bounces+patchwork=sourceware.org@sourceware.org Sender: "Libc-alpha"  <libc-alpha-bounces+patchwork=sourceware.org@sourceware.org> ``` |
| Series | [gmon: Fix allocated buffer overflow (bug 2944)](/project/glibc/list/?series=16752) | expand   * gmon: Fix allocated buffer overflow (bug 2944) |

## Checks

| Context | Check | Description |
| --- | --- | --- |
| dj/TryBot-apply\_patch | success | Patch applied to master at the time it was sent |
| dj/TryBot-32bit | success | Build for i686 |

## Commit Message

[Леонид Юрьев (Leonid Yuriev)](/project/glibc/list/?submitter=36069)
Feb. 4, 2023, 11:41 a.m. UTC
```

  The `__monstartup()` allocates a buffer used to store all the data
accumulated by the monitor.

The size of this buffer depends on the size of the internal structures
used and the address range for which the monitor is activated, as well
as on the maximum density of call instuctions and/or callable functions
that could be potentially on a segment of executable code.

In particular a hash table of arcs is placed at the end of this buffer.
The size of this hash table is calculated in bytes as
   p->fromssize = p->textsize / HASHFRACTION;

but actually should be
   p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));

Another minor error seems a related typo in the calculation of `kcountsize`.

This results in writing beyond the end of the allocated buffer when an
added arc corresponds to a call near from the end of the monitored
address range, since `_mcount()` check the incoming caller address for
monitored range but not the intermediate result hash-like index that
uses to write into the table.

It should be noted that when the results are output to `gmon.out`, the
table is read to the last element calculated from the allocated size in
bytes, so the arcs stored outside the buffer boundary did not fall into
`gprof` for analysis. Thus this "feature" help me to found this bug
during working with https://sourceware.org/bugzilla/show_bug.cgi?id=29438

Just in case, I will explicitly note that the problem breaks the
`make test t=gmon/tst-gmon-dso` added for Bug 29438.
There, the arc of the `f3()` call disappears from the output, since in
the DSO case, the call to `f3` is located close to the end of the
monitored range.
Signed-off-by: Леонид Юрьев (Leonid Yuriev) <leo@yuriev.ru>
---
 gmon/gmon.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

```
## Comments

[Carlos O'Donell](/project/glibc/list/?submitter=3)
Feb. 7, 2023, 2:22 p.m. UTC |
[#1](/comment/137898/)

Addressed

Unaddressed

```

On 2/4/23 06:41, Леонид Юрьев (Leonid Yuriev) wrote:
> The `__monstartup()` allocates a buffer used to store all the data
> accumulated by the monitor.

I haven't reviewed this yet, but the bug number is "29444" and is incorrectly
written in the Subject line.

Thanks for posting this. We talked briefly about this patch during the Monday
patch review and we're trying to find a developer to review it.

> The size of this buffer depends on the size of the internal structures
> used and the address range for which the monitor is activated, as well
> as on the maximum density of call instuctions and/or callable functions
> that could be potentially on a segment of executable code.
>
> In particular a hash table of arcs is placed at the end of this buffer.
> The size of this hash table is calculated in bytes as
>    p->fromssize = p->textsize / HASHFRACTION;
>
> but actually should be
>    p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));
>
> Another minor error seems a related typo in the calculation of `kcountsize`.
>
> This results in writing beyond the end of the allocated buffer when an
> added arc corresponds to a call near from the end of the monitored
> address range, since `_mcount()` check the incoming caller address for
> monitored range but not the intermediate result hash-like index that
> uses to write into the table.
>
> It should be noted that when the results are output to `gmon.out`, the
> table is read to the last element calculated from the allocated size in
> bytes, so the arcs stored outside the buffer boundary did not fall into
> `gprof` for analysis. Thus this "feature" help me to found this bug
> during working with https://sourceware.org/bugzilla/show_bug.cgi?id=29438
>
> Just in case, I will explicitly note that the problem breaks the
> `make test t=gmon/tst-gmon-dso` added for Bug 29438.
> There, the arc of the `f3()` call disappears from the output, since in
> the DSO case, the call to `f3` is located close to the end of the
> monitored range.
>
> Signed-off-by: Леонид Юрьев (Leonid Yuriev) <leo@yuriev.ru>
> ---
>  gmon/gmon.c | 4 ++--
>  1 file changed, 2 insertions(+), 2 deletions(-)
>
> diff --git a/gmon/gmon.c b/gmon/gmon.c
> index dee64803ad..4712d9f66b 100644
> --- a/gmon/gmon.c
> +++ b/gmon/gmon.c
> @@ -132,7 +132,7 @@ __monstartup (u_long lowpc, u_long highpc)
>    p->lowpc = ROUNDDOWN(lowpc, HISTFRACTION * sizeof(HISTCOUNTER));
>    p->highpc = ROUNDUP(highpc, HISTFRACTION * sizeof(HISTCOUNTER));
>    p->textsize = p->highpc - p->lowpc;
> -  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->froms));
> +  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->kcount));
>    p->hashfraction = HASHFRACTION;
>    p->log_hashfraction = -1;
>    /* The following test must be kept in sync with the corresponding
> @@ -142,7 +142,7 @@ __monstartup (u_long lowpc, u_long highpc)
>  	 instead of integer division.  Precompute shift amount. */
>        p->log_hashfraction = ffs(p->hashfraction * sizeof(*p->froms)) - 1;
>    }
> -  p->fromssize = p->textsize / HASHFRACTION;
> +  p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));
>    p->tolimit = p->textsize * ARCDENSITY / 100;
>    if (p->tolimit < MINARCS)
>      p->tolimit = MINARCS;

```

[Siddhesh Poyarekar](/project/glibc/list/?submitter=1946)
Feb. 7, 2023, 3:06 p.m. UTC |
[#2](/comment/137903/)

Addressed

Unaddressed

```

On 2023-02-04 06:41, Леонид Юрьев (Leonid Yuriev) wrote:
> The `__monstartup()` allocates a buffer used to store all the data
> accumulated by the monitor.
>
> The size of this buffer depends on the size of the internal structures
> used and the address range for which the monitor is activated, as well
> as on the maximum density of call instuctions and/or callable functions
> that could be potentially on a segment of executable code.
>
> In particular a hash table of arcs is placed at the end of this buffer.
> The size of this hash table is calculated in bytes as
>     p->fromssize = p->textsize / HASHFRACTION;
>
> but actually should be
>     p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));
>
> Another minor error seems a related typo in the calculation of `kcountsize`.
>
> This results in writing beyond the end of the allocated buffer when an
> added arc corresponds to a call near from the end of the monitored
> address range, since `_mcount()` check the incoming caller address for
> monitored range but not the intermediate result hash-like index that
> uses to write into the table.
>
> It should be noted that when the results are output to `gmon.out`, the
> table is read to the last element calculated from the allocated size in
> bytes, so the arcs stored outside the buffer boundary did not fall into
> `gprof` for analysis. Thus this "feature" help me to found this bug
> during working with https://sourceware.org/bugzilla/show_bug.cgi?id=29438
>
> Just in case, I will explicitly note that the problem breaks the
> `make test t=gmon/tst-gmon-dso` added for Bug 29438.
> There, the arc of the `f3()` call disappears from the output, since in
> the DSO case, the call to `f3` is located close to the end of the
> monitored range.
>
> Signed-off-by: Леонид Юрьев (Leonid Yuriev) <leo@yuriev.ru>

Adding a quick note here since this got raised as a security issue: this
is a bug, but I don't see any security impact here since the inputs that
cause this are trusted, coming from addresses of a profiled application.
We'll be rejecting this CVE.

I'll leave the actual patch review and fix incorporation to DJ, who has
volunteered to look at it.

Thanks,
Sid

```

[DJ Delorie](/project/glibc/list/?submitter=27)
Feb. 7, 2023, 10:12 p.m. UTC |
[#3](/comment/137924/)

Addressed

Unaddressed

```

›µ¾½¸´
®€Œµ² (Leonid Yuriev) <leo@yuriev.ru>
writes:
>    p->lowpc = ROUNDDOWN(lowpc, HISTFRACTION * sizeof(HISTCOUNTER));
>    p->highpc = ROUNDUP(highpc, HISTFRACTION * sizeof(HISTCOUNTER));
>    p->textsize = p->highpc - p->lowpc;
> -  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->froms));
> +  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->kcount));

I think the purpose here isn't to make sure the last entry fits, as that
it handled when lowpc and highpc are rounded.  I think the purpose here
is to make sure that the *next* portion of the buffer (p->froms) is
suitably aligned for its type.
> -  p->fromssize = p->textsize / HASHFRACTION;
> +  p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));

This part looks OK to me.

```

64295

[diff](/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/raw/ "Download patch diff")
[mbox](/project/glibc/patch/20230204114138.5436-1-leo%40yuriev.ru/mbox/ "Download patch mbox")
[series](/series/16752/mbox/ "Download patch mbox with dependencies")
## Patch

```

diff --git a/gmon/gmon.c b/gmon/gmon.c
index dee64803ad..4712d9f66b 100644
--- a/gmon/gmon.c
+++ b/gmon/gmon.c
@@ -132,7 +132,7 @@  __monstartup (u_long lowpc, u_long highpc)
   p->lowpc = ROUNDDOWN(lowpc, HISTFRACTION * sizeof(HISTCOUNTER));
   p->highpc = ROUNDUP(highpc, HISTFRACTION * sizeof(HISTCOUNTER));
   p->textsize = p->highpc - p->lowpc;
-  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->froms));
+  p->kcountsize = ROUNDUP(p->textsize / HISTFRACTION, sizeof(*p->kcount));
   p->hashfraction = HASHFRACTION;
   p->log_hashfraction = -1;
   /* The following test must be kept in sync with the corresponding
@@ -142,7 +142,7 @@  __monstartup (u_long lowpc, u_long highpc)
 	 instead of integer division.  Precompute shift amount. */
       p->log_hashfraction = ffs(p->hashfraction * sizeof(*p->froms)) - 1;
   }
-  p->fromssize = p->textsize / HASHFRACTION;
+  p->fromssize = ROUNDUP(p->textsize / HASHFRACTION, sizeof(*p->froms));
   p->tolimit = p->textsize * ARCDENSITY / 100;
   if (p->tolimit < MINARCS)
     p->tolimit = MINARCS;

```

[patchwork](http://jk.ozlabs.org/projects/patchwork/) patch tracking system |
version v3.1.1.post23-gd11ea11 |
[about patchwork](/about/)


