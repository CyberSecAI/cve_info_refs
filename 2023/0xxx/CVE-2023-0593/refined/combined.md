=== Content from onekey.com_1bf7a314_20250114_190819.html ===
Ready for the New EU Cyber Resilience Act?[Learn More](/cra-readiness-assessment)

Solutions

Roles[Product Owner](/role/product-owner)[PSIRT Manager](/role/psirt-manager)[CTO/CIO](/role/cto-cio)[Head of Development](/role/head-of-development)[Product Compliance Manager](/role/product-compliance-manager)Use Cases[SBOM Management](/use-case/sbom-management)Industries[Manufacturing](/industry/manufacturing)[Automotive](/industry/automotive)[Medical](/industry/medical)[TELCO](/industry/telco)[Software Dev](/industry/software-dev)[Infrastructure](/industry/infrastructure)Product

ONEKEY PlatformYour All-in-One Cybersecurity and Compliance Solution[Platform Overview](/platform-overview)Features[SBOM Management](/feature/sbom-management)[Impact Assessment](/feature/automated-impact-assessment) [Vulnerability Analysis](/feature/automated-vulnerability-analysis)[Compliance Wizard](/feature/compliance-wizard)[Zero-Day Detection](/feature/zero-day-detection)[Monitoring](/feature/monitoring)[License Detection](/feature/license)[Custom Analysis Profiles](/feature/profiles)[![ONEKEY 360Â° Comprehensive Product Cybersecurity & Compliance](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0d8/67121fed08268feb9f6b269b_whitepaperhero.avif)![](https://cdn.prod.website-files.com/plugins/Basic/assets/placeholder.60f9b1840c.svg)WhitepapersSep 1, 2024ONEKEY 360Â° Comprehensive Product Cybersecurity & Compliance](/resource/onekey-360deg-comprehensive-product-cybersecurity-compliance)[Expert Consulting](/expert-consulting)Resources

ONEKEY ResourcesAll our resources combined in one place[Resources](/resources)Resources[Blog](/resources/blog)[Research](/resources/research)[Success Stories](/resources/success-stories)[Events](/resources/events)[Whitepapers](/resources/whitepapers)[FAQs](/faq)[![Critical Vulnerabilities in EV Charging Stations: Analysis of eCharge Controllers](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0d8/6745b8752e1c64e8087e6d40_AdobeStock_847826864%20(1)%201.avif)![](https://cdn.prod.website-files.com/plugins/Basic/assets/placeholder.60f9b1840c.svg)ResearchNov 26, 2024Critical Vulnerabilities in EV Charging Stations: Analysis of eCharge Controllers](/resource/critical-vulnerabilities-in-ev-charging-stations-analysis-of-echarge-controllers)Company

[About Us](/about-us)[Careers](/careers)[Contact](/contact)[Newsletter](/newsletter)[Press Release](/press-releases)[![Cyber Resilience Act bans products with known vulnerabilities](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0d8/671b822e403bdc2f3221d575_6712ae1b7f657cc8b66be3ee_02.jpeg)Press ReleaseJun 6, 2024Cyber Resilience Act bans products with known vulnerabilities](/press-release/cyber-resilience-act-bans-products-with-known-vulnerabilities)[Book a Demo](/book-a-demo)[Book a Demo](/book-a-demo)

[Resources](/resources)>[Research](/resources/research)>Security Advisory: Remote Command Execution in binwalk
# Security Advisory: Remote Command Execution in binwalk

![Security Advisory: Remote Command Execution in binwalk](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0d8/671b823006e95c450f5618ef_6712aebc0c7fcf8155cb3fc0_18.jpeg)![](https://cdn.prod.website-files.com/plugins/Basic/assets/placeholder.60f9b1840c.svg)January 30, 20237Â min readTablE of contentsExample H2
## READY TO UPGRADE YOUR RISK MANAGEMENT?

Make cybersecurity and compliance efficient and effective with ONEKEY.

[Book a Demo](/book-a-demo)
## Introduction

Before we dive into the technical details, we want to raise our hats to the teams behind [binwalk](https://github.com/ReFirmLabs/binwalk/), [ubi\_reader](https://github.com/jrspruitt/ubi_reader), [jefferson](https://github.com/sviehb/jefferson), and [yaffshiv](https://github.com/devttys0/yaffshiv) and express our respect and admiration for the work they put into it over the years and all their contributions towards the security community. Without them, and many other great projects, security analysis of IoT devices would not be where it is today. With the fading maintenance of binwalk, we too were inspired to contribute to the security community and open source our internal extraction framework [unblob](https://www.unblob.org). Our objective with this blog is to summarize some of the pitfalls when dealing with untrusted data and to raise awareness about path traversal security issues and the impact they may have.

With that being out of the way, let's dive in !

As detailed in my Black Alps talk, we audited multiple third-party extractors code base that unblob relies on over the summer of 2022 and identified multiple issues ranging from logic bugs leading to extraction failures to path traversals. In the process, I learned a lot about [the many different ways you can end up with a path traversal in Python](#bonus).

Around October 2022, I had the realization that if all those third-party dependencies are suffering from some variation of these insecure coding patterns, binwalk may be too. So, I started looking and soon enough found a path traversal within the PFS filesystem extractor. I then found a way to gain remote code execution by abusing binwalk's plugin system over lunch at [hardwear.io](https://hardwear.io/) with [MÃ¼cahid](https://twitter.com/muc0ze).

As explained in the [pull request](https://github.com/ReFirmLabs/binwalk/pull/617) I sent on October 26th, I took the liberty to report [it] in the open since [#556](https://github.com/ReFirmLabs/binwalk/pull/556) was fixed that way and I did not find any security/coordinated disclosure policy or contact info. At the time of publication, the vulnerability has yet to be patched.

## Path Traversal in Binwalk

| **Affected vendor & product** | Refirm Labs binwalk |
| --- | --- |
| **Vendor Advisory** | None at this time. |
| **Vulnerable version** | 2.1.2b through 2.3.3 included |
| **Fixed version** | None at this time. |
| **CVE IDs** | [CVE-2022-4510](https://nvd.nist.gov/vuln/detail/CVE-2022-4510) |
| **Impact (CVSS)** | 7.8 (high) [AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H&version=3.1) |
| **Credit** | Q. Kaiser, ONEKEY Research Lab |

## Summary

A path traversal vulnerability was identified in ReFirm Labs binwalk from version 2.1.2b through 2.3.3 (inclusive). This vulnerability allows remote attackers to execute arbitrary code on affected installations of binwalk. User interaction is required to exploit this vulnerability in that the target must open the malicious file with binwalk using extract mode (`-e` option).

## The bug

PFS is an obscure filesystem format found in some embedded devices. The only public documentation comes from a tool named [pfstool](https://lekensteyn.nl/files/pfs/pfs.txt) written by Peter Lekensteyn.

A PFS extractor plugin was merged into binwalk in 2017 with commit [d023454](https://github.com/ReFirmLabs/binwalk/commit/d023454), and a path traversal mitigation attempt was introduced with commit [58d1d92](https://github.com/ReFirmLabs/binwalk/commit/58d1d92) on the same day. This commit introduced the following change:

```
     def extractor(self, fname):
         fname = os.path.abspath(fname)
+        out_dir = binwalk.core.common.unique_file_name(os.path.join(os.path.dirname(fname), "pfs-root"))
+
         try:
             with PFS(fname) as fs:
                 # The end of PFS meta data is the start of the actual data
-                data = open(fname, 'rb')
+                data = binwalk.core.common.BlockFile(fname, 'rb')
                 data.seek(fs.get_end_of_meta_data())
                 for entry in fs.entries():
-                    self._create_dir_from_fname(entry.fname)
-                    outfile = open(entry.fname, 'wb')
-                    outfile.write(data.read(entry.fsize))
-                    outfile.close()
+                    outfile_path = os.path.join(out_dir, entry.fname)
+                    if not outfile_path.startswith(out_dir): # this branch will never be taken
+                        binwalk.core.common.warning("Unpfs extractor detected directory traversal attempt for file: '%s'. Refusing to extract." % outfile_path)
+                    else:
+                        self._create_dir_from_fname(outfile_path)
+                        outfile = binwalk.core.common.BlockFile(outfile_path, 'wb')
+                        outfile.write(data.read(entry.fsize))
+                        outfile.close()
                 data.close()
         except KeyboardInterrupt as e:
             raise e

```

The issue lies in the fact that `os.path.join` one line 16 does not fully resolve a path. Therefore, the condition on line 17 will never be true. Here's an example of that behavior:

```
>>> os.path.join("/tmp", "../etc/passwd")
'/tmp/../etc/passwd'
>>> os.path.abspath(os.path.join("/tmp", "../etc/passwd"))
'/etc/passwd'
```

By crafting a valid PFS filesystem with filenames containing the `../` traversal sequence, we can force binwalk to write files **outside** of the extraction directory.

## Our fix

Our fix simply introduce a call to `os.path.abspath` on line 8 so that the built path is fully resolved.

```
--- a/src/binwalk/plugins/unpfs.py
+++ b/src/binwalk/plugins/unpfs.py
@@ -104,7 +104,7 @@ class PFSExtractor(binwalk.core.plugin.Plugin):
                 data = binwalk.core.common.BlockFile(fname, 'rb')
                 data.seek(fs.get_end_of_meta_data())
                 for entry in fs.entries():
-                    outfile_path = os.path.join(out_dir, entry.fname)
+                    outfile_path = os.path.abspath(os.path.join(out_dir, entry.fname))
                     if not outfile_path.startswith(out_dir):
                         binwalk.core.common.warning("Unpfs extractor detected directory traversal attempt for file: '%s'. Refusing to extract." % outfile_path)
                     else:

```

## Exploitation Strategy

There are plenty of ways to get remote command execution from a path traversal (e.g., by overwriting `.ssh/authorized_keys` to obtain password-less SSH access, overwrite `~/.bashrc` to execute arbitrary commands on the next login), but I wanted something that was environment agnostic and relied on what's already there. **Enter binwalk plugins**.

Since the early days of binwalk, users have the ability to define their own plugins using binwalk's API. As [indicated in the documentation](https://github.com/ReFirmLabs/binwalk/wiki/Creating-Custom-Plugins#plugin-activation):

"*Activating a plugin is as simple as dropping it in binwalk's plugin directory $HOME/.config/binwalk/plugins/. The plugin will then be loaded on all subsequent binwalk scans.*"

So, if we exploit the path traversal to write a valid plugin at that location, binwalk will immediately pick it up and execute it **while it's still scanning the malicious file**. On top of that, the PFS extractor will take care of creating all required directories if they do not exist, so we don't need to expect anything from the system we're running on.

This is the plugin I ended up writing. The plugin executes two times since it does not define an explicit `MODULE` attribute that defines its purpose (e.g., signature scan, entropy calculation, compression stream identification). I take advantage of that behavior to make it clean up after itself.

```
import binwalk.core.plugin
import os
import shutil

class MaliciousExtractor(binwalk.core.plugin.Plugin):
    """
    Malicious binwalk plugin
    """

    def init(self):
        if not os.path.exists("/tmp/.binwalk"):
            os.system("id")
            with open("/tmp/.binwalk", "w") as f:
                f.write("1")
        else:
            os.remove("/tmp/.binwalk")
            os.remove(os.path.abspath(__file__))
            shutil.rmtree(os.path.join(os.path.dirname(os.path.abspath(__file__)), "__pycache__"))

```

Crafting malicious PFS file is left as an exercise to the reader.

## Demo

Here's a video demo of the exploit:

## Future Work

The ["D-Link RomFS" plugin](https://github.com/ReFirmLabs/binwalk/blob/master/src/binwalk/plugins/dlromfsextract.py) is probably affected by a similar vulnerability but the format, which is actually eCOS RomFS, is not parsed properly (see this [PR](https://github.com/ReFirmLabs/binwalk/pull/456) for a fix). I did not want to load two opposing format constructs in my brain just to come up with a proof-of-concept. As a former colleague of mine would have said: CBA.

## Key Takeaways

As security industry, every now and then, we need to look in the mirror and also validate the security of our own technology stack. This especially becomes critical in forensic analysis and reverse engineering where we are commonly faced with untrusted, potentially malicious files.

While the path traversals described in this article have the potential to void any reverse engineering efforts and to tamper with evidence collected, they also demonstrate the importance of sandboxing analysis environments to limit the impact of such vulnerabilities. Especially with the rise of automated extraction and analysis tools relying on tools like binwalk (e.g., FACT, ofrak, EMBA), it's important for developers and users of those solution to be aware of the risks.

## Timeline

**2022-10**-**24** - Attempt to get in touch with Refirm Labs but no security policies and domains are down.

**2022-10-26** â Decided to send a pull request with the fix (<https://github.com/ReFirmLabs/binwalk/pull/617>) so that it could be immediately integrated.

**2022-11-17** â Live demo of the exploit during our talk at Black Alps.

**2023-01-24** â Since the CPE of the latest binwalk vulnerability states `microsoft:binwalk` and that Refirm Labs got [acquired in 2021](https://www.microsoft.com/en-us/security/blog/2021/06/02/microsoft-acquires-refirm-labs-to-enhance-iot-security/), we reported it to MSRC. Turns out MSRC does not consider it a Microsoft product and the CPE was chosen this way by [VulDB](https://vuldb.com/).

**2023-01-25** â Since we're a CNA and we're not seeing any movement on the repository, we take the decision to create a dedicated CVE so that users are aware of this.

**2023-01-31** â ONEKEY releases its advisory

---

## Python Path Traversal Code Patterns

All of the code examples provided below are illustrations of the insecure code patterns observed in the affected projects. You can click on the link provided in each description to open the pull request highlighting the actual code.

### ubi\_reader - **no path traversal verification at all**

| **Affected vendor & product** | jrspruitt:ubi\_reader |
| --- | --- |
| **Vulnerable version** | < 0.8.5 |
| **Fixed version** | 0.8.5 |
| **CVE IDs** | [CVE-2023-0591](https://nvd.nist.gov/vuln/detail/CVE-2023-0591) |
| **Impact (CVSS)** | 5.5 (medium) [AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N&version=3.1) |
| **Credit** | Q. Kaiser, ONEKEY Research Lab |

As seen in [ubi\_reader](https://github.com/jrspruitt/ubi_reader/pull/57/files), the code does not attempt to protect against traversal.

```
import os
extraction_dir = "/tmp"

for filename in filenames:
    extraction_path = os.path.join(extraction_dir, filename)
```

### **jefferson - no path traversal verification at all**

| **Affected vendor & product** | sviehb:jefferson |
| --- | --- |
| **Vulnerable version** | < 0.4.1 |
| **Fixed version** | 0.4.1 |
| **CVE IDs** | [CVE-2023-0592](https://nvd.nist.gov/vuln/detail/CVE-2023-0592) |
| **Impact (CVSS)** | 5.5 (medium) [AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N&version=3.1) |
| **Credit** | Q. Kaiser, ONEKEY Research Lab |

Similar but not the same signature, observed in [Jefferson](https://github.com/sviehb/jefferson/pull/36/files).

```
import os
extraction_dir = "/tmp"

for filename in filenames:
    extraction_path = os.path.join(os.getcwd(), extraction_dir, path)
```

### **yaffshiv - misunderstanding os.path.join's argument precedence**

| **Affected vendor & product** | devttys0:yaffshiv |
| --- | --- |
| **Vulnerable version** | <= 0.1 |
| **Fixed version** | None |
| **CVE IDs** | [CVE-2023-0593](https://nvd.nist.gov/vuln/detail/CVE-2023-0592) |
| **Impact (CVSS)** | 5.5 (medium) [AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N&version=3.1) |
| **Credit** | Q. Kaiser, ONEKEY Research Lab |

The code makes the assumption that `filename` does not start with a forward slash. Observed in [yaffshiv](https://github.com/devttys0/yaffshiv/pull/3/files).

```
import os
extraction_dir = "/tmp"

for filename in filenames:
    file_path = os.path.join(extraction_dir, filename)
    if b'..' in file_path:
        raise Exception("Path traversal attempt, aborting.")
```

The second argument of `os.path.join` always takes precedence if both of them starts with a forward slash.

```
>>> os.path.join("/tmp", "home/traversal")
'/tmp/home/traversal'
>>> os.path.join("/tmp", "/home/traversal")
'/home/traversal'
```

### **binwalk's unpfs - **misunderstanding os.path.join's lack of resolution****

The code makes the assumption that `os.path.join` returns an absolute path, which it doesn't.

```
import os
extraction_dir = "/tmp"

for filename in filenames:
    outfile_path = os.path.join(extraction_dir, filename)
    if not outfile_path.startswith(extraction_dir ): # this condition will never be True
        raise Exception("Path traversal attempt, aborting.")
```

This is what it looks like:

```
>>> os.path.join("/tmp", "../etc/passwd")
'/tmp/../etc/passwd'
>>> os.path.abspath(os.path.join("/tmp", "../etc/passwd"))
'/etc/passwd'
```
Share
## About Onekey

[ONEKEY](/) is the leading European specialist in Product Cybersecurity & Compliance Management and part of the investment portfolio of [PricewaterhouseCoopers Germany (PwC)](https://www.pwc.de/de.html). The unique combination of an automated Product Cybersecurity & Compliance Platform (PCCP) with expert knowledge and consulting services provides fast and comprehensive analysis, support, and management to improve product cybersecurity and compliance from product purchasing, design, development, production to end-of-life.

![](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0cd/67583204f930179edfad5cb3_2024-09%20ONEKEY-TEAM_Mallorca.avif)

CONTACT:

euromarcom public relations GmbH
+49 611 973 150
team@euromarcom.de

## RELATED RESEARCH ARTICLES

![Unblob 2024 Highlights: Sandboxing, Reporting, and Community Milestones](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0d8/675192012562197008d3c477_Image%20Frame%20124.avif)ResearchDec 5, 202410Â min read
### Unblob 2024 Highlights: Sandboxing, Reporting, and Community Milestones

Explore the latest developments in Unblob, including enhanced sandboxing with Landlock, improved carving reporting, and ÏÂ² randomness analysis. Celebrate community contributions, academic research collaborations, and new format handlers, while looking forward to exciting updates in 2025.

[Read More](/resource/unblob-2024-highlights-sandboxing-reporting-and-community-milestones)![Critical Vulnerabilities in EV Charging Stations: Analysis of eCharge Controllers](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0d8/6745b8752e1c64e8087e6d40_AdobeStock_847826864%20(1)%201.avif)ResearchNov 26, 202420Â min read
### Critical Vulnerabilities in EV Charging Stations: Analysis of eCharge Controllers

Discover how severe security flaws, including unauthenticated remote command execution (CVE-2024-11665 & CVE-2024-11666), affect eCharge EV charging controllers. Learn about insecure firmware practices, cloud infrastructure issues, and actionable steps to mitigate risks in EV charging systems.

[Read More](/resource/critical-vulnerabilities-in-ev-charging-stations-analysis-of-echarge-controllers)![Security Advisory: Unauthenticated Command Injection in Mitel IP Phones](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0d8/67209c8a2e0431878267653a_AdobeStock_493462234.jpeg)ResearchNov 17, 202415Â min read
### Security Advisory: Unauthenticated Command Injection in Mitel IP Phones

Discover critical vulnerabilities in Mitel SIP phones that allow unauthenticated command injection. Learn how outdated input parsing can expose your devices and why it's essential to scan firmware for security risks. Protect your network with our in-depth analysis and expert takeaways.

[Read More](/resource/security-advisory-unauthenticated-command-injection-in-mitel-ip-phones)
## Ready to automate your Product Cybersecurity & Compliance?

Make cybersecurity and compliance efficient and effective withÂ ONEKEY.

[Book a Demo](/book-a-demo)

![onekey logo](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0cd/66ec7d83c10fbfa879b33dd9_ONEKEY_Logo_Neon.svg)Solutions[Product Owner](/role/product-owner)[PSIRT Manager](/role/psirt-manager)[CTO/CIO](/role/cto-cio)[Head of Development](/role/head-of-development)[Product Compliance Manager](/role/product-compliance-manager)[SBOM Management](/use-case/sbom-management)Product[Platform Overview](/platform-overview)[SBOM Management](/feature/sbom-management)[Impact Assessment](/feature/automated-impact-assessment) [Vulnerability Analysis](/feature/automated-vulnerability-analysis) [Compliance Wizard](/feature/compliance-wizard)[Zero-Day Detection](/feature/zero-day-detection)[Monitoring](/feature/monitoring)[License Detection](/feature/license)[Custom Analysis Profiles](/feature/profiles)Industries[Manufacturing](/industry/manufacturing)[Automotive](/industry/automotive)[Medical](/industry/medical)[Telco](/industry/telco)[Software Dev](/industry/software-dev)[Infrastructure](/industry/infrastructure)Resources[Blog](/resources/blog)[Research](/resources/research)[Success Stories](/resources/success-stories)[Events](/resources/events)[Whitepapers](/resources/whitepapers)[FAQs](/faq)Company[About Us](/about-us)[Careers](/careers)[Contact](/contact)[Newsletter](/newsletter)[Press Releases](/press-releases)Social[LinkedIn](https://www.linkedin.com/company/onekey-sec/)[Twitter (X)](https://x.com/onekey_sec)

[Privacy policy](/privacy-policy)[Impressum](/imprint)[Responsible Disclosure Policy](/responsible-disclosure-policy)![Security logo](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0cd/66fe7e9c52cda15bb54ea28e_Frame%201000003145.png)![Allianz logo](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0cd/66fe7e9d773dfd7f6acbffc5_Frame%201000003146.avif)![Cybersecurity Made In Europe logo](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0cd/66fe7e9d6e4f46bc39d692ea_Frame%201000003144.avif)![ECSO logo](https://cdn.prod.website-files.com/66e0617dd66a9d24cea2d0cd/66fe7e9d1b01b2cbe0045cea_Frame%201000003152.avif)ONEKeY 2024



=== Content from github.com_aa0dc7e9_20250114_190818.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdevttys0%2Fyaffshiv%2Fpull%2F3%2Ffiles)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdevttys0%2Fyaffshiv%2Fpull%2F3%2Ffiles)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow%2Ffiles&source=header-repo&source_repo=devttys0%2Fyaffshiv)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[devttys0](/devttys0)
/
**[yaffshiv](/devttys0/yaffshiv)**
Public

* [Notifications](/login?return_to=%2Fdevttys0%2Fyaffshiv) You must be signed in to change notification settings
* [Fork
  24](/login?return_to=%2Fdevttys0%2Fyaffshiv)
* [Star
   45](/login?return_to=%2Fdevttys0%2Fyaffshiv)

* [Code](/devttys0/yaffshiv)
* [Issues
  2](/devttys0/yaffshiv/issues)
* [Pull requests
  2](/devttys0/yaffshiv/pulls)
* [Actions](/devttys0/yaffshiv/actions)
* [Projects
  0](/devttys0/yaffshiv/projects)
* [Security](/devttys0/yaffshiv/security)
* [Insights](/devttys0/yaffshiv/pulse)

Additional navigation options

* [Code](/devttys0/yaffshiv)
* [Issues](/devttys0/yaffshiv/issues)
* [Pull requests](/devttys0/yaffshiv/pulls)
* [Actions](/devttys0/yaffshiv/actions)
* [Projects](/devttys0/yaffshiv/projects)
* [Security](/devttys0/yaffshiv/security)
* [Insights](/devttys0/yaffshiv/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fdevttys0%2Fyaffshiv%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fdevttys0%2Fyaffshiv%2Fissues%2Fnew%2Fchoose)
to your account

# Fix path traversal #3

 Merged

[devttys0](/devttys0)
merged 3 commits into
[devttys0:master](/devttys0/yaffshiv/tree/master "devttys0/yaffshiv:master")
from
[onekey-sec:fix-path-traversal](/onekey-sec/yaffshiv/tree/fix-path-traversal "onekey-sec/yaffshiv:fix-path-traversal")

Aug 30, 2024

[Conversation
1](/devttys0/yaffshiv/pull/3)
[Commits
3](/devttys0/yaffshiv/pull/3/commits)
[Checks
0](/devttys0/yaffshiv/pull/3/checks)
[Files changed](/devttys0/yaffshiv/pull/3/files)

 Merged

# [Fix path traversal](#top) #3

 Changes from **all commits**

Commits

[Show all changes

3 commits](/devttys0/yaffshiv/pull/3/files)
Select commit
Hold shift + click to select a range

[`d9488f1`
Do not fail if the output directory already exists.

qkaiser Jan 13, 2022](/devttys0/yaffshiv/pull/3/commits/d9488f1dcf086c10ff1a746e9e4469cd715ef3fe)
[`24e6e45`
Merge pull request #1 from IoT-Inspector/fix-force-overwrite

qkaiser Jan 13, 2022](/devttys0/yaffshiv/pull/3/commits/24e6e453a36a02144ae2d159eb3229f9c6312828)
[`579514b`
Fix path traversal issue.

qkaiser Nov 2, 2022](/devttys0/yaffshiv/pull/3/commits/579514b23c9c72f4bc4afebb848008e5f2e12e84)

**File filter**

### Filter by extension

Filter by extension

No extension
(1)

All 1 file type selected

---

Viewed files

[Clear filters](/devttys0/yaffshiv/pull/3/files)

 **Conversations**

Failed to load comments.  Retry

 Loading

 **Jump to**

Jump to file

Failed to load files.  Retry

 Loading

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Show whitespace

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

## There are no files selected for viewing

22 changes: 14 additions & 8 deletions

22
[src/yaffshiv](#diff-84f84662c7d0762f001050d6405b51cf2ff41df4cb142100ef99e79512683460 "src/yaffshiv")

Show comments

[View file](/onekey-sec/yaffshiv/blob/579514b23c9c72f4bc4afebb848008e5f2e12e84/src/yaffshiv)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -5,6 +5,11 @@ import sys |
|  |  | import struct |
|  |  | import string |
|  |  |  |
|  |  | def is\_safe\_path(basedir, path): |
|  |  | matchpath = os.path.realpath(path) |
|  |  | return basedir == os.path.commonpath((basedir, matchpath)) |
|  |  |  |
|  |  |  |
|  |  | class Compat(object): |
|  |  | ''' |
|  |  | Python2/3 compatability methods. |
| Expand Down  Expand Up | | @@ -607,13 +612,14 @@ class YAFFSExtractor(YAFFS): |
|  |  | for (entry\_id, file\_path) in Compat.iterator(self.file\_paths): |
|  |  | entry = self.file\_entries[entry\_id] |
|  |  | if file\_path and int(entry.yaffs\_obj\_type) == self.YAFFS\_OBJECT\_TYPE\_DIRECTORY: |
|  |  | file\_path = os.path.join(outdir, file\_path) |
|  |  |  |
|  |  | # Check the file name for possible path traversal attacks |
|  |  | if b'..' in file\_path: |
|  |  | if not is\_safe\_path(outdir, file\_path): |
|  |  | sys.stderr.write("Warning: Refusing to create directory '%s': possible path traversal\n" % file\_path) |
|  |  | continue |
|  |  |  |
|  |  | try: |
|  |  | file\_path = os.path.join(outdir, file\_path) |
|  |  | os.makedirs(file\_path) |
|  |  | self.\_set\_mode\_owner(file\_path, entry) |
|  |  | dir\_count += 1 |
| Expand All | | @@ -623,12 +629,13 @@ class YAFFSExtractor(YAFFS): |
|  |  | # Create files, including special device files |
|  |  | for (entry\_id, file\_path) in Compat.iterator(self.file\_paths): |
|  |  | if file\_path: |
|  |  | file\_path = os.path.join(outdir, file\_path) |
|  |  |  |
|  |  | # Check the file name for possible path traversal attacks |
|  |  | if b'..' in file\_path: |
|  |  | if not is\_safe\_path(outdir, file\_path): |
|  |  | sys.stderr.write("Warning: Refusing to create file '%s': possible path traversal\n" % file\_path) |
|  |  | continue |
|  |  |  |
|  |  | file\_path = os.path.join(outdir, file\_path) |
|  |  | entry = self.file\_entries[entry\_id] |
|  |  | if int(entry.yaffs\_obj\_type) == self.YAFFS\_OBJECT\_TYPE\_FILE: |
|  |  | try: |
| Expand All | | @@ -651,13 +658,12 @@ class YAFFSExtractor(YAFFS): |
|  |  | entry = self.file\_entries[entry\_id] |
|  |  |  |
|  |  | if file\_path: |
|  |  | dst = os.path.join(outdir, file\_path) |
|  |  | # Check the file name for possible path traversal attacks |
|  |  | if b'..' in file\_path: |
|  |  | if not is\_safe\_path(outdir, dst): |
|  |  | sys.stderr.write("Warning: Refusing to create link file '%s': possible path traversal\n" % file\_path) |
|  |  | continue |
|  |  |  |
|  |  | dst = os.path.join(outdir, file\_path) |
|  |  |  |
|  |  | if int(entry.yaffs\_obj\_type) == self.YAFFS\_OBJECT\_TYPE\_SYMLINK: |
|  |  | src = entry.alias |
|  |  | try: |
| Expand Down  Expand Up | | @@ -775,7 +781,7 @@ def main(): |
|  |  |  |
|  |  | if out\_dir: |
|  |  | try: |
|  |  | os.makedirs(out\_dir) |
|  |  | os.makedirs(out\_dir, exist\_ok=True) |
|  |  | except Exception as e: |
|  |  | sys.stderr.write("Failed to create output directory: %s\n" % str(e)) |
|  |  | sys.exit(1) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


