=== Content from gitlab.com_32d4a268_20250114_232645.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Arbitrary HTML injection possible when :soft\_email\_confirmation feature flag is enabled in the latest release

**[HackerOne report #1842867](https://hackerone.com/reports/1842867)** by `cryptopone` on 2023-01-22, assigned to `GitLab Team`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

In the GitLab 15.8.0 release, changes have been made to <https://gitlab.com/gitlab-org/gitlab/-/blob/01cc3a3b45cafda62ea8bc82d5c52278890d8ec8/app/controllers/concerns/confirm_email_warning.rb> that includes adding .html\_safe to the flash warning. This code is vulnerable on self-managed instances when the :soft\_email\_confirmation feature flag is enabled on the instance. (**GitLab team:** Note the .html\_safe was part of the original implementation so this issue persists in releases prior to 15.8 and the fixes should be backported to 15.7 and 15.6 accordingly)

```
  def set_confirm_warning
    return unless current_user
    return if current_user.confirmed?

    email = current_user.unconfirmed_email || current_user.email

    flash.now[:warning] = format(
      confirm_warning_message,
      email: email,
      resend_link: view_context.link_to(_('Resend it'), user_confirmation_path(user: { email: email }), method: :post),
      update_link: view_context.link_to(_('Update it'), profile_path)
    ).html_safe
  end
```

A malicious user could register an account using an email containing html tags, and these tags will now render in the flash message once the user logs into their account.

Normally this would be considered a self-xss. But if an administrator impersonates the attacker's account, the html/payload will be rendered for the administrator as well. It's also worth noting the additional HTML tags are not visible on the administrator page for the attacker user, so the admin will be unaware of the potential danger of impersonating the account.

Note: This appears to only affect self-managed instances as GitLab.com does not use this feature flag. No CSP bypass is provided at the time this report is filed as GDK is using 'strict-dynamic' which I have been unable to bypass thus far. I found a bypass for source code installs of GitLab with the default CSP set (doesn't use 'strict-dynamic') but I assume GDK is the CSP policy to be testing against.

##### Steps to reproduce

###### Prerequisites:

1. Enable the feature flag :soft\_email\_confirmation on the GitLab instance. (ex. Run `gitlab-rails console` then execute `Feature.enable(:soft_email_confirmation)` inside the rails console).
2. Go to the Admin general settings page (<http://gitlab.example.com/admin/application_settings/general>).
3. Expand sign-up restrictions and set "Email confirmation settings" to "Hard".
4. Save the changes.

###### Reproduction Steps (Attacker):

1. Register an account on the instance. (ex. Username: AttackerSoftEmail, Email: attackersoftemail@example.com)
2. Log into the account. You should now see a message at the top of the screen stating "Please check your email (attackersoftemail@example.com) to verify that you own this address and unlock the power of CI/CD. Didn't receive it? Resend it. Wrong email address? Update it."
3. Go to the user's profile (<http://gitlab.example.com/-/profile>)
4. Change your e-mail by appending `<h2>testing</h2><script>alert(document.domain)</script>` to the end of the address.
5. Save the changes.
6. Each time the page reloads, you will see a javascript alert fire.

###### Reproduction Steps (Victim Administrator):

1. Log into GitLab as root.
2. Navigate to the Admin users panel and select the AttackerSoftEmail user (<http://gitlab.example.com/admin/users/AttackerSoftEmail>).
3. Note the email address for AttackerSoftEmail does not contain HTML.
4. Click the "Impersonate" button to begin impersonating the user.
5. Note the javascript fires as the page is loaded.
6. Close the alert box, and see the HTML header tag rendered as the page loads.

##### Impact

Administrators on self-managed instances impersonating the attacker's account will inadvertently trigger XSS if the attacker has not validated their email and :soft\_email\_confirmation feature flag is enabled on an instance that requires email confirmations upon registration.

The Administrator is not made aware of the HTML payload contained in the attacker's email address when viewing the attacker's profile from the administrator user page.

##### Examples

N/A

##### What is the current *bug* behavior?

XSS is triggered within context of the self-hosted GitLab instance.

##### What is the expected *correct* behavior?

HTML code appended to the email address should not be rendered by the browser when users are presented with the soft email confirmation alert.

##### Relevant logs and/or screenshots

Attacker updates email address containing HTML payload.

[![AttackerWithHTMLTagsInUpdatedEmail.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/31359fc13ef0a67e5596ccc518800b1b830258bd/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f39393739643330632d363966312d346663312d626334322d3433626430643562623637342f41747461636b65725769746848544d4c54616773496e55706461746564456d61696c2e706e67)

Administrator views the attacker's account in the admin user menu. Note the page does not display the HTML included in the attacker email.

[![AdministratorViewingUserProfileWithoutSeeingEmailTags.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/a5b42e590f41223c8fe8f2e6c8443f9695c215cf/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34346466313866662d376335382d343632612d383539372d3431323361623433323336642f41646d696e6973747261746f7256696577696e675573657250726f66696c65576974686f7574536565696e67456d61696c546167732e706e67)

As soon as the administrator impersonates the user they trigger the XSS payload.

[![AdministratorImpersonatingUserTriggeringXSS.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/e6bc8bdb2a9c66c112f4111704f8e3813a2b3077/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32353166626132662d353964392d343739302d613335632d6434666235633739333533362f41646d696e6973747261746f72496d706572736f6e6174696e675573657254726967676572696e675853532e706e67)

Administrator impersonates the attacker account, triggering the attacker's payload as soon as the account is impersonated.

[![AdministratorImpersonatingAttackerAccount.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/363f17bc8dc3178d0eeb682d19110d020fe14671/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31643366303864612d336337612d343933642d623666342d6463356237326539343764352f41646d696e6973747261746f72496d706572736f6e6174696e6741747461636b65724163636f756e742e706e67)

Finally, a video demonstrating the attack and victim triggering the XSS payload

[SoftEmailConfirmation\_repro.mp4](https://user-content.gitlab-static.net/d3e3b7f1565a7af580768e0a75f92ffa7ad8e96c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36313833383235612d626362322d343466622d386636302d3835316337633261616665312f536f6674456d61696c436f6e6669726d6174696f6e5f726570726f2e6d7034 "Download 'SoftEmailConfirmation_repro.mp4'")

##### Output of checks

###### Results of GitLab environment info

```
System information
System:		Ubuntu 20.04
Proxy:		no
Current User:	git
Using RVM:	no
Ruby Version:	2.7.7p221
Gem Version:	3.1.6
Bundler Version:2.3.15
Rake Version:	13.0.6
Redis Version:	6.2.8
Sidekiq Version:6.5.7
Go Version:	unknown

GitLab information
Version:	15.8.0-ee
Revision:	1d89c23c9f9
Directory:	/opt/gitlab/embedded/service/gitlab-rails
DB Adapter:	PostgreSQL
DB Version:	12.12
URL:		https://gitlab-pentest2.example.com
HTTP Clone URL:	https://gitlab-pentest2.example.com/some-group/some-project.git
SSH Clone URL:	git@gitlab-pentest2.example.com:some-group/some-project.git
Elasticsearch:	no
Geo:		no
Using LDAP:	no
Using Omniauth:	yes
Omniauth Providers:

GitLab Shell
Version:	14.15.0
Repository storages:
- default: 	unix:/var/opt/gitlab/gitaly/gitaly.socket
GitLab Shell path:		/opt/gitlab/embedded/service/gitlab-shell
```

#### Impact

Administrators on self-managed instances impersonating the attacker's account will inadvertently trigger XSS if the attacker has not validated their email and :soft\_email\_confirmation feature flag is enabled on an instance that requires email confirmations upon registration.

The Administrator is not made aware of the HTML payload contained in the attacker's email address when viewing the attacker's profile from the administrator user page.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [AttackerWithHTMLTagsInUpdatedEmail.png](https://h1.sec.gitlab.net/a/9979d30c-69f1-4fc1-bc42-43bd0d5bb674/AttackerWithHTMLTagsInUpdatedEmail.png)
* [AdministratorViewingUserProfileWithoutSeeingEmailTags.png](https://h1.sec.gitlab.net/a/44df18ff-7c58-462a-8597-4123ab43236d/AdministratorViewingUserProfileWithoutSeeingEmailTags.png)
* [AdministratorImpersonatingAttackerAccount.png](https://h1.sec.gitlab.net/a/1d3f08da-3c7a-493d-b6f4-dc5b72e947d5/AdministratorImpersonatingAttackerAccount.png)
* [AdministratorImpersonatingUserTriggeringXSS.png](https://h1.sec.gitlab.net/a/251fba2f-59d9-4790-a35c-d4fb5c793536/AdministratorImpersonatingUserTriggeringXSS.png)
* [SoftEmailConfirmation\_repro.mp4](https://h1.sec.gitlab.net/a/6183825a-bcb2-44fb-8f60-851c7c2aafe1/SoftEmailConfirmation_repro.mp4)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Edited Jan 28, 2023 by [Adil Farrukh](/adil.farrukh)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



=== Content from gitlab.com_a25bd349_20250114_232643.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2023](/gitlab-org/cves/-/tree/master/2023)
* [**CVE-2023-0523.json**](/gitlab-org/cves/-/blob/master/2023/CVE-2023-0523.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2023/CVE-2023-0523.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2023/CVE-2023-0523.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![🤖 GitLab Bot 🤖's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "🤖 GitLab Bot 🤖")](/gitlab-bot)

  Mar 31, 2023

  [8d18172f](/gitlab-org/cves/-/commit/8d18172ffea7124ae2e70a8047ca676f0e4df091)
  [Publishing 0 updated advisories and 14 new advisories](/gitlab-org/cves/-/commit/8d18172ffea7124ae2e70a8047ca676f0e4df091)
  ·
  8d18172f

  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Mar 31, 2023

  8d18172f

  [Publishing 0 updated advisories and 14 new advisories](/gitlab-org/cves/-/commit/8d18172ffea7124ae2e70a8047ca676f0e4df091)
  [🤖 GitLab Bot 🤖](/gitlab-bot) authored Mar 31, 2023

Loading


