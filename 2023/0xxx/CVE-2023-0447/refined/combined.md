=== Content from plugins.trac.wordpress.org_4f50db62_20250114_221133.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fyoutube-channel%2Ftrunk%2Fyoutube-channel.php%3Frev%3D2482795)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/youtube-channel/trunk/youtube-channel.php?rev=2414602 "Revision 2414602")
* [Latest Revision](/browser/youtube-channel/trunk/youtube-channel.php)
* [Next Revision](/browser/youtube-channel/trunk/youtube-channel.php?rev=2844200 "Revision 2844200") →
* [Blame](/browser/youtube-channel/trunk/youtube-channel.php?annotate=blame&rev=2482795 "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/youtube-channel/trunk/youtube-channel.php?rev=2482795)

---

# [source:](/browser?rev=2482795&order=name "Go to repository root") [youtube-channel](/browser/youtube-channel?rev=2482795&order=name "View youtube-channel")/[trunk](/browser/youtube-channel/trunk?rev=2482795&order=name "View trunk")/[youtube-channel.php](/browser/youtube-channel/trunk/youtube-channel.php?rev=2482795&order=name "View youtube-channel.php") @ [2482795](/changeset/2482795/ "View changeset 2482795")

View diff against:

View revision:

| [Last change](/changeset/2482795/youtube-channel/trunk/youtube-channel.php "View differences") on this file since 2482795 was [2482795](/changeset/2482795/ "View changeset 2482795"), checked in by urkekg, [4 years ago](/timeline?from=2021-02-27T22%3A06%3A49Z&precision=second "See timeline at 02/27/2021 10:06:49 PM") |
| --- |
| UX improvements and PHP 8 compatibility |
| **File size:** 56.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Plugin Name: YouTube Channel |
| [4](#L4) | \* Plugin URI:  https://urosevic.net/wordpress/plugins/youtube-channel/ |
| [5](#L5) | \* Description: Quick and easy embed latest or random videos from YouTube channel (user uploads, liked or favourited videos) or playlist. Use <a href="widgets.php">widget</a> for sidebar or shortcode for content. Works with <em>YouTube Data API v3</em>. |
| [6](#L6) | \* Version:     3.0.12.1 |
| [7](#L7) | \* Author:      Aleksandar Urošević |
| [8](#L8) | \* Author URI:  https://urosevic.net/ |
| [9](#L9) | \* License:     GPLv3 |
| [10](#L10) | \* License URI: https://www.gnu.org/licenses/gpl-3.0.txt |
| [11](#L11) | \* Text Domain: youtube-channel |
| [12](#L12) | \*/ |
| [13](#L13) |  |
| [14](#L14) | // Exit if accessed directly |
| [15](#L15) | if ( ! defined( 'ABSPATH' ) ) { |
| [16](#L16) | exit; |
| [17](#L17) | } |
| [18](#L18) |  |
| [19](#L19) | if ( ! class\_exists( 'WPAU\_YOUTUBE\_CHANNEL' ) ) { |
| [20](#L20) | class WPAU\_YOUTUBE\_CHANNEL { |
| [21](#L21) |  |
| [22](#L22) | const DB\_VER = 23; |
| [23](#L23) | const VER = '3.0.12.1'; |
| [24](#L24) |  |
| [25](#L25) | public $plugin\_name   = 'YouTube Channel'; |
| [26](#L26) | public $plugin\_slug   = 'youtube-channel'; |
| [27](#L27) | public $plugin\_option = 'youtube\_channel\_defaults'; |
| [28](#L28) | public $plugin\_url; |
| [29](#L29) | public $ytc\_html5\_js = ''; |
| [30](#L30) | public $defaults; |
| [31](#L31) |  |
| [32](#L32) | /\*\* |
| [33](#L33) | \* Construct class |
| [34](#L34) | \*/ |
| [35](#L35) | function \_\_construct() { |
| [36](#L36) |  |
| [37](#L37) | $this->plugin\_url = plugin\_dir\_url( \_\_FILE\_\_ ); |
| [38](#L38) | load\_plugin\_textdomain( $this->plugin\_slug, false, dirname( plugin\_basename( \_\_FILE\_\_ ) ) . '/languages' ); |
| [39](#L39) |  |
| [40](#L40) | // Generate debug JSON |
| [41](#L41) | if ( ! empty( $\_GET['ytc\_debug\_json\_for'] ) ) { |
| [42](#L42) | $this->generate\_debug\_json(); |
| [43](#L43) | } |
| [44](#L44) |  |
| [45](#L45) | // Clear all YTC cache |
| [46](#L46) | add\_action( 'wp\_ajax\_ytc\_clear\_all\_cache', [ &$this, 'clear\_all\_cache' ] ); |
| [47](#L47) |  |
| [48](#L48) | // Activation hook and maybe update trigger |
| [49](#L49) | register\_activation\_hook( \_\_FILE\_\_, [ $this, 'activate' ] ); |
| [50](#L50) | add\_action( 'plugins\_loaded', [ $this, 'maybe\_update' ] ); |
| [51](#L51) |  |
| [52](#L52) | $this->defaults = self::defaults(); |
| [53](#L53) |  |
| [54](#L54) | // TinyMCE AddOn |
| [55](#L55) | if ( ! empty( $this->defaults['tinymce'] ) ) { |
| [56](#L56) | add\_filter( 'mce\_external\_plugins', [ $this, 'mce\_external\_plugins' ], 998 ); |
| [57](#L57) | add\_filter( 'mce\_buttons', [ $this, 'mce\_buttons' ], 999 ); |
| [58](#L58) | } |
| [59](#L59) |  |
| [60](#L60) | if ( is\_admin() ) { |
| [61](#L61) |  |
| [62](#L62) | // Initialize Plugin Settings Magic |
| [63](#L63) | add\_action( 'init', [ $this, 'admin\_init' ] ); |
| [64](#L64) |  |
| [65](#L65) | // Add various Dashboard notices (if needed) |
| [66](#L66) | add\_action( 'admin\_notices', [ $this, 'admin\_notices' ] ); |
| [67](#L67) |  |
| [68](#L68) | // Enqueue scripts and styles for Widgets page |
| [69](#L69) | add\_action( 'admin\_enqueue\_scripts', [ $this, 'admin\_scripts' ] ); |
| [70](#L70) |  |
| [71](#L71) | } else { // ELSE if ( is\_admin() ) |
| [72](#L72) |  |
| [73](#L73) | // Enqueue frontend scripts |
| [74](#L74) | add\_action( 'wp\_enqueue\_scripts', [ $this, 'enqueue\_scripts' ] ); |
| [75](#L75) | add\_action( 'wp\_footer', [ $this, 'footer\_scripts' ] ); |
| [76](#L76) |  |
| [77](#L77) | } // END if ( is\_admin() ) |
| [78](#L78) |  |
| [79](#L79) | // Load widget |
| [80](#L80) | require\_once( 'inc/widget.php' ); |
| [81](#L81) |  |
| [82](#L82) | // Register shortcodes `youtube\_channel` and `ytc` |
| [83](#L83) | add\_shortcode( 'youtube\_channel', [ $this, 'shortcode' ] ); |
| [84](#L84) | add\_shortcode( 'ytc', [ $this, 'shortcode' ] ); |
| [85](#L85) |  |
| [86](#L86) | } // END function \_\_construct() |
| [87](#L87) |  |
| [88](#L88) | /\*\* |
| [89](#L89) | \* Activate the plugin |
| [90](#L90) | \* Credits: http://solislab.com/blog/plugin-activation-checklist/#update-routines |
| [91](#L91) | \*/ |
| [92](#L92) | public static function activate() { |
| [93](#L93) |  |
| [94](#L94) | global $wpau\_youtube\_channel; |
| [95](#L95) | $wpau\_youtube\_channel->init\_options(); |
| [96](#L96) | $wpau\_youtube\_channel->maybe\_update(); |
| [97](#L97) |  |
| [98](#L98) | } // END public static function activate() |
| [99](#L99) |  |
| [100](#L100) | /\*\* |
| [101](#L101) | \* Return initial options |
| [102](#L102) | \* @return array Global defaults for current plugin version |
| [103](#L103) | \*/ |
| [104](#L104) | public function init\_options() { |
| [105](#L105) |  |
| [106](#L106) | $init = [ |
| [107](#L107) | 'vanity'         => '', // $this->vanity\_id, |
| [108](#L108) | 'channel'        => '', // $this->channel\_id, |
| [109](#L109) | 'username'       => '', // $this->username\_id, |
| [110](#L110) | 'playlist'       => '', // $this->playlist\_id, |
| [111](#L111) | 'resource'       => 0, // ex use\_res |
| [112](#L112) | 'cache'          => 300, // 5 minutes // ex cache\_time |
| [113](#L113) | 'fetch'          => 25, // ex maxrnd |
| [114](#L114) | 'num'            => 1, // ex vidqty |
| [115](#L115) | 'skip'           => 0, |
| [116](#L116) | 'privacy'        => 0, |
| [117](#L117) |  |
| [118](#L118) | 'ratio'          => 3, // 3 - 16:9, 1 - 4:3 (deprecated: 2 - 16:10) |
| [119](#L119) | 'width'          => 306, |
| [120](#L120) | 'responsive'     => 1, |
| [121](#L121) | 'display'        => 'thumbnail', // thumbnail, iframe, iframe2, playlist (deprecated: chromeless, object) |
| [122](#L122) | 'thumb\_quality'  => 'hqdefault', // default, mqdefault, hqdefault, sddefault, maxresdefault |
| [123](#L123) | 'fullscreen'     => 0, |
| [124](#L124) | 'controls'       => 0, |
| [125](#L125) | 'autoplay'       => 0, |
| [126](#L126) | 'autoplay\_mute'  => 0, |
| [127](#L127) | 'norel'          => 0, |
| [128](#L128) | 'playsinline'    => 0, // play video on mobile devices inline instead in native device player |
| [129](#L129) | 'showtitle'      => 'none', // above, below, inside, inside\_b |
| [130](#L130) | 'linktitle'      => 0, |
| [131](#L131) | 'titletag'       => 'h3', |
| [132](#L132) | 'showdesc'       => 0, |
| [133](#L133) | 'desclen'        => 0, |
| [134](#L134) | 'modestbranding' => 0, |
| [135](#L135) | 'hideanno'       => 0, |
| [136](#L136) |  |
| [137](#L137) | 'goto\_txt'       => 'Visit our channel', |
| [138](#L138) | 'popup\_goto'     => 0, // 0 same window, 1 new window JS, 2 new window target |
| [139](#L139) | 'link\_to'        => 'none', // 0 legacy username, 1 channel, 2 vanity |
| [140](#L140) | 'tinymce'        => 1, // show TinyMCE button by default |
| [141](#L141) | 'nolightbox'     => 0, // do not use lightbox global setting |
| [142](#L142) | 'timeout'        => 5, // timeout for wp\_remote\_get() |
| [143](#L143) | 'sslverify'      => true, |
| [144](#L144) | 'js\_ev\_listener' => false, |
| [145](#L145) | ]; |
| [146](#L146) |  |
| [147](#L147) | add\_option( 'youtube\_channel\_version', self::VER, '', 'no' ); |
| [148](#L148) | add\_option( 'youtube\_channel\_db\_ver', self::DB\_VER, '', 'no' ); |
| [149](#L149) | add\_option( $this->plugin\_option, $init, '', 'no' ); |
| [150](#L150) |  |
| [151](#L151) | return $init; |
| [152](#L152) |  |
| [153](#L153) | } // END public function init\_options() |
| [154](#L154) |  |
| [155](#L155) | /\*\* |
| [156](#L156) | \* Check do we need to migrate options |
| [157](#L157) | \*/ |
| [158](#L158) | public function maybe\_update() { |
| [159](#L159) |  |
| [160](#L160) | // bail if this plugin data doesn't need updating |
| [161](#L161) | if ( get\_option( 'youtube\_channel\_db\_ver' ) >= self::DB\_VER ) { |
| [162](#L162) | return; |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | require\_once( dirname( \_\_FILE\_\_ ) . '/update.php' ); |
| [166](#L166) | au\_youtube\_channel\_update(); |
| [167](#L167) |  |
| [168](#L168) | } // END public function maybe\_update() |
| [169](#L169) |  |
| [170](#L170) | /\*\* |
| [171](#L171) | \* Initialize Settings link for Plugins page and create Settings page |
| [172](#L172) | \*/ |
| [173](#L173) | function admin\_init() { |
| [174](#L174) |  |
| [175](#L175) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( \_\_FILE\_\_ ), [ $this, 'add\_settings\_link' ] ); |
| [176](#L176) | // Add row on Plugins page |
| [177](#L177) | add\_filter( 'plugin\_row\_meta', [ $this, 'add\_plugin\_meta\_links' ], 10, 2 ); |
| [178](#L178) |  |
| [179](#L179) | require\_once( 'inc/settings.php' ); |
| [180](#L180) |  |
| [181](#L181) | global $wpau\_youtube\_channel\_settings; |
| [182](#L182) | if ( empty( $wpau\_youtube\_channel\_settings ) ) { |
| [183](#L183) | $wpau\_youtube\_channel\_settings = new WPAU\_YOUTUBE\_CHANNEL\_SETTINGS(); |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | } // END function admin\_init\_settings() |
| [187](#L187) |  |
| [188](#L188) | /\*\* |
| [189](#L189) | \* Append Settings link for Plugins page |
| [190](#L190) | \* @param array $links array of links on plugins page |
| [191](#L191) | \*/ |
| [192](#L192) | function add\_settings\_link( $links ) { |
| [193](#L193) |  |
| [194](#L194) | $settings\_title = \_\_( 'Settings' ); |
| [195](#L195) | $settings\_link = "<a href=\"options-general.php?page={$this->plugin\_slug}\">{$settings\_title}</a>"; |
| [196](#L196) | array\_unshift( $links, $settings\_link ); |
| [197](#L197) |  |
| [198](#L198) | // Free some memory |
| [199](#L199) | unset( $settings\_title, $settings\_link ); |
| [200](#L200) |  |
| [201](#L201) | // Return updated array of links |
| [202](#L202) | return $links; |
| [203](#L203) |  |
| [204](#L204) | } // END function add\_settings\_link() |
| [205](#L205) |  |
| [206](#L206) | /\*\* |
| [207](#L207) | \* Add link to official plugin page |
| [208](#L208) | \*/ |
| [209](#L209) | function add\_plugin\_meta\_links( $links, $file ) { |
| [210](#L210) |  |
| [211](#L211) | if ( 'youtube-channel/youtube-channel.php' === $file ) { |
| [212](#L212) | return array\_merge( |
| [213](#L213) | $links, |
| [214](#L214) | [ |
| [215](#L215) | sprintf( |
| [216](#L216) | '<a href="https://wordpress.org/support/plugin/youtube-channel/" target="\_blank">%s</a>', |
| [217](#L217) | \_\_( 'Support' ) |
| [218](#L218) | ), |
| [219](#L219) | ] |
| [220](#L220) | ); |
| [221](#L221) | } |
| [222](#L222) | return $links; |
| [223](#L223) |  |
| [224](#L224) | } // END function add\_plugin\_meta\_links() |
| [225](#L225) |  |
| [226](#L226) | /\*\* |
| [227](#L227) | \* Enqueue admin scripts and styles for widget customization |
| [228](#L228) | \*/ |
| [229](#L229) | function admin\_scripts() { |
| [230](#L230) |  |
| [231](#L231) | global $pagenow; |
| [232](#L232) |  |
| [233](#L233) | // Enqueue only on widget or post pages |
| [234](#L234) | if ( ! in\_array( $pagenow, [ 'widgets.php', 'customize.php', 'options-general.php', 'post.php', 'post-new.php' ] ) ) { |
| [235](#L235) | return; |
| [236](#L236) | } |
| [237](#L237) |  |
| [238](#L238) | // Enqueue on post page only if tinymce is enabled |
| [239](#L239) | if ( in\_array( $pagenow, [ 'post.php', 'post-new.php' ] ) && empty( $this->defaults['tinymce'] ) ) { |
| [240](#L240) | return; |
| [241](#L241) | } |
| [242](#L242) |  |
| [243](#L243) | wp\_enqueue\_style( |
| [244](#L244) | $this->plugin\_slug . '-admin', |
| [245](#L245) | plugins\_url( 'assets/css/admin.css', \_\_FILE\_\_ ), |
| [246](#L246) | [], |
| [247](#L247) | self::VER |
| [248](#L248) | ); |
| [249](#L249) |  |
| [250](#L250) | // Enqueue script for widget in admin |
| [251](#L251) | if ( in\_array( $pagenow, [ 'widgets.php', 'customize.php' ] ) ) { |
| [252](#L252) | wp\_enqueue\_script( |
| [253](#L253) | $this->plugin\_slug . '-admin', |
| [254](#L254) | plugins\_url( 'assets/js/admin.min.js', \_\_FILE\_\_ ), |
| [255](#L255) | [ 'jquery' ], |
| [256](#L256) | self::VER, |
| [257](#L257) | true |
| [258](#L258) | ); |
| [259](#L259) | } |
| [260](#L260) | } // END function admin\_scripts() |
| [261](#L261) |  |
| [262](#L262) | /\*\* |
| [263](#L263) | \* Print dashboard notice |
| [264](#L264) | \* @return string Formatted notice with usefull explanation |
| [265](#L265) | \*/ |
| [266](#L266) | function admin\_notices() { |
| [267](#L267) |  |
| [268](#L268) | // Get array of dismissed notices |
| [269](#L269) | $dismissed\_notices = get\_option( 'youtube\_channel\_dismissed\_notices' ); |
| [270](#L270) |  |
| [271](#L271) | // Dismiss notices if requested and then update option in DB |
| [272](#L272) | if ( ! empty( $\_GET['ytc\_dismiss\_notice\_old\_php'] ) ) { |
| [273](#L273) | $dismissed\_notices['old\_php'] = 1; |
| [274](#L274) | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
| [275](#L275) | } |
| [276](#L276) | if ( ! empty( $\_GET['ytc\_dismiss\_notice\_apikey\_wpconfig'] ) ) { |
| [277](#L277) | $dismissed\_notices['apikey\_wpconfig'] = 1; |
| [278](#L278) | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
| [279](#L279) | } |
| [280](#L280) | if ( ! empty( $\_GET['ytc\_dismiss\_notice\_vanity\_option'] ) ) { |
| [281](#L281) | $dismissed\_notices['vanity\_option'] = 1; |
| [282](#L282) | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
| [283](#L283) | } |
| [284](#L284) | if ( ! empty( $\_GET['ytc\_dismiss\_notice\_changed\_shortcode\_308'] ) ) { |
| [285](#L285) | $dismissed\_notices['changed\_shortcode\_308'] = 1; |
| [286](#L286) | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | // Prepare vars for notices |
| [290](#L290) | $settings\_page = 'options-general.php?page=youtube-channel'; |
| [291](#L291) | $notice = [ |
| [292](#L292) | 'error'   => '', |
| [293](#L293) | 'warning' => '', |
| [294](#L294) | 'info'    => '', |
| [295](#L295) | ]; |
| [296](#L296) |  |
| [297](#L297) | // Inform if PHP version is lower than 5.3 |
| [298](#L298) | if ( |
| [299](#L299) | version\_compare( PHP\_VERSION, '5.3', '<' ) && |
| [300](#L300) | ( |
| [301](#L301) | empty( $dismissed\_notices ) || |
| [302](#L302) | ( ! empty( $dismissed\_notices ) && empty( $dismissed\_notices['old\_php'] ) ) |
| [303](#L303) | ) |
| [304](#L304) | ) { |
| [305](#L305) | $notice['info'] .= sprintf( |
| [306](#L306) | \_\_( '<p>Your website running on web server with PHP version %1$s. Please note that <strong>%2$s</strong> requires PHP at least 5.3 or newer to work properly. <a href="%3$s" class="dismiss">Dismiss</a></p>', 'youtube-channel' ), |
| [307](#L307) | PHP\_VERSION, |
| [308](#L308) | $this->plugin\_name, |
| [309](#L309) | '?ytc\_dismiss\_notice\_old\_php=1' |
| [310](#L310) | ); |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | // Inform if YOUTUBE\_DATA\_API\_KEY is still in wp-config.php |
| [314](#L314) | if ( |
| [315](#L315) | defined( 'YOUTUBE\_DATA\_API\_KEY' ) && |
| [316](#L316) | empty( $dismissed\_notices['apikey\_wpconfig'] ) |
| [317](#L317) | ) { |
| [318](#L318) | $notice['info'] .= sprintf( |
| [319](#L319) | \_\_( '<p>Since <strong>%1$s</strong> v3.0.6 we store <strong>YouTube Data API Key</strong> in plugin settings. So, you can safely remove %2$s define line from your <strong>wp-config.php</strong> file. <a href="%3$s" class="dismiss">Dismiss</a></p>', 'youtube-channel' ), |
| [320](#L320) | $this->plugin\_name, |
| [321](#L321) | 'YOUTUBE\_DATA\_API\_KEY', |
| [322](#L322) | '?ytc\_dismiss\_notice\_apikey\_wpconfig=1' |
| [323](#L323) | ); |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | // No YouTube DATA Api Key? |
| [327](#L327) | if ( empty( $this->defaults['apikey'] ) ) { |
| [328](#L328) | $notice['error'] .= sprintf( |
| [329](#L329) | wp\_kses( |
| [330](#L330) | \_\_( |
| [331](#L331) | '<p><strong>%1$s v3</strong> require <strong>%2$s</strong> set on plugin <a href="%6$s">%7$s</a>. You can generate your own key on <a href="%3$s" target="\_blank">%4$s</a> by following <a href="%5$s" target="\_blank">this tutorial</a>.</p>', |
| [332](#L332) | 'youtube-channel' |
| [333](#L333) | ), |
| [334](#L334) | [ |
| [335](#L335) | 'a'      => [ |
| [336](#L336) | 'href'   => [], |
| [337](#L337) | 'target' => [ '\_blank' ], |
| [338](#L338) | ], |
| [339](#L339) | 'p'      => [], |
| [340](#L340) | 'strong' => [], |
| [341](#L341) | 'br'     => [], |
| [342](#L342) | ] |
| [343](#L343) | ), |
| [344](#L344) | $this->plugin\_name, |
| [345](#L345) | \_\_( 'YouTube Data API Key', 'youtube-channel' ), |
| [346](#L346) | esc\_url( 'https://console.developers.google.com/project' ), |
| [347](#L347) | \_\_( 'Google Developers Console', 'youtube-channel' ), |
| [348](#L348) | esc\_url( 'https://urosevic.net/wordpress/plugins/youtube-channel/#youtube\_data\_api\_key' ), |
| [349](#L349) | esc\_url( 'options-general.php?page=youtube-channel&tab=general' ), |
| [350](#L350) | \_\_( 'General Settings', 'youtube-channel' ) |
| [351](#L351) | ); |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | // v3.0.8.1 shortcode changes since v3.0.8 |
| [355](#L355) | if ( ! empty( $dismissed\_notices ) && empty( $dismissed\_notices['changed\_shortcode\_308'] ) ) { |
| [356](#L356) | $notice['warning'] .= sprintf( |
| [357](#L357) | \_\_( '<p><strong>%1$s</strong> changed shortcode parameters by removing <code>only\_pl</code> and <code>showgoto</code>, and combining with parameters <code>display</code> and <code>link\_to</code> respectively. Please check out <a href="%2$s&tab=help">%3$s</a> and update your shortcodes. <a href="%4$s" class="dismiss">Dismiss</a>', 'youtube-channel' ), |
| [358](#L358) | $this->plugin\_name, |
| [359](#L359) | $settings\_page, |
| [360](#L360) | 'Help: How to use shortcode', |
| [361](#L361) | '?ytc\_dismiss\_notice\_changed\_shortcode\_308=1' |
| [362](#L362) | ); |
| [363](#L363) | } elseif ( empty( $dismissed\_notices ) ) { |
| [364](#L364) | // First time install? auto dismiss this notice |
| [365](#L365) | $dismissed\_notices['changed\_shortcode\_308'] = 1; |
| [366](#L366) | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | foreach ( $notice as $type => $message ) { |
| [370](#L370) | if ( ! empty( $message ) ) { |
| [371](#L371) | echo "<div class=\"notice notice-{$type}\">{$message}</div>"; |
| [372](#L372) | } |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | } // END function admin\_notices() |
| [376](#L376) |  |
| [377](#L377) | /\*\* |
| [378](#L378) | \* Get default options from DB |
| [379](#L379) | \* @return array Latest global defaults |
| [380](#L380) | \*/ |
| [381](#L381) | public function defaults() { |
| [382](#L382) |  |
| [383](#L383) | $defaults = get\_option( $this->plugin\_option ); |
| [384](#L384) | if ( empty( $defaults ) ) { |
| [385](#L385) | $defaults = $this->init\_options(); |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | return $defaults; |
| [389](#L389) |  |
| [390](#L390) | } // END public function defaults() |
| [391](#L391) |  |
| [392](#L392) | /\*\* |
| [393](#L393) | \* Enqueue frontend scripts and styles |
| [394](#L394) | \*/ |
| [395](#L395) | function enqueue\_scripts() { |
| [396](#L396) |  |
| [397](#L397) | // Check do we need our own lightbox? |
| [398](#L398) | if ( empty( $this->defaults['nolightbox'] ) ) { |
| [399](#L399) | wp\_enqueue\_style( |
| [400](#L400) | 'magnific-popup-au', |
| [401](#L401) | plugins\_url( 'assets/lib/magnific-popup/magnific-popup.min.css', \_\_FILE\_\_ ), |
| [402](#L402) | [], |
| [403](#L403) | self::VER |
| [404](#L404) | ); |
| [405](#L405) | wp\_enqueue\_script( |
| [406](#L406) | 'magnific-popup-au', |
| [407](#L407) | plugins\_url( 'assets/lib/magnific-popup/jquery.magnific-popup.min.js', \_\_FILE\_\_ ), |
| [408](#L408) | [ 'jquery' ], |
| [409](#L409) | self::VER, |
| [410](#L410) | true |
| [411](#L411) | ); |
| [412](#L412) | } |
| [413](#L413) |  |
| [414](#L414) | wp\_enqueue\_style( |
| [415](#L415) | 'youtube-channel', |
| [416](#L416) | plugins\_url( 'assets/css/youtube-channel.css', \_\_FILE\_\_ ), |
| [417](#L417) | [], |
| [418](#L418) | self::VER |
| [419](#L419) | ); |
| [420](#L420) |  |
| [421](#L421) | } // END function enqueue\_scripts() |
| [422](#L422) |  |
| [423](#L423) | /\*\* |
| [424](#L424) | \* Generate comlete inline JavaScript code that conains |
| [425](#L425) | \* Async video load and lightbox init for thumbnails |
| [426](#L426) | \* @return string Compressed JavaScript code |
| [427](#L427) | \*/ |
| [428](#L428) | function footer\_scripts() { |
| [429](#L429) |  |
| [430](#L430) | $js = ''; |
| [431](#L431) |  |
| [432](#L432) | // Print YT API only if we have set ytc\_html5\_js in $\_SESSION |
| [433](#L433) | // if ( ! empty( $\_SESSION['ytc\_html5\_js'] ) ) { |
| [434](#L434) | if ( ! empty( $this->ytc\_html5\_js ) ) { |
| [435](#L435) | $js .= " |
| [436](#L436) | if (!window['YT']) { |
| [437](#L437) | var tag=document.createElement('script'); |
| [438](#L438) | tag.src=\"//www.youtube.com/iframe\_api\"; |
| [439](#L439) | var firstScriptTag=document.getElementsByTagName('script')[0]; |
| [440](#L440) | firstScriptTag.parentNode.insertBefore(tag,firstScriptTag); |
| [441](#L441) | } |
| [442](#L442) | function ytc\_create\_ytplayers(){ |
| [443](#L443) | {$this->ytc\_html5\_js} |
| [444](#L444) | } |
| [445](#L445) | try { |
| [446](#L446) | ytc\_create\_ytplayers(); |
| [447](#L447) | } catch (e) {} |
| [448](#L448) | function onYouTubeIframeAPIReady(){ |
| [449](#L449) | ytc\_create\_ytplayers(); |
| [450](#L450) | } |
| [451](#L451) | function ytc\_mute(event){event.target.mute();} |
| [452](#L452) | "; |
| [453](#L453) | } // END if ( ! empty($\_SESSION['ytc\_html5\_js']) ) |
| [454](#L454) |  |
| [455](#L455) | // Print Magnific Popup if not disabled |
| [456](#L456) | if ( empty( $this->defaults['nolightbox'] ) ) { |
| [457](#L457) | $js .= " |
| [458](#L458) | function ytc\_init\_MPAU() { |
| [459](#L459) | jQuery('.ytc-lightbox').magnificPopupAU({ |
| [460](#L460) | disableOn:320, |
| [461](#L461) | type:'iframe', |
| [462](#L462) | mainClass:'ytc-mfp-lightbox', |
| [463](#L463) | removalDelay:160, |
| [464](#L464) | preloader:false, |
| [465](#L465) | fixedContentPos:false |
| [466](#L466) | }); |
| [467](#L467) | } |
| [468](#L468) | jQuery(window).on('load',function(){ |
| [469](#L469) | ytc\_init\_MPAU(); |
| [470](#L470) | }); |
| [471](#L471) | jQuery(document).ajaxComplete(function(){ |
| [472](#L472) | ytc\_init\_MPAU(); |
| [473](#L473) | }); |
| [474](#L474) | "; |
| [475](#L475) | } // END if ( empty($this->defaults['nolightbox']) ) |
| [476](#L476) |  |
| [477](#L477) | if ( ! empty( $js ) ) { |
| [478](#L478) | $js = sprintf( |
| [479](#L479) | ' |
| [480](#L480) | <!-- YouTube Channel 3 --> |
| [481](#L481) | <script type="text/javascript">%2$s%1$s%3$s</script> |
| [482](#L482) | ', |
| [483](#L483) | $js, |
| [484](#L484) | $this->defaults['js\_ev\_listener'] ? "window.addEventListener('DOMContentLoaded', function() {" : '', |
| [485](#L485) | $this->defaults['js\_ev\_listener'] ? '});' : '' |
| [486](#L486) | ); |
| [487](#L487) |  |
| [488](#L488) | if ( WP\_DEBUG ) { |
| [489](#L489) | // Uncompressed code if WP debug is enabled |
| [490](#L490) | $js = str\_replace( ';var', ";\nvar", $js ); |
| [491](#L491) | $js = str\_replace( "\t", '', $js ); |
| [492](#L492) | // $js = str\_replace(',', ",\n\t", $js); |
| [493](#L493) | echo $js; |
| [494](#L494) | } else { |
| [495](#L495) | echo trim( preg\_replace( '/[\t\r\n]+/', '', $js ) ); |
| [496](#L496) | } |
| [497](#L497) | } |
| [498](#L498) |  |
| [499](#L499) | } // END function footer\_scripts() |
| [500](#L500) |  |
| [501](#L501) | public function shortcode( $atts ) { |
| [502](#L502) |  |
| [503](#L503) | // Get general default settings |
| [504](#L504) | $instance = $this->defaults(); |
| [505](#L505) |  |
| [506](#L506) | // Extract shortcode parameters |
| [507](#L507) | $atts = shortcode\_atts( |
| [508](#L508) | [ |
| [509](#L509) | 'vanity'         => $instance['vanity'], |
| [510](#L510) | 'channel'        => $instance['channel'], |
| [511](#L511) | 'username'       => $instance['username'], |
| [512](#L512) | 'playlist'       => $instance['playlist'], |
| [513](#L513) | 'res'            => '', // (deprecated, but leave for back compatibility) ex res |
| [514](#L514) | 'use\_res'        => '', // (deprecated, but leave for back compatibility) ex use\_res |
| [515](#L515) | 'resource'       => $instance['resource'], // ex use\_res |
| [516](#L516) | 'only\_pl'        => 0, // disabled by default (was: $instance['only\_pl'],) |
| [517](#L517) | 'cache'          => $instance['cache'], // ex cache\_time |
| [518](#L518) | 'privacy'        => $instance['privacy'], // ex showvidesc |
| [519](#L519) | 'fetch'          => $instance['fetch'], // ex maxrnd |
| [520](#L520) | 'num'            => $instance['num'], // ex vidqty |
| [521](#L521) |  |
| [522](#L522) | 'random'         => 0, // ex getrnd |
| [523](#L523) |  |
| [524](#L524) | 'ratio'          => $instance['ratio'], |
| [525](#L525) | 'width'          => $instance['width'], |
| [526](#L526) | 'responsive'     => ! empty( $instance['responsive'] ) ? $instance['responsive'] : '0', |
| [527](#L527) |  |
| [528](#L528) | 'show'           => $instance['display'], // (deprecated, but keep for back compatibility) ex to\_show |
| [529](#L529) | 'display'        => $instance['display'], |
| [530](#L530) | 'thumb\_quality'  => $instance['thumb\_quality'], |
| [531](#L531) | 'no\_thumb\_title' => 0, |
| [532](#L532) | 'controls'       => $instance['controls'], |
| [533](#L533) | 'autoplay'       => $instance['autoplay'], |
| [534](#L534) | 'mute'           => $instance['autoplay\_mute'], |
| [535](#L535) | 'norel'          => $instance['norel'], |
| [536](#L536) | 'playsinline'    => $instance['playsinline'], // play video on mobile devices inline instead in native device player |
| [537](#L537) |  |
| [538](#L538) | 'showtitle'      => $instance['showtitle'], // none, above, below, inside, inside\_b |
| [539](#L539) | 'linktitle'      => ! empty( $instance['linktitle'] ) ? $instance['linktitle'] : '0', |
| [540](#L540) | 'titletag'       => $instance['titletag'], // h3, h4, h5, div, span, strong |
| [541](#L541) | 'showdesc'       => $instance['showdesc'], // ex showvidesc |
| [542](#L542) | 'nobrand'        => ! empty( $instance['modestbranding'] ) ? $instance['modestbranding'] : '0', |
| [543](#L543) | 'desclen'        => $instance['desclen'], // ex videsclen |
| [544](#L544) | 'noanno'         => $instance['hideanno'], |
| [545](#L545) |  |
| [546](#L546) | 'goto\_txt'       => $instance['goto\_txt'], |
| [547](#L547) | 'popup'          => $instance['popup\_goto'], |
| [548](#L548) | 'link\_to'        => $instance['link\_to'], // none, vanity, channel, legacy |
| [549](#L549) |  |
| [550](#L550) | 'class'          => ! empty( $instance['class'] ) ? $instance['class'] : '', |
| [551](#L551) |  |
| [552](#L552) | 'nolightbox'     => ! empty( $instance['nolightbox'] ) ? $instance['nolightbox'] : '0', |
| [553](#L553) | 'target'         => '', |
| [554](#L554) | 'skip'           => 0, // how many items to skip |
| [555](#L555) | ], |
| [556](#L556) | $atts |
| [557](#L557) | ); |
| [558](#L558) |  |
| [559](#L559) | // backward compatibility for show -> display shortcode parameter |
| [560](#L560) | if ( ! empty( $atts['show'] ) && $atts['show'] !== $atts['display'] && $atts['show'] !== $instance['display'] ) { |
| [561](#L561) | $atts['display'] = $atts['show']; |
| [562](#L562) | } |
| [563](#L563) | // backward compatibility for use\_res -> resource shortcode parameter |
| [564](#L564) | if ( ! empty( $atts['use\_res'] ) ) { |
| [565](#L565) | $atts['resource'] = $atts['use\_res']; |
| [566](#L566) | } elseif ( ! empty( $atts['res'] ) ) { |
| [567](#L567) | $atts['resource'] = $atts['res']; |
| [568](#L568) | } |
| [569](#L569) |  |
| [570](#L570) | // prepare instance for output |
| [571](#L571) | $instance['vanity']         = $atts['vanity']; |
| [572](#L572) | $instance['channel']        = $atts['channel']; |
| [573](#L573) | $instance['username']       = $atts['username']; |
| [574](#L574) | $instance['playlist']       = $atts['playlist']; |
| [575](#L575) | $instance['resource']       = $atts['resource']; // resource: 0 channel, 1 favorites, 2 playlist, 3 liked |
| [576](#L576) | $instance['cache']          = $atts['cache']; // in seconds, def 5min - settings? |
| [577](#L577) | $instance['privacy']        = $atts['privacy']; // enhanced privacy |
| [578](#L578) |  |
| [579](#L579) | $instance['fetch']          = (int) $atts['fetch']; |
| [580](#L580) | $instance['num']            = (int) $atts['num']; // num: 1 |
| [581](#L581) |  |
| [582](#L582) | $instance['random']         = $atts['random']; // use embedded playlist - false by default |
| [583](#L583) |  |
| [584](#L584) | // Video Settings |
| [585](#L585) | $instance['ratio']          = $atts['ratio']; // aspect ratio: 3 - 16:9, 2 - 16:10, 1 - 4:3 |
| [586](#L586) | $instance['width']          = (int) $atts['width']; // 306 |
| [587](#L587) | $instance['responsive']     = $atts['responsive']; // enable responsivenes? |
| [588](#L588) | $instance['display']        = $atts['display']; // thumbnail, iframe, iframe2, playlist |
| [589](#L589) | $instance['thumb\_quality']  = $atts['thumb\_quality']; // default, mqdefault, hqdefault, sddefault, maxresdefault |
| [590](#L590) | $instance['no\_thumb\_title'] = $atts['no\_thumb\_title']; // hide tooltip for thumbnails |
| [591](#L591) |  |
| [592](#L592) | $instance['controls']       = $atts['controls']; // hide controls, false by default |
| [593](#L593) | $instance['autoplay']       = $atts['autoplay']; // autoplay disabled by default |
| [594](#L594) | $instance['autoplay\_mute']  = $atts['mute']; // mute sound on autoplay - disabled by default |
| [595](#L595) | $instance['norel']          = $atts['norel']; // hide related videos |
| [596](#L596) | $instance['playsinline']    = $atts['playsinline']; // inline plaer for iOS |
| [597](#L597) |  |
| [598](#L598) | // Content Layout |
| [599](#L599) | $instance['showtitle']      = $atts['showtitle']; // show video title, disabled by default |
| [600](#L600) | $instance['linktitle']      = $atts['linktitle']; // link title to video, disabled by default |
| [601](#L601) | $instance['titletag']       = $atts['titletag']; // title HTML tag wrapper, h3 by default |
| [602](#L602) | $instance['showdesc']       = $atts['showdesc']; // show video description, disabled by default |
| [603](#L603) | $instance['modestbranding'] = $atts['nobrand']; // hide YT logo |
| [604](#L604) | $instance['desclen']        = (int) $atts['desclen']; // cut video description, number of characters |
| [605](#L605) | $instance['hideanno']       = $atts['noanno']; // hide annotations, false by default |
| [606](#L606) |  |
| [607](#L607) | // Link to Channel |
| [608](#L608) | $instance['goto\_txt']       = $atts['goto\_txt']; // text for goto link - use settings |
| [609](#L609) | $instance['popup\_goto']     = $atts['popup']; // open channel in: 0 same window, 1 javascript new, 2 target new |
| [610](#L610) | $instance['link\_to']        = $atts['link\_to']; // link to: none, vanity, legacy, channel |
| [611](#L611) |  |
| [612](#L612) | // Customization |
| [613](#L613) | $instance['class']          = $atts['class']; // custom additional class for container |
| [614](#L614) |  |
| [615](#L615) | $instance['nolightbox']     = $atts['nolightbox']; // custom usage of lightbox |
| [616](#L616) | $instance['target']         = $atts['target'];     // custom target for thumbnails w/o lightbox (empty, \_blank or custom) |
| [617](#L617) |  |
| [618](#L618) | $instance['skip']           = (int) $atts['skip']; |
| [619](#L619) | // return implode( array\_values( $this->output( $instance ) ) ); |
| [620](#L620) | return $this->output( $instance ); |
| [621](#L621) | } // END public function shortcode() |
| [622](#L622) |  |
| [623](#L623) | // Print out YTC block |
| [624](#L624) | public function output( $instance ) { |
| [625](#L625) |  |
| [626](#L626) | // Error message if no YouTube Data API Key |
| [627](#L627) | if ( empty( $this->defaults['apikey'] ) ) { |
| [628](#L628) |  |
| [629](#L629) | $error\_msg = sprintf( |
| [630](#L630) | \_\_( '<strong>%1$s v3</strong> requires <strong>YouTube DATA API Key</strong> to work. <a href="%2$s" target="\_blank">Learn more here</a>.', 'youtube-channel' ), |
| [631](#L631) | $this->plugin\_name, |
| [632](#L632) | 'https://urosevic.net/wordpress/plugins/youtube-channel/#youtube\_data\_api\_key' |
| [633](#L633) | ); |
| [634](#L634) |  |
| [635](#L635) | return $this->front\_debug( $error\_msg ); |
| [636](#L636) |  |
| [637](#L637) | } |
| [638](#L638) |  |
| [639](#L639) | // 1) Get resource from widget/shortcode |
| [640](#L640) | // 2) If not set, get global default |
| [641](#L641) | // 3) if no global, get plugin's default |
| [642](#L642) | if ( ! isset( $instance['resource'] ) ) { |
| [643](#L643) | $instance['resource'] = $this->defaults['resource']; |
| [644](#L644) | } |
| [645](#L645) | $resource = intval( $instance['resource'] ); |
| [646](#L646) | if ( empty( $resource ) && 0 !== $resource ) { |
| [647](#L647) | $resource = intval( $this->defaults['resource'] ); |
| [648](#L648) | if ( empty( $resource ) ) { |
| [649](#L649) | $resource = 0; |
| [650](#L650) | } |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | // Get Channel or Playlist ID based on requested resource |
| [654](#L654) | switch ( $resource ) { |
| [655](#L655) |  |
| [656](#L656) | // Playlist |
| [657](#L657) | case '2': |
| [658](#L658) | // 1) Get Playlist from shortcode/widget |
| [659](#L659) | // 2) If not set, use global default |
| [660](#L660) | // 3) If no global, throw error |
| [661](#L661) | if ( ! empty( $instance['playlist'] ) ) { |
| [662](#L662) | $playlist = trim( $instance['playlist'] ); |
| [663](#L663) | } else { |
| [664](#L664) | $playlist = trim( $this->defaults['playlist'] ); |
| [665](#L665) | } |
| [666](#L666) | // Now check has Playlist ID set or throw error |
| [667](#L667) | if ( '' == $playlist ) { |
| [668](#L668) | return $this->front\_debug( 'Playlist selected as resource but no Playlist ID provided!' ); |
| [669](#L669) | } |
| [670](#L670) | break; |
| [671](#L671) |  |
| [672](#L672) | // Channel, Favourites, Liked |
| [673](#L673) | default: |
| [674](#L674) | /\* Channel \*/ |
| [675](#L675) | // 1) Get channel from shortcode/widget |
| [676](#L676) | // 2) If not set, use global default |
| [677](#L677) | // 3) If no global, throw error |
| [678](#L678) | if ( ! empty( $instance['channel'] ) ) { |
| [679](#L679) | $channel = trim( $instance['channel'] ); |
| [680](#L680) | } else { |
| [681](#L681) | $channel = trim( $this->defaults['channel'] ); |
| [682](#L682) | } |
| [683](#L683) | // Now check is Channel ID set or throw error |
| [684](#L684) | if ( '' == $channel ) { |
| [685](#L685) | if ( 1 == $resource ) { |
| [686](#L686) | $resource\_name = 'Favourited videos'; |
| [687](#L687) | } elseif ( 3 == $resource ) { |
| [688](#L688) | $resource\_name = 'Liked videos'; |
| [689](#L689) | } else { |
| [690](#L690) | $resource\_name = 'Channel (User uploads)'; |
| [691](#L691) | } |
| [692](#L692) | $error\_msg = sprintf( '%s selected as resource but no Channel ID provided!', $resource\_name ); |
| [693](#L693) | return $this->front\_debug( $error\_msg ); |
| [694](#L694) | } |
| [695](#L695) | } // END switch ($resource) |
| [696](#L696) |  |
| [697](#L697) | /\* OK, we have required resource (Playlist or Channel ID), so we can proceed to real job \*/ |
| [698](#L698) |  |
| [699](#L699) | // Set custom class and responsive if needed |
| [700](#L700) | $class = ( ! empty( $instance['class'] ) ) ? $instance['class'] : 'default'; |
| [701](#L701) | if ( ! empty( $instance['responsive'] ) ) { |
| [702](#L702) | $class .= ' responsive'; |
| [703](#L703) | } |
| [704](#L704) | if ( ! empty( $instance['display'] ) ) { |
| [705](#L705) | $class .= " ytc\_display\_{$instance['display']}"; |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) | switch ( $resource ) { |
| [709](#L709) | case 1: // Favourites |
| [710](#L710) | $resource\_name = 'favourites'; |
| [711](#L711) | $resource\_id = preg\_replace( '/^UC/', 'FL', $channel ); |
| [712](#L712) | break; |
| [713](#L713) | case 2: // Playlist |
| [714](#L714) | $resource\_name = 'playlist'; |
| [715](#L715) | $resource\_id = $playlist; |
| [716](#L716) | break; |
| [717](#L717) | case 3: // Liked |
| [718](#L718) | $resource\_name = 'liked'; |
| [719](#L719) | $resource\_id = preg\_replace( '/^UC/', 'LL', $channel ); |
| [720](#L720) | break; |
| [721](#L721) | default: // Channel |
| [722](#L722) | $resource\_name = 'channel'; |
| [723](#L723) | $resource\_id = preg\_replace( '/^UC/', 'UU', $channel ); |
| [724](#L724) | } |
| [725](#L725) |  |
| [726](#L726) | // Start output string |
| [727](#L727) | $output = ''; |
| [728](#L728) |  |
| [729](#L729) | $output .= "<div class=\"youtube\_channel {$class}\">"; |
| [730](#L730) |  |
| [731](#L731) | if ( empty( $instance['display'] ) ) { |
| [732](#L732) | $instance['display'] = $this->defaults['display']; |
| [733](#L733) | } |
| [734](#L734) | if ( 'playlist' == $instance['display'] ) { // Insert as Embedded playlist |
| [735](#L735) |  |
| [736](#L736) | $output .= self::embed\_playlist( $resource\_id, $instance ); |
| [737](#L737) |  |
| [738](#L738) | } else { // Individual videos from channel, favourites, liked or playlist |
| [739](#L739) |  |
| [740](#L740) | // Get max items for random video |
| [741](#L741) | $fetch = ( empty( $instance['fetch'] ) ) ? $this->defaults['fetch'] : $instance['fetch']; |
| [742](#L742) | if ( $fetch < 1 ) { |
| [743](#L743) | $fetch = 10; |
| [744](#L744) | } elseif ( $fetch > 50 ) { |
| [745](#L745) | $fetch = 50; |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | // How many items to skip? |
| [749](#L749) | $skip = 0; |
| [750](#L750) | if ( ! empty( $instance['skip'] ) ) { |
| [751](#L751) | $skip = intval( $instance['skip'] ) > 49 ? 49 : intval( $instance['skip'] ); |
| [752](#L752) | } |
| [753](#L753) | // If we have to skip more items than we have in fetch, set skip to $fetch-1 |
| [754](#L754) | if ( $skip >= $fetch ) { |
| [755](#L755) | $skip = $fetch - 1; |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | $resource\_key = "{$resource\_id}\_{$fetch}"; |
| [759](#L759) |  |
| [760](#L760) | // Do we need cache? Let we define cache fallback key |
| [761](#L761) | $cache\_key\_fallback = 'ytc\_' . md5( $resource\_key ) . '\_fallback'; |
| [762](#L762) |  |
| [763](#L763) | // Do cache magic |
| [764](#L764) | if ( ! empty( $instance['cache'] ) && $instance['cache'] > 0 ) { |
| [765](#L765) |  |
| [766](#L766) | // generate feed cache key for caching time |
| [767](#L767) | $cache\_key = 'ytc\_' . md5( $resource\_key ) . '\_' . $instance['cache']; |
| [768](#L768) |  |
| [769](#L769) | if ( ! empty( $\_GET['ytc\_force\_recache'] ) ) { |
| [770](#L770) | delete\_transient( $cache\_key ); |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | // get/set transient cache |
| [774](#L774) | $json = get\_transient( $cache\_key ); |
| [775](#L775) | if ( false === $json || empty( $json ) ) { |
| [776](#L776) |  |
| [777](#L777) | // no cached JSON, get new |
| [778](#L778) | $json = $this->fetch\_youtube\_feed( $resource\_id, $fetch ); |
| [779](#L779) |  |
| [780](#L780) | // set decoded JSON to transient cache\_key |
| [781](#L781) | set\_transient( $cache\_key, base64\_encode( $json ), $instance['cache'] ); |
| [782](#L782) |  |
| [783](#L783) | } else { |
| [784](#L784) |  |
| [785](#L785) | // we already have cached feed JSON, get it encoded |
| [786](#L786) | $json = base64\_decode( $json ); |
| [787](#L787) |  |
| [788](#L788) | } |
| [789](#L789) | } else { |
| [790](#L790) |  |
| [791](#L791) | // just get fresh feed if cache disabled |
| [792](#L792) | $json = $this->fetch\_youtube\_feed( $resource\_id, $fetch ); |
| [793](#L793) |  |
| [794](#L794) | } |
| [795](#L795) |  |
| [796](#L796) | // free some memory |
| [797](#L797) | unset( $response ); |
| [798](#L798) |  |
| [799](#L799) | // decode JSON data |
| [800](#L800) | $json\_output = json\_decode( $json ); |
| [801](#L801) |  |
| [802](#L802) | // YTC 3.0.7: Do we need this, still? |
| [803](#L803) | // if current feed is messed up, try to get it from fallback cache |
| [804](#L804) | if ( is\_wp\_error( $json\_output ) && ! is\_object( $json\_output ) && empty( $json\_output->items ) ) { |
| [805](#L805) | // do we have fallback cache?! |
| [806](#L806) | $json\_fallback = get\_transient( $cache\_key\_fallback ); |
| [807](#L807) | if ( true === $json\_fallback && ! empty( $json\_fallback ) ) { |
| [808](#L808) | $json\_output = json\_decode( base64\_decode( $json\_fallback ) ); |
| [809](#L809) | // and free memory |
| [810](#L810) | unset( $json\_fallback ); |
| [811](#L811) | } |
| [812](#L812) | } |
| [813](#L813) |  |
| [814](#L814) | // Get resource nice name based on selected resource |
| [815](#L815) | $resource\_nice\_name = $this->resource\_nice\_name( $resource ); |
| [816](#L816) |  |
| [817](#L817) | // Prevent further checks if we have WP Error or empty record even after fallback |
| [818](#L818) | if ( is\_wp\_error( $json\_output ) ) { |
| [819](#L819) | $output .= $this->front\_debug( $json\_output->get\_error\_message() ); |
| [820](#L820) | return $output; |
| [821](#L821) | } elseif ( isset( $json\_output->items ) && 0 == sizeof( $json\_output->items ) ) { |
| [822](#L822) | $output .= $this->front\_debug( sprintf( \_\_( 'You have set to display videos from %1$s [resource list ID: %2$s], but there have no public videos in that resouce.' ), $resource\_nice\_name, $resource\_id ) ); |
| [823](#L823) | return $output; |
| [824](#L824) | } elseif ( empty( $json\_output ) ) { |
| [825](#L825) | $output .= $this->front\_debug( sprintf( \_\_( 'We have empty record for this feed. Please read <a href="%1$s" target="\_blank">FAQ</a> and if that does not help, contact <a href="%2$s" target="\_blank">support</a>.' ), 'https://wordpress.org/plugins/youtube-channel#faq', 'https://wordpress.org/support/plugin/youtube-channel/' ) ); |
| [826](#L826) | return $output; |
| [827](#L827) | } |
| [828](#L828) |  |
| [829](#L829) | // Predefine `max\_items` to prevent undefined notices |
| [830](#L830) | $max\_items = 0; |
| [831](#L831) | if ( is\_object( $json\_output ) && ! empty( $json\_output->items ) ) { |
| [832](#L832) |  |
| [833](#L833) | // Sort by date uploaded |
| [834](#L834) | $json\_entry = $json\_output->items; |
| [835](#L835) |  |
| [836](#L836) | $num = ( empty( $instance['num'] ) ) ? $this->defaults['num'] : $instance['num']; |
| [837](#L837) | if ( $num > $fetch ) { |
| [838](#L838) | $fetch = $num; |
| [839](#L839) | } |
| [840](#L840) | $max\_items = ( $fetch > sizeof( $json\_entry ) ) ? sizeof( $json\_entry ) : $fetch; |
| [841](#L841) |  |
| [842](#L842) | if ( ! empty( $instance['random'] ) ) { |
| [843](#L843) | $items = array\_slice( $json\_entry, 0, $max\_items ); |
| [844](#L844) | } else { |
| [845](#L845) | if ( ! $num ) { |
| [846](#L846) | $num = 1; |
| [847](#L847) | } |
| [848](#L848) | $items = array\_slice( $json\_entry, $skip, $num ); |
| [849](#L849) | } |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | if ( 0 == $max\_items ) { |
| [853](#L853) |  |
| [854](#L854) | // Set default error message |
| [855](#L855) | $error\_msg = 'Unrecognized error experienced.'; |
| [856](#L856) |  |
| [857](#L857) | // Append YouTube DATA API error reason as comment |
| [858](#L858) | if ( ! empty( $json\_output ) && is\_object( $json\_output ) && ! empty( $json\_output->error->errors ) ) { |
| [859](#L859) |  |
| [860](#L860) | // Error went in fetch\_youtube\_feed() |
| [861](#L861) | if ( 'wpError' == $json\_output->error->errors[0]->reason ) { |
| [862](#L862) | $error\_msg = $json\_output->error->errors[0]->message; |
| [863](#L863) | } elseif ( 'playlistNotFound' == $json\_output->error->errors[0]->reason ) { |
| [864](#L864) | // Playlist error from Google API |
| [865](#L865) | if ( 'playlist' == $resource\_name ) { |
| [866](#L866) | $error\_msg = "Please check did you set existing <em>Playlist ID</em>. You set to show videos from {$resource\_nice\_name}, but YouTube does not recognize <strong>{$resource\_id}</strong> as existing and public playlist."; |
| [867](#L867) | } else { |
| [868](#L868) | $error\_msg = "Please check did you set the proper <em>Channel ID</em>. You set to show videos from {$resource\_nice\_name}, but YouTube does not recognize <strong>{$channel}</strong> as an existing or public channel."; |
| [869](#L869) | } |
| [870](#L870) | } elseif ( 'keyInvalid' == $json\_output->error->errors[0]->reason ) { |
| [871](#L871) | // Invalid YouTube Data API Key |
| [872](#L872) | $error\_msg = sprintf( \_\_( "Double check <em>YouTube Data API Key</em> on <em>General</em> plugin tab and make sure it's correct. Read <a href=\"%s\" target=\"\_blank\">Installation</a> document." ), 'https://wordpress.org/plugins/youtube-channel/installation/' ); |
| [873](#L873) | } elseif ( 'ipRefererBlocked' == $json\_output->error->errors[0]->reason ) { |
| [874](#L874) | // Restricted access YouTube Data API Key |
| [875](#L875) | $error\_msg = 'Check <em>YouTube Data API Key</em> restrictions, empty cache if enabled by appending in the browser address bar parameter <em>?ytc\_force\_recache=1</em>'; |
| [876](#L876) | } elseif ( 'invalidChannelId' == $json\_output->error->errors[0]->reason ) { |
| [877](#L877) | // (deprecated?) Non existing Channel ID set |
| [878](#L878) | $error\_msg = sprintf( \_\_( 'You have set wrong Channel ID. Fix that in General plugin settings, Widget and/or shortcode. Read <a href="%s" target="\_blank">FAQ</a> document.' ), 'https://wordpress.org/plugins/youtube-channel/faq/' ); |
| [879](#L879) | } elseif ( 'playlistItemsNotAccessible' == $json\_output->error->errors[0]->reason ) { |
| [880](#L880) | // Forbidden access to resource |
| [881](#L881) | $error\_msg = sprintf( \_\_( "You do not have permission to access ressource <strong>%s</strong> (it's maybe set to private or even does not exists!)" ), $resource\_id ); |
| [882](#L882) | } else { |
| [883](#L883) | $error\_msg = sprintf( |
| [884](#L884) | 'Reason: %1$s; Domain: %2$s; Message: %3$s', |
| [885](#L885) | $json\_output->error->errors[0]->reason, |
| [886](#L886) | $json\_output->error->errors[0]->domain, |
| [887](#L887) | $json\_output->error->errors[0]->message |
| [888](#L888) | ); |
| [889](#L889) | } |
| [890](#L890) | } // END ! empty($json\_output->error->errors) |
| [891](#L891) |  |
| [892](#L892) | $output .= $this->front\_debug( $error\_msg ); |
| [893](#L893) |  |
| [894](#L894) | } else { // ELSE if ($max\_items == 0) |
| [895](#L895) |  |
| [896](#L896) | // looks that feed is OK, let we update fallback that never expire |
| [897](#L897) | set\_transient( $cache\_key\_fallback, base64\_encode( $json ), 0 ); |
| [898](#L898) |  |
| [899](#L899) | // and now free some memory |
| [900](#L900) | unset( $json, $json\_output, $json\_entry ); |
| [901](#L901) |  |
| [902](#L902) | // set array for unique random item |
| [903](#L903) | if ( ! empty( $instance['random'] ) ) { |
| [904](#L904) | $random\_used = []; |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | /\* AU:20141230 reduce number of videos if requested > available \*/ |
| [908](#L908) | if ( $num > sizeof( $items ) ) { |
| [909](#L909) | $num = sizeof( $items ); |
| [910](#L910) | } |
| [911](#L911) |  |
| [912](#L912) | for ( $y = 1; $y <= $num; ++$y ) { |
| [913](#L913) | if ( ! empty( $instance['random'] ) ) { |
| [914](#L914) |  |
| [915](#L915) | $random\_item = mt\_rand( 0, ( count( $items ) - 1 ) ); |
| [916](#L916) | while ( $y > 1 && in\_array( $random\_item, $random\_used ) ) { |
| [917](#L917) | $random\_item = mt\_rand( 0, ( count( $items ) - 1 ) ); |
| [918](#L918) | } |
| [919](#L919) | $random\_used[] = $random\_item; |
| [920](#L920) | $item = $items[ $random\_item ]; |
| [921](#L921) | } else { |
| [922](#L922) | $item = $items[ $y - 1 ]; |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | // Generate single video block |
| [926](#L926) | $video\_block = $this->ytc\_print\_video( $item, $instance, $y ); |
| [927](#L927) | // Allow plugins/themes to override the default video block template. |
| [928](#L928) | $video\_block = apply\_filters( 'ytc\_print\_video', $video\_block, $item, $instance, $y ); |
| [929](#L929) | // Append video block to final output |
| [930](#L930) | $output .= $video\_block; |
| [931](#L931) | } |
| [932](#L932) | // Free some memory |
| [933](#L933) | unset( $random\_used, $random\_item, $json ); |
| [934](#L934) |  |
| [935](#L935) | } // END if ($max\_items == 0) |
| [936](#L936) | } // single playlist or ytc way |
| [937](#L937) |  |
| [938](#L938) | // Append link to channel on bootom of the widget |
| [939](#L939) | $output .= $this->ytc\_footer( $instance ); |
| [940](#L940) |  |
| [941](#L941) | $output .= '</div><!-- .youtube\_channel -->'; |
| [942](#L942) |  |
| [943](#L943) | // fix overflow on crappy themes |
| [944](#L944) | $output .= '<div class="clearfix"></div>'; |
| [945](#L945) |  |
| [946](#L946) | return $output; |
| [947](#L947) |  |
| [948](#L948) | } // END public function output($instance) |
| [949](#L949) |  |
| [950](#L950) | // --- HELPER FUNCTIONS --- |
| [951](#L951) |  |
| [952](#L952) | /\*\* |
| [953](#L953) | \* Download YouTube video feed through API 3.0 |
| [954](#L954) | \* @param  string $id       ID of resource |
| [955](#L955) | \* @param  integer $items   Number of items to fetch (min 2, max 50) |
| [956](#L956) | \* @return array            JSON with videos |
| [957](#L957) | \*/ |
| [958](#L958) | function fetch\_youtube\_feed( $resource\_id, $items ) { |
| [959](#L959) |  |
| [960](#L960) | $feed\_url = 'https://www.googleapis.com/youtube/v3/playlistItems?'; |
| [961](#L961) | $feed\_url .= 'part=snippet'; |
| [962](#L962) | $feed\_url .= "&playlistId={$resource\_id}"; |
| [963](#L963) | $feed\_url .= '&fields=items(snippet(title%2Cdescription%2CpublishedAt%2CresourceId(videoId)))'; |
| [964](#L964) | $feed\_url .= "&maxResults={$items}"; |
| [965](#L965) | $feed\_url .= "&key={$this->defaults['apikey']}"; |
| [966](#L966) |  |
| [967](#L967) | $wparg = [ |
| [968](#L968) | 'timeout'   => $this->defaults['timeout'], |
| [969](#L969) | 'sslverify' => $this->defaults['sslverify'] ? true : false, |
| [970](#L970) | 'headers'   => [ 'referer' => site\_url() ], |
| [971](#L971) | ]; |
| [972](#L972) |  |
| [973](#L973) | $response = wp\_remote\_get( $feed\_url, $wparg ); |
| [974](#L974) |  |
| [975](#L975) | // If we have WP error, make JSON with error |
| [976](#L976) | if ( is\_wp\_error( $response ) ) { |
| [977](#L977) |  |
| [978](#L978) | $json = sprintf( '{"error":{"errors":[{"reason":"wpError","message":"%s","domain":"wpRemoteGet"}]}}', $response->get\_error\_message() ); |
| [979](#L979) |  |
| [980](#L980) | } else { |
| [981](#L981) |  |
| [982](#L982) | $json = wp\_remote\_retrieve\_body( $response ); |
| [983](#L983) |  |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | // Free some memory |
| [987](#L987) | unset( $response ); |
| [988](#L988) |  |
| [989](#L989) | return $json; |
| [990](#L990) |  |
| [991](#L991) | } // END function fetch\_youtube\_feed($resource\_id, $items) |
| [992](#L992) |  |
| [993](#L993) | /\*\* |
| [994](#L994) | \* Print explanation of error for administrators (users with capability manage\_options) |
| [995](#L995) | \* and hidden message for lower users and visitors |
| [996](#L996) | \* @param  string $message Error message |
| [997](#L997) | \* @return string          FOrmatted message for error |
| [998](#L998) | \*/ |
| [999](#L999) | function front\_debug( $message ) { |
| [1000](#L1000) |  |
| [1001](#L1001) | // Show visible error to admin, Oops message to visitors and lower members |
| [1002](#L1002) | if ( is\_user\_logged\_in() && current\_user\_can( 'manage\_options' ) ) { |
| [1003](#L1003) |  |
| [1004](#L1004) | $output = "<p class=\"ytc\_error\"><strong>YTC ERROR:</strong> $message</p>"; |
| [1005](#L1005) |  |
| [1006](#L1006) | } else { |
| [1007](#L1007) |  |
| [1008](#L1008) | $output = \_\_( 'Oops, something went wrong.', 'youtube-channel' ); |
| [1009](#L1009) | $output .= "<!-- YTC ERROR:\n"; |
| [1010](#L1010) | $output .= strip\_tags( $message ); |
| [1011](#L1011) | $output .= "\n-->\n"; |
| [1012](#L1012) |  |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | return $output; |
| [1016](#L1016) |  |
| [1017](#L1017) | } // END function debug( $message ) |
| [1018](#L1018) |  |
| [1019](#L1019) | /\*\* |
| [1020](#L1020) | \* Calculate height by provided width and aspect ratio |
| [1021](#L1021) | \* @param  integer $width Width in pixels |
| [1022](#L1022) | \* @param  integer $ratio Selected aspect ratio (1 for 4:3, other for 16:9) |
| [1023](#L1023) | \* @return integer        Calculated height in pixels |
| [1024](#L1024) | \*/ |
| [1025](#L1025) | function height\_ratio( $width = 306, $ratio = 2 ) { |
| [1026](#L1026) |  |
| [1027](#L1027) | switch ( $ratio ) { |
| [1028](#L1028) | case 1: |
| [1029](#L1029) | $height = round( ( $width / 4 ) \* 3 ); |
| [1030](#L1030) | break; |
| [1031](#L1031) | default: |
| [1032](#L1032) | $height = round( ( $width / 16 ) \* 9 ); |
| [1033](#L1033) | } |
| [1034](#L1034) | return $height; |
| [1035](#L1035) | } // END function height\_ratio($width=306, $ratio) |
| [1036](#L1036) |  |
| [1037](#L1037) | /\*\* |
| [1038](#L1038) | \* Generate link to YouTube channel/user |
| [1039](#L1039) | \* @param  array $instance widget or shortcode settings |
| [1040](#L1040) | \* @return array           components prepared for output |
| [1041](#L1041) | \*/ |
| [1042](#L1042) | function ytc\_footer( $instance ) { |
| [1043](#L1043) |  |
| [1044](#L1044) | // Initialize output string |
| [1045](#L1045) | $output = ''; |
| [1046](#L1046) |  |
| [1047](#L1047) | // Get link to channel part |
| [1048](#L1048) | $output .= $this->ytc\_channel\_link( $instance ); |
| [1049](#L1049) |  |
| [1050](#L1050) | // Wrap content, if we have it |
| [1051](#L1051) | if ( ! empty( $output ) ) { |
| [1052](#L1052) | $output = $this->clearfix() . '<div class="ytc\_link"><p>' . $output . '</p></div>'; |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | return $output; |
| [1056](#L1056) | } // end function ytc\_footer |
| [1057](#L1057) |  |
| [1058](#L1058) | function clearfix() { |
| [1059](#L1059) | return '<div class="clearfix"></div>'; |
| [1060](#L1060) | } |
| [1061](#L1061) | /\*\* |
| [1062](#L1062) | \* Generate link to YouTube channel/user |
| [1063](#L1063) | \* @param  array $instance widget or shortcode settings |
| [1064](#L1064) | \* @return array           components prepared for output |
| [1065](#L1065) | \*/ |
| [1066](#L1066) | function ytc\_channel\_link( $instance ) { |
| [1067](#L1067) |  |
| [1068](#L1068) | // Initialize output string |
| [1069](#L1069) | $output = ''; |
| [1070](#L1070) |  |
| [1071](#L1071) | // do we need to show goto link? |
| [1072](#L1072) | if ( ! empty( $instance['link\_to'] ) && 'none' != $instance['link\_to'] ) { |
| [1073](#L1073) |  |
| [1074](#L1074) | $goto\_url = 'https://www.youtube.com/'; |
| [1075](#L1075) |  |
| [1076](#L1076) | switch ( $instance['link\_to'] ) { |
| [1077](#L1077) | case 'vanity': |
| [1078](#L1078) | $vanity   = trim( $instance['vanity'] ); |
| [1079](#L1079) | if ( empty( $vanity ) ) { |
| [1080](#L1080) | if ( empty( $this->defaults['vanity'] ) ) { |
| [1081](#L1081) | return '<!-- YTC ERROR: Selected Vanity custom URL to be linked but no Vanity Name provided! -->'; |
| [1082](#L1082) | } |
| [1083](#L1083) | // Get vanity from defaults if not set in instance |
| [1084](#L1084) | $vanity = $this->defaults['vanity']; |
| [1085](#L1085) | } |
| [1086](#L1086) | // sanity vanity content (strip all in front of last slash to cleanup vanity ID only) |
| [1087](#L1087) | if ( ! empty( $vanity ) && false !== strpos( $vanity, 'youtube.com' ) ) { |
| [1088](#L1088) | $vanity = preg\_replace( '/^.\*\//', '', $vanity ); |
| [1089](#L1089) | } |
| [1090](#L1090) | $goto\_url .= "c/$vanity"; |
| [1091](#L1091) | break; |
| [1092](#L1092) |  |
| [1093](#L1093) | case 'legacy': |
| [1094](#L1094) | $username = trim( $instance['username'] ); |
| [1095](#L1095) | if ( empty( $username ) ) { |
| [1096](#L1096) | if ( empty( $this->defaults['username'] ) ) { |
| [1097](#L1097) | return '<!-- YTC ERROR: Selected Legacy username to be linked but no Legacy username provided! -->'; |
| [1098](#L1098) | } |
| [1099](#L1099) | $username = $this->defaults['username']; |
| [1100](#L1100) | } |
| [1101](#L1101) | $goto\_url .= "user/$username"; |
| [1102](#L1102) | break; |
| [1103](#L1103) |  |
| [1104](#L1104) | case 'channel': |
| [1105](#L1105) | $channel  = trim( $instance['channel'] ); |
| [1106](#L1106) | if ( empty( $channel ) ) { |
| [1107](#L1107) | if ( empty( $this->defaults['channel'] ) ) { |
| [1108](#L1108) | return '<!-- YTC ERROR: Selected Channel page to be linked but no Channel ID provided! -->'; |
| [1109](#L1109) | } |
| [1110](#L1110) | $channel = $this->defaults['channel']; |
| [1111](#L1111) | } |
| [1112](#L1112) | $goto\_url .= "channel/$channel"; |
| [1113](#L1113) | break; |
| [1114](#L1114) | } |
| [1115](#L1115) |  |
| [1116](#L1116) | $goto\_txt = trim( $instance['goto\_txt'] ); |
| [1117](#L1117) | if ( '' == $goto\_txt ) { |
| [1118](#L1118) | $goto\_txt = \_\_( 'Visit our YouTube channel', 'youtube-channel' ); |
| [1119](#L1119) | } |
| [1120](#L1120) |  |
| [1121](#L1121) | $newtab = \_\_( 'in new window/tab', 'youtube-channel' ); |
| [1122](#L1122) |  |
| [1123](#L1123) | switch ( $instance['popup\_goto'] ) { |
| [1124](#L1124) | case 1: |
| [1125](#L1125) | $output .= "<a href=\"javascript: window.open('{$goto\_url}'); void 0;\" title=\"{$goto\_txt} {$newtab}\">{$goto\_txt}</a>"; |
| [1126](#L1126) | break; |
| [1127](#L1127) | case 2: |
| [1128](#L1128) | $output .= "<a href=\"{$goto\_url}\" target=\"\_blank\" title=\"{$goto\_txt} {$newtab}\">{$goto\_txt}</a>"; |
| [1129](#L1129) | break; |
| [1130](#L1130) | default: |
| [1131](#L1131) | $output .= "<a href=\"{$goto\_url}\" title=\"{$goto\_txt}\">$goto\_txt</a>"; |
| [1132](#L1132) | } // switch popup\_goto |
| [1133](#L1133) |  |
| [1134](#L1134) | } // END if ( ! empty( $instance['link\_to'] ) && 'none' != $instance['link\_to'] ) |
| [1135](#L1135) |  |
| [1136](#L1136) | return $output; |
| [1137](#L1137) | } // END function ytc\_channel\_link |
| [1138](#L1138) |  |
| [1139](#L1139) |  |
| [1140](#L1140) | /\*\* |
| [1141](#L1141) | \* Generate output for single video block |
| [1142](#L1142) | \* @param  object $item     Video object from JSON |
| [1143](#L1143) | \* @param  array  $instance Settings from widget or shortcode |
| [1144](#L1144) | \* @param  int    $y        Order number of video |
| [1145](#L1145) | \* @return array            Prepared single video block as array to concatenate |
| [1146](#L1146) | \*/ |
| [1147](#L1147) | function ytc\_print\_video( $item, $instance, $y ) { |
| [1148](#L1148) |  |
| [1149](#L1149) | // Start output string |
| [1150](#L1150) | $output = ''; |
| [1151](#L1151) |  |
| [1152](#L1152) | // Calculate width and height |
| [1153](#L1153) | if ( empty( $instance['width'] ) ) { |
| [1154](#L1154) | $instance['width'] = $this->defaults['width']; |
| [1155](#L1155) | } |
| [1156](#L1156) | if ( empty( $instance['ratio'] ) ) { |
| [1157](#L1157) | $instance['ratio'] = $this->defaults['ratio']; |
| [1158](#L1158) | } |
| [1159](#L1159) | $height = $this->height\_ratio( $instance['width'], $instance['ratio'] ); |
| [1160](#L1160) |  |
| [1161](#L1161) | // How to display videos? |
| [1162](#L1162) | if ( empty( $instance['display'] ) ) { |
| [1163](#L1163) | $instance['display'] = 'thumbnail'; |
| [1164](#L1164) | } |
| [1165](#L1165) |  |
| [1166](#L1166) | // Extract details about video from Resource |
| [1167](#L1167) | $yt\_id    = $item->snippet->resourceId->videoId; |
| [1168](#L1168) | $yt\_title = $item->snippet->title; |
| [1169](#L1169) | $yt\_date  = $item->snippet->publishedAt; |
| [1170](#L1170) |  |
| [1171](#L1171) | // Enhanced privacy? |
| [1172](#L1172) | $youtube\_domain = $this->youtube\_domain( $instance ); |
| [1173](#L1173) |  |
| [1174](#L1174) | switch ( $y ) { |
| [1175](#L1175) | case 1: |
| [1176](#L1176) | $vnumclass = 'first'; |
| [1177](#L1177) | break; |
| [1178](#L1178) | case $instance['num']: |
| [1179](#L1179) | $autoplay = false; |
| [1180](#L1180) | $vnumclass = 'last'; |
| [1181](#L1181) | break; |
| [1182](#L1182) | default: |
| [1183](#L1183) | $vnumclass = 'mid'; |
| [1184](#L1184) | $autoplay = false; |
| [1185](#L1185) | break; |
| [1186](#L1186) | } |
| [1187](#L1187) |  |
| [1188](#L1188) | // Set proper class for responsive thumbs per selected aspect ratio |
| [1189](#L1189) | $arclass = $this->arclass( $instance ); |
| [1190](#L1190) |  |
| [1191](#L1191) | // Prepare title\_tag (H3, etc) |
| [1192](#L1192) | $title\_tag = isset( $instance['titletag'] ) ? $instance['titletag'] : $this->defaults['titletag']; |
| [1193](#L1193) |  |
| [1194](#L1194) | $output .= "<div class=\"ytc\_video\_container ytc\_video\_{$y} ytc\_video\_{$vnumclass} ${arclass}\" style=\"width:{$instance['width']}px\">"; |
| [1195](#L1195) |  |
| [1196](#L1196) | // Show video title above video? |
| [1197](#L1197) | if ( ! empty( $instance['showtitle'] ) ) { |
| [1198](#L1198) | if ( |
| [1199](#L1199) | // for non-thumbnail for `above` and `inside` |
| [1200](#L1200) | ( 'thumbnail' != $instance['display'] && in\_array( $instance['showtitle'], [ 'above', 'inside' ] ) ) || |
| [1201](#L1201) | // for thubmanil only if it's `below` |
| [1202](#L1202) | ( 'thumbnail' == $instance['display'] && 'above' == $instance['showtitle'] ) |
| [1203](#L1203) | ) { |
| [1204](#L1204) | if ( ! empty( $instance['linktitle'] ) ) { |
| [1205](#L1205) | $output .= sprintf( |
| [1206](#L1206) | '<%1$s class="ytc\_title ytc\_title\_above"><a href="https://%3$s/watch/?v=%4$s" target="youtube">%2$s</a></%1$s>', |
| [1207](#L1207) | $title\_tag, |
| [1208](#L1208) | $yt\_title, |
| [1209](#L1209) | $youtube\_domain, |
| [1210](#L1210) | $yt\_id |
| [1211](#L1211) | ); |
| [1212](#L1212) | } else { |
| [1213](#L1213) | $output .= sprintf( |
| [1214](#L1214) | '<%1$s class="ytc\_title ytc\_title\_above">%2$s</%1$s>', |
| [1215](#L1215) | $title\_tag, |
| [1216](#L1216) | $yt\_title |
| [1217](#L1217) | ); |
| [1218](#L1218) | } |
| [1219](#L1219) | } |
| [1220](#L1220) | } |
| [1221](#L1221) |  |
| [1222](#L1222) | // Print out video |
| [1223](#L1223) | if ( 'iframe' == $instance['display'] ) { |
| [1224](#L1224) |  |
| [1225](#L1225) | // Start wrapper for responsive item |
| [1226](#L1226) | if ( $instance['responsive'] ) { |
| [1227](#L1227) | $output .= '<div class="fluid-width-video-wrapper">'; |
| [1228](#L1228) | } |
| [1229](#L1229) |  |
| [1230](#L1230) | $output .= "<iframe title=\"YouTube Video Player\" width=\"{$instance['width']}\" height=\"{$height}\" src=\"//{$youtube\_domain}/embed/{$yt\_id}?wmode=opaque"; |
| [1231](#L1231) |  |
| [1232](#L1232) | // disable related vides |
| [1233](#L1233) | if ( ! empty( $instance['norel'] ) ) { |
| [1234](#L1234) | $output .= '&amp;rel=0'; |
| [1235](#L1235) | } |
| [1236](#L1236) | if ( ! empty( $instance['controls'] ) ) { |
| [1237](#L1237) | $output .= '&amp;controls=0'; |
| [1238](#L1238) | } |
| [1239](#L1239) | if ( ! empty( $instance['autoplay'] ) && 1 == $y ) { |
| [1240](#L1240) | $output .= '&amp;autoplay=1'; |
| [1241](#L1241) | } |
| [1242](#L1242) | if ( ! empty( $instance['hideanno'] ) ) { |
| [1243](#L1243) | $output .= '&amp;iv\_load\_policy=3'; |
| [1244](#L1244) | } |
| [1245](#L1245) | if ( ! empty( $instance['modestbranding'] ) ) { |
| [1246](#L1246) | $output .= '&amp;modestbranding=1'; |
| [1247](#L1247) | } |
| [1248](#L1248) | if ( ! empty( $instance['playsinline'] ) ) { |
| [1249](#L1249) | $output .= '&amp;playsinline=1'; |
| [1250](#L1250) | } |
| [1251](#L1251) |  |
| [1252](#L1252) | $output .= "\" style=\"border:0;\" allowfullscreen id=\"ytc\_{$yt\_id}\"></iframe>"; |
| [1253](#L1253) |  |
| [1254](#L1254) | // Close wrapper for responsive item |
| [1255](#L1255) | if ( $instance['responsive'] ) { |
| [1256](#L1256) | $output .= '</div>'; |
| [1257](#L1257) | } |
| [1258](#L1258) | } elseif ( 'iframe2' == $instance['display'] ) { |
| [1259](#L1259) |  |
| [1260](#L1260) | // youtube API async |
| [1261](#L1261) | $js\_vars = ''; |
| [1262](#L1262) | $js\_vars .= ( ! empty( $instance['norel'] ) ) ? 'rel:0,' : ''; |
| [1263](#L1263) | $js\_vars .= ( ! empty( $instance['autoplay'] ) && 1 == $y ) ? 'autoplay:1,' : ''; |
| [1264](#L1264) | $js\_vars .= ( ! empty( $instance['controls'] ) ) ? 'controls:0,' : ''; |
| [1265](#L1265) | $js\_vars .= ( ! empty( $instance['modestbranding'] ) ) ? 'modestbranding:1,' : ''; |
| [1266](#L1266) | $js\_vars .= ( ! empty( $instance['playsinline'] ) ) ? 'playsinline:1,' : ''; |
| [1267](#L1267) | $js\_vars .= "wmmode:'opaque'"; |
| [1268](#L1268) | $js\_vars = rtrim( $js\_vars, ',' ); |
| [1269](#L1269) |  |
| [1270](#L1270) | $js\_end = ''; |
| [1271](#L1271) | $js\_end .= ( ! empty( $instance['hideanno'] ) ) ? 'iv\_load\_policy:3,' : ''; |
| [1272](#L1272) | $js\_end .= ( ! empty( $instance['autoplay'] ) && ( 1 == $y ) && ! empty( $instance['autoplay\_mute'] ) ) ? "events:{'onReady':ytc\_mute}," : ''; |
| [1273](#L1273) | $js\_end = rtrim( $js\_end, ',' ); |
| [1274](#L1274) |  |
| [1275](#L1275) | $js\_player\_id      = str\_replace( '-', '\_', $yt\_id ); |
| [1276](#L1276) |  |
| [1277](#L1277) | // Start wrapper for responsive item |
| [1278](#L1278) | if ( $instance['responsive'] ) { |
| [1279](#L1279) | $output .= '<div class="fluid-width-video-wrapper">'; |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | $output .= "<div id=\"ytc\_player\_{$js\_player\_id}\"></div>"; |
| [1283](#L1283) |  |
| [1284](#L1284) | // Close wrapper for responsive item |
| [1285](#L1285) | if ( $instance['responsive'] ) { |
| [1286](#L1286) | $output .= '</div>'; |
| [1287](#L1287) | } |
| [1288](#L1288) |  |
| [1289](#L1289) | $site\_domain = $\_SERVER['HTTP\_HOST']; |
| [1290](#L1290) | $ytc\_html5\_js = "var ytc\_player\_{$js\_player\_id};"; |
| [1291](#L1291) | $ytc\_html5\_js .= "ytc\_player\_{$js\_player\_id}=new YT.Player('ytc\_player\_{$js\_player\_id}',{height:'{$height}',width:'{$instance['width']}',"; |
| [1292](#L1292) | $ytc\_html5\_js .= "videoId:'{$yt\_id}',enablejsapi:1,playerVars:{{$js\_vars}},origin:'{$site\_domain}',{$js\_end}});"; |
| [1293](#L1293) |  |
| [1294](#L1294) | // prepare JS for footer |
| [1295](#L1295) | if ( empty( $this->ytc\_html5\_js ) ) { |
| [1296](#L1296) | $this->ytc\_html5\_js = $ytc\_html5\_js; |
| [1297](#L1297) | } else { |
| [1298](#L1298) | $this->ytc\_html5\_js .= $ytc\_html5\_js; |
| [1299](#L1299) | } |
| [1300](#L1300) | } else { // default is thumbnail |
| [1301](#L1301) |  |
| [1302](#L1302) | // Do we need tooltip for thumbnail? |
| [1303](#L1303) | if ( empty( $instance['no\_thumb\_title'] ) ) { |
| [1304](#L1304) | $title = sprintf( \_\_( 'Watch video %1$s published on %2$s', 'youtube-channel' ), $yt\_title, $yt\_date ); |
| [1305](#L1305) | } |
| [1306](#L1306) |  |
| [1307](#L1307) | $p = ''; |
| [1308](#L1308) | $target = ''; |
| [1309](#L1309) | if ( empty( $instance['nolightbox'] ) ) { |
| [1310](#L1310) | if ( ! empty( $instance['norel'] ) ) { |
| [1311](#L1311) | $p .= '&amp;rel=0'; |
| [1312](#L1312) | } |
| [1313](#L1313) | if ( ! empty( $instance['modestbranding'] ) ) { |
| [1314](#L1314) | $p .= '&amp;modestbranding=1'; |
| [1315](#L1315) | } |
| [1316](#L1316) | if ( ! empty( $instance['controls'] ) ) { |
| [1317](#L1317) | $p .= '&amp;controls=0'; |
| [1318](#L1318) | } |
| [1319](#L1319) | if ( ! empty( $instance['playsinline'] ) ) { |
| [1320](#L1320) | $p .= '&amp;playsinline=1'; |
| [1321](#L1321) | } |
| [1322](#L1322) | if ( ! empty( $instance['privacy'] ) ) { |
| [1323](#L1323) | $p .= '&amp;enhanceprivacy=1'; |
| [1324](#L1324) | } |
| [1325](#L1325) | $lightbox\_class = 'ytc-lightbox'; |
| [1326](#L1326) | } else { |
| [1327](#L1327) | $lightbox\_class = 'ytc-nolightbox'; |
| [1328](#L1328) | if ( ! empty( $instance['target'] ) ) { |
| [1329](#L1329) | $target = 'target="' . sanitize\_key( $instance['target'] ) . '"'; |
| [1330](#L1330) | } |
| [1331](#L1331) | } |
| [1332](#L1332) |  |
| [1333](#L1333) | // Do we need thumbnail w/ or w/o tooltip |
| [1334](#L1334) | $tag\_title = ( empty( $instance['no\_thumb\_title'] ) ) ? $tag\_title = "title=\"{$yt\_title}\"" : ''; |
| [1335](#L1335) |  |
| [1336](#L1336) | // Define video thumbnail |
| [1337](#L1337) | switch ( $instance['thumb\_quality'] ) { |
| [1338](#L1338) | case 'default': |
| [1339](#L1339) | case 'mqdefault': |
| [1340](#L1340) | case 'hqdefault': |
| [1341](#L1341) | case 'sddefault': |
| [1342](#L1342) | case 'maxresdefault': |
| [1343](#L1343) | $thumb\_quality = $instance['thumb\_quality']; |
| [1344](#L1344) | break; |
| [1345](#L1345) | default: |
| [1346](#L1346) | $thumb\_quality = 'hqdefault'; |
| [1347](#L1347) | } |
| [1348](#L1348) | $yt\_thumb  = "//img.youtube.com/vi/${yt\_id}/${thumb\_quality}.jpg"; // zero for HD thumb |
| [1349](#L1349) |  |
| [1350](#L1350) | // Show video title inside video? |
| [1351](#L1351) | $title\_inside = ''; |
| [1352](#L1352) | if ( ! empty( $instance['showtitle'] ) && in\_array( $instance['showtitle'], [ 'inside', 'inside\_b' ] ) ) { |
| [1353](#L1353) | $title\_inside = sprintf( |
| [1354](#L1354) | '<%1$s class="ytc\_title ytc\_title\_inside %3$s">%2$s</%1$s>', |
| [1355](#L1355) | $title\_tag, |
| [1356](#L1356) | $yt\_title, |
| [1357](#L1357) | 'inside\_b' == $instance['showtitle'] ? 'ytc\_title\_inside\_bottom' : '' |
| [1358](#L1358) | ); |
| [1359](#L1359) | } |
| [1360](#L1360) |  |
| [1361](#L1361) | $output .= "<a href=\"//www.youtube.com/watch?v=${yt\_id}${p}\" ${tag\_title} class=\"ytc\_thumb ${lightbox\_class} ${arclass}\" ${target}><span style=\"background-image: url(${yt\_thumb});\" ${tag\_title} id=\"ytc\_{$yt\_id}\">{$title\_inside}</span></a>"; |
| [1362](#L1362) |  |
| [1363](#L1363) | } // what to show conditions |
| [1364](#L1364) |  |
| [1365](#L1365) | // Show video title below video? |
| [1366](#L1366) | if ( ! empty( $instance['showtitle'] ) ) { |
| [1367](#L1367) | if ( |
| [1368](#L1368) | // for non-thumbnail for `below` and `inside\_b` |
| [1369](#L1369) | ( 'thumbnail' != $instance['display'] && in\_array( $instance['showtitle'], [ 'below', 'inside\_b' ] ) ) || |
| [1370](#L1370) | // for thubmanil only if it's `below` |
| [1371](#L1371) | ( 'thumbnail' == $instance['display'] && 'below' == $instance['showtitle'] ) |
| [1372](#L1372) | ) { |
| [1373](#L1373) | if ( ! empty( $instance['linktitle'] ) ) { |
| [1374](#L1374) |  |
| [1375](#L1375) | $output .= sprintf( |
| [1376](#L1376) | '<%1$s class="ytc\_title ytc\_title\_below"><a href="https://%3$s/watch/?v=%4$s" target="youtube">%2$s</a></%1$s>', |
| [1377](#L1377) | $title\_tag, |
| [1378](#L1378) | $yt\_title, |
| [1379](#L1379) | $youtube\_domain, |
| [1380](#L1380) | $yt\_id |
| [1381](#L1381) | ); |
| [1382](#L1382) | } else { |
| [1383](#L1383) | $output .= sprintf( |
| [1384](#L1384) | '<%1$s class="ytc\_title ytc\_title\_below">%2$s</%1$s>', |
| [1385](#L1385) | $title\_tag, |
| [1386](#L1386) | $yt\_title |
| [1387](#L1387) | ); |
| [1388](#L1388) | } |
| [1389](#L1389) | } |
| [1390](#L1390) | } |
| [1391](#L1391) |  |
| [1392](#L1392) | // do we need to show video description? |
| [1393](#L1393) | if ( ! empty( $instance['showdesc'] ) ) { |
| [1394](#L1394) |  |
| [1395](#L1395) | $video\_description = $item->snippet->description; |
| [1396](#L1396) | $etcetera = ''; |
| [1397](#L1397) | ##TODO: If description should note be shortened, print HTML formatted desc |
| [1398](#L1398) | if ( $instance['desclen'] > 0 ) { |
| [1399](#L1399) | if ( function\_exists( 'mb\_strlen' ) && function\_exists( 'mb\_substr' ) ) { |
| [1400](#L1400) | if ( mb\_strlen( $video\_description ) > $instance['desclen'] ) { |
| [1401](#L1401) | $video\_description = mb\_substr( $video\_description, 0, $instance['desclen'] ); |
| [1402](#L1402) | $etcetera = '&hellip;'; |
| [1403](#L1403) | } |
| [1404](#L1404) | } else { |
| [1405](#L1405) | if ( strlen( $video\_description ) > $instance['desclen'] ) { |
| [1406](#L1406) | $video\_description = substr( $video\_description, 0, $instance['desclen'] ); |
| [1407](#L1407) | $etcetera = '&hellip;'; |
| [1408](#L1408) | } |
| [1409](#L1409) | } |
| [1410](#L1410) | } |
| [1411](#L1411) |  |
| [1412](#L1412) | if ( ! empty( $video\_description ) ) { |
| [1413](#L1413) | $output .= "<p class=\"ytc\_description\">{$video\_description}{$etcetera}</p>"; |
| [1414](#L1414) | } |
| [1415](#L1415) | } |
| [1416](#L1416) |  |
| [1417](#L1417) | $output .= '</div><!-- .ytc\_video\_container -->'; |
| [1418](#L1418) |  |
| [1419](#L1419) | return $output; |
| [1420](#L1420) | } // end function ytc\_print\_video |
| [1421](#L1421) |  |
| [1422](#L1422) | /\* function to print standard playlist embed code \*/ |
| [1423](#L1423) | function embed\_playlist( $resource\_id, $instance ) { |
| [1424](#L1424) |  |
| [1425](#L1425) | $width          = empty( $instance['width'] ) ? 306 : $instance['width']; |
| [1426](#L1426) | $height         = self::height\_ratio( $width, $instance['ratio'] ); |
| [1427](#L1427) | $autoplay       = empty( $instance['autoplay'] ) ? '' : '&autoplay=1'; |
| [1428](#L1428) | $modestbranding = empty( $instance['modestbranding'] ) ? '' : '&modestbranding=1'; |
| [1429](#L1429) | $rel            = empty( $instance['norel'] ) ? '' : '&rel=0'; |
| [1430](#L1430) | $playsinline    = empty( $instance['playsinline'] ) ? '' : '&playsinline=1'; |
| [1431](#L1431) |  |
| [1432](#L1432) | // enhanced privacy |
| [1433](#L1433) | $youtube\_domain = $this->youtube\_domain( $instance ); |
| [1434](#L1434) | $arclass = $this->arclass( $instance ); |
| [1435](#L1435) |  |
| [1436](#L1436) | // Start output string |
| [1437](#L1437) | $output = ''; |
| [1438](#L1438) |  |
| [1439](#L1439) | $output .= "<div class=\"ytc\_video\_container ytc\_video\_1 ytc\_video\_single ytc\_playlist\_only {$arclass}\">"; |
| [1440](#L1440) | $output .= '<div class="fluid-width-video-wrapper">'; |
| [1441](#L1441) | $output .= "<iframe src=\"//{$youtube\_domain}/embed/videoseries?list={$resource\_id}{$autoplay}{$modestbranding}{$rel}\""; |
| [1442](#L1442) | if ( ! empty( $instance['fullscreen'] ) ) { |
| [1443](#L1443) | $output .= ' allowfullscreen'; |
| [1444](#L1444) | } |
| [1445](#L1445) | $output .= " width=\"{$width}\" height=\"{$height}\" frameborder=\"0\"></iframe>"; |
| [1446](#L1446) | $output .= '</div><!-- .fluid-width-video-wrapper -->'; |
| [1447](#L1447) | $output .= '</div><!-- .ytc\_video\_container -->'; |
| [1448](#L1448) |  |
| [1449](#L1449) | return $output; |
| [1450](#L1450) |  |
| [1451](#L1451) | } // END function embed\_playlist($resource\_id, $instance) |
| [1452](#L1452) |  |
| [1453](#L1453) | // Helper function cache\_time() |
| [1454](#L1454) | function cache\_time( $cache\_time ) { |
| [1455](#L1455) |  |
| [1456](#L1456) | $out = ''; |
| [1457](#L1457) | $times = self::cache\_times\_arr(); |
| [1458](#L1458) | foreach ( $times as $sec => $title ) { |
| [1459](#L1459) | $out .= '<option value="' . $sec . '" ' . selected( $cache\_time, $sec, 0 ) . '>' . $title . '</option>'; |
| [1460](#L1460) | unset( $sec ); |
| [1461](#L1461) | } |
| [1462](#L1462) |  |
| [1463](#L1463) | return $out; |
| [1464](#L1464) |  |
| [1465](#L1465) | } // END function cache\_time() |
| [1466](#L1466) |  |
| [1467](#L1467) | /\*\* |
| [1468](#L1468) | \* Define cache times array |
| [1469](#L1469) | \*/ |
| [1470](#L1470) | public static function cache\_times\_arr() { |
| [1471](#L1471) |  |
| [1472](#L1472) | return [ |
| [1473](#L1473) | '0'       => \_\_( 'Do not cache', 'youtube-channel' ), |
| [1474](#L1474) | '60'      => \_\_( '1 minute', 'youtube-channel' ), |
| [1475](#L1475) | '300'     => \_\_( '5 minutes', 'youtube-channel' ), |
| [1476](#L1476) | '900'     => \_\_( '15 minutes', 'youtube-channel' ), |
| [1477](#L1477) | '1800'    => \_\_( '30 minutes', 'youtube-channel' ), |
| [1478](#L1478) | '3600'    => \_\_( '1 hour', 'youtube-channel' ), |
| [1479](#L1479) | '7200'    => \_\_( '2 hours', 'youtube-channel' ), |
| [1480](#L1480) | '18000'   => \_\_( '5 hours', 'youtube-channel' ), |
| [1481](#L1481) | '36000'   => \_\_( '10 hours', 'youtube-channel' ), |
| [1482](#L1482) | '43200'   => \_\_( '12 hours', 'youtube-channel' ), |
| [1483](#L1483) | '64800'   => \_\_( '18 hours', 'youtube-channel' ), |
| [1484](#L1484) | '86400'   => \_\_( '1 day', 'youtube-channel' ), |
| [1485](#L1485) | '172800'  => \_\_( '2 days', 'youtube-channel' ), |
| [1486](#L1486) | '259200'  => \_\_( '3 days', 'youtube-channel' ), |
| [1487](#L1487) | '345600'  => \_\_( '4 days', 'youtube-channel' ), |
| [1488](#L1488) | '432000'  => \_\_( '5 days', 'youtube-channel' ), |
| [1489](#L1489) | '518400'  => \_\_( '6 days', 'youtube-channel' ), |
| [1490](#L1490) | '604800'  => \_\_( '1 week', 'youtube-channel' ), |
| [1491](#L1491) | '1209600' => \_\_( '2 weeks', 'youtube-channel' ), |
| [1492](#L1492) | '1814400' => \_\_( '3 weeks', 'youtube-channel' ), |
| [1493](#L1493) | '2419200' => \_\_( '1 month', 'youtube-channel' ), |
| [1494](#L1494) | ]; |
| [1495](#L1495) |  |
| [1496](#L1496) | } // END public static function cache\_times\_arr() |
| [1497](#L1497) |  |
| [1498](#L1498) | /\*\* |
| [1499](#L1499) | \* Method to delete all YTC transient caches |
| [1500](#L1500) | \* @return string Report message about success or failed purge cache |
| [1501](#L1501) | \*/ |
| [1502](#L1502) | function clear\_all\_cache() { |
| [1503](#L1503) |  |
| [1504](#L1504) | global $wpdb; |
| [1505](#L1505) |  |
| [1506](#L1506) | $ret = $wpdb->query( |
| [1507](#L1507) | $wpdb->prepare( |
| [1508](#L1508) | "DELETE FROM $wpdb->options |
| [1509](#L1509) | WHERE option\_name LIKE %s |
| [1510](#L1510) | OR option\_name LIKE %s |
| [1511](#L1511) | ", |
| [1512](#L1512) | '\_transient\_timeout\_ytc\_%', |
| [1513](#L1513) | '\_transient\_ytc\_%' |
| [1514](#L1514) | ) |
| [1515](#L1515) | ); |
| [1516](#L1516) |  |
| [1517](#L1517) | if ( false === $ret ) { |
| [1518](#L1518) | echo 'Oops, we did not cleared any YouTube Channel cache because some error occured'; |
| [1519](#L1519) | } else { |
| [1520](#L1520) | if ( 0 == $ret ) { |
| [1521](#L1521) | echo 'Congratulations! You can chill, there is no YouTube Channel caches.'; |
| [1522](#L1522) | } else { |
| [1523](#L1523) | echo "Success! We cleared $ret row/s with YouTube Channel caches."; |
| [1524](#L1524) | } |
| [1525](#L1525) | } |
| [1526](#L1526) | exit(); |
| [1527](#L1527) |  |
| [1528](#L1528) | } // END function clear\_all\_cache() |
| [1529](#L1529) |  |
| [1530](#L1530) | /\*\* |
| [1531](#L1531) | \* Return nice name for resource by provided resource ID |
| [1532](#L1532) | \* @param  integer $resource\_id Resource ID |
| [1533](#L1533) | \* @return string               Resource nice name |
| [1534](#L1534) | \*/ |
| [1535](#L1535) | function resource\_nice\_name( $resource\_id ) { |
| [1536](#L1536) | if ( 0 == $resource\_id ) { |
| [1537](#L1537) | $resource\_nice\_name = 'Channel (User uploads)'; |
| [1538](#L1538) | } elseif ( 1 == $resource\_id ) { |
| [1539](#L1539) | $resource\_nice\_name = 'Favourited videos'; |
| [1540](#L1540) | } elseif ( 2 == $resource\_id ) { |
| [1541](#L1541) | $resource\_nice\_name = 'Liked videos'; |
| [1542](#L1542) | } elseif ( 3 == $resource\_id ) { |
| [1543](#L1543) | $resource\_nice\_name = 'Liked videos'; |
| [1544](#L1544) | } else { |
| [1545](#L1545) | $resource\_nice\_name = 'Unknown resource'; |
| [1546](#L1546) | } |
| [1547](#L1547) | return $resource\_nice\_name; |
| [1548](#L1548) | } // END function resource\_nice\_name( $resource\_id ) |
| [1549](#L1549) |  |
| [1550](#L1550) | function youtube\_domain( $instance ) { |
| [1551](#L1551) | return empty( $instance['privacy'] ) ? 'www.youtube.com' : 'www.youtube-nocookie.com'; |
| [1552](#L1552) | } // END function youtube\_domain |
| [1553](#L1553) |  |
| [1554](#L1554) | function arclass( $instance ) { |
| [1555](#L1555) | return ! empty( $instance['ratio'] ) && 1 == $instance['ratio'] ? 'ar4\_3' : 'ar16\_9'; |
| [1556](#L1556) | } // END function arclass() |
| [1557](#L1557) |  |
| [1558](#L1558) | /\*\* |
| [1559](#L1559) | \* Register TinyMCE button for YTC |
| [1560](#L1560) | \* @param  array $plugins Unmodified set of plugins |
| [1561](#L1561) | \* @return array          Set of TinyMCE plugins with YTC addition |
| [1562](#L1562) | \*/ |
| [1563](#L1563) | function mce\_external\_plugins( $plugins ) { |
| [1564](#L1564) |  |
| [1565](#L1565) | $plugins['youtube\_channel'] = plugin\_dir\_url( \_\_FILE\_\_ ) . 'inc/tinymce/plugin.min.js'; |
| [1566](#L1566) |  |
| [1567](#L1567) | return $plugins; |
| [1568](#L1568) |  |
| [1569](#L1569) | } // END function mce\_external\_plugins() |
| [1570](#L1570) |  |
| [1571](#L1571) | /\*\* |
| [1572](#L1572) | \* Append TinyMCE button for YTC at the end of row 1 |
| [1573](#L1573) | \* @param  array $buttons Unmodified set of buttons |
| [1574](#L1574) | \* @return array          Set of TinyMCE buttons with YTC addition |
| [1575](#L1575) | \*/ |
| [1576](#L1576) | function mce\_buttons( $buttons ) { |
| [1577](#L1577) |  |
| [1578](#L1578) | $buttons[] = 'youtube\_channel\_shortcode'; |
| [1579](#L1579) | return $buttons; |
| [1580](#L1580) |  |
| [1581](#L1581) | } // END function mce\_buttons() |
| [1582](#L1582) |  |
| [1583](#L1583) | function generate\_debug\_json() { |
| [1584](#L1584) | global $wp\_version; |
| [1585](#L1585) |  |
| [1586](#L1586) | // get widget ID from parameter |
| [1587](#L1587) | $for = trim( $\_GET['ytc\_debug\_json\_for'] ); |
| [1588](#L1588) |  |
| [1589](#L1589) | if ( 'global' == $for ) { |
| [1590](#L1590) | // global settings |
| [1591](#L1591) | $options = get\_option( 'youtube\_channel\_defaults' ); |
| [1592](#L1592) |  |
| [1593](#L1593) | if ( ! is\_array( $options ) ) { |
| [1594](#L1594) | return; |
| [1595](#L1595) | } |
| [1596](#L1596) |  |
| [1597](#L1597) | // Remove YouTube Data API Key from config JSON |
| [1598](#L1598) | unset( $options['apikey'] ); |
| [1599](#L1599) |  |
| [1600](#L1600) | } else { |
| [1601](#L1601) | // widget |
| [1602](#L1602) | $widget\_id = (int) $for; |
| [1603](#L1603) | $for = "youtube-channel-{$for}"; |
| [1604](#L1604) |  |
| [1605](#L1605) | // get YTC widgets options |
| [1606](#L1606) | $widget\_options = get\_option( 'widget\_youtube-channel' ); |
| [1607](#L1607) |  |
| [1608](#L1608) | if ( ! is\_array( $widget\_options[ $widget\_id ] ) ) { |
| [1609](#L1609) | return; |
| [1610](#L1610) | } |
| [1611](#L1611) |  |
| [1612](#L1612) | $options = $widget\_options[ $widget\_id ]; |
| [1613](#L1613) | unset( $widget\_options ); |
| [1614](#L1614) | } |
| [1615](#L1615) |  |
| [1616](#L1616) | // prepare debug data with settings of current widget |
| [1617](#L1617) | $data = array\_merge( |
| [1618](#L1618) | [ |
| [1619](#L1619) | 'date'   => date( 'r' ), |
| [1620](#L1620) | 'server' => $\_SERVER['SERVER\_SOFTWARE'], |
| [1621](#L1621) | 'php'    => PHP\_VERSION, |
| [1622](#L1622) | 'wp'     => $wp\_version, |
| [1623](#L1623) | 'ytc'    => self::VER, |
| [1624](#L1624) | 'url'    => get\_site\_url(), |
| [1625](#L1625) | 'for'    => $for, |
| [1626](#L1626) | ], |
| [1627](#L1627) | $options |
| [1628](#L1628) | ); |
| [1629](#L1629) |  |
| [1630](#L1630) | // Construct descriptive filename |
| [1631](#L1631) | $date = date( 'ymdHis' ); |
| [1632](#L1632) | $json\_filename = "ytc3\_{$\_SERVER['HTTP\_HOST']}\_{$for}\_{$date}.json"; |
| [1633](#L1633) | // Return JSON file |
| [1634](#L1634) | header( "Content-disposition: attachment; filename={$json\_filename}" ); |
| [1635](#L1635) | header( 'Content-Type: application/json' ); |
| [1636](#L1636) | echo json\_encode( $data ); |
| [1637](#L1637) |  |
| [1638](#L1638) | // Destroy vars |
| [1639](#L1639) | unset( $data, $options, $widget\_id, $option\_name, $for, $date, $json\_filename ); |
| [1640](#L1640) |  |
| [1641](#L1641) | // Exit now, because we need only debug data in JSON file, not settings or any other page |
| [1642](#L1642) | exit; |
| [1643](#L1643) | } // End function generate\_debug\_json() |
| [1644](#L1644) |  |
| [1645](#L1645) | } // End class |
| [1646](#L1646) | } // End class check |
| [1647](#L1647) |  |
| [1648](#L1648) | global $wpau\_youtube\_channel; |
| [1649](#L1649) | if ( empty( $wpau\_youtube\_channel ) ) { |
| [1650](#L1650) | $wpau\_youtube\_channel = new WPAU\_YOUTUBE\_CHANNEL(); |
| [1651](#L1651) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/youtube-channel/trunk/youtube-channel.php?rev=2482795&format=txt)
* [Original Format](/export/2482795/youtube-channel/trunk/youtube-channel.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_7386c669_20250114_221140.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# My YouTube Channel <= 3.0.12.1 - Missing Authorization

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   My YouTube Channel <= 3.0.12.1 - Missing Authorization

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2023-0447](https://www.cve.org/CVERecord?id=CVE-2023-0447) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | January 4, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The My YouTube Channel plugin for WordPress is vulnerable to authorization bypass due to a missing capability check on the clear\_all\_cache function in versions up to, and including, 3.0.12.1. This makes it possible for authenticated attackers, with subscriber-level permissions and above, to clear the plugin's cache.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=2844200%40youtube-channel&new=2844200%40youtube-channel&sfp_email=&sfph_mail=)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/youtube-channel/trunk/youtube-channel.php?rev=2482795#L1502)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyoutube-channel%2Fyoutube-channel-30121-missing-authorization&t=My%20YouTube%20Channel%20%3C%3D%203.0.12.1%20-%20Missing%20Authorization "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyoutube-channel%2Fyoutube-channel-30121-missing-authorization&text=My%20YouTube%20Channel%20%3C%3D%203.0.12.1%20-%20Missing%20Authorization "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyoutube-channel%2Fyoutube-channel-30121-missing-authorization "LinkedIn")
Email

## Vulnerability Details for My YouTube Channel

#### [My YouTube Channel](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/youtube-channel)

| Software Type | Plugin |
| --- | --- |
| Software Slug | youtube-channel [(view on wordpress.org)](https://wordpress.org/plugins/youtube-channel) |
| Patched? | Yes |
| Remediation | Update to version 3.23.0, or a newer patched version |
| Affected Version | * <= 3.0.12.1 |
| Patched Version | * 3.23.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_126795cf_20250114_221138.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2844200%2540youtube-channel%26old%3D2844200%2540youtube-channel)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2482801/youtube-channel "Changeset 2482801 for youtube-channel")
* [Next Change](/changeset/2845691/youtube-channel "Changeset 2845691 for youtube-channel") →

---

# Changeset [2844200](/changeset/2844200 "Show full changeset") for [youtube-channel](/browser/youtube-channel?rev=2844200 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
01/05/2023 04:45:54 PM
([2 years](/timeline?from=2023-01-05T16%3A45%3A54Z&precision=second "See timeline at 01/05/2023 04:45:54 PM") ago)

Author:
urkekg
Message:

Fix critical vulenarabilities and improve plugin overall

Location:
[youtube-channel](/browser/youtube-channel?rev=2844200)
Files:

78 added
16 deleted
4 edited

* [tags/3.23.0](/browser/youtube-channel/tags/3.23.0?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/LICENSE](/browser/youtube-channel/tags/3.23.0/LICENSE?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets](/browser/youtube-channel/tags/3.23.0/assets?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/css](/browser/youtube-channel/tags/3.23.0/assets/css?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/css/admin.min.css](/browser/youtube-channel/tags/3.23.0/assets/css/admin.min.css?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/css/admin.min.css.map](/browser/youtube-channel/tags/3.23.0/assets/css/admin.min.css.map?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/css/admin.scss](/browser/youtube-channel/tags/3.23.0/assets/css/admin.scss?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/css/youtube-channel.min.css](/browser/youtube-channel/tags/3.23.0/assets/css/youtube-channel.min.css?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/css/youtube-channel.min.css.map](/browser/youtube-channel/tags/3.23.0/assets/css/youtube-channel.min.css.map?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/css/youtube-channel.scss](/browser/youtube-channel/tags/3.23.0/assets/css/youtube-channel.scss?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/img](/browser/youtube-channel/tags/3.23.0/assets/img?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/img/yt\_play.png](/browser/youtube-channel/tags/3.23.0/assets/img/yt_play.png?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/js](/browser/youtube-channel/tags/3.23.0/assets/js?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/js/admin.js](/browser/youtube-channel/tags/3.23.0/assets/js/admin.js?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/js/admin.min.js](/browser/youtube-channel/tags/3.23.0/assets/js/admin.min.js?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/js/tinymce](/browser/youtube-channel/tags/3.23.0/assets/js/tinymce?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/js/tinymce/plugin.js](/browser/youtube-channel/tags/3.23.0/assets/js/tinymce/plugin.js?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/js/tinymce/plugin.min.js](/browser/youtube-channel/tags/3.23.0/assets/js/tinymce/plugin.min.js?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib](/browser/youtube-channel/tags/3.23.0/assets/lib?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib/magnific-popup](/browser/youtube-channel/tags/3.23.0/assets/lib/magnific-popup?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib/magnific-popup/LICENSE](/browser/youtube-channel/tags/3.23.0/assets/lib/magnific-popup/LICENSE?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib/magnific-popup/css](/browser/youtube-channel/tags/3.23.0/assets/lib/magnific-popup/css?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib/magnific-popup/css/magnific-popup.min.css](/browser/youtube-channel/tags/3.23.0/assets/lib/magnific-popup/css/magnific-popup.min.css?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib/magnific-popup/css/magnific-popup.min.css.map](/browser/youtube-channel/tags/3.23.0/assets/lib/magnific-popup/css/magnific-popup.min.css.map?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib/magnific-popup/css/magnific-popup.scss](/browser/youtube-channel/tags/3.23.0/assets/lib/magnific-popup/css/magnific-popup.scss?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib/magnific-popup/jquery.magnific-popup.js](/browser/youtube-channel/tags/3.23.0/assets/lib/magnific-popup/jquery.magnific-popup.js?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/assets/lib/magnific-popup/jquery.magnific-popup.min.js](/browser/youtube-channel/tags/3.23.0/assets/lib/magnific-popup/jquery.magnific-popup.min.js?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/changelog\_legacy.txt](/browser/youtube-channel/tags/3.23.0/changelog_legacy.txt?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/classes](/browser/youtube-channel/tags/3.23.0/classes?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/classes/class-wpau-youtube-channel-settings.php](/browser/youtube-channel/tags/3.23.0/classes/class-wpau-youtube-channel-settings.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/classes/class-wpau-youtube-channel-widget.php](/browser/youtube-channel/tags/3.23.0/classes/class-wpau-youtube-channel-widget.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/classes/class-wpau-youtube-channel.php](/browser/youtube-channel/tags/3.23.0/classes/class-wpau-youtube-channel.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/feature-request.txt](/browser/youtube-channel/tags/3.23.0/feature-request.txt?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/inc](/browser/youtube-channel/tags/3.23.0/inc?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/inc/helper.php](/browser/youtube-channel/tags/3.23.0/inc/helper.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages](/browser/youtube-channel/tags/3.23.0/languages?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-cs\_CZ.mo](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-cs_CZ.mo?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-cs\_CZ.po](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-cs_CZ.po?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-da\_DK.mo](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-da_DK.mo?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-da\_DK.po](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-da_DK.po?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-es\_ES.mo](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-es_ES.mo?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-es\_ES.po](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-es_ES.po?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-sr\_RS.mo](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-sr_RS.mo?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-sr\_RS.po](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-sr_RS.po?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/languages/youtube-channel-xx\_XX.pot](/browser/youtube-channel/tags/3.23.0/languages/youtube-channel-xx_XX.pot?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/readme.txt](/browser/youtube-channel/tags/3.23.0/readme.txt?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/templates](/browser/youtube-channel/tags/3.23.0/templates?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/templates/settings-support.php](/browser/youtube-channel/tags/3.23.0/templates/settings-support.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/templates/settings-tools.php](/browser/youtube-channel/tags/3.23.0/templates/settings-tools.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/templates/settings-usage-shortcode.php](/browser/youtube-channel/tags/3.23.0/templates/settings-usage-shortcode.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/templates/settings-usage.php](/browser/youtube-channel/tags/3.23.0/templates/settings-usage.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/templates/settings.php](/browser/youtube-channel/tags/3.23.0/templates/settings.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/update.php](/browser/youtube-channel/tags/3.23.0/update.php?rev=2844200 "Show entry in browser")
  (added)
* [tags/3.23.0/youtube-channel.php](/browser/youtube-channel/tags/3.23.0/youtube-channel.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/css/admin.css](/browser/youtube-channel/trunk/assets/css/admin.css?rev=2482795 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/assets/css/admin.css.map](/browser/youtube-channel/trunk/assets/css/admin.css.map?rev=2482795 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/assets/css/admin.less](/browser/youtube-channel/trunk/assets/css/admin.less?rev=2482795 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/assets/css/admin.min.css](/browser/youtube-channel/trunk/assets/css/admin.min.css?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/css/admin.min.css.map](/browser/youtube-channel/trunk/assets/css/admin.min.css.map?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/css/admin.scss](/browser/youtube-channel/trunk/assets/css/admin.scss?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/css/youtube-channel.css](/browser/youtube-channel/trunk/assets/css/youtube-channel.css?rev=2482795 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/assets/css/youtube-channel.css.map](/browser/youtube-channel/trunk/assets/css/youtube-channel.css.map?rev=2482795 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/assets/css/youtube-channel.less](/browser/youtube-channel/trunk/assets/css/youtube-channel.less?rev=1897257 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/assets/css/youtube-channel.min.css](/browser/youtube-channel/trunk/assets/css/youtube-channel.min.css?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/css/youtube-channel.min.css.map](/browser/youtube-channel/trunk/assets/css/youtube-channel.min.css.map?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/css/youtube-channel.scss](/browser/youtube-channel/trunk/assets/css/youtube-channel.scss?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/js/tinymce](/browser/youtube-channel/trunk/assets/js/tinymce?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/js/tinymce/plugin.js](/browser/youtube-channel/trunk/assets/js/tinymce/plugin.js?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/js/tinymce/plugin.min.js](/browser/youtube-channel/trunk/assets/js/tinymce/plugin.min.js?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/lib/magnific-popup/css](/browser/youtube-channel/trunk/assets/lib/magnific-popup/css?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/lib/magnific-popup/css/magnific-popup.min.css](/browser/youtube-channel/trunk/assets/lib/magnific-popup/css/magnific-popup.min.css?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/lib/magnific-popup/css/magnific-popup.min.css.map](/browser/youtube-channel/trunk/assets/lib/magnific-popup/css/magnific-popup.min.css.map?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/lib/magnific-popup/css/magnific-popup.scss](/browser/youtube-channel/trunk/assets/lib/magnific-popup/css/magnific-popup.scss?rev=2844200 "Show entry in browser")
  (added)
* [trunk/assets/lib/magnific-popup/magnific-popup.css](/browser/youtube-channel/trunk/assets/lib/magnific-popup/magnific-popup.css?rev=1177850 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/assets/lib/magnific-popup/magnific-popup.min.css](/browser/youtube-channel/trunk/assets/lib/magnific-popup/magnific-popup.min.css?rev=1266844 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/changelog\_legacy.txt](/browser/youtube-channel/trunk/changelog_legacy.txt?rev=2844200 "Show entry in browser")
  (modified)
  ([1 diff](#file75 "Show differences"))
* [trunk/classes](/browser/youtube-channel/trunk/classes?rev=2844200 "Show entry in browser")
  (added)
* [trunk/classes/class-wpau-youtube-channel-settings.php](/browser/youtube-channel/trunk/classes/class-wpau-youtube-channel-settings.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/classes/class-wpau-youtube-channel-widget.php](/browser/youtube-channel/trunk/classes/class-wpau-youtube-channel-widget.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/classes/class-wpau-youtube-channel.php](/browser/youtube-channel/trunk/classes/class-wpau-youtube-channel.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/inc/helper.php](/browser/youtube-channel/trunk/inc/helper.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/inc/settings-support.php](/browser/youtube-channel/trunk/inc/settings-support.php?rev=2482795 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/inc/settings-template.php](/browser/youtube-channel/trunk/inc/settings-template.php?rev=1739214 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/inc/settings-tools.php](/browser/youtube-channel/trunk/inc/settings-tools.php?rev=2482795 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/inc/settings-usage-shortcode.php](/browser/youtube-channel/trunk/inc/settings-usage-shortcode.php?rev=2414602 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/inc/settings-usage.php](/browser/youtube-channel/trunk/inc/settings-usage.php?rev=1565501 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/inc/settings.php](/browser/youtube-channel/trunk/inc/settings.php?rev=2414602 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/inc/tinymce](/browser/youtube-channel/trunk/inc/tinymce?rev=2414602 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/inc/widget.php](/browser/youtube-channel/trunk/inc/widget.php?rev=2482795 "Show what was removed (content at revision 2844199)")
  (deleted)
* [trunk/readme.txt](/browser/youtube-channel/trunk/readme.txt?rev=2844200 "Show entry in browser")
  (modified)
  ([6 diffs](#file89 "Show differences"))
* [trunk/templates](/browser/youtube-channel/trunk/templates?rev=2844200 "Show entry in browser")
  (added)
* [trunk/templates/settings-support.php](/browser/youtube-channel/trunk/templates/settings-support.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/templates/settings-tools.php](/browser/youtube-channel/trunk/templates/settings-tools.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/templates/settings-usage-shortcode.php](/browser/youtube-channel/trunk/templates/settings-usage-shortcode.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/templates/settings-usage.php](/browser/youtube-channel/trunk/templates/settings-usage.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/templates/settings.php](/browser/youtube-channel/trunk/templates/settings.php?rev=2844200 "Show entry in browser")
  (added)
* [trunk/update.php](/browser/youtube-channel/trunk/update.php?rev=2844200 "Show entry in browser")
  (modified)
  ([13 diffs](#file96 "Show differences"))
* [trunk/youtube-channel.php](/browser/youtube-channel/trunk/youtube-channel.php?rev=2844200 "Show entry in browser")
  (modified)
  ([2 diffs](#file97 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [youtube-channel/trunk/changelog\_legacy.txt](/changeset/2844200/youtube-channel/trunk/changelog_legacy.txt "Show the changeset 2844200 restricted to youtube-channel/trunk/changelog_legacy.txt")

  | [r2355922](/browser/youtube-channel/trunk/changelog_legacy.txt?rev=2355922#L1 "Show revision 2355922 of this file in browser") | [r2844200](/browser/youtube-channel/trunk/changelog_legacy.txt?rev=2844200#L1 "Show revision 2844200 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | == ChangeLog for old releases == |
  |  | 2 |  |
  |  | 3 | = 3.0.11.8 (20200810) = |
  |  | 4 | \* Tested: WordPress 5.5-RC2-48768 and PHP 7.4.1 |
  |  | 5 | \* (20190719) Fix: referrer is wrong for protected API keys (thanks to @hmmux) |
  |  | 6 |  |
  |  | 7 | = 3.0.11.7 (20180906) = |
  |  | 8 | \* Add: Global option `sslverify` to disable SSL Verification |
  |  | 9 | \* Add: Global option `js\_ev\_listener` to enable Event Listener DOMContentLoaded |
  |  | 10 | \* (20180826) Add: Override video block template by 3rd party theme or plugin with filter `ytc\_print\_video` |
  |  | 11 | \* Add: Customizable timeout for wp\_remote\_get() |
  |  | 12 | \* Improve: Disable LastPass altering settings fields |
  |  | 13 |  |
  |  | 14 | = 3.0.11.6 (20180826) = |
  |  | 15 | \* Add compatibility with async/defer optimization (thanks to @lordbass) |
  |  | 16 |  |
  |  | 17 | = 3.0.11.5 (20180721) = |
  |  | 18 | \* Add: Missing `titletag` parameter for shortcode, shortcode TinyMCE wizard and widget |
  |  | 19 | \* Fix: Missing video title for `thubmbnail` display with `above` or `below` positioning (thanks @nimeldk) |
  |  | 20 |  |
  |  | 21 | = 3.0.11.4 (20180622) = |
  |  | 22 | \* Improvement: add `showtitle` options `inside` and `inside\_b`. |
  |  | 23 | \* (20180213) Update: section descriptions on plugin settings. |
  |  | 24 |  |
  |  | 25 | = 3.0.11.3 (20171001) = |
  |  | 26 | \* Fix: Default values in dropdown lists does not preselect in TinyMCE shortcode selector |
  |  | 27 | \* Add: new option for thumbnail quality for TinyMCE shortcode selector |
  |  | 28 |  |
  |  | 29 | = 3.0.11.2 (20171001) = |
  |  | 30 | \* (20171001) Fix: Undefined index: option\_page in youtube-channel/inc/settings.php on line 1006 |
  |  | 31 | \* Add: Support for custom thumbnail quality |
  |  | 32 | \* (20170716) Add: native error message from Google for cases not covered by common errors (like `accessNotConfigured`) |
  |  | 33 |  |
  |  | 34 | = 3.0.11.1 (20170530) = |
  |  | 35 | \* Fix: cut description in the middle of multy-byte characters (reported by @funfrog) |
  |  | 36 | \* (20170509) Fix: undefined variable `nolightbox` |
  |  | 37 | \* Fix: add `nolightbox` shortcode parameter and fix typos on Help section |
  |  | 38 |  |
  |  | 39 | = 3.0.11 (20170424) = |
  |  | 40 | \* Fix: added all 3 parameters to `widget\_title` filter (reported by @squarestar) |
  |  | 41 | \* (20170301) Add: New shortcode options `nolightbox` and `target`, to make available opening thumbnail anchors in new tab/window (requested by @bakercreative) |
  | 2 | 42 |  |
  | 3 | 43 | = 3.0.10.5 (20170225) = |
* ## [youtube-channel/trunk/readme.txt](/changeset/2844200/youtube-channel/trunk/readme.txt "Show the changeset 2844200 restricted to youtube-channel/trunk/readme.txt")

  | [r2482801](/browser/youtube-channel/trunk/readme.txt?rev=2482801#L3 "Show revision 2482801 of this file in browser") | [r2844200](/browser/youtube-channel/trunk/readme.txt?rev=2844200#L3 "Show revision 2844200 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | Donate link: https://urosevic.net/wordpress/donate/?donate\_for=youtube-channel |
  | 4 | 4 | Tags: youtube, channel, playlist, widget, video |
  | 5 |  | Requires at least: ~~4.9~~ |
  | 6 |  | Tested up to: ~~5.6.2~~ |
  | 7 |  | Stable tag: 3.~~0.12.1~~ |
  | 8 |  | Requires PHP: ~~5.6~~ |
  |  | 5 | Requires at least: 5.0 |
  |  | 6 | Tested up to: 6.1.1 |
  |  | 7 | Stable tag: 3.23.0 |
  |  | 8 | Requires PHP: 7.4 |
  | 9 | 9 | License: GPLv3 |
  | 10 | 10 | License URI: http://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/youtube-channel/trunk/readme.txt?rev=2482801#L90) | […](/browser/youtube-channel/trunk/readme.txt?rev=2844200#L90) |  |
  | 90 | 90 | \* `class` (string) Set custom class if you wish to target special styling for specific YTC block |
  | 91 | 91 | \* `channel` (string) ID of preferred YouTube channel. Do not set full URL to channel, but just last part from URL - ID (name) |
  | 92 |  | \* `vanity` (string) part after www.youtube.com/c/ from [Custom URL](https://support.google.com/youtube/answer/2657968?hl=en) |
  | 93 |  | \* `username` (string) Optional legacy YouTube username. |
  |  | 92 | \* `handle` (string) defined custom handle from [YouTube handle](https://www.youtube.com/handle) |
  |  | 93 | \* `vanity` (string) \*DEPRECATED\* part after www.youtube.com/c/ from [Custom URL](https://support.google.com/youtube/answer/2657968?hl=en) |
  |  | 94 | \* `username` (string) \*DEPRECATED\* Optional legacy YouTube username. |
  | 94 | 95 | \* `playlist` (string) ID of preferred YouTube playlist. |
  | 95 | 96 | \* `resource` (int) Resource to use for feed: |
  | […](/browser/youtube-channel/trunk/readme.txt?rev=2482801#L154) | […](/browser/youtube-channel/trunk/readme.txt?rev=2844200#L155) |  |
  | 154 | 155 | \* `link\_to` (string) URL to link: |
  | 155 | 156 | \* `none` Hide link (defult) |
  | 156 |  | ~~\* `vanity` Vanity custom URL~~ |
  | 157 | 157 | \* `channel` Channel page |
  | 158 |  | \* `legacy` Legacy username page |
  |  | 158 | \* `handle` YouTube handle URL |
  |  | 159 | \* `vanity` \*DEPRECATED\* Vanity custom URL |
  |  | 160 | \* `legacy` \*DEPRECATED\* Legacy username page |
  | 159 | 161 |  |
  | 160 | 162 | \*Please note, to enhance plugin functionality, we can change some shortcode parameters in future.\* |
  | […](/browser/youtube-channel/trunk/readme.txt?rev=2482801#L173) | […](/browser/youtube-channel/trunk/readme.txt?rev=2844200#L175) |  |
  | 173 | 175 | \* `snippet->resourceId->videoId` -> YouTube video ID |
  | 174 | 176 | \* `instance` - Current YouTUbe Channel Block parameters, including global settings: |
  |  | 177 | \* `handle` |
  |  | 178 | \* `channel` |
  | 175 | 179 | \* `vanity` |
  | 176 |  | ~~\* `channel`~~ |
  | 177 | 180 | \* `username` |
  | 178 | 181 | \* `playlist` |
  | […](/browser/youtube-channel/trunk/readme.txt?rev=2482801#L443) | […](/browser/youtube-channel/trunk/readme.txt?rev=2844200#L446) |  |
  | 443 | 446 | == Changelog == |
  | 444 | 447 |  |
  |  | 448 | = 3.23.0 (20230105) = |
  |  | 449 | \* Security: fix XSS and Authorization Bypass vulnerability (thanks to WPScan) |
  |  | 450 | \* Tested: WordPress 6.1.1 on PHP 8.1.7 |
  |  | 451 | \* Add: Support for YouTube Handle |
  |  | 452 | \* Add: General option to prevent YTC Widet Preview gets rendered in Block Editor |
  |  | 453 | \* Improve: Coding standard and instructions for translators |
  |  | 454 |  |
  | 445 | 455 | = 3.0.12.1 (20210227) = |
  | 446 | 456 | \* Tested: WordPress 5.6.2 on PHP 7.4.15 and 8.0.2 |
  | […](/browser/youtube-channel/trunk/readme.txt?rev=2482801#L457) | […](/browser/youtube-channel/trunk/readme.txt?rev=2844200#L467) |  |
  | 457 | 467 | \* (20201014) Add: shortcode parameter `skip` to skip requested number of items |
  | 458 | 468 |  |
  | 459 |  | ~~= 3.0.11.8 (20200810) =~~ |
  | 460 |  | ~~\* Tested: WordPress 5.5-RC2-48768 and PHP 7.4.1~~ |
  | 461 |  | ~~\* (20190719) Fix: referrer is wrong for protected API keys (thanks to @hmmux)~~ |
  | 462 |  |  |
  | 463 |  | ~~= 3.0.11.7 (20180906) =~~ |
  | 464 |  | ~~\* Add: Global option `sslverify` to disable SSL Verification~~ |
  | 465 |  | ~~\* Add: Global option `js\_ev\_listener` to enable Event Listener DOMContentLoaded~~ |
  | 466 |  | ~~\* (20180826) Add: Override video block template by 3rd party theme or plugin with filter `ytc\_print\_video`~~ |
  | 467 |  | ~~\* Add: Customizable timeout for wp\_remote\_get()~~ |
  | 468 |  | ~~\* Improve: Disable LastPass altering settings fields~~ |
  | 469 |  |  |
  | 470 |  | ~~= 3.0.11.6 (20180826) =~~ |
  | 471 |  | ~~\* Add compatibility with async/defer optimization (thanks to @lordbass)~~ |
  | 472 |  |  |
  | 473 |  | ~~= 3.0.11.5 (20180721) =~~ |
  | 474 |  | ~~\* Add: Missing `titletag` parameter for shortcode, shortcode TinyMCE wizard and widget~~ |
  | 475 |  | ~~\* Fix: Missing video title for `thubmbnail` display with `above` or `below` positioning (thanks @nimeldk)~~ |
  | 476 |  |  |
  | 477 |  | ~~= 3.0.11.4 (20180622) =~~ |
  | 478 |  | ~~\* Improvement: add `showtitle` options `inside` and `inside\_b`.~~ |
  | 479 |  | ~~\* (20180213) Update: section descriptions on plugin settings.~~ |
  | 480 |  |  |
  | 481 |  | ~~= 3.0.11.3 (20171001) =~~ |
  | 482 |  | ~~\* Fix: Default values in dropdown lists does not preselect in TinyMCE shortcode selector~~ |
  | 483 |  | ~~\* Add: new option for thumbnail quality for TinyMCE shortcode selector~~ |
  | 484 |  |  |
  | 485 |  | ~~= 3.0.11.2 (20171001) =~~ |
  | 486 |  | ~~\* (20171001) Fix: Undefined index: option\_page in youtube-channel/inc/settings.php on line 1006~~ |
  | 487 |  | ~~\* Add: Support for custom thumbnail quality~~ |
  | 488 |  | ~~\* (20170716) Add: native error message from Google for cases not covered by common errors (like `accessNotConfigured`)~~ |
  | 489 |  |  |
  | 490 |  | ~~= 3.0.11.1 (20170530) =~~ |
  | 491 |  | ~~\* Fix: cut description in the middle of multy-byte characters (reported by @funfrog)~~ |
  | 492 |  | ~~\* (20170509) Fix: undefined variable `nolightbox`~~ |
  | 493 |  | ~~\* Fix: add `nolightbox` shortcode parameter and fix typos on Help section~~ |
  | 494 |  |  |
  | 495 |  | ~~= 3.0.11 (20170424) =~~ |
  | 496 |  | ~~\* Fix: added all 3 parameters to `widget\_title` filter (reported by @squarestar)~~ |
  | 497 |  | ~~\* (20170301) Add: New shortcode options `nolightbox` and `target`, to make available opening thumbnail anchors in new tab/window (requested by @bakercreative)~~ |
  | 498 |  |  |
  | 499 | 469 | == Upgrade Notice == |
  | 500 | 470 |  |
  | 501 |  | = 3.0.11.7 = |
  | 502 |  | There is new option to disable SSL verification on host which have a problem to verify Google SSL keys |
  |  | 471 | = 3.23.0 = |
  |  | 472 |  |
  |  | 473 | An XSS vulnerability is fixed, update ASAP! |
  | 503 | 474 |  |
  | 504 | 475 | == Screenshots == |
* ## [youtube-channel/trunk/update.php](/changeset/2844200/youtube-channel/trunk/update.php "Show the changeset 2844200 restricted to youtube-channel/trunk/update.php")

  | [r2482795](/browser/youtube-channel/trunk/update.php?rev=2482795#L18 "Show revision 2482795 of this file in browser") | [r2844200](/browser/youtube-channel/trunk/update.php?rev=2844200#L18 "Show revision 2844200 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 |  |
  | 19 | 19 | // this is the target version that we need to reach |
  | 20 |  | $target\_db\_ver = ~~WPAU\_YOUTUBE\_CHANNEL::DB\_VER~~; |
  |  | 20 | $target\_db\_ver = YTC\_VER\_DB; |
  | 21 | 21 |  |
  | 22 | 22 | // run update routines one by one until the current version number |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L39) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L39) |  |
  | 39 | 39 |  |
  | 40 | 40 | // Update plugin version number |
  | 41 |  | update\_option( 'youtube\_channel\_version', ~~WPAU\_YOUTUBE\_CHANNEL::~~VER ); |
  |  | 41 | update\_option( 'youtube\_channel\_version', YTC\_VER ); |
  | 42 | 42 |  |
  | 43 | 43 | } // END function au\_youtube\_channel\_update() |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L48) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L48) |  |
  | 48 | 48 | function au\_youtube\_channel\_update\_routine\_2() { |
  | 49 | 49 |  |
  | 50 |  | if ( $old = get\_option( 'widget\_youtube\_channel\_widget' ) ) { |
  |  | 50 | $old = get\_option( 'widget\_youtube\_channel\_widget' ); |
  |  | 51 | if ( $old ) { |
  | 51 | 52 |  |
  | 52 | 53 | // get new YTC widgets |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L62) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L63) |  |
  | 62 | 63 | // option for resource |
  | 63 | 64 | $v['use\_res'] = 0; |
  | 64 |  | if ( 'on' == $v['usepl'] ) { |
  |  | 65 | if ( 'on' === $v['usepl'] ) { |
  | 65 | 66 | $v['use\_res'] = 2; |
  | 66 | 67 | } |
  | 67 | 68 |  |
  | 68 | 69 | $v['popup\_goto'] = 0; |
  | 69 |  | if ( 'on' == $v['popupgoto'] ) { |
  |  | 70 | if ( 'on' === $v['popupgoto'] ) { |
  | 70 | 71 | $v['popup\_goto'] = 1; |
  | 71 |  | } elseif ( 'on' == $v['target'] ) { |
  |  | 72 | } elseif ( 'on' === $v['target'] ) { |
  | 72 | 73 | $v['popup\_goto'] = 2; |
  | 73 | 74 | } |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L88) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L89) |  |
  | 88 | 89 | } else { |
  | 89 | 90 | // set as current widget ID |
  | 90 |  | $new[ $k ] = $v; |
  |  | 91 | $new[ $k ]     = $v; |
  | 91 | 92 | $ytc\_widget\_id = "youtube-channel-$k"; |
  | 92 | 93 | } |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L95) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L96) |  |
  | 95 | 96 | foreach ( $widget\_areas as $wak => $wav ) { |
  | 96 | 97 | // check if here we have this widget |
  | 97 |  | if ( is\_array( $wav ) && in\_array( $ytc\_widget\_id, $wav ) ) { |
  |  | 98 | if ( is\_array( $wav ) && in\_array( $ytc\_widget\_id, $wav, true ) ) { |
  | 98 | 99 | ++$ytc\_widget\_added; |
  | 99 | 100 | } |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L103) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L104) |  |
  | 103 | 104 |  |
  | 104 | 105 | // if YTC widget has not present in any widget area, add it to inactive widgets ;) |
  | 105 |  | if ( 0 == $ytc\_widget\_added ) { |
  |  | 106 | if ( 0 === $ytc\_widget\_added ) { |
  | 106 | 107 | array\_push( $widget\_areas['wp\_inactive\_widgets'], $ytc\_widget\_id ); |
  | 107 | 108 | } |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L187) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L188) |  |
  | 187 | 188 | if ( ! $\_wp\_using\_ext\_object\_cache ) { |
  | 188 | 189 |  |
  | 189 |  | $clean = $wpdb->query( $wpdb->prepare(" |
  | 190 |  | DELETE FROM `$wpdb->options` |
  | 191 |  | WHERE option\_name LIKE %s |
  | 192 |  | OR option\_name LIKE %s |
  | 193 |  | ", |
  | 194 |  | '\_transient\_ytc\_%', |
  | 195 |  | '\_transient\_timeout\_ytc\_%' |
  | 196 |  | ) ); |
  |  | 190 | $clean = $wpdb->query( |
  |  | 191 | $wpdb->prepare( |
  |  | 192 | "DELETE FROM `$wpdb->options` |
  |  | 193 | WHERE option\_name LIKE %s |
  |  | 194 | OR option\_name LIKE %s |
  |  | 195 | ", |
  |  | 196 | '\_transient\_ytc\_%', |
  |  | 197 | '\_transient\_timeout\_ytc\_%' |
  |  | 198 | ) |
  |  | 199 | ); |
  | 197 | 200 |  |
  | 198 | 201 | // optimize wp\_options table |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L203) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L206) |  |
  | 203 | 206 | foreach ( $ytc\_widgets as $widget\_id => $widget\_data ) { |
  | 204 | 207 | // process widget arrays, not \_multiwidget bool |
  | 205 |  | if ( '\_multiwidget' != $widget\_id ) { |
  |  | 208 | if ( '\_multiwidget' !== $widget\_id ) { |
  | 206 | 209 |  |
  | 207 | 210 | foreach ( $widget\_data as $key => $val ) { |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L237) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L240) |  |
  | 237 | 240 |  |
  | 238 | 241 | if ( defined( 'YOUTUBE\_DATA\_API\_KEY' ) ) { |
  | 239 |  |  |
  | 240 | 242 | if ( empty( $defaults['apikey'] ) ) { |
  | 241 | 243 | $defaults['apikey'] = YOUTUBE\_DATA\_API\_KEY; |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L343) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L345) |  |
  | 343 | 345 | foreach ( $ytc\_widgets as $widget\_id => $widget\_data ) { |
  | 344 | 346 | // Process widget arrays, not \_multiwidget bool |
  | 345 |  | if ( '\_multiwidget' != $widget\_id ) { |
  |  | 347 | if ( '\_multiwidget' !== $widget\_id ) { |
  | 346 | 348 |  |
  | 347 | 349 | // migrate only\_pl to display |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L365) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L367) |  |
  | 365 | 367 |  |
  | 366 | 368 | if ( isset( $widget\_data['link\_to'] ) ) { |
  | 367 |  | if ( 0 ==~~$widget\_data['link\_to'] || 'legacy'~~ == $widget\_data['link\_to'] ) { |
  |  | 369 | if ( 0 === $widget\_data['link\_to'] || 'legacy' === $widget\_data['link\_to'] ) { |
  | 368 | 370 | $ytc\_widgets[ $widget\_id ]['link\_to'] = 'legacy'; |
  | 369 |  | } elseif ( 1 ==~~$widget\_data['link\_to'] || 'channel'~~ == $widget\_data['link\_to'] ) { |
  |  | 371 | } elseif ( 1 === $widget\_data['link\_to'] || 'channel' === $widget\_data['link\_to'] ) { |
  | 370 | 372 | $ytc\_widgets[ $widget\_id ]['link\_to'] = 'channel'; |
  | 371 |  | } elseif ( 2 ==~~$widget\_data['link\_to'] || 'vanity'~~ == $widget\_data['link\_to'] ) { |
  |  | 373 | } elseif ( 2 === $widget\_data['link\_to'] || 'vanity' === $widget\_data['link\_to'] ) { |
  | 372 | 374 | $ytc\_widgets[ $widget\_id ]['link\_to'] = 'vanity'; |
  | 373 | 375 | } |
  | […](/browser/youtube-channel/trunk/update.php?rev=2482795#L558) | […](/browser/youtube-channel/trunk/update.php?rev=2844200#L560) |  |
  | 558 | 560 |  |
  | 559 | 561 | } // END function au\_youtube\_channel\_update\_routine\_23() |
  |  | 562 |  |
  |  | 563 |  |
  |  | 564 | /\*\* |
  |  | 565 | \* Add default value for new option handle and block\_preview |
  |  | 566 | \*/ |
  |  | 567 | function au\_youtube\_channel\_update\_routine\_24() { |
  |  | 568 |  |
  |  | 569 | // get options from DB |
  |  | 570 | $defaults = get\_option( 'youtube\_channel\_defaults' ); |
  |  | 571 |  |
  |  | 572 | if ( ! isset( $defaults['handle'] ) ) { |
  |  | 573 | $defaults['handle'] = ''; |
  |  | 574 | } |
  |  | 575 | if ( ! isset( $defaults['blockpreview'] ) ) { |
  |  | 576 | $defaults['block\_preview'] = true; |
  |  | 577 | } |
  |  | 578 | if ( isset( $defaults ) ) { |
  |  | 579 | update\_option( 'youtube\_channel\_defaults', $defaults ); |
  |  | 580 | unset( $defaults ); |
  |  | 581 | } |
  |  | 582 |  |
  |  | 583 | } // END function au\_youtube\_channel\_update\_routine\_24() |
* ## [youtube-channel/trunk/youtube-channel.php](/changeset/2844200/youtube-channel/trunk/youtube-channel.php "Show the changeset 2844200 restricted to youtube-channel/trunk/youtube-channel.php")

  | [r2482795](/browser/youtube-channel/trunk/youtube-channel.php?rev=2482795#L4 "Show revision 2482795 of this file in browser") | [r2844200](/browser/youtube-channel/trunk/youtube-channel.php?rev=2844200#L4 "Show revision 2844200 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI:  https://urosevic.net/wordpress/plugins/youtube-channel/ |
  | 5 | 5 | \* Description: Quick and easy embed latest or random videos from YouTube channel (user uploads, liked or favourited videos) or playlist. Use <a href="widgets.php">widget</a> for sidebar or shortcode for content. Works with <em>YouTube Data API v3</em>. |
  | 6 |  | \* Version:     3.~~0.12.1~~ |
  |  | 6 | \* Version:     3.23.0 |
  | 7 | 7 | \* Author:      Aleksandar Urošević |
  | 8 | 8 | \* Author URI:  https://urosevic.net/ |
  | […](/browser/youtube-channel/trunk/youtube-channel.php?rev=2482795#L17) | […](/browser/youtube-channel/trunk/youtube-channel.php?rev=2844200#L17) |  |
  | 17 | 17 | } |
  | 18 | 18 |  |
  | 19 |  | if ( ! class\_exists( 'WPAU\_YOUTUBE\_CHANNEL' ) ) { |
  | 20 |  | class WPAU\_YOUTUBE\_CHANNEL { |
  |  | 19 | define( 'YTC\_VER', '3.23.0' ); |
  |  | 20 | define( 'YTC\_VER\_DB', 24 ); |
  |  | 21 | define( 'YTC\_PLUGIN\_FILE', \_\_FILE\_\_ ); |
  |  | 22 | define( 'YTC\_PLUGIN', plugin\_basename( \_\_FILE\_\_ ) ); |
  |  | 23 | define( 'YTC\_DIR', dirname( \_\_FILE\_\_ ) ); |
  |  | 24 | define( 'YTC\_DIR\_INC', YTC\_DIR . '/inc' ); |
  |  | 25 | define( 'YTC\_DIR\_CLASSES', YTC\_DIR . '/classes' ); |
  |  | 26 | define( 'YTC\_DIR\_TEMPLATES', YTC\_DIR . '/templates' ); |
  |  | 27 | define( 'YTC\_URL', plugin\_dir\_url( \_\_FILE\_\_ ) ); |
  |  | 28 | define( 'YTC\_URL\_ASSETS', YTC\_URL . 'assets' ); |
  | 21 | 29 |  |
  | 22 |  | const DB\_VER = 23; |
  | 23 |  | const VER = '3.0.12.1'; |
  | 24 |  |  |
  | 25 |  | public $plugin\_name   = 'YouTube Channel'; |
  | 26 |  | public $plugin\_slug   = 'youtube-channel'; |
  | 27 |  | public $plugin\_option = 'youtube\_channel\_defaults'; |
  | 28 |  | public $plugin\_url; |
  | 29 |  | public $ytc\_html5\_js = ''; |
  | 30 |  | public $defaults; |
  | 31 |  |  |
  | 32 |  | /\*\* |
  | 33 |  | \* Construct class |
  | 34 |  | \*/ |
  | 35 |  | function \_\_construct() { |
  | 36 |  |  |
  | 37 |  | $this->plugin\_url = plugin\_dir\_url( \_\_FILE\_\_ ); |
  | 38 |  | load\_plugin\_textdomain( $this->plugin\_slug, false, dirname( plugin\_basename( \_\_FILE\_\_ ) ) . '/languages' ); |
  | 39 |  |  |
  | 40 |  | // Generate debug JSON |
  | 41 |  | if ( ! empty( $\_GET['ytc\_debug\_json\_for'] ) ) { |
  | 42 |  | $this->generate\_debug\_json(); |
  | 43 |  | } |
  | 44 |  |  |
  | 45 |  | // Clear all YTC cache |
  | 46 |  | add\_action( 'wp\_ajax\_ytc\_clear\_all\_cache', [ &$this, 'clear\_all\_cache' ] ); |
  | 47 |  |  |
  | 48 |  | // Activation hook and maybe update trigger |
  | 49 |  | register\_activation\_hook( \_\_FILE\_\_, [ $this, 'activate' ] ); |
  | 50 |  | add\_action( 'plugins\_loaded', [ $this, 'maybe\_update' ] ); |
  | 51 |  |  |
  | 52 |  | $this->defaults = self::defaults(); |
  | 53 |  |  |
  | 54 |  | // TinyMCE AddOn |
  | 55 |  | if ( ! empty( $this->defaults['tinymce'] ) ) { |
  | 56 |  | add\_filter( 'mce\_external\_plugins', [ $this, 'mce\_external\_plugins' ], 998 ); |
  | 57 |  | add\_filter( 'mce\_buttons', [ $this, 'mce\_buttons' ], 999 ); |
  | 58 |  | } |
  | 59 |  |  |
  | 60 |  | if ( is\_admin() ) { |
  | 61 |  |  |
  | 62 |  | // Initialize Plugin Settings Magic |
  | 63 |  | add\_action( 'init', [ $this, 'admin\_init' ] ); |
  | 64 |  |  |
  | 65 |  | // Add various Dashboard notices (if needed) |
  | 66 |  | add\_action( 'admin\_notices', [ $this, 'admin\_notices' ] ); |
  | 67 |  |  |
  | 68 |  | // Enqueue scripts and styles for Widgets page |
  | 69 |  | add\_action( 'admin\_enqueue\_scripts', [ $this, 'admin\_scripts' ] ); |
  | 70 |  |  |
  | 71 |  | } else { // ELSE if ( is\_admin() ) |
  | 72 |  |  |
  | 73 |  | // Enqueue frontend scripts |
  | 74 |  | add\_action( 'wp\_enqueue\_scripts', [ $this, 'enqueue\_scripts' ] ); |
  | 75 |  | add\_action( 'wp\_footer', [ $this, 'footer\_scripts' ] ); |
  | 76 |  |  |
  | 77 |  | } // END if ( is\_admin() ) |
  | 78 |  |  |
  | 79 |  | // Load widget |
  | 80 |  | require\_once( 'inc/widget.php' ); |
  | 81 |  |  |
  | 82 |  | // Register shortcodes `youtube\_channel` and `ytc` |
  | 83 |  | add\_shortcode( 'youtube\_channel', [ $this, 'shortcode' ] ); |
  | 84 |  | add\_shortcode( 'ytc', [ $this, 'shortcode' ] ); |
  | 85 |  |  |
  | 86 |  | } // END function \_\_construct() |
  | 87 |  |  |
  | 88 |  | /\*\* |
  | 89 |  | \* Activate the plugin |
  | 90 |  | \* Credits: http://solislab.com/blog/plugin-activation-checklist/#update-routines |
  | 91 |  | \*/ |
  | 92 |  | public static function activate() { |
  | 93 |  |  |
  | 94 |  | global $wpau\_youtube\_channel; |
  | 95 |  | $wpau\_youtube\_channel->init\_options(); |
  | 96 |  | $wpau\_youtube\_channel->maybe\_update(); |
  | 97 |  |  |
  | 98 |  | } // END public static function activate() |
  | 99 |  |  |
  | 100 |  | /\*\* |
  | 101 |  | \* Return initial options |
  | 102 |  | \* @return array Global defaults for current plugin version |
  | 103 |  | \*/ |
  | 104 |  | public function init\_options() { |
  | 105 |  |  |
  | 106 |  | $init = [ |
  | 107 |  | 'vanity'         => '', // $this->vanity\_id, |
  | 108 |  | 'channel'        => '', // $this->channel\_id, |
  | 109 |  | 'username'       => '', // $this->username\_id, |
  | 110 |  | 'playlist'       => '', // $this->playlist\_id, |
  | 111 |  | 'resource'       => 0, // ex use\_res |
  | 112 |  | 'cache'          => 300, // 5 minutes // ex cache\_time |
  | 113 |  | 'fetch'          => 25, // ex maxrnd |
  | 114 |  | 'num'            => 1, // ex vidqty |
  | 115 |  | 'skip'           => 0, |
  | 116 |  | 'privacy'        => 0, |
  | 117 |  |  |
  | 118 |  | 'ratio'          => 3, // 3 - 16:9, 1 - 4:3 (deprecated: 2 - 16:10) |
  | 119 |  | 'width'          => 306, |
  | 120 |  | 'responsive'     => 1, |
  | 121 |  | 'display'        => 'thumbnail', // thumbnail, iframe, iframe2, playlist (deprecated: chromeless, object) |
  | 122 |  | 'thumb\_quality'  => 'hqdefault', // default, mqdefault, hqdefault, sddefault, maxresdefault |
  | 123 |  | 'fullscreen'     => 0, |
  | 124 |  | 'controls'       => 0, |
  | 125 |  | 'autoplay'       => 0, |
  | 126 |  | 'autoplay\_mute'  => 0, |
  | 127 |  | 'norel'          => 0, |
  | 128 |  | 'playsinline'    => 0, // play video on mobile devices inline instead in native device player |
  | 129 |  | 'showtitle'      => 'none', // above, below, inside, inside\_b |
  | 130 |  | 'linktitle'      => 0, |
  | 131 |  | 'titletag'       => 'h3', |
  | 132 |  | 'showdesc'       => 0, |
  | 133 |  | 'desclen'        => 0, |
  | 134 |  | 'modestbranding' => 0, |
  | 135 |  | 'hideanno'       => 0, |
  | 136 |  |  |
  | 137 |  | 'goto\_txt'       => 'Visit our channel', |
  | 138 |  | 'popup\_goto'     => 0, // 0 same window, 1 new window JS, 2 new window target |
  | 139 |  | 'link\_to'        => 'none', // 0 legacy username, 1 channel, 2 vanity |
  | 140 |  | 'tinymce'        => 1, // show TinyMCE button by default |
  | 141 |  | 'nolightbox'     => 0, // do not use lightbox global setting |
  | 142 |  | 'timeout'        => 5, // timeout for wp\_remote\_get() |
  | 143 |  | 'sslverify'      => true, |
  | 144 |  | 'js\_ev\_listener' => false, |
  | 145 |  | ]; |
  | 146 |  |  |
  | 147 |  | add\_option( 'youtube\_channel\_version', self::VER, '', 'no' ); |
  | 148 |  | add\_option( 'youtube\_channel\_db\_ver', self::DB\_VER, '', 'no' ); |
  | 149 |  | add\_option( $this->plugin\_option, $init, '', 'no' ); |
  | 150 |  |  |
  | 151 |  | return $init; |
  | 152 |  |  |
  | 153 |  | } // END public function init\_options() |
  | 154 |  |  |
  | 155 |  | /\*\* |
  | 156 |  | \* Check do we need to migrate options |
  | 157 |  | \*/ |
  | 158 |  | public function maybe\_update() { |
  | 159 |  |  |
  | 160 |  | // bail if this plugin data doesn't need updating |
  | 161 |  | if ( get\_option( 'youtube\_channel\_db\_ver' ) >= self::DB\_VER ) { |
  | 162 |  | return; |
  | 163 |  | } |
  | 164 |  |  |
  | 165 |  | require\_once( dirname( \_\_FILE\_\_ ) . '/update.php' ); |
  | 166 |  | au\_youtube\_channel\_update(); |
  | 167 |  |  |
  | 168 |  | } // END public function maybe\_update() |
  | 169 |  |  |
  | 170 |  | /\*\* |
  | 171 |  | \* Initialize Settings link for Plugins page and create Settings page |
  | 172 |  | \*/ |
  | 173 |  | function admin\_init() { |
  | 174 |  |  |
  | 175 |  | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( \_\_FILE\_\_ ), [ $this, 'add\_settings\_link' ] ); |
  | 176 |  | // Add row on Plugins page |
  | 177 |  | add\_filter( 'plugin\_row\_meta', [ $this, 'add\_plugin\_meta\_links' ], 10, 2 ); |
  | 178 |  |  |
  | 179 |  | require\_once( 'inc/settings.php' ); |
  | 180 |  |  |
  | 181 |  | global $wpau\_youtube\_channel\_settings; |
  | 182 |  | if ( empty( $wpau\_youtube\_channel\_settings ) ) { |
  | 183 |  | $wpau\_youtube\_channel\_settings = new WPAU\_YOUTUBE\_CHANNEL\_SETTINGS(); |
  | 184 |  | } |
  | 185 |  |  |
  | 186 |  | } // END function admin\_init\_settings() |
  | 187 |  |  |
  | 188 |  | /\*\* |
  | 189 |  | \* Append Settings link for Plugins page |
  | 190 |  | \* @param array $links array of links on plugins page |
  | 191 |  | \*/ |
  | 192 |  | function add\_settings\_link( $links ) { |
  | 193 |  |  |
  | 194 |  | $settings\_title = \_\_( 'Settings' ); |
  | 195 |  | $settings\_link = "<a href=\"options-general.php?page={$this->plugin\_slug}\">{$settings\_title}</a>"; |
  | 196 |  | array\_unshift( $links, $settings\_link ); |
  | 197 |  |  |
  | 198 |  | // Free some memory |
  | 199 |  | unset( $settings\_title, $settings\_link ); |
  | 200 |  |  |
  | 201 |  | // Return updated array of links |
  | 202 |  | return $links; |
  | 203 |  |  |
  | 204 |  | } // END function add\_settings\_link() |
  | 205 |  |  |
  | 206 |  | /\*\* |
  | 207 |  | \* Add link to official plugin page |
  | 208 |  | \*/ |
  | 209 |  | function add\_plugin\_meta\_links( $links, $file ) { |
  | 210 |  |  |
  | 211 |  | if ( 'youtube-channel/youtube-channel.php' === $file ) { |
  | 212 |  | return array\_merge( |
  | 213 |  | $links, |
  | 214 |  | [ |
  | 215 |  | sprintf( |
  | 216 |  | '<a href="https://wordpress.org/support/plugin/youtube-channel/" target="\_blank">%s</a>', |
  | 217 |  | \_\_( 'Support' ) |
  | 218 |  | ), |
  | 219 |  | ] |
  | 220 |  | ); |
  | 221 |  | } |
  | 222 |  | return $links; |
  | 223 |  |  |
  | 224 |  | } // END function add\_plugin\_meta\_links() |
  | 225 |  |  |
  | 226 |  | /\*\* |
  | 227 |  | \* Enqueue admin scripts and styles for widget customization |
  | 228 |  | \*/ |
  | 229 |  | function admin\_scripts() { |
  | 230 |  |  |
  | 231 |  | global $pagenow; |
  | 232 |  |  |
  | 233 |  | // Enqueue only on widget or post pages |
  | 234 |  | if ( ! in\_array( $pagenow, [ 'widgets.php', 'customize.php', 'options-general.php', 'post.php', 'post-new.php' ] ) ) { |
  | 235 |  | return; |
  | 236 |  | } |
  | 237 |  |  |
  | 238 |  | // Enqueue on post page only if tinymce is enabled |
  | 239 |  | if ( in\_array( $pagenow, [ 'post.php', 'post-new.php' ] ) && empty( $this->defaults['tinymce'] ) ) { |
  | 240 |  | return; |
  | 241 |  | } |
  | 242 |  |  |
  | 243 |  | wp\_enqueue\_style( |
  | 244 |  | $this->plugin\_slug . '-admin', |
  | 245 |  | plugins\_url( 'assets/css/admin.css', \_\_FILE\_\_ ), |
  | 246 |  | [], |
  | 247 |  | self::VER |
  | 248 |  | ); |
  | 249 |  |  |
  | 250 |  | // Enqueue script for widget in admin |
  | 251 |  | if ( in\_array( $pagenow, [ 'widgets.php', 'customize.php' ] ) ) { |
  | 252 |  | wp\_enqueue\_script( |
  | 253 |  | $this->plugin\_slug . '-admin', |
  | 254 |  | plugins\_url( 'assets/js/admin.min.js', \_\_FILE\_\_ ), |
  | 255 |  | [ 'jquery' ], |
  | 256 |  | self::VER, |
  | 257 |  | true |
  | 258 |  | ); |
  | 259 |  | } |
  | 260 |  | } // END function admin\_scripts() |
  | 261 |  |  |
  | 262 |  | /\*\* |
  | 263 |  | \* Print dashboard notice |
  | 264 |  | \* @return string Formatted notice with usefull explanation |
  | 265 |  | \*/ |
  | 266 |  | function admin\_notices() { |
  | 267 |  |  |
  | 268 |  | // Get array of dismissed notices |
  | 269 |  | $dismissed\_notices = get\_option( 'youtube\_channel\_dismissed\_notices' ); |
  | 270 |  |  |
  | 271 |  | // Dismiss notices if requested and then update option in DB |
  | 272 |  | if ( ! empty( $\_GET['ytc\_dismiss\_notice\_old\_php'] ) ) { |
  | 273 |  | $dismissed\_notices['old\_php'] = 1; |
  | 274 |  | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
  | 275 |  | } |
  | 276 |  | if ( ! empty( $\_GET['ytc\_dismiss\_notice\_apikey\_wpconfig'] ) ) { |
  | 277 |  | $dismissed\_notices['apikey\_wpconfig'] = 1; |
  | 278 |  | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
  | 279 |  | } |
  | 280 |  | if ( ! empty( $\_GET['ytc\_dismiss\_notice\_vanity\_option'] ) ) { |
  | 281 |  | $dismissed\_notices['vanity\_option'] = 1; |
  | 282 |  | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
  | 283 |  | } |
  | 284 |  | if ( ! empty( $\_GET['ytc\_dismiss\_notice\_changed\_shortcode\_308'] ) ) { |
  | 285 |  | $dismissed\_notices['changed\_shortcode\_308'] = 1; |
  | 286 |  | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
  | 287 |  | } |
  | 288 |  |  |
  | 289 |  | // Prepare vars for notices |
  | 290 |  | $settings\_page = 'options-general.php?page=youtube-channel'; |
  | 291 |  | $notice = [ |
  | 292 |  | 'error'   => '', |
  | 293 |  | 'warning' => '', |
  | 294 |  | 'info'    => '', |
  | 295 |  | ]; |
  | 296 |  |  |
  | 297 |  | // Inform if PHP version is lower than 5.3 |
  | 298 |  | if ( |
  | 299 |  | version\_compare( PHP\_VERSION, '5.3', '<' ) && |
  | 300 |  | ( |
  | 301 |  | empty( $dismissed\_notices ) || |
  | 302 |  | ( ! empty( $dismissed\_notices ) && empty( $dismissed\_notices['old\_php'] ) ) |
  | 303 |  | ) |
  | 304 |  | ) { |
  | 305 |  | $notice['info'] .= sprintf( |
  | 306 |  | \_\_( '<p>Your website running on web server with PHP version %1$s. Please note that <strong>%2$s</strong> requires PHP at least 5.3 or newer to work properly. <a href="%3$s" class="dismiss">Dismiss</a></p>', 'youtube-channel' ), |
  | 307 |  | PHP\_VERSION, |
  | 308 |  | $this->plugin\_name, |
  | 309 |  | '?ytc\_dismiss\_notice\_old\_php=1' |
  | 310 |  | ); |
  | 311 |  | } |
  | 312 |  |  |
  | 313 |  | // Inform if YOUTUBE\_DATA\_API\_KEY is still in wp-config.php |
  | 314 |  | if ( |
  | 315 |  | defined( 'YOUTUBE\_DATA\_API\_KEY' ) && |
  | 316 |  | empty( $dismissed\_notices['apikey\_wpconfig'] ) |
  | 317 |  | ) { |
  | 318 |  | $notice['info'] .= sprintf( |
  | 319 |  | \_\_( '<p>Since <strong>%1$s</strong> v3.0.6 we store <strong>YouTube Data API Key</strong> in plugin settings. So, you can safely remove %2$s define line from your <strong>wp-config.php</strong> file. <a href="%3$s" class="dismiss">Dismiss</a></p>', 'youtube-channel' ), |
  | 320 |  | $this->plugin\_name, |
  | 321 |  | 'YOUTUBE\_DATA\_API\_KEY', |
  | 322 |  | '?ytc\_dismiss\_notice\_apikey\_wpconfig=1' |
  | 323 |  | ); |
  | 324 |  | } |
  | 325 |  |  |
  | 326 |  | // No YouTube DATA Api Key? |
  | 327 |  | if ( empty( $this->defaults['apikey'] ) ) { |
  | 328 |  | $notice['error'] .= sprintf( |
  | 329 |  | wp\_kses( |
  | 330 |  | \_\_( |
  | 331 |  | '<p><strong>%1$s v3</strong> require <strong>%2$s</strong> set on plugin <a href="%6$s">%7$s</a>. You can generate your own key on <a href="%3$s" target="\_blank">%4$s</a> by following <a href="%5$s" target="\_blank">this tutorial</a>.</p>', |
  | 332 |  | 'youtube-channel' |
  | 333 |  | ), |
  | 334 |  | [ |
  | 335 |  | 'a'      => [ |
  | 336 |  | 'href'   => [], |
  | 337 |  | 'target' => [ '\_blank' ], |
  | 338 |  | ], |
  | 339 |  | 'p'      => [], |
  | 340 |  | 'strong' => [], |
  | 341 |  | 'br'     => [], |
  | 342 |  | ] |
  | 343 |  | ), |
  | 344 |  | $this->plugin\_name, |
  | 345 |  | \_\_( 'YouTube Data API Key', 'youtube-channel' ), |
  | 346 |  | esc\_url( 'https://console.developers.google.com/project' ), |
  | 347 |  | \_\_( 'Google Developers Console', 'youtube-channel' ), |
  | 348 |  | esc\_url( 'https://urosevic.net/wordpress/plugins/youtube-channel/#youtube\_data\_api\_key' ), |
  | 349 |  | esc\_url( 'options-general.php?page=youtube-channel&tab=general' ), |
  | 350 |  | \_\_( 'General Settings', 'youtube-channel' ) |
  | 351 |  | ); |
  | 352 |  | } |
  | 353 |  |  |
  | 354 |  | // v3.0.8.1 shortcode changes since v3.0.8 |
  | 355 |  | if ( ! empty( $dismissed\_notices ) && empty( $dismissed\_notices['changed\_shortcode\_308'] ) ) { |
  | 356 |  | $notice['warning'] .= sprintf( |
  | 357 |  | \_\_( '<p><strong>%1$s</strong> changed shortcode parameters by removing <code>only\_pl</code> and <code>showgoto</code>, and combining with parameters <code>display</code> and <code>link\_to</code> respectively. Please check out <a href="%2$s&tab=help">%3$s</a> and update your shortcodes. <a href="%4$s" class="dismiss">Dismiss</a>', 'youtube-channel' ), |
  | 358 |  | $this->plugin\_name, |
  | 359 |  | $settings\_page, |
  | 360 |  | 'Help: How to use shortcode', |
  | 361 |  | '?ytc\_dismiss\_notice\_changed\_shortcode\_308=1' |
  | 362 |  | ); |
  | 363 |  | } elseif ( empty( $dismissed\_notices ) ) { |
  | 364 |  | // First time install? auto dismiss this notice |
  | 365 |  | $dismissed\_notices['changed\_shortcode\_308'] = 1; |
  | 366 |  | update\_option( 'youtube\_channel\_dismissed\_notices', $dismissed\_notices ); |
  | 367 |  | } |
  | 368 |  |  |
  | 369 |  | foreach ( $notice as $type => $message ) { |
  | 370 |  | if ( ! empty( $message ) ) { |
  | 371 |  | echo "<div class=\"notice notice-{$type}\">{$message}</div>"; |
  | 372 |  | } |
  | 373 |  | } |
  | 374 |  |  |
  | 375 |  | } // END function admin\_notices() |
  | 376 |  |  |
  | 377 |  | /\*\* |
  | 378 |  | \* Get default options from DB |
  | 379 |  | \* @return array Latest global defaults |
  | 380 |  | \*/ |
  | 381 |  | public function defaults() { |
  | 382 |  |  |
  | 383 |  | $defaults = get\_option( $this->plugin\_option ); |
  | 384 |  | if ( empty( $defaults ) ) { |
  | 385 |  | $defaults = $this->init\_options(); |
  | 386 |  | } |
  | 387 |  |  |
  | 388 |  | return $defaults; |
  | 389 |  |  |
  | 390 |  | } // END public function defaults() |
  | 391 |  |  |
  | 392 |  | /\*\* |
  | 393 |  | \* Enqueue frontend scripts and styles |
  | 394 |  | \*/ |
  | 395 |  | function enqueue\_scripts() { |
  | 396 |  |  |
  | 397 |  | // Check do we need our own lightbox? |
  | 398 |  | if ( empty( $this->defaults['nolightbox'] ) ) { |
  | 399 |  | wp\_enqueue\_style( |
  | 400 |  | 'magnific-popup-au', |
  | 401 |  | plugins\_url( 'assets/lib/magnific-popup/magnific-popup.min.css', \_\_FILE\_\_ ), |
  | 402 |  | [], |
  | 403 |  | self::VER |
  | 404 |  | ); |
  | 405 |  | wp\_enqueue\_script( |
  | 406 |  | 'magnific-popup-au', |
  | 407 |  | plugins\_url( 'assets/lib/magnific-popup/jquery.magnific-popup.min.js', \_\_FILE\_\_ ), |
  | 408 |  | [ 'jquery' ], |
  | 409 |  | self::VER, |
  | 410 |  | true |
  | 411 |  | ); |
  | 412 |  | } |
  | 413 |  |  |
  | 414 |  | wp\_enqueue\_style( |
  | 415 |  | 'youtube-channel', |
  | 416 |  | plugins\_url( 'assets/css/youtube-channel.css', \_\_FILE\_\_ ), |
  | 417 |  | [], |
  | 418 |  | self::VER |
  | 419 |  | ); |
  | 420 |  |  |
  | 421 |  | } // END function enqueue\_scripts() |
  | 422 |  |  |
  | 423 |  | /\*\* |
  | 424 |  | \* Generate comlete inline JavaScript code that conains |
  | 425 |  | \* Async video load and lightbox init for thumbnails |
  | 426 |  | \* @return string Compressed JavaScript code |
  | 427 |  | \*/ |
  | 428 |  | function footer\_scripts() { |
  | 429 |  |  |
  | 430 |  | $js = ''; |
  | 431 |  |  |
  | 432 |  | // Print YT API only if we have set ytc\_html5\_js in $\_SESSION |
  | 433 |  | // if ( ! empty( $\_SESSION['ytc\_html5\_js'] ) ) { |
  | 434 |  | if ( ! empty( $this->ytc\_html5\_js ) ) { |
  | 435 |  | $js .= " |
  | 436 |  | if (!window['YT']) { |
  | 437 |  | var tag=document.createElement('script'); |
  | 438 |  | tag.src=\"//www.youtube.com/iframe\_api\"; |
  | 439 |  | var firstScriptTag=document.getElementsByTagName('script')[0]; |
  | 440 |  | firstScriptTag.parentNode.insertBefore(tag,firstScriptTag); |
  | 441 |  | } |
  | 442 |  | function ytc\_create\_ytplayers(){ |
  | 443 |  | {$this->ytc\_html5\_js} |
  | 444 |  | } |
  | 445 |  | try { |
  | 446 |  | ytc\_create\_ytplayers(); |
  | 447 |  | } catch (e) {} |
  | 448 |  | function onYouTubeIframeAPIReady(){ |
  | 449 |  | ytc\_create\_ytplayers(); |
  | 450 |  | } |
  | 451 |  | function ytc\_mute(event){event.target.mute();} |
  | 452 |  | "; |
  | 453 |  | } // END if ( ! empty($\_SESSION['ytc\_html5\_js']) ) |
  | 454 |  |  |
  | 455 |  | // Print Magnific Popup if not disabled |
  | 456 |  | if ( empty( $this->defaults['nolightbox'] ) ) { |
  | 457 |  | $js .= " |
  | 458 |  | function ytc\_init\_MPAU() { |
  | 459 |  | jQuery('.ytc-lightbox').magnificPopupAU({ |
  | 460 |  | disableOn:320, |
  | 461 |  | type:'iframe', |
  | 462 |  | mainClass:'ytc-mfp-lightbox', |
  | 463 |  | removalDelay:160, |
  | 464 |  | preloader:false, |
  | 465 |  | fixedContentPos:false |
  | 466 |  | }); |
  | 467 |  | } |
  | 468 |  | jQuery(window).on('load',function(){ |
  | 469 |  | ytc\_init\_MPAU(); |
  | 470 |  | }); |
  | 471 |  | jQuery(document).ajaxComplete(function(){ |
  | 472 |  | ytc\_init\_MPAU(); |
  | 473 |  | }); |
  | 474 |  | "; |
  | 475 |  | } // END if ( empty($this->defaults['nolightbox']) ) |
  | 476 |  |  |
  | 477 |  | if ( ! empty( $js ) ) { |
  | 478 |  | $js = sprintf( |
  | 479 |  | ' |
  | 480 |  | <!-- YouTube Channel 3 --> |
  | 481 |  | <script type="text/javascript">%2$s%1$s%3$s</script> |
  | 482 |  | ', |
  | 483 |  | $js, |
  | 484 |  | $this->defaults['js\_ev\_listener'] ? "window.addEventListener('DOMContentLoaded', function() {" : '', |
  | 485 |  | $this->defaults['js\_ev\_listener'] ? '});' : '' |
  | 486 |  | ); |
  | 487 |  |  |
  | 488 |  | if ( WP\_DEBUG ) { |
  | 489 |  | // Uncompressed code if WP debug is enabled |
  | 490 |  | $js = str\_replace( ';var', ";\nvar", $js ); |
  | 491 |  | $js = str\_replace( "\t", '', $js ); |
  | 492 |  | // $js = str\_replace(',', ",\n\t", $js); |
  | 493 |  | echo $js; |
  | 494 |  | } else { |
  | 495 |  | echo trim( preg\_replace( '/[\t\r\n]+/', '', $js ) ); |
  | 496 |  | } |
  | 497 |  | } |
  | 498 |  |  |
  | 499 |  | } // END function footer\_scripts() |
  | 500 |  |  |
  | 501 |  | public function shortcode( $atts ) { |
  | 502 |  |  |
  | 503 |  | // Get general default settings |
  | 504 |  | $instance = $this->defaults(); |
  | 505 |  |  |
  | 506 |  | // Extract shortcode parameters |
  | 507 |  | $atts = shortcode\_atts( |
  | 508 |  | [ |
  | 509 |  | 'vanity'         => $instance['vanity'], |
  | 510 |  | 'channel'        => $instance['channel'], |
  | 511 |  | 'username'       => $instance['username'], |
  | 512 |  | 'playlist'       => $instance['playlist'], |
  | 513 |  | 'res'            => '', // (deprecated, but leave for back compatibility) ex res |
  | 514 |  | 'use\_res'        => '', // (deprecated, but leave for back compatibility) ex use\_res |
  | 515 |  | 'resource'       => $instance['resource'], // ex use\_res |
  | 516 |  | 'only\_pl'        => 0, // disabled by default (was: $instance['only\_pl'],) |
  | 517 |  | 'cache'          => $instance['cache'], // ex cache\_time |
  | 518 |  | 'privacy'        => $instance['privacy'], // ex showvidesc |
  | 519 |  | 'fetch'          => $instance['fetch'], // ex maxrnd |
  | 520 |  | 'num'            => $instance['num'], // ex vidqty |
  | 521 |  |  |
  | 522 |  | 'random'         => 0, // ex getrnd |
  | 523 |  |  |
  | 524 |  | 'ratio'          => $instance['ratio'], |
  | 525 |  | 'width'          => $instance['width'], |
  | 526 |  | 'responsive'     => ! empty( $instance['responsive'] ) ? $instance['responsive'] : '0', |
  | 527 |  |  |
  | 528 |  | 'show'           => $instance['display'], // (deprecated, but keep for back compatibility) ex to\_show |
  | 529 |  | 'display'        => $instance['display'], |
  | 530 |  | 'thumb\_quality'  => $instance['thumb\_quality'], |
  | 531 |  | 'no\_thumb\_title' => 0, |
  | 532 |  | 'controls'       => $instance['controls'], |
  | 533 |  | 'autoplay'       => $instance['autoplay'], |
  | 534 |  | 'mute'           => $instance['autoplay\_mute'], |
  | 535 |  | 'norel'          => $instance['norel'], |
  | 536 |  | 'playsinline'    => $instance['playsinline'], // play video on mobile devices inline instead in native device player |
  | 537 |  |  |
  | 538 |  | 'showtitle'      => $instance['showtitle'], // none, above, below, inside, inside\_b |
  | 539 |  | 'linktitle'      => ! empty( $instance['linktitle'] ) ? $instance['linktitle'] : '0', |
  | 540 |  | 'titletag'       => $instance['titletag'], // h3, h4, h5, div, span, strong |
  | 541 |  | 'showdesc'       => $instance['showdesc'], // ex showvidesc |
  | 542 |  | 'nobrand'        => ! empty( $instance['modestbranding'] ) ? $instance['modestbranding'] : '0', |
  | 543 |  | 'desclen'        => $instance['desclen'], // ex videsclen |
  | 544 |  | 'noanno'         => $instance['hideanno'], |
  | 545 |  |  |
  | 546 |  | 'goto\_txt'       => $instance['goto\_txt'], |
  | 547 |  | 'popup'          => $instance['popup\_goto'], |
  | 548 |  | 'link\_to'        => $instance['link\_to'], // none, vanity, channel, legacy |
  | 549 |  |  |
  | 550 |  | 'class'          => ! empty( $instance['class'] ) ? $instance['class'] : '', |
  | 551 |  |  |
  | 552 |  | 'nolightbox'     => ! empty( $instance['nolightbox'] ) ? $instance['nolightbox'] : '0', |
  | 553 |  | 'target'         => '', |
  | 554 |  | 'skip'           => 0, // how many items to skip |
  | 555 |  | ], |
  | 556 |  | $atts |
  | 557 |  | ); |
  | 558 |  |  |
  | 559 |  | // backward compatibility for show -> display shortcode parameter |
  | 560 |  | if ( ! empty( $atts['show'] ) && $atts['show'] !== $atts['display'] && $atts['show'] !== $instance['display'] ) { |
  | 561 |  | $atts['display'] = $atts['show']; |
  | 562 |  | } |
  | 563 |  | // backward compatibility for use\_res -> resource shortcode parameter |
  | 564 |  | if ( ! empty( $atts['use\_res'] ) ) { |
  | 565 |  | $atts['resource'] = $atts['use\_res']; |
  | 566 |  | } elseif ( ! empty( $atts['res'] ) ) { |
  | 567 |  | $atts['resource'] = $atts['res']; |
  | 568 |  | } |
  | 569 |  |  |
  | 570 |  | // prepare instance for output |
  | 571 |  | $instance['vanity']         = $atts['vanity']; |
  | 572 |  | $instance['channel']        = $atts['channel']; |
  | 573 |  | $instance['username']       = $atts['username']; |
  | 574 |  | $instance['playlist']       = $atts['playlist']; |
  | 575 |  | $instance['resource']       = $atts['resource']; // resource: 0 channel, 1 favorites, 2 playlist, 3 liked |
  | 576 |  | $instance['cache']          = $atts['cache']; // in seconds, def 5min - settings? |
  | 577 |  | $instance['privacy']        = $atts['privacy']; // enhanced privacy |
  | 578 |  |  |
  | 579 |  | $instance['fetch']          = (int) $atts['fetch']; |
  | 580 |  | $instance['num']            = (int) $atts['num']; // num: 1 |
  | 581 |  |  |
  | 582 |  | $instance['random']         = $atts['random']; // use embedded playlist - false by default |
  | 583 |  |  |
  | 584 |  | // Video Settings |
  | 585 |  | $instance['ratio']          = $atts['ratio']; // aspect ratio: 3 - 16:9, 2 - 16:10, 1 - 4:3 |
  | 586 |  | $instance['width']          = (int) $atts['width']; // 306 |
  | 587 |  | $instance['responsive']     = $atts['responsive']; // enable responsivenes? |
  | 588 |  | $instance['display']        = $atts['display']; // thumbnail, iframe, iframe2, playlist |
  | 589 |  | $instance['thumb\_quality']  = $atts['thumb\_quality']; // default, mqdefault, hqdefault, sddefault, maxresdefault |
  | 590 |  | $instance['no\_thumb\_title'] = $atts['no\_thumb\_title']; // hide tooltip for thumbnails |
  | 591 |  |  |
  | 592 |  | $instance['controls']       = $atts['controls']; // hide controls, false by default |
  | 593 |  | $instance['autoplay']       = $atts['autoplay']; // autoplay disabled by default |
  | 594 |  | $instance['autoplay\_mute']  = $atts['mute']; // mute sound on autoplay - disabled by default |
  | 595 |  | $instance['norel']          = $atts['norel']; // hide related videos |
  | 596 |  | $instance['playsinline']    = $atts['playsinline']; // inline plaer for iOS |
  | 597 |  |  |
  | 598 |  | // Content Layout |
  | 599 |  | $instance['showtitle']      = $atts['showtitle']; // show video title, disabled by default |
  | 600 |  | $instance['linktitle']      = $atts['linktitle']; // link title to video, disabled by default |
  | 601 |  | $instance['titletag']       = $atts['titletag']; // title HTML tag wrapper, h3 by default |
  | 602 |  | $instance['showdesc']       = $atts['showdesc']; // show video description, disabled by default |
  | 603 |  | $instance['modestbranding'] = $atts['nobrand']; // hide YT logo |
  | 604 |  | $instance['desclen']        = (int) $atts['desclen']; // cut video description, number of characters |
  | 605 |  | $instance['hideanno']       = $atts['noanno']; // hide annotations, false by default |
  | 606 |  |  |
  | 607 |  | // Link to Channel |
  | 608 |  | $instance['goto\_txt']       = $atts['goto\_txt']; // text for goto link - use settings |
  | 609 |  | $instance['popup\_goto']     = $atts['popup']; // open channel in: 0 same window, 1 javascript new, 2 target new |
  | 610 |  | $instance['link\_to']        = $atts['link\_to']; // link to: none, vanity, legacy, channel |
  | 611 |  |  |
  | 612 |  | // Customization |
  | 613 |  | $instance['class']          = $atts['class']; // custom additional class for container |
  | 614 |  |  |
  | 615 |  | $instance['nolightbox']     = $atts['nolightbox']; // custom usage of lightbox |
  | 616 |  | $instance['target']         = $atts['target'];     // custom target for thumbnails w/o lightbox (empty, \_blank or custom) |
  | 617 |  |  |
  | 618 |  | $instance['skip']           = (int) $atts['skip']; |
  | 619 |  | // return implode( array\_values( $this->output( $instance ) ) ); |
  | 620 |  | return $this->output( $instance ); |
  | 621 |  | } // END public function shortcode() |
  | 622 |  |  |
  | 623 |  | // Print out YTC block |
  | 624 |  | public function output( $instance ) { |
  | 625 |  |  |
  | 626 |  | // Error message if no YouTube Data API Key |
  | 627 |  | if ( empty( $this->defaults['apikey'] ) ) { |
  | 628 |  |  |
  | 629 |  | $error\_msg = sprintf( |
  | 630 |  | \_\_( '<strong>%1$s v3</strong> requires <strong>YouTube DATA API Key</strong> to work. <a href="%2$s" target="\_blank">Learn more here</a>.', 'youtube-channel' ), |
  | 631 |  | $this->plugin\_name, |
  | 632 |  | 'https://urosevic.net/wordpress/plugins/youtube-channel/#youtube\_data\_api\_key' |
  | 633 |  | ); |
  | 634 |  |  |
  | 635 |  | return $this->front\_debug( $error\_msg ); |
  | 636 |  |  |
  | 637 |  | } |
  | 638 |  |  |
  | 639 |  | // 1) Get resource from widget/shortcode |
  | 640 |  | // 2) If not set, get global default |
  | 641 |  | // 3) if no global, get plugin's default |
  | 642 |  | if ( ! isset( $instance['resource'] ) ) { |
  | 643 |  | $instance['resource'] = $this->defaults['resource']; |
  | 644 |  | } |
  | 645 |  | $resource = intval( $instance['resource'] ); |
  | 646 |  | if ( empty( $resource ) && 0 !== $resource ) { |
  | 647 |  | $resource = intval( $this->defaults['resource'] ); |
  | 648 |  | if ( empty( $resource ) ) { |
  | 649 |  | $resource = 0; |
  | 650 |  | } |
  | 651 |  | } |
  | 652 |  |  |
  | 653 |  | // Get Channel or Playlist ID based on requested resource |
  | 654 |  | switch ( $resource ) { |
  | 655 |  |  |
  | 656 |  | // Playlist |
  | 657 |  | case '2': |
  | 658 |  | // 1) Get Playlist from shortcode/widget |
  | 659 |  | // 2) If not set, use global default |
  | 660 |  | // 3) If no global, throw error |
  | 661 |  | if ( ! empty( $instance['playlist'] ) ) { |
  | 662 |  | $playlist = trim( $instance['playlist'] ); |
  | 663 |  | } else { |
  | 664 |  | $playlist = trim( $this->defaults['playlist'] ); |
  | 665 |  | } |
  | 666 |  | // Now check has Playlist ID set or throw error |
  | 667 |  | if ( '' == $playlist ) { |
  | 668 |  | return $this->front\_debug( 'Playlist selected as resource but no Playlist ID provided!' ); |
  | 669 |  | } |
  | 670 |  | break; |
  | 671 |  |  |
  | 672 |  | // Channel, Favourites, Liked |
  | 673 |  | default: |
  | 674 |  | /\* Channel \*/ |
  | 675 |  | // 1) Get channel from shortcode/widget |
  | 676 |  | // 2) If not set, use global default |
  | 677 |  | // 3) If no global, throw error |
  | 678 |  | if ( ! empty( $instance['channel'] ) ) { |
  | 679 |  | $channel = trim( $instance['channel'] ); |
  | 680 |  | } else { |
  | 681 |  | $channel = trim( $this->defaults['channel'] ); |
  | 682 |  | } |
  | 683 |  | // Now check is Channel ID set or throw error |
  | 684 |  | if ( '' == $channel ) { |
  | 685 |  | if ( 1 == $resource ) { |
  | 686 |  | $resource\_name = 'Favourited videos'; |
  | 687 |  | } elseif ( 3 == $resource ) { |
  | 688 |  | $resource\_name = 'Liked videos'; |
  | 689 |  | } else { |
  | 690 |  | $resource\_name = 'Channel (User uploads)'; |
  | 691 |  | } |
  | 692 |  | $error\_msg = sprintf( '%s selected as resource but no Channel ID provided!', $resource\_name ); |
  | 693 |  | return $this->front\_debug( $error\_msg ); |
  | 694 |  | } |
  | 695 |  | } // END switch ($resource) |
  | 696 |  |  |
  | 697 |  | /\* OK, we have required resource (Playlist or Channel ID), so we can proceed to real job \*/ |
  | 698 |  |  |
  | 699 |  | // Set custom class and responsive if needed |
  | 700 |  | $class = ( ! empty( $instance['class'] ) ) ? $instance['class'] : 'default'; |
  | 701 |  | if ( ! empty( $instance['responsive'] ) ) { |
  | 702 |  | $class .= ' responsive'; |
  | 703 |  | } |
  | 704 |  | if ( ! empty( $instance['display'] ) ) { |
  | 705 |  | $class .= " ytc\_display\_{$instance['display']}"; |
  | 706 |  | } |
  | 707 |  |  |
  | 708 |  | switch ( $resource ) { |
  | 709 |  | case 1: // Favourites |
  | 710 |  | $resource\_name = 'favourites'; |
  | 711 |  | $resource\_id = preg\_replace( '/^UC/', 'FL', $channel ); |
  | 712 |  | break; |
  | 713 |  | case 2: // Playlist |
  | 714 |  | $resource\_name = 'playlist'; |
  | 715 |  | $resource\_id = $playlist; |
  | 716 |  | break; |
  | 717 |  | case 3: // Liked |
  | 718 |  | $resource\_name = 'liked'; |
  | 719 |  | $resource\_id = preg\_replace( '/^UC/', 'LL', $channel ); |
  | 720 |  | break; |
  | 721 |  | default: // Channel |
  | 722 |  | $resource\_name = 'channel'; |
  | 723 |  | $resource\_id = preg\_replace( '/^UC/', 'UU', $channel ); |
  | 724 |  | } |
  | 725 |  |  |
  | 726 |  | // Start output string |
  | 727 |  | $output = ''; |
  | 728 |  |  |
  | 729 |  | $output .= "<div class=\"youtube\_channel {$class}\">"; |
  | 730 |  |  |
  | 731 |  | if ( empty( $instance['display'] ) ) { |
  | 732 |  | $instance['display'] = $this->defaults['display']; |
  | 733 |  | } |
  | 734 |  | if ( 'playlist' == $instance['display'] ) { // Insert as Embedded playlist |
  | 735 |  |  |
  | 736 |  | $output .= self::embed\_playlist( $resource\_id, $instance ); |
  | 737 |  |  |
  | 738 |  | } else { // Individual videos from channel, favourites, liked or playlist |
  | 739 |  |  |
  | 740 |  | // Get max items for random video |
  | 741 |  | $fetch = ( empty( $instance['fetch'] ) ) ? $this->defaults['fetch'] : $instance['fetch']; |
  | 742 |  | if ( $fetch < 1 ) { |
  | 743 |  | $fetch = 10; |
  | 744 |  | } elseif ( $fetch > 50 ) { |
  | 745 |  | $fetch = 50; |
  | 746 |  | } |
  | 747 |  |  |
  | 748 |  | // How many items to skip? |
  | 749 |  | $skip = 0; |
  | 750 |  | if ( ! empty( $instance['skip'] ) ) { |
  | 751 |  | $skip = intval( $instance['skip'] ) > 49 ? 49 : intval( $instance['skip'] ); |
  | 752 |  | } |
  | 753 |  | // If we have to skip more items than we have in fetch, set skip to $fetch-1 |
  | 754 |  | if ( $skip >= $fetch ) { |
  | 755 |  | $skip = $fetch - 1; |
  | 756 |  | } |
  | 757 |  |  |
  | 758 |  | $resource\_key = "{$resource\_id}\_{$fetch}"; |
  | 759 |  |  |
  | 760 |  | // Do we need cache? Let we define cache fallback key |
  | 761 |  | $cache\_key\_fallback = 'ytc\_' . md5( $resource\_key ) . '\_fallback'; |
  | 762 |  |  |
  | 763 |  | // Do cache magic |
  | 764 |  | if ( ! empty( $instance['cache'] ) && $instance['cache'] > 0 ) { |
  | 765 |  |  |
  | 766 |  | // generate feed cache key for caching time |
  | 767 |  | $cache\_key = 'ytc\_' . md5( $resource\_key ) . '\_' . $instance['cache']; |
  | 768 |  |  |
  | 769 |  | if ( ! empty( $\_GET['ytc\_force\_recache'] ) ) { |
  | 770 |  | delete\_transient( $cache\_key ); |
  | 771 |  | } |
  | 772 |  |  |
  | 773 |  | // get/set transient cache |
  | 774 |  | $json = get\_transient( $cache\_key ); |
  | 775 |  | if ( false === $json || empty( $json ) ) { |
  | 776 |  |  |
  | 777 |  | // no cached JSON, get new |
  | 778 |  | $json = $this->fetch\_youtube\_feed( $resource\_id, $fetch ); |
  | 779 |  |  |
  | 780 |  | // set decoded JSON to transient cache\_key |
  | 781 |  | set\_transient( $cache\_key, base64\_encode( $json ), $instance['cache'] ); |
  | 782 |  |  |
  | 783 |  | } else { |
  | 784 |  |  |
  | 785 |  | // we already have cached feed JSON, get it encoded |
  | 786 |  | $json = base64\_decode( $json ); |
  | 787 |  |  |
  | 788 |  | } |
  | 789 |  | } else { |
  | 790 |  |  |
  | 791 |  | // just get fresh feed if cache disabled |
  | 792 |  | $json = $this->fetch\_youtube\_feed( $resource\_id, $fetch ); |
  | 793 |  |  |
  | 794 |  | } |
  | 795 |  |  |
  | 796 |  | // free some memory |
  | 797 |  | unset( $response ); |
  | 798 |  |  |
  | 799 |  | // decode JSON data |
  | 800 |  | $json\_output = json\_decode( $json ); |
  | 801 |  |  |
  | 802 |  | // YTC 3.0.7: Do we need this, still? |
  | 803 |  | // if current feed is messed up, try to get it from fallback cache |
  | 804 |  | if ( is\_wp\_error( $json\_output ) && ! is\_object( $json\_output ) && empty( $json\_output->items ) ) { |
  | 805 |  | // do we have fallback cache?! |
  | 806 |  | $json\_fallback = get\_transient( $cache\_key\_fallback ); |
  | 807 |  | if ( true === $json\_fallback && ! empty( $json\_fallback ) ) { |
  | 808 |  | $json\_output = json\_decode( base64\_decode( $json\_fallback ) ); |
  | 809 |  | // and free memory |
  | 810 |  | unset( $json\_fallback ); |
  | 811 |  | } |
  | 812 |  | } |
  | 813 |  |  |
  | 814 |  | // Get resource nice name based on selected resource |
  | 815 |  | $resource\_nice\_name = $this->resource\_nice\_name( $resource ); |
  | 816 |  |  |
  | 817 |  | // Prevent further checks if we have WP Error or empty record even after fallback |
  | 818 |  | if ( is\_wp\_error( $json\_output ) ) { |
  | 819 |  | $output .= $this->front\_debug( $json\_output->get\_error\_message() ); |
  | 820 |  | return $output; |
  | 821 |  | } elseif ( isset( $json\_output->items ) && 0 == sizeof( $json\_output->items ) ) { |
  | 822 |  | $output .= $this->front\_debug( sprintf( \_\_( 'You have set to display videos from %1$s [resource list ID: %2$s], but there have no public videos in that resouce.' ), $resource\_nice\_name, $resource\_id ) ); |
  | 823 |  | return $output; |
  | 824 |  | } elseif ( empty( $json\_output ) ) { |
  | 825 |  | $output .= $this->front\_debug( sprintf( \_\_( 'We have empty record for this feed. Please read <a href="%1$s" target="\_blank">FAQ</a> and if that does not help, contact <a href="%2$s" target="\_blank">support</a>.' ), 'https://wordpress.org/plugins/youtube-channel#faq', 'https://wordpress.org/support/plugin/youtube-channel/' ) ); |
  | 826 |  | return $output; |
  | 827 |  | } |
  | 828 |  |  |
  | 829 |  | // Predefine `max\_items` to prevent undefined notices |
  | 830 |  | $max\_items = 0; |
  | 831 |  | if ( is\_object( $json\_output ) && ! empty( $json\_output->items ) ) { |
  | 832 |  |  |
  | 833 |  | // Sort by date uploaded |
  | 834 |  | $json\_entry = $json\_output->items; |
  | 835 |  |  |
  | 836 |  | $num = ( empty( $instance['num'] ) ) ? $this->defaults['num'] : $instance['num']; |
  | 837 |  | if ( $num > $fetch ) { |
  | 838 |  | $fetch = $num; |
  | 839 |  | } |
  | 840 |  | $max\_items = ( $fetch > sizeof( $json\_entry ) ) ? sizeof( $json\_entry ) : $fetch; |
  | 841 |  |  |
  | 842 |  | if ( ! empty( $instance['random'] ) ) { |
  | 843 |  | $items = array\_slice( $json\_entry, 0, $max\_items ); |
  | 844 |  | } else { |
  | 845 |  | if ( ! $num ) { |
  | 846 |  | $num = 1; |
  | 847 |  | } |
  | 848 |  | $items = array\_slice( $json\_entry, $skip, $num ); |
  | 849 |  | } |
  | 850 |  | } |
  | 851 |  |  |
  | 852 |  | if ( 0 == $max\_items ) { |
  | 853 |  |  |
  | 854 |  | // Set default error message |
  | 855 |  | $error\_msg = 'Unrecognized error experienced.'; |
  | 856 |  |  |
  | 857 |  | // Append YouTube DATA API error reason as comment |
  | 858 |  | if ( ! empty( $json\_output ) && is\_object( $json\_output ) && ! empty( $json\_output->error->errors ) ) { |
  | 859 |  |  |
  | 860 |  | // Error went in fetch\_youtube\_feed() |
  | 861 |  | if ( 'wpError' == $json\_output->error->errors[0]->reason ) { |
  | 862 |  | $error\_msg = $json\_output->error->errors[0]->message; |
  | 863 |  | } elseif ( 'playlistNotFound' == $json\_output->error->errors[0]->reason ) { |
  | 864 |  | // Playlist error from Google API |
  | 865 |  | if ( 'playlist' == $resource\_name ) { |
  | 866 |  | $error\_msg = "Please check did you set existing <em>Playlist ID</em>. You set to show videos from {$resource\_nice\_name}, but YouTube does not recognize <strong>{$resource\_id}</strong> as existing and public playlist."; |
  | 867 |  | } else { |
  | 868 |  | $error\_msg = "Please check did you set the proper <em>Channel ID</em>. You set to show videos from {$resource\_nice\_name}, but YouTube does not recognize <strong>{$channel}</strong> as an existing or public channel."; |
  | 869 |  | } |
  | 870 |  | } elseif ( 'keyInvalid' == $json\_output->error->errors[0]->reason ) { |
  | 871 |  | // Invalid YouTube Data API Key |
  | 872 |  | $error\_msg = sprintf( \_\_( "Double check <em>YouTube Data API Key</em> on <em>General</em> plugin tab and make sure it's correct. Read <a href=\"%s\" target=\"\_blank\">Installation</a> document." ), 'https://wordpress.org/plugins/youtube-channel/installation/' ); |
  | 873 |  | } elseif ( 'ipRefererBlocked' == $json\_output->error->errors[0]->reason ) { |
  | 874 |  | // Restricted access YouTube Data API Key |
  | 875 |  | $error\_msg = 'Check <em>YouTube Data API Key</em> restrictions, empty cache if enabled by appending in the browser address bar parameter <em>?ytc\_force\_recache=1</em>'; |
  | 876 |  | } elseif ( 'invalidChannelId' == $json\_output->error->errors[0]->reason ) { |
  | 877 |  | // (deprecated?) Non existing Channel ID set |
  | 878 |  | $error\_msg = sprintf( \_\_( 'You have set wrong Channel ID. Fix that in General plugin settings, Widget and/or shortcode. Read <a href="%s" target="\_blank">FAQ</a> document.' ), 'https://wordpress.org/plugins/youtube-channel/faq/' ); |
  | 879 |  | } elseif ( 'playlistItemsNotAccessible' == $json\_output->error->errors[0]->reason ) { |
  | 880 |  | // Forbidden access to resource |
  | 881 |  | $error\_msg = sprintf( \_\_( "You do not have permission to access ressource <strong>%s</strong> (it's maybe set to private or even does not exists!)" ), $resource\_id ); |
  | 882 |  | } else { |
  | 883 |  | $error\_msg = sprintf( |
  | 884 |  | 'Reason: %1$s; Domain: %2$s; Message: %3$s', |
  | 885 |  | $json\_output->error->errors[0]->reason, |
  | 886 |  | $json\_output->error->errors[0]->domain, |
  | 887 |  | $json\_output->error->errors[0]->message |
  | 888 |  | ); |
  | 889 |  | } |
  | 890 |  | } // END ! empty($json\_output->error->errors) |
  | 891 |  |  |
  | 892 |  | $output .= $this->front\_debug( $error\_msg ); |
  | 893 |  |  |
  | 894 |  | } else { // ELSE if ($max\_items == 0) |
  | 895 |  |  |
  | 896 |  | // looks that feed is OK, let we update fallback that never expire |
  | 897 |  | set\_transient( $cache\_key\_fallback, base64\_encode( $json ), 0 ); |
  | 898 |  |  |
  | 899 |  | // and now free some memory |
  | 900 |  | unset( $json, $json\_output, $json\_entry ); |
  | 901 |  |  |
  | 902 |  | // set array for unique random item |
  | 903 |  | if ( ! empty( $instance['random'] ) ) { |
  | 904 |  | $random\_used = []; |
  | 905 |  | } |
  | 906 |  |  |
  | 907 |  | /\* AU:20141230 reduce number of videos if requested > available \*/ |
  | 908 |  | if ( $num > sizeof( $items ) ) { |
  | 909 |  | $num = sizeof( $items ); |
  | 910 |  | } |
  | 911 |  |  |
  | 912 |  | for ( $y = 1; $y <= $num; ++$y ) { |
  | 913 |  | if ( ! empty( $instance['random'] ) ) { |
  | 914 |  |  |
  | 915 |  | $random\_item = mt\_rand( 0, ( count( $items ) - 1 ) ); |
  | 916 |  | while ( $y > 1 && in\_array( $random\_item, $random\_used ) ) { |
  | 917 |  | $random\_item = mt\_rand( 0, ( count( $items ) - 1 ) ); |
  | 918 |  | } |
  | 919 |  | $random\_used[] = $random\_item; |
  | 920 |  | $item = $items[ $random\_item ]; |
  | 921 |  | } else { |
  | 922 |  | $item = $items[ $y - 1 ]; |
  | 923 |  | } |
  | 924 |  |  |
  | 925 |  | // Generate single video block |
  | 926 |  | $video\_block = $this->ytc\_print\_video( $item, $instance, $y ); |
  | 927 |  | // Allow plugins/themes to override the default video block template. |
  | 928 |  | $video\_block = apply\_filters( 'ytc\_print\_video', $video\_block, $item, $instance, $y ); |
  | 929 |  | // Append video block to final output |
  | 930 |  | $output .= $video\_block; |
  | 931 |  | } |
  | 932 |  | // Free some memory |
  | 933 |  | unset( $random\_used, $random\_item, $json ); |
  | 934 |  |  |
  | 935 |  | } // END if ($max\_items == 0) |
  | 936 |  | } // single playlist or ytc way |
  | 937 |  |  |
  | 938 |  | // Append link to channel on bootom of the widget |
  | 939 |  | $output .= $this->ytc\_footer( $instance ); |
  | 940 |  |  |
  | 941 |  | $output .= '</div><!-- .youtube\_channel -->'; |
  | 942 |  |  |
  | 943 |  | // fix overflow on crappy themes |
  | 944 |  | $output .= '<div class="clearfix"></div>'; |
  | 945 |  |  |
  | 946 |  | return $output; |
  | 947 |  |  |
  | 948 |  | } // END public function output($instance) |
  | 949 |  |  |
  | 950 |  | // --- HELPER FUNCTIONS --- |
  | 951 |  |  |
  | 952 |  | /\*\* |
  | 953 |  | \* Download YouTube video feed through API 3.0 |
  | 954 |  | \* @param  string $id       ID of resource |
  | 955 |  | \* @param  integer $items   Number of items to fetch (min 2, max 50) |
  | 956 |  | \* @return array            JSON with videos |
  | 957 |  | \*/ |
  | 958 |  | function fetch\_youtube\_feed( $resource\_id, $items ) { |
  | 959 |  |  |
  | 960 |  | $feed\_url = 'https://www.googleapis.com/youtube/v3/playlistItems?'; |
  | 961 |  | $feed\_url .= 'part=snippet'; |
  | 962 |  | $feed\_url .= "&playlistId={$resource\_id}"; |
  | 963 |  | $feed\_url .= '&fields=items(snippet(title%2Cdescription%2CpublishedAt%2CresourceId(videoId)))'; |
  | 964 |  | $feed\_url .= "&maxResults={$items}"; |
  | 965 |  | $feed\_url .= "&key={$this->defaults['apikey']}"; |
  | 966 |  |  |
  | 967 |  | $wparg = [ |
  | 968 |  | 'timeout'   => $this->defaults['timeout'], |
  | 969 |  | 'sslverify' => $this->defaults['sslverify'] ? true : false, |
  | 970 |  | 'headers'   => [ 'referer' => site\_url() ], |
  | 971 |  | ]; |
  | 972 |  |  |
  | 973 |  | $response = wp\_remote\_get( $feed\_url, $wparg ); |
  | 974 |  |  |
  | 975 |  | // If we have WP error, make JSON with error |
  | 976 |  | if ( is\_wp\_error( $response ) ) { |
  | 977 |  |  |
  | 978 |  | $json = sprintf( '{"error":{"errors":[{"reason":"wpError","message":"%s","domain":"wpRemoteGet"}]}}', $response->get\_error\_message() ); |
  | 979 |  |  |
  | 980 |  | } else { |
  | 981 |  |  |
  | 982 |  | $json = wp\_remote\_retrieve\_body( $response ); |
  | 983 |  |  |
  | 984 |  | } |
  | 985 |  |  |
  | 986 |  | // Free some memory |
  | 987 |  | unset( $response ); |
  | 988 |  |  |
  | 989 |  | return $json; |
  | 990 |  |  |
  | 991 |  | } // END function fetch\_youtube\_feed($resource\_id, $items) |
  | 992 |  |  |
  | 993 |  | /\*\* |
  | 994 |  | \* Print explanation of error for administrators (users with capability manage\_options) |
  | 995 |  | \* and hidden message for lower users and visitors |
  | 996 |  | \* @param  string $message Error message |
  | 997 |  | \* @return string          FOrmatted message for error |
  | 998 |  | \*/ |
  | 999 |  | function front\_debug( $message ) { |
  | 1000 |  |  |
  | 1001 |  | // Show visible error to admin, Oops message to visitors and lower members |
  | 1002 |  | if ( is\_user\_logged\_in() && current\_user\_can( 'manage\_options' ) ) { |
  | 1003 |  |  |
  | 1004 |  | $output = "<p class=\"ytc\_error\"><strong>YTC ERROR:</strong> $message</p>"; |
  | 1005 |  |  |
  | 1006 |  | } else { |
  | 1007 |  |  |
  | 1008 |  | $output = \_\_( 'Oops, something went wrong.', 'youtube-channel' ); |
  | 1009 |  | $output .= "<!-- YTC ERROR:\n"; |
  | 1010 |  | $output .= strip\_tags( $message ); |
  | 1011 |  | $output .= "\n-->\n"; |
  | 1012 |  |  |
  | 1013 |  | } |
  | 1014 |  |  |
  | 1015 |  | return $output; |
  | 1016 |  |  |
  | 1017 |  | } // END function debug( $message ) |
  | 1018 |  |  |
  | 1019 |  | /\*\* |
  | 1020 |  | \* Calculate height by provided width and aspect ratio |
  | 1021 |  | \* @param  integer $width Width in pixels |
  | 1022 |  | \* @param  integer $ratio Selected aspect ratio (1 for 4:3, other for 16:9) |
  | 1023 |  | \* @return integer        Calculated height in pixels |
  | 1024 |  | \*/ |
  | 1025 |  | function height\_ratio( $width = 306, $ratio = 2 ) { |
  | 1026 |  |  |
  | 1027 |  | switch ( $ratio ) { |
  | 1028 |  | case 1: |
  | 1029 |  | $height = round( ( $width / 4 ) \* 3 ); |
  | 1030 |  | break; |
  | 1031 |  | default: |
  | 1032 |  | $height = round( ( $width / 16 ) \* 9 ); |
  | 1033 |  | } |
  | 1034 |  | return $height; |
  | 1035 |  | } // END function height\_ratio($width=306, $ratio) |
  | 1036 |  |  |
  | 1037 |  | /\*\* |
  | 1038 |  | \* Generate link to YouTube channel/user |
  | 1039 |  | \* @param  array $instance widget or shortcode settings |
  | 1040 |  | \* @return array           components prepared for output |
  | 1041 |  | \*/ |
  | 1042 |  | function ytc\_footer( $instance ) { |
  | 1043 |  |  |
  | 1044 |  | // Initialize output string |
  | 1045 |  | $output = ''; |
  | 1046 |  |  |
  | 1047 |  | // Get link to channel part |
  | 1048 |  | $output .= $this->ytc\_channel\_link( $instance ); |
  | 1049 |  |  |
  | 1050 |  | // Wrap content, if we have it |
  | 1051 |  | if ( ! empty( $output ) ) { |
  | 1052 |  | $output = $this->clearfix() . '<div class="ytc\_link"><p>' . $output . '</p></div>'; |
  | 1053 |  | } |
  | 1054 |  |  |
  | 1055 |  | return $output; |
  | 1056 |  | } // end function ytc\_footer |
  | 1057 |  |  |
  | 1058 |  | function clearfix() { |
  | 1059 |  | return '<div class="clearfix"></div>'; |
  | 1060 |  | } |
  | 1061 |  | /\*\* |
  | 1062 |  | \* Generate link to YouTube channel/user |
  | 1063 |  | \* @param  array $instance widget or shortcode settings |
  | 1064 |  | \* @return array           components prepared for output |
  | 1065 |  | \*/ |
  | 1066 |  | function ytc\_channel\_link( $instance ) { |
  | 1067 |  |  |
  | 1068 |  | // Initialize output string |
  | 1069 |  | $output = ''; |
  | 1070 |  |  |
  | 1071 |  | // do we need to show goto link? |
  | 1072 |  | if ( ! empty( $instance['link\_to'] ) && 'none' != $instance['link\_to'] ) { |
  | 1073 |  |  |
  | 1074 |  | $goto\_url = 'https://www.youtube.com/'; |
  | 1075 |  |  |
  | 1076 |  | switch ( $instance['link\_to'] ) { |
  | 1077 |  | case 'vanity': |
  | 1078 |  | $vanity   = trim( $instance['vanity'] ); |
  | 1079 |  | if ( empty( $vanity ) ) { |
  | 1080 |  | if ( empty( $this->defaults['vanity'] ) ) { |
  | 1081 |  | return '<!-- YTC ERROR: Selected Vanity custom URL to be linked but no Vanity Name provided! -->'; |
  | 1082 |  | } |
  | 1083 |  | // Get vanity from defaults if not set in instance |
  | 1084 |  | $vanity = $this->defaults['vanity']; |
  | 1085 |  | } |
  | 1086 |  | // sanity vanity content (strip all in front of last slash to cleanup vanity ID only) |
  | 1087 |  | if ( ! empty( $vanity ) && false !== strpos( $vanity, 'youtube.com' ) ) { |
  | 1088 |  | $vanity = preg\_replace( '/^.\*\//', '', $vanity ); |
  | 1089 |  | } |
  | 1090 |  | $goto\_url .= "c/$vanity"; |
  | 1091 |  | break; |
  | 1092 |  |  |
  | 1093 |  | case 'legacy': |
  | 1094 |  | $username = trim( $instance['username'] ); |
  | 1095 |  | if ( empty( $username ) ) { |
  | 1096 |  | if ( empty( $this->defaults['username'] ) ) { |
  | 1097 |  | return '<!-- YTC ERROR: Selected Legacy username to be linked but no Legacy username provided! -->'; |
  | 1098 |  | } |
  | 1099 |  | $username = $this->defaults['username']; |
  | 1100 |  | } |
  | 1101 |  | $goto\_url .= "user/$username"; |
  | 1102 |  | break; |
  | 1103 |  |  |
  | 1104 |  | case 'channel': |
  | 1105 |  | $channel  = trim( $instance['channel'] ); |
  | 1106 |  | if ( empty( $channel ) ) { |
  | 1107 |  | if ( empty( $this->defaults['channel'] ) ) { |
  | 1108 |  | return '<!-- YTC ERROR: Selected Channel page to be linked but no Channel ID provided! -->'; |
  | 1109 |  | } |
  | 1110 |  | $channel = $this->defaults['channel']; |
  | 1111 |  | } |
  | 1112 |  | $goto\_url .= "channel/$channel"; |
  | 1113 |  | break; |
  | 1114 |  | } |
  | 1115 |  |  |
  | 1116 |  | $goto\_txt = trim( $instance['goto\_txt'] ); |
  | 1117 |  | if ( '' == $goto\_txt ) { |
  | 1118 |  | $goto\_txt = \_\_( 'Visit our YouTube channel', 'youtube-channel' ); |
  | 1119 |  | } |
  | 1120 |  |  |
  | 1121 |  | $newtab = \_\_( 'in new window/tab', 'youtube-channel' ); |
  | 1122 |  |  |
  | 1123 |  | switch ( $instance['popup\_goto'] ) { |
  | 1124 |  | case 1: |
  | 1125 |  | $output .= "<a href=\"javascript: window.open('{$goto\_url}'); void 0;\" title=\"{$goto\_txt} {$newtab}\">{$goto\_txt}</a>"; |
  | 1126 |  | break; |
  | 1127 |  | case 2: |
  | 1128 |  | $output .= "<a href=\"{$goto\_url}\" target=\"\_blank\" title=\"{$goto\_txt} {$newtab}\">{$goto\_txt}</a>"; |
  | 1129 |  | break; |
  | 1130 |  | default: |
  | 1131 |  | $output .= "<a href=\"{$goto\_url}\" title=\"{$goto\_txt}\">$goto\_txt</a>"; |
  | 1132 |  | } // switch popup\_goto |
  | 1133 |  |  |
  | 1134 |  | } // END if ( ! empty( $instance['link\_to'] ) && 'none' != $instance['link\_to'] ) |
  | 1135 |  |  |
  | 1136 |  | return $output; |
  | 1137 |  | } // END function ytc\_channel\_link |
  | 1138 |  |  |
  | 1139 |  |  |
  | 1140 |  | /\*\* |
  | 1141 |  | \* Generate output for single video block |
  | 1142 |  | \* @param  object $item     Video object from JSON |
  | 1143 |  | \* @param  array  $instance Settings from widget or shortcode |
  | 1144 |  | \* @param  int    $y        Order number of video |
  | 1145 |  | \* @return array            Prepared single video block as array to concatenate |
  | 1146 |  | \*/ |
  | 1147 |  | function ytc\_print\_video( $item, $instance, $y ) { |
  | 1148 |  |  |
  | 1149 |  | // Start output string |
  | 1150 |  | $output = ''; |
  | 1151 |  |  |
  | 1152 |  | // Calculate width and height |
  | 1153 |  | if ( empty( $instance['width'] ) ) { |
  | 1154 |  | $instance['width'] = $this->defaults['width']; |
  | 1155 |  | } |
  | 1156 |  | if ( empty( $instance['ratio'] ) ) { |
  | 1157 |  | $instance['ratio'] = $this->defaults['ratio']; |
  | 1158 |  | } |
  | 1159 |  | $height = $this->height\_ratio( $instance['width'], $instance['ratio'] ); |
  | 1160 |  |  |
  | 1161 |  | // How to display videos? |
  | 1162 |  | if ( empty( $instance['display'] ) ) { |
  | 1163 |  | $instance['display'] = 'thumbnail'; |
  | 1164 |  | } |
  | 1165 |  |  |
  | 1166 |  | // Extract details about video from Resource |
  | 1167 |  | $yt\_id    = $item->snippet->resourceId->videoId; |
  | 1168 |  | $yt\_title = $item->snippet->title; |
  | 1169 |  | $yt\_date  = $item->snippet->publishedAt; |
  | 1170 |  |  |
  | 1171 |  | // Enhanced privacy? |
  | 1172 |  | $youtube\_domain = $this->youtube\_domain( $instance ); |
  | 1173 |  |  |
  | 1174 |  | switch ( $y ) { |
  | 1175 |  | case 1: |
  | 1176 |  | $vnumclass = 'first'; |
  | 1177 |  | break; |
  | 1178 |  | case $instance['num']: |
  | 1179 |  | $autoplay = false; |
  | 1180 |  | $vnumclass = 'last'; |
  | 1181 |  | break; |
  | 1182 |  | default: |
  | 1183 |  | $vnumclass = 'mid'; |
  | 1184 |  | $autoplay = false; |
  | 1185 |  | break; |
  | 1186 |  | } |
  | 1187 |  |  |
  | 1188 |  | // Set proper class for responsive thumbs per selected aspect ratio |
  | 1189 |  | $arclass = $this->arclass( $instance ); |
  | 1190 |  |  |
  | 1191 |  | // Prepare title\_tag (H3, etc) |
  | 1192 |  | $title\_tag = isset( $instance['titletag'] ) ? $instance['titletag'] : $this->defaults['titletag']; |
  | 1193 |  |  |
  | 1194 |  | $output .= "<div class=\"ytc\_video\_container ytc\_video\_{$y} ytc\_video\_{$vnumclass} ${arclass}\" style=\"width:{$instance['width']}px\">"; |
  | 1195 |  |  |
  | 1196 |  | // Show video title above video? |
  | 1197 |  | if ( ! empty( $instance['showtitle'] ) ) { |
  | 1198 |  | if ( |
  | 1199 |  | // for non-thumbnail for `above` and `inside` |
  | 1200 |  | ( 'thumbnail' != $instance['display'] && in\_array( $instance['showtitle'], [ 'above', 'inside' ] ) ) || |
  | 1201 |  | // for thubmanil only if it's `below` |
  | 1202 |  | ( 'thumbnail' == $instance['display'] && 'above' == $instance['showtitle'] ) |
  | 1203 |  | ) { |
  | 1204 |  | if ( ! empty( $instance['linktitle'] ) ) { |
  | 1205 |  | $output .= sprintf( |
  | 1206 |  | '<%1$s class="ytc\_title ytc\_title\_above"><a href="https://%3$s/watch/?v=%4$s" target="youtube">%2$s</a></%1$s>', |
  | 1207 |  | $title\_tag, |
  | 1208 |  | $yt\_title, |
  | 1209 |  | $youtube\_domain, |
  | 1210 |  | $yt\_id |
  | 1211 |  | ); |
  | 1212 |  | } else { |
  | 1213 |  | $output .= sprintf( |
  | 1214 |  | '<%1$s class="ytc\_title ytc\_title\_above">%2$s</%1$s>', |
  | 1215 |  | $title\_tag, |
  | 1216 |  | $yt\_title |
  | 1217 |  | ); |
  | 1218 |  | } |
  | 1219 |  | } |
  | 1220 |  | } |
  | 1221 |  |  |
  | 1222 |  | // Print out video |
  | 1223 |  | if ( 'iframe' == $instance['display'] ) { |
  | 1224 |  |  |
  | 1225 |  | // Start wrapper for responsive item |
  | 1226 |  | if ( $instance['responsive'] ) { |
  | 1227 |  | $output .= '<div class="fluid-width-video-wrapper">'; |
  | 1228 |  | } |
  | 1229 |  |  |
  | 1230 |  | $output .= "<iframe title=\"YouTube Video Player\" width=\"{$instance['width']}\" height=\"{$height}\" src=\"//{$youtube\_domain}/embed/{$yt\_id}?wmode=opaque"; |
  | 1231 |  |  |
  | 1232 |  | // disable related vides |
  | 1233 |  | if ( ! empty( $instance['norel'] ) ) { |
  | 1234 |  | $output .= '&amp;rel=0'; |
  | 1235 |  | } |
  | 1236 |  | if ( ! empty( $instance['controls'] ) ) { |
  | 1237 |  | $output .= '&amp;controls=0'; |
  | 1238 |  | } |
  | 1239 |  | if ( ! empty( $instance['autoplay'] ) && 1 == $y ) { |
  | 1240 |  | $output .= '&amp;autoplay=1'; |
  | 1241 |  | } |
  | 1242 |  | if ( ! empty( $instance['hideanno'] ) ) { |
  | 1243 |  | $output .= '&amp;iv\_load\_policy=3'; |
  | 1244 |  | } |
  | 1245 |  | if ( ! empty( $instance['modestbranding'] ) ) { |
  | 1246 |  | $output .= '&amp;modestbranding=1'; |
  | 1247 |  | } |
  | 1248 |  | if ( ! empty( $instance['playsinline'] ) ) { |
  | 1249 |  | $output .= '&amp;playsinline=1'; |
  | 1250 |  | } |
  | 1251 |  |  |
  | 1252 |  | $output .= "\" style=\"border:0;\" allowfullscreen id=\"ytc\_{$yt\_id}\"></iframe>"; |
  | 1253 |  |  |
  | 1254 |  | // Close wrapper for responsive item |
  | 1255 |  | if ( $instance['responsive'] ) { |
  | 1256 |  | $output .= '</div>'; |
  | 1257 |  | } |
  | 1258 |  | } elseif ( 'iframe2' == $instance['display'] ) { |
  | 1259 |  |  |
  | 1260 |  | // youtube API async |
  | 1261 |  | $js\_vars = ''; |
  | 1262 |  | $js\_vars .= ( ! empty( $instance['norel'] ) ) ? 'rel:0,' : ''; |
  | 1263 |  | $js\_vars .= ( ! empty( $instance['autoplay'] ) && 1 == $y ) ? 'autoplay:1,' : ''; |
  | 1264 |  | $js\_vars .= ( ! empty( $instance['controls'] ) ) ? 'controls:0,' : ''; |
  | 1265 |  | $js\_vars .= ( ! empty( $instance['modestbranding'] ) ) ? 'modestbranding:1,' : ''; |
  | 1266 |  | $js\_vars .= ( ! empty( $instance['playsinline'] ) ) ? 'playsinline:1,' : ''; |
  | 1267 |  | $js\_vars .= "wmmode:'opaque'"; |
  | 1268 |  | $js\_vars = rtrim( $js\_vars, ',' ); |
  | 1269 |  |  |
  | 1270 |  | $js\_end = ''; |
  | 1271 |  | $js\_end .= ( ! empty( $instance['hideanno'] ) ) ? 'iv\_load\_policy:3,' : ''; |
  | 1272 |  | $js\_end .= ( ! empty( $instance['autoplay'] ) && ( 1 == $y ) && ! empty( $instance['autoplay\_mute'] ) ) ? "events:{'onReady':ytc\_mute}," : ''; |
  | 1273 |  | $js\_end = rtrim( $js\_end, ',' ); |
  | 1274 |  |  |
  | 1275 |  | $js\_player\_id      = str\_replace( '-', '\_', $yt\_id ); |
  | 1276 |  |  |
  | 1277 |  | // Start wrapper for responsive item |
  | 1278 |  | if ( $instance['responsive'] ) { |
  | 1279 |  | $output .= '<div class="fluid-width-video-wrapper">'; |
  | 1280 |  | } |
  | 1281 |  |  |
  | 1282 |  | $output .= "<div id=\"ytc\_player\_{$js\_player\_id}\"></div>"; |
  | 1283 |  |  |
  | 1284 |  | // Close wrapper for responsive item |
  | 1285 |  | if ( $instance['responsive'] ) { |
  | 1286 |  | $output .= '</div>'; |
  | 1287 |  | } |
  | 1288 |  |  |
  | 1289 |  | $site\_domain = $\_SERVER['HTTP\_HOST']; |
  | 1290 |  | $ytc\_html5\_js = "var ytc\_player\_{$js\_player\_id};"; |
  | 1291 |  | $ytc\_html5\_js .= "ytc\_player\_{$js\_player\_id}=new YT.Player('ytc\_player\_{$js\_player\_id}',{height:'{$height}',width:'{$instance['width']}',"; |
  | 1292 |  | $ytc\_html5\_js .= "videoId:'{$yt\_id}',enablejsapi:1,playerVars:{{$js\_vars}},origin:'{$site\_domain}',{$js\_end}});"; |
  | 1293 |  |  |
  | 1294 |  | // prepare JS for footer |
  | 1295 |  | if ( empty( $this->ytc\_html5\_js ) ) { |
  | 1296 |  | $this->ytc\_html5\_js = $ytc\_html5\_js; |
  | 1297 |  | } else { |
  | 1298 |  | $this->ytc\_html5\_js .= $ytc\_html5\_js; |
  | 1299 |  | } |
  | 1300 |  | } else { // default is thumbnail |
  | 1301 |  |  |
  | 1302 |  | // Do we need tooltip for thumbnail? |
  | 1303 |  | if ( empty( $instance['no\_thumb\_title'] ) ) { |
  | 1304 |  | $title = sprintf( \_\_( 'Watch video %1$s published on %2$s', 'youtube-channel' ), $yt\_title, $yt\_date ); |
  | 1305 |  | } |
  | 1306 |  |  |
  | 1307 |  | $p = ''; |
  | 1308 |  | $target = ''; |
  | 1309 |  | if ( empty( $instance['nolightbox'] ) ) { |
  | 1310 |  | if ( ! empty( $instance['norel'] ) ) { |
  | 1311 |  | $p .= '&amp;rel=0'; |
  | 1312 |  | } |
  | 1313 |  | if ( ! empty( $instance['modestbranding'] ) ) { |
  | 1314 |  | $p .= '&amp;modestbranding=1'; |
  | 1315 |  | } |
  | 1316 |  | if ( ! empty( $instance['controls'] ) ) { |
  | 1317 |  | $p .= '&amp;controls=0'; |
  | 1318 |  | } |
  | 1319 |  | if ( ! empty( $instance['playsinline'] ) ) { |
  | 1320 |  | $p .= '&amp;playsinline=1'; |
  | 1321 |  | } |
  | 1322 |  | if ( ! empty( $instance['privacy'] ) ) { |
  | 1323 |  | $p .= '&amp;enhanceprivacy=1'; |
  | 1324 |  | } |
  | 1325 |  | $lightbox\_class = 'ytc-lightbox'; |
  | 1326 |  | } else { |
  | 1327 |  | $lightbox\_class = 'ytc-nolightbox'; |
  | 1328 |  | if ( ! empty( $instance['target'] ) ) { |
  | 1329 |  | $target = 'target="' . sanitize\_key( $instance['target'] ) . '"'; |
  | 1330 |  | } |
  | 1331 |  | } |
  | 1332 |  |  |
  | 1333 |  | // Do we need thumbnail w/ or w/o tooltip |
  | 1334 |  | $tag\_title = ( empty( $instance['no\_thumb\_title'] ) ) ? $tag\_title = "title=\"{$yt\_title}\"" : ''; |
  | 1335 |  |  |
  | 1336 |  | // Define video thumbnail |
  | 1337 |  | switch ( $instance['thumb\_quality'] ) { |
  | 1338 |  | case 'default': |
  | 1339 |  | case 'mqdefault': |
  | 1340 |  | case 'hqdefault': |
  | 1341 |  | case 'sddefault': |
  | 1342 |  | case 'maxresdefault': |
  | 1343 |  | $thumb\_quality = $instance['thumb\_quality']; |
  | 1344 |  | break; |
  | 1345 |  | default: |
  | 1346 |  | $thumb\_quality = 'hqdefault'; |
  | 1347 |  | } |
  | 1348 |  | $yt\_thumb  = "//img.youtube.com/vi/${yt\_id}/${thumb\_quality}.jpg"; // zero for HD thumb |
  | 1349 |  |  |
  | 1350 |  | // Show video title inside video? |
  | 1351 |  | $title\_inside = ''; |
  | 1352 |  | if ( ! empty( $instance['showtitle'] ) && in\_array( $instance['showtitle'], [ 'inside', 'inside\_b' ] ) ) { |
  | 1353 |  | $title\_inside = sprintf( |
  | 1354 |  | '<%1$s class="ytc\_title ytc\_title\_inside %3$s">%2$s</%1$s>', |
  | 1355 |  | $title\_tag, |
  | 1356 |  | $yt\_title, |
  | 1357 |  | 'inside\_b' == $instance['showtitle'] ? 'ytc\_title\_inside\_bottom' : '' |
  | 1358 |  | ); |
  | 1359 |  | } |
  | 1360 |  |  |
  | 1361 |  | $output .= "<a href=\"//www.youtube.com/watch?v=${yt\_id}${p}\" ${tag\_title} class=\"ytc\_thumb ${lightbox\_class} ${arclass}\" ${target}><span style=\"background-image: url(${yt\_thumb});\" ${tag\_title} id=\"ytc\_{$yt\_id}\">{$title\_inside}</span></a>"; |
  | 1362 |  |  |
  | 1363 |  | } // what to show conditions |
  | 1364 |  |  |
  | 1365 |  | // Show video title below video? |
  | 1366 |  | if ( ! empty( $instance['showtitle'] ) ) { |
  | 1367 |  | if ( |
  | 1368 |  | // for non-thumbnail for `below` and `inside\_b` |
  | 1369 |  | ( 'thumbnail' != $instance['display'] && in\_array( $instance['showtitle'], [ 'below', 'inside\_b' ] ) ) || |
  | 1370 |  | // for thubmanil only if it's `below` |
  | 1371 |  | ( 'thumbnail' == $instance['display'] && 'below' == $instance['showtitle'] ) |
  | 1372 |  | ) { |
  | 1373 |  | if ( ! empty( $instance['linktitle'] ) ) { |
  | 1374 |  |  |
  | 1375 |  | $output .= sprintf( |
  | 1376 |  | '<%1$s class="ytc\_title ytc\_title\_below"><a href="https://%3$s/watch/?v=%4$s" target="youtube">%2$s</a></%1$s>', |
  | 1377 |  | $title\_tag, |
  | 1378 |  | $yt\_title, |
  | 1379 |  | $youtube\_domain, |
  | 1380 |  | $yt\_id |
  | 1381 |  | ); |
  | 1382 |  | } else { |
  | 1383 |  | $output .= sprintf( |
  | 1384 |  | '<%1$s class="ytc\_title ytc\_title\_below">%2$s</%1$s>', |
  | 1385 |  | $title\_tag, |
  | 1386 |  | $yt\_title |
  | 1387 |  | ); |
  | 1388 |  | } |
  | 1389 |  | } |
  | 1390 |  | } |
  | 1391 |  |  |
  | 1392 |  | // do we need to show video description? |
  | 1393 |  | if ( ! empty( $instance['showdesc'] ) ) { |
  | 1394 |  |  |
  | 1395 |  | $video\_description = $item->snippet->description; |
  | 1396 |  | $etcetera = ''; |
  | 1397 |  | ##TODO: If description should note be shortened, print HTML formatted desc |
  | 1398 |  | if ( $instance['desclen'] > 0 ) { |
  | 1399 |  | if ( function\_exists( 'mb\_strlen' ) && function\_exists( 'mb\_substr' ) ) { |
  | 1400 |  | if ( mb\_strlen( $video\_description ) > $instance['desclen'] ) { |
  | 1401 |  | $video\_description = mb\_substr( $video\_description, 0, $instance['desclen'] ); |
  | 1402 |  | $etcetera = '&hellip;'; |
  | 1403 |  | } |
  | 1404 |  | } else { |
  | 1405 |  | if ( strlen( $video\_description ) > $instance['desclen'] ) { |
  | 1406 |  | $video\_description = substr( $video\_description, 0, $instance['desclen'] ); |
  | 1407 |  | $etcetera = '&hellip;'; |
  | 1408 |  | } |
  | 1409 |  | } |
  | 1410 |  | } |
  | 1411 |  |  |
  | 1412 |  | if ( ! empty( $video\_description ) ) { |
  | 1413 |  | $output .= "<p class=\"ytc\_description\">{$video\_description}{$etcetera}</p>"; |
  | 1414 |  | } |
  | 1415 |  | } |
  | 1416 |  |  |
  | 1417 |  | $output .= '</div><!-- .ytc\_video\_container -->'; |
  | 1418 |  |  |
  | 1419 |  | return $output; |
  | 1420 |  | } // end function ytc\_print\_video |
  | 1421 |  |  |
  | 1422 |  | /\* function to print standard playlist embed code \*/ |
  | 1423 |  | function embed\_playlist( $resource\_id, $instance ) { |
  | 1424 |  |  |
  | 1425 |  | $width          = empty( $instance['width'] ) ? 306 : $instance['width']; |
  | 1426 |  | $height         = self::height\_ratio( $width, $instance['ratio'] ); |
  | 1427 |  | $autoplay       = empty( $instance['autoplay'] ) ? '' : '&autoplay=1'; |
  | 1428 |  | $modestbranding = empty( $instance['modestbranding'] ) ? '' : '&modestbranding=1'; |
  | 1429 |  | $rel            = empty( $instance['norel'] ) ? '' : '&rel=0'; |
  | 1430 |  | $playsinline    = empty( $instance['playsinline'] ) ? '' : '&playsinline=1'; |
  | 1431 |  |  |
  | 1432 |  | // enhanced privacy |
  | 1433 |  | $youtube\_domain = $this->youtube\_domain( $instance ); |
  | 1434 |  | $arclass = $this->arclass( $instance ); |
  | 1435 |  |  |
  | 1436 |  | // Start output string |
  | 1437 |  | $output = ''; |
  | 1438 |  |  |
  | 1439 |  | $output .= "<div class=\"ytc\_video\_container ytc\_video\_1 ytc\_video\_single ytc\_playlist\_only {$arclass}\">"; |
  | 1440 |  | $output .= '<div class="fluid-width-video-wrapper">'; |
  | 1441 |  | $output .= "<iframe src=\"//{$youtube\_domain}/embed/videoseries?list={$resource\_id}{$autoplay}{$modestbranding}{$rel}\""; |
  | 1442 |  | if ( ! empty( $instance['fullscreen'] ) ) { |
  | 1443 |  | $output .= ' allowfullscreen'; |
  | 1444 |  | } |
  | 1445 |  | $output .= " width=\"{$width}\" height=\"{$height}\" frameborder=\"0\"></iframe>"; |
  | 1446 |  | $output .= '</div><!-- .fluid-width-video-wrapper -->'; |
  | 1447 |  | $output .= '</div><!-- .ytc\_video\_container -->'; |
  | 1448 |  |  |
  | 1449 |  | return $output; |
  | 1450 |  |  |
  | 1451 |  | } // END function embed\_playlist($resource\_id, $instance) |
  | 1452 |  |  |
  | 1453 |  | // Helper function cache\_time() |
  | 1454 |  | function cache\_time( $cache\_time ) { |
  | 1455 |  |  |
  | 1456 |  | $out = ''; |
  | 1457 |  | $times = self::cache\_times\_arr(); |
  | 1458 |  | foreach ( $times as $sec => $title ) { |
  | 1459 |  | $out .= '<option value="' . $sec . '" ' . selected( $cache\_time, $sec, 0 ) . '>' . $title . '</option>'; |
  | 1460 |  | unset( $sec ); |
  | 1461 |  | } |
  | 1462 |  |  |
  | 1463 |  | return $out; |
  | 1464 |  |  |
  | 1465 |  | } // END function cache\_time() |
  | 1466 |  |  |
  | 1467 |  | /\*\* |
  | 1468 |  | \* Define cache times array |
  | 1469 |  | \*/ |
  | 1470 |  | public static function cache\_times\_arr() { |
  | 1471 |  |  |
  | 1472 |  | return [ |
  | 1473 |  | '0'       => \_\_( 'Do not cache', 'youtube-channel' ), |
  | 1474 |  | '60'      => \_\_( '1 minute', 'youtube-channel' ), |
  | 1475 |  | '300'     => \_\_( '5 minutes', 'youtube-channel' ), |
  | 1476 |  | '900'     => \_\_( '15 minutes', 'youtube-channel' ), |
  | 1477 |  | '1800'    => \_\_( '30 minutes', 'youtube-channel' ), |
  | 1478 |  | '3600'    => \_\_( '1 hour', 'youtube-channel' ), |
  | 1479 |  | '7200'    => \_\_( '2 hours', 'youtube-channel' ), |
  | 1480 |  | '18000'   => \_\_( '5 hours', 'youtube-channel' ), |
  | 1481 |  | '36000'   => \_\_( '10 hours', 'youtube-channel' ), |
  | 1482 |  | '43200'   => \_\_( '12 hours', 'youtube-channel' ), |
  | 1483 |  | '64800'   => \_\_( '18 hours', 'youtube-channel' ), |
  | 1484 |  | '86400'   => \_\_( '1 day', 'youtube-channel' ), |
  | 1485 |  | '172800'  => \_\_( '2 days', 'youtube-channel' ), |
  | 1486 |  | '259200'  => \_\_( '3 days', 'youtube-channel' ), |
  | 1487 |  | '345600'  => \_\_( '4 days', 'youtube-channel' ), |
  | 1488 |  | '432000'  => \_\_( '5 days', 'youtube-channel' ), |
  | 1489 |  | '518400'  => \_\_( '6 days', 'youtube-channel' ), |
  | 1490 |  | '604800'  => \_\_( '1 week', 'youtube-channel' ), |
  | 1491 |  | '1209600' => \_\_( '2 weeks', 'youtube-channel' ), |
  | 1492 |  | '1814400' => \_\_( '3 weeks', 'youtube-channel' ), |
  | 1493 |  | '2419200' => \_\_( '1 month', 'youtube-channel' ), |
  | 1494 |  | ]; |
  | 1495 |  |  |
  | 1496 |  | } // END public static function cache\_times\_arr() |
  | 1497 |  |  |
  | 1498 |  | /\*\* |
  | 1499 |  | \* Method to delete all YTC transient caches |
  | 1500 |  | \* @return string Report message about success or failed purge cache |
  | 1501 |  | \*/ |
  | 1502 |  | function clear\_all\_cache() { |
  | 1503 |  |  |
  | 1504 |  | global $wpdb; |
  | 1505 |  |  |
  | 1506 |  | $ret = $wpdb->query( |
  | 1507 |  | $wpdb->prepare( |
  | 1508 |  | "DELETE FROM $wpdb->options |
  | 1509 |  | WHERE option\_name LIKE %s |
  | 1510 |  | OR option\_name LIKE %s |
  | 1511 |  | ", |
  | 1512 |  | '\_transient\_timeout\_ytc\_%', |
  | 1513 |  | '\_transient\_ytc\_%' |
  | 1514 |  | ) |
  | 1515 |  | ); |
  | 1516 |  |  |
  | 1517 |  | if ( false === $ret ) { |
  | 1518 |  | echo 'Oops, we did not cleared any YouTube Channel cache because some error occured'; |
  | 1519 |  | } else { |
  | 1520 |  | if ( 0 == $ret ) { |
  | 1521 |  | echo 'Congratulations! You can chill, there is no YouTube Channel caches.'; |
  | 1522 |  | } else { |
  | 1523 |  | echo "Success! We cleared $ret row/s with YouTube Channel caches."; |
  | 1524 |  | } |
  | 1525 |  | } |
  | 1526 |  | exit(); |
  | 1527 |  |  |
  | 1528 |  | } // END function clear\_all\_cache() |
  | 1529 |  |  |
  | 1530 |  | /\*\* |
  | 1531 |  | \* Return nice name for resource by provided resource ID |
  | 1532 |  | \* @param  integer $resource\_id Resource ID |
  | 1533 |  | \* @return string               Resource nice name |
  | 1534 |  | \*/ |
  | 1535 |  | function resource\_nice\_name( $resource\_id ) { |
  | 1536 |  | if ( 0 == $resource\_id ) { |
  | 1537 |  | $resource\_nice\_name = 'Channel (User uploads)'; |
  | 1538 |  | } elseif ( 1 == $resource\_id ) { |
  | 1539 |  | $resource\_nice\_name = 'Favourited videos'; |
  | 1540 |  | } elseif ( 2 == $resource\_id ) { |
  | 1541 |  | $resource\_nice\_name = 'Liked videos'; |
  | 1542 |  | } elseif ( 3 == $resource\_id ) { |
  | 1543 |  | $resource\_nice\_name = 'Liked videos'; |
  | 1544 |  | } else { |
  | 1545 |  | $resource\_nice\_name = 'Unknown resource'; |
  | 1546 |  | } |
  | 1547 |  | return $resource\_nice\_name; |
  | 1548 |  | } // END function resource\_nice\_name( $resource\_id ) |
  | 1549 |  |  |
  | 1550 |  | function youtube\_domain( $instance ) { |
  | 1551 |  | return empty( $instance['privacy'] ) ? 'www.youtube.com' : 'www.youtube-nocookie.com'; |
  | 1552 |  | } // END function youtube\_domain |
  | 1553 |  |  |
  | 1554 |  | function arclass( $instance ) { |
  | 1555 |  | return ! empty( $instance['ratio'] ) && 1 == $instance['ratio'] ? 'ar4\_3' : 'ar16\_9'; |
  | 1556 |  | } // END function arclass() |
  | 1557 |  |  |
  | 1558 |  | /\*\* |
  | 1559 |  | \* Register TinyMCE button for YTC |
  | 1560 |  | \* @param  array $plugins Unmodified set of plugins |
  | 1561 |  | \* @return array          Set of TinyMCE plugins with YTC addition |
  | 1562 |  | \*/ |
  | 1563 |  | function mce\_external\_plugins( $plugins ) { |
  | 1564 |  |  |
  | 1565 |  | $plugins['youtube\_channel'] = plugin\_dir\_url( \_\_FILE\_\_ ) . 'inc/tinymce/plugin.min.js'; |
  | 1566 |  |  |
  | 1567 |  | return $plugins; |
  | 1568 |  |  |
  | 1569 |  | } // END function mce\_external\_plugins() |
  | 1570 |  |  |
  | 1571 |  | /\*\* |
  | 1572 |  | \* Append TinyMCE button for YTC at the end of row 1 |
  | 1573 |  | \* @param  array $buttons Unmodified set of buttons |
  | 1574 |  | \* @return array          Set of TinyMCE buttons with YTC addition |
  | 1575 |  | \*/ |
  | 1576 |  | function mce\_buttons( $buttons ) { |
  | 1577 |  |  |
  | 1578 |  | $buttons[] = 'youtube\_channel\_shortcode'; |
  | 1579 |  | return $buttons; |
  | 1580 |  |  |
  | 1581 |  | } // END function mce\_buttons() |
  | 1582 |  |  |
  | 1583 |  | function generate\_debug\_json() { |
  | 1584 |  | global $wp\_version; |
  | 1585 |  |  |
  | 1586 |  | // get widget ID from parameter |
  | 1587 |  | $for = trim( $\_GET['ytc\_debug\_json\_for'] ); |
  | 1588 |  |  |
  | 1589 |  | if ( 'global' == $for ) { |
  | 1590 |  | // global settings |
  | 1591 |  | $options = get\_option( 'youtube\_channel\_defaults' ); |
  | 1592 |  |  |
  | 1593 |  | if ( ! is\_array( $options ) ) { |
  | 1594 |  | return; |
  | 1595 |  | } |
  | 1596 |  |  |
  | 1597 |  | // Remove YouTube Data API Key from config JSON |
  | 1598 |  | unset( $options['apikey'] ); |
  | 1599 |  |  |
  | 1600 |  | } else { |
  | 1601 |  | // widget |
  | 1602 |  | $widget\_id = (int) $for; |
  | 1603 |  | $for = "youtube-channel-{$for}"; |
  | 1604 |  |  |
  | 1605 |  | // get YTC widgets options |
  | 1606 |  | $widget\_options = get\_option( 'widget\_youtube-channel' ); |
  | 1607 |  |  |
  | 1608 |  | if ( ! is\_array( $widget\_options[ $widget\_id ] ) ) { |
  | 1609 |  | return; |
  | 1610 |  | } |
  | 1611 |  |  |
  | 1612 |  | $options = $widget\_options[ $widget\_id ]; |
  | 1613 |  | unset( $widget\_options ); |
  | 1614 |  | } |
  | 1615 |  |  |
  | 1616 |  | // prepare debug data with settings of current widget |
  | 1617 |  | $data = array\_merge( |
  | 1618 |  | [ |
  | 1619 |  | 'date'   => date( 'r' ), |
  | 1620 |  | 'server' => $\_SERVER['SERVER\_SOFTWARE'], |
  | 1621 |  | 'php'    => PHP\_VERSION, |
  | 1622 |  | 'wp'     => $wp\_version, |
  | 1623 |  | 'ytc'    => self::VER, |
  | 1624 |  | 'url'    => get\_site\_url(), |
  | 1625 |  | 'for'    => $for, |
  | 1626 |  | ], |
  | 1627 |  | $options |
  | 1628 |  | ); |
  | 1629 |  |  |
  | 1630 |  | // Construct descriptive filename |
  | 1631 |  | $date = date( 'ymdHis' ); |
  | 1632 |  | $json\_filename = "ytc3\_{$\_SERVER['HTTP\_HOST']}\_{$for}\_{$date}.json"; |
  | 1633 |  | // Return JSON file |
  | 1634 |  | header( "Content-disposition: attachment; filename={$json\_filename}" ); |
  | 1635 |  | header( 'Content-Type: application/json' ); |
  | 1636 |  | echo json\_encode( $data ); |
  | 1637 |  |  |
  | 1638 |  | // Destroy vars |
  | 1639 |  | unset( $data, $options, $widget\_id, $option\_name, $for, $date, $json\_filename ); |
  | 1640 |  |  |
  | 1641 |  | // Exit now, because we need only debug data in JSON file, not settings or any other page |
  | 1642 |  | exit; |
  | 1643 |  | } // End function generate\_debug\_json() |
  | 1644 |  |  |
  | 1645 |  | } // End class |
  | 1646 |  | } // End class check |
  |  | 30 | require\_once YTC\_DIR\_INC . '/helper.php'; |
  |  | 31 | require\_once YTC\_DIR\_CLASSES . '/class-wpau-youtube-channel.php'; |
  | 1647 | 32 |  |
  | 1648 | 33 | global $wpau\_youtube\_channel; |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2844200)
* [Zip Archive](?format=zip&new=2844200)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


