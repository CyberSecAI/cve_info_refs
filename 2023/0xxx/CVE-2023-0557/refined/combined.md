=== Content from www.wordfence.com_2d167486_20250115_100438.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# ContentStudio <= 1.2.5 - Information Exposure

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   ContentStudio <= 1.2.5 - Information Exposure

7.5

**Exposure of Sensitive Information to an Unauthorized Actor**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N)

| CVE | [CVE-2023-0557](https://www.cve.org/CVERecord?id=CVE-2023-0557) |
| --- | --- |
| CVSS | 7.5 (High) |
| Publicly Published | January 27, 2023 |
| Last Updated | February 3, 2023 |
| Researcher | [Chloe Chamberland - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/chloe-chamberland) |

### Description

The ContentStudio plugin for WordPress is vulnerable to Sensitive Information Exposure in versions up to, and including, 1.2.5. This could allow unauthenticated attackers to obtain a nonce needed for the creation of posts.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/contentstudio/trunk/contentstudio-plugin.php#L709)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=2851006%40contentstudio%2Ftrunk&old=2844028%40contentstudio%2Ftrunk&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcontentstudio%2Fcontentstudio-125-information-exposure&t=ContentStudio%20%3C%3D%201.2.5%20-%20Information%20Exposure "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcontentstudio%2Fcontentstudio-125-information-exposure&text=ContentStudio%20%3C%3D%201.2.5%20-%20Information%20Exposure "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcontentstudio%2Fcontentstudio-125-information-exposure "LinkedIn")
Email

## Vulnerability Details for ContentStudio

#### [ContentStudio](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/contentstudio)

| Software Type | Plugin |
| --- | --- |
| Software Slug | contentstudio [(view on wordpress.org)](https://wordpress.org/plugins/contentstudio) |
| Patched? | Yes |
| Remediation | Update to version 1.2.6, or a newer patched version |
| Affected Version | * <= 1.2.5 |
| Patched Version | * 1.2.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_43b44205_20250115_100436.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2851006%2540contentstudio%252Ftrunk%26old%3D2844028%2540contentstudio%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2844028/contentstudio/trunk?old=2851006&old_path=%2Fcontentstudio%2Ftrunk)

---

# Changes in [contentstudio/trunk](/browser/contentstudio/trunk?rev=2851006 "Show entry in browser") [[2844028:2851006]](/log/contentstudio/trunk?rev=2851006&stop_rev=2844028 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[contentstudio/trunk](/browser/contentstudio/trunk?rev=2851006)
Files:

7 edited

* [assets/icon-128×128.png](/browser/contentstudio/trunk/assets/icon-128%C3%97128.png?rev=2851005 "Show entry in browser")
  (modified)
  ([previous](/browser/contentstudio/trunk/assets/icon-128%C3%97128.png?rev=2384226 "Show previous version in browser"))
* [assets/icon-256×256.png](/browser/contentstudio/trunk/assets/icon-256%C3%97256.png?rev=2851005 "Show entry in browser")
  (modified)
  ([previous](/browser/contentstudio/trunk/assets/icon-256%C3%97256.png?rev=2384226 "Show previous version in browser"))
* [assets/icon.svg](/browser/contentstudio/trunk/assets/icon.svg?rev=2851005 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [assets/img/logo.png](/browser/contentstudio/trunk/assets/img/logo.png?rev=2851005 "Show entry in browser")
  (modified)
  ([previous](/browser/contentstudio/trunk/assets/img/logo.png?rev=2384226 "Show previous version in browser"))
* [contentstudio-plugin.php](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006 "Show entry in browser")
  (modified)
  ([9 diffs](#file4 "Show differences"))
* [page.php](/browser/contentstudio/trunk/page.php?rev=2851005 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [readme.txt](/browser/contentstudio/trunk/readme.txt?rev=2851006 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [contentstudio/trunk/assets/icon.svg](/changeset/2851005/contentstudio/trunk/assets/icon.svg?old=2384226&old_path=contentstudio%2Ftrunk%2Fassets%2Ficon.svg "Show the [2844028:2851006] differences restricted to contentstudio/trunk/assets/icon.svg")

  | [r2844028](/browser/contentstudio/trunk/assets/icon.svg?rev=2384226#L1 "Show revision 2844028 of this file in browser") | [r2851006](/browser/contentstudio/trunk/assets/icon.svg?rev=2851005#L1 "Show revision 2851006 of this file in browser") |  |
  | --- | --- | --- |
  | 1 |  | <svg id="logo\_icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 255.002 255.001"> |
  | 2 |  | <defs> |
  | 3 |  | <style> |
  | 4 |  | .cls-1 { |
  | 5 |  | fill: #0093f6; |
  | 6 |  | } |
  | 7 |  | </style> |
  | 8 |  | </defs> |
  | 9 |  | <g id="Group\_539" data-name="Group 539" transform="translate(0 0)"> |
  | 10 |  | <path id="Path\_469" data-name="Path 469" class="cls-1" d="M76.942,27.5A30.537,30.537,0,0,0,46.494,57.948V252.053A30.537,30.537,0,0,0,76.942,282.5H271.048A30.537,30.537,0,0,0,301.5,252.053V57.948A30.537,30.537,0,0,0,271.048,27.5ZM174,245.583A90.582,90.582,0,1,1,264.578,155,90.582,90.582,0,0,1,174,245.583Z" transform="translate(-46.494 -27.5)"/> |
  | 11 |  | </g> |
  | 12 |  | <g id="Group\_543" data-name="Group 543" transform="translate(62.109 80.88)"> |
  | 13 |  | <g id="Group\_540" data-name="Group 540" transform="translate(79.876 26.322)"> |
  | 14 |  | <path id="Path\_470" data-name="Path 470" class="cls-1" d="M259.069,225.649c-6.094,8.51-15.885,12.031-21.758,7.824s-5.693-14.61.4-23.12l23.215-32.419c6.094-8.509,15.886-12.03,21.759-7.824s5.693,14.61-.4,23.12Z" transform="translate(-233.021 -168.334)"/> |
  | 15 |  | </g> |
  | 16 |  | <g id="Group\_541" data-name="Group 541" transform="translate(40.187 12.559)"> |
  | 17 |  | <path id="Path\_471" data-name="Path 471" class="cls-1" d="M206.93,207.569c-6.094,8.51-15.885,12.031-21.759,7.825s-5.693-14.61.4-23.12l23.217-32.419c6.093-8.509,15.886-12.031,21.76-7.825s5.694,14.609-.4,23.118Z" transform="translate(-180.881 -150.253)"/> |
  | 18 |  | </g> |
  | 19 |  | <g id="Group\_542" data-name="Group 542"> |
  | 20 |  | <path id="Path\_472" data-name="Path 472" class="cls-1" d="M154.135,191.071c-6.093,8.51-15.885,12.031-21.758,7.823s-5.693-14.611.4-23.121l23.214-32.418c6.093-8.509,15.885-12.03,21.76-7.824s5.694,14.61-.4,23.12Z" transform="translate(-128.087 -133.754)"/> |
  | 21 |  | </g> |
  | 22 |  | </g> |
  |  | 1 | <svg width="255" height="255" viewBox="0 0 255 255" fill="none" xmlns="http://www.w3.org/2000/svg"> |
  |  | 2 | <rect x="255" y="255" width="255" height="255" rx="15" transform="rotate(-180 255 255)" fill="#0068E5"/> |
  |  | 3 | <path d="M36.8335 125.566C36.8335 75.3684 77.5268 34.6752 127.724 34.6752V34.6752C177.922 34.6752 218.615 75.3684 218.615 125.566V129.434C218.615 179.631 177.922 220.325 127.724 220.325V220.325C77.5268 220.325 36.8335 179.631 36.8335 129.434V125.566Z" fill="white"/> |
  |  | 4 | <path d="M144.85 163.146C140.113 159.883 138.962 153.46 142.279 148.8L168.7 111.676C172.017 107.016 178.545 105.884 183.281 109.147C188.018 112.41 189.169 118.832 185.852 123.492L159.431 160.616C156.114 165.276 149.586 166.409 144.85 163.146Z" fill="#0068E5"/> |
  |  | 5 | <path d="M110.223 154.281C105.487 151.018 104.336 144.596 107.652 139.936L134.074 102.812C137.391 98.1517 143.919 97.0192 148.655 100.282C153.391 103.545 154.542 109.967 151.226 114.627L124.804 151.752C121.488 156.411 114.96 157.544 110.223 154.281Z" fill="#0068E5"/> |
  |  | 6 | <path d="M75.5971 145.415C70.8607 142.152 69.7096 135.73 73.0261 131.07L99.4478 93.9458C102.764 89.286 109.292 88.1535 114.029 91.4164C118.765 94.6792 119.916 101.102 116.6 105.762L90.178 142.886C86.8615 147.546 80.3334 148.678 75.5971 145.415Z" fill="#0068E5"/> |
  | 23 | 7 | </svg> |
* ## [contentstudio/trunk/contentstudio-plugin.php](/changeset/2851006/contentstudio/trunk/contentstudio-plugin.php?old=2844028&old_path=contentstudio%2Ftrunk%2Fcontentstudio-plugin.php "Show the [2844028:2851006] differences restricted to contentstudio/trunk/contentstudio-plugin.php")

  | [r2844028](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L3 "Show revision 2844028 of this file in browser") | [r2851006](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L3 "Show revision 2851006 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | Plugin Name: ContentStudio |
  | 4 | 4 | Description: ContentStudio provides you with powerful blogging & social media tools to keep your audience hooked by streamlining the process for you to discover and share engaging content on multiple blogging & social media networks |
  | 5 |  | Version: 1.2.~~5~~ |
  |  | 5 | Version: 1.2.7 |
  | 6 | 6 | Author: ContentStudio |
  | 7 | 7 | Author URI: http://contentstudio.io/ |
  | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L40) | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L40) |  |
  | 40 | 40 | protected $assets = 'https://contentstudio.io/img'; |
  | 41 | 41 |  |
  | 42 |  | private $version = "1.2.~~5~~"; |
  |  | 42 | private $version = "1.2.7"; |
  | 43 | 43 |  |
  | 44 | 44 | protected $contentstudio\_id = ''; |
  | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L109) | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L109) |  |
  | 109 | 109 | $this, |
  | 110 | 110 | 'connection\_page', |
  | 111 |  | ], $this->cstu\_plugin\_assets\_dir . "menu-logo.~~sv~~g", '50.505'); |
  |  | 111 | ], $this->cstu\_plugin\_assets\_dir . "menu-logo.png", '50.505'); |
  | 112 | 112 | // Settings link to the plugin listing page. |
  | 113 | 113 | } |
  | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L414) | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L414) |  |
  | 414 | 414 | { |
  | 415 | 415 | $token = sanitize\_text\_field($token); |
  | 416 |  | if (get\_option('contentstudio\_token') == $token) { |
  |  | 416 | if (get\_option('contentstudio\_token') === $token) { |
  | 417 | 417 | return true; |
  | 418 | 418 | } |
  | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L543) | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L543) |  |
  | 543 | 543 | public function cstu\_get\_metadata() |
  | 544 | 544 | { |
  | 545 |  | if (isset($\_REQUEST['cstu\_get\_metadata']) && ($\_REQUEST['cstu\_get\_metadata'])) { |
  | 546 |  |  |
  | 547 |  | //$token = get\_option('contentstudio\_token'); |
  |  | 545 | if (isset($\_REQUEST['cstu\_get\_metadata'], $\_REQUEST['token'])) { |
  |  | 546 |  |
  |  | 547 | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
  |  | 548 |  |
  |  | 549 | if (!$valid) { |
  |  | 550 | echo json\_encode([ |
  |  | 551 | 'status' => false, |
  |  | 552 | 'message' => self::INVALID\_MESSAGE\_POST\_API, |
  |  | 553 | ]); |
  |  | 554 | die(); |
  |  | 555 | } |
  |  | 556 |  |
  | 548 | 557 |  |
  | 549 | 558 | $varsbloginfo                = array( |
  | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L603) | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L612) |  |
  | 603 | 612 | public function cstu\_get\_blog\_authors() |
  | 604 | 613 | { |
  | 605 |  | if (isset($\_REQUEST['~~token']) && isset($\_REQUEST['authors~~'])) { |
  |  | 614 | if (isset($\_REQUEST['authors'], $\_REQUEST['token'])) { |
  | 606 | 615 | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
  | 607 | 616 | if ($valid) { |
  |  | 617 |  |
  |  | 618 | if (!isset($\_REQUEST['user\_info'])) { |
  |  | 619 | echo json\_encode(['status' => false, 'message' => 'user\_info is required']); |
  |  | 620 | die(); |
  |  | 621 | } |
  |  | 622 | // validate user info |
  |  | 623 | $result = $this->do\_validate\_wp\_user($\_REQUEST['user\_info']); |
  |  | 624 | if ($result['status'] == false) { |
  |  | 625 | echo json\_encode($result); |
  |  | 626 | die(); |
  |  | 627 | } |
  |  | 628 |  |
  |  | 629 |  |
  | 608 | 630 | $authors = get\_users(); |
  | 609 | 631 | $return\_authors = []; |
  | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L631) | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L653) |  |
  | 631 | 653 | public function cstu\_get\_blog\_categories() |
  | 632 | 654 | { |
  | 633 |  | if (isset($\_REQUEST['~~token']) && isset($\_REQUEST['categories~~'])) { |
  |  | 655 | if (isset($\_REQUEST['categories'], $\_REQUEST['token'])) { |
  | 634 | 656 | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
  | 635 | 657 | if ($valid) { |
  |  | 658 |  |
  |  | 659 | if (!isset($\_REQUEST['user\_info'])) { |
  |  | 660 | echo json\_encode(['status' => false, 'message' => 'user\_info is required']); |
  |  | 661 | die(); |
  |  | 662 | } |
  |  | 663 | // validate user info |
  |  | 664 | $result = $this->do\_validate\_wp\_user($\_REQUEST['user\_info']); |
  |  | 665 | if ($result['status'] == false) { |
  |  | 666 | echo json\_encode($result); |
  |  | 667 | die(); |
  |  | 668 | } |
  |  | 669 |  |
  | 636 | 670 | $args = [ |
  | 637 | 671 | "hide\_empty" => 0, |
  | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L712) | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L746) |  |
  | 712 | 746 | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
  | 713 | 747 | if ($valid) { |
  |  | 748 |  |
  |  | 749 | if (!isset($\_REQUEST['user\_info'])) { |
  |  | 750 | echo json\_encode(['status' => false, 'message' => 'user\_info is required']); |
  |  | 751 | die(); |
  |  | 752 | } |
  |  | 753 | // validate user info |
  |  | 754 | $result = $this->do\_validate\_wp\_user($\_REQUEST['user\_info']); |
  |  | 755 | if ($result['status'] == false) { |
  |  | 756 | echo json\_encode($result); |
  |  | 757 | die(); |
  |  | 758 | } |
  |  | 759 |  |
  | 714 | 760 | $nonce = wp\_create\_nonce('cstu\_nonce\_for\_post'); |
  | 715 | 761 | echo json\_encode(['status' => true, 'message' => 'Nonce created successfully', 'nonce' => $nonce]); |
  | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2844028#L1531) | […](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=2851006#L1577) |  |
  | 1531 | 1577 | return new ContentStudio(); |
  | 1532 | 1578 | } |
  | 1533 |  |  |
* ## [contentstudio/trunk/page.php](/changeset/2851005/contentstudio/trunk/page.php?old=2830470&old_path=contentstudio%2Ftrunk%2Fpage.php "Show the [2844028:2851006] differences restricted to contentstudio/trunk/page.php")

  | [r2844028](/browser/contentstudio/trunk/page.php?rev=2830470#L19 "Show revision 2844028 of this file in browser") | [r2851006](/browser/contentstudio/trunk/page.php?rev=2851005#L19 "Show revision 2851006 of this file in browser") |  |
  | --- | --- | --- |
  | 19 | 19 | <div class="contentstudio-plugin-head"> |
  | 20 | 20 | <div class="contentstudio-content-section"> |
  | 21 |  | <img src="<?php cstu\_media\_url(); ?>img/logo.~~sv~~g" width="260" alt="ContentStudio"> |
  |  | 21 | <img src="<?php cstu\_media\_url(); ?>img/logo.png" width="260" alt="ContentStudio"> |
  | 22 | 22 | </div> |
  | 23 | 23 | </div> |
* ## [contentstudio/trunk/readme.txt](/changeset/2851006/contentstudio/trunk/readme.txt?old=2844028&old_path=contentstudio%2Ftrunk%2Freadme.txt "Show the [2844028:2851006] differences restricted to contentstudio/trunk/readme.txt")

  | [r2844028](/browser/contentstudio/trunk/readme.txt?rev=2844028#L5 "Show revision 2844028 of this file in browser") | [r2851006](/browser/contentstudio/trunk/readme.txt?rev=2851006#L5 "Show revision 2851006 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 4.8 |
  | 6 | 6 | Tested up to: 6.1 |
  | 7 |  | Stable tag: 1.2.~~5~~ |
  |  | 7 | Stable tag: 1.2.7 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2851006&old=2844028&new_path=%2Fcontentstudio%2Ftrunk&old_path=%2Fcontentstudio%2Ftrunk)
* [Zip Archive](?format=zip&new=2851006&old=2844028&new_path=%2Fcontentstudio%2Ftrunk&old_path=%2Fcontentstudio%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_bcbfb5cd_20250115_100432.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcontentstudio%2Ftrunk%2Fcontentstudio-plugin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/contentstudio/trunk/contentstudio-plugin.php?rev=3115335 "Revision 3115335")
* Next Revision →
* [Blame](/browser/contentstudio/trunk/contentstudio-plugin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/contentstudio/trunk/contentstudio-plugin.php)

---

# [source:](/browser?order=name "Go to repository root") [contentstudio](/browser/contentstudio?order=name "View contentstudio")/[trunk](/browser/contentstudio/trunk?order=name "View trunk")/[contentstudio-plugin.php](/browser/contentstudio/trunk/contentstudio-plugin.php?order=name "View contentstudio-plugin.php")

View diff against:

View revision:

| [Last change](/changeset/3118035/contentstudio/trunk/contentstudio-plugin.php "View differences") on this file was [3118035](/changeset/3118035/ "View changeset 3118035"), checked in by contentstudio, [6 months ago](/timeline?from=2024-07-15T05%3A57%3A59Z&precision=second "See timeline at 07/15/2024 05:57:59 AM") |
| --- |
| tagging version 1.3.2 |
| **File size:** 70.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | Plugin Name: ContentStudio |
| [4](#L4) | Description: ContentStudio provides you with powerful blogging & social media tools to keep your audience hooked by streamlining the process for you to discover and share engaging content on multiple blogging & social media networks |
| [5](#L5) | Version: 1.3.2 |
| [6](#L6) | Author: ContentStudio |
| [7](#L7) | Author URI: http://contentstudio.io/ |
| [8](#L8) | Plugin URI: http://contentstudio.io/ |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | /\*\* |
| [12](#L12) | \* add the meta SEO title for the web page if the post has SEO title available |
| [13](#L13) | \*/ |
| [14](#L14) | // include\_once(ABSPATH . 'wp-includes/pluggable.php'); |
| [15](#L15) | function cstu\_add\_wpseo\_title() |
| [16](#L16) | { |
| [17](#L17) |  |
| [18](#L18) | global $post; |
| [19](#L19) | if ($post) { |
| [20](#L20) | if (isset($post->ID)) { |
| [21](#L21) | if ($post->post\_type == 'post') { |
| [22](#L22) | $meta\_title = get\_post\_meta($post->ID, 'contentstudio\_wpseo\_title'); |
| [23](#L23) | if(isset($meta\_title[0]) && $meta\_title[0]){ |
| [24](#L24) | return $meta\_title[0]; |
| [25](#L25) | } |
| [26](#L26) | } |
| [27](#L27) | } |
| [28](#L28) | } |
| [29](#L29) | } |
| [30](#L30) |  |
| [31](#L31) | add\_filter('pre\_get\_document\_title', 'cstu\_add\_wpseo\_title'); |
| [32](#L32) |  |
| [33](#L33) | // Check for existing class |
| [34](#L34) | if (! class\_exists('contentstudio')) { |
| [35](#L35) |  |
| [36](#L36) | class ContentStudio |
| [37](#L37) | { |
| [38](#L38) | protected $api\_url = 'https://api-prod.contentstudio.io/'; |
| [39](#L39) |  |
| [40](#L40) | protected $assets = 'https://contentstudio.io/img'; |
| [41](#L41) |  |
| [42](#L42) | private $version = "1.3.2"; |
| [43](#L43) |  |
| [44](#L44) | protected $contentstudio\_id = ''; |
| [45](#L45) |  |
| [46](#L46) | protected $blog\_id = ''; |
| [47](#L47) |  |
| [48](#L48) | public $cstu\_plugin; |
| [49](#L49) |  |
| [50](#L50) | protected $cstu\_plugin\_assets\_dir; |
| [51](#L51) |  |
| [52](#L52) | const INVALID\_MESSAGE = 'Invalid API Key, please make sure you have correct API key added.'; |
| [53](#L53) |  |
| [54](#L54) | const INVALID\_MESSAGE\_POST\_API = 'Invalid API Key, please make sure you have correct API key added.'; |
| [55](#L55) |  |
| [56](#L56) | const UNKNOWN\_ERROR\_MESSAGE = 'An Unknown error occurred while uploading media file.'; |
| [57](#L57) |  |
| [58](#L58) | /\*\* |
| [59](#L59) | \* Add ContentStudio and settings link to the admin menu |
| [60](#L60) | \*/ |
| [61](#L61) | public function \_\_construct() |
| [62](#L62) | { |
| [63](#L63) |  |
| [64](#L64) | $this->cstu\_plugin = plugin\_basename(\_\_FILE\_\_); |
| [65](#L65) |  |
| [66](#L66) | $this->cstu\_plugin\_assets\_dir = plugin\_dir\_url(\_\_FILE\_\_) . "assets/"; |
| [67](#L67) |  |
| [68](#L68) | $this->hooks(); |
| [69](#L69) | register\_activation\_hook(\_\_FILE\_\_, [$this, 'activation']); |
| [70](#L70) | if (is\_admin()) { |
| [71](#L71) | $this->register\_admin\_hooks(); |
| [72](#L72) | } |
| [73](#L73) |  |
| [74](#L74) | // create db table and register webhooks |
| [75](#L75) | $this->create\_cstu\_database\_table(); |
| [76](#L76) | $this->register\_global\_hooks(); |
| [77](#L77) |  |
| [78](#L78) | // register style |
| [79](#L79) |  |
| [80](#L80) | } |
| [81](#L81) |  |
| [82](#L82) |  |
| [83](#L83) |  |
| [84](#L84) | /\*\* |
| [85](#L85) | \* Creaate a database table for the SEO settings |
| [86](#L86) | \*/ |
| [87](#L87) | public function create\_cstu\_database\_table() |
| [88](#L88) | { |
| [89](#L89) | global $wpdb; |
| [90](#L90) | $table\_name = $wpdb->prefix."seo"; |
| [91](#L91) | $sql = "CREATE TABLE $table\_name ( |
| [92](#L92) | id mediumint(9) NOT NULL AUTO\_INCREMENT, |
| [93](#L93) | post\_id mediumint(9) NOT NULL default 0, |
| [94](#L94) | title varchar (100) not NULL, |
| [95](#L95) | description varchar (100) default null, |
| [96](#L96) | slug varchar (100) ,PRIMARY KEY (id));"; |
| [97](#L97) |  |
| [98](#L98) | require\_once(ABSPATH.'wp-admin/includes/upgrade.php'); |
| [99](#L99) | maybe\_create\_table($table\_name, $sql); |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | /\*\* |
| [103](#L103) | \* Add a ContentStudio icon to the menu |
| [104](#L104) | \*/ |
| [105](#L105) | public function add\_menu() |
| [106](#L106) | { |
| [107](#L107) | if(current\_user\_can('editor') || current\_user\_can('administrator')){ |
| [108](#L108) | add\_menu\_page('ContentStudio Publisher', 'ContentStudio', 'edit\_posts', 'contentstudio\_settings', [ |
| [109](#L109) | $this, |
| [110](#L110) | 'connection\_page', |
| [111](#L111) | ], $this->cstu\_plugin\_assets\_dir . "menu-logo.png", '50.505'); |
| [112](#L112) | // Settings link to the plugin listing page. |
| [113](#L113) | } |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | /\*\* |
| [117](#L117) | \* Register global webhooks |
| [118](#L118) | \*/ |
| [119](#L119) | public function register\_global\_hooks() |
| [120](#L120) | { |
| [121](#L121) |  |
| [122](#L122) | add\_action('init', [$this, 'cstu\_verfiy\_wp\_user']); |
| [123](#L123) | add\_action('init', [$this, 'cstu\_check\_token']); |
| [124](#L124) | add\_action('init', [$this, 'cstu\_get\_blog\_authors']); |
| [125](#L125) | add\_action('init', [$this, 'cstu\_get\_blog\_categories']); |
| [126](#L126) | add\_action('init', [$this, 'cstu\_create\_new\_post']); |
| [127](#L127) | add\_action('init', [$this, 'cstu\_update\_post']); |
| [128](#L128) | add\_action('init', [$this, 'cstu\_is\_installed']); |
| [129](#L129) | add\_action('init', [$this, 'cstu\_unset\_token']); |
| [130](#L130) | add\_action('init', [$this, 'cstu\_get\_metadata']); |
| [131](#L131) | add\_action('init', [$this, 'cstu\_create\_nonce\_for\_post']); |
| [132](#L132) | add\_action('init', [$this, 'cstu\_is\_upload\_dir\_exists']); |
| [133](#L133) | add\_action('wp\_head', [$this, 'add\_cstu\_custom\_stylesheet']); |
| [134](#L134) | add\_action('wp\_head', [$this, 'add\_cstu\_meta\_data']); |
| [135](#L135) | add\_action('init', [$this, 'cstu\_change\_post\_status']); |
| [136](#L136) | if (! function\_exists('get\_plugins')) { |
| [137](#L137) | require\_once ABSPATH.'wp-admin/includes/plugin.php'; |
| [138](#L138) | } |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | /\*\* |
| [142](#L142) | \* Add meta SEO title for the users's shared blog posts. |
| [143](#L143) | \*/ |
| [144](#L144) | function add\_cstu\_meta\_data() |
| [145](#L145) | { |
| [146](#L146) | global $post; |
| [147](#L147) | if ($post) { |
| [148](#L148) | if (isset($post->ID)) { |
| [149](#L149) | $meta\_description = get\_post\_meta($post->ID, 'contentstudio\_wpseo\_description'); |
| [150](#L150) | if ($meta\_description) { |
| [151](#L151) | echo '<meta name="description" content="'.esc\_attr($meta\_description[0]).'" />'."\n"; |
| [152](#L152) | } |
| [153](#L153) |  |
| [154](#L154) | //$meta\_title = get\_post\_meta($post->ID, 'contentstudio\_wpseo\_title'); |
| [155](#L155) | //echo '<title>'.$meta\_title[0].'</title>' . "\n"; |
| [156](#L156) |  |
| [157](#L157) | //return $meta\_title[0]; |
| [158](#L158) | } |
| [159](#L159) | } |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) | /\*\* |
| [163](#L163) | \* Adding a custom stylesheet to the WordPress blog, added due to the drag and drop snippet to be shown on the WordPress. |
| [164](#L164) | \*/ |
| [165](#L165) |  |
| [166](#L166) | function add\_cstu\_custom\_stylesheet() |
| [167](#L167) | { |
| [168](#L168) | wp\_register\_style('contentstudio-curation', // handle name |
| [169](#L169) | plugin\_dir\_url(\_\_FILE\_\_).'\_inc/contentstudio\_curation.css', // the URL of the stylesheet |
| [170](#L170) | [], // an array of dependent styles |
| [171](#L171) | '1.0', // version number |
| [172](#L172) | 'screen'); |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | /\*\* |
| [176](#L176) | \* Registers admin-only hooks. |
| [177](#L177) | \*/ |
| [178](#L178) | public function register\_admin\_hooks() |
| [179](#L179) | { |
| [180](#L180) |  |
| [181](#L181) | add\_action('admin\_menu', [$this, 'add\_menu']); |
| [182](#L182) |  |
| [183](#L183) | add\_filter("plugin\_action\_links\_$this->cstu\_plugin", [$this, 'plugin\_settings\_link'], 2, 2); |
| [184](#L184) |  |
| [185](#L185) | // ajax requests |
| [186](#L186) | add\_action('wp\_ajax\_add\_cstu\_api\_key', [$this, 'add\_cstu\_api\_key']); |
| [187](#L187) | add\_action('wp\_ajax\_add\_cstu\_settings', [$this, 'add\_cstu\_settings']); |
| [188](#L188) | // Add check for activation redirection |
| [189](#L189) | add\_action('admin\_init', [$this, 'activation\_redirect']); |
| [190](#L190) | // load resources |
| [191](#L191) |  |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | public function hooks() |
| [195](#L195) | { |
| [196](#L196) |  |
| [197](#L197) | register\_activation\_hook(\_\_FILE\_\_, [$this, 'activation']); |
| [198](#L198) | register\_deactivation\_hook(\_\_FILE\_\_, [$this, 'deactivation']); |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* plugin activation, deactivation and uninstall hooks |
| [203](#L203) | \*/ |
| [204](#L204) | public function activation() |
| [205](#L205) | { |
| [206](#L206) | register\_uninstall\_hook(\_\_FILE\_\_, ['contentstudio', 'uninstall']); |
| [207](#L207) | // Set redirection to true |
| [208](#L208) | add\_option('contentstudio\_redirect', true); |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | /\*\* |
| [212](#L212) | \* on plugin deactivation |
| [213](#L213) | \*/ |
| [214](#L214) | public function deactivation() |
| [215](#L215) | { |
| [216](#L216) | delete\_option('contentstudio\_redirect'); |
| [217](#L217) | delete\_option('contentstudio\_token'); |
| [218](#L218) | delete\_option('contentstudio\_save\_media\_in\_wp'); |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | /\*\* |
| [222](#L222) | \* Find all of the image urls that are in the content description |
| [223](#L223) | \* |
| [224](#L224) | \* @param $content mixed The data of the post |
| [225](#L225) | \* @return array|null result whether it contains images or not |
| [226](#L226) | \*/ |
| [227](#L227) | public function cstu\_find\_all\_images\_urls($content) |
| [228](#L228) | { |
| [229](#L229) | $pattern = '/<img[^>]\*src=["\']([^"\']\*)[^"\']\*["\'][^>]\*>/i'; // find img tags and retrieve src |
| [230](#L230) | preg\_match\_all($pattern, $content, $urls, PREG\_SET\_ORDER); |
| [231](#L231) | if (empty($urls)) { |
| [232](#L232) | return null; |
| [233](#L233) | } |
| [234](#L234) | foreach ($urls as $index => &$url) { |
| [235](#L235) | $images[$index]['alt'] = preg\_match('/<img[^>]\*alt=["\']([^"\']\*)[^"\']\*["\'][^>]\*>/i', $url[0], $alt) ? $alt[1] : null; |
| [236](#L236) | $images[$index]['url'] = $url = $url[1]; |
| [237](#L237) | } |
| [238](#L238) | foreach (array\_unique($urls) as $index => $url) { |
| [239](#L239) | $unique\_array[] = $images[$index]; |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | return $unique\_array; |
| [243](#L243) | } |
| [244](#L244) |  |
| [245](#L245) | /\*\* |
| [246](#L246) | \* |
| [247](#L247) | \* Check whether the plugin yoast is active |
| [248](#L248) | \* |
| [249](#L249) | \* @return bool status of the plugin true if active/false if inactive |
| [250](#L250) | \*/ |
| [251](#L251) |  |
| [252](#L252) | function is\_yoast\_active() |
| [253](#L253) | { |
| [254](#L254) | $active\_plugins = apply\_filters('active\_plugins', get\_option('active\_plugins')); |
| [255](#L255) | foreach ($active\_plugins as $plugin) { |
| [256](#L256) | if (strpos($plugin, 'wp-seo')) { |
| [257](#L257) | return true; |
| [258](#L258) | } |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | return false; |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | /\*\* |
| [265](#L265) | \* |
| [266](#L266) | \* Check whether the All in one SEO plugin is active |
| [267](#L267) | \* |
| [268](#L268) | \* @return bool status of the plugin true if active/false if inactive |
| [269](#L269) | \*/ |
| [270](#L270) |  |
| [271](#L271) | function is\_all\_in\_one\_seo\_active() |
| [272](#L272) | { |
| [273](#L273) |  |
| [274](#L274) | $active\_plugins = apply\_filters('active\_plugins', get\_option('active\_plugins')); |
| [275](#L275) | foreach ($active\_plugins as $plugin) { |
| [276](#L276) | if (strpos($plugin, 'all\_in\_one\_seo\_pack')) { |
| [277](#L277) | return true; |
| [278](#L278) | } |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | return false; |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) | // on plugin removal |
| [285](#L285) | public function uninstall() |
| [286](#L286) | { |
| [287](#L287) | delete\_option('contentstudio\_redirect'); |
| [288](#L288) | delete\_option('contentstudio\_token'); |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | /\*\* |
| [292](#L292) | \* Checks to see if the plugin was just activated to redirect them to settings |
| [293](#L293) | \*/ |
| [294](#L294) | public function activation\_redirect() |
| [295](#L295) | { |
| [296](#L296) |  |
| [297](#L297) |  |
| [298](#L298) | if (get\_option('contentstudio\_redirect', false)) { |
| [299](#L299) | // Redirect to settings page |
| [300](#L300) | if (delete\_option('contentstudio\_redirect')) { |
| [301](#L301) | // If the plugin is being network activated on a multisite install |
| [302](#L302) | if (is\_multisite() && is\_network\_admin()) { |
| [303](#L303) | $redirect\_url = network\_admin\_url('plugins.php'); |
| [304](#L304) | } else { |
| [305](#L305) | $redirect\_url = 'admin.php?page=contentstudio\_settings'; |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | if (wp\_safe\_redirect($redirect\_url)) { |
| [309](#L309) | // NOTE: call to exit after wp\_redirect is per WP Codex doc: |
| [310](#L310) | //       http://codex.wordpress.org/Function\_Reference/wp\_redirect#Usage |
| [311](#L311) | exit; |
| [312](#L312) | } |
| [313](#L313) | } |
| [314](#L314) | } |
| [315](#L315) | } |
| [316](#L316) |  |
| [317](#L317) | // filters plugins section |
| [318](#L318) |  |
| [319](#L319) | public function plugin\_settings\_link($actions, $file) |
| [320](#L320) | { |
| [321](#L321) | if (false !== strpos($file, 'plugin')) { |
| [322](#L322) | $url = "admin.php?page=contentstudio\_settings"; |
| [323](#L323) | $actions['settings'] = '<a href="'.esc\_url($url).'">Settings</a>'; |
| [324](#L324) | } |
| [325](#L325) |  |
| [326](#L326) | return $actions; |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | // ajax section |
| [330](#L330) |  |
| [331](#L331) | public function add\_cstu\_api\_key() |
| [332](#L332) | { |
| [333](#L333) | if (isset($\_POST['data'])) { |
| [334](#L334) |  |
| [335](#L335) | if ($\_POST['data']['security']) { |
| [336](#L336) | $nonce = sanitize\_text\_field($\_POST['data']['security']); |
| [337](#L337) | if (! wp\_verify\_nonce($nonce, 'ajax-nonce')) { |
| [338](#L338) | echo json\_encode(['status' => false, 'message' => 'Invalid security token provided.']); |
| [339](#L339) | die(); |
| [340](#L340) | } |
| [341](#L341) | } |
| [342](#L342) |  |
| [343](#L343) | if (isset($\_POST['data']['key'])) { |
| [344](#L344) | if (strlen($\_POST['data']['key']) == 0) { |
| [345](#L345) | echo json\_encode(['status' => false, 'message' => 'Please enter your API key']); |
| [346](#L346) | die(); |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | $api\_key = sanitize\_text\_field($\_POST['data']['key']); |
| [350](#L350) |  |
| [351](#L351) | $response = json\_decode($this->is\_cstu\_connected($api\_key), true); |
| [352](#L352) | if ($response['status'] == false) { |
| [353](#L353) | echo json\_encode($response); |
| [354](#L354) | die(); |
| [355](#L355) | } |
| [356](#L356) | if ($response['status'] == true) { |
| [357](#L357) | // if successfully verified. |
| [358](#L358) |  |
| [359](#L359) | if (add\_option('contentstudio\_token', $api\_key) == false) { |
| [360](#L360) | update\_option('contentstudio\_token', $api\_key); |
| [361](#L361) | } |
| [362](#L362) |  |
| [363](#L363) | echo json\_encode([ |
| [364](#L364) | 'status' => true, |
| [365](#L365) | 'message' => 'Your blog has been successfully connected with ContentStudio.', |
| [366](#L366) | ]); |
| [367](#L367) | die(); |
| [368](#L368) | } else { |
| [369](#L369) | echo json\_encode(['status' => false, 'message' => self::INVALID\_MESSAGE]); |
| [370](#L370) | die(); |
| [371](#L371) | } |
| [372](#L372) | } else { |
| [373](#L373) | echo json\_encode(['status' => false, 'message' => 'Please enter your API key']); |
| [374](#L374) | die(); |
| [375](#L375) | } |
| [376](#L376) | } else { |
| [377](#L377) | echo json\_encode(['status' => false, 'message' => 'Please enter your API key']); |
| [378](#L378) | die(); |
| [379](#L379) | } |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | public function add\_cstu\_settings() |
| [383](#L383) | { |
| [384](#L384) | if (isset($\_POST['data'])) { |
| [385](#L385) |  |
| [386](#L386) | if ($\_POST['data']['security']) { |
| [387](#L387) | $nonce = sanitize\_text\_field($\_POST['data']['security']); |
| [388](#L388) | if (! wp\_verify\_nonce($nonce, 'ajax-nonce')) { |
| [389](#L389) | echo json\_encode(['status' => false, 'message' => 'Invalid security token provided.']); |
| [390](#L390) | die(); |
| [391](#L391) | } |
| [392](#L392) | } |
| [393](#L393) | // check cs\_save\_in\_wp is set |
| [394](#L394) | if (isset($\_POST['data']['cs\_save\_in\_wp'])) { |
| [395](#L395) |  |
| [396](#L396) | $cs\_save\_in\_wp = rest\_sanitize\_boolean($\_POST['data']['cs\_save\_in\_wp']); |
| [397](#L397) |  |
| [398](#L398) | if (add\_option('contentstudio\_save\_media\_in\_wp', $cs\_save\_in\_wp) == false) { |
| [399](#L399) | update\_option('contentstudio\_save\_media\_in\_wp', $cs\_save\_in\_wp); |
| [400](#L400) | } |
| [401](#L401) |  |
| [402](#L402) | echo json\_encode([ |
| [403](#L403) | 'status' => true, |
| [404](#L404) | 'message' => 'Settings saved successfully.', |
| [405](#L405) | ]); |
| [406](#L406) | die(); |
| [407](#L407) | } else { |
| [408](#L408) | echo json\_encode(['status' => false, 'message' => 'Please select an option.']); |
| [409](#L409) | die(); |
| [410](#L410) | } |
| [411](#L411) | } else { |
| [412](#L412) | echo json\_encode(['status' => false, 'message' => 'Invalid request.']); |
| [413](#L413) | die(); |
| [414](#L414) | } |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) |  |
| [418](#L418) | public function cstu\_is\_installed() |
| [419](#L419) | { |
| [420](#L420) | if (isset($\_REQUEST['cstu\_is\_installed']) && ($\_REQUEST['cstu\_is\_installed'])) { |
| [421](#L421) | $plugin\_data = get\_plugin\_data(\_\_FILE\_\_); |
| [422](#L422) |  |
| [423](#L423) | echo json\_encode([ |
| [424](#L424) | 'status' => true, |
| [425](#L425) | 'message' => 'ContentStudio plugin installed', |
| [426](#L426) | 'version' => $plugin\_data['Version'], |
| [427](#L427) | ]); |
| [428](#L428) | die(); |
| [429](#L429) | } |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | // check token direct ajax request. |
| [433](#L433) | public function cstu\_check\_token() |
| [434](#L434) | { |
| [435](#L435) | if (isset($\_REQUEST['token\_validity']) && isset($\_REQUEST['token'])) { |
| [436](#L436) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [437](#L437) |  |
| [438](#L438) | // server side token validation required. |
| [439](#L439) |  |
| [440](#L440) | if ($valid) { |
| [441](#L441) | echo json\_encode(['status' => true, 'message' => 'Token validated successfully.']); |
| [442](#L442) | die(); |
| [443](#L443) | } else { |
| [444](#L444) | echo json\_encode(['status' => false, 'message' => self::INVALID\_MESSAGE]); |
| [445](#L445) | die(); |
| [446](#L446) | } |
| [447](#L447) | } |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | // validate token from the server to local. |
| [451](#L451) | public function do\_validate\_cstu\_token($token) |
| [452](#L452) | { |
| [453](#L453) | $token = sanitize\_text\_field($token); |
| [454](#L454) | if (get\_option('contentstudio\_token') === $token) { |
| [455](#L455) | return true; |
| [456](#L456) | } |
| [457](#L457) |  |
| [458](#L458) | return false; |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | /\*\* |
| [462](#L462) | \* validate username and password. |
| [463](#L463) | \* |
| [464](#L464) | \*/ |
| [465](#L465) | public function do\_validate\_wp\_user($user\_info) |
| [466](#L466) | { |
| [467](#L467) | $user\_info = explode(":", base64\_decode($user\_info)); |
| [468](#L468) | $user = get\_user\_by('login', $user\_info[0]); |
| [469](#L469) | if ($user && $user->ID != 0) { |
| [470](#L470) | if (wp\_check\_password($user\_info[1], $user->data->user\_pass, $user->ID)) { // validate password |
| [471](#L471) | if ($user->has\_cap('publish\_posts') && $user->has\_cap('edit\_posts')) { |
| [472](#L472) | return ['status' => true, 'message' => 'User validated successfully.']; |
| [473](#L473) | } else { |
| [474](#L474) | $error = "You don't have permission to publish posts."; |
| [475](#L475) | } |
| [476](#L476) | } else { |
| [477](#L477) | $error = "Invalid password."; |
| [478](#L478) | } |
| [479](#L479) | } else { |
| [480](#L480) | $error = "Invalid username."; |
| [481](#L481) | } |
| [482](#L482) | return ['status' => false, 'message' => $error]; |
| [483](#L483) | } |
| [484](#L484) |  |
| [485](#L485) |  |
| [486](#L486) | /\*\* |
| [487](#L487) | \* verify wordpress user and set token |
| [488](#L488) | \*/ |
| [489](#L489) | public function cstu\_verfiy\_wp\_user() |
| [490](#L490) | { |
| [491](#L491) | if (isset($\_REQUEST['cstu\_verfiy\_wp\_user']) && $\_REQUEST['cstu\_verfiy\_wp\_user']) { |
| [492](#L492) | try { |
| [493](#L493) | if (isset($\_REQUEST['username'], $\_REQUEST['password'], $\_REQUEST['token']) && $\_REQUEST['username'] && $\_REQUEST['password'] && $\_REQUEST['token']) { |
| [494](#L494) | $user = get\_user\_by('login', $\_REQUEST['username']); // validate username |
| [495](#L495) | if ($user && $user->ID != 0) { |
| [496](#L496) | if (wp\_check\_password($\_REQUEST['password'], $user->data->user\_pass, $user->ID)) { // validate password |
| [497](#L497) | if ($user->has\_cap('publish\_posts') && $user->has\_cap('edit\_posts')) { |
| [498](#L498) | // set token for later requests validation. |
| [499](#L499) | $token = sanitize\_text\_field($\_REQUEST['token']); |
| [500](#L500) | update\_option('contentstudio\_token', $token); |
| [501](#L501) |  |
| [502](#L502) | echo json\_encode(['status' => true, 'message' => 'User verification completed successfully!']); |
| [503](#L503) | die(); |
| [504](#L504) | } else { |
| [505](#L505) | echo json\_encode(['status' => false, 'message' => "You don't have permissions or the capabilities to publish or edit posts."]); |
| [506](#L506) | die(); |
| [507](#L507) | } |
| [508](#L508) | } else { |
| [509](#L509) | echo json\_encode(['status' => false, 'message' => 'The password that you entered is incorrect.']); |
| [510](#L510) | die(); |
| [511](#L511) | } |
| [512](#L512) | } else { |
| [513](#L513) | echo json\_encode(['status' => false, 'message' => 'No user exists with your provided username.']); |
| [514](#L514) | die(); |
| [515](#L515) | } |
| [516](#L516) | } else { |
| [517](#L517) | echo json\_encode(['status' => false, 'message' => 'Invalid request parameters.']); |
| [518](#L518) | die(); |
| [519](#L519) | } |
| [520](#L520) | } catch (Exception $e) { |
| [521](#L521) | echo json\_encode([ |
| [522](#L522) | 'status' => false, 'message' => self::UNKNOWN\_ERROR\_MESSAGE, |
| [523](#L523) | 'line' => $e->getLine(), 'error\_message' =>  $e->getMessage() |
| [524](#L524) | ]); |
| [525](#L525) | } |
| [526](#L526) | } |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | /\*\* |
| [530](#L530) | \* unset token ajax request |
| [531](#L531) | \*/ |
| [532](#L532) | public function cstu\_unset\_token() |
| [533](#L533) | { |
| [534](#L534) | if (isset($\_REQUEST['cstu\_unset\_token']) && isset($\_REQUEST['token'])) { |
| [535](#L535) |  |
| [536](#L536) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [537](#L537) |  |
| [538](#L538) | if ($valid) { |
| [539](#L539) | delete\_option('contentstudio\_token'); |
| [540](#L540) | echo json\_encode(['status' => true, 'message' => 'Your API key has been removed successfully!']); |
| [541](#L541) | die(); |
| [542](#L542) | } else { |
| [543](#L543) | // TODO: need to brainstorm here. |
| [544](#L544) | echo json\_encode([ |
| [545](#L545) | 'status' => false, |
| [546](#L546) | 'message' => 'API key mismatch, please enter the valid API key.', |
| [547](#L547) | ]); |
| [548](#L548) | die(); |
| [549](#L549) | } |
| [550](#L550) | } |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | /\*\* |
| [554](#L554) | \* Check if the user blog is connected or not, send a remote request to the ContentStudio. |
| [555](#L555) | \* |
| [556](#L556) | \* @param $token string - token to send for the request |
| [557](#L557) | \* @return mixed |
| [558](#L558) | \*/ |
| [559](#L559) | public function is\_cstu\_connected($token) |
| [560](#L560) | { |
| [561](#L561) | $plugin\_data = get\_plugin\_data(\_\_FILE\_\_); |
| [562](#L562) |  |
| [563](#L563) | $payload = [ |
| [564](#L564) | 'body' => [ |
| [565](#L565) | 'token' => $token, |
| [566](#L566) | "name" => get\_bloginfo("name"), |
| [567](#L567) | "description" => get\_bloginfo("description"), |
| [568](#L568) | "wpurl" => get\_bloginfo("wpurl"), |
| [569](#L569) | "url" => get\_bloginfo("url"), |
| [570](#L570) | 'version' => $plugin\_data['Version'], |
| [571](#L571) | ], |
| [572](#L572) | ]; |
| [573](#L573) |  |
| [574](#L574) | return wp\_remote\_post($this->api\_url.'blog/wordpress\_plugin', $payload)['body']; |
| [575](#L575) | } |
| [576](#L576) |  |
| [577](#L577) | /\*\* |
| [578](#L578) | \* Gets blog meta data |
| [579](#L579) | \*/ |
| [580](#L580) |  |
| [581](#L581) | public function cstu\_get\_metadata() |
| [582](#L582) | { |
| [583](#L583) | if (isset($\_REQUEST['cstu\_get\_metadata'], $\_REQUEST['token'])) { |
| [584](#L584) |  |
| [585](#L585) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [586](#L586) |  |
| [587](#L587) | if (!$valid) { |
| [588](#L588) | echo json\_encode([ |
| [589](#L589) | 'status' => false, |
| [590](#L590) | 'message' => self::INVALID\_MESSAGE\_POST\_API, |
| [591](#L591) | ]); |
| [592](#L592) | die(); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) |  |
| [596](#L596) | $varsbloginfo                = array( |
| [597](#L597) | "name"                   => get\_bloginfo( "name" ), |
| [598](#L598) | "description"            => get\_bloginfo( "description" ), |
| [599](#L599) | "wpurl"                  => get\_bloginfo( "wpurl" ), |
| [600](#L600) | "url"                    => get\_bloginfo( "url" ), |
| [601](#L601) | "language"               => get\_bloginfo( "language" ), |
| [602](#L602) | "charset"                => get\_bloginfo( 'charset' ), |
| [603](#L603) | "version"                => get\_bloginfo( "version" ), |
| [604](#L604) | "timezone\_string"        => get\_option( "timezone\_string" ), |
| [605](#L605) | "gmt\_offset"             => get\_option( "gmt\_offset" ), |
| [606](#L606) | "server\_time"            => time(), |
| [607](#L607) | "server\_date"            => date( 'c' ), |
| [608](#L608) | "token"                  => get\_option('contentstudio\_token'), |
| [609](#L609) | //"is\_connected"           => $this->is\_cstu\_connected($token), |
| [610](#L610) | "plugin\_version"         => $this->version, |
| [611](#L611) | "php\_version"            => PHP\_VERSION, |
| [612](#L612) | "php\_disabled\_fn"        => ini\_get( 'disable\_functions' ), |
| [613](#L613) | "php\_disabled\_cl"        => ini\_get( 'disable\_classes' ), |
| [614](#L614) | //"use\_wp\_json\_encode"     => $this->use\_wp\_json\_encode, |
| [615](#L615) | //"first\_transport"        => $http->\_get\_first\_available\_transport( $this->api ), |
| [616](#L616) | // misc blog // |
| [617](#L617) | "site\_url"               => get\_option( 'siteurl' ), |
| [618](#L618) | "pingback\_url"           => get\_bloginfo( "pingback\_url" ), |
| [619](#L619) | "rss2\_url"               => get\_bloginfo( "rss2\_url" ), |
| [620](#L620) | ); |
| [621](#L621) |  |
| [622](#L622) | $varsbloginfo["debug"] = array(); |
| [623](#L623) |  |
| [624](#L624) | $theme                                         = wp\_get\_theme(); |
| [625](#L625) | $varsbloginfo["debug"]["theme"]                = array(); |
| [626](#L626) | $varsbloginfo["debug"]["theme"]["Name"]        = $theme->get( 'Name' ); |
| [627](#L627) | $varsbloginfo["debug"]["theme"]["ThemeURI"]    = $theme->get( 'ThemeURI' ); |
| [628](#L628) | $varsbloginfo["debug"]["theme"]["Description"] = $theme->get( 'Description' ); |
| [629](#L629) | $varsbloginfo["debug"]["theme"]["Author"]      = $theme->get( 'Author' ); |
| [630](#L630) | $varsbloginfo["debug"]["theme"]["AuthorURI"]   = $theme->get( 'AuthorURI' ); |
| [631](#L631) | $varsbloginfo["debug"]["theme"]["Version"]     = $theme->get( 'Version' ); |
| [632](#L632) | $varsbloginfo["debug"]["theme"]["Template"]    = $theme->get( 'Template' ); |
| [633](#L633) | $varsbloginfo["debug"]["theme"]["Status"]      = $theme->get( 'Status' ); |
| [634](#L634) | $varsbloginfo["debug"]["theme"]["Tags"]        = $theme->get( 'Tags' ); |
| [635](#L635) | $varsbloginfo["debug"]["theme"]["TextDomain"]  = $theme->get( 'TextDomain' ); |
| [636](#L636) | $varsbloginfo["debug"]["theme"]["DomainPath"]  = $theme->get( 'DomainPath' ); |
| [637](#L637) |  |
| [638](#L638) | echo json\_encode([ |
| [639](#L639) | 'status' => true, |
| [640](#L640) | 'message' => 'Meta Data Of Blog', |
| [641](#L641) | 'usermetadeata' => $varsbloginfo, |
| [642](#L642) | ]); |
| [643](#L643) | die(); |
| [644](#L644) | } |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | /\*\* |
| [648](#L648) | \* Get a list of blog authors |
| [649](#L649) | \*/ |
| [650](#L650) | public function cstu\_get\_blog\_authors() |
| [651](#L651) | { |
| [652](#L652) | if (isset($\_REQUEST['authors'], $\_REQUEST['token'])) { |
| [653](#L653) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [654](#L654) | if ($valid) { |
| [655](#L655) |  |
| [656](#L656) | if (!isset($\_REQUEST['user\_info'])) { |
| [657](#L657) | echo json\_encode(['status' => false, 'message' => 'user\_info is required']); |
| [658](#L658) | die(); |
| [659](#L659) | } |
| [660](#L660) | // validate user info |
| [661](#L661) | $result = $this->do\_validate\_wp\_user($\_REQUEST['user\_info']); |
| [662](#L662) | if ($result['status'] == false) { |
| [663](#L663) | echo json\_encode($result); |
| [664](#L664) | die(); |
| [665](#L665) | } |
| [666](#L666) |  |
| [667](#L667) |  |
| [668](#L668) | $authors = get\_users(); |
| [669](#L669) | $return\_authors = []; |
| [670](#L670) | foreach ($authors as $author) { |
| [671](#L671) | if (!$author->has\_cap('publish\_posts') || !$author->has\_cap('edit\_posts')) { |
| [672](#L672) | continue; |
| [673](#L673) | } |
| [674](#L674) | $return\_authors[] = [ |
| [675](#L675) | "display\_name" => $author->data->display\_name, |
| [676](#L676) | "user\_id" => $author->ID, |
| [677](#L677) | ]; |
| [678](#L678) | } |
| [679](#L679) | echo json\_encode($return\_authors); |
| [680](#L680) | die(); |
| [681](#L681) | } else { |
| [682](#L682) | echo json\_encode(['status' => false, 'message' => self::INVALID\_MESSAGE]); |
| [683](#L683) | die(); |
| [684](#L684) | } |
| [685](#L685) | } |
| [686](#L686) | } |
| [687](#L687) |  |
| [688](#L688) | /\*\* |
| [689](#L689) | \* Get a list of blog categories |
| [690](#L690) | \*/ |
| [691](#L691) | public function cstu\_get\_blog\_categories() |
| [692](#L692) | { |
| [693](#L693) | if (isset($\_REQUEST['categories'], $\_REQUEST['token'])) { |
| [694](#L694) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [695](#L695) | if ($valid) { |
| [696](#L696) |  |
| [697](#L697) | if (!isset($\_REQUEST['user\_info'])) { |
| [698](#L698) | echo json\_encode(['status' => false, 'message' => 'user\_info is required']); |
| [699](#L699) | die(); |
| [700](#L700) | } |
| [701](#L701) | // validate user info |
| [702](#L702) | $result = $this->do\_validate\_wp\_user($\_REQUEST['user\_info']); |
| [703](#L703) | if ($result['status'] == false) { |
| [704](#L704) | echo json\_encode($result); |
| [705](#L705) | die(); |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) | $args = [ |
| [709](#L709) | "hide\_empty" => 0, |
| [710](#L710) | "type" => "post", |
| [711](#L711) | "orderby" => "name", |
| [712](#L712) | "order" => "ASC", |
| [713](#L713) | ]; |
| [714](#L714) | $categories = get\_categories($args); |
| [715](#L715) | $return\_categories = []; |
| [716](#L716) |  |
| [717](#L717) | foreach ($categories as $category) { |
| [718](#L718) | $return\_categories[] = [ |
| [719](#L719) | "name" => $category->cat\_name, |
| [720](#L720) | "term\_id" => $category->term\_id, |
| [721](#L721) | ]; |
| [722](#L722) | } |
| [723](#L723) | echo json\_encode($return\_categories); |
| [724](#L724) | die(); |
| [725](#L725) | } else { |
| [726](#L726) | echo json\_encode(['status' => false, 'message' => self::INVALID\_MESSAGE]); |
| [727](#L727) | die(); |
| [728](#L728) | } |
| [729](#L729) | } |
| [730](#L730) | } |
| [731](#L731) |  |
| [732](#L732) | /\*\* |
| [733](#L733) | \* Check if the wp-content/upload directory exists for the user blog. |
| [734](#L734) | \* |
| [735](#L735) | \* It is called from the ContentStudio Remote Server. |
| [736](#L736) | \*/ |
| [737](#L737) | public function cstu\_is\_upload\_dir\_exists() |
| [738](#L738) | { |
| [739](#L739) | if (isset($\_REQUEST) && isset($\_REQUEST['cstu\_is\_upload\_dir\_exists']) && isset($\_REQUEST['token'])) { |
| [740](#L740) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [741](#L741) | if ($valid) { |
| [742](#L742) | $base\_dir = wp\_upload\_dir()['basedir']; |
| [743](#L743) | if (! is\_dir($base\_dir)) { |
| [744](#L744) | echo json\_encode([ |
| [745](#L745) | 'status' => true, |
| [746](#L746) | 'message' => 'Your WordPress wp-content/uploads/ directory does not exist. Please create a directory first to enable featured images/media uploads.', |
| [747](#L747) | ]); |
| [748](#L748) | } else { |
| [749](#L749) | echo json\_encode(['status' => false, 'message' => 'Directory already exists.']); |
| [750](#L750) | } |
| [751](#L751) | die(); |
| [752](#L752) | } else { |
| [753](#L753) | echo json\_encode(['status' => false, 'message' => self::INVALID\_MESSAGE]); |
| [754](#L754) | die(); |
| [755](#L755) | } |
| [756](#L756) | } |
| [757](#L757) | } |
| [758](#L758) |  |
| [759](#L759) | /\*\* |
| [760](#L760) | \* @param $post\_id mixed This will check whether the seo data already exists in database |
| [761](#L761) | \* |
| [762](#L762) | \* @return bool true if exists/false if empty |
| [763](#L763) | \*/ |
| [764](#L764) | public function cstu\_seo\_exists($post\_id) |
| [765](#L765) | { |
| [766](#L766) | global $wpdb; |
| [767](#L767) | $sql = $wpdb->prepare("select id from ".$wpdb->prefix."seo where post\_id='%d'", (int) $post\_id); |
| [768](#L768) | $get\_post = $wpdb->get\_results($sql); |
| [769](#L769) | if (count($get\_post)) { |
| [770](#L770) | return true; |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | return false; |
| [774](#L774) | } |
| [775](#L775) |  |
| [776](#L776) | /\*\* |
| [777](#L777) | \* Create a nonce for create and update post. |
| [778](#L778) | \* This nonce will used for create and update post. |
| [779](#L779) | \* |
| [780](#L780) | \*/ |
| [781](#L781) | public function cstu\_create\_nonce\_for\_post() |
| [782](#L782) | { |
| [783](#L783) | if (isset($\_REQUEST) && isset($\_REQUEST['cstu\_create\_nonce\_for\_post'], $\_REQUEST['token'])) { |
| [784](#L784) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [785](#L785) | if ($valid) { |
| [786](#L786) |  |
| [787](#L787) | if (!isset($\_REQUEST['user\_info'])) { |
| [788](#L788) | echo json\_encode(['status' => false, 'message' => 'user\_info is required']); |
| [789](#L789) | die(); |
| [790](#L790) | } |
| [791](#L791) | // validate user info |
| [792](#L792) | $result = $this->do\_validate\_wp\_user($\_REQUEST['user\_info']); |
| [793](#L793) | if ($result['status'] == false) { |
| [794](#L794) | echo json\_encode($result); |
| [795](#L795) | die(); |
| [796](#L796) | } |
| [797](#L797) |  |
| [798](#L798) | $nonce = wp\_create\_nonce('cstu\_nonce\_for\_post'); |
| [799](#L799) | echo json\_encode(['status' => true, 'message' => 'Nonce created successfully', 'nonce' => $nonce]); |
| [800](#L800) | die(); |
| [801](#L801) | } else { |
| [802](#L802) | echo json\_encode(['status' => false, 'message' => self::INVALID\_MESSAGE]); |
| [803](#L803) | die(); |
| [804](#L804) | } |
| [805](#L805) | } |
| [806](#L806) | } |
| [807](#L807) |  |
| [808](#L808) | /\*\* |
| [809](#L809) | \* Create a new WordPress post, action is called from the REMOTE ContentStudio Server. |
| [810](#L810) | \* This action is called from the ContentStudio Remote Server. |
| [811](#L811) | \* Post data is sent from the ContentStudio Remote Server. |
| [812](#L812) | \* Request will be validated using the token (contentstudio\_token) and wordpress nonce. |
| [813](#L813) | \* |
| [814](#L814) | \*/ |
| [815](#L815) | public function cstu\_create\_new\_post() |
| [816](#L816) | { |
| [817](#L817) | if (isset($\_REQUEST) && isset($\_REQUEST['cstu\_create\_new\_post'], $\_REQUEST['token'], $\_REQUEST['nonce'])) { |
| [818](#L818) |  |
| [819](#L819) | // validate the token |
| [820](#L820) |  |
| [821](#L821) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [822](#L822) | if ($valid) { |
| [823](#L823) |  |
| [824](#L824) | // check if the nonce is valid |
| [825](#L825) | if (!wp\_verify\_nonce($\_REQUEST['nonce'], 'cstu\_nonce\_for\_post')) { |
| [826](#L826) | echo json\_encode(['status' => false, 'message' => 'Invalid wordpress nonce', 'invalid\_nonce' => true]); |
| [827](#L827) | die(); |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | if (!isset($\_REQUEST['user\_info'])) { |
| [831](#L831) | echo json\_encode(['status' => false, 'message' => 'user\_info is required']); |
| [832](#L832) | die(); |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | $result = $this->do\_validate\_wp\_user($\_REQUEST['user\_info']); |
| [836](#L836) | if ($result['status'] == false) { |
| [837](#L837) | echo json\_encode($result); |
| [838](#L838) | die(); |
| [839](#L839) | } |
| [840](#L840) |  |
| [841](#L841) | // request post title is available |
| [842](#L842) |  |
| [843](#L843) | if (isset($\_REQUEST['post'])) { |
| [844](#L844) | $post\_title = sanitize\_text\_field($\_REQUEST['post']['post\_title']); |
| [845](#L845) | // check for the post title and make sure it does not exists. |
| [846](#L846) |  |
| [847](#L847) | if (isset($post\_title) && $post\_title) { |
| [848](#L848) | global $wpdb; |
| [849](#L849) | $post\_title = wp\_strip\_all\_tags($post\_title); |
| [850](#L850) | $sql = $wpdb->prepare("select ID from ".$wpdb->posts." where post\_title='%s' AND  post\_status = 'publish'", $post\_title); |
| [851](#L851) | $get\_posts\_list = $wpdb->get\_results($sql); |
| [852](#L852) | if (count($get\_posts\_list)) { |
| [853](#L853) | $cstu\_post\_update = get\_page\_by\_title( $post\_title, '', 'post' ); |
| [854](#L854) | $getid = $cstu\_post\_update->ID; |
| [855](#L855) | echo json\_encode([ |
| [856](#L856) | 'status' => false, |
| [857](#L857) | 'message' => "Post already exists on your blog with title '$getid'.", |
| [858](#L858) | ]); |
| [859](#L859) | die(); |
| [860](#L860) | } |
| [861](#L861) | } |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | // get list of categories |
| [865](#L865) |  |
| [866](#L866) | $categories = explode(',', sanitize\_text\_field($\_REQUEST['post']['post\_category'])); |
| [867](#L867) |  |
| [868](#L868) | $this->kses\_remove\_filters(); |
| [869](#L869) | $post\_id = 0; |
| [870](#L870) | if (isset($\_REQUEST['post']['post\_id']) && $\_REQUEST['post']['post\_id']) { |
| [871](#L871) | $post\_id = (int) sanitize\_text\_field($\_REQUEST['post']['post\_id']); |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | $tags = []; |
| [875](#L875) | if (isset($\_REQUEST['post']['tags'])) |
| [876](#L876) | $tags = explode(',', sanitize\_text\_field($\_REQUEST['post']['tags'])); |
| [877](#L877) |  |
| [878](#L878) | // insert the post |
| [879](#L879) | $post\_author = (int) sanitize\_text\_field($\_REQUEST['post']['post\_author']); |
| [880](#L880) | $post\_content = sanitize\_meta('post\_content', $\_REQUEST['post']['post\_content'], 'post'); |
| [881](#L881) | $post\_status = sanitize\_text\_field($\_REQUEST['post']['post\_status']); |
| [882](#L882) | $post\_title = sanitize\_text\_field($\_REQUEST['post']['post\_title']); |
| [883](#L883) |  |
| [884](#L884) | $post = wp\_insert\_post([ |
| [885](#L885) | 'ID' => $post\_id, |
| [886](#L886) | 'post\_title' => $post\_title, |
| [887](#L887) | 'post\_author' => $post\_author, |
| [888](#L888) | 'post\_content' => $post\_content, |
| [889](#L889) | 'post\_status' => $post\_status, |
| [890](#L890) | 'post\_category' => $categories, |
| [891](#L891) | 'tags\_input' => $tags |
| [892](#L892) | ]); |
| [893](#L893) |  |
| [894](#L894) | if (! $post or $post == 0) { |
| [895](#L895) | $post = wp\_insert\_post([ |
| [896](#L896) | 'post\_author' => $post\_author, |
| [897](#L897) | 'post\_content' => $post\_content, |
| [898](#L898) | 'post\_status' => $post\_status, |
| [899](#L899) | 'post\_category' => $categories, |
| [900](#L900) | 'tags\_input' => $tags |
| [901](#L901) | ]); |
| [902](#L902) | global $wpdb; |
| [903](#L903) | $wpdb->update($wpdb->posts, ['post\_title' => wp\_strip\_all\_tags((string) $post\_title)], ['ID' => $post]); |
| [904](#L904) | // slug scenario |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | // get post |
| [908](#L908) | $get\_post = get\_post($post); |
| [909](#L909) |  |
| [910](#L910) | // set the tags |
| [911](#L911) | if (isset($\_REQUEST['post']['terms'])) $this->cstu\_set\_tags($get\_post); |
| [912](#L912) |  |
| [913](#L913) | // seo settings |
| [914](#L914) | $this->set\_cstu\_metadata\_post($get\_post); |
| [915](#L915) | $this->set\_cstu\_yoast\_settinsg($get\_post); |
| [916](#L916) | $this->set\_cstu\_all\_in\_one\_seo($get\_post); |
| [917](#L917) |  |
| [918](#L918) |  |
| [919](#L919) | $post\_response = [ |
| [920](#L920) | 'post\_id' => $get\_post->ID, |
| [921](#L921) | 'link' => get\_permalink($get\_post->ID), |
| [922](#L922) | 'status' => true, |
| [923](#L923) | 'allow\_url\_fopen' => ini\_get('allow\_url\_fopen') |
| [924](#L924) | ]; |
| [925](#L925) |  |
| [926](#L926) | $this->uploadFeatureImages($post\_response, $\_REQUEST['post']['featured\_image'], $post, $post\_title); |
| [927](#L927) |  |
| [928](#L928) | if(get\_option('contentstudio\_save\_media\_in\_wp', false)) { |
| [929](#L929) | // upload post images if the setting is enabled. |
| [930](#L930) | $post\_response['upload\_images\_response'] = $this->upload\_post\_images($get\_post->ID); |
| [931](#L931) | } |
| [932](#L932) | echo json\_encode($post\_response); |
| [933](#L933) | die(); |
| [934](#L934) |  |
| [935](#L935) | } else { |
| [936](#L936) | echo json\_encode([ |
| [937](#L937) | 'status' => false, |
| [938](#L938) | 'message' => self::INVALID\_MESSAGE\_POST\_API, |
| [939](#L939) | ]); |
| [940](#L940) | die(); |
| [941](#L941) | } |
| [942](#L942) | } |
| [943](#L943) | } |
| [944](#L944) |  |
| [945](#L945) | /\*\* |
| [946](#L946) | \* Upload post images |
| [947](#L947) | \* @param $post\_id mixed The post id |
| [948](#L948) | \* @return array |
| [949](#L949) | \*/ |
| [950](#L950) | private function upload\_post\_images($post\_id) |
| [951](#L951) | { |
| [952](#L952) | try { |
| [953](#L953) | $post = get\_post($post\_id); |
| [954](#L954) | $content = $post->post\_content; |
| [955](#L955) | // Find all image URLs in the post content |
| [956](#L956) | preg\_match\_all('/<img[^>]+src="([^">]+)"/i', $content, $matches); |
| [957](#L957) | $image\_urls = array\_unique($matches[1]); |
| [958](#L958) |  |
| [959](#L959) | if (empty($image\_urls)) { |
| [960](#L960) | return; |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | foreach ($image\_urls as $image\_url) { |
| [964](#L964) | // Download image to server |
| [965](#L965) | $image\_data = wp\_remote\_get($image\_url); |
| [966](#L966) | if (is\_wp\_error($image\_data)) { |
| [967](#L967) | continue; |
| [968](#L968) | } |
| [969](#L969) |  |
| [970](#L970) | $image\_data = wp\_remote\_retrieve\_body($image\_data); |
| [971](#L971) | $filename = basename($image\_url); |
| [972](#L972) | $upload\_dir = wp\_upload\_dir(); |
| [973](#L973) | $file\_path = $upload\_dir['path'] . '/' . $filename; |
| [974](#L974) |  |
| [975](#L975) | file\_put\_contents($file\_path, $image\_data); |
| [976](#L976) |  |
| [977](#L977) | // Check the type of tile. We'll use this as the 'post\_mime\_type'. |
| [978](#L978) | $filetype = wp\_check\_filetype(basename($file\_path), null); |
| [979](#L979) |  |
| [980](#L980) | // Prepare an array of post data for the attachment. |
| [981](#L981) | $attachment = array( |
| [982](#L982) | 'guid'           => $upload\_dir['url'] . '/' . basename($file\_path), |
| [983](#L983) | 'post\_mime\_type' => $filetype['type'], |
| [984](#L984) | 'post\_title'     => sanitize\_file\_name(basename($file\_path)), |
| [985](#L985) | 'post\_content'   => '', |
| [986](#L986) | 'post\_status'    => 'inherit' |
| [987](#L987) | ); |
| [988](#L988) |  |
| [989](#L989) | // Insert the attachment. |
| [990](#L990) | $attach\_id = wp\_insert\_attachment($attachment, $file\_path); |
| [991](#L991) |  |
| [992](#L992) | // Generate the metadata for the attachment, and update the database record. |
| [993](#L993) | require\_once(ABSPATH . 'wp-admin/includes/image.php'); |
| [994](#L994) | $attach\_data = wp\_generate\_attachment\_metadata($attach\_id, $file\_path); |
| [995](#L995) | wp\_update\_attachment\_metadata($attach\_id, $attach\_data); |
| [996](#L996) |  |
| [997](#L997) | // Replace the old image URL with the new image URL |
| [998](#L998) | $new\_image\_url = wp\_get\_attachment\_url($attach\_id); |
| [999](#L999) | $content = str\_replace($image\_url, $new\_image\_url, $content); |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | // Update the post content |
| [1003](#L1003) | $post->post\_content = $content; |
| [1004](#L1004) | wp\_update\_post($post); |
| [1005](#L1005) |  |
| [1006](#L1006) | return [ |
| [1007](#L1007) | 'status' => true, |
| [1008](#L1008) | 'message' => 'Images uploaded successfully.' |
| [1009](#L1009) | ]; |
| [1010](#L1010) | } catch (\Exception $e) { |
| [1011](#L1011) | return [ |
| [1012](#L1012) | 'status' => false, |
| [1013](#L1013) | 'message' => self::UNKNOWN\_ERROR\_MESSAGE, |
| [1014](#L1014) | 'line' => $e->getLine(), |
| [1015](#L1015) | 'error\_message' => $e->getMessage() |
| [1016](#L1016) | ]; |
| [1017](#L1017) | } |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) |  |
| [1021](#L1021) | private function uploadFeatureImages(&$response,$image,$post,$post\_title) { |
| [1022](#L1022) | try { |
| [1023](#L1023) | // reload the post again to get the latest url. |
| [1024](#L1024) | if (isset($image) && $image) { |
| [1025](#L1025) | $image\_data = wp\_remote\_get($image); |
| [1026](#L1026) | if (is\_wp\_error($image\_data)) { |
| [1027](#L1027) | $response['status'] = false; |
| [1028](#L1028) | $response['warning\_message'] = "Unable to download the post featured image."; |
| [1029](#L1029) | } |
| [1030](#L1030) | $status\_code = $image\_data['response']['code'] ?? 0; |
| [1031](#L1031) | // if the status is valid process for upload. |
| [1032](#L1032) | if ($status\_code == 301 || $status\_code == 200) { |
| [1033](#L1033) | $img = $this->cstu\_generate\_image($image, $post,$post\_title); |
| [1034](#L1034) |  |
| [1035](#L1035) | if (!$img['status']) { |
| [1036](#L1036) | $response['status'] = false; |
| [1037](#L1037) | $response['warning\_message'] = $img['message']; |
| [1038](#L1038) | $response['resp'] = $img; |
| [1039](#L1039) | } |
| [1040](#L1040) | } else { |
| [1041](#L1041) | $response['status'] = false; |
| [1042](#L1042) | $response['warning\_message'] = 'Post featured image seems to be down. Image HTTP status code is '.$status\_code; |
| [1043](#L1043) | } |
| [1044](#L1044) | } |
| [1045](#L1045) | } |
| [1046](#L1046) | catch (\Exception $e){ |
| [1047](#L1047) | $response['status'] = false; |
| [1048](#L1048) | $response['message'] = self::UNKNOWN\_ERROR\_MESSAGE; |
| [1049](#L1049) | $response['line'] =  $e->getLine(); |
| [1050](#L1050) | $response['error\_message'] = $e->getMessage(); |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | /\*\* |
| [1056](#L1056) | \* Updates an existing WordPress post, action is called from the REMOTE ContentStudio Server. |
| [1057](#L1057) | \* This action is called from the ContentStudio Remote Server. |
| [1058](#L1058) | \* Post data is sent from the ContentStudio Remote Server. |
| [1059](#L1059) | \* Request will be validated using the token (contentstudio\_token) and wordpress nonce. |
| [1060](#L1060) | \* |
| [1061](#L1061) | \*/ |
| [1062](#L1062) | public function cstu\_update\_post() |
| [1063](#L1063) | { |
| [1064](#L1064) | if (isset($\_REQUEST) && isset($\_REQUEST['cstu\_update\_post'], $\_REQUEST['token'], $\_REQUEST['nonce'])) { |
| [1065](#L1065) |  |
| [1066](#L1066) | // validate the token |
| [1067](#L1067) |  |
| [1068](#L1068) | $valid = $this->do\_validate\_cstu\_token($\_REQUEST['token']); |
| [1069](#L1069) | if ($valid) { |
| [1070](#L1070) |  |
| [1071](#L1071) | // check if the nonce is valid |
| [1072](#L1072) | if (!wp\_verify\_nonce($\_REQUEST['nonce'], 'cstu\_nonce\_for\_post')) { |
| [1073](#L1073) | echo json\_encode(['status' => false, 'message' => 'Invalid wordpress nonce', 'invalid\_nonce' => true]); |
| [1074](#L1074) | die(); |
| [1075](#L1075) | } |
| [1076](#L1076) |  |
| [1077](#L1077) | if (!isset($\_REQUEST['user\_info'])) { |
| [1078](#L1078) | echo json\_encode(['status' => false, 'message' => 'user\_info is required']); |
| [1079](#L1079) | die(); |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | // validate the username and password |
| [1083](#L1083) | $result = $this->do\_validate\_wp\_user($\_REQUEST['user\_info']); |
| [1084](#L1084) | if ($result['status'] == false) { |
| [1085](#L1085) | echo json\_encode($result); |
| [1086](#L1086) | die(); |
| [1087](#L1087) | } |
| [1088](#L1088) |  |
| [1089](#L1089) |  |
| [1090](#L1090) | $categories = explode(',', sanitize\_text\_field($\_REQUEST['post']['post\_category'])); |
| [1091](#L1091) |  |
| [1092](#L1092) | $this->kses\_remove\_filters(); |
| [1093](#L1093) | $post\_id = 0; |
| [1094](#L1094) | if (isset($\_REQUEST['post']['post\_id']) && $\_REQUEST['post']['post\_id']) { |
| [1095](#L1095) | $post\_id = (int) sanitize\_text\_field($\_REQUEST['post']['post\_id']); |
| [1096](#L1096) | } |
| [1097](#L1097) |  |
| [1098](#L1098) | // update the post |
| [1099](#L1099) | $post\_author = (int) sanitize\_text\_field($\_REQUEST['post']['post\_author']); |
| [1100](#L1100) | $post\_content = sanitize\_meta('post\_content', $\_REQUEST['post']['post\_content'], 'post'); |
| [1101](#L1101) | $post\_status = sanitize\_text\_field($\_REQUEST['post']['post\_status']); |
| [1102](#L1102) | $post\_title = sanitize\_text\_field($\_REQUEST['post']['post\_title']); |
| [1103](#L1103) |  |
| [1104](#L1104) | $post = wp\_update\_post([ |
| [1105](#L1105) | 'ID' => $post\_id, |
| [1106](#L1106) | 'post\_title' => $post\_title, |
| [1107](#L1107) | 'post\_author' => $post\_author, |
| [1108](#L1108) | 'post\_content' => $post\_content, |
| [1109](#L1109) | 'post\_status' => $post\_status, |
| [1110](#L1110) | 'post\_category' => $categories, |
| [1111](#L1111) | ]); |
| [1112](#L1112) |  |
| [1113](#L1113) | if (! $post or $post == 0) { |
| [1114](#L1114) | $post = wp\_update\_post([ |
| [1115](#L1115) | 'post\_title' => $post\_title, |
| [1116](#L1116) | 'post\_author' => $post\_author, |
| [1117](#L1117) | 'post\_content' => $post\_content, |
| [1118](#L1118) | 'post\_status' => $post\_status, |
| [1119](#L1119) | 'post\_category' => $categories, |
| [1120](#L1120) | ]); |
| [1121](#L1121) | global $wpdb; |
| [1122](#L1122) | $wpdb->update($wpdb->posts, ['post\_title' => wp\_strip\_all\_tags((string) $post\_title)], ['ID' => $post]); |
| [1123](#L1123) | // slug scenario |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | // get post |
| [1127](#L1127) |  |
| [1128](#L1128) | $get\_post = get\_post($post); |
| [1129](#L1129) |  |
| [1130](#L1130) | // set the tags |
| [1131](#L1131) |  |
| [1132](#L1132) | if (isset($\_REQUEST['post']['terms'])) $this->cstu\_set\_tags($get\_post); |
| [1133](#L1133) |  |
| [1134](#L1134) | // seo settings |
| [1135](#L1135) | $this->set\_cstu\_metadata\_post($get\_post); |
| [1136](#L1136) | $this->set\_cstu\_yoast\_settinsg($get\_post); |
| [1137](#L1137) | $this->set\_cstu\_all\_in\_one\_seo($get\_post); |
| [1138](#L1138) |  |
| [1139](#L1139) | // reload the post again to get the latest url. |
| [1140](#L1140) |  |
| [1141](#L1141) | if (isset($\_REQUEST['post']['featured\_image']) && $\_REQUEST['post']['featured\_image']) { |
| [1142](#L1142) | // perform http request to see the status code of the image. |
| [1143](#L1143) | $status\_code = wp\_remote\_get($\_REQUEST['post']['featured\_image'])['response']['code']; |
| [1144](#L1144) |  |
| [1145](#L1145) | // if the status is valid process for upload. |
| [1146](#L1146) |  |
| [1147](#L1147) | if ($status\_code == 301 || $status\_code == 200) { |
| [1148](#L1148) | $img = $this->cstu\_generate\_image($\_REQUEST['post']['featured\_image'], $post,$\_REQUEST['post']['post\_title']); |
| [1149](#L1149) | if ($img['status']) { |
| [1150](#L1150) | echo json\_encode([ |
| [1151](#L1151) | 'status' => true, |
| [1152](#L1152) | 'post\_id' => $get\_post->ID, |
| [1153](#L1153) | 'link' => get\_permalink($get\_post->ID), |
| [1154](#L1154) | ]); |
| [1155](#L1155) | die(); |
| [1156](#L1156) | } else { |
| [1157](#L1157) | echo json\_encode([ |
| [1158](#L1158) | 'status' => false, |
| [1159](#L1159) | 'warning\_message' => $img['message'], |
| [1160](#L1160) | 'post\_id' => $get\_post->ID, |
| [1161](#L1161) | 'link' => get\_permalink($get\_post->ID), |
| [1162](#L1162) | ]); |
| [1163](#L1163) | die(); |
| [1164](#L1164) | } |
| [1165](#L1165) | } else { |
| [1166](#L1166) | echo json\_encode([ |
| [1167](#L1167) | 'status' => false, |
| [1168](#L1168) | 'warning\_message' => 'Post featured image seems to be down. Image HTTP status code is '.$status\_code, |
| [1169](#L1169) | 'post\_id' => $get\_post->ID, |
| [1170](#L1170) | 'link' => get\_permalink($get\_post->ID)//get\_post\_permalink($get\_post->ID), |
| [1171](#L1171) | ]); |
| [1172](#L1172) | die(); |
| [1173](#L1173) | } |
| [1174](#L1174) | } else { |
| [1175](#L1175) | echo json\_encode([ |
| [1176](#L1176) | 'status' => true, |
| [1177](#L1177) | 'post\_id' => $get\_post->ID, |
| [1178](#L1178) | 'link' => get\_permalink($get\_post->ID), |
| [1179](#L1179) | ]); // get\_post\_permalink($get\_post->ID) |
| [1180](#L1180) | die(); |
| [1181](#L1181) | } |
| [1182](#L1182) | } else { |
| [1183](#L1183) | echo json\_encode([ |
| [1184](#L1184) | 'status' => false, |
| [1185](#L1185) | 'message' => self::INVALID\_MESSAGE\_POST\_API, |
| [1186](#L1186) | ]); |
| [1187](#L1187) | die(); |
| [1188](#L1188) | } |
| [1189](#L1189) | } |
| [1190](#L1190) | /\*else { |
| [1191](#L1191) | echo json\_encode(['status' => false, 'message' => "error"]); |
| [1192](#L1192) | die(); |
| [1193](#L1193) | }\*/ |
| [1194](#L1194) | } |
| [1195](#L1195) |  |
| [1196](#L1196) | /\*\* |
| [1197](#L1197) | \* Set the meta description so that when we publish our content, we show that to the end-user instead of our personal one. |
| [1198](#L1198) | \* |
| [1199](#L1199) | \* @param $get\_post object WordPress post that we retrieved. |
| [1200](#L1200) | \*/ |
| [1201](#L1201) | public function set\_cstu\_metadata\_post($get\_post) |
| [1202](#L1202) | { |
| [1203](#L1203) | try { |
| [1204](#L1204) | // setting up meta description |
| [1205](#L1205) | $meta\_description = null; |
| [1206](#L1206) | if (isset($\_REQUEST['post']['post\_meta\_description'])) { |
| [1207](#L1207) | $meta\_description = sanitize\_text\_field($\_REQUEST['post']['post\_meta\_description']); |
| [1208](#L1208) | } |
| [1209](#L1209) | if ($meta\_description) { |
| [1210](#L1210) | if (! get\_post\_meta($get\_post->ID, 'contentstudio\_wpseo\_description')) { |
| [1211](#L1211) | add\_post\_meta($get\_post->ID, 'contentstudio\_wpseo\_description', $meta\_description, true); |
| [1212](#L1212) | } else { |
| [1213](#L1213) | update\_post\_meta($get\_post->ID, 'contentstudio\_wpseo\_description', $meta\_description); |
| [1214](#L1214) | } |
| [1215](#L1215) | } |
| [1216](#L1216) | $meta\_title = null; |
| [1217](#L1217) | if (isset($\_REQUEST['post']['post\_meta\_title'])) { |
| [1218](#L1218) | $meta\_title = sanitize\_text\_field($\_REQUEST['post']['post\_meta\_title']); |
| [1219](#L1219) | } |
| [1220](#L1220) |  |
| [1221](#L1221) | if ($meta\_title) { |
| [1222](#L1222) | if (! get\_post\_meta($get\_post->ID, 'contentstudio\_wpseo\_title')) { |
| [1223](#L1223) | add\_post\_meta($get\_post->ID, 'contentstudio\_wpseo\_title', $meta\_title, true); |
| [1224](#L1224) | } else { |
| [1225](#L1225) | update\_post\_meta($get\_post->ID, 'contentstudio\_wpseo\_title', $meta\_title); |
| [1226](#L1226) | } |
| [1227](#L1227) | } |
| [1228](#L1228) |  |
| [1229](#L1229) | $slug = null; |
| [1230](#L1230) | if (isset($\_REQUEST['post']['post\_meta\_url'])) { |
| [1231](#L1231) | global $wpdb; |
| [1232](#L1232) |  |
| [1233](#L1233) | $slug = sanitize\_text\_field($\_REQUEST['post']['post\_meta\_url']); |
| [1234](#L1234) | $value = wp\_unique\_post\_slug($slug, $get\_post->ID, $get\_post->post\_status, $get\_post->post\_type, $get\_post->post\_parent); |
| [1235](#L1235) | $slug = $value; |
| [1236](#L1236) |  |
| [1237](#L1237) | wp\_update\_post([ |
| [1238](#L1238) | 'post\_name' => (string) $slug, |
| [1239](#L1239) | 'ID' => $get\_post->ID, |
| [1240](#L1240) | ]); |
| [1241](#L1241) | //$wpdb->update($wpdb->posts, ['post\_name' => (string) $slug], ['ID' => $get\_post->ID]); |
| [1242](#L1242) | } |
| [1243](#L1243) | } |
| [1244](#L1244) | catch (\Exception $e){ |
| [1245](#L1245) |  |
| [1246](#L1246) | } |
| [1247](#L1247) |  |
| [1248](#L1248) | } |
| [1249](#L1249) |  |
| [1250](#L1250) | /\*\* |
| [1251](#L1251) | \* Configure the SEO settings for the YOAST SEO plugin. |
| [1252](#L1252) | \* |
| [1253](#L1253) | \* @param $post object - Post object so that we can get the ID of a POST. |
| [1254](#L1254) | \*/ |
| [1255](#L1255) | public function set\_cstu\_yoast\_settinsg($post) |
| [1256](#L1256) | { |
| [1257](#L1257) | try { |
| [1258](#L1258) | if ($this->is\_yoast\_active()) { |
| [1259](#L1259) | global $wpdb; |
| [1260](#L1260) | $sql = $wpdb->prepare("select object\_id from ".$wpdb->prefix."yoast\_seo\_meta where object\_id='%d'", $post->ID); |
| [1261](#L1261) | $get\_object = $wpdb->get\_results($sql); |
| [1262](#L1262) | if (! count($get\_object)) { |
| [1263](#L1263) | $wpdb->insert($wpdb->prefix."yoast\_seo\_meta", [ |
| [1264](#L1264) | "object\_id" => $post->ID, |
| [1265](#L1265) | "internal\_link\_count" => 0, |
| [1266](#L1266) | "incoming\_link\_count" => 0, |
| [1267](#L1267) | ]); |
| [1268](#L1268) | } |
| [1269](#L1269) | $wpdb->insert($wpdb->postmeta, [ |
| [1270](#L1270) | "post\_id" => $post->ID, |
| [1271](#L1271) | "meta\_key" => "\_yoast\_wpseo\_title", |
| [1272](#L1272) | "meta\_value" => sanitize\_text\_field($\_REQUEST['post']['post\_meta\_title']), |
| [1273](#L1273) | ]); |
| [1274](#L1274) | $wpdb->insert($wpdb->postmeta, [ |
| [1275](#L1275) | "post\_id" => $post->ID, |
| [1276](#L1276) | "meta\_key" => "\_yoast\_wpseo\_metadesc", |
| [1277](#L1277) | "meta\_value" => sanitize\_text\_field($\_REQUEST['post']['post\_meta\_description']), |
| [1278](#L1278) | ]); |
| [1279](#L1279) | } |
| [1280](#L1280) | } |
| [1281](#L1281) | catch (\Exception $e){ |
| [1282](#L1282) |  |
| [1283](#L1283) | } |
| [1284](#L1284) |  |
| [1285](#L1285) | } |
| [1286](#L1286) |  |
| [1287](#L1287) | /\*\* |
| [1288](#L1288) | \* Configure the SEO settings for the All-in-one SEO plugin. |
| [1289](#L1289) | \* |
| [1290](#L1290) | \* @param $post object - Post object so that we can get the ID of a POST. |
| [1291](#L1291) | \*/ |
| [1292](#L1292) | public function set\_cstu\_all\_in\_one\_seo($post) |
| [1293](#L1293) | { |
| [1294](#L1294) | try { |
| [1295](#L1295) | if ($this->is\_all\_in\_one\_seo\_active()) { |
| [1296](#L1296) | global $wpdb; |
| [1297](#L1297) | $wpdb->insert($wpdb->postmeta, [ |
| [1298](#L1298) | "post\_id" => $post->ID, |
| [1299](#L1299) | "meta\_key" => "\_aioseop\_description", |
| [1300](#L1300) | "meta\_value" => sanitize\_text\_field($\_REQUEST['post']['post\_meta\_description']), |
| [1301](#L1301) | ]); |
| [1302](#L1302) | $wpdb->insert($wpdb->postmeta, [ |
| [1303](#L1303) | "post\_id" => $post->ID, |
| [1304](#L1304) | "meta\_key" => "\_aioseop\_title", |
| [1305](#L1305) | "meta\_value" => sanitize\_text\_field($\_REQUEST['post']['post\_meta\_title']), |
| [1306](#L1306) | ]); |
| [1307](#L1307) | $slug = sanitize\_text\_field($\_REQUEST['post']['post\_meta\_url']); |
| [1308](#L1308) | if ($slug) { |
| [1309](#L1309) | $wpdb->insert($wpdb->postmeta, [ |
| [1310](#L1310) | "post\_id" => $post->ID, |
| [1311](#L1311) | "meta\_key" => "\_wp\_old\_slug", |
| [1312](#L1312) | "meta\_value" => $slug, |
| [1313](#L1313) | ]); |
| [1314](#L1314) | } |
| [1315](#L1315) | } |
| [1316](#L1316) | } |
| [1317](#L1317) | catch (\Exception $e){ |
| [1318](#L1318) |  |
| [1319](#L1319) | } |
| [1320](#L1320) |  |
| [1321](#L1321) | } |
| [1322](#L1322) |  |
| [1323](#L1323) | /\*\* |
| [1324](#L1324) | \* Download a featured image and store the web server of the user. |
| [1325](#L1325) | \* |
| [1326](#L1326) | \* @param $image\_url - target url to download |
| [1327](#L1327) | \* @param $post\_id - post id for which it will be attached/ |
| [1328](#L1328) | \* @return array - return of a status true or false with a message. |
| [1329](#L1329) | \*/ |
| [1330](#L1330) | public function cstu\_generate\_image($image\_url, $post\_id, $post\_title) |
| [1331](#L1331) | { |
| [1332](#L1332) |  |
| [1333](#L1333) | try { |
| [1334](#L1334) | //get the upload dir of a website |
| [1335](#L1335) | $upload\_dir = wp\_upload\_dir(); |
| [1336](#L1336) |  |
| [1337](#L1337) | // if there is no upload dir folder made for the user website |
| [1338](#L1338) | if (isset($upload\_dir['error']) && $upload\_dir['error']) return ['status' => false, 'message' => $upload\_dir['error']]; |
| [1339](#L1339) |  |
| [1340](#L1340) | // check allow\_url\_fopen is disable or enable |
| [1341](#L1341) | if ( !ini\_get('allow\_url\_fopen') ) return ['status' => false, 'message' => 'allow\_url\_fopen is disable from PHP Configuration.']; |
| [1342](#L1342) |  |
| [1343](#L1343) | // check if the url contains query params or arguments, remove those. |
| [1344](#L1344) | if(strpos($image\_url, '?') !== false)   $image\_url = substr($image\_url, 0, strpos($image\_url, '?')); |
| [1345](#L1345) | if(strpos($image\_url, '#') !== false)   $image\_url = substr($image\_url, 0, strpos($image\_url, '#')); |
| [1346](#L1346) | $image\_data = file\_get\_contents($image\_url); |
| [1347](#L1347) |  |
| [1348](#L1348) | // if the url contains the amazon url. download the image and get its mimetype |
| [1349](#L1349) | if (strpos($image\_url, 'contentstudioio.s3.amazonaws.com') !== false) { |
| [1350](#L1350) |  |
| [1351](#L1351) | $filename = basename($image\_url); |
| [1352](#L1352) | $img\_headers = wp\_remote\_get($image\_url); |
| [1353](#L1353) | // check content type and assign a type of image to the filename. |
| [1354](#L1354) | switch ($img\_headers['headers']['content-type']){ |
| [1355](#L1355) | case 'image/png': |
| [1356](#L1356) | $filename .= '.png'; |
| [1357](#L1357) | break; |
| [1358](#L1358) | case 'image/jpg': |
| [1359](#L1359) | case 'image/jpeg': |
| [1360](#L1360) | $filename .= '.jpg'; |
| [1361](#L1361) | break; |
| [1362](#L1362) | case 'image/gif': |
| [1363](#L1363) | $filename .= '.gif'; |
| [1364](#L1364) | break; |
| [1365](#L1365) | } |
| [1366](#L1366) | } |
| [1367](#L1367) | // if it is ytimg link, get the correct id by splitting it. |
| [1368](#L1368) | elseif (strpos($image\_url, 'ytimg.com') !== false) $filename = explode('/', $image\_url)[4].'\_'.basename($image\_url); |
| [1369](#L1369) | else $filename = basename($image\_url); |
| [1370](#L1370) |  |
| [1371](#L1371) | $modified\_filename = sanitize\_file\_name($post\_title); |
| [1372](#L1372) | if(strpos($filename, '.') === false){ |
| [1373](#L1373) | $filename = $modified\_filename . '.png'; |
| [1374](#L1374) | } else{ |
| [1375](#L1375) | $filename =  $modified\_filename .  substr($filename, strrpos($filename, '.')); |
| [1376](#L1376) | } |
| [1377](#L1377) |  |
| [1378](#L1378) | // create a file with its name |
| [1379](#L1379) | if (wp\_mkdir\_p($upload\_dir['path'])) $file = $upload\_dir['path'].'/'.$filename; |
| [1380](#L1380) | else $file = $upload\_dir['basedir'].'/'.$filename; |
| [1381](#L1381) |  |
| [1382](#L1382) |  |
| [1383](#L1383) | // put the content |
| [1384](#L1384) | $resp = file\_put\_contents($file, $image\_data); |
| [1385](#L1385) | $wp\_filetype = wp\_check\_filetype($filename, null); |
| [1386](#L1386) |  |
| [1387](#L1387) | // prepare attachment payload |
| [1388](#L1388) | $attachment = [ |
| [1389](#L1389) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [1390](#L1390) | 'post\_title' => $filename, |
| [1391](#L1391) | 'post\_content' => '', |
| [1392](#L1392) | 'post\_status' => 'inherit', |
| [1393](#L1393) | ]; |
| [1394](#L1394) | $attach\_id = wp\_insert\_attachment($attachment, $file, $post\_id); |
| [1395](#L1395) |  |
| [1396](#L1396) | // store the image and set it for the post |
| [1397](#L1397) |  |
| [1398](#L1398) | require\_once(ABSPATH.'wp-admin/includes/image.php'); |
| [1399](#L1399) | $attach\_data = wp\_generate\_attachment\_metadata($attach\_id, $file); |
| [1400](#L1400) | $res1 = wp\_update\_attachment\_metadata($attach\_id, $attach\_data); |
| [1401](#L1401) | $res2 = set\_post\_thumbnail($post\_id, $attach\_id); |
| [1402](#L1402) | update\_post\_meta($attach\_id, '\_wp\_attachment\_image\_alt', $post\_title); |
| [1403](#L1403) | if ($res2) { |
| [1404](#L1404) | return ['status' => true]; |
| [1405](#L1405) | } else { |
| [1406](#L1406) | return ['status' => false, 'message' => self::UNKNOWN\_ERROR\_MESSAGE]; |
| [1407](#L1407) | } |
| [1408](#L1408) | } |
| [1409](#L1409) | catch (\Exception $e){ |
| [1410](#L1410) | return ['status' => false, 'message' => self::UNKNOWN\_ERROR\_MESSAGE, |
| [1411](#L1411) | 'line'=>$e->getLine(), 'error\_message' =>  $e->getMessage()]; |
| [1412](#L1412) | } |
| [1413](#L1413) |  |
| [1414](#L1414) | } |
| [1415](#L1415) |  |
| [1416](#L1416) | /\*\* |
| [1417](#L1417) | \* Render a ContentStudio plugin page. |
| [1418](#L1418) | \*/ |
| [1419](#L1419) | public function connection\_page() |
| [1420](#L1420) | { |
| [1421](#L1421) | if (! current\_user\_can('edit\_posts')) { |
| [1422](#L1422) | wp\_die(\_\_('You do not have sufficient permissions to access this page.')); |
| [1423](#L1423) | } |
| [1424](#L1424) |  |
| [1425](#L1425) | $token = get\_option('contentstudio\_token'); |
| [1426](#L1426) | //$response =  ['status'=>true];  //NOTE: for locally testing... |
| [1427](#L1427) | $response = json\_decode($this->is\_cstu\_connected($token), true); |
| [1428](#L1428) |  |
| [1429](#L1429) | $response['save\_media\_in\_wp'] = get\_option('contentstudio\_save\_media\_in\_wp'); |
| [1430](#L1430) | $response['reconnect'] = false; |
| [1431](#L1431) |  |
| [1432](#L1432) | if (isset($\_GET['reconnect']) && $\_GET['reconnect'] == 'true') { |
| [1433](#L1433) | $response['reconnect'] = true; |
| [1434](#L1434) | } |
| [1435](#L1435) |  |
| [1436](#L1436) | $response['security\_plugins'] = $this->cstu\_check\_installed\_security\_plugins(); |
| [1437](#L1437) | // Save the data to the error log so you can see what the array format is like. |
| [1438](#L1438) |  |
| [1439](#L1439) | $this->load\_resources(); |
| [1440](#L1440) |  |
| [1441](#L1441) | include(sprintf("%s/page.php", dirname(\_\_FILE\_\_))); |
| [1442](#L1442) | } |
| [1443](#L1443) |  |
| [1444](#L1444) | /\*\* |
| [1445](#L1445) | \* Analyzing the security plugins that the user may have installed, and giving them a headsup to |
| [1446](#L1446) | \* whitelist our server's IP address so that there are no problems while authentication being done |
| [1447](#L1447) | \* with ContentStudio. |
| [1448](#L1448) | \* |
| [1449](#L1449) | \* NOTE: we are not modifying anything to these plugins, just checking their status wether they have been |
| [1450](#L1450) | \* activated, if activated, show a notification to the user. |
| [1451](#L1451) | \* |
| [1452](#L1452) | \* @return array - returns list of an array that is used for displaying the name of the plugins. |
| [1453](#L1453) | \*/ |
| [1454](#L1454) | function cstu\_check\_installed\_security\_plugins() |
| [1455](#L1455) | { |
| [1456](#L1456) | $activated\_plugins = get\_option('active\_plugins'); |
| [1457](#L1457) | $response = [ |
| [1458](#L1458) | 'wordfence' => $this->is\_plugin\_activated($activated\_plugins, 'wordfence/wordfence.php'), |
| [1459](#L1459) | 'jetpack' => $this->is\_plugin\_activated($activated\_plugins, 'jetpack/jetpack.php'), |
| [1460](#L1460) | '6scan' => $this->is\_plugin\_activated($activated\_plugins, '6scan-protection/6scan.php'), |
| [1461](#L1461) | 'wp\_security\_scan' => $this->is\_plugin\_activated($activated\_plugins, 'wp-security-scan/index.php'), |
| [1462](#L1462) | 'wp\_all\_in\_one\_wp\_security' => $this->is\_plugin\_activated($activated\_plugins, 'all-in-one-wp-security-and-firewall/wp-security.php'), |
| [1463](#L1463) | 'bulletproof\_security' => $this->is\_plugin\_activated($activated\_plugins, 'bulletproof-security/bulletproof-security.php'), |
| [1464](#L1464) | 'better\_wp\_security' => $this->is\_plugin\_activated($activated\_plugins, 'better-wp-security/better-wp-security.php'), |
| [1465](#L1465) | 'limit\_login\_attempts\_reloaded' => $this->is\_plugin\_activated($activated\_plugins, 'limit-login-attempts-reloaded/limit-login-attempts-reloaded.php'), |
| [1466](#L1466) | 'limit\_login\_attempts' => $this->is\_plugin\_activated($activated\_plugins, 'limit-login-attempts/limit-login-attempts.php'), |
| [1467](#L1467) | 'lockdown\_wp\_admin' => $this->is\_plugin\_activated($activated\_plugins, 'lockdown-wp-admin/lockdown-wp-admin.php'), |
| [1468](#L1468) | 'miniorange\_limit\_login\_attempts' => $this->is\_plugin\_activated($activated\_plugins, 'miniorange-limit-login-attempts/mo\_limit\_login\_widget.php'), |
| [1469](#L1469) | 'wp\_cerber' => $this->is\_plugin\_activated($activated\_plugins, 'wp-cerber/wp-cerber.php'), |
| [1470](#L1470) | 'wp\_limit\_login\_attempts' => $this->is\_plugin\_activated($activated\_plugins, 'wp-limit-login-attempts/wp-limit-login-attempts.php'), |
| [1471](#L1471) | 'sucuri\_scanner' => $this->is\_plugin\_activated($activated\_plugins, 'sucuri-scanner/sucuri.php'), |
| [1472](#L1472) | //                'limit\_login\_attempts\_reloaded' => $this->is\_plugin\_activated($all\_plugins, 'limit-login-attempts-reloaded/limit-login-attempts-reloaded.php'), |
| [1473](#L1473) | ]; |
| [1474](#L1474) |  |
| [1475](#L1475) | return $response; |
| [1476](#L1476) | } |
| [1477](#L1477) |  |
| [1478](#L1478) | /\*\* |
| [1479](#L1479) | \* Check if the value of the plugin name is found in the list of plugins that have been activated by the user. |
| [1480](#L1480) | \* |
| [1481](#L1481) | \* @param $plugins\_list - list of activated plugins by the user |
| [1482](#L1482) | \* @param $file\_name - name of the file for the plugin |
| [1483](#L1483) | \* @return bool |
| [1484](#L1484) | \*/ |
| [1485](#L1485) | function is\_plugin\_activated($plugins\_list, $file\_name) |
| [1486](#L1486) | { |
| [1487](#L1487) | if (in\_array($file\_name, $plugins\_list)) { |
| [1488](#L1488) | return true; |
| [1489](#L1489) | } |
| [1490](#L1490) |  |
| [1491](#L1491) | return false; |
| [1492](#L1492) | } |
| [1493](#L1493) |  |
| [1494](#L1494) | /\*\* |
| [1495](#L1495) | \* Load the style |
| [1496](#L1496) | \*/ |
| [1497](#L1497) | function load\_resources() |
| [1498](#L1498) | { |
| [1499](#L1499) | wp\_enqueue\_style('contentstudio.css', plugin\_dir\_url(\_\_FILE\_\_).'\_inc/contentstudio.css', [], 0.01, false); |
| [1500](#L1500) | wp\_enqueue\_style('contentstudio\_curation.css', plugin\_dir\_url(\_\_FILE\_\_).'\_inc/contentstudio\_curation.css', [], 0.01, false); |
| [1501](#L1501) | wp\_enqueue\_script('notify.min.js', plugin\_dir\_url(\_\_FILE\_\_).'\_inc/notify.min.js', ['jquery'], 0.01, false); |
| [1502](#L1502) | wp\_enqueue\_script('helper.js', plugin\_dir\_url(\_\_FILE\_\_).'\_inc/helper.js', ['jquery'], 0.01, false); |
| [1503](#L1503) | wp\_localize\_script('helper.js', 'ajax\_object', [ |
| [1504](#L1504) | 'ajax\_url' => admin\_url('admin-ajax.php'), |
| [1505](#L1505) | 'security' => wp\_create\_nonce('add\_cstu\_api\_key'), |
| [1506](#L1506) | ]); |
| [1507](#L1507) | } |
| [1508](#L1508) |  |
| [1509](#L1509) | /\*\* |
| [1510](#L1510) | \* Prepare a payload for the request. |
| [1511](#L1511) | \* |
| [1512](#L1512) | \* @param $url - fully qualified URL to target |
| [1513](#L1513) | \* @param $body - payload to send to the request. |
| [1514](#L1514) | \* @return mixed |
| [1515](#L1515) | \*/ |
| [1516](#L1516) | public function prepare\_request($url, $body) |
| [1517](#L1517) | { |
| [1518](#L1518) | $params = [ |
| [1519](#L1519) | 'method' => 'POST', |
| [1520](#L1520) | 'body' => $this->array\_decode\_entities($body), |
| [1521](#L1521) | ]; |
| [1522](#L1522) |  |
| [1523](#L1523) | return $this->perform\_request($this->api\_url.$url, $params); |
| [1524](#L1524) | } |
| [1525](#L1525) |  |
| [1526](#L1526) | /\*\* |
| [1527](#L1527) | \* Provide a layer of compatibility by detecting and retrying after an initial error state.  All attempts to |
| [1528](#L1528) | \* access external resources should use this function. |
| [1529](#L1529) | \* |
| [1530](#L1530) | \* @param $url - fully qualified URL to target |
| [1531](#L1531) | \* @param null $params - optional used in cases where caller wishes to POST |
| [1532](#L1532) | \* |
| [1533](#L1533) | \* @return mixed - result of $http->request(...) call or WP\_Error instance |
| [1534](#L1534) | \*/ |
| [1535](#L1535) | public function perform\_request($url, $params = null) |
| [1536](#L1536) | { |
| [1537](#L1537) | $http = new WP\_Http; |
| [1538](#L1538) |  |
| [1539](#L1539) | $out = $this->perform\_http\_request($http, $url, false, $params); |
| [1540](#L1540) |  |
| [1541](#L1541) | if (is\_wp\_error($out)) { |
| [1542](#L1542) | $out = $this->perform\_http\_request($http, $url, true, $params); |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | return $out; |
| [1546](#L1546) | } |
| [1547](#L1547) |  |
| [1548](#L1548) | /\*\* |
| [1549](#L1549) | \* @param $http - instance of an HTTP client, providing a `request` function |
| [1550](#L1550) | \* @param $url - fully qualified URL to target |
| [1551](#L1551) | \* @param bool|false $skip\_ssl\_verify - if true, will install filters that should prevent SSL cert validation |
| [1552](#L1552) | \* for next request |
| [1553](#L1553) | \* @param null $params - optional used in cases where caller wishes to POST |
| [1554](#L1554) | \* |
| [1555](#L1555) | \* @return mixed - result of $http->request(...) call or WP\_Error instance |
| [1556](#L1556) | \*/ |
| [1557](#L1557) | public function perform\_http\_request($http, $url, $skip\_ssl\_verify = false, $params = null) |
| [1558](#L1558) | { |
| [1559](#L1559) |  |
| [1560](#L1560) | if (isset($skip\_ssl\_verify) && (true === $skip\_ssl\_verify)) { |
| [1561](#L1561) | // For the CURL SSL verifying, some websites does not have the valid SSL certificates. |
| [1562](#L1562) | add\_filter('https\_ssl\_verify', '\_\_return\_false'); |
| [1563](#L1563) | add\_filter('https\_local\_ssl\_verify', '\_\_return\_false'); |
| [1564](#L1564) | } |
| [1565](#L1565) |  |
| [1566](#L1566) | if (isset($params)) { |
| [1567](#L1567) | /\*\* @noinspection PhpUndefinedMethodInspection \*/ |
| [1568](#L1568) | return $http->request($url, $params); |
| [1569](#L1569) | } else { |
| [1570](#L1570) | /\*\* @noinspection PhpUndefinedMethodInspection \*/ |
| [1571](#L1571) | return $http->request($url); |
| [1572](#L1572) | } |
| [1573](#L1573) | } |
| [1574](#L1574) |  |
| [1575](#L1575) | /\*\* |
| [1576](#L1576) | \* Decode entities from the array |
| [1577](#L1577) | \* |
| [1578](#L1578) | \* @param $array |
| [1579](#L1579) | \* @return array |
| [1580](#L1580) | \*/ |
| [1581](#L1581) |  |
| [1582](#L1582) | public function array\_decode\_entities($array) |
| [1583](#L1583) | { |
| [1584](#L1584) | $new\_array = []; |
| [1585](#L1585) |  |
| [1586](#L1586) | foreach ($array as $key => $string) { |
| [1587](#L1587) | if (is\_string($string)) { |
| [1588](#L1588) | $new\_array[$key] = html\_entity\_decode($string, ENT\_QUOTES); |
| [1589](#L1589) | } else { |
| [1590](#L1590) | $new\_array[$key] = $string; |
| [1591](#L1591) | } |
| [1592](#L1592) | } |
| [1593](#L1593) |  |
| [1594](#L1594) | return $new\_array; |
| [1595](#L1595) | } |
| [1596](#L1596) |  |
| [1597](#L1597) | /\*\* |
| [1598](#L1598) | \* @param string $param |
| [1599](#L1599) | \*/ |
| [1600](#L1600) | public function sanitize(&$param = '') |
| [1601](#L1601) | { |
| [1602](#L1602) | if (is\_string($param)) { |
| [1603](#L1603) | $param = esc\_sql($param); |
| [1604](#L1604) | $param = esc\_html($param); |
| [1605](#L1605) | } |
| [1606](#L1606) | } |
| [1607](#L1607) |  |
| [1608](#L1608) | /\*\* |
| [1609](#L1609) | \* Remove the filters before altering the post. |
| [1610](#L1610) | \*/ |
| [1611](#L1611) | function kses\_remove\_filters() |
| [1612](#L1612) | { |
| [1613](#L1613) | // Post filtering |
| [1614](#L1614) | remove\_filter('content\_save\_pre', 'wp\_filter\_post\_kses'); |
| [1615](#L1615) | remove\_filter('excerpt\_save\_pre', 'wp\_filter\_post\_kses'); |
| [1616](#L1616) | remove\_filter('content\_filtered\_save\_pre', 'wp\_filter\_post\_kses'); |
| [1617](#L1617) | } |
| [1618](#L1618) |  |
| [1619](#L1619) | /\*\* |
| [1620](#L1620) | \* change status of the post from the draft to publish or publish to draft. |
| [1621](#L1621) | \*/ |
| [1622](#L1622) |  |
| [1623](#L1623) | public function cstu\_change\_post\_status() |
| [1624](#L1624) | { |
| [1625](#L1625) | if (isset($\_REQUEST) && isset($\_REQUEST['cstu\_change\_post\_status'])) { |
| [1626](#L1626) | $post\_id = (int) sanitize\_text\_field($\_REQUEST['post']['id']); |
| [1627](#L1627) | $status = sanitize\_text\_field($\_REQUEST['post']['status']); |
| [1628](#L1628) | global $wpdb; |
| [1629](#L1629) | $sql = $wpdb->prepare("select post\_status from ".$wpdb->posts." where ID = '%d'", $post\_id); |
| [1630](#L1630) | $post\_status = $wpdb->get\_results($sql)[0]->post\_status; |
| [1631](#L1631) | if ($post\_status == $status) { |
| [1632](#L1632) | echo json\_encode(['status' => false, 'message' => "Your post status is already $post\_status"]); |
| [1633](#L1633) | die(); |
| [1634](#L1634) | } |
| [1635](#L1635) | $result = $wpdb->update($wpdb->posts, ["post\_status" => $status], ["ID" => $post\_id]); |
| [1636](#L1636) | if ($result) { |
| [1637](#L1637) | echo json\_encode(['status' => true, 'message' => 'Your post status has been updated']); |
| [1638](#L1638) | die(); |
| [1639](#L1639) | } |
| [1640](#L1640) | } |
| [1641](#L1641) | } |
| [1642](#L1642) |  |
| [1643](#L1643) | /\*\* |
| [1644](#L1644) | \* |
| [1645](#L1645) | \* Assign a post with the tags that the user may have assigned. |
| [1646](#L1646) | \* |
| [1647](#L1647) | \* @param $get\_post mixed The post object to which the tags are to be assigned |
| [1648](#L1648) | \*/ |
| [1649](#L1649) |  |
| [1650](#L1650) | public function cstu\_set\_tags($get\_post) |
| [1651](#L1651) | { |
| [1652](#L1652) | try { |
| [1653](#L1653) | global $wpdb; |
| [1654](#L1654) | $post\_tags = sanitize\_text\_field($\_REQUEST['post']['terms']); |
| [1655](#L1655) | if (! is\_array($post\_tags)) { |
| [1656](#L1656) | $post\_tags = explode(",", $post\_tags); |
| [1657](#L1657) | } |
| [1658](#L1658) | $terms = []; |
| [1659](#L1659) | foreach ($post\_tags as $tag) { |
| [1660](#L1660) | $term = term\_exists($tag); |
| [1661](#L1661) | if ($term) { |
| [1662](#L1662) |  |
| [1663](#L1663) | $sql = $wpdb->prepare("select term\_taxonomy\_id from ".$wpdb->term\_taxonomy." where term\_id='%s'", $term); |
| [1664](#L1664) | $result = $wpdb->get\_results($sql); |
| [1665](#L1665) | $term\_taxonomy\_id = $result[0]->term\_taxonomy\_id; |
| [1666](#L1666) | $wpdb->query("UPDATE ".$wpdb->term\_taxonomy." SET count = count + 1 where term\_id=".$term); |
| [1667](#L1667) | $terms[] = $term\_taxonomy\_id; |
| [1668](#L1668) | } else { |
| [1669](#L1669) | if ($\_REQUEST['post']['post\_status'] == 'publish') { |
| [1670](#L1670) | $new\_term = wp\_insert\_term($tag, "category"); |
| [1671](#L1671) | $wpdb->query("UPDATE ".$wpdb->term\_taxonomy." SET count = count + 1 where term\_id=".$new\_term["term\_id"]); |
| [1672](#L1672) | $terms[] = $new\_term["term\_taxonomy\_id"]; |
| [1673](#L1673) | } else { |
| [1674](#L1674) | $new\_term = wp\_insert\_term($tag, "post\_tag"); |
| [1675](#L1675) | $wpdb->query("UPDATE ".$wpdb->term\_taxonomy." SET count = count + 1 where term\_id=".$new\_term["term\_id"]); |
| [1676](#L1676) | $terms[] = $new\_term["term\_taxonomy\_id"]; |
| [1677](#L1677) | } |
| [1678](#L1678) | } |
| [1679](#L1679) | } |
| [1680](#L1680) | foreach ($terms as $term) { |
| [1681](#L1681) | $data = [$get\_post->ID, $term]; |
| [1682](#L1682) | global $wpdb; |
| [1683](#L1683) | $post\_query = $wpdb->prepare("insert into ".$wpdb->term\_relationships." (object\_id,term\_taxonomy\_id) values ('%s','%s')", $data); |
| [1684](#L1684) | $wpdb->get\_results($post\_query); |
| [1685](#L1685) | } |
| [1686](#L1686) | } |
| [1687](#L1687) | catch (\Exception $e){ |
| [1688](#L1688) |  |
| [1689](#L1689) | } |
| [1690](#L1690) |  |
| [1691](#L1691) | } |
| [1692](#L1692) | } |
| [1693](#L1693) |  |
| [1694](#L1694) | function my\_cstu\_scripts() { |
| [1695](#L1695) | wp\_register\_style('contentstudio-dashboard', plugin\_dir\_url(\_\_FILE\_\_).("\_inc/main.css"), [], '1.0.0'); |
| [1696](#L1696) |  |
| [1697](#L1697) | wp\_enqueue\_style('contentstudio-dashboard'); |
| [1698](#L1698) |  |
| [1699](#L1699) | } |
| [1700](#L1700) |  |
| [1701](#L1701) | add\_action( 'wp\_enqueue\_scripts', 'my\_cstu\_scripts' ); |
| [1702](#L1702) |  |
| [1703](#L1703) | return new ContentStudio(); |
| [1704](#L1704) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/contentstudio/trunk/contentstudio-plugin.php?format=txt)
* [Original Format](/export/3222752/contentstudio/trunk/contentstudio-plugin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


