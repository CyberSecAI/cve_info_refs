=== Content from gitlab.com_84c41ebe_20250115_082259.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2023](/gitlab-org/cves/-/tree/master/2023)
* [**CVE-2023-0450.json**](/gitlab-org/cves/-/blob/master/2023/CVE-2023-0450.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2023/CVE-2023-0450.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2023/CVE-2023-0450.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ GitLab Bot 's avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 " GitLab Bot ")](/gitlab-bot)

  Mar 31, 2023

  [8d18172f](/gitlab-org/cves/-/commit/8d18172ffea7124ae2e70a8047ca676f0e4df091)
  [Publishing 0 updated advisories and 14 new advisories](/gitlab-org/cves/-/commit/8d18172ffea7124ae2e70a8047ca676f0e4df091)
  繚
  8d18172f

  [ GitLab Bot ](/gitlab-bot) authored Mar 31, 2023

  8d18172f

  [Publishing 0 updated advisories and 14 new advisories](/gitlab-org/cves/-/commit/8d18172ffea7124ae2e70a8047ca676f0e4df091)
  [ GitLab Bot ](/gitlab-bot) authored Mar 31, 2023

Loading



=== Content from gitlab.com_9da4a072_20250115_082259.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Ambiguous branch name exploitation in GitLab

**[HackerOne report #1831547](https://hackerone.com/reports/1831547)** by `inspector-ambitious` on 2023-01-11, assigned to [@fvpotvin](/fvpotvin "F矇lix Veillette-Potvin"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

#### Summary

##### Introduction

I was curious to know what would happen on a GitLab repository if I was creating branches with ambiguous symbolic ref names. After a few experiments, I believe I found one vulnerability that would allow an attacker to lure users into thinking a repository content is safe. Please note that I already reported a quite similar attack in #1831543, but this one do not use tag it uses ambiguous branch names confusion.

##### A quick recap about symbolic ref names

The following is extracted from this [documentation](https://git-scm.com/docs/gitrevisions#Documentation/gitrevisions.txt-emltrefnamegtemegemmasterememheadsmasterememrefsheadsmasterem).

> A symbolic ref name. E.g. `master` typically means the commit object referenced by `refs/heads/master`. If you happen to have both `heads/master` and `tags/master`, you can explicitly say heads/master to tell Git which one you mean. When ambiguous, a `<refname>` is disambiguated by taking the first match in the following rules:
>
> If $GIT\_DIR/`<refname>` exists, that is what you mean (this is usually useful only for HEAD, FETCH\_HEAD, ORIG\_HEAD, MERGE\_HEAD and CHERRY\_PICK\_HEAD);
>
> * otherwise, refs/`<refname>` if it exists;
> * otherwise, refs/tags/`<refname>` if it exists;
> * otherwise, refs/heads/`<refname>` if it exists;
> * otherwise, refs/remotes/`<refname>` if it exists;
> * otherwise, refs/remotes/`<refname>`/HEAD if it exists.

In the following exploitation scenario, we're going to abuse the fact that the following symbolic reference name

`refs/heads/foo`, can resolve to two distinct branches either `refs/heads/foo` or `refs/heads/refs/heads/foo`.

#### Steps to reproduce

This scenario was tested on a local instance of GitLab 15.6.2-ee at the URL `http://gitlab.ubuntu/`.

##### Step 1: The malicious `refs/heads/main` default branch

A user named `inspector-ambitious` creates an empty new repo named `repo0` (without a README).

`inspector-ambitious` will then create a branch named `refs/heads/main` containing a malicious script named `./script.sh`. That branch will become the default branch since the repo was empty.

From the command line, it would look like this

```
git clone git@gitlab.ubuntu:inspector-ambitious/repo0.git
cd repo0
echo "echo 'execute malicious code'" >> script.sh
chmod +x script.sh
git add script.sh
git commit -m "malicious script"
git branch -M hack
git push origin hack:refs/heads/refs/heads/main
```

[![issue1_screenshot1.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f2eb3d7fbe420d9514c31df2663d45602731f1e1/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36346536366533342d323038642d346130312d616538302d3462343565376665333638352f6973737565315f73637265656e73686f74312e706e67)

Note in the screenshot above that the default branch is `refs/heads/main` and the commit name is `malicious script`.

##### Step 2: The genuine `main` branch

Then `inspector-ambitious` creates a `main` branch in the repository containing as well a `./script.sh` but this time the content of `./script.sh` is genuine and safe to execute.

From the command line, it would look like this

```
mkdir repo0_genuine
cd repo0_genuine
echo "echo 'this is genuine'" >> script.sh
chmod +x script.sh
git init
git add script.sh
git commit -m "genuine script"
git branch -M genuine
git remote add origin git@gitlab.ubuntu:inspector-ambitious/repo0.git
git push origin genuine
```

The next step is to create a `main` branch from the `genuine` branch in GitLab UI, since trying push directly a branch called `main` with the command line will result in an error.

[![issue1_screenshot2.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/780a5e80e55485fccd52cf8b7ba7a6660230b63c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62303639396365342d393361392d346664332d393631312d6464633763633663633062612f6973737565315f73637265656e73686f74322e706e67)

##### Step 3: The victim clone the repo and execute the script

Now let's say the user `victim` goes to the repository `http://gitlab.ubuntu/inspector-ambitious/repo0/`, `victim` will see the following.

[![issue1_screenshot3.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/698d294a6a1747d7706e9c52c51b5ca858a4ad9a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61366132623863332d323432392d343164642d396232312d3831373434386161373236312f6973737565315f73637265656e73686f74332e706e67)

While the default branch is `refs/heads/main`, `victim` will see the content of `main` branch instead, note the commit name `genuine script`. And if `victim` was cloning the repository and executing `script.sh`, it will be the malicious code that would be executed instead.

[![issue1_screenshot4.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/fac5dc8412ca9b36b6562b3076e8c5bbdc70d541/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32393933353166312d313734312d346136662d383232302d6339643030366166326134652f6973737565315f73637265656e73686f74342e706e67)

I also tested the download of the zip file and it is not vulnerable, the `victim` would download the `main` branch instead of the `refs/heads/main` branch.

#### Impact

Malicious repositories could be created to lure users into executing what they think is safe code, resulting in the takeover of the victim system.

#### Output of checks

This bug happens on GitLab.com and but i did most of my testing on a local instance of GitLab 15.6.2-ee.

#### Impact

Malicious repositories could be created to lure users into executing what they think is safe code, resulting in the takeover of the victim system.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [issue1\_screenshot1.png](https://h1.sec.gitlab.net/a/64e66e34-208d-4a01-ae80-4b45e7fe3685/issue1_screenshot1.png)
* [issue1\_screenshot2.png](https://h1.sec.gitlab.net/a/b0699ce4-93a9-4fd3-9611-ddc7cc6cc0ba/issue1_screenshot2.png)
* [issue1\_screenshot3.png](https://h1.sec.gitlab.net/a/a6a2b8c3-2429-41dd-9b21-817448aa7261/issue1_screenshot3.png)
* [issue1\_screenshot4.png](https://h1.sec.gitlab.net/a/299351f1-1741-4a6f-8220-c9d006af2a4e/issue1_screenshot4.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


