=== Content from github.com_c349761c_20250114_212556.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fissues%2F9759)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fissues%2F9759)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=nestjs%2Fnest)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nestjs](/nestjs)
/
**[nest](/nestjs/nest)**
Public

* [Notifications](/login?return_to=%2Fnestjs%2Fnest) You must be signed in to change notification settings
* [Fork
  7.7k](/login?return_to=%2Fnestjs%2Fnest)
* [Star
   68.9k](/login?return_to=%2Fnestjs%2Fnest)

* [Code](/nestjs/nest)
* [Issues
  28](/nestjs/nest/issues)
* [Pull requests
  18](/nestjs/nest/pulls)
* [Actions](/nestjs/nest/actions)
* [Projects
  0](/nestjs/nest/projects)
* [Security](/nestjs/nest/security)
* [Insights](/nestjs/nest/pulse)

Additional navigation options

* [Code](/nestjs/nest)
* [Issues](/nestjs/nest/issues)
* [Pull requests](/nestjs/nest/pulls)
* [Actions](/nestjs/nest/actions)
* [Projects](/nestjs/nest/projects)
* [Security](/nestjs/nest/security)
* [Insights](/nestjs/nest/pulse)

# StreamableFile pipe can leak resources if response is closed/errored prematurely¬†#9759

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosed[#9819](https://github.com/nestjs/nest/pull/9819)Closed[StreamableFile pipe can leak resources if response is closed/errored prematurely](#top)#9759[#9819](https://github.com/nestjs/nest/pull/9819)Copy linkLabels[needs triageThis issue has not been looked into](https://github.com/nestjs/nest/issues?q=state%3Aopen%20label%3A%22needs%20triage%22)This issue has not been looked into![@alexd6631](https://avatars.githubusercontent.com/u/1730613?v=4&size=80)
## Description

![@alexd6631](https://avatars.githubusercontent.com/u/1730613?v=4&size=48)[alexd6631](https://github.com/alexd6631)opened [on Jun 13, 2022](https://github.com/nestjs/nest/issues/9759#issue-1269010651)
### Is there an existing issue for this?

* I have searched the existing issues

### Current behavior

[nest/packages/platform-express/adapters/express-adapter.ts](https://github.com/nestjs/nest/blob/d83edc32dd61b84ca759487dd4aa017069549ea8/packages/platform-express/adapters/express-adapter.ts#L81)

Line 81
in
[d83edc3](/nestjs/nest/commit/d83edc32dd61b84ca759487dd4aa017069549ea8)

|  | return body.getStream().pipe(response); |
| --- | --- |

When returning a StreamableFile from a controller, it seems the express adapter will .pipe() it to the express response stream.

As you may know pipe method is somewhat deprecated because it does not properly closes streams in case of abnormal termination, newer code should prefer use [`pipeline`](https://nodejs.org/api/stream.html#streampipelinesource-transforms-destination-callback) which automatically closes source stream on destination stream error.

So if a client cancels a request while it is streaming a StreamableFile, the stream wrapped by the StreamableFile will be kept forever opened, leading to a potential ressource leak.

### Minimum reproduction code

WIP (see below)

### Steps to reproduce

I am noticing the issue on a production app I am currently working on and I can't publish the code source without some adaptation effort to create the minimum reproduction code.

In my setup I have an endpoint that streams images store on S3 using the official AWS S3 client and StreamableFile on the controller side. The S3 client use keep alive and a pool of sockets, so if a GetObject stream is not fully consumed it will leak the socket and prevent it to return it to the pool.

I have a front that displays these images, and If I refresh the page several times quickly, it will cancel some in-flights requests on the server, but due to the .pipe behavior, some S3 Stream will not be destroyed. When the whole client pool is "poisoned", all S3 call will now hang forever, which is quite serious condition, only solved by restarting the nest server.

I could work on a minimum reproduction code, but the above setup is already quite involved.

Let me know if there is enough information, or how "minimal" the reproduction code should be in my case.

### Expected behavior

StreamableFile should destroy the underlying stream not only on full consumption but also in case of error / early abortion of the consumer stream. This should be achievable easily by replacing `.pipe()` method by the `pipeline` function

### Package

* I don't know. Or some 3rd-party package
* `@nestjs/common`
* `@nestjs/core`
* `@nestjs/microservices`
* `@nestjs/platform-express`
* `@nestjs/platform-fastify`
* `@nestjs/platform-socket.io`
* `@nestjs/platform-ws`
* `@nestjs/testing`
* `@nestjs/websockets`
* Other (see below)

### Other package

*No response*

### NestJS version

8.4.5

### Packages versions

### Node.js version

16.15.0

### In which operating systems have you tested?

* macOS
* Windows
* Linux

### Other

*No response*

üëç1
## Metadata

### Assignees

No one assigned

### Labels

[needs triageThis issue has not been looked into](https://github.com/nestjs/nest/issues?q=state%3Aopen%20label%3A%22needs%20triage%22)This issue has not been looked into
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from security.snyk.io_d31de23d_20250114_212601.html ===
[![Homepage](/_nuxt/header-logo.Dk_X-iWD.svg)](/)

2. [Snyk Vulnerability Database](/vuln)
3. [npm](/vuln/npm)
4. @nestjs/core
# Information Exposure Affecting [@nestjs/core](/package/npm/%40nestjs/core) package, versions **<9.0.5**

---

### Severity

 Recommended 0.0low010

CVSS assessment made by Snyk's Security Team. [Learn more](/vuln/SNYK-JS-NESTJSCORE-2869127#cvss)

### Threat Intelligence

EPSS

The probability is the direct output of the EPSS model, and conveys an overall sense of the threat of
exploitation in the wild. The percentile measures the EPSS probability relative to all known EPSS scores.
Note: This data is updated daily, relying on the latest available EPSS model version.
Check out the EPSS
[documentation](https://www.first.org/epss/articles/prob_percentile_bins)
for more details.

**0.11% (46th percentile)**
### Do your applications use this vulnerable package?

In a few clicks we can analyze your entire application and see what components are vulnerable in your application, and suggest you quick fixes.

[Test your applications](https://app.snyk.io/login?cta=sign-up&loc=banner&page=vuln-vuln)

* Snyk ID**SNYK-JS-NESTJSCORE-2869127**
* published**5 Mar 2023**
* disclosed**13 Jun 2022**
* credit**alexd6631**

[Report a new vulnerability](https://snyk.io/vulnerability-disclosure/) [Found a mistake?](https://support.snyk.io/s/contactsupport)
#### Introduced: 13 Jun 2022

[CVE-2023-26108 ¬†(opens in a new tab)](https://www.cve.org/CVERecord?id=CVE-2023-26108) Common Vulnerabilities and Exposures (CVE) are common identifiers for publicly known security vulnerabilities[CWE-200 ¬†(opens in a new tab)](https://cwe.mitre.org/data/definitions/200.html) Common Weakness Enumeration (CWE) is a category system for software weaknesses First added by Snyk
## How to fix?

Upgrade `@nestjs/core` to version 9.0.5 or higher.

## Overview

[@nestjs/core](https://www.npmjs.org/package/%40nestjs/core) is a Nest - modern, fast, powerful node.js web framework (@core)

Affected versions of this package are vulnerable to Information Exposure via the `StreamableFile` pipe. Exploiting this vulnerability is possible when the client cancels a request while it is streaming a `StreamableFile`, the stream wrapped by the `StreamableFile` will be kept open.

## References

* [GitHub Commit](https://github.com/nestjs/nest/pull/9819/commits/f59cf5e81ca73bcdf1b5b36713550fd93918db41)
* [GitHub Issue](https://github.com/nestjs/nest/issues/9759)
* [GitHub PR](https://github.com/nestjs/nest/pull/9819)
### CVSS Scores

version 3.1
### Snyk

3.7¬†low

* Attack Vector (AV)

  The vulnerable component is bound to the network stack and the set of possible attackers extends beyond the other options listed below, up to and including the entire Internet. Such a vulnerability is often termed ‚Äúremotely exploitable‚Äù and can be thought of as an attack being exploitable *at the protocol level* one or more network hops away (e.g., across one or more routers).

  **Network**
* Attack Complexity (AC)

  A successful attack depends on conditions beyond the attacker's control. That is, a successful attack cannot be accomplished at will, but requires the attacker to invest in some measurable amount of effort in preparation or execution against the vulnerable component before a successful attack can be expected.

  **High**
* Privileges Required (PR)

  The attacker is unauthorized prior to attack, and therefore does not require any access to settings or files of the vulnerable system to carry out an attack.

  **None**
* User Interaction (UI)

  The vulnerable system can be exploited without interaction from any user.

  **None**

* Scope (S)

  An exploited vulnerability can only affect resources managed by the same security authority. In this case, the vulnerable component and the impacted component are either the same, or both are managed by the same security authority.

  **Unchanged**

* Confidentiality (C)

  There is some loss of confidentiality. Access to some restricted information is obtained, but the attacker does not have control over what information is obtained, or the amount or kind of loss is limited. The information disclosure does not cause a direct, serious loss to the impacted component.

  **Low**
* Integrity (I)

  There is no loss of integrity within the impacted component.

  **None**
* Availability (A)

  There is no impact to availability within the impacted component.

  **None**
### NVD

5.3¬†medium
### Product

* [Snyk Open Source](https://snyk.io/product/open-source-security-management/)
* [Snyk Code](https://snyk.io/product/snyk-code/)
* [Snyk Container](https://snyk.io/product/container-vulnerability-management/)
* [Snyk Infrastructure as Code](https://snyk.io/product/infrastructure-as-code-security/)
* [Snyk AppRisk](https://snyk.io/product/snyk-apprisk/)
### Resources

* [Vulnerability DB](https://security.snyk.io/)
* [Documentation](https://docs.snyk.io/)
* [Disclosed Vulnerabilities](/disclosed-vulnerabilities)
* [Blog](https://snyk.io/blog/)
* [FAQs](https://support.snyk.io/)
### Company

* [About](https://snyk.io/about)
* [Jobs](https://snyk.io/careers/)
* Contact
* [Policies](https://snyk.io/policies/terms-of-service/)
* [Do Not Sell My Personal Information](https://preferences.snyk.io/dont_sell)
### Contact Us

* Support
* [Report a new vuln](https://snyk.io/vulnerability-disclosure)
* [Events](https://snyk.io/events)
### Find us online

### Track our development

[![DevSecOps Community Podcast](data:image/svg+xml;base64...)](https://www.devseccon.com/the-secure-developer-podcast/)

¬© 2025 Snyk Limited

Registered in England and Wales. Company number: 09677925

Registered address: Highlands House, Basingstoke Road, Spencers Wood, Reading, Berkshire, RG7 1NT.



=== Content from github.com_e81fe4fd_20250114_212558.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F9819)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F9819)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=nestjs%2Fnest)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nestjs](/nestjs)
/
**[nest](/nestjs/nest)**
Public

* [Notifications](/login?return_to=%2Fnestjs%2Fnest) You must be signed in to change notification settings
* [Fork
  7.7k](/login?return_to=%2Fnestjs%2Fnest)
* [Star
   68.9k](/login?return_to=%2Fnestjs%2Fnest)

* [Code](/nestjs/nest)
* [Issues
  28](/nestjs/nest/issues)
* [Pull requests
  18](/nestjs/nest/pulls)
* [Actions](/nestjs/nest/actions)
* [Projects
  0](/nestjs/nest/projects)
* [Security](/nestjs/nest/security)
* [Insights](/nestjs/nest/pulse)

Additional navigation options

* [Code](/nestjs/nest)
* [Issues](/nestjs/nest/issues)
* [Pull requests](/nestjs/nest/pulls)
* [Actions](/nestjs/nest/actions)
* [Projects](/nestjs/nest/projects)
* [Security](/nestjs/nest/security)
* [Insights](/nestjs/nest/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fnestjs%2Fnest%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fnestjs%2Fnest%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix: use pipeline over stream.pipe #9819

 Merged

[kamilmysliwiec](/kamilmysliwiec)
merged 4 commits into
[nestjs:master](/nestjs/nest/tree/master "nestjs/nest:master")
from
[jmcdo29:fix/pipeline-over-pipe](/jmcdo29/nest/tree/fix/pipeline-over-pipe "jmcdo29/nest:fix/pipeline-over-pipe")

Jul 20, 2022

 Merged

# [fix: use pipeline over stream.pipe](#top) #9819

[kamilmysliwiec](/kamilmysliwiec)
merged 4 commits into
[nestjs:master](/nestjs/nest/tree/master "nestjs/nest:master")
from
[jmcdo29:fix/pipeline-over-pipe](/jmcdo29/nest/tree/fix/pipeline-over-pipe "jmcdo29/nest:fix/pipeline-over-pipe")

Jul 20, 2022

[Conversation
23](/nestjs/nest/pull/9819)
[Commits
4](/nestjs/nest/pull/9819/commits)
[Checks
0](/nestjs/nest/pull/9819/checks)
[Files changed](/nestjs/nest/pull/9819/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=60&v=4)](/jmcdo29)

Copy link

Member

### @jmcdo29 **[jmcdo29](/jmcdo29)** commented [Jun 21, 2022](#issue-1279225876)

## PR Checklist

Please check if your PR fulfills the following requirements:

* The commit message follows our guidelines: <https://github.com/nestjs/nest/blob/master/CONTRIBUTING.md>
* Tests for the changes have been added (for bug fixes / features)
* Docs have been added / updated (for bug fixes / features)

## PR Type

What kind of change does this PR introduce?

* Bugfix
* Feature
* Code style update (formatting, local variables)
* Refactoring (no functional changes, no api changes)
* Build related changes
* CI related changes
* Other... Please describe:

## What is the current behavior?

If a request is cancelled during a `StreamableFile` response, then the stream is not properly closed which can lead to memory leaks and possible server failures if enough of them occur

Issue Number: [#9759](https://github.com/nestjs/nest/issues/9759)

## What is the new behavior?

`pipeline` ends up destroying streams used if there is an error in one of

the streams. Due to this, there's no chance of a memory leak from errored out

streams. There's also now an addition of adding an error handler to the

`StreamableFile` so that stream errors by default return a 400 and can be

customized to return an error message however a developer would like. These

only effect the express adapter because of how Fastify already internally

handles streams.

## Does this PR introduce a breaking change?

* Yes
* No

## Other information

fix: [#9759](https://github.com/nestjs/nest/issues/9759)

Sorry, something went wrong.

All reactions

 [![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=40&u=7d8e8932eeb518c12c044aefa593b4fd37a1cd14&v=4)](/jmcdo29)
[jmcdo29](/jmcdo29)
requested review from
[micalevisk](/micalevisk) and
[kamilmysliwiec](/kamilmysliwiec)
[June 21, 2022 23:20](#event-6851720591)

[![micalevisk](https://avatars.githubusercontent.com/u/13461315?s=60&v=4)](/micalevisk)

**[micalevisk](/micalevisk)**
reviewed
[Jun 22, 2022](#pullrequestreview-1014365358)

 [View reviewed changes](/nestjs/nest/pull/9819/files)

[packages/common/file-stream/streamable-file.ts](/nestjs/nest/pull/9819/files#diff-f5b442d6452dc6e43ba78d3b3e1786399c33f608a442affa2d9e92bb6828419c)
Outdated

Show resolved

Hide resolved

[![@coveralls](https://avatars.githubusercontent.com/u/2354108?s=80&v=4)](/coveralls)

Copy link

### **[coveralls](/coveralls)** commented [Jun 22, 2022](#issuecomment-1162528734) ‚Ä¢ edited Loading

|  |  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Pull Request Test Coverage Report for [Build 85be597d-e53e-43e6-a6dc-a62eb5acd350](https://coveralls.io/builds/50953178)  * **0** of **0** changed or added relevant lines in **0** files are covered. * No unchanged relevant lines lost coverage. * Overall coverage decreased (**-94.09%**) to **0.0%**  ---   | Totals | [Coverage Status](https://coveralls.io/builds/50953178) | | --- | --- | | Change from base [Build 989d7a11-e284-4a37-8a57-6d51089adf11](https://coveralls.io/builds/50857294): | -94.09% | | Covered Lines: | 0 | | Relevant Lines: | 0 |   ---  üíõ - [Coveralls](https://coveralls.io) |

All reactions

Sorry, something went wrong.

[![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=80&u=6b1bf39c56f0f912e44b4e1dd2e23d3c16ef363e&v=4)](/kamilmysliwiec)

Copy link

Member

### **[kamilmysliwiec](/kamilmysliwiec)** commented [Jun 22, 2022](#issuecomment-1162860423)

| Tests are failing atm  [image](https://user-images.githubusercontent.com/23244943/174993352-e18235c2-a75a-4046-82a2-8e1e50cccb3b.png) |
| --- |

All reactions

Sorry, something went wrong.

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=80&u=7d8e8932eeb518c12c044aefa593b4fd37a1cd14&v=4)](/jmcdo29)

Copy link

Member

Author

### **[jmcdo29](/jmcdo29)** commented [Jun 22, 2022](#issuecomment-1163087624) ‚Ä¢ edited Loading

| Tests are failing atm  [image](https://user-images.githubusercontent.com/23244943/174993352-e18235c2-a75a-4046-82a2-8e1e50cccb3b.png)  I noticed, but not sure why. They all pass locally, so long as `npm run build` is ran first. Is that what the `integration` flow should be? Right now that's not what we're doing in the integration step in CircleCI  [image](https://user-images.githubusercontent.com/28268680/175039135-3037329d-3c0e-4760-bd5d-cd6327f014e2.png) |
| --- |

All reactions

Sorry, something went wrong.

[![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=80&u=6b1bf39c56f0f912e44b4e1dd2e23d3c16ef363e&v=4)](/kamilmysliwiec)

Copy link

Member

### **[kamilmysliwiec](/kamilmysliwiec)** commented [Jun 23, 2022](#issuecomment-1164284087)

| They all pass locally, so long as npm run build is ran first. Is that what the integration flow should be?  `npm run build` is called as part of the "Prepare tests" step |
| --- |

All reactions

Sorry, something went wrong.

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=40&v=4)](/jmcdo29)

`[fix: use pipeline over stream.pipe](/nestjs/nest/pull/9819/commits/18c27cd7904d7edf2e6b3715b012663f65e511ba "fix: use pipeline over stream.pipe

`pipeline` ends up destroying streams used if there is an error in one of
the streams. Due to this, there's no chance of a memory leak from errored out
streams. There's also now an addition of adding an error handler to the
`StreamableFile` so that stream errors by default return a 400 and can be
customized to return an error message however a developer would like. These
only effect the express adapter because of how Fastify already internally
handles streams.

fix: #9759")`
 ‚Ä¶

`[18c27cd](/nestjs/nest/pull/9819/commits/18c27cd7904d7edf2e6b3715b012663f65e511ba)`

```
`pipeline` ends up destroying streams used if there is an error in one of
the streams. Due to this, there's no chance of a memory leak from errored out
streams. There's also now an addition of adding an error handler to the
`StreamableFile` so that stream errors by default return a 400 and can be
customized to return an error message however a developer would like. These
only effect the express adapter because of how Fastify already internally
handles streams.

fix: [nestjs#9759](https://github.com/nestjs/nest/issues/9759)
```

 [![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=40&u=7d8e8932eeb518c12c044aefa593b4fd37a1cd14&v=4)](/jmcdo29)
[jmcdo29](/jmcdo29)
[force-pushed](/nestjs/nest/compare/c2b2cfd41e06ea4e9265175222ceb26fd3d5e980..18c27cd7904d7edf2e6b3715b012663f65e511ba)
the
fix/pipeline-over-pipe

branch
from
[`c2b2cfd`](/nestjs/nest/commit/c2b2cfd41e06ea4e9265175222ceb26fd3d5e980) to
[`18c27cd`](/nestjs/nest/commit/18c27cd7904d7edf2e6b3715b012663f65e511ba)  [Compare](/nestjs/nest/compare/c2b2cfd41e06ea4e9265175222ceb26fd3d5e980..18c27cd7904d7edf2e6b3715b012663f65e511ba)
[June 23, 2022 15:50](#event-6867628082)

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=80&u=7d8e8932eeb518c12c044aefa593b4fd37a1cd14&v=4)](/jmcdo29)

Copy link

Member

Author

### **[jmcdo29](/jmcdo29)** commented [Jun 23, 2022](#issuecomment-1164585067)

| They all pass locally, so long as npm run build is ran first. Is that what the integration flow should be?  `npm run build` is called as part of the "Prepare tests" step  Sure enough, there was something going on with my local build that was running fine that wasn't in CI. Got it fixed up, should be good once CI resolves now |
| --- |

 üéâ
1
 micalevisk reacted with hooray emoji

All reactions

* üéâ
  1 reaction

Sorry, something went wrong.

[![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=40&u=6b1bf39c56f0f912e44b4e1dd2e23d3c16ef363e&v=4)](/kamilmysliwiec)
[kamilmysliwiec](/kamilmysliwiec)
mentioned this pull request
[Jun 24, 2022](#ref-issue-1269010651)

[StreamableFile pipe can leak resources if response is closed/errored prematurely
#9759](/nestjs/nest/issues/9759)

Closed

15 tasks

[![@alexd6631](https://avatars.githubusercontent.com/u/1730613?s=80&v=4)](/alexd6631)

Copy link

### **[alexd6631](/alexd6631)** commented [Jun 24, 2022](#issuecomment-1165324858)

| Hello [@jmcdo29](https://github.com/jmcdo29),  I have some doubt about the way error handling is implemented in this PR.  I think it will work fine if the error happens at the beginning of the stream, for instance if a file is not present such as in your test suite. But an error could also happen anytime mid-stream (imagine your streamable file streams data from a S3 service, but the S3 service crashes or become unreachable). In that case you will already have sent 200 OK headers and some content to the client and it would be too late to send a 400. (Also IMHO 400 is client bad request error, and seems inappropriate as a default error).  To my knowledge, HTTP doesn't have a mechanism for signaling an error during a response and after headers have been sent and some content stream. So I think the "least worst" approach would be to close the client socket from the server, so the client is notified something is wrong with the streaming (by receiving an IO error) and can retry later.  If we just end the response in case of error, the client will not be able to differentiate between a normal stream completion, and an error which will lead the client to have a truncated content without noticing it.  An alternative for the client would be to compare the Content-Length with the actual streamed content, however it is not always possible to have a Content-Length (we may not known the length of the steam, and it could be generated dynamically).  Let me know if you have a better way to handle this. I think adding a test case with a stream failing in deferred way would be a good way to experiment possible solutions  Best regards, Alex |
| --- |

All reactions

Sorry, something went wrong.

[![@alexd6631](https://avatars.githubusercontent.com/u/1730613?s=80&v=4)](/alexd6631)

Copy link

### **[alexd6631](/alexd6631)** commented [Jun 24, 2022](#issuecomment-1165600377)

| [@jmcdo29](https://github.com/jmcdo29)  As an afterthought of my last comment, I think in case of error in the source (here the StreamableFile), pipeline will destroy the destination stream (here the express Response). So in this case the client socket should be destroyed (because the express response is an http.OutgoingMessage).  So in all cases (error at start or mid-stream) the socket will be closed. (Note this may not optimal for the point of view of keep alive in case of start error, because in that case we should be able to emit error in headers, and end the response properly, without killing the underlying socket. A rough idea to implement that behavior would be to not use pipeline, but pipe and some manually event handling)  So in the error handler, maybe it should be enough to check [headerSent](https://expressjs.com/fr/api.html#res.headersSent) before sending the 400, to diffrentiate the start or mid-stream error. |
| --- |

All reactions

Sorry, something went wrong.

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=80&u=7d8e8932eeb518c12c044aefa593b4fd37a1cd14&v=4)](/jmcdo29)

Copy link

Member

Author

### **[jmcdo29](/jmcdo29)** commented [Jun 24, 2022](#issuecomment-1165605296)

| pipeline will destroy the destination stream (here the express Response)  That's actually why in the `body.getStream()` there is an added `.on('error', (err: Error) => { body.errorHandler(err, response); })`, so that if an error happens when the stream is created an error can still be sent before the response stream is closed.  A rough idea to implement that behavior would be to not use pipeline  Even though the original issue of [#9759](https://github.com/nestjs/nest/issues/9759) is to use `pipeline` instead of `pipe`?  but pipe and some manually event handling  Got an idea of what this would look like? |
| --- |

All reactions

Sorry, something went wrong.

[![@alexd6631](https://avatars.githubusercontent.com/u/1730613?s=80&v=4)](/alexd6631)

Copy link

### **[alexd6631](/alexd6631)** commented [Jun 24, 2022](#issuecomment-1165613527) ‚Ä¢ edited Loading

| As inspiration of the article : <https://www.alxolr.com/articles/understanding-memory-leaks-in-node-js-part-1>  pipeline is roughly equivalent to :  ``` source.pipe(destination);  destination.on('close', () => {    source.destroy(); });  destination.on('error', () => {    source.destroy(); });  source.on('error', () => {   destination.destroy(); });  source.on('end', () => {   destination.destroy(); });  ```  So we could do something like that (pseudo code)  ``` source.pipe(destination);  destination.on('close', () => {    source.destroy(); });  destination.on('error', (e) => {    source.destroy(e); });  source.on('error', (e) => {   if (!destination.headerSent) { //Handle the early error     destination.send(400);     destination.end();   } else { // Mid stream error, close the socket abruptly to notify the client of the error     destination.destroy(e);   } });  source.on('end', () => {   // destination.destroy()   // contrary to the article It should not be necessary to destroy the destination stream in case of a successful stream completion, so I think this handler is not useful });  ```  EDIT: I am not sure about the original implementation in the article, and I did some minor modification based on a quick experimentation with local streams, so ofc take it as a way to draft the idea and not working code ^^. |
| --- |

All reactions

Sorry, something went wrong.

[![Tony133](https://avatars.githubusercontent.com/u/11542387?s=60&v=4)](/Tony133)

**[Tony133](/Tony133)**
approved these changes
[Jun 25, 2022](#pullrequestreview-1019327708)

 [View reviewed changes](/nestjs/nest/pull/9819/files/18c27cd7904d7edf2e6b3715b012663f65e511ba)

[![hebertcisco](https://avatars.githubusercontent.com/u/45374044?s=60&v=4)](/hebertcisco)

**[hebertcisco](/hebertcisco)**
approved these changes
[Jun 28, 2022](#pullrequestreview-1022218328)

 [View reviewed changes](/nestjs/nest/pull/9819/files/18c27cd7904d7edf2e6b3715b012663f65e511ba)

[![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=80&u=6b1bf39c56f0f912e44b4e1dd2e23d3c16ef363e&v=4)](/kamilmysliwiec)

Copy link

Member

### **[kamilmysliwiec](/kamilmysliwiec)** commented [Jul 14, 2022](#issuecomment-1184059068)

| Is there anything left we need to implement here [@jmcdo29](https://github.com/jmcdo29)? üôå |
| --- |

All reactions

Sorry, something went wrong.

[![@micalevisk](https://avatars.githubusercontent.com/u/13461315?s=40&v=4)](/micalevisk)
[micalevisk](/micalevisk)
mentioned this pull request
[Jul 17, 2022](#ref-issue-1307207165)

[StreamableFile errors crash server
#9938](/nestjs/nest/issues/9938)

Closed

15 tasks

[![micalevisk](https://avatars.githubusercontent.com/u/13461315?s=60&v=4)](/micalevisk)

**[micalevisk](/micalevisk)**
reviewed
[Jul 17, 2022](#pullrequestreview-1041184849)

 [View reviewed changes](/nestjs/nest/pull/9819/files/18c27cd7904d7edf2e6b3715b012663f65e511ba)

[packages/common/file-stream/streamable-file.ts](/nestjs/nest/pull/9819/files/18c27cd7904d7edf2e6b3715b012663f65e511ba#diff-f5b442d6452dc6e43ba78d3b3e1786399c33f608a442affa2d9e92bb6828419c)
Outdated

Show resolved

Hide resolved

[![micalevisk](https://avatars.githubusercontent.com/u/13461315?s=60&v=4)](/micalevisk)

**[micalevisk](/micalevisk)**
reviewed
[Jul 17, 2022](#pullrequestreview-1041185748)

 [View reviewed changes](/nestjs/nest/pull/9819/files/18c27cd7904d7edf2e6b3715b012663f65e511ba)

[packages/platform-express/adapters/express-adapter.ts](/nestjs/nest/pull/9819/files/18c27cd7904d7edf2e6b3715b012663f65e511ba#diff-0f9d4c88c1f368780a6f8402b499bd55c191fbbb46435b3d087c6cad9d55b9ca)
Outdated

Show resolved

Hide resolved

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=80&u=7d8e8932eeb518c12c044aefa593b4fd37a1cd14&v=4)](/jmcdo29)

Copy link

Member

Author

### **[jmcdo29](/jmcdo29)** commented [Jul 17, 2022](#issuecomment-1186612661)

| Let me make the changes [@micalevisk](https://github.com/micalevisk) suggested and then this should be good to merge. If we need to modify it again later to take into account other features that's always an option |
| --- |

 üëç
1
 micalevisk reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=40&v=4)](/jmcdo29)

`[feat: update handler to be protected and only handle errors once](/nestjs/nest/pull/9819/commits/f59cf5e81ca73bcdf1b5b36713550fd93918db41 "feat: update handler to be protected and only handle errors once")`

`[f59cf5e](/nestjs/nest/pull/9819/commits/f59cf5e81ca73bcdf1b5b36713550fd93918db41)`

[![micalevisk](https://avatars.githubusercontent.com/u/13461315?s=60&v=4)](/micalevisk)

**[micalevisk](/micalevisk)**
reviewed
[Jul 17, 2022](#pullrequestreview-1041193665)

 [View reviewed changes](/nestjs/nest/pull/9819/files/f59cf5e81ca73bcdf1b5b36713550fd93918db41)

[packages/common/file-stream/streamable-file.ts](/nestjs/nest/pull/9819/files/f59cf5e81ca73bcdf1b5b36713550fd93918db41#diff-f5b442d6452dc6e43ba78d3b3e1786399c33f608a442affa2d9e92bb6828419c)
Outdated

Show resolved

Hide resolved

[![micalevisk](https://avatars.githubusercontent.com/u/13461315?s=60&v=4)](/micalevisk)

**[micalevisk](/micalevisk)**
approved these changes
[Jul 18, 2022](#pullrequestreview-1041205689)

 [View reviewed changes](/nestjs/nest/pull/9819/files)

[![Tony133](https://avatars.githubusercontent.com/u/11542387?s=60&v=4)](/Tony133)

**[Tony133](/Tony133)**
approved these changes
[Jul 18, 2022](#pullrequestreview-1041310975)

 [View reviewed changes](/nestjs/nest/pull/9819/files)

[![@Tony133](https://avatars.githubusercontent.com/u/11542387?s=80&u=4be9af77bb81859d65c2cfa0ecd305068119e9d4&v=4)](/Tony133)

Copy link

Contributor

### **[Tony133](/Tony133)** commented [Jul 18, 2022](#issuecomment-1186803832)

| I think it refers to the changes made in the last commit  [Schermata 2022-07-18 alle 08 06 56](https://user-images.githubusercontent.com/11542387/179453470-c3760ae4-a659-47f2-be4c-0a4a67fae4a3.png) |
| --- |

All reactions

Sorry, something went wrong.

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=40&v=4)](/jmcdo29)

`[fix: rename handler to to better represent what it is handling](/nestjs/nest/pull/9819/commits/248596ba5954003c96a60ca36c6427886eae9bd5 "fix: rename handler to to better represent what it is handling")`

`[248596b](/nestjs/nest/pull/9819/commits/248596ba5954003c96a60ca36c6427886eae9bd5)`

 [![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=40&u=7d8e8932eeb518c12c044aefa593b4fd37a1cd14&v=4)](/jmcdo29)
[jmcdo29](/jmcdo29)
[force-pushed](/nestjs/nest/compare/4f42aaea922423e2a47e3dfde30614dbd3b1f58d..248596ba5954003c96a60ca36c6427886eae9bd5)
the
fix/pipeline-over-pipe

branch
from
[`4f42aae`](/nestjs/nest/commit/4f42aaea922423e2a47e3dfde30614dbd3b1f58d) to
[`248596b`](/nestjs/nest/commit/248596ba5954003c96a60ca36c6427886eae9bd5)  [Compare](/nestjs/nest/compare/4f42aaea922423e2a47e3dfde30614dbd3b1f58d..248596ba5954003c96a60ca36c6427886eae9bd5)
[July 18, 2022 06:09](#event-7009140692)

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=80&u=7d8e8932eeb518c12c044aefa593b4fd37a1cd14&v=4)](/jmcdo29)

Copy link

Member

Author

### **[jmcdo29](/jmcdo29)** commented [Jul 18, 2022](#issuecomment-1186804376)

| I think it refers to the changes made in the last commit [Schermata 2022-07-18 alle 08 06 56](https://user-images.githubusercontent.com/11542387/179453470-c3760ae4-a659-47f2-be4c-0a4a67fae4a3.png)  Just saw this, just pushed a fix, give it a minute |
| --- |

 üëç
1
 Tony133 reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=60&v=4)](/kamilmysliwiec)

**[kamilmysliwiec](/kamilmysliwiec)**
reviewed
[Jul 18, 2022](#pullrequestreview-1041396829)

 [View reviewed changes](/nestjs/nest/pull/9819/files/248596ba5954003c96a60ca36c6427886eae9bd5)

[packages/platform-express/adapters/express-adapter.ts](/nestjs/nest/pull/9819/files/248596ba5954003c96a60ca36c6427886eae9bd5#diff-0f9d4c88c1f368780a6f8402b499bd55c191fbbb46435b3d087c6cad9d55b9ca)
Outdated

Show resolved

Hide resolved

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=40&v=4)](/jmcdo29)

`[fix: move logger to class member](/nestjs/nest/pull/9819/commits/9739aa6a1af44e1f76a44366fbbcdad1aaddc392 "fix: move logger to class member")`

`[9739aa6](/nestjs/nest/pull/9819/commits/9739aa6a1af44e1f76a44366fbbcdad1aaddc392)`

[![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=40&u=6b1bf39c56f0f912e44b4e1dd2e23d3c16ef363e&v=4)](/kamilmysliwiec)
[kamilmysliwiec](/kamilmysliwiec)
merged commit [`429dfa1`](/nestjs/nest/commit/429dfa13820403903619cfa9812b517d90df1d3a)
into
nestjs:master

[Jul 20, 2022](https://github.com/nestjs/nest/pull/9819#event-7027221021)

[![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=80&u=6b1bf39c56f0f912e44b4e1dd2e23d3c16ef363e&v=4)](/kamilmysliwiec)

Copy link

Member

### **[kamilmysliwiec](/kamilmysliwiec)** commented [Jul 20, 2022](#issuecomment-1189994373)

| LGTM |
| --- |

All reactions

Sorry, something went wrong.

[![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=40&u=6b1bf39c56f0f912e44b4e1dd2e23d3c16ef363e&v=4)](/kamilmysliwiec)
[kamilmysliwiec](/kamilmysliwiec)
added
[type: bug üò≠](/nestjs/nest/labels/type%3A%20bug%20%3Asob%3A)
[scope: common](/nestjs/nest/labels/scope%3A%20common)
[scope: platform](/nestjs/nest/labels/scope%3A%20platform)
labels
[Jul 20, 2022](#event-7027223558)

[![@danielkappelle](https://avatars.githubusercontent.com/u/10685473?s=40&v=4)](/danielkappelle)
[danielkappelle](/danielkappelle)
mentioned this pull request
[Aug 12, 2022](#ref-issue-1336929720)

[Quickly closing connection after sending StreamableFile crashes server
#10105](/nestjs/nest/issues/10105)

Closed

15 tasks

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F9819)

Reviewers

[![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=40&v=4)](/kamilmysliwiec) [kamilmysliwiec](/kamilmysliwiec)

kamilmysliwiec left review comments

[![@hebertcisco](https://avatars.githubusercontent.com/u/45374044?s=40&v=4)](/hebertcisco) [hebertcisco](/hebertcisco)

hebertcisco approved these changes

[![@micalevisk](https://avatars.githubusercontent.com/u/13461315?s=40&v=4)](/micalevisk) [micalevisk](/micalevisk)

micalevisk approved these changes

[![@Tony133](https://avatars.githubusercontent.com/u/11542387?s=40&v=4)](/Tony133) [Tony133](/Tony133)

Tony133 approved these changes

Assignees

No one assigned

Labels

[scope: common](/nestjs/nest/labels/scope%3A%20common)
[scope: platform](/nestjs/nest/labels/scope%3A%20platform)
[type: bug üò≠](/nestjs/nest/labels/type%3A%20bug%20%3Asob%3A)

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [StreamableFile pipe can leak resources if response is closed/errored prematurely](https://github.com/nestjs/nest/issues/9759)

7 participants

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=52&v=4)](/jmcdo29) [![@coveralls](https://avatars.githubusercontent.com/u/2354108?s=52&v=4)](/coveralls) [![@kamilmysliwiec](https://avatars.githubusercontent.com/u/23244943?s=52&v=4)](/kamilmysliwiec) [![@alexd6631](https://avatars.githubusercontent.com/u/1730613?s=52&v=4)](/alexd6631) [![@Tony133](https://avatars.githubusercontent.com/u/11542387?s=52&v=4)](/Tony133) [![@micalevisk](https://avatars.githubusercontent.com/u/13461315?s=52&v=4)](/micalevisk) [![@hebertcisco](https://avatars.githubusercontent.com/u/45374044?s=52&v=4)](/hebertcisco)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_65c1bc02_20250114_212600.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F9819%2Fcommits%2Ff59cf5e81ca73bcdf1b5b36713550fd93918db41)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F9819%2Fcommits%2Ff59cf5e81ca73bcdf1b5b36713550fd93918db41)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow%2Fcommits&source=header-repo&source_repo=nestjs%2Fnest)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nestjs](/nestjs)
/
**[nest](/nestjs/nest)**
Public

* [Notifications](/login?return_to=%2Fnestjs%2Fnest) You must be signed in to change notification settings
* [Fork
  7.7k](/login?return_to=%2Fnestjs%2Fnest)
* [Star
   68.9k](/login?return_to=%2Fnestjs%2Fnest)

* [Code](/nestjs/nest)
* [Issues
  28](/nestjs/nest/issues)
* [Pull requests
  18](/nestjs/nest/pulls)
* [Actions](/nestjs/nest/actions)
* [Projects
  0](/nestjs/nest/projects)
* [Security](/nestjs/nest/security)
* [Insights](/nestjs/nest/pulse)

Additional navigation options

* [Code](/nestjs/nest)
* [Issues](/nestjs/nest/issues)
* [Pull requests](/nestjs/nest/pulls)
* [Actions](/nestjs/nest/actions)
* [Projects](/nestjs/nest/projects)
* [Security](/nestjs/nest/security)
* [Insights](/nestjs/nest/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fnestjs%2Fnest%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fnestjs%2Fnest%2Fissues%2Fnew%2Fchoose)
to your account

# fix: use pipeline over stream.pipe #9819

 Merged

[kamilmysliwiec](/kamilmysliwiec)
merged 4 commits into
[nestjs:master](/nestjs/nest/tree/master "nestjs/nest:master")
from
[jmcdo29:fix/pipeline-over-pipe](/jmcdo29/nest/tree/fix/pipeline-over-pipe "jmcdo29/nest:fix/pipeline-over-pipe")

Jul 20, 2022

+53

‚àí1

[Conversation
23](/nestjs/nest/pull/9819)
[Commits
4](/nestjs/nest/pull/9819/commits)
[Checks
0](/nestjs/nest/pull/9819/checks)
[Files changed
5](/nestjs/nest/pull/9819/files)

 Merged

# [fix: use pipeline over stream.pipe](#top) #9819

 Show file tree

 Hide file tree

Changes from **1 commit**

Commits

[Show all changes

4 commits](/nestjs/nest/pull/9819/files)
Select commit
Hold shift + click to select a range

[`18c27cd`
fix: use pipeline over stream.pipe

jmcdo29 Jun 21, 2022](/nestjs/nest/pull/9819/commits/18c27cd7904d7edf2e6b3715b012663f65e511ba)
[`f59cf5e`
feat: update handler to be protected and only handle errors once

jmcdo29 Jul 17, 2022](/nestjs/nest/pull/9819/commits/f59cf5e81ca73bcdf1b5b36713550fd93918db41)
[`248596b`
fix: rename handler to to better represent what it is handling

jmcdo29 Jul 18, 2022](/nestjs/nest/pull/9819/commits/248596ba5954003c96a60ca36c6427886eae9bd5)
[`9739aa6`
fix: move logger to class member

jmcdo29 Jul 18, 2022](/nestjs/nest/pull/9819/commits/9739aa6a1af44e1f76a44366fbbcdad1aaddc392)

**File filter**

### Filter by extension

Filter by extension

.ts
(2)

All 1 file type selected

---

Viewed files

[Clear filters](/nestjs/nest/pull/9819/commits/f59cf5e81ca73bcdf1b5b36713550fd93918db41)

 **Conversations**

Failed to load comments.  Retry

 Loading

 **Jump to**

Jump to file

Failed to load files.  Retry

 Loading

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

Show whitespace

##### Diff view

![Unified Diff View](https://github.githubassets.com/assets/unified-6de447b07fd7.svg)

Unified

![Split Diff View](https://github.githubassets.com/assets/split-b930d4a1df45.svg)

Split

Hide whitespace

 Apply and reload

* packages

  + common/file-stream

    - packages/common/file-stream/streamable-file.ts
      [streamable-file.ts](#diff-f5b442d6452dc6e43ba78d3b3e1786399c33f608a442affa2d9e92bb6828419c)
  + platform-express/adapters

    - packages/platform-express/adapters/express-adapter.ts
      [express-adapter.ts](#diff-0f9d4c88c1f368780a6f8402b499bd55c191fbbb46435b3d087c6cad9d55b9ca)

 [Prev](/nestjs/nest/pull/9819/commits/18c27cd7904d7edf2e6b3715b012663f65e511ba)Previous commit

 [Next](/nestjs/nest/pull/9819/commits/248596ba5954003c96a60ca36c6427886eae9bd5)Next commit

feat: update handler to be protected and only handle errors once

* Loading branch information

[![@jmcdo29](https://avatars.githubusercontent.com/u/28268680?s=40&v=4)](/jmcdo29)

[jmcdo29](/nestjs/nest/commits?author=jmcdo29 "View all commits by jmcdo29")
committed
Jul 17, 2022

commit f59cf5e81ca73bcdf1b5b36713550fd93918db41

## There are no files selected for viewing

14 changes: 6 additions & 8 deletions

14
[packages/common/file-stream/streamable-file.ts](#diff-f5b442d6452dc6e43ba78d3b3e1786399c33f608a442affa2d9e92bb6828419c "packages/common/file-stream/streamable-file.ts")

Show comments

[View file](/jmcdo29/nest/blob/f59cf5e81ca73bcdf1b5b36713550fd93918db41/packages/common/file-stream/streamable-file.ts)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,21 +3,19 @@ import { types } from 'util'; |
|  |  | import { isFunction } from '../utils/shared.utils'; |
|  |  | import { StreamableFileOptions } from './streamable-options.interface'; |
|  |  |  |
|  |  | interface StreamableHandlerResponse { |
|  |  | export interface StreamableHandlerResponse { |
|  |  | statusCode: number; |
|  |  | send: (msg: string) => void; |
|  |  | } |
|  |  |  |
|  |  | export class StreamableFile { |
|  |  | private readonly stream: Readable; |
|  |  |  |
|  |  | private handler: (err: Error, response: StreamableHandlerResponse) => void = ( |
|  |  | err: Error, |
|  |  | res, |
|  |  | ) => { |
|  |  | res.statusCode = 400; |
|  |  | res.send(err.message); |
|  |  | }; |
|  |  | protected handler: (err: Error, response: StreamableHandlerResponse) => void = |
| **jmcdo29** marked this conversation as resolved.   Show resolved  Hide resolved | | |
|  |  | (err: Error, res) => { |
|  |  | res.statusCode = 400; |
|  |  | res.send(err.message); |
|  |  | }; |
|  |  |  |
|  |  | constructor(buffer: Uint8Array, options?: StreamableFileOptions); |
|  |  | constructor(readable: Readable, options?: StreamableFileOptions); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[packages/platform-express/adapters/express-adapter.ts](#diff-0f9d4c88c1f368780a6f8402b499bd55c191fbbb46435b3d087c6cad9d55b9ca "packages/platform-express/adapters/express-adapter.ts")

Show comments

[View file](/jmcdo29/nest/blob/f59cf5e81ca73bcdf1b5b36713550fd93918db41/packages/platform-express/adapters/express-adapter.ts)
Edit file

Delete file

[Open in desktop](https://desktop.github.com)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -81,7 +81,7 @@ export class ExpressAdapter extends AbstractHttpAdapter { |
|  |  | response.setHeader('Content-Length', streamHeaders.length); |
|  |  | } |
|  |  | return pipeline( |
|  |  | body.getStream().on('error', (err: Error) => { |
|  |  | body.getStream().once('error', (err: Error) => { |
|  |  | body.errorHandler(err, response); |
|  |  | }), |
|  |  | response, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


