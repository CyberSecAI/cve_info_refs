=== Content from github.com_ffad4e3d_20250114_235156.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F768d612f79822d30a1e7d132a4d4b05337ce42ec)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F768d612f79822d30a1e7d132a4d4b05337ce42ec)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  434](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/768d612f79822d30a1e7d132a4d4b05337ce42ec)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ext4: fix slab-use-after-free in ext4\_es\_insert\_extent()

[Browse files](/torvalds/linux/tree/768d612f79822d30a1e7d132a4d4b05337ce42ec)
Browse the repository at this point in the history

```
Yikebaer reported an issue:
==================================================================
BUG: KASAN: slab-use-after-free in ext4_es_insert_extent+0xc68/0xcb0
fs/ext4/extents_status.c:894
Read of size 4 at addr ffff888112ecc1a4 by task syz-executor/8438

CPU: 1 PID: 8438 Comm: syz-executor Not tainted 6.5.0-rc5 #1
Call Trace:
 [...]
 kasan_report+0xba/0xf0 mm/kasan/report.c:588
 ext4_es_insert_extent+0xc68/0xcb0 fs/ext4/extents_status.c:894
 ext4_map_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
 ext4_alloc_file_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
 ext4_zero_range fs/ext4/extents.c:4622 [inline]
 ext4_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
 [...]

Allocated by task 8438:
 [...]
 kmem_cache_zalloc include/linux/slab.h:693 [inline]
 __es_alloc_extent fs/ext4/extents_status.c:469 [inline]
 ext4_es_insert_extent+0x672/0xcb0 fs/ext4/extents_status.c:873
 ext4_map_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
 ext4_alloc_file_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
 ext4_zero_range fs/ext4/extents.c:4622 [inline]
 ext4_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
 [...]

Freed by task 8438:
 [...]
 kmem_cache_free+0xec/0x490 mm/slub.c:3823
 ext4_es_try_to_merge_right fs/ext4/extents_status.c:593 [inline]
 __es_insert_extent+0x9f4/0x1440 fs/ext4/extents_status.c:802
 ext4_es_insert_extent+0x2ca/0xcb0 fs/ext4/extents_status.c:882
 ext4_map_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
 ext4_alloc_file_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
 ext4_zero_range fs/ext4/extents.c:4622 [inline]
 ext4_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
 [...]
==================================================================

The flow of issue triggering is as follows:
1. remove es
      raw es               es  removed  es1
|-------------------| -> |----|.......|------|

2. insert es
  es   insert   es1      merge with es  es1     merge with es and free es1
|----|.......|------| -> |------------|------| -> |-------------------|

es merges with newes, then merges with es1, frees es1, then determines
if es1->es_len is 0 and triggers a UAF.

The code flow is as follows:
ext4_es_insert_extent
  es1 = __es_alloc_extent(true);
  es2 = __es_alloc_extent(true);
  __es_remove_extent(inode, lblk, end, NULL, es1)
    __es_insert_extent(inode, &newes, es1) ---> insert es1 to es tree
  __es_insert_extent(inode, &newes, es2)
    ext4_es_try_to_merge_right
      ext4_es_free_extent(inode, es1) --->  es1 is freed
  if (es1 && !es1->es_len)
    // Trigger UAF by determining if es1 is used.

We determine whether es1 or es2 is used immediately after calling
__es_remove_extent() or __es_insert_extent() to avoid triggering a
UAF if es1 or es2 is freed.

Reported-by: Yikebaer Aizezi <yikebaer61@gmail.com>
Closes: [https://lore.kernel.org/lkml/CALcu4raD4h9coiyEBL4Bm0zjDwxC2CyPiTwsP3zFuhot6y9Beg@mail.gmail.com](https://lore.kernel.org/lkml/CALcu4raD4h9coiyEBL4Bm0zjDwxC2CyPiTwsP3zFuhot6y9Beg%40mail.gmail.com)
Fixes: [2a69c45](https://github.com/torvalds/linux/commit/2a69c450083db164596c75c0f5b4d9c4c0e18eba) ("ext4: using nofail preallocation in ext4_es_insert_extent()")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20230815070808.3377171-1-libaokun1@huawei.com](https://lore.kernel.org/r/20230815070808.3377171-1-libaokun1%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
```

* Loading branch information

[![@LiBaokun96](https://avatars.githubusercontent.com/u/180092431?s=40&v=4)](/LiBaokun96) [![@tytso](https://avatars.githubusercontent.com/u/51416?s=40&v=4)](/tytso)

[LiBaokun96](/torvalds/linux/commits?author=LiBaokun96 "View all commits by LiBaokun96")
authored and
[tytso](/torvalds/linux/commits?author=tytso "View all commits by tytso")
committed
Aug 27, 2023

1 parent
[af494af](/torvalds/linux/commit/af494af38580a35b92f921639a60630a2307bcc2)

commit 768d612

Showing
**1 changed file**
with
**30 additions**
and
**14 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

44 changes: 30 additions & 14 deletions

44
[fs/ext4/extents\_status.c](#diff-11ac3bad38eb8867c828345809f97d69bf55132e0b64be17cca41378b48df351 "fs/ext4/extents_status.c")

Show comments

[View file](/torvalds/linux/blob/768d612f79822d30a1e7d132a4d4b05337ce42ec/fs/ext4/extents_status.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -878,23 +878,29 @@ void ext4\_es\_insert\_extent(struct inode \*inode, ext4\_lblk\_t lblk, |
|  |  | err1 = \_\_es\_remove\_extent(inode, lblk, end, NULL, es1); |
|  |  | if (err1 != 0) |
|  |  | goto error; |
|  |  | /\* Free preallocated extent if it didn't get used. \*/ |
|  |  | if (es1) { |
|  |  | if (!es1->es\_len) |
|  |  | \_\_es\_free\_extent(es1); |
|  |  | es1 = NULL; |
|  |  | } |
|  |  |  |
|  |  | err2 = \_\_es\_insert\_extent(inode, &newes, es2); |
|  |  | if (err2 == -ENOMEM && !ext4\_es\_must\_keep(&newes)) |
|  |  | err2 = 0; |
|  |  | if (err2 != 0) |
|  |  | goto error; |
|  |  | /\* Free preallocated extent if it didn't get used. \*/ |
|  |  | if (es2) { |
|  |  | if (!es2->es\_len) |
|  |  | \_\_es\_free\_extent(es2); |
|  |  | es2 = NULL; |
|  |  | } |
|  |  |  |
|  |  | if (sbi->s\_cluster\_ratio > 1 && test\_opt(inode->i\_sb, DELALLOC) && |
|  |  | (status & EXTENT\_STATUS\_WRITTEN || |
|  |  | status & EXTENT\_STATUS\_UNWRITTEN)) |
|  |  | \_\_revise\_pending(inode, lblk, len); |
|  |  |  |
|  |  | /\* es is pre-allocated but not used, free it. \*/ |
|  |  | if (es1 && !es1->es\_len) |
|  |  | \_\_es\_free\_extent(es1); |
|  |  | if (es2 && !es2->es\_len) |
|  |  | \_\_es\_free\_extent(es2); |
|  |  | error: |
|  |  | write\_unlock(&EXT4\_I(inode)->i\_es\_lock); |
|  |  | if (err1 || err2) |
| Expand Down  Expand Up | | @@ -1491,8 +1497,12 @@ void ext4\_es\_remove\_extent(struct inode \*inode, ext4\_lblk\_t lblk, |
|  |  | \*/ |
|  |  | write\_lock(&EXT4\_I(inode)->i\_es\_lock); |
|  |  | err = \_\_es\_remove\_extent(inode, lblk, end, &reserved, es); |
|  |  | if (es && !es->es\_len) |
|  |  | \_\_es\_free\_extent(es); |
|  |  | /\* Free preallocated extent if it didn't get used. \*/ |
|  |  | if (es) { |
|  |  | if (!es->es\_len) |
|  |  | \_\_es\_free\_extent(es); |
|  |  | es = NULL; |
|  |  | } |
|  |  | write\_unlock(&EXT4\_I(inode)->i\_es\_lock); |
|  |  | if (err) |
|  |  | goto retry; |
| Expand Down  Expand Up | | @@ -2047,19 +2057,25 @@ void ext4\_es\_insert\_delayed\_block(struct inode \*inode, ext4\_lblk\_t lblk, |
|  |  | err1 = \_\_es\_remove\_extent(inode, lblk, lblk, NULL, es1); |
|  |  | if (err1 != 0) |
|  |  | goto error; |
|  |  | /\* Free preallocated extent if it didn't get used. \*/ |
|  |  | if (es1) { |
|  |  | if (!es1->es\_len) |
|  |  | \_\_es\_free\_extent(es1); |
|  |  | es1 = NULL; |
|  |  | } |
|  |  |  |
|  |  | err2 = \_\_es\_insert\_extent(inode, &newes, es2); |
|  |  | if (err2 != 0) |
|  |  | goto error; |
|  |  | /\* Free preallocated extent if it didn't get used. \*/ |
|  |  | if (es2) { |
|  |  | if (!es2->es\_len) |
|  |  | \_\_es\_free\_extent(es2); |
|  |  | es2 = NULL; |
|  |  | } |
|  |  |  |
|  |  | if (allocated) |
|  |  | \_\_insert\_pending(inode, lblk); |
|  |  |  |
|  |  | /\* es is pre-allocated but not used, free it. \*/ |
|  |  | if (es1 && !es1->es\_len) |
|  |  | \_\_es\_free\_extent(es1); |
|  |  | if (es2 && !es2->es\_len) |
|  |  | \_\_es\_free\_extent(es2); |
|  |  | error: |
|  |  | write\_unlock(&EXT4\_I(inode)->i\_es\_lock); |
|  |  | if (err1 || err2) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `768d612`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F768d612f79822d30a1e7d132a4d4b05337ce42ec) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from cdn.kernel.org_ac14656b_20250114_235152.html ===
commit 2ba0babe7865cd5f4fac3d76ad15d9b6131bd283
Author: Greg Kroah-Hartman
Date: Tue Sep 19 12:30:30 2023 +0200
Linux 6.5.4
Link: https://lore.kernel.org/r/20230917191051.639202302@linuxfoundation.org
Tested-by: SeongJae Park
Tested-by: Ronald Warsow
Tested-by: Bagas Sanjaya
Tested-by: Ron Economos
Tested-by: Justin M. Forbes
Tested-by: Linux Kernel Functional Testing
Tested-by: Guenter Roeck
Tested-by: Salvatore Bonaccorso
Tested-by: Florian Fainelli
Tested-by: Shuah Khan
Tested-by: Conor Dooley
Signed-off-by: Greg Kroah-Hartman
commit 09ea6d0f8cc1e64b97dffa060940827a6a0e9546
Author: Wesley Chalmers
Date: Wed Jun 21 19:13:26 2023 -0400
drm/amd/display: Fix a bug when searching for insert\_above\_mpcc
commit 3d028d5d60d516c536de1ddd3ebf3d55f3f8983b upstream.
[WHY]
Currently, when insert\_plane is called with insert\_above\_mpcc
parameter that is equal to tree->opp\_list, the function returns NULL.
[HOW]
Instead, the function should insert the plane at the top of the tree.
Cc: Mario Limonciello
Cc: Alex Deucher
Cc: stable@vger.kernel.org
Reviewed-by: Jun Lei
Acked-by: Tom Chung
Signed-off-by: Wesley Chalmers
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 85746e2ab3fa8c392103507a2de765b2078a609f
Author: Linus Torvalds
Date: Sat Sep 16 12:31:42 2023 -0700
vm: fix move\_vma() memory accounting being off
commit 3cec50490969afd4a76ccee441f747d869ccff77 upstream.
Commit 408579cd627a ("mm: Update do\_vmi\_align\_munmap() return
semantics") seems to have updated one of the callers of do\_vmi\_munmap()
incorrectly: it used to check for the error case (which didn't
change: negative means error).
That commit changed the check to the success case (which did change:
before that commit, 0 was success, and 1 was "success and lock
downgraded". After the change, it's always 0 for success, and the lock
will have been released if requested).
This didn't change any actual VM behavior \_except\_ for memory accounting
when 'VM\_ACCOUNT' was set on the vma. Which made the wrong return value
test fairly subtle, since everything continues to work.
Or rather - it continues to work but the "Committed memory" accounting
goes all wonky (Committed\_AS value in /proc/meminfo), and depending on
settings that then causes problems much much later as the VM relies on
bogus statistics for its heuristics.
Revert that one line of the change back to the original logic.
Fixes: 408579cd627a ("mm: Update do\_vmi\_align\_munmap() return semantics")
Reported-by: Christoph Biedl
Reported-bisected-and-tested-by: Michael Labiuk
Cc: Bagas Sanjaya
Cc: Liam R. Howlett
Link: https://lore.kernel.org/all/1694366957@msgid.manchmal.in-ulm.de/
Signed-off-by: Linus Torvalds
Cc: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit 992b2ac783aad360b98ed9d4686e86176a20f6f1
Author: Kuniyuki Iwashima
Date: Mon Sep 11 19:27:53 2023 -0700
kcm: Fix error handling for SOCK\_DGRAM in kcm\_sendmsg().
[ Upstream commit a22730b1b4bf437c6bbfdeff5feddf54be4aeada ]
syzkaller found a memory leak in kcm\_sendmsg(), and commit c821a88bd720
("kcm: Fix memory leak in error path of kcm\_sendmsg()") suppressed it by
updating kcm\_tx\_msg(head)->last\_skb if partial data is copied so that the
following sendmsg() will resume from the skb.
However, we cannot know how many bytes were copied when we get the error.
Thus, we could mess up the MSG\_MORE queue.
When kcm\_sendmsg() fails for SOCK\_DGRAM, we should purge the queue as we
do so for UDP by udp\_flush\_pending\_frames().
Even without this change, when the error occurred, the following sendmsg()
resumed from a wrong skb and the queue was messed up. However, we have
yet to get such a report, and only syzkaller stumbled on it. So, this
can be changed safely.
Note this does not change SOCK\_SEQPACKET behaviour.
Fixes: c821a88bd720 ("kcm: Fix memory leak in error path of kcm\_sendmsg()")
Fixes: ab7ac4eb9832 ("kcm: Kernel Connection Multiplexor module")
Signed-off-by: Kuniyuki Iwashima
Link: https://lore.kernel.org/r/20230912022753.33327-1-kuniyu@amazon.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 5e93c6044b92bc6bea2211992fdfa9eaa1702f67
Author: Yoshihiro Shimoda
Date: Tue Sep 12 10:49:35 2023 +0900
net: renesas: rswitch: Fix unmasking irq condition
[ Upstream commit e7b1ef29420fe52c2c1a273a9b4b36103a522625 ]
Fix unmasking irq condition by using napi\_complete\_done(). Otherwise,
redundant interrupts happen.
Fixes: 3590918b5d07 ("net: ethernet: renesas: Add support for "Ethernet Switch"")
Signed-off-by: Yoshihiro Shimoda
Reviewed-by: Simon Horman
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 0e3ea7e82a06014b9baf1b84ba579c38cbff3558
Author: Corinna Vinschen
Date: Mon Sep 11 13:28:49 2023 -0700
igb: clean up in all error paths when enabling SR-IOV
[ Upstream commit bc6ed2fa24b14e40e1005488bbe11268ce7108fa ]
After commit 50f303496d92 ("igb: Enable SR-IOV after reinit"), removing
the igb module could hang or crash (depending on the machine) when the
module has been loaded with the max\_vfs parameter set to some value != 0.
In case of one test machine with a dual port 82580, this hang occurred:
[ 232.480687] igb 0000:41:00.1: removed PHC on enp65s0f1
[ 233.093257] igb 0000:41:00.1: IOV Disabled
[ 233.329969] pcieport 0000:40:01.0: AER: Multiple Uncorrected (Non-Fatal) err0
[ 233.340302] igb 0000:41:00.0: PCIe Bus Error: severity=Uncorrected (Non-Fata)
[ 233.352248] igb 0000:41:00.0: device [8086:1516] error status/mask=00100000
[ 233.361088] igb 0000:41:00.0: [20] UnsupReq (First)
[ 233.368183] igb 0000:41:00.0: AER: TLP Header: 40000001 0000040f cdbfc00c c
[ 233.376846] igb 0000:41:00.1: PCIe Bus Error: severity=Uncorrected (Non-Fata)
[ 233.388779] igb 0000:41:00.1: device [8086:1516] error status/mask=00100000
[ 233.397629] igb 0000:41:00.1: [20] UnsupReq (First)
[ 233.404736] igb 0000:41:00.1: AER: TLP Header: 40000001 0000040f cdbfc00c c
[ 233.538214] pci 0000:41:00.1: AER: can't recover (no error\_detected callback)
[ 233.538401] igb 0000:41:00.0: removed PHC on enp65s0f0
[ 233.546197] pcieport 0000:40:01.0: AER: device recovery failed
[ 234.157244] igb 0000:41:00.0: IOV Disabled
[ 371.619705] INFO: task irq/35-aerdrv:257 blocked for more than 122 seconds.
[ 371.627489] Not tainted 6.4.0-dirty #2
[ 371.632257] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this.
[ 371.641000] task:irq/35-aerdrv state:D stack:0 pid:257 ppid:2 f0
[ 371.650330] Call Trace:
[ 371.653061]
[ 371.655407] \_\_schedule+0x20e/0x660
[ 371.659313] schedule+0x5a/0xd0
[ 371.662824] schedule\_preempt\_disabled+0x11/0x20
[ 371.667983] \_\_mutex\_lock.constprop.0+0x372/0x6c0
[ 371.673237] ? \_\_pfx\_aer\_root\_reset+0x10/0x10
[ 371.678105] report\_error\_detected+0x25/0x1c0
[ 371.682974] ? \_\_pfx\_report\_normal\_detected+0x10/0x10
[ 371.688618] pci\_walk\_bus+0x72/0x90
[ 371.692519] pcie\_do\_recovery+0xb2/0x330
[ 371.696899] aer\_process\_err\_devices+0x117/0x170
[ 371.702055] aer\_isr+0x1c0/0x1e0
[ 371.705661] ? \_\_set\_cpus\_allowed\_ptr+0x54/0xa0
[ 371.710723] ? \_\_pfx\_irq\_thread\_fn+0x10/0x10
[ 371.715496] irq\_thread\_fn+0x20/0x60
[ 371.719491] irq\_thread+0xe6/0x1b0
[ 371.723291] ? \_\_pfx\_irq\_thread\_dtor+0x10/0x10
[ 371.728255] ? \_\_pfx\_irq\_thread+0x10/0x10
[ 371.732731] kthread+0xe2/0x110
[ 371.736243] ? \_\_pfx\_kthread+0x10/0x10
[ 371.740430] ret\_from\_fork+0x2c/0x50
[ 371.744428]
The reproducer was a simple script:
#!/bin/sh
for i in `seq 1 5`; do
modprobe -rv igb
modprobe -v igb max\_vfs=1
sleep 1
modprobe -rv igb
done
It turned out that this could only be reproduce on 82580 (quad and
dual-port), but not on 82576, i350 and i210. Further debugging showed
that igb\_enable\_sriov()'s call to pci\_enable\_sriov() is failing, because
dev->is\_physfn is 0 on 82580.
Prior to commit 50f303496d92 ("igb: Enable SR-IOV after reinit"),
igb\_enable\_sriov() jumped into the "err\_out" cleanup branch. After this
commit it only returned the error code.
So the cleanup didn't take place, and the incorrect VF setup in the
igb\_adapter structure fooled the igb driver into assuming that VFs have
been set up where no VF actually existed.
Fix this problem by cleaning up again if pci\_enable\_sriov() fails.
Fixes: 50f303496d92 ("igb: Enable SR-IOV after reinit")
Signed-off-by: Corinna Vinschen
Reviewed-by: Akihiko Odaki
Tested-by: Rafal Romanowski
Signed-off-by: Tony Nguyen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 849b9fb734577e996d32cc3b11d1af739ce09249
Author: Vadim Fedorenko
Date: Mon Sep 11 13:28:14 2023 -0700
ixgbe: fix timestamp configuration code
[ Upstream commit 3c44191dd76cf9c0cc49adaf34384cbd42ef8ad2 ]
The commit in fixes introduced flags to control the status of hardware
configuration while processing packets. At the same time another structure
is used to provide configuration of timestamper to user-space applications.
The way it was coded makes this structures go out of sync easily. The
repro is easy for 82599 chips:
[root@hostname ~]# hwstamp\_ctl -i eth0 -r 12 -t 1
current settings:
tx\_type 0
rx\_filter 0
new settings:
tx\_type 1
rx\_filter 12
The eth0 device is properly configured to timestamp any PTPv2 events.
[root@hostname ~]# hwstamp\_ctl -i eth0 -r 1 -t 1
current settings:
tx\_type 1
rx\_filter 12
SIOCSHWTSTAMP failed: Numerical result out of range
The requested time stamping mode is not supported by the hardware.
The error is properly returned because HW doesn't support all packets
timestamping. But the adapter->flags is cleared of timestamp flags
even though no HW configuration was done. From that point no RX timestamps
are received by user-space application. But configuration shows good
values:
[root@hostname ~]# hwstamp\_ctl -i eth0
current settings:
tx\_type 1
rx\_filter 12
Fix the issue by applying new flags only when the HW was actually
configured.
Fixes: a9763f3cb54c ("ixgbe: Update PTP to support X550EM\_x devices")
Signed-off-by: Vadim Fedorenko
Reviewed-by: Simon Horman
Tested-by: Pucha Himasekhar Reddy  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 591d4ca76dd239ff53617ee1828d712adea85277
Author: Kuniyuki Iwashima
Date: Mon Sep 11 11:36:58 2023 -0700
selftest: tcp: Fix address length in bind\_wildcard.c.
[ Upstream commit 0071d15517b4a3d265abc00395beb1138e7236c7 ]
The selftest passes the IPv6 address length for an IPv4 address.
We should pass the correct length.
Note inet\_bind\_sk() does not check if the size is larger than
sizeof(struct sockaddr\_in), so there is no real bug in this
selftest.
Fixes: 13715acf8ab5 ("selftest: Add test for bind() conflicts.")
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 25c757e451c1fa957178508417282dc5bf35442c
Author: Kuniyuki Iwashima
Date: Mon Sep 11 11:36:57 2023 -0700
tcp: Fix bind() regression for v4-mapped-v6 non-wildcard address.
[ Upstream commit c48ef9c4aed3632566b57ba66cec6ec78624d4cb ]
Since bhash2 was introduced, the example below does not work as expected.
These two bind() should conflict, but the 2nd bind() now succeeds.
from socket import \*
s1 = socket(AF\_INET6, SOCK\_STREAM)
s1.bind(('::ffff:127.0.0.1', 0))
s2 = socket(AF\_INET, SOCK\_STREAM)
s2.bind(('127.0.0.1', s1.getsockname()[1]))
During the 2nd bind() in inet\_csk\_get\_port(), inet\_bind2\_bucket\_find()
fails to find the 1st socket's tb2, so inet\_bind2\_bucket\_create() allocates
a new tb2 for the 2nd socket. Then, we call inet\_csk\_bind\_conflict() that
checks conflicts in the new tb2 by inet\_bhash2\_conflict(). However, the
new tb2 does not include the 1st socket, thus the bind() finally succeeds.
In this case, inet\_bind2\_bucket\_match() must check if AF\_INET6 tb2 has
the conflicting v4-mapped-v6 address so that inet\_bind2\_bucket\_find()
returns the 1st socket's tb2.
Note that if we bind two sockets to 127.0.0.1 and then ::FFFF:127.0.0.1,
the 2nd bind() fails properly for the same reason mentinoed in the previous
commit.
Fixes: 28044fc1d495 ("net: Add a bhash2 table hashed by port and address")
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Acked-by: Andrei Vagin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3a548ad0e346806b0912ea6b3f66e443c168f426
Author: Kuniyuki Iwashima
Date: Mon Sep 11 11:36:56 2023 -0700
tcp: Fix bind() regression for v4-mapped-v6 wildcard address.
[ Upstream commit aa99e5f87bd54db55dd37cb130bd5eb55933027f ]
Andrei Vagin reported bind() regression with strace logs.
If we bind() a TCPv6 socket to ::FFFF:0.0.0.0 and then bind() a TCPv4
socket to 127.0.0.1, the 2nd bind() should fail but now succeeds.
from socket import \*
s1 = socket(AF\_INET6, SOCK\_STREAM)
s1.bind(('::ffff:0.0.0.0', 0))
s2 = socket(AF\_INET, SOCK\_STREAM)
s2.bind(('127.0.0.1', s1.getsockname()[1]))
During the 2nd bind(), if tb->family is AF\_INET6 and sk->sk\_family is
AF\_INET in inet\_bind2\_bucket\_match\_addr\_any(), we still need to check
if tb has the v4-mapped-v6 wildcard address.
The example above does not work after commit 5456262d2baa ("net: Fix
incorrect address comparison when searching for a bind2 bucket"), but
the blamed change is not the commit.
Before the commit, the leading zeros of ::FFFF:0.0.0.0 were treated
as 0.0.0.0, and the sequence above worked by chance. Technically, this
case has been broken since bhash2 was introduced.
Note that if we bind() two sockets to 127.0.0.1 and then ::FFFF:0.0.0.0,
the 2nd bind() fails properly because we fall back to using bhash to
detect conflicts for the v4-mapped-v6 address.
Fixes: 28044fc1d495 ("net: Add a bhash2 table hashed by port and address")
Reported-by: Andrei Vagin
Closes: https://lore.kernel.org/netdev/ZPuYBOFC8zsK6r9T@google.com/
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1f97354c16efc94853f563e972a5b7dd334c71fa
Author: Kuniyuki Iwashima
Date: Mon Sep 11 11:36:55 2023 -0700
tcp: Factorise sk\_family-independent comparison in inet\_bind2\_bucket\_match(\_addr\_any).
[ Upstream commit c6d277064b1da7f9015b575a562734de87a7e463 ]
This is a prep patch to make the following patches cleaner that touch
inet\_bind2\_bucket\_match() and inet\_bind2\_bucket\_match\_addr\_any().
Both functions have duplicated comparison for netns, port, and l3mdev.
Let's factorise them.
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Stable-dep-of: aa99e5f87bd5 ("tcp: Fix bind() regression for v4-mapped-v6 wildcard address.")
Signed-off-by: Sasha Levin
commit 7a811588048450e022ffcd3589e03c0a7574bb88
Author: Eric Dumazet
Date: Mon Sep 11 15:42:13 2023 +0000
ipv6: fix ip6\_sock\_set\_addr\_preferences() typo
[ Upstream commit 8cdd9f1aaedf823006449faa4e540026c692ac43 ]
ip6\_sock\_set\_addr\_preferences() second argument should be an integer.
SUNRPC attempts to set IPV6\_PREFER\_SRC\_PUBLIC were
translated to IPV6\_PREFER\_SRC\_TMP
Fixes: 18d5ad623275 ("ipv6: add ip6\_sock\_set\_addr\_preferences")
Signed-off-by: Eric Dumazet
Cc: Christoph Hellwig
Cc: Chuck Lever
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230911154213.713941-1-edumazet@google.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit d1cf87594991845b58db6dc5347bc233f6f7c7f2
Author: Toke Høiland-Jørgensen
Date: Mon Sep 11 15:58:25 2023 +0200
veth: Update XDP feature set when bringing up device
[ Upstream commit 7a6102aa6df0d5d032b4cbc51935d1d4cda17254 ]
There's an early return in veth\_set\_features() if the device is in a down
state, which leads to the XDP feature flags not being updated when enabling
GRO while the device is down. Which in turn leads to XDP\_REDIRECT not
working, because the redirect code now checks the flags.
Fix this by updating the feature flags after bringing the device up.
Before this patch:
NETDEV\_XDP\_ACT\_BASIC: yes
NETDEV\_XDP\_ACT\_REDIRECT: yes
NETDEV\_XDP\_ACT\_NDO\_XMIT: no
NETDEV\_XDP\_ACT\_XSK\_ZEROCOPY: no
NETDEV\_XDP\_ACT\_HW\_OFFLOAD: no
NETDEV\_XDP\_ACT\_RX\_SG: yes
NETDEV\_XDP\_ACT\_NDO\_XMIT\_SG: no
After this patch:
NETDEV\_XDP\_ACT\_BASIC: yes
NETDEV\_XDP\_ACT\_REDIRECT: yes
NETDEV\_XDP\_ACT\_NDO\_XMIT: yes
NETDEV\_XDP\_ACT\_XSK\_ZEROCOPY: no
NETDEV\_XDP\_ACT\_HW\_OFFLOAD: no
NETDEV\_XDP\_ACT\_RX\_SG: yes
NETDEV\_XDP\_ACT\_NDO\_XMIT\_SG: yes
Fixes: fccca038f300 ("veth: take into account device reconfiguration for xdp\_features flag")
Fixes: 66c0e13ad236 ("drivers: net: turn on XDP features")
Signed-off-by: Toke Høiland-Jørgensen
Link: https://lore.kernel.org/r/20230911135826.722295-1-toke@redhat.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 1252572fea95161528b932193c7ddd0ab123ffc6
Author: Sascha Hauer
Date: Fri Sep 8 13:29:13 2023 +0200
net: macb: fix sleep inside spinlock
[ Upstream commit 403f0e771457e2b8811dc280719d11b9bacf10f4 ]
macb\_set\_tx\_clk() is called under a spinlock but itself calls clk\_set\_rate()
which can sleep. This results in:
| BUG: sleeping function called from invalid context at kernel/locking/mutex.c:580
| pps pps1: new PPS source ptp1
| in\_atomic(): 1, irqs\_disabled(): 1, non\_block: 0, pid: 40, name: kworker/u4:3
| preempt\_count: 1, expected: 0
| RCU nest depth: 0, expected: 0
| 4 locks held by kworker/u4:3/40:
| #0: ffff000003409148
| macb ff0c0000.ethernet: gem-ptp-timer ptp clock registered.
| ((wq\_completion)events\_power\_efficient){+.+.}-{0:0}, at: process\_one\_work+0x14c/0x51c
| #1: ffff8000833cbdd8 ((work\_completion)(&pl->resolve)){+.+.}-{0:0}, at: process\_one\_work+0x14c/0x51c
| #2: ffff000004f01578 (&pl->state\_mutex){+.+.}-{4:4}, at: phylink\_resolve+0x44/0x4e8
| #3: ffff000004f06f50 (&bp->lock){....}-{3:3}, at: macb\_mac\_link\_up+0x40/0x2ac
| irq event stamp: 113998
| hardirqs last enabled at (113997): [] \_raw\_spin\_unlock\_irq+0x30/0x64
| hardirqs last disabled at (113998): [] \_raw\_spin\_lock\_irqsave+0xac/0xc8
| softirqs last enabled at (113608): [] \_\_do\_softirq+0x430/0x4e4
| softirqs last disabled at (113597): [] \_\_\_\_do\_softirq+0x10/0x1c
| CPU: 0 PID: 40 Comm: kworker/u4:3 Not tainted 6.5.0-11717-g9355ce8b2f50-dirty #368
| Hardware name: ... ZynqMP ... (DT)
| Workqueue: events\_power\_efficient phylink\_resolve
| Call trace:
| dump\_backtrace+0x98/0xf0
| show\_stack+0x18/0x24
| dump\_stack\_lvl+0x60/0xac
| dump\_stack+0x18/0x24
| \_\_might\_resched+0x144/0x24c
| \_\_might\_sleep+0x48/0x98
| \_\_mutex\_lock+0x58/0x7b0
| mutex\_lock\_nested+0x24/0x30
| clk\_prepare\_lock+0x4c/0xa8
| clk\_set\_rate+0x24/0x8c
| macb\_mac\_link\_up+0x25c/0x2ac
| phylink\_resolve+0x178/0x4e8
| process\_one\_work+0x1ec/0x51c
| worker\_thread+0x1ec/0x3e4
| kthread+0x120/0x124
| ret\_from\_fork+0x10/0x20
The obvious fix is to move the call to macb\_set\_tx\_clk() out of the
protected area. This seems safe as rx and tx are both disabled anyway at
this point.
It is however not entirely clear what the spinlock shall protect. It
could be the read-modify-write access to the NCFGR register, but this
is accessed in macb\_set\_rx\_mode() and macb\_set\_rxcsum\_feature() as well
without holding the spinlock. It could also be the register accesses
done in mog\_init\_rings() or macb\_init\_buffers(), but again these
functions are called without holding the spinlock in macb\_hresp\_error\_task().
The locking seems fishy in this driver and it might deserve another look
before this patch is applied.
Fixes: 633e98a711ac0 ("net: macb: use resolved link config in mac\_link\_up()")
Signed-off-by: Sascha Hauer
Link: https://lore.kernel.org/r/20230908112913.1701766-1-s.hauer@pengutronix.de
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 74aecad5da19004ccf6321fd397d14b10756622a
Author: Liu Jian
Date: Sat Sep 9 16:14:34 2023 +0800
net/tls: do not free tls\_rec on async operation in bpf\_exec\_tx\_verdict()
[ Upstream commit cfaa80c91f6f99b9342b6557f0f0e1143e434066 ]
I got the below warning when do fuzzing test:
BUG: KASAN: null-ptr-deref in scatterwalk\_copychunks+0x320/0x470
Read of size 4 at addr 0000000000000008 by task kworker/u8:1/9
CPU: 0 PID: 9 Comm: kworker/u8:1 Tainted: G OE
Hardware name: linux,dummy-virt (DT)
Workqueue: pencrypt\_parallel padata\_parallel\_worker
Call trace:
dump\_backtrace+0x0/0x420
show\_stack+0x34/0x44
dump\_stack+0x1d0/0x248
\_\_kasan\_report+0x138/0x140
kasan\_report+0x44/0x6c
\_\_asan\_load4+0x94/0xd0
scatterwalk\_copychunks+0x320/0x470
skcipher\_next\_slow+0x14c/0x290
skcipher\_walk\_next+0x2fc/0x480
skcipher\_walk\_first+0x9c/0x110
skcipher\_walk\_aead\_common+0x380/0x440
skcipher\_walk\_aead\_encrypt+0x54/0x70
ccm\_encrypt+0x13c/0x4d0
crypto\_aead\_encrypt+0x7c/0xfc
pcrypt\_aead\_enc+0x28/0x84
padata\_parallel\_worker+0xd0/0x2dc
process\_one\_work+0x49c/0xbdc
worker\_thread+0x124/0x880
kthread+0x210/0x260
ret\_from\_fork+0x10/0x18
This is because the value of rec\_seq of tls\_crypto\_info configured by the
user program is too large, for example, 0xffffffffffffff. In addition, TLS
is asynchronously accelerated. When tls\_do\_encryption() returns
-EINPROGRESS and sk->sk\_err is set to EBADMSG due to rec\_seq overflow,
skmsg is released before the asynchronous encryption process ends. As a
result, the UAF problem occurs during the asynchronous processing of the
encryption module.
If the operation is asynchronous and the encryption module returns
EINPROGRESS, do not free the record information.
Fixes: 635d93981786 ("net/tls: free record only on encryption error")
Signed-off-by: Liu Jian
Reviewed-by: Sabrina Dubroca
Link: https://lore.kernel.org/r/20230909081434.2324940-1-liujian56@huawei.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 85ad4eede956b3182e079390930e54b507a659c3
Author: Geert Uytterhoeven
Date: Mon Sep 4 14:00:35 2023 +0200
platform/mellanox: NVSW\_SN2201 should depend on ACPI
[ Upstream commit 0a138f1670bd1af13ba6949c48ea86ddd4bf557e ]
The only probing method supported by the Nvidia SN2201 platform driver
is probing through an ACPI match table. Hence add a dependency on
ACPI, to prevent asking the user about this driver when configuring a
kernel without ACPI support.
Fixes: 662f24826f95 ("platform/mellanox: Add support for new SN2201 system")
Signed-off-by: Geert Uytterhoeven
Acked-by: Vadim Pasternak
Acked-by: Andi Shyti
Link: https://lore.kernel.org/r/ec5a4071691ab08d58771b7732a9988e89779268.1693828363.git.geert+renesas@glider.be
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit d65f117e2ed4f4062a2f9702de9dec161159f6ed
Author: Shravan Kumar Ramani
Date: Tue Sep 5 08:49:33 2023 -0400
platform/mellanox: mlxbf-pmc: Fix reading of unprogrammed events
[ Upstream commit 0f5969452e162efc50bdc98968fb62b424a9874b ]
This fix involves 2 changes:
- All event regs have a reset value of 0, which is not a valid
event\_number as per the event\_list for most blocks and hence seen
as an error. Add a "disable" event with event\_number 0 for all blocks.
- The enable bit for each counter need not be checked before
reading the event info, and hence removed.
Fixes: 1a218d312e65 ("platform/mellanox: mlxbf-pmc: Add Mellanox BlueField PMC driver")
Signed-off-by: Shravan Kumar Ramani
Reviewed-by: Vadim Pasternak
Reviewed-by: David Thompson
Link: https://lore.kernel.org/r/04d0213932d32681de1c716b54320ed894e52425.1693917738.git.shravankr@nvidia.com
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 8748f70981ac2924beb04e3c1442f851e0e24029
Author: Shravan Kumar Ramani
Date: Tue Sep 5 08:49:32 2023 -0400
platform/mellanox: mlxbf-pmc: Fix potential buffer overflows
[ Upstream commit 80ccd40568bcd3655b0fd0be1e9b3379fd6e1056 ]
Replace sprintf with sysfs\_emit where possible.
Size check in mlxbf\_pmc\_event\_list\_show should account for "\0".
Fixes: 1a218d312e65 ("platform/mellanox: mlxbf-pmc: Add Mellanox BlueField PMC driver")
Signed-off-by: Shravan Kumar Ramani
Reviewed-by: Vadim Pasternak
Reviewed-by: David Thompson
Link: https://lore.kernel.org/r/bef39ef32319a31b32f999065911f61b0d3b17c3.1693917738.git.shravankr@nvidia.com
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 23a9a765ba5e5149454aaf73142b666afec1e920
Author: Liming Sun
Date: Tue Aug 29 13:43:00 2023 -0400
platform/mellanox: mlxbf-tmfifo: Drop jumbo frames
[ Upstream commit fc4c655821546239abb3cf4274d66b9747aa87dd ]
This commit drops over-sized network packets to avoid tmfifo
queue stuck.
Fixes: 1357dfd7261f ("platform/mellanox: Add TmFifo driver for Mellanox BlueField Soc")
Signed-off-by: Liming Sun
Reviewed-by: Vadim Pasternak
Reviewed-by: David Thompson
Link: https://lore.kernel.org/r/9318936c2447f76db475c985ca6d91f057efcd41.1693322547.git.limings@nvidia.com
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 8efa4d5833b756946aff51d2c6eb3af609a2d9b1
Author: Liming Sun
Date: Tue Aug 29 13:42:59 2023 -0400
platform/mellanox: mlxbf-tmfifo: Drop the Rx packet if no more descriptors
[ Upstream commit 78034cbece79c2d730ad0770b3b7f23eedbbecf5 ]
This commit fixes tmfifo console stuck issue when the virtual
networking interface is in down state. In such case, the network
Rx descriptors runs out and causes the Rx network packet staying
in the head of the tmfifo thus blocking the console packets. The
fix is to drop the Rx network packet when no more Rx descriptors.
Function name mlxbf\_tmfifo\_release\_pending\_pkt() is also renamed
to mlxbf\_tmfifo\_release\_pkt() to be more approperiate.
Fixes: 1357dfd7261f ("platform/mellanox: Add TmFifo driver for Mellanox BlueField Soc")
Signed-off-by: Liming Sun
Reviewed-by: Vadim Pasternak
Reviewed-by: David Thompson
Link: https://lore.kernel.org/r/8c0177dc938ae03f52ff7e0b62dbeee74b7bec09.1693322547.git.limings@nvidia.com
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit af8085e0fc3207ecbf8b9e7a635c790e36d058c6
Author: Shigeru Yoshida
Date: Sun Sep 10 02:03:10 2023 +0900
kcm: Fix memory leak in error path of kcm\_sendmsg()
[ Upstream commit c821a88bd720b0046433173185fd841a100d44ad ]
syzbot reported a memory leak like below:
BUG: memory leak
unreferenced object 0xffff88810b088c00 (size 240):
comm "syz-executor186", pid 5012, jiffies 4294943306 (age 13.680s)
hex dump (first 32 bytes):
00 89 08 0b 81 88 ff ff 00 00 00 00 00 00 00 00 ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
backtrace:
[] \_\_alloc\_skb+0x1ef/0x230 net/core/skbuff.c:634
[] alloc\_skb include/linux/skbuff.h:1289 [inline]
[] kcm\_sendmsg+0x269/0x1050 net/kcm/kcmsock.c:815
[] sock\_sendmsg\_nosec net/socket.c:725 [inline]
[] sock\_sendmsg+0x56/0xb0 net/socket.c:748
[] \_\_\_\_sys\_sendmsg+0x365/0x470 net/socket.c:2494
[] \_\_\_sys\_sendmsg+0xc9/0x130 net/socket.c:2548
[] \_\_sys\_sendmsg+0xa6/0x120 net/socket.c:2577
[] do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
[] do\_syscall\_64+0x38/0xb0 arch/x86/entry/common.c:80
[] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
In kcm\_sendmsg(), kcm\_tx\_msg(head)->last\_skb is used as a cursor to append
newly allocated skbs to 'head'. If some bytes are copied, an error occurred,
and jumped to out\_error label, 'last\_skb' is left unmodified. A later
kcm\_sendmsg() will use an obsoleted 'last\_skb' reference, corrupting the
'head' frag\_list and causing the leak.
This patch fixes this issue by properly updating the last allocated skb in
'last\_skb'.
Fixes: ab7ac4eb9832 ("kcm: Kernel Connection Multiplexor module")
Reported-and-tested-by: syzbot+6f98de741f7dbbfc4ccb@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=6f98de741f7dbbfc4ccb
Signed-off-by: Shigeru Yoshida
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e552933d024299a44d7afe01caa37ffd7cabaaab
Author: Hayes Wang
Date: Fri Sep 8 15:01:52 2023 +0800
r8152: check budget for r8152\_poll()
[ Upstream commit a7b8d60b37237680009dd0b025fe8c067aba0ee3 ]
According to the document of napi, there is no rx process when the
budget is 0. Therefore, r8152\_poll() has to return 0 directly when the
budget is equal to 0.
Fixes: d2187f8e4454 ("r8152: divide the tx and rx bottom functions")
Signed-off-by: Hayes Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 271e48ec78bcfed9d6c3f59f78ee51fb2ef42ee2
Author: Vladimir Oltean
Date: Fri Sep 8 16:33:52 2023 +0300
net: dsa: sja1105: block FDB accesses that are concurrent with a switch reset
[ Upstream commit 86899e9e1e29e854b5f6dcc24ba4f75f792c89aa ]
Currently, when we add the first sja1105 port to a bridge with
vlan\_filtering 1, then we sometimes see this output:
sja1105 spi2.2: port 4 failed to read back entry for be:79:b4:9e:9e:96 vid 3088: -ENOENT
sja1105 spi2.2: Reset switch and programmed static config. Reason: VLAN filtering
sja1105 spi2.2: port 0 failed to add be:79:b4:9e:9e:96 vid 0 to fdb: -2
It is because sja1105\_fdb\_add() runs from the dsa\_owq which is no longer
serialized with switch resets since it dropped the rtnl\_lock() in the
blamed commit.
Either performing the FDB accesses before the reset, or after the reset,
is equally fine, because sja1105\_static\_fdb\_change() backs up those
changes in the static config, but FDB access during reset isn't ok.
Make sja1105\_static\_config\_reload() take the fdb\_lock to fix that.
Fixes: 0faf890fc519 ("net: dsa: drop rtnl\_lock from dsa\_slave\_switchdev\_event\_work")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 2e52d6f9c651be854fe53b641e45f78fc9d1fec7
Author: Vladimir Oltean
Date: Fri Sep 8 16:33:51 2023 +0300
net: dsa: sja1105: serialize sja1105\_port\_mcast\_flood() with other FDB accesses
[ Upstream commit ea32690daf4fa525dc5a4d164bd00ed8c756e1c6 ]
sja1105\_fdb\_add() runs from the dsa\_owq, and sja1105\_port\_mcast\_flood()
runs from switchdev\_deferred\_process\_work(). Prior to the blamed commit,
they used to be indirectly serialized through the rtnl\_lock(), which
no longer holds true because dsa\_owq dropped that.
So, it is now possible that we traverse the static config BLK\_IDX\_L2\_LOOKUP
elements concurrently compared to when we change them, in
sja1105\_static\_fdb\_change(). That is not ideal, since it might result in
data corruption.
Introduce a mutex which serializes accesses to the hardware FDB and to
the static config elements for the L2 Address Lookup table.
I can't find a good reason to add locking around sja1105\_fdb\_dump().
I'll add it later if needed.
Fixes: 0faf890fc519 ("net: dsa: drop rtnl\_lock from dsa\_slave\_switchdev\_event\_work")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ae3f25142a0c8d7f30cb1b43b34b62442d993c13
Author: Vladimir Oltean
Date: Fri Sep 8 16:33:50 2023 +0300
net: dsa: sja1105: fix multicast forwarding working only for last added mdb entry
[ Upstream commit 7cef293b9a634a05fcce9e1df4aee3aeed023345 ]
The commit cited in Fixes: did 2 things: it refactored the read-back
polling from sja1105\_dynamic\_config\_read() into a new function,
sja1105\_dynamic\_config\_wait\_complete(), and it called that from
sja1105\_dynamic\_config\_write() too.
What is problematic is the refactoring.
The refactored code from sja1105\_dynamic\_config\_poll\_valid() works like
the previous one, but the problem is that it uses another packed\_buf[]
SPI buffer, and there was code at the end of sja1105\_dynamic\_config\_read()
which was relying on the read-back packed\_buf[]:
/\* Don't dereference possibly NULL pointer - maybe caller
\* only wanted to see whether the entry existed or not.
\*/
if (entry)
ops->entry\_packing(packed\_buf, entry, UNPACK);
After the change, the packed\_buf[] that this code sees is no longer the
entry read back from hardware, but the original entry that the caller
passed to the sja1105\_dynamic\_config\_read(), packed into this buffer.
This difference is the most notable with the SJA1105\_SEARCH uses from
sja1105pqrs\_fdb\_add() - used for both fdb and mdb. There, we have logic
added by commit 728db843df88 ("net: dsa: sja1105: ignore the FDB entry
for unknown multicast when adding a new address") to figure out whether
the address we're trying to add matches on any existing hardware entry,
with the exception of the catch-all multicast address.
That logic was broken, because with sja1105\_dynamic\_config\_read() not
working properly, it doesn't return us the entry read back from
hardware, but the entry that we passed to it. And, since for multicast,
a match will always exist, it will tell us that any mdb entry already
exists at index=0 L2 Address Lookup table. It is index=0 because the
caller doesn't know the index - it wants to find it out, and
sja1105\_dynamic\_config\_read() does:
if (index < 0) { // SJA1105\_SEARCH
/\* Avoid copying a signed negative number to an u64 \*/
cmd.index = 0; // <- this
cmd.search = true;
} else {
cmd.index = index;
cmd.search = false;
}
So, to the caller of sja1105\_dynamic\_config\_read(), the returned info
looks entirely legit, and it will add all mdb entries to FDB index 0.
There, they will always overwrite each other (not to mention,
potentially they can also overwrite a pre-existing bridge fdb entry),
and the user-visible impact will be that only the last mdb entry will be
forwarded as it should. The others won't (will be flooded or dropped,
depending on the egress flood settings).
Fixing is a bit more complicated, and involves either passing the same
packed\_buf[] to sja1105\_dynamic\_config\_wait\_complete(), or moving all
the extra processing on the packed\_buf[] to
sja1105\_dynamic\_config\_wait\_complete(). I've opted for the latter,
because it makes sja1105\_dynamic\_config\_wait\_complete() a bit more
self-contained.
Fixes: df405910ab9f ("net: dsa: sja1105: wait for dynamic config command completion on writes too")
Reported-by: Yanan Yang
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ca8e7b32bf2658f534e59eebeab49e85c88ad33f
Author: Vladimir Oltean
Date: Fri Sep 8 16:33:49 2023 +0300
net: dsa: sja1105: propagate exact error code from sja1105\_dynamic\_config\_poll\_valid()
[ Upstream commit c956798062b5a308db96e75157747291197f0378 ]
Currently, sja1105\_dynamic\_config\_wait\_complete() returns either 0 or
-ETIMEDOUT, because it just looks at the read\_poll\_timeout() return code.
There will be future changes which move some more checks to
sja1105\_dynamic\_config\_poll\_valid(). It is important that we propagate
their exact return code (-ENOENT, -EINVAL), because callers of
sja1105\_dynamic\_config\_read() depend on them.
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Stable-dep-of: 7cef293b9a63 ("net: dsa: sja1105: fix multicast forwarding working only for last added mdb entry")
Signed-off-by: Sasha Levin
commit 314b9eef8408a3b6c32f4de553d65582e28b0d4b
Author: Vladimir Oltean
Date: Fri Sep 8 16:33:48 2023 +0300
net: dsa: sja1105: hide all multicast addresses from "bridge fdb show"
[ Upstream commit 02c652f5465011126152bbd93b6a582a1d0c32f1 ]
Commit 4d9423549501 ("net: dsa: sja1105: offload bridge port flags to
device") has partially hidden some multicast entries from showing up in
the "bridge fdb show" output, but it wasn't enough. Addresses which are
added through "bridge mdb add" still show up. Hide them all.
Fixes: 291d1e72b756 ("net: dsa: sja1105: Add support for FDB and MDB management")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 93546f928ab6768ec1d77f88e66af90322338f92
Author: Ciprian Regus
Date: Fri Sep 8 15:58:08 2023 +0300
net:ethernet:adi:adin1110: Fix forwarding offload
[ Upstream commit 32530dba1bd48da4437d18d9a8dbc9d2826938a6 ]
Currently, when a new fdb entry is added (with both ports of the
ADIN2111 bridged), the driver configures the MAC filters for the wrong
port, which results in the forwarding being done by the host, and not
actually hardware offloaded.
The ADIN2111 offloads the forwarding by setting filters on the
destination MAC address of incoming frames. Based on these, they may be
routed to the other port. Thus, if a frame has to be forwarded from port
1 to port 2, the required configuration for the ADDR\_FILT\_UPRn register
should set the APPLY2PORT1 bit (instead of APPLY2PORT2, as it's
currently the case).
Fixes: bc93e19d088b ("net: ethernet: adi: Add ADIN1110 support")
Signed-off-by: Ciprian Regus
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 499d86b62723207d2cef19e9c6796c1d0970c575
Author: Yang Yingliang
Date: Fri Aug 4 17:35:31 2023 +0800
net: ethernet: adi: adin1110: use eth\_broadcast\_addr() to assign broadcast address
[ Upstream commit 54024dbec95585243391caeb9f04a2620e630765 ]
Use eth\_broadcast\_addr() to assign broadcast address instead
of memset().
Signed-off-by: Yang Yingliang
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Stable-dep-of: 32530dba1bd4 ("net:ethernet:adi:adin1110: Fix forwarding offload")
Signed-off-by: Sasha Levin
commit ed7a0ba7e840dc5d54cdbd8466be27e6aedce1e5
Author: Ziyang Xuan
Date: Fri Sep 8 18:17:52 2023 +0800
hsr: Fix uninit-value access in fill\_frame\_info()
[ Upstream commit 484b4833c604c0adcf19eac1ca14b60b757355b5 ]
Syzbot reports the following uninit-value access problem.
=====================================================
BUG: KMSAN: uninit-value in fill\_frame\_info net/hsr/hsr\_forward.c:601 [inline]
BUG: KMSAN: uninit-value in hsr\_forward\_skb+0x9bd/0x30f0 net/hsr/hsr\_forward.c:616
fill\_frame\_info net/hsr/hsr\_forward.c:601 [inline]
hsr\_forward\_skb+0x9bd/0x30f0 net/hsr/hsr\_forward.c:616
hsr\_dev\_xmit+0x192/0x330 net/hsr/hsr\_device.c:223
\_\_netdev\_start\_xmit include/linux/netdevice.h:4889 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4903 [inline]
xmit\_one net/core/dev.c:3544 [inline]
dev\_hard\_start\_xmit+0x247/0xa10 net/core/dev.c:3560
\_\_dev\_queue\_xmit+0x34d0/0x52a0 net/core/dev.c:4340
dev\_queue\_xmit include/linux/netdevice.h:3082 [inline]
packet\_xmit+0x9c/0x6b0 net/packet/af\_packet.c:276
packet\_snd net/packet/af\_packet.c:3087 [inline]
packet\_sendmsg+0x8b1d/0x9f30 net/packet/af\_packet.c:3119
sock\_sendmsg\_nosec net/socket.c:730 [inline]
sock\_sendmsg net/socket.c:753 [inline]
\_\_sys\_sendto+0x781/0xa30 net/socket.c:2176
\_\_do\_sys\_sendto net/socket.c:2188 [inline]
\_\_se\_sys\_sendto net/socket.c:2184 [inline]
\_\_ia32\_sys\_sendto+0x11f/0x1c0 net/socket.c:2184
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:112 [inline]
\_\_do\_fast\_syscall\_32+0xa2/0x100 arch/x86/entry/common.c:178
do\_fast\_syscall\_32+0x37/0x80 arch/x86/entry/common.c:203
do\_SYSENTER\_32+0x1f/0x30 arch/x86/entry/common.c:246
entry\_SYSENTER\_compat\_after\_hwframe+0x70/0x82
Uninit was created at:
slab\_post\_alloc\_hook+0x12f/0xb70 mm/slab.h:767
slab\_alloc\_node mm/slub.c:3478 [inline]
kmem\_cache\_alloc\_node+0x577/0xa80 mm/slub.c:3523
kmalloc\_reserve+0x148/0x470 net/core/skbuff.c:559
\_\_alloc\_skb+0x318/0x740 net/core/skbuff.c:644
alloc\_skb include/linux/skbuff.h:1286 [inline]
alloc\_skb\_with\_frags+0xc8/0xbd0 net/core/skbuff.c:6299
sock\_alloc\_send\_pskb+0xa80/0xbf0 net/core/sock.c:2794
packet\_alloc\_skb net/packet/af\_packet.c:2936 [inline]
packet\_snd net/packet/af\_packet.c:3030 [inline]
packet\_sendmsg+0x70e8/0x9f30 net/packet/af\_packet.c:3119
sock\_sendmsg\_nosec net/socket.c:730 [inline]
sock\_sendmsg net/socket.c:753 [inline]
\_\_sys\_sendto+0x781/0xa30 net/socket.c:2176
\_\_do\_sys\_sendto net/socket.c:2188 [inline]
\_\_se\_sys\_sendto net/socket.c:2184 [inline]
\_\_ia32\_sys\_sendto+0x11f/0x1c0 net/socket.c:2184
do\_syscall\_32\_irqs\_on arch/x86/entry/common.c:112 [inline]
\_\_do\_fast\_syscall\_32+0xa2/0x100 arch/x86/entry/common.c:178
do\_fast\_syscall\_32+0x37/0x80 arch/x86/entry/common.c:203
do\_SYSENTER\_32+0x1f/0x30 arch/x86/entry/common.c:246
entry\_SYSENTER\_compat\_after\_hwframe+0x70/0x82
It is because VLAN not yet supported in hsr driver. Return error
when protocol is ETH\_P\_8021Q in fill\_frame\_info() now to fix it.
Fixes: 451d8123f897 ("net: prp: add packet handling support")
Reported-by: syzbot+bf7e6250c7ce248f3ec9@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=bf7e6250c7ce248f3ec9
Signed-off-by: Ziyang Xuan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fe0195fe48f85182bc7e7eabcad925bd3cbc10f5
Author: Hangyu Hua
Date: Fri Sep 8 14:19:50 2023 +0800
net: ethernet: mtk\_eth\_soc: fix possible NULL pointer dereference in mtk\_hwlro\_get\_fdir\_all()
[ Upstream commit e4c79810755f66c9a933ca810da2724133b1165a ]
rule\_locs is allocated in ethtool\_get\_rxnfc and the size is determined by
rule\_cnt from user space. So rule\_cnt needs to be check before using
rule\_locs to avoid NULL pointer dereference.
Fixes: 7aab747e5563 ("net: ethernet: mediatek: add ethtool functions to configure RX flows of HW LRO")
Signed-off-by: Hangyu Hua
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 625b70d31dd4df4b96b3ddcbe251debb33bd67f5
Author: Hangyu Hua
Date: Fri Sep 8 14:19:49 2023 +0800
net: ethernet: mvpp2\_main: fix possible OOB write in mvpp2\_ethtool\_get\_rxnfc()
[ Upstream commit 51fe0a470543f345e3c62b6798929de3ddcedc1d ]
rules is allocated in ethtool\_get\_rxnfc and the size is determined by
rule\_cnt from user space. So rule\_cnt needs to be check before using
rules to avoid OOB writing or NULL pointer dereference.
Fixes: 90b509b39ac9 ("net: mvpp2: cls: Add Classification offload support")
Signed-off-by: Hangyu Hua
Reviewed-by: Marcin Wojtas
Reviewed-by: Russell King (Oracle)
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit adfbdc712f75efcd6c508a359bfc15e50eea000e
Author: Vincent Whitchurch
Date: Thu Sep 7 12:46:31 2023 +0200
net: stmmac: fix handling of zero coalescing tx-usecs
[ Upstream commit fa60b8163816f194786f3ee334c9a458da7699c6 ]
Setting ethtool -C eth0 tx-usecs 0 is supposed to disable the use of the
coalescing timer but currently it gets programmed with zero delay
instead.
Disable the use of the coalescing timer if tx-usecs is zero by
preventing it from being restarted. Note that to keep things simple we
don't start/stop the timer when the coalescing settings are changed, but
just let that happen on the next transmit or timer expiry.
Fixes: 8fce33317023 ("net: stmmac: Rework coalesce timer and fix multi-queue races")
Signed-off-by: Vincent Whitchurch
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b717463610a27fc0b58484cfead7a623d5913e61
Author: Guangguan Wang
Date: Fri Sep 8 11:31:43 2023 +0800
net/smc: use smc\_lgr\_list.lock to protect smc\_lgr\_list.list iterate in smcr\_port\_add
[ Upstream commit f5146e3ef0a9eea405874b36178c19a4863b8989 ]
While doing smcr\_port\_add, there maybe linkgroup add into or delete
from smc\_lgr\_list.list at the same time, which may result kernel crash.
So, use smc\_lgr\_list.lock to protect smc\_lgr\_list.list iterate in
smcr\_port\_add.
The crash calltrace show below:
BUG: kernel NULL pointer dereference, address: 0000000000000000
PGD 0 P4D 0
Oops: 0000 [#1] SMP NOPTI
CPU: 0 PID: 559726 Comm: kworker/0:92 Kdump: loaded Tainted: G
Hardware name: Alibaba Cloud Alibaba Cloud ECS, BIOS 449e491 04/01/2014
Workqueue: events smc\_ib\_port\_event\_work [smc]
RIP: 0010:smcr\_port\_add+0xa6/0xf0 [smc]
RSP: 0000:ffffa5a2c8f67de0 EFLAGS: 00010297
RAX: 0000000000000001 RBX: ffff9935e0650000 RCX: 0000000000000000
RDX: 0000000000000010 RSI: ffff9935e0654290 RDI: ffff9935c8560000
RBP: 0000000000000000 R08: 0000000000000000 R09: ffff9934c0401918
R10: 0000000000000000 R11: ffffffffb4a5c278 R12: ffff99364029aae4
R13: ffff99364029aa00 R14: 00000000ffffffed R15: ffff99364029ab08
FS: 0000000000000000(0000) GS:ffff994380600000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 0000000f06a10003 CR4: 0000000002770ef0
PKRU: 55555554
Call Trace:
smc\_ib\_port\_event\_work+0x18f/0x380 [smc]
process\_one\_work+0x19b/0x340
worker\_thread+0x30/0x370
? process\_one\_work+0x340/0x340
kthread+0x114/0x130
? \_\_kthread\_cancel\_work+0x50/0x50
ret\_from\_fork+0x1f/0x30
Fixes: 1f90a05d9ff9 ("net/smc: add smcr\_port\_add() and smcr\_link\_up() processing")
Signed-off-by: Guangguan Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 67920084b37cb45fd1b26666c4b1f053b7456db3
Author: Ratheesh Kannoth
Date: Fri Sep 8 08:23:09 2023 +0530
octeontx2-pf: Fix page pool cache index corruption.
[ Upstream commit 88e69af061f2e061a68751ef9cad47a674527a1b ]
The access to page pool `cache' array and the `count' variable
is not locked. Page pool cache access is fine as long as there
is only one consumer per pool.
octeontx2 driver fills in rx buffers from page pool in NAPI context.
If system is stressed and could not allocate buffers, refiiling work
will be delegated to a delayed workqueue. This means that there are
two cosumers to the page pool cache.
Either workqueue or IRQ/NAPI can be run on other CPU. This will lead
to lock less access, hence corruption of cache pool indexes.
To fix this issue, NAPI is rescheduled from workqueue context to refill
rx buffers.
Fixes: b2e3406a38f0 ("octeontx2-pf: Add support for page pool")
Signed-off-by: Ratheesh Kannoth
Reported-by: Sebastian Andrzej Siewior
Reviewed-by: Sebastian Andrzej Siewior
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a26ba60413b2c8f95daf0ee0152cf82abd7bfbe4
Author: Jinjie Ruan
Date: Thu Sep 7 22:03:58 2023 +0800
net: microchip: vcap api: Fix possible memory leak for vcap\_dup\_rule()
[ Upstream commit 281f65d29d6da1a9b6907fb0b145aaf34f4e4822 ]
Inject fault When select CONFIG\_VCAP\_KUNIT\_TEST, the below memory leak
occurs. If kzalloc() for duprule succeeds, but the following
kmemdup() fails, the duprule, ckf and caf memory will be leaked. So kfree
them in the error path.
unreferenced object 0xffff122744c50600 (size 192):
comm "kunit\_try\_catch", pid 346, jiffies 4294896122 (age 911.812s)
hex dump (first 32 bytes):
10 27 00 00 04 00 00 00 1e 00 00 00 2c 01 00 00 .'..........,...
00 00 00 00 00 00 00 00 18 06 c5 44 27 12 ff ff ...........D'...
backtrace:
[<00000000394b0db8>] \_\_kmem\_cache\_alloc\_node+0x274/0x2f8
[<0000000001bedc67>] kmalloc\_trace+0x38/0x88
[<00000000b0612f98>] vcap\_dup\_rule+0x50/0x460
[<000000005d2d3aca>] vcap\_add\_rule+0x8cc/0x1038
[<00000000eef9d0f8>] test\_vcap\_xn\_rule\_creator.constprop.0.isra.0+0x238/0x494
[<00000000cbda607b>] vcap\_api\_rule\_remove\_in\_front\_test+0x1ac/0x698
[<00000000c8766299>] kunit\_try\_run\_case+0xe0/0x20c
[<00000000c4fe9186>] kunit\_generic\_run\_threadfn\_adapter+0x50/0x94
[<00000000f6864acf>] kthread+0x2e8/0x374
[<0000000022e639b3>] ret\_from\_fork+0x10/0x20
Fixes: 814e7693207f ("net: microchip: vcap api: Add a storage state to a VCAP rule")
Signed-off-by: Jinjie Ruan
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 46f67054a8ec22cc7aa161e488c1928ed6b59512
Author: Naveen N Rao
Date: Wed Jun 14 14:40:46 2023 +0530
selftests/ftrace: Fix dependencies for some of the synthetic event tests
[ Upstream commit 145036f88d693d7ef3aa8537a4b1aa22f8764647 ]
Commit b81a3a100cca1b ("tracing/histogram: Add simple tests for
stacktrace usage of synthetic events") changed the output text in
tracefs README, but missed updating some of the dependencies specified
in selftests. This causes some of the tests to exit as unsupported.
Fix this by changing the grep pattern. Since we want these tests to work
on older kernels, match only against the common last part of the
pattern.
Link: https://lore.kernel.org/linux-trace-kernel/20230614091046.2178539-1-naveen@kernel.org
Cc:
Cc: Masami Hiramatsu
Cc: Shuah Khan
Fixes: b81a3a100cca ("tracing/histogram: Add simple tests for stacktrace usage of synthetic events")
Signed-off-by: Naveen N Rao
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Sasha Levin
commit 45c9367015ef79a2f3671323a8046ef9d300ae13
Author: Björn Töpel
Date: Tue Aug 22 15:58:37 2023 +0200
selftests: Keep symlinks, when possible
[ Upstream commit 3f3f384139ed147c71e1d770accf610133d5309b ]
When kselftest is built/installed with the 'gen\_tar' target, rsync is
used for the installation step to copy files. Extra care is needed for
tests that have symlinks. Commit ae108c48b5d2 ("selftests: net: Fix
cross-tree inclusion of scripts") added '-L' (transform symlink into
referent file/dir) to rsync, to fix dangling links. However, that
broke some tests where the symlink (being a symlink) is part of the
test (e.g. exec:execveat).
Use rsync's '--copy-unsafe-links' that does right thing.
Fixes: ae108c48b5d2 ("selftests: net: Fix cross-tree inclusion of scripts")
Signed-off-by: Björn Töpel
Reviewed-by: Benjamin Poirier
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 9225ced01220b3db386b7dced28047048027cc4c
Author: Björn Töpel
Date: Wed Jul 5 13:53:17 2023 +0200
kselftest/runner.sh: Propagate SIGTERM to runner child
[ Upstream commit 9616cb34b08ec86642b162eae75c5a7ca8debe3c ]
Timeouts in kselftest are done using the "timeout" command with the
"--foreground" option. Without the "foreground" option, it is not
possible for a user to cancel the runner using SIGINT, because the
signal is not propagated to timeout which is running in a different
process group. The "forground" options places the timeout in the same
process group as its parent, but only sends the SIGTERM (on timeout)
signal to the forked process. Unfortunately, this does not play nice
with all kselftests, e.g. "net:fcnal-test.sh", where the child
processes will linger because timeout does not send SIGTERM to the
group.
Some users have noted these hangs [1].
Fix this by nesting the timeout with an additional timeout without the
foreground option.
Link: https://lore.kernel.org/all/7650b2eb-0aee-a2b0-2e64-c9bc63210f67@alu.unizg.hr/ # [1]
Fixes: 651e0d881461 ("kselftest/runner: allow to properly deliver signals to tests")
Signed-off-by: Björn Töpel
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit 42652af5360d30b43b06057c193739e7dfb18f42
Author: Liu Jian
Date: Thu Sep 7 10:57:09 2023 +0800
net: ipv4: fix one memleak in \_\_inet\_del\_ifa()
[ Upstream commit ac28b1ec6135649b5d78b028e47264cb3ebca5ea ]
I got the below warning when do fuzzing test:
unregister\_netdevice: waiting for bond0 to become free. Usage count = 2
It can be repoduced via:
ip link add bond0 type bond
sysctl -w net.ipv4.conf.bond0.promote\_secondaries=1
ip addr add 4.117.174.103/0 scope 0x40 dev bond0
ip addr add 192.168.100.111/255.255.255.254 scope 0 dev bond0
ip addr add 0.0.0.4/0 scope 0x40 secondary dev bond0
ip addr del 4.117.174.103/0 scope 0x40 dev bond0
ip link delete bond0 type bond
In this reproduction test case, an incorrect 'last\_prim' is found in
\_\_inet\_del\_ifa(), as a result, the secondary address(0.0.0.4/0 scope 0x40)
is lost. The memory of the secondary address is leaked and the reference of
in\_device and net\_device is leaked.
Fix this problem:
Look for 'last\_prim' starting at location of the deleted IP and inserting
the promoted IP into the location of 'last\_prim'.
Fixes: 0ff60a45678e ("[IPV4]: Fix secondary IP addresses after promotion")
Signed-off-by: Liu Jian
Signed-off-by: Julian Anastasov
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a9d39abd011f67c0abcbb8406941b2f0250386f5
Author: Jinjie Ruan
Date: Sun Sep 3 15:10:25 2023 +0800
kunit: Fix wild-memory-access bug in kunit\_free\_suite\_set()
[ Upstream commit 2810c1e99867a811e631dd24e63e6c1e3b78a59d ]
Inject fault while probing kunit-example-test.ko, if kstrdup()
fails in mod\_sysfs\_setup() in load\_module(), the mod->state will
switch from MODULE\_STATE\_COMING to MODULE\_STATE\_GOING instead of
from MODULE\_STATE\_LIVE to MODULE\_STATE\_GOING, so only
kunit\_module\_exit() will be called without kunit\_module\_init(), and
the mod->kunit\_suites is no set correctly and the free in
kunit\_free\_suite\_set() will cause below wild-memory-access bug.
The mod->state state machine when load\_module() succeeds:
MODULE\_STATE\_UNFORMED ---> MODULE\_STATE\_COMING ---> MODULE\_STATE\_LIVE
^ |
| | delete\_module
+---------------- MODULE\_STATE\_GOING <---------+
The mod->state state machine when load\_module() fails at
mod\_sysfs\_setup():
MODULE\_STATE\_UNFORMED ---> MODULE\_STATE\_COMING ---> MODULE\_STATE\_GOING
^ |
| |
+-----------------------------------------------+
Call kunit\_module\_init() at MODULE\_STATE\_COMING state to fix the issue
because MODULE\_STATE\_LIVE is transformed from it.
Unable to handle kernel paging request at virtual address ffffff341e942a88
KASAN: maybe wild-memory-access in range [0x0003f9a0f4a15440-0x0003f9a0f4a15447]
Mem abort info:
ESR = 0x0000000096000004
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x04: level 0 translation fault
Data abort info:
ISV = 0, ISS = 0x00000004, ISS2 = 0x00000000
CM = 0, WnR = 0, TnD = 0, TagAccess = 0
GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
swapper pgtable: 4k pages, 48-bit VAs, pgdp=00000000441ea000
[ffffff341e942a88] pgd=0000000000000000, p4d=0000000000000000
Internal error: Oops: 0000000096000004 [#1] PREEMPT SMP
Modules linked in: kunit\_example\_test(-) cfg80211 rfkill 8021q garp mrp stp llc ipv6 [last unloaded: kunit\_example\_test]
CPU: 3 PID: 2035 Comm: modprobe Tainted: G W N 6.5.0-next-20230828+ #136
Hardware name: linux,dummy-virt (DT)
pstate: a0000005 (NzCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : kfree+0x2c/0x70
lr : kunit\_free\_suite\_set+0xcc/0x13c
sp : ffff8000829b75b0
x29: ffff8000829b75b0 x28: ffff8000829b7b90 x27: 0000000000000000
x26: dfff800000000000 x25: ffffcd07c82a7280 x24: ffffcd07a50ab300
x23: ffffcd07a50ab2e8 x22: 1ffff00010536ec0 x21: dfff800000000000
x20: ffffcd07a50ab2f0 x19: ffffcd07a50ab2f0 x18: 0000000000000000
x17: 0000000000000000 x16: 0000000000000000 x15: ffffcd07c24b6764
x14: ffffcd07c24b63c0 x13: ffffcd07c4cebb94 x12: ffff700010536ec7
x11: 1ffff00010536ec6 x10: ffff700010536ec6 x9 : dfff800000000000
x8 : 00008fffefac913a x7 : 0000000041b58ab3 x6 : 0000000000000000
x5 : 1ffff00010536ec5 x4 : ffff8000829b7628 x3 : dfff800000000000
x2 : ffffff341e942a80 x1 : ffffcd07a50aa000 x0 : fffffc0000000000
Call trace:
kfree+0x2c/0x70
kunit\_free\_suite\_set+0xcc/0x13c
kunit\_module\_notify+0xd8/0x360
blocking\_notifier\_call\_chain+0xc4/0x128
load\_module+0x382c/0x44a4
init\_module\_from\_file+0xd4/0x128
idempotent\_init\_module+0x2c8/0x524
\_\_arm64\_sys\_finit\_module+0xac/0x100
invoke\_syscall+0x6c/0x258
el0\_svc\_common.constprop.0+0x160/0x22c
do\_el0\_svc+0x44/0x5c
el0\_svc+0x38/0x78
el0t\_64\_sync\_handler+0x13c/0x158
el0t\_64\_sync+0x190/0x194
Code: aa0003e1 b25657e0 d34cfc42 8b021802 (f9400440)
---[ end trace 0000000000000000 ]---
Kernel panic - not syncing: Oops: Fatal exception
SMP: stopping secondary CPUs
Kernel Offset: 0x4d0742200000 from 0xffff800080000000
PHYS\_OFFSET: 0xffffee43c0000000
CPU features: 0x88000203,3c020000,1000421b
Memory Limit: none
Rebooting in 1 seconds..
Fixes: 3d6e44623841 ("kunit: unify module and builtin suite definitions")
Signed-off-by: Jinjie Ruan
Reviewed-by: Rae Moar
Reviewed-by: David Gow
Signed-off-by: Shuah Khan
Signed-off-by: Sasha Levin
commit ff4f59a022150f4a1939d9fa89aea7b767255795
Author: Helge Deller
Date: Wed Aug 30 07:56:04 2023 +0200
parisc: sba\_iommu: Fix build warning if procfs if disabled
[ Upstream commit 6428bc7bd3f35e43c8cb7359cb89d83248d339d2 ]
Clean up the code, e.g. make proc\_mckinley\_root static, drop the now
empty mckinley header file and remove some unneeded ifdefs around procfs
functions.
Signed-off-by: Helge Deller
Reported-by: kernel test robot
Closes: https://lore.kernel.org/oe-kbuild-all/202308300800.Jod4sHzM-lkp@intel.com/
Fixes: 77e0ddf097d6 ("parisc: ccio-dma: Create private runway procfs root entry")
Signed-off-by: Sasha Levin
commit 2bf2d2ac9e67184dc99275875a6452ca6e3027ff
Author: Biju Das
Date: Wed Aug 16 14:55:49 2023 +0100
regulator: raa215300: Fix resource leak in case of error
[ Upstream commit e21ac64e669e960688e79bf5babeed63132dac8a ]
The clk\_register\_clkdev() allocates memory by calling vclkdev\_alloc() and
this memory is not freed in the error path. Similarly, resources allocated
by clk\_register\_fixed\_rate() are not freed in the error path.
Fix these issues by using devm\_clk\_hw\_register\_fixed\_rate() and
devm\_clk\_hw\_register\_clkdev().
After this, the static variable clk is not needed. Replace it with
local variable hw in probe() and drop calling clk\_unregister\_fixed\_rate()
from raa215300\_rtc\_unregister\_device().
Fixes: 7bce16630837 ("regulator: Add Renesas PMIC RAA215300 driver")
Cc: stable@kernel.org
Signed-off-by: Biju Das
Link: https://lore.kernel.org/r/20230816135550.146657-2-biju.das.jz@bp.renesas.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 749491b59097138040971348e31dc924c82d46cf
Author: Biju Das
Date: Thu Jun 29 11:42:00 2023 +0100
regulator: raa215300: Change the scope of the variables {clkin\_name, xin\_name}
[ Upstream commit 42a95739c5bc4d7a6e93a43117e9283598ba2287 ]
Change the scope of the variables {clkin\_name, xin\_name} from global->local
to fix the below warning.
drivers/regulator/raa215300.c:42:12: sparse: sparse: symbol 'xin\_name' was
not declared. Should it be static?
Reported-by: kernel test robot
Closes: https://lore.kernel.org/oe-kbuild-all/202306250552.Fan9WTiN-lkp@intel.com/
Signed-off-by: Biju Das
Reviewed-by: Geert Uytterhoeven
Link: https://lore.kernel.org/r/20230629104200.102663-1-biju.das.jz@bp.renesas.com
Signed-off-by: Mark Brown
Stable-dep-of: e21ac64e669e ("regulator: raa215300: Fix resource leak in case of error")
Signed-off-by: Sasha Levin
commit fdb3a30cb17ab0e57c3ea47ca79c4c4e904a2e0b
Author: Arnd Bergmann
Date: Tue Aug 1 13:13:58 2023 +0200
bpf: fix bpf\_probe\_read\_kernel prototype mismatch
[ Upstream commit 6a5a148aaf14747570cc634f9cdfcb0393f5617f ]
bpf\_probe\_read\_kernel() has a \_\_weak definition in core.c and another
definition with an incompatible prototype in kernel/trace/bpf\_trace.c,
when CONFIG\_BPF\_EVENTS is enabled.
Since the two are incompatible, there cannot be a shared declaration in
a header file, but the lack of a prototype causes a W=1 warning:
kernel/bpf/core.c:1638:12: error: no previous prototype for 'bpf\_probe\_read\_kernel' [-Werror=missing-prototypes]
On 32-bit architectures, the local prototype
u64 \_\_weak bpf\_probe\_read\_kernel(void \*dst, u32 size, const void \*unsafe\_ptr)
passes arguments in other registers as the one in bpf\_trace.c
BPF\_CALL\_3(bpf\_probe\_read\_kernel, void \*, dst, u32, size,
const void \*, unsafe\_ptr)
which uses 64-bit arguments in pairs of registers.
As both versions of the function are fairly simple and only really
differ in one line, just move them into a header file as an inline
function that does not add any overhead for the bpf\_trace.c callers
and actually avoids a function call for the other one.
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/all/ac25cb0f-b804-1649-3afb-1dc6138c2716@iogearbox.net/
Signed-off-by: Arnd Bergmann
Acked-by: Yonghong Song
Link: https://lore.kernel.org/r/20230801111449.185301-1-arnd@kernel.org
Signed-off-by: Alexei Starovoitov
Signed-off-by: Sasha Levin
commit 5479e06e07bdc0d77ae9646e8830978fb48aaf6a
Author: Hamza Mahfooz
Date: Tue Aug 15 09:13:37 2023 -0400
drm/amdgpu: register a dirty framebuffer callback for fbcon
commit 0a611560f53bfd489e33f4a718c915f1a6123d03 upstream.
fbcon requires that we implement &drm\_framebuffer\_funcs.dirty.
Otherwise, the framebuffer might take a while to flush (which would
manifest as noticeable lag). However, we can't enable this callback for
non-fbcon cases since it may cause too many atomic commits to be made at
once. So, implement amdgpu\_dirtyfb() and only enable it for fbcon
framebuffers (we can use the "struct drm\_file file" parameter in the
callback to check for this since it is only NULL when called by fbcon,
at least in the mainline kernel) on devices that support atomic KMS.
Cc: Aurabindo Pillai
Cc: Mario Limonciello
Cc: stable@vger.kernel.org # 6.1+
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2519
Reviewed-by: Mario Limonciello
Signed-off-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 399b73d6b7720a9eae68a333193b53ed4f432fe5
Author: Jay Cornwall
Date: Fri Aug 25 12:18:41 2023 -0400
drm/amdkfd: Add missing gfx11 MQD manager callbacks
commit e9dca969b2426702a73719ab9207e43c6d80b581 upstream.
mqd\_stride function was introduced in commit 2f77b9a242a2
("drm/amdkfd: Update MQD management on multi XCC setup")
but not assigned for gfx11. Fixes a NULL dereference in debugfs.
Signed-off-by: Jay Cornwall
Signed-off-by: Harish Kasiviswanathan
Acked-by: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 6.5.x
Signed-off-by: Greg Kroah-Hartman
commit aeeb30ac4448569af4da967753faf818fb796d67
Author: Gabe Teeger
Date: Mon Aug 14 16:06:18 2023 -0400
drm/amd/display: Remove wait while locked
commit 5a3ccb1400339268c5e3dc1fa044a7f6c7f59a02 upstream.
[Why]
We wait for mpc idle while in a locked state, leading to potential
deadlock.
[What]
Move the wait\_for\_idle call to outside of HW lock. This and a
call to wait\_drr\_doublebuffer\_pending\_clear are moved added to a new
static helper function called wait\_for\_outstanding\_hw\_updates, to make
the interface clearer.
Cc: stable@vger.kernel.org
Fixes: 8f0d304d21b3 ("drm/amd/display: Do not commit pipe when updating DRR")
Reviewed-by: Jun Lei
Acked-by: Hamza Mahfooz
Signed-off-by: Gabe Teeger
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 9bebf189f65f538411e67fcb475c56856462396e
Author: Wenjing Liu
Date: Tue Aug 15 10:47:52 2023 -0400
drm/amd/display: always switch off ODM before committing more streams
commit 49a30c3d1a2258fc93cfe6eea8e4951dabadc824 upstream.
ODM power optimization is only supported with single stream. When ODM
power optimization is enabled, we might not have enough free pipes for
enabling other stream. So when we are committing more than 1 stream we
should first switch off ODM power optimization to make room for new
stream and then allocating pipe resource for the new stream.
Cc: stable@vger.kernel.org
Fixes: 59de751e3845 ("drm/amd/display: add ODM case when looking for first split pipe")
Reviewed-by: Dillon Varone
Acked-by: Hamza Mahfooz
Signed-off-by: Wenjing Liu
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 55a941a021fbda31c72227331a48ee297b01413b
Author: Namhyung Kim
Date: Mon Jul 31 02:49:33 2023 -0700
perf hists browser: Fix the number of entries for 'e' key
commit f6b8436bede3e80226e8b2100279c4450c73806a upstream.
The 'e' key is to toggle expand/collapse the selected entry only. But
the current code has a bug that it only increases the number of entries
by 1 in the hierarchy mode so users cannot move under the current entry
after the key stroke. This is due to a wrong assumption in the
hist\_entry\_\_set\_folding().
The commit b33f922651011eff ("perf hists browser: Put hist\_entry folding
logic into single function") factored out the code, but actually it
should be handled separately. The hist\_browser\_\_set\_folding() is to
update fold state for each entry so it needs to traverse all (child)
entries regardless of the current fold state. So it increases the
number of entries by 1.
But the hist\_entry\_\_set\_folding() only cares the currently selected
entry and its all children. So it should count all unfolded child
entries. This code is implemented in hist\_browser\_\_toggle\_fold()
already so we can just call it.
Fixes: b33f922651011eff ("perf hists browser: Put hist\_entry folding logic into single function")
Signed-off-by: Namhyung Kim
Tested-by: Arnaldo Carvalho de Melo
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Peter Zijlstra
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230731094934.1616495-2-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit cd668bcafa4cc9bc8374ae64da6316fc04c73529
Author: Namhyung Kim
Date: Thu Jul 27 19:24:47 2023 -0700
perf build: Include generated header files properly
commit c7e97f215a4ad634b746804679f5937d25f77e29 upstream.
The flex and bison generate header files from the source. When user
specified a build directory with O= option, it'd generate files under
the directory. The build command has -I option to specify the header
include directory.
But the -I option only affects the files included like <...>. Let's
change the flex and bison headers to use it instead of "...".
Fixes: 80eeb67fe577aa76 ("perf jevents: Program to convert JSON file")
Signed-off-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Andi Kleen
Cc: Anup Sharma
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Peter Zijlstra
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230728022447.1323563-2-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 41cb5ac3b4f3d0c419bd9151d93fb92e871c37c6
Author: Namhyung Kim
Date: Fri Aug 25 08:25:49 2023 -0700
perf tools: Handle old data in PERF\_RECORD\_ATTR
commit 9bf63282ea77a531ea58acb42fb3f40d2d1e4497 upstream.
The PERF\_RECORD\_ATTR is used for a pipe mode to describe an event with
attribute and IDs. The ID table comes after the attr and it calculate
size of the table using the total record size and the attr size.
n\_ids = (total\_record\_size - end\_of\_the\_attr\_field) / sizeof(u64)
This is fine for most use cases, but sometimes it saves the pipe output
in a file and then process it later. And it becomes a problem if there
is a change in attr size between the record and report.
$ perf record -o- > perf-pipe.data # old version
$ perf report -i- < perf-pipe.data # new version
For example, if the attr size is 128 and it has 4 IDs, then it would
save them in 168 byte like below:
8 byte: perf event header { .type = PERF\_RECORD\_ATTR, .size = 168 },
128 byte: perf event attr { .size = 128, ... },
32 byte: event IDs [] = { 1234, 1235, 1236, 1237 },
But when report later, it thinks the attr size is 136 then it only read
the last 3 entries as ID.
8 byte: perf event header { .type = PERF\_RECORD\_ATTR, .size = 168 },
136 byte: perf event attr { .size = 136, ... },
24 byte: event IDs [] = { 1235, 1236, 1237 }, // 1234 is missing
So it should use the recorded version of the attr. The attr has the
size field already then it should honor the size when reading data.
Fixes: 2c46dbb517a10b18 ("perf: Convert perf header attrs into attr events")
Signed-off-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Peter Zijlstra
Cc: Tom Zanussi
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230825152552.112913-1-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 9952bbd484f52ae92966954390d9af05ea46ba0e
Author: Namhyung Kim
Date: Fri Aug 25 09:41:51 2023 -0700
perf test shell stat\_bpf\_counters: Fix test on Intel
commit 68ca249c964f520af7f8763e22f12bd26b57b870 upstream.
As of now, bpf counters (bperf) don't support event groups. But the
default perf stat includes topdown metrics if supported (on recent Intel
machines) which require groups. That makes perf stat exiting.
$ sudo perf stat --bpf-counter true
bpf managed perf events do not yet support groups.
Actually the test explicitly uses cycles event only, but it missed to
pass the option when it checks the availability of the command.
Fixes: 2c0cb9f56020d2ea ("perf test: Add a shell test for 'perf stat --bpf-counters' new option")
Reviewed-by: Song Liu
Signed-off-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Peter Zijlstra
Cc: bpf@vger.kernel.org
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230825164152.165610-2-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 0753b9d0bfe67f26d33ad4ddb9d4b087d0b0f471
Author: Namhyung Kim
Date: Thu Jul 27 19:24:46 2023 -0700
perf build: Update build rule for generated files
commit 7822a8913f4c51c7d1aff793b525d60c3384fb5b upstream.
The bison and flex generate C files from the source (.y and .l)
files. When O= option is used, they are saved in a separate directory
but the default build rule assumes the .C files are in the source
directory. So it might read invalid file if there are generated files
from an old version. The same is true for the pmu-events files.
For example, the following command would cause a build failure:
$ git checkout v6.3
$ make -C tools/perf # build in the same directory
$ git checkout v6.5-rc2
$ mkdir build # create a build directory
$ make -C tools/perf O=build # build in a different directory but it
# refers files in the source directory
Let's update the build rule to specify those cases explicitly to depend
on the files in the output directory.
Note that it's not a complete fix and it needs the next patch for the
include path too.
Fixes: 80eeb67fe577aa76 ("perf jevents: Program to convert JSON file")
Signed-off-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Andi Kleen
Cc: Anup Sharma
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Peter Zijlstra
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230728022447.1323563-1-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 8a5b35fe024d25f9c2bfbe6df24f9188746fafce
Author: Namhyung Kim
Date: Mon Jul 31 02:49:32 2023 -0700
perf hists browser: Fix hierarchy mode header
commit e2cabf2a44791f01c21f8d5189b946926e34142e upstream.
The commit ef9ff6017e3c4593 ("perf ui browser: Move the extra title
lines from the hists browser") introduced ui\_browser\_\_gotorc\_title() to
help moving non-title lines easily. But it missed to update the title
for the hierarchy mode so it won't print the header line on TUI at all.
$ perf report --hierarchy
Fixes: ef9ff6017e3c4593 ("perf ui browser: Move the extra title lines from the hists browser")
Signed-off-by: Namhyung Kim
Tested-by: Arnaldo Carvalho de Melo
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Peter Zijlstra
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230731094934.1616495-1-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit ca874c5ffad26a70b2dfd5f1fcbeaecfed129520
Author: Maciej W. Rozycki
Date: Tue Jul 18 15:37:18 2023 +0100
MIPS: Fix CONFIG\_CPU\_DADDI\_WORKAROUNDS `modules\_install' regression
commit a79a404e6c2241ebc528b9ebf4c0832457b498c3 upstream.
Remove a build-time check for the presence of the GCC `-msym32' option.
This option has been there since GCC 4.1.0, which is below the minimum
required as at commit 805b2e1d427a ("kbuild: include Makefile.compiler
only when compiler is needed"), when an error message:
arch/mips/Makefile:306: \*\*\* CONFIG\_CPU\_DADDI\_WORKAROUNDS unsupported without -msym32. Stop.
started to trigger for the `modules\_install' target with configurations
such as `decstation\_64\_defconfig' that set CONFIG\_CPU\_DADDI\_WORKAROUNDS,
because said commit has made `cc-option-yn' an undefined function for
non-build targets.
Reported-by: Jan-Benedict Glaw
Signed-off-by: Maciej W. Rozycki
Fixes: 805b2e1d427a ("kbuild: include Makefile.compiler only when compiler is needed")
Cc: stable@vger.kernel.org # v5.13+
Reviewed-by: Philippe Mathieu-Daudé
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit 20f8c9ae46a5dba4f6317d990becd5cc81f2a53c
Author: Maciej W. Rozycki
Date: Tue Jul 18 15:37:23 2023 +0100
MIPS: Only fiddle with CHECKFLAGS if `need-compiler'
commit 4fe4a6374c4db9ae2b849b61e84b58685dca565a upstream.
We have originally guarded fiddling with CHECKFLAGS in our arch Makefile
by checking for the CONFIG\_MIPS variable, not set for targets such as
`distclean', etc. that neither include `.config' nor use the compiler.
Starting from commit 805b2e1d427a ("kbuild: include Makefile.compiler
only when compiler is needed") we have had a generic `need-compiler'
variable explicitly telling us if the compiler will be used and thus its
capabilities need to be checked and expressed in the form of compilation
flags. If this variable is not set, then `make' functions such as
`cc-option' are undefined, causing all kinds of weirdness to happen if
we expect specific results to be returned, most recently:
cc1: error: '-mloongson-mmi' must be used with '-mhard-float'
messages with configurations such as `fuloong2e\_defconfig' and the
`modules\_install' target, which does include `.config' and yet does not
use the compiler.
Replace the check for CONFIG\_MIPS with one for `need-compiler' instead,
so as to prevent the compiler from being ever called for CHECKFLAGS when
not needed.
Reported-by: Guillaume Tucker
Closes: https://lore.kernel.org/r/85031c0c-d981-031e-8a50-bc4fad2ddcd8@collabora.com/
Signed-off-by: Maciej W. Rozycki
Fixes: 805b2e1d427a ("kbuild: include Makefile.compiler only when compiler is needed")
Cc: stable@vger.kernel.org # v5.13+
Reported-by: "kernelci.org bot"
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Greg Kroah-Hartman
commit 61c97e3ee78b3244e66bd1e4c4e0a10d3b49c2dd
Author: Sean Christopherson
Date: Thu Aug 24 19:23:57 2023 -0700
KVM: SVM: Skip VMSA init in sev\_es\_init\_vmcb() if pointer is NULL
commit 1952e74da96fb3e48b72a2d0ece78c688a5848c1 upstream.
Skip initializing the VMSA physical address in the VMCB if the VMSA is
NULL, which occurs during intrahost migration as KVM initializes the VMCB
before copying over state from the source to the destination (including
the VMSA and its physical address).
In normal builds, \_\_pa() is just math, so the bug isn't fatal, but with
CONFIG\_DEBUG\_VIRTUAL=y, the validity of the virtual address is verified
and passing in NULL will make the kernel unhappy.
Fixes: 6defa24d3b12 ("KVM: SEV: Init target VMCBs in sev\_migrate\_from")
Cc: stable@vger.kernel.org
Cc: Peter Gonda
Reviewed-by: Peter Gonda
Reviewed-by: Pankaj Gupta
Link: https://lore.kernel.org/r/20230825022357.2852133-3-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit e9898d822940ac28ef38ebd21e852fba4fb68fd9
Author: Sean Christopherson
Date: Tue Aug 8 16:31:32 2023 -0700
KVM: SVM: Set target pCPU during IRTE update if target vCPU is running
commit f3cebc75e7425d6949d726bb8e937095b0aef025 upstream.
Update the target pCPU for IOMMU doorbells when updating IRTE routing if
KVM is actively running the associated vCPU. KVM currently only updates
the pCPU when loading the vCPU (via avic\_vcpu\_load()), and so doorbell
events will be delayed until the vCPU goes through a put+load cycle (which
might very well "never" happen for the lifetime of the VM).
To avoid inserting a stale pCPU, e.g. due to racing between updating IRTE
routing and vCPU load/put, get the pCPU information from the vCPU's
Physical APIC ID table entry (a.k.a. avic\_physical\_id\_cache in KVM) and
update the IRTE while holding ir\_list\_lock. Add comments with --verbose
enabled to explain exactly what is and isn't protected by ir\_list\_lock.
Fixes: 411b44ba80ab ("svm: Implements update\_pi\_irte hook to setup posted interrupt")
Reported-by: dengqiao.joey
Cc: stable@vger.kernel.org
Cc: Alejandro Jimenez
Cc: Joao Martins
Cc: Maxim Levitsky
Cc: Suravee Suthikulpanit
Tested-by: Alejandro Jimenez
Reviewed-by: Joao Martins
Link: https://lore.kernel.org/r/20230808233132.2499764-3-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit e91c07f6cf7060d2acb3aeee31a6baebe3773d3f
Author: Sean Christopherson
Date: Fri Jul 28 18:15:49 2023 -0700
KVM: nSVM: Load L1's TSC multiplier based on L1 state, not L2 state
commit 0c94e2468491cbf0754f49a5136ab51294a96b69 upstream.
When emulating nested VM-Exit, load L1's TSC multiplier if L1's desired
ratio doesn't match the current ratio, not if the ratio L1 is using for
L2 diverges from the default. Functionally, the end result is the same
as KVM will run L2 with L1's multiplier if L2's multiplier is the default,
i.e. checking that L1's multiplier is loaded is equivalent to checking if
L2 has a non-default multiplier.
However, the assertion that TSC scaling is exposed to L1 is flawed, as
userspace can trigger the WARN at will by writing the MSR and then
updating guest CPUID to hide the feature (modifying guest CPUID is
allowed anytime before KVM\_RUN). E.g. hacking KVM's state\_test
selftest to do
vcpu\_set\_msr(vcpu, MSR\_AMD64\_TSC\_RATIO, 0);
vcpu\_clear\_cpuid\_feature(vcpu, X86\_FEATURE\_TSCRATEMSR);
after restoring state in a new VM+vCPU yields an endless supply of:
------------[ cut here ]------------
WARNING: CPU: 10 PID: 206939 at arch/x86/kvm/svm/nested.c:1105
nested\_svm\_vmexit+0x6af/0x720 [kvm\_amd]
Call Trace:
nested\_svm\_exit\_handled+0x102/0x1f0 [kvm\_amd]
svm\_handle\_exit+0xb9/0x180 [kvm\_amd]
kvm\_arch\_vcpu\_ioctl\_run+0x1eab/0x2570 [kvm]
kvm\_vcpu\_ioctl+0x4c9/0x5b0 [kvm]
? trace\_hardirqs\_off+0x4d/0xa0
\_\_se\_sys\_ioctl+0x7a/0xc0
\_\_x64\_sys\_ioctl+0x21/0x30
do\_syscall\_64+0x41/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Unlike the nested VMRUN path, hoisting the svm->tsc\_scaling\_enabled check
into the if-statement is wrong as KVM needs to ensure L1's multiplier is
loaded in the above scenario. Alternatively, the WARN\_ON() could simply
be deleted, but that would make KVM's behavior even more subtle, e.g. it's
not immediately obvious why it's safe to write MSR\_AMD64\_TSC\_RATIO when
checking only tsc\_ratio\_msr.
Fixes: 5228eb96a487 ("KVM: x86: nSVM: implement nested TSC scaling")
Cc: Maxim Levitsky
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230729011608.1065019-3-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit 02b24270568f65dd607c4a848512dc8055b4491b
Author: Sean Christopherson
Date: Fri Jul 28 18:15:48 2023 -0700
KVM: nSVM: Check instead of asserting on nested TSC scaling support
commit 7cafe9b8e22bb3d77f130c461aedf6868c4aaf58 upstream.
Check for nested TSC scaling support on nested SVM VMRUN instead of
asserting that TSC scaling is exposed to L1 if L1's MSR\_AMD64\_TSC\_RATIO
has diverged from KVM's default. Userspace can trigger the WARN at will
by writing the MSR and then updating guest CPUID to hide the feature
(modifying guest CPUID is allowed anytime before KVM\_RUN). E.g. hacking
KVM's state\_test selftest to do
vcpu\_set\_msr(vcpu, MSR\_AMD64\_TSC\_RATIO, 0);
vcpu\_clear\_cpuid\_feature(vcpu, X86\_FEATURE\_TSCRATEMSR);
after restoring state in a new VM+vCPU yields an endless supply of:
------------[ cut here ]------------
WARNING: CPU: 164 PID: 62565 at arch/x86/kvm/svm/nested.c:699
nested\_vmcb02\_prepare\_control+0x3d6/0x3f0 [kvm\_amd]
Call Trace:
enter\_svm\_guest\_mode+0x114/0x560 [kvm\_amd]
nested\_svm\_vmrun+0x260/0x330 [kvm\_amd]
vmrun\_interception+0x29/0x30 [kvm\_amd]
svm\_invoke\_exit\_handler+0x35/0x100 [kvm\_amd]
svm\_handle\_exit+0xe7/0x180 [kvm\_amd]
kvm\_arch\_vcpu\_ioctl\_run+0x1eab/0x2570 [kvm]
kvm\_vcpu\_ioctl+0x4c9/0x5b0 [kvm]
\_\_se\_sys\_ioctl+0x7a/0xc0
\_\_x64\_sys\_ioctl+0x21/0x30
do\_syscall\_64+0x41/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
RIP: 0033:0x45ca1b
Note, the nested #VMEXIT path has the same flaw, but needs a different
fix and will be handled separately.
Fixes: 5228eb96a487 ("KVM: x86: nSVM: implement nested TSC scaling")
Cc: Maxim Levitsky
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230729011608.1065019-2-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit 2ee4b180d51b12a45bdd3264629719ef6a572a73
Author: Sean Christopherson
Date: Thu Aug 24 19:23:56 2023 -0700
KVM: SVM: Get source vCPUs from source VM for SEV-ES intrahost migration
commit f1187ef24eb8f36e8ad8106d22615ceddeea6097 upstream.
Fix a goof where KVM tries to grab source vCPUs from the destination VM
when doing intrahost migration. Grabbing the wrong vCPU not only hoses
the guest, it also crashes the host due to the VMSA pointer being left
NULL.
BUG: unable to handle page fault for address: ffffe38687000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] SMP NOPTI
CPU: 39 PID: 17143 Comm: sev\_migrate\_tes Tainted: GO 6.5.0-smp--fff2e47e6c3b-next #151
Hardware name: Google, Inc. Arcadia\_IT\_80/Arcadia\_IT\_80, BIOS 34.28.0 07/10/2023
RIP: 0010:\_\_free\_pages+0x15/0xd0
RSP: 0018:ffff923fcf6e3c78 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffffe38687000000 RCX: 0000000000000100
RDX: 0000000000000100 RSI: 0000000000000000 RDI: ffffe38687000000
RBP: ffff923fcf6e3c88 R08: ffff923fcafb0000 R09: 0000000000000000
R10: 0000000000000000 R11: ffffffff83619b90 R12: ffff923fa9540000
R13: 0000000000080007 R14: ffff923f6d35d000 R15: 0000000000000000
FS: 0000000000000000(0000) GS:ffff929d0d7c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffe38687000000 CR3: 0000005224c34005 CR4: 0000000000770ee0
PKRU: 55555554
Call Trace:
sev\_free\_vcpu+0xcb/0x110 [kvm\_amd]
svm\_vcpu\_free+0x75/0xf0 [kvm\_amd]
kvm\_arch\_vcpu\_destroy+0x36/0x140 [kvm]
kvm\_destroy\_vcpus+0x67/0x100 [kvm]
kvm\_arch\_destroy\_vm+0x161/0x1d0 [kvm]
kvm\_put\_kvm+0x276/0x560 [kvm]
kvm\_vm\_release+0x25/0x30 [kvm]
\_\_fput+0x106/0x280
\_\_\_\_fput+0x12/0x20
task\_work\_run+0x86/0xb0
do\_exit+0x2e3/0x9c0
do\_group\_exit+0xb1/0xc0
\_\_x64\_sys\_exit\_group+0x1b/0x20
do\_syscall\_64+0x41/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd

CR2: ffffe38687000000
Fixes: 6defa24d3b12 ("KVM: SEV: Init target VMCBs in sev\_migrate\_from")
Cc: stable@vger.kernel.org
Cc: Peter Gonda
Reviewed-by: Peter Gonda
Reviewed-by: Pankaj Gupta
Link: https://lore.kernel.org/r/20230825022357.2852133-2-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit 713a3ab70439babbc1e44894179086ff88ae0ae4
Author: Sean Christopherson
Date: Thu Aug 24 18:36:18 2023 -0700
KVM: SVM: Don't inject #UD if KVM attempts to skip SEV guest insn
commit cb49631ad111570f1bad37702c11c2ae07fa2e3c upstream.
Don't inject a #UD if KVM attempts to "emulate" to skip an instruction
for an SEV guest, and instead resume the guest and hope that it can make
forward progress. When commit 04c40f344def ("KVM: SVM: Inject #UD on
attempted emulation for SEV guest w/o insn buffer") added the completely
arbitrary #UD behavior, there were no known scenarios where a well-behaved
guest would induce a VM-Exit that triggered emulation, i.e. it was thought
that injecting #UD would be helpful.
However, now that KVM (correctly) attempts to re-inject INT3/INTO, e.g. if
a #NPF is encountered when attempting to deliver the INT3/INTO, an SEV
guest can trigger emulation without a buffer, through no fault of its own.
Resuming the guest and retrying the INT3/INTO is architecturally wrong,
e.g. the vCPU will incorrectly re-hit code #DBs, but for SEV guests there
is literally no other option that has a chance of making forward progress.
Drop the #UD injection for all "skip" emulation, not just those related to
INT3/INTO, even though that means that the guest will likely end up in an
infinite loop instead of getting a #UD (the vCPU may also crash, e.g. if
KVM emulated everything about an instruction except for advancing RIP).
There's no evidence that suggests that an unexpected #UD is actually
better than hanging the vCPU, e.g. a soft-hung vCPU can still respond to
IRQs and NMIs to generate a backtrace.
Reported-by: Wu Zongyo
Closes: https://lore.kernel.org/all/8eb933fd-2cf3-d7a9-32fe-2a1d82eac42a@mail.ustc.edu.cn
Fixes: 6ef88d6e36c2 ("KVM: SVM: Re-inject INT3/INTO instead of retrying the instruction")
Cc: stable@vger.kernel.org
Cc: Tom Lendacky
Link: https://lore.kernel.org/r/20230825013621.2845700-2-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit 133962a91462758200c6f48280fd87d919fa5f24
Author: Sean Christopherson
Date: Tue Aug 8 16:31:31 2023 -0700
KVM: SVM: Take and hold ir\_list\_lock when updating vCPU's Physical ID entry
commit 4c08e737f056fec930b416a2bd37ed266d724f95 upstream.
Hoist the acquisition of ir\_list\_lock from avic\_update\_iommu\_vcpu\_affinity()
to its two callers, avic\_vcpu\_load() and avic\_vcpu\_put(), specifically to
encapsulate the write to the vCPU's entry in the AVIC Physical ID table.
This will allow a future fix to pull information from the Physical ID entry
when updating the IRTE, without potentially consuming stale information,
i.e. without racing with the vCPU being (un)loaded.
Add a comment to call out that ir\_list\_lock does NOT protect against
multiple writers, specifically that reading the Physical ID entry in
avic\_vcpu\_put() outside of the lock is safe.
To preserve some semblance of independence from ir\_list\_lock, keep the
READ\_ONCE() in avic\_vcpu\_load() even though acuiring the spinlock
effectively ensures the load(s) will be generated after acquiring the
lock.
Cc: stable@vger.kernel.org
Tested-by: Alejandro Jimenez
Reviewed-by: Joao Martins
Link: https://lore.kernel.org/r/20230808233132.2499764-2-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit c6b4258ab85d4ab5d4353ff6a590cd32edbaec48
Author: Sean Christopherson
Date: Thu Aug 24 18:45:32 2023 -0700
KVM: VMX: Refresh available regs and IDT vectoring info before NMI handling
commit 50011c2a245792993f2756e5b5b571512bfa409e upstream.
Reset the mask of available "registers" and refresh the IDT vectoring
info snapshot in vmx\_vcpu\_enter\_exit(), before KVM potentially handles a
an NMI VM-Exit. One of the "registers" that KVM VMX lazily loads is the
vmcs.VM\_EXIT\_INTR\_INFO field, which is holds the vector+type on "exception
or NMI" VM-Exits, i.e. is needed to identify NMIs. Clearing the available
registers bitmask after handling NMIs results in KVM querying info from
the last VM-Exit that read vmcs.VM\_EXIT\_INTR\_INFO, and leads to both
missed NMIs and spurious NMIs in the host.
Opportunistically grab vmcs.IDT\_VECTORING\_INFO\_FIELD early in the VM-Exit
path too, e.g. to guard against similar consumption of stale data. The
field is read on every "normal" VM-Exit, and there's no point in delaying
the inevitable.
Reported-by: Like Xu
Fixes: 11df586d774f ("KVM: VMX: Handle NMI VM-Exits in noinstr region")
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230825014532.2846714-1-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit 240713e695abba407df9c917b16f9818bd42bbc2
Author: Hamza Mahfooz
Date: Tue Sep 5 13:27:22 2023 -0400
drm/amd/display: prevent potential division by zero errors
commit 07e388aab042774f284a2ad75a70a194517cdad4 upstream.
There are two places in apply\_below\_the\_range() where it's possible for
a divide by zero error to occur. So, to fix this make sure the divisor
is non-zero before attempting the computation in both cases.
Cc: stable@vger.kernel.org
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2637
Fixes: a463b263032f ("drm/amd/display: Fix frames\_to\_insert math")
Fixes: ded6119e825a ("drm/amd/display: Reinstate LFC optimization")
Reviewed-by: Aurabindo Pillai
Signed-off-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit f5da0ee56e5f103c91cb3601fa945d52c82dd715
Author: Hamza Mahfooz
Date: Thu Aug 31 15:22:35 2023 -0400
drm/amd/display: limit the v\_startup workaround to ASICs older than DCN3.1
commit 47428f4b638d3b3264a2efa1a567b0bbddbb6107 upstream.
Since, calling dcn20\_adjust\_freesync\_v\_startup() on DCN3.1+ ASICs
can cause the display to flicker and underflow to occur, we shouldn't
call it for them. So, ensure that the DCN version is less than
DCN\_VERSION\_3\_1 before calling dcn20\_adjust\_freesync\_v\_startup().
Cc: stable@vger.kernel.org
Reviewed-by: Fangzhi Zuo
Signed-off-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit df1092760dc2d6a81487f3aa437fe4cbb3370ccd
Author: Melissa Wen
Date: Thu Aug 31 15:12:28 2023 -0100
drm/amd/display: enable cursor degamma for DCN3+ DRM legacy gamma
commit 57a943ebfcdb4a97fbb409640234bdb44bfa1953 upstream.
For DRM legacy gamma, AMD display manager applies implicit sRGB degamma
using a pre-defined sRGB transfer function. It works fine for DCN2
family where degamma ROM and custom curves go to the same color block.
But, on DCN3+, degamma is split into two blocks: degamma ROM for
pre-defined TFs and `gamma correction` for user/custom curves and
degamma ROM settings doesn't apply to cursor plane. To get DRM legacy
gamma working as expected, enable cursor degamma ROM for implict sRGB
degamma on HW with this configuration.
Cc: stable@vger.kernel.org
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2803
Fixes: 96b020e2163f ("drm/amd/display: check attr flag before set cursor degamma on DCN3+")
Signed-off-by: Melissa Wen
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit cc502fe191074c208cb9fe32ce5bda29c720a7b1
Author: Hamza Mahfooz
Date: Thu Aug 31 15:17:14 2023 -0400
Revert "drm/amd/display: Remove v\_startup workaround for dcn3+"
commit a81de4a22bbe3183b7f0d6f13f592b8f5b5a3c18 upstream.
This reverts commit 3a31e8b89b7240d9a17ace8a1ed050bdcb560f9e.
We still need to call dcn20\_adjust\_freesync\_v\_startup() for older DCN3+
ASICs. Otherwise, it can cause DP to HDMI 2.1 PCONs to fail to light up.
Cc: stable@vger.kernel.org
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2809
Reviewed-by: Fangzhi Zuo
Reviewed-by: Harry Wentland
Signed-off-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 4a9928c8c489964a0223a84a09b7fc25426ccdc2
Author: William Zhang
Date: Thu Jul 6 11:29:05 2023 -0700
mtd: rawnand: brcmnand: Fix ECC level field setting for v7.2 controller
commit 2ec2839a9062db8a592525a3fdabd42dcd9a3a9b upstream.
v7.2 controller has different ECC level field size and shift in the acc
control register than its predecessor and successor controller. It needs
to be set specifically.
Fixes: decba6d47869 ("mtd: brcmnand: Add v7.2 controller support")
Signed-off-by: William Zhang
Reviewed-by: Florian Fainelli
Cc: stable@vger.kernel.org
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20230706182909.79151-2-william.zhang@broadcom.com
Signed-off-by: Greg Kroah-Hartman
commit 15c066155d9f9be3c1fdd1ead7385ff106af08f8
Author: William Zhang
Date: Thu Jul 6 11:29:06 2023 -0700
mtd: rawnand: brcmnand: Fix potential false time out warning
commit 9cc0a598b944816f2968baf2631757f22721b996 upstream.
If system is busy during the command status polling function, the driver
may not get the chance to poll the status register till the end of time
out and return the premature status. Do a final check after time out
happens to ensure reading the correct status.
Fixes: 9d2ee0a60b8b ("mtd: nand: brcmnand: Check flash #WP pin status before nand erase/program")
Signed-off-by: William Zhang
Reviewed-by: Florian Fainelli
Cc: stable@vger.kernel.org
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20230706182909.79151-3-william.zhang@broadcom.com
Signed-off-by: Greg Kroah-Hartman
commit 17584a3d9b814c61044795036e50e285946c111a
Author: Linus Walleij
Date: Tue Jul 18 13:56:11 2023 +0200
mtd: spi-nor: Correct flags for Winbond w25q128
commit 83e824a4a595132f9bd7ac4f5afff857bfc5991e upstream.
The Winbond "w25q128" (actual vendor name W25Q128JV) has
exactly the same flags as the sibling device "w25q128jv".
The devices both require unlocking to enable write access.
The actual product naming between devices vs the Linux
strings in winbond.c:
0xef4018: "w25q128" W25Q128JV-IN/IQ/JQ
0xef7018: "w25q128jv" W25Q128JV-IM/JM
The latter device, "w25q128jv" supports features named DTQ
and QPI, otherwise it is the same.
Not having the right flags has the annoying side effect
that write access does not work.
After this patch I can write to the flash on the Inteno
XG6846 router.
The flash memory also supports dual and quad SPI modes.
This does not currently manifest, but by turning on SFDP
parsing, the right SPI modes are emitted in
/sys/kernel/debug/spi-nor/spi1.0/capabilities
for this chip, so we also turn on this.
Since we now have determined that SFDP parsing works on
the device, we also detect the geometry using SFDP.
After this dmesg and sysfs says:
[ 1.062401] spi-nor spi1.0: w25q128 (16384 Kbytes)
cat erasesize
65536
(16384\*1024)/65536 = 256 sectors
spi-nor sysfs:
cat jedec\_id
ef4018
cat manufacturer
winbond
cat partname
w25q128
hexdump -v -C sfdp
00000000 53 46 44 50 05 01 00 ff 00 05 01 10 80 00 00 ff
00000010 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
00000020 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
00000030 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
00000040 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
00000050 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
00000060 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
00000070 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
00000080 e5 20 f9 ff ff ff ff 07 44 eb 08 6b 08 3b 42 bb
00000090 fe ff ff ff ff ff 00 00 ff ff 40 eb 0c 20 0f 52
000000a0 10 d8 00 00 36 02 a6 00 82 ea 14 c9 e9 63 76 33
000000b0 7a 75 7a 75 f7 a2 d5 5c 19 f7 4d ff e9 30 f8 80
Cc: stable@vger.kernel.org
Suggested-by: Michael Walle
Reviewed-by: Michael Walle
Signed-off-by: Linus Walleij
Link: https://lore.kernel.org/r/20230718-spi-nor-winbond-w25q128-v5-1-a73653ee46c3@linaro.org
Signed-off-by: Tudor Ambarus
Signed-off-by: Greg Kroah-Hartman
commit 648d1150a688698e37f7aaf302860180901cb30e
Author: William Zhang
Date: Thu Jul 6 11:29:08 2023 -0700
mtd: rawnand: brcmnand: Fix potential out-of-bounds access in oob write
commit 5d53244186c9ac58cb88d76a0958ca55b83a15cd upstream.
When the oob buffer length is not in multiple of words, the oob write
function does out-of-bounds read on the oob source buffer at the last
iteration. Fix that by always checking length limit on the oob buffer
read and fill with 0xff when reaching the end of the buffer to the oob
registers.
Fixes: 27c5b17cd1b1 ("mtd: nand: add NAND driver "library" for Broadcom STB NAND controller")
Signed-off-by: William Zhang
Reviewed-by: Florian Fainelli
Cc: stable@vger.kernel.org
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20230706182909.79151-5-william.zhang@broadcom.com
Signed-off-by: Greg Kroah-Hartman
commit dc4085bef6bdcff4d0836fd772c7da4d2bb0bc04
Author: William Zhang
Date: Thu Jul 6 11:29:07 2023 -0700
mtd: rawnand: brcmnand: Fix crash during the panic\_write
commit e66dd317194daae0475fe9e5577c80aa97f16cb9 upstream.
When executing a NAND command within the panic write path, wait for any
pending command instead of calling BUG\_ON to avoid crashing while
already crashing.
Fixes: 27c5b17cd1b1 ("mtd: nand: add NAND driver "library" for Broadcom STB NAND controller")
Signed-off-by: William Zhang
Reviewed-by: Florian Fainelli
Reviewed-by: Kursad Oney
Reviewed-by: Kamal Dasu
Cc: stable@vger.kernel.org
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20230706182909.79151-4-william.zhang@broadcom.com
Signed-off-by: Greg Kroah-Hartman
commit 0f98de0a11d29821d9448114178ddc1b1fe32a18
Author: Liu Ying
Date: Mon Jun 12 17:23:59 2023 +0800
drm/mxsfb: Disable overlay plane in mxsfb\_plane\_overlay\_atomic\_disable()
commit aa656d48e871a1b062e1bbf9474d8b831c35074c upstream.
When disabling overlay plane in mxsfb\_plane\_overlay\_atomic\_update(),
overlay plane's framebuffer pointer is NULL. So, dereferencing it would
cause a kernel Oops(NULL pointer dereferencing). Fix the issue by
disabling overlay plane in mxsfb\_plane\_overlay\_atomic\_disable() instead.
Fixes: cb285a5348e7 ("drm: mxsfb: Replace mxsfb\_get\_fb\_paddr() with drm\_fb\_cma\_get\_gem\_addr()")
Cc: stable@vger.kernel.org # 5.19+
Signed-off-by: Liu Ying
Reviewed-by: Marek Vasut
Signed-off-by: Marek Vasut
Link: https://patchwork.freedesktop.org/patch/msgid/20230612092359.784115-1-victor.liu@nxp.com
Signed-off-by: Greg Kroah-Hartman
commit ce585c9b1cd700324fecedae130a9c35261fec30
Author: Qu Wenruo
Date: Thu Aug 3 14:33:31 2023 +0800
btrfs: scrub: fix grouping of read IO
commit ae76d8e3e1351aa1ba09cc68dab6866d356f2e17 upstream.
[REGRESSION]
There are several regression reports about the scrub performance with
v6.4 kernel.
On a PCIe 3.0 device, the old v6.3 kernel can go 3GB/s scrub speed, but
v6.4 can only go 1GB/s, an obvious 66% performance drop.
[CAUSE]
Iostat shows a very different behavior between v6.3 and v6.4 kernel:
Device r/s rkB/s rrqm/s %rrqm r\_await rareq-sz aqu-sz %util
nvme0n1p3 9731.00 3425544.00 17237.00 63.92 2.18 352.02 21.18 100.00
nvme0n1p3 15578.00 993616.00 5.00 0.03 0.09 63.78 1.32 100.00
The upper one is v6.3 while the lower one is v6.4.
There are several obvious differences:
- Very few read merges
This turns out to be a behavior change that we no longer do bio
plug/unplug.
- Very low aqu-sz
This is due to the submit-and-wait behavior of flush\_scrub\_stripes(),
and extra extent/csum tree search.
Both behaviors are not that obvious on SATA SSDs, as SATA SSDs have NCQ
to merge the reads, while SATA SSDs can not handle high queue depth well
either.
[FIX]
For now this patch focuses on the read speed fix. Dev-replace replace
speed needs more work.
For the read part, we go two directions to fix the problems:
- Re-introduce blk plug/unplug to merge read requests
This is pretty simple, and the behavior is pretty easy to observe.
This would enlarge the average read request size to 512K.
- Introduce multi-group reads and no longer wait for each group
Instead of the old behavior, which submits 8 stripes and waits for
them, here we would enlarge the total number of stripes to 16 \* 8.
Which is 8M per device, the same limit as the old scrub in-flight
bios size limit.
Now every time we fill a group (8 stripes), we submit them and
continue to next stripes.
Only when the full 16 \* 8 stripes are all filled, we submit the
remaining ones (the last group), and wait for all groups to finish.
Then submit the repair writes and dev-replace writes.
This should enlarge the queue depth.
This would greatly improve the merge rate (thus read block size) and
queue depth:
Before (with regression, and cached extent/csum path):
Device r/s rkB/s rrqm/s %rrqm r\_await rareq-sz aqu-sz %util
nvme0n1p3 20666.00 1318240.00 10.00 0.05 0.08 63.79 1.63 100.00
After (with all patches applied):
nvme0n1p3 5165.00 2278304.00 30557.00 85.54 0.55 441.10 2.81 100.00
i.e. 1287 to 2224 MB/s.
CC: stable@vger.kernel.org # 6.4+
Signed-off-by: Qu Wenruo
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 6a1a0e43b1eed39c0dbfd4591238d74991dd861d
Author: Qu Wenruo
Date: Thu Aug 3 14:33:30 2023 +0800
btrfs: scrub: avoid unnecessary csum tree search preparing stripes
commit 3c771c194402ffe20d4de68d9fc21e703179a9ce upstream.
One of the bottleneck of the new scrub code is the extra csum tree
search.
The old code would only do the csum tree search for each scrub bio,
which can be as large as 512KiB, thus they can afford to allocate a new
path each time.
But the new scrub code is doing csum tree search for each stripe, which
is only 64KiB, this means we'd better re-use the same csum path during
each search.
This patch would introduce a per-sctx path for csum tree search, as we
don't need to re-allocate the path every time we need to do a csum tree
search.
With this change we can further improve the queue depth and improve the
scrub read performance:
Before (with regression and cached extent tree path):
Device r/s rkB/s rrqm/s %rrqm r\_await rareq-sz aqu-sz %util
nvme0n1p3 15875.00 1013328.00 12.00 0.08 0.08 63.83 1.35 100.00
After (with both cached extent/csum tree path):
nvme0n1p3 17759.00 1133280.00 10.00 0.06 0.08 63.81 1.50 100.00
Fixes: e02ee89baa66 ("btrfs: scrub: switch scrub\_simple\_mirror() to scrub\_stripe infrastructure")
CC: stable@vger.kernel.org # 6.4+
Signed-off-by: Qu Wenruo
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 5a5b4a234bfa7ac60cf60991dd85ac16e72a89fe
Author: Qu Wenruo
Date: Thu Aug 3 14:33:29 2023 +0800
btrfs: scrub: avoid unnecessary extent tree search preparing stripes
commit 1dc4888e725dc748b82858984f2a5bd41efc5201 upstream.
Since commit e02ee89baa66 ("btrfs: scrub: switch scrub\_simple\_mirror()
to scrub\_stripe infrastructure"), scrub no longer re-use the same path
for extent tree search.
This can lead to unnecessary extent tree search, especially for the new
stripe based scrub, as we have way more stripes to prepare.
This patch would re-introduce a shared path for extent tree search, and
properly release it when the block group is scrubbed.
This change alone can improve scrub performance slightly by reducing the
time spend preparing the stripe thus improving the queue depth.
Before (with regression):
Device r/s rkB/s rrqm/s %rrqm r\_await rareq-sz aqu-sz %util
nvme0n1p3 15578.00 993616.00 5.00 0.03 0.09 63.78 1.32 100.00
After (with this patch):
nvme0n1p3 15875.00 1013328.00 12.00 0.08 0.08 63.83 1.35 100.00
Fixes: e02ee89baa66 ("btrfs: scrub: switch scrub\_simple\_mirror() to scrub\_stripe infrastructure")
CC: stable@vger.kernel.org # 6.4+
Signed-off-by: Qu Wenruo
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 06a03d77043364fe5181504e88ecf594ddf633f9
Author: Anand Jain
Date: Mon Jul 31 19:16:34 2023 +0800
btrfs: use the correct superblock to compare fsid in btrfs\_validate\_super
commit d167aa76dc0683828588c25767da07fb549e4f48 upstream.
The function btrfs\_validate\_super() should verify the fsid in the provided
superblock argument. Because, all its callers expect it to do that.
Such as in the following stack:
write\_all\_supers()
sb = fs\_info->super\_for\_commit;
btrfs\_validate\_write\_super(.., sb)
btrfs\_validate\_super(.., sb, ..)
scrub\_one\_super()
btrfs\_validate\_super(.., sb, ..)
And
check\_dev\_super()
btrfs\_validate\_super(.., sb, ..)
However, it currently verifies the fs\_info::super\_copy::fsid instead,
which is not correct. Fix this using the correct fsid in the superblock
argument.
CC: stable@vger.kernel.org # 5.4+
Reviewed-by: Johannes Thumshirn
Tested-by: Guilherme G. Piccoli
Signed-off-by: Anand Jain
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit b8dd2239e46f2dcba1d561899da7d146698dd37c
Author: Naohiro Aota
Date: Tue Aug 8 01:12:40 2023 +0900
btrfs: zoned: re-enable metadata over-commit for zoned mode
commit 5b135b382a360f4c87cf8896d1465b0b07f10cb0 upstream.
Now that, we can re-enable metadata over-commit. As we moved the activation
from the reservation time to the write time, we no longer need to ensure
all the reserved bytes is properly activated.
Without the metadata over-commit, it suffers from lower performance because
it needs to flush the delalloc items more often and allocate more block
groups. Re-enabling metadata over-commit will solve the issue.
Fixes: 79417d040f4f ("btrfs: zoned: disable metadata overcommit for zoned")
CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Johannes Thumshirn
Signed-off-by: Naohiro Aota
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 9d1e020ed9649cf140fcfafd052cfdcce9e9d67d
Author: Josef Bacik
Date: Mon Jul 31 11:13:00 2023 -0400
btrfs: set page extent mapped after read\_folio in relocate\_one\_page
commit e7f1326cc24e22b38afc3acd328480a1183f9e79 upstream.
One of the CI runs triggered the following panic
assertion failed: PagePrivate(page) && page->private, in fs/btrfs/subpage.c:229
------------[ cut here ]------------
kernel BUG at fs/btrfs/subpage.c:229!
Internal error: Oops - BUG: 00000000f2000800 [#1] SMP
CPU: 0 PID: 923660 Comm: btrfs Not tainted 6.5.0-rc3+ #1
pstate: 61400005 (nZCv daif +PAN -UAO -TCO +DIT -SSBS BTYPE=--)
pc : btrfs\_subpage\_assert+0xbc/0xf0
lr : btrfs\_subpage\_assert+0xbc/0xf0
sp : ffff800093213720
x29: ffff800093213720 x28: ffff8000932138b4 x27: 000000000c280000
x26: 00000001b5d00000 x25: 000000000c281000 x24: 000000000c281fff
x23: 0000000000001000 x22: 0000000000000000 x21: ffffff42b95bf880
x20: ffff42b9528e0000 x19: 0000000000001000 x18: ffffffffffffffff
x17: 667274622f736620 x16: 6e69202c65746176 x15: 0000000000000028
x14: 0000000000000003 x13: 00000000002672d7 x12: 0000000000000000
x11: ffffcd3f0ccd9204 x10: ffffcd3f0554ae50 x9 : ffffcd3f0379528c
x8 : ffff800093213428 x7 : 0000000000000000 x6 : ffffcd3f091771e8
x5 : ffff42b97f333948 x4 : 0000000000000000 x3 : 0000000000000000
x2 : 0000000000000000 x1 : ffff42b9556cde80 x0 : 000000000000004f
Call trace:
btrfs\_subpage\_assert+0xbc/0xf0
btrfs\_subpage\_set\_dirty+0x38/0xa0
btrfs\_page\_set\_dirty+0x58/0x88
relocate\_one\_page+0x204/0x5f0
relocate\_file\_extent\_cluster+0x11c/0x180
relocate\_data\_extent+0xd0/0xf8
relocate\_block\_group+0x3d0/0x4e8
btrfs\_relocate\_block\_group+0x2d8/0x490
btrfs\_relocate\_chunk+0x54/0x1a8
btrfs\_balance+0x7f4/0x1150
btrfs\_ioctl+0x10f0/0x20b8
\_\_arm64\_sys\_ioctl+0x120/0x11d8
invoke\_syscall.constprop.0+0x80/0xd8
do\_el0\_svc+0x6c/0x158
el0\_svc+0x50/0x1b0
el0t\_64\_sync\_handler+0x120/0x130
el0t\_64\_sync+0x194/0x198
Code: 91098021 b0007fa0 91346000 97e9c6d2 (d4210000)
This is the same problem outlined in 17b17fcd6d44 ("btrfs:
set\_page\_extent\_mapped after read\_folio in btrfs\_cont\_expand") , and the
fix is the same. I originally looked for the same pattern elsewhere in
our code, but mistakenly skipped over this code because I saw the page
cache readahead before we set\_page\_extent\_mapped, not realizing that
this was only in the !page case, that we can still end up with a
!uptodate page and then do the btrfs\_read\_folio further down.
The fix here is the same as the above mentioned patch, move the
set\_page\_extent\_mapped call to after the btrfs\_read\_folio() block to
make sure that we have the subpage blocksize stuff setup properly before
using the page.
CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Filipe Manana
Signed-off-by: Josef Bacik
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 70fa3d4a856d52ba72619b49d8181a053fa47d50
Author: Filipe Manana
Date: Wed Jul 26 16:56:57 2023 +0100
btrfs: don't start transaction when joining with TRANS\_JOIN\_NOSTART
commit 4490e803e1fe9fab8db5025e44e23b55df54078b upstream.
When joining a transaction with TRANS\_JOIN\_NOSTART, if we don't find a
running transaction we end up creating one. This goes against the purpose
of TRANS\_JOIN\_NOSTART which is to join a running transaction if its state
is at or below the state TRANS\_STATE\_COMMIT\_START, otherwise return an
-ENOENT error and don't start a new transaction. So fix this to not create
a new transaction if there's no running transaction at or below that
state.
CC: stable@vger.kernel.org # 4.14+
Fixes: a6d155d2e363 ("Btrfs: fix deadlock between fiemap and transaction commits")
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit b5cd2c8a07c61040ef7418f2188dbced4d206f7b
Author: Boris Burkov
Date: Fri Jul 21 09:02:06 2023 -0700
btrfs: free qgroup rsv on io failure
commit e28b02118b94e42be3355458a2406c6861e2dd32 upstream.
If we do a write whose bio suffers an error, we will never reclaim the
qgroup reserved space for it. We allocate the space in the write\_iter
codepath, then release the reservation as we allocate the ordered
extent, but we only create a delayed ref if the ordered extent finishes.
If it has an error, we simply leak the rsv. This is apparent in running
any error injecting (dmerror) fstests like btrfs/146 or btrfs/160. Such
tests fail due to dmesg on umount complaining about the leaked qgroup
data space.
When we clean up other aspects of space on failed ordered\_extents, also
free the qgroup rsv.
Reviewed-by: Josef Bacik
CC: stable@vger.kernel.org # 5.10+
Signed-off-by: Boris Burkov
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 6fd4d27daccbcd0e79d9f7eb58a4d21dbbd3158a
Author: Boris Burkov
Date: Fri Jul 21 09:02:07 2023 -0700
btrfs: fix start transaction qgroup rsv double free
commit a6496849671a5bc9218ecec25a983253b34351b1 upstream.
btrfs\_start\_transaction reserves metadata space of the PERTRANS type
before it identifies a transaction to start/join. This allows flushing
when reserving that space without a deadlock. However, it results in a
race which temporarily breaks qgroup rsv accounting.
T1 T2
start\_transaction
do\_stuff
start\_transaction
qgroup\_reserve\_meta\_pertrans
commit\_transaction
qgroup\_free\_meta\_all\_pertrans
hit an error starting txn
goto reserve\_fail
qgroup\_free\_meta\_pertrans (already freed!)
The basic issue is that there is nothing preventing another commit from
committing before start\_transaction finishes (in fact sometimes we
intentionally wait for it) so any error path that frees the reserve is
at risk of this race.
While this exact space was getting freed anyway, and it's not a huge
deal to double free it (just a warning, the free code catches this), it
can result in incorrectly freeing some other pertrans reservation in
this same reservation, which could then lead to spuriously granting
reservations we might not have the space for. Therefore, I do believe it
is worth fixing.
To fix it, use the existing prealloc->pertrans conversion mechanism.
When we first reserve the space, we reserve prealloc space and only when
we are sure we have a transaction do we convert it to pertrans. This way
any racing commits do not blow away our reservation, but we still get a
pertrans reservation that is freed when \_this\_ transaction gets committed.
This issue can be reproduced by running generic/269 with either qgroups
or squotas enabled via mkfs on the scratch device.
Reviewed-by: Josef Bacik
CC: stable@vger.kernel.org # 5.10+
Signed-off-by: Boris Burkov
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 7b2d588572e75489341ea60ff809c6d6c4b746f9
Author: Naohiro Aota
Date: Fri Jul 21 16:42:14 2023 +0900
btrfs: zoned: do not zone finish data relocation block group
commit 332581bde2a419d5f12a93a1cdc2856af649a3cc upstream.
When multiple writes happen at once, we may need to sacrifice a currently
active block group to be zone finished for a new allocation. We choose a
block group with the least free space left, and zone finish it.
To do the finishing, we need to send IOs for already allocated region
and wait for them and on-going IOs. Otherwise, these IOs fail because the
zone is already finished at the time the IO reach a device.
However, if a block group dedicated to the data relocation is zone
finished, there is a chance that finishing it before an ongoing write IO
reaches the device. That is because there is timing gap between an
allocation is done (block\_group->reservations == 0, as pre-allocation is
done) and an ordered extent is created when the relocation IO starts.
Thus, if we finish the zone between them, we can fail the IOs.
We cannot simply use "fs\_info->data\_reloc\_bg == block\_group->start" to
avoid the zone finishing. Because, the data\_reloc\_bg may already switch to
a new block group, while there are still ongoing write IOs to the old
data\_reloc\_bg.
So, this patch reworks the BLOCK\_GROUP\_FLAG\_ZONED\_DATA\_RELOC bit to
indicate there is a data relocation allocation and/or ongoing write to the
block group. The bit is set on allocation and cleared in end\_io function of
the last IO for the currently allocated region.
To change the timing of the bit setting also solves the issue that the bit
being left even after there is no IO going on. With the current code, if
the data\_reloc\_bg switches after the last IO to the current data\_reloc\_bg,
the bit is set at this timing and there is no one clearing that bit. As a
result, that block group is kept unallocatable for anything.
Fixes: 343d8a30851c ("btrfs: zoned: prevent allocation from previous data relocation BG")
Fixes: 74e91b12b115 ("btrfs: zoned: zone finish unused block group")
CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Christoph Hellwig
Reviewed-by: Johannes Thumshirn
Signed-off-by: Naohiro Aota
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit b638e83f6781d0ddcb4954d5726e296ca827472f
Author: ruanmeisi
Date: Tue Apr 25 19:13:54 2023 +0800
fuse: nlookup missing decrement in fuse\_direntplus\_link
commit b8bd342d50cbf606666488488f9fea374aceb2d5 upstream.
During our debugging of glusterfs, we found an Assertion failed error:
inode\_lookup >= nlookup, which was caused by the nlookup value in the
kernel being greater than that in the FUSE file system.
The issue was introduced by fuse\_direntplus\_link, where in the function,
fuse\_iget increments nlookup, and if d\_splice\_alias returns failure,
fuse\_direntplus\_link returns failure without decrementing nlookup
https://github.com/gluster/glusterfs/pull/4081
Signed-off-by: ruanmeisi
Fixes: 0b05b18381ee ("fuse: implement NFS-like readdirplus support")
Cc:  # v3.9
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 3583d05ab60f100eac5fc7ec1e7ab19ba5eb4a98
Author: Damien Le Moal
Date: Thu Aug 24 07:41:59 2023 +0900
ata: pata\_ftide010: Add missing MODULE\_DESCRIPTION
commit 7274eef5729037300f29d14edeb334a47a098f65 upstream.
Add the missing MODULE\_DESCRIPTION() to avoid warnings such as:
WARNING: modpost: missing MODULE\_DESCRIPTION() in drivers/ata/pata\_ftide010.o
when compiling with W=1.
Fixes: be4e456ed3a5 ("ata: Add driver for Faraday Technology FTIDE010")
Cc: stable@vger.kernel.org
Signed-off-by: Damien Le Moal
Reviewed-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 45139e7f21ea767795fe100ced1bb8e78d8d8d23
Author: Damien Le Moal
Date: Thu Aug 24 07:43:18 2023 +0900
ata: sata\_gemini: Add missing MODULE\_DESCRIPTION
commit 8566572bf3b4d6e416a4bf2110dbb4817d11ba59 upstream.
Add the missing MODULE\_DESCRIPTION() to avoid warnings such as:
WARNING: modpost: missing MODULE\_DESCRIPTION() in drivers/ata/sata\_gemini.o
when compiling with W=1.
Fixes: be4e456ed3a5 ("ata: Add driver for Faraday Technology FTIDE010")
Cc: stable@vger.kernel.org
Signed-off-by: Damien Le Moal
Reviewed-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit a9ddf95ac5a2810fdc2920c634865773614fee6d
Author: Michael Schmitz
Date: Sun Aug 27 16:13:47 2023 +1200
ata: pata\_falcon: fix IO base selection for Q40
commit 8a1f00b753ecfdb117dc1a07e68c46d80e7923ea upstream.
With commit 44b1fbc0f5f3 ("m68k/q40: Replace q40ide driver
with pata\_falcon and falconide"), the Q40 IDE driver was
replaced by pata\_falcon.c.
Both IO and memory resources were defined for the Q40 IDE
platform device, but definition of the IDE register addresses
was modeled after the Falcon case, both in use of the memory
resources and in including register shift and byte vs. word
offset in the address.
This was correct for the Falcon case, which does not apply
any address translation to the register addresses. In the
Q40 case, all of device base address, byte access offset
and register shift is included in the platform specific
ISA access translation (in asm/mm\_io.h).
As a consequence, such address translation gets applied
twice, and register addresses are mangled.
Use the device base address from the platform IO resource
for Q40 (the IO address translation will then add the correct
ISA window base address and byte access offset), with register
shift 1. Use MMIO base address and register shift 2 as before
for Falcon.
Encode PIO\_OFFSET into IO port addresses for all registers
for Q40 except the data transfer register. Encode the MMIO
offset there (pata\_falcon\_data\_xfer() directly uses raw IO
with no address translation).
Reported-by: William R Sowerbutts
Closes: https://lore.kernel.org/r/CAMuHMdUU62jjunJh9cqSqHT87B0H0A4udOOPs=WN7WZKpcagVA@mail.gmail.com
Link: https://lore.kernel.org/r/CAMuHMdUU62jjunJh9cqSqHT87B0H0A4udOOPs=WN7WZKpcagVA@mail.gmail.com
Fixes: 44b1fbc0f5f3 ("m68k/q40: Replace q40ide driver with pata\_falcon and falconide")
Cc: stable@vger.kernel.org
Cc: Finn Thain
Cc: Geert Uytterhoeven
Tested-by: William R Sowerbutts
Signed-off-by: Michael Schmitz
Reviewed-by: Sergey Shtylyov
Reviewed-by: Geert Uytterhoeven
Signed-off-by: Damien Le Moal
Signed-off-by: Greg Kroah-Hartman
commit 247d2f1f5a3cdb56b0486be23016586ca3341ff7
Author: Werner Fischer
Date: Tue Aug 29 13:33:58 2023 +0200
ata: ahci: Add Elkhart Lake AHCI controller
commit 2a2df98ec592667927b5c1351afa6493ea125c9f upstream.
Elkhart Lake is the successor of Apollo Lake and Gemini Lake. These
CPUs and their PCHs are used in mobile and embedded environments.
With this patch I suggest that Elkhart Lake SATA controllers [1] should
use the default LPM policy for mobile chipsets.
The disadvantage of missing hot-plug support with this setting should
not be an issue, as those CPUs are used in embedded environments and
not in servers with hot-plug backplanes.
We discovered that the Elkhart Lake SATA controllers have been missing
in ahci.c after a customer reported the throttling of his SATA SSD
after a short period of higher I/O. We determined the high temperature
of the SSD controller in idle mode as the root cause for that.
Depending on the used SSD, we have seen up to 1.8 Watt lower system
idle power usage and up to 30°C lower SSD controller temperatures in
our tests, when we set med\_power\_with\_dipm manually. I have provided a
table showing seven different SATA SSDs from ATP, Intel/Solidigm and
Samsung [2].
Intel lists a total of 3 SATA controller IDs (4B60, 4B62, 4B63) in [1]
for those mobile PCHs.
This commit just adds 0x4b63 as I do not have test systems with 0x4b60
and 0x4b62 SATA controllers.
I have tested this patch with a system which uses 0x4b63 as SATA
controller.
[1] https://sata-io.org/product/8803
[2] https://www.thomas-krenn.com/en/wiki/SATA\_Link\_Power\_Management#Example\_LES\_v4
Signed-off-by: Werner Fischer
Cc: stable@vger.kernel.org
Signed-off-by: Damien Le Moal
Signed-off-by: Greg Kroah-Hartman
commit b9d30c38ee859d833a51131b5b4b864c7a6219d0
Author: Johannes Weiner
Date: Wed Aug 23 15:54:30 2023 -0700
memcontrol: ensure memcg acquired by id is properly set up
commit 6f0df8e16eb543167f2929cb756e695709a3551d upstream.
In the eviction recency check, we attempt to retrieve the memcg to which
the folio belonged when it was evicted, by the memcg id stored in the
shadow entry. However, there is a chance that the retrieved memcg is not
the original memcg that has been killed, but a new one which happens to
have the same id.
This is a somewhat unfortunate, but acceptable and rare inaccuracy in the
heuristics. However, if we retrieve this new memcg between its allocation
and when it is properly attached to the memcg hierarchy, we could run into
the following NULL pointer exception during the memcg hierarchy traversal
done in mem\_cgroup\_get\_nr\_swap\_pages():
[ 155757.793456] BUG: kernel NULL pointer dereference, address: 00000000000000c0
[ 155757.807568] #PF: supervisor read access in kernel mode
[ 155757.818024] #PF: error\_code(0x0000) - not-present page
[ 155757.828482] PGD 401f77067 P4D 401f77067 PUD 401f76067 PMD 0
[ 155757.839985] Oops: 0000 [#1] SMP
[ 155757.887870] RIP: 0010:mem\_cgroup\_get\_nr\_swap\_pages+0x3d/0xb0
[ 155757.899377] Code: 29 19 4a 02 48 39 f9 74 63 48 8b 97 c0 00 00 00 48 8b b7 58 02 00 00 48 2b b7 c0 01 00 00 48 39 f0 48 0f 4d c6 48 39 d1 74 42 <48> 8b b2 c0 00 00 00 48 8b ba 58 02 00 00 48 2b ba c0 01 00 00 48
[ 155757.937125] RSP: 0018:ffffc9002ecdfbc8 EFLAGS: 00010286
[ 155757.947755] RAX: 00000000003a3b1c RBX: 000007ffffffffff RCX: ffff888280183000
[ 155757.962202] RDX: 0000000000000000 RSI: 0007ffffffffffff RDI: ffff888bbc2d1000
[ 155757.976648] RBP: 0000000000000001 R08: 000000000000000b R09: ffff888ad9cedba0
[ 155757.991094] R10: ffffea0039c07900 R11: 0000000000000010 R12: ffff888b23a7b000
[ 155758.005540] R13: 0000000000000000 R14: ffff888bbc2d1000 R15: 000007ffffc71354
[ 155758.019991] FS: 00007f6234c68640(0000) GS:ffff88903f9c0000(0000) knlGS:0000000000000000
[ 155758.036356] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 155758.048023] CR2: 00000000000000c0 CR3: 0000000a83eb8004 CR4: 00000000007706e0
[ 155758.062473] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 155758.076924] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 155758.091376] PKRU: 55555554
[ 155758.096957] Call Trace:
[ 155758.102016]
[ 155758.106502] ? \_\_die+0x78/0xc0
[ 155758.112793] ? page\_fault\_oops+0x286/0x380
[ 155758.121175] ? exc\_page\_fault+0x5d/0x110
[ 155758.129209] ? asm\_exc\_page\_fault+0x22/0x30
[ 155758.137763] ? mem\_cgroup\_get\_nr\_swap\_pages+0x3d/0xb0
[ 155758.148060] workingset\_test\_recent+0xda/0x1b0
[ 155758.157133] workingset\_refault+0xca/0x1e0
[ 155758.165508] filemap\_add\_folio+0x4d/0x70
[ 155758.173538] page\_cache\_ra\_unbounded+0xed/0x190
[ 155758.182919] page\_cache\_sync\_ra+0xd6/0x1e0
[ 155758.191738] filemap\_read+0x68d/0xdf0
[ 155758.199495] ? mlx5e\_napi\_poll+0x123/0x940
[ 155758.207981] ? \_\_napi\_schedule+0x55/0x90
[ 155758.216095] \_\_x64\_sys\_pread64+0x1d6/0x2c0
[ 155758.224601] do\_syscall\_64+0x3d/0x80
[ 155758.232058] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 155758.242473] RIP: 0033:0x7f62c29153b5
[ 155758.249938] Code: e8 48 89 75 f0 89 7d f8 48 89 4d e0 e8 b4 e6 f7 ff 41 89 c0 4c 8b 55 e0 48 8b 55 e8 48 8b 75 f0 8b 7d f8 b8 11 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 33 44 89 c7 48 89 45 f8 e8 e7 e6 f7 ff 48 8b
[ 155758.288005] RSP: 002b:00007f6234c5ffd0 EFLAGS: 00000293 ORIG\_RAX: 0000000000000011
[ 155758.303474] RAX: ffffffffffffffda RBX: 00007f628c4e70c0 RCX: 00007f62c29153b5
[ 155758.318075] RDX: 000000000003c041 RSI: 00007f61d2986000 RDI: 0000000000000076
[ 155758.332678] RBP: 00007f6234c5fff0 R08: 0000000000000000 R09: 0000000064d5230c
[ 155758.347452] R10: 000000000027d450 R11: 0000000000000293 R12: 000000000003c041
[ 155758.362044] R13: 00007f61d2986000 R14: 00007f629e11b060 R15: 000000000027d450
[ 155758.376661]
This patch fixes the issue by moving the memcg's id publication from the
alloc stage to online stage, ensuring that any memcg acquired via id must
be connected to the memcg tree.
Link: https://lkml.kernel.org/r/20230823225430.166925-1-nphamcs@gmail.com
Fixes: f78dfc7b77d5 ("workingset: fix confusion around eviction vs refault container")
Signed-off-by: Johannes Weiner
Co-developed-by: Nhat Pham
Signed-off-by: Nhat Pham
Acked-by: Shakeel Butt
Cc: Yosry Ahmed
Cc: Michal Hocko
Cc: Roman Gushchin
Cc: Muchun Song
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 6ef09eca632f869efdd44ff39cb357f324fc7be9
Author: Christian Marangi
Date: Sun Jul 16 04:28:04 2023 +0200
hwspinlock: qcom: add missing regmap config for SFPB MMIO implementation
commit 23316be8a9d450f33a21f1efe7d89570becbec58 upstream.
Commit 5d4753f741d8 ("hwspinlock: qcom: add support for MMIO on older
SoCs") introduced and made regmap\_config mandatory in the of\_data struct
but didn't add the regmap\_config for sfpb based devices.
SFPB based devices can both use the legacy syscon way to probe or the
new MMIO way and currently device that use the MMIO way are broken as
they lack the definition of the now required regmap\_config and always
return -EINVAL (and indirectly makes fail probing everything that
depends on it, smem, nandc with smem-parser...)
Fix this by correctly adding the missing regmap\_config and restore
function of hwspinlock on SFPB based devices with MMIO implementation.
Cc: stable@vger.kernel.org
Fixes: 5d4753f741d8 ("hwspinlock: qcom: add support for MMIO on older SoCs")
Signed-off-by: Christian Marangi
Link: https://lore.kernel.org/r/20230716022804.21239-1-ansuelsmth@gmail.com
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 4be83c312df6413b2d4191fdcaf16a20f6e496d6
Author: Nathan Chancellor
Date: Mon Aug 7 08:36:28 2023 -0700
lib: test\_scanf: Add explicit type cast to result initialization in test\_number\_prefix()
commit 92382d744176f230101d54f5c017bccd62770f01 upstream.
A recent change in clang allows it to consider more expressions as
compile time constants, which causes it to point out an implicit
conversion in the scanf tests:
lib/test\_scanf.c:661:2: warning: implicit conversion from 'int' to 'unsigned char' changes value from -168 to 88 [-Wconstant-conversion]
661 | test\_number\_prefix(unsigned char, "0xA7", "%2hhx%hhx", 0, 0xa7, 2, check\_uchar);
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
lib/test\_scanf.c:609:29: note: expanded from macro 'test\_number\_prefix'
609 | T result[2] = {~expect[0], ~expect[1]}; \
| ~ ^~~~~~~~~~
1 warning generated.
The result of the bitwise negation is the type of the operand after
going through the integer promotion rules, so this truncation is
expected but harmless, as the initial values in the result array get
overwritten by \_test() anyways. Add an explicit cast to the expected
type in test\_number\_prefix() to silence the warning. There is no
functional change, as all the tests still pass with GCC 13.1.0 and clang
18.0.0.
Cc: stable@vger.kernel.org
Link: https://github.com/ClangBuiltLinux/linuxq/issues/1899
Link: https://github.com/llvm/llvm-project/commit/610ec954e1f81c0e8fcadedcd25afe643f5a094e
Suggested-by: Nick Desaulniers
Signed-off-by: Nathan Chancellor
Reviewed-by: Petr Mladek
Signed-off-by: Petr Mladek
Link: https://lore.kernel.org/r/20230807-test\_scanf-wconstant-conversion-v2-1-839ca39083e1@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 88f10fb3170d3f8f8d7f7212f5cec03c42ef6773
Author: Jaegeuk Kim
Date: Fri Aug 18 11:34:32 2023 -0700
f2fs: avoid false alarm of circular locking
commit 5c13e2388bf3426fd69a89eb46e50469e9624e56 upstream.
======================================================
WARNING: possible circular locking dependency detected
6.5.0-rc5-syzkaller-00353-gae545c3283dc #0 Not tainted
------------------------------------------------------
syz-executor273/5027 is trying to acquire lock:
ffff888077fe1fb0 (&fi->i\_sem){+.+.}-{3:3}, at: f2fs\_down\_write fs/f2fs/f2fs.h:2133 [inline]
ffff888077fe1fb0 (&fi->i\_sem){+.+.}-{3:3}, at: f2fs\_add\_inline\_entry+0x300/0x6f0 fs/f2fs/inline.c:644
but task is already holding lock:
ffff888077fe07c8 (&fi->i\_xattr\_sem){.+.+}-{3:3}, at: f2fs\_down\_read fs/f2fs/f2fs.h:2108 [inline]
ffff888077fe07c8 (&fi->i\_xattr\_sem){.+.+}-{3:3}, at: f2fs\_add\_dentry+0x92/0x230 fs/f2fs/dir.c:783
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&fi->i\_xattr\_sem){.+.+}-{3:3}:
down\_read+0x9c/0x470 kernel/locking/rwsem.c:1520
f2fs\_down\_read fs/f2fs/f2fs.h:2108 [inline]
f2fs\_getxattr+0xb1e/0x12c0 fs/f2fs/xattr.c:532
\_\_f2fs\_get\_acl+0x5a/0x900 fs/f2fs/acl.c:179
f2fs\_acl\_create fs/f2fs/acl.c:377 [inline]
f2fs\_init\_acl+0x15c/0xb30 fs/f2fs/acl.c:420
f2fs\_init\_inode\_metadata+0x159/0x1290 fs/f2fs/dir.c:558
f2fs\_add\_regular\_entry+0x79e/0xb90 fs/f2fs/dir.c:740
f2fs\_add\_dentry+0x1de/0x230 fs/f2fs/dir.c:788
f2fs\_do\_add\_link+0x190/0x280 fs/f2fs/dir.c:827
f2fs\_add\_link fs/f2fs/f2fs.h:3554 [inline]
f2fs\_mkdir+0x377/0x620 fs/f2fs/namei.c:781
vfs\_mkdir+0x532/0x7e0 fs/namei.c:4117
do\_mkdirat+0x2a9/0x330 fs/namei.c:4140
\_\_do\_sys\_mkdir fs/namei.c:4160 [inline]
\_\_se\_sys\_mkdir fs/namei.c:4158 [inline]
\_\_x64\_sys\_mkdir+0xf2/0x140 fs/namei.c:4158
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x38/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
-> #0 (&fi->i\_sem){+.+.}-{3:3}:
check\_prev\_add kernel/locking/lockdep.c:3142 [inline]
check\_prevs\_add kernel/locking/lockdep.c:3261 [inline]
validate\_chain kernel/locking/lockdep.c:3876 [inline]
\_\_lock\_acquire+0x2e3d/0x5de0 kernel/locking/lockdep.c:5144
lock\_acquire kernel/locking/lockdep.c:5761 [inline]
lock\_acquire+0x1ae/0x510 kernel/locking/lockdep.c:5726
down\_write+0x93/0x200 kernel/locking/rwsem.c:1573
f2fs\_down\_write fs/f2fs/f2fs.h:2133 [inline]
f2fs\_add\_inline\_entry+0x300/0x6f0 fs/f2fs/inline.c:644
f2fs\_add\_dentry+0xa6/0x230 fs/f2fs/dir.c:784
f2fs\_do\_add\_link+0x190/0x280 fs/f2fs/dir.c:827
f2fs\_add\_link fs/f2fs/f2fs.h:3554 [inline]
f2fs\_mkdir+0x377/0x620 fs/f2fs/namei.c:781
vfs\_mkdir+0x532/0x7e0 fs/namei.c:4117
ovl\_do\_mkdir fs/overlayfs/overlayfs.h:196 [inline]
ovl\_mkdir\_real+0xb5/0x370 fs/overlayfs/dir.c:146
ovl\_workdir\_create+0x3de/0x820 fs/overlayfs/super.c:309
ovl\_make\_workdir fs/overlayfs/super.c:711 [inline]
ovl\_get\_workdir fs/overlayfs/super.c:864 [inline]
ovl\_fill\_super+0xdab/0x6180 fs/overlayfs/super.c:1400
vfs\_get\_super+0xf9/0x290 fs/super.c:1152
vfs\_get\_tree+0x88/0x350 fs/super.c:1519
do\_new\_mount fs/namespace.c:3335 [inline]
path\_mount+0x1492/0x1ed0 fs/namespace.c:3662
do\_mount fs/namespace.c:3675 [inline]
\_\_do\_sys\_mount fs/namespace.c:3884 [inline]
\_\_se\_sys\_mount fs/namespace.c:3861 [inline]
\_\_x64\_sys\_mount+0x293/0x310 fs/namespace.c:3861
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x38/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
rlock(&fi->i\_xattr\_sem);
lock(&fi->i\_sem);
lock(&fi->i\_xattr\_sem);
lock(&fi->i\_sem);
Cc:
Reported-and-tested-by: syzbot+e5600587fa9cbf8e3826@syzkaller.appspotmail.com
Fixes: 5eda1ad1aaff "f2fs: fix deadlock in i\_xattr\_sem and inode page lock"
Tested-by: Guenter Roeck
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit bfa7853bb47fee0c17030b377c98cf4ede47ba33
Author: Jaegeuk Kim
Date: Fri Jul 7 07:03:13 2023 -0700
f2fs: flush inode if atomic file is aborted
commit a3ab55746612247ce3dcaac6de66f5ffc055b9df upstream.
Let's flush the inode being aborted atomic operation to avoid stale dirty
inode during eviction in this call stack:
f2fs\_mark\_inode\_dirty\_sync+0x22/0x40 [f2fs]
f2fs\_abort\_atomic\_write+0xc4/0xf0 [f2fs]
f2fs\_evict\_inode+0x3f/0x690 [f2fs]
? sugov\_start+0x140/0x140
evict+0xc3/0x1c0
evict\_inodes+0x17b/0x210
generic\_shutdown\_super+0x32/0x120
kill\_block\_super+0x21/0x50
deactivate\_locked\_super+0x31/0x90
cleanup\_mnt+0x100/0x160
task\_work\_run+0x59/0x90
do\_exit+0x33b/0xa50
do\_group\_exit+0x2d/0x80
\_\_x64\_sys\_exit\_group+0x14/0x20
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
This triggers f2fs\_bug\_on() in f2fs\_evict\_inode:
f2fs\_bug\_on(sbi, is\_inode\_flag\_set(inode, FI\_DIRTY\_INODE));
This fixes the syzbot report:
loop0: detected capacity change from 0 to 131072
F2FS-fs (loop0): invalid crc value
F2FS-fs (loop0): Found nat\_bits in checkpoint
F2FS-fs (loop0): Mounted with checkpoint version = 48b305e4
------------[ cut here ]------------
kernel BUG at fs/f2fs/inode.c:869!
invalid opcode: 0000 [#1] PREEMPT SMP KASAN
CPU: 0 PID: 5014 Comm: syz-executor220 Not tainted 6.4.0-syzkaller-11479-g6cd06ab12d1a #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 05/27/2023
RIP: 0010:f2fs\_evict\_inode+0x172d/0x1e00 fs/f2fs/inode.c:869
Code: ff df 48 c1 ea 03 80 3c 02 00 0f 85 6a 06 00 00 8b 75 40 ba 01 00 00 00 4c 89 e7 e8 6d ce 06 00 e9 aa fc ff ff e8 63 22 e2 fd <0f> 0b e8 5c 22 e2 fd 48 c7 c0 a8 3a 18 8d 48 ba 00 00 00 00 00 fc
RSP: 0018:ffffc90003a6fa00 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000001 RCX: 0000000000000000
RDX: ffff8880273b8000 RSI: ffffffff83a2bd0d RDI: 0000000000000007
RBP: ffff888077db91b0 R08: 0000000000000007 R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000001 R12: ffff888029a3c000
R13: ffff888077db9660 R14: ffff888029a3c0b8 R15: ffff888077db9c50
FS: 0000000000000000(0000) GS:ffff8880b9800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f1909bb9000 CR3: 00000000276a9000 CR4: 0000000000350ef0
Call Trace:
evict+0x2ed/0x6b0 fs/inode.c:665
dispose\_list+0x117/0x1e0 fs/inode.c:698
evict\_inodes+0x345/0x440 fs/inode.c:748
generic\_shutdown\_super+0xaf/0x480 fs/super.c:478
kill\_block\_super+0x64/0xb0 fs/super.c:1417
kill\_f2fs\_super+0x2af/0x3c0 fs/f2fs/super.c:4704
deactivate\_locked\_super+0x98/0x160 fs/super.c:330
deactivate\_super+0xb1/0xd0 fs/super.c:361
cleanup\_mnt+0x2ae/0x3d0 fs/namespace.c:1254
task\_work\_run+0x16f/0x270 kernel/task\_work.c:179
exit\_task\_work include/linux/task\_work.h:38 [inline]
do\_exit+0xa9a/0x29a0 kernel/exit.c:874
do\_group\_exit+0xd4/0x2a0 kernel/exit.c:1024
\_\_do\_sys\_exit\_group kernel/exit.c:1035 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1033 [inline]
\_\_x64\_sys\_exit\_group+0x3e/0x50 kernel/exit.c:1033
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x39/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
RIP: 0033:0x7f309be71a09
Code: Unable to access opcode bytes at 0x7f309be719df.
RSP: 002b:00007fff171df518 EFLAGS: 00000246 ORIG\_RAX: 00000000000000e7
RAX: ffffffffffffffda RBX: 00007f309bef7330 RCX: 00007f309be71a09
RDX: 000000000000003c RSI: 00000000000000e7 RDI: 0000000000000001
RBP: 0000000000000001 R08: ffffffffffffffc0 R09: 00007f309bef1e40
R10: 0000000000010600 R11: 0000000000000246 R12: 00007f309bef7330
R13: 0000000000000001 R14: 0000000000000000 R15: 0000000000000001

Modules linked in:
---[ end trace 0000000000000000 ]---
RIP: 0010:f2fs\_evict\_inode+0x172d/0x1e00 fs/f2fs/inode.c:869
Code: ff df 48 c1 ea 03 80 3c 02 00 0f 85 6a 06 00 00 8b 75 40 ba 01 00 00 00 4c 89 e7 e8 6d ce 06 00 e9 aa fc ff ff e8 63 22 e2 fd <0f> 0b e8 5c 22 e2 fd 48 c7 c0 a8 3a 18 8d 48 ba 00 00 00 00 00 fc
RSP: 0018:ffffc90003a6fa00 EFLAGS: 00010293
RAX: 0000000000000000 RBX: 0000000000000001 RCX: 0000000000000000
RDX: ffff8880273b8000 RSI: ffffffff83a2bd0d RDI: 0000000000000007
RBP: ffff888077db91b0 R08: 0000000000000007 R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000001 R12: ffff888029a3c000
R13: ffff888077db9660 R14: ffff888029a3c0b8 R15: ffff888077db9c50
FS: 0000000000000000(0000) GS:ffff8880b9800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f1909bb9000 CR3: 00000000276a9000 CR4: 0000000000350ef0
Cc:
Reported-and-tested-by: syzbot+e1246909d526a9d470fa@syzkaller.appspotmail.com
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 6cba5457aa9d5c571da06a54c9c316166af2e1a8
Author: Jaegeuk Kim
Date: Thu Jan 19 10:47:00 2023 -0800
f2fs: get out of a repeat loop when getting a locked data page
commit d2d9bb3b6d2fbccb5b33d3a85a2830971625a4ea upstream.
https://bugzilla.kernel.org/show\_bug.cgi?id=216050
Somehow we're getting a page which has a different mapping.
Let's avoid the infinite loop.
Cc:
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 697b223d3226ae3de464b15d4a689182e08abd24
Author: Brian Foster
Date: Thu Aug 10 12:55:59 2023 -0400
ext4: drop dio overwrite only flag and associated warning
commit 194505b55dd7899da114a4d47825204eefc0fff5 upstream.
The commit referenced below opened up concurrent unaligned dio under
shared locking for pure overwrites. In doing so, it enabled use of
the IOMAP\_DIO\_OVERWRITE\_ONLY flag and added a warning on unexpected
-EAGAIN returns as an extra precaution, since ext4 does not retry
writes in such cases. The flag itself is advisory in this case since
ext4 checks for unaligned I/Os and uses appropriate locking up
front, rather than on a retry in response to -EAGAIN.
As it turns out, the warning check is susceptible to false positives
because there are scenarios where -EAGAIN can be expected from lower
layers without necessarily having IOCB\_NOWAIT set on the iocb. For
example, one instance of the warning has been seen where io\_uring
sets IOCB\_HIPRI, which in turn results in REQ\_POLLED|REQ\_NOWAIT on
the bio. This results in -EAGAIN if the block layer is unable to
allocate a request, etc. [Note that there is an outstanding patch to
untangle REQ\_POLLED and REQ\_NOWAIT such that the latter relies on
IOCB\_NOWAIT, which would also address this instance of the warning.]
Another instance of the warning has been reproduced by syzbot. A dio
write is interrupted down in \_\_get\_user\_pages\_locked() waiting on
the mm lock and returns -EAGAIN up the stack. If the iomap dio
iteration layer has made no progress on the write to this point,
-EAGAIN returns up to the filesystem and triggers the warning.
This use of the overwrite flag in ext4 is precautionary and
half-baked. I.e., ext4 doesn't actually implement overwrite checking
in the iomap callbacks when the flag is set, so the only extra
verification it provides are i\_size checks in the generic iomap dio
layer. Combined with the tendency for false positives, the added
verification is not worth the extra trouble. Remove the flag,
associated warning, and update the comments to document when
concurrent unaligned dio writes are allowed and why said flag is not
used.
Cc: stable@kernel.org
Reported-by: syzbot+5050ad0fb47527b1808a@syzkaller.appspotmail.com
Reported-by: Pengfei Xu
Fixes: 310ee0902b8d ("ext4: allow concurrent unaligned dio overwrites")
Signed-off-by: Brian Foster
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230810165559.946222-1-bfoster@redhat.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 36daf050be3f6f067631dc52054de2d3b7cc849f
Author: Luís Henriques
Date: Thu Aug 3 10:17:13 2023 +0100
ext4: fix memory leaks in ext4\_fname\_{setup\_filename,prepare\_lookup}
commit 7ca4b085f430f3774c3838b3da569ceccd6a0177 upstream.
If the filename casefolding fails, we'll be leaking memory from the
fscrypt\_name struct, namely from the 'crypto\_buf.name' member.
Make sure we free it in the error path on both ext4\_fname\_setup\_filename()
and ext4\_fname\_prepare\_lookup() functions.
Cc: stable@kernel.org
Fixes: 1ae98e295fa2 ("ext4: optimize match for casefolded encrypted dirs")
Signed-off-by: Luís Henriques
Reviewed-by: Eric Biggers
Link: https://lore.kernel.org/r/20230803091713.13239-1-lhenriques@suse.de
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 8903b3c300bd6b5c43d21002d9ada3382409759a
Author: Wang Jianjian
Date: Thu Aug 3 00:28:39 2023 +0800
ext4: add correct group descriptors and reserved GDT blocks to system zone
commit 68228da51c9a436872a4ef4b5a7692e29f7e5bc7 upstream.
When setup\_system\_zone, flex\_bg is not initialized so it is always 1.
Use a new helper function, ext4\_num\_base\_meta\_blocks() which does not
depend on sbi->s\_log\_groups\_per\_flex being initialized.
[ Squashed two patches in the Link URL's below together into a single
commit, which is simpler to review/understand. Also fix checkpatch
warnings. --TYT ]
Cc: stable@kernel.org
Signed-off-by: Wang Jianjian
Link: https://lore.kernel.org/r/tencent\_21AF0D446A9916ED5C51492CC6C9A0A77B05@qq.com
Link: https://lore.kernel.org/r/tencent\_D744D1450CC169AEA77FCF0A64719909ED05@qq.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit c15bf3330a9e3c01b23e59899a6a02432a62ddc3
Author: Baokun Li
Date: Tue Aug 15 15:08:08 2023 +0800
ext4: fix slab-use-after-free in ext4\_es\_insert\_extent()
commit 768d612f79822d30a1e7d132a4d4b05337ce42ec upstream.
Yikebaer reported an issue:
==================================================================
BUG: KASAN: slab-use-after-free in ext4\_es\_insert\_extent+0xc68/0xcb0
fs/ext4/extents\_status.c:894
Read of size 4 at addr ffff888112ecc1a4 by task syz-executor/8438
CPU: 1 PID: 8438 Comm: syz-executor Not tainted 6.5.0-rc5 #1
Call Trace:
[...]
kasan\_report+0xba/0xf0 mm/kasan/report.c:588
ext4\_es\_insert\_extent+0xc68/0xcb0 fs/ext4/extents\_status.c:894
ext4\_map\_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
ext4\_alloc\_file\_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
ext4\_zero\_range fs/ext4/extents.c:4622 [inline]
ext4\_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
[...]
Allocated by task 8438:
[...]
kmem\_cache\_zalloc include/linux/slab.h:693 [inline]
\_\_es\_alloc\_extent fs/ext4/extents\_status.c:469 [inline]
ext4\_es\_insert\_extent+0x672/0xcb0 fs/ext4/extents\_status.c:873
ext4\_map\_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
ext4\_alloc\_file\_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
ext4\_zero\_range fs/ext4/extents.c:4622 [inline]
ext4\_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
[...]
Freed by task 8438:
[...]
kmem\_cache\_free+0xec/0x490 mm/slub.c:3823
ext4\_es\_try\_to\_merge\_right fs/ext4/extents\_status.c:593 [inline]
\_\_es\_insert\_extent+0x9f4/0x1440 fs/ext4/extents\_status.c:802
ext4\_es\_insert\_extent+0x2ca/0xcb0 fs/ext4/extents\_status.c:882
ext4\_map\_blocks+0x92a/0x16f0 fs/ext4/inode.c:680
ext4\_alloc\_file\_blocks.isra.0+0x2df/0xb70 fs/ext4/extents.c:4462
ext4\_zero\_range fs/ext4/extents.c:4622 [inline]
ext4\_fallocate+0x251c/0x3ce0 fs/ext4/extents.c:4721
[...]
==================================================================
The flow of issue triggering is as follows:
1. remove es
raw es es removed es1
|-------------------| -> |----|.......|------|
2. insert es
es insert es1 merge with es es1 merge with es and free es1
|----|.......|------| -> |------------|------| -> |-------------------|
es merges with newes, then merges with es1, frees es1, then determines
if es1->es\_len is 0 and triggers a UAF.
The code flow is as follows:
ext4\_es\_insert\_extent
es1 = \_\_es\_alloc\_extent(true);
es2 = \_\_es\_alloc\_extent(true);
\_\_es\_remove\_extent(inode, lblk, end, NULL, es1)
\_\_es\_insert\_extent(inode, &newes, es1) ---> insert es1 to es tree
\_\_es\_insert\_extent(inode, &newes, es2)
ext4\_es\_try\_to\_merge\_right
ext4\_es\_free\_extent(inode, es1) ---> es1 is freed
if (es1 && !es1->es\_len)
// Trigger UAF by determining if es1 is used.
We determine whether es1 or es2 is used immediately after calling
\_\_es\_remove\_extent() or \_\_es\_insert\_extent() to avoid triggering a
UAF if es1 or es2 is freed.
Reported-by: Yikebaer Aizezi
Closes: https://lore.kernel.org/lkml/CALcu4raD4h9coiyEBL4Bm0zjDwxC2CyPiTwsP3zFuhot6y9Beg@mail.gmail.com
Fixes: 2a69c450083d ("ext4: using nofail preallocation in ext4\_es\_insert\_extent()")
Cc: stable@kernel.org
Signed-off-by: Baokun Li
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230815070808.3377171-1-libaokun1@huawei.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 05874c69576c8cf0d67efb5e2bd329e0c7536f23
Author: Zhang Yi
Date: Mon Jun 26 15:33:22 2023 +0800
jbd2: correct the end of the journal recovery scan range
commit 2dfba3bb40ad8536b9fa802364f2d40da31aa88e upstream.
We got a filesystem inconsistency issue below while running generic/475
I/O failure pressure test with fast\_commit feature enabled.
Symlink /p3/d3/d1c/d6c/dd6/dce/l101 (inode #132605) is invalid.
If fast\_commit feature is enabled, a special fast\_commit journal area is
appended to the end of the normal journal area. The journal->j\_last
point to the first unused block behind the normal journal area instead
of the whole log area, and the journal->j\_fc\_last point to the first
unused block behind the fast\_commit journal area. While doing journal
recovery, do\_one\_pass(PASS\_SCAN) should first scan the normal journal
area and turn around to the first block once it meet journal->j\_last,
but the wrap() macro misuse the journal->j\_fc\_last, so the recovering
could not read the next magic block (commit block perhaps) and would end
early mistakenly and missing tN and every transaction after it in the
following example. Finally, it could lead to filesystem inconsistency.
| normal journal area | fast commit area |
+-------------------------------------------------+------------------+
| tN(rere) | tN+1 |~| tN-x |...| tN-1 | tN(front) | .... |
+-------------------------------------------------+------------------+
/ / /
start journal->j\_last journal->j\_fc\_last
This patch fix it by use the correct ending journal->j\_last.
Fixes: 5b849b5f96b4 ("jbd2: fast commit recovery path")
Cc: stable@kernel.org
Reported-by: Theodore Ts'o
Link: https://lore.kernel.org/linux-ext4/20230613043120.GB1584772@mit.edu/
Signed-off-by: Zhang Yi
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230626073322.3956567-1-yi.zhang@huaweicloud.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 2298f2589903a8bc03061b54b31fd97985ab6529
Author: Zhihao Cheng
Date: Fri Jul 14 10:55:27 2023 +0800
jbd2: check 'jh->b\_transaction' before removing it from checkpoint
commit 590a809ff743e7bd890ba5fb36bc38e20a36de53 upstream.
Following process will corrupt ext4 image:
Step 1:
jbd2\_journal\_commit\_transaction
\_\_jbd2\_journal\_insert\_checkpoint(jh, commit\_transaction)
// Put jh into trans1->t\_checkpoint\_list
journal->j\_checkpoint\_transactions = commit\_transaction
// Put trans1 into journal->j\_checkpoint\_transactions
Step 2:
do\_get\_write\_access
test\_clear\_buffer\_dirty(bh) // clear buffer dirty，set jbd dirty
\_\_jbd2\_journal\_file\_buffer(jh, transaction) // jh belongs to trans2
Step 3:
drop\_cache
journal\_shrink\_one\_cp\_list
jbd2\_journal\_try\_remove\_checkpoint
if (!trylock\_buffer(bh)) // lock bh, true
if (buffer\_dirty(bh)) // buffer is not dirty
\_\_jbd2\_journal\_remove\_checkpoint(jh)
// remove jh from trans1->t\_checkpoint\_list
Step 4:
jbd2\_log\_do\_checkpoint
trans1 = journal->j\_checkpoint\_transactions
// jh is not in trans1->t\_checkpoint\_list
jbd2\_cleanup\_journal\_tail(journal) // trans1 is done
Step 5: Power cut, trans2 is not committed, jh is lost in next mounting.
Fix it by checking 'jh->b\_transaction' before remove it from checkpoint.
Cc: stable@kernel.org
Fixes: 46f881b5b175 ("jbd2: fix a race when checking checkpoint buffer busy")
Signed-off-by: Zhihao Cheng
Signed-off-by: Zhang Yi
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230714025528.564988-3-yi.zhang@huaweicloud.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 8313c4a44631c8f1dfb9d3ad5e1127120287c68b
Author: Zhang Yi
Date: Fri Jul 14 10:55:26 2023 +0800
jbd2: fix checkpoint cleanup performance regression
commit 373ac521799d9e97061515aca6ec6621789036bb upstream.
journal\_clean\_one\_cp\_list() has been merged into
journal\_shrink\_one\_cp\_list(), but do chekpoint buffer cleanup from the
committing process is just a best effort, it should stop scan once it
meet a busy buffer, or else it will cause a lot of invalid buffer scan
and checks. We catch a performance regression when doing fs\_mark tests
below.
Test cmd:
./fs\_mark -d scratch -s 1024 -n 10000 -t 1 -D 100 -N 100
Before merging checkpoint buffer cleanup:
FSUse% Count Size Files/sec App Overhead
95 10000 1024 8304.9 49033
After merging checkpoint buffer cleanup:
FSUse% Count Size Files/sec App Overhead
95 10000 1024 7649.0 50012
FSUse% Count Size Files/sec App Overhead
95 10000 1024 2107.1 50871
After merging checkpoint buffer cleanup, the total loop count in
journal\_shrink\_one\_cp\_list() could be up to 6,261,600+ (50,000+ ~
100,000+ in general), most of them are invalid. This patch fix it
through passing 'shrink\_type' into journal\_shrink\_one\_cp\_list() and add
a new 'SHRINK\_BUSY\_STOP' to indicate it should stop once meet a busy
buffer. After fix, the loop count descending back to 10,000+.
After this fix:
FSUse% Count Size Files/sec App Overhead
95 10000 1024 8558.4 49109
Cc: stable@kernel.org
Fixes: b98dba273a0e ("jbd2: remove journal\_clean\_one\_cp\_list()")
Signed-off-by: Zhang Yi
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230714025528.564988-2-yi.zhang@huaweicloud.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit d8061ff566c22671a75b3be38fd568d97bcc9c1d
Author: Ekansh Gupta
Date: Fri Aug 11 12:56:42 2023 +0100
misc: fastrpc: Fix incorrect DMA mapping unmap request
commit a2cb9cd6a3949a3804ad9fd7da234892ce6719ec upstream.
Scatterlist table is obtained during map create request and the same
table is used for DMA mapping unmap. In case there is any failure
while getting the sg\_table, ERR\_PTR is returned instead of sg\_table.
When the map is getting freed, there is only a non-NULL check of
sg\_table which will also be true in case failure was returned instead
of sg\_table. This would result in improper unmap request. Add proper
check before setting map table to avoid bad unmap request.
Fixes: c68cfb718c8f ("misc: fastrpc: Add support for context Invoke method")
Cc: stable
Signed-off-by: Ekansh Gupta
Signed-off-by: Srinivas Kandagatla
Link: https://lore.kernel.org/r/20230811115643.38578-3-srinivas.kandagatla@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit 0d559064318e766d4c66775688fd6e4389d605eb
Author: Ekansh Gupta
Date: Fri Aug 11 12:56:41 2023 +0100
misc: fastrpc: Fix remote heap allocation request
commit ada6c2d99aedd1eac2f633d03c652e070bc2ea74 upstream.
Remote heap is used by DSP audioPD on need basis. This memory is
allocated from reserved CMA memory region and is then shared with
audioPD to use it for it's functionality.
Current implementation of remote heap is not allocating the memory
from CMA region, instead it is allocating the memory from SMMU
context bank. The arguments passed to scm call for the reassignment
of ownership is also not correct. Added changes to allocate CMA
memory and have a proper ownership reassignment.
Fixes: 532ad70c6d44 ("misc: fastrpc: Add mmap request assigning for static PD pool")
Cc: stable
Tested-by: Ekansh Gupta
Signed-off-by: Ekansh Gupta
Signed-off-by: Srinivas Kandagatla
Link: https://lore.kernel.org/r/20230811115643.38578-2-srinivas.kandagatla@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit f75ef413b99c201d74dfbca5168c9f81c138908f
Author: Hien Huynh
Date: Thu Jul 6 12:21:50 2023 +0100
dmaengine: sh: rz-dmac: Fix destination and source data size setting
commit c6ec8c83a29fb3aec3efa6fabbf5344498f57c7f upstream.
Before setting DDS and SDS values, we need to clear its value first
otherwise, we get incorrect results when we change/update the DMA bus
width several times due to the 'OR' expression.
Fixes: 5000d37042a6 ("dmaengine: sh: Add DMAC driver for RZ/G2L SoC")
Cc: stable@kernel.org
Signed-off-by: Hien Huynh
Signed-off-by: Biju Das
Reviewed-by: Geert Uytterhoeven
Link: https://lore.kernel.org/r/20230706112150.198941-3-biju.das.jz@bp.renesas.com
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit da86cf1974b8926e46e89e07f18c7338f4ad783c
Author: Walter Chang
Date: Mon Jul 17 17:07:34 2023 +0800
clocksource/drivers/arm\_arch\_timer: Disable timer before programming CVAL
commit e7d65e40ab5a5940785c5922f317602d0268caaf upstream.
Due to the fact that the use of `writeq\_relaxed()` to program CVAL is
not guaranteed to be atomic, it is necessary to disable the timer before
programming CVAL.
However, if the MMIO timer is already enabled and has not yet expired,
there is a possibility of unexpected behavior occurring: when the CPU
enters the idle state during this period, and if the CPU's local event
is earlier than the broadcast event, the following process occurs:
tick\_broadcast\_enter()
tick\_broadcast\_oneshot\_control(TICK\_BROADCAST\_ENTER)
\_\_tick\_broadcast\_oneshot\_control()
\_\_\_tick\_broadcast\_oneshot\_control()
tick\_broadcast\_set\_event()
clockevents\_program\_event()
set\_next\_event\_mem()
During this process, the MMIO timer remains enabled while programming
CVAL. To prevent such behavior, disable timer explicitly prior to
programming CVAL.
Fixes: 8b82c4f883a7 ("clocksource/drivers/arm\_arch\_timer: Move MMIO timer programming over to CVAL")
Cc: stable@vger.kernel.org
Signed-off-by: Walter Chang
Acked-by: Marc Zyngier
Reviewed-by: AngeloGioacchino Del Regno
Signed-off-by: Daniel Lezcano
Link: https://lore.kernel.org/r/20230717090735.19370-1-walter.chang@mediatek.com
Signed-off-by: Greg Kroah-Hartman
commit ba5f2f952e6e45e4c31b12fee463324890537ff5
Author: Pavel Kozlov
Date: Tue Aug 15 19:11:36 2023 +0400
ARC: atomics: Add compiler barrier to atomic operations...
commit 42f51fb24fd39cc547c086ab3d8a314cc603a91c upstream.
... to avoid unwanted gcc optimizations
SMP kernels fail to boot with commit 596ff4a09b89
("cpumask: re-introduce constant-sized cpumask optimizations").
|
| percpu: BUG: failure at mm/percpu.c:2981/pcpu\_build\_alloc\_info()!
|
The write operation performed by the SCOND instruction in the atomic
inline asm code is not properly passed to the compiler. The compiler
cannot correctly optimize a nested loop that runs through the cpumask
in the pcpu\_build\_alloc\_info() function.
Fix this by add a compiler barrier (memory clobber in inline asm).
Apparently atomic ops used to have memory clobber implicitly via
surrounding smp\_mb(). However commit b64be6836993c431e
("ARC: atomics: implement relaxed variants") removed the smp\_mb() for
the relaxed variants, but failed to add the explicit compiler barrier.
Link: https://github.com/foss-for-synopsys-dwc-arc-processors/linux/issues/135
Cc:  # v6.3+
Fixes: b64be6836993c43 ("ARC: atomics: implement relaxed variants")
Signed-off-by: Pavel Kozlov
Signed-off-by: Vineet Gupta
[vgupta: tweaked the changelog and added Fixes tag]
Signed-off-by: Greg Kroah-Hartman
commit 97ea0ac092cdfbf52b20e1bdac9065680ca015e3
Author: Fangzhi Zuo
Date: Thu Jul 20 12:04:39 2023 -0400
drm/amd/display: Temporary Disable MST DP Colorspace Property
commit 69a959610229ec31b534eaa5f6ec75965f321bed upstream.
Create MST colorsapce property for downstream device would trigger
warning message "RIP: 0010:drm\_mode\_object\_add+0x8e/0xa0 [drm]"
After driver is loaded and drm device is registered, create
dp colorspace property triggers warning storm at
WARN\_ON(!dev->driver->load && dev->registered && !obj\_free\_cb);
Temporary disabling MST dp colorspace property for now.
Reviewed-by: Aurabindo Pillai
Acked-by: Aurabindo Pillai
Signed-off-by: Fangzhi Zuo
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit ef035adf6c1f096ea0976380cc7388d78cb2ebb1
Author: Florent CARLI
Date: Fri Jul 21 10:13:47 2023 +0200
watchdog: advantech\_ec\_wdt: fix Kconfig dependencies
commit 6eb28a38f6478a650c7e76b2d6910669615d8a62 upstream.
This driver uses the WATCHDOG\_CORE framework and ISA\_BUS\_API.
This commit has these dependencies correctly selected.
Signed-off-by: Florent CARLI
Co-authored-by: Yoann Congal
Reviewed-by: Guenter Roeck
Link: https://lore.kernel.org/r/20230721081347.52069-1-fcarli@gmail.com
Signed-off-by: Guenter Roeck
Signed-off-by: Wim Van Sebroeck
Cc: Yoann Congal
Signed-off-by: Greg Kroah-Hartman
commit 53092c767eef50dd42c0a74abcf77ac466589b3f
Author: Masahiro Yamada
Date: Wed Sep 6 03:46:57 2023 +0900
linux/export: fix reference to exported functions for parisc64
commit 08700ec705043eb0cee01b35cf5b9d63f0230d12 upstream.
John David Anglin reported parisc has been broken since commit
ddb5cdbafaaa ("kbuild: generate KSYMTAB entries by modpost").
Like ia64, parisc64 uses a function descriptor. The function
references must be prefixed with P%.
Also, symbols prefixed $$ from the library have the symbol type
STT\_LOPROC instead of STT\_FUNC. They should be handled as functions
too.
Fixes: ddb5cdbafaaa ("kbuild: generate KSYMTAB entries by modpost")
Reported-by: John David Anglin
Tested-by: John David Anglin
Tested-by: Helge Deller
Closes: https://lore.kernel.org/linux-parisc/1901598a-e11d-f7dd-a5d9-9a69d06e6b6e@bell.net/T/#u
Signed-off-by: Masahiro Yamada
Signed-off-by: Helge Deller
Signed-off-by: Greg Kroah-Hartman
commit 610dbd8ac271aa36080aac50b928d700ee3fe4de
Author: Duoming Zhou
Date: Wed Aug 2 11:37:37 2023 +0800
sh: push-switch: Reorder cleanup operations to avoid use-after-free bug
[ Upstream commit 246f80a0b17f8f582b2c0996db02998239057c65 ]
The original code puts flush\_work() before timer\_shutdown\_sync()
in switch\_drv\_remove(). Although we use flush\_work() to stop
the worker, it could be rescheduled in switch\_timer(). As a result,
a use-after-free bug can occur. The details are shown below:
(cpu 0) | (cpu 1)
switch\_drv\_remove() |
flush\_work() |
... | switch\_timer // timer
| schedule\_work(&psw->work)
timer\_shutdown\_sync() |
... | switch\_work\_handler // worker
kfree(psw) // free |
| psw->state = 0 // use
This patch puts timer\_shutdown\_sync() before flush\_work() to
mitigate the bugs. As a result, the worker and timer will be
stopped safely before the deallocate operations.
Fixes: 9f5e8eee5cfe ("sh: generic push-switch framework.")
Signed-off-by: Duoming Zhou
Reviewed-by: Geert Uytterhoeven
Reviewed-by: John Paul Adrian Glaubitz
Link: https://lore.kernel.org/r/20230802033737.9738-1-duoming@zju.edu.cn
Signed-off-by: John Paul Adrian Glaubitz
Signed-off-by: Sasha Levin
commit e7c5d573d05fdf0cdc3b423aa06a10acc37d30d6
Author: Petr Tesarik
Date: Mon Jul 24 14:07:42 2023 +0200
sh: boards: Fix CEU buffer size passed to dma\_declare\_coherent\_memory()
[ Upstream commit fb60211f377b69acffead3147578f86d0092a7a5 ]
In all these cases, the last argument to dma\_declare\_coherent\_memory() is
the buffer end address, but the expected value should be the size of the
reserved region.
Fixes: 39fb993038e1 ("media: arch: sh: ap325rxa: Use new renesas-ceu camera driver")
Fixes: c2f9b05fd5c1 ("media: arch: sh: ecovec: Use new renesas-ceu camera driver")
Fixes: f3590dc32974 ("media: arch: sh: kfr2r09: Use new renesas-ceu camera driver")
Fixes: 186c446f4b84 ("media: arch: sh: migor: Use new renesas-ceu camera driver")
Fixes: 1a3c230b4151 ("media: arch: sh: ms7724se: Use new renesas-ceu camera driver")
Signed-off-by: Petr Tesarik
Reviewed-by: Geert Uytterhoeven
Reviewed-by: Jacopo Mondi
Reviewed-by: John Paul Adrian Glaubitz
Reviewed-by: Laurent Pinchart
Link: https://lore.kernel.org/r/20230724120742.2187-1-petrtesarik@huaweicloud.com
Signed-off-by: John Paul Adrian Glaubitz
Signed-off-by: Sasha Levin
commit a59e2ea0139f31c215a78fa232eed7f8b3f99bc9
Author: Vladimir Oltean
Date: Wed Sep 6 17:16:09 2023 +0300
net: enetc: distinguish error from valid pointers in enetc\_fixup\_clear\_rss\_rfs()
[ Upstream commit 1b36955cc048c8ff6ba448dbf4be0e52f59f2963 ]
enetc\_psi\_create() returns an ERR\_PTR() or a valid station interface
pointer, but checking for the non-NULL quality of the return code blurs
that difference away. So if enetc\_psi\_create() fails, we call
enetc\_psi\_destroy() when we shouldn't. This will likely result in
crashes, since enetc\_psi\_create() cleans up everything after itself when
it returns an ERR\_PTR().
Fixes: f0168042a212 ("net: enetc: reimplement RFS/RSS memory clearing as PCI quirk")
Reported-by: Dan Carpenter
Closes: https://lore.kernel.org/netdev/582183ef-e03b-402b-8e2d-6d9bb3c83bd9@moroto.mountain/
Suggested-by: Dan Carpenter
Signed-off-by: Vladimir Oltean
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230906141609.247579-1-vladimir.oltean@nxp.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 9397be66f278dc5557665c9c7cf07d0548b10472
Author: Jie Wang
Date: Wed Sep 6 15:20:18 2023 +0800
net: hns3: remove GSO partial feature bit
[ Upstream commit 60326634f6c54528778de18bfef1e8a7a93b3771 ]
HNS3 NIC does not support GSO partial packets segmentation. Actually tunnel
packets for example NvGRE packets segment offload and checksum offload is
already supported. There is no need to keep gso partial feature bit. So
this patch removes it.
Fixes: 76ad4f0ee747 ("net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC")
Signed-off-by: Jie Wang
Signed-off-by: Jijie Shao
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 3a483057efc600f3b18351c4ed3c1e02558aea57
Author: Yisen Zhuang
Date: Wed Sep 6 15:20:17 2023 +0800
net: hns3: fix the port information display when sfp is absent
[ Upstream commit 674d9591a32d01df75d6b5fffed4ef942a294376 ]
When sfp is absent or unidentified, the port type should be
displayed as PORT\_OTHERS, rather than PORT\_FIBRE.
Fixes: 88d10bd6f730 ("net: hns3: add support for multiple media type")
Signed-off-by: Yisen Zhuang
Signed-off-by: Jijie Shao
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 7627e29561d4de15c66beb8e2400418e38a36f02
Author: Jijie Shao
Date: Wed Sep 6 15:20:16 2023 +0800
net: hns3: fix invalid mutex between tc qdisc and dcb ets command issue
[ Upstream commit fa5564945f7d15ae2390b00c08b6abaef0165cda ]
We hope that tc qdisc and dcb ets commands can not be used crosswise.
If we want to use any of the commands to configure tc,
We must use the other command to clear the existing configuration.
However, when we configure a single tc with tc qdisc,
we can still configure it with dcb ets.
Because we use mqprio\_active as the tag of tc qdisc configuration,
but with dcb ets, we do not check mqprio\_active.
This patch fix this issue by check mqprio\_active before
executing the dcb ets command. and add dcb\_ets\_active to
replace HCLGE\_FLAG\_DCB\_ENABLE and HCLGE\_FLAG\_MQPRIO\_ENABLE
at the hclge layer,
Fixes: cacde272dd00 ("net: hns3: Add hclge\_dcb module for the support of DCB feature")
Signed-off-by: Jijie Shao
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 435abe129e7504380ea539eae3fd24635e7e966e
Author: Hao Chen
Date: Wed Sep 6 15:20:15 2023 +0800
net: hns3: fix debugfs concurrency issue between kfree buffer and read
[ Upstream commit c295160b1d95e885f1af4586a221cb221d232d10 ]
Now in hns3\_dbg\_uninit(), there may be concurrency between
kfree buffer and read, it may result in memory error.
Moving debugfs\_remove\_recursive() in front of kfree buffer to ensure
they don't happen at the same time.
Fixes: 5e69ea7ee2a6 ("net: hns3: refactor the debugfs process")
Signed-off-by: Hao Chen
Signed-off-by: Jijie Shao
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 83210404caa947746f8d6a20a64eb7a2a7fa647b
Author: Hao Chen
Date: Wed Sep 6 15:20:14 2023 +0800
net: hns3: fix byte order conversion issue in hclge\_dbg\_fd\_tcam\_read()
[ Upstream commit efccf655e99b6907ca07a466924e91805892e7d3 ]
req1->tcam\_data is defined as "u8 tcam\_data[8]", and we convert it as
(u32 \*) without considerring byte order conversion,
it may result in printing wrong data for tcam\_data.
Convert tcam\_data to (\_\_le32 \*) first to fix it.
Fixes: b5a0b70d77b9 ("net: hns3: refactor dump fd tcam of debugfs")
Signed-off-by: Hao Chen
Signed-off-by: Jijie Shao
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit e61362ee8419d0edcada0b1298e065eea876127b
Author: Jian Shen
Date: Wed Sep 6 15:20:12 2023 +0800
net: hns3: fix tx timeout issue
[ Upstream commit 61a1deacc3d4fd3d57d7fda4d935f7f7503e8440 ]
Currently, the driver knocks the ring doorbell before updating
the ring->last\_to\_use in tx flow. if the hardware transmiting
packet and napi poll scheduling are fast enough, it may get
the old ring->last\_to\_use in drivers' napi poll.
In this case, the driver will think the tx is not completed, and
return directly without clear the flag \_\_QUEUE\_STATE\_STACK\_XOFF,
which may cause tx timeout.
Fixes: 20d06ca2679c ("net: hns3: optimize the tx clean process")
Signed-off-by: Jian Shen
Signed-off-by: Jijie Shao
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 68cec6dcfda69a95564ccd0408dfa6642983e046
Author: Lukasz Majewski
Date: Tue Sep 5 11:33:15 2023 +0200
net: phy: Provide Module 4 KSZ9477 errata (DS80000754C)
[ Upstream commit 08c6d8bae48c2c28f7017d7b61b5d5a1518ceb39 ]
The KSZ9477 errata points out (in 'Module 4') the link up/down problems
when EEE (Energy Efficient Ethernet) is enabled in the device to which
the KSZ9477 tries to auto negotiate.
The suggested workaround is to clear advertisement of EEE for PHYs in
this chip driver.
To avoid regressions with other switch ICs the new MICREL\_NO\_EEE flag
has been introduced.
Moreover, the in-register disablement of MMD\_DEVICE\_ID\_EEE\_ADV.MMD\_EEE\_ADV
MMD register is removed, as this code is both; now executed too late
(after previous rework of the PHY and DSA for KSZ switches) and not
required as setting all members of eee\_broken\_modes bit field prevents
the KSZ9477 from advertising EEE.
Fixes: 69d3b36ca045 ("net: dsa: microchip: enable EEE support") # for KSZ9477
Signed-off-by: Lukasz Majewski
Tested-by: Oleksij Rempel  # Confirmed disabled EEE with oscilloscope.
Reviewed-by: Oleksij Rempel
Reviewed-by: Florian Fainelli
Link: https://lore.kernel.org/r/20230905093315.784052-1-lukma@denx.de
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit ef81e4557d051cbd5de7a95bf3c91a3e9649feaf
Author: Pablo Neira Ayuso
Date: Wed Sep 6 11:42:02 2023 +0200
netfilter: nf\_tables: Unbreak audit log reset
[ Upstream commit 9b5ba5c9c5109bf89dc64a3f4734bd125d1ce52e ]
Deliver audit log from \_\_nf\_tables\_dump\_rules(), table dereference at
the end of the table list loop might point to the list head, leading to
this crash.
[ 4137.407349] BUG: unable to handle page fault for address: 00000000001f3c50
[ 4137.407357] #PF: supervisor read access in kernel mode
[ 4137.407359] #PF: error\_code(0x0000) - not-present page
[ 4137.407360] PGD 0 P4D 0
[ 4137.407363] Oops: 0000 [#1] PREEMPT SMP PTI
[ 4137.407365] CPU: 4 PID: 500177 Comm: nft Not tainted 6.5.0+ #277
[ 4137.407369] RIP: 0010:string+0x49/0xd0
[ 4137.407374] Code: ff 77 36 45 89 d1 31 f6 49 01 f9 66 45 85 d2 75 19 eb 1e 49 39 f8 76 02 88 07 48 83 c7 01 83 c6 01 48 83 c2 01 4c 39 cf 74 07 <0f> b6 02 84 c0 75 e2 4c 89 c2 e9 58 e5 ff ff 48 c7 c0 0e b2 ff 81
[ 4137.407377] RSP: 0018:ffff8881179737f0 EFLAGS: 00010286
[ 4137.407379] RAX: 00000000001f2c50 RBX: ffff888117973848 RCX: ffff0a00ffffff04
[ 4137.407380] RDX: 00000000001f3c50 RSI: 0000000000000000 RDI: 0000000000000000
[ 4137.407381] RBP: 0000000000000000 R08: 0000000000000000 R09: 00000000ffffffff
[ 4137.407383] R10: ffffffffffffffff R11: ffff88813584d200 R12: 0000000000000000
[ 4137.407384] R13: ffffffffa15cf709 R14: 0000000000000000 R15: ffffffffa15cf709
[ 4137.407385] FS: 00007fcfc18bb580(0000) GS:ffff88840e700000(0000) knlGS:0000000000000000
[ 4137.407387] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 4137.407388] CR2: 00000000001f3c50 CR3: 00000001055b2001 CR4: 00000000001706e0
[ 4137.407390] Call Trace:
[ 4137.407392]
[ 4137.407393] ? \_\_die+0x1b/0x60
[ 4137.407397] ? page\_fault\_oops+0x6b/0xa0
[ 4137.407399] ? exc\_page\_fault+0x60/0x120
[ 4137.407403] ? asm\_exc\_page\_fault+0x22/0x30
[ 4137.407408] ? string+0x49/0xd0
[ 4137.407410] vsnprintf+0x257/0x4f0
[ 4137.407414] kvasprintf+0x3e/0xb0
[ 4137.407417] kasprintf+0x3e/0x50
[ 4137.407419] nf\_tables\_dump\_rules+0x1c0/0x360 [nf\_tables]
[ 4137.407439] ? \_\_alloc\_skb+0xc3/0x170
[ 4137.407442] netlink\_dump+0x170/0x330
[ 4137.407447] \_\_netlink\_dump\_start+0x227/0x300
[ 4137.407449] nf\_tables\_getrule+0x205/0x390 [nf\_tables]
Deliver audit log only once at the end of the rule dump+reset for
consistency with the set dump+reset.
Ensure audit reset access to table under rcu read side lock. The table
list iteration holds rcu read lock side, but recent audit code
dereferences table object out of the rcu read lock side.
Fixes: ea078ae9108e ("netfilter: nf\_tables: Audit log rule reset")
Fixes: 7e9be1124dbe ("netfilter: nf\_tables: Audit log setelem reset")
Signed-off-by: Pablo Neira Ayuso
Acked-by: Phil Sutter
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit e3213ff99a355cda811b41e8dbb3472d13167a3a
Author: Pablo Neira Ayuso
Date: Mon Sep 4 02:14:36 2023 +0200
netfilter: nft\_set\_rbtree: skip sync GC for new elements in this transaction
[ Upstream commit 2ee52ae94baabf7ee09cf2a8d854b990dac5d0e4 ]
New elements in this transaction might expired before such transaction
ends. Skip sync GC for such elements otherwise commit path might walk
over an already released object. Once transaction is finished, async GC
will collect such expired element.
Fixes: f6c383b8c31a ("netfilter: nf\_tables: adapt set backend to use GC transaction API")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit a3d0f898b80ac9b049e590b3ee6391716002da17
Author: Wander Lairson Costa
Date: Fri Sep 1 10:50:20 2023 -0300
netfilter: nfnetlink\_osf: avoid OOB read
[ Upstream commit f4f8a7803119005e87b716874bec07c751efafec ]
The opt\_num field is controlled by user mode and is not currently
validated inside the kernel. An attacker can take advantage of this to
trigger an OOB read and potentially leak information.
BUG: KASAN: slab-out-of-bounds in nf\_osf\_match\_one+0xbed/0xd10 net/netfilter/nfnetlink\_osf.c:88
Read of size 2 at addr ffff88804bc64272 by task poc/6431
CPU: 1 PID: 6431 Comm: poc Not tainted 6.0.0-rc4 #1
Call Trace:
nf\_osf\_match\_one+0xbed/0xd10 net/netfilter/nfnetlink\_osf.c:88
nf\_osf\_find+0x186/0x2f0 net/netfilter/nfnetlink\_osf.c:281
nft\_osf\_eval+0x37f/0x590 net/netfilter/nft\_osf.c:47
expr\_call\_ops\_eval net/netfilter/nf\_tables\_core.c:214
nft\_do\_chain+0x2b0/0x1490 net/netfilter/nf\_tables\_core.c:264
nft\_do\_chain\_ipv4+0x17c/0x1f0 net/netfilter/nft\_chain\_filter.c:23
[..]
Also add validation to genre, subtype and version fields.
Fixes: 11eeef41d5f6 ("netfilter: passive OS fingerprint xtables match")
Reported-by: Lucas Leong
Signed-off-by: Wander Lairson Costa
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit c8f292322ff16b9a2272a67de396c09a50e09dce
Author: Florian Westphal
Date: Tue Sep 5 23:13:56 2023 +0200
netfilter: nftables: exthdr: fix 4-byte stack OOB write
[ Upstream commit fd94d9dadee58e09b49075240fe83423eb1dcd36 ]
If priv->len is a multiple of 4, then dst[len / 4] can write past
the destination array which leads to stack corruption.
This construct is necessary to clean the remainder of the register
in case ->len is NOT a multiple of the register size, so make it
conditional just like nft\_payload.c does.
The bug was added in 4.1 cycle and then copied/inherited when
tcp/sctp and ip option support was added.
Bug reported by Zero Day Initiative project (ZDI-CAN-21950,
ZDI-CAN-21951, ZDI-CAN-21961).
Fixes: 49499c3e6e18 ("netfilter: nf\_tables: switch registers to 32 bit addressing")
Fixes: 935b7f643018 ("netfilter: nft\_exthdr: add TCP option matching")
Fixes: 133dc203d77d ("netfilter: nft\_exthdr: Support SCTP chunks")
Fixes: dbb5281a1f84 ("netfilter: nf\_tables: add support for matching IPv4 options")
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit 262d8c0dacfdefbc26714c6a6b43a4b32dc673a8
Author: Martin KaFai Lau
Date: Fri Sep 1 16:11:28 2023 -0700
bpf: bpf\_sk\_storage: Fix the missing uncharge in sk\_omem\_alloc
[ Upstream commit 55d49f750b1cb1f177fb1b00ae02cba4613bcfb7 ]
The commit c83597fa5dc6 ("bpf: Refactor some inode/task/sk storage functions
for reuse"), refactored the bpf\_{sk,task,inode}\_storage\_free() into
bpf\_local\_storage\_unlink\_nolock() which then later renamed to
bpf\_local\_storage\_destroy(). The commit accidentally passed the
"bool uncharge\_mem = false" argument to bpf\_selem\_unlink\_storage\_nolock()
which then stopped the uncharge from happening to the sk->sk\_omem\_alloc.
This missing uncharge only happens when the sk is going away (during
\_\_sk\_destruct).
This patch fixes it by always passing "uncharge\_mem = true". It is a
noop to the task/inode/cgroup storage because they do not have the
map\_local\_storage\_(un)charge enabled in the map\_ops. A followup patch
will be done in bpf-next to remove the uncharge\_mem argument.
A selftest is added in the next patch.
Fixes: c83597fa5dc6 ("bpf: Refactor some inode/task/sk storage functions for reuse")
Signed-off-by: Martin KaFai Lau
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20230901231129.578493-3-martin.lau@linux.dev
Signed-off-by: Sasha Levin
commit 300415caa373a07782fcbc2f8d9429bc2dc27a47
Author: Martin KaFai Lau
Date: Fri Sep 1 16:11:27 2023 -0700
bpf: bpf\_sk\_storage: Fix invalid wait context lockdep report
[ Upstream commit a96a44aba556c42b432929d37d60158aca21ad4c ]
'./test\_progs -t test\_local\_storage' reported a splat:
[ 27.137569] =============================
[ 27.138122] [ BUG: Invalid wait context ]
[ 27.138650] 6.5.0-03980-gd11ae1b16b0a #247 Tainted: G O
[ 27.139542] -----------------------------
[ 27.140106] test\_progs/1729 is trying to lock:
[ 27.140713] ffff8883ef047b88 (stock\_lock){-.-.}-{3:3}, at: local\_lock\_acquire+0x9/0x130
[ 27.141834] other info that might help us debug this:
[ 27.142437] context-{5:5}
[ 27.142856] 2 locks held by test\_progs/1729:
[ 27.143352] #0: ffffffff84bcd9c0 (rcu\_read\_lock){....}-{1:3}, at: rcu\_lock\_acquire+0x4/0x40
[ 27.144492] #1: ffff888107deb2c0 (&storage->lock){..-.}-{2:2}, at: bpf\_local\_storage\_update+0x39e/0x8e0
[ 27.145855] stack backtrace:
[ 27.146274] CPU: 0 PID: 1729 Comm: test\_progs Tainted: G O 6.5.0-03980-gd11ae1b16b0a #247
[ 27.147550] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014
[ 27.149127] Call Trace:
[ 27.149490]
[ 27.149867] dump\_stack\_lvl+0x130/0x1d0
[ 27.152609] dump\_stack+0x14/0x20
[ 27.153131] \_\_lock\_acquire+0x1657/0x2220
[ 27.153677] lock\_acquire+0x1b8/0x510
[ 27.157908] local\_lock\_acquire+0x29/0x130
[ 27.159048] obj\_cgroup\_charge+0xf4/0x3c0
[ 27.160794] slab\_pre\_alloc\_hook+0x28e/0x2b0
[ 27.161931] \_\_kmem\_cache\_alloc\_node+0x51/0x210
[ 27.163557] \_\_kmalloc+0xaa/0x210
[ 27.164593] bpf\_map\_kzalloc+0xbc/0x170
[ 27.165147] bpf\_selem\_alloc+0x130/0x510
[ 27.166295] bpf\_local\_storage\_update+0x5aa/0x8e0
[ 27.167042] bpf\_fd\_sk\_storage\_update\_elem+0xdb/0x1a0
[ 27.169199] bpf\_map\_update\_value+0x415/0x4f0
[ 27.169871] map\_update\_elem+0x413/0x550
[ 27.170330] \_\_sys\_bpf+0x5e9/0x640
[ 27.174065] \_\_x64\_sys\_bpf+0x80/0x90
[ 27.174568] do\_syscall\_64+0x48/0xa0
[ 27.175201] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
[ 27.175932] RIP: 0033:0x7effb40e41ad
[ 27.176357] Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d8
[ 27.179028] RSP: 002b:00007ffe64c21fc8 EFLAGS: 00000202 ORIG\_RAX: 0000000000000141
[ 27.180088] RAX: ffffffffffffffda RBX: 00007ffe64c22768 RCX: 00007effb40e41ad
[ 27.181082] RDX: 0000000000000020 RSI: 00007ffe64c22008 RDI: 0000000000000002
[ 27.182030] RBP: 00007ffe64c21ff0 R08: 0000000000000000 R09: 00007ffe64c22788
[ 27.183038] R10: 0000000000000064 R11: 0000000000000202 R12: 0000000000000000
[ 27.184006] R13: 00007ffe64c22788 R14: 00007effb42a1000 R15: 0000000000000000
[ 27.184958]
It complains about acquiring a local\_lock while holding a raw\_spin\_lock.
It means it should not allocate memory while holding a raw\_spin\_lock
since it is not safe for RT.
raw\_spin\_lock is needed because bpf\_local\_storage supports tracing
context. In particular for task local storage, it is easy to
get a "current" task PTR\_TO\_BTF\_ID in tracing bpf prog.
However, task (and cgroup) local storage has already been moved to
bpf mem allocator which can be used after raw\_spin\_lock.
The splat is for the sk storage. For sk (and inode) storage,
it has not been moved to bpf mem allocator. Using raw\_spin\_lock or not,
kzalloc(GFP\_ATOMIC) could theoretically be unsafe in tracing context.
However, the local storage helper requires a verifier accepted
sk pointer (PTR\_TO\_BTF\_ID), it is hypothetical if that (mean running
a bpf prog in a kzalloc unsafe context and also able to hold a verifier
accepted sk pointer) could happen.
This patch avoids kzalloc after raw\_spin\_lock to silent the splat.
There is an existing kzalloc before the raw\_spin\_lock. At that point,
a kzalloc is very likely required because a lookup has just been done
before. Thus, this patch always does the kzalloc before acquiring
the raw\_spin\_lock and remove the later kzalloc usage after the
raw\_spin\_lock. After this change, it will have a charge and then
uncharge during the syscall bpf\_map\_update\_elem() code path.
This patch opts for simplicity and not continue the old
optimization to save one charge and uncharge.
This issue is dated back to the very first commit of bpf\_sk\_storage
which had been refactored multiple times to create task, inode, and
cgroup storage. This patch uses a Fixes tag with a more recent
commit that should be easier to do backport.
Fixes: b00fa38a9c1c ("bpf: Enable non-atomic allocations in local storage")
Signed-off-by: Martin KaFai Lau
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20230901231129.578493-2-martin.lau@linux.dev
Signed-off-by: Sasha Levin
commit 6decfb1b5ae3f69e3a8a87eb4d44cb730af814d3
Author: Ilya Leoshkevich
Date: Wed Sep 6 02:44:19 2023 +0200
s390/bpf: Pass through tail call counter in trampolines
[ Upstream commit a192103a11465e9d517975c50f9944dc80e44d61 ]
s390x eBPF programs use the following extension to the s390x calling
convention: tail call counter is passed on stack at offset
STK\_OFF\_TCCNT, which callees otherwise use as scratch space.
Currently trampoline does not respect this and clobbers tail call
counter. This breaks enforcing tail call limits in eBPF programs, which
have trampolines attached to them.
Fix by forwarding a copy of the tail call counter to the original eBPF
program in the trampoline (for fexit), and by restoring it at the end
of the trampoline (for fentry).
Fixes: 528eb2cb87bc ("s390/bpf: Implement arch\_prepare\_bpf\_trampoline()")
Reported-by: Leon Hwang
Signed-off-by: Ilya Leoshkevich
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20230906004448.111674-1-iii@linux.ibm.com
Signed-off-by: Sasha Levin
commit f66a0738c76c2ae31a8de9b29e365297fe318edd
Author: Sebastian Andrzej Siewior
Date: Wed Aug 30 10:04:05 2023 +0200
bpf: Assign bpf\_tramp\_run\_ctx::saved\_run\_ctx before recursion check.
[ Upstream commit 6764e767f4af1e35f87f3497e1182d945de37f93 ]
\_\_bpf\_prog\_enter\_recur() assigns bpf\_tramp\_run\_ctx::saved\_run\_ctx before
performing the recursion check which means in case of a recursion
\_\_bpf\_prog\_exit\_recur() uses the previously set bpf\_tramp\_run\_ctx::saved\_run\_ctx
value.
\_\_bpf\_prog\_enter\_sleepable\_recur() assigns bpf\_tramp\_run\_ctx::saved\_run\_ctx
after the recursion check which means in case of a recursion
\_\_bpf\_prog\_exit\_sleepable\_recur() uses an uninitialized value. This does not
look right. If I read the entry trampoline code right, then bpf\_tramp\_run\_ctx
isn't initialized upfront.
Align \_\_bpf\_prog\_enter\_sleepable\_recur() with \_\_bpf\_prog\_enter\_recur() and
set bpf\_tramp\_run\_ctx::saved\_run\_ctx before the recursion check is made.
Remove the assignment of saved\_run\_ctx in kern\_sys\_bpf() since it happens
a few cycles later.
Fixes: e384c7b7b46d0 ("bpf, x86: Create bpf\_tramp\_run\_ctx on the caller thread's stack")
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Daniel Borkmann
Acked-by: Jiri Olsa
Link: https://lore.kernel.org/bpf/20230830080405.251926-3-bigeasy@linutronix.de
Signed-off-by: Sasha Levin
commit 5dfee42998e873df3e57772247f28d2632d52734
Author: Sebastian Andrzej Siewior
Date: Wed Aug 30 10:04:04 2023 +0200
bpf: Invoke \_\_bpf\_prog\_exit\_sleepable\_recur() on recursion in kern\_sys\_bpf().
[ Upstream commit 7645629f7dc88cd777f98970134bf1a54c8d77e3 ]
If \_\_bpf\_prog\_enter\_sleepable\_recur() detects recursion then it returns
0 without undoing rcu\_read\_lock\_trace(), migrate\_disable() or
decrementing the recursion counter. This is fine in the JIT case because
the JIT code will jump in the 0 case to the end and invoke the matching
exit trampoline (\_\_bpf\_prog\_exit\_sleepable\_recur()).
This is not the case in kern\_sys\_bpf() which returns directly to the
caller with an error code.
Add \_\_bpf\_prog\_exit\_sleepable\_recur() as clean up in the recursion case.
Fixes: b1d18a7574d0d ("bpf: Extend sys\_bpf commands for bpf\_syscall programs.")
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Daniel Borkmann
Acked-by: Jiri Olsa
Link: https://lore.kernel.org/bpf/20230830080405.251926-2-bigeasy@linutronix.de
Signed-off-by: Sasha Levin
commit f491a7984e8d38a53c6d8c0e0a97e7750ac7105d
Author: Jakub Kicinski
Date: Tue Sep 5 16:42:02 2023 -0700
net: phylink: fix sphinx complaint about invalid literal
[ Upstream commit 1a961e74d5abbea049588a3d74b759955b4ed9d5 ]
sphinx complains about the use of "%PHYLINK\_PCS\_NEG\_\*":
Documentation/networking/kapi:144: ./include/linux/phylink.h:601: WARNING: Inline literal start-string without end-string.
Documentation/networking/kapi:144: ./include/linux/phylink.h:633: WARNING: Inline literal start-string without end-string.
These are not valid symbols so drop the '%' prefix.
Alternatively we could use %PHYLINK\_PCS\_NEG\_\\* (escape the \*)
or use normal literal ``PHYLINK\_PCS\_NEG\_\*`` but there is already
a handful of un-adorned DEFINE\_\* in this file.
Fixes: f99d471afa03 ("net: phylink: add PCS negotiation mode")
Reported-by: Stephen Rothwell
Link: https://lore.kernel.org/all/20230626162908.2f149f98@canb.auug.org.au/
Signed-off-by: Jakub Kicinski
Reviewed-by: Bagas Sanjaya
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b8fc445b5d896cacc1406a84f217636dfb48482f
Author: Vladimir Oltean
Date: Wed Sep 6 00:53:38 2023 +0300
net: dsa: sja1105: complete tc-cbs offload support on SJA1110
[ Upstream commit 180a7419fe4adc8d9c8e0ef0fd17bcdd0cf78acd ]
The blamed commit left this delta behind:
struct sja1105\_cbs\_entry {
- u64 port;
- u64 prio;
+ u64 port; /\* Not used for SJA1110 \*/
+ u64 prio; /\* Not used for SJA1110 \*/
u64 credit\_hi;
u64 credit\_lo;
u64 send\_slope;
u64 idle\_slope;
};
but did not actually implement tc-cbs offload fully for the new switch.
The offload is accepted, but it doesn't work.
The difference compared to earlier switch generations is that now, the
table of CBS shapers is sparse, because there are many more shapers, so
the mapping between a {port, prio} and a table index is static, rather
than requiring us to store the port and prio into the sja1105\_cbs\_entry.
So, the problem is that the code programs the CBS shaper parameters at a
dynamic table index which is incorrect.
All that needs to be done for SJA1110 CBS shapers to work is to bypass
the logic which allocates shapers in a dense manner, as for SJA1105, and
use the fixed mapping instead.
Fixes: 3e77e59bf8cf ("net: dsa: sja1105: add support for the SJA1110 switch family")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ddf9bc72b8c5e2f09d6d64a3deaa7654317a2811
Author: Vladimir Oltean
Date: Wed Sep 6 00:53:37 2023 +0300
net: dsa: sja1105: fix -ENOSPC when replacing the same tc-cbs too many times
[ Upstream commit 894cafc5c62ccced758077bd4e970dc714c42637 ]
After running command [2] too many times in a row:
[1] $ tc qdisc add dev sw2p0 root handle 1: mqprio num\_tc 8 \
map 0 1 2 3 4 5 6 7 queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 hw 0
[2] $ tc qdisc replace dev sw2p0 parent 1:1 cbs offload 1 \
idleslope 120000 sendslope -880000 locredit -1320 hicredit 180
(aka more than priv->info->num\_cbs\_shapers times)
we start seeing the following error message:
Error: Specified device failed to setup cbs hardware offload.
This comes from the fact that ndo\_setup\_tc(TC\_SETUP\_QDISC\_CBS) presents
the same API for the qdisc create and replace cases, and the sja1105
driver fails to distinguish between the 2. Thus, it always thinks that
it must allocate the same shaper for a {port, queue} pair, when it may
instead have to replace an existing one.
Fixes: 4d7525085a9b ("net: dsa: sja1105: offload the Credit-Based Shaper qdisc")
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9d09ea4ec01b332415fa023fe3d3ea663eee3f32
Author: Vladimir Oltean
Date: Wed Sep 6 00:53:36 2023 +0300
net: dsa: sja1105: fix bandwidth discrepancy between tc-cbs software and offload
[ Upstream commit 954ad9bf13c4f95a4958b5f8433301f2ab99e1f5 ]
More careful measurement of the tc-cbs bandwidth shows that the stream
bandwidth (effectively idleslope) increases, there is a larger and
larger discrepancy between the rate limit obtained by the software
Qdisc, and the rate limit obtained by its offloaded counterpart.
The discrepancy becomes so large, that e.g. at an idleslope of 40000
(40Mbps), the offloaded cbs does not actually rate limit anything, and
traffic will pass at line rate through a 100 Mbps port.
The reason for the discrepancy is that the hardware documentation I've
been following is incorrect. UM11040.pdf (for SJA1105P/Q/R/S) states
about IDLE\_SLOPE that it is "the rate (in unit of bytes/sec) at which
the credit counter is increased".
Cross-checking with UM10944.pdf (for SJA1105E/T) and UM11107.pdf
(for SJA1110), the wording is different: "This field specifies the
value, in bytes per second times link speed, by which the credit counter
is increased".
So there's an extra scaling for link speed that the driver is currently
not accounting for, and apparently (empirically), that link speed is
expressed in Kbps.
I've pondered whether to pollute the sja1105\_mac\_link\_up()
implementation with CBS shaper reprogramming, but I don't think it is
worth it. IMO, the UAPI exposed by tc-cbs requires user space to
recalculate the sendslope anyway, since the formula for that depends on
port\_transmit\_rate (see man tc-cbs), which is not an invariant from tc's
perspective.
So we use the offload->sendslope and offload->idleslope to deduce the
original port\_transmit\_rate from the CBS formula, and use that value to
scale the offload->sendslope and offload->idleslope to values that the
hardware understands.
Some numerical data points:
40Mbps stream, max interfering frame size 1500, port speed 100M
---------------------------------------------------------------
tc-cbs parameters:
idleslope 40000 sendslope -60000 locredit -900 hicredit 600
which result in hardware values:
Before (doesn't work) After (works)
credit\_hi 600 600
credit\_lo 900 900
send\_slope 7500000 75
idle\_slope 5000000 50
40Mbps stream, max interfering frame size 1500, port speed 1G
-------------------------------------------------------------
tc-cbs parameters:
idleslope 40000 sendslope -960000 locredit -1440 hicredit 60
which result in hardware values:
Before (doesn't work) After (works)
credit\_hi 60 60
credit\_lo 1440 1440
send\_slope 120000000 120
idle\_slope 5000000 5
5.12Mbps stream, max interfering frame size 1522, port speed 100M
-----------------------------------------------------------------
tc-cbs parameters:
idleslope 5120 sendslope -94880 locredit -1444 hicredit 77
which result in hardware values:
Before (doesn't work) After (works)
credit\_hi 77 77
credit\_lo 1444 1444
send\_slope 11860000 118
idle\_slope 640000 6
Tested on SJA1105T, SJA1105S and SJA1110A, at 1Gbps and 100Mbps.
Fixes: 4d7525085a9b ("net: dsa: sja1105: offload the Credit-Based Shaper qdisc")
Reported-by: Yanan Yang
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4b912846fd6877e825092a0862195bb99052e39a
Author: Bodong Wang
Date: Tue Sep 5 10:48:46 2023 -0700
mlx5/core: E-Switch, Create ACL FT for eswitch manager in switchdev mode
[ Upstream commit 344134609a564f28b3cc81ca6650319ccd5d8961 ]
ACL flow table is required in switchdev mode when metadata is enabled,
driver creates such table when loading each vport. However, not every
vport is loaded in switchdev mode. Such as ECPF if it's the eswitch manager.
In this case, ACL flow table is still needed.
To make it modularized, create ACL flow table for eswitch manager as
default and skip such operations when loading manager vport.
Also, there is no need to load the eswitch manager vport in switchdev mode.
This means there is no need to load it on regular connect-x HCAs where
the PF is the eswitch manager. This will avoid creating duplicate ACL
flow table for host PF vport.
Fixes: 29bcb6e4fe70 ("net/mlx5e: E-Switch, Use metadata for vport matching in send-to-vport rules")
Fixes: eb8e9fae0a22 ("mlx5/core: E-Switch, Allocate ECPF vport if it's an eswitch manager")
Fixes: 5019833d661f ("net/mlx5: E-switch, Introduce helper function to enable/disable vports")
Signed-off-by: Bodong Wang
Reviewed-by: Mark Bloch
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d5683ec3899da43fb309393e55f2b740524477c7
Author: Jiri Pirko
Date: Thu May 25 10:01:02 2023 +0200
net/mlx5: Push devlink port PF/VF init/cleanup calls out of devlink\_port\_register/unregister()
[ Upstream commit d9833bcfe840fff5d368b1c7c68e05c95be8d19c ]
In order to prepare for
mlx5\_esw\_offloads\_devlink\_port\_register/unregister() to be used
for SFs as well, push out the PF/VF specific init/cleanup calls outside.
Introduce mlx5\_eswitch\_load/unload\_pf\_vf\_vport() and call them from
there. Use these new helpers of PF/VF loading and make
mlx5\_eswitch\_local/unload\_vport() reusable for SFs.
Signed-off-by: Jiri Pirko
Reviewed-by: Shay Drory
Signed-off-by: Saeed Mahameed
Stable-dep-of: 344134609a56 ("mlx5/core: E-Switch, Create ACL FT for eswitch manager in switchdev mode")
Signed-off-by: Sasha Levin
commit 5e3e61f7eaac804a110db0002675ccc8f571740c
Author: Jiri Pirko
Date: Wed May 24 17:46:47 2023 +0200
net/mlx5: Rework devlink port alloc/free into init/cleanup
[ Upstream commit 4c0dac1ef8abc6295a91197884f5ceb5d11c2bd9 ]
In order to prepare the devlink port registration function to be common
for PFs/VFs and SFs, change the existing devlink port allocation and
free functions into PF/VF init and cleanup, so similar helpers could be
later on introduced for SFs. Make the init/cleanup helpers responsible
for setting/clearing the vport->dl\_port pointer.
Signed-off-by: Jiri Pirko
Reviewed-by: Shay Drory
Signed-off-by: Saeed Mahameed
Stable-dep-of: 344134609a56 ("mlx5/core: E-Switch, Create ACL FT for eswitch manager in switchdev mode")
Signed-off-by: Sasha Levin
commit c4a9d6a5c68172c76b58a9afa48f419f4ab19b2c
Author: Jiri Pirko
Date: Thu May 25 09:42:09 2023 +0200
net/mlx5: Give esw\_offloads\_load/unload\_rep() "mlx5\_" prefix
[ Upstream commit 9eca8bb8da4385b02bd02b6876af8d4225bf4713 ]
As esw\_offloads\_load/unload\_rep() are used outside eswitch.c it is nicer
for them to have "mlx5\_" prefix. Add it.
Signed-off-by: Jiri Pirko
Reviewed-by: Shay Drory
Signed-off-by: Saeed Mahameed
Stable-dep-of: 344134609a56 ("mlx5/core: E-Switch, Create ACL FT for eswitch manager in switchdev mode")
Signed-off-by: Sasha Levin
commit c1aece30ed884cb30c73ce12ee49c715831b391b
Author: Jianbo Liu
Date: Tue Sep 5 10:48:45 2023 -0700
net/mlx5e: Clear mirred devices array if the rule is split
[ Upstream commit b7558a77529fef60e7992f40fb5353fed8be0cf8 ]
In the cited commit, the mirred devices are recorded and checked while
parsing the actions. In order to avoid system crash, the duplicate
action in a single rule is not allowed.
But the rule is actually break down into several FTEs in different
tables, for either mirroring, or the specified types of actions which
use post action infrastructure.
It will reject certain action list by mistake, for example:
actions:enp8s0f0\_1,set(ipv4(ttl=63)),enp8s0f0\_0,enp8s0f0\_1.
Here the rule is split to two FTEs because of pedit action.
To fix this issue, when parsing the rule actions, reset if\_count to
clear the mirred devices array if the rule is split to multiple
FTEs, and then the duplicate checking is restarted.
Fixes: 554fe75c1b3f ("net/mlx5e: Avoid duplicating rule destinations")
Signed-off-by: Jianbo Liu
Reviewed-by: Vlad Buslov
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b9c7805994fa706cd56b1a0ee9e701bf33b298e8
Author: Eric Dumazet
Date: Tue Sep 5 13:40:46 2023 +0000
ip\_tunnels: use DEV\_STATS\_INC()
[ Upstream commit 9b271ebaf9a2c5c566a54bc6cd915962e8241130 ]
syzbot/KCSAN reported data-races in iptunnel\_xmit\_stats() [1]
This can run from multiple cpus without mutual exclusion.
Adopt SMP safe DEV\_STATS\_INC() to update dev->stats fields.
[1]
BUG: KCSAN: data-race in iptunnel\_xmit / iptunnel\_xmit
read-write to 0xffff8881353df170 of 8 bytes by task 30263 on cpu 1:
iptunnel\_xmit\_stats include/net/ip\_tunnels.h:493 [inline]
iptunnel\_xmit+0x432/0x4a0 net/ipv4/ip\_tunnel\_core.c:87
ip\_tunnel\_xmit+0x1477/0x1750 net/ipv4/ip\_tunnel.c:831
\_\_gre\_xmit net/ipv4/ip\_gre.c:469 [inline]
ipgre\_xmit+0x516/0x570 net/ipv4/ip\_gre.c:662
\_\_netdev\_start\_xmit include/linux/netdevice.h:4889 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4903 [inline]
xmit\_one net/core/dev.c:3544 [inline]
dev\_hard\_start\_xmit+0x11b/0x3f0 net/core/dev.c:3560
\_\_dev\_queue\_xmit+0xeee/0x1de0 net/core/dev.c:4340
dev\_queue\_xmit include/linux/netdevice.h:3082 [inline]
\_\_bpf\_tx\_skb net/core/filter.c:2129 [inline]
\_\_bpf\_redirect\_no\_mac net/core/filter.c:2159 [inline]
\_\_bpf\_redirect+0x723/0x9c0 net/core/filter.c:2182
\_\_\_\_bpf\_clone\_redirect net/core/filter.c:2453 [inline]
bpf\_clone\_redirect+0x16c/0x1d0 net/core/filter.c:2425
\_\_\_bpf\_prog\_run+0xd7d/0x41e0 kernel/bpf/core.c:1954
\_\_bpf\_prog\_run512+0x74/0xa0 kernel/bpf/core.c:2195
bpf\_dispatcher\_nop\_func include/linux/bpf.h:1181 [inline]
\_\_bpf\_prog\_run include/linux/filter.h:609 [inline]
bpf\_prog\_run include/linux/filter.h:616 [inline]
bpf\_test\_run+0x15d/0x3d0 net/bpf/test\_run.c:423
bpf\_prog\_test\_run\_skb+0x77b/0xa00 net/bpf/test\_run.c:1045
bpf\_prog\_test\_run+0x265/0x3d0 kernel/bpf/syscall.c:3996
\_\_sys\_bpf+0x3af/0x780 kernel/bpf/syscall.c:5353
\_\_do\_sys\_bpf kernel/bpf/syscall.c:5439 [inline]
\_\_se\_sys\_bpf kernel/bpf/syscall.c:5437 [inline]
\_\_x64\_sys\_bpf+0x43/0x50 kernel/bpf/syscall.c:5437
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
read-write to 0xffff8881353df170 of 8 bytes by task 30249 on cpu 0:
iptunnel\_xmit\_stats include/net/ip\_tunnels.h:493 [inline]
iptunnel\_xmit+0x432/0x4a0 net/ipv4/ip\_tunnel\_core.c:87
ip\_tunnel\_xmit+0x1477/0x1750 net/ipv4/ip\_tunnel.c:831
\_\_gre\_xmit net/ipv4/ip\_gre.c:469 [inline]
ipgre\_xmit+0x516/0x570 net/ipv4/ip\_gre.c:662
\_\_netdev\_start\_xmit include/linux/netdevice.h:4889 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4903 [inline]
xmit\_one net/core/dev.c:3544 [inline]
dev\_hard\_start\_xmit+0x11b/0x3f0 net/core/dev.c:3560
\_\_dev\_queue\_xmit+0xeee/0x1de0 net/core/dev.c:4340
dev\_queue\_xmit include/linux/netdevice.h:3082 [inline]
\_\_bpf\_tx\_skb net/core/filter.c:2129 [inline]
\_\_bpf\_redirect\_no\_mac net/core/filter.c:2159 [inline]
\_\_bpf\_redirect+0x723/0x9c0 net/core/filter.c:2182
\_\_\_\_bpf\_clone\_redirect net/core/filter.c:2453 [inline]
bpf\_clone\_redirect+0x16c/0x1d0 net/core/filter.c:2425
\_\_\_bpf\_prog\_run+0xd7d/0x41e0 kernel/bpf/core.c:1954
\_\_bpf\_prog\_run512+0x74/0xa0 kernel/bpf/core.c:2195
bpf\_dispatcher\_nop\_func include/linux/bpf.h:1181 [inline]
\_\_bpf\_prog\_run include/linux/filter.h:609 [inline]
bpf\_prog\_run include/linux/filter.h:616 [inline]
bpf\_test\_run+0x15d/0x3d0 net/bpf/test\_run.c:423
bpf\_prog\_test\_run\_skb+0x77b/0xa00 net/bpf/test\_run.c:1045
bpf\_prog\_test\_run+0x265/0x3d0 kernel/bpf/syscall.c:3996
\_\_sys\_bpf+0x3af/0x780 kernel/bpf/syscall.c:5353
\_\_do\_sys\_bpf kernel/bpf/syscall.c:5439 [inline]
\_\_se\_sys\_bpf kernel/bpf/syscall.c:5437 [inline]
\_\_x64\_sys\_bpf+0x43/0x50 kernel/bpf/syscall.c:5437
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x0000000000018830 -> 0x0000000000018831
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 30249 Comm: syz-executor.4 Not tainted 6.5.0-syzkaller-11704-g3f86ed6ec0b3 #0
Fixes: 039f50629b7f ("ip\_tunnel: Move stats update to iptunnel\_xmit()")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ed66a54bce05cba0cde30773630c193430facee9
Author: Ariel Marcovitch
Date: Sat Aug 26 20:33:17 2023 +0300
idr: fix param name in idr\_alloc\_cyclic() doc
[ Upstream commit 2a15de80dd0f7e04a823291aa9eb49c5294f56af ]
The relevant parameter is 'start' and not 'nextid'
Fixes: 460488c58ca8 ("idr: Remove idr\_alloc\_ext")
Signed-off-by: Ariel Marcovitch
Signed-off-by: Matthew Wilcox (Oracle)
Signed-off-by: Sasha Levin
commit e52c1698088ccbc36c5984fce6b29e3813d697b9
Author: Jerome Neanne
Date: Tue Sep 5 16:07:34 2023 +0200
regulator: tps6594-regulator: Fix random kernel crash
[ Upstream commit ca0e36e3e39a4e8b5a4b647dff8c5938ca6ccbec ]
Random kernel crash detected in TI CICD when regulator driver is added.
This is root caused to irq index increment being done twice causing
irq\_data being allocated outside of the range.
- Rework tps6594\_request\_reg\_irqs with correct index increment
- Adjust irq\_data kmalloc size to the exact size needed for the device
This has been reported on TI mainline. No public bug report associated.
Reported-by: Udit Kumar
Fixes: f17ccc5deb4d ("regulator: tps6594-regulator: Add driver for TI TPS6594 regulators")
Signed-off-by: Jerome Neanne
Link: https://lore.kernel.org/r/20230828-tps6594\_random\_boot\_crash\_fix-v1-1-f29cbf9ddb37@baylibre.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 174f11ef1615ec3ab1e2189685864433c0d855a2
Author: Andy Shevchenko
Date: Thu Aug 31 13:59:59 2023 +0300
s390/zcrypt: don't leak memory if dev\_set\_name() fails
[ Upstream commit 6252f47b78031979ad919f971dc8468b893488bd ]
When dev\_set\_name() fails, zcdn\_create() doesn't free the newly
allocated resources. Do it.
Fixes: 00fab2350e6b ("s390/zcrypt: multiple zcrypt device nodes support")
Signed-off-by: Andy Shevchenko
Link: https://lore.kernel.org/r/20230831110000.24279-1-andriy.shevchenko@linux.intel.com
Signed-off-by: Harald Freudenberger
Signed-off-by: Heiko Carstens
Signed-off-by: Sasha Levin
commit 2a86ad78abe053a0109561676ea37ff6f7c0a1ca
Author: Olga Zaborska
Date: Tue Jul 25 10:10:58 2023 +0200
igb: Change IGB\_MIN to allow set rx/tx value between 64 and 80
[ Upstream commit 6319685bdc8ad5310890add907b7c42f89302886 ]
Change the minimum value of RX/TX descriptors to 64 to enable setting the rx/tx
value between 64 and 80. All igb devices can use as low as 64 descriptors.
This change will unify igb with other drivers.
Based on commit 7b1be1987c1e ("e1000e: lower ring minimum size to 64")
Fixes: 9d5c824399de ("igb: PCI-Express 82575 Gigabit Ethernet driver")
Signed-off-by: Olga Zaborska
Tested-by: Pucha Himasekhar Reddy  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit a47535904c5bc22904c209f4684ca94b405af94e
Author: Olga Zaborska
Date: Tue Jul 25 10:10:57 2023 +0200
igbvf: Change IGBVF\_MIN to allow set rx/tx value between 64 and 80
[ Upstream commit 8360717524a24a421c36ef8eb512406dbd42160a ]
Change the minimum value of RX/TX descriptors to 64 to enable setting the rx/tx
value between 64 and 80. All igbvf devices can use as low as 64 descriptors.
This change will unify igbvf with other drivers.
Based on commit 7b1be1987c1e ("e1000e: lower ring minimum size to 64")
Fixes: d4e0fe01a38a ("igbvf: add new driver to support 82576 virtual functions")
Signed-off-by: Olga Zaborska
Tested-by: Rafal Romanowski
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 3ce31d747265cbfbff972850e8a96ec81f1d218b
Author: Olga Zaborska
Date: Tue Jul 25 10:10:56 2023 +0200
igc: Change IGC\_MIN to allow set rx/tx value between 64 and 80
[ Upstream commit 5aa48279712e1f134aac908acde4df798955a955 ]
Change the minimum value of RX/TX descriptors to 64 to enable setting the rx/tx
value between 64 and 80. All igc devices can use as low as 64 descriptors.
This change will unify igc with other drivers.
Based on commit 7b1be1987c1e ("e1000e: lower ring minimum size to 64")
Fixes: 0507ef8a0372 ("igc: Add transmit and receive fastpath and interrupt handlers")
Signed-off-by: Olga Zaborska
Tested-by: Naama Meir
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 7167f68d0b0e87ade7bf176f3885f5d304699d8d
Author: Geetha sowjanya
Date: Tue Sep 5 12:18:16 2023 +0530
octeontx2-af: Fix truncation of smq in CN10K NIX AQ enqueue mbox handler
[ Upstream commit 29fe7a1b62717d58f033009874554d99d71f7d37 ]
The smq value used in the CN10K NIX AQ instruction enqueue mailbox
handler was truncated to 9-bit value from 10-bit value because of
typecasting the CN10K mbox request structure to the CN9K structure.
Though this hasn't caused any problems when programming the NIX SQ
context to the HW because the context structure is the same size.
However, this causes a problem when accessing the structure parameters.
This patch reads the right smq value for each platform.
Fixes: 30077d210c83 ("octeontx2-af: cn10k: Update NIX/NPA context structure")
Signed-off-by: Geetha sowjanya
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 703e5f708360b1400ff269a14c6837c42ef3365e
Author: Shigeru Yoshida
Date: Sun Sep 3 02:07:08 2023 +0900
kcm: Destroy mutex in kcm\_exit\_net()
[ Upstream commit 6ad40b36cd3b04209e2d6c89d252c873d8082a59 ]
kcm\_exit\_net() should call mutex\_destroy() on knet->mutex. This is especially
needed if CONFIG\_DEBUG\_MUTEXES is enabled.
Fixes: ab7ac4eb9832 ("kcm: Kernel Connection Multiplexor module")
Signed-off-by: Shigeru Yoshida
Link: https://lore.kernel.org/r/20230902170708.1727999-1-syoshida@redhat.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit e5471b82c36396e809817cb988dfc4bce0a688cb
Author: valis
Date: Fri Sep 1 12:22:37 2023 -0400
net: sched: sch\_qfq: Fix UAF in qfq\_dequeue()
[ Upstream commit 8fc134fee27f2263988ae38920bc03da416b03d8 ]
When the plug qdisc is used as a class of the qfq qdisc it could trigger a
UAF. This issue can be reproduced with following commands:
tc qdisc add dev lo root handle 1: qfq
tc class add dev lo parent 1: classid 1:1 qfq weight 1 maxpkt 512
tc qdisc add dev lo parent 1:1 handle 2: plug
tc filter add dev lo parent 1: basic classid 1:1
ping -c1 127.0.0.1
and boom:
[ 285.353793] BUG: KASAN: slab-use-after-free in qfq\_dequeue+0xa7/0x7f0
[ 285.354910] Read of size 4 at addr ffff8880bad312a8 by task ping/144
[ 285.355903]
[ 285.356165] CPU: 1 PID: 144 Comm: ping Not tainted 6.5.0-rc3+ #4
[ 285.357112] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-2 04/01/2014
[ 285.358376] Call Trace:
[ 285.358773]
[ 285.359109] dump\_stack\_lvl+0x44/0x60
[ 285.359708] print\_address\_description.constprop.0+0x2c/0x3c0
[ 285.360611] kasan\_report+0x10c/0x120
[ 285.361195] ? qfq\_dequeue+0xa7/0x7f0
[ 285.361780] qfq\_dequeue+0xa7/0x7f0
[ 285.362342] \_\_qdisc\_run+0xf1/0x970
[ 285.362903] net\_tx\_action+0x28e/0x460
[ 285.363502] \_\_do\_softirq+0x11b/0x3de
[ 285.364097] do\_softirq.part.0+0x72/0x90
[ 285.364721]
[ 285.365072]
[ 285.365422] \_\_local\_bh\_enable\_ip+0x77/0x90
[ 285.366079] \_\_dev\_queue\_xmit+0x95f/0x1550
[ 285.366732] ? \_\_pfx\_csum\_and\_copy\_from\_iter+0x10/0x10
[ 285.367526] ? \_\_pfx\_\_\_dev\_queue\_xmit+0x10/0x10
[ 285.368259] ? \_\_build\_skb\_around+0x129/0x190
[ 285.368960] ? ip\_generic\_getfrag+0x12c/0x170
[ 285.369653] ? \_\_pfx\_ip\_generic\_getfrag+0x10/0x10
[ 285.370390] ? csum\_partial+0x8/0x20
[ 285.370961] ? raw\_getfrag+0xe5/0x140
[ 285.371559] ip\_finish\_output2+0x539/0xa40
[ 285.372222] ? \_\_pfx\_ip\_finish\_output2+0x10/0x10
[ 285.372954] ip\_output+0x113/0x1e0
[ 285.373512] ? \_\_pfx\_ip\_output+0x10/0x10
[ 285.374130] ? icmp\_out\_count+0x49/0x60
[ 285.374739] ? \_\_pfx\_ip\_finish\_output+0x10/0x10
[ 285.375457] ip\_push\_pending\_frames+0xf3/0x100
[ 285.376173] raw\_sendmsg+0xef5/0x12d0
[ 285.376760] ? do\_syscall\_64+0x40/0x90
[ 285.377359] ? \_\_static\_call\_text\_end+0x136578/0x136578
[ 285.378173] ? do\_syscall\_64+0x40/0x90
[ 285.378772] ? kasan\_enable\_current+0x11/0x20
[ 285.379469] ? \_\_pfx\_raw\_sendmsg+0x10/0x10
[ 285.380137] ? \_\_sock\_create+0x13e/0x270
[ 285.380673] ? \_\_sys\_socket+0xf3/0x180
[ 285.381174] ? \_\_x64\_sys\_socket+0x3d/0x50
[ 285.381725] ? entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
[ 285.382425] ? \_\_rcu\_read\_unlock+0x48/0x70
[ 285.382975] ? ip4\_datagram\_release\_cb+0xd8/0x380
[ 285.383608] ? \_\_pfx\_ip4\_datagram\_release\_cb+0x10/0x10
[ 285.384295] ? preempt\_count\_sub+0x14/0xc0
[ 285.384844] ? \_\_list\_del\_entry\_valid+0x76/0x140
[ 285.385467] ? \_raw\_spin\_lock\_bh+0x87/0xe0
[ 285.386014] ? \_\_pfx\_\_raw\_spin\_lock\_bh+0x10/0x10
[ 285.386645] ? release\_sock+0xa0/0xd0
[ 285.387148] ? preempt\_count\_sub+0x14/0xc0
[ 285.387712] ? freeze\_secondary\_cpus+0x348/0x3c0
[ 285.388341] ? aa\_sk\_perm+0x177/0x390
[ 285.388856] ? \_\_pfx\_aa\_sk\_perm+0x10/0x10
[ 285.389441] ? check\_stack\_object+0x22/0x70
[ 285.390032] ? inet\_send\_prepare+0x2f/0x120
[ 285.390603] ? \_\_pfx\_inet\_sendmsg+0x10/0x10
[ 285.391172] sock\_sendmsg+0xcc/0xe0
[ 285.391667] \_\_sys\_sendto+0x190/0x230
[ 285.392168] ? \_\_pfx\_\_\_sys\_sendto+0x10/0x10
[ 285.392727] ? kvm\_clock\_get\_cycles+0x14/0x30
[ 285.393328] ? set\_normalized\_timespec64+0x57/0x70
[ 285.393980] ? \_raw\_spin\_unlock\_irq+0x1b/0x40
[ 285.394578] ? \_\_x64\_sys\_clock\_gettime+0x11c/0x160
[ 285.395225] ? \_\_pfx\_\_\_x64\_sys\_clock\_gettime+0x10/0x10
[ 285.395908] ? \_copy\_to\_user+0x3e/0x60
[ 285.396432] ? exit\_to\_user\_mode\_prepare+0x1a/0x120
[ 285.397086] ? syscall\_exit\_to\_user\_mode+0x22/0x50
[ 285.397734] ? do\_syscall\_64+0x71/0x90
[ 285.398258] \_\_x64\_sys\_sendto+0x74/0x90
[ 285.398786] do\_syscall\_64+0x64/0x90
[ 285.399273] ? exit\_to\_user\_mode\_prepare+0x1a/0x120
[ 285.399949] ? syscall\_exit\_to\_user\_mode+0x22/0x50
[ 285.400605] ? do\_syscall\_64+0x71/0x90
[ 285.401124] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
[ 285.401807] RIP: 0033:0x495726
[ 285.402233] Code: ff ff ff f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b8 0f 1f 00 41 89 ca 64 8b 04 25 18 00 00 00 85 c0 75 11 b8 2c 00 00 00 0f 09
[ 285.404683] RSP: 002b:00007ffcc25fb618 EFLAGS: 00000246 ORIG\_RAX: 000000000000002c
[ 285.405677] RAX: ffffffffffffffda RBX: 0000000000000040 RCX: 0000000000495726
[ 285.406628] RDX: 0000000000000040 RSI: 0000000002518750 RDI: 0000000000000000
[ 285.407565] RBP: 00000000005205ef R08: 00000000005f8838 R09: 000000000000001c
[ 285.408523] R10: 0000000000000000 R11: 0000000000000246 R12: 0000000002517634
[ 285.409460] R13: 00007ffcc25fb6f0 R14: 0000000000000003 R15: 0000000000000000
[ 285.410403]
[ 285.410704]
[ 285.410929] Allocated by task 144:
[ 285.411402] kasan\_save\_stack+0x1e/0x40
[ 285.411926] kasan\_set\_track+0x21/0x30
[ 285.412442] \_\_kasan\_slab\_alloc+0x55/0x70
[ 285.412973] kmem\_cache\_alloc\_node+0x187/0x3d0
[ 285.413567] \_\_alloc\_skb+0x1b4/0x230
[ 285.414060] \_\_ip\_append\_data+0x17f7/0x1b60
[ 285.414633] ip\_append\_data+0x97/0xf0
[ 285.415144] raw\_sendmsg+0x5a8/0x12d0
[ 285.415640] sock\_sendmsg+0xcc/0xe0
[ 285.416117] \_\_sys\_sendto+0x190/0x230
[ 285.416626] \_\_x64\_sys\_sendto+0x74/0x90
[ 285.417145] do\_syscall\_64+0x64/0x90
[ 285.417624] entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
[ 285.418306]
[ 285.418531] Freed by task 144:
[ 285.418960] kasan\_save\_stack+0x1e/0x40
[ 285.419469] kasan\_set\_track+0x21/0x30
[ 285.419988] kasan\_save\_free\_info+0x27/0x40
[ 285.420556] \_\_\_\_kasan\_slab\_free+0x109/0x1a0
[ 285.421146] kmem\_cache\_free+0x1c2/0x450
[ 285.421680] \_\_netif\_receive\_skb\_core+0x2ce/0x1870
[ 285.422333] \_\_netif\_receive\_skb\_one\_core+0x97/0x140
[ 285.423003] process\_backlog+0x100/0x2f0
[ 285.423537] \_\_napi\_poll+0x5c/0x2d0
[ 285.424023] net\_rx\_action+0x2be/0x560
[ 285.424510] \_\_do\_softirq+0x11b/0x3de
[ 285.425034]
[ 285.425254] The buggy address belongs to the object at ffff8880bad31280
[ 285.425254] which belongs to the cache skbuff\_head\_cache of size 224
[ 285.426993] The buggy address is located 40 bytes inside of
[ 285.426993] freed 224-byte region [ffff8880bad31280, ffff8880bad31360)
[ 285.428572]
[ 285.428798] The buggy address belongs to the physical page:
[ 285.429540] page:00000000f4b77674 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0xbad31
[ 285.430758] flags: 0x100000000000200(slab|node=0|zone=1)
[ 285.431447] page\_type: 0xffffffff()
[ 285.431934] raw: 0100000000000200 ffff88810094a8c0 dead000000000122 0000000000000000
[ 285.432757] raw: 0000000000000000 00000000800c000c 00000001ffffffff 0000000000000000
[ 285.433562] page dumped because: kasan: bad access detected
[ 285.434144]
[ 285.434320] Memory state around the buggy address:
[ 285.434828] ffff8880bad31180: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 285.435580] ffff8880bad31200: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 285.436264] >ffff8880bad31280: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 285.436777] ^
[ 285.437106] ffff8880bad31300: fb fb fb fb fb fb fb fb fb fb fb fb fc fc fc fc
[ 285.437616] ffff8880bad31380: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 285.438126] ==================================================================
[ 285.438662] Disabling lock debugging due to kernel taint
Fix this by:
1. Changing sch\_plug's .peek handler to qdisc\_peek\_dequeued(), a
function compatible with non-work-conserving qdiscs
2. Checking the return value of qdisc\_dequeue\_peeked() in sch\_qfq.
Fixes: 462dbc9101ac ("pkt\_sched: QFQ Plus: fair-queueing service at DRR cost")
Reported-by: valis
Signed-off-by: valis
Signed-off-by: Jamal Hadi Salim
Link: https://lore.kernel.org/r/20230901162237.11525-1-jhs@mojatatu.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit a226df7e00dd0c5154813c52ae38282bbb533851
Author: Kuniyuki Iwashima
Date: Fri Sep 1 17:27:08 2023 -0700
af\_unix: Fix data race around sk->sk\_err.
[ Upstream commit b192812905e4b134f7b7994b079eb647e9d2d37e ]
As with sk->sk\_shutdown shown in the previous patch, sk->sk\_err can be
read locklessly by unix\_dgram\_sendmsg().
Let's use READ\_ONCE() for sk\_err as well.
Note that the writer side is marked by commit cc04410af7de ("af\_unix:
annotate lockless accesses to sk->sk\_err").
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d883243048aca57b4299ec4f332be205898c8d17
Author: Kuniyuki Iwashima
Date: Fri Sep 1 17:27:07 2023 -0700
af\_unix: Fix data-races around sk->sk\_shutdown.
[ Upstream commit afe8764f76346ba838d4f162883e23d2fcfaa90e ]
sk->sk\_shutdown is changed under unix\_state\_lock(sk), but
unix\_dgram\_sendmsg() calls two functions to read sk\_shutdown locklessly.
sock\_alloc\_send\_pskb
`- sock\_wait\_for\_wmem
Let's use READ\_ONCE() there.
Note that the writer side was marked by commit e1d09c2c2f57 ("af\_unix:
Fix data races around sk->sk\_shutdown.").
BUG: KCSAN: data-race in sock\_alloc\_send\_pskb / unix\_release\_sock
write (marked) to 0xffff8880069af12c of 1 bytes by task 1 on cpu 1:
unix\_release\_sock+0x75c/0x910 net/unix/af\_unix.c:631
unix\_release+0x59/0x80 net/unix/af\_unix.c:1053
\_\_sock\_release+0x7d/0x170 net/socket.c:654
sock\_close+0x19/0x30 net/socket.c:1386
\_\_fput+0x2a3/0x680 fs/file\_table.c:384
\_\_\_\_fput+0x15/0x20 fs/file\_table.c:412
task\_work\_run+0x116/0x1a0 kernel/task\_work.c:179
resume\_user\_mode\_work include/linux/resume\_user\_mode.h:49 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:171 [inline]
exit\_to\_user\_mode\_prepare+0x174/0x180 kernel/entry/common.c:204
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:286 [inline]
syscall\_exit\_to\_user\_mode+0x1a/0x30 kernel/entry/common.c:297
do\_syscall\_64+0x4b/0x90 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
read to 0xffff8880069af12c of 1 bytes by task 28650 on cpu 0:
sock\_alloc\_send\_pskb+0xd2/0x620 net/core/sock.c:2767
unix\_dgram\_sendmsg+0x2f8/0x14f0 net/unix/af\_unix.c:1944
unix\_seqpacket\_sendmsg net/unix/af\_unix.c:2308 [inline]
unix\_seqpacket\_sendmsg+0xba/0x130 net/unix/af\_unix.c:2292
sock\_sendmsg\_nosec net/socket.c:725 [inline]
sock\_sendmsg+0x148/0x160 net/socket.c:748
\_\_\_\_sys\_sendmsg+0x4e4/0x610 net/socket.c:2494
\_\_\_sys\_sendmsg+0xc6/0x140 net/socket.c:2548
\_\_sys\_sendmsg+0x94/0x140 net/socket.c:2577
\_\_do\_sys\_sendmsg net/socket.c:2586 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2584 [inline]
\_\_x64\_sys\_sendmsg+0x45/0x50 net/socket.c:2584
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
value changed: 0x00 -> 0x03
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 28650 Comm: systemd-coredum Not tainted 6.4.0-11989-g6843306689af #6
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: syzkaller
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit afc284a4a781defbb12b2a40427fae34c3d20e17
Author: Kuniyuki Iwashima
Date: Fri Sep 1 17:27:06 2023 -0700
af\_unix: Fix data-race around unix\_tot\_inflight.
[ Upstream commit ade32bd8a738d7497ffe9743c46728db26740f78 ]
unix\_tot\_inflight is changed under spin\_lock(unix\_gc\_lock), but
unix\_release\_sock() reads it locklessly.
Let's use READ\_ONCE() for unix\_tot\_inflight.
Note that the writer side was marked by commit 9d6d7f1cb67c ("af\_unix:
annote lockless accesses to unix\_tot\_inflight & gc\_in\_progress")
BUG: KCSAN: data-race in unix\_inflight / unix\_release\_sock
write (marked) to 0xffffffff871852b8 of 4 bytes by task 123 on cpu 1:
unix\_inflight+0x130/0x180 net/unix/scm.c:64
unix\_attach\_fds+0x137/0x1b0 net/unix/scm.c:123
unix\_scm\_to\_skb net/unix/af\_unix.c:1832 [inline]
unix\_dgram\_sendmsg+0x46a/0x14f0 net/unix/af\_unix.c:1955
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg+0x148/0x160 net/socket.c:747
\_\_\_\_sys\_sendmsg+0x4e4/0x610 net/socket.c:2493
\_\_\_sys\_sendmsg+0xc6/0x140 net/socket.c:2547
\_\_sys\_sendmsg+0x94/0x140 net/socket.c:2576
\_\_do\_sys\_sendmsg net/socket.c:2585 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2583 [inline]
\_\_x64\_sys\_sendmsg+0x45/0x50 net/socket.c:2583
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
read to 0xffffffff871852b8 of 4 bytes by task 4891 on cpu 0:
unix\_release\_sock+0x608/0x910 net/unix/af\_unix.c:671
unix\_release+0x59/0x80 net/unix/af\_unix.c:1058
\_\_sock\_release+0x7d/0x170 net/socket.c:653
sock\_close+0x19/0x30 net/socket.c:1385
\_\_fput+0x179/0x5e0 fs/file\_table.c:321
\_\_\_\_fput+0x15/0x20 fs/file\_table.c:349
task\_work\_run+0x116/0x1a0 kernel/task\_work.c:179
resume\_user\_mode\_work include/linux/resume\_user\_mode.h:49 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:171 [inline]
exit\_to\_user\_mode\_prepare+0x174/0x180 kernel/entry/common.c:204
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:286 [inline]
syscall\_exit\_to\_user\_mode+0x1a/0x30 kernel/entry/common.c:297
do\_syscall\_64+0x4b/0x90 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
value changed: 0x00000000 -> 0x00000001
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 4891 Comm: systemd-coredum Not tainted 6.4.0-rc5-01219-gfa0e21fa4443 #5
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
Fixes: 9305cfa4443d ("[AF\_UNIX]: Make unix\_tot\_inflight counter non-atomic")
Reported-by: syzkaller
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ac92f239a079678a035c0faad9089354a874aede
Author: Kuniyuki Iwashima
Date: Fri Sep 1 17:27:05 2023 -0700
af\_unix: Fix data-races around user->unix\_inflight.
[ Upstream commit 0bc36c0650b21df36fbec8136add83936eaf0607 ]
user->unix\_inflight is changed under spin\_lock(unix\_gc\_lock),
but too\_many\_unix\_fds() reads it locklessly.
Let's annotate the write/read accesses to user->unix\_inflight.
BUG: KCSAN: data-race in unix\_attach\_fds / unix\_inflight
write to 0xffffffff8546f2d0 of 8 bytes by task 44798 on cpu 1:
unix\_inflight+0x157/0x180 net/unix/scm.c:66
unix\_attach\_fds+0x147/0x1e0 net/unix/scm.c:123
unix\_scm\_to\_skb net/unix/af\_unix.c:1827 [inline]
unix\_dgram\_sendmsg+0x46a/0x14f0 net/unix/af\_unix.c:1950
unix\_seqpacket\_sendmsg net/unix/af\_unix.c:2308 [inline]
unix\_seqpacket\_sendmsg+0xba/0x130 net/unix/af\_unix.c:2292
sock\_sendmsg\_nosec net/socket.c:725 [inline]
sock\_sendmsg+0x148/0x160 net/socket.c:748
\_\_\_\_sys\_sendmsg+0x4e4/0x610 net/socket.c:2494
\_\_\_sys\_sendmsg+0xc6/0x140 net/socket.c:2548
\_\_sys\_sendmsg+0x94/0x140 net/socket.c:2577
\_\_do\_sys\_sendmsg net/socket.c:2586 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2584 [inline]
\_\_x64\_sys\_sendmsg+0x45/0x50 net/socket.c:2584
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
read to 0xffffffff8546f2d0 of 8 bytes by task 44814 on cpu 0:
too\_many\_unix\_fds net/unix/scm.c:101 [inline]
unix\_attach\_fds+0x54/0x1e0 net/unix/scm.c:110
unix\_scm\_to\_skb net/unix/af\_unix.c:1827 [inline]
unix\_dgram\_sendmsg+0x46a/0x14f0 net/unix/af\_unix.c:1950
unix\_seqpacket\_sendmsg net/unix/af\_unix.c:2308 [inline]
unix\_seqpacket\_sendmsg+0xba/0x130 net/unix/af\_unix.c:2292
sock\_sendmsg\_nosec net/socket.c:725 [inline]
sock\_sendmsg+0x148/0x160 net/socket.c:748
\_\_\_\_sys\_sendmsg+0x4e4/0x610 net/socket.c:2494
\_\_\_sys\_sendmsg+0xc6/0x140 net/socket.c:2548
\_\_sys\_sendmsg+0x94/0x140 net/socket.c:2577
\_\_do\_sys\_sendmsg net/socket.c:2586 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2584 [inline]
\_\_x64\_sys\_sendmsg+0x45/0x50 net/socket.c:2584
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3b/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
value changed: 0x000000000000000c -> 0x000000000000000d
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 44814 Comm: systemd-coredum Not tainted 6.4.0-11989-g6843306689af #6
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
Fixes: 712f4aad406b ("unix: properly account for FDs passed over unix sockets")
Reported-by: syzkaller
Signed-off-by: Kuniyuki Iwashima
Acked-by: Willy Tarreau
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 51bd1196ea4d0a2e63b49f93553bb5231a9f48cb
Author: Kuniyuki Iwashima
Date: Fri Sep 1 16:46:04 2023 -0700
af\_unix: Fix msg\_controllen test in scm\_pidfd\_recv() for MSG\_CMSG\_COMPAT.
[ Upstream commit 718e6b51298e0f254baca0d40ab52a00e004e014 ]
Heiko Carstens reported that SCM\_PIDFD does not work with MSG\_CMSG\_COMPAT
because scm\_pidfd\_recv() always checks msg\_controllen against sizeof(struct
cmsghdr).
We need to use sizeof(struct compat\_cmsghdr) for the compat case.
Fixes: 5e2ff6704a27 ("scm: add SO\_PASSPIDFD and SCM\_PIDFD")
Reported-by: Heiko Carstens
Closes: https://lore.kernel.org/netdev/20230901200517.8742-A-hca@linux.ibm.com/
Signed-off-by: Kuniyuki Iwashima
Tested-by: Heiko Carstens
Reviewed-by: Alexander Mikhalitsyn
Reviewed-by: Michal Swiatkowski
Acked-by: Christian Brauner
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e6b5e47adb9166e732cdf7e6e034946e3f89f36d
Author: John Fastabend
Date: Fri Sep 1 13:21:37 2023 -0700
bpf, sockmap: Fix skb refcnt race after locking changes
[ Upstream commit a454d84ee20baf7bd7be90721b9821f73c7d23d9 ]
There is a race where skb's from the sk\_psock\_backlog can be referenced
after userspace side has already skb\_consumed() the sk\_buff and its refcnt
dropped to zer0 causing use after free.
The flow is the following:
while ((skb = skb\_peek(&psock->ingress\_skb))
sk\_psock\_handle\_Skb(psock, skb, ..., ingress)
if (!ingress) ...
sk\_psock\_skb\_ingress
sk\_psock\_skb\_ingress\_enqueue(skb)
msg->skb = skb
sk\_psock\_queue\_msg(psock, msg)
skb\_dequeue(&psock->ingress\_skb)
The sk\_psock\_queue\_msg() puts the msg on the ingress\_msg queue. This is
what the application reads when recvmsg() is called. An application can
read this anytime after the msg is placed on the queue. The recvmsg hook
will also read msg->skb and then after user space reads the msg will call
consume\_skb(skb) on it effectively free'ing it.
But, the race is in above where backlog queue still has a reference to
the skb and calls skb\_dequeue(). If the skb\_dequeue happens after the
user reads and free's the skb we have a use after free.
The !ingress case does not suffer from this problem because it uses
sendmsg\_\*(sk, msg) which does not pass the sk\_buff further down the
stack.
The following splat was observed with 'test\_progs -t sockmap\_listen':
[ 1022.710250][ T2556] general protection fault, ...
[...]
[ 1022.712830][ T2556] Workqueue: events sk\_psock\_backlog
[ 1022.713262][ T2556] RIP: 0010:skb\_dequeue+0x4c/0x80
[ 1022.713653][ T2556] Code: ...
[...]
[ 1022.720699][ T2556] Call Trace:
[ 1022.720984][ T2556]
[ 1022.721254][ T2556] ? die\_addr+0x32/0x80^M
[ 1022.721589][ T2556] ? exc\_general\_protection+0x25a/0x4b0
[ 1022.722026][ T2556] ? asm\_exc\_general\_protection+0x22/0x30
[ 1022.722489][ T2556] ? skb\_dequeue+0x4c/0x80
[ 1022.722854][ T2556] sk\_psock\_backlog+0x27a/0x300
[ 1022.723243][ T2556] process\_one\_work+0x2a7/0x5b0
[ 1022.723633][ T2556] worker\_thread+0x4f/0x3a0
[ 1022.723998][ T2556] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 1022.724386][ T2556] kthread+0xfd/0x130
[ 1022.724709][ T2556] ? \_\_pfx\_kthread+0x10/0x10
[ 1022.725066][ T2556] ret\_from\_fork+0x2d/0x50
[ 1022.725409][ T2556] ? \_\_pfx\_kthread+0x10/0x10
[ 1022.725799][ T2556] ret\_from\_fork\_asm+0x1b/0x30
[ 1022.726201][ T2556]
To fix we add an skb\_get() before passing the skb to be enqueued in the
engress queue. This bumps the skb->users refcnt so that consume\_skb()
and kfree\_skb will not immediately free the sk\_buff. With this we can
be sure the skb is still around when we do the dequeue. Then we just
need to decrement the refcnt or free the skb in the backlog case which
we do by calling kfree\_skb() on the ingress case as well as the sendmsg
case.
Before locking change from fixes tag we had the sock locked so we
couldn't race with user and there was no issue here.
Fixes: 799aa7f98d53e ("skmsg: Avoid lock\_sock() in sk\_psock\_backlog()")
Reported-by: Jiri Olsa
Signed-off-by: John Fastabend
Signed-off-by: Daniel Borkmann
Tested-by: Xu Kuohai
Tested-by: Jiri Olsa
Link: https://lore.kernel.org/bpf/20230901202137.214666-1-john.fastabend@gmail.com
Signed-off-by: Sasha Levin
commit 3db68536ce76ebc19a9ed0d7e1b1c246be5ac9ef
Author: Oleksij Rempel
Date: Fri Sep 1 06:53:23 2023 +0200
net: phy: micrel: Correct bit assignments for phy\_device flags
[ Upstream commit 719c5e37e99d2fd588d1c994284d17650a66354c ]
Previously, the defines for phy\_device flags in the Micrel driver were
ambiguous in their representation. They were intended to be bit masks
but were mistakenly defined as bit positions. This led to the following
issues:
- MICREL\_KSZ8\_P1\_ERRATA, designated for KSZ88xx switches, overlapped
with MICREL\_PHY\_FXEN and MICREL\_PHY\_50MHZ\_CLK.
- Due to this overlap, the code path for MICREL\_PHY\_FXEN, tailored for
the KSZ8041 PHY, was not executed for KSZ88xx PHYs.
- Similarly, the code associated with MICREL\_PHY\_50MHZ\_CLK wasn't
triggered for KSZ88xx.
To rectify this, all three flags have now been explicitly converted to
use the `BIT()` macro, ensuring they are defined as bit masks and
preventing potential overlaps in the future.
Fixes: 49011e0c1555 ("net: phy: micrel: ksz886x/ksz8081: add cabletest support")
Signed-off-by: Oleksij Rempel
Reviewed-by: Russell King (Oracle)
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fbdfbc80362b431c0f12427b07e78d6512b7a715
Author: Alex Henrie
Date: Thu Aug 31 22:41:27 2023 -0600
net: ipv6/addrconf: avoid integer underflow in ipv6\_create\_tempaddr
[ Upstream commit f31867d0d9d82af757c1e0178b659438f4c1ea3c ]
The existing code incorrectly casted a negative value (the result of a
subtraction) to an unsigned value without checking. For example, if
/proc/sys/net/ipv6/conf/\*/temp\_prefered\_lft was set to 1, the preferred
lifetime would jump to 4 billion seconds. On my machine and network the
shortest lifetime that avoided underflow was 3 seconds.
Fixes: 76506a986dc3 ("IPv6: fix DESYNC\_FACTOR")
Signed-off-by: Alex Henrie
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cad8c215be8c36720105de7e9fb67cc1c8fd6006
Author: Liang Chen
Date: Fri Sep 1 12:09:21 2023 +0800
veth: Fixing transmit return status for dropped packets
[ Upstream commit 151e887d8ff97e2e42110ffa1fb1e6a2128fb364 ]
The veth\_xmit function returns NETDEV\_TX\_OK even when packets are dropped.
This behavior leads to incorrect calculations of statistics counts, as
well as things like txq->trans\_start updates.
Fixes: e314dbdc1c0d ("[NET]: Virtual ethernet device driver.")
Signed-off-by: Liang Chen
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 605f45b418e0882f2a5cf836c2a26cbadb4c3e81
Author: Eric Dumazet
Date: Thu Aug 31 21:38:12 2023 +0000
gve: fix frag\_list chaining
[ Upstream commit 817c7cd2043a83a3d8147f40eea1505ac7300b62 ]
gve\_rx\_append\_frags() is able to build skbs chained with frag\_list,
like GRO engine.
Problem is that shinfo->frag\_list should only be used
for the head of the chain.
All other links should use skb->next pointer.
Otherwise, built skbs are not valid and can cause crashes.
Equivalent code in GRO (skb\_gro\_receive()) is:
if (NAPI\_GRO\_CB(p)->last == p)
skb\_shinfo(p)->frag\_list = skb;
else
NAPI\_GRO\_CB(p)->last->next = skb;
NAPI\_GRO\_CB(p)->last = skb;
Fixes: 9b8dd5e5ea48 ("gve: DQO: Add RX path")
Signed-off-by: Eric Dumazet
Cc: Bailey Forrest
Cc: Willem de Bruijn
Cc: Catherine Sullivan
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 39acd66ada7136dd596f254a88eccd5d23a4ce7b
Author: Corinna Vinschen
Date: Thu Aug 31 14:19:13 2023 +0200
igb: disable virtualization features on 82580
[ Upstream commit fa09bc40b21a33937872c4c4cf0f266ec9fa4869 ]
Disable virtualization features on 82580 just as on i210/i211.
This avoids that virt functions are acidentally called on 82850.
Fixes: 55cac248caa4 ("igb: Add full support for 82580 devices")
Signed-off-by: Corinna Vinschen
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ae211fd518d700e96b1a8c4e61aea2520e92df65
Author: Xu Kuohai
Date: Fri Sep 1 11:10:37 2023 +0800
selftests/bpf: Fix a CI failure caused by vsock write
[ Upstream commit c1970e26bdc1209974bb5cf31cc23f2b7ad6ce50 ]
While commit 90f0074cd9f9 ("selftests/bpf: fix a CI failure caused by vsock sockmap test")
fixes a receive failure of vsock sockmap test, there is still a write failure:
Error: #211/79 sockmap\_listen/sockmap VSOCK test\_vsock\_redir
Error: #211/79 sockmap\_listen/sockmap VSOCK test\_vsock\_redir
./test\_progs:vsock\_unix\_redir\_connectible:1501: egress: write: Transport endpoint is not connected
vsock\_unix\_redir\_connectible:FAIL:1501
./test\_progs:vsock\_unix\_redir\_connectible:1501: ingress: write: Transport endpoint is not connected
vsock\_unix\_redir\_connectible:FAIL:1501
./test\_progs:vsock\_unix\_redir\_connectible:1501: egress: write: Transport endpoint is not connected
vsock\_unix\_redir\_connectible:FAIL:1501
The reason is that the vsock connection in the test is set to ESTABLISHED state
by function virtio\_transport\_recv\_pkt, which is executed in a workqueue thread,
so when the user space test thread runs before the workqueue thread, this
problem occurs.
To fix it, before writing the connection, wait for it to be connected.
Fixes: d61bd8c1fd02 ("selftests/bpf: add a test case for vsock sockmap")
Signed-off-by: Xu Kuohai
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20230901031037.3314007-1-xukuohai@huaweicloud.com
Signed-off-by: Sasha Levin
commit be5879bade482a2bb605dc7b21e2c211720a8ff4
Author: Sriram Yagnaraman
Date: Thu Aug 31 10:03:31 2023 +0200
ipv6: ignore dst hint for multipath routes
[ Upstream commit 8423be8926aa82cd2e28bba5cc96ccb72c7ce6be ]
Route hints when the nexthop is part of a multipath group causes packets
in the same receive batch to be sent to the same nexthop irrespective of
the multipath hash of the packet. So, do not extract route hint for
packets whose destination is part of a multipath group.
A new SKB flag IP6SKB\_MULTIPATH is introduced for this purpose, set the
flag when route is looked up in fib6\_select\_path() and use it in
ip6\_can\_use\_hint() to check for the existence of the flag.
Fixes: 197dbf24e360 ("ipv6: introduce and uses route look hints for list input.")
Signed-off-by: Sriram Yagnaraman
Reviewed-by: Ido Schimmel
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 292a742fe33b6a3a57bac4a8befd59a8776b2811
Author: Sriram Yagnaraman
Date: Thu Aug 31 10:03:30 2023 +0200
ipv4: ignore dst hint for multipath routes
[ Upstream commit 6ac66cb03ae306c2e288a9be18226310529f5b25 ]
Route hints when the nexthop is part of a multipath group causes packets
in the same receive batch to be sent to the same nexthop irrespective of
the multipath hash of the packet. So, do not extract route hint for
packets whose destination is part of a multipath group.
A new SKB flag IPSKB\_MULTIPATH is introduced for this purpose, set the
flag when route is looked up in ip\_mkroute\_input() and use it in
ip\_extract\_route\_hint() to check for the existence of the flag.
Fixes: 02b24941619f ("ipv4: use dst hint for ipv4 list receive")
Signed-off-by: Sriram Yagnaraman
Reviewed-by: Ido Schimmel
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5f4836eca4f9c5fb6e3e49d9b09e1545cf472684
Author: Eric Dumazet
Date: Thu Aug 31 13:52:12 2023 +0000
net: annotate data-races around sk->sk\_bind\_phc
[ Upstream commit 251cd405a9e6e70b92fe5afbdd17fd5caf9d3266 ]
sk->sk\_bind\_phc is read locklessly. Add corresponding annotations.
Fixes: d463126e23f1 ("net: sock: extend SO\_TIMESTAMPING for PHC binding")
Signed-off-by: Eric Dumazet
Cc: Yangbo Lu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b352717b3cc265c97ad817696c24c173cd7f9294
Author: Eric Dumazet
Date: Thu Aug 31 13:52:11 2023 +0000
net: annotate data-races around sk->sk\_tsflags
[ Upstream commit e3390b30a5dfb112e8e802a59c0f68f947b638b2 ]
sk->sk\_tsflags can be read locklessly, add corresponding annotations.
Fixes: b9f40e21ef42 ("net-timestamp: move timestamp flags out of sk\_flags")
Signed-off-by: Eric Dumazet
Cc: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ca7fe4b1131de42954a68c5bf898f86ebef20f57
Author: Eric Dumazet
Date: Thu Aug 31 13:52:10 2023 +0000
mptcp: annotate data-races around msk->rmem\_fwd\_alloc
[ Upstream commit 9531e4a83febc3fb47ac77e24cfb5ea97e50034d ]
msk->rmem\_fwd\_alloc can be read locklessly.
Add mptcp\_rmem\_fwd\_alloc\_add(), similar to sk\_forward\_alloc\_add(),
and appropriate READ\_ONCE()/WRITE\_ONCE() annotations.
Fixes: 6511882cdd82 ("mptcp: allocate fwd memory separately on the rx and tx path")
Signed-off-by: Eric Dumazet
Cc: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 12f7eda26d690986621fbba0d7cbf118a192d826
Author: Eric Dumazet
Date: Thu Aug 31 13:52:09 2023 +0000
net: annotate data-races around sk->sk\_forward\_alloc
[ Upstream commit 5e6300e7b3a4ab5b72a82079753868e91fbf9efc ]
Every time sk->sk\_forward\_alloc is read locklessly,
add a READ\_ONCE().
Add sk\_forward\_alloc\_add() helper to centralize updates,
to reduce number of WRITE\_ONCE().
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3d34ec2ba1fb28e4f8fb70fddfb072aac221c043
Author: Eric Dumazet
Date: Thu Aug 31 13:52:08 2023 +0000
net: use sk\_forward\_alloc\_get() in sk\_get\_meminfo()
[ Upstream commit 66d58f046c9d3a8f996b7138d02e965fd0617de0 ]
inet\_sk\_diag\_fill() has been changed to use sk\_forward\_alloc\_get(),
but sk\_get\_meminfo() was forgotten.
Fixes: 292e6077b040 ("net: introduce sk\_forward\_alloc\_get()")
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 93d69f18edcca282351394c5870bec24cc99d745
Author: Eric Dumazet
Date: Thu Aug 31 08:45:09 2023 +0000
net/handshake: fix null-ptr-deref in handshake\_nl\_done\_doit()
[ Upstream commit 82ba0ff7bf0483d962e592017bef659ae022d754 ]
We should not call trace\_handshake\_cmd\_done\_err() if socket lookup has failed.
Also we should call trace\_handshake\_cmd\_done\_err() before releasing the file,
otherwise dereferencing sock->sk can return garbage.
This also reverts 7afc6d0a107f ("net/handshake: Fix uninitialized local variable")
Unable to handle kernel paging request at virtual address dfff800000000003
KASAN: null-ptr-deref in range [0x0000000000000018-0x000000000000001f]
Mem abort info:
ESR = 0x0000000096000005
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
FSC = 0x05: level 1 translation fault
Data abort info:
ISV = 0, ISS = 0x00000005, ISS2 = 0x00000000
CM = 0, WnR = 0, TnD = 0, TagAccess = 0
GCS = 0, Overlay = 0, DirtyBit = 0, Xs = 0
[dfff800000000003] address between user and kernel address ranges
Internal error: Oops: 0000000096000005 [#1] PREEMPT SMP
Modules linked in:
CPU: 1 PID: 5986 Comm: syz-executor292 Not tainted 6.5.0-rc7-syzkaller-gfe4469582053 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/26/2023
pstate: 80400005 (Nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : handshake\_nl\_done\_doit+0x198/0x9c8 net/handshake/netlink.c:193
lr : handshake\_nl\_done\_doit+0x180/0x9c8
sp : ffff800096e37180
x29: ffff800096e37200 x28: 1ffff00012dc6e34 x27: dfff800000000000
x26: ffff800096e373d0 x25: 0000000000000000 x24: 00000000ffffffa8
x23: ffff800096e373f0 x22: 1ffff00012dc6e38 x21: 0000000000000000
x20: ffff800096e371c0 x19: 0000000000000018 x18: 0000000000000000
x17: 0000000000000000 x16: ffff800080516cc4 x15: 0000000000000001
x14: 1fffe0001b14aa3b x13: 0000000000000000 x12: 0000000000000000
x11: 0000000000000000 x10: 0000000000000000 x9 : 0000000000000003
x8 : 0000000000000003 x7 : ffff800080afe47c x6 : 0000000000000000
x5 : 0000000000000000 x4 : 0000000000000000 x3 : ffff800080a88078
x2 : 0000000000000001 x1 : 00000000ffffffa8 x0 : 0000000000000000
Call trace:
handshake\_nl\_done\_doit+0x198/0x9c8 net/handshake/netlink.c:193
genl\_family\_rcv\_msg\_doit net/netlink/genetlink.c:970 [inline]
genl\_family\_rcv\_msg net/netlink/genetlink.c:1050 [inline]
genl\_rcv\_msg+0x96c/0xc50 net/netlink/genetlink.c:1067
netlink\_rcv\_skb+0x214/0x3c4 net/netlink/af\_netlink.c:2549
genl\_rcv+0x38/0x50 net/netlink/genetlink.c:1078
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1339 [inline]
netlink\_unicast+0x660/0x8d4 net/netlink/af\_netlink.c:1365
netlink\_sendmsg+0x834/0xb18 net/netlink/af\_netlink.c:1914
sock\_sendmsg\_nosec net/socket.c:725 [inline]
sock\_sendmsg net/socket.c:748 [inline]
\_\_\_\_sys\_sendmsg+0x56c/0x840 net/socket.c:2494
\_\_\_sys\_sendmsg net/socket.c:2548 [inline]
\_\_sys\_sendmsg+0x26c/0x33c net/socket.c:2577
\_\_do\_sys\_sendmsg net/socket.c:2586 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2584 [inline]
\_\_arm64\_sys\_sendmsg+0x80/0x94 net/socket.c:2584
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:37 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:51
el0\_svc\_common+0x130/0x23c arch/arm64/kernel/syscall.c:136
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:155
el0\_svc+0x58/0x16c arch/arm64/kernel/entry-common.c:678
el0t\_64\_sync\_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:696
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:591
Code: 12800108 b90043e8 910062b3 d343fe68 (387b6908)
Fixes: 3b3009ea8abb ("net/handshake: Create a NETLINK service for handling handshake requests")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Cc: Chuck Lever
Reviewed-by: Michal Kubiak
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 69b49b24f29dc7eadf77616216e33e20c805ff5d
Author: Hamza Mahfooz
Date: Fri Aug 18 09:11:11 2023 -0400
drm/amd/display: fix mode scaling (RMX\_.\*)
[ Upstream commit ea7971af7a911a7a388b4c47db2a231a6b8dcc29 ]
As made mention of in commit 4a2df0d1f28e ("drm/amd/display: Fixed
non-native modes not lighting up"), we shouldn't call
drm\_mode\_set\_crtcinfo() once the crtc timings have been decided. Since,
it can cause settings to be unintentionally overwritten. So, since
dm\_state is never NULL now, we can use old\_stream to determine if we
should call drm\_mode\_set\_crtcinfo() because we only need to set the crtc
timing parameters for entirely new streams.
Cc: Harry Wentland
Cc: Rodrigo Siqueira
Fixes: bd49f19039c1 ("drm/amd/display: Always set crtcinfo from create\_stream\_for\_sink")
Reviewed-by: Harry Wentland
Signed-off-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit ed059a6675da157b19f67d6f406739a9b1833477
Author: Sean Christopherson
Date: Fri Jul 28 18:35:16 2023 -0700
drm/i915/gvt: Drop unused helper intel\_vgpu\_reset\_gtt()
[ Upstream commit a90c367e5af63880008e21dd199dac839e0e9e0f ]
Drop intel\_vgpu\_reset\_gtt() as it no longer has any callers. In addition
to eliminating dead code, this eliminates the last possible scenario where
\_\_kvmgt\_protect\_table\_find() can be reached without holding vgpu\_lock.
Requiring vgpu\_lock to be held when calling \_\_kvmgt\_protect\_table\_find()
will allow a protecting the gfn hash with vgpu\_lock without too much fuss.
No functional change intended.
Fixes: ba25d977571e ("drm/i915/gvt: Do not destroy ppgtt\_mm during vGPU D3->D0.")
Reviewed-by: Yan Zhao
Tested-by: Yongwei Ma
Reviewed-by: Zhi Wang
Link: https://lore.kernel.org/r/20230729013535.1070024-11-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 6d2357b2c8e84ac53e154536d6c80027eb1b8761
Author: Sean Christopherson
Date: Fri Jul 28 18:35:11 2023 -0700
drm/i915/gvt: Put the page reference obtained by KVM's gfn\_to\_pfn()
[ Upstream commit 708e49583d7da863898b25dafe4bcd799c414278 ]
Put the struct page reference acquired by gfn\_to\_pfn(), KVM's API is that
the caller is ultimately responsible for dropping any reference.
Note, kvm\_release\_pfn\_clean() ensures the pfn is actually a refcounted
struct page before trying to put any references.
Fixes: b901b252b6cf ("drm/i915/gvt: Add 2M huge gtt support")
Reviewed-by: Yan Zhao
Tested-by: Yongwei Ma
Reviewed-by: Zhi Wang
Link: https://lore.kernel.org/r/20230729013535.1070024-6-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit dcb7c713f0112dcfba8405379aa33a9f0c36f170
Author: Sean Christopherson
Date: Fri Jul 28 18:35:07 2023 -0700
drm/i915/gvt: Verify pfn is "valid" before dereferencing "struct page"
[ Upstream commit f046923af79158361295ed4f0a588c80b9fdcc1d ]
Check that the pfn found by gfn\_to\_pfn() is actually backed by "struct
page" memory prior to retrieving and dereferencing the page. KVM
supports backing guest memory with VM\_PFNMAP, VM\_IO, etc., and so
there is no guarantee the pfn returned by gfn\_to\_pfn() has an associated
"struct page".
Fixes: b901b252b6cf ("drm/i915/gvt: Add 2M huge gtt support")
Reviewed-by: Yan Zhao
Tested-by: Yongwei Ma
Reviewed-by: Zhi Wang
Link: https://lore.kernel.org/r/20230729013535.1070024-2-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 595931912357fa3507e522a7f8a0a76e423c23e4
Author: Magnus Karlsson
Date: Thu Aug 31 12:01:17 2023 +0200
xsk: Fix xsk\_diag use-after-free error during socket cleanup
[ Upstream commit 3e019d8a05a38abb5c85d4f1e85fda964610aa14 ]
Fix a use-after-free error that is possible if the xsk\_diag interface
is used after the socket has been unbound from the device. This can
happen either due to the socket being closed or the device
disappearing. In the early days of AF\_XDP, the way we tested that a
socket was not bound to a device was to simply check if the netdevice
pointer in the xsk socket structure was NULL. Later, a better system
was introduced by having an explicit state variable in the xsk socket
struct. For example, the state of a socket that is on the way to being
closed and has been unbound from the device is XSK\_UNBOUND.
The commit in the Fixes tag below deleted the old way of signalling
that a socket is unbound, setting dev to NULL. This in the belief that
all code using the old way had been exterminated. That was
unfortunately not true as the xsk diagnostics code was still using the
old way and thus does not work as intended when a socket is going
down. Fix this by introducing a test against the state variable. If
the socket is in the state XSK\_UNBOUND, simply abort the diagnostic's
netlink operation.
Fixes: 18b1ab7aa76b ("xsk: Fix race at socket teardown")
Reported-by: syzbot+822d1359297e2694f873@syzkaller.appspotmail.com
Signed-off-by: Magnus Karlsson
Signed-off-by: Daniel Borkmann
Tested-by: syzbot+822d1359297e2694f873@syzkaller.appspotmail.com
Tested-by: Maciej Fijalkowski
Reviewed-by: Maciej Fijalkowski
Link: https://lore.kernel.org/bpf/20230831100119.17408-1-magnus.karlsson@gmail.com
Signed-off-by: Sasha Levin
commit c2c13f83db659f0b9be9cfd4674eb308db9e0ee0
Author: Florian Westphal
Date: Wed Aug 30 13:00:37 2023 +0200
net: fib: avoid warn splat in flow dissector
[ Upstream commit 8aae7625ff3f0bd5484d01f1b8d5af82e44bec2d ]
New skbs allocated via nf\_send\_reset() have skb->dev == NULL.
fib\*\_rules\_early\_flow\_dissect helpers already have a 'struct net'
argument but its not passed down to the flow dissector core, which
will then WARN as it can't derive a net namespace to use:
WARNING: CPU: 0 PID: 0 at net/core/flow\_dissector.c:1016 \_\_skb\_flow\_dissect+0xa91/0x1cd0
[..]
ip\_route\_me\_harder+0x143/0x330
nf\_send\_reset+0x17c/0x2d0 [nf\_reject\_ipv4]
nft\_reject\_inet\_eval+0xa9/0xf2 [nft\_reject\_inet]
nft\_do\_chain+0x198/0x5d0 [nf\_tables]
nft\_do\_chain\_inet+0xa4/0x110 [nf\_tables]
nf\_hook\_slow+0x41/0xc0
ip\_local\_deliver+0xce/0x110
..
Cc: Stanislav Fomichev
Cc: David Ahern
Cc: Ido Schimmel
Fixes: 812fa71f0d96 ("netfilter: Dissect flow after packet mangling")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217826
Signed-off-by: Florian Westphal
Reviewed-by: Ido Schimmel
Reviewed-by: David Ahern
Link: https://lore.kernel.org/r/20230830110043.30497-1-fw@strlen.de
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit b1f5b890b89cb38a6c0bac91984d56cd69808e8c
Author: Eric Dumazet
Date: Wed Aug 30 10:12:44 2023 +0000
net: read sk->sk\_family once in sk\_mc\_loop()
[ Upstream commit a3e0fdf71bbe031de845e8e08ed7fba49f9c702c ]
syzbot is playing with IPV6\_ADDRFORM quite a lot these days,
and managed to hit the WARN\_ON\_ONCE(1) in sk\_mc\_loop()
We have many more similar issues to fix.
WARNING: CPU: 1 PID: 1593 at net/core/sock.c:782 sk\_mc\_loop+0x165/0x260
Modules linked in:
CPU: 1 PID: 1593 Comm: kworker/1:3 Not tainted 6.1.40-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/26/2023
Workqueue: events\_power\_efficient gc\_worker
RIP: 0010:sk\_mc\_loop+0x165/0x260 net/core/sock.c:782
Code: 34 1b fd 49 81 c7 18 05 00 00 4c 89 f8 48 c1 e8 03 42 80 3c 20 00 74 08 4c 89 ff e8 25 36 6d fd 4d 8b 37 eb 13 e8 db 33 1b fd <0f> 0b b3 01 eb 34 e8 d0 33 1b fd 45 31 f6 49 83 c6 38 4c 89 f0 48
RSP: 0018:ffffc90000388530 EFLAGS: 00010246
RAX: ffffffff846d9b55 RBX: 0000000000000011 RCX: ffff88814f884980
RDX: 0000000000000102 RSI: ffffffff87ae5160 RDI: 0000000000000011
RBP: ffffc90000388550 R08: 0000000000000003 R09: ffffffff846d9a65
R10: 0000000000000002 R11: ffff88814f884980 R12: dffffc0000000000
R13: ffff88810dbee000 R14: 0000000000000010 R15: ffff888150084000
FS: 0000000000000000(0000) GS:ffff8881f6b00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000180 CR3: 000000014ee5b000 CR4: 00000000003506e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
[] ip6\_finish\_output2+0x33f/0x1ae0 net/ipv6/ip6\_output.c:83
[] \_\_ip6\_finish\_output net/ipv6/ip6\_output.c:200 [inline]
[] ip6\_finish\_output+0x6c6/0xb10 net/ipv6/ip6\_output.c:211
[] NF\_HOOK\_COND include/linux/netfilter.h:298 [inline]
[] ip6\_output+0x2bc/0x3d0 net/ipv6/ip6\_output.c:232
[] dst\_output include/net/dst.h:444 [inline]
[] ip6\_local\_out+0x10f/0x140 net/ipv6/output\_core.c:161
[] ipvlan\_process\_v6\_outbound drivers/net/ipvlan/ipvlan\_core.c:483 [inline]
[] ipvlan\_process\_outbound drivers/net/ipvlan/ipvlan\_core.c:529 [inline]
[] ipvlan\_xmit\_mode\_l3 drivers/net/ipvlan/ipvlan\_core.c:602 [inline]
[] ipvlan\_queue\_xmit+0x1174/0x1be0 drivers/net/ipvlan/ipvlan\_core.c:677
[] ipvlan\_start\_xmit+0x49/0x100 drivers/net/ipvlan/ipvlan\_main.c:229
[] netdev\_start\_xmit include/linux/netdevice.h:4925 [inline]
[] xmit\_one net/core/dev.c:3644 [inline]
[] dev\_hard\_start\_xmit+0x320/0x980 net/core/dev.c:3660
[] sch\_direct\_xmit+0x2a0/0x9c0 net/sched/sch\_generic.c:342
[] qdisc\_restart net/sched/sch\_generic.c:407 [inline]
[] \_\_qdisc\_run+0xb13/0x1e70 net/sched/sch\_generic.c:415
[] qdisc\_run+0xd6/0x260 include/net/pkt\_sched.h:125
[] net\_tx\_action+0x7ac/0x940 net/core/dev.c:5247
[] \_\_do\_softirq+0x2bd/0x9bd kernel/softirq.c:599
[] invoke\_softirq kernel/softirq.c:430 [inline]
[] \_\_irq\_exit\_rcu+0xc8/0x170 kernel/softirq.c:683
[] irq\_exit\_rcu+0x9/0x20 kernel/softirq.c:695
Fixes: 7ad6848c7e81 ("ip: fix mc\_loop checks for tunnels with multicast outer addresses")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Reviewed-by: Kuniyuki Iwashima
Link: https://lore.kernel.org/r/20230830101244.1146934-1-edumazet@google.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit a558ff4ae5238d19cba11677614b78b859ed8c7c
Author: Eric Dumazet
Date: Wed Aug 30 09:55:20 2023 +0000
ipv4: annotate data-races around fi->fib\_dead
[ Upstream commit fce92af1c29d90184dfec638b5738831097d66e9 ]
syzbot complained about a data-race in fib\_table\_lookup() [1]
Add appropriate annotations to document it.
[1]
BUG: KCSAN: data-race in fib\_release\_info / fib\_table\_lookup
write to 0xffff888150f31744 of 1 bytes by task 1189 on cpu 0:
fib\_release\_info+0x3a0/0x460 net/ipv4/fib\_semantics.c:281
fib\_table\_delete+0x8d2/0x900 net/ipv4/fib\_trie.c:1777
fib\_magic+0x1c1/0x1f0 net/ipv4/fib\_frontend.c:1106
fib\_del\_ifaddr+0x8cf/0xa60 net/ipv4/fib\_frontend.c:1317
fib\_inetaddr\_event+0x77/0x200 net/ipv4/fib\_frontend.c:1448
notifier\_call\_chain kernel/notifier.c:93 [inline]
blocking\_notifier\_call\_chain+0x90/0x200 kernel/notifier.c:388
\_\_inet\_del\_ifa+0x4df/0x800 net/ipv4/devinet.c:432
inet\_del\_ifa net/ipv4/devinet.c:469 [inline]
inetdev\_destroy net/ipv4/devinet.c:322 [inline]
inetdev\_event+0x553/0xaf0 net/ipv4/devinet.c:1606
notifier\_call\_chain kernel/notifier.c:93 [inline]
raw\_notifier\_call\_chain+0x6b/0x1c0 kernel/notifier.c:461
call\_netdevice\_notifiers\_info net/core/dev.c:1962 [inline]
call\_netdevice\_notifiers\_mtu+0xd2/0x130 net/core/dev.c:2037
dev\_set\_mtu\_ext+0x30b/0x3e0 net/core/dev.c:8673
do\_setlink+0x5be/0x2430 net/core/rtnetlink.c:2837
rtnl\_setlink+0x255/0x300 net/core/rtnetlink.c:3177
rtnetlink\_rcv\_msg+0x807/0x8c0 net/core/rtnetlink.c:6445
netlink\_rcv\_skb+0x126/0x220 net/netlink/af\_netlink.c:2549
rtnetlink\_rcv+0x1c/0x20 net/core/rtnetlink.c:6463
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1339 [inline]
netlink\_unicast+0x56f/0x640 net/netlink/af\_netlink.c:1365
netlink\_sendmsg+0x665/0x770 net/netlink/af\_netlink.c:1914
sock\_sendmsg\_nosec net/socket.c:725 [inline]
sock\_sendmsg net/socket.c:748 [inline]
sock\_write\_iter+0x1aa/0x230 net/socket.c:1129
do\_iter\_write+0x4b4/0x7b0 fs/read\_write.c:860
vfs\_writev+0x1a8/0x320 fs/read\_write.c:933
do\_writev+0xf8/0x220 fs/read\_write.c:976
\_\_do\_sys\_writev fs/read\_write.c:1049 [inline]
\_\_se\_sys\_writev fs/read\_write.c:1046 [inline]
\_\_x64\_sys\_writev+0x45/0x50 fs/read\_write.c:1046
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
read to 0xffff888150f31744 of 1 bytes by task 21839 on cpu 1:
fib\_table\_lookup+0x2bf/0xd50 net/ipv4/fib\_trie.c:1585
fib\_lookup include/net/ip\_fib.h:383 [inline]
ip\_route\_output\_key\_hash\_rcu+0x38c/0x12c0 net/ipv4/route.c:2751
ip\_route\_output\_key\_hash net/ipv4/route.c:2641 [inline]
\_\_ip\_route\_output\_key include/net/route.h:134 [inline]
ip\_route\_output\_flow+0xa6/0x150 net/ipv4/route.c:2869
send4+0x1e7/0x500 drivers/net/wireguard/socket.c:61
wg\_socket\_send\_skb\_to\_peer+0x94/0x130 drivers/net/wireguard/socket.c:175
wg\_socket\_send\_buffer\_to\_peer+0xd6/0x100 drivers/net/wireguard/socket.c:200
wg\_packet\_send\_handshake\_initiation drivers/net/wireguard/send.c:40 [inline]
wg\_packet\_handshake\_send\_worker+0x10c/0x150 drivers/net/wireguard/send.c:51
process\_one\_work+0x434/0x860 kernel/workqueue.c:2600
worker\_thread+0x5f2/0xa10 kernel/workqueue.c:2751
kthread+0x1d7/0x210 kernel/kthread.c:389
ret\_from\_fork+0x2e/0x40 arch/x86/kernel/process.c:145
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304
value changed: 0x00 -> 0x01
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 21839 Comm: kworker/u4:18 Tainted: G W 6.5.0-syzkaller #0
Fixes: dccd9ecc3744 ("ipv4: Do not use dead fib\_info entries.")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Reviewed-by: David Ahern
Link: https://lore.kernel.org/r/20230830095520.1046984-1-edumazet@google.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 59dcfbcc51512583a734525c4989f49f5044dc33
Author: Eric Dumazet
Date: Wed Aug 30 09:45:19 2023 +0000
sctp: annotate data-races around sk->sk\_wmem\_queued
[ Upstream commit dc9511dd6f37fe803f6b15b61b030728d7057417 ]
sk->sk\_wmem\_queued can be read locklessly from sctp\_poll()
Use sk\_wmem\_queued\_add() when the field is changed,
and add READ\_ONCE() annotations in sctp\_writeable()
and sctp\_assocs\_seq\_show()
syzbot reported:
BUG: KCSAN: data-race in sctp\_poll / sctp\_wfree
read-write to 0xffff888149d77810 of 4 bytes by interrupt on cpu 0:
sctp\_wfree+0x170/0x4a0 net/sctp/socket.c:9147
skb\_release\_head\_state+0xb7/0x1a0 net/core/skbuff.c:988
skb\_release\_all net/core/skbuff.c:1000 [inline]
\_\_kfree\_skb+0x16/0x140 net/core/skbuff.c:1016
consume\_skb+0x57/0x180 net/core/skbuff.c:1232
sctp\_chunk\_destroy net/sctp/sm\_make\_chunk.c:1503 [inline]
sctp\_chunk\_put+0xcd/0x130 net/sctp/sm\_make\_chunk.c:1530
sctp\_datamsg\_put+0x29a/0x300 net/sctp/chunk.c:128
sctp\_chunk\_free+0x34/0x50 net/sctp/sm\_make\_chunk.c:1515
sctp\_outq\_sack+0xafa/0xd70 net/sctp/outqueue.c:1381
sctp\_cmd\_process\_sack net/sctp/sm\_sideeffect.c:834 [inline]
sctp\_cmd\_interpreter net/sctp/sm\_sideeffect.c:1366 [inline]
sctp\_side\_effects net/sctp/sm\_sideeffect.c:1198 [inline]
sctp\_do\_sm+0x12c7/0x31b0 net/sctp/sm\_sideeffect.c:1169
sctp\_assoc\_bh\_rcv+0x2b2/0x430 net/sctp/associola.c:1051
sctp\_inq\_push+0x108/0x120 net/sctp/inqueue.c:80
sctp\_rcv+0x116e/0x1340 net/sctp/input.c:243
sctp6\_rcv+0x25/0x40 net/sctp/ipv6.c:1120
ip6\_protocol\_deliver\_rcu+0x92f/0xf30 net/ipv6/ip6\_input.c:437
ip6\_input\_finish net/ipv6/ip6\_input.c:482 [inline]
NF\_HOOK include/linux/netfilter.h:303 [inline]
ip6\_input+0xbd/0x1b0 net/ipv6/ip6\_input.c:491
dst\_input include/net/dst.h:468 [inline]
ip6\_rcv\_finish+0x1e2/0x2e0 net/ipv6/ip6\_input.c:79
NF\_HOOK include/linux/netfilter.h:303 [inline]
ipv6\_rcv+0x74/0x150 net/ipv6/ip6\_input.c:309
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5452 [inline]
\_\_netif\_receive\_skb+0x90/0x1b0 net/core/dev.c:5566
process\_backlog+0x21f/0x380 net/core/dev.c:5894
\_\_napi\_poll+0x60/0x3b0 net/core/dev.c:6460
napi\_poll net/core/dev.c:6527 [inline]
net\_rx\_action+0x32b/0x750 net/core/dev.c:6660
\_\_do\_softirq+0xc1/0x265 kernel/softirq.c:553
run\_ksoftirqd+0x17/0x20 kernel/softirq.c:921
smpboot\_thread\_fn+0x30a/0x4a0 kernel/smpboot.c:164
kthread+0x1d7/0x210 kernel/kthread.c:389
ret\_from\_fork+0x2e/0x40 arch/x86/kernel/process.c:145
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304
read to 0xffff888149d77810 of 4 bytes by task 17828 on cpu 1:
sctp\_writeable net/sctp/socket.c:9304 [inline]
sctp\_poll+0x265/0x410 net/sctp/socket.c:8671
sock\_poll+0x253/0x270 net/socket.c:1374
vfs\_poll include/linux/poll.h:88 [inline]
do\_pollfd fs/select.c:873 [inline]
do\_poll fs/select.c:921 [inline]
do\_sys\_poll+0x636/0xc00 fs/select.c:1015
\_\_do\_sys\_ppoll fs/select.c:1121 [inline]
\_\_se\_sys\_ppoll+0x1af/0x1f0 fs/select.c:1101
\_\_x64\_sys\_ppoll+0x67/0x80 fs/select.c:1101
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x00019e80 -> 0x0000cc80
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 17828 Comm: syz-executor.1 Not tainted 6.5.0-rc7-syzkaller-00185-g28f20a19294d #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/26/2023
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Cc: Marcelo Ricardo Leitner
Acked-by: Xin Long
Link: https://lore.kernel.org/r/20230830094519.950007-1-edumazet@google.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit e093000e7d13569c9cb07d7500acd5142c3c43cb
Author: Eric Dumazet
Date: Tue Aug 29 12:35:41 2023 +0000
net/sched: fq\_pie: avoid stalls in fq\_pie\_timer()
[ Upstream commit 8c21ab1bae945686c602c5bfa4e3f3352c2452c5 ]
When setting a high number of flows (limit being 65536),
fq\_pie\_timer() is currently using too much time as syzbot reported.
Add logic to yield the cpu every 2048 flows (less than 150 usec
on debug kernels).
It should also help by not blocking qdisc fast paths for too long.
Worst case (65536 flows) would need 31 jiffies for a complete scan.
Relevant extract from syzbot report:
rcu: INFO: rcu\_preempt detected expedited stalls on CPUs/tasks: { 0-.... } 2663 jiffies s: 873 root: 0x1/.
rcu: blocking rcu\_node structures (internal RCU debug):
Sending NMI from CPU 1 to CPUs 0:
NMI backtrace for cpu 0
CPU: 0 PID: 5177 Comm: syz-executor273 Not tainted 6.5.0-syzkaller-00453-g727dbda16b83 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/26/2023
RIP: 0010:check\_kcov\_mode kernel/kcov.c:173 [inline]
RIP: 0010:write\_comp\_data+0x21/0x90 kernel/kcov.c:236
Code: 2e 0f 1f 84 00 00 00 00 00 65 8b 05 01 b2 7d 7e 49 89 f1 89 c6 49 89 d2 81 e6 00 01 00 00 49 89 f8 65 48 8b 14 25 80 b9 03 00  00 01 ff 00 74 0e 85 f6 74 59 8b 82 04 16 00 00 85 c0 74 4f 8b
RSP: 0018:ffffc90000007bb8 EFLAGS: 00000206
RAX: 0000000000000101 RBX: ffffc9000dc0d140 RCX: ffffffff885893b0
RDX: ffff88807c075940 RSI: 0000000000000100 RDI: 0000000000000001
RBP: 0000000000000000 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000000 R12: ffffc9000dc0d178
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
FS: 0000555555d54380(0000) GS:ffff8880b9800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f6b442f6130 CR3: 000000006fe1c000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:

pie\_calculate\_probability+0x480/0x850 net/sched/sch\_pie.c:415
fq\_pie\_timer+0x1da/0x4f0 net/sched/sch\_fq\_pie.c:387
call\_timer\_fn+0x1a0/0x580 kernel/time/timer.c:1700
Fixes: ec97ecf1ebe4 ("net: sched: add Flow Queue PIE packet scheduler")
Link: https://lore.kernel.org/lkml/00000000000017ad3f06040bf394@google.com/
Reported-by: syzbot+e46fbd5289363464bc13@syzkaller.appspotmail.com
Signed-off-by: Eric Dumazet
Reviewed-by: Michal Kubiak
Reviewed-by: Jamal Hadi Salim
Link: https://lore.kernel.org/r/20230829123541.3745013-1-edumazet@google.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit cdbb5e973faa4b6cc3e7f0c26ad893207880301f
Author: Katya Orlova
Date: Tue Aug 15 16:38:31 2023 +0300
smb: propagate error code of extract\_sharename()
[ Upstream commit efc0b0bcffcba60d9c6301063d25a22a4744b499 ]
In addition to the EINVAL, there may be an ENOMEM.
Found by Linux Verification Center (linuxtesting.org) with SVACE.
Fixes: 70431bfd825d ("cifs: Support fscache indexing rewrite")
Signed-off-by: Katya Orlova
Signed-off-by: Steve French
Signed-off-by: Sasha Levin
commit 7f56ae02d97421814ce5ab473c3932185da2d603
Author: Phil Sutter
Date: Tue Aug 29 19:51:58 2023 +0200
netfilter: nf\_tables: Audit log rule reset
[ Upstream commit ea078ae9108e25fc881c84369f7c03931d22e555 ]
Resetting rules' stateful data happens outside of the transaction logic,
so 'get' and 'dump' handlers have to emit audit log entries themselves.
Fixes: 8daa8fde3fc3f ("netfilter: nf\_tables: Introduce NFT\_MSG\_GETRULE\_RESET")
Signed-off-by: Phil Sutter
Reviewed-by: Richard Guy Briggs
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 51d68d752995a98408b84acea84b0013917536d3
Author: Phil Sutter
Date: Tue Aug 29 19:51:57 2023 +0200
netfilter: nf\_tables: Audit log setelem reset
[ Upstream commit 7e9be1124dbe7888907e82cab20164578e3f9ab7 ]
Since set element reset is not integrated into nf\_tables' transaction
logic, an explicit log call is needed, similar to NFT\_MSG\_GETOBJ\_RESET
handling.
For the sake of simplicity, catchall element reset will always generate
a dedicated log entry. This relieves nf\_tables\_dump\_set() from having to
adjust the logged element count depending on whether a catchall element
was found or not.
Fixes: 079cd633219d7 ("netfilter: nf\_tables: Introduce NFT\_MSG\_GETSETELEM\_RESET")
Signed-off-by: Phil Sutter
Reviewed-by: Richard Guy Briggs
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 8950b63645033a1745005365db6cc2f964a4d70e
Author: Yu Kuai
Date: Wed Aug 16 09:27:08 2023 +0800
blk-throttle: consider 'carryover\_ios/bytes' in throtl\_trim\_slice()
[ Upstream commit eead0056648cef49d7b15c07ae612fa217083165 ]
Currently, 'carryover\_ios/bytes' is not handled in throtl\_trim\_slice(),
for consequence, 'carryover\_ios/bytes' will be used to throttle bio
multiple times, for example:
1) set iops limit to 100, and slice start is 0, slice end is 100ms;
2) current time is 0, and 10 ios are dispatched, those io won't be
throttled and io\_disp is 10;
3) still at current time 0, update iops limit to 1000, carryover\_ios is
updated to (0 - 10) = -10;
4) in this slice(0 - 100ms), io\_allowed = 100 + (-10) = 90, which means
only 90 ios can be dispatched without waiting;
5) assume that io is throttled in slice(0 - 100ms), and
throtl\_trim\_slice() update silce to (100ms - 200ms). In this case,
'carryover\_ios/bytes' is not cleared and still only 90 ios can be
dispatched between 100ms - 200ms.
Fix this problem by updating 'carryover\_ios/bytes' in
throtl\_trim\_slice().
Fixes: a880ae93e5b5 ("blk-throttle: fix io hung due to configuration updates")
Reported-by: zhuxiaohui
Link: https://lore.kernel.org/all/20230812072116.42321-1-zhuxiaohui.400@bytedance.com/
Signed-off-by: Yu Kuai
Acked-by: Tejun Heo
Link: https://lore.kernel.org/r/20230816012708.1193747-5-yukuai1@huaweicloud.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 3e76e05e3bdb0eba098dd211eda961aec64c1b47
Author: Yu Kuai
Date: Wed Aug 16 09:27:07 2023 +0800
blk-throttle: use calculate\_io/bytes\_allowed() for throtl\_trim\_slice()
[ Upstream commit e8368b57c006dc0e02dcd8a9dc9f2060ff5476fe ]
There are no functional changes, just make the code cleaner.
Signed-off-by: Yu Kuai
Acked-by: Tejun Heo
Link: https://lore.kernel.org/r/20230816012708.1193747-4-yukuai1@huaweicloud.com
Signed-off-by: Jens Axboe
Stable-dep-of: eead0056648c ("blk-throttle: consider 'carryover\_ios/bytes' in throtl\_trim\_slice()")
Signed-off-by: Sasha Levin
commit 7fb464d52fa41c31a6fd1ad82888e67c65935d94
Author: Andrzej Hajda
Date: Mon Aug 21 17:30:35 2023 +0200
drm/i915: mark requests for GuC virtual engines to avoid use-after-free
[ Upstream commit 5eefc5307c983b59344a4cb89009819f580c84fa ]
References to i915\_requests may be trapped by userspace inside a
sync\_file or dmabuf (dma-resv) and held indefinitely across different
proceses. To counter-act the memory leaks, we try to not to keep
references from the request past their completion.
On the other side on fence release we need to know if rq->engine
is valid and points to hw engine (true for non-virtual requests).
To make it possible extra bit has been added to rq->execution\_mask,
for marking virtual engines.
Fixes: bcb9aa45d5a0 ("Revert "drm/i915: Hold reference to intel\_context over life of i915\_request"")
Signed-off-by: Chris Wilson
Signed-off-by: Andrzej Hajda
Reviewed-by: Andi Shyti
Signed-off-by: Andi Shyti
Link: https://patchwork.freedesktop.org/patch/msgid/20230821153035.3903006-1-andrzej.hajda@intel.com
(cherry picked from commit 280410677af763f3871b93e794a199cfcf6fb580)
Signed-off-by: Rodrigo Vivi
Signed-off-by: Sasha Levin
commit 33da1bcbfa9fcc10de49f6f9ce4488630dc1d121
Author: Yonghong Song
Date: Sun Aug 27 08:05:51 2023 -0700
selftests/bpf: Fix flaky cgroup\_iter\_sleepable subtest
[ Upstream commit 5439cfa7fe612e7d02d5a1234feda3fa6e483ba7 ]
Occasionally, with './test\_progs -j' on my vm, I will hit the
following failure:
test\_cgrp\_local\_storage:PASS:join\_cgroup /cgrp\_local\_storage 0 nsec
test\_cgroup\_iter\_sleepable:PASS:skel\_open 0 nsec
test\_cgroup\_iter\_sleepable:PASS:skel\_load 0 nsec
test\_cgroup\_iter\_sleepable:PASS:attach\_iter 0 nsec
test\_cgroup\_iter\_sleepable:PASS:iter\_create 0 nsec
test\_cgroup\_iter\_sleepable:FAIL:cgroup\_id unexpected cgroup\_id: actual 1 != expected 2812
#48/5 cgrp\_local\_storage/cgroup\_iter\_sleepable:FAIL
#48 cgrp\_local\_storage:FAIL
Finally, I decided to do some investigation since the test is introduced
by myself. It turns out the reason is due to cgroup\_fd with value 0.
In cgroup\_iter, a cgroup\_fd of value 0 means the root cgroup.
/\* from cgroup\_iter.c \*/
if (fd)
cgrp = cgroup\_v1v2\_get\_from\_fd(fd);
else if (id)
cgrp = cgroup\_get\_from\_id(id);
else /\* walk the entire hierarchy by default. \*/
cgrp = cgroup\_get\_from\_path("/");
That is why we got cgroup\_id 1 instead of expected 2812.
Why we got a cgroup\_fd 0? Nobody should really touch 'stdin' (fd 0) in
test\_progs. I traced 'close' syscall with stack trace and found the root
cause, which is a bug in bpf\_obj\_pinning.c. Basically, the code closed
fd 0 although it should not. Fixing the bug in bpf\_obj\_pinning.c also
resolved the above cgroup\_iter\_sleepable subtest failure.
Fixes: 3b22f98e5a05 ("selftests/bpf: Add path\_fd-based BPF\_OBJ\_PIN and BPF\_OBJ\_GET tests")
Signed-off-by: Yonghong Song
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20230827150551.1743497-1-yonghong.song@linux.dev
Signed-off-by: Sasha Levin
commit 2d2b4d003a167d13bb5d7f4f418337108726ed2e
Author: Vincent Whitchurch
Date: Tue Aug 29 16:04:12 2023 +0200
regulator: tps6287x: Fix n\_voltages
[ Upstream commit c69290557c7571dff3d995fa27619b965915e8a1 ]
There are 256 possible voltage settings for each range, not 256 possible
voltage settings in total.
Fixes: 15a1cd245d5b ("regulator: tps6287x: Fix missing .n\_voltages setting")
Signed-off-by: Vincent Whitchurch
commit a3f87e6f331d28af27c9a7a9aff32645c9bcccdc
Author: Namhyung Kim
Date: Fri Aug 25 09:41:52 2023 -0700
perf test stat\_bpf\_counters\_cgrp: Enhance perf stat cgroup BPF counter test
[ Upstream commit a84260e314029e6dc9904fd6eabf8d9fd7965351 ]
It has system-wide test and cpu-list test but the cpu-list test fails
sometimes. It runs sleep command on CPU1 and measure both user.slice
and system.slice cgroups by default (on systemd-based systems).
But if the system was idle enough, sometime the system.slice gets no
count and it makes the test failing. Maybe that's because it only looks
at the CPU1, let's add CPU0 to increase the chance it finds some tasks.
Fixes: 7901086014bbaa3a ("perf test: Add a new test for perf stat cgroup BPF counter")
Reported-by: Arnaldo Carvalho de Melo
Signed-off-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: bpf@vger.kernel.org
Link: https://lore.kernel.org/r/20230825164152.165610-3-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit fe8b6e5994108d773df953d62945eb67908c8051
Author: Kajol Jain
Date: Sun Jul 9 23:57:39 2023 +0530
perf test stat\_bpf\_counters\_cgrp: Fix shellcheck issue about logical operators
[ Upstream commit 0dd1f815545d7210150642741c364521cc5cf116 ]
Running shellcheck on lock\_contention.sh generates below warning:
In stat\_bpf\_counters\_cgrp.sh line 28:
if [ -d /sys/fs/cgroup/system.slice -a -d /sys/fs/cgroup/user.slice ]; then
^-- SC2166 (warning): Prefer [ p ] && [ q ] as [ p -a q ] is not well defined.
In stat\_bpf\_counters\_cgrp.sh line 34:
local self\_cgrp=$(grep perf\_event /proc/self/cgroup | cut -d: -f3)
^-------------^ SC3043 (warning): In POSIX sh, 'local' is undefined.
^-------^ SC2155 (warning): Declare and assign separately to avoid masking return values.
^-- SC2046 (warning): Quote this to prevent word splitting.
In stat\_bpf\_counters\_cgrp.sh line 51:
local output
^----------^ SC3043 (warning): In POSIX sh, 'local' is undefined.
In stat\_bpf\_counters\_cgrp.sh line 65:
local output
^----------^ SC3043 (warning): In POSIX sh, 'local' is undefined.
Fixed above warnings by:
- Changing the expression [p -a q] to [p] && [q].
- Fixing shellcheck warnings for local usage, by prefixing
function name to the variable.
Signed-off-by: Kajol Jain
Acked-by: Ian Rogers
Cc: Disha Goel
Cc: Jiri Olsa
Cc: Madhavan Srinivasan
Cc: Namhyung Kim
Cc: linuxppc-dev@lists.ozlabs.org
Link: https://lore.kernel.org/r/20230709182800.53002-6-atrajeev@linux.vnet.ibm.com
Signed-off-by: Athira Rajeev
Signed-off-by: Arnaldo Carvalho de Melo
Stable-dep-of: a84260e31402 ("perf test stat\_bpf\_counters\_cgrp: Enhance perf stat cgroup BPF counter test")
Signed-off-by: Sasha Levin
commit d1fb133ca6d95a07f91674efcfa2ce4ca2ac88a7
Author: Miquel Raynal
Date: Thu Aug 17 12:18:53 2023 +0200
i3c: master: svc: Describe member 'saved\_regs'
[ Upstream commit 5496eac6ad7428fa06811a8c34b3a15beb93b86d ]
The 'saved\_regs' member of the 'svc\_i3c\_master' structure is not
described in the kernel doc, which produces the following warning:
Function parameter or member 'saved\_regs' not described in 'svc\_i3c\_master'
Add the missing line in the kernel documentation of the parent
structure.
Fixes: 1c5ee2a77b1b ("i3c: master: svc: fix i3c suspend/resume issue")
Reported-by: kernel test robot
Closes: https://lore.kernel.org/oe-kbuild-all/202308171435.0xQ82lvu-lkp@intel.com/
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/r/20230817101853.16805-1-miquel.raynal@bootlin.com
Signed-off-by: Alexandre Belloni
Signed-off-by: Sasha Levin
commit 4e387cd28631721829eab19a4d9cb4b6fe49c63c
Author: Ian Rogers
Date: Thu Aug 24 19:39:57 2023 -0700
perf header: Fix missing PMU caps
[ Upstream commit 9897009eecae821efc684ecdd1d04584f5501509 ]
PMU caps are written as HEADER\_PMU\_CAPS or for the special case of the
PMU "cpu" as HEADER\_CPU\_PMU\_CAPS. As the PMU "cpu" is special, and not
any "core" PMU, the logic had become broken and core PMUs not called
"cpu" were not having their caps written.
This affects ARM and s390 non-hybrid PMUs.
Simplify the PMU caps writing logic to scan one fewer time and to be
more explicit in its behavior.
Fixes: 178ddf3bad981380 ("perf header: Avoid hybrid PMU list in write\_pmu\_caps")
Reported-by: Wei Li
Signed-off-by: Ian Rogers
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Athira Rajeev
Cc: Huacai Chen
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: James Clark
Cc: Jiri Olsa
Cc: John Garry
Cc: K Prateek Nayak
Cc: Kajol Jain
Cc: Kan Liang
Cc: Leo Yan
Cc: Mark Rutland
Cc: Mike Leach
Cc: Ming Wang
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Ravi Bangoria
Cc: Sean Christopherson
Cc: Suzuki Poulouse
Cc: Will Deacon
Cc: linux-arm-kernel@lists.infradead.org
Link: https://lore.kernel.org/r/20230825024002.801955-2-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 4f314ab4a5e78b6c5853c2633d15dc58e9323a88
Author: Justin Stitt
Date: Thu Aug 24 21:20:25 2023 +0000
accel/ivpu: refactor deprecated strncpy
[ Upstream commit 4b2fd81f2af7147e844ecec0c5c07a16bca6b86e ]
`strncpy` is deprecated for use on NUL-terminated destination strings [1].
A suitable replacement is `strscpy` [2] due to the fact that it
guarantees NUL-termination on its destination buffer argument which is
\_not\_ the case for `strncpy`!
Also remove extraneous if-statement as it can never be entered. The
return value from `strncpy` is it's first argument. In this case,
`...dyndbg\_cmd` is an array:
| char dyndbg\_cmd[VPU\_DYNDBG\_CMD\_MAX\_LEN];
^^^^^^^^^^
This can never be NULL which means `strncpy`'s return value cannot be
NULL here. Just use `strscpy` which is more robust and results in
simpler and less ambiguous code.
Moreover, remove needless `... - 1` as `strscpy`'s implementation
ensures NUL-termination and we do not need to carefully dance around
ending boundaries with a "- 1" anymore.
Fixes: 5d7422cfb498 ("accel/ivpu: Add IPC driver and JSM messages")
Link: www.kernel.org/doc/html/latest/process/deprecated.html#strncpy-on-nul-terminated-strings [1]
Link: https://manpages.debian.org/testing/linux-manual-4.8/strscpy.9.en.html [2]
Link: https://github.com/KSPP/linux/issues/90
Cc: linux-hardening@vger.kernel.org
Signed-off-by: Justin Stitt
Reviewed-by: Stanislaw Gruszka
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230824-strncpy-drivers-accel-ivpu-ivpu\_jsm\_msg-c-v1-1-12d9b52d2dff@google.com
Signed-off-by: Sasha Levin
commit e3a0ddbaf7f1f9ffc070718b417461ced3268758
Author: Vladimir Zapolskiy
Date: Mon Jul 17 17:52:57 2023 +0200
pwm: lpc32xx: Remove handling of PWM channels
[ Upstream commit 4aae44f65827f0213a7361cf9c32cfe06114473f ]
Because LPC32xx PWM controllers have only a single output which is
registered as the only PWM device/channel per controller, it is known in
advance that pwm->hwpwm value is always 0. On basis of this fact
simplify the code by removing operations with pwm->hwpwm, there is no
controls which require channel number as input.
Even though I wasn't aware at the time when I forward ported that patch,
this fixes a null pointer dereference as lpc32xx->chip.pwms is NULL
before devm\_pwmchip\_add() is called.
Reported-by: Dan Carpenter
Signed-off-by: Vladimir Zapolskiy
Signed-off-by: Uwe Kleine-König
Fixes: 3d2813fb17e5 ("pwm: lpc32xx: Don't modify HW state in .probe() after the PWM chip was registered")
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
commit f11ccbdb9e1693006e6dcf188b1998823e6bbb3f
Author: Ilkka Koskinen
Date: Thu Aug 3 14:13:28 2023 -0700
perf vendor events arm64: Remove L1D\_CACHE\_LMISS from AmpereOne list
[ Upstream commit b8af10062df3c23fe002c3f187389bb263b3eb20 ]
amperene/cache.json file tried to include L1D\_CACHE\_LMISS while it
doesn't exist in common-and-microarch.json. While this bug doesn't seem to
cause issue in newer kernels with jevents.py script, it prevents building
older perf tools with the backported patch.
Fixes: a9650b7f6fc09d16 ("perf vendor events arm64: Add AmpereOne core PMU events")
Reported-by: Dave Kleikamp
Reviewed-by: Ian Rogers
Reviewed-by: John Garry
Signed-off-by: Ilkka Koskinen
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Ilkka Koskinen
Cc: Ingo Molnar
Cc: James Clark
Cc: Jiri Olsa
Cc: Leo Yan
Cc: Mark Rutland
Cc: Mike Leach
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Will Deacon
Cc: linux-arm-kernel@lists.infradead.org
Closes: https://lore.kernel.org/all/76bb2e47-ce44-76ae-838e-53279047084d@oracle.com/
Link: https://lore.kernel.org/r/20230803211331.140553-2-ilkka@os.amperecomputing.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 1edc8ab3dd8fe650700fe89d72f15897b6b7e7ab
Author: Raag Jadav
Date: Fri Aug 11 17:32:20 2023 +0530
watchdog: intel-mid\_wdt: add MODULE\_ALIAS() to allow auto-load
[ Upstream commit cf38e7691c85f1b09973b22a0b89bf1e1228d2f9 ]
When built with CONFIG\_INTEL\_MID\_WATCHDOG=m, currently the driver
needs to be loaded manually, for the lack of module alias.
This causes unintended resets in cases where watchdog timer is
set-up by bootloader and the driver is not explicitly loaded.
Add MODULE\_ALIAS() to load the driver automatically at boot and
avoid this issue.
Fixes: 87a1ef8058d9 ("watchdog: add Intel MID watchdog driver support")
Signed-off-by: Raag Jadav
Reviewed-by: Andy Shevchenko
Reviewed-by: Guenter Roeck
Link: https://lore.kernel.org/r/20230811120220.31578-1-raag.jadav@intel.com
Signed-off-by: Guenter Roeck
Signed-off-by: Wim Van Sebroeck
Signed-off-by: Sasha Levin
commit b12265092d33429d80ed07d93b50d02b4a6c2b02
Author: Arnaldo Carvalho de Melo
Date: Thu Aug 17 09:11:21 2023 -0300
perf lock: Don't pass an ERR\_PTR() directly to perf\_session\_\_delete()
[ Upstream commit abaf1e0355abb050f9c11d2d13a513caec80f7ad ]
While debugging a segfault on 'perf lock contention' without an
available perf.data file I noticed that it was basically calling:
perf\_session\_\_delete(ERR\_PTR(-1))
Resulting in:
(gdb) run lock contention
Starting program: /root/bin/perf lock contention
[Thread debugging using libthread\_db enabled]
Using host libthread\_db library "/lib64/libthread\_db.so.1".
failed to open perf.data: No such file or directory (try 'perf record' first)
Initializing perf session failed
Program received signal SIGSEGV, Segmentation fault.
0x00000000005e7515 in auxtrace\_\_free (session=0xffffffffffffffff) at util/auxtrace.c:2858
2858 if (!session->auxtrace)
(gdb) p session
$1 = (struct perf\_session \*) 0xffffffffffffffff
(gdb) bt
#0 0x00000000005e7515 in auxtrace\_\_free (session=0xffffffffffffffff) at util/auxtrace.c:2858
#1 0x000000000057bb4d in perf\_session\_\_delete (session=0xffffffffffffffff) at util/session.c:300
#2 0x000000000047c421 in \_\_cmd\_contention (argc=0, argv=0x7fffffffe200) at builtin-lock.c:2161
#3 0x000000000047dc95 in cmd\_lock (argc=0, argv=0x7fffffffe200) at builtin-lock.c:2604
#4 0x0000000000501466 in run\_builtin (p=0xe597a8 , argc=2, argv=0x7fffffffe200) at perf.c:322
#5 0x00000000005016d5 in handle\_internal\_command (argc=2, argv=0x7fffffffe200) at perf.c:375
#6 0x0000000000501824 in run\_argv (argcp=0x7fffffffe02c, argv=0x7fffffffe020) at perf.c:419
#7 0x0000000000501b11 in main (argc=2, argv=0x7fffffffe200) at perf.c:535
(gdb)
So just set it to NULL after using PTR\_ERR(session) to decode the error
as perf\_session\_\_delete(NULL) is supported.
Fixes: eef4fee5e52071d5 ("perf lock: Dynamically allocate lockhash\_table")
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Andi Kleen
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: K Prateek Nayak
Cc: Kan Liang
Cc: Leo Yan
Cc: Mamatha Inamdar
Cc: Mark Rutland
Cc: Masami Hiramatsu
Cc: Namhyung Kim
Cc: Paolo Bonzini
Cc: Peter Zijlstra
Cc: Ravi Bangoria
Cc: Ross Zwisler
Cc: Sean Christopherson
Cc: Steven Rostedt (VMware)
Cc: Tiezhu Yang
Cc: Yang Jihong
Link: https://lore.kernel.org/lkml/ZN4R1AYfsD2J8lRs@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 6b66e3a098bb35cd9fba146720806bbf2b361e74
Author: Arnaldo Carvalho de Melo
Date: Thu Aug 17 09:11:21 2023 -0300
perf top: Don't pass an ERR\_PTR() directly to perf\_session\_\_delete()
[ Upstream commit ef23cb593304bde0cc046fd4cc83ae7ea2e24f16 ]
While debugging a segfault on 'perf lock contention' without an
available perf.data file I noticed that it was basically calling:
perf\_session\_\_delete(ERR\_PTR(-1))
Resulting in:
(gdb) run lock contention
Starting program: /root/bin/perf lock contention
[Thread debugging using libthread\_db enabled]
Using host libthread\_db library "/lib64/libthread\_db.so.1".
failed to open perf.data: No such file or directory (try 'perf record' first)
Initializing perf session failed
Program received signal SIGSEGV, Segmentation fault.
0x00000000005e7515 in auxtrace\_\_free (session=0xffffffffffffffff) at util/auxtrace.c:2858
2858 if (!session->auxtrace)
(gdb) p session
$1 = (struct perf\_session \*) 0xffffffffffffffff
(gdb) bt
#0 0x00000000005e7515 in auxtrace\_\_free (session=0xffffffffffffffff) at util/auxtrace.c:2858
#1 0x000000000057bb4d in perf\_session\_\_delete (session=0xffffffffffffffff) at util/session.c:300
#2 0x000000000047c421 in \_\_cmd\_contention (argc=0, argv=0x7fffffffe200) at builtin-lock.c:2161
#3 0x000000000047dc95 in cmd\_lock (argc=0, argv=0x7fffffffe200) at builtin-lock.c:2604
#4 0x0000000000501466 in run\_builtin (p=0xe597a8 , argc=2, argv=0x7fffffffe200) at perf.c:322
#5 0x00000000005016d5 in handle\_internal\_command (argc=2, argv=0x7fffffffe200) at perf.c:375
#6 0x0000000000501824 in run\_argv (argcp=0x7fffffffe02c, argv=0x7fffffffe020) at perf.c:419
#7 0x0000000000501b11 in main (argc=2, argv=0x7fffffffe200) at perf.c:535
(gdb)
So just set it to NULL after using PTR\_ERR(session) to decode the error
as perf\_session\_\_delete(NULL) is supported.
The same problem was found in 'perf top' after an audit of all
perf\_session\_\_new() failure handling.
Fixes: 6ef81c55a2b6584c ("perf session: Return error code for perf\_session\_\_new() function on failure")
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Alexey Budankov
Cc: Greg Kroah-Hartman
Cc: Jeremie Galarneau
Cc: Jiri Olsa
Cc: Kate Stewart
Cc: Mamatha Inamdar
Cc: Mukesh Ojha
Cc: Nageswara R Sastry
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Ravi Bangoria
Cc: Shawn Landden
Cc: Song Liu
Cc: Thomas Gleixner
Cc: Tzvetomir Stoyanov
Link: https://lore.kernel.org/lkml/ZN4Q2rxxsL08A8rd@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 2405d1eb5e9c046be15f1d3dc1ec8440fe81ff1b
Author: Kajol Jain
Date: Mon Aug 14 16:58:02 2023 +0530
perf vendor events: Update metric event names for power10 platform
[ Upstream commit edd65d2bc55fb84d7b80c2ffe3b74d9b11ac4e2f ]
Update metric event name for some of the JSON/metric events for
power10 platform.
Fixes: 3ca3af7d1f230d1f ("perf vendor events power10: Add metric events JSON file for power10 platform")
Signed-off-by: Kajol Jain
Cc: Athira Rajeev
Cc: Disha Goel
Cc: Ian Rogers
Cc: Kajol Jain
Cc: Madhavan Srinivasan
Cc: Namhyung Kim
Cc: linuxppc-dev@lists.ozlabs.org
Link: https://lore.kernel.org/r/20230814112803.1508296-6-kjain@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit f31933014c280a654c79fd809004a34498a874ba
Author: Kajol Jain
Date: Mon Aug 14 16:58:00 2023 +0530
perf vendor events: Move JSON/events to appropriate files for power10 platform
[ Upstream commit 7d473f475b2aff7e7c5d63b6f701c54590f84781 ]
Move some of the power10 JSON/events to appropriate files.
Fixes: 32daa5d7899e0343 ("perf vendor events: Initial JSON/events list for power10 platform")
Signed-off-by: Kajol Jain
Cc: Athira Rajeev
Cc: Disha Goel
Cc: Ian Rogers
Cc: Kajol Jain
Cc: Madhavan Srinivasan
Cc: Namhyung Kim
Cc: linuxppc-dev@lists.ozlabs.org
Link: https://lore.kernel.org/r/20230814112803.1508296-4-kjain@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit d3b9594c82615d5c8e7e66a126e56ac54e80454f
Author: Kajol Jain
Date: Mon Aug 14 16:57:59 2023 +0530
perf vendor events: Drop STORES\_PER\_INST metric event for power10 platform
[ Upstream commit 4836b9a85ef148c7c9779b66fab3f7279e488d90 ]
Drop STORES\_PER\_INST metric event for the power10 platform, as the
metric expression of STORES\_PER\_INST metric event using dropped event
PM\_ST\_FIN.
Fixes: 3ca3af7d1f230d1f ("perf vendor events power10: Add metric events JSON file for power10 platform")
Signed-off-by: Kajol Jain
Cc: Athira Rajeev
Cc: Disha Goel
Cc: Ian Rogers
Cc: Kajol Jain
Cc: Madhavan Srinivasan
Cc: Namhyung Kim
Cc: linuxppc-dev@lists.ozlabs.org
Link: https://lore.kernel.org/r/20230814112803.1508296-3-kjain@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit f85bca192b9fc37938636bfffc72c69658afd0e7
Author: Kajol Jain
Date: Mon Aug 14 16:57:58 2023 +0530
perf vendor events: Drop some of the JSON/events for power10 platform
[ Upstream commit e104df97b8dcfbab2e42de634b99bf03f0805d85 ]
Drop some of the JSON/events for power10 platform due to counter
data mismatch.
Fixes: 32daa5d7899e0343 ("perf vendor events: Initial JSON/events list for power10 platform")
Signed-off-by: Kajol Jain
Cc: Athira Rajeev
Cc: Disha Goel
Cc: Ian Rogers
Cc: Kajol Jain
Cc: Madhavan Srinivasan
Cc: Namhyung Kim
Cc: linuxppc-dev@lists.ozlabs.org
Link: https://lore.kernel.org/r/20230814112803.1508296-2-kjain@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 1d160e27a6461c9afc805feb817e723a28d8e9f2
Author: Kajol Jain
Date: Mon Aug 14 16:57:57 2023 +0530
perf vendor events: Update the JSON/events descriptions for power10 platform
[ Upstream commit 3286f88f31da060ac2789cee247153961ba57e49 ]
Update the description for some of the JSON/events for power10 platform.
Fixes: 32daa5d7899e0343 ("perf vendor events: Initial JSON/events list for power10 platform")
Signed-off-by: Kajol Jain
Cc: Athira Rajeev
Cc: Disha Goel
Cc: Ian Rogers
Cc: Kajol Jain
Cc: Madhavan Srinivasan
Cc: Namhyung Kim
Cc: linuxppc-dev@lists.ozlabs.org
Link: https://lore.kernel.org/r/20230814112803.1508296-1-kjain@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit dd6df6c9c2f53f0c1812c9c46ab3b94ec159ef28
Author: Adrian Hunter
Date: Mon Jul 31 12:18:57 2023 +0300
perf dlfilter: Add al\_cleanup()
[ Upstream commit 82b0a10390e5f198a4e23c9cc6a7307d2cf099f3 ]
Add perf\_dlfilter\_fns.al\_cleanup() to do addr\_location\_\_exit() on data
passed via perf\_dlfilter\_fns.resolve\_address().
Add dlfilter-test-api-v2 to the "dlfilter C API" test to test it.
Update documentation, clarifying that data returned by APIs should not
be dereferenced after filter\_event() and filter\_event\_early() return.
Fixes: 0dd5041c9a0eaf8c ("perf addr\_location: Add init/exit/copy functions")
Reviewed-by: Ian Rogers
Signed-off-by: Adrian Hunter
Cc: Jiri Olsa
Cc: Namhyung Kim
Link: https://lore.kernel.org/r/20230731091857.10681-3-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit bb95d578d172bd3285f7fa96c0d3ae2fe0cf44a5
Author: Arnaldo Carvalho de Melo
Date: Mon Jul 31 12:18:56 2023 +0300
perf dlfilter: Initialize addr\_location before passing it to thread\_\_find\_symbol\_fb()
[ Upstream commit 42c6dd9d23019ff339d0aca80a444eb71087050e ]
As thread\_\_find\_symbol\_fb() will end up calling thread\_\_find\_map() and
it in turn will call these on uninitialized memory:
maps\_\_zput(al->maps);
map\_\_zput(al->map);
thread\_\_zput(al->thread);
Fixes: 0dd5041c9a0eaf8c ("perf addr\_location: Add init/exit/copy functions")
Reviewed-by: Ian Rogers
Cc: Adrian Hunter
Cc: Aneesh Kumar K.V
Cc: Athira Rajeev
Cc: Disha Goel
Cc: Jiri Olsa
Cc: Kajol Jain
Cc: Madhavan Srinivasan
Cc: Namhyung Kim
Link: https://lore.kernel.org/r/20230731091857.10681-2-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit cc91cf171b8d6ab4acd394b3f287f2d691159e11
Author: Namhyung Kim
Date: Thu Aug 10 19:58:21 2023 -0700
perf bpf-filter: Fix sample flag check with ||
[ Upstream commit dc7f01f1bceca38839992b3371e0be8a3c9d5acf ]
For logical OR operator, the actual sample\_flags are in the 'groups'
list so it needs to check entries in the list instead. Otherwise it
would show the following error message.
$ sudo perf record -a -e cycles:p --filter 'period > 100 || weight > 0' sleep 1
Error: cycles:p event does not have sample flags 0
failed to set filter "BPF" on event cycles:p with 2 (No such file or directory)
Actually it should warn on 'weight' is used without WEIGHT flag.
Error: cycles:p event does not have PERF\_SAMPLE\_WEIGHT
Hint: please add -W option to perf record
failed to set filter "BPF" on event cycles:p with 2 (No such file or directory)
Fixes: 4310551b76e0d676 ("perf bpf filter: Show warning for missing sample flags")
Reviewed-by: Ian Rogers
Signed-off-by: Namhyung Kim
Tested-by: Arnaldo Carvalho de Melo
Cc: Adrian Hunter
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Peter Zijlstra
Link: https://lore.kernel.org/r/20230811025822.3859771-1-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 6125d4cc36e94bbac7dd292b19d79e8d9042271f
Author: Ivan Babrou
Date: Mon Jul 17 17:07:37 2023 -0700
perf script: Print "cgroup" field on the same line as "comm"
[ Upstream commit 8c49c6e1a7b790c4cb9f464c5485117451d91c60 ]
Commit 3fd7a168bf51 ("perf script: Add 'cgroup' field for output")
added support for printing cgroup path in perf script output.
It was okay if you didn't want any stacks:
$ sudo perf script --comms jpegtran:23f4bf -F comm,tid,cpu,time,cgroup
jpegtran:23f4bf 3321915 [013] 404718.587488: /idle.slice/polish.service
jpegtran:23f4bf 3321915 [031] 404718.592073: /idle.slice/polish.service
With stacks it gets messier as cgroup is printed after the stack:
$ perf script --comms jpegtran:23f4bf -F comm,tid,cpu,time,cgroup,ip,sym
jpegtran:23f4bf 3321915 [013] 404718.587488:
5c554 compress\_output
570d9 jpeg\_finish\_compress
3476e jpegtran\_main
330ee jpegtran::main
326e2 core::ops::function::FnOnce::call\_once (inlined)
326e2 std::sys\_common::backtrace::\_\_rust\_begin\_short\_backtrace
/idle.slice/polish.service
jpegtran:23f4bf 3321915 [031] 404718.592073:
8474d jsimd\_encode\_mcu\_AC\_first\_prepare\_sse2.PADDING
55af68e62fff [unknown]
/idle.slice/polish.service
Let's instead print cgroup on the same line as comm:
$ perf script --comms jpegtran:23f4bf -F comm,tid,cpu,time,cgroup,ip,sym
jpegtran:23f4bf 3321915 [013] 404718.587488: /idle.slice/polish.service
5c554 compress\_output
570d9 jpeg\_finish\_compress
3476e jpegtran\_main
330ee jpegtran::main
326e2 core::ops::function::FnOnce::call\_once (inlined)
326e2 std::sys\_common::backtrace::\_\_rust\_begin\_short\_backtrace
jpegtran:23f4bf 3321915 [031] 404718.592073: /idle.slice/polish.service
8474d jsimd\_encode\_mcu\_AC\_first\_prepare\_sse2.PADDING
55af68e62fff [unknown]
Fixes: 3fd7a168bf514979 ("perf script: Add 'cgroup' field for output")
Signed-off-by: Ivan Babrou
Acked-by: Ian Rogers
Acked-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Peter Zijlstra
Cc: kernel-team@cloudflare.com
Link: https://lore.kernel.org/r/20230718000737.49077-1-ivan@cloudflare.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 09af247f5bd610f60f7245e04cf5f89e2756b634
Author: Sean Christopherson
Date: Fri Jul 21 13:18:52 2023 -0700
x86/virt: Drop unnecessary check on extended CPUID level in cpu\_has\_svm()
[ Upstream commit 5df8ecfe3632d5879d1f154f7aa8de441b5d1c89 ]
Drop the explicit check on the extended CPUID level in cpu\_has\_svm(), the
kernel's cached CPUID info will leave the entire SVM leaf unset if said
leaf is not supported by hardware. Prior to using cached information,
the check was needed to avoid false positives due to Intel's rather crazy
CPUID behavior of returning the values of the maximum supported leaf if
the specified leaf is unsupported.
Fixes: 682a8108872f ("x86/kvm/svm: Simplify cpu\_has\_svm()")
Link: https://lore.kernel.org/r/20230721201859.2307736-13-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Sasha Levin
commit 95101e1cf94abc69ba158f0fbd4777784e5a0ea0
Author: Arnaldo Carvalho de Melo
Date: Wed Aug 2 18:22:14 2023 -0300
perf annotate bpf: Don't enclose non-debug code with an assert()
[ Upstream commit 979e9c9fc9c2a761303585e07fe2699bdd88182f ]
In 616b14b47a86d880 ("perf build: Conditionally define NDEBUG") we
started using NDEBUG=1 when DEBUG=1 isn't present, so code that is
enclosed with assert() is not called.
In dd317df072071903 ("perf build: Make binutil libraries opt in") we
stopped linking against binutils-devel, for licensing reasons.
Recently people asked me why annotation of BPF programs wasn't working,
i.e. this:
$ perf annotate bpf\_prog\_5280546344e3f45c\_kfree\_skb
was returning:
case SYMBOL\_ANNOTATE\_ERRNO\_\_NO\_LIBOPCODES\_FOR\_BPF:
scnprintf(buf, buflen, "Please link with binutils's libopcode to enable BPF annotation");
This was on a fedora rpm, so its new enough that I had to try to test by
rebuilding using BUILD\_NONDISTRO=1, only to get it segfaulting on me.
This combination made this libopcode function not to be called:
assert(bfd\_check\_format(bfdf, bfd\_object));
Changing it to:
if (!bfd\_check\_format(bfdf, bfd\_object))
abort();
Made it work, looking at this "check" function made me realize it
changes the 'bfdf' internal state, i.e. we better call it.
So stop using assert() on it, just call it and abort if it fails.
Probably it is better to propagate the error, etc, but it seems it is
unlikely to fail from the usage done so far and we really need to stop
using libopcodes, so do the quick fix above and move on.
With it we have BPF annotation back working when built with
BUILD\_NONDISTRO=1:
⬢[acme@toolbox perf-tools-next]$ perf annotate --stdio2 bpf\_prog\_5280546344e3f45c\_kfree\_skb | head
No kallsyms or vmlinux with build-id 939bc71a1a51cdc434e60af93c7e734f7d5c0e7e was found
Samples: 12 of event 'cpu-clock:ppp', 4000 Hz, Event count (approx.): 3000000, [percent: local period]
bpf\_prog\_5280546344e3f45c\_kfree\_skb() bpf\_prog\_5280546344e3f45c\_kfree\_skb
Percent int kfree\_skb(struct trace\_event\_raw\_kfree\_skb \*args) {
nop
33.33 xchg %ax,%ax
push %rbp
mov %rsp,%rbp
sub $0x180,%rsp
push %rbx
push %r13
⬢[acme@toolbox perf-tools-next]$
Fixes: 6987561c9e86eace ("perf annotate: Enable annotation of BPF programs")
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Mohamed Mahmoud
Cc: Namhyung Kim
Cc: Dave Tucker
Cc: Derek Barbosa
Cc: Song Liu
Link: https://lore.kernel.org/lkml/ZMrMzoQBe0yqMek1@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 52385cfce5be36e6fb222f58a96b73d27d7644ec
Author: Dmitry Torokhov
Date: Sun Jul 23 22:30:20 2023 -0700
Input: tca6416-keypad - fix interrupt enable disbalance
[ Upstream commit cc141c35af873c6796e043adcb820833bd8ef8c5 ]
The driver has been switched to use IRQF\_NO\_AUTOEN, but in the error
unwinding and remove paths calls to enable\_irq() were left in place, which
will lead to an incorrect enable counter value.
Fixes: bcd9730a04a1 ("Input: move to use request\_irq by IRQF\_NO\_AUTOEN flag")
Link: https://lore.kernel.org/r/20230724053024.352054-3-dmitry.torokhov@gmail.com
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit e1c2e3c03ae68777c929079067f96cf63fac68b7
Author: Dmitry Torokhov
Date: Sun Jul 23 22:30:18 2023 -0700
Input: tca6416-keypad - always expect proper IRQ number in i2c client
[ Upstream commit 687fe7dfb736b03ab820d172ea5dbfc1ec447135 ]
Remove option having i2c client contain raw gpio number instead of proper
IRQ number. There are no users of this facility in mainline and it will
allow cleaning up the driver code with regard to wakeup handling, etc.
Link: https://lore.kernel.org/r/20230724053024.352054-1-dmitry.torokhov@gmail.com
Signed-off-by: Dmitry Torokhov
Stable-dep-of: cc141c35af87 ("Input: tca6416-keypad - fix interrupt enable disbalance")
Signed-off-by: Sasha Levin
commit f518e18b2c13ab3edf38325e5ebdbe9ff78e440e
Author: Sean Christopherson
Date: Thu Jun 15 16:37:56 2023 +1000
KVM: SVM: Don't defer NMI unblocking until next exit for SEV-ES guests
[ Upstream commit 389fbbec261b2842fd0e34b26a2b288b122cc406 ]
Immediately mark NMIs as unmasked in response to #VMGEXIT(NMI complete)
instead of setting awaiting\_iret\_completion and waiting until the \*next\*
VM-Exit to unmask NMIs. The whole point of "NMI complete" is that the
guest is responsible for telling the hypervisor when it's safe to inject
an NMI, i.e. there's no need to wait. And because there's no IRET to
single-step, the next VM-Exit could be a long time coming, i.e. KVM could
incorrectly hold an NMI pending for far longer than what is required and
expected.
Opportunistically fix a stale reference to HF\_IRET\_MASK.
Fixes: 916b54a7688b ("KVM: x86: Move HF\_NMI\_MASK and HF\_IRET\_MASK into "struct vcpu\_svm"")
Fixes: 4444dfe4050b ("KVM: SVM: Add NMI support for an SEV-ES guest")
Cc: Tom Lendacky
Link: https://lore.kernel.org/r/20230615063757.3039121-9-aik@amd.com
Signed-off-by: Sean Christopherson
Signed-off-by: Sasha Levin
commit 6f9da1f65fd8014cfcef7533703981c6e6d2d9fb
Author: Ian Rogers
Date: Tue Jun 27 11:10:27 2023 -0700
perf parse-events: Additional error reporting
[ Upstream commit b30d4f0b695428f513c561eeaea52e042ef48550 ]
When no events or PMUs match report an error for event\_pmu:
Before:
```
$ perf stat -e 'asdfasdf' -a sleep 1
Run 'perf list' for a list of valid events
Usage: perf stat [] []
-e, --event  event selector. use 'perf list' to list available events
```
After:
```
$ perf stat -e 'asdfasdf' -a sleep 1
event syntax error: 'asdfasdf'
\\_\_\_ Bad event name
Unabled to find PMU or event on a PMU of 'asdfasdf'
Run 'perf list' for a list of valid events
Usage: perf stat [] []
-e, --event  event selector. use 'perf list' to list available events
```
Fixes the inadvertent removal when hybrid parsing was modified.
Fixes: 70c90e4a6b2fbe77 ("perf parse-events: Avoid scanning PMUs before parsing")
Signed-off-by: Ian Rogers
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Athira Rajeev
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: bpf@vger.kernel.org
Link: https://lore.kernel.org/r/20230627181030.95608-11-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit be3835ca6a3e612a67e4c62c77fa030d4a14c7fe
Author: Ian Rogers
Date: Tue Jun 27 11:10:26 2023 -0700
perf parse-events: Separate ENOMEM memory handling
[ Upstream commit b52cb995f1a559bc6e1a7cdc0ed0375503528541 ]
Add PE\_ABORT that will YYNOMEM or YYABORT accordingly.
Signed-off-by: Ian Rogers
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Athira Rajeev
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: bpf@vger.kernel.org
Link: https://lore.kernel.org/r/20230627181030.95608-10-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Stable-dep-of: b30d4f0b6954 ("perf parse-events: Additional error reporting")
Signed-off-by: Sasha Levin
commit 0e8501c8a936e0b2ff4ffdff2c4866ba74969189
Author: Ian Rogers
Date: Tue Jun 27 11:10:25 2023 -0700
perf parse-events: Move instances of YYABORT to YYNOMEM
[ Upstream commit 77cdd787fc45e3426b8e0b5038b85c276540dfb4 ]
Migration to improve error reporting as YYABORT cases should carry
event parsing errors.
Signed-off-by: Ian Rogers
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Athira Rajeev
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: bpf@vger.kernel.org
Link: https://lore.kernel.org/r/20230627181030.95608-9-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Stable-dep-of: b30d4f0b6954 ("perf parse-events: Additional error reporting")
Signed-off-by: Sasha Levin
commit 7e7bca9dd3e7fe5cc4c7ef78610c9cb0ce93c9fd
Author: Ian Rogers
Date: Tue Jun 27 11:10:24 2023 -0700
perf parse-events: Separate YYABORT and YYNOMEM cases
[ Upstream commit a7a3252dad354a9e5c173156dab959e4019b9467 ]
Split cases in event\_pmu for greater accuracy.
Signed-off-by: Ian Rogers
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Athira Rajeev
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: bpf@vger.kernel.org
Link: https://lore.kernel.org/r/20230627181030.95608-8-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Stable-dep-of: b30d4f0b6954 ("perf parse-events: Additional error reporting")
Signed-off-by: Sasha Levin
commit 2a6a2572a0f77874c008a723b4fbe4965163b5f2
Author: Ying Liu
Date: Fri Jul 21 09:29:03 2023 +0000
backlight: gpio\_backlight: Drop output GPIO direction check for initial power state
[ Upstream commit fe1328b5b2a087221e31da77e617f4c2b70f3b7f ]
So, let's drop output GPIO direction check and only check GPIO value to set
the initial power state.
Fixes: 706dc68102bc ("backlight: gpio: Explicitly set the direction of the GPIO")
Signed-off-by: Liu Ying
Reviewed-by: Andy Shevchenko
Acked-by: Linus Walleij
Acked-by: Bartosz Golaszewski
Link: https://lore.kernel.org/r/20230721093342.1532531-1-victor.liu@nxp.com
Signed-off-by: Lee Jones
Signed-off-by: Sasha Levin
commit f60b2ca659d69313595f291354c1a3da8221a7c0
Author: Artur Weber
Date: Fri Jul 14 14:14:39 2023 +0200
backlight: lp855x: Initialize PWM state on first brightness change
[ Upstream commit 4c09e20b3c85f60353ace21092e34f35f5e3ab00 ]
As pointed out by Uwe Kleine-König[1], the changes introduced in
commit c1ff7da03e16 ("video: backlight: lp855x: Get PWM for PWM mode
during probe") caused the PWM state set up by the bootloader to be
re-set when the driver is probed. This differs from the behavior from
before that patch, where the PWM state would be initialized on the
first brightness change.
Fix this by moving the PWM state initialization into the PWM control
function. Add a new variable, needs\_pwm\_init, to the device info struct
to allow us to check whether we need the initialization, or whether it
has already been done.
[1] https://lore.kernel.org/lkml/20230614083953.e4kkweddjz7wztby@pengutronix.de/
Fixes: c1ff7da03e16 ("video: backlight: lp855x: Get PWM for PWM mode during probe")
Signed-off-by: Artur Weber
Reviewed-by: Daniel Thompson
Link: https://lore.kernel.org/r/20230714121440.7717-2-aweber.kernel@gmail.com
Signed-off-by: Lee Jones
Signed-off-by: Sasha Levin
commit 053a8ea0be4d96713716393df63638704c2b760c
Author: Uwe Kleine-König
Date: Wed Jul 19 21:20:10 2023 +0200
pwm: atmel-tcb: Fix resource freeing in error path and remove
[ Upstream commit c11622324c023415fb69196c5fc3782d2b8cced0 ]
Several resources were not freed in the error path and the remove
function. Add the forgotten items.
Fixes: 34cbcd72588f ("pwm: atmel-tcb: Add sama5d2 support")
Fixes: 061f8572a31c ("pwm: atmel-tcb: Switch to new binding")
Signed-off-by: Uwe Kleine-König
Reviewed-by: Claudiu Beznea
Signed-off-by: Thierry Reding
Signed-off-by: Sasha Levin
commit 13ffd3dd8fd4f7605eb55ed09d2305592775ae25
Author: Uwe Kleine-König
Date: Wed Jul 19 21:20:09 2023 +0200
pwm: atmel-tcb: Harmonize resource allocation order
[ Upstream commit 0323e8fedd1ef25342cf7abf3a2024f5670362b8 ]
Allocate driver data as first resource in the probe function. This way it
can be used during allocation of the other resources (instead of assigning
these to local variables first and update driver data only when it's
allocated). Also as driver data is allocated using a devm function this
should happen first to have the order of freeing resources in the error
path and the remove function in reverse.
Signed-off-by: Uwe Kleine-König
Signed-off-by: Thierry Reding
Stable-dep-of: c11622324c02 ("pwm: atmel-tcb: Fix resource freeing in error path and remove")
Signed-off-by: Sasha Levin
commit 27f396f64537b1ae48d0644d7cbf0d250b3c0b33
Author: Arnaldo Carvalho de Melo
Date: Wed Jul 19 15:37:14 2023 -0300
perf trace: Really free the evsel->priv area
[ Upstream commit 7962ef13651a9163f07b530607392ea123482e8a ]
In 3cb4d5e00e037c70 ("perf trace: Free syscall tp fields in
evsel->priv") it only was freeing if strcmp(evsel->tp\_format->system,
"syscalls") returned zero, while the corresponding initialization of
evsel->priv was being performed if it was \_not\_ zero, i.e. if the tp
system wasn't 'syscalls'.
Just stop looking for that and free it if evsel->priv was set, which
should be equivalent.
Also use the pre-existing evsel\_trace\_\_delete() function.
This resolves these leaks, detected with:
$ make EXTRA\_CFLAGS="-fsanitize=address" BUILD\_BPF\_SKEL=1 CORESIGHT=1 O=/tmp/build/perf-tools-next -C tools/perf install-bin
=================================================================
==481565==ERROR: LeakSanitizer: detected memory leaks
Direct leak of 40 byte(s) in 1 object(s) allocated from:
#0 0x7f7343cba097 in calloc (/lib64/libasan.so.8+0xba097)
#1 0x987966 in zalloc (/home/acme/bin/perf+0x987966)
#2 0x52f9b9 in evsel\_trace\_\_new /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:307
#3 0x52f9b9 in evsel\_\_syscall\_tp /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:333
#4 0x52f9b9 in evsel\_\_init\_raw\_syscall\_tp /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:458
#5 0x52f9b9 in perf\_evsel\_\_raw\_syscall\_newtp /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:480
#6 0x540e8b in trace\_\_add\_syscall\_newtp /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:3212
#7 0x540e8b in trace\_\_run /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:3891
#8 0x540e8b in cmd\_trace /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:5156
#9 0x5ef262 in run\_builtin /home/acme/git/perf-tools-next/tools/perf/perf.c:323
#10 0x4196da in handle\_internal\_command /home/acme/git/perf-tools-next/tools/perf/perf.c:377
#11 0x4196da in run\_argv /home/acme/git/perf-tools-next/tools/perf/perf.c:421
#12 0x4196da in main /home/acme/git/perf-tools-next/tools/perf/perf.c:537
#13 0x7f7342c4a50f in \_\_libc\_start\_call\_main (/lib64/libc.so.6+0x2750f)
Direct leak of 40 byte(s) in 1 object(s) allocated from:
#0 0x7f7343cba097 in calloc (/lib64/libasan.so.8+0xba097)
#1 0x987966 in zalloc (/home/acme/bin/perf+0x987966)
#2 0x52f9b9 in evsel\_trace\_\_new /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:307
#3 0x52f9b9 in evsel\_\_syscall\_tp /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:333
#4 0x52f9b9 in evsel\_\_init\_raw\_syscall\_tp /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:458
#5 0x52f9b9 in perf\_evsel\_\_raw\_syscall\_newtp /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:480
#6 0x540dd1 in trace\_\_add\_syscall\_newtp /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:3205
#7 0x540dd1 in trace\_\_run /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:3891
#8 0x540dd1 in cmd\_trace /home/acme/git/perf-tools-next/tools/perf/builtin-trace.c:5156
#9 0x5ef262 in run\_builtin /home/acme/git/perf-tools-next/tools/perf/perf.c:323
#10 0x4196da in handle\_internal\_command /home/acme/git/perf-tools-next/tools/perf/perf.c:377
#11 0x4196da in run\_argv /home/acme/git/perf-tools-next/tools/perf/perf.c:421
#12 0x4196da in main /home/acme/git/perf-tools-next/tools/perf/perf.c:537
#13 0x7f7342c4a50f in \_\_libc\_start\_call\_main (/lib64/libc.so.6+0x2750f)
SUMMARY: AddressSanitizer: 80 byte(s) leaked in 2 allocation(s).
[root@quaco ~]#
With this we plug all leaks with "perf trace sleep 1".
Fixes: 3cb4d5e00e037c70 ("perf trace: Free syscall tp fields in evsel->priv")
Acked-by: Ian Rogers
Cc: Adrian Hunter
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Riccardo Mancini
Link: https://lore.kernel.org/lkml/20230719202951.534582-5-acme@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit f6fa0e0760a7748341c289c76728ef33871c4f8c
Author: Jeff LaBundy
Date: Sun Jul 9 12:06:37 2023 -0500
Input: iqs7222 - configure power mode before triggering ATI
[ Upstream commit 2e00b8bf5624767f6be7427b6eb532524793463e ]
If the device drops into ultra-low-power mode before being placed
into normal-power mode as part of ATI being triggered, the device
does not assert any interrupts until the ATI routine is restarted
two seconds later.
Solve this problem by adopting the vendor's recommendation, which
calls for the device to be placed into normal-power mode prior to
being configured and ATI being triggered.
The original implementation followed this sequence, but the order
was inadvertently changed as part of the resolution of a separate
erratum.
Fixes: 1e4189d8af27 ("Input: iqs7222 - protect volatile registers")
Signed-off-by: Jeff LaBundy
Link: https://lore.kernel.org/r/ZKrpHc2Ji9qR25r2@nixie71
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit f20377d4e0200ef53fa1d0d042fb542170be4f86
Author: Xie XiuQi
Date: Thu Aug 31 11:42:05 2023 +0800
tools/mm: fix undefined reference to pthread\_once
[ Upstream commit 7f33105cdd59a99d068d3d147723a865d10e2260 ]
Commit 97d5f2e9ee12 ("tools api fs: More thread safety for global
filesystem variables") introduces pthread\_once, so the libpthread
should be added at link time, or we'll meet the following compile
error when 'make -C tools/mm':
gcc -Wall -Wextra -I../lib/ -o page-types page-types.c ../lib/api/libapi.a
~/linux/tools/lib/api/fs/fs.c:146: undefined reference to `pthread\_once'
~/linux/tools/lib/api/fs/fs.c:147: undefined reference to `pthread\_once'
~/linux/tools/lib/api/fs/fs.c:148: undefined reference to `pthread\_once'
~/linux/tools/lib/api/fs/fs.c:149: undefined reference to `pthread\_once'
~/linux/tools/lib/api/fs/fs.c:150: undefined reference to `pthread\_once'
/usr/bin/ld: ../lib/api/libapi.a(libapi-in.o):~/linux/tools/lib/api/fs/fs.c:151:
more undefined references to `pthread\_once' follow
collect2: error: ld returned 1 exit status
make: \*\*\* [Makefile:22: page-types] Error 1
Link: https://lkml.kernel.org/r/20230831034205.2376653-1-xiexiuqi@huaweicloud.com
Fixes: 97d5f2e9ee12 ("tools api fs: More thread safety for global filesystem variables")
Signed-off-by: Xie XiuQi
Acked-by: Ian Rogers
Cc: Matthew Wilcox
Signed-off-by: Andrew Morton
Signed-off-by: Sasha Levin
commit adf27ed04c836018c64b08f3608736694c82aa46
Author: Konstantin Meskhidze
Date: Tue Sep 5 17:59:14 2023 +0800
kconfig: fix possible buffer overflow
[ Upstream commit a3b7039bb2b22fcd2ad20d59c00ed4e606ce3754 ]
Buffer 'new\_argv' is accessed without bound check after accessing with
bound check via 'new\_argc' index.
Fixes: e298f3b49def ("kconfig: add built-in function support")
Co-developed-by: Ivanov Mikhail
Signed-off-by: Konstantin Meskhidze
Signed-off-by: Masahiro Yamada
Signed-off-by: Sasha Levin
commit 30e4f88dfaa94f6fbeefea61e4a1b4f6bb816042
Author: Jonathan Marek
Date: Wed Aug 2 09:52:22 2023 -0400
mailbox: qcom-ipcc: fix incorrect num\_chans counting
[ Upstream commit a493208079e299aefdc15169dc80e3da3ebb718a ]
Breaking out early when a match is found leads to an incorrect num\_chans
value when more than one ipcc mailbox channel is used by the same device.
Fixes: e9d50e4b4d04 ("mailbox: qcom-ipcc: Dynamic alloc for channel arrangement")
Signed-off-by: Jonathan Marek
Signed-off-by: Jassi Brar
Signed-off-by: Sasha Levin
commit 1a1623087d8d472e6acfed0e3875e5bb52d9ea18
Author: Andreas Gruenbacher
Date: Thu Aug 10 17:15:46 2023 +0200
gfs2: low-memory forced flush fixes
[ Upstream commit b74cd55aa9a9d0aca760028a51343ec79812e410 ]
First, function gfs2\_ail\_flush\_reqd checks the SDF\_FORCE\_AIL\_FLUSH flag
to determine if an AIL flush should be forced in low-memory situations.
However, it also immediately clears the flag, and when called repeatedly
as in function gfs2\_logd, the flag will be lost. Fix that by pulling
the SDF\_FORCE\_AIL\_FLUSH flag check out of gfs2\_ail\_flush\_reqd.
Second, function gfs2\_writepages sets the SDF\_FORCE\_AIL\_FLUSH flag
whether or not enough pages were written. If enough pages could be
written, flushing the AIL is unnecessary, though.
Third, gfs2\_writepages doesn't wake up logd after setting the
SDF\_FORCE\_AIL\_FLUSH flag, so it can take a long time for logd to react.
It would be preferable to wake up logd, but that hurts the performance
of some workloads and we don't quite understand why so far, so don't
wake up logd so far.
Fixes: b066a4eebd4f ("gfs2: forcibly flush ail to relieve memory pressure")
Signed-off-by: Andreas Gruenbacher
Signed-off-by: Sasha Levin
commit 42c45325a5d53093c1e74ad2ab40658680b01fbe
Author: Andreas Gruenbacher
Date: Thu Aug 17 15:46:16 2023 +0200
gfs2: Switch to wait\_event in gfs2\_logd
[ Upstream commit 6df373b09b1dcf2f7d579f515f653f89a896d417 ]
In gfs2\_logd(), switch from an open-coded wait loop to
wait\_event\_interruptible\_timeout().
Signed-off-by: Andreas Gruenbacher
Stable-dep-of: b74cd55aa9a9 ("gfs2: low-memory forced flush fixes")
Signed-off-by: Sasha Levin
commit bc8e346651ba12daad06ba2bf03abf21a45cfe63
Author: Christophe JAILLET
Date: Sat Feb 25 11:58:48 2023 +0100
tpm\_crb: Fix an error handling path in crb\_acpi\_add()
[ Upstream commit 9c377852ddfdc557b1370f196b0cfdf28d233460 ]
Some error paths don't call acpi\_put\_table() before returning.
Branch to the correct place instead of doing some direct return.
Fixes: 4d2732882703 ("tpm\_crb: Add support for CRB devices based on Pluton")
Signed-off-by: Christophe JAILLET
Acked-by: Matthew Garrett
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Sasha Levin
commit ad2c639f4f717d9ba23d6e982375fb900ac316c0
Author: Jiri Slaby
Date: Tue Aug 29 12:51:06 2023 +0200
kbuild: dummy-tools: make MPROFILE\_KERNEL checks work on BE
[ Upstream commit bfb41e46d0b040ae83c1c4a50292298208b10f73 ]
Commit 2eab791f940b ("kbuild: dummy-tools: support MPROFILE\_KERNEL
checks for ppc") added support for ppc64le's checks for
-mprofile-kernel.
Now, commit aec0ba7472a7 ("powerpc/64: Use -mprofile-kernel for big
endian ELFv2 kernels") added support for -mprofile-kernel even on
big-endian ppc.
So lift the check in gcc-check-mprofile-kernel.sh to support big-endian too.
Fixes: aec0ba7472a7 ("powerpc/64: Use -mprofile-kernel for big endian ELFv2 kernels")
Signed-off-by: Jiri Slaby
Signed-off-by: Masahiro Yamada
Signed-off-by: Sasha Levin
commit 8da9dd59dd0b42b586ccfc7b640f215d09698cbc
Author: Masahiro Yamada
Date: Wed Aug 23 20:50:41 2023 +0900
kbuild: do not run depmod for 'make modules\_sign'
[ Upstream commit 2429742e506a2b5939a62c629c4a46d91df0ada8 ]
Commit 961ab4a3cd66 ("kbuild: merge scripts/Makefile.modsign to
scripts/Makefile.modinst") started to run depmod at the end of
'make modules\_sign'.
Move the depmod rule to scripts/Makefile.modinst and run it only when
$(modules\_sign\_only) is empty.
Fixes: 961ab4a3cd66 ("kbuild: merge scripts/Makefile.modsign to scripts/Makefile.modinst")
Signed-off-by: Masahiro Yamada
Reviewed-by: Nicolas Schier
Signed-off-by: Sasha Levin
commit edd005afaefec3f166acf69d897cf9a0d8a1201f
Author: Masahiro Yamada
Date: Sat Jul 22 13:47:48 2023 +0900
kbuild: rpm-pkg: define \_arch conditionally
[ Upstream commit 233046a2afd12a4f699305b92ee634eebf1e4f31 ]
Commit 3089b2be0cce ("kbuild: rpm-pkg: fix build error when \_arch is
undefined") does not work as intended; \_arch is always defined as
$UTS\_MACHINE.
The intention was to define \_arch to $UTS\_MACHINE only when it is not
defined.
Fixes: 3089b2be0cce ("kbuild: rpm-pkg: fix build error when \_arch is undefined")
Signed-off-by: Masahiro Yamada
Signed-off-by: Sasha Levin
commit 5c6cc19d7378c6bebeb87519a77a2c8be431cac8
Author: Qiang Yu
Date: Thu May 18 14:22:39 2023 +0800
bus: mhi: host: Skip MHI reset if device is in RDDM
commit cabce92dd805945a090dc6fc73b001bb35ed083a upstream.
In RDDM EE, device can not process MHI reset issued by host. In case of MHI
power off, host is issuing MHI reset and polls for it to get cleared until
it times out. Since this timeout can not be avoided in case of RDDM, skip
the MHI reset in this scenarios.
Cc:
Fixes: a6e2e3522f29 ("bus: mhi: core: Add support for PM state transitions")
Signed-off-by: Qiang Yu
Reviewed-by: Jeffrey Hugo
Reviewed-by: Manivannan Sadhasivam
Link: https://lore.kernel.org/r/1684390959-17836-1-git-send-email-quic\_qianyu@quicinc.com
Signed-off-by: Manivannan Sadhasivam
Signed-off-by: Greg Kroah-Hartman
commit b350c662d63add0157931bca0789344053c69c05
Author: Fedor Pchelkin
Date: Thu Jul 20 18:37:51 2023 +0300
NFSv4/pnfs: minor fix for cleanup path in nfs4\_get\_device\_info
commit 96562c45af5c31b89a197af28f79bfa838fb8391 upstream.
It is an almost improbable error case but when page allocating loop in
nfs4\_get\_device\_info() fails then we should only free the already
allocated pages, as \_\_free\_page() can't deal with NULL arguments.
Found by Linux Verification Center (linuxtesting.org).
Cc: stable@vger.kernel.org
Signed-off-by: Fedor Pchelkin
Reviewed-by: Benjamin Coddington
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 0ec26716e45d615edfff46012e7dedcc0ac5f7ab
Author: Trond Myklebust
Date: Sat Aug 19 17:22:14 2023 -0400
NFS: Fix a potential data corruption
commit 88975a55969e11f26fe3846bf4fbf8e7dc8cbbd4 upstream.
We must ensure that the subrequests are joined back into the head before
we can retransmit a request. If the head was not on the commit lists,
because the server wrote it synchronously, we still need to add it back
to the retransmission list.
Add a call that mirrors the effect of nfs\_cancel\_remove\_inode() for
O\_DIRECT.
Fixes: ed5d588fe47f ("NFS: Try to join page groups before an O\_DIRECT retransmission")
Cc: stable@vger.kernel.org
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit de830dc9625a1dfea6bf0f5de5e725f4b789e800
Author: Johan Hovold
Date: Tue Jul 18 15:29:01 2023 +0200
clk: qcom: mss-sc7180: fix missing resume during probe
commit e2349da0fa7ca822cda72f427345b95795358fe7 upstream.
Drivers that enable runtime PM must make sure that the controller is
runtime resumed before accessing its registers to prevent the power
domain from being disabled.
Fixes: 8def929c4097 ("clk: qcom: Add modem clock controller driver for SC7180")
Cc: stable@vger.kernel.org # 5.7
Cc: Taniya Das
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20230718132902.21430-8-johan+linaro@kernel.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 0f316479360a89899fe379d519eea81ecb60f062
Author: Johan Hovold
Date: Tue Jul 18 15:29:00 2023 +0200
clk: qcom: q6sstop-qcs404: fix missing resume during probe
commit 97112c83f4671a4a722f99a53be4e91fac4091bc upstream.
Drivers that enable runtime PM must make sure that the controller is
runtime resumed before accessing its registers to prevent the power
domain from being disabled.
Fixes: 6cdef2738db0 ("clk: qcom: Add Q6SSTOP clock controller for QCS404")
Cc: stable@vger.kernel.org # 5.5
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20230718132902.21430-7-johan+linaro@kernel.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 5a078ec3fa28304a80ad2b5e8b61f29f8f9c1612
Author: Johan Hovold
Date: Tue Jul 18 15:28:59 2023 +0200
clk: qcom: lpasscc-sc7280: fix missing resume during probe
commit 66af5339d4f8e20c6d89a490570bd94d40f1a7f6 upstream.
Drivers that enable runtime PM must make sure that the controller is
runtime resumed before accessing its registers to prevent the power
domain from being disabled.
Fixes: 4ab43d171181 ("clk: qcom: Add lpass clock controller driver for SC7280")
Cc: stable@vger.kernel.org # 5.16
Cc: Taniya Das
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20230718132902.21430-6-johan+linaro@kernel.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 98faf753f00909f67e9eaa092c30f34009f97b21
Author: Johan Hovold
Date: Tue Jul 18 15:28:57 2023 +0200
clk: qcom: dispcc-sm8550: fix runtime PM imbalance on probe errors
commit acaf1b3296a504d4a61b685f78baae771421608d upstream.
Make sure to decrement the runtime PM usage count before returning in
case regmap initialisation fails.
Fixes: 90114ca11476 ("clk: qcom: add SM8550 DISPCC driver")
Cc: stable@vger.kernel.org # 6.3
Cc: Neil Armstrong
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20230718132902.21430-4-johan+linaro@kernel.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 1c1962a912ef4a5996ca5d02fce60b352bdee51d
Author: Johan Hovold
Date: Tue Jul 18 15:28:56 2023 +0200
clk: qcom: dispcc-sm8450: fix runtime PM imbalance on probe errors
commit b0f3d01bda6c3f6f811e70f76d2040ae81f64565 upstream.
Make sure to decrement the runtime PM usage count before returning in
case regmap initialisation fails.
Fixes: 16fb89f92ec4 ("clk: qcom: Add support for Display Clock Controller on SM8450")
Cc: stable@vger.kernel.org # 6.1
Cc: Dmitry Baryshkov
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20230718132902.21430-3-johan+linaro@kernel.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 22ee7c9c7f381be178b4457bc54530002e08e938
Author: Chris Lew
Date: Tue Aug 1 12:17:12 2023 +0530
soc: qcom: qmi\_encdec: Restrict string length in decode
commit 8d207400fd6b79c92aeb2f33bb79f62dff904ea2 upstream.
The QMI TLV value for strings in a lot of qmi element info structures
account for null terminated strings with MAX\_LEN + 1. If a string is
actually MAX\_LEN + 1 length, this will cause an out of bounds access
when the NULL character is appended in decoding.
Fixes: 9b8a11e82615 ("soc: qcom: Introduce QMI encoder/decoder")
Cc: stable@vger.kernel.org
Signed-off-by: Chris Lew
Signed-off-by: Praveenkumar I
Link: https://lore.kernel.org/r/20230801064712.3590128-1-quic\_ipkumar@quicinc.com
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit c8b48c5ee3c61b041a6a26489eb3127a0b60f5c0
Author: Dmitry Baryshkov
Date: Sat May 13 00:17:23 2023 +0300
clk: qcom: gcc-mdm9615: use proper parent for pll0\_vote clock
commit 1583694bb4eaf186f17131dbc1b83d6057d2749b upstream.
The pll0\_vote clock definitely should have pll0 as a parent (instead of
pll8).
Fixes: 7792a8d6713c ("clk: mdm9615: Add support for MDM9615 Clock Controllers")
Cc: stable@kernel.org
Reviewed-by: Neil Armstrong
Signed-off-by: Dmitry Baryshkov
Reviewed-by: Konrad Dybcio
Link: https://lore.kernel.org/r/20230512211727.3445575-7-dmitry.baryshkov@linaro.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 120367a5ab68bd8d444467872d9e1aa4808f7353
Author: Marco Felsch
Date: Mon Aug 7 10:47:43 2023 +0200
clk: imx: pll14xx: align pdiv with reference manual
commit 37cfd5e457cbdcd030f378127ff2d62776f641e7 upstream.
The PLL14xx hardware can be found on i.MX8M{M,N,P} SoCs and always come
with a 6-bit pre-divider. Neither the reference manuals nor the
datasheets of these SoCs do mention any restrictions. Furthermore the
current code doesn't respect the restrictions from the comment too.
Therefore drop the restriction and align the max pre-divider (pdiv)
value to 63 to get more accurate frequencies.
Fixes: b09c68dc57c9 ("clk: imx: pll14xx: Support dynamic rates")
Cc: stable@vger.kernel.org
Signed-off-by: Marco Felsch
Reviewed-by: Abel Vesa
Reviewed-by: Adam Ford
Signed-off-by: Philipp Zabel
Acked-by: Sascha Hauer
Tested-by: Ahmad Fatoum
Link: https://lore.kernel.org/r/20230807084744.1184791-1-m.felsch@pengutronix.de
Signed-off-by: Abel Vesa
Signed-off-by: Greg Kroah-Hartman
commit 20b9ffdb96b4eea0d771bf238fddc7152cde5ef2
Author: Ahmad Fatoum
Date: Mon Aug 7 10:47:44 2023 +0200
clk: imx: pll14xx: dynamically configure PLL for 393216000/361267200Hz
commit 72d00e560d10665e6139c9431956a87ded6e9880 upstream.
Since commit b09c68dc57c9 ("clk: imx: pll14xx: Support dynamic rates"),
the driver has the ability to dynamically compute PLL parameters to
approximate the requested rates. This is not always used, because the
logic is as follows:
- Check if the target rate is hardcoded in the frequency table
- Check if varying only kdiv is possible, so switch over is glitch free
- Compute rate dynamically by iterating over pdiv range
If we skip the frequency table for the 1443x PLL, we find that the
computed values differ to the hardcoded ones. This can be valid if the
hardcoded values guarantee for example an earlier lock-in or if the
divisors are chosen, so that other important rates are more likely to
be reached glitch-free.
For rates (393216000 and 361267200, this doesn't seem to be the case:
They are only approximated by existing parameters (393215995 and
361267196 Hz, respectively) and they aren't reachable glitch-free from
other hardcoded frequencies. Dropping them from the table allows us
to lock-in to these frequencies exactly.
This is immediately noticeable because they are the assigned-clock-rates
for IMX8MN\_AUDIO\_PLL1 and IMX8MN\_AUDIO\_PLL2, respectively and a look
into clk\_summary so far showed that they were a few Hz short of the target:
imx8mn-board:~# grep audio\_pll[12]\_out /sys/kernel/debug/clk/clk\_summary
audio\_pll2\_out 0 0 0 361267196 0 0 50000 N
audio\_pll1\_out 1 1 0 393215995 0 0 50000 Y
and afterwards:
imx8mn-board:~# grep audio\_pll[12]\_out /sys/kernel/debug/clk/clk\_summary
audio\_pll2\_out 0 0 0 361267200 0 0 50000 N
audio\_pll1\_out 1 1 0 393216000 0 0 50000 Y
This change is equivalent to adding following hardcoded values:
/\* rate mdiv pdiv sdiv kdiv \*/
PLL\_1443X\_RATE(393216000, 655, 5, 3, 23593),
PLL\_1443X\_RATE(361267200, 497, 33, 0, -16882),
Fixes: 053a4ffe2988 ("clk: imx: imx8mm: fix audio pll setting")
Cc: stable@vger.kernel.org # v5.18+
Signed-off-by: Ahmad Fatoum
Signed-off-by: Marco Felsch
Link: https://lore.kernel.org/r/20230807084744.1184791-2-m.felsch@pengutronix.de
Signed-off-by: Abel Vesa
Signed-off-by: Greg Kroah-Hartman
commit 209a26803ca26ad7c467a2b385edf9b942d5bef3
Author: Krzysztof Kozlowski
Date: Fri Jul 28 18:59:23 2023 +0200
dt-bindings: clock: xlnx,versal-clk: drop select:false
commit 172044e30b00977784269e8ab72132a48293c654 upstream.
select:false makes the schema basically ignored and not effective, which
is clearly not what we want for a device binding.
Fixes: 352546805a44 ("dt-bindings: clock: Add bindings for versal clock driver")
Cc:
Signed-off-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20230728165923.108589-1-krzysztof.kozlowski@linaro.org
Reviewed-by: Conor Dooley
Reviewed-by: Shubhrajyoti Datta
Signed-off-by: Stephen Boyd
Signed-off-by: Greg Kroah-Hartman
commit aaf5e6320a7e69ae5c19366c949e0c216a7c1d90
Author: Raag Jadav
Date: Tue Aug 22 12:53:40 2023 +0530
pinctrl: cherryview: fix address\_space\_handler() argument
commit d5301c90716a8e20bc961a348182daca00c8e8f0 upstream.
First argument of acpi\_\*\_address\_space\_handler() APIs is acpi\_handle of
the device, which is incorrectly passed in driver ->remove() path here.
Fix it by passing the appropriate argument and while at it, make both
API calls consistent using ACPI\_HANDLE().
Fixes: a0b028597d59 ("pinctrl: cherryview: Add support for GMMR GPIO opregion")
Cc: stable@vger.kernel.org
Signed-off-by: Raag Jadav
Acked-by: Mika Westerberg
Signed-off-by: Andy Shevchenko
Signed-off-by: Greg Kroah-Hartman
commit b0fd3e2b095af02030b2411f767d057c036598c3
Author: Bharath SM
Date: Wed Aug 16 19:38:45 2023 +0000
cifs: update desired access while requesting for directory lease
commit b6d44d42313baa45a81ce9b299aeee2ccf3d0ee1 upstream.
We read and cache directory contents when we get directory
lease, so we should ask for read permission to read contents
of directory.
Signed-off-by: Bharath SM
Reviewed-by: Shyam Prasad N
Cc: stable@vger.kernel.org
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 0fe7b6d676176886334875ae954d22e8bf69d8d9
Author: Helge Deller
Date: Fri Aug 25 17:46:39 2023 +0200
parisc: led: Reduce CPU overhead for disk & lan LED computation
commit 358ad816e52d4253b38c2f312e6b1cbd89e0dbf7 upstream.
Older PA-RISC machines have LEDs which show the disk- and LAN-activity.
The computation is done in software and takes quite some time, e.g. on a
J6500 this may take up to 60% time of one CPU if the machine is loaded
via network traffic.
Since most people don't care about the LEDs, start with LEDs disabled and
just show a CPU heartbeat LED. The disk and LAN LEDs can be turned on
manually via /proc/pdc/led.
Signed-off-by: Helge Deller
Cc:
Signed-off-by: Greg Kroah-Hartman
commit 81de4949593927fb98fc93a963d1ea595a202a7f
Author: Helge Deller
Date: Sun Aug 27 13:46:11 2023 +0200
parisc: led: Fix LAN receive and transmit LEDs
commit 4db89524b084f712a887256391fc19d9f66c8e55 upstream.
Fix the LAN receive and LAN transmit LEDs, which where swapped
up to now.
Signed-off-by: Helge Deller
Cc:
Signed-off-by: Greg Kroah-Hartman
commit 6599f72bed2364750e4f6f3a6f5f17ad0b3e1a0d
Author: Kalesh Singh
Date: Tue Aug 1 19:56:03 2023 -0700
Multi-gen LRU: avoid race in inc\_min\_seq()
commit bb5e7f234eacf34b65be67ebb3613e3b8cf11b87 upstream.
inc\_max\_seq() will try to inc\_min\_seq() if nr\_gens == MAX\_NR\_GENS. This
is because the generations are reused (the last oldest now empty
generation will become the next youngest generation).
inc\_min\_seq() is retried until successful, dropping the lru\_lock
and yielding the CPU on each failure, and retaking the lock before
trying again:
while (!inc\_min\_seq(lruvec, type, can\_swap)) {
spin\_unlock\_irq(&lruvec->lru\_lock);
cond\_resched();
spin\_lock\_irq(&lruvec->lru\_lock);
}
However, the initial condition that required incrementing the min\_seq
(nr\_gens == MAX\_NR\_GENS) is not retested. This can change by another
call to inc\_max\_seq() from run\_aging() with force\_scan=true from the
debugfs interface.
Since the eviction stalls when the nr\_gens == MIN\_NR\_GENS, avoid
unnecessarily incrementing the min\_seq by rechecking the number of
generations before each attempt.
This issue was uncovered in previous discussion on the list by Yu Zhao
and Aneesh Kumar [1].
[1] https://lore.kernel.org/linux-mm/CAOUHufbO7CaVm=xjEb1avDhHVvnC8pJmGyKcFf2iY\_dpf+zR3w@mail.gmail.com/
Link: https://lkml.kernel.org/r/20230802025606.346758-2-kaleshsingh@google.com
Fixes: d6c3af7d8a2b ("mm: multi-gen LRU: debugfs interface")
Signed-off-by: Kalesh Singh
Tested-by: AngeloGioacchino Del Regno  [mediatek]
Tested-by: Charan Teja Kalla
Cc: Yu Zhao
Cc: Aneesh Kumar K V
Cc: Barry Song
Cc: Brian Geffon
Cc: Jan Alexander Steffens (heftig)
Cc: Lecopzer Chen
Cc: Matthias Brugger
Cc: Oleksandr Natalenko
Cc: Qi Zheng
Cc: Steven Barrett
Cc: Suleiman Souhlal
Cc: Suren Baghdasaryan
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 16e5d74e123d71fb48b5e7d5aec4b2ecb6af3c91
Author: Andrew Donnellan
Date: Fri Jul 14 11:52:38 2023 +1000
lib/test\_meminit: allocate pages up to order MAX\_ORDER
commit efb78fa86e95832b78ca0ba60f3706788a818938 upstream.
test\_pages() tests the page allocator by calling alloc\_pages() with
different orders up to order 10.
However, different architectures and platforms support different maximum
contiguous allocation sizes. The default maximum allocation order
(MAX\_ORDER) is 10, but architectures can use CONFIG\_ARCH\_FORCE\_MAX\_ORDER
to override this. On platforms where this is less than 10, test\_meminit()
will blow up with a WARN(). This is expected, so let's not do that.
Replace the hardcoded "10" with the MAX\_ORDER macro so that we test
allocations up to the expected platform limit.
Link: https://lkml.kernel.org/r/20230714015238.47931-1-ajd@linux.ibm.com
Fixes: 5015a300a522 ("lib: introduce test\_meminit module")
Signed-off-by: Andrew Donnellan
Reviewed-by: Alexander Potapenko
Cc: Xiaoke Wang
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 6a99d82d849987450e7acf2a995d64c72c68f040
Author: Muchun Song
Date: Fri Jul 7 11:38:59 2023 +0800
mm: hugetlb\_vmemmap: fix a race between vmemmap pmd split
commit 3ce2c24cb68f228590a053d6058a5901cd31af61 upstream.
The local variable @page in \_\_split\_vmemmap\_huge\_pmd() to obtain a pmd
page without holding page\_table\_lock may possiblely get the page table
page instead of a huge pmd page.
The effect may be in set\_pte\_at() since we may pass an invalid page
struct, if set\_pte\_at() wants to access the page struct (e.g.
CONFIG\_PAGE\_TABLE\_CHECK is enabled), it may crash the kernel.
So fix it. And inline \_\_split\_vmemmap\_huge\_pmd() since it only has one
user.
Link: https://lkml.kernel.org/r/20230707033859.16148-1-songmuchun@bytedance.com
Fixes: d8d55f5616cf ("mm: sparsemem: use page table lock to protect kernel pmd operations")
Signed-off-by: Muchun Song
Cc: Mike Kravetz
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 75bb29b6c44f486e9bd048759669c205dccb2048
Author: Michal Hocko
Date: Tue Jul 4 13:52:40 2023 +0200
memcg: drop kmem.limit\_in\_bytes
commit 86327e8eb94c52eca4f93cfece2e29d1bf52acbf upstream.
kmem.limit\_in\_bytes (v1 way to limit kernel memory usage) has been
deprecated since 58056f77502f ("memcg, kmem: further deprecate
kmem.limit\_in\_bytes") merged in 5.16. We haven't heard about any serious
users since then but it seems that the mere presence of the file is
causing more harm thatn good. We (SUSE) have had several bug reports from
customers where Docker based containers started to fail because a write to
kmem.limit\_in\_bytes has failed.
This was unexpected because runc code only expects ENOENT (kmem disabled)
or EBUSY (tasks already running within cgroup). So a new error code was
unexpected and the whole container startup failed. This has been later
addressed by
https://github.com/opencontainers/runc/commit/52390d68040637dfc77f9fda6bbe70952423d380
so current Docker runtimes do not suffer from the problem anymore. There
are still older version of Docker in use and likely hard to get rid of
completely.
Address this by wiping out the file completely and effectively get back to
pre 4.5 era and CONFIG\_MEMCG\_KMEM=n configuration.
I would recommend backporting to stable trees which have picked up
58056f77502f ("memcg, kmem: further deprecate kmem.limit\_in\_bytes").
[mhocko@suse.com: restore \_KMEM switch case]
Link: https://lkml.kernel.org/r/ZKe5wxdbvPi5Cwd7@dhcp22.suse.cz
Link: https://lkml.kernel.org/r/20230704115240.14672-1-mhocko@kernel.org
Signed-off-by: Michal Hocko
Acked-by: Shakeel Butt
Acked-by: Johannes Weiner
Acked-by: Roman Gushchin
Cc: Muchun Song
Cc: Tejun Heo
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit cbf06d3e0271f3b9c7590d865acb576ce9911291
Author: Steve French
Date: Thu Aug 24 23:29:18 2023 -0500
send channel sequence number in SMB3 requests after reconnects
commit 09ee7a3bf866c0fa5ee1914d2c65958559eb5b4c upstream.
The ChannelSequence field in the SMB3 header is supposed to be
increased after reconnect to allow the server to distinguish
requests from before and after the reconnect. We had always
been setting it to zero. There are cases where incrementing
ChannelSequence on requests after network reconnects can reduce
the chance of data corruptions.
See MS-SMB2 3.2.4.1 and 3.2.7.1
Signed-off-by: Steve French
Cc: stable@vger.kernel.org # 5.16+
Signed-off-by: Greg Kroah-Hartman
commit 0286d8947a3c134b2580988141db7083348aebba
Author: Aleksey Nasibulin
Date: Wed Jul 12 03:40:17 2023 +0200
ARM: dts: BCM5301X: Extend RAM to full 256MB for Linksys EA6500 V2
commit 91994e59079dcb455783d3f9ea338eea6f671af3 upstream.
Linksys ea6500-v2 have 256MB of ram. Currently we only use 128MB.
Expand the definition to use all the available RAM.
Fixes: 03e96644d7a8 ("ARM: dts: BCM5301X: Add basic DT for Linksys EA6500 V2")
Signed-off-by: Aleksey Nasibulin
Signed-off-by: Christian Marangi
Cc: stable@vger.kernel.org
Acked-by: Rafał Miłecki
Link: https://lore.kernel.org/r/20230712014017.28123-1-ansuelsmth@gmail.com
Signed-off-by: Florian Fainelli
Signed-off-by: Greg Kroah-Hartman
commit 908f16a356230f8f9ee8d38d53472ee15edcf186
Author: Chris Paterson
Date: Fri Jun 9 23:11:36 2023 +0100
arm64: dts: renesas: rzg2l: Fix txdv-skew-psec typos
commit db67345716a52abb750ec8f76d6a5675218715f9 upstream.
It looks like txdv-skew-psec is a typo from a copy+paste. txdv-skew-psec
is not present in the PHY bindings nor is it in the driver.
Correct to txen-skew-psec which is clearly what it was meant to be.
Given that the default for txen-skew-psec is 0, and the device tree is
only trying to set it to 0 anyway, there should not be any functional
change from this fix.
Fixes: 361b0dcbd7f9 ("arm64: dts: renesas: rzg2l-smarc-som: Enable Ethernet")
Fixes: 6494e4f90503 ("arm64: dts: renesas: rzg2ul-smarc-som: Enable Ethernet on SMARC platform")
Fixes: ce0c63b6a5ef ("arm64: dts: renesas: Add initial device tree for RZ/G2LC SMARC EVK")
Cc: stable@vger.kernel.org # 6.1.y
Reported-by: Tomohiro Komagata
Signed-off-by: Chris Paterson
Reviewed-by: Geert Uytterhoeven
Link: https://lore.kernel.org/r/20230609221136.7431-1-chris.paterson2@renesas.com
Signed-off-by: Geert Uytterhoeven
Signed-off-by: Greg Kroah-Hartman
commit 6190c676fedf7a6ba2bdab662cb8600b32c5b1eb
Author: Krzysztof Kozlowski
Date: Thu Jul 20 13:53:35 2023 +0200
ARM: dts: qcom: msm8974pro-castor: correct touchscreen syna,nosleep-mode
commit 7c74379afdfee7b13f1cd8ff1ad6e0f986aec96c upstream.
There is no syna,nosleep property in Synaptics RMI4 touchscreen:
qcom-msm8974pro-sony-xperia-shinano-castor.dtb: synaptics@2c: rmi4-f01@1: 'syna,nosleep' does not match any of the regexes: 'pinctrl-[0-9]+'
Fixes: ab80661883de ("ARM: dts: qcom: msm8974: Add Sony Xperia Z2 Tablet")
Cc:
Signed-off-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20230720115335.137354-6-krzysztof.kozlowski@linaro.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 1d4e79be26748f2881fca5a4cd5a0bf3ec2c3a0d
Author: Krzysztof Kozlowski
Date: Thu Jul 20 13:53:34 2023 +0200
ARM: dts: qcom: msm8974pro-castor: correct touchscreen function names
commit 31fba16c19c45b2b3a7c23b0bfef80aed1b29050 upstream.
The node names for functions of Synaptics RMI4 touchscreen must be as
"rmi4-fXX", as required by bindings and Linux driver.
qcom-msm8974pro-sony-xperia-shinano-castor.dtb: synaptics@2c: Unevaluated properties are not allowed ('rmi-f01@1', 'rmi-f11@11' were unexpected)
Fixes: ab80661883de ("ARM: dts: qcom: msm8974: Add Sony Xperia Z2 Tablet")
Cc:
Signed-off-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20230720115335.137354-5-krzysztof.kozlowski@linaro.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 0167317a624a99dd1e861b69820efd9f9f4e6c5e
Author: Krzysztof Kozlowski
Date: Thu Jul 20 13:53:30 2023 +0200
arm64: dts: qcom: msm8953-vince: drop duplicated touschreen parent interrupt
commit b019cf7e5fbaa7d25f716cb936a9237b47156f2d upstream.
Interrupts extended already define a parent interrupt controller:
msm8953-xiaomi-vince.dtb: touchscreen@20: Unevaluated properties are not allowed ('interrupts-parent' was unexpected)
Fixes: aa17e707e04a ("arm64: dts: qcom: msm8953: Add device tree for Xiaomi Redmi 5 Plus")
Cc:
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Konrad Dybcio
Link: https://lore.kernel.org/r/20230720115335.137354-1-krzysztof.kozlowski@linaro.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit c6ffc6d40f906fd4e731772178d77f9c2653f228
Author: Krzysztof Kozlowski
Date: Thu Jul 20 13:53:33 2023 +0200
ARM: dts: qcom: msm8974pro-castor: correct inverted X of touchscreen
commit 43db69268149049540b1d2bbe8a69e59d5cb43b6 upstream.
There is no syna,f11-flip-x property, so assume intention was to use
touchscreen-inverted-x.
Fixes: ab80661883de ("ARM: dts: qcom: msm8974: Add Sony Xperia Z2 Tablet")
Cc:
Signed-off-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20230720115335.137354-4-krzysztof.kozlowski@linaro.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 0cf21057fb77b6b59273907e550caadf8c013471
Author: Johan Hovold
Date: Tue Jul 18 15:29:02 2023 +0200
clk: qcom: turingcc-qcs404: fix missing resume during probe
commit a9f71a033587c9074059132d34c74eabbe95ef26 upstream.
Drivers that enable runtime PM must make sure that the controller is
runtime resumed before accessing its registers to prevent the power
domain from being disabled.
Fixes: 892df0191b29 ("clk: qcom: Add QCS404 TuringCC")
Cc: stable@vger.kernel.org # 5.2
Cc: Bjorn Andersson
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20230718132902.21430-9-johan+linaro@kernel.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit ac47243e58daac0b9bf2861457911b1845c8dd2a
Author: Sameer Pujar
Date: Thu Jun 29 10:42:17 2023 +0530
arm64: tegra: Update AHUB clock parent and rate
commit dc6d5d85ed3a3fe566314f388bce4c71a26b1677 upstream.
I2S data sanity test failures are seen at lower AHUB clock rates
on Tegra234. The Tegra194 uses the same clock relationship for AHUB
and it is likely that similar issues would be seen. Thus update the
AHUB clock parent and rates here as well for Tegra194, Tegra186
and Tegra210.
Fixes: 177208f7b06d ("arm64: tegra: Add DT binding for AHUB components")
Cc: stable@vger.kernel.org
Signed-off-by: Sameer Pujar
Signed-off-by: Thierry Reding
Signed-off-by: Greg Kroah-Hartman
commit e983f0bfa902d1b65f99d9a3f17d6dafb2e864fd
Author: Sheetal
Date: Thu Jun 29 10:42:16 2023 +0530
arm64: tegra: Update AHUB clock parent and rate on Tegra234
commit e483fe34adab3197558b7284044c1b26f5ede20e upstream.
I2S data sanity tests fail beyond a bit clock frequency of 6.144MHz.
This happens because the AHUB clock rate is too low and it shows
9.83MHz on boot.
The maximum rate of PLLA\_OUT0 is 49.152MHz and is used to serve I/O
clocks. It is recommended that AHUB clock operates higher than this.
Thus fix this by using PLLP\_OUT0 as parent clock for AHUB instead of
PLLA\_OUT0 and fix the rate to 81.6MHz.
Fixes: dc94a94daa39 ("arm64: tegra: Add audio devices on Tegra234")
Cc: stable@vger.kernel.org
Signed-off-by: Sheetal
Signed-off-by: Sameer Pujar
Reviewed-by: Mohan Kumar D
Signed-off-by: Thierry Reding
Signed-off-by: Greg Kroah-Hartman
commit bd2a4d3c2a17e1b4f42ba01a5c99084426684392
Author: Paul Cercueil
Date: Fri Jul 14 17:37:20 2023 +0200
ARM: dts: samsung: exynos4210-i9100: Fix LCD screen's physical size
commit b3f3fc32e5ff1e848555af8616318cc667457f90 upstream.
The previous values were completely bogus, and resulted in the computed
DPI ratio being much lower than reality, causing applications and UIs to
misbehave.
The new values were measured by myself with a ruler.
Signed-off-by: Paul Cercueil
Acked-by: Sam Ravnborg
Fixes: 8620cc2f99b7 ("ARM: dts: exynos: Add devicetree file for the Galaxy S2")
Cc:  # v5.8+
Link: https://lore.kernel.org/r/20230714153720.336990-1-paul@crapouillou.net
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Greg Kroah-Hartman
commit 7c3d7b8a99801e4cfaae601cf1535231f77114d1
Author: Sheetal
Date: Thu Jun 22 17:04:09 2023 +0530
ASoC: tegra: Fix SFC conversion for few rates
commit d900d9a435ca95a386f49424f3689cd17ec201da upstream.
Sample rate conversions for rates greater than 48kHz are found to be
failing. It means x->y conversions fail when either x or y is greater
than 48kHz.
This happens because, tegra210\_sfc\_rate\_to\_idx() returns incorrect
index for rates greater than 48kHz. This actually depends on the
tegra210\_sfc\_rates[] array and it is not in sync with frequency
values of SFC TX/RX register. To be precise, 64kHz entry is missing
in above array defined in the driver. Due to this wrong index is
returned and this results in incorrect programming of coefficients.
To fix this, align the tegra210\_sfc\_rates[] array with SFC register
specification and thus add 64kHz entry to it. Also, the coefficient
table is updated to reflect that none of the conversions are supported
for 64kHz.
Fixes: b2f74ec53a6c ("ASoC: tegra: Add Tegra210 based SFC driver")
Cc: stable@vger.kernel.org
Signed-off-by: Sheetal
Reviewed-by: Mohan Kumar D
Reviewed-by: Sameer Pujar
Link: https://lore.kernel.org/r/Message-Id: <1687433656-7892-2-git-send-email-spujar@nvidia.com>
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit b0cce2c7960bce06fae80a63cc15d31ea43f00a4
Author: Thomas Zimmermann
Date: Wed Jun 21 14:53:35 2023 +0200
drm/ast: Fix DRAM init on AST2200
commit 4cfe75f0f14f044dae66ad0e6eea812d038465d9 upstream.
Fix the test for the AST2200 in the DRAM initialization. The value
in ast->chip has to be compared against an enum constant instead of
a numerical value.
This bug got introduced when the driver was first imported into the
kernel.
Signed-off-by: Thomas Zimmermann
Fixes: 312fec1405dd ("drm: Initial KMS driver for AST (ASpeed Technologies) 2000 series (v2)")
Cc: Dave Airlie
Cc: dri-devel@lists.freedesktop.org
Cc:  # v3.5+
Reviewed-by: Sui Jingfeng
Reviewed-by: Jocelyn Falempe
Tested-by: Jocelyn Falempe  # AST2600
Link: https://patchwork.freedesktop.org/patch/msgid/20230621130032.3568-2-tzimmermann@suse.de
Signed-off-by: Greg Kroah-Hartman
commit 44bc5f5c252d33623711a3bb1dac5774ceadffc1
Author: Johan Hovold
Date: Tue Jul 18 15:28:55 2023 +0200
clk: qcom: camcc-sc7180: fix async resume during probe
commit c948ff727e25297f3a703eb5349dd66aabf004e4 upstream.
To make sure that the controller is runtime resumed and its power domain
is enabled before accessing its registers during probe, the synchronous
runtime PM interface must be used.
Fixes: 8d4025943e13 ("clk: qcom: camcc-sc7180: Use runtime PM ops instead of clk ones")
Cc: stable@vger.kernel.org # 5.11
Cc: Stephen Boyd
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20230718132902.21430-2-johan+linaro@kernel.org
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 0517fc5a71333b315164736bbd32608894fbb872
Author: Thomas Zimmermann
Date: Tue Jun 13 13:06:49 2023 +0200
fbdev/ep93xx-fb: Do not assign to struct fb\_info.dev
commit f90a0e5265b60cdd3c77990e8105f79aa2fac994 upstream.
Do not assing the Linux device to struct fb\_info.dev. The call to
register\_framebuffer() initializes the field to the fbdev device.
Drivers should not override its value.
Fixes a bug where the driver incorrectly decreases the hardware
device's reference counter and leaks the fbdev device.
v2:
\* add Fixes tag (Dan)
Signed-off-by: Thomas Zimmermann
Fixes: 88017bda96a5 ("ep93xx video driver")
Cc:  # v2.6.32+
Reviewed-by: Javier Martinez Canillas
Reviewed-by: Sam Ravnborg
Link: https://patchwork.freedesktop.org/patch/msgid/20230613110953.24176-15-tzimmermann@suse.de
Signed-off-by: Greg Kroah-Hartman
commit 9566b301c1a398158f1f03b69373bf46f2af020b
Author: Ian Kent
Date: Sun Aug 6 09:26:49 2023 +0800
kernfs: fix missing kernfs\_iattr\_rwsem locking
commit 0559f63057f927d298d68294d6ff77ce09b99255 upstream.
When the kernfs\_iattr\_rwsem was introduced a case was missed.
The update of the kernfs directory node child count was also protected
by the kernfs\_rwsem and needs to be included in the change so that the
child count (and so the inode n\_link attribute) does not change while
holding the rwsem for read.
Fixes: 9caf69614225 ("kernfs: Introduce separate rwsem to protect inode attributes.")
Cc: stable
Signed-off-by: Ian Kent
Reviewed-By: Imran Khan
Acked-by: Miklos Szeredi
Cc: Anders Roxell
Cc: Arnd Bergmann
Cc: Minchan Kim
Cc: Eric Sandeen
Link: https://lore.kernel.org/r/169128520941.68052.15749253469930138901.stgit@donald.themaw.net
Signed-off-by: Greg Kroah-Hartman
commit a7cb2e709f2927cc3c76781df3e45de2381b3b9d
Author: Chengming Zhou
Date: Fri Sep 1 20:03:06 2023 +0800
null\_blk: fix poll request timeout handling
commit 5a26e45edb4690d58406178b5a9ea4c6dcf2c105 upstream.
When doing io\_uring benchmark on /dev/nullb0, it's easy to crash the
kernel if poll requests timeout triggered, as reported by David. [1]
BUG: kernel NULL pointer dereference, address: 0000000000000008
Workqueue: kblockd blk\_mq\_timeout\_work
RIP: 0010:null\_timeout\_rq+0x4e/0x91
Call Trace:
? null\_timeout\_rq+0x4e/0x91
blk\_mq\_handle\_expired+0x31/0x4b
bt\_iter+0x68/0x84
? bt\_tags\_iter+0x81/0x81
\_\_sbitmap\_for\_each\_set.constprop.0+0xb0/0xf2
? \_\_blk\_mq\_complete\_request\_remote+0xf/0xf
bt\_for\_each+0x46/0x64
? \_\_blk\_mq\_complete\_request\_remote+0xf/0xf
? percpu\_ref\_get\_many+0xc/0x2a
blk\_mq\_queue\_tag\_busy\_iter+0x14d/0x18e
blk\_mq\_timeout\_work+0x95/0x127
process\_one\_work+0x185/0x263
worker\_thread+0x1b5/0x227
This is indeed a race problem between null\_timeout\_rq() and null\_poll().
null\_poll() null\_timeout\_rq()
spin\_lock(&nq->poll\_lock)
list\_splice\_init(&nq->poll\_list, &list)
spin\_unlock(&nq->poll\_lock)
while (!list\_empty(&list))
req = list\_first\_entry()
list\_del\_init()
...
blk\_mq\_add\_to\_batch()
// req->rq\_next = NULL
spin\_lock(&nq->poll\_lock)
// rq->queuelist->next == NULL
list\_del\_init(&rq->queuelist)
spin\_unlock(&nq->poll\_lock)
Fix these problems by setting requests state to MQ\_RQ\_COMPLETE under
nq->poll\_lock protection, in which null\_timeout\_rq() can safely detect
this race and early return.
Note this patch just fix the kernel panic when request timeout happen.
[1] https://lore.kernel.org/all/3893581.1691785261@warthog.procyon.org.uk/
Fixes: 0a593fbbc245 ("null\_blk: poll queue support")
Reported-by: David Howells
Tested-by: David Howells
Reviewed-by: Ming Lei
Signed-off-by: Chengming Zhou
Link: https://lore.kernel.org/r/20230901120306.170520-2-chengming.zhou@linux.dev
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 7c059b6a6ec24fa307cd36bdb948756b82972dd2
Author: Quinn Tran
Date: Mon Aug 21 18:30:39 2023 +0530
scsi: qla2xxx: Fix firmware resource tracking
commit e370b64c7db96384a0886a09a9d80406e4c663d7 upstream.
The storage was not draining I/Os and the work load was not spread out
across different CPUs evenly. This led to firmware resource counters
getting overrun on the busy CPU. This overrun prevented error recovery from
happening in a timely manner.
By switching the counter to atomic, it allows the count to be little more
accurate to prevent the overrun.
Cc: stable@vger.kernel.org
Fixes: da7c21b72aa8 ("scsi: qla2xxx: Fix command flush during TMF")
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230821130045.34850-4-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 6c3c9b0d13e93198e18516cd981581602ff2d455
Author: Quinn Tran
Date: Mon Aug 21 18:30:41 2023 +0530
scsi: qla2xxx: Error code did not return to upper layer
commit 0ba0b018f94525a6b32f5930f980ce9b62b72e6f upstream.
TMF was returned with an error code. The error code was not preserved to be
returned to upper layer. Instead, the error code from the Marker was
returned.
Preserve error code from TMF and return it to upper layer.
Cc: stable@vger.kernel.org
Fixes: da7c21b72aa8 ("scsi: qla2xxx: Fix command flush during TMF")
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230821130045.34850-6-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit a923d44190762979025ee5bec8ed733c79cc1954
Author: Nilesh Javali
Date: Mon Aug 21 18:30:43 2023 +0530
scsi: qla2xxx: Fix smatch warn for qla\_init\_iocb\_limit()
commit b496953dd0444001b12f425ea07d78c1f47e3193 upstream.
Fix indentation for warning reported by smatch:
drivers/scsi/qla2xxx/qla\_init.c:4199 qla\_init\_iocb\_limit() warn: inconsistent indenting
Fixes: efa74a62aaa2 ("scsi: qla2xxx: Adjust IOCB resource on qpair create")
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230821130045.34850-8-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit ac67720f5475d3d88baa83f5d037994c4b853822
Author: Quinn Tran
Date: Mon Aug 21 18:30:38 2023 +0530
scsi: qla2xxx: Flush mailbox commands on chip reset
commit 6d0b65569c0a10b27c49bacd8d25bcd406003533 upstream.
Fix race condition between Interrupt thread and Chip reset thread in trying
to flush the same mailbox. With the race condition, the "ha->mbx\_intr\_comp"
will get an extra complete() call. The extra complete call create erroneous
mailbox timeout condition when the next mailbox is sent where the mailbox
call does not wait for interrupt to arrive. Instead, it advances without
waiting.
Add lock protection around the check for mailbox completion.
Cc: stable@vger.kernel.org
Fixes: b2000805a975 ("scsi: qla2xxx: Flush mailbox commands on chip reset")
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230821130045.34850-3-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 5c4246a3a054945ecaf5dfedf02e2e73b8043fea
Author: Manish Rangankar
Date: Mon Aug 21 18:30:42 2023 +0530
scsi: qla2xxx: Remove unsupported ql2xenabledif option
commit e9105c4b7a9208a21a9bda133707624f12ddabc2 upstream.
User accidently passed module parameter ql2xenabledif=1 which is
unsupported. However, driver still initialized which lead to guard tag
errors during device discovery.
Remove unsupported ql2xenabledif=1 option and validate the user input.
Cc: stable@vger.kernel.org
Signed-off-by: Manish Rangankar
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230821130045.34850-7-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 34ccae749d18141e6c34247202f30d1060e55c53
Author: Quinn Tran
Date: Fri Jul 14 12:31:02 2023 +0530
scsi: qla2xxx: Fix TMF leak through
commit 5d3148d8e8b05f084e607ac3bd55a4c317a9f934 upstream.
Task management can retry up to 5 times when FW resource becomes bottle
neck. Between the retries, there is a short sleep. Current code assumes
the chip has not reset or session has not changed.
Check for chip reset or session change before sending Task management.
Cc: stable@vger.kernel.org
Fixes: 9803fb5d2759 ("scsi: qla2xxx: Fix task management cmd failure")
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-9-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit bf464c4d0496a40ca89d1ca9e34600cc95e3f50e
Author: Quinn Tran
Date: Fri Jul 14 12:31:00 2023 +0530
scsi: qla2xxx: Fix session hang in gnl
commit 39d22740712c7563a2e18c08f033deeacdaf66e7 upstream.
Connection does not resume after a host reset / chip reset. The cause of
the blockage is due to the FCF\_ASYNC\_ACTIVE left on. The gnl command was
interrupted by the chip reset. On exiting the command, this flag should be
turn off to allow relogin to reoccur. Clear this flag to prevent blockage.
Cc: stable@vger.kernel.org
Fixes: 17e64648aa47 ("scsi: qla2xxx: Correct fcport flags handling")
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-7-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 997f10317ed4f84fb3b326acb2e1363fd33878d9
Author: Quinn Tran
Date: Fri Jul 14 12:31:01 2023 +0530
scsi: qla2xxx: Turn off noisy message log
commit 8ebaa45163a3fedc885c1dc7d43ea987a2f00a06 upstream.
Some consider noisy log as test failure. Turn off noisy message log.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-8-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 5add37906f18e9c720795da6f2dbd2b9396b6e2f
Author: Quinn Tran
Date: Fri Jul 14 12:30:59 2023 +0530
scsi: qla2xxx: Fix erroneous link up failure
commit 5b51f35d127e7bef55fa869d2465e2bca4636454 upstream.
Link up failure occurred where driver failed to see certain events from FW
indicating link up (AEN 8011) and fabric login completion (AEN 8014).
Without these 2 events, driver would not proceed forward to scan the
fabric. The cause of this is due to delay in the receive of interrupt for
Mailbox 60 that causes qla to set the fw\_started flag late. The late
setting of this flag causes other interrupts to be dropped. These dropped
interrupts happen to be the link up (AEN 8011) and fabric login completion
(AEN 8014).
Set fw\_started flag early to prevent interrupts being dropped.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-6-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit b617809d87377aba8fb2e7830d1ac240332d74c9
Author: Quinn Tran
Date: Fri Jul 14 12:30:58 2023 +0530
scsi: qla2xxx: Fix command flush during TMF
commit da7c21b72aa86e990af5f73bce6590b8d8d148d0 upstream.
For each TMF request, driver iterates through each qpair and flushes
commands associated to the TMF. At the end of the qpair flush, a Marker is
used to complete the flush transaction. This process was repeated for each
qpair. The multiple flush and marker for this TMF request seems to cause
confusion for FW.
Instead, 1 flush is sent to FW. Driver would wait for FW to go through all
the I/Os on each qpair to be read then return. Driver then closes out the
transaction with a Marker.
Cc: stable@vger.kernel.org
Fixes: d90171dd0da5 ("scsi: qla2xxx: Multi-que support for TMF")
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-5-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 8ef539cac3576a513c705986a4a299d0c2ea48a9
Author: Quinn Tran
Date: Fri Jul 14 12:31:03 2023 +0530
scsi: qla2xxx: fix inconsistent TMF timeout
commit 009e7fe4a1ed52276b332842a6b6e23b07200f2d upstream.
Different behavior were experienced of session being torn down vs not when
TMF is timed out. When FW detects the time out, the session is torn down.
When driver detects the time out, the session is not torn down.
Allow TMF error to return to upper layer without session tear down.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-10-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit b05017cb4ff75eea783583f3d400059507510ab1
Author: Quinn Tran
Date: Fri Jul 14 12:30:55 2023 +0530
scsi: qla2xxx: Fix deletion race condition
commit 6dfe4344c168c6ca20fe7640649aacfcefcccb26 upstream.
System crash when using debug kernel due to link list corruption. The cause
of the link list corruption is due to session deletion was allowed to queue
up twice. Here's the internal trace that show the same port was allowed to
double queue for deletion on different cpu.
20808683956 015 qla2xxx [0000:13:00.1]-e801:4: Scheduling sess ffff93ebf9306800 for deletion 50:06:0e:80:12:48:ff:50 fc4\_type 1
20808683957 027 qla2xxx [0000:13:00.1]-e801:4: Scheduling sess ffff93ebf9306800 for deletion 50:06:0e:80:12:48:ff:50 fc4\_type 1
Move the clearing/setting of deleted flag lock.
Cc: stable@vger.kernel.org
Fixes: 726b85487067 ("qla2xxx: Add framework for async fabric discovery")
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-2-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 69228675683e345d2dbf3be8b0ea4f24c4d60d96
Author: Quinn Tran
Date: Fri Jul 14 12:30:57 2023 +0530
scsi: qla2xxx: Limit TMF to 8 per function
commit a8ec192427e0516436e61f9ca9eb49c54eadfe0a upstream.
Per FW recommendation, 8 TMF's can be outstanding for each
function. Previously, it allowed 8 per target.
Limit TMF to 8 per function.
Cc: stable@vger.kernel.org
Fixes: 6a87679626b5 ("scsi: qla2xxx: Fix task management cmd fail due to unavailable resource")
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-4-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 0e2f41d082285c9a5788c97372088ed1f30ab02c
Author: Quinn Tran
Date: Fri Jul 14 12:30:56 2023 +0530
scsi: qla2xxx: Adjust IOCB resource on qpair create
commit efa74a62aaa2429c04fe6cb277b3bf6739747d86 upstream.
During NVMe queue creation, a new qpair is created. FW resource limit needs
to be re-adjusted to take into account the new qpair. Otherwise, NVMe
command can not go through. This issue was discovered while
testing/forcing FW execution to fail at load time.
Add call to readjust IOCB and exchange limit.
In addition, get FW state command and require FW to be running. Otherwise,
error is generated.
Cc: stable@vger.kernel.org
Signed-off-by: Quinn Tran
Signed-off-by: Nilesh Javali
Link: https://lore.kernel.org/r/20230714070104.40052-3-njavali@marvell.com
Reviewed-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit ea834e6609b82293abffe810428ee4e1881ee457
Author: Bean Huo
Date: Wed Aug 9 20:18:46 2023 +0200
scsi: ufs: core: Add advanced RPMB support where UFSHCI 4.0 does not support EHS length in UTRD
commit c91e585cfb3dd7d076e9ba0967908fc504d32def upstream.
According to UFSHCI 4.0 specification:
5.2 Host Controller Capabilities Registers
5.2.1 Offset 00h: CAP – Controller Capabilities:
"EHS Length in UTRD Supported (EHSLUTRDS): Indicates whether the host
controller supports EHS Length field in UTRD.
0 – Host controller takes EHS length from CMD UPIU, and SW driver use EHS
Length field in CMD UPIU.
1 – HW controller takes EHS length from UTRD, and SW driver use EHS
Length field in UTRD.
NOTE Recommend Host controllers move to taking EHS length from UTRD, and
in UFS-5, it will be mandatory."
So, when UFSHCI 4.0 doesn't support EHS Length field in UTRD, we could use
EHS Length field in CMD UPIU. Remove the limitation that advanced RPMB only
works when EHS length is supported in UTRD.
Fixes: 6ff265fc5ef6 ("scsi: ufs: core: bsg: Add advanced RPMB support in ufs\_bsg")
Co-developed-by: "jonghwi.rha"
Signed-off-by: "jonghwi.rha"
Signed-off-by: Bean Huo
Link: https://lore.kernel.org/r/20230809181847.102123-2-beanhuo@iokpp.de
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 4037dcd70c3335600a2a95ec6229d70859bd37a1
Author: Gurchetan Singh
Date: Fri Jul 7 14:31:24 2023 -0700
drm/virtio: Conditionally allocate virtio\_gpu\_fence
commit 70d1ace56db6c79d39dbe9c0d5244452b67e2fde upstream.
We don't want to create a fence for every command submission. It's
only necessary when userspace provides a waitable token for submission.
This could be:
1) bo\_handles, to be used with VIRTGPU\_WAIT
2) out\_fence\_fd, to be used with dma\_fence apis
3) a ring\_idx provided with VIRTGPU\_CONTEXT\_PARAM\_POLL\_RINGS\_MASK
+ DRM event API
4) syncobjs in the future
The use case for just submitting a command to the host, and expecting
no response. For example, gfxstream has GFXSTREAM\_CONTEXT\_PING that
just wakes up the host side worker threads. There's also
CROSS\_DOMAIN\_CMD\_SEND which just sends data to the Wayland server.
This prevents the need to signal the automatically created
virtio\_gpu\_fence.
In addition, VIRTGPU\_EXECBUF\_RING\_IDX is checked when creating a
DRM event object. VIRTGPU\_CONTEXT\_PARAM\_POLL\_RINGS\_MASK is
already defined in terms of per-context rings. It was theoretically
possible to create a DRM event on the global timeline (ring\_idx == 0),
if the context enabled DRM event polling. However, that wouldn't
work and userspace (Sommelier). Explicitly disallow it for
clarity.
Signed-off-by: Gurchetan Singh
Reviewed-by: Dmitry Osipenko
Tested-by: Dmitry Osipenko
Signed-off-by: Dmitry Osipenko  # edited coding style
Link: https://patchwork.freedesktop.org/patch/msgid/20230707213124.494-1-gurchetansingh@chromium.org
Signed-off-by: Alyssa Ross
Signed-off-by: Greg Kroah-Hartman
commit 23e0882db356a403ca92c467b2a7c6e0cc149fe6
Author: Quan Tian
Date: Tue Sep 5 10:36:10 2023 +0000
net/ipv6: SKB symmetric hash should incorporate transport ports
commit a5e2151ff9d5852d0ababbbcaeebd9646af9c8d9 upstream.
\_\_skb\_get\_hash\_symmetric() was added to compute a symmetric hash over
the protocol, addresses and transport ports, by commit eb70db875671
("packet: Use symmetric hash for PACKET\_FANOUT\_HASH."). It uses
flow\_keys\_dissector\_symmetric\_keys as the flow\_dissector to incorporate
IPv4 addresses, IPv6 addresses and ports. However, it should not specify
the flag as FLOW\_DISSECTOR\_F\_STOP\_AT\_FLOW\_LABEL, which stops further
dissection when an IPv6 flow label is encountered, making transport
ports not being incorporated in such case.
As a consequence, the symmetric hash is based on 5-tuple for IPv4 but
3-tuple for IPv6 when flow label is present. It caused a few problems,
e.g. when nft symhash and openvswitch l4\_sym rely on the symmetric hash
to perform load balancing as different L4 flows between two given IPv6
addresses would always get the same symmetric hash, leading to uneven
traffic distribution.
Removing the use of FLOW\_DISSECTOR\_F\_STOP\_AT\_FLOW\_LABEL makes sure the
symmetric hash is based on 5-tuple for both IPv4 and IPv6 consistently.
Fixes: eb70db875671 ("packet: Use symmetric hash for PACKET\_FANOUT\_HASH.")
Reported-by: Lars Ekman
Closes: https://github.com/antrea-io/antrea/issues/5457
Signed-off-by: Quan Tian
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman

