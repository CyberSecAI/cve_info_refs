=== Content from plugins.trac.wordpress.org_1ae558a4_20250114_204630.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2977505%2540chatbot%252Ftrunk%26old%3D2967435%2540chatbot%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2967435/chatbot/trunk?old=2977505&old_path=%2Fchatbot%2Ftrunk)

---

# Changes in [chatbot/trunk](/browser/chatbot/trunk?rev=2977505 "Show entry in browser") [[2967435:2977505]](/log/chatbot/trunk?rev=2977505&stop_rev=2967435 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[chatbot/trunk](/browser/chatbot/trunk?rev=2977505)
Files:

14 edited

* [functions.php](/browser/chatbot/trunk/functions.php?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [includes/class-wpbot-gc-download.php](/browser/chatbot/trunk/includes/class-wpbot-gc-download.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [includes/class-wpwbot-cache.php](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [includes/class-wpwbot-table.php](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [includes/openai/admin/settings.php](/browser/chatbot/trunk/includes/openai/admin/settings.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [includes/openai/qcld-bot-openai.php](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505 "Show entry in browser")
  (modified)
  ([6 diffs](#file5 "Show differences"))
* [includes/openai/qcld\_wp\_OpenAI.php](/browser/chatbot/trunk/includes/openai/qcld_wp_OpenAI.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [js/qcld-wp-chatbot-admin.js](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505 "Show entry in browser")
  (modified)
  ([8 diffs](#file7 "Show differences"))
* [js/qcld-wp-chatbot-plugin.js](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file8 "Show differences"))
* [qcld-wpwbot-search.php](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505 "Show entry in browser")
  (modified)
  ([6 diffs](#file9 "Show differences"))
* [qcld-wpwbot.php](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))
* [qcld\_df\_api.php](/browser/chatbot/trunk/qcld_df_api.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file11 "Show differences"))
* [readme.txt](/browser/chatbot/trunk/readme.txt?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file12 "Show differences"))
* [templates/app-templates/app-checkout.php](/browser/chatbot/trunk/templates/app-templates/app-checkout.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file13 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [chatbot/trunk/functions.php](/changeset/2977505/chatbot/trunk/functions.php?old=2966995&old_path=chatbot%2Ftrunk%2Ffunctions.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/functions.php")

  | [r2967435](/browser/chatbot/trunk/functions.php?rev=2966995#L1219 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/functions.php?rev=2977505#L1219 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 1219 | 1219 | die(); |
  | 1220 | 1220 | } |
  | 1221 |  | // Order Status part. |
  | 1222 |  | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_check\_user', 'qcld\_wb\_chatbot\_check\_user'); |
  | 1223 |  | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_check\_user', 'qcld\_wb\_chatbot\_check\_user'); |
  | 1224 |  | function qcld\_wb\_chatbot\_check\_user(){ |
  | 1225 |  | global $wpcommerce; |
  | 1226 |  | $user\_name = trim(sanitize\_text\_field($\_POST['user\_name'])); |
  | 1227 |  | $response = array(); |
  | 1228 |  | $response['message'] = ""; |
  | 1229 |  | if (username\_exists($user\_name)) { |
  | 1230 |  | if (get\_option('qlcd\_wp\_chatbot\_order\_user') == 'login') { |
  | 1231 |  | $response['status'] = "success"; |
  | 1232 |  | $response['message'] .= wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_username\_thanks')))); |
  | 1233 |  | $response['html'] .= '<p>' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_username\_password')))) . '</p>'; |
  | 1234 |  | } else if (get\_option('qlcd\_wp\_chatbot\_order\_user') == 'not\_login') { |
  | 1235 |  | $response = get\_order\_by\_username($user\_name); |
  | 1236 |  | } |
  | 1237 |  | } else { |
  | 1238 |  | $response['status'] = "fail"; |
  | 1239 |  | $response['message'] .= '<strong>' . $user\_name . '</strong> ' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_username\_not\_exist')))); |
  | 1240 |  | } |
  | 1241 |  | wp\_send\_json($response); |
  | 1242 |  | die(); |
  | 1243 |  | } |
  |  | 1221 | // Order Status part. removed |
  |  | 1222 |  |
  | 1244 | 1223 | function wpb\_randmom\_message\_handle($items){ |
  | 1245 | 1224 | return $items[rand(0, count($items) - 1)]; |
  | […](/browser/chatbot/trunk/functions.php?rev=2966995#L1758) | […](/browser/chatbot/trunk/functions.php?rev=2977505#L1737) |  |
  | 1758 | 1737 |  |
  | 1759 | 1738 | //User login on Checkout page. |
  | 1760 |  | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
  | 1761 |  | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
  | 1762 |  | function qcld\_wb\_chatbot\_checkout\_user\_login(){ |
  | 1763 |  | // Nonce is checked, get the POST data and sign user on |
  | 1764 |  | $info = array(); |
  | 1765 |  | //$info['nonce'] = $\_POST['nonce\_val']; |
  | 1766 |  | $info['user\_login'] = trim(sanitize\_text\_field($\_POST['user\_name'])); |
  | 1767 |  | $info['user\_password'] = trim(sanitize\_text\_field($\_POST['user\_pass'])); |
  | 1768 |  | $info['remember'] = true; |
  | 1769 |  | $user\_signon = wp\_signon($info, false); |
  | 1770 |  | // $response=$info; |
  | 1771 |  | $response = array(); |
  | 1772 |  | if (is\_wp\_error($user\_signon)) { |
  | 1773 |  | // $response['status'] = "fail"; |
  | 1774 |  | $response = "no"; |
  | 1775 |  | } else { |
  | 1776 |  | $response = "yes"; |
  | 1777 |  | } |
  | 1778 |  | wp\_send\_json($response); |
  | 1779 |  | } |
  |  | 1739 | // add\_action('wp\_ajax\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
  |  | 1740 | // add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
  |  | 1741 | // function qcld\_wb\_chatbot\_checkout\_user\_login(){ |
  |  | 1742 | //     // Nonce is checked, get the POST data and sign user on |
  |  | 1743 | //     $info = array(); |
  |  | 1744 | //     //$info['nonce'] = $\_POST['nonce\_val']; |
  |  | 1745 | //     $info['user\_login'] = trim(sanitize\_text\_field($\_POST['user\_name'])); |
  |  | 1746 | //     $info['user\_password'] = trim(sanitize\_text\_field($\_POST['user\_pass'])); |
  |  | 1747 | //     $info['remember'] = true; |
  |  | 1748 | //     $user\_signon = wp\_signon($info, false); |
  |  | 1749 | //     // $response=$info; |
  |  | 1750 | //     $response = array(); |
  |  | 1751 | //     if (is\_wp\_error($user\_signon)) { |
  |  | 1752 | //         // $response['status'] = "fail"; |
  |  | 1753 | //         $response = "no"; |
  |  | 1754 | //     } else { |
  |  | 1755 | //         $response = "yes"; |
  |  | 1756 | //     } |
  |  | 1757 | //     wp\_send\_json($response); |
  |  | 1758 | // } |
  | 1780 | 1759 | // Load template for App Order Thank You page url |
  | 1781 | 1760 | function wp\_chatbot\_load\_app\_template($template){ |
* ## [chatbot/trunk/includes/class-wpbot-gc-download.php](/changeset/2977505/chatbot/trunk/includes/class-wpbot-gc-download.php?old=2537910&old_path=chatbot%2Ftrunk%2Fincludes%2Fclass-wpbot-gc-download.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/class-wpbot-gc-download.php")

  | [r2967435](/browser/chatbot/trunk/includes/class-wpbot-gc-download.php?rev=2537910#L46 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/class-wpbot-gc-download.php?rev=2977505#L46 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 46 | 46 |  |
  | 47 | 47 | public function downloadgc(){ |
  | 48 |  | $gcdirectory = QCLD\_wpCHATBOT\_GC\_DIRNAME; |
  |  | 48 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 49 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 50 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 51 | wp\_die(); |
  | 49 | 52 |  |
  | 50 |  | if ( ! is\_dir( $gcdirectory ) ) { |
  | 51 |  | $this->create\_folder( $gcdirectory ); |
  | 52 |  | } |
  | 53 |  | if(!file\_exists($gcdirectory.'/index.php')){ |
  | 54 |  | $this->create\_file( $gcdirectory.'/index.php' ); |
  |  | 53 | }else{ |
  |  | 54 | $gcdirectory = QCLD\_wpCHATBOT\_GC\_DIRNAME; |
  |  | 55 |  |
  |  | 56 | if ( ! is\_dir( $gcdirectory ) ) { |
  |  | 57 | $this->create\_folder( $gcdirectory ); |
  |  | 58 | } |
  |  | 59 | if(!file\_exists($gcdirectory.'/index.php')){ |
  |  | 60 | $this->create\_file( $gcdirectory.'/index.php' ); |
  |  | 61 | } |
  |  | 62 |  |
  |  | 63 | if(is\_dir($gcdirectory)){ |
  |  | 64 |  |
  |  | 65 | $zipFile = $gcdirectory."/".$this->filename; // Local Zip File Path |
  |  | 66 | $zipResource = fopen($zipFile, "w"); |
  |  | 67 | // Get The Zip File From Server |
  |  | 68 | $ch = curl\_init(); |
  |  | 69 | curl\_setopt($ch, CURLOPT\_URL, $this->download\_url); |
  |  | 70 | curl\_setopt($ch, CURLOPT\_FAILONERROR, true); |
  |  | 71 | curl\_setopt($ch, CURLOPT\_HEADER, 0); |
  |  | 72 | curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, true); |
  |  | 73 | curl\_setopt($ch, CURLOPT\_AUTOREFERER, true); |
  |  | 74 | curl\_setopt($ch, CURLOPT\_BINARYTRANSFER,true); |
  |  | 75 | curl\_setopt($ch, CURLOPT\_TIMEOUT, 10); |
  |  | 76 | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 0); |
  |  | 77 | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, 0); |
  |  | 78 | curl\_setopt($ch, CURLOPT\_FILE, $zipResource); |
  |  | 79 | $page = curl\_exec($ch); |
  |  | 80 | if(!$page) { |
  |  | 81 | $response = array('status'=>'error','content'=> curl\_error($ch)); |
  |  | 82 | echo wp\_send\_json($response); |
  |  | 83 | wp\_die(); |
  |  | 84 | } |
  |  | 85 | curl\_close($ch); |
  |  | 86 | $response = array('status'=>'success','content'=> 'File downloaded successfully'); |
  |  | 87 | }else{ |
  |  | 88 | $response = array('status'=>'error','content'=> 'Server does not allow to create files and folders'); |
  |  | 89 | } |
  |  | 90 |  |
  |  | 91 | echo wp\_send\_json($response); |
  |  | 92 | wp\_die(); |
  | 55 | 93 | } |
  | 56 |  |  |
  | 57 |  | ~~if(is\_dir($gcdirectory)){~~ |
  | 58 |  |  |
  | 59 |  | ~~$zipFile = $gcdirectory."/".$this->filename; // Local Zip File Path~~ |
  | 60 |  | ~~$zipResource = fopen($zipFile, "w");~~ |
  | 61 |  | ~~// Get The Zip File From Server~~ |
  | 62 |  | ~~$ch = curl\_init();~~ |
  | 63 |  | ~~curl\_setopt($ch, CURLOPT\_URL, $this->download\_url);~~ |
  | 64 |  | ~~curl\_setopt($ch, CURLOPT\_FAILONERROR, true);~~ |
  | 65 |  | ~~curl\_setopt($ch, CURLOPT\_HEADER, 0);~~ |
  | 66 |  | ~~curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, true);~~ |
  | 67 |  | ~~curl\_setopt($ch, CURLOPT\_AUTOREFERER, true);~~ |
  | 68 |  | ~~curl\_setopt($ch, CURLOPT\_BINARYTRANSFER,true);~~ |
  | 69 |  | ~~curl\_setopt($ch, CURLOPT\_TIMEOUT, 10);~~ |
  | 70 |  | ~~curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 0);~~ |
  | 71 |  | ~~curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, 0);~~ |
  | 72 |  | ~~curl\_setopt($ch, CURLOPT\_FILE, $zipResource);~~ |
  | 73 |  | ~~$page = curl\_exec($ch);~~ |
  | 74 |  | ~~if(!$page) {~~ |
  | 75 |  | ~~$response = array('status'=>'error','content'=> curl\_error($ch));~~ |
  | 76 |  | ~~echo wp\_send\_json($response);~~ |
  | 77 |  | ~~wp\_die();~~ |
  | 78 |  | ~~}~~ |
  | 79 |  | ~~curl\_close($ch);~~ |
  | 80 |  | ~~$response = array('status'=>'success','content'=> 'File downloaded successfully');~~ |
  | 81 |  | ~~}else{~~ |
  | 82 |  | ~~$response = array('status'=>'error','content'=> 'Server does not allow to create files and folders');~~ |
  | 83 |  | ~~}~~ |
  | 84 |  |  |
  | 85 |  | ~~echo wp\_send\_json($response);~~ |
  | 86 |  | ~~wp\_die();~~ |
  | 87 | 94 | } |
  | 88 | 95 |  |
  | 89 | 96 | function extractgc(){ |
  | 90 |  | $gcdirectory = QCLD\_wpCHATBOT\_GC\_DIRNAME; |
  | 91 |  | $gcfilename = QCLD\_wpCHATBOT\_GC\_DIRNAME.'/'.$this->filename; |
  | 92 |  | /\* Open the Zip file \*/ |
  | 93 |  | $zip = new ZipArchive; |
  | 94 |  | $extractPath = "path\_to\_extract"; |
  | 95 |  | if($zip->open($gcfilename) != "true"){ |
  | 96 |  | $response = array('status'=>'error','content'=> 'File Not Found!'); |
  |  | 97 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 98 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 99 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 100 | wp\_die(); |
  |  | 101 |  |
  |  | 102 | }else{ |
  |  | 103 | $gcdirectory = QCLD\_wpCHATBOT\_GC\_DIRNAME; |
  |  | 104 | $gcfilename = QCLD\_wpCHATBOT\_GC\_DIRNAME.'/'.$this->filename; |
  |  | 105 | /\* Open the Zip file \*/ |
  |  | 106 | $zip = new ZipArchive; |
  |  | 107 | $extractPath = "path\_to\_extract"; |
  |  | 108 | if($zip->open($gcfilename) != "true"){ |
  |  | 109 | $response = array('status'=>'error','content'=> 'File Not Found!'); |
  |  | 110 | echo wp\_send\_json($response); |
  |  | 111 | wp\_die(); |
  |  | 112 | } |
  |  | 113 | /\* Extract Zip File \*/ |
  |  | 114 | $zip->extractTo($gcdirectory); |
  |  | 115 | $zip->close(); |
  |  | 116 | @unlink($gcfilename); |
  |  | 117 | $response = array('status'=>'success','content'=> 'Files Extracted successfully!'); |
  | 97 | 118 | echo wp\_send\_json($response); |
  | 98 | 119 | wp\_die(); |
  | 99 |  | } |
  | 100 |  | /\* Extract Zip File \*/ |
  | 101 |  | $zip->extractTo($gcdirectory); |
  | 102 |  | $zip->close(); |
  | 103 |  | @unlink($gcfilename); |
  | 104 |  | $response = array('status'=>'success','content'=> 'Files Extracted successfully!'); |
  | 105 |  | echo wp\_send\_json($response); |
  | 106 |  | wp\_die(); |
  | 107 |  |  |
  |  | 120 | } |
  | 108 | 121 | } |
  | 109 | 122 | } |
* ## [chatbot/trunk/includes/class-wpwbot-cache.php](/changeset/2977505/chatbot/trunk/includes/class-wpwbot-cache.php?old=1933241&old_path=chatbot%2Ftrunk%2Fincludes%2Fclass-wpwbot-cache.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/class-wpwbot-cache.php")

  | [r2967435](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=1933241#L35 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=2977505#L35 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 35 | 35 | global $wpdb; |
  | 36 | 36 | $this->cache\_table\_name = $wpdb->prefix . QCLD\_wpCHATBOT\_CACHE\_TABLE; |
  | 37 |  | ~~add\_action( 'aws\_cache\_clear', array( $this, 'clear\_cache' ) );~~ |
  | 38 |  | ~~add\_action( 'wp\_ajax\_aws-clear-cache', array( $this, 'clear\_cache' ) );~~ |
  | 39 | 37 | } |
  | 40 | 38 | /\*\* |
  | […](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=1933241#L116) | […](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=2977505#L114) |  |
  | 116 | 114 | return $result; |
  | 117 | 115 | } |
  | 118 |  | /\* |
  | 119 |  | \* Clear cached terms |
  | 120 |  | \*/ |
  | 121 |  | public function clear\_cache() { |
  | 122 |  | global $wpdb; |
  | 123 |  | if ( ! $this->is\_cache\_table\_not\_exist() ) { |
  | 124 |  |  |
  | 125 |  | $terms = "aws\_search\_term\_%"; |
  | 126 |  | $where = $wpdb->prepare( " name LIKE %s", $terms ); |
  | 127 |  | $sql = "DELETE FROM {$this->cache\_table\_name} |
  | 128 |  | WHERE {$where} |
  | 129 |  | "; |
  | 130 |  | $wpdb->query( $sql ); |
  | 131 |  |  |
  | 132 |  | } |
  | 133 |  |  |
  | 134 |  | } |
  |  | 116 |  |
  | 135 | 117 | } |
  | 136 | 118 | endif; |
* ## [chatbot/trunk/includes/class-wpwbot-table.php](/changeset/2977505/chatbot/trunk/includes/class-wpwbot-table.php?old=2177045&old_path=chatbot%2Ftrunk%2Fincludes%2Fclass-wpwbot-table.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/class-wpwbot-table.php")

  | [r2967435](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2177045#L34 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2977505#L34 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 | \* Reindex plugin table |
  | 35 | 35 | \*/ |
  | 36 |  | public function reindex\_table( $return = false ) { |
  | 37 |  | global $wpdb; |
  | 38 |  | $index\_meta = get\_option( 'wp\_chatbot\_index\_meta', false ); |
  | 39 |  | $status = false; |
  | 40 |  | // No current index going on. Let's start over |
  | 41 |  | if ( false === $index\_meta ) { |
  | 42 |  | $status = 'start'; |
  | 43 |  | $index\_meta = array( |
  | 44 |  | 'offset' => 0, |
  | 45 |  | 'start' => true, |
  |  | 36 | public function reindex\_table( $return) { |
  |  | 37 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 38 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 39 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 40 | wp\_die(); |
  |  | 41 |  |
  |  | 42 | }else{ |
  |  | 43 | global $wpdb; |
  |  | 44 | $index\_meta = get\_option( 'wp\_chatbot\_index\_meta', false ); |
  |  | 45 | $status = false; |
  |  | 46 | // No current index going on. Let's start over |
  |  | 47 | if ( false === $index\_meta ) { |
  |  | 48 | $status = 'start'; |
  |  | 49 | $index\_meta = array( |
  |  | 50 | 'offset' => 0, |
  |  | 51 | 'start' => true, |
  |  | 52 | ); |
  |  | 53 | $wpdb->query("DROP TABLE IF EXISTS {$this->table\_name}"); |
  |  | 54 | $this->create\_table(); |
  |  | 55 | $index\_meta['found\_posts'] = $this->get\_number\_of\_products(); |
  |  | 56 | } else if ( ! empty( $index\_meta['site\_stack'] ) && $index\_meta['offset'] >= $index\_meta['found\_posts'] ) { |
  |  | 57 | $status = 'start'; |
  |  | 58 | $index\_meta['start'] = true; |
  |  | 59 | $index\_meta['offset'] = 0; |
  |  | 60 | $index\_meta['current\_site'] = array\_shift( $index\_meta['site\_stack'] ); |
  |  | 61 | } else { |
  |  | 62 | $index\_meta['start'] = false; |
  |  | 63 | } |
  |  | 64 | $index\_meta = apply\_filters( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  |  | 65 | $posts\_per\_page = apply\_filters( 'wp\_chatbot\_index\_posts\_per\_page', 30 ); |
  |  | 66 | $args = array( |
  |  | 67 | 'posts\_per\_page'      => $posts\_per\_page, |
  |  | 68 | 'fields'              => 'ids', |
  |  | 69 | 'post\_type'           => 'product', |
  |  | 70 | 'post\_status'         => 'publish', |
  |  | 71 | 'offset'              => $index\_meta['offset'], |
  |  | 72 | 'ignore\_sticky\_posts' => true, |
  |  | 73 | 'suppress\_filters'    => true, |
  |  | 74 | 'no\_found\_rows'       => 1, |
  |  | 75 | 'orderby'             => 'ID', |
  |  | 76 | 'order'               => 'DESC', |
  | 46 | 77 | ); |
  | 47 |  | $wpdb->query("DROP TABLE IF EXISTS {$this->table\_name}"); |
  | 48 |  | $this->create\_table(); |
  | 49 |  | $index\_meta['found\_posts'] = $this->get\_number\_of\_products(); |
  | 50 |  | } else if ( ! empty( $index\_meta['site\_stack'] ) && $index\_meta['offset'] >= $index\_meta['found\_posts'] ) { |
  | 51 |  | $status = 'start'; |
  | 52 |  | $index\_meta['start'] = true; |
  | 53 |  | $index\_meta['offset'] = 0; |
  | 54 |  | $index\_meta['current\_site'] = array\_shift( $index\_meta['site\_stack'] ); |
  | 55 |  | } else { |
  | 56 |  | $index\_meta['start'] = false; |
  | 57 |  | } |
  | 58 |  | $index\_meta = apply\_filters( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  | 59 |  | $posts\_per\_page = apply\_filters( 'wp\_chatbot\_index\_posts\_per\_page', 30 ); |
  | 60 |  | $args = array( |
  | 61 |  | 'posts\_per\_page'      => $posts\_per\_page, |
  | 62 |  | 'fields'              => 'ids', |
  | 63 |  | 'post\_type'           => 'product', |
  | 64 |  | 'post\_status'         => 'publish', |
  | 65 |  | 'offset'              => $index\_meta['offset'], |
  | 66 |  | 'ignore\_sticky\_posts' => true, |
  | 67 |  | 'suppress\_filters'    => true, |
  | 68 |  | 'no\_found\_rows'       => 1, |
  | 69 |  | 'orderby'             => 'ID', |
  | 70 |  | 'order'               => 'DESC', |
  | 71 |  | ); |
  | 72 |  | $posts = get\_posts( $args ); |
  | 73 |  | if ( $status !== 'start' ) { |
  | 74 |  | if ( $posts && count( $posts ) > 0 ) { |
  | 75 |  | $queued\_posts = array(); |
  | 76 |  | foreach( $posts as $post\_id ) { |
  | 77 |  | $queued\_posts[] = absint( $post\_id ); |
  |  | 78 | $posts = get\_posts( $args ); |
  |  | 79 | if ( $status !== 'start' ) { |
  |  | 80 | if ( $posts && count( $posts ) > 0 ) { |
  |  | 81 | $queued\_posts = array(); |
  |  | 82 | foreach( $posts as $post\_id ) { |
  |  | 83 | $queued\_posts[] = absint( $post\_id ); |
  |  | 84 | } |
  |  | 85 | $this->fill\_table( $queued\_posts ); |
  |  | 86 | $index\_meta['offset'] = absint( $index\_meta['offset'] + $posts\_per\_page ); |
  |  | 87 | if ( $index\_meta['offset'] >= $index\_meta['found\_posts'] ) { |
  |  | 88 | $index\_meta['offset'] = $index\_meta['found\_posts']; |
  |  | 89 | } |
  |  | 90 | update\_option( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  |  | 91 | } else { |
  |  | 92 | // We are done (with this site) |
  |  | 93 | $index\_meta['offset'] = (int) count( $posts ); |
  |  | 94 | delete\_option( 'wp\_chatbot\_index\_meta' ); |
  |  | 95 | update\_option( 'wp\_chatbot\_index\_count', 1 ); |
  | 78 | 96 | } |
  | 79 |  | $this->fill\_table( $queued\_posts ); |
  | 80 |  | $index\_meta['offset'] = absint( $index\_meta['offset'] + $posts\_per\_page ); |
  | 81 |  | if ( $index\_meta['offset'] >= $index\_meta['found\_posts'] ) { |
  | 82 |  | $index\_meta['offset'] = $index\_meta['found\_posts']; |
  | 83 |  | } |
  |  | 97 | } else { |
  | 84 | 98 | update\_option( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  |  | 99 | } |
  |  | 100 | if ( $return ) { |
  |  | 101 | return $index\_meta; |
  | 85 | 102 | } else { |
  | 86 |  | // We are done (with this site) |
  | 87 |  | $index\_meta['offset'] = (int) count( $posts ); |
  | 88 |  | delete\_option( 'wp\_chatbot\_index\_meta' ); |
  | 89 |  | update\_option( 'wp\_chatbot\_index\_count', 1 ); |
  | 90 |  | } |
  | 91 |  | } else { |
  | 92 |  | update\_option( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  | 93 |  | } |
  | 94 |  | if ( $return ) { |
  | 95 |  | return $index\_meta; |
  | 96 |  | } else { |
  | 97 |  | wp\_send\_json\_success( $index\_meta ); |
  |  | 103 | wp\_send\_json\_success( $index\_meta ); |
  |  | 104 | } |
  | 98 | 105 | } |
  | 99 | 106 | } |
  | […](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2177045#L243) | […](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2977505#L250) |  |
  | 243 | 250 | \*/ |
  | 244 | 251 | public function cancel\_reindex() { |
  | 245 |  | delete\_option( 'wp\_chatbot\_index\_meta' ); |
  | 246 |  | wp\_send\_json\_success( 'Deleted!' ); |
  |  | 252 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 253 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 254 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 255 | wp\_die(); |
  |  | 256 |  |
  |  | 257 | }else{ |
  |  | 258 | delete\_option( 'wp\_chatbot\_index\_meta' ); |
  |  | 259 | wp\_send\_json\_success( 'Deleted!' ); |
  |  | 260 | } |
  | 247 | 261 | } |
  | 248 | 262 | /\* |
* ## [chatbot/trunk/includes/openai/admin/settings.php](/changeset/2977505/chatbot/trunk/includes/openai/admin/settings.php?old=2967435&old_path=chatbot%2Ftrunk%2Fincludes%2Fopenai%2Fadmin%2Fsettings.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/openai/admin/settings.php")

  | [r2967435](/browser/chatbot/trunk/includes/openai/admin/settings.php?rev=2967435#L72 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/openai/admin/settings.php?rev=2977505#L72 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 72 | 72 | </div> |
  | 73 | 73 | </div> |
  | 74 |  | <div class="<?php esc\_attr\_e( 'mb-3','wpbot');?>"> |
  | 75 |  | <div class=""> |
  | 76 |  | <label><?php esc\_html\_e('Conversation continuity Only works in promt Q/A, Chat and friend chat'); ?></label> |
  | 77 |  | </div> |
  | 78 |  | <div class="<?php esc\_attr\_e( 'form-check form-switch my-4','wpbot');?>"> |
  | 79 |  | <input class="<?php esc\_attr\_e( 'form-check-input','wpbot');?>" type="checkbox" <?php echo (get\_option( 'conversation\_continuity') == 1) ? esc\_attr( 'checked') : '';?>  role="switch" value="" id="<?php esc\_attr\_e( 'conversation\_continuity','wpbot');?>"> |
  | 80 |  | <label class="<?php esc\_attr\_e( 'form-check-label','wpbot');?>" for="<?php esc\_attr\_e( 'conversation\_continuity','wpbot');?>"><?php esc\_html\_e( 'Enable conversation continuity','wpbot');  ?></label> |
  | 81 |  | </div> |
  | 82 |  | </div> |
  |  | 74 |  |
  | 83 | 75 |  |
  | 84 | 76 | <div class="<?php esc\_attr\_e( 'mb-3','wpbot');?>"> |
* ## [chatbot/trunk/includes/openai/qcld-bot-openai.php](/changeset/2977505/chatbot/trunk/includes/openai/qcld-bot-openai.php?old=2957286&old_path=chatbot%2Ftrunk%2Fincludes%2Fopenai%2Fqcld-bot-openai.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/openai/qcld-bot-openai.php")

  | [r2967435](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L61 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L61 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 61 | 61 | $this->includes(); |
  | 62 | 62 | add\_action('wp\_ajax\_openai\_settings\_option', [$this, 'openai\_settings\_option\_callback']); |
  | 63 |  | ~~add\_action('wp\_ajax\_openai\_file\_upload', [$this, 'openai\_file\_upload\_callback']);~~ |
  | 64 | 63 | add\_action('wp\_ajax\_openai\_response',[$this,'openai\_response\_callback']); |
  | 65 |  | ~~add\_action('wp\_ajax\_openai\_file\_list',[$this,'openai\_file\_list\_callback']);~~ |
  | 66 |  | ~~add\_action('wp\_ajax\_openai\_finetune\_list', [$this,'openai\_finetune\_list']);~~ |
  | 67 |  | ~~add\_action('wp\_ajax\_openai\_file\_delete',[$this,'openai\_file\_delete\_callback']);~~ |
  | 68 | 64 | add\_action('wp\_ajax\_nopriv\_openai\_response', [$this, 'openai\_response\_callback']); |
  | 69 |  | ~~add\_action('wp\_ajax\_openai\_ft\_model\_create', [$this, 'openai\_ft\_model\_create']);~~ |
  | 70 |  | ~~add\_action('wp\_ajax\_openai\_ft\_model\_delete', [$this, 'openai\_ft\_model\_delete']);~~ |
  | 71 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_post\_data\_converter\_count', [$this,'qcld\_openai\_post\_data\_converter\_count']);~~ |
  | 72 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_post\_data\_converter', [$this,'qcld\_openai\_post\_data\_converter']);~~ |
  | 73 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_upload\_pagetraining\_file',[$this, 'qcld\_openai\_upload\_pagetraining\_file']);~~ |
  | 74 | 65 | add\_action('wp\_ajax\_qcld\_openai\_image\_generate',[$this, 'qcld\_openai\_image\_generate']); |
  | 75 | 66 | add\_action('wp\_ajax\_openai\_keyword\_suggestion\_content',[$this,'openai\_keyword\_suggestion\_content']); |
  | 76 | 67 | add\_action('wp\_ajax\_qcld\_openai\_image\_generate\_url',[$this,'qcld\_seo\_image\_generate\_url\_functions']); |
  | 77 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_file\_dowload',[$this,'qcld\_openai\_file\_dowload']);~~ |
  | 78 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_delete\_training\_file',[$this,'qcld\_openai\_delete\_training\_file']);~~ |
  | 79 | 68 |  |
  | 80 | 69 | if (is\_admin() && !empty($\_GET["page"]) && (($\_GET["page"] == "openai-panel\_dashboard") || ($\_GET["page"] == "openai-panel\_file") || ($\_GET["page"] == "openai-panel\_help"))) { |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L141) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L130) |  |
  | 141 | 130 |  |
  | 142 | 131 | } |
  | 143 |  | public function openai\_file\_delete\_callback(){ |
  | 144 |  | $file\_id = sanitize\_text\_field($\_POST['file\_id']); |
  | 145 |  | $url = 'https://api.openai.com/v1/files/'. $file\_id; |
  | 146 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 147 |  | $ch = curl\_init(); |
  | 148 |  | curl\_setopt($ch, CURLOPT\_URL, $url); |
  | 149 |  | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
  | 150 |  | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'DELETE'); |
  | 151 |  | $headers = array( |
  | 152 |  | $apt\_key, |
  | 153 |  | ); |
  | 154 |  | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
  | 155 |  | $result = curl\_exec($ch); |
  | 156 |  | if (curl\_errno($ch)) { |
  | 157 |  | echo 'Error:' . curl\_error($ch); |
  | 158 |  | } |
  | 159 |  | curl\_close($ch); |
  | 160 |  | wp\_send\_json( json\_decode($result)); |
  | 161 |  | wp\_die(); |
  | 162 |  | } |
  | 163 |  | public function openai\_ft\_model\_create(){ |
  | 164 |  | $file\_id = sanitize\_text\_field($\_POST['file\_id']); |
  | 165 |  | $ft\_suffix = sanitize\_text\_field($\_POST['ft\_suffix']); |
  | 166 |  | $ft\_engines = sanitize\_text\_field($\_POST['ft\_engines']); |
  | 167 |  | $rel = $this->openai\_finetune\_create($file\_id,$ft\_suffix,$ft\_engines); |
  | 168 |  | // print\_r(wp\_send\_json([$rel]));wp\_die(); |
  | 169 |  | echo wp\_send\_json([$rel]); |
  | 170 |  | wp\_die(); |
  | 171 |  | } |
  | 172 |  | public function qcld\_openai\_file\_dowload(){ |
  | 173 |  |  |
  | 174 |  | //   -H "Authorization: Bearer $OPENAI\_API\_KEY" > results.csv |
  | 175 |  |  |
  | 176 |  | $file\_id = sanitize\_text\_field($\_POST['file\_id']); |
  | 177 |  | $url =  'https://api.openai.com/v1/files/'.$file\_id; |
  | 178 |  | $url1 =  'https://api.openai.com/v1/files/'.$file\_id. '/content'; |
  | 179 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 180 |  | $headers = array( |
  | 181 |  | "Content-Type: application/json", |
  | 182 |  | $apt\_key, |
  | 183 |  | ); |
  | 184 |  | $headers1 = array( |
  | 185 |  | "Content-Type:  file.jsonl", |
  | 186 |  | $apt\_key, |
  | 187 |  | ); |
  | 188 |  | $curl = curl\_init(); |
  | 189 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 190 |  | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  | 191 |  | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  | 192 |  | $result = json\_decode(curl\_exec($curl)); |
  | 193 |  | curl\_close($curl); |
  | 194 |  | $ch = curl\_init(); |
  | 195 |  | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
  | 196 |  | curl\_setopt($ch, CURLOPT\_URL, $url1); |
  | 197 |  | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
  | 198 |  | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'GET'); |
  | 199 |  | //curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  | 200 |  | $res = curl\_exec($ch); |
  | 201 |  | if (curl\_errno($ch)) { |
  | 202 |  | echo 'Error:' . curl\_error($ch); |
  | 203 |  | } |
  | 204 |  | curl\_close($ch); |
  | 205 |  | //  var\_dump($res); |
  | 206 |  | if(!empty($result)){ |
  | 207 |  | $response['status'] = 'success'; |
  | 208 |  | $response['fileinfo'] =  $result; |
  | 209 |  | $response['filedata'] = $res; |
  | 210 |  |  |
  | 211 |  | } |
  | 212 |  | echo wp\_send\_json([$response]); |
  | 213 |  | wp\_die(); |
  | 214 |  |  |
  | 215 |  | } |
  |  | 132 |  |
  | 216 | 133 | public function buildFormBody( $fields, $boundary ) |
  | 217 | 134 | { |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L235) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L152) |  |
  | 235 | 152 | } |
  | 236 | 153 |  |
  | 237 |  | ~~public function openai\_file\_list\_callback(){~~ |
  | 238 |  | ~~$url = 'https://api.openai.com/v1/files';~~ |
  | 239 |  | ~~$apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key');~~ |
  | 240 |  | ~~$curl = curl\_init();~~ |
  | 241 |  | ~~curl\_setopt($curl, CURLOPT\_URL, $url);~~ |
  | 242 |  | ~~$headers = array(~~ |
  | 243 |  | ~~"Content-Type: application/json",~~ |
  | 244 |  | ~~$apt\_key,~~ |
  | 245 |  | ~~);~~ |
  | 246 |  | ~~curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers);~~ |
  | 247 |  | ~~curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true);~~ |
  | 248 |  | ~~$response = curl\_exec($curl);~~ |
  | 249 |  | ~~curl\_close($curl);~~ |
  | 250 |  | ~~wp\_send\_json( json\_decode($response));~~ |
  | 251 |  | ~~wp\_die();~~ |
  | 252 |  | ~~}~~ |
  | 253 | 154 | public function qcld\_sanitize\_text\_or\_array\_field($array\_or\_string) { |
  | 254 | 155 | if( is\_string($array\_or\_string) ){ |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L267) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L168) |  |
  | 267 | 168 | return $array\_or\_string; |
  | 268 | 169 | } |
  | 269 |  | public function qcld\_openai\_post\_data\_converter\_count() |
  | 270 |  | { |
  | 271 |  | global $wpdb; |
  | 272 |  | $qcldopenai\_result = array('status' => 'error'); |
  | 273 |  | if(isset($\_POST['data']) && is\_array($\_POST['data'])){ |
  | 274 |  | $types = Self::qcld\_sanitize\_text\_or\_array\_field($\_POST['data']); |
  | 275 |  | $sql = "SELECT COUNT(\*) FROM ".$wpdb->posts." WHERE post\_status='publish' AND post\_type IN ('".implode("','",$types)."')"; |
  | 276 |  | $qcldopenai\_result['count'] = $wpdb->get\_var($sql); |
  | 277 |  | $qcldopenai\_result['status'] = 'success'; |
  | 278 |  | $qcldopenai\_result['types'] = $types; |
  | 279 |  | } |
  | 280 |  | else $qcldopenai\_result['msg'] = 'Please select least one data to convert'; |
  | 281 |  |  |
  | 282 |  | $this->qcld\_openai\_post\_data\_converter($qcldopenai\_result); |
  | 283 |  | } |
  | 284 |  |  |
  | 285 |  | public function qcld\_openai\_post\_data\_converter($result) |
  | 286 |  | { |
  | 287 |  | $qcldopenai\_result = array('status' => 'error','msg' => 'Something went wrong'); |
  | 288 |  | global $wpdb; |
  | 289 |  | if( |
  | 290 |  | isset($result['types']) |
  | 291 |  | && is\_array($result['types']) |
  | 292 |  | ){ |
  | 293 |  | $types = Self::qcld\_sanitize\_text\_or\_array\_field($result['types']); |
  | 294 |  |  |
  | 295 |  | $qcldopenai\_total = sanitize\_text\_field($\_POST['total']); |
  | 296 |  | $qcldopenai\_per\_page = sanitize\_text\_field($\_POST['per\_page']); |
  | 297 |  | $qcldopenai\_page = isset($\_POST['page']) && !empty($\_POST['page']) ? sanitize\_text\_field($\_POST['page']) : 1; |
  | 298 |  | if(isset($\_POST['file']) && !empty($\_POST['file'])){ |
  | 299 |  | $qcldopenai\_file = sanitize\_text\_field($\_POST['file']); |
  | 300 |  | }else{ |
  | 301 |  | $qcldopenai\_file = md5(time()).'.jsonl'; |
  | 302 |  | } |
  | 303 |  | if(isset($\_POST['id']) && !empty($\_POST['id'])){ |
  | 304 |  | $qcldopenai\_convert\_id = sanitize\_text\_field($\_POST['id']); |
  | 305 |  | }else{ |
  | 306 |  | $qcldopenai\_convert\_id = wp\_insert\_post(array( |
  | 307 |  | 'post\_title' => $qcldopenai\_file, |
  | 308 |  | 'post\_type' => 'qcldopenai\_convert', |
  | 309 |  | 'post\_status' => 'publish' |
  | 310 |  | )); |
  | 311 |  | } try { |
  | 312 |  | $upload  = wp\_upload\_dir(); |
  | 313 |  | $upload\_dir = $upload['basedir'] . '/' . 'qcldopenai\_site\_training'; |
  | 314 |  | $permissions = 0755; |
  | 315 |  | $oldmask = umask(0); |
  | 316 |  | if (!is\_dir($upload\_dir)){ |
  | 317 |  | mkdir($upload\_dir, $permissions); |
  | 318 |  | $umask = umask($oldmask); |
  | 319 |  | $chmod = chmod($upload\_dir, $permissions); |
  | 320 |  | } |
  | 321 |  | $gcdirpath = WP\_CONTENT\_DIR.'/qcldopenai\_site\_training'; |
  | 322 |  | $qcldopenai\_json\_file = fopen(wp\_upload\_dir()['basedir'] .'/qcldopenai\_site\_training/'.basename($qcldopenai\_file), "w"); |
  | 323 |  | $qcldopenai\_content = ''; |
  | 324 |  | $sql = "SELECT post\_title, post\_content FROM ".$wpdb->posts." WHERE post\_status='publish' AND post\_type IN ('".implode("','",$types)."') ORDER BY post\_date"; |
  | 325 |  | $qcldopenai\_data = $wpdb->get\_results($sql); |
  | 326 |  | if($qcldopenai\_data && is\_array($qcldopenai\_data) && count($qcldopenai\_data)){ |
  | 327 |  | foreach($qcldopenai\_data as $item){ |
  | 328 |  | $tag\_less\_content =  wp\_strip\_all\_tags($item->post\_content); |
  | 329 |  | $vc\_tag\_less = preg\_replace("/\[(\/\*)?vc\_(.\*?)\]/", '', $tag\_less\_content); |
  | 330 |  | $clean\_html\_body = preg\_replace('/\xc2\xa0/', '', $vc\_tag\_less); |
  | 331 |  | $completion\_string = str\_replace(array("\n","\r","\t","&nbsp;"), ' ', $clean\_html\_body); |
  | 332 |  | $completion\_string = wp\_trim\_words( $completion\_string,500); |
  | 333 |  |  |
  | 334 |  | $tag\_less\_title =  wp\_strip\_all\_tags($item->post\_title); |
  | 335 |  | $clean\_html\_title = preg\_replace('/\xc2\xa0/', '', $tag\_less\_title); |
  | 336 |  | $title\_string = str\_replace(array("\n","\r","\t","&nbsp;"), ' ', $clean\_html\_title); |
  | 337 |  | $title\_string = wp\_trim\_words( $title\_string,50); |
  | 338 |  | $data = array( |
  | 339 |  | "prompt" => $title\_string.' ->', |
  | 340 |  | "completion" => $completion\_string |
  | 341 |  | ); |
  | 342 |  | fwrite($qcldopenai\_json\_file, json\_encode($data) . PHP\_EOL); |
  |  | 170 |  |
  |  | 171 |  |
  |  | 172 |  |
  |  | 173 | public function qcld\_openai\_image\_generate(){ |
  |  | 174 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 175 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 176 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 177 | wp\_die(); |
  |  | 178 |  |
  |  | 179 | }else{ |
  |  | 180 | $qcld\_seo\_result = array( |
  |  | 181 | 'status' => 'error', |
  |  | 182 | 'msg'    => 'Something went wrong', |
  |  | 183 | ); |
  |  | 184 | $OPENAI\_API\_KEY = get\_option('open\_ai\_api\_key'); |
  |  | 185 | $qcld\_seo\_prompt                = isset( $\_POST['qcld\_seo\_prompt'] )                ? sanitize\_text\_field( $\_POST['qcld\_seo\_prompt'] )              : ''; |
  |  | 186 | $qcld\_seo\_artist                = isset( $\_POST['qcld\_seo\_artist'] )                ? sanitize\_text\_field( $\_POST['qcld\_seo\_artist'] )              : 'Painter'; |
  |  | 187 | $qcld\_seo\_art\_style             = isset( $\_POST['qcld\_seo\_art\_style'] )             ? sanitize\_text\_field( $\_POST['qcld\_seo\_art\_style'] )           : 'Style'; |
  |  | 188 | $qcld\_seo\_photography\_style     = isset( $\_POST['qcld\_seo\_photography\_style'] )     ? sanitize\_text\_field( $\_POST['qcld\_seo\_photography\_style'] )   : 'Photography Style'; |
  |  | 189 | $qcld\_seo\_lighting              = isset( $\_POST['qcld\_seo\_lighting'] )              ? sanitize\_text\_field( $\_POST['qcld\_seo\_lighting'] )            : 'Lighting'; |
  |  | 190 | $qcld\_seo\_subject               = isset( $\_POST['qcld\_seo\_subject'] )               ? sanitize\_text\_field( $\_POST['qcld\_seo\_subject'] )             : 'Subject'; |
  |  | 191 | $qcld\_seo\_camera\_settings       = isset( $\_POST['qcld\_seo\_camera\_settings'] )       ? sanitize\_text\_field( $\_POST['qcld\_seo\_camera\_settings'] )     : 'Camera Settings'; |
  |  | 192 | $qcld\_seo\_composition           = isset( $\_POST['qcld\_seo\_composition'] )           ? sanitize\_text\_field( $\_POST['qcld\_seo\_composition'] )         : 'Composition'; |
  |  | 193 | $qcld\_seo\_resolution            = isset( $\_POST['qcld\_seo\_resolution'] )            ? sanitize\_text\_field( $\_POST['qcld\_seo\_resolution'] )          : 'Resolution'; |
  |  | 194 | $qcld\_seo\_color                 = isset( $\_POST['qcld\_seo\_color'] )                 ? sanitize\_text\_field( $\_POST['qcld\_seo\_color'] )               : 'Color'; |
  |  | 195 | $qcld\_seo\_special\_effects       = isset( $\_POST['qcld\_seo\_special\_effects'] )       ? sanitize\_text\_field( $\_POST['qcld\_seo\_special\_effects'] )     : 'Special Effects'; |
  |  | 196 | $qcld\_seo\_img\_size              = isset( $\_POST['qcld\_seo\_img\_size'] )              ? sanitize\_text\_field( $\_POST['qcld\_seo\_img\_size'] )            : '512x512'; |
  |  | 197 | $qcld\_seo\_num\_images            = isset( $\_POST['qcld\_seo\_num\_images'] )            ? sanitize\_text\_field( $\_POST['qcld\_seo\_num\_images'] )          : 1; |
  |  | 198 | $qcld\_seo\_num\_images            = isset( $qcld\_seo\_num\_images )                     ? (int) $qcld\_seo\_num\_images                                    : 6; |
  |  | 199 | if (!empty($qcld\_seo\_prompt)) { |
  |  | 200 | // Get the prompt from the form |
  |  | 201 | $prompt         = $qcld\_seo\_prompt; |
  |  | 202 | $img\_size       = $qcld\_seo\_img\_size; |
  |  | 203 | $num\_images     = $qcld\_seo\_num\_images; |
  |  | 204 | // convert num\_images to an integer |
  |  | 205 | $num\_images     = (int) $num\_images; |
  |  | 206 | $prompt\_elements = array( |
  |  | 207 | 'artist'            => $qcld\_seo\_artist, |
  |  | 208 | 'art\_style'         => $qcld\_seo\_art\_style, |
  |  | 209 | 'photography\_style' => $qcld\_seo\_photography\_style, |
  |  | 210 | 'composition'       => $qcld\_seo\_composition, |
  |  | 211 | 'resolution'        => $qcld\_seo\_resolution, |
  |  | 212 | 'color'             => $qcld\_seo\_color, |
  |  | 213 | 'special\_effects'   => $qcld\_seo\_special\_effects, |
  |  | 214 | 'lighting'          => $qcld\_seo\_lighting, |
  |  | 215 | 'subject'           => $qcld\_seo\_subject, |
  |  | 216 | 'camera\_settings'   => $qcld\_seo\_camera\_settings, |
  |  | 217 | ); |
  |  | 218 | foreach ($prompt\_elements as $key => $value) { |
  |  | 219 | if ($\_POST[$key] != "None") { |
  |  | 220 | $prompt = $prompt . ". " . $value . ": " . $\_POST[$key]; |
  | 343 | 221 | } |
  | 344 | 222 | } |
  | 345 |  | fclose($qcldopenai\_json\_file); |
  | 346 |  | $qcldopenai\_result['file'] = $qcldopenai\_file; |
  | 347 |  | $qcldopenai\_result['id'] = $qcldopenai\_convert\_id; |
  | 348 |  | $qcldopenai\_result['status'] = 'success'; |
  | 349 |  | } catch (\Exception $exception){ |
  | 350 |  | $qcldopenai\_result['msg'] = $exception->getMessage(); |
  | 351 |  | } |
  | 352 |  | } |
  | 353 |  | else $qcldopenai\_result['msg'] = 'Please select least one data to convert'; |
  | 354 |  | wp\_send\_json($qcldopenai\_result); |
  | 355 |  | } |
  | 356 |  |  |
  | 357 |  | public function openai\_ft\_model\_delete(){ |
  | 358 |  | $ft\_id = sanitize\_text\_field($\_POST['ft\_id']); |
  | 359 |  | $url = 'https://api.openai.com/v1/models/' . $ft\_id; |
  | 360 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 361 |  | $curl = curl\_init(); |
  | 362 |  | $headers = array( |
  | 363 |  | "Content-Type: multipart/form-data", |
  | 364 |  | $apt\_key, |
  | 365 |  | ); |
  | 366 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 367 |  | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  | 368 |  | curl\_setopt($curl, CURLOPT\_CUSTOMREQUEST, 'DELETE'); |
  | 369 |  | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 370 |  | $res = json\_decode(curl\_exec ($curl)); |
  | 371 |  | curl\_close ($curl); |
  | 372 |  | echo wp\_send\_json([$rel]); |
  | 373 |  | wp\_die(); |
  | 374 |  |  |
  | 375 |  | } |
  | 376 |  | public function qcld\_openai\_upload\_pagetraining\_file(){ |
  | 377 |  |  |
  | 378 |  | if( |
  | 379 |  | isset($\_POST['filename']) |
  | 380 |  | && !empty($\_POST['filename']) |
  | 381 |  | ){ |
  | 382 |  | $filename = sanitize\_text\_field($\_POST['filename']); |
  | 383 |  | $line = isset($\_POST['line']) && !empty($\_POST['line']) ? sanitize\_text\_field($\_POST['line']) : 0; |
  | 384 |  | $file =   wp\_upload\_dir()['basedir'].'/qcldopenai\_site\_training/'.$filename; |
  | 385 |  | if(file\_exists($file)){ |
  | 386 |  | $qcld\_openai\_lines = file($file); |
  | 387 |  | $fileo =  '@'. wp\_upload\_dir()['basedir'].'/qcldopenai\_site\_training/'.$filename; |
  | 388 |  | $split\_file = wp\_upload\_dir()['basedir'].'/qcldopenai\_site\_training/'.$filename; |
  | 389 |  | $qcld\_openai\_json\_file = fopen($split\_file, "a"); |
  | 390 |  | $qcld\_openai\_content = ''; |
  | 391 |  | for($i = $line; $i <= count($qcld\_openai\_lines);$i++){ |
  | 392 |  | if($i == count($qcld\_openai\_lines)){ |
  | 393 |  | $qcld\_openai\_content .= $qcld\_openai\_lines[$i]; |
  | 394 |  | $qcld\_openai\_result['next'] = 'DONE'; |
  | 395 |  | } |
  | 396 |  | else{ |
  | 397 |  | if(mb\_strlen($qcld\_openai\_content, '8bit') > $this->wpaicg\_max\_file\_size){ |
  | 398 |  | $qcld\_openai\_result['next'] = $i+1; |
  | 399 |  | break; |
  | 400 |  | } |
  | 401 |  | else{ |
  | 402 |  | $qcld\_openai\_content .= $qcld\_openai\_lines[$i]; |
  | 403 |  | } |
  | 404 |  | } |
  | 405 |  | } |
  | 406 |  | fwrite($qcld\_openai\_json\_file,$qcld\_openai\_content); |
  | 407 |  | fclose($qcld\_openai\_json\_file); |
  | 408 |  | $url = 'https://api.openai.com/v1/files'; |
  | 409 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  |  | 223 | // Send the request to OpenAI |
  |  | 224 | $request\_body = [ |
  |  | 225 | "prompt"            => $prompt, |
  |  | 226 | "n"                 => $num\_images, |
  |  | 227 | "size"              => $img\_size, |
  |  | 228 | "response\_format"   => "url", |
  |  | 229 | ]; |
  |  | 230 | $data    = json\_encode($request\_body); |
  |  | 231 | $url     = "https://api.openai.com/v1/images/generations"; |
  |  | 232 | $apt\_key = "Authorization: Bearer ". $OPENAI\_API\_KEY; |
  | 410 | 233 | $curl = curl\_init($url); |
  | 411 |  | ~~$c\_file = curl\_file\_create($split\_file, mime\_content\_type($split\_file),basename($split\_file));~~ |
  | 412 |  | ~~$data = array(~~ |
  | 413 |  | ~~'purpose' => 'fine-tune',~~ |
  | 414 |  | ~~'file' => $c\_file,~~ |
  | 415 |  | ~~);~~ |
  | 416 | 234 | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 417 | 235 | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 418 |  | $headers = array( |
  | 419 |  | "Content-Type: multipart/form-data", |
  | 420 |  | $apt\_key, |
  |  | 236 | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  |  | 237 | $headers    = array( |
  |  | 238 | "Content-Type: application/json", |
  |  | 239 | $apt\_key , |
  | 421 | 240 | ); |
  | 422 |  | $init = curl\_init(); |
  | 423 |  | curl\_setopt($init, CURLOPT\_URL,$url); |
  | 424 |  | curl\_setopt($init, CURLOPT\_HTTPHEADER, $headers); |
  | 425 |  | curl\_setopt($init, CURLOPT\_POSTFIELDS, $data); |
  | 426 |  | curl\_setopt($init, CURLOPT\_RETURNTRANSFER, true); |
  | 427 |  | $res = json\_decode(curl\_exec ($init)); |
  | 428 |  |  |
  | 429 |  | curl\_close ($init); |
  | 430 |  | if(!empty($res->error)){ |
  | 431 |  | $response['status'] = 'error'; |
  | 432 |  | $response['message'] = $res->error->message; |
  |  | 241 | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  |  | 242 | curl\_setopt($curl, CURLOPT\_POSTFIELDS, $data); |
  |  | 243 | $result     = curl\_exec($curl); |
  |  | 244 | curl\_close($curl); |
  |  | 245 |  |
  |  | 246 | // we need to catch the error here |
  |  | 247 | $img\_result = json\_decode( $result ); |
  |  | 248 |  |
  |  | 249 | $image\_grid = '<div class="qcld\_image\_grid">'; |
  |  | 250 | for ($i = 0; $i < $num\_images; $i++) { |
  |  | 251 | $image\_grid .= '<div class="qcld\_image-grid\_wrap qcld\_botopenai\_generate\_image\_download"> '; |
  |  | 252 | $image\_grid .= '<img class="qcld\_image-item" src=' . esc\_html($img\_result->data[$i]->url) . '>'; |
  |  | 253 | $image\_grid .= '<div class="qcld\_seo\_download" data-img="' . esc\_html($img\_result->data[$i]->url) . '"><button class="btn btn-success">Add to media libary</button></div>'; |
  |  | 254 | $image\_grid .= '</div>'; |
  | 433 | 255 | } |
  | 434 |  |  |
  | 435 |  | if(!empty($res->status)){ |
  | 436 |  | $response['status'] = 'success'; |
  | 437 |  | $response['message'] = 'Successfully Created file' . $res->id ; |
  | 438 |  |  |
  | 439 |  | } |
  | 440 |  | echo wp\_send\_json([$response]); |
  | 441 |  | wp\_die(); |
  | 442 |  | } else { |
  | 443 |  | if(!empty($res->status)){ |
  | 444 |  | $response['status'] = 'error'; |
  | 445 |  | $response['message'] = 'The file has been removed from wp-uploads'; |
  | 446 |  | } |
  | 447 |  | } |
  |  | 256 | $image\_grid .= '</div>'; |
  |  | 257 | $qcld\_seo\_result['status'] = 'success'; |
  |  | 258 | $qcld\_seo\_result['html'] = $image\_grid; |
  |  | 259 |  |
  |  | 260 | } |
  |  | 261 |  |
  |  | 262 | wp\_send\_json( $qcld\_seo\_result ); |
  | 448 | 263 | } |
  | 449 | 264 | } |
  | 450 |  | public function openai\_file\_upload\_callback(){ |
  | 451 |  | $uploadedfile = $\_FILES['file']; |
  | 452 |  | $url = 'https://api.openai.com/v1/files'; |
  | 453 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 454 |  | $curl = curl\_init($url); |
  | 455 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 456 |  | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 457 |  | $headers = array( |
  | 458 |  | "Content-Type: multipart/form-data", |
  | 459 |  | $apt\_key, |
  | 460 |  | ); |
  | 461 |  | if (function\_exists('curl\_file\_create')) { |
  | 462 |  | $tmp\_file = curl\_file\_create($uploadedfile['tmp\_name'], 'jsonl', $uploadedfile['name']); |
  | 463 |  | } else { |
  | 464 |  | $tmp\_file = open($uploadedfile['tmp\_name']); |
  | 465 |  | } |
  | 466 |  |  |
  | 467 |  | $data = array('file'=> $tmp\_file,'purpose'=> 'fine-tune'); |
  | 468 |  | $init = curl\_init(); |
  | 469 |  | //function parameteres |
  | 470 |  | curl\_setopt($init, CURLOPT\_URL,$url); |
  | 471 |  | curl\_setopt($init, CURLOPT\_HTTPHEADER, $headers); |
  | 472 |  | curl\_setopt($init, CURLOPT\_POSTFIELDS, $data); |
  | 473 |  | curl\_setopt($init, CURLOPT\_RETURNTRANSFER, true); |
  | 474 |  | $res = json\_decode(curl\_exec ($init)); |
  | 475 |  |  |
  | 476 |  | curl\_close ($init); |
  | 477 |  | if(!empty($res->error)){ |
  | 478 |  | $response['status'] = 'error'; |
  | 479 |  | $response['message'] = $res->error->message; |
  | 480 |  | } |
  | 481 |  |  |
  | 482 |  | if(!empty($res->status)){ |
  | 483 |  | $response['status'] = 'success'; |
  | 484 |  | $response['message'] = 'Successfully Created file' . $res->id ; |
  | 485 |  |  |
  | 486 |  | } |
  | 487 |  | echo wp\_send\_json([$response]); |
  | 488 |  | wp\_die(); |
  | 489 |  | } |
  | 490 |  | public function qcld\_openai\_image\_generate(){ |
  | 491 |  |  |
  | 492 |  | $qcld\_seo\_result = array( |
  | 493 |  | 'status' => 'error', |
  | 494 |  | 'msg'    => 'Something went wrong', |
  | 495 |  | ); |
  | 496 |  | $OPENAI\_API\_KEY = get\_option('open\_ai\_api\_key'); |
  | 497 |  | $qcld\_seo\_prompt                = isset( $\_POST['qcld\_seo\_prompt'] )                ? sanitize\_text\_field( $\_POST['qcld\_seo\_prompt'] )              : ''; |
  | 498 |  | $qcld\_seo\_artist                = isset( $\_POST['qcld\_seo\_artist'] )                ? sanitize\_text\_field( $\_POST['qcld\_seo\_artist'] )              : 'Painter'; |
  | 499 |  | $qcld\_seo\_art\_style             = isset( $\_POST['qcld\_seo\_art\_style'] )             ? sanitize\_text\_field( $\_POST['qcld\_seo\_art\_style'] )           : 'Style'; |
  | 500 |  | $qcld\_seo\_photography\_style     = isset( $\_POST['qcld\_seo\_photography\_style'] )     ? sanitize\_text\_field( $\_POST['qcld\_seo\_photography\_style'] )   : 'Photography Style'; |
  | 501 |  | $qcld\_seo\_lighting              = isset( $\_POST['qcld\_seo\_lighting'] )              ? sanitize\_text\_field( $\_POST['qcld\_seo\_lighting'] )            : 'Lighting'; |
  | 502 |  | $qcld\_seo\_subject               = isset( $\_POST['qcld\_seo\_subject'] )               ? sanitize\_text\_field( $\_POST['qcld\_seo\_subject'] )             : 'Subject'; |
  | 503 |  | $qcld\_seo\_camera\_settings       = isset( $\_POST['qcld\_seo\_camera\_settings'] )       ? sanitize\_text\_field( $\_POST['qcld\_seo\_camera\_settings'] )     : 'Camera Settings'; |
  | 504 |  | $qcld\_seo\_composition           = isset( $\_POST['qcld\_seo\_composition'] )           ? sanitize\_text\_field( $\_POST['qcld\_seo\_composition'] )         : 'Composition'; |
  | 505 |  | $qcld\_seo\_resolution            = isset( $\_POST['qcld\_seo\_resolution'] )            ? sanitize\_text\_field( $\_POST['qcld\_seo\_resolution'] )          : 'Resolution'; |
  | 506 |  | $qcld\_seo\_color                 = isset( $\_POST['qcld\_seo\_color'] )                 ? sanitize\_text\_field( $\_POST['qcld\_seo\_color'] )               : 'Color'; |
  | 507 |  | $qcld\_seo\_special\_effects       = isset( $\_POST['qcld\_seo\_special\_effects'] )       ? sanitize\_text\_field( $\_POST['qcld\_seo\_special\_effects'] )     : 'Special Effects'; |
  | 508 |  | $qcld\_seo\_img\_size              = isset( $\_POST['qcld\_seo\_img\_size'] )              ? sanitize\_text\_field( $\_POST['qcld\_seo\_img\_size'] )            : '512x512'; |
  | 509 |  | $qcld\_seo\_num\_images            = isset( $\_POST['qcld\_seo\_num\_images'] )            ? sanitize\_text\_field( $\_POST['qcld\_seo\_num\_images'] )          : 1; |
  | 510 |  | $qcld\_seo\_num\_images            = isset( $qcld\_seo\_num\_images )                     ? (int) $qcld\_seo\_num\_images                                    : 6; |
  | 511 |  | if (!empty($qcld\_seo\_prompt)) { |
  | 512 |  | // Get the prompt from the form |
  | 513 |  | $prompt         = $qcld\_seo\_prompt; |
  | 514 |  | $img\_size       = $qcld\_seo\_img\_size; |
  | 515 |  | $num\_images     = $qcld\_seo\_num\_images; |
  | 516 |  | // convert num\_images to an integer |
  | 517 |  | $num\_images     = (int) $num\_images; |
  | 518 |  | $prompt\_elements = array( |
  | 519 |  | 'artist'            => $qcld\_seo\_artist, |
  | 520 |  | 'art\_style'         => $qcld\_seo\_art\_style, |
  | 521 |  | 'photography\_style' => $qcld\_seo\_photography\_style, |
  | 522 |  | 'composition'       => $qcld\_seo\_composition, |
  | 523 |  | 'resolution'        => $qcld\_seo\_resolution, |
  | 524 |  | 'color'             => $qcld\_seo\_color, |
  | 525 |  | 'special\_effects'   => $qcld\_seo\_special\_effects, |
  | 526 |  | 'lighting'          => $qcld\_seo\_lighting, |
  | 527 |  | 'subject'           => $qcld\_seo\_subject, |
  | 528 |  | 'camera\_settings'   => $qcld\_seo\_camera\_settings, |
  | 529 |  | ); |
  | 530 |  | foreach ($prompt\_elements as $key => $value) { |
  | 531 |  | if ($\_POST[$key] != "None") { |
  | 532 |  | $prompt = $prompt . ". " . $value . ": " . $\_POST[$key]; |
  | 533 |  | } |
  | 534 |  | } |
  | 535 |  | // Send the request to OpenAI |
  | 536 |  | $request\_body = [ |
  | 537 |  | "prompt"            => $prompt, |
  | 538 |  | "n"                 => $num\_images, |
  | 539 |  | "size"              => $img\_size, |
  | 540 |  | "response\_format"   => "url", |
  | 541 |  | ]; |
  | 542 |  | $data    = json\_encode($request\_body); |
  | 543 |  | $url     = "https://api.openai.com/v1/images/generations"; |
  | 544 |  | $apt\_key = "Authorization: Bearer ". $OPENAI\_API\_KEY; |
  | 545 |  | $curl = curl\_init($url); |
  | 546 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 547 |  | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 548 |  | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  | 549 |  | $headers    = array( |
  | 550 |  | "Content-Type: application/json", |
  | 551 |  | $apt\_key , |
  | 552 |  | ); |
  | 553 |  | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  | 554 |  | curl\_setopt($curl, CURLOPT\_POSTFIELDS, $data); |
  | 555 |  | $result     = curl\_exec($curl); |
  | 556 |  | curl\_close($curl); |
  | 557 |  |  |
  | 558 |  | // we need to catch the error here |
  | 559 |  | $img\_result = json\_decode( $result ); |
  | 560 |  |  |
  | 561 |  | $image\_grid = '<div class="qcld\_image\_grid">'; |
  | 562 |  | for ($i = 0; $i < $num\_images; $i++) { |
  | 563 |  | $image\_grid .= '<div class="qcld\_image-grid\_wrap qcld\_botopenai\_generate\_image\_download"> '; |
  | 564 |  | $image\_grid .= '<img class="qcld\_image-item" src=' . esc\_html($img\_result->data[$i]->url) . '>'; |
  | 565 |  | $image\_grid .= '<div class="qcld\_seo\_download" data-img="' . esc\_html($img\_result->data[$i]->url) . '"><button class="btn btn-success">Add to media libary</button></div>'; |
  | 566 |  | $image\_grid .= '</div>'; |
  | 567 |  | } |
  | 568 |  | $image\_grid .= '</div>'; |
  | 569 |  | $qcld\_seo\_result['status'] = 'success'; |
  | 570 |  | $qcld\_seo\_result['html'] = $image\_grid; |
  | 571 |  |  |
  | 572 |  | } |
  | 573 |  |  |
  | 574 |  | wp\_send\_json( $qcld\_seo\_result ); |
  | 575 |  | } |
  | 576 |  | public function qcld\_openai\_delete\_training\_file(){ |
  | 577 |  | $file = sanitize\_text\_field($\_POST['file']); |
  | 578 |  | $qcld\_seo\_result = array( |
  | 579 |  | 'status' => 'error', |
  | 580 |  | 'msg'    => 'Something went wrong', |
  | 581 |  | ); |
  | 582 |  | if (is\_file($file)) { |
  | 583 |  |  |
  | 584 |  | chmod($file, 0777); |
  | 585 |  |  |
  | 586 |  | if (unlink($file)) { |
  | 587 |  | $result = 'File deleted'; |
  | 588 |  | $qcld\_seo\_result['html'] = $result; |
  | 589 |  | } else { |
  | 590 |  | $result = 'Cannot remove that file'; |
  | 591 |  | $qcld\_seo\_result['html'] = $result; |
  | 592 |  | } |
  | 593 |  |  |
  | 594 |  | } else { |
  | 595 |  | $result = 'File does not exist'; |
  | 596 |  | $qcld\_seo\_result['html'] = $result; |
  | 597 |  | } |
  | 598 |  |  |
  | 599 |  | wp\_send\_json( $qcld\_seo\_result ); |
  | 600 |  | wp\_die(); |
  | 601 |  |  |
  | 602 |  | } |
  | 603 |  | public function openai\_finetune\_create($file\_id,$ft\_suffix,$ft\_engines){ |
  | 604 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 605 |  | $headers = array( |
  | 606 |  | "Content-Type: application/json", |
  | 607 |  | $apt\_key, |
  | 608 |  | ); |
  | 609 |  | $curl = curl\_init(); |
  | 610 |  | $qcld\_openai\_suffix = isset($ft\_suffix) ? $ft\_suffix : get\_option('qcld\_openai\_suffix'); |
  | 611 |  | $openai\_engines = isset($ft\_engines) ? $ft\_engines : get\_option('openai\_engines'); |
  | 612 |  | $base\_engine = explode('-',$openai\_engines); |
  | 613 |  | $data = json\_encode(array('training\_file'=>$file\_id,'model' => $base\_engine[1], 'suffix' => $qcld\_openai\_suffix )); |
  | 614 |  | $url = "https://api.openai.com/v1/fine-tunes"; |
  | 615 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 616 |  | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  | 617 |  | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 618 |  | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  | 619 |  | curl\_setopt($curl, CURLOPT\_POSTFIELDS, $data); |
  | 620 |  | $result = json\_decode(curl\_exec($curl)); |
  | 621 |  | curl\_close($curl); |
  | 622 |  | return $result; |
  | 623 |  | } |
  | 624 |  | public function openai\_finetune\_list(){ |
  | 625 |  |  |
  | 626 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 627 |  | $headers = array( |
  | 628 |  | "Content-Type: application/json", |
  | 629 |  | $apt\_key, |
  | 630 |  | ); |
  | 631 |  | $curl\_ft = curl\_init(); |
  | 632 |  | //$data = json\_encode(array('training\_file'=>$file\_id)); |
  | 633 |  |  |
  | 634 |  | $url = "https://api.openai.com/v1/fine-tunes"; |
  | 635 |  | curl\_setopt($curl\_ft, CURLOPT\_URL, $url); |
  | 636 |  | curl\_setopt($curl\_ft, CURLOPT\_HTTPHEADER, $headers); |
  | 637 |  | curl\_setopt($curl\_ft, CURLOPT\_RETURNTRANSFER, true); |
  | 638 |  | $result = json\_decode(curl\_exec($curl\_ft)); |
  | 639 |  | $ft\_arry = []; |
  | 640 |  | foreach($result->data as $value ){ |
  | 641 |  | if(($value->training\_files[0]->status != 'deleted') && ($value->result\_files[0]->status != 'deleted') ){ |
  | 642 |  | $ft\_arry[] = [$value->id,$value->fine\_tuned\_model,$value->status,$value->training\_files[0]->filename,$value->training\_files[0]->id]; |
  | 643 |  | } |
  | 644 |  | } |
  | 645 |  | curl\_close($curl\_ft); |
  | 646 |  | wp\_send\_json( $ft\_arry); |
  | 647 |  | wp\_die(); |
  | 648 |  |  |
  | 649 |  |  |
  | 650 |  | } |
  | 651 |  | public function openai\_retrive\_fine\_tune($keyword){ |
  | 652 |  |  |
  | 653 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 654 |  | $headers = array( |
  | 655 |  | "Content-Type: application/json", |
  | 656 |  | $apt\_key, |
  | 657 |  | ); |
  | 658 |  | $curl = curl\_init(); |
  | 659 |  | $max\_tokens =  (int)get\_option( 'openai\_max\_tokens'); |
  | 660 |  | $temp = (float)get\_option( 'openai\_temperature'); |
  | 661 |  | $frequency\_penalty = (float)get\_option( 'frequency\_penalty'); |
  | 662 |  | $presence\_penalty = (float)get\_option( 'presence\_penalty'); |
  | 663 |  | $engines = explode('-',get\_option( 'openai\_engines')); |
  | 664 |  |  |
  | 665 |  | $data = json\_encode(array( |
  | 666 |  | 'prompt'=>$keyword, |
  | 667 |  | 'model'=> get\_option( 'qcld\_openai\_custom\_model'), |
  | 668 |  | "max\_tokens" => $max\_tokens, |
  | 669 |  | "temperature" => $temp, |
  | 670 |  | "top\_p" => 1, |
  | 671 |  | "presence\_penalty" => $frequency\_penalty, |
  | 672 |  | "frequency\_penalty"=> $presence\_penalty, |
  | 673 |  | "best\_of"=> 1, |
  | 674 |  | )); |
  | 675 |  | $url = "https://api.openai.com/v1/completions"; |
  | 676 |  |  |
  | 677 |  | $ch = curl\_init(); |
  | 678 |  |  |
  | 679 |  | curl\_setopt($ch, CURLOPT\_URL, 'https://api.openai.com/v1/completions'); |
  | 680 |  | // curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
  | 681 |  | // curl\_setopt($ch, CURLOPT\_POST, 1); |
  | 682 |  | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, true); |
  | 683 |  | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'POST'); |
  | 684 |  | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
  | 685 |  | curl\_setopt($ch, CURLOPT\_POSTFIELDS, $data); |
  | 686 |  |  |
  | 687 |  | $result = (curl\_exec($ch)); |
  | 688 |  | $result = str\_replace("#","",$result ); |
  | 689 |  | return $result; |
  | 690 |  | if (curl\_errno($ch)) { |
  | 691 |  | echo 'Error:' . curl\_error($ch); |
  | 692 |  | } |
  | 693 |  | curl\_close($ch); |
  | 694 |  |  |
  | 695 |  | } |
  |  | 265 |  |
  | 696 | 266 | public function response\_form\_file($keyword){ |
  | 697 | 267 | $max\_tokens =  (int)get\_option( 'openai\_max\_tokens'); |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L825) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L395) |  |
  | 825 | 395 | $gptkeyword = []; |
  | 826 | 396 | $keyword = sanitize\_text\_field($\_POST['keyword']); |
  | 827 |  | ~~$response\_files = $this->openai\_retrive\_fine\_tune($keyword);~~ |
  |  | 397 |  |
  | 828 | 398 | $response\_file = json\_decode($response\_files, true); |
  | 829 | 399 | $gptkeywords = []; |
  | 830 |  | if(empty($response\_file['choices'][0]["text"])){ |
  | 831 |  |  |
  | 832 |  | $engines = explode('-',get\_option( 'openai\_engines')); |
  | 833 |  | if($engines[0] == 'gpt'){ |
  | 834 |  |  |
  | 835 |  | if(empty($\_COOKIE["last\_five\_prompt"])){ |
  | 836 |  | array\_push($gptkeyword, array( |
  | 837 |  | "role" => "user", |
  | 838 |  | "content" =>  $keyword |
  | 839 |  | )); |
  | 840 |  | setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeyword)) , time() + (60000), "/"); |
  | 841 |  | }else{ |
  | 842 |  | $data = ($\_COOKIE['last\_five\_prompt']); |
  | 843 |  | $data = (base64\_decode($data)); |
  | 844 |  | $gptkeyword =  maybe\_unserialize($data); |
  | 845 |  | if(is\_array($gptkeyword)){ |
  | 846 |  | array\_push( $gptkeyword, array( |
  | 847 |  | "role" => "user", |
  | 848 |  | "content" => $keyword |
  | 849 |  | )); |
  | 850 |  | setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeyword)) , time() + (60000), "/"); |
  | 851 |  | } |
  | 852 |  | } |
  | 853 |  |  |
  |  | 400 | $engines = explode('-',get\_option( 'openai\_engines')); |
  |  | 401 | if($engines[0] == 'gpt'){ |
  |  | 402 |  |
  |  | 403 | // if(empty($\_COOKIE["last\_five\_prompt"])){ |
  |  | 404 | array\_push($gptkeyword, array( |
  |  | 405 | "role" => "user", |
  |  | 406 | "content" =>  $keyword |
  |  | 407 | )); |
  |  | 408 | setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeyword)) , time() + (60000), "/"); |
  |  | 409 | // }else{ |
  |  | 410 | //     $data = ($\_COOKIE['last\_five\_prompt']); |
  |  | 411 | //     $data = (base64\_decode($data)); |
  |  | 412 | //     $gptkeyword =  maybe\_unserialize($data); |
  |  | 413 | //     if(is\_array($gptkeyword)){ |
  |  | 414 | //         array\_push( $gptkeyword, array( |
  |  | 415 | //             "role" => "user", |
  |  | 416 | //             "content" => $keyword |
  |  | 417 | //         )); |
  |  | 418 | //         setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeyword)) , time() + (60000), "/"); |
  |  | 419 | //     } |
  |  | 420 | // } |
  |  | 421 |  |
  | 854 | 422 | if((!empty(get\_option('openai\_include\_keyword')) ||  !empty(get\_option('openai\_exclude\_keyword'))) && (get\_option('qcld\_openai\_relevant\_enabled') == '1') ){ |
  | 855 | 423 | $prompts =  $this->include\_exclude\_prompt($keyword); |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L858) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L426) |  |
  | 858 | 426 | "role" => "user", |
  | 859 | 427 | "content" =>  $prompts, |
  | 860 |  | )); |
  |  | 428 | )); |
  | 861 | 429 | }else if((!empty(get\_option('openai\_include\_keyword')) ||  !empty(get\_option('openai\_exclude\_keyword'))) && (get\_option('qcld\_openai\_relevant\_enabled') == '0')){ |
  | 862 |  | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
  |  | 430 | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
  | 863 | 431 | $response['message'] = 'Sorry, No result found!'; |
  | 864 | 432 | echo json\_encode($response); |
  | 865 |  | wp\_die(); |
  |  | 433 | wp\_die(); |
  | 866 | 434 | }else{ |
  | 867 | 435 | array\_push($gptkeyword, array( |
  | 868 | 436 | "role" => "user", |
  | 869 | 437 | "content" =>  $keyword |
  | 870 |  | )); |
  |  | 438 | )); |
  | 871 | 439 | } |
  | 872 | 440 |  |
  | 873 | 441 | } |
  | 874 |  |  |
  | 875 |  | $res = $OpenAI->gptcomplete( |
  | 876 |  | $gptkeyword |
  | 877 |  | ); |
  | 878 |  | $mess = json\_decode($res); |
  | 879 |  | $response['message'] = $mess->choices[0]->message->content; |
  | 880 |  | if($response['message'] == 'DUH.'  || $response['message'] == 'DUH'){ |
  | 881 |  | $response['message'] = 'Sorry, No result found!'; |
  | 882 |  | } |
  | 883 |  | if(get\_option('conversation\_continuity') == 1){ |
  | 884 |  | $data = ($\_COOKIE['last\_five\_prompt']); |
  | 885 |  | $data = (base64\_decode($data)); |
  | 886 |  | $gptkeywords =  maybe\_unserialize($data); |
  | 887 |  | if(is\_array($gptkeywords)){ |
  | 888 |  | array\_push( $gptkeywords, array( |
  | 889 |  | "role" => "assistant", |
  | 890 |  | "content" =>  $response['message'] |
  | 891 |  | )); |
  | 892 |  | setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeywords)) , time() + (60000), "/"); |
  | 893 |  | } |
  | 894 |  | } |
  | 895 |  |  |
  | 896 |  | }else{ |
  | 897 |  | if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '1') ){ |
  | 898 |  | $prompts =  $this->include\_exclude\_prompt($keyword); |
  | 899 |  | }else if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '0')){ |
  | 900 |  | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
  | 901 |  | $response['message'] = "Sorry, No result found!"; |
  | 902 |  | echo json\_encode($response); |
  | 903 |  | wp\_die(); |
  | 904 |  | }else{ |
  | 905 |  | $prompts = $this->get\_prompt($keyword); |
  | 906 |  | } |
  |  | 442 |  |
  |  | 443 | $res = $OpenAI->gptcomplete( |
  |  | 444 | $gptkeyword |
  |  | 445 | ); |
  |  | 446 | $mess = json\_decode($res); |
  |  | 447 | $response['message'] = $mess->choices[0]->message->content; |
  |  | 448 | if($response['message'] == 'DUH.'  || $response['message'] == 'DUH'){ |
  |  | 449 | $response['message'] = 'Sorry, No result found!'; |
  |  | 450 | } |
  |  | 451 | // if(get\_option('conversation\_continuity') == 1){ |
  |  | 452 | //     $data = ($\_COOKIE['last\_five\_prompt']); |
  |  | 453 | //     $data = (base64\_decode($data)); |
  |  | 454 | //     $gptkeywords =  maybe\_unserialize($data); |
  |  | 455 | //     if(is\_array($gptkeywords)){ |
  |  | 456 | //         array\_push( $gptkeywords, array( |
  |  | 457 | //             "role" => "assistant", |
  |  | 458 | //             "content" =>  $response['message'] |
  |  | 459 | //         )); |
  |  | 460 | //         setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeywords)) , time() + (60000), "/"); |
  |  | 461 | //     } |
  |  | 462 | // } |
  |  | 463 |  |
  |  | 464 | }else{ |
  |  | 465 |  |
  |  | 466 | if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '1') ){ |
  |  | 467 | $prompts =  $this->include\_exclude\_prompt($keyword); |
  |  | 468 | }else if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '0')){ |
  |  | 469 |  |
  |  | 470 | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
  |  | 471 | $response['message'] = "Sorry, No result found!"; |
  |  | 472 | echo json\_encode($response); |
  |  | 473 | wp\_die(); |
  | 907 | 474 | }else{ |
  | 908 | 475 | $prompts = $this->get\_prompt($keyword); |
  | 909 | 476 | } |
  | 910 |  | $prompt =$prompts; |
  | 911 |  | $res = $OpenAI->complete( |
  | 912 |  | $prompt |
  | 913 |  | ); |
  | 914 |  |  |
  | 915 |  | $mess = json\_decode($res); |
  | 916 |  | $response['message'] = $mess->choices[0]->text; |
  | 917 |  | if($response['message'] == 'DUH.' || $response['message'] == 'DUH'){ |
  | 918 |  | $response['message'] = 'Sorry, No result found!'; |
  | 919 |  | } |
  | 920 |  | if(get\_option('conversation\_continuity') == 1){ |
  | 921 |  | $lasfivecookie = $\_COOKIE["last\_five\_prompt"] . $response['message'] . '###'; |
  | 922 |  | $response['cookie'] =  $\_COOKIE["last\_five\_prompt"]; |
  | 923 |  | } |
  | 924 |  | } |
  | 925 |  | }else{ |
  | 926 |  | $response['message'] = $response\_file['choices'][0]["text"]; |
  | 927 |  | } |
  |  | 477 | }else{ |
  |  | 478 | $prompts = $this->get\_prompt($keyword); |
  |  | 479 | } |
  |  | 480 | $prompt =$prompts; |
  |  | 481 | $res = $OpenAI->complete( |
  |  | 482 | $prompt |
  |  | 483 | ); |
  |  | 484 |  |
  |  | 485 | $mess = json\_decode($res); |
  |  | 486 | $response['message'] = $mess->choices[0]->text; |
  |  | 487 | if($response['message'] == 'DUH.' || $response['message'] == 'DUH'){ |
  |  | 488 | $response['message'] = 'Sorry, No result found!'; |
  |  | 489 | } |
  |  | 490 | if(get\_option('conversation\_continuity') == 1){ |
  |  | 491 | $lasfivecookie = $\_COOKIE["last\_five\_prompt"] . $response['message'] . '###'; |
  |  | 492 | $response['cookie'] =  $\_COOKIE["last\_five\_prompt"]; |
  |  | 493 | } |
  |  | 494 | } |
  |  | 495 |  |
  | 928 | 496 | echo json\_encode($response); |
  | 929 | 497 | wp\_die(); |
* ## [chatbot/trunk/includes/openai/qcld\_wp\_OpenAI.php](/changeset/2977505/chatbot/trunk/includes/openai/qcld_wp_OpenAI.php?old=2936993&old_path=chatbot%2Ftrunk%2Fincludes%2Fopenai%2Fqcld_wp_OpenAI.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/openai/qcld_wp_OpenAI.php")

  | [r2967435](/browser/chatbot/trunk/includes/openai/qcld_wp_OpenAI.php?rev=2936993#L66 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/openai/qcld_wp_OpenAI.php?rev=2977505#L66 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 66 | 66 | "temperature" => 0 |
  | 67 | 67 | ); |
  |  | 68 |  |
  | 68 | 69 | $header  = [ |
  | 69 | 70 | 'Content-Type: application/json', |
* ## [chatbot/trunk/js/qcld-wp-chatbot-admin.js](/changeset/2977505/chatbot/trunk/js/qcld-wp-chatbot-admin.js?old=2955247&old_path=chatbot%2Ftrunk%2Fjs%2Fqcld-wp-chatbot-admin.js "Show the [2967435:2977505] differences restricted to chatbot/trunk/js/qcld-wp-chatbot-admin.js")

  | [r2967435](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L160 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L160 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 160 | 160 | $('#qc\_wpbot\_gc\_download').on('click', function(e){ |
  | 161 | 161 | e.preventDefault(); |
  | 162 |  |  |
  | 163 | 162 | $.ajax( |
  | 164 | 163 | { |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L166) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L165) |  |
  | 166 | 165 | // Change to 'GET' if you need. |
  | 167 | 166 | url: ajax\_object.ajax\_url, data: { |
  | 168 |  | 'action': 'qcld\_wp\_chatbot\_gc\_client\_download' |
  |  | 167 | 'action': 'qcld\_wp\_chatbot\_gc\_client\_download', |
  |  | 168 | 'nonce': ajax\_object.ajax\_nonce, |
  | 169 | 169 | }, |
  | 170 | 170 | beforeSend: function() |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L182) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L182) |  |
  | 182 | 182 | // Change to 'GET' if you need. |
  | 183 | 183 | url: ajax\_object.ajax\_url, data: { |
  | 184 |  | 'action': 'qcld\_wp\_chatbot\_gc\_client\_extract' |
  |  | 184 | 'action': 'qcld\_wp\_chatbot\_gc\_client\_extract', |
  |  | 185 | 'nonce': ajax\_object.ajax\_nonce |
  | 185 | 186 | }, |
  | 186 | 187 | beforeSend: function() |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L488) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L489) |  |
  | 488 | 489 | 'action': 'qcld\_wp\_df\_api\_call', |
  | 489 | 490 | 'dfquery': 'hi', |
  |  | 491 | 'nonce': ajax\_object.ajax\_nonce, |
  | 490 | 492 | 'sessionid': 'wpwBot\_df\_201sdf8071' |
  | 491 | 493 | }, |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L736) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L738) |  |
  | 736 | 738 | data: { |
  | 737 | 739 |  |
  | 738 |  | action: 'qcld-wp-chabot-reindex' |
  |  | 740 | action: 'qcld-wp-chabot-reindex', |
  |  | 741 | 'nonce': ajax\_object.ajax\_nonce |
  | 739 | 742 |  |
  | 740 | 743 | }, |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L840) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L843) |  |
  | 840 | 843 | url: ajax\_object.ajax\_url, |
  | 841 | 844 | data: { |
  | 842 |  | action: 'qcld-wp-chabot-cancel-index' |
  |  | 845 | action: 'qcld-wp-chabot-cancel-index', |
  |  | 846 | 'nonce': ajax\_object.ajax\_nonce |
  | 843 | 847 | } |
  | 844 | 848 | }); |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L1142) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L1146) |  |
  | 1142 | 1146 | }); |
  | 1143 | 1147 | } |
  | 1144 |  | $('#post\_conversion\_files').on('click','.qcld\_convert\_upload',function(){ |
  | 1145 |  | var filename = $('.qcld\_convert\_upload').attr('data-file'); |
  | 1146 |  | var lines = $('.qcld\_convert\_upload').attr('data-lines'); |
  | 1147 |  |  |
  | 1148 |  | $.ajax({ |
  | 1149 |  | url: ajax\_object.ajax\_url, |
  | 1150 |  | type: "POST", |
  | 1151 |  | dataType: "JSON", |
  | 1152 |  | data: { |
  | 1153 |  | action : 'qcld\_openai\_upload\_pagetraining\_file', |
  | 1154 |  | data: lines, |
  | 1155 |  | filename: filename, |
  | 1156 |  | }, |
  | 1157 |  | success: function(res) { |
  | 1158 |  | location.reload(); |
  | 1159 |  | setTimeout(() => { |
  | 1160 |  | jQuery('a[href$="#wp-chatbot-openai-training-model"]').trigger('click'); |
  | 1161 |  | }, 5000); |
  | 1162 |  | } |
  | 1163 |  | }); |
  | 1164 |  |  |
  | 1165 |  | }) |
  |  | 1148 |  |
  | 1166 | 1149 | $("#wp-chatbot-data\_post\_converter").on('click','.qcld\_convert\_data', function(){ |
  | 1167 | 1150 | var list = $("input[name='wp\_chatbot\_data\_converter\_list[]']:checked").map(function () { |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L1342) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L1325) |  |
  | 1342 | 1325 | qcld\_seo\_img\_size: qcld\_seo\_img\_size, |
  | 1343 | 1326 | qcld\_seo\_num\_images: qcld\_seo\_num\_images, |
  | 1344 |  | action: 'qcld\_openai\_image\_generate' |
  |  | 1327 | action: 'qcld\_openai\_image\_generate', |
  |  | 1328 | nonce: ajax\_object.ajax\_url, |
  | 1345 | 1329 | }; |
  | 1346 | 1330 |  |
* ## [chatbot/trunk/js/qcld-wp-chatbot-plugin.js](/changeset/2977505/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?old=2957286&old_path=chatbot%2Ftrunk%2Fjs%2Fqcld-wp-chatbot-plugin.js "Show the [2967435:2977505] differences restricted to chatbot/trunk/js/qcld-wp-chatbot-plugin.js")

  | [r2967435](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2957286#L295 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2977505#L295 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 295 | 295 | }); |
  | 296 | 296 | }else{ |
  |  | 297 | console.log(globalwpw.settings.obj) |
  | 297 | 298 | return jQuery.post(globalwpw.settings.obj.ajax\_url, { |
  | 298 | 299 | 'action': 'qcld\_wp\_df\_api\_call', |
  | 299 | 300 | 'dfquery': text, |
  |  | 301 | 'nonce': globalwpw.settings.obj.ajax\_nonce, |
  | 300 | 302 | 'sessionid': localStorage.getItem('botsessionid')?localStorage.getItem('botsessionid'):'wpwBot\_df\_2018071' |
  | 301 | 303 | }); |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2957286#L1187) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2977505#L1189) |  |
  | 1187 | 1189 | }, |
  | 1188 | 1190 | site\_search:function(msg){ |
  | 1189 |  | msg = wpwKits.filterStopWords(msg); |
  | 1190 |  | var data = {'action':'wpbo\_search\_site','name':globalwpw.hasNameCookie,'keyword':msg}; |
  |  | 1191 | msg1 = wpwKits.filterStopWords(msg); |
  |  | 1192 | var data = {'action':'wpbo\_search\_site','name':globalwpw.hasNameCookie,'keyword':msg1}; |
  | 1191 | 1193 | wpwKits.ajax(data).done(function (res) { |
  | 1192 | 1194 | var json=$.parseJSON(res); |
* ## [chatbot/trunk/qcld-wpwbot-search.php](/changeset/2977505/chatbot/trunk/qcld-wpwbot-search.php?old=2957286&old_path=chatbot%2Ftrunk%2Fqcld-wpwbot-search.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/qcld-wpwbot-search.php")

  | [r2967435](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L86 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L86 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 86 | 86 | $response['status'] = 'fail'; |
  | 87 | 87 | } |
  | 88 |  | ~~//var\_dump($total\_post);wp\_die();~~ |
  | 89 | 88 | $response['html'] .= '<p>'.$msg.'</p>'; |
  | 90 | 89 | $response['html'] .= $responses; |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L174) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L173) |  |
  | 174 | 173 |  |
  | 175 | 174 | $status = array('status'=>'fail', 'multiple'=>false); |
  |  | 175 | $field = "ID"; |
  | 176 | 176 | if(($strid != '') && empty($response\_result)){ |
  | 177 |  | $results = $wpdb->get\_results(~~"SELECT \* FROM `$table` WHERE `ID` = ".$strid~~); |
  |  | 177 | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM %i WHERE %i = %d",$table,$field,$strid)); |
  | 178 | 178 | if(!empty($results)){ |
  | 179 | 179 | foreach($results as $result){ |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L184) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L184) |  |
  | 184 | 184 | } |
  | 185 | 185 | } |
  | 186 |  |  |
  | 187 |  | $results = $wpdb->get\_results("SELECT `id`, `query`, `response` FROM `$table` WHERE 1 and `query` = '".$keyword."'"); |
  |  | 186 | $field = "query"; |
  |  | 187 | $sql\_text = $wpdb->prepare("SELECT `id`, `query`, `response` FROM %i WHERE 1 and %i =  %s", $table, $field,$keyword); |
  |  | 188 | $results = $wpdb->get\_results($sql\_text); |
  |  | 189 |  |
  | 188 | 190 |  |
  | 189 | 191 | if(!empty($results)){ |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L194) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L196) |  |
  | 194 | 196 | } |
  | 195 | 197 | } |
  |  | 198 |  |
  |  | 199 | $field = "category"; |
  | 196 | 200 | if(empty($response\_result)){ |
  | 197 |  | $results = $wpdb->get\_results("SELECT `id`, `query`, `response` FROM `$table` WHERE 1 and `category` = '".$keyword."'"); |
  |  | 201 | $sql = $wpdb->prepare("SELECT `id`, `query`, `response` FROM %i  WHERE 1 and %i = %s", $table,$field, $keyword); |
  |  | 202 | $results = $wpdb->get\_results($sql ); |
  | 198 | 203 |  |
  | 199 | 204 |  |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L232) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L237) |  |
  | 232 | 237 | $sql = "ALTER TABLE `{$table}` ADD FULLTEXT($qfields);"; |
  | 233 | 238 | $wpdb->query( $sql ); |
  | 234 |  | $sql\_text = "SELECT `id`, `query`, `response`, MATCH($qfields) AGAINST('".$keyword."' IN NATURAL LANGUAGE MODE) as score FROM $table WHERE MATCH($qfields) AGAINST('".$keyword."' IN NATURAL LANGUAGE MODE) order by score desc limit 15"; |
  |  | 239 |  |
  |  | 240 | $sql\_text = $wpdb->prepare("SELECT `id`, `query`, `response`, MATCH($qfields) AGAINST(%s IN NATURAL LANGUAGE MODE) as score FROM %i WHERE MATCH($qfields) AGAINST(%s IN NATURAL LANGUAGE MODE) order by score desc limit 15",$keyword,$table,$keyword); |
  | 235 | 241 | $results = $wpdb->get\_results($sql\_text); |
  | 236 |  |  |
  | 237 | 242 | $weight = get\_option('qc\_bot\_str\_weight')!=''?get\_option('qc\_bot\_str\_weight'):'0.4'; |
  |  | 243 |  |
  | 238 | 244 | if(!empty($results)){ |
  | 239 | 245 | foreach($results as $result){ |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L244) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L250) |  |
  | 244 | 250 | } |
  | 245 | 251 | } |
  | 246 |  |  |
  |  | 252 | $field = "keyword"; |
  | 247 | 253 | if( empty( $response\_result ) ){ |
  | 248 |  | $results = $wpdb->get\_results("SELECT \* FROM `$table` WHERE `keyword` REGEXP '".$keyword."'"); |
  |  | 254 | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM %i WHERE %i REGEXP %s", $table,$field,$keyword)); |
  |  | 255 |  |
  |  | 256 |  |
  | 249 | 257 | if(!empty($results)){ |
  | 250 | 258 | foreach($results as $result){ |
* ## [chatbot/trunk/qcld-wpwbot.php](/changeset/2977505/chatbot/trunk/qcld-wpwbot.php?old=2967435&old_path=chatbot%2Ftrunk%2Fqcld-wpwbot.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/qcld-wpwbot.php")

  | [r2967435](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2967435#L5 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2977505#L5 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Description: ChatBot is a native WordPress ChatBot plugin to provide quick support and email functionality. |
  | 6 | 6 | \* Donate link: https://www.quantumcloud.com |
  | 7 |  | \* Version: 4.~~8.9~~ |
  |  | 7 | \* Version: 4.9.1 |
  | 8 | 8 | \* @author    QuantumCloud |
  | 9 | 9 | \* Author: QuantumCloud |
  | […](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2967435#L19) | […](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2977505#L19) |  |
  | 19 | 19 |  |
  | 20 | 20 | if (!defined('ABSPATH')) exit; // Exit if accessed directly |
  | 21 |  | define('QCLD\_wpCHATBOT\_VERSION', '4.~~8.9~~'); |
  |  | 21 | define('QCLD\_wpCHATBOT\_VERSION', '4.9.1'); |
  | 22 | 22 | define('QCLD\_wpCHATBOT\_REQUIRED\_wpCOMMERCE\_VERSION', 2.2); |
  | 23 | 23 | define('QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH', plugin\_dir\_path(\_\_FILE\_\_)); |
* ## [chatbot/trunk/qcld\_df\_api.php](/changeset/2977505/chatbot/trunk/qcld_df_api.php?old=2537910&old_path=chatbot%2Ftrunk%2Fqcld_df_api.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/qcld_df_api.php")

  | [r2967435](/browser/chatbot/trunk/qcld_df_api.php?rev=2537910#L79 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/qcld_df_api.php?rev=2977505#L79 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 79 | 79 | add\_action('wp\_ajax\_nopriv\_qcld\_wp\_df\_api\_call', 'qcld\_wp\_df\_api\_call'); |
  | 80 | 80 | function qcld\_wp\_df\_api\_call(){ |
  | 81 |  | $session\_id = 'asd2342sde'; |
  | 82 |  | $language = get\_option('qlcd\_wp\_chatbot\_dialogflow\_agent\_language'); |
  | 83 |  | //project ID |
  | 84 |  | $project\_ID = get\_option('qlcd\_wp\_chatbot\_dialogflow\_project\_id'); |
  | 85 |  | // Service Account Key json file |
  | 86 |  | $JsonFileContents = get\_option('qlcd\_wp\_chatbot\_dialogflow\_project\_key'); |
  | 87 |  | if($project\_ID==''){ |
  | 88 |  | echo json\_encode(array('error'=>'Project ID is empty'));exit; |
  | 89 |  | } |
  | 90 |  | if($JsonFileContents==''){ |
  | 91 |  | echo json\_encode(array('error'=>'Key is empty'));exit; |
  | 92 |  | } |
  | 93 |  | if(!isset($\_POST['dfquery']) || $\_POST['dfquery']==''){ |
  | 94 |  | echo json\_encode(array('error'=>'Query text is not added!'));exit; |
  | 95 |  | } |
  | 96 |  | $query = sanitize\_text\_field($\_POST['dfquery']); |
  | 97 |  | if(isset($\_POST['sessionid']) && $\_POST['sessionid']!=''){ |
  | 98 |  | $session\_id = sanitize\_text\_field($\_POST['sessionid']); |
  | 99 |  | } |
  | 100 |  |  |
  | 101 |  |  |
  | 102 |  | if(file\_exists(QCLD\_wpCHATBOT\_GC\_DIRNAME.'/autoload.php')){ |
  | 103 |  |  |
  | 104 |  | require(QCLD\_wpCHATBOT\_GC\_DIRNAME.'/autoload.php'); |
  | 105 |  |  |
  | 106 |  | $client = new \Google\_Client(); |
  | 107 |  | $client->useApplicationDefaultCredentials(); |
  | 108 |  | $client->setScopes (['https://www.googleapis.com/auth/dialogflow']); |
  | 109 |  | // Convert to array |
  | 110 |  | $array = json\_decode($JsonFileContents, true); |
  | 111 |  | $client->setAuthConfig($array); |
  | 112 |  |  |
  | 113 |  | try { |
  | 114 |  | $httpClient = $client->authorize(); |
  | 115 |  | $apiUrl = "https://dialogflow.googleapis.com/v2/projects/{$project\_ID}/agent/sessions/{$session\_id}:detectIntent"; |
  | 116 |  |  |
  | 117 |  | $response = $httpClient->request('POST', $apiUrl, [ |
  | 118 |  | 'json' => ['queryInput' => ['text' => ['text' => $query, 'languageCode' => $language]], |
  | 119 |  | 'queryParams' => ['timeZone' => '']] |
  | 120 |  | ]); |
  | 121 |  |  |
  | 122 |  | $contents = $response->getBody()->getContents(); |
  | 123 |  | echo $contents;exit; |
  | 124 |  |  |
  | 125 |  | }catch(Exception $e) { |
  | 126 |  | echo json\_encode(array('error'=>$e->getMessage()));exit; |
  | 127 |  | } |
  |  | 81 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 82 | if ((! wp\_verify\_nonce($nonce,'wp\_chatbot')) && ( ! wp\_verify\_nonce($nonce,'qcsecretbotnonceval123qc'))) { |
  |  | 83 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 84 | wp\_die(); |
  | 128 | 85 |  |
  | 129 | 86 | }else{ |
  | 130 |  | echo json\_encode(array('error'=>'API client not found'));exit; |
  |  | 87 | $session\_id = 'asd2342sde'; |
  |  | 88 | $language = get\_option('qlcd\_wp\_chatbot\_dialogflow\_agent\_language'); |
  |  | 89 | //project ID |
  |  | 90 | $project\_ID = get\_option('qlcd\_wp\_chatbot\_dialogflow\_project\_id'); |
  |  | 91 | // Service Account Key json file |
  |  | 92 | $JsonFileContents = get\_option('qlcd\_wp\_chatbot\_dialogflow\_project\_key'); |
  |  | 93 | if($project\_ID==''){ |
  |  | 94 | echo json\_encode(array('error'=>'Project ID is empty'));exit; |
  |  | 95 | } |
  |  | 96 | if($JsonFileContents==''){ |
  |  | 97 | echo json\_encode(array('error'=>'Key is empty'));exit; |
  |  | 98 | } |
  |  | 99 | if(!isset($\_POST['dfquery']) || $\_POST['dfquery']==''){ |
  |  | 100 | echo json\_encode(array('error'=>'Query text is not added!'));exit; |
  |  | 101 | } |
  |  | 102 | $query = sanitize\_text\_field($\_POST['dfquery']); |
  |  | 103 | if(isset($\_POST['sessionid']) && $\_POST['sessionid']!=''){ |
  |  | 104 | $session\_id = sanitize\_text\_field($\_POST['sessionid']); |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 |  |
  |  | 108 | if(file\_exists(QCLD\_wpCHATBOT\_GC\_DIRNAME.'/autoload.php')){ |
  |  | 109 |  |
  |  | 110 | require(QCLD\_wpCHATBOT\_GC\_DIRNAME.'/autoload.php'); |
  |  | 111 |  |
  |  | 112 | $client = new \Google\_Client(); |
  |  | 113 | $client->useApplicationDefaultCredentials(); |
  |  | 114 | $client->setScopes (['https://www.googleapis.com/auth/dialogflow']); |
  |  | 115 | // Convert to array |
  |  | 116 | $array = json\_decode($JsonFileContents, true); |
  |  | 117 | $client->setAuthConfig($array); |
  |  | 118 |  |
  |  | 119 | try { |
  |  | 120 | $httpClient = $client->authorize(); |
  |  | 121 | $apiUrl = "https://dialogflow.googleapis.com/v2/projects/{$project\_ID}/agent/sessions/{$session\_id}:detectIntent"; |
  |  | 122 |  |
  |  | 123 | $response = $httpClient->request('POST', $apiUrl, [ |
  |  | 124 | 'json' => ['queryInput' => ['text' => ['text' => $query, 'languageCode' => $language]], |
  |  | 125 | 'queryParams' => ['timeZone' => '']] |
  |  | 126 | ]); |
  |  | 127 |  |
  |  | 128 | $contents = $response->getBody()->getContents(); |
  |  | 129 | echo $contents;exit; |
  |  | 130 |  |
  |  | 131 | }catch(Exception $e) { |
  |  | 132 | echo json\_encode(array('error'=>$e->getMessage()));exit; |
  |  | 133 | } |
  |  | 134 |  |
  |  | 135 | }else{ |
  |  | 136 | echo json\_encode(array('error'=>'API client not found'));exit; |
  |  | 137 | } |
  |  | 138 | die(); |
  | 131 | 139 | } |
  | 132 |  | ~~die();~~ |
  | 133 | 140 | } |
* ## [chatbot/trunk/readme.txt](/changeset/2977505/chatbot/trunk/readme.txt?old=2967435&old_path=chatbot%2Ftrunk%2Freadme.txt "Show the [2967435:2977505] differences restricted to chatbot/trunk/readme.txt")

  | [r2967435](/browser/chatbot/trunk/readme.txt?rev=2967435#L5 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/readme.txt?rev=2977505#L5 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 4.6 |
  | 6 | 6 | Tested up to: 6.3 |
  | 7 |  | Stable tag: 4.~~8.9~~ |
  |  | 7 | Stable tag: 4.9.1 |
  | 8 | 8 | Requires PHP: 5.6 |
  | 9 | 9 | License: GPLv2 or later |
  | […](/browser/chatbot/trunk/readme.txt?rev=2967435#L399) | […](/browser/chatbot/trunk/readme.txt?rev=2977505#L399) |  |
  | 399 | 399 | == Changelog == |
  | 400 | 400 |  |
  |  | 401 | = 4.9.1 = |
  |  | 402 | # Improved security |
  |  | 403 | # Removed unnecessary functions |
  |  | 404 |  |
  |  | 405 |  |
  | 401 | 406 | = 4.8.9 = |
  | 402 | 407 | # Minor UI Update |
* ## [chatbot/trunk/templates/app-templates/app-checkout.php](/changeset/2977505/chatbot/trunk/templates/app-templates/app-checkout.php?old=1933241&old_path=chatbot%2Ftrunk%2Ftemplates%2Fapp-templates%2Fapp-checkout.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/templates/app-templates/app-checkout.php")

  | [r2967435](/browser/chatbot/trunk/templates/app-templates/app-checkout.php?rev=1933241#L13 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/templates/app-templates/app-checkout.php?rev=2977505#L13 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 | ?> |
  | 14 | 14 | <script> |
  | 15 |  | jQuery(function ($) { |
  | 16 |  | var ajaxurl = '<?php echo admin\_url('admin-ajax.php'); ?>'; |
  | 17 |  | $("#wp-chatbot-app-checkout-container").parents("body").addClass("wpchatbot-app-checkout"); |
  | 18 |  | $(document).on('click', '.wpcommerce-form-login input[type="submit"]', function (event) { |
  | 19 |  | event.preventDefault(); |
  | 20 |  | var validatorDom=$('.wpcommerce-form-login>p').first(); |
  | 21 |  | var validate=""; |
  | 22 |  | var NonceName=$('#\_wpnonce').attr('name'); |
  | 23 |  | var NonceVal=$('#\_wpnonce').val(); |
  | 24 |  | var userName=$('#username').val(); |
  | 25 |  | var password=$('#password').val(); |
  | 26 |  | if(userName=="" || password=="" ){ |
  | 27 |  | validate+='<p style="color:red"> User name & Password are required. </p>'; |
  | 28 |  | } |
  | 29 |  | if(validate==""){ |
  | 30 |  | var data = {'action': 'qcld\_wb\_chatbot\_checkout\_user\_login','user\_name': userName,'user\_pass': password,'nonce\_name': NonceName,'nonce\_val':NonceVal}; |
  | 31 |  | jQuery.post(ajaxurl, data, function (response) { |
  | 32 |  | if(response=='yes'){ |
  | 33 |  | window.location.reload(true); |
  | 34 |  | }else{ |
  | 35 |  | validatorDom.html('<p style="color:red"> User name Or Password or both are incorrect. </p>'); |
  | 36 |  | setTimeout(function () { |
  | 37 |  | validatorDom.html(''); |
  | 38 |  | },5000); |
  | 39 |  | } |
  | 40 |  | }); |
  | 41 |  | }else{ |
  | 42 |  | validatorDom.html(validate); |
  | 43 |  | setTimeout(function () { |
  | 44 |  | validatorDom.html(''); |
  | 45 |  | },5000); |
  | 46 |  | } |
  | 47 |  | }); |
  | 48 |  | }); |
  |  | 15 | // jQuery(function ($) { |
  |  | 16 | //     var ajaxurl = '<?php // echo admin\_url('admin-ajax.php'); ?>'; |
  |  | 17 | //     var nonce = '<?php // wp\_create\_nonce('login\_nonce'); ?>'; |
  |  | 18 | //     $("#wp-chatbot-app-checkout-container").parents("body").addClass("wpchatbot-app-checkout"); |
  |  | 19 | //     $(document).on('click', '.wpcommerce-form-login input[type="submit"]', function (event) { |
  |  | 20 | //         event.preventDefault(); |
  |  | 21 | //         var validatorDom=$('.wpcommerce-form-login>p').first(); |
  |  | 22 | //         var validate=""; |
  |  | 23 | //         var NonceName=$('#\_wpnonce').attr('name'); |
  |  | 24 | //         var NonceVal=$('#\_wpnonce').val(); |
  |  | 25 | //         var userName=$('#username').val(); |
  |  | 26 | //         var password=$('#password').val(); |
  |  | 27 | //         if(userName=="" || password=="" ){ |
  |  | 28 | //             validate+='<p style="color:red"> User name & Password are required. </p>'; |
  |  | 29 | //         } |
  |  | 30 | //         if(validate==""){ |
  |  | 31 | //             var data = {'action': 'qcld\_wb\_chatbot\_checkout\_user\_login','user\_name': userName,'user\_pass': password,'nonce\_name': NonceName,'nonce\_val':NonceVal}; |
  |  | 32 | //             jQuery.post(ajaxurl, data, function (response) { |
  |  | 33 | //                 if(response=='yes'){ |
  |  | 34 | //                     window.location.reload(true); |
  |  | 35 | //                 }else{ |
  |  | 36 | //                     validatorDom.html('<p style="color:red"> User name Or Password or both are incorrect. </p>'); |
  |  | 37 | //                     setTimeout(function () { |
  |  | 38 | //                         validatorDom.html(''); |
  |  | 39 | //                     },5000); |
  |  | 40 | //                 } |
  |  | 41 | //             }); |
  |  | 42 | //         }else{ |
  |  | 43 | //             validatorDom.html(validate); |
  |  | 44 | //             setTimeout(function () { |
  |  | 45 | //                 validatorDom.html(''); |
  |  | 46 | //             },5000); |
  |  | 47 | //         } |
  |  | 48 | //     }); |
  |  | 49 | // }); |
  | 49 | 50 | </script> |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2977505&old=2967435&new_path=%2Fchatbot%2Ftrunk&old_path=%2Fchatbot%2Ftrunk)
* [Zip Archive](?format=zip&new=2977505&old=2967435&new_path=%2Fchatbot%2Ftrunk&old_path=%2Fchatbot%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_0fc1927b_20250114_204627.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fchatbot%2Ftrunk%2Ffunctions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/chatbot/trunk/functions.php?rev=3119022 "Revision 3119022")
* Next Revision →
* [Blame](/browser/chatbot/trunk/functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/chatbot/trunk/functions.php)

---

# [source:](/browser?order=name "Go to repository root") [chatbot](/browser/chatbot?order=name "View chatbot")/[trunk](/browser/chatbot/trunk?order=name "View trunk")/[functions.php](/browser/chatbot/trunk/functions.php?order=name "View functions.php")

View diff against:

View revision:

| [Last change](/changeset/3203538/chatbot/trunk/functions.php "View differences") on this file was [3203538](/changeset/3203538/ "View changeset 3203538"), checked in by quantumcloud, [6 weeks ago](/timeline?from=2024-12-06T10%3A54%3A59Z&precision=second "See timeline at 12/06/2024 10:54:59 AM") |
| --- |
| Updated some depreciate code |
| **File size:** 104.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* @param $type |
| [4](#L4) | \* Display wpwBot Icon ball |
| [5](#L5) | \*/ |
| [6](#L6) | if (!defined('ABSPATH')) exit; // Exit if accessed directly |
| [7](#L7) | add\_action('wp\_footer', 'wp\_chatbot\_load\_footer\_html'); |
| [8](#L8) | add\_action( 'admin\_footer', 'qc\_style\_for\_hide\_iframe'); |
| [9](#L9) | function qc\_style\_for\_hide\_iframe(){ |
| [10](#L10) | ?> |
| [11](#L11) | <script> |
| [12](#L12) | jQuery( document ).ready(function() { |
| [13](#L13) | setInterval(function(){ |
| [14](#L14) | if(document.querySelector('.wp-block-legacy-widget\_\_edit-preview-iframe')){ |
| [15](#L15) | document.querySelector('.wp-block-legacy-widget\_\_edit-preview-iframe').addEventListener("load", ev => { |
| [16](#L16) | jQuery('.wp-block-legacy-widget\_\_edit-preview-iframe').contents().find('#wp-chatbot-chat-container').hide(); |
| [17](#L17) | }); |
| [18](#L18) |  |
| [19](#L19) | } |
| [20](#L20) | }, 500); |
| [21](#L21) | }); |
| [22](#L22) | </script> |
| [23](#L23) | <?php |
| [24](#L24) | } |
| [25](#L25) | function wp\_chatbot\_load\_footer\_html(){ |
| [26](#L26) | if ( get\_option('disable\_wp\_chatbot') != 1 && wp\_chatbot\_load\_controlling() === true) { |
| [27](#L27) |  |
| [28](#L28) | ?> |
| [29](#L29) | <style> |
| [30](#L30) | <?php if(get\_option('wp\_chatbot\_custom\_css')!="") { |
| [31](#L31) | //Sanitization to be checked |
| [32](#L32) | // phpcs:ignore |
| [33](#L33) | echo sanitize\_text\_field(get\_option('wp\_chatbot\_custom\_css')); |
| [34](#L34) | } |
| [35](#L35) | ?> |
| [36](#L36) | </style> |
| [37](#L37) |  |
| [38](#L38) | <?php if (get\_option('qcld\_wb\_chatbot\_change\_bg') == 1) { |
| [39](#L39) | if (get\_option('qcld\_wb\_chatbot\_board\_bg\_path') != "") { |
| [40](#L40) | $qcld\_wb\_chatbot\_board\_bg\_path = get\_option('qcld\_wb\_chatbot\_board\_bg\_path'); |
| [41](#L41) | } else { |
| [42](#L42) | $qcld\_wb\_chatbot\_board\_bg\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'background/background.png'; |
| [43](#L43) | } |
| [44](#L44) | ?> |
| [45](#L45) | <style> |
| [46](#L46) | .wp-chatbot-container { |
| [47](#L47) | background-image: url(<?php echo esc\_url($qcld\_wb\_chatbot\_board\_bg\_path); ?>) !important; |
| [48](#L48) | } |
| [49](#L49) | </style> |
| [50](#L50) | <?php } |
| [51](#L51) | $wp\_chatbot\_enable\_rtl = ""; |
| [52](#L52) | if (get\_option('enable\_wp\_chatbot\_rtl') == '1') { |
| [53](#L53) | $wp\_chatbot\_enable\_rtl .= "wp-chatbot-rtl"; |
| [54](#L54) | } |
| [55](#L55) | $wp\_chatbot\_enable\_mobile\_screen = ""; |
| [56](#L56) | //  if (get\_option('enable\_wp\_chatbot\_mobile\_full\_screen')==1) { |
| [57](#L57) | $wp\_chatbot\_enable\_mobile\_screen .= "wp-chatbot-mobile-full-screen"; |
| [58](#L58) | // } |
| [59](#L59) | ?> |
| [60](#L60) | <div id="wp-chatbot-chat-container" class="<?php echo esc\_attr($wp\_chatbot\_enable\_rtl .' '.$wp\_chatbot\_enable\_mobile\_screen); ?>"> |
| [61](#L61) | <div id="wp-chatbot-integration-container"> |
| [62](#L62) | <div class="wp-chatbot-integration-button-container"> |
| [63](#L63) | <?php if (get\_option('enable\_wp\_chatbot\_skype\_floating\_icon') == 1) { ?> |
| [64](#L64) | <a href="skype:<?php echo esc\_attr(get\_option('enable\_wp\_chatbot\_skype\_id')); ?>?chat"><span |
| [65](#L65) | class="inetegration-skype-btn" title="<?php esc\_attr\_e('Skype', 'wpchatbot'); ?>"> </span></a> |
| [66](#L66) | <?php } ?> |
| [67](#L67) | <?php if (get\_option('enable\_wp\_chatbot\_floating\_whats') == 1) { ?> |
| [68](#L68) | <a href="<?php echo esc\_url('https://api.whatsapp.com/send?phone=' . get\_option('qlcd\_wp\_chatbot\_whats\_num')); ?>" |
| [69](#L69) | target="\_blank"><span class="intergration-whats" |
| [70](#L70) | title="<?php esc\_html\_e('WhatsApp', 'wpchatbot'); ?>"></span></a> |
| [71](#L71) | <?php } ?> |
| [72](#L72) | <?php if (get\_option('enable\_wp\_chatbot\_floating\_viber') == 1) { ?> |
| [73](#L73) | <a href="<?php echo esc\_url('https://live.viber.com/#/' . get\_option('qlcd\_wp\_chatbot\_viber\_acc')); ?>" |
| [74](#L74) | target="\_blank"><span class="intergration-viber" |
| [75](#L75) | title="<?php esc\_html\_e('Viber', 'wpchatbot'); ?>"></span></a> |
| [76](#L76) | <?php } ?> |
| [77](#L77) | <?php if (get\_option('enable\_wp\_chatbot\_floating\_phone') == 1 && get\_option('qlcd\_wp\_chatbot\_phone') != "") { ?> |
| [78](#L78) | <a href="tel:<?php echo esc\_attr(get\_option('qlcd\_wp\_chatbot\_phone')); ?>"><span |
| [79](#L79) | class="intergration-phone" |
| [80](#L80) | title="<?php esc\_html\_e('Phone', 'wpchatbot'); ?>"> </span></a> |
| [81](#L81) | <?php } ?> |
| [82](#L82) | <?php if (get\_option('enable\_wp\_chatbot\_floating\_link') == 1 && get\_option('qlcd\_wp\_chatbot\_weblink') != "") { ?> |
| [83](#L83) | <a href="<?php echo esc\_url(get\_option('qlcd\_wp\_chatbot\_weblink')); ?>" target="\_blank"><span |
| [84](#L84) | class="intergration-weblink" title="<?php esc\_html\_e('Web Link', 'wpchatbot'); ?>"></span></a> |
| [85](#L85) | <?php } ?> |
| [86](#L86) | </div> |
| [87](#L87) | </div> |
| [88](#L88) | <?php |
| [89](#L89) | //Get wpcommerce cart |
| [90](#L90) |  |
| [91](#L91) | $qcld\_wb\_chatbot\_theme = get\_option('qcld\_wb\_chatbot\_theme'); |
| [92](#L92) | if (file\_exists(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/style.css')) { |
| [93](#L93) | wp\_register\_style('qcld-wp-chatbot-style', plugins\_url(basename(plugin\_dir\_path(\_\_FILE\_\_)) . '/templates/' . $qcld\_wb\_chatbot\_theme . '/style.css', basename(\_\_FILE\_\_)), '', QCLD\_wpCHATBOT\_VERSION, 'screen'); |
| [94](#L94) | wp\_enqueue\_style('qcld-wp-chatbot-style'); |
| [95](#L95) | } |
| [96](#L96) | if (file\_exists(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/template.php')) { |
| [97](#L97) | require\_once(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/template.php'); |
| [98](#L98) | } else { |
| [99](#L99) | echo "<h2>" . esc\_html\_\_('No wpWBot Theme Found!', 'wpchatbot') . "</h2>"; |
| [100](#L100) | } |
| [101](#L101) | ?> |
| [102](#L102) | <?php |
| [103](#L103) | if (get\_option('disable\_wp\_chatbot\_notification') != 1) { |
| [104](#L104) | ?> |
| [105](#L105) | <div id="wp-chatbot-notification-container" class="wp-chatbot-notification-container"> |
| [106](#L106) | <div class="wp-chatbot-notification-controller"> |
| [107](#L107) | <span class="wp-chatbot-notification-close"> |
| [108](#L108) | <?php esc\_html\_e('X', 'wpchatbot'); ?> |
| [109](#L109) | </span> |
| [110](#L110) | </div> |
| [111](#L111) | <?php |
| [112](#L112) | $testingTip=""; |
| [113](#L113) | if (get\_option('wp\_chatbot\_agent\_image') == "custom-agent.png") { |
| [114](#L114) | $wp\_chatbot\_custom\_agent\_path = get\_option('wp\_chatbot\_custom\_agent\_path'); |
| [115](#L115) | } else if (get\_option('wp\_chatbot\_agent\_image') != "custom-agent.png") { |
| [116](#L116) | $wp\_chatbot\_custom\_agent\_path = QCLD\_wpCHATBOT\_IMG\_URL . get\_option('wp\_chatbot\_agent\_image'); |
| [117](#L117) | } else { |
| [118](#L118) | $wp\_chatbot\_custom\_agent\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'custom-agent.png'; |
| [119](#L119) | } |
| [120](#L120) | ?> |
| [121](#L121) | <div class="wp-chatbot-notification-agent-profile"> |
| [122](#L122) | <div class="wp-chatbot-notification-widget-avatar" ><img |
| [123](#L123) | src="<?php echo esc\_attr($wp\_chatbot\_custom\_agent\_path); ?>" alt=""></div> |
| [124](#L124) | <div class="wp-chatbot-notification-welcome"><?php echo wp\_kses\_post(wpb\_randmom\_message\_handle(maybe\_unserialize(get\_option('qlcd\_wp\_chatbot\_welcome')))) . ' <strong>' . esc\_html(get\_option('qlcd\_wp\_chatbot\_host')) . '</strong>'; ?></div> |
| [125](#L125) | </div> |
| [126](#L126) | <?php |
| [127](#L127) | //update\_option('qlcd\_wp\_chatbot\_notifications','Welcome to WpBot'); |
| [128](#L128) | $notifications = qcld\_wb\_chatbot\_func\_str\_replace(wp\_kses\_post(maybe\_unserialize(get\_option('qlcd\_wp\_chatbot\_notifications')))); |
| [129](#L129) |  |
| [130](#L130) | ?> |
| [131](#L131) |  |
| [132](#L132) | <div class="wp-chatbot-notification-message"><?php echo esc\_html($notifications[0]); ?></div> |
| [133](#L133) | </div> |
| [134](#L134) | <?php } ?> |
| [135](#L135) | <!--wp-chatbot-board-container--> |
| [136](#L136) | <div id="wp-chatbot-ball" class=""> |
| [137](#L137) | <div class="wp-chatbot-ball"> |
| [138](#L138) | <div class="wp-chatbot-ball-animator wp-chatbot-ball-animation-switch"></div> |
| [139](#L139) | <?php |
| [140](#L140) | if (get\_option('wp\_chatbot\_icon') == "custom.png") { |
| [141](#L141) | $wp\_chatbot\_custom\_icon\_path = (!empty(get\_option('wp\_chatbot\_custom\_icon\_path'))) ? get\_option('wp\_chatbot\_custom\_icon\_path') : QCLD\_wpCHATBOT\_IMG\_URL . 'icon-1.png'; |
| [142](#L142) |  |
| [143](#L143) | } else if (get\_option('wp\_chatbot\_icon') != "custom.png") { |
| [144](#L144) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . get\_option('wp\_chatbot\_icon'); |
| [145](#L145) | } else { |
| [146](#L146) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'custom.png'; |
| [147](#L147) | } |
| [148](#L148) | ?> |
| [149](#L149) | <img src="<?php echo esc\_url($wp\_chatbot\_custom\_icon\_path); ?>" |
| [150](#L150) | alt="wpChatIcon" qcld\_agent="<?php echo esc\_url($wp\_chatbot\_custom\_icon\_path); ?>" > |
| [151](#L151) |  |
| [152](#L152) | </div> |
| [153](#L153) | </div> |
| [154](#L154) | <?php |
| [155](#L155) | $fb\_app\_id = get\_option('qlcd\_wp\_chatbot\_fb\_app\_id'); |
| [156](#L156) | $fb\_page\_id = get\_option('qlcd\_wp\_chatbot\_fb\_page\_id'); |
| [157](#L157) | $fb\_mgs\_color = get\_option('qlcd\_wp\_chatbot\_fb\_color') != '' ? get\_option('qlcd\_wp\_chatbot\_fb\_color') : '#0084ff'; |
| [158](#L158) | $fb\_mgs\_in = get\_option('qlcd\_wp\_chatbot\_fb\_in\_msg') != '' ? get\_option('qlcd\_wp\_chatbot\_fb\_in\_msg') : 'You are welcome'; |
| [159](#L159) | $fb\_mgs\_out = get\_option('qlcd\_wp\_chatbot\_fb\_out\_msg') != '' ? get\_option('qlcd\_wp\_chatbot\_fb\_out\_msg') : 'You are not logged in'; |
| [160](#L160) | if (get\_option('enable\_wp\_chatbot\_messenger') == 1 && get\_option('enable\_wp\_chatbot\_messenger\_floating\_icon') == 1) { |
| [161](#L161) | ?> |
| [162](#L162) | <!--                wp-chatbot-board-container--> |
| [163](#L163) | <script> |
| [164](#L164) |  |
| [165](#L165) | window.fbAsyncInit = function () { |
| [166](#L166) | FB.init({ |
| [167](#L167) | appId: '<?php echo esc\_js($fb\_app\_id); ?>', |
| [168](#L168) | autoLogAppEvents: true, |
| [169](#L169) | xfbml: true, |
| [170](#L170) | version: 'v2.12' |
| [171](#L171) | }); |
| [172](#L172) | }; |
| [173](#L173) |  |
| [174](#L174) | (function (d, s, id) { |
| [175](#L175) | var js, fjs = d.getElementsByTagName(s)[0]; |
| [176](#L176) | if (d.getElementById(id)) return; |
| [177](#L177) | js = d.createElement(s); |
| [178](#L178) | js.id = id; |
| [179](#L179) | js.src = 'https://connect.facebook.net/en\_US/sdk.js'; |
| [180](#L180) | fjs.parentNode.insertBefore(js, fjs); |
| [181](#L181) | }(document, 'script', 'facebook-jssdk')); |
| [182](#L182) | </script> |
| [183](#L183) | <div class="fb-customerchat" |
| [184](#L184) | page\_id="<?php echo esc\_attr($fb\_page\_id); ?>" |
| [185](#L185) | greeting\_dialog\_display="hide" |
| [186](#L186) | theme\_color="<?php echo esc\_attr($fb\_mgs\_color); ?>" |
| [187](#L187) | logged\_in\_greeting="<?php echo esc\_attr($fb\_mgs\_in); ?>" |
| [188](#L188) | logged\_out\_greeting="<?php echo esc\_attr($fb\_mgs\_out); ?>"></div> |
| [189](#L189) | <?php |
| [190](#L190) | } |
| [191](#L191) | ?> |
| [192](#L192) | <!--container--> |
| [193](#L193) | <!--wp-chatbot-ball-wrapper--> |
| [194](#L194) | </div> |
| [195](#L195) |  |
| [196](#L196) | <?php |
| [197](#L197) |  |
| [198](#L198) | if ( get\_transient( 'bot\_clear\_cache' ) ) { |
| [199](#L199) | echo  '<script type="text/javascript">var wpbot\_clear\_cache = 1 </script>'; |
| [200](#L200) | delete\_transient( 'bot\_clear\_cache' ); |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | }else{ |
| [204](#L204) | ?> |
| [205](#L205) | <script> |
| [206](#L206) | var openingHourIsFn = 1; |
| [207](#L207) | </script> |
| [208](#L208) | <?php |
| [209](#L209) | } |
| [210](#L210) | } |
| [211](#L211) | //wp\_chatbot load control handler. |
| [212](#L212) | function wp\_chatbot\_load\_controlling(){ |
| [213](#L213) | $wp\_chatbot\_load = true; |
| [214](#L214) |  |
| [215](#L215) |  |
| [216](#L216) | if (get\_option('wp\_chatbot\_show\_pages') == 'off') { |
| [217](#L217) | $wp\_chatbot\_select\_pages = unserialize(get\_option('wp\_chatbot\_show\_pages\_list')); |
| [218](#L218) | if (is\_page() && !empty($wp\_chatbot\_select\_pages)) { |
| [219](#L219) |  |
| [220](#L220) | if (in\_array(get\_the\_ID(), $wp\_chatbot\_select\_pages) == true) { |
| [221](#L221) |  |
| [222](#L222) | $wp\_chatbot\_load = true; |
| [223](#L223) | } else { |
| [224](#L224) | $wp\_chatbot\_load = false; |
| [225](#L225) | } |
| [226](#L226) |  |
| [227](#L227) | } |
| [228](#L228) |  |
| [229](#L229) | if(function\_exists('is\_shop')){ |
| [230](#L230) | if (is\_shop() || is\_cart() || is\_checkout() || 'product' == get\_post\_type()) { |
| [231](#L231) | $wp\_chatbot\_load = false; |
| [232](#L232) | } |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | } |
| [236](#L236) | if (get\_option('wp\_chatbot\_show\_wpcommerce') == 'off') { |
| [237](#L237) |  |
| [238](#L238) | } |
| [239](#L239) | //load wpwbot shortcode template and prevent default wpwbot from footer. |
| [240](#L240) | if (is\_page()) { |
| [241](#L241) | $page\_id = get\_the\_ID(); |
| [242](#L242) | $page = get\_post($page\_id); |
| [243](#L243) | if (has\_shortcode($page->post\_content, 'wpwbot')) { |
| [244](#L244) | $wp\_chatbot\_load = false; |
| [245](#L245) | } |
| [246](#L246) | } |
| [247](#L247) |  |
| [248](#L248) | $post\_list = maybe\_unserialize(get\_option('wp\_chatbot\_exclude\_post\_list')); |
| [249](#L249) |  |
| [250](#L250) | if( is\_array( $post\_list ) && in\_array(get\_post\_type(), $post\_list)){ |
| [251](#L251) | $wp\_chatbot\_load = false; |
| [252](#L252) | } |
| [253](#L253) | if (wp\_chatbot\_is\_mobile() && get\_option('disable\_wp\_chatbot\_on\_mobile') == 1) { |
| [254](#L254) | $wp\_chatbot\_load = false; |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) | if (get\_option('wp\_chatbot\_show\_home\_page') == 'off' && is\_home()) { |
| [258](#L258) | $wp\_chatbot\_load = false; |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | if (get\_option('wp\_chatbot\_show\_posts') == 'off' && 'post' == get\_post\_type()) { |
| [262](#L262) | $wp\_chatbot\_load = false; |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | if(is\_admin()){ |
| [266](#L266) | $wp\_chatbot\_load = false; |
| [267](#L267) | } |
| [268](#L268) | return $wp\_chatbot\_load; |
| [269](#L269) | } |
| [270](#L270) | //checking Devices |
| [271](#L271) | function wp\_chatbot\_is\_mobile(){ |
| [272](#L272) | $useragent = $\_SERVER['HTTP\_USER\_AGENT']; |
| [273](#L273) | if (preg\_match('/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i', $useragent) || preg\_match('/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|\_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |\_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i', substr($useragent, 0, 4))) { |
| [274](#L274) | return true; |
| [275](#L275) | } else { |
| [276](#L276) | return false; |
| [277](#L277) | } |
| [278](#L278) | } |
| [279](#L279) | //Checking wpwbot opening hour |
| [280](#L280) | function wp\_chatbot\_check\_opening\_hours(){ |
| [281](#L281) | $curent\_day=strtolower(date('l',strtotime(current\_time( 'mysql' )))); |
| [282](#L282) | $current\_time=date('H:i',strtotime(current\_time( 'mysql'))); |
| [283](#L283) | $is\_wpwbot\_open =false; |
| [284](#L284) | if(get\_option('wpwbot\_hours')) { |
| [285](#L285) | $wpwbot\_times = wp\_kses\_post(unserialize(get\_option('wpwbot\_hours'))); |
| [286](#L286) | if (isset($wpwbot\_times[$curent\_day])) { |
| [287](#L287) | $day\_times = $wpwbot\_times[$curent\_day]; |
| [288](#L288) | if (!empty($day\_times)) { |
| [289](#L289) | foreach ($day\_times as $day\_time) { |
| [290](#L290) | if(strtotime($current\_time) > strtotime($day\_time[0]) && strtotime($current\_time) < strtotime($day\_time[1])  ){ |
| [291](#L291) | $is\_wpwbot\_open=true; |
| [292](#L292) | } |
| [293](#L293) | } |
| [294](#L294) | } |
| [295](#L295) | } |
| [296](#L296) | } |
| [297](#L297) | return $is\_wpwbot\_open; |
| [298](#L298) | } |
| [299](#L299) | //wpwBot shortcode. |
| [300](#L300) | add\_shortcode('wpwbot', 'wp\_chatbot\_short\_code'); |
| [301](#L301) | function wp\_chatbot\_short\_code($atts = []){ |
| [302](#L302) | ob\_start(); |
| [303](#L303) | wp\_chatbot\_shortcode\_dom($atts); |
| [304](#L304) | $content = ob\_get\_clean(); |
| [305](#L305) | return $content; |
| [306](#L306) | } |
| [307](#L307) | function wp\_chatbot\_shortcode\_dom($atts){ |
| [308](#L308) | //Defaults & Set Parameters for shortcode |
| [309](#L309) | extract(shortcode\_atts( |
| [310](#L310) | array( |
| [311](#L311) | 'template' => '01', |
| [312](#L312) | ), $atts |
| [313](#L313) | )); |
| [314](#L314) | ?> |
| [315](#L315) | <style> |
| [316](#L316) | <?php if(get\_option('wp\_chatbot\_custom\_css')!=""){ |
| [317](#L317) | //Sanitization to be checked |
| [318](#L318) | // phpcs:ignore |
| [319](#L319) | echo sanitize\_text\_field(get\_option('wp\_chatbot\_custom\_css')); |
| [320](#L320) | } ?> |
| [321](#L321) | </style> |
| [322](#L322) | <?php if (get\_option('qcld\_wb\_chatbot\_change\_bg') == 1) { |
| [323](#L323) | if (get\_option('qcld\_wb\_chatbot\_board\_bg\_path') != "") { |
| [324](#L324) | $qcld\_wb\_chatbot\_board\_bg\_path = get\_option('qcld\_wb\_chatbot\_board\_bg\_path'); |
| [325](#L325) | } else { |
| [326](#L326) | $qcld\_wb\_chatbot\_board\_bg\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'background/background.png'; |
| [327](#L327) | } |
| [328](#L328) | ?> |
| [329](#L329) | <style> |
| [330](#L330) | .wp-chatbot-container { |
| [331](#L331) | background: url(<?php echo esc\_url($qcld\_wb\_chatbot\_board\_bg\_path) ;?>) no-repeat top right !important; |
| [332](#L332) | } |
| [333](#L333) | </style> |
| [334](#L334) | <?php } |
| [335](#L335) | $wp\_chatbot\_enable\_rtl = ""; |
| [336](#L336) | if (get\_option('enable\_wp\_chatbot\_rtl')) { |
| [337](#L337) | $wp\_chatbot\_enable\_rtl .= "wp-chatbot-rtl"; |
| [338](#L338) | } |
| [339](#L339) | ?> |
| [340](#L340) | <div id="wp-chatbot-chat-container" class="<?php echo esc\_attr($wp\_chatbot\_enable\_rtl); ?>"> |
| [341](#L341) | <?php |
| [342](#L342) | //Get wpcommerce cart |
| [343](#L343) |  |
| [344](#L344) | $qcld\_wb\_chatbot\_theme = 'template-' . $template; |
| [345](#L345) | if (file\_exists(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/style.css')) { |
| [346](#L346) | wp\_register\_style('qcld-wp-chatbot-style', plugins\_url(basename(plugin\_dir\_path(\_\_FILE\_\_)) . '/templates/' . $qcld\_wb\_chatbot\_theme . '/style.css', basename(\_\_FILE\_\_)), '', QCLD\_wpCHATBOT\_VERSION, 'screen'); |
| [347](#L347) | wp\_enqueue\_style('qcld-wp-chatbot-style'); |
| [348](#L348) | } |
| [349](#L349) | if (file\_exists(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/template.php')) { |
| [350](#L350) | require\_once(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/template.php'); |
| [351](#L351) | } else { |
| [352](#L352) | echo "<h2>" . esc\_html\_\_('No wpWBot Theme Found!', 'wpchatbot') . "</h2>"; |
| [353](#L353) | } |
| [354](#L354) | ?> |
| [355](#L355) | <?php if (get\_option('disable\_wp\_chatbot') != 1): ?> |
| [356](#L356) | <div id="wp-chatbot-notification-container" class="wp-chatbot-notification-container"> |
| [357](#L357) | <div class="wp-chatbot-notification-controller"> <span class="wp-chatbot-notification-close">X</span> </div> |
| [358](#L358) | <?php |
| [359](#L359) | if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') == "custom-agent.png") { |
| [360](#L360) | $wp\_chatbot\_custom\_icon\_path = get\_option('wp\_chatbot\_custom\_agent\_path'); |
| [361](#L361) | } else if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') != "custom-agent.png") { |
| [362](#L362) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . get\_option('wp\_chatbot\_agent\_image'); |
| [363](#L363) | } else { |
| [364](#L364) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'custom-agent.png'; |
| [365](#L365) | } |
| [366](#L366) | ?> |
| [367](#L367) | <div class="wp-chatbot-notification-agent-profile"> |
| [368](#L368) | <div class="wp-chatbot-notification-widget-avatar"><img |
| [369](#L369) | src="<?php echo esc\_url($wp\_chatbot\_custom\_icon\_path); ?>" alt=""></div> |
| [370](#L370) | <div class="wp-chatbot-notification-welcome"><?php echo wp\_kses\_post(wpb\_randmom\_message\_handle(maybe\_unserialize(get\_option('qlcd\_wp\_chatbot\_welcome')))) . ' <strong>' . esc\_html(get\_option('qlcd\_wp\_chatbot\_host')) . '</strong>'; ?></div> |
| [371](#L371) | </div> |
| [372](#L372) | <div class="wp-chatbot-notification-message"><?php echo wp\_kses\_post(wpb\_randmom\_message\_handle(maybe\_unserialize(get\_option('qlcd\_wp\_chatbot\_notifications')))); ?></div> |
| [373](#L373) | </div> |
| [374](#L374) | <!--wp-chatbot-board-container--> |
| [375](#L375) | <div id="wp-chatbot-ball" class=""> |
| [376](#L376) | <div class="wp-chatbot-ball"> |
| [377](#L377) | <div class="wp-chatbot-ball-animator wp-chatbot-ball-animation-switch"></div> |
| [378](#L378) | <?php |
| [379](#L379) | if (get\_option('wp\_chatbot\_custom\_icon\_path') != "" && get\_option('wp\_chatbot\_icon') == "custom.png") { |
| [380](#L380) | $wp\_chatbot\_custom\_icon\_path = get\_option('wp\_chatbot\_custom\_icon\_path'); |
| [381](#L381) | } else if (get\_option('wp\_chatbot\_custom\_icon\_path') != "" && get\_option('wp\_chatbot\_icon') != "custom.png") { |
| [382](#L382) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . get\_option('wp\_chatbot\_icon'); |
| [383](#L383) | } else { |
| [384](#L384) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'custom.png'; |
| [385](#L385) | } |
| [386](#L386) | ?> |
| [387](#L387) | <img src="<?php echo  esc\_url($wp\_chatbot\_custom\_icon\_path); ?>" |
| [388](#L388) | alt="wpChatIcon"> <!--<span class="wp-chatbot-ball-cart-items"><?php echo esc\_html( $cart\_items\_number ); ?></span>--> </div> |
| [389](#L389) | </div> |
| [390](#L390) | <!--                wp-chatbot-board-container--> |
| [391](#L391) | <?php endif; ?> |
| [392](#L392) | <!--container--> |
| [393](#L393) | <!--wp-chatbot-ball-wrapper--> |
| [394](#L394) | </div> |
| [395](#L395) | <?php } ?> |
| [396](#L396) | <?php |
| [397](#L397) | //Create shortcode for wpwBot for pages. |
| [398](#L398) | add\_shortcode('wpbot-page', 'wp\_chatbot\_page\_short\_code'); |
| [399](#L399) | function wp\_chatbot\_page\_short\_code(){ |
| [400](#L400) | ob\_start(); |
| [401](#L401) | wp\_chatbot\_page\_dom(); |
| [402](#L402) | $content = ob\_get\_clean(); |
| [403](#L403) | return $content; |
| [404](#L404) | } |
| [405](#L405) | function wp\_chatbot\_page\_dom(){ ?> |
| [406](#L406) | <style> |
| [407](#L407) | <?php |
| [408](#L408) | if(get\_option('wp\_chatbot\_custom\_css')!=""){ |
| [409](#L409) | //Sanitization to be checked |
| [410](#L410) | // phpcs:ignore |
| [411](#L411) | echo sanitize\_text\_field(get\_option('wp\_chatbot\_custom\_css')); |
| [412](#L412) | } ?> |
| [413](#L413) | </style> |
| [414](#L414) | <?php |
| [415](#L415) | //Get wpcommerce cart |
| [416](#L416) |  |
| [417](#L417) | $qcld\_wb\_chatbot\_theme = get\_option('qcld\_wb\_chatbot\_theme'); |
| [418](#L418) | $wp\_chatbot\_enable\_rtl = ""; |
| [419](#L419) | if (get\_option('enable\_wp\_chatbot\_rtl') == 1) { |
| [420](#L420) | $wp\_chatbot\_enable\_rtl .= "wp-chatbot-rtl"; |
| [421](#L421) | } |
| [422](#L422) | if (file\_exists(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/shortcode.php')) { |
| [423](#L423) | require\_once(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/shortcode.php'); |
| [424](#L424) | } else { |
| [425](#L425) | echo "<h2>" . esc\_html\_\_('No WPBot ShortCode Theme Found!', 'wpchatbot') . "</h2>"; |
| [426](#L426) | } |
| [427](#L427) | } |
| [428](#L428) | //shortcode for wpWBot mobile app |
| [429](#L429) | add\_shortcode('wpwbot\_app', 'wp\_chatbot\_mobile\_app\_short\_code'); |
| [430](#L430) | function wp\_chatbot\_mobile\_app\_short\_code(){ ?> |
| [431](#L431) | <style> |
| [432](#L432) | <?php |
| [433](#L433) | if(get\_option('wp\_chatbot\_custom\_css')!=""){ |
| [434](#L434) | //Sanitization to be checked |
| [435](#L435) | // phpcs:ignore |
| [436](#L436) | echo sanitize\_text\_field(get\_option('wp\_chatbot\_custom\_css')); |
| [437](#L437) | } |
| [438](#L438) | ?> |
| [439](#L439) | </style> |
| [440](#L440) | <?php if (get\_option('qcld\_wb\_chatbot\_change\_bg') == 1) { |
| [441](#L441) | if (get\_option('qcld\_wb\_chatbot\_board\_bg\_path') != "") { |
| [442](#L442) | $qcld\_wb\_chatbot\_board\_bg\_path = get\_option('qcld\_wb\_chatbot\_board\_bg\_path'); |
| [443](#L443) | } else { |
| [444](#L444) | $qcld\_wb\_chatbot\_board\_bg\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'background/background.png'; |
| [445](#L445) | } |
| [446](#L446) | ?> |
| [447](#L447) | <style> |
| [448](#L448) | .wp-chatbot-container { |
| [449](#L449) | background: url(<?php echo esc\_url($qcld\_wb\_chatbot\_board\_bg\_path) ;?>) no-repeat top right !important; |
| [450](#L450) | } |
| [451](#L451) | </style> |
| [452](#L452) | <?php } |
| [453](#L453) | $wp\_chatbot\_enable\_rtl = ""; |
| [454](#L454) | if (get\_option('enable\_wp\_chatbot\_rtl') == '1') { |
| [455](#L455) | $wp\_chatbot\_enable\_rtl .= "wp-chatbot-rtl"; |
| [456](#L456) | } |
| [457](#L457) | ?> |
| [458](#L458) | <div id="wp-chatbot-chat-app-shortcode-container" class="<?php echo esc\_attr($wp\_chatbot\_enable\_rtl); ?>"> |
| [459](#L459) | <?php |
| [460](#L460) | // keep traking app template. |
| [461](#L461) | $template\_app = 'yes'; |
| [462](#L462) | //Get wpcommerce cart |
| [463](#L463) |  |
| [464](#L464) | //Handling shortcode enqeue and remove features part. |
| [465](#L465) | define('wpCOMMERCE', true); |
| [466](#L466) | wp\_enqueue\_script('jquery'); |
| [467](#L467) |  |
| [468](#L468) |  |
| [469](#L469) | wp\_enqueue\_script('wc-address-i18n'); |
| [470](#L470) | wp\_enqueue\_script('wc-country-select'); |
| [471](#L471) |  |
| [472](#L472) |  |
| [473](#L473) | // add the action |
| [474](#L474) | if (isset($\_GET['from']) && $\_GET['from'] == 'app') { |
| [475](#L475) | if (!isset($\_COOKIE['from\_app'])) { |
| [476](#L476) | setcookie('from\_app', 'yes', time() + 3600); |
| [477](#L477) | } |
| [478](#L478) | } |
| [479](#L479) | $qcld\_wb\_chatbot\_theme = get\_option('qcld\_wb\_chatbot\_theme'); |
| [480](#L480) | if (file\_exists(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/template.php')) { |
| [481](#L481) | require\_once(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . '/templates/' . $qcld\_wb\_chatbot\_theme . '/template.php'); |
| [482](#L482) | } else { |
| [483](#L483) | echo "<h2>" . esc\_html\_\_('No WPBot Theme Found!', 'wpchatbot') . "</h2>"; |
| [484](#L484) | } |
| [485](#L485) | ?> |
| [486](#L486) | </div> |
| [487](#L487) | <?php |
| [488](#L488) | } |
| [489](#L489) |  |
| [490](#L490) | /\*\* |
| [491](#L491) | \* wpwBot Search keyword product |
| [492](#L492) | \*/ |
| [493](#L493) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_keyword', 'qcld\_wb\_chatbot\_keyword'); |
| [494](#L494) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_keyword', 'qcld\_wb\_chatbot\_keyword'); |
| [495](#L495) | function qcld\_wb\_chatbot\_keyword(){ |
| [496](#L496) | $keyword = sanitize\_text\_field($\_POST['keyword']); |
| [497](#L497) | $product\_per\_page = get\_option('qlcd\_wp\_chatbot\_ppp') != '' ? get\_option('qlcd\_wp\_chatbot\_ppp') : 10; |
| [498](#L498) | if (get\_option('qlcd\_wp\_chatbot\_search\_option') == 'standard') { |
| [499](#L499) | $product\_orderby = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_orderby') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_orderby') : 'title'); |
| [500](#L500) | $product\_order = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_order') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_order') : 'ASC'); |
| [501](#L501) | //Merging all query together. |
| [502](#L502) | $argu\_params = array( |
| [503](#L503) | 'post\_type' => 'product', |
| [504](#L504) | 'post\_status' => 'publish', |
| [505](#L505) | 'posts\_per\_page' => $product\_per\_page, |
| [506](#L506) | 'orderby' => $product\_orderby, |
| [507](#L507) | 'order' => $product\_order, |
| [508](#L508) | 's' => $keyword, |
| [509](#L509) | ); |
| [510](#L510) | /\*\*\*\*\*\* |
| [511](#L511) | \*WP Query Operation to get products.\* |
| [512](#L512) | \*\*\*\*\*\*\*/ |
| [513](#L513) | $product\_query = new WP\_Query($argu\_params); |
| [514](#L514) | $product\_num = $product\_query->post\_count; |
| [515](#L515) | //Getting total product number by string. |
| [516](#L516) | $total\_argu = array('post\_type' => 'product', 's' => $keyword, 'posts\_per\_page' => 100); |
| [517](#L517) | $total\_query = new WP\_Query($total\_argu); |
| [518](#L518) | $total\_product\_num = $total\_query->post\_count; |
| [519](#L519) | $html = '<div class="wp-chatbot-products-area">'; |
| [520](#L520) | $\_pf = new WC\_Product\_Factory(); |
| [521](#L521) | //repeating the products |
| [522](#L522) | if ($product\_num > 0) { |
| [523](#L523) | $html .= '<ul class="wp-chatbot-products">'; |
| [524](#L524) | while ($product\_query->have\_posts()) : $product\_query->the\_post(); |
| [525](#L525) | $product = $\_pf->get\_product(get\_the\_ID()); |
| [526](#L526) | if (wp\_chatbot\_product\_controlling(get\_the\_ID()) == true) { |
| [527](#L527) | $html .= '<li class="wp-chatbot-product">'; |
| [528](#L528) | $html .= '<a target="\_blank" href="' . get\_permalink(get\_the\_ID()) . '"  wp-chatbot-pid= "' . get\_the\_ID() . '" title="' . esc\_attr($product->post->post\_title ? $product->post->post\_title : get\_the\_ID()) . '">'; |
| [529](#L529) | $html .= get\_the\_post\_thumbnail(get\_the\_ID(), 'shop\_catalog') . ' |
| [530](#L530) | <div class="wp-chatbot-product-summary"> |
| [531](#L531) | <div class="wp-chatbot-product-table"> |
| [532](#L532) | <div class="wp-chatbot-product-table-cell"> |
| [533](#L533) | <h3 class="wp-chatbot-product-title">' . $product->post->post\_title . '</h3> |
| [534](#L534) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [535](#L535) | $html .= ' </div> |
| [536](#L536) | </div> |
| [537](#L537) | </div></a> |
| [538](#L538) | </li>'; |
| [539](#L539) | } |
| [540](#L540) | endwhile; |
| [541](#L541) | wp\_reset\_postdata(); |
| [542](#L542) | $html .= '</ul>'; |
| [543](#L543) | if ($total\_product\_num > $product\_per\_page && $product\_per\_page > 0 ) { |
| [544](#L544) | $html .= '<p style="text-align: center"><button type="button" id="wp-chatbot-loadmore" data-offset="' . $product\_per\_page . '" data-search-type="product" data-search-term="' . $keyword . '" >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_load\_more')))) . ' <span id="wp-chatbot-loadmore-loader"></span></button> </p>'; |
| [545](#L545) | } |
| [546](#L546) | } |
| [547](#L547) | $html .= '</div>'; |
| [548](#L548) | } else if (get\_option('qlcd\_wp\_chatbot\_search\_option') == 'advanced') { |
| [549](#L549) | $result = wpwBot\_Search::factory()->search($keyword); |
| [550](#L550) | $products = $result['products']; |
| [551](#L551) | $product\_num = count($result['products']); |
| [552](#L552) | $total\_product\_num = $result['total\_products']; |
| [553](#L553) | $more\_product\_ids = implode(",", $result['more\_ids']); |
| [554](#L554) | $html = '<div class="wp-chatbot-products-area">'; |
| [555](#L555) | $\_pf = new WC\_Product\_Factory(); |
| [556](#L556) | //repeating the products |
| [557](#L557) | if ($product\_num > 0) { |
| [558](#L558) | $html .= '<ul class="wp-chatbot-products">'; |
| [559](#L559) | foreach ($products as $product) { |
| [560](#L560) | if (wp\_chatbot\_product\_controlling($product->get\_id()) == true) { |
| [561](#L561) | $html .= '<li class="wp-chatbot-product">'; |
| [562](#L562) | $html .= '<a target="\_blank" href="' . get\_permalink($product->get\_id()) . '" wp-chatbot-pid= "' . $product->get\_id() . '"  title="' . esc\_attr($product->get\_title()) . '">'; |
| [563](#L563) | $html .= get\_the\_post\_thumbnail($product->get\_id(), 'shop\_catalog') . ' |
| [564](#L564) | <div class="wp-chatbot-product-summary"> |
| [565](#L565) | <div class="wp-chatbot-product-table"> |
| [566](#L566) | <div class="wp-chatbot-product-table-cell"> |
| [567](#L567) | <h3 class="wp-chatbot-product-title">' . $product->get\_title() . '</h3> |
| [568](#L568) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [569](#L569) | $html .= ' </div></div></div></a></li>'; |
| [570](#L570) | } |
| [571](#L571) | } |
| [572](#L572) | $html .= '</ul>'; |
| [573](#L573) | if ($total\_product\_num > $product\_per\_page && $product\_per\_page > 0) { |
| [574](#L574) | $html .= '<p style="text-align: center"><button type="button" id="wp-chatbot-loadmore" data-offset="' . $product\_per\_page . '" data-search-type="product" data-search-term="' . $more\_product\_ids . '" >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_load\_more')))) . ' <span id="wp-chatbot-loadmore-loader"></span></button> </p>'; |
| [575](#L575) | } |
| [576](#L576) | } |
| [577](#L577) | $html .= '</div>'; |
| [578](#L578) | } |
| [579](#L579) | $response = array('html' => $html, 'product\_num' => $total\_product\_num, 'per\_page' => $product\_per\_page); |
| [580](#L580) | wp\_send\_json($response); |
| [581](#L581) |  |
| [582](#L582) | } |
| [583](#L583) | /\*\* |
| [584](#L584) | \* wpwBot Categories |
| [585](#L585) | \*/ |
| [586](#L586) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_category', 'qcld\_wb\_chatbot\_category'); |
| [587](#L587) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_category', 'qcld\_wb\_chatbot\_category'); |
| [588](#L588) | function qcld\_wb\_chatbot\_category(){ |
| [589](#L589) | $category\_type="common"; |
| [590](#L590) | if (get\_option('wp\_chatbot\_show\_parent\_category') != "") { |
| [591](#L591) | $terms = get\_terms('product\_cat', array('parent' => 0, 'hide\_empty' => true, 'fields' => 'all')); |
| [592](#L592) |  |
| [593](#L593) | } else { |
| [594](#L594) | $terms = get\_terms('product\_cat', array('hide\_empty' => true, 'fields' => 'all')); |
| [595](#L595) | } |
| [596](#L596) | $html = ""; |
| [597](#L597) | foreach ($terms as $term) { |
| [598](#L598) | $child\_terms=get\_terms('product\_cat', array('parent' => $term->term\_id, 'hide\_empty' => true, 'fields' => 'all')); |
| [599](#L599) | if(get\_option('wp\_chatbot\_show\_sub\_category')==1 && count($child\_terms) >0){ |
| [600](#L600) | $category\_type="hasChilds"; |
| [601](#L601) | } |
| [602](#L602) | $html .= '<span class="qcld-chatbot-product-category" data-category-type="' . $category\_type . '"  data-category-slug="' . $term->slug . '" data-category-id="' . $term->term\_id . '">' . $term->name . '</span>'; |
| [603](#L603) | } |
| [604](#L604) | wp\_send\_json($html); |
| [605](#L605) |  |
| [606](#L606) | } |
| [607](#L607) | /\*\* |
| [608](#L608) | \* wpwBot Sub categories |
| [609](#L609) | \*/ |
| [610](#L610) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_sub\_category', 'qcld\_wb\_chatbot\_sub\_category'); |
| [611](#L611) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_sub\_category', 'qcld\_wb\_chatbot\_sub\_category'); |
| [612](#L612) | function qcld\_wb\_chatbot\_sub\_category(){ |
| [613](#L613) | $parent\_id = stripslashes($\_POST['parent\_id']); |
| [614](#L614) | $terms = get\_terms('product\_cat', array('parent' => $parent\_id, 'hide\_empty' => true, 'fields' => 'all')); |
| [615](#L615) | $html = ""; |
| [616](#L616) | foreach ($terms as $term) { |
| [617](#L617) | $html .= '<span class="qcld-chatbot-product-category" data-category-type="common"  data-category-slug="' . $term->slug . '" data-category-id="' . $term->term\_id . '">' . $term->name . '</span>'; |
| [618](#L618) | } |
| [619](#L619) | wp\_send\_json($html); |
| [620](#L620) |  |
| [621](#L621) | } |
| [622](#L622) | /\*\* |
| [623](#L623) | \* wpwBot category product |
| [624](#L624) | \*/ |
| [625](#L625) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_category\_products', 'qcld\_wb\_chatbot\_category\_products'); |
| [626](#L626) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_category\_products', 'qcld\_wb\_chatbot\_category\_products'); |
| [627](#L627) | function qcld\_wb\_chatbot\_category\_products(){ |
| [628](#L628) | $category\_id = stripslashes($\_POST['category']); |
| [629](#L629) | $product\_per\_page = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_ppp') != '' ? get\_option('qlcd\_wp\_chatbot\_ppp') : 10); |
| [630](#L630) | $product\_orderby = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_orderby') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_orderby') : 'title'); |
| [631](#L631) | $product\_order = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_order') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_order') : 'ASC'); |
| [632](#L632) | //Merging all query together. |
| [633](#L633) | $argu\_params = array( |
| [634](#L634) | 'post\_type' => 'product', |
| [635](#L635) | 'post\_status' => 'publish', |
| [636](#L636) | 'ignore\_sticky\_posts' => 1, |
| [637](#L637) | 'orderby' => $product\_orderby, |
| [638](#L638) | 'order' => $product\_order, |
| [639](#L639) | 'posts\_per\_page' => $product\_per\_page, |
| [640](#L640) | 'tax\_query' => array( |
| [641](#L641) | array( |
| [642](#L642) | 'taxonomy' => 'product\_cat', |
| [643](#L643) | 'field' => 'term\_id', |
| [644](#L644) | 'terms' => $category\_id, |
| [645](#L645) | 'operator' => 'IN' |
| [646](#L646) | ) |
| [647](#L647) | ) |
| [648](#L648) | ); |
| [649](#L649) | /\*\*\*\*\*\* |
| [650](#L650) | \*WP Query Operation to get products.\* |
| [651](#L651) | \*\*\*\*\*\*\*/ |
| [652](#L652) | $product\_query = new WP\_Query($argu\_params); |
| [653](#L653) | $product\_num = $product\_query->post\_count; |
| [654](#L654) | //Getting total product number by string. |
| [655](#L655) | $total\_argu = array( |
| [656](#L656) | 'post\_type' => 'product', |
| [657](#L657) | 'post\_status' => 'publish', |
| [658](#L658) | 'posts\_per\_page' => 100, |
| [659](#L659) | 'tax\_query' => array( |
| [660](#L660) | array( |
| [661](#L661) | 'taxonomy' => 'product\_cat', |
| [662](#L662) | 'field' => 'term\_id', |
| [663](#L663) | 'terms' => $category\_id, |
| [664](#L664) | 'operator' => 'IN' |
| [665](#L665) | ) |
| [666](#L666) | ) |
| [667](#L667) | ); |
| [668](#L668) | $total\_query = new WP\_Query($total\_argu); |
| [669](#L669) | $total\_product\_num = $total\_query->post\_count; |
| [670](#L670) | $\_pf = new WC\_Product\_Factory(); |
| [671](#L671) | //repeating the products |
| [672](#L672) | $html = ''; |
| [673](#L673) | if ($product\_num > 0) { |
| [674](#L674) | $html .= '<div class="wp-chatbot-products-area">'; |
| [675](#L675) | $html .= '<ul class="wp-chatbot-products">'; |
| [676](#L676) | while ($product\_query->have\_posts()) : $product\_query->the\_post(); |
| [677](#L677) | $product = $\_pf->get\_product(get\_the\_ID()); |
| [678](#L678) | //$qcld\_thumb = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( get\_the\_ID() ), 'shop\_thumbnail' ); |
| [679](#L679) | $html .= '<li class="wp-chatbot-product">'; |
| [680](#L680) | $html .= '<a class="wp-chatbot-product-url" wp-chatbot-pid= "' . get\_the\_ID() . '" target="\_blank" href="' . get\_permalink(get\_the\_ID()) . '" title="' . esc\_attr($product->get\_title() ? $product->get\_title() : get\_the\_ID()) . '">'; |
| [681](#L681) | $html .= get\_the\_post\_thumbnail(get\_the\_ID(), 'shop\_catalog') . ' |
| [682](#L682) | <div class="wp-chatbot-product-summary"> |
| [683](#L683) | <div class="wp-chatbot-product-table"> |
| [684](#L684) | <div class="wp-chatbot-product-table-cell"> |
| [685](#L685) | <h3 class="wp-chatbot-product-title">' . $product->get\_title() . '</h3> |
| [686](#L686) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [687](#L687) | $html .= ' </div> |
| [688](#L688) | </div> |
| [689](#L689) | </div></a> |
| [690](#L690) | </li>'; |
| [691](#L691) | endwhile; |
| [692](#L692) | wp\_reset\_postdata(); |
| [693](#L693) | $html .= '</ul>'; |
| [694](#L694) | if ($total\_product\_num > $product\_per\_page && $product\_per\_page >0) { |
| [695](#L695) | $html .= '<p style="text-align: center"><button type="button" id="wp-chatbot-loadmore" data-offset="' . $product\_per\_page . '" data-search-type="category" data-search-term="' . $category\_id . '" >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_load\_more')))) . ' <span id="wp-chatbot-loadmore-loader"></span></button> </p>'; |
| [696](#L696) | } |
| [697](#L697) | $html .= '</div>'; |
| [698](#L698) | } else { |
| [699](#L699) | $html = ''; |
| [700](#L700) | } |
| [701](#L701) | $response = array('html' => $html, 'product\_num' => $total\_product\_num, 'per\_page' => $product\_per\_page); |
| [702](#L702) | wp\_send\_json($response); |
| [703](#L703) | } |
| [704](#L704) | /\*\* |
| [705](#L705) | \* wpwBot latest, featured, recent product |
| [706](#L706) | \*/ |
| [707](#L707) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_featured\_products', 'qcld\_wb\_chatbot\_featured\_products'); |
| [708](#L708) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_featured\_products', 'qcld\_wb\_chatbot\_featured\_products'); |
| [709](#L709) | function qcld\_wb\_chatbot\_featured\_products(){ |
| [710](#L710) | $product\_per\_page = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_ppp') != '' ? get\_option('qlcd\_wp\_chatbot\_ppp') : 10); |
| [711](#L711) | $product\_orderby = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_orderby') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_orderby') : 'title'); |
| [712](#L712) | $product\_order = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_order') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_order') : 'ASC'); |
| [713](#L713) | //get featured products query. |
| [714](#L714) | $argu\_params = array('post\_status' => 'publish', |
| [715](#L715) | 'posts\_per\_page' => $product\_per\_page, |
| [716](#L716) | 'post\_type' => 'product', |
| [717](#L717) | 'post\_status' => 'publish', |
| [718](#L718) | 'tax\_query' => array(array('taxonomy' => 'product\_visibility', 'field' => 'name', 'terms' => 'featured')) |
| [719](#L719) | ); |
| [720](#L720) | /\*\*\*\*\*\* |
| [721](#L721) | \*WP Query Operation to get products.\* |
| [722](#L722) | \*\*\*\*\*\*\*/ |
| [723](#L723) | $product\_query = new WP\_Query($argu\_params); |
| [724](#L724) | $product\_num = $product\_query->post\_count; |
| [725](#L725) | //Getting total product number by string. |
| [726](#L726) | $total\_argu = array('post\_status' => 'publish', |
| [727](#L727) | 'posts\_per\_page' => 100, |
| [728](#L728) | 'post\_type' => 'product', |
| [729](#L729) | 'post\_status' => 'publish', |
| [730](#L730) | 'tax\_query' => array(array('taxonomy' => 'product\_visibility', 'field' => 'name', 'terms' => 'featured',),) |
| [731](#L731) | ); |
| [732](#L732) | $total\_query = new WP\_Query($total\_argu); |
| [733](#L733) | $total\_product\_num = $total\_query->post\_count; |
| [734](#L734) | $html = '<div class="wp-chatbot-products-area">'; |
| [735](#L735) | $\_pf = new WC\_Product\_Factory(); |
| [736](#L736) | //repeating the products |
| [737](#L737) | if ($product\_num > 0) { |
| [738](#L738) | //$html .= '<p>sdf sdfdsf : '.$asdfdf.'</p>'; |
| [739](#L739) | $html .= '<ul class="wp-chatbot-products">'; |
| [740](#L740) | while ($product\_query->have\_posts()) : $product\_query->the\_post(); |
| [741](#L741) | $product = $\_pf->get\_product(get\_the\_ID()); |
| [742](#L742) | $html .= '<li class="wp-chatbot-product">'; |
| [743](#L743) | $html .= '<a class="wp-chatbot-product-url" wp-chatbot-pid= "' . get\_the\_ID() . '" target="\_blank" href="' . get\_permalink(get\_the\_ID()) . '" title="' . esc\_attr($product->get\_title() ? $product->get\_title() : get\_the\_ID()) . '">'; |
| [744](#L744) | $html .= get\_the\_post\_thumbnail(get\_the\_ID(), 'shop\_catalog') . ' |
| [745](#L745) | <div class="wp-chatbot-product-summary"> |
| [746](#L746) | <div class="wp-chatbot-product-table"> |
| [747](#L747) | <div class="wp-chatbot-product-table-cell"> |
| [748](#L748) | <h3 class="wp-chatbot-product-title">' . $product->get\_title() . '</h3> |
| [749](#L749) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [750](#L750) | $html .= ' </div> |
| [751](#L751) | </div> |
| [752](#L752) | </div></a> |
| [753](#L753) | </li>'; |
| [754](#L754) | endwhile; |
| [755](#L755) | wp\_reset\_postdata(); |
| [756](#L756) | $html .= '</ul>'; |
| [757](#L757) | if ($total\_product\_num > $product\_per\_page) { |
| [758](#L758) | $html .= '<p style="text-align: center"><button type="button" id="wp-chatbot-loadmore" data-offset="' . $product\_per\_page . '" data-search-type="product" data-search-term="featured" >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_load\_more')))) . ' <span id="wp-chatbot-loadmore-loader"></span></button> </p>'; |
| [759](#L759) | } |
| [760](#L760) | } |
| [761](#L761) | $html .= '</div>'; |
| [762](#L762) | $response = array('html' => $html, 'product\_num' => $total\_product\_num, 'per\_page' => $product\_per\_page); |
| [763](#L763) | wp\_send\_json($response); |
| [764](#L764) | } |
| [765](#L765) | //Product display controll |
| [766](#L766) | function wp\_chatbot\_product\_controlling($product\_id){ |
| [767](#L767) | $display\_product = true; |
| [768](#L768) | //Controlling Out of Stock product display from back end. |
| [769](#L769) | $\_pf = new WC\_Product\_Factory(); |
| [770](#L770) | $product = $\_pf->get\_product($product\_id); |
| [771](#L771) | if ($product->manage\_stock == 'yes' && $product->stock\_quantity <= 0 && get\_option('wp\_chatbot\_exclude\_stock\_out\_product') == 1) { |
| [772](#L772) | $display\_product = false; |
| [773](#L773) | } |
| [774](#L774) | return $display\_product; |
| [775](#L775) | } |
| [776](#L776) | //Get Sale products |
| [777](#L777) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_sale\_products', 'qcld\_wb\_chatbot\_sale\_products'); |
| [778](#L778) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_sale\_products', 'qcld\_wb\_chatbot\_sale\_products'); |
| [779](#L779) | function qcld\_wb\_chatbot\_sale\_products(){ |
| [780](#L780) | $product\_per\_page = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_ppp') != '' ? get\_option('qlcd\_wp\_chatbot\_ppp') : 10); |
| [781](#L781) | $product\_orderby = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_orderby') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_orderby') : 'title'); |
| [782](#L782) | $product\_order = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_order') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_order') : 'ASC'); |
| [783](#L783) | //get sale products query. |
| [784](#L784) | $argu\_params = array( |
| [785](#L785) | 'post\_type' => 'product', |
| [786](#L786) | 'post\_status' => 'publish', |
| [787](#L787) | 'posts\_per\_page' => $product\_per\_page, |
| [788](#L788) | 'meta\_query' => array( |
| [789](#L789) | 'relation' => 'OR', |
| [790](#L790) | array( // Simple products type |
| [791](#L791) | 'key' => '\_sale\_price', |
| [792](#L792) | 'value' => 0, |
| [793](#L793) | 'compare' => '>', |
| [794](#L794) | 'type' => 'numeric' |
| [795](#L795) | ), |
| [796](#L796) | array( // Variable products type |
| [797](#L797) | 'key' => '\_min\_variation\_sale\_price', |
| [798](#L798) | 'value' => 0, |
| [799](#L799) | 'compare' => '>', |
| [800](#L800) | 'type' => 'numeric' |
| [801](#L801) | ) |
| [802](#L802) | ) |
| [803](#L803) | ); |
| [804](#L804) | /\*\*\*\*\*\* |
| [805](#L805) | \*WP Query Operation to get products.\* |
| [806](#L806) | \*\*\*\*\*\*\*/ |
| [807](#L807) | $product\_query = new WP\_Query($argu\_params); |
| [808](#L808) | $product\_num = $product\_query->post\_count; |
| [809](#L809) | //Getting total product number by string. |
| [810](#L810) | $total\_argu = array( |
| [811](#L811) | 'post\_type' => 'product', |
| [812](#L812) | 'post\_status' => 'publish', |
| [813](#L813) | 'posts\_per\_page' => 100, |
| [814](#L814) | 'meta\_query' => array( |
| [815](#L815) | 'relation' => 'OR', |
| [816](#L816) | array( // Simple products type |
| [817](#L817) | 'key' => '\_sale\_price', |
| [818](#L818) | 'value' => 0, |
| [819](#L819) | 'compare' => '>', |
| [820](#L820) | 'type' => 'numeric' |
| [821](#L821) | ), |
| [822](#L822) | array( // Variable products type |
| [823](#L823) | 'key' => '\_min\_variation\_sale\_price', |
| [824](#L824) | 'value' => 0, |
| [825](#L825) | 'compare' => '>', |
| [826](#L826) | 'type' => 'numeric' |
| [827](#L827) | ) |
| [828](#L828) | ) |
| [829](#L829) | ); |
| [830](#L830) | $total\_query = new WP\_Query($total\_argu); |
| [831](#L831) | $total\_product\_num = $total\_query->post\_count; |
| [832](#L832) | $html = '<div class="wp-chatbot-products-area">'; |
| [833](#L833) | $\_pf = new WC\_Product\_Factory(); |
| [834](#L834) | //repeating the products |
| [835](#L835) | if ($product\_num > 0) { |
| [836](#L836) | //$html .= '<p>sdf sdfdsf : '.$asdfdf.'</p>'; |
| [837](#L837) | $html .= '<ul class="wp-chatbot-products">'; |
| [838](#L838) | while ($product\_query->have\_posts()) : $product\_query->the\_post(); |
| [839](#L839) | $product = $\_pf->get\_product(get\_the\_ID()); |
| [840](#L840) | $html .= '<li class="wp-chatbot-product">'; |
| [841](#L841) | $html .= '<a class="wp-chatbot-product-url" wp-chatbot-pid= "' . get\_the\_ID() . '" target="\_blank" href="' . get\_permalink(get\_the\_ID()) . '" title="' . esc\_attr($product->get\_title() ? $product->get\_title() : get\_the\_ID()) . '">'; |
| [842](#L842) | $html .= get\_the\_post\_thumbnail(get\_the\_ID(), 'shop\_catalog') . ' |
| [843](#L843) | <div class="wp-chatbot-product-summary"> |
| [844](#L844) | <div class="wp-chatbot-product-table"> |
| [845](#L845) | <div class="wp-chatbot-product-table-cell"> |
| [846](#L846) | <h3 class="wp-chatbot-product-title">' . $product->get\_title() . '</h3> |
| [847](#L847) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [848](#L848) | $html .= ' </div> |
| [849](#L849) | </div> |
| [850](#L850) | </div></a> |
| [851](#L851) | </li>'; |
| [852](#L852) | endwhile; |
| [853](#L853) | wp\_reset\_postdata(); |
| [854](#L854) | $html .= '</ul>'; |
| [855](#L855) | if ($total\_product\_num > $product\_per\_page) { |
| [856](#L856) | $html .= '<p style="text-align: center"><button type="button" id="wp-chatbot-loadmore" data-offset="' . $product\_per\_page . '" data-search-type="product" data-search-term="sale" >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_load\_more')))) . ' <span id="wp-chatbot-loadmore-loader"></span></button> </p>'; |
| [857](#L857) | } |
| [858](#L858) | } |
| [859](#L859) | $html .= '</div>'; |
| [860](#L860) | $response = array('html' => $html, 'product\_num' => $total\_product\_num, 'per\_page' => $product\_per\_page); |
| [861](#L861) | wp\_send\_json($response); |
| [862](#L862) | } |
| [863](#L863) | //load more |
| [864](#L864) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_load\_more', 'qcld\_wb\_chatbot\_load\_more'); |
| [865](#L865) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_load\_more', 'qcld\_wb\_chatbot\_load\_more'); |
| [866](#L866) | function qcld\_wb\_chatbot\_load\_more(){ |
| [867](#L867) | $offset = stripslashes($\_POST['offset']); |
| [868](#L868) | $search\_type = stripslashes($\_POST['search\_type']); |
| [869](#L869) | $search\_term = stripslashes($\_POST['search\_term']); |
| [870](#L870) | $product\_per\_page = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_ppp') != '' ? get\_option('qlcd\_wp\_chatbot\_ppp') : 10); |
| [871](#L871) | $product\_orderby = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_orderby') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_orderby') : 'title'); |
| [872](#L872) | $product\_order = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_product\_order') != '' ? get\_option('qlcd\_wp\_chatbot\_product\_order') : 'ASC'); |
| [873](#L873) | $next\_offset = intval($product\_per\_page + $offset); |
| [874](#L874) | if ($search\_type == 'product' && $search\_term != 'featured' && $search\_term != 'sale' && get\_option('qlcd\_wp\_chatbot\_search\_option') == 'advanced') { |
| [875](#L875) | //if have multiple ids then explode else have single need to array push |
| [876](#L876) | if (strpos($search\_term, ',') !== false) { |
| [877](#L877) | $product\_ids = explode(',', $search\_term); |
| [878](#L878) | } else { |
| [879](#L879) | $product\_ids = array($search\_term); |
| [880](#L880) | } |
| [881](#L881) | $result = wpwBot\_Search::factory()->get\_load\_more\_products($product\_ids); |
| [882](#L882) | $products = $result['products']; |
| [883](#L883) | $product\_num = count($result['products']); |
| [884](#L884) | $total\_product\_num = $result['total\_products']; |
| [885](#L885) | $more\_product\_ids = implode(",", $result['more\_ids']); |
| [886](#L886) | $\_pf = new WC\_Product\_Factory(); |
| [887](#L887) | //repeating the products |
| [888](#L888) | $html = ''; |
| [889](#L889) | if ($product\_num > 0) { |
| [890](#L890) | foreach ($products as $product) { |
| [891](#L891) | $html .= '<li class="wp-chatbot-product">'; |
| [892](#L892) | $html .= '<a target="\_blank" href="' . get\_permalink($product->get\_id()) . '" wp-chatbot-pid= "' . $product->get\_id() . '"  title="' . esc\_attr($product->get\_title()) . '">'; |
| [893](#L893) | $html .= get\_the\_post\_thumbnail($product->get\_id(), 'shop\_catalog') . ' |
| [894](#L894) | <div class="wp-chatbot-product-summary"> |
| [895](#L895) | <div class="wp-chatbot-product-table"> |
| [896](#L896) | <div class="wp-chatbot-product-table-cell"> |
| [897](#L897) | <h3 class="wp-chatbot-product-title">' . $product->get\_title() . '</h3> |
| [898](#L898) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [899](#L899) | $html .= ' </div></div></div></a></li>'; |
| [900](#L900) | } |
| [901](#L901) | } |
| [902](#L902) | $response = array('html' => $html, 'product\_num' => $total\_product\_num, 'search\_term' => $more\_product\_ids, 'offset' => $next\_offset, 'per\_page' => $product\_per\_page); |
| [903](#L903) | } else { |
| [904](#L904) | if ($search\_type == 'product' && $search\_term != 'featured' && $search\_term != 'sale') {  //For Standard search |
| [905](#L905) | $argu\_params = array( |
| [906](#L906) | 'post\_type' => 'product', |
| [907](#L907) | 'post\_status' => 'publish', |
| [908](#L908) | 'posts\_per\_page' => $product\_per\_page, |
| [909](#L909) | 'offset' => $offset, |
| [910](#L910) | 'orderby' => $product\_orderby, |
| [911](#L911) | 'order' => $product\_order, |
| [912](#L912) | 's' => $search\_term, |
| [913](#L913) | ); |
| [914](#L914) | } else if ($search\_type == 'category') { |
| [915](#L915) | $argu\_params = array( |
| [916](#L916) | 'post\_type' => 'product', |
| [917](#L917) | 'post\_status' => 'publish', |
| [918](#L918) | 'ignore\_sticky\_posts' => 1, |
| [919](#L919) | 'posts\_per\_page' => $product\_per\_page, |
| [920](#L920) | 'orderby' => $product\_orderby, |
| [921](#L921) | 'order' => $product\_order, |
| [922](#L922) | 'offset' => $offset, |
| [923](#L923) | 'tax\_query' => array( |
| [924](#L924) | array( |
| [925](#L925) | 'taxonomy' => 'product\_cat', |
| [926](#L926) | 'field' => 'term\_id', |
| [927](#L927) | 'terms' => $search\_term, |
| [928](#L928) | 'operator' => 'IN' |
| [929](#L929) | ) |
| [930](#L930) | ) |
| [931](#L931) | ); |
| [932](#L932) | } else if ($search\_type == 'product' && $search\_term == 'featured') { |
| [933](#L933) | $argu\_params = array( |
| [934](#L934) | 'post\_type' => 'product', |
| [935](#L935) | 'post\_status' => 'publish', |
| [936](#L936) | 'ignore\_sticky\_posts' => 1, |
| [937](#L937) | 'posts\_per\_page' => $product\_per\_page, |
| [938](#L938) | 'orderby' => $product\_orderby, |
| [939](#L939) | 'order' => $product\_order, |
| [940](#L940) | 'offset' => $offset, |
| [941](#L941) | 'meta\_query' => array('key' => '\_featured', 'value' => 'yes') |
| [942](#L942) | ); |
| [943](#L943) | } else if ($search\_type == 'product' && $search\_term == 'sale') { |
| [944](#L944) | $argu\_params = array( |
| [945](#L945) | 'post\_type' => 'product', |
| [946](#L946) | 'post\_status' => 'publish', |
| [947](#L947) | 'ignore\_sticky\_posts' => 1, |
| [948](#L948) | 'posts\_per\_page' => $product\_per\_page, |
| [949](#L949) | 'orderby' => $product\_orderby, |
| [950](#L950) | 'order' => $product\_order, |
| [951](#L951) | 'offset' => $offset, |
| [952](#L952) | 'meta\_query' => array( |
| [953](#L953) | 'relation' => 'OR', |
| [954](#L954) | array( // Simple products type |
| [955](#L955) | 'key' => '\_sale\_price', |
| [956](#L956) | 'value' => 0, |
| [957](#L957) | 'compare' => '>', |
| [958](#L958) | 'type' => 'numeric' |
| [959](#L959) | ), |
| [960](#L960) | array( // Variable products type |
| [961](#L961) | 'key' => '\_min\_variation\_sale\_price', |
| [962](#L962) | 'value' => 0, |
| [963](#L963) | 'compare' => '>', |
| [964](#L964) | 'type' => 'numeric' |
| [965](#L965) | ) |
| [966](#L966) | ) |
| [967](#L967) | ); |
| [968](#L968) | } |
| [969](#L969) | $product\_query = new WP\_Query($argu\_params); |
| [970](#L970) | $product\_num = $product\_query->post\_count; |
| [971](#L971) | $\_pf = new WC\_Product\_Factory(); |
| [972](#L972) | //repeating the products |
| [973](#L973) | $html = ''; |
| [974](#L974) | if ($product\_num > 0) { |
| [975](#L975) | while ($product\_query->have\_posts()) : $product\_query->the\_post(); |
| [976](#L976) | $product = $\_pf->get\_product(get\_the\_ID()); |
| [977](#L977) | $html .= '<li class="wp-chatbot-product">'; |
| [978](#L978) | $html .= '<a target="\_blank" href="' . get\_permalink(get\_the\_ID()) . '"  wp-chatbot-pid= "' . get\_the\_ID() . '" title="' . esc\_attr($product->post->post\_title ? $product->post->post\_title : get\_the\_ID()) . '">'; |
| [979](#L979) | $html .= get\_the\_post\_thumbnail(get\_the\_ID(), 'shop\_catalog') . ' |
| [980](#L980) | <div class="wp-chatbot-product-summary"> |
| [981](#L981) | <div class="wp-chatbot-product-table"> |
| [982](#L982) | <div class="wp-chatbot-product-table-cell"> |
| [983](#L983) | <h3 class="wp-chatbot-product-title">' . $product->post->post\_title . '</h3> |
| [984](#L984) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [985](#L985) | $html .= ' </div> |
| [986](#L986) | </div> |
| [987](#L987) | </div></a> |
| [988](#L988) | </li>'; |
| [989](#L989) | endwhile; |
| [990](#L990) | wp\_reset\_postdata(); |
| [991](#L991) | } else { |
| [992](#L992) | $html .= ''; |
| [993](#L993) | } |
| [994](#L994) | $response = array('html' => $html, 'product\_num' => $product\_num, 'search\_term' => $search\_term, 'offset' => $next\_offset, 'per\_page' => $product\_per\_page); |
| [995](#L995) | } |
| [996](#L996) | wp\_send\_json($response); |
| [997](#L997) | } |
| [998](#L998) | //product details |
| [999](#L999) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_product\_details', 'qcld\_wb\_chatbot\_product\_details'); |
| [1000](#L1000) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_product\_details', 'qcld\_wb\_chatbot\_product\_details'); |
| [1001](#L1001) | function qcld\_wb\_chatbot\_product\_details(){ |
| [1002](#L1002) | $product\_id = stripslashes($\_POST['wp\_chatbot\_pid']); |
| [1003](#L1003) | //Tracking product view from chat board |
| [1004](#L1004) | wp\_chatbot\_view\_track\_product\_by\_id($product\_id); |
| [1005](#L1005) | //wpcommerce product factory |
| [1006](#L1006) | $wc\_pf = new WC\_Product\_Factory(); |
| [1007](#L1007) | $product = $wc\_pf->get\_product($product\_id); |
| [1008](#L1008) | $product\_type = $wc\_pf->get\_product\_type($product\_id); |
| [1009](#L1009) | $product\_title = '<h2 id="wp-chatbot-product-title" ><a target="\_blank" href="' . get\_permalink($product->get\_id()) . '">' . $product->get\_title() . '</a></h2>'; |
| [1010](#L1010) | $product\_desc = apply\_filters('the\_excerpt', $product->post->post\_excerpt);//$product->post->post\_excerpt; |
| [1011](#L1011) | $gallery\_ids = $product->get\_gallery\_image\_ids(); |
| [1012](#L1012) | //images processing.. |
| [1013](#L1013) | $product\_feature\_image\_id = get\_post\_thumbnail\_id($product\_id); |
| [1014](#L1014) | $product\_feature\_image = wp\_get\_attachment\_image\_src($product\_feature\_image\_id, 'full'); |
| [1015](#L1015) | $product\_feature\_thumb = wp\_get\_attachment\_image\_src($product\_feature\_image\_id, 'shop\_thumbnail'); |
| [1016](#L1016) | //$full\_img\_src = $product\_feature\_image[0]; |
| [1017](#L1017) | //$product\_image = '<img  style="width:500px;height:300px" src="' . $full\_img\_src . '" >'; |
| [1018](#L1018) | $product\_image = '<div class="wp-chatbot-product-image-large"> |
| [1019](#L1019) | <a href="' . $product\_feature\_image[0] . '" id="wp-chatbot-product-image-large-path"><img id="wp-chatbot-product-image-large-src" src="' . $product\_feature\_image[0] . '" alt="Large Image" title="Zoom Image" /></a> |
| [1020](#L1020) | </div>'; |
| [1021](#L1021) | $product\_image .= '<div class="wp-chatbot-product-image-thumbs"><ul> |
| [1022](#L1022) | <li class="wp-chatbot-product-active-image-thumbs"><a href="' . $product\_feature\_image[0] . '" class="wp-chatbot-product-image-thumbs-path"><img  class="wp-chatbot-product-image-thumbs-src" src="' . $product\_feature\_thumb[0] . '" alt="Thumb Image" /></a></li>'; |
| [1023](#L1023) | if (!empty($gallery\_ids)) { |
| [1024](#L1024) | foreach ($gallery\_ids as $gallery\_id) { |
| [1025](#L1025) | $gallery\_image = wp\_get\_attachment\_image\_src($gallery\_id, 'full'); |
| [1026](#L1026) | $gallery\_thumb = wp\_get\_attachment\_image\_src($gallery\_id, 'shop\_thumbnail'); |
| [1027](#L1027) | $product\_image .= '<li><a href="' . $gallery\_image[0] . '" class="wp-chatbot-product-image-thumbs-path"><img class="wp-chatbot-product-image-thumbs-src" src="' . $gallery\_thumb[0] . '" alt="Thumb Image" /></a></li>'; |
| [1028](#L1028) | } |
| [1029](#L1029) | } |
| [1030](#L1030) | $product\_image .= '</ul></div>'; |
| [1031](#L1031) | $product\_price = '<p class="wp-chatbot-product-price" id="wp-chatbot-product-price">' . $product->get\_price\_html() . '</p>'; |
| [1032](#L1032) | $product\_sku = '<p class="wp-chatbot-product-sku"> ' . \_\_('SKU', 'wpchatbot') . ' : ' . $product->get\_sku() . '</p>'; |
| [1033](#L1033) | //if ( $product->is\_in\_stock() || $product->is\_purchasable() ) |
| [1034](#L1034) | //Handle variable product start |
| [1035](#L1035) | $variations = ""; |
| [1036](#L1036) | $add\_cart\_button = ""; |
| [1037](#L1037) | $product\_quantity = ""; |
| [1038](#L1038) | if ($product->is\_in\_stock()) { |
| [1039](#L1039) | if ($product\_type == "variable") { |
| [1040](#L1040) | //Getting product variation number based details |
| [1041](#L1041) | $variations\_data = array(); |
| [1042](#L1042) | foreach ($product->get\_children() as $child\_id) { |
| [1043](#L1043) | $all\_cfs = get\_post\_custom($child\_id); |
| [1044](#L1044) | array\_push($variations\_data, array('variation\_id' => $child\_id, 'variation\_data' => $all\_cfs)); |
| [1045](#L1045) | } |
| [1046](#L1046) | $variations\_data = json\_encode($variations\_data); |
| [1047](#L1047) | $attributes = $product->get\_attributes(); |
| [1048](#L1048) | //Handling Variant & Non Variant products |
| [1049](#L1049) | $var\_attrs = $product->get\_variation\_attributes(); |
| [1050](#L1050) | $varation\_names = array(); |
| [1051](#L1051) | if (!empty($var\_attrs)) { |
| [1052](#L1052) | foreach ($var\_attrs as $key => $value) { |
| [1053](#L1053) | array\_push($varation\_names, $key); |
| [1054](#L1054) | } |
| [1055](#L1055) | } |
| [1056](#L1056) | $debug = $varation\_names; |
| [1057](#L1057) | foreach ($attributes as $attribute) { |
| [1058](#L1058) | /\*if (empty($attribute['is\_visible']) || ($attribute['is\_taxonomy'] && !taxonomy\_exists($attribute['name']))) { |
| [1059](#L1059) | continue; |
| [1060](#L1060) | }\*/ |
| [1061](#L1061) | $title = wc\_attribute\_label($attribute['name']); |
| [1062](#L1062) | $name = $attribute['name']; |
| [1063](#L1063) | if ($attribute['is\_taxonomy']) { |
| [1064](#L1064) | $values = wc\_get\_product\_terms($product->get\_id(), $attribute['name'], array('fields' => 'slugs')); |
| [1065](#L1065) | } else { |
| [1066](#L1066) | $values = array\_map('trim', explode(WC\_DELIMITER, $attribute['value'])); |
| [1067](#L1067) | } |
| [1068](#L1068) | natsort($values); |
| [1069](#L1069) | if (!in\_array($name, $varation\_names)) { |
| [1070](#L1070) | $variations .= '<p><label for="' . sanitize\_title($name) . '">' . $title . '</label> ' . ucfirst(implode(",", $values)) . '</p>'; |
| [1071](#L1071) | } else { |
| [1072](#L1072) | $variations .= '<div class="wp-chatbot-variable-' . sanitize\_title($name) . '">'; |
| [1073](#L1073) | $variations .= '<label for="' . sanitize\_title($name) . '">' . $title . '</label>'; |
| [1074](#L1074) | $variations .= '<select id="' . esc\_attr(sanitize\_title($name)) . '" name="attribute\_' . sanitize\_title($name) . '" data-attribute\_name="attribute\_' . sanitize\_title($name) . '" class="each\_attribute">'; |
| [1075](#L1075) | $variations .= '<option value="">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_choose\_option')))) . '</option>'; |
| [1076](#L1076) | foreach ($values as $value) { |
| [1077](#L1077) | if (isset($\_REQUEST['attribute\_' . sanitize\_title($name)])) { |
| [1078](#L1078) | $selected\_value = $\_REQUEST['attribute\_' . sanitize\_title($name)]; |
| [1079](#L1079) | } else { |
| [1080](#L1080) | $selected\_value = ''; |
| [1081](#L1081) | } |
| [1082](#L1082) | $variations .= '<option value="' . esc\_attr(strtolower($value)) . '"' . selected($selected\_value, $value, false) . '>' . apply\_filters('wpcommerce\_variation\_option\_name', $value) . '</option>'; |
| [1083](#L1083) | } |
| [1084](#L1084) | $variations .= '</select></div>'; |
| [1085](#L1085) | } |
| [1086](#L1086) | } |
| [1087](#L1087) | $add\_cart\_button .= '<input type="button"  id="wp-chatbot-variation-add-to-cart" wp-chatbot-product-id="' . $product\_id . '" value="' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_add\_to\_cart')))) . '" variation\_id="" />'; |
| [1088](#L1088) | $add\_cart\_button .= "<input type='hidden'   id='wp-chatbot-variation-data'  data-product-variation='" . $variations\_data . "' />"; |
| [1089](#L1089) | } else { |
| [1090](#L1090) | $add\_cart\_button .= '<input type="button" id="wp-chatbot-add-cart-button" wp-chatbot-product-id="' . $product\_id . '" value="' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_add\_to\_cart')))) . '" />'; |
| [1091](#L1091) | } |
| [1092](#L1092) | //Handle variable product end. |
| [1093](#L1093) | $product\_quantity .= '<label for="">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_quantity')))) . '</label> |
| [1094](#L1094) | <input type="number" id="vPQuantity" value="1" />'; |
| [1095](#L1095) | } |
| [1096](#L1096) | //$response=$full\_size\_image; |
| [1097](#L1097) | $response = array('title' => $product\_title, 'description' => $product\_desc, 'image' => $product\_image, 'price' => $product\_price, 'sku' => $product\_sku, 'quantity' => $product\_quantity, 'buttton' => $add\_cart\_button, 'variation' => $variations, 'type' => $product\_type, 'debug' => $debug); |
| [1098](#L1098) | wp\_send\_json($response); |
| [1099](#L1099) | } |
| [1100](#L1100) | //Add to cart for variable product. |
| [1101](#L1101) | add\_action('wp\_ajax\_variable\_add\_to\_cart', 'qcld\_wb\_chatbot\_variable\_add\_to\_cart'); |
| [1102](#L1102) | add\_action('wp\_ajax\_nopriv\_variable\_add\_to\_cart', 'qcld\_wb\_chatbot\_variable\_add\_to\_cart'); |
| [1103](#L1103) | function qcld\_wb\_chatbot\_variable\_add\_to\_cart(){ |
| [1104](#L1104) | $product\_id = stripslashes($\_POST['p\_id']); |
| [1105](#L1105) | $quantity = stripslashes($\_POST['quantity']); |
| [1106](#L1106) | $variations\_id = stripslashes($\_POST['variations\_id']); |
| [1107](#L1107) | $attrs = stripslashes($\_POST['attributes']); |
| [1108](#L1108) | //echo wp\_send\_json(array('p\_id'=>$product\_id,'qnty'=>$quantity,'id'=>$variations\_id,'att'=>$attrs)); |
| [1109](#L1109) | $attributes = array(); |
| [1110](#L1110) | foreach ($attrs as $attr) { |
| [1111](#L1111) | $single = explode("#", $attr); |
| [1112](#L1112) | if (isset($single[0])) { |
| [1113](#L1113) | $a\_name = explode("\_", $single[0]); |
| [1114](#L1114) | } |
| [1115](#L1115) | $attributes[$a\_name[2]] = $single[1]; |
| [1116](#L1116) | } |
| [1117](#L1117) | global $wpcommerce; |
| [1118](#L1118) | $result = $wpcommerce->cart->add\_to\_cart($product\_id, $quantity, $variations\_id, $attributes, null); |
| [1119](#L1119) | if ($result != false) { |
| [1120](#L1120) | wp\_send\_json('variable'); |
| [1121](#L1121) | } else { |
| [1122](#L1122) | wp\_send\_json('error'); |
| [1123](#L1123) | } |
| [1124](#L1124) | } |
| [1125](#L1125) | //Add to cart for simple product. |
| [1126](#L1126) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_add\_to\_cart', 'qcld\_wb\_chatbot\_add\_to\_cart'); |
| [1127](#L1127) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_add\_to\_cart', 'qcld\_wb\_chatbot\_add\_to\_cart'); |
| [1128](#L1128) | function qcld\_wb\_chatbot\_add\_to\_cart(){ |
| [1129](#L1129) | $product\_id = stripslashes($\_POST['product\_id']); |
| [1130](#L1130) | $product\_quantity = stripslashes($\_POST['quantity']); |
| [1131](#L1131) | global $wpcommerce; |
| [1132](#L1132) | $result = $wpcommerce->cart->add\_to\_cart($product\_id, $product\_quantity); |
| [1133](#L1133) | if ($result != false) { |
| [1134](#L1134) | wp\_send\_json('simple'); |
| [1135](#L1135) | } else { |
| [1136](#L1136) | wp\_send\_json('error'); |
| [1137](#L1137) | } |
| [1138](#L1138) | } |
| [1139](#L1139) | //Support part |
| [1140](#L1140) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_support\_email', 'qcld\_wb\_chatbot\_support\_email'); |
| [1141](#L1141) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_support\_email', 'qcld\_wb\_chatbot\_support\_email'); |
| [1142](#L1142) | function qcld\_wb\_chatbot\_support\_email(){ |
| [1143](#L1143) | $name = trim(sanitize\_text\_field($\_POST['name'])); |
| [1144](#L1144) | $email = sanitize\_email($\_POST['email']); |
| [1145](#L1145) | $message = sanitize\_text\_field($\_POST['message']); |
| [1146](#L1146) | $subject = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_email\_sub') != '' ? get\_option('qlcd\_wp\_chatbot\_email\_sub') : 'Support Email from wpWBot by Client'); |
| [1147](#L1147) | //Extract Domain |
| [1148](#L1148) | $url = get\_site\_url(); |
| [1149](#L1149) | $url = parse\_url($url); |
| [1150](#L1150) | $domain = $url['host']; |
| [1151](#L1151) | //$admin\_email = "admin@" . $domain; |
| [1152](#L1152) | $admin\_email = sanitize\_email(get\_option('admin\_email')); |
| [1153](#L1153) | $toEmail = sanitize\_email(get\_option('qlcd\_wp\_chatbot\_admin\_email') != '' ? get\_option('qlcd\_wp\_chatbot\_admin\_email') : $admin\_email); |
| [1154](#L1154) |  |
| [1155](#L1155) |  |
| [1156](#L1156) | if(get\_option('qlcd\_wp\_chatbot\_from\_email') && get\_option('qlcd\_wp\_chatbot\_from\_email')!=''){ |
| [1157](#L1157) | $fromEmail = get\_option('qlcd\_wp\_chatbot\_from\_email'); |
| [1158](#L1158) | }else{ |
| [1159](#L1159) | $fromEmail = "wordpress@" . $domain; |
| [1160](#L1160) | } |
| [1161](#L1161) |  |
| [1162](#L1162) | //Starting messaging and status. |
| [1163](#L1163) | $response['status'] = 'fail'; |
| [1164](#L1164) | $response['message'] = str\_replace('\\', '',wp\_kses\_post(get\_option('qlcd\_wp\_chatbot\_email\_fail'))); |
| [1165](#L1165) | if (filter\_var($email, FILTER\_VALIDATE\_EMAIL) === false) { |
| [1166](#L1166) | $response['message'] = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_invalid\_email')))); |
| [1167](#L1167) | $response['status'] = 'fail'; |
| [1168](#L1168) | } else { |
| [1169](#L1169) | //build email body |
| [1170](#L1170) | $bodyContent = ""; |
| [1171](#L1171) | $bodyContent .= '<p><strong>' . \_\_('Support Request Details', 'wpchatbot') . ':</strong></p><hr>'; |
| [1172](#L1172) | $bodyContent .= '<p>' . \_\_('Name', 'wpchatbot') . ' : ' . $name . '</p>'; |
| [1173](#L1173) | $bodyContent .= '<p>' . \_\_('Email', 'wpchatbot') . ' : ' . $email . '</p>'; |
| [1174](#L1174) | $bodyContent .= '<p>' . \_\_('Subject', 'wpchatbot') . ' : ' . $subject . '</p>'; |
| [1175](#L1175) | $bodyContent .= '<p>' . \_\_('Message', 'wpchatbot') . ' : ' . $message . '</p>'; |
| [1176](#L1176) | $bodyContent .= '<p>' . \_\_('Mail Generated on', 'wpchatbot') . ': ' . current\_time('F j, Y, g:i a') . '</p>'; |
| [1177](#L1177) | $to = $toEmail; |
| [1178](#L1178) | $body = $bodyContent; |
| [1179](#L1179) | $headers = array(); |
| [1180](#L1180) | $headers[] = 'Content-Type: text/html; charset=UTF-8'; |
| [1181](#L1181) | $headers[] = 'From: ' . $name . ' <' . $fromEmail . '>'; |
| [1182](#L1182) | $headers[] = 'Reply-To: ' . $name . ' <' . $email . '>'; |
| [1183](#L1183) | $result = wp\_mail($to, $subject, $body, $headers); |
| [1184](#L1184) | if ($result) { |
| [1185](#L1185) | $response['status'] = 'success'; |
| [1186](#L1186) | $response['message'] = str\_replace('\\', '',wp\_kses\_post(get\_option('qlcd\_wp\_chatbot\_email\_sent'))); |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | } |
| [1190](#L1190) | echo json\_encode($response); |
| [1191](#L1191) | die(); |
| [1192](#L1192) | } |
| [1193](#L1193) | //Support Phone |
| [1194](#L1194) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_support\_phone', 'qcld\_wb\_chatbot\_support\_phone'); |
| [1195](#L1195) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_support\_phone', 'qcld\_wb\_chatbot\_support\_phone'); |
| [1196](#L1196) | function qcld\_wb\_chatbot\_support\_phone(){ |
| [1197](#L1197) | $name = trim(sanitize\_text\_field($\_POST['name'])); |
| [1198](#L1198) | $phone =sanitize\_text\_field($\_POST['phone']); |
| [1199](#L1199) | $subject = 'WPBot Support Mail Request for Call Back'; |
| [1200](#L1200) | //Extract Domain |
| [1201](#L1201) | $url = get\_site\_url(); |
| [1202](#L1202) | $url = parse\_url($url); |
| [1203](#L1203) | $domain = $url['host']; |
| [1204](#L1204) | //$admin\_email = "admin@" . $domain; |
| [1205](#L1205) | $admin\_email = get\_option('admin\_email'); |
| [1206](#L1206) | $toEmail = sanitize\_email(get\_option('qlcd\_wp\_chatbot\_admin\_email') != '' ? get\_option('qlcd\_wp\_chatbot\_admin\_email') : $admin\_email); |
| [1207](#L1207) |  |
| [1208](#L1208) |  |
| [1209](#L1209) | if(get\_option('qlcd\_wp\_chatbot\_from\_email') && get\_option('qlcd\_wp\_chatbot\_from\_email')!=''){ |
| [1210](#L1210) | $fromEmail = sanitize\_email(get\_option('qlcd\_wp\_chatbot\_from\_email')); |
| [1211](#L1211) | }else{ |
| [1212](#L1212) | $fromEmail = "wordpress@" . $domain; |
| [1213](#L1213) | } |
| [1214](#L1214) | //Starting messaging and status. |
| [1215](#L1215) | $response['status'] = 'fail'; |
| [1216](#L1216) | $response['message'] = str\_replace('\\', '',wp\_kses\_post(get\_option('qlcd\_wp\_chatbot\_phone\_fail'))); |
| [1217](#L1217) | //build email body |
| [1218](#L1218) | $bodyContent = ""; |
| [1219](#L1219) | $bodyContent .= '<p><strong>' . \_\_('Support Request Details', 'wpchatbot') . ':</strong></p><hr>'; |
| [1220](#L1220) | $bodyContent .= '<p>' . \_\_('Name', 'wpchatbot') . ' : ' . $name . '</p>'; |
| [1221](#L1221) | $bodyContent .= '<p>' . \_\_('Phone', 'wpchatbot') . ' : ' . $phone . '</p>'; |
| [1222](#L1222) | $bodyContent .= '<p>' . \_\_('Subject', 'wpchatbot') . ' : ' . $subject . '</p>'; |
| [1223](#L1223) | $bodyContent .= '<p>' . \_\_('Message', 'wpchatbot') . ' : ' . \_\_(' Call me at ', 'wpchatbot'). $phone . '</p>'; |
| [1224](#L1224) | $bodyContent .= '<p>' . \_\_('Mail Generated on', 'wpchatbot') . ': ' . current\_time('F j, Y, g:i a') . '</p>'; |
| [1225](#L1225) | $to = $toEmail; |
| [1226](#L1226) | $body = $bodyContent; |
| [1227](#L1227) | $headers = array(); |
| [1228](#L1228) | $headers[] = 'Content-Type: text/html; charset=UTF-8'; |
| [1229](#L1229) | $headers[] = 'From: ' . $name . ' <' . $fromEmail . '>'; |
| [1230](#L1230) | $headers[] = 'Reply-To: ' . $name . ' <' . $fromEmail . '>'; |
| [1231](#L1231) | $result = wp\_mail($to, $subject, $body, $headers); |
| [1232](#L1232) | if ($result) { |
| [1233](#L1233) | $response['status'] = 'success'; |
| [1234](#L1234) | $response['message'] = str\_replace('\\', '',wp\_kses\_post(get\_option('qlcd\_wp\_chatbot\_phone\_sent'))); |
| [1235](#L1235) | } |
| [1236](#L1236) | echo json\_encode($response); |
| [1237](#L1237) | die(); |
| [1238](#L1238) | } |
| [1239](#L1239) | // Order Status part. removed |
| [1240](#L1240) |  |
| [1241](#L1241) | function wpb\_randmom\_message\_handle($items){ |
| [1242](#L1242) | return $items[rand(0, count($items) - 1)]; |
| [1243](#L1243) | } |
| [1244](#L1244) | function qcld\_wb\_chatbot\_func\_str\_replace($messages = array()){ |
| [1245](#L1245) | $refined\_mesgses = array(); |
| [1246](#L1246) | foreach ($messages as $message) { |
| [1247](#L1247) | $refined\_msg = str\_replace('\\', '', $message); |
| [1248](#L1248) | array\_push($refined\_mesgses, $refined\_msg); |
| [1249](#L1249) | } |
| [1250](#L1250) | return $refined\_mesgses; |
| [1251](#L1251) | } |
| [1252](#L1252) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_login\_user', 'qcld\_wb\_chatbot\_login\_user'); |
| [1253](#L1253) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_login\_user', 'qcld\_wb\_chatbot\_login\_user'); |
| [1254](#L1254) | function qcld\_wb\_chatbot\_login\_user(){ |
| [1255](#L1255) | // First check the nonce, if it fails the function will break |
| [1256](#L1256) | check\_ajax\_referer('wpwbot-order-nonce', 'security'); |
| [1257](#L1257) | // Nonce is checked, get the POST data and sign user on |
| [1258](#L1258) | $info = array(); |
| [1259](#L1259) | $info['user\_login'] = trim(sanitize\_text\_field($\_POST['user\_name'])); |
| [1260](#L1260) | $info['user\_password'] = trim(sanitize\_text\_field($\_POST['user\_pass'])); |
| [1261](#L1261) | $info['remember'] = true; |
| [1262](#L1262) | $user\_signon = wp\_signon($info, false); |
| [1263](#L1263) | $response = array(); |
| [1264](#L1264) | if (is\_wp\_error($user\_signon)) { |
| [1265](#L1265) | $response['status'] = "fail"; |
| [1266](#L1266) | $response['message'] = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_password\_incorrect')))); |
| [1267](#L1267) | } else { |
| [1268](#L1268) | $response = get\_order\_by\_username($info['user\_login']); |
| [1269](#L1269) | $response['status'] = "success"; |
| [1270](#L1270) | } |
| [1271](#L1271) | wp\_send\_json($response); |
| [1272](#L1272) | } |
| [1273](#L1273) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_loged\_in\_user\_orders', 'qcld\_wb\_chatbot\_loged\_in\_user\_orders'); |
| [1274](#L1274) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_loged\_in\_user\_orders', 'qcld\_wb\_chatbot\_loged\_in\_user\_orders'); |
| [1275](#L1275) | function qcld\_wb\_chatbot\_loged\_in\_user\_orders(){ |
| [1276](#L1276) | $current\_user = wp\_get\_current\_user(); |
| [1277](#L1277) | $user\_name = $current\_user->user\_login; |
| [1278](#L1278) | $response = get\_order\_by\_username($user\_name); |
| [1279](#L1279) | wp\_send\_json($response); |
| [1280](#L1280) | } |
| [1281](#L1281) | function get\_order\_by\_username($user\_name){ |
| [1282](#L1282) | global $post; |
| [1283](#L1283) | $response = array(); |
| [1284](#L1284) | $response['status'] .= "success"; |
| [1285](#L1285) | $user = get\_user\_by('login', $user\_name); |
| [1286](#L1286) | // The query arguments |
| [1287](#L1287) | $customer\_orders = get\_posts(array( |
| [1288](#L1288) | 'numberposts' => -1, |
| [1289](#L1289) | 'meta\_key' => '\_customer\_user', |
| [1290](#L1290) | 'meta\_value' => $user->ID, |
| [1291](#L1291) | 'post\_type' => wc\_get\_order\_types(), |
| [1292](#L1292) | 'post\_status' => array\_keys(wc\_get\_order\_statuses()), |
| [1293](#L1293) | 'posts\_per\_page' => 10, |
| [1294](#L1294) | 'orderby' => 'date', |
| [1295](#L1295) | )); |
| [1296](#L1296) | $response['order\_num'] = count($customer\_orders); |
| [1297](#L1297) | $order\_html = ''; |
| [1298](#L1298) | if ($response['order\_num'] > 0) { |
| [1299](#L1299) | $response['message'] .= wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_found')))); |
| [1300](#L1300) | $order\_html .= '<div class="wp-chatbot-orders-container"> |
| [1301](#L1301) | <div class="wp-chatbot-orders-header"> |
| [1302](#L1302) | <div class="order-id">' . \_\_('ID', 'wpchatbot') . '</div> |
| [1303](#L1303) | <div class="order-date">' . \_\_('Date', 'wpchatbot') . ' </div> |
| [1304](#L1304) | <div class="order-items">' . \_\_('Items', 'wpchatbot') . '</div> |
| [1305](#L1305) | <div class="order-status">' . \_\_('Status', 'wpchatbot') . '</div> |
| [1306](#L1306) | </div>'; |
| [1307](#L1307) | foreach ($customer\_orders as $order) { |
| [1308](#L1308) | //Formatting order summery |
| [1309](#L1309) | if (isset($\_COOKIE['from\_app']) && $\_COOKIE['from\_app'] == 'yes') { |
| [1310](#L1310) | $thanks\_page\_id = sanitize\_text\_field(get\_option('wp\_chatbot\_app\_order\_thankyou')); |
| [1311](#L1311) | $thanks\_parmanlink = esc\_url(get\_permalink($thanks\_page\_id)); |
| [1312](#L1312) | $order\_url = '<a href="' . $thanks\_parmanlink . '?order\_id=' . $order->ID . '" >' . $order->ID . '</a>'; |
| [1313](#L1313) | } else { |
| [1314](#L1314) | $order\_url = '<a href="' . get\_url(get\_permalink(get\_option('wpcommerce\_myaccount\_page\_id')) . '/view-order/' . $order->ID) . '" target="\_blank" >' . $order->ID . '</a>'; |
| [1315](#L1315) | } |
| [1316](#L1316) | $order\_html .= '<div class="wp-chatbot-orders-single"> |
| [1317](#L1317) | <div class="order-id"> ' . $order\_url . '</div> |
| [1318](#L1318) | <div class="order-date"> <p>' . date("m/d/Y", strtotime($order->post\_date)) . '</p> </div> |
| [1319](#L1319) | <div class="order-items">'; |
| [1320](#L1320) | $singleOrder = new WC\_Order($order->ID); |
| [1321](#L1321) | $items = $singleOrder->get\_items(); |
| [1322](#L1322) | foreach ($items as $item) { |
| [1323](#L1323) | $order\_html .= '<p>' . $item["name"] . ' X ' . $item["qty"] . '</p>'; |
| [1324](#L1324) | } |
| [1325](#L1325) | $order\_html .= '</div> |
| [1326](#L1326) | <div class="order-status">' . strtoupper(end(explode("-", $order->post\_status))) . '</div> |
| [1327](#L1327) |  |
| [1328](#L1328) | </div>'; |
| [1329](#L1329) | } |
| [1330](#L1330) | $order\_html .= '</div>'; |
| [1331](#L1331) | } else { |
| [1332](#L1332) | $response['message'] .= get\_option('qlcd\_wp\_chatbot\_sorry') . '! <strong>' . $user\_name . '</strong>'; |
| [1333](#L1333) | $order\_html .= '<p>' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_not\_found')))) . '</p>'; |
| [1334](#L1334) | } |
| [1335](#L1335) | $response['html'] = $order\_html; |
| [1336](#L1336) | return $response; |
| [1337](#L1337) | } |
| [1338](#L1338) | //Recently viewed products |
| [1339](#L1339) | //keeping id in cookies as |
| [1340](#L1340) | function wp\_chatbot\_track\_product\_view(){ |
| [1341](#L1341) | if (!is\_singular('product')) { |
| [1342](#L1342) | return; |
| [1343](#L1343) | } |
| [1344](#L1344) | global $post; |
| [1345](#L1345) | wp\_chatbot\_view\_track\_product\_by\_id($post->ID); |
| [1346](#L1346) | } |
| [1347](#L1347) | function wp\_chatbot\_view\_track\_product\_by\_id($post\_id){ |
| [1348](#L1348) | if (empty($\_COOKIE['wp\_chatbot\_wpcommerce\_recently\_viewed'])) |
| [1349](#L1349) | $viewed\_products = array(); |
| [1350](#L1350) | else |
| [1351](#L1351) | $viewed\_products = (array)explode('|', $\_COOKIE['wp\_chatbot\_wpcommerce\_recently\_viewed']); |
| [1352](#L1352) | if (!in\_array($post\_id, $viewed\_products)) { |
| [1353](#L1353) | $viewed\_products[] = $post\_id; |
| [1354](#L1354) | } |
| [1355](#L1355) | if (sizeof($viewed\_products) > 15) { |
| [1356](#L1356) | array\_shift($viewed\_products); |
| [1357](#L1357) | } |
| [1358](#L1358) | // Store for session only |
| [1359](#L1359) | if( function\_exists( 'wc\_setcookie' ) ){ |
| [1360](#L1360) | wc\_setcookie('wp\_chatbot\_wpcommerce\_recently\_viewed', implode('|', $viewed\_products)); |
| [1361](#L1361) | } |
| [1362](#L1362) | } |
| [1363](#L1363) | add\_action('template\_redirect', 'wp\_chatbot\_track\_product\_view', 20); |
| [1364](#L1364) | //recent view product ajax |
| [1365](#L1365) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_recently\_viewed\_products', 'qcld\_wb\_chatbot\_recently\_viewed\_products'); |
| [1366](#L1366) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_recently\_viewed\_products', 'qcld\_wb\_chatbot\_recently\_viewed\_products'); |
| [1367](#L1367) | function qcld\_wb\_chatbot\_recently\_viewed\_products(){ |
| [1368](#L1368) | // Get wpCommerce Global |
| [1369](#L1369) | $\_pf = new WC\_Product\_Factory(); |
| [1370](#L1370) | //show post per page. |
| [1371](#L1371) | $product\_per\_page = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_ppp') != '' ? get\_option('qlcd\_wp\_chatbot\_ppp') : 10); |
| [1372](#L1372) | $wp\_chatbot\_product\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_latest\_product\_welcome')))); |
| [1373](#L1373) | // Get recently viewed product cookies data |
| [1374](#L1374) | $viewed\_products = !empty($\_COOKIE['wp\_chatbot\_wpcommerce\_recently\_viewed']) ? (array)explode('|', $\_COOKIE['wp\_chatbot\_wpcommerce\_recently\_viewed']) : array(); |
| [1375](#L1375) | $viewed\_products = array\_filter(array\_map('absint', $viewed\_products)); |
| [1376](#L1376) | //get featured products if has. |
| [1377](#L1377) | $featured\_products = new WP\_Query(array('post\_status' => 'publish', 'posts\_per\_page' => $product\_per\_page, 'post\_type' => 'product', 'tax\_query' => array(array('taxonomy' => 'product\_visibility', 'field' => 'name', 'terms' => 'featured')))); |
| [1378](#L1378) | //Getting recently vieew products. |
| [1379](#L1379) | if (!empty($viewed\_products)) { |
| [1380](#L1380) | $wp\_chatbot\_product\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_viewed\_product\_welcome')))); |
| [1381](#L1381) | $product\_query = new WP\_Query(array( |
| [1382](#L1382) | 'posts\_per\_page' => $product\_per\_page, |
| [1383](#L1383) | 'no\_found\_rows' => 1, |
| [1384](#L1384) | 'post\_status' => 'publish', |
| [1385](#L1385) | 'post\_type' => 'product', |
| [1386](#L1386) | 'post\_\_in' => $viewed\_products, |
| [1387](#L1387) | )); |
| [1388](#L1388) | //Getting featured products |
| [1389](#L1389) | } else if ($featured\_products->post\_count > 0) { |
| [1390](#L1390) | $wp\_chatbot\_product\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_featured\_product\_welcome')))); |
| [1391](#L1391) | $product\_query = $featured\_products; |
| [1392](#L1392) | } else { |
| [1393](#L1393) | $wp\_chatbot\_product\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_latest\_product\_welcome')))); |
| [1394](#L1394) | //Getting recent products |
| [1395](#L1395) | $product\_query = new WP\_Query(array('post\_status' => 'publish', 'posts\_per\_page' => $product\_per\_page, 'post\_type' => 'product', 'orderby' => 'date', 'order' => 'DESC')); |
| [1396](#L1396) | } |
| [1397](#L1397) | if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') == "custom-agent.png") { |
| [1398](#L1398) | $wp\_chatbot\_custom\_icon\_path = get\_option('wp\_chatbot\_custom\_agent\_path'); |
| [1399](#L1399) | } else if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') != "custom-agent.png") { |
| [1400](#L1400) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . get\_option('wp\_chatbot\_agent\_image'); |
| [1401](#L1401) | } else { |
| [1402](#L1402) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'custom-agent.png'; |
| [1403](#L1403) | } |
| [1404](#L1404) | $html = '<div class="wp-chatbot-agent-profile"> |
| [1405](#L1405) | <div class="wp-chatbot-widget-avatar"><img src="' . esc\_url($wp\_chatbot\_custom\_icon\_path) . '" alt=""></div> |
| [1406](#L1406) | <div class="wp-chatbot-widget-agent">' . esc\_html(get\_option('qlcd\_wp\_chatbot\_agent')) . '</div> |
| [1407](#L1407) | <div class="wp-chatbot-bubble">' . $wp\_chatbot\_product\_title . '</div> |
| [1408](#L1408) | </div>'; |
| [1409](#L1409) | if ($product\_query->post\_count > 0) { |
| [1410](#L1410) | $html .= '<div class="wp-chatbot-products-area">'; |
| [1411](#L1411) | $html .= '<ul class="wp-chatbot-products">'; |
| [1412](#L1412) | while ($product\_query->have\_posts()) : $product\_query->the\_post(); |
| [1413](#L1413) | $product = $\_pf->get\_product(get\_the\_ID()); |
| [1414](#L1414) | $html .= '<li class="wp-chatbot-product">'; |
| [1415](#L1415) | $html .= '<a target="\_blank" href="' . get\_permalink(get\_the\_ID()) . '" wp-chatbot-pid= "' . get\_the\_ID() . '" title="' . esc\_attr($product->post->post\_title ? $product->post->post\_title : get\_the\_ID()) . '">'; |
| [1416](#L1416) | $html .= get\_the\_post\_thumbnail(get\_the\_ID(), 'shop\_catalog') . ' |
| [1417](#L1417) | <div class="wp-chatbot-product-summary"> |
| [1418](#L1418) | <div class="wp-chatbot-product-table"> |
| [1419](#L1419) | <div class="wp-chatbot-product-table-cell"> |
| [1420](#L1420) | <h3 class="wp-chatbot-product-title">' . $product->post->post\_title . '</h3> |
| [1421](#L1421) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [1422](#L1422) | $html .= ' </div> |
| [1423](#L1423) | </div> |
| [1424](#L1424) | </div></a> |
| [1425](#L1425) | </li>'; |
| [1426](#L1426) | endwhile; |
| [1427](#L1427) | wp\_reset\_query(); |
| [1428](#L1428) | wp\_reset\_postdata(); |
| [1429](#L1429) | $html .= '</ul></div>'; |
| [1430](#L1430) | } else { |
| [1431](#L1431) | $html .= '<div class="wp-chatbot-products-area">'; |
| [1432](#L1432) | $html .= '<p style="text-align: center">You have no products !'; |
| [1433](#L1433) | $html .= '</div>'; |
| [1434](#L1434) | } |
| [1435](#L1435) | wp\_send\_json($html); |
| [1436](#L1436) | } |
| [1437](#L1437) | //Recently viewed product shortcode |
| [1438](#L1438) | add\_shortcode('wpwbot\_products', 'qcld\_wb\_chatbot\_recently\_viewed\_shortcode'); |
| [1439](#L1439) | function qcld\_wb\_chatbot\_recently\_viewed\_shortcode(){ |
| [1440](#L1440) | // Get wpCommerce Global |
| [1441](#L1441) | $\_pf = new WC\_Product\_Factory(); |
| [1442](#L1442) | $product\_per\_page = sanitize\_text\_field(get\_option('qlcd\_wp\_chatbot\_ppp') != '' ? get\_option('qlcd\_wp\_chatbot\_ppp') : 10); |
| [1443](#L1443) | $wp\_chatbot\_product\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_latest\_product\_welcome')))); |
| [1444](#L1444) | // Get recently viewed product cookies data |
| [1445](#L1445) | $viewed\_products = !empty($\_COOKIE['wp\_chatbot\_wpcommerce\_recently\_viewed']) ? (array)explode('|', $\_COOKIE['wp\_chatbot\_wpcommerce\_recently\_viewed']) : array(); |
| [1446](#L1446) | $viewed\_products = array\_filter(array\_map('absint', $viewed\_products)); |
| [1447](#L1447) | //get featured products if has. |
| [1448](#L1448) | $featured\_products = new WP\_Query(array('post\_status' => 'publish', 'posts\_per\_page' => $product\_per\_page, 'post\_type' => 'product', 'tax\_query' => array(array('taxonomy' => 'product\_visibility', 'field' => 'name', 'terms' => 'featured')))); |
| [1449](#L1449) | //Getting recently vieew products. |
| [1450](#L1450) | if (!empty($viewed\_products)) { |
| [1451](#L1451) | $wp\_chatbot\_product\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_viewed\_product\_welcome')))); |
| [1452](#L1452) | $product\_query = new WP\_Query(array( |
| [1453](#L1453) | 'posts\_per\_page' => $product\_per\_page, |
| [1454](#L1454) | 'no\_found\_rows' => 1, |
| [1455](#L1455) | 'post\_status' => 'publish', |
| [1456](#L1456) | 'post\_type' => 'product', |
| [1457](#L1457) | 'post\_\_in' => $viewed\_products, |
| [1458](#L1458) | )); |
| [1459](#L1459) | //implementing featured products |
| [1460](#L1460) | } else if ($featured\_products->post\_count > 0) { |
| [1461](#L1461) | $wp\_chatbot\_product\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_featured\_product\_welcome')))); |
| [1462](#L1462) | $product\_query = $featured\_products; |
| [1463](#L1463) | } else { |
| [1464](#L1464) | $wp\_chatbot\_product\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_latest\_product\_welcome')))); |
| [1465](#L1465) | //Getting recent products |
| [1466](#L1466) | $product\_query = new WP\_Query(array('post\_status' => 'publish', 'posts\_per\_page' => $product\_per\_page, 'post\_type' => 'product', 'orderby' => 'date', 'order' => 'DESC')); |
| [1467](#L1467) | } |
| [1468](#L1468) | if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') == "custom-agent.png") { |
| [1469](#L1469) | $wp\_chatbot\_custom\_icon\_path = get\_option('wp\_chatbot\_custom\_agent\_path'); |
| [1470](#L1470) | } else if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') != "custom-agent.png") { |
| [1471](#L1471) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . get\_option('wp\_chatbot\_agent\_image'); |
| [1472](#L1472) | } else { |
| [1473](#L1473) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'custom-agent.png'; |
| [1474](#L1474) | } |
| [1475](#L1475) | $html = '<div class="wp-chatbot-agent-profile"> |
| [1476](#L1476) | <div class="wp-chatbot-widget-avatar"><img src="' . esc\_url($wp\_chatbot\_custom\_icon\_path) . '" alt=""></div> |
| [1477](#L1477) | <div class="wp-chatbot-widget-agent">' . esc\_html(get\_option('qlcd\_wp\_chatbot\_agent')) . '</div> |
| [1478](#L1478) | <div class="wp-chatbot-bubble">' . esc\_html($wp\_chatbot\_product\_title) . '</div> |
| [1479](#L1479) | </div>'; |
| [1480](#L1480) | if ($product\_query->post\_count > 0) { |
| [1481](#L1481) | $html .= '<div class="wp-chatbot-products-area">'; |
| [1482](#L1482) | $html .= '<ul class="wp-chatbot-products">'; |
| [1483](#L1483) | while ($product\_query->have\_posts()) : $product\_query->the\_post(); |
| [1484](#L1484) | $product = $\_pf->get\_product(get\_the\_ID()); |
| [1485](#L1485) | $html .= '<li class="wp-chatbot-product">'; |
| [1486](#L1486) | $html .= '<a target="\_blank" href="' . get\_permalink(get\_the\_ID()) . '" wp-chatbot-pid= "' . get\_the\_ID() . '" title="' . esc\_attr($product->post->post\_title ? $product->post->post\_title : get\_the\_ID()) . '">'; |
| [1487](#L1487) | $html .= get\_the\_post\_thumbnail(get\_the\_ID(), 'shop\_catalog') . ' |
| [1488](#L1488) | <div class="wp-chatbot-product-summary"> |
| [1489](#L1489) | <div class="wp-chatbot-product-table"> |
| [1490](#L1490) | <div class="wp-chatbot-product-table-cell"> |
| [1491](#L1491) | <h3 class="wp-chatbot-product-title">' . $product->post->post\_title . '</h3> |
| [1492](#L1492) | <div class="price">' . $product->get\_price\_html() . '</div>'; |
| [1493](#L1493) | $html .= ' </div> |
| [1494](#L1494) | </div> |
| [1495](#L1495) | </div></a> |
| [1496](#L1496) | </li>'; |
| [1497](#L1497) | endwhile; |
| [1498](#L1498) | wp\_reset\_query(); |
| [1499](#L1499) | wp\_reset\_postdata(); |
| [1500](#L1500) | $html .= '</ul></div>'; |
| [1501](#L1501) | } else { |
| [1502](#L1502) | $html .= '<div class="wp-chatbot-products-area">'; |
| [1503](#L1503) | $html .= '<p style="text-align: center">' . \_\_('You have no products', 'wpchatbot') . ' !'; |
| [1504](#L1504) | $html .= '</div>'; |
| [1505](#L1505) | } |
| [1506](#L1506) | return $html; |
| [1507](#L1507) | } |
| [1508](#L1508) | //Show cart for wp chatbot |
| [1509](#L1509) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_show\_cart', 'qcld\_wb\_chatbot\_show\_cart'); |
| [1510](#L1510) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_show\_cart', 'qcld\_wb\_chatbot\_show\_cart'); |
| [1511](#L1511) | function qcld\_wb\_chatbot\_show\_cart(){ |
| [1512](#L1512) | global $wpcommerce; |
| [1513](#L1513) | // $cart\_url = $wpcommerce->cart->get\_cart\_url(); |
| [1514](#L1514) | $cart\_url = wc\_get\_cart\_url(); |
| [1515](#L1515) | $checkout\_url = wc\_get\_checkout\_url(); |
| [1516](#L1516) | //$checkout\_url = $wpcommerce->cart->get\_checkout\_url(); |
| [1517](#L1517) | $items = $wpcommerce->cart->get\_cart(); |
| [1518](#L1518) | $itemCount = $wpcommerce->cart->cart\_contents\_count; |
| [1519](#L1519) | $cart\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_shopping\_cart')))); |
| [1520](#L1520) | $no\_cart\_item\_msg = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_no\_cart\_items')))); |
| [1521](#L1521) | if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') == "custom-agent.png") { |
| [1522](#L1522) | $wp\_chatbot\_custom\_icon\_path = get\_option('wp\_chatbot\_custom\_agent\_path'); |
| [1523](#L1523) | } else if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') != "custom-agent.png") { |
| [1524](#L1524) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . get\_option('wp\_chatbot\_agent\_image'); |
| [1525](#L1525) | } else { |
| [1526](#L1526) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'custom-agent.png'; |
| [1527](#L1527) | } |
| [1528](#L1528) | $html = '<div class="wp-chatbot-agent-profile"> |
| [1529](#L1529) | <div class="wp-chatbot-widget-avatar"><img src="' . esc\_url($wp\_chatbot\_custom\_icon\_path) . '" alt=""></div> |
| [1530](#L1530) | <div class="wp-chatbot-widget-agent">' . esc\_html(get\_option('qlcd\_wp\_chatbot\_agent')) . '</div> |
| [1531](#L1531) | <div class="wp-chatbot-bubble">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_welcome')))) . '</div> |
| [1532](#L1532) | </div>'; |
| [1533](#L1533) | if ($itemCount >= 1) { |
| [1534](#L1534) | $html .= '<div class ="wp-chatbot-cart-container">'; |
| [1535](#L1535) | $html .= '<div class="wp-chatbot-cart-header"><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_title')))) . '</div><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_quantity')))) . '</div><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_price')))) . '</div><div class="qcld-wp-chatbot-cell"></div></div>'; |
| [1536](#L1536) | $html .= '<div class ="wp-chatbot-cart-body">'; |
| [1537](#L1537) | foreach ($items as $item => $values) { |
| [1538](#L1538) | $cart\_item= apply\_filters('wpcommerce\_cart\_item\_product', $values['data'], $values, $item); |
| [1539](#L1539) | //product image |
| [1540](#L1540) | $getProductDetail = wc\_get\_product($values['product\_id']); |
| [1541](#L1541) | $price = get\_post\_meta($values['product\_id'], '\_price', true); |
| [1542](#L1542) | $html .= '<div class="wp-chatbot-cart-single"> |
| [1543](#L1543) | <div class="qcld-wp-chatbot-cell"> <h3 class="wp-chatbot-title">' . $cart\_item->get\_title() . '</h3></div>'; |
| [1544](#L1544) | $html .= '<div class="qcld-wp-chatbot-cell">'; |
| [1545](#L1545) | $html .= '<input class="qcld-wp-chatbot-cart-item-qnty" data-cart-item="' . $item . '" type="number" min="1" value="' . $values['quantity'] . '"></div>'; |
| [1546](#L1546) | $html .= '<div class="qcld-wp-chatbot-cell"><span class="wp-chatbot-cart-price">' . apply\_filters('wpcommerce\_cart\_item\_price', WC()->cart->get\_product\_price($cart\_item), $values, $item) . '</span> </div>'; |
| [1547](#L1547) | $html .= '<div class="qcld-wp-chatbot-cell"><span data-cart-item="' . $item . '" class="wp-chatbot-remove-cart-item">X</span></div> </div>'; |
| [1548](#L1548) | } |
| [1549](#L1549) | $html .= ' </div>';//End of cart body |
| [1550](#L1550) | $html .= '<div class="wp-chatbot-cart-single"> |
| [1551](#L1551) | <div class="qcld-wp-chatbot-cell"></div> |
| [1552](#L1552) | <div class="qcld-wp-chatbot-cell"><strong>Total</strong></div> |
| [1553](#L1553) | <div class="qcld-wp-chatbot-cell"><strong>' . $wpcommerce->cart->get\_cart\_total() . '</strong></div> |
| [1554](#L1554) | </div>'; |
| [1555](#L1555) | $html .= '<div class="wp-chatbot-cart-footer"><div class="qcld-wp-chatbot-cart-page"><a class="wp-chatbot-cart-link" href="' . $cart\_url . '" target="\_blank"  >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_link')))) . '</a></div><div class="qcld-wp-chatbot-checkout"><a class="wp-chatbot-checkout-link" href="' . $checkout\_url . '" target="\_blank"  >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_checkout\_link')))) . '</a></div></div>'; |
| [1556](#L1556) | $html .= ' </div>'; |
| [1557](#L1557) | } else { |
| [1558](#L1558) | $html .= '<div class="wp-chatbot-cart-container">'; |
| [1559](#L1559) | $html .= '<div><p style="text-align:center">' . $no\_cart\_item\_msg . '</p></div>'; |
| [1560](#L1560) | $html .= '</div>'; |
| [1561](#L1561) | } |
| [1562](#L1562) | $response = array('html' => $html, 'items' => $itemCount); |
| [1563](#L1563) | wp\_send\_json($response); |
| [1564](#L1564) | } |
| [1565](#L1565) | //cart onley for wp chatbot |
| [1566](#L1566) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_only\_cart', 'qcld\_wb\_chatbot\_only\_cart'); |
| [1567](#L1567) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_only\_cart', 'qcld\_wb\_chatbot\_only\_cart'); |
| [1568](#L1568) | function qcld\_wb\_chatbot\_only\_cart(){ |
| [1569](#L1569) | global $wpcommerce; |
| [1570](#L1570) | // $cart\_url = $wpcommerce->cart->get\_cart\_url(); |
| [1571](#L1571) | $cart\_url = wc\_get\_cart\_url(); |
| [1572](#L1572) | $checkout\_url = wc\_get\_checkout\_url(); |
| [1573](#L1573) | //$checkout\_url = $wpcommerce->cart->get\_checkout\_url(); |
| [1574](#L1574) | $items = $wpcommerce->cart->get\_cart(); |
| [1575](#L1575) | $itemCount = $wpcommerce->cart->cart\_contents\_count; |
| [1576](#L1576) | $no\_cart\_item\_msg = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_no\_cart\_items')))); |
| [1577](#L1577) |  |
| [1578](#L1578) | $html = ''; |
| [1579](#L1579) | if ($itemCount >= 1) { |
| [1580](#L1580) | $html .= '<div class ="wp-chatbot-cart-container">'; |
| [1581](#L1581) | $html .= '<div class="wp-chatbot-cart-header"><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_title')))) . '</div><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_quantity')))) . '</div><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_price')))) . '</div><div class="qcld-wp-chatbot-cell"></div></div>'; |
| [1582](#L1582) | $html .= '<div class ="wp-chatbot-cart-body">'; |
| [1583](#L1583) | foreach ($items as $item => $values) { |
| [1584](#L1584) | $cart\_item= apply\_filters('wpcommerce\_cart\_item\_product', $values['data'], $values, $item); |
| [1585](#L1585) | //product image |
| [1586](#L1586) | $getProductDetail = wc\_get\_product($values['product\_id']); |
| [1587](#L1587) | $price = get\_post\_meta($values['product\_id'], '\_price', true); |
| [1588](#L1588) | $html .= '<div class="wp-chatbot-cart-single"> |
| [1589](#L1589) | <div class="qcld-wp-chatbot-cell"> <h3 class="wp-chatbot-title">' . $cart\_item->get\_title() . '</h3></div>'; |
| [1590](#L1590) | $html .= '<div class="qcld-wp-chatbot-cell">'; |
| [1591](#L1591) | $html .= '<input class="qcld-wp-chatbot-cart-item-qnty" data-cart-item="' . $item . '" type="number" min="1" value="' . $values['quantity'] . '"></div>'; |
| [1592](#L1592) | $html .= '<div class="qcld-wp-chatbot-cell"><span class="wp-chatbot-cart-price">' . apply\_filters('wpcommerce\_cart\_item\_price', WC()->cart->get\_product\_price($cart\_item), $values, $item) . '</span> </div>'; |
| [1593](#L1593) | $html .= '<div class="qcld-wp-chatbot-cell"><span data-cart-item="' . $item . '" class="wp-chatbot-remove-cart-item">X</span></div> </div>'; |
| [1594](#L1594) | } |
| [1595](#L1595) | $html .= ' </div>';//End of cart body |
| [1596](#L1596) | $html .= '<div class="wp-chatbot-cart-single"> |
| [1597](#L1597) | <div class="qcld-wp-chatbot-cell"></div> |
| [1598](#L1598) | <div class="qcld-wp-chatbot-cell"><strong>Total</strong></div> |
| [1599](#L1599) | <div class="qcld-wp-chatbot-cell"><strong>' . $wpcommerce->cart->get\_cart\_total() . '</strong></div> |
| [1600](#L1600) | </div>'; |
| [1601](#L1601) | $html .= '<div class="wp-chatbot-cart-footer"><div class="qcld-wp-chatbot-cart-page"><a class="wp-chatbot-cart-link" href="' . $cart\_url . '" target="\_blank"  >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_link')))) . '</a></div><div class="qcld-wp-chatbot-checkout"><a class="wp-chatbot-checkout-link" href="' . $checkout\_url . '" target="\_blank"  >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_checkout\_link')))) . '</a></div></div>'; |
| [1602](#L1602) | $html .= ' </div>'; |
| [1603](#L1603) | } else { |
| [1604](#L1604) | $html .= '<div class="wp-chatbot-cart-container">'; |
| [1605](#L1605) | $html .= '<div><p style="text-align:center">' . esc\_html($no\_cart\_item\_msg) . '</p></div>'; |
| [1606](#L1606) | $html .= '</div>'; |
| [1607](#L1607) | } |
| [1608](#L1608) | $response = array('html' => $html, 'items' => $itemCount); |
| [1609](#L1609) | wp\_send\_json($response); |
| [1610](#L1610) | } |
| [1611](#L1611) | //Cart show Shortcode |
| [1612](#L1612) | add\_shortcode('wpwbot\_cart', 'qcld\_wb\_chatbot\_cart\_shortcode'); |
| [1613](#L1613) | function qcld\_wb\_chatbot\_cart\_shortcode(){ |
| [1614](#L1614) | global $wpcommerce; |
| [1615](#L1615) | $items = $wpcommerce->cart->get\_cart(); |
| [1616](#L1616) | $itemCount = $wpcommerce->cart->cart\_contents\_count; |
| [1617](#L1617) | $cart\_title = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_shopping\_cart')))); |
| [1618](#L1618) | $no\_cart\_item\_msg = wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_no\_cart\_items')))); |
| [1619](#L1619) | if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') == "custom-agent.png") { |
| [1620](#L1620) | $wp\_chatbot\_custom\_icon\_path = get\_option('wp\_chatbot\_custom\_agent\_path'); |
| [1621](#L1621) | } else if (get\_option('wp\_chatbot\_custom\_agent\_path') != "" && get\_option('wp\_chatbot\_agent\_image') != "custom-agent.png") { |
| [1622](#L1622) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . get\_option('wp\_chatbot\_agent\_image'); |
| [1623](#L1623) | } else { |
| [1624](#L1624) | $wp\_chatbot\_custom\_icon\_path = QCLD\_wpCHATBOT\_IMG\_URL . 'custom-agent.png'; |
| [1625](#L1625) | } |
| [1626](#L1626) | $html = '<div class="wp-chatbot-agent-profile"> |
| [1627](#L1627) | <div class="wp-chatbot-widget-avatar"><img src="' . esc\_url($wp\_chatbot\_custom\_icon\_path) . '" alt=""></div> |
| [1628](#L1628) | <div class="wp-chatbot-widget-agent">' . esc\_html(get\_option('qlcd\_wp\_chatbot\_agent')) . '</div> |
| [1629](#L1629) | <div class="wp-chatbot-bubble">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_welcome')))) . '</div> |
| [1630](#L1630) | </div>'; |
| [1631](#L1631) | if ($itemCount >= 1) { |
| [1632](#L1632) | $html .= '<div class ="wp-chatbot-cart-container">'; |
| [1633](#L1633) | $html .= '<div class="wp-chatbot-cart-header"><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_title')))) . '</div><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_quantity')))) . '</div><div class="qcld-wp-chatbot-cell">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_price')))) . '</div> <div class="qcld-wp-chatbot-cell"></div> </div>'; |
| [1634](#L1634) | $html .= '<div class ="wp-chatbot-cart-body">'; |
| [1635](#L1635) | foreach ($items as $item => $values) { |
| [1636](#L1636) | $cart\_item = apply\_filters('wpcommerce\_cart\_item\_product', $values['data'], $values, $item); |
| [1637](#L1637) | //product image |
| [1638](#L1638) | $getProductDetail = wc\_get\_product($values['product\_id']); |
| [1639](#L1639) | $price = get\_post\_meta($values['product\_id'], '\_price', true); |
| [1640](#L1640) | $html .= '<div class="wp-chatbot-cart-single"> |
| [1641](#L1641) | <div class="qcld-wp-chatbot-cell"> <h3 class="wp-chatbot-title">' . $cart\_item->get\_title() . '</h3></div>'; |
| [1642](#L1642) | $html .= '<div class="qcld-wp-chatbot-cell">'; |
| [1643](#L1643) | $html .= '<input class="qcld-wp-chatbot-cart-item-qnty" data-cart-item="' . $item . '" type="number" min="1" value="' . $values['quantity'] . '"></div>'; |
| [1644](#L1644) | $html .= '<div class="qcld-wp-chatbot-cell"><span class="wp-chatbot-cart-price">' . apply\_filters('wpcommerce\_cart\_item\_price', WC()->cart->get\_product\_price($cart\_item), $values, $item) . '</span> </div>'; |
| [1645](#L1645) | $html .= '<div class="qcld-wp-chatbot-cell"><span data-cart-item="' . $item . '" class="wp-chatbot-remove-cart-item">X</span></div> </div>'; |
| [1646](#L1646) | } |
| [1647](#L1647) | $html .= ' </div>';//End of cart body |
| [1648](#L1648) | $html .= '<div class="wp-chatbot-cart-single"> |
| [1649](#L1649) | <div class="qcld-wp-chatbot-cell"></div> |
| [1650](#L1650) | <div class="qcld-wp-chatbot-cell"><strong>Total</strong></div> |
| [1651](#L1651) | <div class="qcld-wp-chatbot-cell"><strong>' . $wpcommerce->cart->get\_cart\_total() . '</strong></div> |
| [1652](#L1652) | </div>'; |
| [1653](#L1653) | $html .= '<div class="wp-chatbot-cart-footer"><div class="qcld-wp-chatbot-cart-page"><a href="' . site\_url() . '/cart" target="\_blank" >' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_cart\_link')))) . '</a></div><div class="qcld-wp-chatbot-checkout"><a href="' . site\_url() . '/checkout" target="\_blank">' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_checkout\_link')))) . '</a></div></div>'; |
| [1654](#L1654) | $html .= ' </div>'; |
| [1655](#L1655) | } else { |
| [1656](#L1656) | $html .= '<div class="wp-chatbot-cart-container">'; |
| [1657](#L1657) | $html .= '<div><p style="text-align:center">' . $no\_cart\_item\_msg . '</p></div>'; |
| [1658](#L1658) | $html .= '</div>'; |
| [1659](#L1659) | } |
| [1660](#L1660) | // $response=array('html'=>$html,'items'=>$itemCount); |
| [1661](#L1661) | return $html; |
| [1662](#L1662) | } |
| [1663](#L1663) | //Updating the cart items. |
| [1664](#L1664) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_update\_cart\_item\_number', 'qcld\_wb\_chatbot\_update\_cart\_item\_number'); |
| [1665](#L1665) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_update\_cart\_item\_number', 'qcld\_wb\_chatbot\_update\_cart\_item\_number'); |
| [1666](#L1666) | function qcld\_wb\_chatbot\_update\_cart\_item\_number(){ |
| [1667](#L1667) | //getting cart items n |
| [1668](#L1668) | $cart\_item\_key = sanitize\_text\_field($\_POST['cart\_item\_key']); |
| [1669](#L1669) | $qnty = sanitize\_text\_field($\_POST['qnty']); |
| [1670](#L1670) | global $wpcommerce; |
| [1671](#L1671) | $result = $wpcommerce->cart->set\_quantity($cart\_item\_key, $qnty); |
| [1672](#L1672) | wp\_send\_json($result); |
| [1673](#L1673) | } |
| [1674](#L1674) | //Show item after removing from cart page. |
| [1675](#L1675) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_cart\_item\_remove', 'qcld\_wb\_chatbot\_cart\_item\_remove'); |
| [1676](#L1676) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_cart\_item\_remove', 'qcld\_wb\_chatbot\_cart\_item\_remove'); |
| [1677](#L1677) | function qcld\_wb\_chatbot\_cart\_item\_remove(){ |
| [1678](#L1678) | //getting cart items n |
| [1679](#L1679) | $cart\_item\_key = sanitize\_text\_field($\_POST['cart\_item']); |
| [1680](#L1680) | global $wpcommerce; |
| [1681](#L1681) | $result = $wpcommerce->cart->remove\_cart\_item($cart\_item\_key); |
| [1682](#L1682) | wp\_send\_json($result); |
| [1683](#L1683) | } |
| [1684](#L1684) | //Show cart page by shortcode. |
| [1685](#L1685) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_cart\_page', 'qcld\_wb\_chatbot\_cart\_page'); |
| [1686](#L1686) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_cart\_page', 'qcld\_wb\_chatbot\_cart\_page'); |
| [1687](#L1687) | function qcld\_wb\_chatbot\_cart\_page(){ |
| [1688](#L1688) | global $wpcommerce; |
| [1689](#L1689) | $itemCount = $wpcommerce->cart->cart\_contents\_count; |
| [1690](#L1690) | $html = ""; |
| [1691](#L1691) | if ($itemCount < 0) { |
| [1692](#L1692) | $html .= wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_no\_cart\_items')))); |
| [1693](#L1693) | } else { |
| [1694](#L1694) | $html .= do\_shortcode("[wpcommerce\_cart]"); |
| [1695](#L1695) | } |
| [1696](#L1696) | wp\_send\_json($html); |
| [1697](#L1697) | } |
| [1698](#L1698) | //Show checkout page by shortcode. |
| [1699](#L1699) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_checkout\_page', 'qcld\_wb\_chatbot\_checkout\_page'); |
| [1700](#L1700) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_checkout\_page', 'qcld\_wb\_chatbot\_checkout\_page'); |
| [1701](#L1701) | function qcld\_wb\_chatbot\_checkout\_page(){ |
| [1702](#L1702) | global $wpcommerce; |
| [1703](#L1703) | $itemCount = $wpcommerce->cart->cart\_contents\_count; |
| [1704](#L1704) | $html = ""; |
| [1705](#L1705) | if ($itemCount < 0) { |
| [1706](#L1706) | $status = 'no'; |
| [1707](#L1707) | $html .= wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_no\_cart\_items')))); |
| [1708](#L1708) | } else { |
| [1709](#L1709) | $status = 'yes'; |
| [1710](#L1710) | $checkout\_page\_id = get\_option('wp\_chatbot\_app\_checkout'); |
| [1711](#L1711) | $checkout\_parmanlink = esc\_url(get\_permalink($checkout\_page\_id)); |
| [1712](#L1712) | $html .= $checkout\_parmanlink; |
| [1713](#L1713) | } |
| [1714](#L1714) | $response = array('status' => $status, 'html' => $html); |
| [1715](#L1715) | wp\_send\_json($response); |
| [1716](#L1716) | } |
| [1717](#L1717) | //\_dynamic\_intent |
| [1718](#L1718) | function qc\_dynamic\_intent(){ |
| [1719](#L1719) | global $wpdb; |
| [1720](#L1720) | $intents = array(); |
| [1721](#L1721) |  |
| [1722](#L1722) | $ai\_df = get\_option('enable\_wp\_chatbot\_dailogflow'); |
| [1723](#L1723) | $custom\_intent\_labels = maybe\_unserialize( get\_option('qlcd\_wp\_custon\_intent\_label')); |
| [1724](#L1724) | if($ai\_df==1 && isset($custom\_intent\_labels[0]) && trim($custom\_intent\_labels[0])!=''): |
| [1725](#L1725) |  |
| [1726](#L1726) | foreach($custom\_intent\_labels as $custom\_intent\_label): |
| [1727](#L1727) | $intents[] = $custom\_intent\_label; |
| [1728](#L1728) | endforeach; |
| [1729](#L1729) |  |
| [1730](#L1730) | endif; |
| [1731](#L1731) |  |
| [1732](#L1732) |  |
| [1733](#L1733) |  |
| [1734](#L1734) | if(class\_exists('Qcformbuilder\_Forms\_Admin')){ |
| [1735](#L1735) |  |
| [1736](#L1736) |  |
| [1737](#L1737) | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM ". $wpdb->prefix."wfb\_forms WHERE type= %s",'primary')); //DB Call OK, No Caching OK |
| [1738](#L1738) |  |
| [1739](#L1739) | if(!empty($results)){ |
| [1740](#L1740) |  |
| [1741](#L1741) | foreach($results as $result){ |
| [1742](#L1742) | $form = maybe\_unserialize($result->config); |
| [1743](#L1743) | $intents[] = $form['name']; |
| [1744](#L1744) | } |
| [1745](#L1745) |  |
| [1746](#L1746) | } |
| [1747](#L1747) | } |
| [1748](#L1748) |  |
| [1749](#L1749) | if(!empty($intents)){ |
| [1750](#L1750) | return implode(", ", $intents); |
| [1751](#L1751) | }else{ |
| [1752](#L1752) | return ''; |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | } |
| [1756](#L1756) |  |
| [1757](#L1757) | //User login on Checkout page. |
| [1758](#L1758) | // add\_action('wp\_ajax\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
| [1759](#L1759) | // add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
| [1760](#L1760) | // function qcld\_wb\_chatbot\_checkout\_user\_login(){ |
| [1761](#L1761) | //     // Nonce is checked, get the POST data and sign user on |
| [1762](#L1762) | //     $info = array(); |
| [1763](#L1763) | //     //$info['nonce'] = $\_POST['nonce\_val']; |
| [1764](#L1764) | //     $info['user\_login'] = trim(sanitize\_text\_field($\_POST['user\_name'])); |
| [1765](#L1765) | //     $info['user\_password'] = trim(sanitize\_text\_field($\_POST['user\_pass'])); |
| [1766](#L1766) | //     $info['remember'] = true; |
| [1767](#L1767) | //     $user\_signon = wp\_signon($info, false); |
| [1768](#L1768) | //     // $response=$info; |
| [1769](#L1769) | //     $response = array(); |
| [1770](#L1770) | //     if (is\_wp\_error($user\_signon)) { |
| [1771](#L1771) | //         // $response['status'] = "fail"; |
| [1772](#L1772) | //         $response = "no"; |
| [1773](#L1773) | //     } else { |
| [1774](#L1774) | //         $response = "yes"; |
| [1775](#L1775) | //     } |
| [1776](#L1776) | //     wp\_send\_json($response); |
| [1777](#L1777) | // } |
| [1778](#L1778) | // Load template for App Order Thank You page url |
| [1779](#L1779) | function wp\_chatbot\_load\_app\_template($template){ |
| [1780](#L1780) | if (is\_page('wpwbot-mobile-app')) { |
| [1781](#L1781) | return dirname(\_\_FILE\_\_) . '/templates/app-templates/app.php'; |
| [1782](#L1782) | } |
| [1783](#L1783) | return $template; |
| [1784](#L1784) | } |
| [1785](#L1785) | add\_filter('template\_include', 'wp\_chatbot\_load\_app\_template', 99); |
| [1786](#L1786) | // Load template for App Order Thank You page url |
| [1787](#L1787) | function wp\_chatbot\_load\_app\_order\_thankyou\_template($template){ |
| [1788](#L1788) | if (is\_page('wpwbot-app-order-thankyou')) { |
| [1789](#L1789) | return dirname(\_\_FILE\_\_) . '/templates/app-templates/app-order-thankyou.php'; |
| [1790](#L1790) | } |
| [1791](#L1791) | return $template; |
| [1792](#L1792) | } |
| [1793](#L1793) | add\_filter('template\_include', 'wp\_chatbot\_load\_app\_order\_thankyou\_template', 99); |
| [1794](#L1794) | // Load template for App checkout |
| [1795](#L1795) | function wp\_chatbot\_load\_app\_checkout\_template($template){ |
| [1796](#L1796) | if (is\_page('wpwbot-app-checkout')) { |
| [1797](#L1797) | return dirname(\_\_FILE\_\_) . '/templates/app-templates/app-checkout.php'; |
| [1798](#L1798) | } |
| [1799](#L1799) | return $template; |
| [1800](#L1800) | } |
| [1801](#L1801) | add\_filter('template\_include', 'wp\_chatbot\_load\_app\_checkout\_template', 99); |
| [1802](#L1802) | // Create embed page when plugin install or activate |
| [1803](#L1803) | //register\_activation\_hook(\_\_FILE\_\_, 'wp\_chatbot\_create\_app\_order\_thankyou\_page'); |
| [1804](#L1804) | add\_action('init', 'wp\_chatbot\_create\_app\_checkout\_thankyou\_page'); |
| [1805](#L1805) | function wp\_chatbot\_create\_app\_checkout\_thankyou\_page(){ |
| [1806](#L1806) | if (get\_option('wp\_chatbot\_app\_pages') == 1) { |
| [1807](#L1807) | //Mobile App page create |
| [1808](#L1808) | if (get\_page\_by\_title('wpwBot Mobile App') == NULL) { |
| [1809](#L1809) | //post status and options |
| [1810](#L1810) | $app\_page = array( |
| [1811](#L1811) | 'comment\_status' => 'closed', |
| [1812](#L1812) | 'ping\_status' => 'closed', |
| [1813](#L1813) | 'post\_author' => get\_current\_user\_id(), |
| [1814](#L1814) | 'post\_date' => date('Y-m-d H:i:s'), |
| [1815](#L1815) | 'post\_status' => 'publish', |
| [1816](#L1816) | 'post\_title' => 'wpwBot Mobile App', |
| [1817](#L1817) | 'post\_name' => 'wpwbot-mobile-app', |
| [1818](#L1818) | 'post\_type' => 'page', |
| [1819](#L1819) | ); |
| [1820](#L1820) | //insert page and save the id |
| [1821](#L1821) | $wpwbot\_app = wp\_insert\_post($app\_page, false); |
| [1822](#L1822) | //save the id in the database |
| [1823](#L1823) | update\_option('wp\_chatbot\_app\_checkout', $wpwbot\_app); |
| [1824](#L1824) | } |
| [1825](#L1825) | //App checkout page create |
| [1826](#L1826) | if (get\_page\_by\_title('wpwBot App Checkout') == NULL) { |
| [1827](#L1827) | //post status and options |
| [1828](#L1828) | $checkout\_page = array( |
| [1829](#L1829) | 'comment\_status' => 'closed', |
| [1830](#L1830) | 'ping\_status' => 'closed', |
| [1831](#L1831) | 'post\_author' => get\_current\_user\_id(), |
| [1832](#L1832) | 'post\_date' => date('Y-m-d H:i:s'), |
| [1833](#L1833) | 'post\_status' => 'publish', |
| [1834](#L1834) | 'post\_title' => 'wpwBot App Checkout', |
| [1835](#L1835) | 'post\_name' => 'wpwbot-app-checkout', |
| [1836](#L1836) | 'post\_type' => 'page', |
| [1837](#L1837) | ); |
| [1838](#L1838) | //insert page and save the id |
| [1839](#L1839) | $app\_checkout = wp\_insert\_post($checkout\_page, false); |
| [1840](#L1840) | //save the id in the database |
| [1841](#L1841) | update\_option('wp\_chatbot\_app\_checkout', $app\_checkout); |
| [1842](#L1842) | } |
| [1843](#L1843) | //App Order thank you page create |
| [1844](#L1844) | if (get\_page\_by\_title('wpwBot App Order Thank You') == NULL) { |
| [1845](#L1845) | //post status and options |
| [1846](#L1846) | $thankyou\_page = array( |
| [1847](#L1847) | 'comment\_status' => 'closed', |
| [1848](#L1848) | 'ping\_status' => 'closed', |
| [1849](#L1849) | 'post\_author' => get\_current\_user\_id(), |
| [1850](#L1850) | 'post\_date' => date('Y-m-d H:i:s'), |
| [1851](#L1851) | 'post\_status' => 'publish', |
| [1852](#L1852) | 'post\_title' => 'wpwBot App Order Thank You', |
| [1853](#L1853) | 'post\_name' => 'wpwbot-app-order-thankyou', |
| [1854](#L1854) | 'post\_type' => 'page', |
| [1855](#L1855) | ); |
| [1856](#L1856) | //insert page and save the id |
| [1857](#L1857) | $app\_order\_thankyou = wp\_insert\_post($thankyou\_page, false); |
| [1858](#L1858) | //save the id in the database |
| [1859](#L1859) | update\_option('wp\_chatbot\_app\_order\_thankyou', $app\_order\_thankyou); |
| [1860](#L1860) | } |
| [1861](#L1861) | } |
| [1862](#L1862) | //Keep tracking from App by cookies |
| [1863](#L1863) | if (isset($\_GET['from']) && $\_GET['from'] == 'app') { |
| [1864](#L1864) | if (!isset($\_COOKIE['from\_app'])) { |
| [1865](#L1865) | setcookie('from\_app', 'yes', (time() + 3600), '/'); |
| [1866](#L1866) | } |
| [1867](#L1867) | } |
| [1868](#L1868) | } |
| [1869](#L1869) | /\*\*\* |
| [1870](#L1870) | \* Override order Thank page for mobile app |
| [1871](#L1871) | \*/ |
| [1872](#L1872) | add\_action('wpcommerce\_thankyou', 'qcld\_wb\_chatbot\_\_redirect\_after\_purchase', 10, 1); |
| [1873](#L1873) | function qcld\_wb\_chatbot\_\_redirect\_after\_purchase($order\_get\_id){ |
| [1874](#L1874) | if (isset($\_COOKIE['from\_app']) && $\_COOKIE['from\_app'] == 'yes') { |
| [1875](#L1875) | global $wp; |
| [1876](#L1876) | if (is\_checkout() && !empty($wp->query\_vars['order-received'])) { |
| [1877](#L1877) | $thanks\_page\_id = get\_option('wp\_chatbot\_app\_order\_thankyou'); |
| [1878](#L1878) | $thanks\_parmanlink = esc\_url(get\_permalink($thanks\_page\_id)); |
| [1879](#L1879) | wp\_redirect($thanks\_parmanlink . '?order\_id=' . $order\_get\_id); |
| [1880](#L1880) | exit; |
| [1881](#L1881) | } |
| [1882](#L1882) | } else { |
| [1883](#L1883) | remove\_action('wpcommerce\_thankyou', 'qcld\_wb\_chatbot\_\_redirect\_after\_purchase'); |
| [1884](#L1884) | do\_action('wpcommerce\_thankyou', $order\_get\_id); |
| [1885](#L1885) | } |
| [1886](#L1886) | } |
| [1887](#L1887) |  |
| [1888](#L1888) | function qcld\_choose\_random($array){ |
| [1889](#L1889) | return $array[array\_rand($array)]; |
| [1890](#L1890) | } |
| [1891](#L1891) |  |
| [1892](#L1892) | //User session count |
| [1893](#L1893) | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_session\_count', 'qcld\_wb\_chatbot\_session\_count'); |
| [1894](#L1894) | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_session\_count', 'qcld\_wb\_chatbot\_session\_count'); |
| [1895](#L1895) | function qcld\_wb\_chatbot\_session\_count(){ |
| [1896](#L1896) | // Nonce is checked, get the POST data and sign user on |
| [1897](#L1897) | global $wpdb; |
| [1898](#L1898) | $wpdb->show\_errors = true; |
| [1899](#L1899) | $tableuser    = $wpdb->prefix.'wpbot\_sessions'; |
| [1900](#L1900) | $response = array(); |
| [1901](#L1901) |  |
| [1902](#L1902) |  |
| [1903](#L1903) | $session\_exists = $wpdb->get\_row($wpdb->prepare("select \* from $tableuser where 1 and id = %d",1)); //DB Call OK, No Caching OK |
| [1904](#L1904) |  |
| [1905](#L1905) | if(empty($session\_exists)){ |
| [1906](#L1906) | $wpdb->insert( |
| [1907](#L1907) | $tableuser, |
| [1908](#L1908) | array( |
| [1909](#L1909) | 'session'   => 1, |
| [1910](#L1910) | ) |
| [1911](#L1911) | ); //DB Call OK, No Caching OK |
| [1912](#L1912) | }else{ |
| [1913](#L1913) |  |
| [1914](#L1914) | $session\_id = $session\_exists->id; |
| [1915](#L1915) |  |
| [1916](#L1916) | $wpdb->update( |
| [1917](#L1917) | $tableuser, |
| [1918](#L1918) | array( |
| [1919](#L1919) | 'session'=>($session\_exists->session+1), |
| [1920](#L1920) | ), |
| [1921](#L1921) | array('id'=>$session\_id), |
| [1922](#L1922) | array( |
| [1923](#L1923) | '%d', |
| [1924](#L1924) | ), |
| [1925](#L1925) | array('%d') |
| [1926](#L1926) | ); //DB Call OK, No Caching OK |
| [1927](#L1927) |  |
| [1928](#L1928) | } |
| [1929](#L1929) |  |
| [1930](#L1930) | wp\_send\_json($response); |
| [1931](#L1931) | } |
| [1932](#L1932) |  |
| [1933](#L1933) | /\* WPBot Chat History Addon check \*/ |
| [1934](#L1934) | function qcld\_wpbot\_is\_active\_chat\_history(){ |
| [1935](#L1935) |  |
| [1936](#L1936) | if(function\_exists('qcwp\_chat\_session\_menu\_fnc')  || function\_exists( 'qcpdcs\_chat\_session\_menu\_fnc' ) ){ |
| [1937](#L1937) | return 1; |
| [1938](#L1938) | }else{ |
| [1939](#L1939) | return 0; |
| [1940](#L1940) | } |
| [1941](#L1941) |  |
| [1942](#L1942) | } |
| [1943](#L1943) |  |
| [1944](#L1944) | function qc\_wpbot\_input\_validation( $data ) { |
| [1945](#L1945) | $data = html\_entity\_decode($data); |
| [1946](#L1946) | $data = trim($data); |
| [1947](#L1947) | $data = stripslashes($data); |
| [1948](#L1948) | $data = htmlspecialchars($data); |
| [1949](#L1949) | return $data; |
| [1950](#L1950) | } |
| [1951](#L1951) | add\_action('wp\_ajax\_small\_talk\_import', 'small\_talk\_import'); |
| [1952](#L1952) | function small\_talk\_import(){ |
| [1953](#L1953) |  |
| [1954](#L1954) | global $wpdb; |
| [1955](#L1955) |  |
| [1956](#L1956) | $table = $wpdb->prefix.'wpbot\_response'; |
| [1957](#L1957) |  |
| [1958](#L1958) | $csvFile = file(QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . 'small\_talk.csv'); |
| [1959](#L1959) |  |
| [1960](#L1960) | foreach ($csvFile as $line) { |
| [1961](#L1961) | $line = str\_getcsv($line, ',', '"'); |
| [1962](#L1962) | $wpdb->insert($table, array( |
| [1963](#L1963) | 'query' => $line[0], |
| [1964](#L1964) | 'keyword' => $line[1], |
| [1965](#L1965) | 'response' => $line[2], |
| [1966](#L1966) | 'category'=> $line[3], |
| [1967](#L1967) | 'intent'=> '', |
| [1968](#L1968) | //'lang'=> 'en\_US', |
| [1969](#L1969) | )); //DB Call OK, No Caching OK |
| [1970](#L1970) | } |
| [1971](#L1971) |  |
| [1972](#L1972) | $table2 = $wpdb->prefix.'wpbot\_response\_category'; |
| [1973](#L1973) |  |
| [1974](#L1974) | $wpdb->insert($table2, array( |
| [1975](#L1975) | 'name' => 'smalltalk', |
| [1976](#L1976) | )); //DB Call OK, No Caching OK |
| [1977](#L1977) |  |
| [1978](#L1978) | update\_option( 'qcld\_small\_talk\_imported', 'yes' ); |
| [1979](#L1979) |  |
| [1980](#L1980) | } |
| [1981](#L1981) | function sanitize\_array( &$array ) { |
| [1982](#L1982) | if (!empty($array)) { |
| [1983](#L1983) | foreach ($array as &$value) { |
| [1984](#L1984) | if( !is\_array($value) ) |
| [1985](#L1985) | // sanitize if value is not an array |
| [1986](#L1986) | $value = sanitize\_text\_field( esc\_html($value) ); |
| [1987](#L1987) | else |
| [1988](#L1988) | // go inside this function again |
| [1989](#L1989) | sanitize\_array(esc\_html($value)); |
| [1990](#L1990) | } |
| [1991](#L1991) | } |
| [1992](#L1992) | return $array; |
| [1993](#L1993) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/chatbot/trunk/functions.php?format=txt)
* [Original Format](/export/3222471/chatbot/trunk/functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_237d040a_20250114_204632.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# AI ChatBot <= 4.8.9 - Unauthenticated Sensitive Information Exposure via qcld\_wb\_chatbot\_check\_user

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   AI ChatBot <= 4.8.9 - Unauthenticated Sensitive Information Exposure via qcld\_wb\_chatbot\_check\_user

5.3

**Exposure of Sensitive Information to an Unauthorized Actor**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N)

| CVE | [CVE-2023-5254](https://www.cve.org/CVERecord?id=CVE-2023-5254) |
| --- | --- |
| CVSS | 5.3 (Medium) |
| Publicly Published | October 11, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The ChatBot plugin for WordPress is vulnerable to Sensitive Information Exposure in versions up to, and including, 4.8.9 via the qcld\_wb\_chatbot\_check\_user function. This can allow unauthenticated attackers to extract sensitive data including confirmation as to whether a user name exists on the site as well as order information for existing users.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/chatbot/trunk/functions.php#L1224)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=2977505%40chatbot%2Ftrunk&old=2967435%40chatbot%2Ftrunk&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fchatbot%2Fchatbot-489-unauthenticated-sensitive-information-exposure-via-qcld-wb-chatbot-check-user&t=AI%20ChatBot%20%3C%3D%204.8.9%20-%20Unauthenticated%20Sensitive%20Information%20Exposure%20via%20qcld_wb_chatbot_check_user "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fchatbot%2Fchatbot-489-unauthenticated-sensitive-information-exposure-via-qcld-wb-chatbot-check-user&text=AI%20ChatBot%20%3C%3D%204.8.9%20-%20Unauthenticated%20Sensitive%20Information%20Exposure%20via%20qcld_wb_chatbot_check_user "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fchatbot%2Fchatbot-489-unauthenticated-sensitive-information-exposure-via-qcld-wb-chatbot-check-user "LinkedIn")
Email

## Vulnerability Details for AI ChatBot for WordPress – WPBot

#### [AI ChatBot for WordPress – WPBot](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/chatbot)

| Software Type | Plugin |
| --- | --- |
| Software Slug | chatbot [(view on wordpress.org)](https://wordpress.org/plugins/chatbot) |
| Patched? | Yes |
| Remediation | Update to version 4.9.1, or a newer patched version |
| Affected Version | * <= 4.8.9 |
| Patched Version | * 4.9.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


