=== Content from security.gentoo.org_897e22ca_20250114_222136.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# Mozilla Firefox: Multiple Vulnerabilities — GLSA **202401-10**

Multiple vulnerabilities have been found in Mozilla Firefox, the worst of which could lead to remote code execution.

### Affected packages

| Package | **www-client/firefox** on all architectures |
| --- | --- |
| Affected versions | < **121.0**< **115.6.0** |
| Unaffected versions | >= **121.0**>= **115.6.0** |

| Package | **www-client/firefox-bin** on all architectures |
| --- | --- |
| Affected versions | < **121.0**< **115.6.0** |
| Unaffected versions | >= **121.0**>= **115.6.0** |

### Background

Mozilla Firefox is a popular open-source web browser from the Mozilla project.

### Description

Multiple vulnerabilities have been discovered in Mozilla Firefox. Please review the CVE identifiers referenced below for details.

### Impact

Please review the referenced CVE identifiers for details.

### Workaround

There is no known workaround at this time.

### Resolution

All Mozilla Firefox ESR binary users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-bin-115.6.0:esr"

```

All Mozilla Firefox ESR users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-115.6.0:esr"

```

All Mozilla Firefox binary users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-bin-121.0:rapid"

```

All Mozilla Firefox users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-121.0:rapid"

```
### References

* [CVE-2023-3482](https://nvd.nist.gov/vuln/detail/CVE-2023-3482)
* [CVE-2023-4058](https://nvd.nist.gov/vuln/detail/CVE-2023-4058)
* [CVE-2023-4579](https://nvd.nist.gov/vuln/detail/CVE-2023-4579)
* [CVE-2023-4863](https://nvd.nist.gov/vuln/detail/CVE-2023-4863)
* [CVE-2023-5129](https://nvd.nist.gov/vuln/detail/CVE-2023-5129)
* [CVE-2023-5170](https://nvd.nist.gov/vuln/detail/CVE-2023-5170)
* [CVE-2023-5172](https://nvd.nist.gov/vuln/detail/CVE-2023-5172)
* [CVE-2023-5173](https://nvd.nist.gov/vuln/detail/CVE-2023-5173)
* [CVE-2023-5175](https://nvd.nist.gov/vuln/detail/CVE-2023-5175)
* [CVE-2023-5722](https://nvd.nist.gov/vuln/detail/CVE-2023-5722)
* [CVE-2023-5723](https://nvd.nist.gov/vuln/detail/CVE-2023-5723)
* [CVE-2023-5729](https://nvd.nist.gov/vuln/detail/CVE-2023-5729)
* [CVE-2023-5731](https://nvd.nist.gov/vuln/detail/CVE-2023-5731)
* [CVE-2023-5758](https://nvd.nist.gov/vuln/detail/CVE-2023-5758)
* [CVE-2023-6135](https://nvd.nist.gov/vuln/detail/CVE-2023-6135)
* [CVE-2023-6210](https://nvd.nist.gov/vuln/detail/CVE-2023-6210)
* [CVE-2023-6211](https://nvd.nist.gov/vuln/detail/CVE-2023-6211)
* [CVE-2023-6213](https://nvd.nist.gov/vuln/detail/CVE-2023-6213)
* [CVE-2023-6856](https://nvd.nist.gov/vuln/detail/CVE-2023-6856)
* [CVE-2023-6857](https://nvd.nist.gov/vuln/detail/CVE-2023-6857)
* [CVE-2023-6858](https://nvd.nist.gov/vuln/detail/CVE-2023-6858)
* [CVE-2023-6859](https://nvd.nist.gov/vuln/detail/CVE-2023-6859)
* [CVE-2023-6860](https://nvd.nist.gov/vuln/detail/CVE-2023-6860)
* [CVE-2023-6861](https://nvd.nist.gov/vuln/detail/CVE-2023-6861)
* [CVE-2023-6862](https://nvd.nist.gov/vuln/detail/CVE-2023-6862)
* [CVE-2023-6863](https://nvd.nist.gov/vuln/detail/CVE-2023-6863)
* [CVE-2023-6864](https://nvd.nist.gov/vuln/detail/CVE-2023-6864)
* [CVE-2023-6865](https://nvd.nist.gov/vuln/detail/CVE-2023-6865)
* [CVE-2023-6866](https://nvd.nist.gov/vuln/detail/CVE-2023-6866)
* [CVE-2023-6867](https://nvd.nist.gov/vuln/detail/CVE-2023-6867)
* [CVE-2023-6868](https://nvd.nist.gov/vuln/detail/CVE-2023-6868)
* [CVE-2023-6869](https://nvd.nist.gov/vuln/detail/CVE-2023-6869)
* [CVE-2023-6870](https://nvd.nist.gov/vuln/detail/CVE-2023-6870)
* [CVE-2023-6871](https://nvd.nist.gov/vuln/detail/CVE-2023-6871)
* [CVE-2023-6872](https://nvd.nist.gov/vuln/detail/CVE-2023-6872)
* [CVE-2023-6873](https://nvd.nist.gov/vuln/detail/CVE-2023-6873)
* [CVE-2023-32205](https://nvd.nist.gov/vuln/detail/CVE-2023-32205)
* [CVE-2023-32206](https://nvd.nist.gov/vuln/detail/CVE-2023-32206)
* [CVE-2023-32207](https://nvd.nist.gov/vuln/detail/CVE-2023-32207)
* [CVE-2023-32208](https://nvd.nist.gov/vuln/detail/CVE-2023-32208)
* [CVE-2023-32209](https://nvd.nist.gov/vuln/detail/CVE-2023-32209)
* [CVE-2023-32210](https://nvd.nist.gov/vuln/detail/CVE-2023-32210)
* [CVE-2023-32211](https://nvd.nist.gov/vuln/detail/CVE-2023-32211)
* [CVE-2023-32212](https://nvd.nist.gov/vuln/detail/CVE-2023-32212)
* [CVE-2023-32213](https://nvd.nist.gov/vuln/detail/CVE-2023-32213)
* [CVE-2023-32214](https://nvd.nist.gov/vuln/detail/CVE-2023-32214)
* [CVE-2023-32215](https://nvd.nist.gov/vuln/detail/CVE-2023-32215)
* [CVE-2023-32216](https://nvd.nist.gov/vuln/detail/CVE-2023-32216)
* [CVE-2023-34414](https://nvd.nist.gov/vuln/detail/CVE-2023-34414)
* [CVE-2023-34415](https://nvd.nist.gov/vuln/detail/CVE-2023-34415)
* [CVE-2023-34416](https://nvd.nist.gov/vuln/detail/CVE-2023-34416)
* [CVE-2023-34417](https://nvd.nist.gov/vuln/detail/CVE-2023-34417)
* [CVE-2023-37203](https://nvd.nist.gov/vuln/detail/CVE-2023-37203)
* [CVE-2023-37204](https://nvd.nist.gov/vuln/detail/CVE-2023-37204)
* [CVE-2023-37205](https://nvd.nist.gov/vuln/detail/CVE-2023-37205)
* [CVE-2023-37206](https://nvd.nist.gov/vuln/detail/CVE-2023-37206)
* [CVE-2023-37209](https://nvd.nist.gov/vuln/detail/CVE-2023-37209)
* [CVE-2023-37210](https://nvd.nist.gov/vuln/detail/CVE-2023-37210)
* [CVE-2023-37212](https://nvd.nist.gov/vuln/detail/CVE-2023-37212)
* MFSA-2023-40
* MFSA-TMP-2023-0002

**Release date**

January 07, 2024

**Latest revision**

January 07, 2024: 1

**Severity**

high

**Exploitable**

remote

**Bugzilla entries**

* [908245](https://bugs.gentoo.org/show_bug.cgi?id=908245)
* [914073](https://bugs.gentoo.org/show_bug.cgi?id=914073)
* [918433](https://bugs.gentoo.org/show_bug.cgi?id=918433)
* [920507](https://bugs.gentoo.org/show_bug.cgi?id=920507)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from www.mozilla.org_f0f8a38e_20250114_222137.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2023-41

## Security Vulnerabilities fixed in Firefox 118

Announced
September 26, 2023
Impact
high
Products
Firefox
Fixed in

* Firefox 118

#### [#CVE-2023-5168: Out-of-bounds write in FilterNodeD2D1](#CVE-2023-5168)

Reporter
sonakkbi
Impact
high
##### Description

A compromised content process could have provided malicious data to `FilterNodeD2D1` resulting in an out-of-bounds write, leading to a potentially exploitable crash in a privileged process.
*This bug only affects Firefox on Windows. Other operating systems are unaffected.*

##### References

* [Bug 1846683](https://bugzilla.mozilla.org/show_bug.cgi?id=1846683)

#### [#CVE-2023-5169: Out-of-bounds write in PathOps](#CVE-2023-5169)

Reporter
sonakkbi
Impact
high
##### Description

A compromised content process could have provided malicious data in a `PathRecording` resulting in an out-of-bounds write, leading to a potentially exploitable crash in a privileged process.

##### References

* [Bug 1846685](https://bugzilla.mozilla.org/show_bug.cgi?id=1846685)

#### [#CVE-2023-5170: Memory leak from a privileged process](#CVE-2023-5170)

Reporter
sonakkbi
Impact
high
##### Description

In canvas rendering, a compromised content process could have caused a surface to change unexpectedly, leading to a memory leak of a privileged process. This memory leak could be used to effect a sandbox escape if the correct data was leaked.

##### References

* [Bug 1846686](https://bugzilla.mozilla.org/show_bug.cgi?id=1846686)

#### [#CVE-2023-5171: Use-after-free in Ion Compiler](#CVE-2023-5171)

Reporter
Lukas Bernhard
Impact
high
##### Description

During Ion compilation, a Garbage Collection could have resulted in a use-after-free condition, allowing an attacker to write two NUL bytes, and cause a potentially exploitable crash.

##### References

* [Bug 1851599](https://bugzilla.mozilla.org/show_bug.cgi?id=1851599)

#### [#CVE-2023-5172: Memory Corruption in Ion Hints](#CVE-2023-5172)

Reporter
Mozilla Fuzzing Team
Impact
high
##### Description

A hashtable in the Ion Engine could have been mutated while there was a live interior reference, leading to a potential use-after-free and exploitable crash.

##### References

* [Bug 1852218](https://bugzilla.mozilla.org/show_bug.cgi?id=1852218)

#### [#CVE-2023-5173: Out-of-bounds write in HTTP Alternate Services](#CVE-2023-5173)

Reporter
Ronald Crane
Impact
moderate
##### Description

In a non-standard configuration of Firefox, an integer overflow could have occurred based on network traffic (possibly under influence of a local unprivileged webpage), leading to an out-of-bounds write to privileged process memory.
*This bug only affects Firefox if a non-standard preference allowing non-HTTPS Alternate Services (`network.http.altsvc.oe`) is enabled.*

##### References

* [Bug 1823172](https://bugzilla.mozilla.org/show_bug.cgi?id=1823172)

#### [#CVE-2023-5174: Double-free in process spawning on Windows](#CVE-2023-5174)

Reporter
Ronald Crane
Impact
moderate
##### Description

If Windows failed to duplicate a handle during process creation, the sandbox code may have inadvertently freed a pointer twice, resulting in a use-after-free and a potentially exploitable crash.
*This bug only affects Firefox on Windows when run in non-standard configurations (such as using `runas`). Other operating systems are unaffected.*

##### References

* [Bug 1848454](https://bugzilla.mozilla.org/show_bug.cgi?id=1848454)

#### [#CVE-2023-5175: Use-after-free of ImageBitmap during process shutdown](#CVE-2023-5175)

Reporter
Yangkang of 360 ATA Team
Impact
low
##### Description

During process shutdown, it was possible that an `ImageBitmap` was created that would later be used after being freed from a different codepath, leading to a potentially exploitable crash.

##### References

* [Bug 1849704](https://bugzilla.mozilla.org/show_bug.cgi?id=1849704)

#### [#CVE-2023-5176: Memory safety bugs fixed in Firefox 118, Firefox ESR 115.3, and Thunderbird 115.3](#CVE-2023-5176)

Reporter
Chris Peterson, Andrew McCreight, André Bargull, Nika Layzell and the Mozilla Fuzzing Team
Impact
high
##### Description

Memory safety bugs present in Firefox 117, Firefox ESR 115.2, and Thunderbird 115.2. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 118, Firefox ESR 115.3, and Thunderbird 115.3](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1836353%2C1842674%2C1843824%2C1843962%2C1848890%2C1850180%2C1850983%2C1851195)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_7de2c4a7_20250114_222135.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1849704)
* [XML](/show_bug.cgi?ctype=xml&id=1849704)

Closed
[Bug 1849704](/show_bug.cgi?id=1849704)
(CVE-2023-5175)

Opened 1 year ago
Closed 1 year ago

# heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver

## Categories

### (Core :: Graphics: Canvas2D, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics%3A%20Canvas2D#Graphics%3A%20Canvas2D)

Graphics: Canvas2D
▾

Core :: Graphics: Canvas2D
Bugs with the HTML5 [<canvas>](http://whatwg.org/specs/web-apps/current-work/#dynamic) element, its XUL sibling, and related rendering contexts.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Canvas2D&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Canvas2D&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics%3A%20Canvas2D)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

118 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |
| Performance Impact | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected) |
| firefox-esr115 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=unaffected) |
| firefox116 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=unaffected) |
| firefox117 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=wontfix) |
| firefox118 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | unaffected |
| firefox-esr115 | --- | unaffected |
| firefox-esr128 | --- | --- |
| firefox116 |  | unaffected |
| firefox117 |  | wontfix |
| firefox118 |  | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: m.cooolie, Assigned: tnikkel)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/0646a42110a02dd585f200f270716852?d=mm&size=40)  [tnikkel](/user_profile?user_id=255010)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/a2afc3e713a960c7119ae73ca1cd5e8e?d=mm&size=40)  [m.cooolie](/user_profile?user_id=689709)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/029a38b9773f1943419c24b7c3d93761?d=mm&size=40)  [lsalzman](/user_profile?user_id=536714)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

6 people

## References

### (Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[1839286](/show_bug.cgi?id=1839286 "RESOLVED FIXED - ImageBitmap can create a lot shutdown observers, which are managed by an array")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [reporter-external] [client-bounty-form] [verif?][adv-main118+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-5175

[Keywords:](/describekeywords.cgi)

[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[reporter-external] [client-bounty-form] [verif?][adv-main118+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a632304_1689 "1 year ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files)

| [poc.html](/attachment.cgi?id=9349853)  [1 year ago](#c0)  [m.cooolie](/user_profile?user_id=689709)   909 bytes, text/html |  | [Details](/attachment.cgi?id=9349853&action=edit) |
| --- | --- | --- |
| [ff.test2.js](/attachment.cgi?id=9349854)  [1 year ago](#c1)  [m.cooolie](/user_profile?user_id=689709)   11.25 KB, text/javascript |  | [Details](/attachment.cgi?id=9349854&action=edit) |
| [Bug 1849704. Don't create a new ImageBitmapShutdownObserver if we are in XPCOMShutdown or later. r?#gfx-reviewers](/attachment.cgi?id=9350277)  [1 year ago](#c12)  [Timothy Nikkel (:tnikkel)](/user_profile?user_id=255010)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9350277&action=edit) | [Review](/attachment.cgi?id=9350277) |
| [advisory.txt](/attachment.cgi?id=9354366)  [1 year ago](#c19)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   282 bytes, text/plain |  | [Details](/attachment.cgi?id=9354366&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1849704#c0)• 1 year ago |
|  | |

Attached file
[poc.html](attachment.cgi?id=9349853)
— [Details](attachment.cgi?id=9349853&action=edit)

#Summary

heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove

#Reproduce

OS:Win10 X64

118.0a1 (2023-08-21) (64-bit)

step:

1. install node & puppeteer-core (for easy reproduce)
2. python -m http.server 1337
3. node ff.test2.js test <http://localhost:1337/poc.html> 30 firefox.exe\_path

#Type of crash

Tab process

#Analysis

coming soon

# #ASAN

==14772==ERROR: AddressSanitizer: heap-use-after-free on address 0x119d234cc1d8 at pc 0x7ffafd5d922e bp 0x008a8fdfe1d0 sp 0x008a8fdfe218

READ of size 4 at 0x119d234cc1d8 thread T0

#0 0x7ffafd5d922d in PLDHashTable::Remove /builds/worker/checkouts/gecko/xpcom/ds/PLDHashTable.cpp:546

#1 0x7ffb034f2b86 in mozilla::dom::ImageBitmap::~ImageBitmap /builds/worker/checkouts/gecko/dom/canvas/ImageBitmap.cpp:665

#2 0x7ffb0353152f in mozilla::dom::ImageBitmap::cycleCollection::DeleteCycleCollectable /builds/worker/workspace/obj-build/dist/include/mozilla/dom/ImageBitmap.h:85

#3 0x7ffafd552f86 in SnowWhiteKiller::~SnowWhiteKiller /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:2473

#4 0x7ffafd55185e in nsCycleCollector::FreeSnowWhite /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:2663

#5 0x7ffafd55d195 in nsCycleCollector::BeginCollection /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3660

#6 0x7ffafd55c16f in nsCycleCollector::Collect /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3484

#7 0x7ffafd55b9e0 in nsCycleCollector::ShutdownCollect /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:3418

#8 0x7ffafd561ffc in nsCycleCollector\_shutdown /builds/worker/checkouts/gecko/xpcom/base/nsCycleCollector.cpp:4046

#9 0x7ffafd82f6d0 in mozilla::ShutdownXPCOM /builds/worker/checkouts/gecko/xpcom/build/XPCOMInit.cpp:693

#10 0x7ffb0c0cf54a in XRE\_InitChildProcess /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:661

#11 0x7ff6e0c92953 in NS\_internal\_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:375

#12 0x7ff6e0c9169b in wmain /builds/worker/checkouts/gecko/toolkit/xre/nsWindowsWMain.cpp:167

#13 0x7ff6e0d734e7 in \_\_scrt\_common\_main\_seh D:\a\_work\1\s\src\vctools\crt\vcstartup\src\startup\exe\_common.inl:288

#14 0x7ffbb0d17613 in BaseThreadInitThunk+0x13 (C:\WINDOWS\System32\KERNEL32.DLL+0x180017613)

#15 0x7ffbb0fe26b0 in RtlUserThreadStart+0x20 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x1800526b0)

0x119d234cc1d8 is located 56 bytes inside of 64-byte region [0x119d234cc1a0,0x119d234cc1e0)

freed by thread T0 here:

#0 0x7ffb5fd4f28d in free /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan\_malloc\_win.cpp:82

#1 0x7ffb034f3042 in mozilla::dom::ImageBitmapShutdownObserver::Release /builds/worker/checkouts/gecko/dom/canvas/ImageBitmap.cpp:137

#2 0x7ffafd629fe5 in nsTHashtable<nsObserverList>::s\_ClearEntry /builds/worker/workspace/obj-build/dist/include/nsTHashtable.h:720

#3 0x7ffafd5d600c in PLDHashTable::~PLDHashTable /builds/worker/checkouts/gecko/xpcom/ds/PLDHashTable.cpp:293

#4 0x7ffafd5d6290 in PLDHashTable::Clear /builds/worker/checkouts/gecko/xpcom/ds/PLDHashTable.cpp:312

#5 0x7ffafd82f49a in mozilla::ShutdownXPCOM /builds/worker/checkouts/gecko/xpcom/build/XPCOMInit.cpp:633

#6 0x7ffb0c0cf54a in XRE\_InitChildProcess /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:661

#7 0x7ff6e0c92953 in NS\_internal\_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:375

#8 0x7ff6e0c9169b in wmain /builds/worker/checkouts/gecko/toolkit/xre/nsWindowsWMain.cpp:167

#9 0x7ff6e0d734e7 in \_\_scrt\_common\_main\_seh D:\a\_work\1\s\src\vctools\crt\vcstartup\src\startup\exe\_common.inl:288

#10 0x7ffbb0d17613 in BaseThreadInitThunk+0x13 (C:\WINDOWS\System32\KERNEL32.DLL+0x180017613)

#11 0x7ffbb0fe26b0 in RtlUserThreadStart+0x20 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x1800526b0)

previously allocated by thread T22 here:

#0 0x7ffb5fd4f39d in malloc /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan\_malloc\_win.cpp:98

#1 0x7ffb6dfa11ad in moz\_xmalloc /builds/worker/checkouts/gecko/memory/mozalloc/mozalloc.cpp:52

#2 0x7ffb034f3a45 in mozilla::dom::ImageBitmap::ImageBitmap /builds/worker/checkouts/gecko/dom/canvas/ImageBitmap.cpp:651

#3 0x7ffb034f6d57 in mozilla::dom::ImageBitmap::CreateFromOffscreenCanvas /builds/worker/checkouts/gecko/dom/canvas/ImageBitmap.cpp:949

#4 0x7ffb03517068 in mozilla::dom::OffscreenCanvas::TransferToImageBitmap /builds/worker/checkouts/gecko/dom/canvas/OffscreenCanvas.cpp:346

#5 0x7ffb0174bf77 in mozilla::dom::OffscreenCanvas\_Binding::transferToImageBitmap /builds/worker/workspace/obj-build/dom/bindings/OffscreenCanvasBinding.cpp:1171

#6 0x7ffb03208582 in mozilla::dom::binding\_detail::GenericMethod<mozilla::dom::binding\_detail::NormalThisPolicy,mozilla::dom::binding\_detail::ThrowExceptions> /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3327

#7 0x2fffc814c4 (<unknown module>)

Thread T22 created by T0 here:

#0 0x7ffb5fd5ce72 in \_\_asan\_wrap\_CreateThread /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan\_win.cpp:146

#1 0x7ffbae991896 in beginthreadex+0x56 (C:\WINDOWS\System32\ucrtbase.dll+0x180021896)

#2 0x7ffb5d4092f2 in \_PR\_MD\_CREATE\_THREAD /builds/worker/checkouts/gecko/nsprpub/pr/src/md/windows/w95thred.c:153

#3 0x7ffb5d43173e in \_PR\_NativeCreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1058

#4 0x7ffb5d431f42 in \_PR\_CreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1184

#5 0x7ffb5d427e2f in PR\_CreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1404

#6 0x7ffafd78ff5f in nsThread::Init /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:634

#7 0x7ffb06a27026 in mozilla::dom::WorkerThread::Create /builds/worker/checkouts/gecko/dom/workers/WorkerThread.cpp:101

#8 0x7ffb06990c43 in mozilla::dom::workerinternals::RuntimeService::ScheduleWorker /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:1313

#9 0x7ffb0698eb31 in mozilla::dom::workerinternals::RuntimeService::RegisterWorker /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:1195

#10 0x7ffb069e9d84 in mozilla::dom::WorkerPrivate::Constructor /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:2684

#11 0x7ffb069ad485 in mozilla::dom::Worker::Constructor /builds/worker/checkouts/gecko/dom/workers/Worker.cpp:50

#12 0x7ffb0273b1d9 in mozilla::dom::Worker\_Binding::\_constructor /builds/worker/workspace/obj-build/dom/bindings/WorkerBinding.cpp:1158

#13 0x7ffb0dfadb87 in InternalConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:727

#14 0x7ffb0dfc89ee in js::Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3380

#15 0x7ffb0dfa9803 in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:458

#16 0x7ffb0dfaf1b5 in js::ExecuteKernel /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:845

#17 0x7ffb0dfaf611 in js::Execute /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:877

#18 0x7ffb0c53a5bd in ExecuteScript /builds/worker/checkouts/gecko/js/src/vm/CompilationAndEvaluation.cpp:494

#19 0x7ffb0c53a94f in JS\_ExecuteScript /builds/worker/checkouts/gecko/js/src/vm/CompilationAndEvaluation.cpp:518

#20 0x7ffb00c821a7 in mozilla::dom::JSExecutionContext::ExecScript /builds/worker/checkouts/gecko/dom/base/JSExecutionContext.cpp:241

#21 0x7ffb07027306 in mozilla::dom::ScriptLoader::EvaluateScript /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:2440

#22 0x7ffb07025653 in mozilla::dom::ScriptLoader::EvaluateScriptElement /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:2244

#23 0x7ffb0701bc8c in mozilla::dom::ScriptLoader::ProcessRequest /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:1884

#24 0x7ffb07016a1a in mozilla::dom::ScriptLoader::ProcessInlineScript /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:1318

#25 0x7ffb07000f02 in mozilla::dom::ScriptLoader::ProcessScriptElement /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:908

#26 0x7ffb06fffcb3 in mozilla::dom::ScriptElement::MaybeProcessScript /builds/worker/checkouts/gecko/dom/script/ScriptElement.cpp:182

#27 0x7ffaff71b7aa in nsHtml5TreeOpExecutor::RunScript /builds/worker/checkouts/gecko/parser/html/nsHtml5TreeOpExecutor.cpp:950

#28 0x7ffaff715c5e in nsHtml5TreeOpExecutor::RunFlushLoop /builds/worker/checkouts/gecko/parser/html/nsHtml5TreeOpExecutor.cpp:741

#29 0x7ffaff7239d4 in nsHtml5ExecutorFlusher::Run /builds/worker/checkouts/gecko/parser/html/nsHtml5StreamParser.cpp:174

#30 0x7ffafd76219e in mozilla::RunnableTask::Run /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:559

#31 0x7ffafd743e51 in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:886

#32 0x7ffafd73f595 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:709

#33 0x7ffafd7401e4 in mozilla::TaskController::ProcessPendingMTTask /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:495

#34 0x7ffafd765ae1 in mozilla::detail::RunnableFunction<`lambda at /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:218:7'>::Run /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.h:548

#35 0x7ffafd795a8e in nsThread::ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1199

#36 0x7ffafd7a62f1 in NS\_ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:480

#37 0x7ffafee92007 in mozilla::ipc::MessagePump::Run /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85

#38 0x7ffafedae5f3 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message\_loop.cc:363

#39 0x7ffafedae3ba in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message\_loop.cc:345

#40 0x7ffb07579b5c in nsBaseAppShell::Run /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:148

#41 0x7ffb07798227 in nsAppShell::Run /builds/worker/checkouts/gecko/widget/windows/nsAppShell.cpp:466

#42 0x7ffb0c0cff5e in XRE\_RunAppShell /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:722

#43 0x7ffafedae5f3 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message\_loop.cc:363

#44 0x7ffafedae3ba in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message\_loop.cc:345

#45 0x7ffb0c0cf518 in XRE\_InitChildProcess /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:657

#46 0x7ff6e0c92953 in NS\_internal\_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:375

#47 0x7ff6e0c9169b in wmain /builds/worker/checkouts/gecko/toolkit/xre/nsWindowsWMain.cpp:167

#48 0x7ff6e0d734e7 in \_\_scrt\_common\_main\_seh D:\a\_work\1\s\src\vctools\crt\vcstartup\src\startup\exe\_common.inl:288

#49 0x7ffbb0d17613 in BaseThreadInitThunk+0x13 (C:\WINDOWS\System32\KERNEL32.DLL+0x180017613)

#50 0x7ffbb0fe26b0 in RtlUserThreadStart+0x20 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x1800526b0)

SUMMARY: AddressSanitizer: heap-use-after-free /builds/worker/checkouts/gecko/xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove

Shadow bytes around the buggy address:

0x119d234cbf00: fd fd fd fd fd fd fd fd fa fa fa fa fd fd fd fd

0x119d234cbf80: fd fd fd fd fa fa fa fa fd fd fd fd fd fd fd fd

0x119d234cc000: fa fa fa fa fd fd fd fd fd fd fd fd fa fa fa fa

0x119d234cc080: fd fd fd fd fd fd fd fd fa fa fa fa fd fd fd fd

0x119d234cc100: fd fd fd fd fa fa fa fa fd fd fd fd fd fd fd fd

=>0x119d234cc180: fa fa fa fa fd fd fd fd fd fd fd[fd]fa fa fa fa

0x119d234cc200: fd fd fd fd fd fd fd fa fa fa fa fa fd fd fd fd

0x119d234cc280: fd fd fd fd fa fa fa fa fd fd fd fd fd fd fd fd

0x119d234cc300: fa fa fa fa fd fd fd fd fd fd fd fd fa fa fa fa

0x119d234cc380: fd fd fd fd fd fd fd fa fa fa fa fa fd fd fd fd

0x119d234cc400: fd fd fd fd fa fa fa fa fd fd fd fd fd fd fd fd

Shadow byte legend (one shadow byte represents 8 application bytes):

Addressable: 00

Partially addressable: 01 02 03 04 05 06 07

Heap left redzone: fa

Freed heap region: fd

Stack left redzone: f1

Stack mid redzone: f2

Stack right redzone: f3

Stack after return: f5

Stack use after scope: f8

Global redzone: f9

Global init order: f6

Poisoned by user: f7

Container overflow: fc

Array cookie: ac

Intra object redzone: bb

ASan internal: fe

Left alloca redzone: ca

Right alloca redzone: cb

==14772==ABORTING

Flags: sec-bounty?

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1849704#c1)• 1 year ago |
|  | |

Attached file
[ff.test2.js](attachment.cgi?id=9349854)
— [Details](attachment.cgi?id=9349854&action=edit)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a4581_406194)• 1 year ago |

Group: firefox-core-security → gfx-core-securityComponent: Security → Graphics: Canvas2DKeywords: [csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---)Product: Firefox → Core

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1849704#c2)• 1 year ago |
|  | |

This looks like a child process shutdown issue, so I'm not sure it is actually exploitable. This looks like it could be a regression from [bug 1839286](/show_bug.cgi?id=1839286 "RESOLVED FIXED - ImageBitmap can create a lot shutdown observers, which are managed by an array"), which changed ImageBitmapShutdownObserver recently.

Keywords: [regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)Regressed by: [1839286](/show_bug.cgi?id=1839286 "RESOLVED FIXED - ImageBitmap can create a lot shutdown observers, which are managed by an array")Summary: heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove → heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1849704#c3)• 1 year ago |
|  | |

(by not really exploitable, I mean that we don't run this code in the child process in release builds, only in ASan and debug builds...)

|  | [Timothy Nikkel (:tnikkel)](/user_profile?user_id=255010)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1849704#c4)• 1 year ago |
|  | |

Hmm, I haven't reproduced yet, but I think this is the same as [bug 1845372](/show_bug.cgi?id=1845372 "VERIFIED FIXED - Assertion failure: mBitmaps.Contains(aImageBitmap), at /dom/canvas/ImageBitmap.cpp:124") except we're creating another image bitmap shutdown observer in the XPCOMShutdown phase (instead of after that phase). So the AppShutdown::IsInOrBeyond(ShutdownPhase::XPCOMShutdownThreads) just needs to be changed to AppShutdown::IsInOrBeyond(ShutdownPhase::XPCOMShutdown). I'll work on reproducing to confirm that.

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1849704#c5)• 1 year ago |
|  | |

Set release status flags based on info from the regressing [bug 1839286](/show_bug.cgi?id=1839286 "RESOLVED FIXED - ImageBitmap can create a lot shutdown observers, which are managed by an array")

[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=unaffected)
[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected)
[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=unaffected)

|  | [Timothy Nikkel (:tnikkel)](/user_profile?user_id=255010)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a30954_255010)• 1 year ago |

Assignee: nobody → tnikkel

|  | [Timothy Nikkel (:tnikkel)](/user_profile?user_id=255010)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1849704#c6)• 1 year ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #3](/show_bug.cgi?id=1849704#c3 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver"))

> (by not really exploitable, I mean that we don't run this code in the child process in release builds, only in ASan and debug builds...)

Is that because we do a quick exit call without running any of the shutdown phases?

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1849704#c7)• 1 year ago |
|  | |

(In reply to Timothy Nikkel (:tnikkel) from [comment #6](/show_bug.cgi?id=1849704#c6 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver"))

> Is that because we do a quick exit call without running any of the shutdown phases?

Yes, it is the call to ProcessChild::QuickExit() in ContentChild::ActorDestroy() under `#ifndef NS_FREE_PERMANENT_DATA`. Maybe we should enable that somehow in fuzzing builds where we don't care about leak checking. I'm not sure.

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---) → [sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

|  | [Timothy Nikkel (:tnikkel)](/user_profile?user_id=255010)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1849704#c8)• 1 year ago |
|  | |

I wasn't able to reproduce, but I made builds with the proposed patch on try here

<https://treeherder.mozilla.org/jobs?repo=try&revision=7d6c85198e29ce72c5e327b837e08ead39d57ced>

Is it possible for you to download a build from that try link and see if it reproduces for you? If you haven't done that before you just click on the B of the type of build that you want, then "Artifacts and Debugging Tools" and then download target.zip from there. There are asan, fuzzing, debug, and regular opt builds there.

Flags: needinfo?(m.cooolie)

|  | [m.cooolie](/user_profile?user_id=689709)  Reporter |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1849704#c9)• 1 year ago |
|  | |

(In reply to Timothy Nikkel (:tnikkel) from [comment #8](/show_bug.cgi?id=1849704#c8 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver"))

> I wasn't able to reproduce, but I made builds with the proposed patch on try here
>
> <https://treeherder.mozilla.org/jobs?repo=try&revision=7d6c85198e29ce72c5e327b837e08ead39d57ced>
>
> Is it possible for you to download a build from that try link and see if it reproduces for you? If you haven't done that before you just click on the B of the type of build that you want, then "Artifacts and Debugging Tools" and then download target.zip from there. There are asan, fuzzing, debug, and regular opt builds there.

no longer reproduce.

Flags: needinfo?(m.cooolie)

|  | [Jason Kratzer [:jkratzer]](/user_profile?user_id=586683) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1849704#c10)• 1 year ago |
|  | |

:tnikkel, I'd like to understand a bit more about what configuration might be required to trigger this issue. I've been unable to reproduce it locally. Could it be related to a hardware specific configuration?

|  | [Timothy Nikkel (:tnikkel)](/user_profile?user_id=255010)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1849704#c11)• 1 year ago |
|  | |

(In reply to Jason Kratzer [:jkratzer] from [comment #10](/show_bug.cgi?id=1849704#c10 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver"))

> :tnikkel, I'd like to understand a bit more about what configuration might be required to trigger this issue. I've been unable to reproduce it locally. Could it be related to a hardware specific configuration?

Not as far as I know. I suspect it's just very timing sensitive: we have to create an ImageBitmap in exactly the right shutdown phase, and normally we would try to avoid creating any new unnecessary objects in shutdown at all. So different os/cpu/environment can lead to differences in thread dispatching and what runs when. I only have access to macos this week and the reporter seems to be on Windows. Have you tried to reproduce anywhere?

It's also possible that this bug is the same as your [bug 1846528](/show_bug.cgi?id=1846528 "RESOLVED FIXED - AddressSanitizer: heap-buffer-overflow [@ std::_Atomic_storage<unsigned int,4>::load] with READ of size 4"), but we didn't have any reproduction or pernosco there so we weren't able to go any further.

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a196689_75935)• 1 year ago |

[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=wontfix)

|  | [Timothy Nikkel (:tnikkel)](/user_profile?user_id=255010)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1849704#c12)• 1 year ago |
|  | |

Attached file
[Bug 1849704. Don't create a new ImageBitmapShutdownObserver if we are in XPCOMShutdown or later. r?#gfx-reviewers](attachment.cgi?id=9350277)
— [Details](attachment.cgi?id=9350277&action=edit)

PCOMShutdownThreads is the phase just after XPCOMShutdown and XPCOMShutdown is when we destory the ImageBitmapShutdownObserver, so we need to not create a new ImageBitmapShutdownObserver if we are in XPCOMShutdown or later.

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1849704#c13)• 1 year ago |
|  | |

Pushed by tnikkel@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/8bec97042dc0>
Don't create a new ImageBitmapShutdownObserver if we are in XPCOMShutdown or later. r=gfx-reviewers,aosmond

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1849704#c14)• 1 year ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/8bec97042dc0>

Group: gfx-core-security → core-security-releaseStatus: NEW → RESOLVEDClosed: 1 year ago
[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 118 Branch

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1849704#c15)• 1 year ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #7](/show_bug.cgi?id=1849704#c7 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver"))

> (In reply to Timothy Nikkel (:tnikkel) from [comment #6](/show_bug.cgi?id=1849704#c6 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver"))
>
> > Is that because we do a quick exit call without running any of the shutdown phases?
>
> Yes, it is the call to ProcessChild::QuickExit() in ContentChild::ActorDestroy() under `#ifndef NS_FREE_PERMANENT_DATA`. Maybe we should enable that somehow in fuzzing builds where we don't care about leak checking. I'm not sure.

Can someone provide an authoritative answer?

Should we adjust how this is fuzzed?

Flags: needinfo?(tnikkel)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a632304_1689)• 1 year ago |

Flags: sec-bounty? → sec-bounty+

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1849704#c16)• 1 year ago |
|  | |

(In reply to Frederik Braun [:freddy] from [comment #15](/show_bug.cgi?id=1849704#c15 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver"))

> Can someone provide an authoritative answer?
>
> Should we adjust how this is fuzzed?

I filed [bug 1850021](/show_bug.cgi?id=1850021 "NEW - Fuzzing ASan builds shouldn't be NS_FREE_PERMANENT_DATA") on this.

|  | [Timothy Nikkel (:tnikkel)](/user_profile?user_id=255010)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1849704#c17)• 1 year ago |
|  | |

I think Andrew answered this needinfo.

Flags: needinfo?(tnikkel)

|  | [Camelia Badau [:cbadau], Desktop Test Engineering](/user_profile?user_id=500622) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a767190_500622)• 1 year ago |

Flags: qe-verify+

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a876382_488993)• 1 year ago |

QA Whiteboard: [post-critsmash-triage]

|  | [Ciprian Georgiu, Desktop QA](/user_profile?user_id=576182) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1849704#c18)• 1 year ago |
|  | |

I've followed the STR from [comment 0](/show_bug.cgi?id=1849704#c0 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver") in order to reproduce the bug, but unfortunately it does not crash on my end. I'm using an affected asan Nightly build (20230822040001) on Win 11 x64.

After talking with Timothy on slack, it seems that the crash is not an easy one to reproduce, and we have to rely on the verification made in [comment 9](/show_bug.cgi?id=1849704#c9 "RESOLVED FIXED - heap-use-after-free xpcom/ds/PLDHashTable.cpp:546 in PLDHashTable::Remove with ImageBitmapShutdownObserver").

I'm removing the qe+ flag since there's nothing for QA to be done here.

Flags: qe-verify+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a2347151_578488)• 1 year ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?] → [reporter-external] [client-bounty-form] [verif?][adv-main118+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1849704#c19)• 1 year ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9354366)
— [Details](attachment.cgi?id=9354366&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a11652787_1689)• 1 year ago |

Group: core-security-release

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a11657703_1689)• 1 year ago |

Alias: CVE-2023-5175

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1849704#a24391338_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1849704&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [m.cooolie](/user_profile?user_id=689709)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


