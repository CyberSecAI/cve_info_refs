=== Content from www.wordfence.com_7832070a_20250114_181958.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# AI ChatBot <= 4.8.9 and 4.9.2 - Authenticated (Subscriber+) Directory Traversal to Arbitrary File Write via qcld\_openai\_upload\_pagetraining\_file

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   AI ChatBot <= 4.8.9 and 4.9.2 - Authenticated (Subscriber+) Directory Traversal to Arbitrary File Write via qcld\_openai\_upload\_pagetraining\_file

9.6

**Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:N/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:N/I:H/A:H)

| CVE | [CVE-2023-5241](https://www.cve.org/CVERecord?id=CVE-2023-5241) |
| --- | --- |
| CVSS | 9.6 (Critical) |
| Publicly Published | October 11, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The AI ChatBot for WordPress is vulnerable to Directory Traversal in versions up to, and including, 4.8.9 as well as 4.9.2 via the qcld\_openai\_upload\_pagetraining\_file function. This allows subscriber-level attackers to append "<?php" to any existing file on the server resulting in potential DoS when appended to critical files such as wp-config.php.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php#L376)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=2977505%40chatbot%2Ftrunk&old=2967435%40chatbot%2Ftrunk&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fchatbot%2Fai-chatbot-489-authenticated-subscriber-directory-traversal-to-arbitrary-file-write-via-qcld-openai-upload-pagetraining-file&t=AI%20ChatBot%20%3C%3D%204.8.9%20and%204.9.2%20-%20Authenticated%20%28Subscriber%2B%29%20Directory%20Traversal%20to%20Arbitrary%20File%20Write%20via%20qcld_openai_upload_pagetraining_file "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fchatbot%2Fai-chatbot-489-authenticated-subscriber-directory-traversal-to-arbitrary-file-write-via-qcld-openai-upload-pagetraining-file&text=AI%20ChatBot%20%3C%3D%204.8.9%20and%204.9.2%20-%20Authenticated%20%28Subscriber%2B%29%20Directory%20Traversal%20to%20Arbitrary%20File%20Write%20via%20qcld_openai_upload_pagetraining_file "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fchatbot%2Fai-chatbot-489-authenticated-subscriber-directory-traversal-to-arbitrary-file-write-via-qcld-openai-upload-pagetraining-file "LinkedIn")
Email

## Vulnerability Details for AI ChatBot for WordPress – WPBot

#### [AI ChatBot for WordPress – WPBot](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/chatbot)

| Software Type | Plugin |
| --- | --- |
| Software Slug | chatbot [(view on wordpress.org)](https://wordpress.org/plugins/chatbot) |
| Patched? | Yes |
| Remediation | Update to one of the following versions, or a newer patched version: 4.9.1, 4.9.3 |
| Affected Versions | * 4.9.2 * <= 4.8.9 |
| Patched Versions | * 4.9.1 * 4.9.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_72ecf93b_20250114_181952.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fchatbot%2Ftrunk%2Fincludes%2Fopenai%2Fqcld-bot-openai.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=3164072 "Revision 3164072")
* Next Revision →
* [Blame](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/chatbot/trunk/includes/openai/qcld-bot-openai.php)

---

# [source:](/browser?order=name "Go to repository root") [chatbot](/browser/chatbot?order=name "View chatbot")/[trunk](/browser/chatbot/trunk?order=name "View trunk")/[includes](/browser/chatbot/trunk/includes?order=name "View includes")/[openai](/browser/chatbot/trunk/includes/openai?order=name "View openai")/[qcld-bot-openai.php](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?order=name "View qcld-bot-openai.php")

View diff against:

View revision:

| [Last change](/changeset/3174814/chatbot/trunk/includes/openai/qcld-bot-openai.php "View differences") on this file was [3174814](/changeset/3174814/ "View changeset 3174814"), checked in by quantumcloud, [3 months ago](/timeline?from=2024-10-24T08%3A53%3A57Z&precision=second "See timeline at 10/24/2024 08:53:57 AM") |
| --- |
| Mark down support for OpenAI responses |
| **File size:** 35.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (!defined('ABSPATH')) exit; // Exit if accessed directly |
| [3](#L3) |  |
| [4](#L4) | if(!class\_exists('qcld\_wpopenai\_addons')){ |
| [5](#L5) |  |
| [6](#L6) |  |
| [7](#L7) | /\*\* |
| [8](#L8) | \* Main Class. |
| [9](#L9) | \*/ |
| [10](#L10) | final class qcld\_wpopenai\_addons |
| [11](#L11) | { |
| [12](#L12) | private $id = 'Open AI'; |
| [13](#L13) |  |
| [14](#L14) | /\*\* |
| [15](#L15) | \* WPBot Pro version. |
| [16](#L16) | \* |
| [17](#L17) | \* @var string |
| [18](#L18) | \*/ |
| [19](#L19) | public $version = '1.0.6'; |
| [20](#L20) |  |
| [21](#L21) | /\*\* |
| [22](#L22) | \* WPBot Pro helper. |
| [23](#L23) | \* |
| [24](#L24) | \* @var object |
| [25](#L25) | \*/ |
| [26](#L26) | public $helper; |
| [27](#L27) |  |
| [28](#L28) | /\*\* |
| [29](#L29) | \* The single instance of the class. |
| [30](#L30) | \* |
| [31](#L31) | \* @var qcld\_wb\_Chatbot |
| [32](#L32) | \* @since 1.0.0 |
| [33](#L33) | \*/ |
| [34](#L34) | protected static $\_instance = null; |
| [35](#L35) |  |
| [36](#L36) | /\*\* |
| [37](#L37) | \* Main wpbot Instance. |
| [38](#L38) | \* |
| [39](#L39) | \* Ensures only one instance of wpbot is loaded or can be loaded. |
| [40](#L40) | \* |
| [41](#L41) | \* @return qcld\_wb\_Chatbot - Main instance. |
| [42](#L42) | \* @since 1.0.0 |
| [43](#L43) | \* @static |
| [44](#L44) | \*/ |
| [45](#L45) | public static function instance() { |
| [46](#L46) | if ( is\_null( self::$\_instance ) ) { |
| [47](#L47) | self::$\_instance = new self(); |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | return self::$\_instance; |
| [51](#L51) | } |
| [52](#L52) |  |
| [53](#L53) | public $response\_list; |
| [54](#L54) |  |
| [55](#L55) | /\*\* |
| [56](#L56) | \*  Constructor |
| [57](#L57) | \*/ |
| [58](#L58) | public function \_\_construct() |
| [59](#L59) | { |
| [60](#L60) | $this->define\_constants(); |
| [61](#L61) | $this->includes(); |
| [62](#L62) | add\_action('wp\_ajax\_openai\_settings\_option', [$this, 'openai\_settings\_option\_callback']); |
| [63](#L63) | add\_action('wp\_ajax\_openai\_response',[$this,'openai\_response\_callback']); |
| [64](#L64) | add\_action('wp\_ajax\_nopriv\_openai\_response', [$this, 'openai\_response\_callback']); |
| [65](#L65) | add\_action('wp\_ajax\_openai\_troubleshooting',[$this,'openai\_troubleshooting']); |
| [66](#L66) | if (is\_admin() && !empty($\_GET["page"]) && (($\_GET["page"] == "openai-panel\_dashboard") || ($\_GET["page"] == "openai-panel\_file") || ($\_GET["page"] == "openai-panel\_help"))) { |
| [67](#L67) | add\_action('admin\_enqueue\_scripts', array($this, 'qcld\_wb\_chatbot\_admin\_scripts')); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) |  |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) |  |
| [74](#L74) | /\*\* |
| [75](#L75) | \* Define wpbot Constants. |
| [76](#L76) | \* |
| [77](#L77) | \* @return void |
| [78](#L78) | \* @since 1.0.0 |
| [79](#L79) | \*/ |
| [80](#L80) | public function define\_constants() { |
| [81](#L81) | if( ! defined( 'QCLD\_openai\_addon\_VERSION' ) ){ |
| [82](#L82) | define('QCLD\_openai\_addon\_VERSION', $this->version); |
| [83](#L83) | } |
| [84](#L84) | //define('QCLD\_openai\_addon\_REQUIRED\_wpCOMMERCE\_VERSION', 2.2); |
| [85](#L85) |  |
| [86](#L86) | if( ! defined( 'QCLD\_openai\_addon\_PLUGIN\_DIR\_PATH' ) ){ |
| [87](#L87) | define('QCLD\_openai\_addon\_PLUGIN\_DIR\_PATH', plugin\_dir\_path(\_\_FILE\_\_)); |
| [88](#L88) | } |
| [89](#L89) | if( ! defined( 'QCLD\_openai\_addon\_PLUGIN\_URL' ) ){ |
| [90](#L90) | define('QCLD\_openai\_addon\_PLUGIN\_URL', plugin\_dir\_url(\_\_FILE\_\_)); |
| [91](#L91) | } |
| [92](#L92) | if( ! defined( 'QCLD\_openai\_addon\_IMG\_URL' ) ){ |
| [93](#L93) | define('QCLD\_openai\_addon\_IMG\_URL', QCLD\_openai\_addon\_PLUGIN\_URL . "images/"); |
| [94](#L94) | } |
| [95](#L95) | if( ! defined( 'QCLD\_openai\_addon\_IMG\_ABSOLUTE\_PATH' ) ){ |
| [96](#L96) | define('QCLD\_openai\_addon\_IMG\_ABSOLUTE\_PATH', plugin\_dir\_path(\_\_FILE\_\_) . "images"); |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | } |
| [100](#L100) |  |
| [101](#L101) |  |
| [102](#L102) | public function qcld\_wb\_chatbot\_admin\_scripts(){ |
| [103](#L103) | // wp\_register\_style('qlcd-open-ai-bootstap', QCLD\_openai\_addon\_PLUGIN\_URL . 'css/openai-bootstrap.css', '', QCLD\_openai\_addon\_VERSION, 'screen'); |
| [104](#L104) | // wp\_enqueue\_style('qlcd-open-ai-bootstap'); |
| [105](#L105) | // wp\_register\_style('qlcd-open-ai-admin-style', QCLD\_openai\_addon\_PLUGIN\_URL . 'css/openai-admin-style.css', '', QCLD\_openai\_addon\_VERSION, 'screen'); |
| [106](#L106) | // wp\_enqueue\_style('qlcd-open-ai-admin-style'); |
| [107](#L107) | // wp\_register\_script('qlcd-openai\_collapse', QCLD\_openai\_addon\_PLUGIN\_URL . 'js/collapse.js', array('jquery'),'',QCLD\_openai\_addon\_VERSION,true); |
| [108](#L108) | // wp\_enqueue\_script('qlcd-openai\_collapse'); |
| [109](#L109) | // wp\_register\_script('qlcd-openai\_settings', QCLD\_openai\_addon\_PLUGIN\_URL . 'js/openai\_settings.js', array('jquery'),'',QCLD\_openai\_addon\_VERSION,true); |
| [110](#L110) | // wp\_enqueue\_script('qlcd-openai\_settings'); |
| [111](#L111) |  |
| [112](#L112) | // wp\_localize\_script( 'qlcd-openai\_settings', 'openai\_ajax', array( |
| [113](#L113) | //     'url' => admin\_url( 'admin-ajax.php' ), |
| [114](#L114) | // ) ); |
| [115](#L115) |  |
| [116](#L116) | } |
| [117](#L117) | /\*\* |
| [118](#L118) | \* Include all required files |
| [119](#L119) | \* |
| [120](#L120) | \* since 1.0.0 |
| [121](#L121) | \* |
| [122](#L122) | \* @return void |
| [123](#L123) | \*/ |
| [124](#L124) | public function includes() { |
| [125](#L125) | require\_once( QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . "includes/openai/qcld\_wp\_OpenAI.php" ); |
| [126](#L126) | require\_once( QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . "includes/openai/OpenAi\_WPBot\_Menu.php" ); |
| [127](#L127) | require\_once( QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH . "includes/openai/Parsedown.php" ); |
| [128](#L128) |  |
| [129](#L129) | } |
| [130](#L130) | // public function openai\_file\_delete\_callback(){ |
| [131](#L131) | //     $file\_id = sanitize\_text\_field($\_POST['file\_id']); |
| [132](#L132) | //     $url = 'https://api.openai.com/v1/files/'. $file\_id; |
| [133](#L133) | //     $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
| [134](#L134) | //     $ch = curl\_init(); |
| [135](#L135) | //     curl\_setopt($ch, CURLOPT\_URL, $url); |
| [136](#L136) | //     curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
| [137](#L137) | //     curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'DELETE'); |
| [138](#L138) | //     $headers = array( |
| [139](#L139) | //         $apt\_key, |
| [140](#L140) | //     ); |
| [141](#L141) | //     curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
| [142](#L142) | //     $result = curl\_exec($ch); |
| [143](#L143) | //     if (curl\_errno($ch)) { |
| [144](#L144) | //         echo 'Error:' . curl\_error($ch); |
| [145](#L145) | //     } |
| [146](#L146) | //     curl\_close($ch); |
| [147](#L147) | //    wp\_send\_json( json\_decode($result)); |
| [148](#L148) | //    wp\_die(); |
| [149](#L149) | // } |
| [150](#L150) |  |
| [151](#L151) | public function buildFormBody( $fields, $boundary ) |
| [152](#L152) | { |
| [153](#L153) | $body = ''; |
| [154](#L154) | foreach ( $fields as $name => $value ) { |
| [155](#L155) | if ( $name == 'data' ) { |
| [156](#L156) | continue; |
| [157](#L157) | } |
| [158](#L158) | $body .= "--$boundary\r\n"; |
| [159](#L159) | $body .= "Content-Disposition: form-data; name=\"$name\""; |
| [160](#L160) | if ( $name == 'file' ) { |
| [161](#L161) | $body .= "; filename=\"{$value}\"\r\n"; |
| [162](#L162) | $body .= "Content-Type: application/json\r\n\r\n"; |
| [163](#L163) | $body .= $fields['data'] . "\r\n"; |
| [164](#L164) | }else { |
| [165](#L165) | $body .= "\r\n\r\n$value\r\n"; |
| [166](#L166) | } |
| [167](#L167) | } |
| [168](#L168) | $body .= "--$boundary--\r\n"; |
| [169](#L169) | return $body; |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | // public function openai\_file\_list\_callback(){ |
| [173](#L173) | //     $url = 'https://api.openai.com/v1/files'; |
| [174](#L174) | //     $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
| [175](#L175) | //     $curl = curl\_init(); |
| [176](#L176) | //     curl\_setopt($curl, CURLOPT\_URL, $url); |
| [177](#L177) | //     $headers = array( |
| [178](#L178) | //         "Content-Type: application/json", |
| [179](#L179) | //         $apt\_key, |
| [180](#L180) | //     ); |
| [181](#L181) | //     curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
| [182](#L182) | //     curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
| [183](#L183) | //     $response = curl\_exec($curl); |
| [184](#L184) | //     curl\_close($curl); |
| [185](#L185) | //     wp\_send\_json( json\_decode($response)); |
| [186](#L186) | //     wp\_die(); |
| [187](#L187) | // } |
| [188](#L188) | public function qcld\_sanitize\_text\_or\_array\_field($array\_or\_string) { |
| [189](#L189) | if( is\_string($array\_or\_string) ){ |
| [190](#L190) | $array\_or\_string = sanitize\_text\_field($array\_or\_string); |
| [191](#L191) | }elseif( is\_array($array\_or\_string) ){ |
| [192](#L192) | foreach ( $array\_or\_string as $key => &$value ) { |
| [193](#L193) | if ( is\_array( $value ) ) { |
| [194](#L194) | $value = $this->sanitize\_text\_or\_array\_field($value); |
| [195](#L195) | } |
| [196](#L196) | else { |
| [197](#L197) | $value = sanitize\_text\_field( $value ); |
| [198](#L198) | } |
| [199](#L199) | } |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | return $array\_or\_string; |
| [203](#L203) | } |
| [204](#L204) |  |
| [205](#L205) | // public function openai\_file\_upload\_callback(){ |
| [206](#L206) | //     $uploadedfile = $\_FILES['file']; |
| [207](#L207) | //     $url = 'https://api.openai.com/v1/files'; |
| [208](#L208) | //     $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
| [209](#L209) | //     $curl = curl\_init($url); |
| [210](#L210) | //     curl\_setopt($curl, CURLOPT\_URL, $url); |
| [211](#L211) | //     curl\_setopt($curl, CURLOPT\_POST, true); |
| [212](#L212) | //     $headers = array( |
| [213](#L213) | //         "Content-Type: multipart/form-data", |
| [214](#L214) | //         $apt\_key, |
| [215](#L215) | //     ); |
| [216](#L216) | //     if (function\_exists('curl\_file\_create')) { |
| [217](#L217) | //         $tmp\_file = curl\_file\_create($uploadedfile['tmp\_name'], 'jsonl', $uploadedfile['name']); |
| [218](#L218) | //     } else { |
| [219](#L219) | //         $tmp\_file = open($uploadedfile['tmp\_name']); |
| [220](#L220) | //     } |
| [221](#L221) | //     $data = array('file'=> $tmp\_file,'purpose'=> 'fine-tune'); |
| [222](#L222) | //     $init = curl\_init(); |
| [223](#L223) | //     //function parameteres |
| [224](#L224) | //     curl\_setopt($init, CURLOPT\_URL,$url); |
| [225](#L225) | //     curl\_setopt($init, CURLOPT\_HTTPHEADER, $headers); |
| [226](#L226) | //     curl\_setopt($init, CURLOPT\_POSTFIELDS, $data); |
| [227](#L227) | //     curl\_setopt($init, CURLOPT\_RETURNTRANSFER, true); |
| [228](#L228) | //     $res = json\_decode(curl\_exec ($init)); |
| [229](#L229) |  |
| [230](#L230) | //     curl\_close ($init); |
| [231](#L231) | //     if(!empty($res->error)){ |
| [232](#L232) | //         $response['status'] = 'error'; |
| [233](#L233) | //         $response['message'] = $res->error->message; |
| [234](#L234) | //     } |
| [235](#L235) |  |
| [236](#L236) | //     if(!empty($res->status)){ |
| [237](#L237) | //         $response['status'] = 'success'; |
| [238](#L238) | //         $response['message'] = 'Successfully Created file' . $res->id ; |
| [239](#L239) |  |
| [240](#L240) | //     } |
| [241](#L241) | //     echo wp\_send\_json([$response]); |
| [242](#L242) | //     wp\_die(); |
| [243](#L243) | // } |
| [244](#L244) | public function openai\_finetune\_create($file\_id,$ft\_suffix,$ft\_engines){ |
| [245](#L245) | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
| [246](#L246) | $headers = array( |
| [247](#L247) | "Content-Type: application/json", |
| [248](#L248) | $apt\_key, |
| [249](#L249) | ); |
| [250](#L250) | $curl = curl\_init(); |
| [251](#L251) | $qcld\_openai\_suffix = isset($ft\_suffix) ? $ft\_suffix : get\_option('qcld\_openai\_suffix'); |
| [252](#L252) | $openai\_engines = isset($ft\_engines) ? $ft\_engines : get\_option('openai\_engines'); |
| [253](#L253) | $base\_engine = explode('-',$openai\_engines); |
| [254](#L254) | if( $base\_engine[0] == 'gpt'){ |
| [255](#L255) | $data = json\_encode(array('training\_file'=>$file\_id,'model' => $openai\_engines, 'suffix' => $qcld\_openai\_suffix )); |
| [256](#L256) | $url = "https://api.openai.com/v1/fine\_tuning/jobs"; |
| [257](#L257) | curl\_setopt($curl, CURLOPT\_URL, $url); |
| [258](#L258) | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
| [259](#L259) | curl\_setopt($curl, CURLOPT\_POST, true); |
| [260](#L260) | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
| [261](#L261) | curl\_setopt($curl, CURLOPT\_POSTFIELDS, $data); |
| [262](#L262) | $result = json\_decode(curl\_exec($curl)); |
| [263](#L263) | curl\_close($curl); |
| [264](#L264) | }else{ |
| [265](#L265) |  |
| [266](#L266) | $data = json\_encode(array('training\_file'=>$file\_id,'model' => $base\_engine[1], 'suffix' => $qcld\_openai\_suffix )); |
| [267](#L267) | $url = "https://api.openai.com/v1/fine-tunes"; |
| [268](#L268) | curl\_setopt($curl, CURLOPT\_URL, $url); |
| [269](#L269) | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
| [270](#L270) | curl\_setopt($curl, CURLOPT\_POST, true); |
| [271](#L271) | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
| [272](#L272) | curl\_setopt($curl, CURLOPT\_POSTFIELDS, $data); |
| [273](#L273) | $result = json\_decode(curl\_exec($curl)); |
| [274](#L274) | curl\_close($curl); |
| [275](#L275) | } |
| [276](#L276) | return $result; |
| [277](#L277) | } |
| [278](#L278) | public function relevant\_pagelink($search\_query){ |
| [279](#L279) |  |
| [280](#L280) | $stopwords = explode( ',', get\_option('qlcd\_wp\_chatbot\_stop\_words') ); |
| [281](#L281) |  |
| [282](#L282) | $finalQueryWordsWithoutStopWords = $this->qcpd\_remove\_wa\_stopwords( strtolower($search\_query), $stopwords ); |
| [283](#L283) |  |
| [284](#L284) | $cleanWordsWithoutPunctuationMarks = preg\_replace('/[\p{P}]/u', '', $finalQueryWordsWithoutStopWords); |
| [285](#L285) |  |
| [286](#L286) | $q = trim($cleanWordsWithoutPunctuationMarks); |
| [287](#L287) |  |
| [288](#L288) | $links = []; |
| [289](#L289) |  |
| [290](#L290) | $post\_type\_array = ['post','page']; |
| [291](#L291) |  |
| [292](#L292) | //Proceeding with traditional search |
| [293](#L293) |  |
| [294](#L294) | $the\_query = new WP\_Query( array( 'post\_status' => 'publish', 'posts\_per\_page' => 5, 's' => esc\_attr( $q ), 'post\_type' => $post\_type\_array ) ); |
| [295](#L295) |  |
| [296](#L296) | if( $the\_query->have\_posts() ){ |
| [297](#L297) |  |
| [298](#L298) | while( $the\_query->have\_posts() ){ |
| [299](#L299) |  |
| [300](#L300) | $the\_query->the\_post(); |
| [301](#L301) |  |
| [302](#L302) | $url  = esc\_url( get\_permalink() ); |
| [303](#L303) |  |
| [304](#L304) | $link = '<li><mark><a style="color: #000" href=' . $url . '>' . get\_the\_title() . '</a><mark></li>'; |
| [305](#L305) |  |
| [306](#L306) | array\_push($links, $link); |
| [307](#L307) |  |
| [308](#L308) | } //End of WHILE |
| [309](#L309) |  |
| [310](#L310) | wp\_reset\_postdata(); |
| [311](#L311) |  |
| [312](#L312) | } //End of IF |
| [313](#L313) |  |
| [314](#L314) | $links = array\_unique($links); |
| [315](#L315) |  |
| [316](#L316) | return $links; |
| [317](#L317) |  |
| [318](#L318) | } //End of function relevant\_pagelink() |
| [319](#L319) | public function openai\_retrive\_fine\_tune($keyword){ |
| [320](#L320) |  |
| [321](#L321) | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
| [322](#L322) | $headers = array( |
| [323](#L323) | "Content-Type: application/json", |
| [324](#L324) | $apt\_key, |
| [325](#L325) | ); |
| [326](#L326) | $curl = curl\_init(); |
| [327](#L327) | $max\_tokens =  (int)get\_option( 'openai\_max\_tokens'); |
| [328](#L328) | $temp = (float)get\_option( 'openai\_temperature'); |
| [329](#L329) | $frequency\_penalty = (float)get\_option( 'frequency\_penalty'); |
| [330](#L330) | $presence\_penalty = (float)get\_option( 'presence\_penalty'); |
| [331](#L331) | $engines = explode('-',get\_option( 'openai\_engines')); |
| [332](#L332) | $custom\_model = get\_option( 'qcld\_openai\_custom\_model'); |
| [333](#L333) | $custom\_model = (explode(":",$custom\_model)); |
| [334](#L334) | $prompts = $this->get\_prompt($keyword); |
| [335](#L335) |  |
| [336](#L336) | if($custom\_model[1] != 'gpt-3.5-turbo-0613'){ |
| [337](#L337) | $data = json\_encode(array( |
| [338](#L338) | 'prompt'=>  $prompts, |
| [339](#L339) | 'model'=> get\_option( 'qcld\_openai\_custom\_model'), |
| [340](#L340) | "max\_tokens" => $max\_tokens, |
| [341](#L341) | "temperature" => $temp, |
| [342](#L342) | "top\_p" => 1, |
| [343](#L343) | "presence\_penalty" => $frequency\_penalty, |
| [344](#L344) | "frequency\_penalty"=> $presence\_penalty, |
| [345](#L345) | "best\_of"=> 1, |
| [346](#L346) | "stop"=> ["\n###\n","###"] |
| [347](#L347) | )); |
| [348](#L348) | $url = "https://api.openai.com/v1/completions"; |
| [349](#L349) |  |
| [350](#L350) | $ch = curl\_init(); |
| [351](#L351) |  |
| [352](#L352) | curl\_setopt($ch, CURLOPT\_URL, 'https://api.openai.com/v1/completions'); |
| [353](#L353) | // curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
| [354](#L354) | // curl\_setopt($ch, CURLOPT\_POST, 1); |
| [355](#L355) | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, true); |
| [356](#L356) | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'POST'); |
| [357](#L357) | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
| [358](#L358) | curl\_setopt($ch, CURLOPT\_POSTFIELDS, $data); |
| [359](#L359) |  |
| [360](#L360) | $result = (curl\_exec($ch)); |
| [361](#L361) | $result = str\_replace("#","",$result ); |
| [362](#L362) |  |
| [363](#L363) | return $result; |
| [364](#L364) | if (curl\_errno($ch)) { |
| [365](#L365) | // phpcs:ignore |
| [366](#L366) | echo 'Error:' . curl\_error($ch); |
| [367](#L367) | } |
| [368](#L368) | curl\_close($ch); |
| [369](#L369) | }else{ |
| [370](#L370) | $data = json\_encode(array( |
| [371](#L371) | 'model'=> get\_option( 'qcld\_openai\_custom\_model'), |
| [372](#L372) | "messages"=>  [ |
| [373](#L373) |  |
| [374](#L374) | [ |
| [375](#L375) | "role"=> "user", |
| [376](#L376) | "content"=>$keyword |
| [377](#L377) | ] |
| [378](#L378) |  |
| [379](#L379) | ], |
| [380](#L380) |  |
| [381](#L381) | )); |
| [382](#L382) | $ch = curl\_init(); |
| [383](#L383) |  |
| [384](#L384) | curl\_setopt($ch, CURLOPT\_URL, 'https://api.openai.com/v1/chat/completions'); |
| [385](#L385) | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, true); |
| [386](#L386) | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'POST'); |
| [387](#L387) | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
| [388](#L388) | curl\_setopt($ch, CURLOPT\_POSTFIELDS, $data); |
| [389](#L389) |  |
| [390](#L390) | $results = (curl\_exec($ch)); |
| [391](#L391) | $results = str\_replace("#","",$result ); |
| [392](#L392) | $result = (json\_decode($results)->choices[0]->message->content); |
| [393](#L393) | return $result; |
| [394](#L394) |  |
| [395](#L395) |  |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | } |
| [399](#L399) | public function response\_form\_file($keyword){ |
| [400](#L400) | $max\_tokens =  (int)get\_option( 'openai\_max\_tokens'); |
| [401](#L401) | $temp = (float)get\_option( 'openai\_temperature'); |
| [402](#L402) | $frequency\_penalty = (float)get\_option( 'frequency\_penalty'); |
| [403](#L403) | $presence\_penalty = (float)get\_option( 'presence\_penalty'); |
| [404](#L404) | $engines = explode('-',get\_option( 'openai\_engines')); |
| [405](#L405) | if($engines[0] != 'gpt'){ |
| [406](#L406) | // $prompts = $this->get\_prompt($keyword); |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) | $request\_body = [ |
| [410](#L410) | "prompt" =>   $keyword, |
| [411](#L411) | "model" => get\_option( 'qcld\_openai\_custom\_model'), |
| [412](#L412) | "max\_tokens" => $max\_tokens, |
| [413](#L413) | "temperature" => 0, |
| [414](#L414) | "top\_p" => 1, |
| [415](#L415) | "stop" => [], |
| [416](#L416) | "presence\_penalty" => 0, |
| [417](#L417) | "frequency\_penalty"=> 0, |
| [418](#L418) | "best\_of"=> 1, |
| [419](#L419) | ]; |
| [420](#L420) | $postFields = json\_encode($request\_body); |
| [421](#L421) | $OpenAI =  new qcld\_wp\_OpenAI(); |
| [422](#L422) | $result = $OpenAI->get\_response($postFields); |
| [423](#L423) |  |
| [424](#L424) | return $result; |
| [425](#L425) | } |
| [426](#L426) | public function get\_prompt($keyword){ |
| [427](#L427) | $openai\_include\_keyword =  get\_option( 'openai\_include\_keyword'); |
| [428](#L428) | $openai\_exclude\_keyword = get\_option( 'openai\_exclude\_keyword'); |
| [429](#L429) | $qcld\_openai\_prompt = get\_option('qcld\_openai\_prompt',true); |
| [430](#L430) |  |
| [431](#L431) | } |
| [432](#L432) | public function include\_exclude\_prompt($keyword){ |
| [433](#L433) | $openai\_include\_keyword = strtolower(get\_option('openai\_include\_keyword')); |
| [434](#L434) | $openai\_exclude\_keyword = strtolower(get\_option('openai\_exclude\_keyword')); |
| [435](#L435) |  |
| [436](#L436) | if((get\_option('openai\_include\_keyword')  != '') || (get\_option('openai\_exclude\_keyword')  == '')){ |
| [437](#L437) | $prompts    = 'If the query is not relevant  to one of the keywords: '.$openai\_include\_keyword .' then only say DUH. Provide a response only if the following query is relevant to one of the keywords: '.$openai\_include\_keyword .' The actual query is as follows: '. $keyword; |
| [438](#L438) | return $prompts; |
| [439](#L439) | }else if((get\_option('openai\_include\_keyword')  == '') || (get\_option('openai\_exclude\_keyword')  != '')){ |
| [440](#L440) |  |
| [441](#L441) | $prompts = 'If the query is relevant to one of the keywords: ' .$openai\_exclude\_keyword . ',  then do not respond and only say "DUH."   The actual query is as follows: '. $keyword. '?/n'; |
| [442](#L442) | return $prompts; |
| [443](#L443) | }else if((get\_option('openai\_include\_keyword')  != '') || (get\_option('openai\_exclude\_keyword')  != '')){ |
| [444](#L444) | $prompts    = 'If the query is not relevant  to one of the keywords: '.$openai\_include\_keyword .' then only say "DUH." Provide a response only if the following query is relevant to one of the keywords: '.$openai\_include\_keyword .' The actual query is as follows: '. $keyword; |
| [445](#L445) | return $prompts; |
| [446](#L446) | } |
| [447](#L447) | } |
| [448](#L448) | public function qcld\_include\_keyword\_exist( $keyword ){ |
| [449](#L449) | $keyword = isset($keyword) ? $keyword : ''; |
| [450](#L450) | $openai\_include\_keywords = strtolower(get\_option('openai\_include\_keyword')); |
| [451](#L451) | if(!empty($keyword)){ |
| [452](#L452) | $openai\_include\_keyword = ( isset( $openai\_include\_keywords ) ?  $openai\_include\_keywords : ''); |
| [453](#L453) |  |
| [454](#L454) | if( !empty($openai\_include\_keyword)){ |
| [455](#L455) | $include\_items = explode(',', $openai\_include\_keyword); |
| [456](#L456) | if(!empty($include\_items)){ |
| [457](#L457) | foreach($include\_items as $k => $item){ |
| [458](#L458) | if((strpos($keyword,trim($item)) !== false) && !empty($item)){ |
| [459](#L459) | return true; |
| [460](#L460) | } |
| [461](#L461) | } |
| [462](#L462) | } |
| [463](#L463) | return false; |
| [464](#L464) | } |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | return false; |
| [468](#L468) |  |
| [469](#L469) | } |
| [470](#L470) | public function openai\_response\_callback() { |
| [471](#L471) | // $nonce =  sanitize\_text\_field($\_POST['nonce']); |
| [472](#L472) | // if (! wp\_verify\_nonce($nonce,'qcsecretbotnonceval123qc')) { |
| [473](#L473) | //     wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
| [474](#L474) | //     wp\_die(); |
| [475](#L475) |  |
| [476](#L476) | // }else{ |
| [477](#L477) | $response['status'] = 'success'; |
| [478](#L478) | $response['message'] ='A preset message'; |
| [479](#L479) | $OpenAI =  new qcld\_wp\_OpenAI(); |
| [480](#L480) | $gptkeyword = []; |
| [481](#L481) | $keyword = sanitize\_text\_field($\_POST['keyword']); |
| [482](#L482) | $relevant\_pagelink = $this->relevant\_pagelink($keyword); |
| [483](#L483) |  |
| [484](#L484) | $relevant\_pagelink = array\_slice($relevant\_pagelink, 0, 5, true); |
| [485](#L485) |  |
| [486](#L486) | if( (get\_option('page\_suggestion\_enabled') == '1') && count($relevant\_pagelink) > 0 ){ |
| [487](#L487) |  |
| [488](#L488) | $relevant\_post\_link = get\_option('qlcd\_wp\_chatbot\_relevant\_post\_link\_openai'); |
| [489](#L489) |  |
| [490](#L490) | if(is\_array($relevant\_post\_link )){ |
| [491](#L491) |  |
| [492](#L492) | $relevant\_pagelinks = '<br><br><p><em>'. implode('', $relevant\_post\_link) .'</em></p><ul style="list-style: disc;padding-left: 10px;">'. implode(" ", $relevant\_pagelink). '</ul>'; |
| [493](#L493) | }else{ |
| [494](#L494) | $relevant\_pagelinks = '<br><br><p><em>'. $relevant\_post\_link .'</em></p><ul style="list-style: disc;padding-left: 10px;">'. implode(" ", $relevant\_pagelink) .'</ul>'; |
| [495](#L495) | } |
| [496](#L496) | }else{ |
| [497](#L497) | $relevant\_pagelinks = ''; |
| [498](#L498) | } |
| [499](#L499) | if(get\_option( 'is\_asst\_enabled') != 1){ |
| [500](#L500) | $response\_files = $this->openai\_retrive\_fine\_tune($keyword); |
| [501](#L501) | $response\_file = json\_decode($response\_files, true); |
| [502](#L502) | $gptkeywords = []; |
| [503](#L503) | if((empty($response\_file['choices'][0]["text"])) && empty($response\_file['choices'][0]["message"]['content'])){ |
| [504](#L504) | array\_push( $gptkeyword, array( |
| [505](#L505) | "role" => "system", |
| [506](#L506) | "content" =>   get\_option('qcld\_openai\_system\_content') |
| [507](#L507) | )); |
| [508](#L508) | array\_push($gptkeyword, array( |
| [509](#L509) | "role" => "user", |
| [510](#L510) | "content" =>  $keyword |
| [511](#L511) | )); |
| [512](#L512) | if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '1') ){ |
| [513](#L513) | $prompts =  $this->include\_exclude\_prompt($keyword); |
| [514](#L514) |  |
| [515](#L515) | $gptkeyword = []; |
| [516](#L516) | array\_push($gptkeyword, array( |
| [517](#L517) | "role" => "user", |
| [518](#L518) | "content" =>  $prompts, |
| [519](#L519) | )); |
| [520](#L520) | }else if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '0')){ |
| [521](#L521) | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
| [522](#L522) |  |
| [523](#L523) | $response['message'] = 'Sorry, No result found!'; |
| [524](#L524) | echo json\_encode($response); |
| [525](#L525) | wp\_die(); |
| [526](#L526) | }else{ |
| [527](#L527) | array\_push($gptkeyword, array( |
| [528](#L528) | "role" => "user", |
| [529](#L529) | "content" =>  $keyword |
| [530](#L530) | )); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | } |
| [534](#L534) | $res = $OpenAI->gptcomplete( |
| [535](#L535) | $gptkeyword |
| [536](#L536) | ); |
| [537](#L537) | $mess = json\_decode($res); |
| [538](#L538) | $Parsedown = new Parsedown(); |
| [539](#L539) | $msg = $mess->choices[0]->message->content; |
| [540](#L540) | $msg = $Parsedown->text($msg); |
| [541](#L541) | $response['message'] = $msg ; |
| [542](#L542) | if(($response['message'] == 'DUH.') || ($response['message'] == 'DUH')){ |
| [543](#L543) | $response['message'] = 'Sorry, No result found!'; |
| [544](#L544) | }else{ |
| [545](#L545) | $Parsedown = new Parsedown(); |
| [546](#L546) | $msg = $mess->choices[0]->message->content; |
| [547](#L547) | $msg = $Parsedown->text($msg); |
| [548](#L548) | $response['message'] = $msg . $relevant\_pagelinks; |
| [549](#L549) | } |
| [550](#L550) | }else if(!empty($response\_file['choices'][0]["message"]['content'])){ |
| [551](#L551) | $result = $response\_file['choices'][0]["message"]['content']; |
| [552](#L552) | $Parsedown = new Parsedown(); |
| [553](#L553) | $msg = preg\_replace("/\r\n|\r|\n/", '<br/>',$result); |
| [554](#L554) | $response['message'] = $msg . $relevant\_pagelinks; |
| [555](#L555) | }else{ |
| [556](#L556) | $result = $response\_file['choices'][0]["text"]; |
| [557](#L557) | $message = explode(">",$result); |
| [558](#L558) | if(empty($message)){ |
| [559](#L559) | $message = $result; |
| [560](#L560) | }elseif(empty($message[1])){ |
| [561](#L561) | $message = $message[0]; |
| [562](#L562) | }else{ |
| [563](#L563) | $message = $message[1]; |
| [564](#L564) | } |
| [565](#L565) | $Parsedown = new Parsedown(); |
| [566](#L566) | $msg = preg\_replace("/\r\n|\r|\n/", '<br/>',$message); |
| [567](#L567) | $message = $Parsedown->text($msg); |
| [568](#L568) | if(get\_option('conversation\_continuity') == 1){ |
| [569](#L569) | $lasfivecookie = $\_COOKIE["last\_five\_prompt"] . $message . '###'; |
| [570](#L570) | setcookie('last\_five\_prompt', $lasfivecookie, time() + (60000), "/"); |
| [571](#L571) | $response['cookie'] =  $lasfivecookie; |
| [572](#L572) | } |
| [573](#L573) | $response['message'] = $message . $relevant\_pagelinks; |
| [574](#L574) | } |
| [575](#L575) | }else{ |
| [576](#L576) | $url = 'https://api.openai.com/v1/threads'; |
| [577](#L577) | $api\_key = get\_option('open\_ai\_api\_key'); |
| [578](#L578) | $engines = get\_option( 'openai\_engines'); |
| [579](#L579) |  |
| [580](#L580) | $header  = [ |
| [581](#L581) | 'Content-Type: application/json', |
| [582](#L582) | 'OpenAI-Beta: assistants=v1', |
| [583](#L583) | 'Authorization: Bearer ' . $api\_key |
| [584](#L584) | ]; |
| [585](#L585) | //  $threads\_id = ''; |
| [586](#L586) | $threads\_id\_COOKIE = $\_COOKIE["qcld\_threads\_id"]; |
| [587](#L587) | $threads\_id = $threads\_id\_COOKIE; |
| [588](#L588) | if(($threads\_id == '')){ |
| [589](#L589) |  |
| [590](#L590) | $ch = curl\_init(); |
| [591](#L591) | curl\_setopt($ch, CURLOPT\_URL, $url); |
| [592](#L592) | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
| [593](#L593) | curl\_setopt($ch, CURLOPT\_POST, 1); |
| [594](#L594) | //    curl\_setopt($ch, CURLOPT\_POSTFIELDS, json\_encode($post\_fields)); |
| [595](#L595) | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $header); |
| [596](#L596) | $threads = curl\_exec($ch); |
| [597](#L597) | $threads\_id = json\_decode($threads)->id; |
| [598](#L598) | setcookie('qcld\_threads\_id',$threads\_id  , time() + (60000), "/"); |
| [599](#L599) | if (curl\_errno($ch)) { |
| [600](#L600) | // phpcs:ignore |
| [601](#L601) | echo 'Error: ' . curl\_error($ch); |
| [602](#L602) | } |
| [603](#L603) | curl\_close($ch); |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | $msg = $this->add\_on\_thrrads($threads\_id,$keyword); |
| [607](#L607) | $Parsedown = new Parsedown(); |
| [608](#L608) | $msg = preg\_replace("/\r\n|\r|\n/", '<br/>',$msg); |
| [609](#L609) | $message = $Parsedown->text($msg); |
| [610](#L610) | $response['message'] = $message . $relevant\_pagelinks; |
| [611](#L611) |  |
| [612](#L612) | } |
| [613](#L613) | echo json\_encode($response); |
| [614](#L614) | wp\_die(); |
| [615](#L615) | //} |
| [616](#L616) | } |
| [617](#L617) | public function openai\_settings\_option\_callback() { |
| [618](#L618) | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
| [619](#L619) |  |
| [620](#L620) | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
| [621](#L621) | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
| [622](#L622) | wp\_die(); |
| [623](#L623) |  |
| [624](#L624) | }else{ |
| [625](#L625) |  |
| [626](#L626) | $api\_key = sanitize\_text\_field($\_POST['api\_key']); |
| [627](#L627) | $openai\_engines = sanitize\_text\_field($\_POST['openai\_engines']); |
| [628](#L628) | $qcld\_openai\_prompt = sanitize\_text\_field($\_POST['qcld\_openai\_prompt']); |
| [629](#L629) | $max\_tokens = sanitize\_text\_field($\_POST['max\_tokens']); |
| [630](#L630) | $qcld\_openai\_suffix = (!empty($\_POST['qcld\_openai\_suffix'])) ? sanitize\_text\_field($\_POST['qcld\_openai\_suffix']) : ''; |
| [631](#L631) | $qcld\_openai\_custom\_model = sanitize\_text\_field($\_POST['qcld\_openai\_custom\_model']); |
| [632](#L632) | $frequency\_penalty = sanitize\_text\_field($\_POST['frequency\_penalty']); |
| [633](#L633) | $presence\_penalty = sanitize\_text\_field($\_POST['presence\_penalty']); |
| [634](#L634) | $temperature = sanitize\_text\_field($\_POST['temperature']); |
| [635](#L635) | $ai\_enabled = sanitize\_text\_field($\_POST['ai\_enabled']); |
| [636](#L636) | $suggestion\_enabled = sanitize\_text\_field($\_POST['is\_page\_suggestion\_enabled']); |
| [637](#L637) | $is\_relevant\_enabled = sanitize\_text\_field($\_POST['is\_relevant\_enabled']); |
| [638](#L638) | $file\_id = (!empty($\_POST['file\_id'])) ? sanitize\_text\_field($\_POST['file\_id']) : ''; |
| [639](#L639) | $qcld\_openai\_prompt\_custom = sanitize\_text\_field($\_POST['qcld\_openai\_prompt\_custom']); |
| [640](#L640) | $conversation\_continuity = sanitize\_text\_field($\_POST['conversation\_continuity']); |
| [641](#L641) | $qcld\_openai\_system\_content = sanitize\_text\_field($\_POST['qcld\_openai\_system\_content']); |
| [642](#L642) | /\* Customized by Kadir on 05-12-2023 : To set empty value for API field \*/ |
| [643](#L643) |  |
| [644](#L644) | $disable\_ss = sanitize\_text\_field($\_POST['disable\_ss']); |
| [645](#L645) |  |
| [646](#L646) | if($api\_key  != ''){ |
| [647](#L647) | update\_option( 'open\_ai\_api\_key', $api\_key ); |
| [648](#L648) | } |
| [649](#L649) | else{ |
| [650](#L650) | delete\_option( 'open\_ai\_api\_key'); |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | /\* Ends: Customized by Kadir on 05-12-2023 : To set empty value for API field \*/ |
| [654](#L654) |  |
| [655](#L655) | if($openai\_engines  != ''){ |
| [656](#L656) | update\_option( 'openai\_engines', $openai\_engines ); |
| [657](#L657) | } |
| [658](#L658) | if($conversation\_continuity  != ''){ |
| [659](#L659) | update\_option( 'conversation\_continuity', $conversation\_continuity ); |
| [660](#L660) | } |
| [661](#L661) | update\_option( 'openai\_max\_tokens', $max\_tokens ); |
| [662](#L662) |  |
| [663](#L663) | if($qcld\_openai\_suffix != ''){ |
| [664](#L664) | update\_option('qcld\_openai\_suffix', $qcld\_openai\_suffix); |
| [665](#L665) | } |
| [666](#L666) | if($frequency\_penalty  != ''){ |
| [667](#L667) | update\_option( 'frequency\_penalty', $frequency\_penalty ); |
| [668](#L668) | } |
| [669](#L669) | if($presence\_penalty  != ''){ |
| [670](#L670) | update\_option( 'presence\_penalty', $presence\_penalty ); |
| [671](#L671) | } |
| [672](#L672) | if($temperature  != ''){ |
| [673](#L673) | update\_option( 'openai\_temperature', $temperature ); |
| [674](#L674) | } |
| [675](#L675) | if($qcld\_openai\_prompt\_custom  != ''){ |
| [676](#L676) | update\_option('qcld\_openai\_prompt\_custom', $qcld\_openai\_prompt\_custom ); |
| [677](#L677) | } |
| [678](#L678) | update\_option('qcld\_openai\_custom\_model',$qcld\_openai\_custom\_model); |
| [679](#L679) | update\_option('qcld\_openai\_system\_content', stripslashes( $qcld\_openai\_system\_content)); |
| [680](#L680) | update\_option('ai\_enabled',$ai\_enabled); |
| [681](#L681) | update\_option('qcld\_openai\_relevant\_enabled',$is\_relevant\_enabled); |
| [682](#L682) | update\_option('page\_suggestion\_enabled',$suggestion\_enabled); |
| [683](#L683) | if($file\_id  != ''){ |
| [684](#L684) | update\_option('file\_id',$file\_id); |
| [685](#L685) | } |
| [686](#L686) | $openai\_include\_keyword = sanitize\_text\_field($\_POST['openai\_include\_keyword']); |
| [687](#L687) | update\_option('openai\_include\_keyword',$openai\_include\_keyword); |
| [688](#L688) | $openai\_exclude\_keyword = sanitize\_text\_field($\_POST['openai\_exclude\_keyword']); |
| [689](#L689) | update\_option('openai\_exclude\_keyword',$openai\_exclude\_keyword); |
| [690](#L690) |  |
| [691](#L691) |  |
| [692](#L692) | /\* Customized by Kadir on 05-12-2023 : To Disable Site Search\*/ |
| [693](#L693) | //Disable Site Search |
| [694](#L694) | if( $disable\_ss == 1 ){ |
| [695](#L695) | update\_option('disable\_wp\_chatbot\_site\_search',1); |
| [696](#L696) | } |
| [697](#L697) | /\* Ends: Customized by Kadir on 05-12-2023 : To Disable Site Search\*/ |
| [698](#L698) |  |
| [699](#L699) |  |
| [700](#L700) |  |
| [701](#L701) | } |
| [702](#L702) | if($qcld\_openai\_prompt != ''){ |
| [703](#L703) | update\_option('qcld\_openai\_prompt', $qcld\_openai\_prompt); |
| [704](#L704) | } |
| [705](#L705) | $tem = get\_option( 'openai\_temperature', $temperature ); |
| [706](#L706) |  |
| [707](#L707) | echo json\_encode($ai\_enabled);wp\_die(); |
| [708](#L708) |  |
| [709](#L709) | } |
| [710](#L710) | public function qcpd\_remove\_wa\_stopwords($query, $stopwords){ |
| [711](#L711) |  |
| [712](#L712) | return preg\_replace('/\b('.implode('|',$stopwords).')\b/','',$query); |
| [713](#L713) |  |
| [714](#L714) | } |
| [715](#L715) | public function openai\_troubleshooting(){ |
| [716](#L716) | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
| [717](#L717) | $OpenAI =  new qcld\_wp\_OpenAI(); |
| [718](#L718) | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
| [719](#L719) | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
| [720](#L720) | wp\_die(); |
| [721](#L721) |  |
| [722](#L722) | }else{ |
| [723](#L723) | $gptkeyword = []; |
| [724](#L724) | array\_push($gptkeyword, array( |
| [725](#L725) | "role" => "user", |
| [726](#L726) | "content" =>  "Is our request comes from openAI ?" |
| [727](#L727) | )); |
| [728](#L728) | $res = $OpenAI->gptcomplete( |
| [729](#L729) | $gptkeyword |
| [730](#L730) | ); |
| [731](#L731) | if(empty(json\_decode($res)->error)){ |
| [732](#L732) | $mess = json\_decode($res); |
| [733](#L733) | $msg = preg\_replace("/\r\n|\r|\n/", '<br/>',$mess->choices[0]->message->content); |
| [734](#L734) | wp\_send\_json(array('success' => true,'title' => esc\_html\_\_('success', 'sm'),'icon'=>esc\_html\_\_('alert-success', 'sm'),'msg' => esc\_html\_\_($msg, 'sm'))); |
| [735](#L735) | }else{ |
| [736](#L736) |  |
| [737](#L737) | wp\_send\_json(array('success' => true,'title' => esc\_html\_\_('Error', 'sm'),'icon'=>esc\_html\_\_('error', 'sm'), 'msg' => esc\_html\_\_(json\_decode($res)->error->message, 'sm'))); |
| [738](#L738) | } |
| [739](#L739) | } |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) |  |
| [743](#L743) | } |
| [744](#L744) |  |
| [745](#L745) | /\*\* |
| [746](#L746) | \* @return qcld\_wpopenai\_addon |
| [747](#L747) | \*/ |
| [748](#L748) | if(!function\_exists('qcld\_wpopenai\_addons')){ |
| [749](#L749) | function qcld\_openais() { |
| [750](#L750) | $qcld\_wpopenai\_addon = new qcld\_wpopenai\_addons(); |
| [751](#L751) | return $qcld\_wpopenai\_addon->instance(); |
| [752](#L752) |  |
| [753](#L753) | } |
| [754](#L754) | } |
| [755](#L755) |  |
| [756](#L756) | //fire off the plugin |
| [757](#L757) | qcld\_openais(); |
| [758](#L758) |  |
| [759](#L759) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?format=txt)
* [Original Format](/export/3222434/chatbot/trunk/includes/openai/qcld-bot-openai.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from packetstormsecurity.com_560258f3_20250114_181946.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



=== Content from plugins.trac.wordpress.org_1ae558a4_20250114_181956.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2977505%2540chatbot%252Ftrunk%26old%3D2967435%2540chatbot%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2967435/chatbot/trunk?old=2977505&old_path=%2Fchatbot%2Ftrunk)

---

# Changes in [chatbot/trunk](/browser/chatbot/trunk?rev=2977505 "Show entry in browser") [[2967435:2977505]](/log/chatbot/trunk?rev=2977505&stop_rev=2967435 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[chatbot/trunk](/browser/chatbot/trunk?rev=2977505)
Files:

14 edited

* [functions.php](/browser/chatbot/trunk/functions.php?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [includes/class-wpbot-gc-download.php](/browser/chatbot/trunk/includes/class-wpbot-gc-download.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [includes/class-wpwbot-cache.php](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [includes/class-wpwbot-table.php](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [includes/openai/admin/settings.php](/browser/chatbot/trunk/includes/openai/admin/settings.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [includes/openai/qcld-bot-openai.php](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505 "Show entry in browser")
  (modified)
  ([6 diffs](#file5 "Show differences"))
* [includes/openai/qcld\_wp\_OpenAI.php](/browser/chatbot/trunk/includes/openai/qcld_wp_OpenAI.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [js/qcld-wp-chatbot-admin.js](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505 "Show entry in browser")
  (modified)
  ([8 diffs](#file7 "Show differences"))
* [js/qcld-wp-chatbot-plugin.js](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file8 "Show differences"))
* [qcld-wpwbot-search.php](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505 "Show entry in browser")
  (modified)
  ([6 diffs](#file9 "Show differences"))
* [qcld-wpwbot.php](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))
* [qcld\_df\_api.php](/browser/chatbot/trunk/qcld_df_api.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file11 "Show differences"))
* [readme.txt](/browser/chatbot/trunk/readme.txt?rev=2977505 "Show entry in browser")
  (modified)
  ([2 diffs](#file12 "Show differences"))
* [templates/app-templates/app-checkout.php](/browser/chatbot/trunk/templates/app-templates/app-checkout.php?rev=2977505 "Show entry in browser")
  (modified)
  ([1 diff](#file13 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [chatbot/trunk/functions.php](/changeset/2977505/chatbot/trunk/functions.php?old=2966995&old_path=chatbot%2Ftrunk%2Ffunctions.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/functions.php")

  | [r2967435](/browser/chatbot/trunk/functions.php?rev=2966995#L1219 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/functions.php?rev=2977505#L1219 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 1219 | 1219 | die(); |
  | 1220 | 1220 | } |
  | 1221 |  | // Order Status part. |
  | 1222 |  | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_check\_user', 'qcld\_wb\_chatbot\_check\_user'); |
  | 1223 |  | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_check\_user', 'qcld\_wb\_chatbot\_check\_user'); |
  | 1224 |  | function qcld\_wb\_chatbot\_check\_user(){ |
  | 1225 |  | global $wpcommerce; |
  | 1226 |  | $user\_name = trim(sanitize\_text\_field($\_POST['user\_name'])); |
  | 1227 |  | $response = array(); |
  | 1228 |  | $response['message'] = ""; |
  | 1229 |  | if (username\_exists($user\_name)) { |
  | 1230 |  | if (get\_option('qlcd\_wp\_chatbot\_order\_user') == 'login') { |
  | 1231 |  | $response['status'] = "success"; |
  | 1232 |  | $response['message'] .= wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_username\_thanks')))); |
  | 1233 |  | $response['html'] .= '<p>' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_username\_password')))) . '</p>'; |
  | 1234 |  | } else if (get\_option('qlcd\_wp\_chatbot\_order\_user') == 'not\_login') { |
  | 1235 |  | $response = get\_order\_by\_username($user\_name); |
  | 1236 |  | } |
  | 1237 |  | } else { |
  | 1238 |  | $response['status'] = "fail"; |
  | 1239 |  | $response['message'] .= '<strong>' . $user\_name . '</strong> ' . wp\_kses\_post(wpb\_randmom\_message\_handle(unserialize(get\_option('qlcd\_wp\_chatbot\_order\_username\_not\_exist')))); |
  | 1240 |  | } |
  | 1241 |  | wp\_send\_json($response); |
  | 1242 |  | die(); |
  | 1243 |  | } |
  |  | 1221 | // Order Status part. removed |
  |  | 1222 |  |
  | 1244 | 1223 | function wpb\_randmom\_message\_handle($items){ |
  | 1245 | 1224 | return $items[rand(0, count($items) - 1)]; |
  | […](/browser/chatbot/trunk/functions.php?rev=2966995#L1758) | […](/browser/chatbot/trunk/functions.php?rev=2977505#L1737) |  |
  | 1758 | 1737 |  |
  | 1759 | 1738 | //User login on Checkout page. |
  | 1760 |  | add\_action('wp\_ajax\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
  | 1761 |  | add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
  | 1762 |  | function qcld\_wb\_chatbot\_checkout\_user\_login(){ |
  | 1763 |  | // Nonce is checked, get the POST data and sign user on |
  | 1764 |  | $info = array(); |
  | 1765 |  | //$info['nonce'] = $\_POST['nonce\_val']; |
  | 1766 |  | $info['user\_login'] = trim(sanitize\_text\_field($\_POST['user\_name'])); |
  | 1767 |  | $info['user\_password'] = trim(sanitize\_text\_field($\_POST['user\_pass'])); |
  | 1768 |  | $info['remember'] = true; |
  | 1769 |  | $user\_signon = wp\_signon($info, false); |
  | 1770 |  | // $response=$info; |
  | 1771 |  | $response = array(); |
  | 1772 |  | if (is\_wp\_error($user\_signon)) { |
  | 1773 |  | // $response['status'] = "fail"; |
  | 1774 |  | $response = "no"; |
  | 1775 |  | } else { |
  | 1776 |  | $response = "yes"; |
  | 1777 |  | } |
  | 1778 |  | wp\_send\_json($response); |
  | 1779 |  | } |
  |  | 1739 | // add\_action('wp\_ajax\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
  |  | 1740 | // add\_action('wp\_ajax\_nopriv\_qcld\_wb\_chatbot\_checkout\_user\_login', 'qcld\_wb\_chatbot\_checkout\_user\_login'); |
  |  | 1741 | // function qcld\_wb\_chatbot\_checkout\_user\_login(){ |
  |  | 1742 | //     // Nonce is checked, get the POST data and sign user on |
  |  | 1743 | //     $info = array(); |
  |  | 1744 | //     //$info['nonce'] = $\_POST['nonce\_val']; |
  |  | 1745 | //     $info['user\_login'] = trim(sanitize\_text\_field($\_POST['user\_name'])); |
  |  | 1746 | //     $info['user\_password'] = trim(sanitize\_text\_field($\_POST['user\_pass'])); |
  |  | 1747 | //     $info['remember'] = true; |
  |  | 1748 | //     $user\_signon = wp\_signon($info, false); |
  |  | 1749 | //     // $response=$info; |
  |  | 1750 | //     $response = array(); |
  |  | 1751 | //     if (is\_wp\_error($user\_signon)) { |
  |  | 1752 | //         // $response['status'] = "fail"; |
  |  | 1753 | //         $response = "no"; |
  |  | 1754 | //     } else { |
  |  | 1755 | //         $response = "yes"; |
  |  | 1756 | //     } |
  |  | 1757 | //     wp\_send\_json($response); |
  |  | 1758 | // } |
  | 1780 | 1759 | // Load template for App Order Thank You page url |
  | 1781 | 1760 | function wp\_chatbot\_load\_app\_template($template){ |
* ## [chatbot/trunk/includes/class-wpbot-gc-download.php](/changeset/2977505/chatbot/trunk/includes/class-wpbot-gc-download.php?old=2537910&old_path=chatbot%2Ftrunk%2Fincludes%2Fclass-wpbot-gc-download.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/class-wpbot-gc-download.php")

  | [r2967435](/browser/chatbot/trunk/includes/class-wpbot-gc-download.php?rev=2537910#L46 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/class-wpbot-gc-download.php?rev=2977505#L46 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 46 | 46 |  |
  | 47 | 47 | public function downloadgc(){ |
  | 48 |  | $gcdirectory = QCLD\_wpCHATBOT\_GC\_DIRNAME; |
  |  | 48 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 49 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 50 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 51 | wp\_die(); |
  | 49 | 52 |  |
  | 50 |  | if ( ! is\_dir( $gcdirectory ) ) { |
  | 51 |  | $this->create\_folder( $gcdirectory ); |
  | 52 |  | } |
  | 53 |  | if(!file\_exists($gcdirectory.'/index.php')){ |
  | 54 |  | $this->create\_file( $gcdirectory.'/index.php' ); |
  |  | 53 | }else{ |
  |  | 54 | $gcdirectory = QCLD\_wpCHATBOT\_GC\_DIRNAME; |
  |  | 55 |  |
  |  | 56 | if ( ! is\_dir( $gcdirectory ) ) { |
  |  | 57 | $this->create\_folder( $gcdirectory ); |
  |  | 58 | } |
  |  | 59 | if(!file\_exists($gcdirectory.'/index.php')){ |
  |  | 60 | $this->create\_file( $gcdirectory.'/index.php' ); |
  |  | 61 | } |
  |  | 62 |  |
  |  | 63 | if(is\_dir($gcdirectory)){ |
  |  | 64 |  |
  |  | 65 | $zipFile = $gcdirectory."/".$this->filename; // Local Zip File Path |
  |  | 66 | $zipResource = fopen($zipFile, "w"); |
  |  | 67 | // Get The Zip File From Server |
  |  | 68 | $ch = curl\_init(); |
  |  | 69 | curl\_setopt($ch, CURLOPT\_URL, $this->download\_url); |
  |  | 70 | curl\_setopt($ch, CURLOPT\_FAILONERROR, true); |
  |  | 71 | curl\_setopt($ch, CURLOPT\_HEADER, 0); |
  |  | 72 | curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, true); |
  |  | 73 | curl\_setopt($ch, CURLOPT\_AUTOREFERER, true); |
  |  | 74 | curl\_setopt($ch, CURLOPT\_BINARYTRANSFER,true); |
  |  | 75 | curl\_setopt($ch, CURLOPT\_TIMEOUT, 10); |
  |  | 76 | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 0); |
  |  | 77 | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, 0); |
  |  | 78 | curl\_setopt($ch, CURLOPT\_FILE, $zipResource); |
  |  | 79 | $page = curl\_exec($ch); |
  |  | 80 | if(!$page) { |
  |  | 81 | $response = array('status'=>'error','content'=> curl\_error($ch)); |
  |  | 82 | echo wp\_send\_json($response); |
  |  | 83 | wp\_die(); |
  |  | 84 | } |
  |  | 85 | curl\_close($ch); |
  |  | 86 | $response = array('status'=>'success','content'=> 'File downloaded successfully'); |
  |  | 87 | }else{ |
  |  | 88 | $response = array('status'=>'error','content'=> 'Server does not allow to create files and folders'); |
  |  | 89 | } |
  |  | 90 |  |
  |  | 91 | echo wp\_send\_json($response); |
  |  | 92 | wp\_die(); |
  | 55 | 93 | } |
  | 56 |  |  |
  | 57 |  | ~~if(is\_dir($gcdirectory)){~~ |
  | 58 |  |  |
  | 59 |  | ~~$zipFile = $gcdirectory."/".$this->filename; // Local Zip File Path~~ |
  | 60 |  | ~~$zipResource = fopen($zipFile, "w");~~ |
  | 61 |  | ~~// Get The Zip File From Server~~ |
  | 62 |  | ~~$ch = curl\_init();~~ |
  | 63 |  | ~~curl\_setopt($ch, CURLOPT\_URL, $this->download\_url);~~ |
  | 64 |  | ~~curl\_setopt($ch, CURLOPT\_FAILONERROR, true);~~ |
  | 65 |  | ~~curl\_setopt($ch, CURLOPT\_HEADER, 0);~~ |
  | 66 |  | ~~curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, true);~~ |
  | 67 |  | ~~curl\_setopt($ch, CURLOPT\_AUTOREFERER, true);~~ |
  | 68 |  | ~~curl\_setopt($ch, CURLOPT\_BINARYTRANSFER,true);~~ |
  | 69 |  | ~~curl\_setopt($ch, CURLOPT\_TIMEOUT, 10);~~ |
  | 70 |  | ~~curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 0);~~ |
  | 71 |  | ~~curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, 0);~~ |
  | 72 |  | ~~curl\_setopt($ch, CURLOPT\_FILE, $zipResource);~~ |
  | 73 |  | ~~$page = curl\_exec($ch);~~ |
  | 74 |  | ~~if(!$page) {~~ |
  | 75 |  | ~~$response = array('status'=>'error','content'=> curl\_error($ch));~~ |
  | 76 |  | ~~echo wp\_send\_json($response);~~ |
  | 77 |  | ~~wp\_die();~~ |
  | 78 |  | ~~}~~ |
  | 79 |  | ~~curl\_close($ch);~~ |
  | 80 |  | ~~$response = array('status'=>'success','content'=> 'File downloaded successfully');~~ |
  | 81 |  | ~~}else{~~ |
  | 82 |  | ~~$response = array('status'=>'error','content'=> 'Server does not allow to create files and folders');~~ |
  | 83 |  | ~~}~~ |
  | 84 |  |  |
  | 85 |  | ~~echo wp\_send\_json($response);~~ |
  | 86 |  | ~~wp\_die();~~ |
  | 87 | 94 | } |
  | 88 | 95 |  |
  | 89 | 96 | function extractgc(){ |
  | 90 |  | $gcdirectory = QCLD\_wpCHATBOT\_GC\_DIRNAME; |
  | 91 |  | $gcfilename = QCLD\_wpCHATBOT\_GC\_DIRNAME.'/'.$this->filename; |
  | 92 |  | /\* Open the Zip file \*/ |
  | 93 |  | $zip = new ZipArchive; |
  | 94 |  | $extractPath = "path\_to\_extract"; |
  | 95 |  | if($zip->open($gcfilename) != "true"){ |
  | 96 |  | $response = array('status'=>'error','content'=> 'File Not Found!'); |
  |  | 97 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 98 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 99 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 100 | wp\_die(); |
  |  | 101 |  |
  |  | 102 | }else{ |
  |  | 103 | $gcdirectory = QCLD\_wpCHATBOT\_GC\_DIRNAME; |
  |  | 104 | $gcfilename = QCLD\_wpCHATBOT\_GC\_DIRNAME.'/'.$this->filename; |
  |  | 105 | /\* Open the Zip file \*/ |
  |  | 106 | $zip = new ZipArchive; |
  |  | 107 | $extractPath = "path\_to\_extract"; |
  |  | 108 | if($zip->open($gcfilename) != "true"){ |
  |  | 109 | $response = array('status'=>'error','content'=> 'File Not Found!'); |
  |  | 110 | echo wp\_send\_json($response); |
  |  | 111 | wp\_die(); |
  |  | 112 | } |
  |  | 113 | /\* Extract Zip File \*/ |
  |  | 114 | $zip->extractTo($gcdirectory); |
  |  | 115 | $zip->close(); |
  |  | 116 | @unlink($gcfilename); |
  |  | 117 | $response = array('status'=>'success','content'=> 'Files Extracted successfully!'); |
  | 97 | 118 | echo wp\_send\_json($response); |
  | 98 | 119 | wp\_die(); |
  | 99 |  | } |
  | 100 |  | /\* Extract Zip File \*/ |
  | 101 |  | $zip->extractTo($gcdirectory); |
  | 102 |  | $zip->close(); |
  | 103 |  | @unlink($gcfilename); |
  | 104 |  | $response = array('status'=>'success','content'=> 'Files Extracted successfully!'); |
  | 105 |  | echo wp\_send\_json($response); |
  | 106 |  | wp\_die(); |
  | 107 |  |  |
  |  | 120 | } |
  | 108 | 121 | } |
  | 109 | 122 | } |
* ## [chatbot/trunk/includes/class-wpwbot-cache.php](/changeset/2977505/chatbot/trunk/includes/class-wpwbot-cache.php?old=1933241&old_path=chatbot%2Ftrunk%2Fincludes%2Fclass-wpwbot-cache.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/class-wpwbot-cache.php")

  | [r2967435](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=1933241#L35 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=2977505#L35 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 35 | 35 | global $wpdb; |
  | 36 | 36 | $this->cache\_table\_name = $wpdb->prefix . QCLD\_wpCHATBOT\_CACHE\_TABLE; |
  | 37 |  | ~~add\_action( 'aws\_cache\_clear', array( $this, 'clear\_cache' ) );~~ |
  | 38 |  | ~~add\_action( 'wp\_ajax\_aws-clear-cache', array( $this, 'clear\_cache' ) );~~ |
  | 39 | 37 | } |
  | 40 | 38 | /\*\* |
  | […](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=1933241#L116) | […](/browser/chatbot/trunk/includes/class-wpwbot-cache.php?rev=2977505#L114) |  |
  | 116 | 114 | return $result; |
  | 117 | 115 | } |
  | 118 |  | /\* |
  | 119 |  | \* Clear cached terms |
  | 120 |  | \*/ |
  | 121 |  | public function clear\_cache() { |
  | 122 |  | global $wpdb; |
  | 123 |  | if ( ! $this->is\_cache\_table\_not\_exist() ) { |
  | 124 |  |  |
  | 125 |  | $terms = "aws\_search\_term\_%"; |
  | 126 |  | $where = $wpdb->prepare( " name LIKE %s", $terms ); |
  | 127 |  | $sql = "DELETE FROM {$this->cache\_table\_name} |
  | 128 |  | WHERE {$where} |
  | 129 |  | "; |
  | 130 |  | $wpdb->query( $sql ); |
  | 131 |  |  |
  | 132 |  | } |
  | 133 |  |  |
  | 134 |  | } |
  |  | 116 |  |
  | 135 | 117 | } |
  | 136 | 118 | endif; |
* ## [chatbot/trunk/includes/class-wpwbot-table.php](/changeset/2977505/chatbot/trunk/includes/class-wpwbot-table.php?old=2177045&old_path=chatbot%2Ftrunk%2Fincludes%2Fclass-wpwbot-table.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/class-wpwbot-table.php")

  | [r2967435](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2177045#L34 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2977505#L34 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 34 | 34 | \* Reindex plugin table |
  | 35 | 35 | \*/ |
  | 36 |  | public function reindex\_table( $return = false ) { |
  | 37 |  | global $wpdb; |
  | 38 |  | $index\_meta = get\_option( 'wp\_chatbot\_index\_meta', false ); |
  | 39 |  | $status = false; |
  | 40 |  | // No current index going on. Let's start over |
  | 41 |  | if ( false === $index\_meta ) { |
  | 42 |  | $status = 'start'; |
  | 43 |  | $index\_meta = array( |
  | 44 |  | 'offset' => 0, |
  | 45 |  | 'start' => true, |
  |  | 36 | public function reindex\_table( $return) { |
  |  | 37 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 38 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 39 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 40 | wp\_die(); |
  |  | 41 |  |
  |  | 42 | }else{ |
  |  | 43 | global $wpdb; |
  |  | 44 | $index\_meta = get\_option( 'wp\_chatbot\_index\_meta', false ); |
  |  | 45 | $status = false; |
  |  | 46 | // No current index going on. Let's start over |
  |  | 47 | if ( false === $index\_meta ) { |
  |  | 48 | $status = 'start'; |
  |  | 49 | $index\_meta = array( |
  |  | 50 | 'offset' => 0, |
  |  | 51 | 'start' => true, |
  |  | 52 | ); |
  |  | 53 | $wpdb->query("DROP TABLE IF EXISTS {$this->table\_name}"); |
  |  | 54 | $this->create\_table(); |
  |  | 55 | $index\_meta['found\_posts'] = $this->get\_number\_of\_products(); |
  |  | 56 | } else if ( ! empty( $index\_meta['site\_stack'] ) && $index\_meta['offset'] >= $index\_meta['found\_posts'] ) { |
  |  | 57 | $status = 'start'; |
  |  | 58 | $index\_meta['start'] = true; |
  |  | 59 | $index\_meta['offset'] = 0; |
  |  | 60 | $index\_meta['current\_site'] = array\_shift( $index\_meta['site\_stack'] ); |
  |  | 61 | } else { |
  |  | 62 | $index\_meta['start'] = false; |
  |  | 63 | } |
  |  | 64 | $index\_meta = apply\_filters( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  |  | 65 | $posts\_per\_page = apply\_filters( 'wp\_chatbot\_index\_posts\_per\_page', 30 ); |
  |  | 66 | $args = array( |
  |  | 67 | 'posts\_per\_page'      => $posts\_per\_page, |
  |  | 68 | 'fields'              => 'ids', |
  |  | 69 | 'post\_type'           => 'product', |
  |  | 70 | 'post\_status'         => 'publish', |
  |  | 71 | 'offset'              => $index\_meta['offset'], |
  |  | 72 | 'ignore\_sticky\_posts' => true, |
  |  | 73 | 'suppress\_filters'    => true, |
  |  | 74 | 'no\_found\_rows'       => 1, |
  |  | 75 | 'orderby'             => 'ID', |
  |  | 76 | 'order'               => 'DESC', |
  | 46 | 77 | ); |
  | 47 |  | $wpdb->query("DROP TABLE IF EXISTS {$this->table\_name}"); |
  | 48 |  | $this->create\_table(); |
  | 49 |  | $index\_meta['found\_posts'] = $this->get\_number\_of\_products(); |
  | 50 |  | } else if ( ! empty( $index\_meta['site\_stack'] ) && $index\_meta['offset'] >= $index\_meta['found\_posts'] ) { |
  | 51 |  | $status = 'start'; |
  | 52 |  | $index\_meta['start'] = true; |
  | 53 |  | $index\_meta['offset'] = 0; |
  | 54 |  | $index\_meta['current\_site'] = array\_shift( $index\_meta['site\_stack'] ); |
  | 55 |  | } else { |
  | 56 |  | $index\_meta['start'] = false; |
  | 57 |  | } |
  | 58 |  | $index\_meta = apply\_filters( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  | 59 |  | $posts\_per\_page = apply\_filters( 'wp\_chatbot\_index\_posts\_per\_page', 30 ); |
  | 60 |  | $args = array( |
  | 61 |  | 'posts\_per\_page'      => $posts\_per\_page, |
  | 62 |  | 'fields'              => 'ids', |
  | 63 |  | 'post\_type'           => 'product', |
  | 64 |  | 'post\_status'         => 'publish', |
  | 65 |  | 'offset'              => $index\_meta['offset'], |
  | 66 |  | 'ignore\_sticky\_posts' => true, |
  | 67 |  | 'suppress\_filters'    => true, |
  | 68 |  | 'no\_found\_rows'       => 1, |
  | 69 |  | 'orderby'             => 'ID', |
  | 70 |  | 'order'               => 'DESC', |
  | 71 |  | ); |
  | 72 |  | $posts = get\_posts( $args ); |
  | 73 |  | if ( $status !== 'start' ) { |
  | 74 |  | if ( $posts && count( $posts ) > 0 ) { |
  | 75 |  | $queued\_posts = array(); |
  | 76 |  | foreach( $posts as $post\_id ) { |
  | 77 |  | $queued\_posts[] = absint( $post\_id ); |
  |  | 78 | $posts = get\_posts( $args ); |
  |  | 79 | if ( $status !== 'start' ) { |
  |  | 80 | if ( $posts && count( $posts ) > 0 ) { |
  |  | 81 | $queued\_posts = array(); |
  |  | 82 | foreach( $posts as $post\_id ) { |
  |  | 83 | $queued\_posts[] = absint( $post\_id ); |
  |  | 84 | } |
  |  | 85 | $this->fill\_table( $queued\_posts ); |
  |  | 86 | $index\_meta['offset'] = absint( $index\_meta['offset'] + $posts\_per\_page ); |
  |  | 87 | if ( $index\_meta['offset'] >= $index\_meta['found\_posts'] ) { |
  |  | 88 | $index\_meta['offset'] = $index\_meta['found\_posts']; |
  |  | 89 | } |
  |  | 90 | update\_option( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  |  | 91 | } else { |
  |  | 92 | // We are done (with this site) |
  |  | 93 | $index\_meta['offset'] = (int) count( $posts ); |
  |  | 94 | delete\_option( 'wp\_chatbot\_index\_meta' ); |
  |  | 95 | update\_option( 'wp\_chatbot\_index\_count', 1 ); |
  | 78 | 96 | } |
  | 79 |  | $this->fill\_table( $queued\_posts ); |
  | 80 |  | $index\_meta['offset'] = absint( $index\_meta['offset'] + $posts\_per\_page ); |
  | 81 |  | if ( $index\_meta['offset'] >= $index\_meta['found\_posts'] ) { |
  | 82 |  | $index\_meta['offset'] = $index\_meta['found\_posts']; |
  | 83 |  | } |
  |  | 97 | } else { |
  | 84 | 98 | update\_option( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  |  | 99 | } |
  |  | 100 | if ( $return ) { |
  |  | 101 | return $index\_meta; |
  | 85 | 102 | } else { |
  | 86 |  | // We are done (with this site) |
  | 87 |  | $index\_meta['offset'] = (int) count( $posts ); |
  | 88 |  | delete\_option( 'wp\_chatbot\_index\_meta' ); |
  | 89 |  | update\_option( 'wp\_chatbot\_index\_count', 1 ); |
  | 90 |  | } |
  | 91 |  | } else { |
  | 92 |  | update\_option( 'wp\_chatbot\_index\_meta', $index\_meta ); |
  | 93 |  | } |
  | 94 |  | if ( $return ) { |
  | 95 |  | return $index\_meta; |
  | 96 |  | } else { |
  | 97 |  | wp\_send\_json\_success( $index\_meta ); |
  |  | 103 | wp\_send\_json\_success( $index\_meta ); |
  |  | 104 | } |
  | 98 | 105 | } |
  | 99 | 106 | } |
  | […](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2177045#L243) | […](/browser/chatbot/trunk/includes/class-wpwbot-table.php?rev=2977505#L250) |  |
  | 243 | 250 | \*/ |
  | 244 | 251 | public function cancel\_reindex() { |
  | 245 |  | delete\_option( 'wp\_chatbot\_index\_meta' ); |
  | 246 |  | wp\_send\_json\_success( 'Deleted!' ); |
  |  | 252 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 253 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 254 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 255 | wp\_die(); |
  |  | 256 |  |
  |  | 257 | }else{ |
  |  | 258 | delete\_option( 'wp\_chatbot\_index\_meta' ); |
  |  | 259 | wp\_send\_json\_success( 'Deleted!' ); |
  |  | 260 | } |
  | 247 | 261 | } |
  | 248 | 262 | /\* |
* ## [chatbot/trunk/includes/openai/admin/settings.php](/changeset/2977505/chatbot/trunk/includes/openai/admin/settings.php?old=2967435&old_path=chatbot%2Ftrunk%2Fincludes%2Fopenai%2Fadmin%2Fsettings.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/openai/admin/settings.php")

  | [r2967435](/browser/chatbot/trunk/includes/openai/admin/settings.php?rev=2967435#L72 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/openai/admin/settings.php?rev=2977505#L72 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 72 | 72 | </div> |
  | 73 | 73 | </div> |
  | 74 |  | <div class="<?php esc\_attr\_e( 'mb-3','wpbot');?>"> |
  | 75 |  | <div class=""> |
  | 76 |  | <label><?php esc\_html\_e('Conversation continuity Only works in promt Q/A, Chat and friend chat'); ?></label> |
  | 77 |  | </div> |
  | 78 |  | <div class="<?php esc\_attr\_e( 'form-check form-switch my-4','wpbot');?>"> |
  | 79 |  | <input class="<?php esc\_attr\_e( 'form-check-input','wpbot');?>" type="checkbox" <?php echo (get\_option( 'conversation\_continuity') == 1) ? esc\_attr( 'checked') : '';?>  role="switch" value="" id="<?php esc\_attr\_e( 'conversation\_continuity','wpbot');?>"> |
  | 80 |  | <label class="<?php esc\_attr\_e( 'form-check-label','wpbot');?>" for="<?php esc\_attr\_e( 'conversation\_continuity','wpbot');?>"><?php esc\_html\_e( 'Enable conversation continuity','wpbot');  ?></label> |
  | 81 |  | </div> |
  | 82 |  | </div> |
  |  | 74 |  |
  | 83 | 75 |  |
  | 84 | 76 | <div class="<?php esc\_attr\_e( 'mb-3','wpbot');?>"> |
* ## [chatbot/trunk/includes/openai/qcld-bot-openai.php](/changeset/2977505/chatbot/trunk/includes/openai/qcld-bot-openai.php?old=2957286&old_path=chatbot%2Ftrunk%2Fincludes%2Fopenai%2Fqcld-bot-openai.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/openai/qcld-bot-openai.php")

  | [r2967435](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L61 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L61 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 61 | 61 | $this->includes(); |
  | 62 | 62 | add\_action('wp\_ajax\_openai\_settings\_option', [$this, 'openai\_settings\_option\_callback']); |
  | 63 |  | ~~add\_action('wp\_ajax\_openai\_file\_upload', [$this, 'openai\_file\_upload\_callback']);~~ |
  | 64 | 63 | add\_action('wp\_ajax\_openai\_response',[$this,'openai\_response\_callback']); |
  | 65 |  | ~~add\_action('wp\_ajax\_openai\_file\_list',[$this,'openai\_file\_list\_callback']);~~ |
  | 66 |  | ~~add\_action('wp\_ajax\_openai\_finetune\_list', [$this,'openai\_finetune\_list']);~~ |
  | 67 |  | ~~add\_action('wp\_ajax\_openai\_file\_delete',[$this,'openai\_file\_delete\_callback']);~~ |
  | 68 | 64 | add\_action('wp\_ajax\_nopriv\_openai\_response', [$this, 'openai\_response\_callback']); |
  | 69 |  | ~~add\_action('wp\_ajax\_openai\_ft\_model\_create', [$this, 'openai\_ft\_model\_create']);~~ |
  | 70 |  | ~~add\_action('wp\_ajax\_openai\_ft\_model\_delete', [$this, 'openai\_ft\_model\_delete']);~~ |
  | 71 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_post\_data\_converter\_count', [$this,'qcld\_openai\_post\_data\_converter\_count']);~~ |
  | 72 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_post\_data\_converter', [$this,'qcld\_openai\_post\_data\_converter']);~~ |
  | 73 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_upload\_pagetraining\_file',[$this, 'qcld\_openai\_upload\_pagetraining\_file']);~~ |
  | 74 | 65 | add\_action('wp\_ajax\_qcld\_openai\_image\_generate',[$this, 'qcld\_openai\_image\_generate']); |
  | 75 | 66 | add\_action('wp\_ajax\_openai\_keyword\_suggestion\_content',[$this,'openai\_keyword\_suggestion\_content']); |
  | 76 | 67 | add\_action('wp\_ajax\_qcld\_openai\_image\_generate\_url',[$this,'qcld\_seo\_image\_generate\_url\_functions']); |
  | 77 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_file\_dowload',[$this,'qcld\_openai\_file\_dowload']);~~ |
  | 78 |  | ~~add\_action('wp\_ajax\_qcld\_openai\_delete\_training\_file',[$this,'qcld\_openai\_delete\_training\_file']);~~ |
  | 79 | 68 |  |
  | 80 | 69 | if (is\_admin() && !empty($\_GET["page"]) && (($\_GET["page"] == "openai-panel\_dashboard") || ($\_GET["page"] == "openai-panel\_file") || ($\_GET["page"] == "openai-panel\_help"))) { |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L141) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L130) |  |
  | 141 | 130 |  |
  | 142 | 131 | } |
  | 143 |  | public function openai\_file\_delete\_callback(){ |
  | 144 |  | $file\_id = sanitize\_text\_field($\_POST['file\_id']); |
  | 145 |  | $url = 'https://api.openai.com/v1/files/'. $file\_id; |
  | 146 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 147 |  | $ch = curl\_init(); |
  | 148 |  | curl\_setopt($ch, CURLOPT\_URL, $url); |
  | 149 |  | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
  | 150 |  | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'DELETE'); |
  | 151 |  | $headers = array( |
  | 152 |  | $apt\_key, |
  | 153 |  | ); |
  | 154 |  | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
  | 155 |  | $result = curl\_exec($ch); |
  | 156 |  | if (curl\_errno($ch)) { |
  | 157 |  | echo 'Error:' . curl\_error($ch); |
  | 158 |  | } |
  | 159 |  | curl\_close($ch); |
  | 160 |  | wp\_send\_json( json\_decode($result)); |
  | 161 |  | wp\_die(); |
  | 162 |  | } |
  | 163 |  | public function openai\_ft\_model\_create(){ |
  | 164 |  | $file\_id = sanitize\_text\_field($\_POST['file\_id']); |
  | 165 |  | $ft\_suffix = sanitize\_text\_field($\_POST['ft\_suffix']); |
  | 166 |  | $ft\_engines = sanitize\_text\_field($\_POST['ft\_engines']); |
  | 167 |  | $rel = $this->openai\_finetune\_create($file\_id,$ft\_suffix,$ft\_engines); |
  | 168 |  | // print\_r(wp\_send\_json([$rel]));wp\_die(); |
  | 169 |  | echo wp\_send\_json([$rel]); |
  | 170 |  | wp\_die(); |
  | 171 |  | } |
  | 172 |  | public function qcld\_openai\_file\_dowload(){ |
  | 173 |  |  |
  | 174 |  | //   -H "Authorization: Bearer $OPENAI\_API\_KEY" > results.csv |
  | 175 |  |  |
  | 176 |  | $file\_id = sanitize\_text\_field($\_POST['file\_id']); |
  | 177 |  | $url =  'https://api.openai.com/v1/files/'.$file\_id; |
  | 178 |  | $url1 =  'https://api.openai.com/v1/files/'.$file\_id. '/content'; |
  | 179 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 180 |  | $headers = array( |
  | 181 |  | "Content-Type: application/json", |
  | 182 |  | $apt\_key, |
  | 183 |  | ); |
  | 184 |  | $headers1 = array( |
  | 185 |  | "Content-Type:  file.jsonl", |
  | 186 |  | $apt\_key, |
  | 187 |  | ); |
  | 188 |  | $curl = curl\_init(); |
  | 189 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 190 |  | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  | 191 |  | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  | 192 |  | $result = json\_decode(curl\_exec($curl)); |
  | 193 |  | curl\_close($curl); |
  | 194 |  | $ch = curl\_init(); |
  | 195 |  | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
  | 196 |  | curl\_setopt($ch, CURLOPT\_URL, $url1); |
  | 197 |  | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
  | 198 |  | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'GET'); |
  | 199 |  | //curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  | 200 |  | $res = curl\_exec($ch); |
  | 201 |  | if (curl\_errno($ch)) { |
  | 202 |  | echo 'Error:' . curl\_error($ch); |
  | 203 |  | } |
  | 204 |  | curl\_close($ch); |
  | 205 |  | //  var\_dump($res); |
  | 206 |  | if(!empty($result)){ |
  | 207 |  | $response['status'] = 'success'; |
  | 208 |  | $response['fileinfo'] =  $result; |
  | 209 |  | $response['filedata'] = $res; |
  | 210 |  |  |
  | 211 |  | } |
  | 212 |  | echo wp\_send\_json([$response]); |
  | 213 |  | wp\_die(); |
  | 214 |  |  |
  | 215 |  | } |
  |  | 132 |  |
  | 216 | 133 | public function buildFormBody( $fields, $boundary ) |
  | 217 | 134 | { |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L235) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L152) |  |
  | 235 | 152 | } |
  | 236 | 153 |  |
  | 237 |  | ~~public function openai\_file\_list\_callback(){~~ |
  | 238 |  | ~~$url = 'https://api.openai.com/v1/files';~~ |
  | 239 |  | ~~$apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key');~~ |
  | 240 |  | ~~$curl = curl\_init();~~ |
  | 241 |  | ~~curl\_setopt($curl, CURLOPT\_URL, $url);~~ |
  | 242 |  | ~~$headers = array(~~ |
  | 243 |  | ~~"Content-Type: application/json",~~ |
  | 244 |  | ~~$apt\_key,~~ |
  | 245 |  | ~~);~~ |
  | 246 |  | ~~curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers);~~ |
  | 247 |  | ~~curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true);~~ |
  | 248 |  | ~~$response = curl\_exec($curl);~~ |
  | 249 |  | ~~curl\_close($curl);~~ |
  | 250 |  | ~~wp\_send\_json( json\_decode($response));~~ |
  | 251 |  | ~~wp\_die();~~ |
  | 252 |  | ~~}~~ |
  | 253 | 154 | public function qcld\_sanitize\_text\_or\_array\_field($array\_or\_string) { |
  | 254 | 155 | if( is\_string($array\_or\_string) ){ |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L267) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L168) |  |
  | 267 | 168 | return $array\_or\_string; |
  | 268 | 169 | } |
  | 269 |  | public function qcld\_openai\_post\_data\_converter\_count() |
  | 270 |  | { |
  | 271 |  | global $wpdb; |
  | 272 |  | $qcldopenai\_result = array('status' => 'error'); |
  | 273 |  | if(isset($\_POST['data']) && is\_array($\_POST['data'])){ |
  | 274 |  | $types = Self::qcld\_sanitize\_text\_or\_array\_field($\_POST['data']); |
  | 275 |  | $sql = "SELECT COUNT(\*) FROM ".$wpdb->posts." WHERE post\_status='publish' AND post\_type IN ('".implode("','",$types)."')"; |
  | 276 |  | $qcldopenai\_result['count'] = $wpdb->get\_var($sql); |
  | 277 |  | $qcldopenai\_result['status'] = 'success'; |
  | 278 |  | $qcldopenai\_result['types'] = $types; |
  | 279 |  | } |
  | 280 |  | else $qcldopenai\_result['msg'] = 'Please select least one data to convert'; |
  | 281 |  |  |
  | 282 |  | $this->qcld\_openai\_post\_data\_converter($qcldopenai\_result); |
  | 283 |  | } |
  | 284 |  |  |
  | 285 |  | public function qcld\_openai\_post\_data\_converter($result) |
  | 286 |  | { |
  | 287 |  | $qcldopenai\_result = array('status' => 'error','msg' => 'Something went wrong'); |
  | 288 |  | global $wpdb; |
  | 289 |  | if( |
  | 290 |  | isset($result['types']) |
  | 291 |  | && is\_array($result['types']) |
  | 292 |  | ){ |
  | 293 |  | $types = Self::qcld\_sanitize\_text\_or\_array\_field($result['types']); |
  | 294 |  |  |
  | 295 |  | $qcldopenai\_total = sanitize\_text\_field($\_POST['total']); |
  | 296 |  | $qcldopenai\_per\_page = sanitize\_text\_field($\_POST['per\_page']); |
  | 297 |  | $qcldopenai\_page = isset($\_POST['page']) && !empty($\_POST['page']) ? sanitize\_text\_field($\_POST['page']) : 1; |
  | 298 |  | if(isset($\_POST['file']) && !empty($\_POST['file'])){ |
  | 299 |  | $qcldopenai\_file = sanitize\_text\_field($\_POST['file']); |
  | 300 |  | }else{ |
  | 301 |  | $qcldopenai\_file = md5(time()).'.jsonl'; |
  | 302 |  | } |
  | 303 |  | if(isset($\_POST['id']) && !empty($\_POST['id'])){ |
  | 304 |  | $qcldopenai\_convert\_id = sanitize\_text\_field($\_POST['id']); |
  | 305 |  | }else{ |
  | 306 |  | $qcldopenai\_convert\_id = wp\_insert\_post(array( |
  | 307 |  | 'post\_title' => $qcldopenai\_file, |
  | 308 |  | 'post\_type' => 'qcldopenai\_convert', |
  | 309 |  | 'post\_status' => 'publish' |
  | 310 |  | )); |
  | 311 |  | } try { |
  | 312 |  | $upload  = wp\_upload\_dir(); |
  | 313 |  | $upload\_dir = $upload['basedir'] . '/' . 'qcldopenai\_site\_training'; |
  | 314 |  | $permissions = 0755; |
  | 315 |  | $oldmask = umask(0); |
  | 316 |  | if (!is\_dir($upload\_dir)){ |
  | 317 |  | mkdir($upload\_dir, $permissions); |
  | 318 |  | $umask = umask($oldmask); |
  | 319 |  | $chmod = chmod($upload\_dir, $permissions); |
  | 320 |  | } |
  | 321 |  | $gcdirpath = WP\_CONTENT\_DIR.'/qcldopenai\_site\_training'; |
  | 322 |  | $qcldopenai\_json\_file = fopen(wp\_upload\_dir()['basedir'] .'/qcldopenai\_site\_training/'.basename($qcldopenai\_file), "w"); |
  | 323 |  | $qcldopenai\_content = ''; |
  | 324 |  | $sql = "SELECT post\_title, post\_content FROM ".$wpdb->posts." WHERE post\_status='publish' AND post\_type IN ('".implode("','",$types)."') ORDER BY post\_date"; |
  | 325 |  | $qcldopenai\_data = $wpdb->get\_results($sql); |
  | 326 |  | if($qcldopenai\_data && is\_array($qcldopenai\_data) && count($qcldopenai\_data)){ |
  | 327 |  | foreach($qcldopenai\_data as $item){ |
  | 328 |  | $tag\_less\_content =  wp\_strip\_all\_tags($item->post\_content); |
  | 329 |  | $vc\_tag\_less = preg\_replace("/\[(\/\*)?vc\_(.\*?)\]/", '', $tag\_less\_content); |
  | 330 |  | $clean\_html\_body = preg\_replace('/\xc2\xa0/', '', $vc\_tag\_less); |
  | 331 |  | $completion\_string = str\_replace(array("\n","\r","\t","&nbsp;"), ' ', $clean\_html\_body); |
  | 332 |  | $completion\_string = wp\_trim\_words( $completion\_string,500); |
  | 333 |  |  |
  | 334 |  | $tag\_less\_title =  wp\_strip\_all\_tags($item->post\_title); |
  | 335 |  | $clean\_html\_title = preg\_replace('/\xc2\xa0/', '', $tag\_less\_title); |
  | 336 |  | $title\_string = str\_replace(array("\n","\r","\t","&nbsp;"), ' ', $clean\_html\_title); |
  | 337 |  | $title\_string = wp\_trim\_words( $title\_string,50); |
  | 338 |  | $data = array( |
  | 339 |  | "prompt" => $title\_string.' ->', |
  | 340 |  | "completion" => $completion\_string |
  | 341 |  | ); |
  | 342 |  | fwrite($qcldopenai\_json\_file, json\_encode($data) . PHP\_EOL); |
  |  | 170 |  |
  |  | 171 |  |
  |  | 172 |  |
  |  | 173 | public function qcld\_openai\_image\_generate(){ |
  |  | 174 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 175 | if (! wp\_verify\_nonce($nonce,'wp\_chatbot')) { |
  |  | 176 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 177 | wp\_die(); |
  |  | 178 |  |
  |  | 179 | }else{ |
  |  | 180 | $qcld\_seo\_result = array( |
  |  | 181 | 'status' => 'error', |
  |  | 182 | 'msg'    => 'Something went wrong', |
  |  | 183 | ); |
  |  | 184 | $OPENAI\_API\_KEY = get\_option('open\_ai\_api\_key'); |
  |  | 185 | $qcld\_seo\_prompt                = isset( $\_POST['qcld\_seo\_prompt'] )                ? sanitize\_text\_field( $\_POST['qcld\_seo\_prompt'] )              : ''; |
  |  | 186 | $qcld\_seo\_artist                = isset( $\_POST['qcld\_seo\_artist'] )                ? sanitize\_text\_field( $\_POST['qcld\_seo\_artist'] )              : 'Painter'; |
  |  | 187 | $qcld\_seo\_art\_style             = isset( $\_POST['qcld\_seo\_art\_style'] )             ? sanitize\_text\_field( $\_POST['qcld\_seo\_art\_style'] )           : 'Style'; |
  |  | 188 | $qcld\_seo\_photography\_style     = isset( $\_POST['qcld\_seo\_photography\_style'] )     ? sanitize\_text\_field( $\_POST['qcld\_seo\_photography\_style'] )   : 'Photography Style'; |
  |  | 189 | $qcld\_seo\_lighting              = isset( $\_POST['qcld\_seo\_lighting'] )              ? sanitize\_text\_field( $\_POST['qcld\_seo\_lighting'] )            : 'Lighting'; |
  |  | 190 | $qcld\_seo\_subject               = isset( $\_POST['qcld\_seo\_subject'] )               ? sanitize\_text\_field( $\_POST['qcld\_seo\_subject'] )             : 'Subject'; |
  |  | 191 | $qcld\_seo\_camera\_settings       = isset( $\_POST['qcld\_seo\_camera\_settings'] )       ? sanitize\_text\_field( $\_POST['qcld\_seo\_camera\_settings'] )     : 'Camera Settings'; |
  |  | 192 | $qcld\_seo\_composition           = isset( $\_POST['qcld\_seo\_composition'] )           ? sanitize\_text\_field( $\_POST['qcld\_seo\_composition'] )         : 'Composition'; |
  |  | 193 | $qcld\_seo\_resolution            = isset( $\_POST['qcld\_seo\_resolution'] )            ? sanitize\_text\_field( $\_POST['qcld\_seo\_resolution'] )          : 'Resolution'; |
  |  | 194 | $qcld\_seo\_color                 = isset( $\_POST['qcld\_seo\_color'] )                 ? sanitize\_text\_field( $\_POST['qcld\_seo\_color'] )               : 'Color'; |
  |  | 195 | $qcld\_seo\_special\_effects       = isset( $\_POST['qcld\_seo\_special\_effects'] )       ? sanitize\_text\_field( $\_POST['qcld\_seo\_special\_effects'] )     : 'Special Effects'; |
  |  | 196 | $qcld\_seo\_img\_size              = isset( $\_POST['qcld\_seo\_img\_size'] )              ? sanitize\_text\_field( $\_POST['qcld\_seo\_img\_size'] )            : '512x512'; |
  |  | 197 | $qcld\_seo\_num\_images            = isset( $\_POST['qcld\_seo\_num\_images'] )            ? sanitize\_text\_field( $\_POST['qcld\_seo\_num\_images'] )          : 1; |
  |  | 198 | $qcld\_seo\_num\_images            = isset( $qcld\_seo\_num\_images )                     ? (int) $qcld\_seo\_num\_images                                    : 6; |
  |  | 199 | if (!empty($qcld\_seo\_prompt)) { |
  |  | 200 | // Get the prompt from the form |
  |  | 201 | $prompt         = $qcld\_seo\_prompt; |
  |  | 202 | $img\_size       = $qcld\_seo\_img\_size; |
  |  | 203 | $num\_images     = $qcld\_seo\_num\_images; |
  |  | 204 | // convert num\_images to an integer |
  |  | 205 | $num\_images     = (int) $num\_images; |
  |  | 206 | $prompt\_elements = array( |
  |  | 207 | 'artist'            => $qcld\_seo\_artist, |
  |  | 208 | 'art\_style'         => $qcld\_seo\_art\_style, |
  |  | 209 | 'photography\_style' => $qcld\_seo\_photography\_style, |
  |  | 210 | 'composition'       => $qcld\_seo\_composition, |
  |  | 211 | 'resolution'        => $qcld\_seo\_resolution, |
  |  | 212 | 'color'             => $qcld\_seo\_color, |
  |  | 213 | 'special\_effects'   => $qcld\_seo\_special\_effects, |
  |  | 214 | 'lighting'          => $qcld\_seo\_lighting, |
  |  | 215 | 'subject'           => $qcld\_seo\_subject, |
  |  | 216 | 'camera\_settings'   => $qcld\_seo\_camera\_settings, |
  |  | 217 | ); |
  |  | 218 | foreach ($prompt\_elements as $key => $value) { |
  |  | 219 | if ($\_POST[$key] != "None") { |
  |  | 220 | $prompt = $prompt . ". " . $value . ": " . $\_POST[$key]; |
  | 343 | 221 | } |
  | 344 | 222 | } |
  | 345 |  | fclose($qcldopenai\_json\_file); |
  | 346 |  | $qcldopenai\_result['file'] = $qcldopenai\_file; |
  | 347 |  | $qcldopenai\_result['id'] = $qcldopenai\_convert\_id; |
  | 348 |  | $qcldopenai\_result['status'] = 'success'; |
  | 349 |  | } catch (\Exception $exception){ |
  | 350 |  | $qcldopenai\_result['msg'] = $exception->getMessage(); |
  | 351 |  | } |
  | 352 |  | } |
  | 353 |  | else $qcldopenai\_result['msg'] = 'Please select least one data to convert'; |
  | 354 |  | wp\_send\_json($qcldopenai\_result); |
  | 355 |  | } |
  | 356 |  |  |
  | 357 |  | public function openai\_ft\_model\_delete(){ |
  | 358 |  | $ft\_id = sanitize\_text\_field($\_POST['ft\_id']); |
  | 359 |  | $url = 'https://api.openai.com/v1/models/' . $ft\_id; |
  | 360 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 361 |  | $curl = curl\_init(); |
  | 362 |  | $headers = array( |
  | 363 |  | "Content-Type: multipart/form-data", |
  | 364 |  | $apt\_key, |
  | 365 |  | ); |
  | 366 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 367 |  | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  | 368 |  | curl\_setopt($curl, CURLOPT\_CUSTOMREQUEST, 'DELETE'); |
  | 369 |  | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 370 |  | $res = json\_decode(curl\_exec ($curl)); |
  | 371 |  | curl\_close ($curl); |
  | 372 |  | echo wp\_send\_json([$rel]); |
  | 373 |  | wp\_die(); |
  | 374 |  |  |
  | 375 |  | } |
  | 376 |  | public function qcld\_openai\_upload\_pagetraining\_file(){ |
  | 377 |  |  |
  | 378 |  | if( |
  | 379 |  | isset($\_POST['filename']) |
  | 380 |  | && !empty($\_POST['filename']) |
  | 381 |  | ){ |
  | 382 |  | $filename = sanitize\_text\_field($\_POST['filename']); |
  | 383 |  | $line = isset($\_POST['line']) && !empty($\_POST['line']) ? sanitize\_text\_field($\_POST['line']) : 0; |
  | 384 |  | $file =   wp\_upload\_dir()['basedir'].'/qcldopenai\_site\_training/'.$filename; |
  | 385 |  | if(file\_exists($file)){ |
  | 386 |  | $qcld\_openai\_lines = file($file); |
  | 387 |  | $fileo =  '@'. wp\_upload\_dir()['basedir'].'/qcldopenai\_site\_training/'.$filename; |
  | 388 |  | $split\_file = wp\_upload\_dir()['basedir'].'/qcldopenai\_site\_training/'.$filename; |
  | 389 |  | $qcld\_openai\_json\_file = fopen($split\_file, "a"); |
  | 390 |  | $qcld\_openai\_content = ''; |
  | 391 |  | for($i = $line; $i <= count($qcld\_openai\_lines);$i++){ |
  | 392 |  | if($i == count($qcld\_openai\_lines)){ |
  | 393 |  | $qcld\_openai\_content .= $qcld\_openai\_lines[$i]; |
  | 394 |  | $qcld\_openai\_result['next'] = 'DONE'; |
  | 395 |  | } |
  | 396 |  | else{ |
  | 397 |  | if(mb\_strlen($qcld\_openai\_content, '8bit') > $this->wpaicg\_max\_file\_size){ |
  | 398 |  | $qcld\_openai\_result['next'] = $i+1; |
  | 399 |  | break; |
  | 400 |  | } |
  | 401 |  | else{ |
  | 402 |  | $qcld\_openai\_content .= $qcld\_openai\_lines[$i]; |
  | 403 |  | } |
  | 404 |  | } |
  | 405 |  | } |
  | 406 |  | fwrite($qcld\_openai\_json\_file,$qcld\_openai\_content); |
  | 407 |  | fclose($qcld\_openai\_json\_file); |
  | 408 |  | $url = 'https://api.openai.com/v1/files'; |
  | 409 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  |  | 223 | // Send the request to OpenAI |
  |  | 224 | $request\_body = [ |
  |  | 225 | "prompt"            => $prompt, |
  |  | 226 | "n"                 => $num\_images, |
  |  | 227 | "size"              => $img\_size, |
  |  | 228 | "response\_format"   => "url", |
  |  | 229 | ]; |
  |  | 230 | $data    = json\_encode($request\_body); |
  |  | 231 | $url     = "https://api.openai.com/v1/images/generations"; |
  |  | 232 | $apt\_key = "Authorization: Bearer ". $OPENAI\_API\_KEY; |
  | 410 | 233 | $curl = curl\_init($url); |
  | 411 |  | ~~$c\_file = curl\_file\_create($split\_file, mime\_content\_type($split\_file),basename($split\_file));~~ |
  | 412 |  | ~~$data = array(~~ |
  | 413 |  | ~~'purpose' => 'fine-tune',~~ |
  | 414 |  | ~~'file' => $c\_file,~~ |
  | 415 |  | ~~);~~ |
  | 416 | 234 | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 417 | 235 | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 418 |  | $headers = array( |
  | 419 |  | "Content-Type: multipart/form-data", |
  | 420 |  | $apt\_key, |
  |  | 236 | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  |  | 237 | $headers    = array( |
  |  | 238 | "Content-Type: application/json", |
  |  | 239 | $apt\_key , |
  | 421 | 240 | ); |
  | 422 |  | $init = curl\_init(); |
  | 423 |  | curl\_setopt($init, CURLOPT\_URL,$url); |
  | 424 |  | curl\_setopt($init, CURLOPT\_HTTPHEADER, $headers); |
  | 425 |  | curl\_setopt($init, CURLOPT\_POSTFIELDS, $data); |
  | 426 |  | curl\_setopt($init, CURLOPT\_RETURNTRANSFER, true); |
  | 427 |  | $res = json\_decode(curl\_exec ($init)); |
  | 428 |  |  |
  | 429 |  | curl\_close ($init); |
  | 430 |  | if(!empty($res->error)){ |
  | 431 |  | $response['status'] = 'error'; |
  | 432 |  | $response['message'] = $res->error->message; |
  |  | 241 | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  |  | 242 | curl\_setopt($curl, CURLOPT\_POSTFIELDS, $data); |
  |  | 243 | $result     = curl\_exec($curl); |
  |  | 244 | curl\_close($curl); |
  |  | 245 |  |
  |  | 246 | // we need to catch the error here |
  |  | 247 | $img\_result = json\_decode( $result ); |
  |  | 248 |  |
  |  | 249 | $image\_grid = '<div class="qcld\_image\_grid">'; |
  |  | 250 | for ($i = 0; $i < $num\_images; $i++) { |
  |  | 251 | $image\_grid .= '<div class="qcld\_image-grid\_wrap qcld\_botopenai\_generate\_image\_download"> '; |
  |  | 252 | $image\_grid .= '<img class="qcld\_image-item" src=' . esc\_html($img\_result->data[$i]->url) . '>'; |
  |  | 253 | $image\_grid .= '<div class="qcld\_seo\_download" data-img="' . esc\_html($img\_result->data[$i]->url) . '"><button class="btn btn-success">Add to media libary</button></div>'; |
  |  | 254 | $image\_grid .= '</div>'; |
  | 433 | 255 | } |
  | 434 |  |  |
  | 435 |  | if(!empty($res->status)){ |
  | 436 |  | $response['status'] = 'success'; |
  | 437 |  | $response['message'] = 'Successfully Created file' . $res->id ; |
  | 438 |  |  |
  | 439 |  | } |
  | 440 |  | echo wp\_send\_json([$response]); |
  | 441 |  | wp\_die(); |
  | 442 |  | } else { |
  | 443 |  | if(!empty($res->status)){ |
  | 444 |  | $response['status'] = 'error'; |
  | 445 |  | $response['message'] = 'The file has been removed from wp-uploads'; |
  | 446 |  | } |
  | 447 |  | } |
  |  | 256 | $image\_grid .= '</div>'; |
  |  | 257 | $qcld\_seo\_result['status'] = 'success'; |
  |  | 258 | $qcld\_seo\_result['html'] = $image\_grid; |
  |  | 259 |  |
  |  | 260 | } |
  |  | 261 |  |
  |  | 262 | wp\_send\_json( $qcld\_seo\_result ); |
  | 448 | 263 | } |
  | 449 | 264 | } |
  | 450 |  | public function openai\_file\_upload\_callback(){ |
  | 451 |  | $uploadedfile = $\_FILES['file']; |
  | 452 |  | $url = 'https://api.openai.com/v1/files'; |
  | 453 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 454 |  | $curl = curl\_init($url); |
  | 455 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 456 |  | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 457 |  | $headers = array( |
  | 458 |  | "Content-Type: multipart/form-data", |
  | 459 |  | $apt\_key, |
  | 460 |  | ); |
  | 461 |  | if (function\_exists('curl\_file\_create')) { |
  | 462 |  | $tmp\_file = curl\_file\_create($uploadedfile['tmp\_name'], 'jsonl', $uploadedfile['name']); |
  | 463 |  | } else { |
  | 464 |  | $tmp\_file = open($uploadedfile['tmp\_name']); |
  | 465 |  | } |
  | 466 |  |  |
  | 467 |  | $data = array('file'=> $tmp\_file,'purpose'=> 'fine-tune'); |
  | 468 |  | $init = curl\_init(); |
  | 469 |  | //function parameteres |
  | 470 |  | curl\_setopt($init, CURLOPT\_URL,$url); |
  | 471 |  | curl\_setopt($init, CURLOPT\_HTTPHEADER, $headers); |
  | 472 |  | curl\_setopt($init, CURLOPT\_POSTFIELDS, $data); |
  | 473 |  | curl\_setopt($init, CURLOPT\_RETURNTRANSFER, true); |
  | 474 |  | $res = json\_decode(curl\_exec ($init)); |
  | 475 |  |  |
  | 476 |  | curl\_close ($init); |
  | 477 |  | if(!empty($res->error)){ |
  | 478 |  | $response['status'] = 'error'; |
  | 479 |  | $response['message'] = $res->error->message; |
  | 480 |  | } |
  | 481 |  |  |
  | 482 |  | if(!empty($res->status)){ |
  | 483 |  | $response['status'] = 'success'; |
  | 484 |  | $response['message'] = 'Successfully Created file' . $res->id ; |
  | 485 |  |  |
  | 486 |  | } |
  | 487 |  | echo wp\_send\_json([$response]); |
  | 488 |  | wp\_die(); |
  | 489 |  | } |
  | 490 |  | public function qcld\_openai\_image\_generate(){ |
  | 491 |  |  |
  | 492 |  | $qcld\_seo\_result = array( |
  | 493 |  | 'status' => 'error', |
  | 494 |  | 'msg'    => 'Something went wrong', |
  | 495 |  | ); |
  | 496 |  | $OPENAI\_API\_KEY = get\_option('open\_ai\_api\_key'); |
  | 497 |  | $qcld\_seo\_prompt                = isset( $\_POST['qcld\_seo\_prompt'] )                ? sanitize\_text\_field( $\_POST['qcld\_seo\_prompt'] )              : ''; |
  | 498 |  | $qcld\_seo\_artist                = isset( $\_POST['qcld\_seo\_artist'] )                ? sanitize\_text\_field( $\_POST['qcld\_seo\_artist'] )              : 'Painter'; |
  | 499 |  | $qcld\_seo\_art\_style             = isset( $\_POST['qcld\_seo\_art\_style'] )             ? sanitize\_text\_field( $\_POST['qcld\_seo\_art\_style'] )           : 'Style'; |
  | 500 |  | $qcld\_seo\_photography\_style     = isset( $\_POST['qcld\_seo\_photography\_style'] )     ? sanitize\_text\_field( $\_POST['qcld\_seo\_photography\_style'] )   : 'Photography Style'; |
  | 501 |  | $qcld\_seo\_lighting              = isset( $\_POST['qcld\_seo\_lighting'] )              ? sanitize\_text\_field( $\_POST['qcld\_seo\_lighting'] )            : 'Lighting'; |
  | 502 |  | $qcld\_seo\_subject               = isset( $\_POST['qcld\_seo\_subject'] )               ? sanitize\_text\_field( $\_POST['qcld\_seo\_subject'] )             : 'Subject'; |
  | 503 |  | $qcld\_seo\_camera\_settings       = isset( $\_POST['qcld\_seo\_camera\_settings'] )       ? sanitize\_text\_field( $\_POST['qcld\_seo\_camera\_settings'] )     : 'Camera Settings'; |
  | 504 |  | $qcld\_seo\_composition           = isset( $\_POST['qcld\_seo\_composition'] )           ? sanitize\_text\_field( $\_POST['qcld\_seo\_composition'] )         : 'Composition'; |
  | 505 |  | $qcld\_seo\_resolution            = isset( $\_POST['qcld\_seo\_resolution'] )            ? sanitize\_text\_field( $\_POST['qcld\_seo\_resolution'] )          : 'Resolution'; |
  | 506 |  | $qcld\_seo\_color                 = isset( $\_POST['qcld\_seo\_color'] )                 ? sanitize\_text\_field( $\_POST['qcld\_seo\_color'] )               : 'Color'; |
  | 507 |  | $qcld\_seo\_special\_effects       = isset( $\_POST['qcld\_seo\_special\_effects'] )       ? sanitize\_text\_field( $\_POST['qcld\_seo\_special\_effects'] )     : 'Special Effects'; |
  | 508 |  | $qcld\_seo\_img\_size              = isset( $\_POST['qcld\_seo\_img\_size'] )              ? sanitize\_text\_field( $\_POST['qcld\_seo\_img\_size'] )            : '512x512'; |
  | 509 |  | $qcld\_seo\_num\_images            = isset( $\_POST['qcld\_seo\_num\_images'] )            ? sanitize\_text\_field( $\_POST['qcld\_seo\_num\_images'] )          : 1; |
  | 510 |  | $qcld\_seo\_num\_images            = isset( $qcld\_seo\_num\_images )                     ? (int) $qcld\_seo\_num\_images                                    : 6; |
  | 511 |  | if (!empty($qcld\_seo\_prompt)) { |
  | 512 |  | // Get the prompt from the form |
  | 513 |  | $prompt         = $qcld\_seo\_prompt; |
  | 514 |  | $img\_size       = $qcld\_seo\_img\_size; |
  | 515 |  | $num\_images     = $qcld\_seo\_num\_images; |
  | 516 |  | // convert num\_images to an integer |
  | 517 |  | $num\_images     = (int) $num\_images; |
  | 518 |  | $prompt\_elements = array( |
  | 519 |  | 'artist'            => $qcld\_seo\_artist, |
  | 520 |  | 'art\_style'         => $qcld\_seo\_art\_style, |
  | 521 |  | 'photography\_style' => $qcld\_seo\_photography\_style, |
  | 522 |  | 'composition'       => $qcld\_seo\_composition, |
  | 523 |  | 'resolution'        => $qcld\_seo\_resolution, |
  | 524 |  | 'color'             => $qcld\_seo\_color, |
  | 525 |  | 'special\_effects'   => $qcld\_seo\_special\_effects, |
  | 526 |  | 'lighting'          => $qcld\_seo\_lighting, |
  | 527 |  | 'subject'           => $qcld\_seo\_subject, |
  | 528 |  | 'camera\_settings'   => $qcld\_seo\_camera\_settings, |
  | 529 |  | ); |
  | 530 |  | foreach ($prompt\_elements as $key => $value) { |
  | 531 |  | if ($\_POST[$key] != "None") { |
  | 532 |  | $prompt = $prompt . ". " . $value . ": " . $\_POST[$key]; |
  | 533 |  | } |
  | 534 |  | } |
  | 535 |  | // Send the request to OpenAI |
  | 536 |  | $request\_body = [ |
  | 537 |  | "prompt"            => $prompt, |
  | 538 |  | "n"                 => $num\_images, |
  | 539 |  | "size"              => $img\_size, |
  | 540 |  | "response\_format"   => "url", |
  | 541 |  | ]; |
  | 542 |  | $data    = json\_encode($request\_body); |
  | 543 |  | $url     = "https://api.openai.com/v1/images/generations"; |
  | 544 |  | $apt\_key = "Authorization: Bearer ". $OPENAI\_API\_KEY; |
  | 545 |  | $curl = curl\_init($url); |
  | 546 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 547 |  | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 548 |  | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  | 549 |  | $headers    = array( |
  | 550 |  | "Content-Type: application/json", |
  | 551 |  | $apt\_key , |
  | 552 |  | ); |
  | 553 |  | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  | 554 |  | curl\_setopt($curl, CURLOPT\_POSTFIELDS, $data); |
  | 555 |  | $result     = curl\_exec($curl); |
  | 556 |  | curl\_close($curl); |
  | 557 |  |  |
  | 558 |  | // we need to catch the error here |
  | 559 |  | $img\_result = json\_decode( $result ); |
  | 560 |  |  |
  | 561 |  | $image\_grid = '<div class="qcld\_image\_grid">'; |
  | 562 |  | for ($i = 0; $i < $num\_images; $i++) { |
  | 563 |  | $image\_grid .= '<div class="qcld\_image-grid\_wrap qcld\_botopenai\_generate\_image\_download"> '; |
  | 564 |  | $image\_grid .= '<img class="qcld\_image-item" src=' . esc\_html($img\_result->data[$i]->url) . '>'; |
  | 565 |  | $image\_grid .= '<div class="qcld\_seo\_download" data-img="' . esc\_html($img\_result->data[$i]->url) . '"><button class="btn btn-success">Add to media libary</button></div>'; |
  | 566 |  | $image\_grid .= '</div>'; |
  | 567 |  | } |
  | 568 |  | $image\_grid .= '</div>'; |
  | 569 |  | $qcld\_seo\_result['status'] = 'success'; |
  | 570 |  | $qcld\_seo\_result['html'] = $image\_grid; |
  | 571 |  |  |
  | 572 |  | } |
  | 573 |  |  |
  | 574 |  | wp\_send\_json( $qcld\_seo\_result ); |
  | 575 |  | } |
  | 576 |  | public function qcld\_openai\_delete\_training\_file(){ |
  | 577 |  | $file = sanitize\_text\_field($\_POST['file']); |
  | 578 |  | $qcld\_seo\_result = array( |
  | 579 |  | 'status' => 'error', |
  | 580 |  | 'msg'    => 'Something went wrong', |
  | 581 |  | ); |
  | 582 |  | if (is\_file($file)) { |
  | 583 |  |  |
  | 584 |  | chmod($file, 0777); |
  | 585 |  |  |
  | 586 |  | if (unlink($file)) { |
  | 587 |  | $result = 'File deleted'; |
  | 588 |  | $qcld\_seo\_result['html'] = $result; |
  | 589 |  | } else { |
  | 590 |  | $result = 'Cannot remove that file'; |
  | 591 |  | $qcld\_seo\_result['html'] = $result; |
  | 592 |  | } |
  | 593 |  |  |
  | 594 |  | } else { |
  | 595 |  | $result = 'File does not exist'; |
  | 596 |  | $qcld\_seo\_result['html'] = $result; |
  | 597 |  | } |
  | 598 |  |  |
  | 599 |  | wp\_send\_json( $qcld\_seo\_result ); |
  | 600 |  | wp\_die(); |
  | 601 |  |  |
  | 602 |  | } |
  | 603 |  | public function openai\_finetune\_create($file\_id,$ft\_suffix,$ft\_engines){ |
  | 604 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 605 |  | $headers = array( |
  | 606 |  | "Content-Type: application/json", |
  | 607 |  | $apt\_key, |
  | 608 |  | ); |
  | 609 |  | $curl = curl\_init(); |
  | 610 |  | $qcld\_openai\_suffix = isset($ft\_suffix) ? $ft\_suffix : get\_option('qcld\_openai\_suffix'); |
  | 611 |  | $openai\_engines = isset($ft\_engines) ? $ft\_engines : get\_option('openai\_engines'); |
  | 612 |  | $base\_engine = explode('-',$openai\_engines); |
  | 613 |  | $data = json\_encode(array('training\_file'=>$file\_id,'model' => $base\_engine[1], 'suffix' => $qcld\_openai\_suffix )); |
  | 614 |  | $url = "https://api.openai.com/v1/fine-tunes"; |
  | 615 |  | curl\_setopt($curl, CURLOPT\_URL, $url); |
  | 616 |  | curl\_setopt($curl, CURLOPT\_HTTPHEADER, $headers); |
  | 617 |  | curl\_setopt($curl, CURLOPT\_POST, true); |
  | 618 |  | curl\_setopt($curl, CURLOPT\_RETURNTRANSFER, true); |
  | 619 |  | curl\_setopt($curl, CURLOPT\_POSTFIELDS, $data); |
  | 620 |  | $result = json\_decode(curl\_exec($curl)); |
  | 621 |  | curl\_close($curl); |
  | 622 |  | return $result; |
  | 623 |  | } |
  | 624 |  | public function openai\_finetune\_list(){ |
  | 625 |  |  |
  | 626 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 627 |  | $headers = array( |
  | 628 |  | "Content-Type: application/json", |
  | 629 |  | $apt\_key, |
  | 630 |  | ); |
  | 631 |  | $curl\_ft = curl\_init(); |
  | 632 |  | //$data = json\_encode(array('training\_file'=>$file\_id)); |
  | 633 |  |  |
  | 634 |  | $url = "https://api.openai.com/v1/fine-tunes"; |
  | 635 |  | curl\_setopt($curl\_ft, CURLOPT\_URL, $url); |
  | 636 |  | curl\_setopt($curl\_ft, CURLOPT\_HTTPHEADER, $headers); |
  | 637 |  | curl\_setopt($curl\_ft, CURLOPT\_RETURNTRANSFER, true); |
  | 638 |  | $result = json\_decode(curl\_exec($curl\_ft)); |
  | 639 |  | $ft\_arry = []; |
  | 640 |  | foreach($result->data as $value ){ |
  | 641 |  | if(($value->training\_files[0]->status != 'deleted') && ($value->result\_files[0]->status != 'deleted') ){ |
  | 642 |  | $ft\_arry[] = [$value->id,$value->fine\_tuned\_model,$value->status,$value->training\_files[0]->filename,$value->training\_files[0]->id]; |
  | 643 |  | } |
  | 644 |  | } |
  | 645 |  | curl\_close($curl\_ft); |
  | 646 |  | wp\_send\_json( $ft\_arry); |
  | 647 |  | wp\_die(); |
  | 648 |  |  |
  | 649 |  |  |
  | 650 |  | } |
  | 651 |  | public function openai\_retrive\_fine\_tune($keyword){ |
  | 652 |  |  |
  | 653 |  | $apt\_key = "Authorization: Bearer ". get\_option('open\_ai\_api\_key'); |
  | 654 |  | $headers = array( |
  | 655 |  | "Content-Type: application/json", |
  | 656 |  | $apt\_key, |
  | 657 |  | ); |
  | 658 |  | $curl = curl\_init(); |
  | 659 |  | $max\_tokens =  (int)get\_option( 'openai\_max\_tokens'); |
  | 660 |  | $temp = (float)get\_option( 'openai\_temperature'); |
  | 661 |  | $frequency\_penalty = (float)get\_option( 'frequency\_penalty'); |
  | 662 |  | $presence\_penalty = (float)get\_option( 'presence\_penalty'); |
  | 663 |  | $engines = explode('-',get\_option( 'openai\_engines')); |
  | 664 |  |  |
  | 665 |  | $data = json\_encode(array( |
  | 666 |  | 'prompt'=>$keyword, |
  | 667 |  | 'model'=> get\_option( 'qcld\_openai\_custom\_model'), |
  | 668 |  | "max\_tokens" => $max\_tokens, |
  | 669 |  | "temperature" => $temp, |
  | 670 |  | "top\_p" => 1, |
  | 671 |  | "presence\_penalty" => $frequency\_penalty, |
  | 672 |  | "frequency\_penalty"=> $presence\_penalty, |
  | 673 |  | "best\_of"=> 1, |
  | 674 |  | )); |
  | 675 |  | $url = "https://api.openai.com/v1/completions"; |
  | 676 |  |  |
  | 677 |  | $ch = curl\_init(); |
  | 678 |  |  |
  | 679 |  | curl\_setopt($ch, CURLOPT\_URL, 'https://api.openai.com/v1/completions'); |
  | 680 |  | // curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, 1); |
  | 681 |  | // curl\_setopt($ch, CURLOPT\_POST, 1); |
  | 682 |  | curl\_setopt($ch, CURLOPT\_RETURNTRANSFER, true); |
  | 683 |  | curl\_setopt($ch, CURLOPT\_CUSTOMREQUEST, 'POST'); |
  | 684 |  | curl\_setopt($ch, CURLOPT\_HTTPHEADER, $headers); |
  | 685 |  | curl\_setopt($ch, CURLOPT\_POSTFIELDS, $data); |
  | 686 |  |  |
  | 687 |  | $result = (curl\_exec($ch)); |
  | 688 |  | $result = str\_replace("#","",$result ); |
  | 689 |  | return $result; |
  | 690 |  | if (curl\_errno($ch)) { |
  | 691 |  | echo 'Error:' . curl\_error($ch); |
  | 692 |  | } |
  | 693 |  | curl\_close($ch); |
  | 694 |  |  |
  | 695 |  | } |
  |  | 265 |  |
  | 696 | 266 | public function response\_form\_file($keyword){ |
  | 697 | 267 | $max\_tokens =  (int)get\_option( 'openai\_max\_tokens'); |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L825) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L395) |  |
  | 825 | 395 | $gptkeyword = []; |
  | 826 | 396 | $keyword = sanitize\_text\_field($\_POST['keyword']); |
  | 827 |  | ~~$response\_files = $this->openai\_retrive\_fine\_tune($keyword);~~ |
  |  | 397 |  |
  | 828 | 398 | $response\_file = json\_decode($response\_files, true); |
  | 829 | 399 | $gptkeywords = []; |
  | 830 |  | if(empty($response\_file['choices'][0]["text"])){ |
  | 831 |  |  |
  | 832 |  | $engines = explode('-',get\_option( 'openai\_engines')); |
  | 833 |  | if($engines[0] == 'gpt'){ |
  | 834 |  |  |
  | 835 |  | if(empty($\_COOKIE["last\_five\_prompt"])){ |
  | 836 |  | array\_push($gptkeyword, array( |
  | 837 |  | "role" => "user", |
  | 838 |  | "content" =>  $keyword |
  | 839 |  | )); |
  | 840 |  | setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeyword)) , time() + (60000), "/"); |
  | 841 |  | }else{ |
  | 842 |  | $data = ($\_COOKIE['last\_five\_prompt']); |
  | 843 |  | $data = (base64\_decode($data)); |
  | 844 |  | $gptkeyword =  maybe\_unserialize($data); |
  | 845 |  | if(is\_array($gptkeyword)){ |
  | 846 |  | array\_push( $gptkeyword, array( |
  | 847 |  | "role" => "user", |
  | 848 |  | "content" => $keyword |
  | 849 |  | )); |
  | 850 |  | setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeyword)) , time() + (60000), "/"); |
  | 851 |  | } |
  | 852 |  | } |
  | 853 |  |  |
  |  | 400 | $engines = explode('-',get\_option( 'openai\_engines')); |
  |  | 401 | if($engines[0] == 'gpt'){ |
  |  | 402 |  |
  |  | 403 | // if(empty($\_COOKIE["last\_five\_prompt"])){ |
  |  | 404 | array\_push($gptkeyword, array( |
  |  | 405 | "role" => "user", |
  |  | 406 | "content" =>  $keyword |
  |  | 407 | )); |
  |  | 408 | setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeyword)) , time() + (60000), "/"); |
  |  | 409 | // }else{ |
  |  | 410 | //     $data = ($\_COOKIE['last\_five\_prompt']); |
  |  | 411 | //     $data = (base64\_decode($data)); |
  |  | 412 | //     $gptkeyword =  maybe\_unserialize($data); |
  |  | 413 | //     if(is\_array($gptkeyword)){ |
  |  | 414 | //         array\_push( $gptkeyword, array( |
  |  | 415 | //             "role" => "user", |
  |  | 416 | //             "content" => $keyword |
  |  | 417 | //         )); |
  |  | 418 | //         setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeyword)) , time() + (60000), "/"); |
  |  | 419 | //     } |
  |  | 420 | // } |
  |  | 421 |  |
  | 854 | 422 | if((!empty(get\_option('openai\_include\_keyword')) ||  !empty(get\_option('openai\_exclude\_keyword'))) && (get\_option('qcld\_openai\_relevant\_enabled') == '1') ){ |
  | 855 | 423 | $prompts =  $this->include\_exclude\_prompt($keyword); |
  | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2957286#L858) | […](/browser/chatbot/trunk/includes/openai/qcld-bot-openai.php?rev=2977505#L426) |  |
  | 858 | 426 | "role" => "user", |
  | 859 | 427 | "content" =>  $prompts, |
  | 860 |  | )); |
  |  | 428 | )); |
  | 861 | 429 | }else if((!empty(get\_option('openai\_include\_keyword')) ||  !empty(get\_option('openai\_exclude\_keyword'))) && (get\_option('qcld\_openai\_relevant\_enabled') == '0')){ |
  | 862 |  | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
  |  | 430 | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
  | 863 | 431 | $response['message'] = 'Sorry, No result found!'; |
  | 864 | 432 | echo json\_encode($response); |
  | 865 |  | wp\_die(); |
  |  | 433 | wp\_die(); |
  | 866 | 434 | }else{ |
  | 867 | 435 | array\_push($gptkeyword, array( |
  | 868 | 436 | "role" => "user", |
  | 869 | 437 | "content" =>  $keyword |
  | 870 |  | )); |
  |  | 438 | )); |
  | 871 | 439 | } |
  | 872 | 440 |  |
  | 873 | 441 | } |
  | 874 |  |  |
  | 875 |  | $res = $OpenAI->gptcomplete( |
  | 876 |  | $gptkeyword |
  | 877 |  | ); |
  | 878 |  | $mess = json\_decode($res); |
  | 879 |  | $response['message'] = $mess->choices[0]->message->content; |
  | 880 |  | if($response['message'] == 'DUH.'  || $response['message'] == 'DUH'){ |
  | 881 |  | $response['message'] = 'Sorry, No result found!'; |
  | 882 |  | } |
  | 883 |  | if(get\_option('conversation\_continuity') == 1){ |
  | 884 |  | $data = ($\_COOKIE['last\_five\_prompt']); |
  | 885 |  | $data = (base64\_decode($data)); |
  | 886 |  | $gptkeywords =  maybe\_unserialize($data); |
  | 887 |  | if(is\_array($gptkeywords)){ |
  | 888 |  | array\_push( $gptkeywords, array( |
  | 889 |  | "role" => "assistant", |
  | 890 |  | "content" =>  $response['message'] |
  | 891 |  | )); |
  | 892 |  | setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeywords)) , time() + (60000), "/"); |
  | 893 |  | } |
  | 894 |  | } |
  | 895 |  |  |
  | 896 |  | }else{ |
  | 897 |  | if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '1') ){ |
  | 898 |  | $prompts =  $this->include\_exclude\_prompt($keyword); |
  | 899 |  | }else if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '0')){ |
  | 900 |  | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
  | 901 |  | $response['message'] = "Sorry, No result found!"; |
  | 902 |  | echo json\_encode($response); |
  | 903 |  | wp\_die(); |
  | 904 |  | }else{ |
  | 905 |  | $prompts = $this->get\_prompt($keyword); |
  | 906 |  | } |
  |  | 442 |  |
  |  | 443 | $res = $OpenAI->gptcomplete( |
  |  | 444 | $gptkeyword |
  |  | 445 | ); |
  |  | 446 | $mess = json\_decode($res); |
  |  | 447 | $response['message'] = $mess->choices[0]->message->content; |
  |  | 448 | if($response['message'] == 'DUH.'  || $response['message'] == 'DUH'){ |
  |  | 449 | $response['message'] = 'Sorry, No result found!'; |
  |  | 450 | } |
  |  | 451 | // if(get\_option('conversation\_continuity') == 1){ |
  |  | 452 | //     $data = ($\_COOKIE['last\_five\_prompt']); |
  |  | 453 | //     $data = (base64\_decode($data)); |
  |  | 454 | //     $gptkeywords =  maybe\_unserialize($data); |
  |  | 455 | //     if(is\_array($gptkeywords)){ |
  |  | 456 | //         array\_push( $gptkeywords, array( |
  |  | 457 | //             "role" => "assistant", |
  |  | 458 | //             "content" =>  $response['message'] |
  |  | 459 | //         )); |
  |  | 460 | //         setcookie('last\_five\_prompt', base64\_encode(maybe\_serialize($gptkeywords)) , time() + (60000), "/"); |
  |  | 461 | //     } |
  |  | 462 | // } |
  |  | 463 |  |
  |  | 464 | }else{ |
  |  | 465 |  |
  |  | 466 | if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '1') ){ |
  |  | 467 | $prompts =  $this->include\_exclude\_prompt($keyword); |
  |  | 468 | }else if(((get\_option('openai\_include\_keyword')  != '') ||  (get\_option('openai\_exclude\_keyword')  != '')) && (get\_option('qcld\_openai\_relevant\_enabled') == '0')){ |
  |  | 469 |  |
  |  | 470 | if($this->qcld\_include\_keyword\_exist($keyword) == false){ |
  |  | 471 | $response['message'] = "Sorry, No result found!"; |
  |  | 472 | echo json\_encode($response); |
  |  | 473 | wp\_die(); |
  | 907 | 474 | }else{ |
  | 908 | 475 | $prompts = $this->get\_prompt($keyword); |
  | 909 | 476 | } |
  | 910 |  | $prompt =$prompts; |
  | 911 |  | $res = $OpenAI->complete( |
  | 912 |  | $prompt |
  | 913 |  | ); |
  | 914 |  |  |
  | 915 |  | $mess = json\_decode($res); |
  | 916 |  | $response['message'] = $mess->choices[0]->text; |
  | 917 |  | if($response['message'] == 'DUH.' || $response['message'] == 'DUH'){ |
  | 918 |  | $response['message'] = 'Sorry, No result found!'; |
  | 919 |  | } |
  | 920 |  | if(get\_option('conversation\_continuity') == 1){ |
  | 921 |  | $lasfivecookie = $\_COOKIE["last\_five\_prompt"] . $response['message'] . '###'; |
  | 922 |  | $response['cookie'] =  $\_COOKIE["last\_five\_prompt"]; |
  | 923 |  | } |
  | 924 |  | } |
  | 925 |  | }else{ |
  | 926 |  | $response['message'] = $response\_file['choices'][0]["text"]; |
  | 927 |  | } |
  |  | 477 | }else{ |
  |  | 478 | $prompts = $this->get\_prompt($keyword); |
  |  | 479 | } |
  |  | 480 | $prompt =$prompts; |
  |  | 481 | $res = $OpenAI->complete( |
  |  | 482 | $prompt |
  |  | 483 | ); |
  |  | 484 |  |
  |  | 485 | $mess = json\_decode($res); |
  |  | 486 | $response['message'] = $mess->choices[0]->text; |
  |  | 487 | if($response['message'] == 'DUH.' || $response['message'] == 'DUH'){ |
  |  | 488 | $response['message'] = 'Sorry, No result found!'; |
  |  | 489 | } |
  |  | 490 | if(get\_option('conversation\_continuity') == 1){ |
  |  | 491 | $lasfivecookie = $\_COOKIE["last\_five\_prompt"] . $response['message'] . '###'; |
  |  | 492 | $response['cookie'] =  $\_COOKIE["last\_five\_prompt"]; |
  |  | 493 | } |
  |  | 494 | } |
  |  | 495 |  |
  | 928 | 496 | echo json\_encode($response); |
  | 929 | 497 | wp\_die(); |
* ## [chatbot/trunk/includes/openai/qcld\_wp\_OpenAI.php](/changeset/2977505/chatbot/trunk/includes/openai/qcld_wp_OpenAI.php?old=2936993&old_path=chatbot%2Ftrunk%2Fincludes%2Fopenai%2Fqcld_wp_OpenAI.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/includes/openai/qcld_wp_OpenAI.php")

  | [r2967435](/browser/chatbot/trunk/includes/openai/qcld_wp_OpenAI.php?rev=2936993#L66 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/includes/openai/qcld_wp_OpenAI.php?rev=2977505#L66 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 66 | 66 | "temperature" => 0 |
  | 67 | 67 | ); |
  |  | 68 |  |
  | 68 | 69 | $header  = [ |
  | 69 | 70 | 'Content-Type: application/json', |
* ## [chatbot/trunk/js/qcld-wp-chatbot-admin.js](/changeset/2977505/chatbot/trunk/js/qcld-wp-chatbot-admin.js?old=2955247&old_path=chatbot%2Ftrunk%2Fjs%2Fqcld-wp-chatbot-admin.js "Show the [2967435:2977505] differences restricted to chatbot/trunk/js/qcld-wp-chatbot-admin.js")

  | [r2967435](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L160 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L160 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 160 | 160 | $('#qc\_wpbot\_gc\_download').on('click', function(e){ |
  | 161 | 161 | e.preventDefault(); |
  | 162 |  |  |
  | 163 | 162 | $.ajax( |
  | 164 | 163 | { |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L166) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L165) |  |
  | 166 | 165 | // Change to 'GET' if you need. |
  | 167 | 166 | url: ajax\_object.ajax\_url, data: { |
  | 168 |  | 'action': 'qcld\_wp\_chatbot\_gc\_client\_download' |
  |  | 167 | 'action': 'qcld\_wp\_chatbot\_gc\_client\_download', |
  |  | 168 | 'nonce': ajax\_object.ajax\_nonce, |
  | 169 | 169 | }, |
  | 170 | 170 | beforeSend: function() |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L182) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L182) |  |
  | 182 | 182 | // Change to 'GET' if you need. |
  | 183 | 183 | url: ajax\_object.ajax\_url, data: { |
  | 184 |  | 'action': 'qcld\_wp\_chatbot\_gc\_client\_extract' |
  |  | 184 | 'action': 'qcld\_wp\_chatbot\_gc\_client\_extract', |
  |  | 185 | 'nonce': ajax\_object.ajax\_nonce |
  | 185 | 186 | }, |
  | 186 | 187 | beforeSend: function() |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L488) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L489) |  |
  | 488 | 489 | 'action': 'qcld\_wp\_df\_api\_call', |
  | 489 | 490 | 'dfquery': 'hi', |
  |  | 491 | 'nonce': ajax\_object.ajax\_nonce, |
  | 490 | 492 | 'sessionid': 'wpwBot\_df\_201sdf8071' |
  | 491 | 493 | }, |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L736) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L738) |  |
  | 736 | 738 | data: { |
  | 737 | 739 |  |
  | 738 |  | action: 'qcld-wp-chabot-reindex' |
  |  | 740 | action: 'qcld-wp-chabot-reindex', |
  |  | 741 | 'nonce': ajax\_object.ajax\_nonce |
  | 739 | 742 |  |
  | 740 | 743 | }, |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L840) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L843) |  |
  | 840 | 843 | url: ajax\_object.ajax\_url, |
  | 841 | 844 | data: { |
  | 842 |  | action: 'qcld-wp-chabot-cancel-index' |
  |  | 845 | action: 'qcld-wp-chabot-cancel-index', |
  |  | 846 | 'nonce': ajax\_object.ajax\_nonce |
  | 843 | 847 | } |
  | 844 | 848 | }); |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L1142) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L1146) |  |
  | 1142 | 1146 | }); |
  | 1143 | 1147 | } |
  | 1144 |  | $('#post\_conversion\_files').on('click','.qcld\_convert\_upload',function(){ |
  | 1145 |  | var filename = $('.qcld\_convert\_upload').attr('data-file'); |
  | 1146 |  | var lines = $('.qcld\_convert\_upload').attr('data-lines'); |
  | 1147 |  |  |
  | 1148 |  | $.ajax({ |
  | 1149 |  | url: ajax\_object.ajax\_url, |
  | 1150 |  | type: "POST", |
  | 1151 |  | dataType: "JSON", |
  | 1152 |  | data: { |
  | 1153 |  | action : 'qcld\_openai\_upload\_pagetraining\_file', |
  | 1154 |  | data: lines, |
  | 1155 |  | filename: filename, |
  | 1156 |  | }, |
  | 1157 |  | success: function(res) { |
  | 1158 |  | location.reload(); |
  | 1159 |  | setTimeout(() => { |
  | 1160 |  | jQuery('a[href$="#wp-chatbot-openai-training-model"]').trigger('click'); |
  | 1161 |  | }, 5000); |
  | 1162 |  | } |
  | 1163 |  | }); |
  | 1164 |  |  |
  | 1165 |  | }) |
  |  | 1148 |  |
  | 1166 | 1149 | $("#wp-chatbot-data\_post\_converter").on('click','.qcld\_convert\_data', function(){ |
  | 1167 | 1150 | var list = $("input[name='wp\_chatbot\_data\_converter\_list[]']:checked").map(function () { |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2955247#L1342) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-admin.js?rev=2977505#L1325) |  |
  | 1342 | 1325 | qcld\_seo\_img\_size: qcld\_seo\_img\_size, |
  | 1343 | 1326 | qcld\_seo\_num\_images: qcld\_seo\_num\_images, |
  | 1344 |  | action: 'qcld\_openai\_image\_generate' |
  |  | 1327 | action: 'qcld\_openai\_image\_generate', |
  |  | 1328 | nonce: ajax\_object.ajax\_url, |
  | 1345 | 1329 | }; |
  | 1346 | 1330 |  |
* ## [chatbot/trunk/js/qcld-wp-chatbot-plugin.js](/changeset/2977505/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?old=2957286&old_path=chatbot%2Ftrunk%2Fjs%2Fqcld-wp-chatbot-plugin.js "Show the [2967435:2977505] differences restricted to chatbot/trunk/js/qcld-wp-chatbot-plugin.js")

  | [r2967435](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2957286#L295 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2977505#L295 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 295 | 295 | }); |
  | 296 | 296 | }else{ |
  |  | 297 | console.log(globalwpw.settings.obj) |
  | 297 | 298 | return jQuery.post(globalwpw.settings.obj.ajax\_url, { |
  | 298 | 299 | 'action': 'qcld\_wp\_df\_api\_call', |
  | 299 | 300 | 'dfquery': text, |
  |  | 301 | 'nonce': globalwpw.settings.obj.ajax\_nonce, |
  | 300 | 302 | 'sessionid': localStorage.getItem('botsessionid')?localStorage.getItem('botsessionid'):'wpwBot\_df\_2018071' |
  | 301 | 303 | }); |
  | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2957286#L1187) | […](/browser/chatbot/trunk/js/qcld-wp-chatbot-plugin.js?rev=2977505#L1189) |  |
  | 1187 | 1189 | }, |
  | 1188 | 1190 | site\_search:function(msg){ |
  | 1189 |  | msg = wpwKits.filterStopWords(msg); |
  | 1190 |  | var data = {'action':'wpbo\_search\_site','name':globalwpw.hasNameCookie,'keyword':msg}; |
  |  | 1191 | msg1 = wpwKits.filterStopWords(msg); |
  |  | 1192 | var data = {'action':'wpbo\_search\_site','name':globalwpw.hasNameCookie,'keyword':msg1}; |
  | 1191 | 1193 | wpwKits.ajax(data).done(function (res) { |
  | 1192 | 1194 | var json=$.parseJSON(res); |
* ## [chatbot/trunk/qcld-wpwbot-search.php](/changeset/2977505/chatbot/trunk/qcld-wpwbot-search.php?old=2957286&old_path=chatbot%2Ftrunk%2Fqcld-wpwbot-search.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/qcld-wpwbot-search.php")

  | [r2967435](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L86 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L86 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 86 | 86 | $response['status'] = 'fail'; |
  | 87 | 87 | } |
  | 88 |  | ~~//var\_dump($total\_post);wp\_die();~~ |
  | 89 | 88 | $response['html'] .= '<p>'.$msg.'</p>'; |
  | 90 | 89 | $response['html'] .= $responses; |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L174) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L173) |  |
  | 174 | 173 |  |
  | 175 | 174 | $status = array('status'=>'fail', 'multiple'=>false); |
  |  | 175 | $field = "ID"; |
  | 176 | 176 | if(($strid != '') && empty($response\_result)){ |
  | 177 |  | $results = $wpdb->get\_results(~~"SELECT \* FROM `$table` WHERE `ID` = ".$strid~~); |
  |  | 177 | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM %i WHERE %i = %d",$table,$field,$strid)); |
  | 178 | 178 | if(!empty($results)){ |
  | 179 | 179 | foreach($results as $result){ |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L184) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L184) |  |
  | 184 | 184 | } |
  | 185 | 185 | } |
  | 186 |  |  |
  | 187 |  | $results = $wpdb->get\_results("SELECT `id`, `query`, `response` FROM `$table` WHERE 1 and `query` = '".$keyword."'"); |
  |  | 186 | $field = "query"; |
  |  | 187 | $sql\_text = $wpdb->prepare("SELECT `id`, `query`, `response` FROM %i WHERE 1 and %i =  %s", $table, $field,$keyword); |
  |  | 188 | $results = $wpdb->get\_results($sql\_text); |
  |  | 189 |  |
  | 188 | 190 |  |
  | 189 | 191 | if(!empty($results)){ |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L194) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L196) |  |
  | 194 | 196 | } |
  | 195 | 197 | } |
  |  | 198 |  |
  |  | 199 | $field = "category"; |
  | 196 | 200 | if(empty($response\_result)){ |
  | 197 |  | $results = $wpdb->get\_results("SELECT `id`, `query`, `response` FROM `$table` WHERE 1 and `category` = '".$keyword."'"); |
  |  | 201 | $sql = $wpdb->prepare("SELECT `id`, `query`, `response` FROM %i  WHERE 1 and %i = %s", $table,$field, $keyword); |
  |  | 202 | $results = $wpdb->get\_results($sql ); |
  | 198 | 203 |  |
  | 199 | 204 |  |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L232) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L237) |  |
  | 232 | 237 | $sql = "ALTER TABLE `{$table}` ADD FULLTEXT($qfields);"; |
  | 233 | 238 | $wpdb->query( $sql ); |
  | 234 |  | $sql\_text = "SELECT `id`, `query`, `response`, MATCH($qfields) AGAINST('".$keyword."' IN NATURAL LANGUAGE MODE) as score FROM $table WHERE MATCH($qfields) AGAINST('".$keyword."' IN NATURAL LANGUAGE MODE) order by score desc limit 15"; |
  |  | 239 |  |
  |  | 240 | $sql\_text = $wpdb->prepare("SELECT `id`, `query`, `response`, MATCH($qfields) AGAINST(%s IN NATURAL LANGUAGE MODE) as score FROM %i WHERE MATCH($qfields) AGAINST(%s IN NATURAL LANGUAGE MODE) order by score desc limit 15",$keyword,$table,$keyword); |
  | 235 | 241 | $results = $wpdb->get\_results($sql\_text); |
  | 236 |  |  |
  | 237 | 242 | $weight = get\_option('qc\_bot\_str\_weight')!=''?get\_option('qc\_bot\_str\_weight'):'0.4'; |
  |  | 243 |  |
  | 238 | 244 | if(!empty($results)){ |
  | 239 | 245 | foreach($results as $result){ |
  | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2957286#L244) | […](/browser/chatbot/trunk/qcld-wpwbot-search.php?rev=2977505#L250) |  |
  | 244 | 250 | } |
  | 245 | 251 | } |
  | 246 |  |  |
  |  | 252 | $field = "keyword"; |
  | 247 | 253 | if( empty( $response\_result ) ){ |
  | 248 |  | $results = $wpdb->get\_results("SELECT \* FROM `$table` WHERE `keyword` REGEXP '".$keyword."'"); |
  |  | 254 | $results = $wpdb->get\_results($wpdb->prepare("SELECT \* FROM %i WHERE %i REGEXP %s", $table,$field,$keyword)); |
  |  | 255 |  |
  |  | 256 |  |
  | 249 | 257 | if(!empty($results)){ |
  | 250 | 258 | foreach($results as $result){ |
* ## [chatbot/trunk/qcld-wpwbot.php](/changeset/2977505/chatbot/trunk/qcld-wpwbot.php?old=2967435&old_path=chatbot%2Ftrunk%2Fqcld-wpwbot.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/qcld-wpwbot.php")

  | [r2967435](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2967435#L5 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2977505#L5 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Description: ChatBot is a native WordPress ChatBot plugin to provide quick support and email functionality. |
  | 6 | 6 | \* Donate link: https://www.quantumcloud.com |
  | 7 |  | \* Version: 4.~~8.9~~ |
  |  | 7 | \* Version: 4.9.1 |
  | 8 | 8 | \* @author    QuantumCloud |
  | 9 | 9 | \* Author: QuantumCloud |
  | […](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2967435#L19) | […](/browser/chatbot/trunk/qcld-wpwbot.php?rev=2977505#L19) |  |
  | 19 | 19 |  |
  | 20 | 20 | if (!defined('ABSPATH')) exit; // Exit if accessed directly |
  | 21 |  | define('QCLD\_wpCHATBOT\_VERSION', '4.~~8.9~~'); |
  |  | 21 | define('QCLD\_wpCHATBOT\_VERSION', '4.9.1'); |
  | 22 | 22 | define('QCLD\_wpCHATBOT\_REQUIRED\_wpCOMMERCE\_VERSION', 2.2); |
  | 23 | 23 | define('QCLD\_wpCHATBOT\_PLUGIN\_DIR\_PATH', plugin\_dir\_path(\_\_FILE\_\_)); |
* ## [chatbot/trunk/qcld\_df\_api.php](/changeset/2977505/chatbot/trunk/qcld_df_api.php?old=2537910&old_path=chatbot%2Ftrunk%2Fqcld_df_api.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/qcld_df_api.php")

  | [r2967435](/browser/chatbot/trunk/qcld_df_api.php?rev=2537910#L79 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/qcld_df_api.php?rev=2977505#L79 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 79 | 79 | add\_action('wp\_ajax\_nopriv\_qcld\_wp\_df\_api\_call', 'qcld\_wp\_df\_api\_call'); |
  | 80 | 80 | function qcld\_wp\_df\_api\_call(){ |
  | 81 |  | $session\_id = 'asd2342sde'; |
  | 82 |  | $language = get\_option('qlcd\_wp\_chatbot\_dialogflow\_agent\_language'); |
  | 83 |  | //project ID |
  | 84 |  | $project\_ID = get\_option('qlcd\_wp\_chatbot\_dialogflow\_project\_id'); |
  | 85 |  | // Service Account Key json file |
  | 86 |  | $JsonFileContents = get\_option('qlcd\_wp\_chatbot\_dialogflow\_project\_key'); |
  | 87 |  | if($project\_ID==''){ |
  | 88 |  | echo json\_encode(array('error'=>'Project ID is empty'));exit; |
  | 89 |  | } |
  | 90 |  | if($JsonFileContents==''){ |
  | 91 |  | echo json\_encode(array('error'=>'Key is empty'));exit; |
  | 92 |  | } |
  | 93 |  | if(!isset($\_POST['dfquery']) || $\_POST['dfquery']==''){ |
  | 94 |  | echo json\_encode(array('error'=>'Query text is not added!'));exit; |
  | 95 |  | } |
  | 96 |  | $query = sanitize\_text\_field($\_POST['dfquery']); |
  | 97 |  | if(isset($\_POST['sessionid']) && $\_POST['sessionid']!=''){ |
  | 98 |  | $session\_id = sanitize\_text\_field($\_POST['sessionid']); |
  | 99 |  | } |
  | 100 |  |  |
  | 101 |  |  |
  | 102 |  | if(file\_exists(QCLD\_wpCHATBOT\_GC\_DIRNAME.'/autoload.php')){ |
  | 103 |  |  |
  | 104 |  | require(QCLD\_wpCHATBOT\_GC\_DIRNAME.'/autoload.php'); |
  | 105 |  |  |
  | 106 |  | $client = new \Google\_Client(); |
  | 107 |  | $client->useApplicationDefaultCredentials(); |
  | 108 |  | $client->setScopes (['https://www.googleapis.com/auth/dialogflow']); |
  | 109 |  | // Convert to array |
  | 110 |  | $array = json\_decode($JsonFileContents, true); |
  | 111 |  | $client->setAuthConfig($array); |
  | 112 |  |  |
  | 113 |  | try { |
  | 114 |  | $httpClient = $client->authorize(); |
  | 115 |  | $apiUrl = "https://dialogflow.googleapis.com/v2/projects/{$project\_ID}/agent/sessions/{$session\_id}:detectIntent"; |
  | 116 |  |  |
  | 117 |  | $response = $httpClient->request('POST', $apiUrl, [ |
  | 118 |  | 'json' => ['queryInput' => ['text' => ['text' => $query, 'languageCode' => $language]], |
  | 119 |  | 'queryParams' => ['timeZone' => '']] |
  | 120 |  | ]); |
  | 121 |  |  |
  | 122 |  | $contents = $response->getBody()->getContents(); |
  | 123 |  | echo $contents;exit; |
  | 124 |  |  |
  | 125 |  | }catch(Exception $e) { |
  | 126 |  | echo json\_encode(array('error'=>$e->getMessage()));exit; |
  | 127 |  | } |
  |  | 81 | $nonce =  sanitize\_text\_field($\_POST['nonce']); |
  |  | 82 | if ((! wp\_verify\_nonce($nonce,'wp\_chatbot')) && ( ! wp\_verify\_nonce($nonce,'qcsecretbotnonceval123qc'))) { |
  |  | 83 | wp\_send\_json(array('success' => false, 'msg' => esc\_html\_\_('Failed in Security check', 'sm'))); |
  |  | 84 | wp\_die(); |
  | 128 | 85 |  |
  | 129 | 86 | }else{ |
  | 130 |  | echo json\_encode(array('error'=>'API client not found'));exit; |
  |  | 87 | $session\_id = 'asd2342sde'; |
  |  | 88 | $language = get\_option('qlcd\_wp\_chatbot\_dialogflow\_agent\_language'); |
  |  | 89 | //project ID |
  |  | 90 | $project\_ID = get\_option('qlcd\_wp\_chatbot\_dialogflow\_project\_id'); |
  |  | 91 | // Service Account Key json file |
  |  | 92 | $JsonFileContents = get\_option('qlcd\_wp\_chatbot\_dialogflow\_project\_key'); |
  |  | 93 | if($project\_ID==''){ |
  |  | 94 | echo json\_encode(array('error'=>'Project ID is empty'));exit; |
  |  | 95 | } |
  |  | 96 | if($JsonFileContents==''){ |
  |  | 97 | echo json\_encode(array('error'=>'Key is empty'));exit; |
  |  | 98 | } |
  |  | 99 | if(!isset($\_POST['dfquery']) || $\_POST['dfquery']==''){ |
  |  | 100 | echo json\_encode(array('error'=>'Query text is not added!'));exit; |
  |  | 101 | } |
  |  | 102 | $query = sanitize\_text\_field($\_POST['dfquery']); |
  |  | 103 | if(isset($\_POST['sessionid']) && $\_POST['sessionid']!=''){ |
  |  | 104 | $session\_id = sanitize\_text\_field($\_POST['sessionid']); |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 |  |
  |  | 108 | if(file\_exists(QCLD\_wpCHATBOT\_GC\_DIRNAME.'/autoload.php')){ |
  |  | 109 |  |
  |  | 110 | require(QCLD\_wpCHATBOT\_GC\_DIRNAME.'/autoload.php'); |
  |  | 111 |  |
  |  | 112 | $client = new \Google\_Client(); |
  |  | 113 | $client->useApplicationDefaultCredentials(); |
  |  | 114 | $client->setScopes (['https://www.googleapis.com/auth/dialogflow']); |
  |  | 115 | // Convert to array |
  |  | 116 | $array = json\_decode($JsonFileContents, true); |
  |  | 117 | $client->setAuthConfig($array); |
  |  | 118 |  |
  |  | 119 | try { |
  |  | 120 | $httpClient = $client->authorize(); |
  |  | 121 | $apiUrl = "https://dialogflow.googleapis.com/v2/projects/{$project\_ID}/agent/sessions/{$session\_id}:detectIntent"; |
  |  | 122 |  |
  |  | 123 | $response = $httpClient->request('POST', $apiUrl, [ |
  |  | 124 | 'json' => ['queryInput' => ['text' => ['text' => $query, 'languageCode' => $language]], |
  |  | 125 | 'queryParams' => ['timeZone' => '']] |
  |  | 126 | ]); |
  |  | 127 |  |
  |  | 128 | $contents = $response->getBody()->getContents(); |
  |  | 129 | echo $contents;exit; |
  |  | 130 |  |
  |  | 131 | }catch(Exception $e) { |
  |  | 132 | echo json\_encode(array('error'=>$e->getMessage()));exit; |
  |  | 133 | } |
  |  | 134 |  |
  |  | 135 | }else{ |
  |  | 136 | echo json\_encode(array('error'=>'API client not found'));exit; |
  |  | 137 | } |
  |  | 138 | die(); |
  | 131 | 139 | } |
  | 132 |  | ~~die();~~ |
  | 133 | 140 | } |
* ## [chatbot/trunk/readme.txt](/changeset/2977505/chatbot/trunk/readme.txt?old=2967435&old_path=chatbot%2Ftrunk%2Freadme.txt "Show the [2967435:2977505] differences restricted to chatbot/trunk/readme.txt")

  | [r2967435](/browser/chatbot/trunk/readme.txt?rev=2967435#L5 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/readme.txt?rev=2977505#L5 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 4.6 |
  | 6 | 6 | Tested up to: 6.3 |
  | 7 |  | Stable tag: 4.~~8.9~~ |
  |  | 7 | Stable tag: 4.9.1 |
  | 8 | 8 | Requires PHP: 5.6 |
  | 9 | 9 | License: GPLv2 or later |
  | […](/browser/chatbot/trunk/readme.txt?rev=2967435#L399) | […](/browser/chatbot/trunk/readme.txt?rev=2977505#L399) |  |
  | 399 | 399 | == Changelog == |
  | 400 | 400 |  |
  |  | 401 | = 4.9.1 = |
  |  | 402 | # Improved security |
  |  | 403 | # Removed unnecessary functions |
  |  | 404 |  |
  |  | 405 |  |
  | 401 | 406 | = 4.8.9 = |
  | 402 | 407 | # Minor UI Update |
* ## [chatbot/trunk/templates/app-templates/app-checkout.php](/changeset/2977505/chatbot/trunk/templates/app-templates/app-checkout.php?old=1933241&old_path=chatbot%2Ftrunk%2Ftemplates%2Fapp-templates%2Fapp-checkout.php "Show the [2967435:2977505] differences restricted to chatbot/trunk/templates/app-templates/app-checkout.php")

  | [r2967435](/browser/chatbot/trunk/templates/app-templates/app-checkout.php?rev=1933241#L13 "Show revision 2967435 of this file in browser") | [r2977505](/browser/chatbot/trunk/templates/app-templates/app-checkout.php?rev=2977505#L13 "Show revision 2977505 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 | ?> |
  | 14 | 14 | <script> |
  | 15 |  | jQuery(function ($) { |
  | 16 |  | var ajaxurl = '<?php echo admin\_url('admin-ajax.php'); ?>'; |
  | 17 |  | $("#wp-chatbot-app-checkout-container").parents("body").addClass("wpchatbot-app-checkout"); |
  | 18 |  | $(document).on('click', '.wpcommerce-form-login input[type="submit"]', function (event) { |
  | 19 |  | event.preventDefault(); |
  | 20 |  | var validatorDom=$('.wpcommerce-form-login>p').first(); |
  | 21 |  | var validate=""; |
  | 22 |  | var NonceName=$('#\_wpnonce').attr('name'); |
  | 23 |  | var NonceVal=$('#\_wpnonce').val(); |
  | 24 |  | var userName=$('#username').val(); |
  | 25 |  | var password=$('#password').val(); |
  | 26 |  | if(userName=="" || password=="" ){ |
  | 27 |  | validate+='<p style="color:red"> User name & Password are required. </p>'; |
  | 28 |  | } |
  | 29 |  | if(validate==""){ |
  | 30 |  | var data = {'action': 'qcld\_wb\_chatbot\_checkout\_user\_login','user\_name': userName,'user\_pass': password,'nonce\_name': NonceName,'nonce\_val':NonceVal}; |
  | 31 |  | jQuery.post(ajaxurl, data, function (response) { |
  | 32 |  | if(response=='yes'){ |
  | 33 |  | window.location.reload(true); |
  | 34 |  | }else{ |
  | 35 |  | validatorDom.html('<p style="color:red"> User name Or Password or both are incorrect. </p>'); |
  | 36 |  | setTimeout(function () { |
  | 37 |  | validatorDom.html(''); |
  | 38 |  | },5000); |
  | 39 |  | } |
  | 40 |  | }); |
  | 41 |  | }else{ |
  | 42 |  | validatorDom.html(validate); |
  | 43 |  | setTimeout(function () { |
  | 44 |  | validatorDom.html(''); |
  | 45 |  | },5000); |
  | 46 |  | } |
  | 47 |  | }); |
  | 48 |  | }); |
  |  | 15 | // jQuery(function ($) { |
  |  | 16 | //     var ajaxurl = '<?php // echo admin\_url('admin-ajax.php'); ?>'; |
  |  | 17 | //     var nonce = '<?php // wp\_create\_nonce('login\_nonce'); ?>'; |
  |  | 18 | //     $("#wp-chatbot-app-checkout-container").parents("body").addClass("wpchatbot-app-checkout"); |
  |  | 19 | //     $(document).on('click', '.wpcommerce-form-login input[type="submit"]', function (event) { |
  |  | 20 | //         event.preventDefault(); |
  |  | 21 | //         var validatorDom=$('.wpcommerce-form-login>p').first(); |
  |  | 22 | //         var validate=""; |
  |  | 23 | //         var NonceName=$('#\_wpnonce').attr('name'); |
  |  | 24 | //         var NonceVal=$('#\_wpnonce').val(); |
  |  | 25 | //         var userName=$('#username').val(); |
  |  | 26 | //         var password=$('#password').val(); |
  |  | 27 | //         if(userName=="" || password=="" ){ |
  |  | 28 | //             validate+='<p style="color:red"> User name & Password are required. </p>'; |
  |  | 29 | //         } |
  |  | 30 | //         if(validate==""){ |
  |  | 31 | //             var data = {'action': 'qcld\_wb\_chatbot\_checkout\_user\_login','user\_name': userName,'user\_pass': password,'nonce\_name': NonceName,'nonce\_val':NonceVal}; |
  |  | 32 | //             jQuery.post(ajaxurl, data, function (response) { |
  |  | 33 | //                 if(response=='yes'){ |
  |  | 34 | //                     window.location.reload(true); |
  |  | 35 | //                 }else{ |
  |  | 36 | //                     validatorDom.html('<p style="color:red"> User name Or Password or both are incorrect. </p>'); |
  |  | 37 | //                     setTimeout(function () { |
  |  | 38 | //                         validatorDom.html(''); |
  |  | 39 | //                     },5000); |
  |  | 40 | //                 } |
  |  | 41 | //             }); |
  |  | 42 | //         }else{ |
  |  | 43 | //             validatorDom.html(validate); |
  |  | 44 | //             setTimeout(function () { |
  |  | 45 | //                 validatorDom.html(''); |
  |  | 46 | //             },5000); |
  |  | 47 | //         } |
  |  | 48 | //     }); |
  |  | 49 | // }); |
  | 49 | 50 | </script> |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2977505&old=2967435&new_path=%2Fchatbot%2Ftrunk&old_path=%2Fchatbot%2Ftrunk)
* [Zip Archive](?format=zip&new=2977505&old=2967435&new_path=%2Fchatbot%2Ftrunk&old_path=%2Fchatbot%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


