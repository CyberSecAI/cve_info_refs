=== Content from www.wordfence.com_e6b7a7b9_20250114_202739.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Easy Registration Forms <= 2.1.1 - Authenticated (Subscriber+) Information Disclosure via Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Easy Registration Forms <= 2.1.1 - Authenticated (Subscriber+) Information Disclosure via Shortcode

4.3

**Exposure of Sensitive Information to an Unauthorized Actor**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

| CVE | [CVE-2023-5134](https://www.cve.org/CVERecord?id=CVE-2023-5134) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | September 22, 2023 |
| Last Updated | September 23, 2023 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Easy Registration Forms for WordPress is vulnerable to Information Disclosure via the 'erforms\_user\_meta' shortcode in versions up to, and including, 2.1.1 due to insufficient controls on the information retrievable via the shortcode. This makes it possible for authenticated attackers, with subscriber-level capabilities or above, to retrieve arbitrary sensitive user meta.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/easy-registration-forms/tags/2.1.1/includes/class-user.php#L835)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Feasy-registration-forms%2Feasy-registration-forms-211-authenticated-subscriber-information-disclosure-via-shortcode&t=Easy%20Registration%20Forms%20%3C%3D%202.1.1%20-%20Authenticated%20%28Subscriber%2B%29%20Information%20Disclosure%20via%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Feasy-registration-forms%2Feasy-registration-forms-211-authenticated-subscriber-information-disclosure-via-shortcode&text=Easy%20Registration%20Forms%20%3C%3D%202.1.1%20-%20Authenticated%20%28Subscriber%2B%29%20Information%20Disclosure%20via%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Feasy-registration-forms%2Feasy-registration-forms-211-authenticated-subscriber-information-disclosure-via-shortcode "LinkedIn")
Email

## Vulnerability Details for Easy Registration Forms

#### [Easy Registration Forms](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/easy-registration-forms)

| Software Type | Plugin |
| --- | --- |
| Software Slug | easy-registration-forms [(view on wordpress.org)](https://wordpress.org/plugins/easy-registration-forms) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 2.1.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_d2b305d1_20250114_202737.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Feasy-registration-forms%2Ftags%2F2.1.1%2Fincludes%2Fclass-user.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/easy-registration-forms/tags/2.1.1/includes/class-user.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/easy-registration-forms/tags/2.1.1/includes/class-user.php)

---

# [source:](/browser?order=name "Go to repository root") [easy-registration-forms](/browser/easy-registration-forms?order=name "View easy-registration-forms")/[tags](/browser/easy-registration-forms/tags?order=name "View tags")/[2.1.1](/browser/easy-registration-forms/tags/2.1.1?order=name "View 2.1.1")/[includes](/browser/easy-registration-forms/tags/2.1.1/includes?order=name "View includes")/[class-user.php](/browser/easy-registration-forms/tags/2.1.1/includes/class-user.php?order=name "View class-user.php")

View diff against:

View revision:

| [Last change](/changeset/2504638/easy-registration-forms/tags/2.1.1/includes/class-user.php "View differences") on this file was [2504638](/changeset/2504638/ "View changeset 2504638"), checked in by easyregistrationforms, [4 years ago](/timeline?from=2021-03-28T05%3A27%3A09Z&precision=second "See timeline at 03/28/2021 05:27:09 AM") |
| --- |
| 2.1.1 |
| **File size:** 34.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* User Related |
| [4](#L4) | \* |
| [5](#L5) | \* @package    ERForms |
| [6](#L6) | \* @author     ERForms |
| [7](#L7) | \* @since      1.0.0 |
| [8](#L8) | \*/ |
| [9](#L9) | class ERForms\_User { |
| [10](#L10) |  |
| [11](#L11) | private  $meta\_prefix= 'erf\_'; |
| [12](#L12) | private static $instance = null; |
| [13](#L13) | /\*\* |
| [14](#L14) | \* Primary class constructor. |
| [15](#L15) | \* |
| [16](#L16) | \* @since 1.0.0 |
| [17](#L17) | \*/ |
| [18](#L18) | private function \_\_construct() { |
| [19](#L19) | add\_action('erf\_user\_created', array($this, 'post\_user\_creation'), 10, 3); |
| [20](#L20) | add\_filter('login\_redirect', array($this,'login\_redirect'), 10, 3 ); |
| [21](#L21) | add\_filter('erf\_login\_redirect', array($this,'login\_redirect'), 10, 3 ); |
| [22](#L22) | add\_filter('erf\_ajax\_before\_sub\_response',array($this,'ajax\_before\_sub\_response'),10,1); |
| [23](#L23) |  |
| [24](#L24) | // WP User Related |
| [25](#L25) | add\_action('edit\_user\_profile', array($this,'show\_profile\_fields')); |
| [26](#L26) | add\_action('show\_user\_profile', array($this,'show\_profile\_fields')); |
| [27](#L27) | add\_action( 'personal\_options\_update',array($this,'update\_user\_status')); |
| [28](#L28) | add\_action( 'edit\_user\_profile\_update',array($this,'update\_user\_status')); |
| [29](#L29) | add\_action('manage\_users\_columns',array($this,'add\_user\_column')); |
| [30](#L30) | add\_action('manage\_users\_custom\_column', array($this,'fill\_status\_column'),10,3); |
| [31](#L31) | add\_filter('authenticate', array($this,'authenticate\_user'), 30, 3 ); |
| [32](#L32) | add\_action('wp\_ajax\_erf\_reset\_password', array( $this, 'reset\_password')); |
| [33](#L33) | add\_action('wp\_ajax\_nopriv\_erf\_reset\_password', array( $this, 'reset\_password')); |
| [34](#L34) | add\_action('wp\_ajax\_erf\_otp\_check', array( $this, 'otp\_check')); |
| [35](#L35) | add\_action('wp\_ajax\_nopriv\_erf\_otp\_check', array( $this, 'otp\_check')); |
| [36](#L36) | add\_action('wp\_ajax\_erf\_update\_password', array( $this, 'update\_password')); |
| [37](#L37) | add\_action('wp\_ajax\_nopriv\_erf\_update\_password', array( $this, 'update\_password')); |
| [38](#L38) | add\_action('wp\_ajax\_erf\_login\_user', array( $this, 'process\_login')); |
| [39](#L39) | add\_action('wp\_ajax\_nopriv\_erf\_login\_user', array( $this, 'process\_login')); |
| [40](#L40) | add\_action('wp\_ajax\_erf\_change\_password', array( $this, 'change\_password\_ajax')); |
| [41](#L41) | add\_action('wp\_ajax\_erf\_account\_verification',array($this,'account\_verification')); |
| [42](#L42) | add\_action('wp\_ajax\_nopriv\_erf\_account\_verification',array($this,'ajax\_account\_verification')); |
| [43](#L43) | add\_shortcode('erforms\_account\_verification',array($this,'account\_verification')); |
| [44](#L44) | add\_action('wp\_ajax\_erf\_ajax\_log\_in',array($this,'ajax\_log\_in')); |
| [45](#L45) | add\_action('wp\_ajax\_nopriv\_erf\_ajax\_log\_in',array($this,'ajax\_log\_in')); |
| [46](#L46) | add\_shortcode('erforms\_resend\_verification\_link',array($this,'resend\_verification\_link')); |
| [47](#L47) | add\_action('wp\_ajax\_erf\_resend\_verification',array($this,'resend\_verification')); |
| [48](#L48) | add\_action('wp\_ajax\_nopriv\_erf\_resend\_verification',array($this,'resend\_verification')); |
| [49](#L49) | add\_filter('erforms\_user\_username\_change',array($this,'check\_user\_by\_username'),10,2); |
| [50](#L50) | add\_filter('erforms\_user\_user\_email\_change',array($this,'check\_user\_by\_email'),10,2); |
| [51](#L51) | add\_action('erf\_user\_meta\_updated',array($this,'user\_meta\_updated'),10,4); |
| [52](#L52) | add\_action('erf\_post\_submission\_completed', array($this,'post\_submission\_completed'),10); |
| [53](#L53) | add\_shortcode('erforms\_user\_meta',array($this,'user\_meta\_for\_shortcode')); |
| [54](#L54) | } |
| [55](#L55) |  |
| [56](#L56) | public static function get\_instance() |
| [57](#L57) | { |
| [58](#L58) | if (self::$instance === null) { |
| [59](#L59) | self::$instance = new self(); |
| [60](#L60) | } |
| [61](#L61) | return self::$instance; |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) | public function post\_user\_creation($user\_id, $form\_id,$sub\_id) { |
| [65](#L65) | $form\_model = erforms()->form; |
| [66](#L66) | $form= $form\_model->get\_form($form\_id); |
| [67](#L67) | $submission= erforms()->submission->get\_submission($sub\_id); |
| [68](#L68) | // Check for user role assignment if not already logged in |
| [69](#L69) | if (is\_user\_logged\_in()) |
| [70](#L70) | return false; |
| [71](#L71) |  |
| [72](#L72) | $default\_role = $form['default\_role']; |
| [73](#L73) | $roles= erforms\_wp\_roles(); |
| [74](#L74) | if(!isset($roles[$default\_role])){ |
| [75](#L75) | $default\_role = ''; |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | if(!empty($default\_role)){ |
| [79](#L79) | $default\_role= apply\_filters('erf\_before\_setting\_user\_role',$default\_role,$user\_id,$form, $submission); |
| [80](#L80) | $this->set\_user\_role($user\_id, $default\_role); |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) |  |
| [84](#L84) | // Update form and submission ID in user meta for future reference |
| [85](#L85) | $this->update\_meta($user\_id, 'form', $form['id']); |
| [86](#L86) | $this->update\_meta($user\_id, 'submission', $sub\_id); |
| [87](#L87) |  |
| [88](#L88) | // Auto User Activation Check |
| [89](#L89) | $auto\_activation = $form['auto\_user\_activation']; |
| [90](#L90) | if(!empty($submission['payment\_status']) && $submission['payment\_status']==ERFORMS\_COMPLETED){ |
| [91](#L91) | $auto\_activation= true; |
| [92](#L92) | } |
| [93](#L93) | $user\_active= false; |
| [94](#L94) | if (!empty($auto\_activation)) { |
| [95](#L95) | $active= apply\_filters('erf\_before\_user\_activation',true,$user\_id,$submission,$form); |
| [96](#L96) | if($active){ |
| [97](#L97) | $this->update\_meta($user\_id, 'active', 1); |
| [98](#L98) | do\_action('erf\_async\_user\_activated',$user\_id); |
| [99](#L99) | //wp\_schedule\_single\_event(time() + 60, 'erf\_async\_user\_activated',array($user\_id)); |
| [100](#L100) | $user\_active= true; |
| [101](#L101) | } |
| [102](#L102) | else |
| [103](#L103) | { |
| [104](#L104) | $this->update\_meta($user\_id, 'active', 0); |
| [105](#L105) | do\_action('erf\_async\_user\_deactivated',$user\_id); |
| [106](#L106) | } |
| [107](#L107) | } else { |
| [108](#L108) | // Check if email verification has to be done |
| [109](#L109) | if(!empty($form['en\_email\_verification'])){ |
| [110](#L110) | $hash=  wp\_generate\_password(12,false); |
| [111](#L111) | $this->update\_meta($user\_id, 'verification\_hash',$hash); |
| [112](#L112) | do\_action('erf\_send\_verification\_link',$user\_id,$hash,$form,$sub\_id); |
| [113](#L113) | //wp\_schedule\_single\_event(time()+50,'erf\_send\_verification\_link',array($user\_id,$hash,$form,$sub\_id)); |
| [114](#L114) | } |
| [115](#L115) | $this->update\_meta($user\_id, 'active', 0); |
| [116](#L116) | } |
| [117](#L117) |  |
| [118](#L118) |  |
| [119](#L119) | // Auto Login check |
| [120](#L120) | $auto\_login = $form['auto\_login']; |
| [121](#L121) | if (!empty($auto\_login) && !empty($user\_active)) { |
| [122](#L122) | $this->login\_user\_by\_id($user\_id); |
| [123](#L123) | } |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) |  |
| [127](#L127) |  |
| [128](#L128) | public function set\_user\_role($user\_id, $role) { |
| [129](#L129) | $user = get\_user\_by('ID', $user\_id); |
| [130](#L130) | if (empty($user)) |
| [131](#L131) | return false; |
| [132](#L132) |  |
| [133](#L133) | $user->set\_role($role); |
| [134](#L134) | } |
| [135](#L135) |  |
| [136](#L136) | public function get\_user\_roles($user\_id) { |
| [137](#L137) | $user = get\_user\_by('ID', $user\_id); |
| [138](#L138) | if (empty($user)) |
| [139](#L139) | return false; |
| [140](#L140) |  |
| [141](#L141) | return $user->roles; |
| [142](#L142) | } |
| [143](#L143) |  |
| [144](#L144) | /\* |
| [145](#L145) | \* Login user by ID |
| [146](#L146) | \*/ |
| [147](#L147) | public function login\_user\_by\_id($user\_id) { |
| [148](#L148) | if (headers\_sent()) |
| [149](#L149) | return; |
| [150](#L150) | //delete\_user\_meta($user\_id,$this->meta\_prefix.'verification\_hash'); |
| [151](#L151) | wp\_set\_current\_user($user\_id); |
| [152](#L152) | wp\_set\_auth\_cookie($user\_id); |
| [153](#L153) | do\_action('erf\_user\_logged\_in',$user\_id); |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | public function login\_user\_by\_credentials($credentials= array(),$secure\_cookie=''){ |
| [157](#L157) | return wp\_signon($credentials,$secure\_cookie); |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | public function update\_meta($user\_id, $meta, $value) { |
| [161](#L161) | $meta = 'erf\_' . $meta; |
| [162](#L162) | $status= update\_user\_meta($user\_id, $meta, $value); |
| [163](#L163) | do\_action('erf\_user\_meta\_updated',$meta,$user\_id,$value,$status); |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | public function get\_meta($user\_id, $meta,$single= true) { |
| [167](#L167) | $meta = 'erf\_'.$meta; |
| [168](#L168) | return get\_user\_meta($user\_id, $meta, $single); |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | public function login\_redirect($redirect\_to,$requested\_redirect\_to,$user){ |
| [172](#L172) | if(is\_wp\_error($user) || empty($user)) |
| [173](#L173) | return $redirect\_to; |
| [174](#L174) |  |
| [175](#L175) | if(empty($user->ID)) |
| [176](#L176) | return $redirect\_to; |
| [177](#L177) |  |
| [178](#L178) | $redirect\_to= $this->redirection\_url\_after\_login($redirect\_to,$user); |
| [179](#L179) | return $redirect\_to; |
| [180](#L180) |  |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | /\* |
| [184](#L184) | \* Process login form. |
| [185](#L185) | \*/ |
| [186](#L186) | public function process\_login(){ |
| [187](#L187) | $response= array('success'=>0,'msg'=>''); |
| [188](#L188) | $options= erforms()->options->get\_options(); |
| [189](#L189) |  |
| [190](#L190) | $action= isset($\_POST['action']) ? sanitize\_text\_field(wp\_unslash($\_POST['action'])) : ''; |
| [191](#L191) | $username = isset($\_POST['erf\_username']) ? sanitize\_text\_field(wp\_unslash($\_POST['erf\_username'])) : ''; |
| [192](#L192) | $password = isset($\_POST['erf\_password']) ? sanitize\_text\_field($\_POST['erf\_password']) : ''; |
| [193](#L193) | if($action=='erf\_login\_user' && !empty($username) && !empty($password)){ |
| [194](#L194) | if(erforms\_login\_captcha\_enabled()){ |
| [195](#L195) | $g\_r\_captcha = isset($\_POST['g-recaptcha-response']) ? sanitize\_text\_field($\_POST['g-recaptcha-response']) : \_\_('Invalid Captcha','erforms'); |
| [196](#L196) | $valid = empty($g\_r\_captcha) ? false : erforms\_validate\_captcha($g\_r\_captcha); |
| [197](#L197) | if (!$valid) { // Invalid reCaptcha |
| [198](#L198) | $response['msg']= esc\_html(\_\_('Invalid/Expired Recapctha.', 'erforms')); |
| [199](#L199) | echo json\_encode($response); |
| [200](#L200) | wp\_die(); |
| [201](#L201) | } |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | if($options['allow\_login\_from']=='username'){ |
| [205](#L205) | $user= get\_user\_by('login',$username); |
| [206](#L206) | } |
| [207](#L207) | elseif($options['allow\_login\_from']=='email'){ |
| [208](#L208) | $user= get\_user\_by('email',$username); |
| [209](#L209) | } |
| [210](#L210) | else{ |
| [211](#L211) | $user= get\_user\_by('login',$username); |
| [212](#L212) | if(empty($user)){ |
| [213](#L213) | $user= get\_user\_by('email',$username); |
| [214](#L214) | } |
| [215](#L215) | } |
| [216](#L216) | if(!empty($user)){ |
| [217](#L217) | $creds = array(); |
| [218](#L218) | $creds['user\_login'] = $user->user\_login; |
| [219](#L219) | $creds['user\_password'] = $password; |
| [220](#L220) | $creds['remember']= isset($\_POST['rememberme']) ? true : false; |
| [221](#L221) |  |
| [222](#L222) | $user= $this->login\_user\_by\_credentials($creds,is\_ssl()); |
| [223](#L223) | if($user instanceof WP\_Error){ |
| [224](#L224) | $response['msg']= (isset($user->errors) && isset($user->errors['incorrect\_password'])) ? sprintf(\_\_('The password you entered for the username <strong>%s</strong> is incorrect.','erforms'),$username) : $user->get\_error\_message(); |
| [225](#L225) | } |
| [226](#L226) | else{ |
| [227](#L227) | $response['success']=1; |
| [228](#L228) | wp\_set\_current\_user($user->ID); |
| [229](#L229) | $redirect\_to= apply\_filters('erf\_login\_redirect','','',$user); |
| [230](#L230) | if(!empty($redirect\_to)){ |
| [231](#L231) | $response['redirect']= $redirect\_to; |
| [232](#L232) | } |
| [233](#L233) | else{ |
| [234](#L234) | $response['reload']= true; |
| [235](#L235) | } |
| [236](#L236) | } |
| [237](#L237) | } |
| [238](#L238) | else |
| [239](#L239) | { |
| [240](#L240) | $response['msg']= \_\_('ERROR: No such user exists.','erforms'); |
| [241](#L241) | } |
| [242](#L242) | } |
| [243](#L243) | $response['msg'] = $response['msg']; |
| [244](#L244) | $response['redirect']= !empty($response['redirect']) ? esc\_url\_raw($response['redirect']) : ''; |
| [245](#L245) | echo json\_encode($response); |
| [246](#L246) | wp\_die(); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | public function show\_profile\_fields($user){ |
| [250](#L250) | erforms\_show\_user\_fields($user); |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | public function update\_user\_status($user\_id){ |
| [254](#L254) | if ( !current\_user\_can( 'edit\_user', $user\_id ) ) |
| [255](#L255) | return false; |
| [256](#L256) | $current\_user= wp\_get\_current\_user(); |
| [257](#L257) |  |
| [258](#L258) | if($current\_user->ID==$user\_id) |
| [259](#L259) | return; |
| [260](#L260) |  |
| [261](#L261) | if(!isset($\_POST['erf\_user\_status'])) |
| [262](#L262) | return; |
| [263](#L263) |  |
| [264](#L264) | $active= absint($\_POST['erf\_user\_status']); |
| [265](#L265) | $current\_status= $this->get\_meta( $user\_id,'active'); |
| [266](#L266) | $this->update\_meta( $user\_id,'active',$active); |
| [267](#L267) |  |
| [268](#L268) | if($current\_status!=$active && $active==1) |
| [269](#L269) | { |
| [270](#L270) | do\_action('erf\_user\_activated',$user\_id); |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) | public function add\_user\_column($column\_headers) { |
| [276](#L276) | $column\_headers['user\_status'] = \_\_('User Status','erforms'); |
| [277](#L277) | return $column\_headers; |
| [278](#L278) | } |
| [279](#L279) |  |
| [280](#L280) | public function fill\_status\_column($value, $column\_name, $user\_id) { |
| [281](#L281) | $user = get\_userdata($user\_id); |
| [282](#L282) | if ('user\_status'==$column\_name) |
| [283](#L283) | { |
| [284](#L284) | $active= $this->get\_meta($user->ID,'active'); |
| [285](#L285) | if($active==='0') |
| [286](#L286) | return \_\_('Inactive','erforms'); |
| [287](#L287) | else |
| [288](#L288) | return \_\_('Active','erforms'); |
| [289](#L289) | } |
| [290](#L290) | return $value; |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | public function ajax\_before\_sub\_response($response){ |
| [294](#L294) | $submission= erforms()->submission->get\_submission($response['submission\_id']); |
| [295](#L295) | $form= erforms()->form->get\_form($submission['form\_id']); |
| [296](#L296) | $auto\_login = $form['auto\_login']; |
| [297](#L297) | $auto\_activation = $form['auto\_user\_activation']; |
| [298](#L298) | $redirect\_to= $form['redirect\_to']; |
| [299](#L299) | if (!is\_user\_logged\_in() && empty($redirect\_to) && !empty($auto\_login) && !empty($auto\_activation)) { |
| [300](#L300) | $response['msg']= \_\_('Please wait, While we are setting up your account.','erforms'); |
| [301](#L301) | $response['reload']= true; |
| [302](#L302) | } |
| [303](#L303) |  |
| [304](#L304) | if(erforms()->frontend->edit\_sub\_status){ |
| [305](#L305) | if(isset($response['redirect\_to'])) unset($response['redirect\_to']); |
| [306](#L306) | if(isset($response['reload'])) unset($response['reload']); |
| [307](#L307) | $response['msg']= \_\_('Submission edited successfully','erforms'); |
| [308](#L308) | } |
| [309](#L309) |  |
| [310](#L310) | return $response; |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | public function get\_user($user\_id){ |
| [314](#L314) | return get\_userdata($user\_id); |
| [315](#L315) | } |
| [316](#L316) |  |
| [317](#L317) | public function authenticate\_user($user, $username, $password){ |
| [318](#L318) | // username and password are correct |
| [319](#L319) | if ($user instanceof WP\_User) { |
| [320](#L320) | $is\_active = $this->get\_meta($user->ID, 'active'); |
| [321](#L321) | if($is\_active==='0') |
| [322](#L322) | { |
| [323](#L323) | return new WP\_Error('status\_deactive',\_\_('ERROR: Your account is not active.','erforms')); |
| [324](#L324) | } |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | return $user; |
| [328](#L328) | } |
| [329](#L329) |  |
| [330](#L330) | /\*\* |
| [331](#L331) | \* Check OTP. |
| [332](#L332) | \*/ |
| [333](#L333) | public function otp\_check($user\_login = '',$user\_otp='') { |
| [334](#L334) | $get\_method = 0; |
| [335](#L335) | if($user\_login!='' && $user\_otp!=''){ |
| [336](#L336) | $get\_method = 1; |
| [337](#L337) | }else{ |
| [338](#L338) | $user\_login= sanitize\_text\_field(wp\_unslash($\_POST['user\_login'])); |
| [339](#L339) | $user\_otp= sanitize\_text\_field(wp\_unslash($\_POST['user\_otp'])); |
| [340](#L340) | } |
| [341](#L341) | $response= array('success'=>0,'msg'=>\_\_('','erforms')); |
| [342](#L342) |  |
| [343](#L343) | if(empty($user\_login)){ |
| [344](#L344) | $response['msg']= \_\_('ERROR: Enter a username or email address.'); |
| [345](#L345) | }elseif(strpos($user\_login,'@')){ |
| [346](#L346) | $user\_data = get\_user\_by('email',$user\_login); |
| [347](#L347) | if (empty($user\_data)){ |
| [348](#L348) | $response['msg']= \_\_('ERROR: Something goes wrong, Please try again.'); |
| [349](#L349) | } |
| [350](#L350) | }else { |
| [351](#L351) | $user\_data = get\_user\_by('login',$user\_login); |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | if (!$user\_data) { |
| [355](#L355) | $response['msg']= \_\_('ERROR: Something goes wrong, Please try again.'); |
| [356](#L356) | }else{ |
| [357](#L357) | $get\_user\_otp = get\_user\_meta($user\_data->ID, 'erf\_user\_otp', true); |
| [358](#L358) | if($user\_otp==$get\_user\_otp){ |
| [359](#L359) | $response['success']=1; |
| [360](#L360) | $response['msg']= $user\_data->ID; |
| [361](#L361) | }else{ |
| [362](#L362) | $response['msg']= \_\_('ERROR: Invalid OTP, Please try again.'); |
| [363](#L363) | } |
| [364](#L364) | } |
| [365](#L365) |  |
| [366](#L366) | $response['msg'] = esc\_html($response['msg']); |
| [367](#L367) | if($get\_method==0){ |
| [368](#L368) | echo json\_encode($response); |
| [369](#L369) | }else{ |
| [370](#L370) | return $response; |
| [371](#L371) | } |
| [372](#L372) | exit; |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | /\*\* |
| [376](#L376) | \* Update Password OTP. |
| [377](#L377) | \*/ |
| [378](#L378) | public function update\_password() { |
| [379](#L379) | $user\_login= sanitize\_text\_field(wp\_unslash($\_POST['user\_login'])); |
| [380](#L380) | $user\_otp= sanitize\_text\_field(wp\_unslash($\_POST['user\_otp'])); |
| [381](#L381) | $user\_password= sanitize\_text\_field(wp\_unslash($\_POST['password'])); |
| [382](#L382) | $user\_cpassword= sanitize\_text\_field(wp\_unslash($\_POST['cpassword'])); |
| [383](#L383) | $response= array('success'=>0,'msg'=>\_\_('ERROR: Something goes wrong, Please try again.','erforms')); |
| [384](#L384) |  |
| [385](#L385) | $check\_otp = $this->otp\_check($user\_login,$user\_otp); |
| [386](#L386) | if($check\_otp['success']==1){ |
| [387](#L387) | if($user\_password==$user\_cpassword){ |
| [388](#L388) | if(strlen($user\_password)>4){ |
| [389](#L389) | wp\_set\_password($user\_password,$check\_otp['msg']); |
| [390](#L390) | $response['success']=1; |
| [391](#L391) | $response['msg']= 'Password Changed Successfully.'; |
| [392](#L392) | }else{ |
| [393](#L393) | $response['msg']= \_\_('ERROR: Password length should be minimum 5 characters'); |
| [394](#L394) | } |
| [395](#L395) | }else{ |
| [396](#L396) | $response['msg']= \_\_('ERROR: Password and Confirm Password should be same'); |
| [397](#L397) | } |
| [398](#L398) | } |
| [399](#L399) |  |
| [400](#L400) | $response['msg'] = esc\_html($response['msg']); |
| [401](#L401) | echo json\_encode($response); |
| [402](#L402) | exit; |
| [403](#L403) | } |
| [404](#L404) |  |
| [405](#L405) | /\*\* |
| [406](#L406) | \* Initiates password reset. |
| [407](#L407) | \*/ |
| [408](#L408) | public function reset\_password() { |
| [409](#L409) | $user\_login= sanitize\_text\_field(wp\_unslash($\_POST['user\_login'])); |
| [410](#L410) | $response= array('success'=>1,'msg'=>\_\_('Check your email for the OTP.','erforms')); |
| [411](#L411) | if(empty($user\_login)){ |
| [412](#L412) | $response['msg']= \_\_('Please provide a valid email or username'); |
| [413](#L413) | } |
| [414](#L414) |  |
| [415](#L415) | $errors = $this->retrieve\_password($user\_login); |
| [416](#L416) | if (is\_wp\_error($errors)) { |
| [417](#L417) | $response['msg']=  $errors->get\_error\_message(); |
| [418](#L418) | $response['success']=0; |
| [419](#L419) | } |
| [420](#L420) | $response['msg'] = esc\_html($response['msg']); |
| [421](#L421) | echo json\_encode($response); |
| [422](#L422) | exit; |
| [423](#L423) | } |
| [424](#L424) |  |
| [425](#L425) |  |
| [426](#L426) | public function retrieve\_password($user\_login){ |
| [427](#L427) | $errors = new WP\_Error(); |
| [428](#L428) | if (empty($user\_login)){ |
| [429](#L429) | $errors->add('empty\_username', \_\_('<strong>ERROR</strong>: Enter a username or email address.')); |
| [430](#L430) | } elseif(strpos($user\_login,'@')){ |
| [431](#L431) | $user\_data = get\_user\_by('email',$user\_login); |
| [432](#L432) | if (empty($user\_data)) |
| [433](#L433) | $errors->add('invalid\_email', \_\_('<strong>ERROR</strong>: There is no user registered with that email address.')); |
| [434](#L434) | } else { |
| [435](#L435) | $user\_data = get\_user\_by('login',$user\_login); |
| [436](#L436) | } |
| [437](#L437) |  |
| [438](#L438) | do\_action( 'lostpassword\_post', $errors ); |
| [439](#L439) | if ($errors->get\_error\_code()) |
| [440](#L440) | return $errors; |
| [441](#L441) |  |
| [442](#L442) | if (!$user\_data) { |
| [443](#L443) | $errors->add('invalidcombo', \_\_('<strong>ERROR</strong>: Invalid username or email.','erforms')); |
| [444](#L444) | return $errors; |
| [445](#L445) | } |
| [446](#L446) | $options= erforms()->options->get\_options(); |
| [447](#L447) | // Redefining user\_login ensures we return the right case in the email. |
| [448](#L448) | $user\_login = $user\_data->user\_login; |
| [449](#L449) | $user\_email = $user\_data->user\_email; |
| [450](#L450) | $user\_id = $user\_data->ID; |
| [451](#L451) | $random\_number = wp\_generate\_password(12); |
| [452](#L452) | update\_user\_meta($user\_id,'erf\_user\_otp',$random\_number); |
| [453](#L453) | $message = str\_replace(array('{{user\_login}}','{{otp}}'), array($user\_login,$random\_number), $options['forgot\_pass\_email']); |
| [454](#L454) | $title = $options['forgot\_pass\_email\_subject']; |
| [455](#L455) | $title = apply\_filters( 'retrieve\_password\_title', $title, $user\_login, $user\_data ); |
| [456](#L456) | $message = apply\_filters( 'erforms\_password\_message', $message, $user\_login, $user\_data ); |
| [457](#L457) |  |
| [458](#L458) | if ($message && !wp\_mail($user\_email,wp\_specialchars\_decode($title),$message)){ |
| [459](#L459) | return new WP\_Error('erf\_email\_error',\_\_('The email could not be sent.','erforms')); |
| [460](#L460) | } |
| [461](#L461) | return true; |
| [462](#L462) | } |
| [463](#L463) |  |
| [464](#L464) | public function check\_user\_by\_username($commands,$form){ |
| [465](#L465) | if(is\_user\_logged\_in()){ |
| [466](#L466) | return $commands; |
| [467](#L467) | } |
| [468](#L468) | $username= sanitize\_text\_field(wp\_unslash($\_POST['field\_value'])); |
| [469](#L469) | if(empty($username)){ |
| [470](#L470) | return $commands; |
| [471](#L471) | } |
| [472](#L472) | $command= erforms\_default\_field\_command(); |
| [473](#L473) | if(username\_exists($username)){ |
| [474](#L474) | $command['error']= \_\_('Username already exists.','erforms'); |
| [475](#L475) | } |
| [476](#L476) | array\_push($commands,$command); |
| [477](#L477) | return $commands; |
| [478](#L478) | } |
| [479](#L479) |  |
| [480](#L480) | public function check\_user\_by\_email($commands,$form){ |
| [481](#L481) | if(is\_user\_logged\_in()){ |
| [482](#L482) | return $commands; |
| [483](#L483) | } |
| [484](#L484) | $email= sanitize\_text\_field(wp\_unslash($\_POST['field\_value'])); |
| [485](#L485) | if(empty($email)){ |
| [486](#L486) | return $commands; |
| [487](#L487) | } |
| [488](#L488) | $command= erforms\_default\_field\_command(); |
| [489](#L489) | $exists = email\_exists($email); |
| [490](#L490) | if(!empty($exists)){ |
| [491](#L491) | $command['error']= \_\_('Email already exists.','erforms'); |
| [492](#L492) | } |
| [493](#L493) | array\_push($commands,$command); |
| [494](#L494) | return $commands; |
| [495](#L495) | } |
| [496](#L496) |  |
| [497](#L497) | /\* |
| [498](#L498) | \* Change password for authenticated users |
| [499](#L499) | \*/ |
| [500](#L500) | public function change\_password\_ajax(){ |
| [501](#L501) | // Delete report action |
| [502](#L502) | if (defined('DOING\_AJAX') && DOING\_AJAX){ |
| [503](#L503) | $errors= array(); |
| [504](#L504) | $nonce=  isset($\_POST['erform\_change\_pwd\_nonce']) ? sanitize\_text\_field($\_POST['erform\_change\_pwd\_nonce']) : ''; |
| [505](#L505) | if (!wp\_verify\_nonce($nonce,'erform\_change\_pwd\_nonce')) { |
| [506](#L506) | $errors[]=\_\_('Invalid Security Token, Please refresh the page and try again','erforms'); |
| [507](#L507) | wp\_send\_json\_error(array('errors'=>$errors)); |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | $current\_password= sanitize\_text\_field(wp\_unslash($\_POST['password\_current'])); |
| [511](#L511) | if(empty($current\_password)){ |
| [512](#L512) | $errors[]=\_\_('Current Password Required.','erforms'); |
| [513](#L513) | wp\_send\_json\_error(array('errors'=>$errors)); |
| [514](#L514) | } |
| [515](#L515) |  |
| [516](#L516) | $current\_user = wp\_get\_current\_user(); |
| [517](#L517) | // Check current password |
| [518](#L518) | $match= wp\_check\_password($current\_password, $current\_user->user\_pass, $current\_user->ID); |
| [519](#L519) | if(empty($match)){ |
| [520](#L520) | $errors[]=\_\_('Current Password Incorrect.','erforms'); |
| [521](#L521) | wp\_send\_json\_error(array('errors'=>$errors)); |
| [522](#L522) | } |
| [523](#L523) |  |
| [524](#L524) | $password\_1= sanitize\_text\_field(wp\_unslash($\_POST['password\_1'])); |
| [525](#L525) | if(empty($password\_1)){ |
| [526](#L526) | $errors[]=\_\_('New Password Required.','erforms'); |
| [527](#L527) | wp\_send\_json\_error(array('errors'=>$errors)); |
| [528](#L528) | } |
| [529](#L529) |  |
| [530](#L530) | wp\_set\_password($password\_1,$current\_user->ID); |
| [531](#L531) |  |
| [532](#L532) | // Log-in again. |
| [533](#L533) | wp\_set\_auth\_cookie($current\_user->ID); |
| [534](#L534) | wp\_set\_current\_user($current\_user->ID); |
| [535](#L535) | do\_action('wp\_login', $current\_user->user\_login, $current\_user); |
| [536](#L536) | wp\_send\_json\_success(array('msg'=>\_\_('Password changed successfully.','erforms'))); |
| [537](#L537) | } |
| [538](#L538) | } |
| [539](#L539) |  |
| [540](#L540) | // Called when Account verification page is not configured |
| [541](#L541) | public function ajax\_account\_verification(){ |
| [542](#L542) | $hash= isset($\_REQUEST['erf\_account\_hash']) ? sanitize\_text\_field($\_REQUEST['erf\_account\_hash']) : ''; |
| [543](#L543) | if(empty($hash)){ |
| [544](#L544) | \_e('Missing verification hash','erforms'); |
| [545](#L545) | wp\_die(); |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | $form\_id= isset($\_REQUEST['erf\_form']) ? absint($\_REQUEST['erf\_form']) : 0; |
| [549](#L549) | $form= erforms()->form->get\_form($form\_id); |
| [550](#L550) | if(empty($form)){ |
| [551](#L551) | \_e('Form not found.','erforms'); |
| [552](#L552) | wp\_die(); |
| [553](#L553) | } |
| [554](#L554) |  |
| [555](#L555) | // Find User |
| [556](#L556) | $user\_meta\_query= array( |
| [557](#L557) | array( |
| [558](#L558) | 'key'=>$this->meta\_prefix.'verification\_hash', |
| [559](#L559) | 'value'=>$hash, |
| [560](#L560) | 'compare'=>'' |
| [561](#L561) | ) |
| [562](#L562) | ); |
| [563](#L563) | $users= get\_users(array('meta\_query'=>$user\_meta\_query)); |
| [564](#L564) | if(empty($users)){ |
| [565](#L565) | \_e('No such users exists','erforms'); |
| [566](#L566) | wp\_die(); |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | foreach($users as $user){ // Execute block only for first user as verification hash meant to be unique |
| [570](#L570) | $current\_status= $this->get\_meta($user->ID,'active'); |
| [571](#L571) | if($current\_status==='' || !empty($current\_status)) |
| [572](#L572) | { |
| [573](#L573) | \_e('User account is already activated','erforms'); |
| [574](#L574) | } |
| [575](#L575) | else |
| [576](#L576) | { |
| [577](#L577) | $this->update\_meta($user->ID, 'active', 1); |
| [578](#L578) | do\_action('erf\_user\_activated',$user->ID); |
| [579](#L579) | //delete\_user\_meta($user->ID,$this->meta\_prefix.'verification\_hash'); |
| [580](#L580) | $auto\_login = $form['auto\_login\_after\_ver']; |
| [581](#L581) | $redirect\_to= home\_url(); |
| [582](#L582) | if (!empty($auto\_login)) { |
| [583](#L583) | $this->login\_user\_by\_id($user->ID); |
| [584](#L584) | $redirect\_to= $this->redirection\_url\_after\_login($redirect\_to,$user); |
| [585](#L585) | } |
| [586](#L586) | do\_action('erf\_user\_account\_verified',$user); |
| [587](#L587) | echo strip\_shortcodes($form['user\_acc\_verification\_msg']); |
| [588](#L588) | echo '<script>document.location="'.$redirect\_to.'";</script>'; |
| [589](#L589) | } |
| [590](#L590) | break; |
| [591](#L591) | } |
| [592](#L592) | exit; |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | // Registered with [erforms\_account\_verification] shortcode |
| [596](#L596) | public function account\_verification(){ |
| [597](#L597) | ob\_start(); |
| [598](#L598) | $hash= isset($\_REQUEST['erf\_account\_hash']) ? sanitize\_text\_field($\_REQUEST['erf\_account\_hash']) : ''; |
| [599](#L599) | if(empty($hash)){ |
| [600](#L600) | return ob\_get\_clean(); |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | $form\_id= isset($\_REQUEST['erf\_form']) ? absint($\_REQUEST['erf\_form']) : 0; |
| [604](#L604) | $form= erforms()->form->get\_form($form\_id); |
| [605](#L605) | if(empty($form) || $form['type']!='reg'){ |
| [606](#L606) | return ob\_get\_clean(); |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | // Find User |
| [610](#L610) | $user\_meta\_query= array( |
| [611](#L611) | array( |
| [612](#L612) | 'key'=>$this->meta\_prefix.'verification\_hash', |
| [613](#L613) | 'value'=>$hash, |
| [614](#L614) | 'compare'=>'' |
| [615](#L615) | ) |
| [616](#L616) | ); |
| [617](#L617) | $users= get\_users(array('meta\_query'=>$user\_meta\_query)); |
| [618](#L618) | if(empty($users)){ |
| [619](#L619) | \_e('Verification link does not match with any User\'s record.','erforms'); |
| [620](#L620) | return ob\_get\_clean(); |
| [621](#L621) | } |
| [622](#L622) | if(is\_user\_logged\_in()){ |
| [623](#L623) | include('html/account\_verification.php'); |
| [624](#L624) | return ob\_get\_clean(); |
| [625](#L625) | } |
| [626](#L626) |  |
| [627](#L627) | foreach($users as $user){ // Execute block only for first user as verification hash meant to be unique |
| [628](#L628) | $current\_status= $this->get\_meta($user->ID,'active'); |
| [629](#L629) | if($current\_status==='' || !empty($current\_status)) |
| [630](#L630) | { |
| [631](#L631) | \_e('User account is already activated','erforms'); |
| [632](#L632) | } |
| [633](#L633) | else |
| [634](#L634) | { |
| [635](#L635) | $this->update\_meta($user->ID, 'active', 1); |
| [636](#L636) | do\_action('erf\_user\_activated',$user->ID); |
| [637](#L637) | //delete\_user\_meta($user->ID,$this->meta\_prefix.'verification\_hash'); |
| [638](#L638) | include('html/account\_verification.php'); |
| [639](#L639) | do\_action('erf\_user\_account\_verified',$user); |
| [640](#L640) | } |
| [641](#L641) | break; |
| [642](#L642) | } |
| [643](#L643) | return ob\_get\_clean(); |
| [644](#L644) | } |
| [645](#L645) |  |
| [646](#L646) | // Logins user from AJAX request. Example: Used in Auto Login after successfull account verification |
| [647](#L647) | public function ajax\_log\_in(){ |
| [648](#L648) | $type= sanitize\_text\_field($\_POST['type']); |
| [649](#L649) | $value= sanitize\_text\_field($\_POST['value']); |
| [650](#L650) |  |
| [651](#L651) | if(empty($type) || empty($value)){ |
| [652](#L652) | wp\_send\_json\_error(); |
| [653](#L653) | } |
| [654](#L654) |  |
| [655](#L655) | if($type=='user\_hash'){ |
| [656](#L656) | $user\_meta\_query= array( |
| [657](#L657) | array( |
| [658](#L658) | 'key'=>$this->meta\_prefix.'verification\_hash', |
| [659](#L659) | 'value'=>$value, |
| [660](#L660) | 'compare'=>'' |
| [661](#L661) | ) |
| [662](#L662) | ); |
| [663](#L663) | $users= get\_users(array('meta\_query'=>$user\_meta\_query)); |
| [664](#L664) | if(empty($users)){ |
| [665](#L665) | wp\_send\_json\_error(); |
| [666](#L666) | } |
| [667](#L667) | $options= erforms()->options->get\_options(); |
| [668](#L668) | foreach($users as $user){ |
| [669](#L669) | $this->login\_user\_by\_id($user->ID); |
| [670](#L670) | $redirect\_to= sanitize\_text\_field($\_POST['redirect\_to']); |
| [671](#L671) | $redirect\_to= $this->redirection\_url\_after\_login($redirect\_to,$user); |
| [672](#L672) | break; |
| [673](#L673) | } |
| [674](#L674) | wp\_send\_json\_success(array('redirect\_to'=>esc\_url($redirect\_to))); |
| [675](#L675) | } |
| [676](#L676) | wp\_send\_json\_success(); |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | // Returns redirection URL as configured in Global Settings |
| [680](#L680) | public function redirection\_url\_after\_login($default\_url,$user){ |
| [681](#L681) | $options= erforms()->options->get\_options(); |
| [682](#L682) | if(!empty($options['en\_role\_redirection'])){ |
| [683](#L683) | foreach($user->roles as $role){ |
| [684](#L684) | if(!empty($options[$role.'\_login\_redirection'])){ |
| [685](#L685) | $default\_url= $options[$role.'\_login\_redirection']; |
| [686](#L686) | break; |
| [687](#L687) | } |
| [688](#L688) | } |
| [689](#L689) | } |
| [690](#L690) | else if(!empty($options['after\_login\_redirect\_url'])) |
| [691](#L691) | { |
| [692](#L692) | $default\_url = $options['after\_login\_redirect\_url']; |
| [693](#L693) | } |
| [694](#L694) | return $default\_url; |
| [695](#L695) | } |
| [696](#L696) |  |
| [697](#L697) | public function resend\_verification\_link($attrs){ |
| [698](#L698) | if(empty($attrs['sub\_id'])) |
| [699](#L699) | return ''; |
| [700](#L700) | $label= empty($attrs['label']) ? \_\_('resend verification link','erforms') : $attrs['label']; |
| [701](#L701) | $nonce= wp\_create\_nonce('erf-resend-verification'); |
| [702](#L702) | $html= "<a data-sub='".$attrs['sub\_id']."' data-nonce='$nonce' class='erf\_resend\_ver\_link' href='javascript:void(0)'>$label</a>"; |
| [703](#L703) | return $html; |
| [704](#L704) | } |
| [705](#L705) |  |
| [706](#L706) | public function resend\_verification(){ |
| [707](#L707) | $nonce= sanitize\_text\_field($\_POST['nonce']); |
| [708](#L708) | if (!wp\_verify\_nonce($nonce,'erf-resend-verification')) { |
| [709](#L709) | wp\_send\_json\_error(array('msg'=>\_\_('Security token expired.','erforms'))); |
| [710](#L710) | } |
| [711](#L711) | $sub= sanitize\_text\_field($\_POST['sub']); |
| [712](#L712) | $submission= erforms()->submission->get\_submission($sub); |
| [713](#L713) | if(empty($submission)){ |
| [714](#L714) | wp\_send\_json\_error(array('msg'=>\_\_('System is unable to send verification email.','erforms'))); |
| [715](#L715) | } |
| [716](#L716) | //Check if user exists in WordPress |
| [717](#L717) | $user= get\_user\_by('id',$submission['user']['ID']); |
| [718](#L718) | if(empty($user)){ // User is no more available in WordPress |
| [719](#L719) | wp\_send\_json\_error(array('msg'=>\_\_('User data is unavailable.','erforms'))); |
| [720](#L720) | } |
| [721](#L721) | $is\_active= $this->get\_meta($user->ID, 'active'); |
| [722](#L722) | if(!empty($is\_active)){ |
| [723](#L723) | wp\_send\_json\_error(array('msg'=>\_\_('User is already verified.','erforms'))); |
| [724](#L724) | } |
| [725](#L725) | $hash= $this->get\_meta($user->ID,'verification\_hash'); |
| [726](#L726) | if(empty($hash)){ |
| [727](#L727) | wp\_send\_json\_error(array('msg'=>\_\_('No verification key available.','erforms'))); |
| [728](#L728) | } |
| [729](#L729) | $form= erforms()->form->get\_form($submission['form\_id']); |
| [730](#L730) | do\_action('erf\_send\_verification\_link',$user->ID,$hash,$form,$submission['id']); |
| [731](#L731) | wp\_send\_json\_success(array('msg'=>\_\_('Verification link has been sent. Please check your email.','erforms'))); |
| [732](#L732) | } |
| [733](#L733) |  |
| [734](#L734) | /\* |
| [735](#L735) | \* Returns User meta data as per the field's configuration in Form. |
| [736](#L736) | \*/ |
| [737](#L737) | public function frontend\_localize\_user\_meta($form) { |
| [738](#L738) | $user\_meta = array('attachments'=>array()); |
| [739](#L739) | // Looping through form fields for user meta |
| [740](#L740) | if (is\_user\_logged\_in()) { |
| [741](#L741) | $user = wp\_get\_current\_user(); |
| [742](#L742) | if (is\_array($form['fields'])) { |
| [743](#L743) | foreach ($form['fields'] as $field) { |
| [744](#L744) | if (!empty($field['name']) && !empty($field['addUserField']) && !empty($field['addUserFieldMap'])) { |
| [745](#L745) | $m\_keys = explode(',', $field['addUserFieldMap']); |
| [746](#L746) | if($m\_keys[0] == 'user\_email' && $form['type']=='contact'){ |
| [747](#L747) | $user\_meta[$field['name']] = $user->user\_email; |
| [748](#L748) | } else { |
| [749](#L749) | $user\_meta[$field['name']] = get\_user\_meta($user->ID, $m\_keys[0], true); |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | if(!empty($field['type']) && $field['type']=='file' && !empty($user\_meta[$field['name']])){ |
| [753](#L753) | $attachment= array(); |
| [754](#L754) | $attachment\_id= $user\_meta[$field['name']]; |
| [755](#L755) | $attachment\_submission\_id = erforms\_get\_post\_meta($attachment\_id,'submission\_id'); |
| [756](#L756) | if(wp\_attachment\_is\_image($attachment\_id)){ |
| [757](#L757) | $attachment['image\_url']= erforms\_get\_attachment\_url($attachment\_id,$attachment\_submission\_id); |
| [758](#L758) | } |
| [759](#L759) | else{ |
| [760](#L760) | $link\_url = erforms\_get\_attachment\_url($attachment\_id,$attachment\_submission\_id); |
| [761](#L761) | if(!empty($link\_url)){ |
| [762](#L762) | $attachment['link\_url']= $link\_url; |
| [763](#L763) | $attachment['link\_label']= ucwords(get\_the\_title($attachment\_id)); |
| [764](#L764) | } |
| [765](#L765) | } |
| [766](#L766) | if(!empty($attachment)){ |
| [767](#L767) | $attachment['f\_label']= $field['label']; |
| [768](#L768) | $attachment['f\_name']= $field['name']; |
| [769](#L769) | $attachment['f\_val']= $attachment\_id; |
| [770](#L770) | array\_push($user\_meta['attachments'],$attachment); |
| [771](#L771) | } |
| [772](#L772) | } |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | if($form['type']=='reg'){ |
| [776](#L776) | // Username field |
| [777](#L777) | if($field['type']=='username'){ |
| [778](#L778) | $user\_meta[$field['name']] = $user->user\_login; |
| [779](#L779) | } |
| [780](#L780) | else if($field['type']=='user\_email'){ |
| [781](#L781) | $user\_meta[$field['name']] = $user->user\_email; |
| [782](#L782) | } |
| [783](#L783) | else if($field['type']=='password'){ |
| [784](#L784) | $user\_meta[$field['name']] = 'Cheating!!!'; |
| [785](#L785) | } |
| [786](#L786) |  |
| [787](#L787) | } |
| [788](#L788) | } |
| [789](#L789) | } |
| [790](#L790) | } |
| [791](#L791) | return $user\_meta; |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) | public function user\_meta\_updated($key,$user\_id,$value,$status){ |
| [795](#L795) | if($key=='user\_url'){ |
| [796](#L796) | wp\_update\_user(array('ID'=>$user\_id,$key=>$value)); |
| [797](#L797) | } |
| [798](#L798) | } |
| [799](#L799) |  |
| [800](#L800) | public function post\_submission\_completed($sub\_id){ |
| [801](#L801) | $submission = erforms()->submission->get\_submission($sub\_id); |
| [802](#L802) | if(empty($submission) || empty($submission['user']) || erforms()->initial\_login\_status) |
| [803](#L803) | return; |
| [804](#L804) |  |
| [805](#L805) | $plans = !empty($submission['plans']) ? $submission['plans'] : array(); |
| [806](#L806) | $u = new WP\_User($submission['user']['ID']); |
| [807](#L807) | if(empty($u->ID)) |
| [808](#L808) | return; |
| [809](#L809) | $existing\_roles = $this->get\_user\_roles($submission['user']['ID']); |
| [810](#L810) | $new\_roles = array(); |
| [811](#L811) | foreach($plans as $p){ |
| [812](#L812) | $plan = erforms()->plan->get\_plan($p['id']); |
| [813](#L813) | if(!empty($plan) && !empty($plan['en\_role'])){ // Assign user role |
| [814](#L814) | $selected\_roles = $plan['roles']; |
| [815](#L815) |  |
| [816](#L816) | if(!empty($selected\_roles)){ |
| [817](#L817) | foreach($selected\_roles as $r){ |
| [818](#L818) | $u->add\_role($r); |
| [819](#L819) | array\_push($new\_roles,$r); |
| [820](#L820) | } |
| [821](#L821) | if(!empty($plan['del\_old\_role'])){ // Removing previous user roles |
| [822](#L822) | foreach($existing\_roles as $index=>$r){ // Removing previous roles |
| [823](#L823) | if(!in\_array($r,$new\_roles)){ |
| [824](#L824) | $u->remove\_role($r); |
| [825](#L825) | unset($existing\_roles[$index]); |
| [826](#L826) | } |
| [827](#L827) | } |
| [828](#L828) | } |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | } |
| [832](#L832) | } |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | public function user\_meta\_for\_shortcode($args){ |
| [836](#L836) | $meta\_key = isset($args['key']) ? sanitize\_text\_field($args['key']) : ''; |
| [837](#L837) | if(empty($meta\_key)){ |
| [838](#L838) | return ''; |
| [839](#L839) | } |
| [840](#L840) | $user\_id = isset($args['id']) ? sanitize\_text\_field($args['id']) : ''; |
| [841](#L841) | if(empty($user\_id)){ |
| [842](#L842) | $user = wp\_get\_current\_user(); |
| [843](#L843) | if(!empty($user->ID)){ |
| [844](#L844) | $user\_id = $user->ID; |
| [845](#L845) | } |
| [846](#L846) | } |
| [847](#L847) | if(empty($user\_id)) |
| [848](#L848) | return ''; |
| [849](#L849) |  |
| [850](#L850) | $meta\_value = get\_user\_meta($user\_id,$meta\_key,true); |
| [851](#L851) | if(empty($meta\_value)){ |
| [852](#L852) | return ''; |
| [853](#L853) | } |
| [854](#L854) | if(is\_array($meta\_value)){ |
| [855](#L855) | return implode(',', $meta\_value); |
| [856](#L856) | } |
| [857](#L857) | return $meta\_value; |
| [858](#L858) | } |
| [859](#L859) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/easy-registration-forms/tags/2.1.1/includes/class-user.php?format=txt)
* [Original Format](/export/3222468/easy-registration-forms/tags/2.1.1/includes/class-user.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


