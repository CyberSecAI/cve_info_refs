=== Content from plugins.trac.wordpress.org_82b0ea58_20250114_191430.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Ftags%2F1.3.7.2%2Finc%2Fdnd-upload-cf7.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php)

---

# [source:](/browser?order=name "Go to repository root") [drag-and-drop-multiple-file-upload-contact-form-7](/browser/drag-and-drop-multiple-file-upload-contact-form-7?order=name "View drag-and-drop-multiple-file-upload-contact-form-7")/[tags](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags?order=name "View tags")/[1.3.7.2](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2?order=name "View 1.3.7.2")/[inc](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc?order=name "View inc")/[dnd-upload-cf7.php](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?order=name "View dnd-upload-cf7.php")

View diff against:

View revision:

| [Last change](/changeset/2968538/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php "View differences") on this file was [2968538](/changeset/2968538/ "View changeset 2968538"), checked in by glenwpcoder, [16 months ago](/timeline?from=2023-09-19T04%3A40%3A32Z&precision=second "See timeline at 09/19/2023 04:40:32 AM") |
| --- |
| * Released version 1.3.7.3 |
| **File size:** 51.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* @Description : Plugin main core |
| [5](#L5) | \* @Package : Drag & Drop Multiple File Upload - Contact Form 7 |
| [6](#L6) | \* @Author : Glen Don L. Mongaya |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | if ( ! defined( 'ABSPATH' ) || ! defined('dnd\_upload\_cf7') ) { |
| [10](#L10) | exit; |
| [11](#L11) | } |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* Begin : begin plugin hooks |
| [15](#L15) | \*/ |
| [16](#L16) |  |
| [17](#L17) | add\_action( 'wpcf7\_init', 'dnd\_cf7\_upload\_add\_form\_tag\_file' ); |
| [18](#L18) | add\_action( 'wpcf7\_enqueue\_scripts', 'dnd\_cf7\_scripts' ); |
| [19](#L19) |  |
| [20](#L20) | // Hook on plugins loaded |
| [21](#L21) | add\_action('plugins\_loaded','dnd\_cf7\_upload\_plugins\_loaded'); |
| [22](#L22) |  |
| [23](#L23) | // Ajax Upload |
| [24](#L24) | add\_action( 'wp\_ajax\_dnd\_codedropz\_upload', 'dnd\_upload\_cf7\_upload' ); |
| [25](#L25) | add\_action( 'wp\_ajax\_nopriv\_dnd\_codedropz\_upload', 'dnd\_upload\_cf7\_upload' ); |
| [26](#L26) |  |
| [27](#L27) | // Hook - Ajax Delete |
| [28](#L28) | add\_action('wp\_ajax\_nopriv\_dnd\_codedropz\_upload\_delete', 'dnd\_codedropz\_upload\_delete'); |
| [29](#L29) | add\_action('wp\_ajax\_dnd\_codedropz\_upload\_delete','dnd\_codedropz\_upload\_delete'); |
| [30](#L30) |  |
| [31](#L31) | // Ajax Nonce check |
| [32](#L32) | add\_action('wp\_ajax\_\_wpcf7\_check\_nonce', 'dnd\_wpcf7\_nonce\_check'); |
| [33](#L33) | add\_action('wp\_ajax\_nopriv\_\_wpcf7\_check\_nonce', 'dnd\_wpcf7\_nonce\_check'); |
| [34](#L34) |  |
| [35](#L35) | // Hook mail cf7 |
| [36](#L36) | add\_filter('wpcf7\_posted\_data', 'dnd\_wpcf7\_posted\_data', 10, 1); |
| [37](#L37) | add\_action('wpcf7\_before\_send\_mail','dnd\_cf7\_before\_send\_mail', 30, 1); |
| [38](#L38) | add\_action('wpcf7\_mail\_components','dnd\_cf7\_mail\_components', 50, 2); |
| [39](#L39) |  |
| [40](#L40) | // Auto clean up dir/files |
| [41](#L41) | add\_action('template\_redirect', 'dnd\_cf7\_auto\_clean\_dir', 20, 0 ); |
| [42](#L42) |  |
| [43](#L43) | // Add row meta links |
| [44](#L44) | add\_filter( 'plugin\_row\_meta', 'dnd\_custom\_plugin\_row\_meta', 10, 2 ); |
| [45](#L45) |  |
| [46](#L46) | // Add custom mime-type |
| [47](#L47) | add\_filter('upload\_mimes', 'dnd\_extra\_mime\_types', 1, 1); |
| [48](#L48) |  |
| [49](#L49) | // Plugin settings |
| [50](#L50) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( dnd\_upload\_cf7\_directory ) .'/drag-n-drop-upload-cf7.php', 'dnd\_cf7\_upload\_links' ); |
| [51](#L51) |  |
| [52](#L52) | // Add Submenu - Settings |
| [53](#L53) | add\_action('admin\_menu', 'dnd\_admin\_settings'); |
| [54](#L54) |  |
| [55](#L55) | // Add custom script in footer |
| [56](#L56) | add\_action('wp\_footer','dnd\_custom\_scripts'); |
| [57](#L57) | add\_action('wp\_footer','dnd\_custom\_style'); |
| [58](#L58) |  |
| [59](#L59) | // Flamingo Hooks |
| [60](#L60) | add\_action('before\_delete\_post', 'dnd\_remove\_uploaded\_files'); |
| [61](#L61) |  |
| [62](#L62) | // Nonce |
| [63](#L63) | function dnd\_wpcf7\_nonce\_check(){ |
| [64](#L64) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', false, false ) ){ |
| [65](#L65) | wp\_send\_json\_success( wp\_create\_nonce( "dnd-cf7-security-nonce" ) ); |
| [66](#L66) | } |
| [67](#L67) | } |
| [68](#L68) |  |
| [69](#L69) | // Add links to settings |
| [70](#L70) | function dnd\_cf7\_upload\_links( $actions ) { |
| [71](#L71) | $upload\_links = array('<a href="' . admin\_url( 'admin.php?page=drag-n-drop-upload' ) . '">Settings</a>',); |
| [72](#L72) | $actions = array\_merge( $upload\_links, $actions ); |
| [73](#L73) | return $actions; |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | // Load plugin text-domain |
| [77](#L77) | function dnd\_cf7\_upload\_plugins\_loaded() { |
| [78](#L78) |  |
| [79](#L79) | // Load language domain |
| [80](#L80) | load\_plugin\_textdomain( 'drag-and-drop-multiple-file-upload-contact-form-7', false, dirname( dirname( plugin\_basename( \_\_FILE\_\_ ) ) ) . '/languages' ); |
| [81](#L81) |  |
| [82](#L82) | // Create dir |
| [83](#L83) | $dir = dnd\_get\_upload\_dir(); |
| [84](#L84) | if( isset( $dir['upload\_dir'] ) && is\_dir( $dir['upload\_dir'] ) ) { |
| [85](#L85) | // Generate .htaccess file` |
| [86](#L86) | $htaccess\_file = path\_join( dirname( $dir['upload\_dir'] ), '.htaccess' ); |
| [87](#L87) | if ( ! file\_exists( $htaccess\_file ) ) { |
| [88](#L88) | if ( $handle = fopen( $htaccess\_file, 'w' ) ) { |
| [89](#L89) | fwrite( $handle, "Options -Indexes \n <Files \*.php> \n deny from all \n </Files>" ); |
| [90](#L90) | fclose( $handle ); |
| [91](#L91) | } |
| [92](#L92) | } |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | // fix spam |
| [96](#L96) | if( get\_option('drag\_n\_drop\_fix\_spam') == 'yes' ) { |
| [97](#L97) | add\_filter('wpcf7\_spam', function(){ |
| [98](#L98) | return false; |
| [99](#L99) | }); |
| [100](#L100) | } |
| [101](#L101) | } |
| [102](#L102) |  |
| [103](#L103) | // Remove uploaded files when item is deleted permanently. |
| [104](#L104) | function dnd\_remove\_uploaded\_files( $post\_id ) { |
| [105](#L105) | $post\_type = get\_post\_type( $post\_id ); |
| [106](#L106) | $page = get\_post( $post\_id ); |
| [107](#L107) | if( $post\_type == 'flamingo\_inbound' ) { |
| [108](#L108) | preg\_match\_all( '/(.\*?)(\/'.wpcf7\_dnd\_dir.'\/wpcf7-files\/.\*$)/m', $page->post\_content, $matches ); |
| [109](#L109) | if( $matches[0] && count( $matches[0] ) > 0 ) { |
| [110](#L110) | foreach( $matches[0] as $files ) { |
| [111](#L111) | $new\_file = str\_replace( site\_url().'/', wp\_normalize\_path( ABSPATH ), $files ); |
| [112](#L112) | if( file\_exists( $new\_file ) ) { |
| [113](#L113) | wp\_delete\_file( $new\_file ); |
| [114](#L114) | } |
| [115](#L115) | } |
| [116](#L116) | } |
| [117](#L117) | } |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | // Modify contact form posted\_data |
| [121](#L121) | function dnd\_wpcf7\_posted\_data( $posted\_data ){ |
| [122](#L122) |  |
| [123](#L123) | // Subbmisson instance from CF7 |
| [124](#L124) | $submission = WPCF7\_Submission::get\_instance(); |
| [125](#L125) |  |
| [126](#L126) | // Make sure we have the data |
| [127](#L127) | if ( ! $posted\_data ) { |
| [128](#L128) | $posted\_data = $submission->get\_posted\_data(); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | // Scan and get all form tags from cf7 generator |
| [132](#L132) | $forms\_tags = $submission->get\_contact\_form(); |
| [133](#L133) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [134](#L134) |  |
| [135](#L135) | if( $forms = $forms\_tags->scan\_form\_tags() ) { |
| [136](#L136) | foreach( $forms as $field ) { |
| [137](#L137) | $field\_name = $field->name; |
| [138](#L138) | if( $field->basetype == 'mfile' && isset( $posted\_data[$field\_name] ) && ! empty( $posted\_data[$field\_name] ) ) { |
| [139](#L139) | foreach( $posted\_data[$field\_name] as $key => $file ) { |
| [140](#L140) | $posted\_data[$field\_name][$key] = trailingslashit( $uploads\_dir['upload\_url'] ) . wp\_basename( $file ); |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | return $posted\_data; |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | // Hooks for admin settings |
| [150](#L150) | function dnd\_admin\_settings() { |
| [151](#L151) | add\_submenu\_page( 'wpcf7', 'Drag & Drop Uploader - Settings', 'Drag & Drop Upload', 'manage\_options', 'drag-n-drop-upload','dnd\_upload\_admin\_settings'); |
| [152](#L152) | add\_action('admin\_init','dnd\_upload\_register\_settings'); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | // Add custom mime-types |
| [156](#L156) | function dnd\_extra\_mime\_types( $mime\_types ){ |
| [157](#L157) | $mime\_types['xls'] = 'application/excel, application/vnd.ms-excel, application/x-excel, application/x-msexcel'; |
| [158](#L158) | $mime\_types['xlsx'] = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'; |
| [159](#L159) | return $mime\_types; |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) | // Default Error Message |
| [163](#L163) | function dnd\_cf7\_error\_msg( $error\_key ) { |
| [164](#L164) |  |
| [165](#L165) | // Array of default error message |
| [166](#L166) | $errors = array( |
| [167](#L167) | 'server\_limit'          =>      \_\_('The uploaded file exceeds the maximum upload size of your server.','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [168](#L168) | 'failed\_upload'         =>      \_\_('Uploading a file fails for any reason','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [169](#L169) | 'large\_file'            =>      \_\_('Uploaded file is too large','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [170](#L170) | 'invalid\_type'          =>      \_\_('Uploaded file is not allowed for file type','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [171](#L171) | 'max\_file\_limit'        =>      \_\_('Note : Some of the files are not uploaded ( Only %count% files allowed )','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [172](#L172) | 'required'                      =>      \_\_('This field is required.', 'drag-and-drop-multiple-file-upload-contact-form-7' ), |
| [173](#L173) | 'min\_file'                      =>      \_\_('The minimum file upload is','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [174](#L174) | ); |
| [175](#L175) |  |
| [176](#L176) | // return error message based on $error\_key request |
| [177](#L177) | if( isset( $errors[ $error\_key ] ) ) { |
| [178](#L178) | return $errors[ $error\_key ]; |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) | return false; |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | // Get folder path |
| [185](#L185) | function dnd\_get\_upload\_dir() { |
| [186](#L186) | $upload = wp\_upload\_dir(); |
| [187](#L187) | $uploads\_dir = wpcf7\_dnd\_dir . '/wpcf7-files'; |
| [188](#L188) |  |
| [189](#L189) | // If save as attachment ( also : Check if upload use year and month folders ) |
| [190](#L190) | if( get\_option('drag\_n\_drop\_mail\_attachment') == 'yes' ) { |
| [191](#L191) | $uploads\_dir = ( get\_option('uploads\_use\_yearmonth\_folders') ? wpcf7\_dnd\_dir . $upload['subdir'] : wpcf7\_dnd\_dir ); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | // Create directory |
| [195](#L195) | if ( ! is\_dir( trailingslashit( $upload['basedir'] ) . $uploads\_dir ) ) { |
| [196](#L196) | wp\_mkdir\_p( trailingslashit( $upload['basedir'] ) . $uploads\_dir ); |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | // Make sure directory exist before returning |
| [200](#L200) | if( file\_exists( trailingslashit( $upload['basedir'] ) . $uploads\_dir ) ) { |
| [201](#L201) | return array( |
| [202](#L202) | 'upload\_dir'    =>      trailingslashit( $upload['basedir'] ) . $uploads\_dir, |
| [203](#L203) | 'upload\_url'    =>      trailingslashit( $upload['baseurl'] ) . $uploads\_dir |
| [204](#L204) | ); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | return trailingslashit( $upload['basedir'] ) . $uploads\_dir; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | // Clean up directory - From Contact Form 7 |
| [211](#L211) | function dnd\_cf7\_auto\_clean\_dir( $seconds = 3600, $max = 60 ) { |
| [212](#L212) | if ( is\_admin() || 'GET' != $\_SERVER['REQUEST\_METHOD'] || is\_robots() || is\_feed() || is\_trackback() ) { |
| [213](#L213) | return; |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | // Disable auto delete |
| [217](#L217) | if( get\_option('drag\_n\_drop\_disable\_auto\_delete') == 'yes' ) { |
| [218](#L218) | return; |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | // Setup dirctory path |
| [222](#L222) | $upload = wp\_upload\_dir(); |
| [223](#L223) | $dir = trailingslashit( $upload['basedir'] ) . wpcf7\_dnd\_dir . '/wpcf7-files/'; |
| [224](#L224) |  |
| [225](#L225) | // Make sure dir is readable or writable |
| [226](#L226) | if ( ! is\_dir( $dir ) || ! is\_readable( $dir ) || ! wp\_is\_writable( $dir ) ) { |
| [227](#L227) | return; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | $seconds = apply\_filters( 'dnd\_cf7\_auto\_delete\_files', $seconds ); |
| [231](#L231) | $max = absint( $max ); |
| [232](#L232) | $count = 0; |
| [233](#L233) |  |
| [234](#L234) | if ( $handle = @opendir( $dir ) ) { |
| [235](#L235) | while ( false !== ( $file = readdir( $handle ) ) ) { |
| [236](#L236) | if ( $file == "." || $file == ".." ) { |
| [237](#L237) | continue; |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | // Get file time of files OLD files. |
| [241](#L241) | $mtime = @filemtime( $dir . $file ); |
| [242](#L242) |  |
| [243](#L243) | if ( $mtime && time() < $mtime + absint( $seconds ) ) { // less than $seconds old |
| [244](#L244) | continue; |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | // Delete files from dir |
| [248](#L248) | if( $file != '.htaccess' ) { |
| [249](#L249) | wp\_delete\_file( $dir . $file ); |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) | $count += 1; |
| [253](#L253) |  |
| [254](#L254) | if ( $max <= $count ) { |
| [255](#L255) | break; |
| [256](#L256) | } |
| [257](#L257) | } |
| [258](#L258) | @closedir( $handle ); |
| [259](#L259) | } |
| [260](#L260) | @rmdir( $dir ); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | // Hooks before sending the email - ( append links to body email ) |
| [264](#L264) | function dnd\_cf7\_before\_send\_mail( $wpcf7 ){ |
| [265](#L265) | global $\_mail; |
| [266](#L266) |  |
| [267](#L267) | // Get upload path / dir |
| [268](#L268) | $upload\_path = dnd\_get\_upload\_dir(); |
| [269](#L269) |  |
| [270](#L270) | // Mail Counter |
| [271](#L271) | $\_mail = 0; |
| [272](#L272) |  |
| [273](#L273) | // Check If send attachment as link |
| [274](#L274) | if( ! get\_option('drag\_n\_drop\_mail\_attachment') ) { |
| [275](#L275) | return $wpcf7; |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | // cf7 instance |
| [279](#L279) | $submission = WPCF7\_Submission::get\_instance(); |
| [280](#L280) |  |
| [281](#L281) | // Check for submission |
| [282](#L282) | if( $submission ) { |
| [283](#L283) |  |
| [284](#L284) | // Get posted data |
| [285](#L285) | $submitted['posted\_data'] = $submission->get\_posted\_data(); |
| [286](#L286) |  |
| [287](#L287) | // Parse fields |
| [288](#L288) | $fields = $wpcf7->scan\_form\_tags(); |
| [289](#L289) |  |
| [290](#L290) | // Links |
| [291](#L291) | $links = array(); |
| [292](#L292) |  |
| [293](#L293) | // Prop email |
| [294](#L294) | $mail = $wpcf7->prop('mail'); |
| [295](#L295) | $mail\_2 = $wpcf7->prop('mail\_2'); |
| [296](#L296) |  |
| [297](#L297) | // Default upload path |
| [298](#L298) | $simple\_path = dirname( $upload\_path['upload\_url'] ); // dirname - remove duplicate form dir (/wpcf-dnd-uploads/wpcf7-dnd-uploads/example.jpg) |
| [299](#L299) |  |
| [300](#L300) | // Loop fields and replace mfile code |
| [301](#L301) | foreach( $fields as $field ) { |
| [302](#L302) | if( $field->basetype == 'mfile') { |
| [303](#L303) | if( isset( $submitted['posted\_data'][$field->name] ) && ! empty( $submitted['posted\_data'][$field->name] ) ) { |
| [304](#L304) |  |
| [305](#L305) | // Get posted\_data files |
| [306](#L306) | $files = $submitted['posted\_data'][$field->name]; |
| [307](#L307) |  |
| [308](#L308) | // Links - 1 |
| [309](#L309) | $mail\_links = dnd\_cf7\_links( $files, $mail['use\_html'] ); |
| [310](#L310) | $mail['body'] = str\_replace( "[$field->name]", "\n" . implode( "\n", $mail\_links ), $mail['body'] ); |
| [311](#L311) |  |
| [312](#L312) | // Links - 2 |
| [313](#L313) | if( $mail\_2['active'] ) { |
| [314](#L314) | $mail\_links\_2 = dnd\_cf7\_links( $files, $mail\_2['use\_html'] ); |
| [315](#L315) | $mail\_2['body'] = str\_replace( "[$field->name]", "\n" . implode( "\n", $mail\_links\_2 ), $mail\_2['body'] ); |
| [316](#L316) | } |
| [317](#L317) | } |
| [318](#L318) | } |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | // For debug |
| [322](#L322) | if( defined('dnd\_cf7\_debug') ){ |
| [323](#L323) | print\_r($mail); |
| [324](#L324) | print\_r($mail\_2); |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | // Save the email body |
| [328](#L328) | $wpcf7->set\_properties( array("mail" => $mail) ); |
| [329](#L329) |  |
| [330](#L330) | // if mail 2 |
| [331](#L331) | if( $mail\_2['active'] ) { |
| [332](#L332) | $wpcf7->set\_properties( array("mail\_2" => $mail\_2) ); |
| [333](#L333) | } |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | return $wpcf7; |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | // Get file links. |
| [340](#L340) | function dnd\_cf7\_links( $files, $use\_html = false) { |
| [341](#L341) |  |
| [342](#L342) | // check and make sure we have files |
| [343](#L343) | if( ! $files ) { |
| [344](#L344) | return; |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | // Setup html links |
| [348](#L348) | $links = array(); |
| [349](#L349) | foreach( $files as $file ) { |
| [350](#L350) | $links[] = ( $use\_html ? '<a href="'. esc\_url( $file ) .'">'. wp\_basename( $file ) .'</a>' : $file ); |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | // Allow other themes/plugin to modify data. |
| [354](#L354) | return apply\_filters('dndcf7\_before\_send\_files', $links, $files ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | // Log message... |
| [358](#L358) | function dnd\_logs( $message, $email = false ) { |
| [359](#L359) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [360](#L360) | $file = fopen( $uploads\_dir['upload\_dir']."/logs.txt", "a") or die("Unable to open file!"); |
| [361](#L361) | fwrite( $file, "\n". ( is\_array( $message ) ? print\_r( $message, true ) : $message ) ); |
| [362](#L362) | fclose( $file ); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | // hooks - Custom cf7 Mail components ( Attached File on Email ) |
| [366](#L366) | function dnd\_cf7\_mail\_components( $components, $form ) { |
| [367](#L367) | global $\_mail; |
| [368](#L368) |  |
| [369](#L369) | if( ! $form ) { |
| [370](#L370) | return; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | // Get upload directory |
| [374](#L374) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [375](#L375) |  |
| [376](#L376) | // cf7 - Submission Object |
| [377](#L377) | $submission = WPCF7\_Submission::get\_instance(); |
| [378](#L378) |  |
| [379](#L379) | // get all form fields |
| [380](#L380) | $fields = $form->scan\_form\_tags(); |
| [381](#L381) |  |
| [382](#L382) | // Send email link as an attachment. |
| [383](#L383) | if( get\_option('drag\_n\_drop\_mail\_attachment') == 'yes' ) { |
| [384](#L384) | return $components; |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | // Get mail,mail\_2 attachment [tags] |
| [388](#L388) | $mail = array('mail','mail\_2'); |
| [389](#L389) | $props\_mail = array(); |
| [390](#L390) |  |
| [391](#L391) | foreach( $mail as $single\_mail ) { |
| [392](#L392) | $props\_mail[] = $form->prop( $single\_mail ); |
| [393](#L393) | } |
| [394](#L394) |  |
| [395](#L395) | // Get email attachments (mail, mail\_2) |
| [396](#L396) | $mail = $props\_mail[ $\_mail ]; |
| [397](#L397) | if( $mail['active'] && $mail['attachments'] ) { |
| [398](#L398) |  |
| [399](#L399) | // Loop fields get mfile only. |
| [400](#L400) | foreach( $fields as $field ) { |
| [401](#L401) |  |
| [402](#L402) | // If field type equal to mfile which our default field. |
| [403](#L403) | if( $field->basetype == 'mfile') { |
| [404](#L404) |  |
| [405](#L405) | // Make sure we have files to attach |
| [406](#L406) | if( isset( $\_POST[ $field->name ] ) && count( $\_POST[ $field->name ] ) > 0 ) { |
| [407](#L407) |  |
| [408](#L408) | // Check and make sure [upload-file-xxx] exists in attachments - fields |
| [409](#L409) | if ( false !== strpos( $mail['attachments'], "[{$field->name}]" ) ) { |
| [410](#L410) |  |
| [411](#L411) | // Loop all the files and attach to cf7 components |
| [412](#L412) | foreach( $\_POST[ $field->name ] as $\_file ) { |
| [413](#L413) |  |
| [414](#L414) | // Join dir and a new file name ( get from <input type="hidden" name="upload-file-333"> ) |
| [415](#L415) | $new\_file\_name = trailingslashit( $uploads\_dir['upload\_dir'] ) . wp\_basename( $\_file ); |
| [416](#L416) |  |
| [417](#L417) | // Check if submitted and file exists then file is ready. |
| [418](#L418) | if ( $submission && file\_exists( $new\_file\_name )  ) { |
| [419](#L419) | $components['attachments'][] = $new\_file\_name; |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | } |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | // Debug |
| [431](#L431) | if( defined('dnd\_cf7\_debug') ){ |
| [432](#L432) | print\_r($components); |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | // Increment mail counter |
| [436](#L436) | $\_mail = $\_mail + 1; |
| [437](#L437) |  |
| [438](#L438) | // Return setup components |
| [439](#L439) | return $components; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | // Load js and css |
| [443](#L443) | function dnd\_cf7\_scripts() { |
| [444](#L444) |  |
| [445](#L445) | // Get plugin version |
| [446](#L446) | $version = dnd\_upload\_cf7\_version; |
| [447](#L447) |  |
| [448](#L448) | // enque script (Use native Javascript or jQuery) |
| [449](#L449) | if( get\_option('drag\_n\_drop\_use\_jquery') == 'yes' ){ |
| [450](#L450) | wp\_enqueue\_script( 'codedropz-uploader', plugins\_url ('/assets/js/codedropz-uploader-jquery.js', dirname(\_\_FILE\_\_) ), array('jquery','contact-form-7'), $version, true ); |
| [451](#L451) | }else{ |
| [452](#L452) | wp\_enqueue\_script( 'codedropz-uploader', plugins\_url ('/assets/js/codedropz-uploader-min.js', dirname(\_\_FILE\_\_) ), '', $version, true ); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | // All data options |
| [456](#L456) | $data\_options = apply\_filters('dnd\_cf7\_data\_options', |
| [457](#L457) | array( |
| [458](#L458) | 'tag'                           =>      ( get\_option('drag\_n\_drop\_heading\_tag') ? get\_option('drag\_n\_drop\_heading\_tag') : 'h3' ), |
| [459](#L459) | 'text'                          =>      ( get\_option('drag\_n\_drop\_text') ? get\_option('drag\_n\_drop\_text') : \_\_('Drag & Drop Files Here','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [460](#L460) | 'or\_separator'          =>      ( get\_option('drag\_n\_drop\_separator') ? get\_option('drag\_n\_drop\_separator') : \_\_('or','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [461](#L461) | 'browse'                        =>      ( get\_option('drag\_n\_drop\_browse\_text') ? get\_option('drag\_n\_drop\_browse\_text') : \_\_('Browse Files','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [462](#L462) | 'server\_max\_error'      =>      ( get\_option('drag\_n\_drop\_error\_server\_limit') ? get\_option('drag\_n\_drop\_error\_server\_limit') : dnd\_cf7\_error\_msg('server\_limit') ), |
| [463](#L463) | 'large\_file'            =>      ( get\_option('drag\_n\_drop\_error\_files\_too\_large') ? get\_option('drag\_n\_drop\_error\_files\_too\_large') : dnd\_cf7\_error\_msg('large\_file') ), |
| [464](#L464) | 'inavalid\_type'         =>      ( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ), |
| [465](#L465) | 'max\_file\_limit'        =>      ( get\_option('drag\_n\_drop\_error\_max\_file') ? get\_option('drag\_n\_drop\_error\_max\_file') : dnd\_cf7\_error\_msg('max\_file\_limit') ), |
| [466](#L466) | 'required'                      =>      dnd\_cf7\_error\_msg('required'), |
| [467](#L467) | 'delete'                        =>      array( |
| [468](#L468) | 'text'              =>      \_\_('deleting','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [469](#L469) | 'title'             =>      \_\_('Remove','drag-and-drop-multiple-file-upload-contact-form-7') |
| [470](#L470) | ) |
| [471](#L471) | ) |
| [472](#L472) | ); |
| [473](#L473) |  |
| [474](#L474) | //  registered script with data for a JavaScript variable. |
| [475](#L475) | wp\_localize\_script( 'codedropz-uploader', 'dnd\_cf7\_uploader', |
| [476](#L476) | array( |
| [477](#L477) | 'ajax\_url'                              =>      admin\_url( 'admin-ajax.php' ), |
| [478](#L478) | 'ajax\_nonce'                    =>      wp\_create\_nonce( "dnd-cf7-security-nonce" ), |
| [479](#L479) | 'drag\_n\_drop\_upload'    =>  $data\_options, |
| [480](#L480) | 'dnd\_text\_counter'      =>      \_\_('of','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [481](#L481) | 'disable\_btn'           =>      ( get\_option('drag\_n\_drop\_disable\_btn') == 'yes' ? true : false ) |
| [482](#L482) | ) |
| [483](#L483) | ); |
| [484](#L484) |  |
| [485](#L485) | // enque style |
| [486](#L486) | //wp\_enqueue\_style( 'dnd-upload-cf7', plugins\_url ('/assets/css/dnd-upload-cf7.css', dirname(\_\_FILE\_\_) ), '', $version ); |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | // Generate tag |
| [490](#L490) | function dnd\_cf7\_upload\_add\_form\_tag\_file() { |
| [491](#L491) | wpcf7\_add\_form\_tag(     array( 'mfile ', 'mfile\*'), 'dnd\_cf7\_upload\_form\_tag\_handler', array( 'name-attr' => true ) ); |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | // Form tag handler from the tag - callback |
| [495](#L495) | function dnd\_cf7\_upload\_form\_tag\_handler( $tag ) { |
| [496](#L496) |  |
| [497](#L497) | // check and make sure tag name is not empty |
| [498](#L498) | if ( empty( $tag->name ) ) { |
| [499](#L499) | return ''; |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | // Validate our fields |
| [503](#L503) | $validation\_error = wpcf7\_get\_validation\_error( $tag->name ); |
| [504](#L504) |  |
| [505](#L505) | // Generate class |
| [506](#L506) | $class = wpcf7\_form\_controls\_class( 'drag-n-drop-file d-none' ); |
| [507](#L507) |  |
| [508](#L508) | // Add not-valid class if there's an error. |
| [509](#L509) | if ( $validation\_error ) { |
| [510](#L510) | $class .= ' wpcf7-not-valid'; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | // Get current form Object |
| [514](#L514) | $form = WPCF7\_ContactForm::get\_current(); |
| [515](#L515) |  |
| [516](#L516) | // Setup element attributes |
| [517](#L517) | $atts = array(); |
| [518](#L518) |  |
| [519](#L519) | $atts['size'] = $tag->get\_size\_option( '40' ); |
| [520](#L520) | $atts['class'] = $tag->get\_class\_option( $class ); |
| [521](#L521) | $atts['id'] = $tag->get\_id\_option(); |
| [522](#L522) | $atts['tabindex'] = $tag->get\_option( 'tabindex', 'signed\_int', true ); |
| [523](#L523) |  |
| [524](#L524) | // If file is required |
| [525](#L525) | if ( $tag->is\_required() ) { |
| [526](#L526) | $atts['aria-required'] = 'true'; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | // Set invalid attributes if there's validation error |
| [530](#L530) | $atts['aria-invalid'] = $validation\_error ? 'true' : 'false'; |
| [531](#L531) |  |
| [532](#L532) | // Set input type and name |
| [533](#L533) | $atts['type'] = 'file'; |
| [534](#L534) | $atts['multiple'] = 'multiple'; |
| [535](#L535) | $atts['data-name'] = $tag->name; |
| [536](#L536) | $atts['data-type'] = $tag->get\_option( 'filetypes','', true); |
| [537](#L537) | $atts['data-limit'] = $tag->get\_option( 'limit','', true); |
| [538](#L538) | $atts['data-min'] = $tag->get\_option( 'min-file', '', true ); |
| [539](#L539) | $atts['data-max'] = $tag->get\_option( 'max-file','', true); |
| [540](#L540) | $atts['data-id'] = ( $form ? $form->id() : 0 ); |
| [541](#L541) | $atts['data-version'] = 'free version '. dnd\_upload\_cf7\_version; |
| [542](#L542) |  |
| [543](#L543) | // Accept data attributes |
| [544](#L544) | $types = explode('|', $atts['data-type'] ); |
| [545](#L545) |  |
| [546](#L546) | if( $types && ! wp\_is\_mobile() ) { |
| [547](#L547) | $type = implode(', .', array\_map( 'trim', $types ) ); |
| [548](#L548) | if( $type != '\*' ) { |
| [549](#L549) | $atts['accept'] = '.' . $type; |
| [550](#L550) | } |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | // Allow blacklist |
| [554](#L554) | if( $tag->get\_option('blacklist-types', '', true) ){ |
| [555](#L555) | $atts['data-black-list'] = $tag->get\_option('blacklist-types', '', true); |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | // Combine and format attrbiutes |
| [559](#L559) | $atts = wpcf7\_format\_atts( $atts ); |
| [560](#L560) |  |
| [561](#L561) | // Return our element and attributes |
| [562](#L562) | return sprintf('<span class="wpcf7-form-control-wrap" data-name="%1$s"><input %2$s />%3$s</span>',      sanitize\_html\_class( $tag->name ), $atts, $validation\_error ); |
| [563](#L563) | } |
| [564](#L564) |  |
| [565](#L565) | // Encode type filter to support multipart since this is input type file |
| [566](#L566) | add\_filter( 'wpcf7\_form\_enctype', 'dnd\_upload\_cf7\_form\_enctype\_filter' ); |
| [567](#L567) |  |
| [568](#L568) | function dnd\_upload\_cf7\_form\_enctype\_filter( $enctype ) { |
| [569](#L569) | $multipart = (bool) wpcf7\_scan\_form\_tags( array( 'type' => array( 'drag\_drop\_file', 'drag\_drop\_file\*' ) ) ); |
| [570](#L570) |  |
| [571](#L571) | if ( $multipart ) { |
| [572](#L572) | $enctype = 'multipart/form-data'; |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | return $enctype; |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | // 3rd party compatability... |
| [579](#L579) | function dnd\_cf7\_conditional\_fields( $form\_id ) { |
| [580](#L580) |  |
| [581](#L581) | if( ! $form\_id ) { |
| [582](#L582) | return false; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | // Get visible groups |
| [586](#L586) | $groups = array(); |
| [587](#L587) |  |
| [588](#L588) | // Get current form object |
| [589](#L589) | $cf7\_post = get\_post( $form\_id ); |
| [590](#L590) |  |
| [591](#L591) | // Extract group shortcode |
| [592](#L592) | $regex = get\_shortcode\_regex( array('group') ); |
| [593](#L593) |  |
| [594](#L594) | // Match pattern |
| [595](#L595) | preg\_match\_all( '/'. $regex .'/s', $cf7\_post->post\_content, $matches ); |
| [596](#L596) |  |
| [597](#L597) | if( array\_key\_exists( 3, $matches )) { |
| [598](#L598) | foreach( $matches[3] as $index => $group\_name ) { |
| [599](#L599) | $name = array\_filter( explode(" ", $group\_name ) ); |
| [600](#L600) | preg\_match('/\[mfile[\*|\s].\*?\]/', $matches[0][$index], $file\_matches ); |
| [601](#L601) | if( $file\_matches ) { |
| [602](#L602) | $field\_name = shortcode\_parse\_atts( $file\_matches[0] ); |
| [603](#L603) | $field\_name = preg\_replace( '/[^a-zA-Z0-9-\_]/','', $field\_name[1] ); |
| [604](#L604) | $groups[ $field\_name ] = $name[1]; |
| [605](#L605) | } |
| [606](#L606) | } |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | return $groups; |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | // Validation + upload handling filter |
| [613](#L613) | add\_filter( 'wpcf7\_validate\_mfile', 'dnd\_upload\_cf7\_validation\_filter', 10, 2 ); |
| [614](#L614) | add\_filter( 'wpcf7\_validate\_mfile\*', 'dnd\_upload\_cf7\_validation\_filter', 10, 2 ); |
| [615](#L615) |  |
| [616](#L616) | function dnd\_upload\_cf7\_validation\_filter( $result, $tag ) { |
| [617](#L617) | $name = $tag->name; |
| [618](#L618) | $id = $tag->get\_id\_option(); |
| [619](#L619) | $multiple\_files = ( ( isset( $\_POST[ $name ] ) && is\_countable( $\_POST[ $name ] ) && count( $\_POST[ $name ] ) > 0 ) ? $\_POST[ $name ] : null ); |
| [620](#L620) | $min\_file = $tag->get\_option( 'min-file','', true); |
| [621](#L621) |  |
| [622](#L622) | // Check minimum upload |
| [623](#L623) | if( $multiple\_files && count( $multiple\_files ) < (int) $min\_file ) { |
| [624](#L624) | $min\_file\_error = ( get\_option('drag\_n\_drop\_error\_min\_file') ? get\_option('drag\_n\_drop\_error\_min\_file') : dnd\_cf7\_error\_msg('min\_file') ); |
| [625](#L625) | $result->invalidate( $tag, $min\_file\_error .' '. (int)$min\_file ); |
| [626](#L626) | return $result; |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | // Cf7 Conditional Field |
| [630](#L630) | if( in\_array('cf7-conditional-fields/contact-form-7-conditional-fields.php', get\_option('active\_plugins') ) ){ |
| [631](#L631) |  |
| [632](#L632) | $hidden\_groups = json\_decode( stripslashes( $\_POST['\_wpcf7cf\_hidden\_groups'] ) ); |
| [633](#L633) | $form\_id = WPCF7\_ContactForm::get\_current()->id(); |
| [634](#L634) | $group\_fields = dnd\_cf7\_conditional\_fields( $form\_id ); |
| [635](#L635) |  |
| [636](#L636) | if( is\_null( $multiple\_files ) && $tag->is\_required() ) { |
| [637](#L637) | if( isset( $group\_fields[ $name ] ) && ! in\_array( $group\_fields[ $name ], $hidden\_groups ) ) { |
| [638](#L638) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [639](#L639) | }elseif( ! array\_key\_exists( $name, $group\_fields ) ) { |
| [640](#L640) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [641](#L641) | } |
| [642](#L642) | return $result; |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | return $result; |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | // Check if we have files or if it's empty |
| [649](#L649) | if( is\_null( $multiple\_files ) && $tag->is\_required() ) { |
| [650](#L650) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [651](#L651) | return $result; |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | return $result; |
| [655](#L655) | } |
| [656](#L656) |  |
| [657](#L657) | // Generate Admin From Tag |
| [658](#L658) | add\_action( 'wpcf7\_admin\_init', 'dnd\_upload\_cf7\_add\_tag\_generator', 50 ); |
| [659](#L659) |  |
| [660](#L660) | function dnd\_upload\_cf7\_add\_tag\_generator() { |
| [661](#L661) | $tag\_generator = WPCF7\_TagGenerator::get\_instance(); |
| [662](#L662) | $tag\_generator->add( 'upload-file', \_\_( 'multiple file upload', 'drag-and-drop-multiple-file-upload-contact-form-7' ),'dnd\_upload\_cf7\_tag\_generator\_file' ); |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | // Display form in admin |
| [666](#L666) | function dnd\_upload\_cf7\_tag\_generator\_file( $contact\_form, $args = '' ) { |
| [667](#L667) |  |
| [668](#L668) | // Parse data and get our options |
| [669](#L669) | $args = wp\_parse\_args( $args, array() ); |
| [670](#L670) |  |
| [671](#L671) | // Our multiple upload field |
| [672](#L672) | $type = 'mfile'; |
| [673](#L673) |  |
| [674](#L674) | $description = \_\_( "Generate a form-tag for a file uploading field. For more details, see %s.", 'contact-form-7' ); |
| [675](#L675) | $desc\_link = wpcf7\_link( \_\_( 'https://contactform7.com/file-uploading-and-attachment/', 'contact-form-7' ), \_\_( 'File Uploading and Attachment', 'contact-form-7' ) ); |
| [676](#L676) |  |
| [677](#L677) | ?> |
| [678](#L678) |  |
| [679](#L679) | <div class="control-box"> |
| [680](#L680) | <fieldset> |
| [681](#L681) | <legend><?php echo sprintf( esc\_html( $description ), $desc\_link ); ?></legend> |
| [682](#L682) | <table class="form-table"> |
| [683](#L683) | <tbody> |
| [684](#L684) | <tr> |
| [685](#L685) | <th scope="row"><?php echo esc\_html( \_\_( 'Field type', 'contact-form-7' ) ); ?></th> |
| [686](#L686) | <td> |
| [687](#L687) | <fieldset> |
| [688](#L688) | <legend class="screen-reader-text"><?php echo esc\_html( \_\_( 'Field type', 'contact-form-7' ) ); ?></legend> |
| [689](#L689) | <label><input type="checkbox" name="required" /> <?php echo esc\_html( \_\_( 'Required field', 'contact-form-7' ) ); ?></label> |
| [690](#L690) | </fieldset> |
| [691](#L691) | </td> |
| [692](#L692) | </tr> |
| [693](#L693) | <tr> |
| [694](#L694) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-name' ); ?>"><?php echo esc\_html( \_\_( 'Name', 'contact-form-7' ) ); ?></label></th> |
| [695](#L695) | <td><input type="text" name="name" class="tg-name oneline" id="<?php echo esc\_attr( $args['content'] . '-name' ); ?>" /></td> |
| [696](#L696) | </tr> |
| [697](#L697) | <tr> |
| [698](#L698) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>"><?php echo esc\_html( \_\_( "File size limit (bytes)", 'contact-form-7' ) ); ?></label></th> |
| [699](#L699) | <td><input type="text" name="limit" class="filesize oneline option" id="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>" /></td> |
| [700](#L700) | </tr> |
| [701](#L701) | <tr> |
| [702](#L702) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>"><?php echo esc\_html( \_\_( 'Acceptable file types', 'contact-form-7' ) ); ?></label></th> |
| [703](#L703) | <td><input type="text" name="filetypes" class="filetype oneline option" placeholder="jpeg|png|jpg|gif" id="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>" /></td> |
| [704](#L704) | </tr> |
| [705](#L705) | <tr> |
| [706](#L706) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>"><?php echo esc\_html( \_\_( 'Blacklist file types', 'contact-form-7' ) ); ?></label></th> |
| [707](#L707) | <td><input type="text" name="blacklist-types" class="filetype oneline option" placeholder="exe|bat|com" id="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>" /></td> |
| [708](#L708) | </tr> |
| [709](#L709) | <tr> |
| [710](#L710) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>"><?php echo esc\_html( \_\_( 'Minimum file upload', 'contact-form-7' ) ); ?></label></th> |
| [711](#L711) | <td><input type="text" name="min-file" class="filetype oneline option" placeholder="5" id="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>" /></td> |
| [712](#L712) | </tr> |
| [713](#L713) | <tr> |
| [714](#L714) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>"><?php echo esc\_html( \_\_( 'Max file upload', 'contact-form-7' ) ); ?></label></th> |
| [715](#L715) | <td><input type="text" name="max-file" class="filetype oneline option" placeholder="10" id="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>" /></td> |
| [716](#L716) | </tr> |
| [717](#L717) | <tr> |
| [718](#L718) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-id' ); ?>"><?php echo esc\_html( \_\_( 'Id attribute', 'contact-form-7' ) ); ?></label></th> |
| [719](#L719) | <td><input type="text" name="id" class="idvalue oneline option" id="<?php echo esc\_attr( $args['content'] . '-id' ); ?>" /></td> |
| [720](#L720) | </tr> |
| [721](#L721) | <tr> |
| [722](#L722) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-class' ); ?>"><?php echo esc\_html( \_\_( 'Class attribute', 'contact-form-7' ) ); ?></label></th> |
| [723](#L723) | <td><input type="text" name="class" class="classvalue oneline option" id="<?php echo esc\_attr( $args['content'] . '-class' ); ?>" /></td> |
| [724](#L724) | </tr> |
| [725](#L725) | </tbody> |
| [726](#L726) | </table> |
| [727](#L727) | </fieldset> |
| [728](#L728) | </div> |
| [729](#L729) |  |
| [730](#L730) | <div class="insert-box"> |
| [731](#L731) | <input type="text" name="<?php echo $type; ?>" class="tag code" readonly="readonly" onfocus="this.select()" /> |
| [732](#L732) | <div class="submitbox"> |
| [733](#L733) | <input type="button" class="button button-primary insert-tag" value="<?php echo esc\_attr( \_\_( 'Insert Tag', 'contact-form-7' ) ); ?>" /> |
| [734](#L734) | </div> |
| [735](#L735) | <br class="clear" /> |
| [736](#L736) | <p class="description mail-tag"> |
| [737](#L737) | <label for="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>"><?php echo sprintf( esc\_html( \_\_( "To attach the file uploaded through this field to mail, you need to insert the corresponding mail-tag (%s) into the File Attachments field on the Mail tab.", 'contact-form-7' ) ), '<strong><span class="mail-tag"></span></strong>' ); ?><input type="text" class="mail-tag code hidden" readonly="readonly" id="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>" /></label> |
| [738](#L738) | </p> |
| [739](#L739) | </div> |
| [740](#L740) |  |
| [741](#L741) | <?php |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) | // Get allowed types |
| [745](#L745) | function dnd\_cf7\_get\_allowed\_types( $form\_id ) { |
| [746](#L746) |  |
| [747](#L747) | $tags = dnd\_get\_upload\_form( $form\_id ); |
| [748](#L748) | $supported\_types = array(); |
| [749](#L749) |  |
| [750](#L750) | // Loop all upload tags |
| [751](#L751) | if( $tags && is\_array( $tags ) ) { |
| [752](#L752) | foreach( $tags as $tag ) { |
| [753](#L753) |  |
| [754](#L754) | // Get file types option & remove not allowed character.. |
| [755](#L755) | $types = preg\_replace( '/[^a-zA-Z0-9\*|\']/', '', $tag->get\_option('filetypes','', true ) ); |
| [756](#L756) |  |
| [757](#L757) | // Assign if filetypes is present otherwise use the default ext list. |
| [758](#L758) | $supported\_types[ $tag->name ] = ( $types ? $types : dnd\_upload\_default\_ext() ); |
| [759](#L759) | } |
| [760](#L760) | } |
| [761](#L761) |  |
| [762](#L762) | return $supported\_types; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | // Get file size option |
| [766](#L766) | function dnd\_cf7\_get\_size\_limit( $form\_id ) { |
| [767](#L767) |  |
| [768](#L768) | $tags = dnd\_get\_upload\_form( $form\_id ); |
| [769](#L769) | $allowed\_size = array(); |
| [770](#L770) |  |
| [771](#L771) | // Loop all upload tags |
| [772](#L772) | if( $tags && is\_array( $tags ) ) { |
| [773](#L773) | foreach( $tags as $tag ) { |
| [774](#L774) |  |
| [775](#L775) | // Get file types option & remove not allowed character.. |
| [776](#L776) | $limit = $tag->get\_option('limit','', true ); |
| [777](#L777) |  |
| [778](#L778) | // Assign if filetypes is present otherwise use the default ext list. |
| [779](#L779) | $allowed\_size[ $tag->name ] = ( $limit ? $limit : 10485760 ); //default 10MB |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) |  |
| [783](#L783) | return $allowed\_size; |
| [784](#L784) | } |
| [785](#L785) |  |
| [786](#L786) | // Get contact form data |
| [787](#L787) | function dnd\_get\_upload\_form( $form\_id ){ |
| [788](#L788) |  |
| [789](#L789) | // Initialize contact form instance |
| [790](#L790) | $form = WPCF7\_ContactForm::get\_instance( $form\_id ); |
| [791](#L791) |  |
| [792](#L792) | // Check if not valid object and null |
| [793](#L793) | if( ! $form && ! is\_object( $form ) ) { |
| [794](#L794) | return false; |
| [795](#L795) | } |
| [796](#L796) |  |
| [797](#L797) | // Get specific tag (mfile is for dnd file upload) |
| [798](#L798) | $tags = $form->scan\_form\_tags( array( 'type' => array('mfile', 'mfile\*') ) ); |
| [799](#L799) |  |
| [800](#L800) | if( $tags ){ |
| [801](#L801) | return $tags; |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) | return false; |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | // Begin process upload |
| [808](#L808) | function dnd\_upload\_cf7\_upload() { |
| [809](#L809) |  |
| [810](#L810) | // cf7 form id & upload name |
| [811](#L811) | $cf7\_id = sanitize\_text\_field( (int)$\_POST['form\_id']); |
| [812](#L812) |  |
| [813](#L813) | // Get the name of upload field. |
| [814](#L814) | $cf7\_upload\_name = sanitize\_text\_field( $\_POST['upload\_name'] ); |
| [815](#L815) |  |
| [816](#L816) | // Get allowed ext list @expected : png|jpeg|jpg |
| [817](#L817) | $allowed\_types = dnd\_cf7\_get\_allowed\_types( $cf7\_id ); |
| [818](#L818) |  |
| [819](#L819) | // File size limit |
| [820](#L820) | $size\_limit = dnd\_cf7\_get\_size\_limit( $cf7\_id ); |
| [821](#L821) |  |
| [822](#L822) | // check and verify ajax request |
| [823](#L823) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', 'security', false ) ) { |
| [824](#L824) | wp\_send\_json\_error('The security nonce is invalid or expired.'); |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | // Get blacklist Types |
| [828](#L828) | $blacklist\_types = ( isset( $\_POST['blacklist-types'] ) ?  explode( '|', sanitize\_text\_field( $\_POST['blacklist-types'] ) ) : '' ); |
| [829](#L829) |  |
| [830](#L830) | // Get upload dir |
| [831](#L831) | $path = dnd\_get\_upload\_dir(); |
| [832](#L832) |  |
| [833](#L833) | // input type file 'name' |
| [834](#L834) | $name = 'upload-file'; |
| [835](#L835) |  |
| [836](#L836) | // Get File ( name, type, tmp\_name, size, error ) |
| [837](#L837) | $file = isset( $\_FILES[$name] ) ? $\_FILES[$name] : null; |
| [838](#L838) |  |
| [839](#L839) | // Tells whether the file was uploaded via HTTP POST |
| [840](#L840) | if ( ! is\_uploaded\_file( $file['tmp\_name'] ) ) { |
| [841](#L841) | $failed\_error = get\_option('drag\_n\_drop\_error\_failed\_to\_upload'); |
| [842](#L842) | wp\_send\_json\_error( '('. $file['error'] .') ' . ( $failed\_error ? $failed\_error : dnd\_cf7\_error\_msg('failed\_upload') ) ); |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | /\* Get allowed extension \*/ |
| [846](#L846) | $supported\_type = ( isset( $allowed\_types["$cf7\_upload\_name"] ) ? $allowed\_types["$cf7\_upload\_name"] : dnd\_upload\_default\_ext() ); |
| [847](#L847) |  |
| [848](#L848) | // Create type pattern for anti script |
| [849](#L849) | $file\_type\_pattern = dnd\_upload\_cf7\_filetypes( $supported\_type ); |
| [850](#L850) |  |
| [851](#L851) | // Get file extension |
| [852](#L852) | $extension = strtolower( pathinfo( $file['name'], PATHINFO\_EXTENSION ) ); |
| [853](#L853) |  |
| [854](#L854) | // Validate File Types |
| [855](#L855) | if( $blacklist\_types && in\_array( $extension, $blacklist\_types ) && $supported\_type == '\*' ){ |
| [856](#L856) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [857](#L857) | } |
| [858](#L858) |  |
| [859](#L859) | // validate file type |
| [860](#L860) | if ( ( ! preg\_match( $file\_type\_pattern, $file['name'] ) || ! dnd\_cf7\_validate\_type( $extension, $supported\_type ) ) && $supported\_type != '\*' ) { |
| [861](#L861) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | // validate mime type |
| [865](#L865) | if( $supported\_type && $supported\_type != '\*' ){ |
| [866](#L866) |  |
| [867](#L867) | // wheather if we validate mime type |
| [868](#L868) | $validate\_mime = apply\_filters('dnd\_cf7\_validate\_mime', false ); |
| [869](#L869) |  |
| [870](#L870) | if( $validate\_mime ){ |
| [871](#L871) |  |
| [872](#L872) | if( ! function\_exists('wp\_check\_filetype\_and\_ext') ){ |
| [873](#L873) | require\_once ABSPATH .'wp-admin/includes/file.php'; |
| [874](#L874) | } |
| [875](#L875) |  |
| [876](#L876) | // Get file type and extension name |
| [877](#L877) | $wp\_filetype = wp\_check\_filetype\_and\_ext( $file['tmp\_name'], $file['name'] ); //[ext, type] |
| [878](#L878) | $valid\_mimes = explode('|', $supported\_type); // array[png, jpg] |
| [879](#L879) |  |
| [880](#L880) | if( empty( $wp\_filetype['type'] ) || empty( $wp\_filetype['ext'] ) || ! in\_array( $wp\_filetype['ext'], $valid\_mimes ) ){ |
| [881](#L881) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [882](#L882) | } |
| [883](#L883) | } |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | // validate file size limit |
| [887](#L887) | if( isset( $size\_limit["$cf7\_upload\_name"] ) && $file['size'] > $size\_limit["$cf7\_upload\_name"] ) { |
| [888](#L888) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_files\_too\_large') ? get\_option('drag\_n\_drop\_error\_files\_too\_large') : dnd\_cf7\_error\_msg('large\_file') ); |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | // Create file name |
| [892](#L892) | $filename = wp\_basename( $file['name'] ); |
| [893](#L893) | $filename = wpcf7\_canonicalize( $filename, 'as-is' ); |
| [894](#L894) |  |
| [895](#L895) | // Check if string is ascii then proceed with antiscript function ( remove or clean filename ) |
| [896](#L896) | if( dnd\_cf7\_check\_ascii( $filename ) ){ |
| [897](#L897) | $filename = wpcf7\_antiscript\_file\_name( $filename ); |
| [898](#L898) | } |
| [899](#L899) |  |
| [900](#L900) | // Add filter on upload file name |
| [901](#L901) | $filename = apply\_filters( 'wpcf7\_upload\_file\_name', $filename, $file['name'] ); |
| [902](#L902) |  |
| [903](#L903) | // Generate new filename |
| [904](#L904) | $filename = wp\_unique\_filename( $path['upload\_dir'], $filename ); |
| [905](#L905) | $new\_file = path\_join( $path['upload\_dir'], $filename ); |
| [906](#L906) |  |
| [907](#L907) | // Upload File |
| [908](#L908) | if ( false === move\_uploaded\_file( $file['tmp\_name'], $new\_file ) ) { |
| [909](#L909) | $failed\_error = get\_option('drag\_n\_drop\_error\_failed\_to\_upload'); |
| [910](#L910) | wp\_send\_json\_error( '('. $file['error'] .') ' . ( $failed\_error ? $failed\_error : dnd\_cf7\_error\_msg('failed\_upload') ) ); |
| [911](#L911) | }else{ |
| [912](#L912) |  |
| [913](#L913) | // Setup path and files url |
| [914](#L914) | $files = array( |
| [915](#L915) | 'path'  =>      basename( $path['upload\_dir'] ), |
| [916](#L916) | 'file'  =>      str\_replace('/','-', $filename) |
| [917](#L917) | ); |
| [918](#L918) |  |
| [919](#L919) | // Change file permission to 0400 |
| [920](#L920) | chmod( $new\_file, 0644 ); |
| [921](#L921) |  |
| [922](#L922) | // Allow other plugin to hook |
| [923](#L923) | do\_action('wpcf7\_upload\_file\_name\_custom', $new\_file, $filename ); |
| [924](#L924) |  |
| [925](#L925) | // Return json files |
| [926](#L926) | wp\_send\_json\_success( $files ); |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | die; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | // Check if a string is ASCII. |
| [933](#L933) | function dnd\_cf7\_check\_ascii( $string ) { |
| [934](#L934) | if ( function\_exists( 'mb\_check\_encoding' ) ) { |
| [935](#L935) | if ( mb\_check\_encoding( $string, 'ASCII' ) ) { |
| [936](#L936) | return true; |
| [937](#L937) | } |
| [938](#L938) | } elseif ( ! preg\_match( '/[^\x00-\x7F]/', $string ) ) { |
| [939](#L939) | return true; |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | return false; |
| [943](#L943) | } |
| [944](#L944) |  |
| [945](#L945) | // Delete file |
| [946](#L946) | function dnd\_codedropz\_upload\_delete() { |
| [947](#L947) |  |
| [948](#L948) | // Get folder directory |
| [949](#L949) | $dir = dnd\_get\_upload\_dir(); |
| [950](#L950) |  |
| [951](#L951) | // check and verify ajax request); |
| [952](#L952) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', 'security', false ) ) { |
| [953](#L953) | wp\_send\_json\_error('The security nonce is invalid or expired.'); |
| [954](#L954) | } |
| [955](#L955) |  |
| [956](#L956) |  |
| [957](#L957) | // Sanitize Path |
| [958](#L958) | $get\_path = ( isset( $\_POST['path'] ) ? sanitize\_text\_field( $\_POST['path'] ) : null ); |
| [959](#L959) |  |
| [960](#L960) | //limit the user input to a file name and to ignore injected path names |
| [961](#L961) | $path = basename( $get\_path ); |
| [962](#L962) |  |
| [963](#L963) | // Make sure path is set |
| [964](#L964) | if( ! is\_null( $path ) ) { |
| [965](#L965) |  |
| [966](#L966) | // Check valid filename & extensions |
| [967](#L967) | if( preg\_match\_all('/wp-|(\.php|\.exe|\.js|\.phtml|\.cgi|\.aspx|\.asp|\.bat)/', $path ) ) { |
| [968](#L968) | die('File not safe'); |
| [969](#L969) | } |
| [970](#L970) |  |
| [971](#L971) | // Concatenate path and upload directory |
| [972](#L972) | $file\_path = realpath( trailingslashit( $dir['upload\_dir'] ) . trim( $path ) ); |
| [973](#L973) |  |
| [974](#L974) | // Check if is in the correct upload\_dir |
| [975](#L975) | if( ! preg\_match("/". wpcf7\_dnd\_dir ."/i", $file\_path ) ) { |
| [976](#L976) | die('It\'s not a valid upload directory'); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | // Check if file exists |
| [980](#L980) | if( file\_exists( $file\_path ) ){ |
| [981](#L981) | wp\_delete\_file( $file\_path ); |
| [982](#L982) | if( ! file\_exists( $file\_path ) ) { |
| [983](#L983) | wp\_send\_json\_success('File Deleted!'); |
| [984](#L984) | } |
| [985](#L985) | } |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | die; |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | // Setup file type pattern for validation |
| [992](#L992) | function dnd\_upload\_cf7\_filetypes( $types ) { |
| [993](#L993) | $file\_type\_pattern = ''; |
| [994](#L994) |  |
| [995](#L995) | // If contact form 7 5.0 and up |
| [996](#L996) | if( function\_exists('wpcf7\_acceptable\_filetypes') ) { |
| [997](#L997) | $file\_type\_pattern = wpcf7\_acceptable\_filetypes( $types, 'regex' ); |
| [998](#L998) | $file\_type\_pattern = '/\.(' . $file\_type\_pattern . ')$/i'; |
| [999](#L999) | }else{ |
| [1000](#L1000) | $allowed\_file\_types = array(); |
| [1001](#L1001) | $file\_types = explode( '|', $types ); |
| [1002](#L1002) |  |
| [1003](#L1003) | foreach ( $file\_types as $file\_type ) { |
| [1004](#L1004) | $file\_type = trim( $file\_type, '.' ); |
| [1005](#L1005) | $file\_type = str\_replace( array( '.', '+', '\*', '?' ), array( '\.', '\+', '\\*', '\?' ), $file\_type ); |
| [1006](#L1006) | $allowed\_file\_types[] = $file\_type; |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | $allowed\_file\_types = array\_unique( $allowed\_file\_types ); |
| [1010](#L1010) | $file\_type\_pattern = implode( '|', $allowed\_file\_types ); |
| [1011](#L1011) |  |
| [1012](#L1012) | $file\_type\_pattern = trim( $file\_type\_pattern, '|' ); |
| [1013](#L1013) | $file\_type\_pattern = '(' . $file\_type\_pattern . ')'; |
| [1014](#L1014) | $file\_type\_pattern = '/\.' . $file\_type\_pattern . '$/i'; |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | return $file\_type\_pattern; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | // Add more validation for file extension |
| [1021](#L1021) | function dnd\_cf7\_validate\_type( $extension, $supported\_types ) { |
| [1022](#L1022) | $valid = true; |
| [1023](#L1023) | $extension = preg\_replace( '/[^A-Za-z0-9,|]/', '', $extension ); |
| [1024](#L1024) |  |
| [1025](#L1025) | // not allowed file types |
| [1026](#L1026) | $not\_allowed = array( 'php', 'php3','php4','phtml','exe','script', 'app', 'asp', 'bas', 'bat', 'cer', 'cgi', 'chm', 'cmd', 'com', 'cpl', 'crt', 'csh', 'csr', 'dll', 'drv', 'fxp', 'flv', 'hlp', 'hta', 'htaccess', 'htm', 'htpasswd', 'inf', 'ins', 'isp', 'jar', 'js', 'jse', 'jsp', 'ksh', 'lnk', 'mdb', 'mde', 'mdt', 'mdw', 'msc', 'msi', 'msp', 'mst', 'ops', 'pcd', 'pif', 'pl', 'prg', 'ps1', 'ps2', 'py', 'rb', 'reg', 'scr', 'sct', 'sh', 'shb', 'shs', 'sys', 'swf', 'tmp', 'torrent', 'url', 'vb', 'vbe', 'vbs', 'vbscript', 'wsc', 'wsf', 'wsf', 'wsh' ); |
| [1027](#L1027) |  |
| [1028](#L1028) | // allowed ext. |
| [1029](#L1029) | $allowed\_ext = array('ipt'); |
| [1030](#L1030) |  |
| [1031](#L1031) | // Search in $not\_allowed extension and match |
| [1032](#L1032) | foreach( $not\_allowed as $single\_ext ) { |
| [1033](#L1033) | if ( strpos( $single\_ext, $extension, 0 ) !== false && ! in\_array( $extension, $allowed\_ext )) { |
| [1034](#L1034) | $valid = false; |
| [1035](#L1035) | break; |
| [1036](#L1036) | } |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | // If pass on first validation - check extension if exists in allowed types |
| [1040](#L1040) | if( $valid === true ) { |
| [1041](#L1041) | $extensions = explode('|', strtolower( $supported\_types ) ); |
| [1042](#L1042) | if( ! in\_array( $extension, $extensions ) ) { |
| [1043](#L1043) | $valid = false; |
| [1044](#L1044) | } |
| [1045](#L1045) | } |
| [1046](#L1046) |  |
| [1047](#L1047) | return $valid; |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | // Admin Settings |
| [1051](#L1051) | function dnd\_upload\_admin\_settings( ) { |
| [1052](#L1052) | echo '<div class="wrap">'; |
| [1053](#L1053) | echo '<h1>Drag & Drop Uploader - Settings</h1>'; |
| [1054](#L1054) |  |
| [1055](#L1055) | echo '<div class="update-nag notice" style="width: 98%;padding: 0px 10px;margin-bottom: 5px;">'; |
| [1056](#L1056) | echo '<p>Checkout more features on <a href="https://codedropz.com/purchase-plugin/" target="\_blank">Pro Version</a></p>'; |
| [1057](#L1057) | echo '</div>'; |
| [1058](#L1058) |  |
| [1059](#L1059) | // Error settings |
| [1060](#L1060) | settings\_errors(); |
| [1061](#L1061) |  |
| [1062](#L1062) | echo '<form method="post" action="options.php"> '; |
| [1063](#L1063) | settings\_fields( 'drag-n-drop-upload-file-cf7' ); |
| [1064](#L1064) | do\_settings\_sections( 'drag-n-drop-upload-file-cf7' ); |
| [1065](#L1065) | ?> |
| [1066](#L1066) |  |
| [1067](#L1067) | <table class="form-table" style="display:none;"> |
| [1068](#L1068) | <tr valign="top"> |
| [1069](#L1069) | <th scope="row"><?php \_e('Translate To','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1070](#L1070) | <td><?php wp\_dropdown\_languages( array('name' => 'drag\_n\_drop\_lang', 'id' => 'drag\_n\_drop\_lang') ); ?> |
| [1071](#L1071) | <div style="margin-top:20px;"> |
| [1072](#L1072) | <strong>Translated: </strong><a href="">abc</a> |
| [1073](#L1073) | </div> |
| [1074](#L1074) | </td> |
| [1075](#L1075) | </tr> |
| [1076](#L1076) | </table> |
| [1077](#L1077) |  |
| [1078](#L1078) | <table class="form-table"> |
| [1079](#L1079) | <tr valign="top"> |
| [1080](#L1080) | <th scope="row"><?php \_e('Send Attachment as links?','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1081](#L1081) | <td><input name="drag\_n\_drop\_mail\_attachment" type="checkbox" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_mail\_attachment')); ?>></td> |
| [1082](#L1082) | </tr> |
| [1083](#L1083) | </table> |
| [1084](#L1084) |  |
| [1085](#L1085) | <h2><?php \_e('Uploader Info','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1086](#L1086) |  |
| [1087](#L1087) | <table class="form-table"> |
| [1088](#L1088) | <tr valign="top"> |
| [1089](#L1089) | <th scope="row"><?php \_e('Heading Tag','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1090](#L1090) | <td> |
| [1091](#L1091) | <select name="drag\_n\_drop\_heading\_tag"> |
| [1092](#L1092) | <option value="h1" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h1'); ?>>H1</option> |
| [1093](#L1093) | <option value="h2" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h2'); ?>>H2</option> |
| [1094](#L1094) | <option value="h3" <?php selected( get\_option('drag\_n\_drop\_heading\_tag','h3'), 'h3'); ?>>H3</option> |
| [1095](#L1095) | <option value="h4" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h4'); ?>>H4</option> |
| [1096](#L1096) | <option value="h5" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h5'); ?>>H5</option> |
| [1097](#L1097) | <option value="h6" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h6'); ?>>H6</option> |
| [1098](#L1098) | <option value="span" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'span'); ?>>Span</option> |
| [1099](#L1099) | <option value="div" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'div'); ?>>Div</option> |
| [1100](#L1100) | </select> |
| [1101](#L1101) | </td> |
| [1102](#L1102) | </tr> |
| [1103](#L1103) | <tr valign="top"> |
| [1104](#L1104) | <th scope="row"><?php \_e('Drag & Drop Text','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1105](#L1105) | <td><input type="text" name="drag\_n\_drop\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_text') ); ?>" placeholder="Drag & Drop Files Here" /></td> |
| [1106](#L1106) | </tr> |
| [1107](#L1107) | <tr valign="top"> |
| [1108](#L1108) | <th scope="row"></th> |
| [1109](#L1109) | <td><input type="text" name="drag\_n\_drop\_separator" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_separator') ); ?>" placeholder="or" /></td> |
| [1110](#L1110) | </tr> |
| [1111](#L1111) | <tr valign="top"> |
| [1112](#L1112) | <th scope="row"><?php \_e('Browse Text','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1113](#L1113) | <td><input type="text" name="drag\_n\_drop\_browse\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_browse\_text') ); ?>" placeholder="Browse Files" /></td> |
| [1114](#L1114) | </tr> |
| [1115](#L1115) | </table> |
| [1116](#L1116) |  |
| [1117](#L1117) | <h2><?php \_e('Error Message','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1118](#L1118) |  |
| [1119](#L1119) | <table class="form-table"> |
| [1120](#L1120) | <tr valign="top"> |
| [1121](#L1121) | <th scope="row"><?php \_e('File exceeds server limit','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1122](#L1122) | <td><input type="text" name="drag\_n\_drop\_error\_server\_limit" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_server\_limit') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('server\_limit'); ?>" /></td> |
| [1123](#L1123) | </tr> |
| [1124](#L1124) | <tr valign="top"> |
| [1125](#L1125) | <th scope="row"><?php \_e('Failed to Upload','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1126](#L1126) | <td><input type="text" name="drag\_n\_drop\_error\_failed\_to\_upload" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_failed\_to\_upload') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('failed\_upload'); ?>" /></td> |
| [1127](#L1127) | </tr> |
| [1128](#L1128) | <tr valign="top"> |
| [1129](#L1129) | <th scope="row"><?php \_e('Files too large','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1130](#L1130) | <td><input type="text" name="drag\_n\_drop\_error\_files\_too\_large" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_files\_too\_large') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('large\_file'); ?>" /></td> |
| [1131](#L1131) | </tr> |
| [1132](#L1132) | <tr valign="top"> |
| [1133](#L1133) | <th scope="row"><?php \_e('Invalid file Type','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1134](#L1134) | <td><input type="text" name="drag\_n\_drop\_error\_invalid\_file" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_invalid\_file') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('invalid\_type'); ?>" /></td> |
| [1135](#L1135) | </tr> |
| [1136](#L1136) | <tr valign="top"> |
| [1137](#L1137) | <th scope="row"><?php \_e('Max File Limit','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1138](#L1138) | <td><input type="text" name="drag\_n\_drop\_error\_max\_file" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_max\_file') ); ?>" placeholder="" /><p class="description">Example: `Note : Some of the files are not uploaded ( Only %count% files allowed )`</p></td> |
| [1139](#L1139) | </tr> |
| [1140](#L1140) | <tr valign="top"> |
| [1141](#L1141) | <th scope="row"><?php \_e('Minimum File','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1142](#L1142) | <td><input type="text" name="drag\_n\_drop\_error\_min\_file" placeholder="" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_min\_file') ); ?>" placeholder="" /></td> |
| [1143](#L1143) | </tr> |
| [1144](#L1144) | </table> |
| [1145](#L1145) |  |
| [1146](#L1146) | <h2><?php \_e('Auto Delete Files','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1147](#L1147) |  |
| [1148](#L1148) | <table class="form-table"> |
| [1149](#L1149) | <tr valign="top"> |
| [1150](#L1150) | <th scope="row"><?php \_e('Don\'t delete files','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1151](#L1151) | <td><input type="checkbox" name="drag\_n\_drop\_disable\_auto\_delete" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_auto\_delete')); ?>> Yes <br><p class="description"><em>The default will automatically delete files 1-2 hours after submissions, if you want to keep files check "Yes" above.</em></p></td> |
| [1152](#L1152) | </tr> |
| [1153](#L1153) | </table> |
| [1154](#L1154) |  |
| [1155](#L1155) | <h2><?php \_e('Spam Filtering Issue','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1156](#L1156) |  |
| [1157](#L1157) | <table class="form-table"> |
| [1158](#L1158) | <tr valign="top"> |
| [1159](#L1159) | <th scope="row"><?php \_e('Fix Spam','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1160](#L1160) | <td><input type="checkbox" name="drag\_n\_drop\_fix\_spam" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_fix\_spam')); ?>> Yes <p class="description"><em>If a “spam” answer is the response, Contact Form 7 will suspend the email and show a message saying, “There was an error trying to send your message", force to send message by checking this option..</em></p></td> |
| [1161](#L1161) | </tr> |
| [1162](#L1162) | </table> |
| [1163](#L1163) |  |
| [1164](#L1164) | <h2><?php \_e('Use jQuery','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1165](#L1165) |  |
| [1166](#L1166) | <table class="form-table"> |
| [1167](#L1167) | <tr valign="top"> |
| [1168](#L1168) | <th scope="row"><?php \_e('Enable jQuery','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1169](#L1169) | <td><input type="checkbox" name="drag\_n\_drop\_use\_jquery" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_use\_jquery')); ?>> Yes <p class="description"><em>Activate this option in case there are any problems with our plugin when utilizing native Javascript.</em></p></td> |
| [1170](#L1170) | </tr> |
| [1171](#L1171) | </table> |
| [1172](#L1172) |  |
| [1173](#L1173) | <h2 style="display:none;"><?php \_e('Disable Button','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1174](#L1174) |  |
| [1175](#L1175) | <table style="display:none;" class="form-table"> |
| [1176](#L1176) | <tr valign="top"> |
| [1177](#L1177) | <th scope="row"><?php \_e('Disable Submit button','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1178](#L1178) | <td><input type="checkbox" name="drag\_n\_drop\_disable\_btn" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_btn')); ?>> Yes <p class="description">Disable submit button if there's an error.</p></td> |
| [1179](#L1179) | </tr> |
| [1180](#L1180) | </table> |
| [1181](#L1181) |  |
| [1182](#L1182) | <?php submit\_button(); ?> |
| [1183](#L1183) |  |
| [1184](#L1184) | <?php |
| [1185](#L1185) | echo '</form>'; |
| [1186](#L1186) | echo '</div>'; |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | // Add script in footer |
| [1190](#L1190) | function dnd\_custom\_scripts() { |
| [1191](#L1191) | if( ! in\_array('jquery-validation-for-contact-form-7/jquery-validation-for-contact-form-7.php', get\_option('active\_plugins') ) ){ |
| [1192](#L1192) | return; |
| [1193](#L1193) | } |
| [1194](#L1194) | ?> |
| [1195](#L1195) | <script type="text/javascript"> |
| [1196](#L1196) | // Contact form 7 - Jquery validation |
| [1197](#L1197) | jQuery(document).ready(function($){ |
| [1198](#L1198) | jQuery('.wpcf7-form-control.wpcf7-submit').click(function(e){ |
| [1199](#L1199) | var uploadFields = $(this).parents('form').find('.wpcf7-drag-n-drop-file'); |
| [1200](#L1200) | var valid = true; |
| [1201](#L1201) | if( uploadFields.length > 0 ) { |
| [1202](#L1202) | jQuery.each(uploadFields, function(i,field){ |
| [1203](#L1203) | if( $(field).attr('aria-required') == 'true' ) { |
| [1204](#L1204) | parentsWrap = $(field).parents('.codedropz-upload-wrapper'); |
| [1205](#L1205) | parentsWrap.removeClass('invalid'); |
| [1206](#L1206) | parentsWrap.find('label').remove(); |
| [1207](#L1207) | if( $('[type="hidden"][name="'+$(field).attr('data-name')+'[]"]').length == 0 ) { |
| [1208](#L1208) | parentsWrap.append('<label class="error-new">'+ dnd\_cf7\_uploader.drag\_n\_drop\_upload.required +'</label>').addClass('invalid'); |
| [1209](#L1209) | valid = false; |
| [1210](#L1210) | } |
| [1211](#L1211) | } |
| [1212](#L1212) | }); |
| [1213](#L1213) | if( ! valid ) { |
| [1214](#L1214) | return false; |
| [1215](#L1215) | } |
| [1216](#L1216) | } |
| [1217](#L1217) | return true; |
| [1218](#L1218) | }); |
| [1219](#L1219) | }); |
| [1220](#L1220) | </script> |
| [1221](#L1221) | <?php |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | // Custom css style - Inline |
| [1225](#L1225) | function dnd\_custom\_style(){ |
| [1226](#L1226) | echo '<style id="multiple-file-upload">'; |
| [1227](#L1227) | include dnd\_upload\_cf7\_directory . '/assets/css/dnd-upload-cf7.css'; |
| [1228](#L1228) | echo '</style>'; |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | // Define custom (safe) file extension. |
| [1232](#L1232) | function dnd\_upload\_default\_ext() { |
| [1233](#L1233) | return apply\_filters('dnd\_cf7\_default\_ext', 'jpg|jpeg|JPG|png|gif|pdf|doc|docx|ppt|pptx|odt|avi|ogg|m4a|mov|mp3|mp4|mpg|wav|wmv|xls' ); |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | // Add custom links |
| [1237](#L1237) | function dnd\_custom\_plugin\_row\_meta( $links, $file ) { |
| [1238](#L1238) | if ( strpos( $file, 'drag-n-drop-upload-cf7.php' ) !== false ) { |
| [1239](#L1239) | $new\_links = array('pro-version' => '<a href="https://codedropz.com/purchase-plugin/" target="\_blank" style="font-weight:bold; color:#f4a647;">Pro Version</a>'); |
| [1240](#L1240) | $links = array\_merge( $links, $new\_links ); |
| [1241](#L1241) | } |
| [1242](#L1242) | return $links; |
| [1243](#L1243) | } |
| [1244](#L1244) |  |
| [1245](#L1245) | // Save admin settings |
| [1246](#L1246) | function dnd\_upload\_register\_settings() { |
| [1247](#L1247) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_heading\_tag','sanitize\_text\_field' ); |
| [1248](#L1248) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_mail\_attachment','sanitize\_text\_field' ); |
| [1249](#L1249) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_text','sanitize\_text\_field' ); |
| [1250](#L1250) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_separator','sanitize\_text\_field' ); |
| [1251](#L1251) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_browse\_text','sanitize\_text\_field' ); |
| [1252](#L1252) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_server\_limit','sanitize\_text\_field' ); |
| [1253](#L1253) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_failed\_to\_upload','sanitize\_text\_field' ); |
| [1254](#L1254) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_files\_too\_large','sanitize\_text\_field' ); |
| [1255](#L1255) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_invalid\_file','sanitize\_text\_field' ); |
| [1256](#L1256) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_max\_file','sanitize\_text\_field' ); |
| [1257](#L1257) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_min\_file','sanitize\_text\_field' ); |
| [1258](#L1258) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_disable\_btn','sanitize\_text\_field' ); |
| [1259](#L1259) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_disable\_auto\_delete','sanitize\_text\_field' ); |
| [1260](#L1260) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_fix\_spam','sanitize\_text\_field' ); |
| [1261](#L1261) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_use\_jquery','sanitize\_text\_field' ); |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | function dnd\_upload\_cf7\_lang() { |
| [1265](#L1265) | $lang = null; |
| [1266](#L1266) |  |
| [1267](#L1267) | // Polylang & WPML compatiblity |
| [1268](#L1268) | if( function\_exists('pll\_current\_language') ) { |
| [1269](#L1269) | $lang = pll\_current\_language(); |
| [1270](#L1270) | }elseif( class\_exists('SitePress') ) { |
| [1271](#L1271) | $lang = ICL\_LANGUAGE\_CODE; |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | // If english / default lang leave empty. |
| [1275](#L1275) | if( $lang ) { |
| [1276](#L1276) | $lang = ( $lang == 'en' ? '' : '-'.$lang ); |
| [1277](#L1277) | } |
| [1278](#L1278) |  |
| [1279](#L1279) | return apply\_filters('dndmfu\_wc\_lang', $lang ); |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | /\*add\_action('admin\_footer', function(){ |
| [1283](#L1283) | if( isset( $\_GET['page'] ) && $\_GET['page'] == 'drag-n-drop-upload' ) { |
| [1284](#L1284) | ?> |
| [1285](#L1285) | <script type="text/javascript"> |
| [1286](#L1286) | jQuery('document').ready(function($){ |
| [1287](#L1287) | $('#drag\_n\_drop\_lang').change(function(){ |
| [1288](#L1288) | window.location.href = "<?php echo admin\_url('admin.php?page=drag-n-drop-upload&lang-code='); ?>" + $(this).val(); |
| [1289](#L1289) | }); |
| [1290](#L1290) | }); |
| [1291](#L1291) | </script> |
| [1292](#L1292) | <?php |
| [1293](#L1293) | } |
| [1294](#L1294) | });\*/ |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?format=txt)
* [Original Format](/export/3222448/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_ac87ce6f_20250114_191432.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Ftags%2F1.3.7.2%2Finc%2Fdnd-upload-cf7.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php)

---

# [source:](/browser?order=name "Go to repository root") [drag-and-drop-multiple-file-upload-contact-form-7](/browser/drag-and-drop-multiple-file-upload-contact-form-7?order=name "View drag-and-drop-multiple-file-upload-contact-form-7")/[tags](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags?order=name "View tags")/[1.3.7.2](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2?order=name "View 1.3.7.2")/[inc](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc?order=name "View inc")/[dnd-upload-cf7.php](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?order=name "View dnd-upload-cf7.php")

View diff against:

View revision:

| [Last change](/changeset/2968538/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php "View differences") on this file was [2968538](/changeset/2968538/ "View changeset 2968538"), checked in by glenwpcoder, [16 months ago](/timeline?from=2023-09-19T04%3A40%3A32Z&precision=second "See timeline at 09/19/2023 04:40:32 AM") |
| --- |
| * Released version 1.3.7.3 |
| **File size:** 51.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* @Description : Plugin main core |
| [5](#L5) | \* @Package : Drag & Drop Multiple File Upload - Contact Form 7 |
| [6](#L6) | \* @Author : Glen Don L. Mongaya |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | if ( ! defined( 'ABSPATH' ) || ! defined('dnd\_upload\_cf7') ) { |
| [10](#L10) | exit; |
| [11](#L11) | } |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* Begin : begin plugin hooks |
| [15](#L15) | \*/ |
| [16](#L16) |  |
| [17](#L17) | add\_action( 'wpcf7\_init', 'dnd\_cf7\_upload\_add\_form\_tag\_file' ); |
| [18](#L18) | add\_action( 'wpcf7\_enqueue\_scripts', 'dnd\_cf7\_scripts' ); |
| [19](#L19) |  |
| [20](#L20) | // Hook on plugins loaded |
| [21](#L21) | add\_action('plugins\_loaded','dnd\_cf7\_upload\_plugins\_loaded'); |
| [22](#L22) |  |
| [23](#L23) | // Ajax Upload |
| [24](#L24) | add\_action( 'wp\_ajax\_dnd\_codedropz\_upload', 'dnd\_upload\_cf7\_upload' ); |
| [25](#L25) | add\_action( 'wp\_ajax\_nopriv\_dnd\_codedropz\_upload', 'dnd\_upload\_cf7\_upload' ); |
| [26](#L26) |  |
| [27](#L27) | // Hook - Ajax Delete |
| [28](#L28) | add\_action('wp\_ajax\_nopriv\_dnd\_codedropz\_upload\_delete', 'dnd\_codedropz\_upload\_delete'); |
| [29](#L29) | add\_action('wp\_ajax\_dnd\_codedropz\_upload\_delete','dnd\_codedropz\_upload\_delete'); |
| [30](#L30) |  |
| [31](#L31) | // Ajax Nonce check |
| [32](#L32) | add\_action('wp\_ajax\_\_wpcf7\_check\_nonce', 'dnd\_wpcf7\_nonce\_check'); |
| [33](#L33) | add\_action('wp\_ajax\_nopriv\_\_wpcf7\_check\_nonce', 'dnd\_wpcf7\_nonce\_check'); |
| [34](#L34) |  |
| [35](#L35) | // Hook mail cf7 |
| [36](#L36) | add\_filter('wpcf7\_posted\_data', 'dnd\_wpcf7\_posted\_data', 10, 1); |
| [37](#L37) | add\_action('wpcf7\_before\_send\_mail','dnd\_cf7\_before\_send\_mail', 30, 1); |
| [38](#L38) | add\_action('wpcf7\_mail\_components','dnd\_cf7\_mail\_components', 50, 2); |
| [39](#L39) |  |
| [40](#L40) | // Auto clean up dir/files |
| [41](#L41) | add\_action('template\_redirect', 'dnd\_cf7\_auto\_clean\_dir', 20, 0 ); |
| [42](#L42) |  |
| [43](#L43) | // Add row meta links |
| [44](#L44) | add\_filter( 'plugin\_row\_meta', 'dnd\_custom\_plugin\_row\_meta', 10, 2 ); |
| [45](#L45) |  |
| [46](#L46) | // Add custom mime-type |
| [47](#L47) | add\_filter('upload\_mimes', 'dnd\_extra\_mime\_types', 1, 1); |
| [48](#L48) |  |
| [49](#L49) | // Plugin settings |
| [50](#L50) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( dnd\_upload\_cf7\_directory ) .'/drag-n-drop-upload-cf7.php', 'dnd\_cf7\_upload\_links' ); |
| [51](#L51) |  |
| [52](#L52) | // Add Submenu - Settings |
| [53](#L53) | add\_action('admin\_menu', 'dnd\_admin\_settings'); |
| [54](#L54) |  |
| [55](#L55) | // Add custom script in footer |
| [56](#L56) | add\_action('wp\_footer','dnd\_custom\_scripts'); |
| [57](#L57) | add\_action('wp\_footer','dnd\_custom\_style'); |
| [58](#L58) |  |
| [59](#L59) | // Flamingo Hooks |
| [60](#L60) | add\_action('before\_delete\_post', 'dnd\_remove\_uploaded\_files'); |
| [61](#L61) |  |
| [62](#L62) | // Nonce |
| [63](#L63) | function dnd\_wpcf7\_nonce\_check(){ |
| [64](#L64) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', false, false ) ){ |
| [65](#L65) | wp\_send\_json\_success( wp\_create\_nonce( "dnd-cf7-security-nonce" ) ); |
| [66](#L66) | } |
| [67](#L67) | } |
| [68](#L68) |  |
| [69](#L69) | // Add links to settings |
| [70](#L70) | function dnd\_cf7\_upload\_links( $actions ) { |
| [71](#L71) | $upload\_links = array('<a href="' . admin\_url( 'admin.php?page=drag-n-drop-upload' ) . '">Settings</a>',); |
| [72](#L72) | $actions = array\_merge( $upload\_links, $actions ); |
| [73](#L73) | return $actions; |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | // Load plugin text-domain |
| [77](#L77) | function dnd\_cf7\_upload\_plugins\_loaded() { |
| [78](#L78) |  |
| [79](#L79) | // Load language domain |
| [80](#L80) | load\_plugin\_textdomain( 'drag-and-drop-multiple-file-upload-contact-form-7', false, dirname( dirname( plugin\_basename( \_\_FILE\_\_ ) ) ) . '/languages' ); |
| [81](#L81) |  |
| [82](#L82) | // Create dir |
| [83](#L83) | $dir = dnd\_get\_upload\_dir(); |
| [84](#L84) | if( isset( $dir['upload\_dir'] ) && is\_dir( $dir['upload\_dir'] ) ) { |
| [85](#L85) | // Generate .htaccess file` |
| [86](#L86) | $htaccess\_file = path\_join( dirname( $dir['upload\_dir'] ), '.htaccess' ); |
| [87](#L87) | if ( ! file\_exists( $htaccess\_file ) ) { |
| [88](#L88) | if ( $handle = fopen( $htaccess\_file, 'w' ) ) { |
| [89](#L89) | fwrite( $handle, "Options -Indexes \n <Files \*.php> \n deny from all \n </Files>" ); |
| [90](#L90) | fclose( $handle ); |
| [91](#L91) | } |
| [92](#L92) | } |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | // fix spam |
| [96](#L96) | if( get\_option('drag\_n\_drop\_fix\_spam') == 'yes' ) { |
| [97](#L97) | add\_filter('wpcf7\_spam', function(){ |
| [98](#L98) | return false; |
| [99](#L99) | }); |
| [100](#L100) | } |
| [101](#L101) | } |
| [102](#L102) |  |
| [103](#L103) | // Remove uploaded files when item is deleted permanently. |
| [104](#L104) | function dnd\_remove\_uploaded\_files( $post\_id ) { |
| [105](#L105) | $post\_type = get\_post\_type( $post\_id ); |
| [106](#L106) | $page = get\_post( $post\_id ); |
| [107](#L107) | if( $post\_type == 'flamingo\_inbound' ) { |
| [108](#L108) | preg\_match\_all( '/(.\*?)(\/'.wpcf7\_dnd\_dir.'\/wpcf7-files\/.\*$)/m', $page->post\_content, $matches ); |
| [109](#L109) | if( $matches[0] && count( $matches[0] ) > 0 ) { |
| [110](#L110) | foreach( $matches[0] as $files ) { |
| [111](#L111) | $new\_file = str\_replace( site\_url().'/', wp\_normalize\_path( ABSPATH ), $files ); |
| [112](#L112) | if( file\_exists( $new\_file ) ) { |
| [113](#L113) | wp\_delete\_file( $new\_file ); |
| [114](#L114) | } |
| [115](#L115) | } |
| [116](#L116) | } |
| [117](#L117) | } |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | // Modify contact form posted\_data |
| [121](#L121) | function dnd\_wpcf7\_posted\_data( $posted\_data ){ |
| [122](#L122) |  |
| [123](#L123) | // Subbmisson instance from CF7 |
| [124](#L124) | $submission = WPCF7\_Submission::get\_instance(); |
| [125](#L125) |  |
| [126](#L126) | // Make sure we have the data |
| [127](#L127) | if ( ! $posted\_data ) { |
| [128](#L128) | $posted\_data = $submission->get\_posted\_data(); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | // Scan and get all form tags from cf7 generator |
| [132](#L132) | $forms\_tags = $submission->get\_contact\_form(); |
| [133](#L133) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [134](#L134) |  |
| [135](#L135) | if( $forms = $forms\_tags->scan\_form\_tags() ) { |
| [136](#L136) | foreach( $forms as $field ) { |
| [137](#L137) | $field\_name = $field->name; |
| [138](#L138) | if( $field->basetype == 'mfile' && isset( $posted\_data[$field\_name] ) && ! empty( $posted\_data[$field\_name] ) ) { |
| [139](#L139) | foreach( $posted\_data[$field\_name] as $key => $file ) { |
| [140](#L140) | $posted\_data[$field\_name][$key] = trailingslashit( $uploads\_dir['upload\_url'] ) . wp\_basename( $file ); |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | return $posted\_data; |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | // Hooks for admin settings |
| [150](#L150) | function dnd\_admin\_settings() { |
| [151](#L151) | add\_submenu\_page( 'wpcf7', 'Drag & Drop Uploader - Settings', 'Drag & Drop Upload', 'manage\_options', 'drag-n-drop-upload','dnd\_upload\_admin\_settings'); |
| [152](#L152) | add\_action('admin\_init','dnd\_upload\_register\_settings'); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | // Add custom mime-types |
| [156](#L156) | function dnd\_extra\_mime\_types( $mime\_types ){ |
| [157](#L157) | $mime\_types['xls'] = 'application/excel, application/vnd.ms-excel, application/x-excel, application/x-msexcel'; |
| [158](#L158) | $mime\_types['xlsx'] = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'; |
| [159](#L159) | return $mime\_types; |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) | // Default Error Message |
| [163](#L163) | function dnd\_cf7\_error\_msg( $error\_key ) { |
| [164](#L164) |  |
| [165](#L165) | // Array of default error message |
| [166](#L166) | $errors = array( |
| [167](#L167) | 'server\_limit'          =>      \_\_('The uploaded file exceeds the maximum upload size of your server.','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [168](#L168) | 'failed\_upload'         =>      \_\_('Uploading a file fails for any reason','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [169](#L169) | 'large\_file'            =>      \_\_('Uploaded file is too large','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [170](#L170) | 'invalid\_type'          =>      \_\_('Uploaded file is not allowed for file type','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [171](#L171) | 'max\_file\_limit'        =>      \_\_('Note : Some of the files are not uploaded ( Only %count% files allowed )','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [172](#L172) | 'required'                      =>      \_\_('This field is required.', 'drag-and-drop-multiple-file-upload-contact-form-7' ), |
| [173](#L173) | 'min\_file'                      =>      \_\_('The minimum file upload is','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [174](#L174) | ); |
| [175](#L175) |  |
| [176](#L176) | // return error message based on $error\_key request |
| [177](#L177) | if( isset( $errors[ $error\_key ] ) ) { |
| [178](#L178) | return $errors[ $error\_key ]; |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) | return false; |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | // Get folder path |
| [185](#L185) | function dnd\_get\_upload\_dir() { |
| [186](#L186) | $upload = wp\_upload\_dir(); |
| [187](#L187) | $uploads\_dir = wpcf7\_dnd\_dir . '/wpcf7-files'; |
| [188](#L188) |  |
| [189](#L189) | // If save as attachment ( also : Check if upload use year and month folders ) |
| [190](#L190) | if( get\_option('drag\_n\_drop\_mail\_attachment') == 'yes' ) { |
| [191](#L191) | $uploads\_dir = ( get\_option('uploads\_use\_yearmonth\_folders') ? wpcf7\_dnd\_dir . $upload['subdir'] : wpcf7\_dnd\_dir ); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | // Create directory |
| [195](#L195) | if ( ! is\_dir( trailingslashit( $upload['basedir'] ) . $uploads\_dir ) ) { |
| [196](#L196) | wp\_mkdir\_p( trailingslashit( $upload['basedir'] ) . $uploads\_dir ); |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | // Make sure directory exist before returning |
| [200](#L200) | if( file\_exists( trailingslashit( $upload['basedir'] ) . $uploads\_dir ) ) { |
| [201](#L201) | return array( |
| [202](#L202) | 'upload\_dir'    =>      trailingslashit( $upload['basedir'] ) . $uploads\_dir, |
| [203](#L203) | 'upload\_url'    =>      trailingslashit( $upload['baseurl'] ) . $uploads\_dir |
| [204](#L204) | ); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | return trailingslashit( $upload['basedir'] ) . $uploads\_dir; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | // Clean up directory - From Contact Form 7 |
| [211](#L211) | function dnd\_cf7\_auto\_clean\_dir( $seconds = 3600, $max = 60 ) { |
| [212](#L212) | if ( is\_admin() || 'GET' != $\_SERVER['REQUEST\_METHOD'] || is\_robots() || is\_feed() || is\_trackback() ) { |
| [213](#L213) | return; |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | // Disable auto delete |
| [217](#L217) | if( get\_option('drag\_n\_drop\_disable\_auto\_delete') == 'yes' ) { |
| [218](#L218) | return; |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | // Setup dirctory path |
| [222](#L222) | $upload = wp\_upload\_dir(); |
| [223](#L223) | $dir = trailingslashit( $upload['basedir'] ) . wpcf7\_dnd\_dir . '/wpcf7-files/'; |
| [224](#L224) |  |
| [225](#L225) | // Make sure dir is readable or writable |
| [226](#L226) | if ( ! is\_dir( $dir ) || ! is\_readable( $dir ) || ! wp\_is\_writable( $dir ) ) { |
| [227](#L227) | return; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | $seconds = apply\_filters( 'dnd\_cf7\_auto\_delete\_files', $seconds ); |
| [231](#L231) | $max = absint( $max ); |
| [232](#L232) | $count = 0; |
| [233](#L233) |  |
| [234](#L234) | if ( $handle = @opendir( $dir ) ) { |
| [235](#L235) | while ( false !== ( $file = readdir( $handle ) ) ) { |
| [236](#L236) | if ( $file == "." || $file == ".." ) { |
| [237](#L237) | continue; |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | // Get file time of files OLD files. |
| [241](#L241) | $mtime = @filemtime( $dir . $file ); |
| [242](#L242) |  |
| [243](#L243) | if ( $mtime && time() < $mtime + absint( $seconds ) ) { // less than $seconds old |
| [244](#L244) | continue; |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | // Delete files from dir |
| [248](#L248) | if( $file != '.htaccess' ) { |
| [249](#L249) | wp\_delete\_file( $dir . $file ); |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) | $count += 1; |
| [253](#L253) |  |
| [254](#L254) | if ( $max <= $count ) { |
| [255](#L255) | break; |
| [256](#L256) | } |
| [257](#L257) | } |
| [258](#L258) | @closedir( $handle ); |
| [259](#L259) | } |
| [260](#L260) | @rmdir( $dir ); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | // Hooks before sending the email - ( append links to body email ) |
| [264](#L264) | function dnd\_cf7\_before\_send\_mail( $wpcf7 ){ |
| [265](#L265) | global $\_mail; |
| [266](#L266) |  |
| [267](#L267) | // Get upload path / dir |
| [268](#L268) | $upload\_path = dnd\_get\_upload\_dir(); |
| [269](#L269) |  |
| [270](#L270) | // Mail Counter |
| [271](#L271) | $\_mail = 0; |
| [272](#L272) |  |
| [273](#L273) | // Check If send attachment as link |
| [274](#L274) | if( ! get\_option('drag\_n\_drop\_mail\_attachment') ) { |
| [275](#L275) | return $wpcf7; |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | // cf7 instance |
| [279](#L279) | $submission = WPCF7\_Submission::get\_instance(); |
| [280](#L280) |  |
| [281](#L281) | // Check for submission |
| [282](#L282) | if( $submission ) { |
| [283](#L283) |  |
| [284](#L284) | // Get posted data |
| [285](#L285) | $submitted['posted\_data'] = $submission->get\_posted\_data(); |
| [286](#L286) |  |
| [287](#L287) | // Parse fields |
| [288](#L288) | $fields = $wpcf7->scan\_form\_tags(); |
| [289](#L289) |  |
| [290](#L290) | // Links |
| [291](#L291) | $links = array(); |
| [292](#L292) |  |
| [293](#L293) | // Prop email |
| [294](#L294) | $mail = $wpcf7->prop('mail'); |
| [295](#L295) | $mail\_2 = $wpcf7->prop('mail\_2'); |
| [296](#L296) |  |
| [297](#L297) | // Default upload path |
| [298](#L298) | $simple\_path = dirname( $upload\_path['upload\_url'] ); // dirname - remove duplicate form dir (/wpcf-dnd-uploads/wpcf7-dnd-uploads/example.jpg) |
| [299](#L299) |  |
| [300](#L300) | // Loop fields and replace mfile code |
| [301](#L301) | foreach( $fields as $field ) { |
| [302](#L302) | if( $field->basetype == 'mfile') { |
| [303](#L303) | if( isset( $submitted['posted\_data'][$field->name] ) && ! empty( $submitted['posted\_data'][$field->name] ) ) { |
| [304](#L304) |  |
| [305](#L305) | // Get posted\_data files |
| [306](#L306) | $files = $submitted['posted\_data'][$field->name]; |
| [307](#L307) |  |
| [308](#L308) | // Links - 1 |
| [309](#L309) | $mail\_links = dnd\_cf7\_links( $files, $mail['use\_html'] ); |
| [310](#L310) | $mail['body'] = str\_replace( "[$field->name]", "\n" . implode( "\n", $mail\_links ), $mail['body'] ); |
| [311](#L311) |  |
| [312](#L312) | // Links - 2 |
| [313](#L313) | if( $mail\_2['active'] ) { |
| [314](#L314) | $mail\_links\_2 = dnd\_cf7\_links( $files, $mail\_2['use\_html'] ); |
| [315](#L315) | $mail\_2['body'] = str\_replace( "[$field->name]", "\n" . implode( "\n", $mail\_links\_2 ), $mail\_2['body'] ); |
| [316](#L316) | } |
| [317](#L317) | } |
| [318](#L318) | } |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | // For debug |
| [322](#L322) | if( defined('dnd\_cf7\_debug') ){ |
| [323](#L323) | print\_r($mail); |
| [324](#L324) | print\_r($mail\_2); |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | // Save the email body |
| [328](#L328) | $wpcf7->set\_properties( array("mail" => $mail) ); |
| [329](#L329) |  |
| [330](#L330) | // if mail 2 |
| [331](#L331) | if( $mail\_2['active'] ) { |
| [332](#L332) | $wpcf7->set\_properties( array("mail\_2" => $mail\_2) ); |
| [333](#L333) | } |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | return $wpcf7; |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | // Get file links. |
| [340](#L340) | function dnd\_cf7\_links( $files, $use\_html = false) { |
| [341](#L341) |  |
| [342](#L342) | // check and make sure we have files |
| [343](#L343) | if( ! $files ) { |
| [344](#L344) | return; |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | // Setup html links |
| [348](#L348) | $links = array(); |
| [349](#L349) | foreach( $files as $file ) { |
| [350](#L350) | $links[] = ( $use\_html ? '<a href="'. esc\_url( $file ) .'">'. wp\_basename( $file ) .'</a>' : $file ); |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | // Allow other themes/plugin to modify data. |
| [354](#L354) | return apply\_filters('dndcf7\_before\_send\_files', $links, $files ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | // Log message... |
| [358](#L358) | function dnd\_logs( $message, $email = false ) { |
| [359](#L359) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [360](#L360) | $file = fopen( $uploads\_dir['upload\_dir']."/logs.txt", "a") or die("Unable to open file!"); |
| [361](#L361) | fwrite( $file, "\n". ( is\_array( $message ) ? print\_r( $message, true ) : $message ) ); |
| [362](#L362) | fclose( $file ); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | // hooks - Custom cf7 Mail components ( Attached File on Email ) |
| [366](#L366) | function dnd\_cf7\_mail\_components( $components, $form ) { |
| [367](#L367) | global $\_mail; |
| [368](#L368) |  |
| [369](#L369) | if( ! $form ) { |
| [370](#L370) | return; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | // Get upload directory |
| [374](#L374) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [375](#L375) |  |
| [376](#L376) | // cf7 - Submission Object |
| [377](#L377) | $submission = WPCF7\_Submission::get\_instance(); |
| [378](#L378) |  |
| [379](#L379) | // get all form fields |
| [380](#L380) | $fields = $form->scan\_form\_tags(); |
| [381](#L381) |  |
| [382](#L382) | // Send email link as an attachment. |
| [383](#L383) | if( get\_option('drag\_n\_drop\_mail\_attachment') == 'yes' ) { |
| [384](#L384) | return $components; |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | // Get mail,mail\_2 attachment [tags] |
| [388](#L388) | $mail = array('mail','mail\_2'); |
| [389](#L389) | $props\_mail = array(); |
| [390](#L390) |  |
| [391](#L391) | foreach( $mail as $single\_mail ) { |
| [392](#L392) | $props\_mail[] = $form->prop( $single\_mail ); |
| [393](#L393) | } |
| [394](#L394) |  |
| [395](#L395) | // Get email attachments (mail, mail\_2) |
| [396](#L396) | $mail = $props\_mail[ $\_mail ]; |
| [397](#L397) | if( $mail['active'] && $mail['attachments'] ) { |
| [398](#L398) |  |
| [399](#L399) | // Loop fields get mfile only. |
| [400](#L400) | foreach( $fields as $field ) { |
| [401](#L401) |  |
| [402](#L402) | // If field type equal to mfile which our default field. |
| [403](#L403) | if( $field->basetype == 'mfile') { |
| [404](#L404) |  |
| [405](#L405) | // Make sure we have files to attach |
| [406](#L406) | if( isset( $\_POST[ $field->name ] ) && count( $\_POST[ $field->name ] ) > 0 ) { |
| [407](#L407) |  |
| [408](#L408) | // Check and make sure [upload-file-xxx] exists in attachments - fields |
| [409](#L409) | if ( false !== strpos( $mail['attachments'], "[{$field->name}]" ) ) { |
| [410](#L410) |  |
| [411](#L411) | // Loop all the files and attach to cf7 components |
| [412](#L412) | foreach( $\_POST[ $field->name ] as $\_file ) { |
| [413](#L413) |  |
| [414](#L414) | // Join dir and a new file name ( get from <input type="hidden" name="upload-file-333"> ) |
| [415](#L415) | $new\_file\_name = trailingslashit( $uploads\_dir['upload\_dir'] ) . wp\_basename( $\_file ); |
| [416](#L416) |  |
| [417](#L417) | // Check if submitted and file exists then file is ready. |
| [418](#L418) | if ( $submission && file\_exists( $new\_file\_name )  ) { |
| [419](#L419) | $components['attachments'][] = $new\_file\_name; |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | } |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | // Debug |
| [431](#L431) | if( defined('dnd\_cf7\_debug') ){ |
| [432](#L432) | print\_r($components); |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | // Increment mail counter |
| [436](#L436) | $\_mail = $\_mail + 1; |
| [437](#L437) |  |
| [438](#L438) | // Return setup components |
| [439](#L439) | return $components; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | // Load js and css |
| [443](#L443) | function dnd\_cf7\_scripts() { |
| [444](#L444) |  |
| [445](#L445) | // Get plugin version |
| [446](#L446) | $version = dnd\_upload\_cf7\_version; |
| [447](#L447) |  |
| [448](#L448) | // enque script (Use native Javascript or jQuery) |
| [449](#L449) | if( get\_option('drag\_n\_drop\_use\_jquery') == 'yes' ){ |
| [450](#L450) | wp\_enqueue\_script( 'codedropz-uploader', plugins\_url ('/assets/js/codedropz-uploader-jquery.js', dirname(\_\_FILE\_\_) ), array('jquery','contact-form-7'), $version, true ); |
| [451](#L451) | }else{ |
| [452](#L452) | wp\_enqueue\_script( 'codedropz-uploader', plugins\_url ('/assets/js/codedropz-uploader-min.js', dirname(\_\_FILE\_\_) ), '', $version, true ); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | // All data options |
| [456](#L456) | $data\_options = apply\_filters('dnd\_cf7\_data\_options', |
| [457](#L457) | array( |
| [458](#L458) | 'tag'                           =>      ( get\_option('drag\_n\_drop\_heading\_tag') ? get\_option('drag\_n\_drop\_heading\_tag') : 'h3' ), |
| [459](#L459) | 'text'                          =>      ( get\_option('drag\_n\_drop\_text') ? get\_option('drag\_n\_drop\_text') : \_\_('Drag & Drop Files Here','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [460](#L460) | 'or\_separator'          =>      ( get\_option('drag\_n\_drop\_separator') ? get\_option('drag\_n\_drop\_separator') : \_\_('or','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [461](#L461) | 'browse'                        =>      ( get\_option('drag\_n\_drop\_browse\_text') ? get\_option('drag\_n\_drop\_browse\_text') : \_\_('Browse Files','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [462](#L462) | 'server\_max\_error'      =>      ( get\_option('drag\_n\_drop\_error\_server\_limit') ? get\_option('drag\_n\_drop\_error\_server\_limit') : dnd\_cf7\_error\_msg('server\_limit') ), |
| [463](#L463) | 'large\_file'            =>      ( get\_option('drag\_n\_drop\_error\_files\_too\_large') ? get\_option('drag\_n\_drop\_error\_files\_too\_large') : dnd\_cf7\_error\_msg('large\_file') ), |
| [464](#L464) | 'inavalid\_type'         =>      ( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ), |
| [465](#L465) | 'max\_file\_limit'        =>      ( get\_option('drag\_n\_drop\_error\_max\_file') ? get\_option('drag\_n\_drop\_error\_max\_file') : dnd\_cf7\_error\_msg('max\_file\_limit') ), |
| [466](#L466) | 'required'                      =>      dnd\_cf7\_error\_msg('required'), |
| [467](#L467) | 'delete'                        =>      array( |
| [468](#L468) | 'text'              =>      \_\_('deleting','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [469](#L469) | 'title'             =>      \_\_('Remove','drag-and-drop-multiple-file-upload-contact-form-7') |
| [470](#L470) | ) |
| [471](#L471) | ) |
| [472](#L472) | ); |
| [473](#L473) |  |
| [474](#L474) | //  registered script with data for a JavaScript variable. |
| [475](#L475) | wp\_localize\_script( 'codedropz-uploader', 'dnd\_cf7\_uploader', |
| [476](#L476) | array( |
| [477](#L477) | 'ajax\_url'                              =>      admin\_url( 'admin-ajax.php' ), |
| [478](#L478) | 'ajax\_nonce'                    =>      wp\_create\_nonce( "dnd-cf7-security-nonce" ), |
| [479](#L479) | 'drag\_n\_drop\_upload'    =>  $data\_options, |
| [480](#L480) | 'dnd\_text\_counter'      =>      \_\_('of','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [481](#L481) | 'disable\_btn'           =>      ( get\_option('drag\_n\_drop\_disable\_btn') == 'yes' ? true : false ) |
| [482](#L482) | ) |
| [483](#L483) | ); |
| [484](#L484) |  |
| [485](#L485) | // enque style |
| [486](#L486) | //wp\_enqueue\_style( 'dnd-upload-cf7', plugins\_url ('/assets/css/dnd-upload-cf7.css', dirname(\_\_FILE\_\_) ), '', $version ); |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | // Generate tag |
| [490](#L490) | function dnd\_cf7\_upload\_add\_form\_tag\_file() { |
| [491](#L491) | wpcf7\_add\_form\_tag(     array( 'mfile ', 'mfile\*'), 'dnd\_cf7\_upload\_form\_tag\_handler', array( 'name-attr' => true ) ); |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | // Form tag handler from the tag - callback |
| [495](#L495) | function dnd\_cf7\_upload\_form\_tag\_handler( $tag ) { |
| [496](#L496) |  |
| [497](#L497) | // check and make sure tag name is not empty |
| [498](#L498) | if ( empty( $tag->name ) ) { |
| [499](#L499) | return ''; |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | // Validate our fields |
| [503](#L503) | $validation\_error = wpcf7\_get\_validation\_error( $tag->name ); |
| [504](#L504) |  |
| [505](#L505) | // Generate class |
| [506](#L506) | $class = wpcf7\_form\_controls\_class( 'drag-n-drop-file d-none' ); |
| [507](#L507) |  |
| [508](#L508) | // Add not-valid class if there's an error. |
| [509](#L509) | if ( $validation\_error ) { |
| [510](#L510) | $class .= ' wpcf7-not-valid'; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | // Get current form Object |
| [514](#L514) | $form = WPCF7\_ContactForm::get\_current(); |
| [515](#L515) |  |
| [516](#L516) | // Setup element attributes |
| [517](#L517) | $atts = array(); |
| [518](#L518) |  |
| [519](#L519) | $atts['size'] = $tag->get\_size\_option( '40' ); |
| [520](#L520) | $atts['class'] = $tag->get\_class\_option( $class ); |
| [521](#L521) | $atts['id'] = $tag->get\_id\_option(); |
| [522](#L522) | $atts['tabindex'] = $tag->get\_option( 'tabindex', 'signed\_int', true ); |
| [523](#L523) |  |
| [524](#L524) | // If file is required |
| [525](#L525) | if ( $tag->is\_required() ) { |
| [526](#L526) | $atts['aria-required'] = 'true'; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | // Set invalid attributes if there's validation error |
| [530](#L530) | $atts['aria-invalid'] = $validation\_error ? 'true' : 'false'; |
| [531](#L531) |  |
| [532](#L532) | // Set input type and name |
| [533](#L533) | $atts['type'] = 'file'; |
| [534](#L534) | $atts['multiple'] = 'multiple'; |
| [535](#L535) | $atts['data-name'] = $tag->name; |
| [536](#L536) | $atts['data-type'] = $tag->get\_option( 'filetypes','', true); |
| [537](#L537) | $atts['data-limit'] = $tag->get\_option( 'limit','', true); |
| [538](#L538) | $atts['data-min'] = $tag->get\_option( 'min-file', '', true ); |
| [539](#L539) | $atts['data-max'] = $tag->get\_option( 'max-file','', true); |
| [540](#L540) | $atts['data-id'] = ( $form ? $form->id() : 0 ); |
| [541](#L541) | $atts['data-version'] = 'free version '. dnd\_upload\_cf7\_version; |
| [542](#L542) |  |
| [543](#L543) | // Accept data attributes |
| [544](#L544) | $types = explode('|', $atts['data-type'] ); |
| [545](#L545) |  |
| [546](#L546) | if( $types && ! wp\_is\_mobile() ) { |
| [547](#L547) | $type = implode(', .', array\_map( 'trim', $types ) ); |
| [548](#L548) | if( $type != '\*' ) { |
| [549](#L549) | $atts['accept'] = '.' . $type; |
| [550](#L550) | } |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | // Allow blacklist |
| [554](#L554) | if( $tag->get\_option('blacklist-types', '', true) ){ |
| [555](#L555) | $atts['data-black-list'] = $tag->get\_option('blacklist-types', '', true); |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | // Combine and format attrbiutes |
| [559](#L559) | $atts = wpcf7\_format\_atts( $atts ); |
| [560](#L560) |  |
| [561](#L561) | // Return our element and attributes |
| [562](#L562) | return sprintf('<span class="wpcf7-form-control-wrap" data-name="%1$s"><input %2$s />%3$s</span>',      sanitize\_html\_class( $tag->name ), $atts, $validation\_error ); |
| [563](#L563) | } |
| [564](#L564) |  |
| [565](#L565) | // Encode type filter to support multipart since this is input type file |
| [566](#L566) | add\_filter( 'wpcf7\_form\_enctype', 'dnd\_upload\_cf7\_form\_enctype\_filter' ); |
| [567](#L567) |  |
| [568](#L568) | function dnd\_upload\_cf7\_form\_enctype\_filter( $enctype ) { |
| [569](#L569) | $multipart = (bool) wpcf7\_scan\_form\_tags( array( 'type' => array( 'drag\_drop\_file', 'drag\_drop\_file\*' ) ) ); |
| [570](#L570) |  |
| [571](#L571) | if ( $multipart ) { |
| [572](#L572) | $enctype = 'multipart/form-data'; |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | return $enctype; |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | // 3rd party compatability... |
| [579](#L579) | function dnd\_cf7\_conditional\_fields( $form\_id ) { |
| [580](#L580) |  |
| [581](#L581) | if( ! $form\_id ) { |
| [582](#L582) | return false; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | // Get visible groups |
| [586](#L586) | $groups = array(); |
| [587](#L587) |  |
| [588](#L588) | // Get current form object |
| [589](#L589) | $cf7\_post = get\_post( $form\_id ); |
| [590](#L590) |  |
| [591](#L591) | // Extract group shortcode |
| [592](#L592) | $regex = get\_shortcode\_regex( array('group') ); |
| [593](#L593) |  |
| [594](#L594) | // Match pattern |
| [595](#L595) | preg\_match\_all( '/'. $regex .'/s', $cf7\_post->post\_content, $matches ); |
| [596](#L596) |  |
| [597](#L597) | if( array\_key\_exists( 3, $matches )) { |
| [598](#L598) | foreach( $matches[3] as $index => $group\_name ) { |
| [599](#L599) | $name = array\_filter( explode(" ", $group\_name ) ); |
| [600](#L600) | preg\_match('/\[mfile[\*|\s].\*?\]/', $matches[0][$index], $file\_matches ); |
| [601](#L601) | if( $file\_matches ) { |
| [602](#L602) | $field\_name = shortcode\_parse\_atts( $file\_matches[0] ); |
| [603](#L603) | $field\_name = preg\_replace( '/[^a-zA-Z0-9-\_]/','', $field\_name[1] ); |
| [604](#L604) | $groups[ $field\_name ] = $name[1]; |
| [605](#L605) | } |
| [606](#L606) | } |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | return $groups; |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | // Validation + upload handling filter |
| [613](#L613) | add\_filter( 'wpcf7\_validate\_mfile', 'dnd\_upload\_cf7\_validation\_filter', 10, 2 ); |
| [614](#L614) | add\_filter( 'wpcf7\_validate\_mfile\*', 'dnd\_upload\_cf7\_validation\_filter', 10, 2 ); |
| [615](#L615) |  |
| [616](#L616) | function dnd\_upload\_cf7\_validation\_filter( $result, $tag ) { |
| [617](#L617) | $name = $tag->name; |
| [618](#L618) | $id = $tag->get\_id\_option(); |
| [619](#L619) | $multiple\_files = ( ( isset( $\_POST[ $name ] ) && is\_countable( $\_POST[ $name ] ) && count( $\_POST[ $name ] ) > 0 ) ? $\_POST[ $name ] : null ); |
| [620](#L620) | $min\_file = $tag->get\_option( 'min-file','', true); |
| [621](#L621) |  |
| [622](#L622) | // Check minimum upload |
| [623](#L623) | if( $multiple\_files && count( $multiple\_files ) < (int) $min\_file ) { |
| [624](#L624) | $min\_file\_error = ( get\_option('drag\_n\_drop\_error\_min\_file') ? get\_option('drag\_n\_drop\_error\_min\_file') : dnd\_cf7\_error\_msg('min\_file') ); |
| [625](#L625) | $result->invalidate( $tag, $min\_file\_error .' '. (int)$min\_file ); |
| [626](#L626) | return $result; |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | // Cf7 Conditional Field |
| [630](#L630) | if( in\_array('cf7-conditional-fields/contact-form-7-conditional-fields.php', get\_option('active\_plugins') ) ){ |
| [631](#L631) |  |
| [632](#L632) | $hidden\_groups = json\_decode( stripslashes( $\_POST['\_wpcf7cf\_hidden\_groups'] ) ); |
| [633](#L633) | $form\_id = WPCF7\_ContactForm::get\_current()->id(); |
| [634](#L634) | $group\_fields = dnd\_cf7\_conditional\_fields( $form\_id ); |
| [635](#L635) |  |
| [636](#L636) | if( is\_null( $multiple\_files ) && $tag->is\_required() ) { |
| [637](#L637) | if( isset( $group\_fields[ $name ] ) && ! in\_array( $group\_fields[ $name ], $hidden\_groups ) ) { |
| [638](#L638) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [639](#L639) | }elseif( ! array\_key\_exists( $name, $group\_fields ) ) { |
| [640](#L640) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [641](#L641) | } |
| [642](#L642) | return $result; |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | return $result; |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | // Check if we have files or if it's empty |
| [649](#L649) | if( is\_null( $multiple\_files ) && $tag->is\_required() ) { |
| [650](#L650) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [651](#L651) | return $result; |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | return $result; |
| [655](#L655) | } |
| [656](#L656) |  |
| [657](#L657) | // Generate Admin From Tag |
| [658](#L658) | add\_action( 'wpcf7\_admin\_init', 'dnd\_upload\_cf7\_add\_tag\_generator', 50 ); |
| [659](#L659) |  |
| [660](#L660) | function dnd\_upload\_cf7\_add\_tag\_generator() { |
| [661](#L661) | $tag\_generator = WPCF7\_TagGenerator::get\_instance(); |
| [662](#L662) | $tag\_generator->add( 'upload-file', \_\_( 'multiple file upload', 'drag-and-drop-multiple-file-upload-contact-form-7' ),'dnd\_upload\_cf7\_tag\_generator\_file' ); |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | // Display form in admin |
| [666](#L666) | function dnd\_upload\_cf7\_tag\_generator\_file( $contact\_form, $args = '' ) { |
| [667](#L667) |  |
| [668](#L668) | // Parse data and get our options |
| [669](#L669) | $args = wp\_parse\_args( $args, array() ); |
| [670](#L670) |  |
| [671](#L671) | // Our multiple upload field |
| [672](#L672) | $type = 'mfile'; |
| [673](#L673) |  |
| [674](#L674) | $description = \_\_( "Generate a form-tag for a file uploading field. For more details, see %s.", 'contact-form-7' ); |
| [675](#L675) | $desc\_link = wpcf7\_link( \_\_( 'https://contactform7.com/file-uploading-and-attachment/', 'contact-form-7' ), \_\_( 'File Uploading and Attachment', 'contact-form-7' ) ); |
| [676](#L676) |  |
| [677](#L677) | ?> |
| [678](#L678) |  |
| [679](#L679) | <div class="control-box"> |
| [680](#L680) | <fieldset> |
| [681](#L681) | <legend><?php echo sprintf( esc\_html( $description ), $desc\_link ); ?></legend> |
| [682](#L682) | <table class="form-table"> |
| [683](#L683) | <tbody> |
| [684](#L684) | <tr> |
| [685](#L685) | <th scope="row"><?php echo esc\_html( \_\_( 'Field type', 'contact-form-7' ) ); ?></th> |
| [686](#L686) | <td> |
| [687](#L687) | <fieldset> |
| [688](#L688) | <legend class="screen-reader-text"><?php echo esc\_html( \_\_( 'Field type', 'contact-form-7' ) ); ?></legend> |
| [689](#L689) | <label><input type="checkbox" name="required" /> <?php echo esc\_html( \_\_( 'Required field', 'contact-form-7' ) ); ?></label> |
| [690](#L690) | </fieldset> |
| [691](#L691) | </td> |
| [692](#L692) | </tr> |
| [693](#L693) | <tr> |
| [694](#L694) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-name' ); ?>"><?php echo esc\_html( \_\_( 'Name', 'contact-form-7' ) ); ?></label></th> |
| [695](#L695) | <td><input type="text" name="name" class="tg-name oneline" id="<?php echo esc\_attr( $args['content'] . '-name' ); ?>" /></td> |
| [696](#L696) | </tr> |
| [697](#L697) | <tr> |
| [698](#L698) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>"><?php echo esc\_html( \_\_( "File size limit (bytes)", 'contact-form-7' ) ); ?></label></th> |
| [699](#L699) | <td><input type="text" name="limit" class="filesize oneline option" id="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>" /></td> |
| [700](#L700) | </tr> |
| [701](#L701) | <tr> |
| [702](#L702) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>"><?php echo esc\_html( \_\_( 'Acceptable file types', 'contact-form-7' ) ); ?></label></th> |
| [703](#L703) | <td><input type="text" name="filetypes" class="filetype oneline option" placeholder="jpeg|png|jpg|gif" id="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>" /></td> |
| [704](#L704) | </tr> |
| [705](#L705) | <tr> |
| [706](#L706) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>"><?php echo esc\_html( \_\_( 'Blacklist file types', 'contact-form-7' ) ); ?></label></th> |
| [707](#L707) | <td><input type="text" name="blacklist-types" class="filetype oneline option" placeholder="exe|bat|com" id="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>" /></td> |
| [708](#L708) | </tr> |
| [709](#L709) | <tr> |
| [710](#L710) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>"><?php echo esc\_html( \_\_( 'Minimum file upload', 'contact-form-7' ) ); ?></label></th> |
| [711](#L711) | <td><input type="text" name="min-file" class="filetype oneline option" placeholder="5" id="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>" /></td> |
| [712](#L712) | </tr> |
| [713](#L713) | <tr> |
| [714](#L714) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>"><?php echo esc\_html( \_\_( 'Max file upload', 'contact-form-7' ) ); ?></label></th> |
| [715](#L715) | <td><input type="text" name="max-file" class="filetype oneline option" placeholder="10" id="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>" /></td> |
| [716](#L716) | </tr> |
| [717](#L717) | <tr> |
| [718](#L718) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-id' ); ?>"><?php echo esc\_html( \_\_( 'Id attribute', 'contact-form-7' ) ); ?></label></th> |
| [719](#L719) | <td><input type="text" name="id" class="idvalue oneline option" id="<?php echo esc\_attr( $args['content'] . '-id' ); ?>" /></td> |
| [720](#L720) | </tr> |
| [721](#L721) | <tr> |
| [722](#L722) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-class' ); ?>"><?php echo esc\_html( \_\_( 'Class attribute', 'contact-form-7' ) ); ?></label></th> |
| [723](#L723) | <td><input type="text" name="class" class="classvalue oneline option" id="<?php echo esc\_attr( $args['content'] . '-class' ); ?>" /></td> |
| [724](#L724) | </tr> |
| [725](#L725) | </tbody> |
| [726](#L726) | </table> |
| [727](#L727) | </fieldset> |
| [728](#L728) | </div> |
| [729](#L729) |  |
| [730](#L730) | <div class="insert-box"> |
| [731](#L731) | <input type="text" name="<?php echo $type; ?>" class="tag code" readonly="readonly" onfocus="this.select()" /> |
| [732](#L732) | <div class="submitbox"> |
| [733](#L733) | <input type="button" class="button button-primary insert-tag" value="<?php echo esc\_attr( \_\_( 'Insert Tag', 'contact-form-7' ) ); ?>" /> |
| [734](#L734) | </div> |
| [735](#L735) | <br class="clear" /> |
| [736](#L736) | <p class="description mail-tag"> |
| [737](#L737) | <label for="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>"><?php echo sprintf( esc\_html( \_\_( "To attach the file uploaded through this field to mail, you need to insert the corresponding mail-tag (%s) into the File Attachments field on the Mail tab.", 'contact-form-7' ) ), '<strong><span class="mail-tag"></span></strong>' ); ?><input type="text" class="mail-tag code hidden" readonly="readonly" id="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>" /></label> |
| [738](#L738) | </p> |
| [739](#L739) | </div> |
| [740](#L740) |  |
| [741](#L741) | <?php |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) | // Get allowed types |
| [745](#L745) | function dnd\_cf7\_get\_allowed\_types( $form\_id ) { |
| [746](#L746) |  |
| [747](#L747) | $tags = dnd\_get\_upload\_form( $form\_id ); |
| [748](#L748) | $supported\_types = array(); |
| [749](#L749) |  |
| [750](#L750) | // Loop all upload tags |
| [751](#L751) | if( $tags && is\_array( $tags ) ) { |
| [752](#L752) | foreach( $tags as $tag ) { |
| [753](#L753) |  |
| [754](#L754) | // Get file types option & remove not allowed character.. |
| [755](#L755) | $types = preg\_replace( '/[^a-zA-Z0-9\*|\']/', '', $tag->get\_option('filetypes','', true ) ); |
| [756](#L756) |  |
| [757](#L757) | // Assign if filetypes is present otherwise use the default ext list. |
| [758](#L758) | $supported\_types[ $tag->name ] = ( $types ? $types : dnd\_upload\_default\_ext() ); |
| [759](#L759) | } |
| [760](#L760) | } |
| [761](#L761) |  |
| [762](#L762) | return $supported\_types; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | // Get file size option |
| [766](#L766) | function dnd\_cf7\_get\_size\_limit( $form\_id ) { |
| [767](#L767) |  |
| [768](#L768) | $tags = dnd\_get\_upload\_form( $form\_id ); |
| [769](#L769) | $allowed\_size = array(); |
| [770](#L770) |  |
| [771](#L771) | // Loop all upload tags |
| [772](#L772) | if( $tags && is\_array( $tags ) ) { |
| [773](#L773) | foreach( $tags as $tag ) { |
| [774](#L774) |  |
| [775](#L775) | // Get file types option & remove not allowed character.. |
| [776](#L776) | $limit = $tag->get\_option('limit','', true ); |
| [777](#L777) |  |
| [778](#L778) | // Assign if filetypes is present otherwise use the default ext list. |
| [779](#L779) | $allowed\_size[ $tag->name ] = ( $limit ? $limit : 10485760 ); //default 10MB |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) |  |
| [783](#L783) | return $allowed\_size; |
| [784](#L784) | } |
| [785](#L785) |  |
| [786](#L786) | // Get contact form data |
| [787](#L787) | function dnd\_get\_upload\_form( $form\_id ){ |
| [788](#L788) |  |
| [789](#L789) | // Initialize contact form instance |
| [790](#L790) | $form = WPCF7\_ContactForm::get\_instance( $form\_id ); |
| [791](#L791) |  |
| [792](#L792) | // Check if not valid object and null |
| [793](#L793) | if( ! $form && ! is\_object( $form ) ) { |
| [794](#L794) | return false; |
| [795](#L795) | } |
| [796](#L796) |  |
| [797](#L797) | // Get specific tag (mfile is for dnd file upload) |
| [798](#L798) | $tags = $form->scan\_form\_tags( array( 'type' => array('mfile', 'mfile\*') ) ); |
| [799](#L799) |  |
| [800](#L800) | if( $tags ){ |
| [801](#L801) | return $tags; |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) | return false; |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | // Begin process upload |
| [808](#L808) | function dnd\_upload\_cf7\_upload() { |
| [809](#L809) |  |
| [810](#L810) | // cf7 form id & upload name |
| [811](#L811) | $cf7\_id = sanitize\_text\_field( (int)$\_POST['form\_id']); |
| [812](#L812) |  |
| [813](#L813) | // Get the name of upload field. |
| [814](#L814) | $cf7\_upload\_name = sanitize\_text\_field( $\_POST['upload\_name'] ); |
| [815](#L815) |  |
| [816](#L816) | // Get allowed ext list @expected : png|jpeg|jpg |
| [817](#L817) | $allowed\_types = dnd\_cf7\_get\_allowed\_types( $cf7\_id ); |
| [818](#L818) |  |
| [819](#L819) | // File size limit |
| [820](#L820) | $size\_limit = dnd\_cf7\_get\_size\_limit( $cf7\_id ); |
| [821](#L821) |  |
| [822](#L822) | // check and verify ajax request |
| [823](#L823) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', 'security', false ) ) { |
| [824](#L824) | wp\_send\_json\_error('The security nonce is invalid or expired.'); |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | // Get blacklist Types |
| [828](#L828) | $blacklist\_types = ( isset( $\_POST['blacklist-types'] ) ?  explode( '|', sanitize\_text\_field( $\_POST['blacklist-types'] ) ) : '' ); |
| [829](#L829) |  |
| [830](#L830) | // Get upload dir |
| [831](#L831) | $path = dnd\_get\_upload\_dir(); |
| [832](#L832) |  |
| [833](#L833) | // input type file 'name' |
| [834](#L834) | $name = 'upload-file'; |
| [835](#L835) |  |
| [836](#L836) | // Get File ( name, type, tmp\_name, size, error ) |
| [837](#L837) | $file = isset( $\_FILES[$name] ) ? $\_FILES[$name] : null; |
| [838](#L838) |  |
| [839](#L839) | // Tells whether the file was uploaded via HTTP POST |
| [840](#L840) | if ( ! is\_uploaded\_file( $file['tmp\_name'] ) ) { |
| [841](#L841) | $failed\_error = get\_option('drag\_n\_drop\_error\_failed\_to\_upload'); |
| [842](#L842) | wp\_send\_json\_error( '('. $file['error'] .') ' . ( $failed\_error ? $failed\_error : dnd\_cf7\_error\_msg('failed\_upload') ) ); |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | /\* Get allowed extension \*/ |
| [846](#L846) | $supported\_type = ( isset( $allowed\_types["$cf7\_upload\_name"] ) ? $allowed\_types["$cf7\_upload\_name"] : dnd\_upload\_default\_ext() ); |
| [847](#L847) |  |
| [848](#L848) | // Create type pattern for anti script |
| [849](#L849) | $file\_type\_pattern = dnd\_upload\_cf7\_filetypes( $supported\_type ); |
| [850](#L850) |  |
| [851](#L851) | // Get file extension |
| [852](#L852) | $extension = strtolower( pathinfo( $file['name'], PATHINFO\_EXTENSION ) ); |
| [853](#L853) |  |
| [854](#L854) | // Validate File Types |
| [855](#L855) | if( $blacklist\_types && in\_array( $extension, $blacklist\_types ) && $supported\_type == '\*' ){ |
| [856](#L856) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [857](#L857) | } |
| [858](#L858) |  |
| [859](#L859) | // validate file type |
| [860](#L860) | if ( ( ! preg\_match( $file\_type\_pattern, $file['name'] ) || ! dnd\_cf7\_validate\_type( $extension, $supported\_type ) ) && $supported\_type != '\*' ) { |
| [861](#L861) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | // validate mime type |
| [865](#L865) | if( $supported\_type && $supported\_type != '\*' ){ |
| [866](#L866) |  |
| [867](#L867) | // wheather if we validate mime type |
| [868](#L868) | $validate\_mime = apply\_filters('dnd\_cf7\_validate\_mime', false ); |
| [869](#L869) |  |
| [870](#L870) | if( $validate\_mime ){ |
| [871](#L871) |  |
| [872](#L872) | if( ! function\_exists('wp\_check\_filetype\_and\_ext') ){ |
| [873](#L873) | require\_once ABSPATH .'wp-admin/includes/file.php'; |
| [874](#L874) | } |
| [875](#L875) |  |
| [876](#L876) | // Get file type and extension name |
| [877](#L877) | $wp\_filetype = wp\_check\_filetype\_and\_ext( $file['tmp\_name'], $file['name'] ); //[ext, type] |
| [878](#L878) | $valid\_mimes = explode('|', $supported\_type); // array[png, jpg] |
| [879](#L879) |  |
| [880](#L880) | if( empty( $wp\_filetype['type'] ) || empty( $wp\_filetype['ext'] ) || ! in\_array( $wp\_filetype['ext'], $valid\_mimes ) ){ |
| [881](#L881) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [882](#L882) | } |
| [883](#L883) | } |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | // validate file size limit |
| [887](#L887) | if( isset( $size\_limit["$cf7\_upload\_name"] ) && $file['size'] > $size\_limit["$cf7\_upload\_name"] ) { |
| [888](#L888) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_files\_too\_large') ? get\_option('drag\_n\_drop\_error\_files\_too\_large') : dnd\_cf7\_error\_msg('large\_file') ); |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | // Create file name |
| [892](#L892) | $filename = wp\_basename( $file['name'] ); |
| [893](#L893) | $filename = wpcf7\_canonicalize( $filename, 'as-is' ); |
| [894](#L894) |  |
| [895](#L895) | // Check if string is ascii then proceed with antiscript function ( remove or clean filename ) |
| [896](#L896) | if( dnd\_cf7\_check\_ascii( $filename ) ){ |
| [897](#L897) | $filename = wpcf7\_antiscript\_file\_name( $filename ); |
| [898](#L898) | } |
| [899](#L899) |  |
| [900](#L900) | // Add filter on upload file name |
| [901](#L901) | $filename = apply\_filters( 'wpcf7\_upload\_file\_name', $filename, $file['name'] ); |
| [902](#L902) |  |
| [903](#L903) | // Generate new filename |
| [904](#L904) | $filename = wp\_unique\_filename( $path['upload\_dir'], $filename ); |
| [905](#L905) | $new\_file = path\_join( $path['upload\_dir'], $filename ); |
| [906](#L906) |  |
| [907](#L907) | // Upload File |
| [908](#L908) | if ( false === move\_uploaded\_file( $file['tmp\_name'], $new\_file ) ) { |
| [909](#L909) | $failed\_error = get\_option('drag\_n\_drop\_error\_failed\_to\_upload'); |
| [910](#L910) | wp\_send\_json\_error( '('. $file['error'] .') ' . ( $failed\_error ? $failed\_error : dnd\_cf7\_error\_msg('failed\_upload') ) ); |
| [911](#L911) | }else{ |
| [912](#L912) |  |
| [913](#L913) | // Setup path and files url |
| [914](#L914) | $files = array( |
| [915](#L915) | 'path'  =>      basename( $path['upload\_dir'] ), |
| [916](#L916) | 'file'  =>      str\_replace('/','-', $filename) |
| [917](#L917) | ); |
| [918](#L918) |  |
| [919](#L919) | // Change file permission to 0400 |
| [920](#L920) | chmod( $new\_file, 0644 ); |
| [921](#L921) |  |
| [922](#L922) | // Allow other plugin to hook |
| [923](#L923) | do\_action('wpcf7\_upload\_file\_name\_custom', $new\_file, $filename ); |
| [924](#L924) |  |
| [925](#L925) | // Return json files |
| [926](#L926) | wp\_send\_json\_success( $files ); |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | die; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | // Check if a string is ASCII. |
| [933](#L933) | function dnd\_cf7\_check\_ascii( $string ) { |
| [934](#L934) | if ( function\_exists( 'mb\_check\_encoding' ) ) { |
| [935](#L935) | if ( mb\_check\_encoding( $string, 'ASCII' ) ) { |
| [936](#L936) | return true; |
| [937](#L937) | } |
| [938](#L938) | } elseif ( ! preg\_match( '/[^\x00-\x7F]/', $string ) ) { |
| [939](#L939) | return true; |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | return false; |
| [943](#L943) | } |
| [944](#L944) |  |
| [945](#L945) | // Delete file |
| [946](#L946) | function dnd\_codedropz\_upload\_delete() { |
| [947](#L947) |  |
| [948](#L948) | // Get folder directory |
| [949](#L949) | $dir = dnd\_get\_upload\_dir(); |
| [950](#L950) |  |
| [951](#L951) | // check and verify ajax request); |
| [952](#L952) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', 'security', false ) ) { |
| [953](#L953) | wp\_send\_json\_error('The security nonce is invalid or expired.'); |
| [954](#L954) | } |
| [955](#L955) |  |
| [956](#L956) |  |
| [957](#L957) | // Sanitize Path |
| [958](#L958) | $get\_path = ( isset( $\_POST['path'] ) ? sanitize\_text\_field( $\_POST['path'] ) : null ); |
| [959](#L959) |  |
| [960](#L960) | //limit the user input to a file name and to ignore injected path names |
| [961](#L961) | $path = basename( $get\_path ); |
| [962](#L962) |  |
| [963](#L963) | // Make sure path is set |
| [964](#L964) | if( ! is\_null( $path ) ) { |
| [965](#L965) |  |
| [966](#L966) | // Check valid filename & extensions |
| [967](#L967) | if( preg\_match\_all('/wp-|(\.php|\.exe|\.js|\.phtml|\.cgi|\.aspx|\.asp|\.bat)/', $path ) ) { |
| [968](#L968) | die('File not safe'); |
| [969](#L969) | } |
| [970](#L970) |  |
| [971](#L971) | // Concatenate path and upload directory |
| [972](#L972) | $file\_path = realpath( trailingslashit( $dir['upload\_dir'] ) . trim( $path ) ); |
| [973](#L973) |  |
| [974](#L974) | // Check if is in the correct upload\_dir |
| [975](#L975) | if( ! preg\_match("/". wpcf7\_dnd\_dir ."/i", $file\_path ) ) { |
| [976](#L976) | die('It\'s not a valid upload directory'); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | // Check if file exists |
| [980](#L980) | if( file\_exists( $file\_path ) ){ |
| [981](#L981) | wp\_delete\_file( $file\_path ); |
| [982](#L982) | if( ! file\_exists( $file\_path ) ) { |
| [983](#L983) | wp\_send\_json\_success('File Deleted!'); |
| [984](#L984) | } |
| [985](#L985) | } |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | die; |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | // Setup file type pattern for validation |
| [992](#L992) | function dnd\_upload\_cf7\_filetypes( $types ) { |
| [993](#L993) | $file\_type\_pattern = ''; |
| [994](#L994) |  |
| [995](#L995) | // If contact form 7 5.0 and up |
| [996](#L996) | if( function\_exists('wpcf7\_acceptable\_filetypes') ) { |
| [997](#L997) | $file\_type\_pattern = wpcf7\_acceptable\_filetypes( $types, 'regex' ); |
| [998](#L998) | $file\_type\_pattern = '/\.(' . $file\_type\_pattern . ')$/i'; |
| [999](#L999) | }else{ |
| [1000](#L1000) | $allowed\_file\_types = array(); |
| [1001](#L1001) | $file\_types = explode( '|', $types ); |
| [1002](#L1002) |  |
| [1003](#L1003) | foreach ( $file\_types as $file\_type ) { |
| [1004](#L1004) | $file\_type = trim( $file\_type, '.' ); |
| [1005](#L1005) | $file\_type = str\_replace( array( '.', '+', '\*', '?' ), array( '\.', '\+', '\\*', '\?' ), $file\_type ); |
| [1006](#L1006) | $allowed\_file\_types[] = $file\_type; |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | $allowed\_file\_types = array\_unique( $allowed\_file\_types ); |
| [1010](#L1010) | $file\_type\_pattern = implode( '|', $allowed\_file\_types ); |
| [1011](#L1011) |  |
| [1012](#L1012) | $file\_type\_pattern = trim( $file\_type\_pattern, '|' ); |
| [1013](#L1013) | $file\_type\_pattern = '(' . $file\_type\_pattern . ')'; |
| [1014](#L1014) | $file\_type\_pattern = '/\.' . $file\_type\_pattern . '$/i'; |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | return $file\_type\_pattern; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | // Add more validation for file extension |
| [1021](#L1021) | function dnd\_cf7\_validate\_type( $extension, $supported\_types ) { |
| [1022](#L1022) | $valid = true; |
| [1023](#L1023) | $extension = preg\_replace( '/[^A-Za-z0-9,|]/', '', $extension ); |
| [1024](#L1024) |  |
| [1025](#L1025) | // not allowed file types |
| [1026](#L1026) | $not\_allowed = array( 'php', 'php3','php4','phtml','exe','script', 'app', 'asp', 'bas', 'bat', 'cer', 'cgi', 'chm', 'cmd', 'com', 'cpl', 'crt', 'csh', 'csr', 'dll', 'drv', 'fxp', 'flv', 'hlp', 'hta', 'htaccess', 'htm', 'htpasswd', 'inf', 'ins', 'isp', 'jar', 'js', 'jse', 'jsp', 'ksh', 'lnk', 'mdb', 'mde', 'mdt', 'mdw', 'msc', 'msi', 'msp', 'mst', 'ops', 'pcd', 'pif', 'pl', 'prg', 'ps1', 'ps2', 'py', 'rb', 'reg', 'scr', 'sct', 'sh', 'shb', 'shs', 'sys', 'swf', 'tmp', 'torrent', 'url', 'vb', 'vbe', 'vbs', 'vbscript', 'wsc', 'wsf', 'wsf', 'wsh' ); |
| [1027](#L1027) |  |
| [1028](#L1028) | // allowed ext. |
| [1029](#L1029) | $allowed\_ext = array('ipt'); |
| [1030](#L1030) |  |
| [1031](#L1031) | // Search in $not\_allowed extension and match |
| [1032](#L1032) | foreach( $not\_allowed as $single\_ext ) { |
| [1033](#L1033) | if ( strpos( $single\_ext, $extension, 0 ) !== false && ! in\_array( $extension, $allowed\_ext )) { |
| [1034](#L1034) | $valid = false; |
| [1035](#L1035) | break; |
| [1036](#L1036) | } |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | // If pass on first validation - check extension if exists in allowed types |
| [1040](#L1040) | if( $valid === true ) { |
| [1041](#L1041) | $extensions = explode('|', strtolower( $supported\_types ) ); |
| [1042](#L1042) | if( ! in\_array( $extension, $extensions ) ) { |
| [1043](#L1043) | $valid = false; |
| [1044](#L1044) | } |
| [1045](#L1045) | } |
| [1046](#L1046) |  |
| [1047](#L1047) | return $valid; |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | // Admin Settings |
| [1051](#L1051) | function dnd\_upload\_admin\_settings( ) { |
| [1052](#L1052) | echo '<div class="wrap">'; |
| [1053](#L1053) | echo '<h1>Drag & Drop Uploader - Settings</h1>'; |
| [1054](#L1054) |  |
| [1055](#L1055) | echo '<div class="update-nag notice" style="width: 98%;padding: 0px 10px;margin-bottom: 5px;">'; |
| [1056](#L1056) | echo '<p>Checkout more features on <a href="https://codedropz.com/purchase-plugin/" target="\_blank">Pro Version</a></p>'; |
| [1057](#L1057) | echo '</div>'; |
| [1058](#L1058) |  |
| [1059](#L1059) | // Error settings |
| [1060](#L1060) | settings\_errors(); |
| [1061](#L1061) |  |
| [1062](#L1062) | echo '<form method="post" action="options.php"> '; |
| [1063](#L1063) | settings\_fields( 'drag-n-drop-upload-file-cf7' ); |
| [1064](#L1064) | do\_settings\_sections( 'drag-n-drop-upload-file-cf7' ); |
| [1065](#L1065) | ?> |
| [1066](#L1066) |  |
| [1067](#L1067) | <table class="form-table" style="display:none;"> |
| [1068](#L1068) | <tr valign="top"> |
| [1069](#L1069) | <th scope="row"><?php \_e('Translate To','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1070](#L1070) | <td><?php wp\_dropdown\_languages( array('name' => 'drag\_n\_drop\_lang', 'id' => 'drag\_n\_drop\_lang') ); ?> |
| [1071](#L1071) | <div style="margin-top:20px;"> |
| [1072](#L1072) | <strong>Translated: </strong><a href="">abc</a> |
| [1073](#L1073) | </div> |
| [1074](#L1074) | </td> |
| [1075](#L1075) | </tr> |
| [1076](#L1076) | </table> |
| [1077](#L1077) |  |
| [1078](#L1078) | <table class="form-table"> |
| [1079](#L1079) | <tr valign="top"> |
| [1080](#L1080) | <th scope="row"><?php \_e('Send Attachment as links?','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1081](#L1081) | <td><input name="drag\_n\_drop\_mail\_attachment" type="checkbox" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_mail\_attachment')); ?>></td> |
| [1082](#L1082) | </tr> |
| [1083](#L1083) | </table> |
| [1084](#L1084) |  |
| [1085](#L1085) | <h2><?php \_e('Uploader Info','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1086](#L1086) |  |
| [1087](#L1087) | <table class="form-table"> |
| [1088](#L1088) | <tr valign="top"> |
| [1089](#L1089) | <th scope="row"><?php \_e('Heading Tag','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1090](#L1090) | <td> |
| [1091](#L1091) | <select name="drag\_n\_drop\_heading\_tag"> |
| [1092](#L1092) | <option value="h1" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h1'); ?>>H1</option> |
| [1093](#L1093) | <option value="h2" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h2'); ?>>H2</option> |
| [1094](#L1094) | <option value="h3" <?php selected( get\_option('drag\_n\_drop\_heading\_tag','h3'), 'h3'); ?>>H3</option> |
| [1095](#L1095) | <option value="h4" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h4'); ?>>H4</option> |
| [1096](#L1096) | <option value="h5" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h5'); ?>>H5</option> |
| [1097](#L1097) | <option value="h6" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h6'); ?>>H6</option> |
| [1098](#L1098) | <option value="span" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'span'); ?>>Span</option> |
| [1099](#L1099) | <option value="div" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'div'); ?>>Div</option> |
| [1100](#L1100) | </select> |
| [1101](#L1101) | </td> |
| [1102](#L1102) | </tr> |
| [1103](#L1103) | <tr valign="top"> |
| [1104](#L1104) | <th scope="row"><?php \_e('Drag & Drop Text','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1105](#L1105) | <td><input type="text" name="drag\_n\_drop\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_text') ); ?>" placeholder="Drag & Drop Files Here" /></td> |
| [1106](#L1106) | </tr> |
| [1107](#L1107) | <tr valign="top"> |
| [1108](#L1108) | <th scope="row"></th> |
| [1109](#L1109) | <td><input type="text" name="drag\_n\_drop\_separator" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_separator') ); ?>" placeholder="or" /></td> |
| [1110](#L1110) | </tr> |
| [1111](#L1111) | <tr valign="top"> |
| [1112](#L1112) | <th scope="row"><?php \_e('Browse Text','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1113](#L1113) | <td><input type="text" name="drag\_n\_drop\_browse\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_browse\_text') ); ?>" placeholder="Browse Files" /></td> |
| [1114](#L1114) | </tr> |
| [1115](#L1115) | </table> |
| [1116](#L1116) |  |
| [1117](#L1117) | <h2><?php \_e('Error Message','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1118](#L1118) |  |
| [1119](#L1119) | <table class="form-table"> |
| [1120](#L1120) | <tr valign="top"> |
| [1121](#L1121) | <th scope="row"><?php \_e('File exceeds server limit','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1122](#L1122) | <td><input type="text" name="drag\_n\_drop\_error\_server\_limit" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_server\_limit') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('server\_limit'); ?>" /></td> |
| [1123](#L1123) | </tr> |
| [1124](#L1124) | <tr valign="top"> |
| [1125](#L1125) | <th scope="row"><?php \_e('Failed to Upload','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1126](#L1126) | <td><input type="text" name="drag\_n\_drop\_error\_failed\_to\_upload" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_failed\_to\_upload') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('failed\_upload'); ?>" /></td> |
| [1127](#L1127) | </tr> |
| [1128](#L1128) | <tr valign="top"> |
| [1129](#L1129) | <th scope="row"><?php \_e('Files too large','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1130](#L1130) | <td><input type="text" name="drag\_n\_drop\_error\_files\_too\_large" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_files\_too\_large') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('large\_file'); ?>" /></td> |
| [1131](#L1131) | </tr> |
| [1132](#L1132) | <tr valign="top"> |
| [1133](#L1133) | <th scope="row"><?php \_e('Invalid file Type','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1134](#L1134) | <td><input type="text" name="drag\_n\_drop\_error\_invalid\_file" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_invalid\_file') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('invalid\_type'); ?>" /></td> |
| [1135](#L1135) | </tr> |
| [1136](#L1136) | <tr valign="top"> |
| [1137](#L1137) | <th scope="row"><?php \_e('Max File Limit','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1138](#L1138) | <td><input type="text" name="drag\_n\_drop\_error\_max\_file" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_max\_file') ); ?>" placeholder="" /><p class="description">Example: `Note : Some of the files are not uploaded ( Only %count% files allowed )`</p></td> |
| [1139](#L1139) | </tr> |
| [1140](#L1140) | <tr valign="top"> |
| [1141](#L1141) | <th scope="row"><?php \_e('Minimum File','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1142](#L1142) | <td><input type="text" name="drag\_n\_drop\_error\_min\_file" placeholder="" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_min\_file') ); ?>" placeholder="" /></td> |
| [1143](#L1143) | </tr> |
| [1144](#L1144) | </table> |
| [1145](#L1145) |  |
| [1146](#L1146) | <h2><?php \_e('Auto Delete Files','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1147](#L1147) |  |
| [1148](#L1148) | <table class="form-table"> |
| [1149](#L1149) | <tr valign="top"> |
| [1150](#L1150) | <th scope="row"><?php \_e('Don\'t delete files','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1151](#L1151) | <td><input type="checkbox" name="drag\_n\_drop\_disable\_auto\_delete" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_auto\_delete')); ?>> Yes <br><p class="description"><em>The default will automatically delete files 1-2 hours after submissions, if you want to keep files check "Yes" above.</em></p></td> |
| [1152](#L1152) | </tr> |
| [1153](#L1153) | </table> |
| [1154](#L1154) |  |
| [1155](#L1155) | <h2><?php \_e('Spam Filtering Issue','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1156](#L1156) |  |
| [1157](#L1157) | <table class="form-table"> |
| [1158](#L1158) | <tr valign="top"> |
| [1159](#L1159) | <th scope="row"><?php \_e('Fix Spam','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1160](#L1160) | <td><input type="checkbox" name="drag\_n\_drop\_fix\_spam" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_fix\_spam')); ?>> Yes <p class="description"><em>If a “spam” answer is the response, Contact Form 7 will suspend the email and show a message saying, “There was an error trying to send your message", force to send message by checking this option..</em></p></td> |
| [1161](#L1161) | </tr> |
| [1162](#L1162) | </table> |
| [1163](#L1163) |  |
| [1164](#L1164) | <h2><?php \_e('Use jQuery','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1165](#L1165) |  |
| [1166](#L1166) | <table class="form-table"> |
| [1167](#L1167) | <tr valign="top"> |
| [1168](#L1168) | <th scope="row"><?php \_e('Enable jQuery','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1169](#L1169) | <td><input type="checkbox" name="drag\_n\_drop\_use\_jquery" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_use\_jquery')); ?>> Yes <p class="description"><em>Activate this option in case there are any problems with our plugin when utilizing native Javascript.</em></p></td> |
| [1170](#L1170) | </tr> |
| [1171](#L1171) | </table> |
| [1172](#L1172) |  |
| [1173](#L1173) | <h2 style="display:none;"><?php \_e('Disable Button','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1174](#L1174) |  |
| [1175](#L1175) | <table style="display:none;" class="form-table"> |
| [1176](#L1176) | <tr valign="top"> |
| [1177](#L1177) | <th scope="row"><?php \_e('Disable Submit button','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1178](#L1178) | <td><input type="checkbox" name="drag\_n\_drop\_disable\_btn" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_btn')); ?>> Yes <p class="description">Disable submit button if there's an error.</p></td> |
| [1179](#L1179) | </tr> |
| [1180](#L1180) | </table> |
| [1181](#L1181) |  |
| [1182](#L1182) | <?php submit\_button(); ?> |
| [1183](#L1183) |  |
| [1184](#L1184) | <?php |
| [1185](#L1185) | echo '</form>'; |
| [1186](#L1186) | echo '</div>'; |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | // Add script in footer |
| [1190](#L1190) | function dnd\_custom\_scripts() { |
| [1191](#L1191) | if( ! in\_array('jquery-validation-for-contact-form-7/jquery-validation-for-contact-form-7.php', get\_option('active\_plugins') ) ){ |
| [1192](#L1192) | return; |
| [1193](#L1193) | } |
| [1194](#L1194) | ?> |
| [1195](#L1195) | <script type="text/javascript"> |
| [1196](#L1196) | // Contact form 7 - Jquery validation |
| [1197](#L1197) | jQuery(document).ready(function($){ |
| [1198](#L1198) | jQuery('.wpcf7-form-control.wpcf7-submit').click(function(e){ |
| [1199](#L1199) | var uploadFields = $(this).parents('form').find('.wpcf7-drag-n-drop-file'); |
| [1200](#L1200) | var valid = true; |
| [1201](#L1201) | if( uploadFields.length > 0 ) { |
| [1202](#L1202) | jQuery.each(uploadFields, function(i,field){ |
| [1203](#L1203) | if( $(field).attr('aria-required') == 'true' ) { |
| [1204](#L1204) | parentsWrap = $(field).parents('.codedropz-upload-wrapper'); |
| [1205](#L1205) | parentsWrap.removeClass('invalid'); |
| [1206](#L1206) | parentsWrap.find('label').remove(); |
| [1207](#L1207) | if( $('[type="hidden"][name="'+$(field).attr('data-name')+'[]"]').length == 0 ) { |
| [1208](#L1208) | parentsWrap.append('<label class="error-new">'+ dnd\_cf7\_uploader.drag\_n\_drop\_upload.required +'</label>').addClass('invalid'); |
| [1209](#L1209) | valid = false; |
| [1210](#L1210) | } |
| [1211](#L1211) | } |
| [1212](#L1212) | }); |
| [1213](#L1213) | if( ! valid ) { |
| [1214](#L1214) | return false; |
| [1215](#L1215) | } |
| [1216](#L1216) | } |
| [1217](#L1217) | return true; |
| [1218](#L1218) | }); |
| [1219](#L1219) | }); |
| [1220](#L1220) | </script> |
| [1221](#L1221) | <?php |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | // Custom css style - Inline |
| [1225](#L1225) | function dnd\_custom\_style(){ |
| [1226](#L1226) | echo '<style id="multiple-file-upload">'; |
| [1227](#L1227) | include dnd\_upload\_cf7\_directory . '/assets/css/dnd-upload-cf7.css'; |
| [1228](#L1228) | echo '</style>'; |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | // Define custom (safe) file extension. |
| [1232](#L1232) | function dnd\_upload\_default\_ext() { |
| [1233](#L1233) | return apply\_filters('dnd\_cf7\_default\_ext', 'jpg|jpeg|JPG|png|gif|pdf|doc|docx|ppt|pptx|odt|avi|ogg|m4a|mov|mp3|mp4|mpg|wav|wmv|xls' ); |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | // Add custom links |
| [1237](#L1237) | function dnd\_custom\_plugin\_row\_meta( $links, $file ) { |
| [1238](#L1238) | if ( strpos( $file, 'drag-n-drop-upload-cf7.php' ) !== false ) { |
| [1239](#L1239) | $new\_links = array('pro-version' => '<a href="https://codedropz.com/purchase-plugin/" target="\_blank" style="font-weight:bold; color:#f4a647;">Pro Version</a>'); |
| [1240](#L1240) | $links = array\_merge( $links, $new\_links ); |
| [1241](#L1241) | } |
| [1242](#L1242) | return $links; |
| [1243](#L1243) | } |
| [1244](#L1244) |  |
| [1245](#L1245) | // Save admin settings |
| [1246](#L1246) | function dnd\_upload\_register\_settings() { |
| [1247](#L1247) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_heading\_tag','sanitize\_text\_field' ); |
| [1248](#L1248) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_mail\_attachment','sanitize\_text\_field' ); |
| [1249](#L1249) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_text','sanitize\_text\_field' ); |
| [1250](#L1250) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_separator','sanitize\_text\_field' ); |
| [1251](#L1251) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_browse\_text','sanitize\_text\_field' ); |
| [1252](#L1252) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_server\_limit','sanitize\_text\_field' ); |
| [1253](#L1253) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_failed\_to\_upload','sanitize\_text\_field' ); |
| [1254](#L1254) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_files\_too\_large','sanitize\_text\_field' ); |
| [1255](#L1255) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_invalid\_file','sanitize\_text\_field' ); |
| [1256](#L1256) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_max\_file','sanitize\_text\_field' ); |
| [1257](#L1257) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_min\_file','sanitize\_text\_field' ); |
| [1258](#L1258) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_disable\_btn','sanitize\_text\_field' ); |
| [1259](#L1259) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_disable\_auto\_delete','sanitize\_text\_field' ); |
| [1260](#L1260) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_fix\_spam','sanitize\_text\_field' ); |
| [1261](#L1261) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_use\_jquery','sanitize\_text\_field' ); |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | function dnd\_upload\_cf7\_lang() { |
| [1265](#L1265) | $lang = null; |
| [1266](#L1266) |  |
| [1267](#L1267) | // Polylang & WPML compatiblity |
| [1268](#L1268) | if( function\_exists('pll\_current\_language') ) { |
| [1269](#L1269) | $lang = pll\_current\_language(); |
| [1270](#L1270) | }elseif( class\_exists('SitePress') ) { |
| [1271](#L1271) | $lang = ICL\_LANGUAGE\_CODE; |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | // If english / default lang leave empty. |
| [1275](#L1275) | if( $lang ) { |
| [1276](#L1276) | $lang = ( $lang == 'en' ? '' : '-'.$lang ); |
| [1277](#L1277) | } |
| [1278](#L1278) |  |
| [1279](#L1279) | return apply\_filters('dndmfu\_wc\_lang', $lang ); |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | /\*add\_action('admin\_footer', function(){ |
| [1283](#L1283) | if( isset( $\_GET['page'] ) && $\_GET['page'] == 'drag-n-drop-upload' ) { |
| [1284](#L1284) | ?> |
| [1285](#L1285) | <script type="text/javascript"> |
| [1286](#L1286) | jQuery('document').ready(function($){ |
| [1287](#L1287) | $('#drag\_n\_drop\_lang').change(function(){ |
| [1288](#L1288) | window.location.href = "<?php echo admin\_url('admin.php?page=drag-n-drop-upload&lang-code='); ?>" + $(this).val(); |
| [1289](#L1289) | }); |
| [1290](#L1290) | }); |
| [1291](#L1291) | </script> |
| [1292](#L1292) | <?php |
| [1293](#L1293) | } |
| [1294](#L1294) | });\*/ |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?format=txt)
* [Original Format](/export/3222448/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_aeb168b3_20250114_191435.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D2987252%2540drag-and-drop-multiple-file-upload-contact-form-7%252Ftrunk%26old%3D2968538%2540drag-and-drop-multiple-file-upload-contact-form-7%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2968538/drag-and-drop-multiple-file-upload-contact-form-7/trunk?old=2987252&old_path=%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk)

---

# Changes in [drag-and-drop-multiple-file-upload-contact-form-7/trunk](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk?rev=2987252 "Show entry in browser") [[2968538:2987252]](/log/drag-and-drop-multiple-file-upload-contact-form-7/trunk?rev=2987252&stop_rev=2968538 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[drag-and-drop-multiple-file-upload-contact-form-7/trunk](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk?rev=2987252)
Files:

4 edited

* [assets/js/codedropz-uploader-min.js](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/assets/js/codedropz-uploader-min.js?rev=2987252 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [drag-n-drop-upload-cf7.php](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/drag-n-drop-upload-cf7.php?rev=2987252 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [inc/dnd-upload-cf7.php](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252 "Show entry in browser")
  (modified)
  ([21 diffs](#file2 "Show differences"))
* [readme.txt](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/readme.txt?rev=2987252 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [drag-and-drop-multiple-file-upload-contact-form-7/trunk/assets/js/codedropz-uploader-min.js](/changeset/2987252/drag-and-drop-multiple-file-upload-contact-form-7/trunk/assets/js/codedropz-uploader-min.js?old=2968538&old_path=drag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk%2Fassets%2Fjs%2Fcodedropz-uploader-min.js "Show the [2968538:2987252] differences restricted to drag-and-drop-multiple-file-upload-contact-form-7/trunk/assets/js/codedropz-uploader-min.js")

  | [r2968538](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/assets/js/codedropz-uploader-min.js?rev=2968538#L157 "Show revision 2968538 of this file in browser") | [r2987252](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/assets/js/codedropz-uploader-min.js?rev=2987252#L157 "Show revision 2987252 of this file in browser") |  |
  | --- | --- | --- |
  | 157 | 157 |  |
  | 158 | 158 | // black list file types |
  | 159 |  | if( input.hasAttribute('data-black-list') ){ |
  |  | 159 | /\*if( input.hasAttribute('data-black-list') ){ |
  | 160 | 160 | formData.append('blacklist-types', input.dataset.blackList); |
  | 161 |  | } |
  |  | 161 | }\*/ |
  | 162 | 162 |  |
  | 163 | 163 | // remove has error |
* ## [drag-and-drop-multiple-file-upload-contact-form-7/trunk/drag-n-drop-upload-cf7.php](/changeset/2987252/drag-and-drop-multiple-file-upload-contact-form-7/trunk/drag-n-drop-upload-cf7.php?old=2968538&old_path=drag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk%2Fdrag-n-drop-upload-cf7.php "Show the [2968538:2987252] differences restricted to drag-and-drop-multiple-file-upload-contact-form-7/trunk/drag-n-drop-upload-cf7.php")

  | [r2968538](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/drag-n-drop-upload-cf7.php?rev=2968538#L7 "Show revision 2968538 of this file in browser") | [r2987252](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/drag-n-drop-upload-cf7.php?rev=2987252#L7 "Show revision 2987252 of this file in browser") |  |
  | --- | --- | --- |
  | 7 | 7 | \* Text Domain: drag-and-drop-multiple-file-upload-contact-form-7 |
  | 8 | 8 | \* Domain Path: /languages |
  | 9 |  | \* Version: 1.3.7.~~3~~ |
  |  | 9 | \* Version: 1.3.7.4 |
  | 10 | 10 | \* Author: Glen Don L. Mongaya |
  | 11 | 11 | \* Author URI: http://codedropz.com |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/drag-n-drop-upload-cf7.php?rev=2968538#L22) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/drag-n-drop-upload-cf7.php?rev=2987252#L22) |  |
  | 22 | 22 |  |
  | 23 | 23 | /\*\*  Define plugin Version \*/ |
  | 24 |  | define( 'dnd\_upload\_cf7\_version', '1.3.7.~~3~~' ); |
  |  | 24 | define( 'dnd\_upload\_cf7\_version', '1.3.7.4' ); |
  | 25 | 25 |  |
  | 26 | 26 | /\*\*  Define constant Plugin Directories  \*/ |
* ## [drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php](/changeset/2987252/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?old=2968538&old_path=drag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk%2Finc%2Fdnd-upload-cf7.php "Show the [2968538:2987252] differences restricted to drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php")

  | [r2968538](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L69 "Show revision 2968538 of this file in browser") | [r2987252](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L69 "Show revision 2987252 of this file in browser") |  |
  | --- | --- | --- |
  | 69 | 69 | // Add links to settings |
  | 70 | 70 | function dnd\_cf7\_upload\_links( $actions ) { |
  | 71 |  | $upload\_links = array('<a href="' . admin\_url( 'admin.php?page=drag-n-drop-upload' ) . '">~~' . esc\_html\_\_( 'Settings', 'drag-and-drop-multiple-file-upload-contact-form-7' ) . '~~</a>',); |
  |  | 71 | $upload\_links = array('<a href="' . admin\_url( 'admin.php?page=drag-n-drop-upload' ) . '">Settings</a>',); |
  | 72 | 72 | $actions = array\_merge( $upload\_links, $actions ); |
  | 73 | 73 | return $actions; |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L149) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L149) |  |
  | 149 | 149 | // Hooks for admin settings |
  | 150 | 150 | function dnd\_admin\_settings() { |
  | 151 |  | add\_submenu\_page( 'wpcf7', ~~\_\_( 'Drag & Drop Uploader - Settings', 'drag-and-drop-multiple-file-upload-contact-form-7' ), \_\_( 'Drag & Drop Upload', 'drag-and-drop-multiple-file-upload-contact-form-7' )~~, 'manage\_options', 'drag-n-drop-upload','dnd\_upload\_admin\_settings'); |
  |  | 151 | add\_submenu\_page( 'wpcf7', 'Drag & Drop Uploader - Settings', 'Drag & Drop Upload', 'manage\_options', 'drag-n-drop-upload','dnd\_upload\_admin\_settings'); |
  | 152 | 152 | add\_action('admin\_init','dnd\_upload\_register\_settings'); |
  | 153 | 153 | } |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L672) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L672) |  |
  | 672 | 672 | $type = 'mfile'; |
  | 673 | 673 |  |
  | 674 |  | $description = \_\_( "Generate a form-tag for a file uploading field. For more details, see %s.", '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ); |
  | 675 |  | $desc\_link = wpcf7\_link( \_\_( 'https://contactform7.com/file-uploading-and-attachment/', '~~drag-and-drop-multiple-file-upload-contact-form-7' ), \_\_( 'File Uploading and Attachment', 'drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); |
  |  | 674 | $description = \_\_( "Generate a form-tag for a file uploading field. For more details, see %s.", 'contact-form-7' ); |
  |  | 675 | $desc\_link = wpcf7\_link( \_\_( 'https://contactform7.com/file-uploading-and-attachment/', 'contact-form-7' ), \_\_( 'File Uploading and Attachment', 'contact-form-7' ) ); |
  | 676 | 676 |  |
  | 677 | 677 | ?> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L683) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L683) |  |
  | 683 | 683 | <tbody> |
  | 684 | 684 | <tr> |
  | 685 |  | <th scope="row"><?php echo esc\_html( \_\_( 'Field type', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></th> |
  |  | 685 | <th scope="row"><?php echo esc\_html( \_\_( 'Field type', 'contact-form-7' ) ); ?></th> |
  | 686 | 686 | <td> |
  | 687 | 687 | <fieldset> |
  | 688 |  | <legend class="screen-reader-text"><?php echo esc\_html( \_\_( 'Field type', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></legend> |
  | 689 |  | <label><input type="checkbox" name="required" /> <?php echo esc\_html( \_\_( 'Required field', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label> |
  |  | 688 | <legend class="screen-reader-text"><?php echo esc\_html( \_\_( 'Field type', 'contact-form-7' ) ); ?></legend> |
  |  | 689 | <label><input type="checkbox" name="required" /> <?php echo esc\_html( \_\_( 'Required field', 'contact-form-7' ) ); ?></label> |
  | 690 | 690 | </fieldset> |
  | 691 | 691 | </td> |
  | 692 | 692 | </tr> |
  | 693 | 693 | <tr> |
  | 694 |  | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-name' ); ?>"><?php echo esc\_html( \_\_( 'Name', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label></th> |
  |  | 694 | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-name' ); ?>"><?php echo esc\_html( \_\_( 'Name', 'contact-form-7' ) ); ?></label></th> |
  | 695 | 695 | <td><input type="text" name="name" class="tg-name oneline" id="<?php echo esc\_attr( $args['content'] . '-name' ); ?>" /></td> |
  | 696 | 696 | </tr> |
  | 697 | 697 | <tr> |
  | 698 |  | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>"><?php echo esc\_html( \_\_( "File size limit (bytes)", '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label></th> |
  |  | 698 | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>"><?php echo esc\_html( \_\_( "File size limit (bytes)", 'contact-form-7' ) ); ?></label></th> |
  | 699 | 699 | <td><input type="text" name="limit" class="filesize oneline option" id="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>" /></td> |
  | 700 | 700 | </tr> |
  | 701 | 701 | <tr> |
  | 702 |  | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>"><?php echo esc\_html( \_\_( 'Acceptable file types', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label></th> |
  |  | 702 | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>"><?php echo esc\_html( \_\_( 'Acceptable file types', 'contact-form-7' ) ); ?></label></th> |
  | 703 | 703 | <td><input type="text" name="filetypes" class="filetype oneline option" placeholder="jpeg|png|jpg|gif" id="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>" /></td> |
  | 704 | 704 | </tr> |
  | 705 | 705 | <tr> |
  | 706 |  | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>"><?php echo esc\_html( \_\_( 'Blacklist file types', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label></th> |
  |  | 706 | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>"><?php echo esc\_html( \_\_( 'Blacklist file types', 'contact-form-7' ) ); ?></label></th> |
  | 707 | 707 | <td><input type="text" name="blacklist-types" class="filetype oneline option" placeholder="exe|bat|com" id="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>" /></td> |
  | 708 | 708 | </tr> |
  | 709 | 709 | <tr> |
  | 710 |  | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>"><?php echo esc\_html( \_\_( 'Minimum file upload', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label></th> |
  |  | 710 | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>"><?php echo esc\_html( \_\_( 'Minimum file upload', 'contact-form-7' ) ); ?></label></th> |
  | 711 | 711 | <td><input type="text" name="min-file" class="filetype oneline option" placeholder="5" id="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>" /></td> |
  | 712 | 712 | </tr> |
  | 713 | 713 | <tr> |
  | 714 |  | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>"><?php echo esc\_html( \_\_( 'Max file upload', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label></th> |
  |  | 714 | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>"><?php echo esc\_html( \_\_( 'Max file upload', 'contact-form-7' ) ); ?></label></th> |
  | 715 | 715 | <td><input type="text" name="max-file" class="filetype oneline option" placeholder="10" id="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>" /></td> |
  | 716 | 716 | </tr> |
  | 717 | 717 | <tr> |
  | 718 |  | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-id' ); ?>"><?php echo esc\_html( \_\_( 'Id attribute', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label></th> |
  |  | 718 | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-id' ); ?>"><?php echo esc\_html( \_\_( 'Id attribute', 'contact-form-7' ) ); ?></label></th> |
  | 719 | 719 | <td><input type="text" name="id" class="idvalue oneline option" id="<?php echo esc\_attr( $args['content'] . '-id' ); ?>" /></td> |
  | 720 | 720 | </tr> |
  | 721 | 721 | <tr> |
  | 722 |  | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-class' ); ?>"><?php echo esc\_html( \_\_( 'Class attribute', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?></label></th> |
  |  | 722 | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-class' ); ?>"><?php echo esc\_html( \_\_( 'Class attribute', 'contact-form-7' ) ); ?></label></th> |
  | 723 | 723 | <td><input type="text" name="class" class="classvalue oneline option" id="<?php echo esc\_attr( $args['content'] . '-class' ); ?>" /></td> |
  | 724 | 724 | </tr> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L731) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L731) |  |
  | 731 | 731 | <input type="text" name="<?php echo $type; ?>" class="tag code" readonly="readonly" onfocus="this.select()" /> |
  | 732 | 732 | <div class="submitbox"> |
  | 733 |  | <input type="button" class="button button-primary insert-tag" value="<?php echo esc\_attr( \_\_( 'Insert Tag', '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ); ?>" /> |
  |  | 733 | <input type="button" class="button button-primary insert-tag" value="<?php echo esc\_attr( \_\_( 'Insert Tag', 'contact-form-7' ) ); ?>" /> |
  | 734 | 734 | </div> |
  | 735 | 735 | <br class="clear" /> |
  | 736 | 736 | <p class="description mail-tag"> |
  | 737 |  | <label for="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>"><?php echo sprintf( esc\_html( \_\_( "To attach the file uploaded through this field to mail, you need to insert the corresponding mail-tag (%s) into the File Attachments field on the Mail tab.", '~~drag-and-drop-multiple-file-upload-~~contact-form-7' ) ), '<strong><span class="mail-tag"></span></strong>' ); ?><input type="text" class="mail-tag code hidden" readonly="readonly" id="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>" /></label> |
  |  | 737 | <label for="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>"><?php echo sprintf( esc\_html( \_\_( "To attach the file uploaded through this field to mail, you need to insert the corresponding mail-tag (%s) into the File Attachments field on the Mail tab.", 'contact-form-7' ) ), '<strong><span class="mail-tag"></span></strong>' ); ?><input type="text" class="mail-tag code hidden" readonly="readonly" id="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>" /></label> |
  | 738 | 738 | </p> |
  | 739 | 739 | </div> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L742) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L742) |  |
  | 742 | 742 | } |
  | 743 | 743 |  |
  | 744 |  | // Get allowed types |
  | 745 |  | function dnd\_cf7\_get\_allowed\_types( $form\_id ) { |
  | 746 |  |  |
  | 747 |  | $tags = dnd\_get\_upload\_form( $form\_id ); |
  | 748 |  | $supported\_types = array(); |
  | 749 |  |  |
  | 750 |  | // Loop all upload tags |
  | 751 |  | if( $tags && is\_array( $tags ) ) { |
  | 752 |  | foreach( $tags as $tag ) { |
  | 753 |  |  |
  | 754 |  | // Get file types option & remove not allowed character.. |
  | 755 |  | $types = preg\_replace( '/[^a-zA-Z0-9\*|\']/', '', $tag->get\_option('filetypes','', true ) ); |
  | 756 |  |  |
  | 757 |  | // Assign if filetypes is present otherwise use the default ext list. |
  | 758 |  | $supported\_types[ $tag->name ] = ( $types ? $types : dnd\_upload\_default\_ext() ); |
  | 759 |  | } |
  | 760 |  | } |
  | 761 |  |  |
  | 762 |  | return $supported\_types; |
  | 763 |  | } |
  | 764 |  |  |
  | 765 |  | // Get file size option |
  | 766 |  | function dnd\_cf7\_get\_size\_limit( $form\_id ) { |
  |  | 744 | // Get option |
  |  | 745 | function dnd\_cf7\_get\_option( $form\_id, $option\_name ) { |
  | 767 | 746 |  |
  | 768 | 747 | $tags = dnd\_get\_upload\_form( $form\_id ); |
  | 769 |  | $allowed\_size = array(); |
  |  | 748 | $options = array(); |
  |  | 749 | $args = array( |
  |  | 750 | 'limit'     =>  10485760, |
  |  | 751 | 'filetypes' =>  dnd\_upload\_default\_ext() |
  |  | 752 | ); |
  | 770 | 753 |  |
  | 771 | 754 | // Loop all upload tags |
  | 772 | 755 | if( $tags && is\_array( $tags ) ) { |
  | 773 | 756 | foreach( $tags as $tag ) { |
  | 774 |  |  |
  | 775 |  | // Get file types option & remove not allowed character.. |
  | 776 |  | $limit = $tag->get\_option('limit','', true ); |
  | 777 |  |  |
  | 778 |  | // Assign if filetypes is present otherwise use the default ext list. |
  | 779 |  | $allowed\_size[ $tag->name ] = ( $limit ? $limit : 10485760 ); //default 10MB |
  | 780 |  | } |
  | 781 |  | } |
  | 782 |  |  |
  | 783 |  | return $allowed\_size; |
  |  | 757 | if( $option = $tag->get\_option( $option\_name, '', true ) ){ |
  |  | 758 | $options[ $tag->name ] = $option; |
  |  | 759 | }else{ |
  |  | 760 | $options[ $tag->name ] = ( isset( $args[ $option\_name ] ) ? $args[ $option\_name ] : '' ); |
  |  | 761 | } |
  |  | 762 | } |
  |  | 763 | } |
  |  | 764 |  |
  |  | 765 | return $options; |
  | 784 | 766 | } |
  | 785 | 767 |  |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L815) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L797) |  |
  | 815 | 797 |  |
  | 816 | 798 | // Get allowed ext list @expected : png|jpeg|jpg |
  | 817 |  | $allowed\_types = dnd\_cf7\_get\_~~allowed\_types( $cf7\_id~~ ); |
  |  | 799 | $allowed\_types = dnd\_cf7\_get\_option( $cf7\_id, 'filetypes' ); |
  | 818 | 800 |  |
  | 819 | 801 | // File size limit |
  | 820 |  | $size\_limit = dnd\_cf7\_get\_size\_limit( $cf7\_id ); |
  |  | 802 | $size\_limit = dnd\_cf7\_get\_option( $cf7\_id, 'limit' ); |
  |  | 803 |  |
  |  | 804 | // Blacklist Option |
  |  | 805 | $blacklist = dnd\_cf7\_get\_option( $cf7\_id, 'blacklist-types' ); |
  | 821 | 806 |  |
  | 822 | 807 | // check and verify ajax request |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L826) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L811) |  |
  | 826 | 811 |  |
  | 827 | 812 | // Get blacklist Types |
  | 828 |  | $blacklist\_types = ( isset( $~~\_POST['blacklist-types'] ) ?  explode( '|', sanitize\_text\_field( $\_POST['blacklist-types'] )~~ ) : '' ); |
  |  | 813 | $blacklist\_types = ( isset( $blacklist["$cf7\_upload\_name"] ) ?  explode( '|', $blacklist["$cf7\_upload\_name"] ) : '' ); |
  | 829 | 814 |  |
  | 830 | 815 | // Get upload dir |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L850) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L835) |  |
  | 850 | 835 |  |
  | 851 | 836 | // Get file extension |
  | 852 |  | $extension = strtolower( pathinfo( $file['name'], PATHINFO\_EXTENSION ) ); |
  |  | 837 | $extension = strtolower( pathinfo( sanitize\_file\_name( $file['name'] ), PATHINFO\_EXTENSION ) ); |
  |  | 838 |  |
  |  | 839 | // Create file name |
  |  | 840 | $filename = wp\_basename( $file['name'] ); |
  |  | 841 | $filename = wpcf7\_canonicalize( $filename, 'as-is' ); |
  |  | 842 |  |
  |  | 843 | // Check unique name |
  |  | 844 | $filename = wp\_unique\_filename( $path['upload\_dir'], $filename ); |
  | 853 | 845 |  |
  | 854 | 846 | // Validate File Types |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L889) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L881) |  |
  | 889 | 881 | } |
  | 890 | 882 |  |
  | 891 |  | ~~// Create file name~~ |
  | 892 |  | ~~$filename = wp\_basename( $file['name'] );~~ |
  | 893 |  | ~~$filename = wpcf7\_canonicalize( $filename, 'as-is' );~~ |
  | 894 |  |  |
  | 895 | 883 | // Check if string is ascii then proceed with antiscript function ( remove or clean filename ) |
  | 896 | 884 | if( dnd\_cf7\_check\_ascii( $filename ) ){ |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L902) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L890) |  |
  | 902 | 890 |  |
  | 903 | 891 | // Generate new filename |
  | 904 |  | ~~$filename = wp\_unique\_filename( $path['upload\_dir'], $filename );~~ |
  | 905 | 892 | $new\_file = path\_join( $path['upload\_dir'], $filename ); |
  | 906 | 893 |  |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L965) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L952) |  |
  | 965 | 952 |  |
  | 966 | 953 | // Check valid filename & extensions |
  | 967 |  | if~~( preg\_match\_all('/wp-|(\.php|\.exe|\.js|\.phtml|\.cgi|\.aspx|\.asp|\.bat)/', $path )~~ ) { |
  | 968 |  | die('File not safe'); |
  | 969 |  | } |
  |  | 954 | if (preg\_match('/wp-|(\.php|\.exe|\.js|\.phtml|\.cgi|\.aspx|\.asp|\.bat)(?!\_\.txt$)/', $path)) { |
  |  | 955 | die('File not safe'); |
  |  | 956 | } |
  | 970 | 957 |  |
  | 971 | 958 | // Concatenate path and upload directory |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1051) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1038) |  |
  | 1051 | 1038 | function dnd\_upload\_admin\_settings( ) { |
  | 1052 | 1039 | echo '<div class="wrap">'; |
  | 1053 |  | echo '<h1>~~' . esc\_html\_\_( 'Drag & Drop Uploader - Settings', 'drag-and-drop-multiple-file-upload-contact-form-7' ) . '~~</h1>'; |
  |  | 1040 | echo '<h1>Drag & Drop Uploader - Settings</h1>'; |
  | 1054 | 1041 |  |
  | 1055 | 1042 | echo '<div class="update-nag notice" style="width: 98%;padding: 0px 10px;margin-bottom: 5px;">'; |
  | 1056 |  | echo '<p>~~' . sprintf(esc\_html\_\_( 'Checkout more features on %1$sPro Version%2$s', 'drag-and-drop-multiple-file-upload-contact-form-7' ),'<a href="https://codedropz.com/purchase-plugin/" target="\_blank">','</a>') . '~~</p>'; |
  |  | 1043 | echo '<p>Checkout more features on <a href="https://codedropz.com/purchase-plugin/" target="\_blank">Pro Version</a></p>'; |
  | 1057 | 1044 | echo '</div>'; |
  | 1058 | 1045 |  |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1070) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1057) |  |
  | 1070 | 1057 | <td><?php wp\_dropdown\_languages( array('name' => 'drag\_n\_drop\_lang', 'id' => 'drag\_n\_drop\_lang') ); ?> |
  | 1071 | 1058 | <div style="margin-top:20px;"> |
  | 1072 |  | <strong>~~<?php esc\_html\_e( 'Translated: ', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?></strong><a href=""><?php esc\_html\_e( 'abc', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~</a> |
  |  | 1059 | <strong>Translated: </strong><a href="">abc</a> |
  | 1073 | 1060 | </div> |
  | 1074 | 1061 | </td> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1103) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1090) |  |
  | 1103 | 1090 | <tr valign="top"> |
  | 1104 | 1091 | <th scope="row"><?php \_e('Drag & Drop Text','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
  | 1105 |  | <td><input type="text" name="drag\_n\_drop\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_text') ); ?>" placeholder="~~<?php esc\_attr\_e( 'Drag & Drop Files Here', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~" /></td> |
  |  | 1092 | <td><input type="text" name="drag\_n\_drop\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_text') ); ?>" placeholder="Drag & Drop Files Here" /></td> |
  | 1106 | 1093 | </tr> |
  | 1107 | 1094 | <tr valign="top"> |
  | 1108 | 1095 | <th scope="row"></th> |
  | 1109 |  | <td><input type="text" name="drag\_n\_drop\_separator" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_separator') ); ?>" placeholder="~~<?php esc\_attr\_e( 'or', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~" /></td> |
  |  | 1096 | <td><input type="text" name="drag\_n\_drop\_separator" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_separator') ); ?>" placeholder="or" /></td> |
  | 1110 | 1097 | </tr> |
  | 1111 | 1098 | <tr valign="top"> |
  | 1112 | 1099 | <th scope="row"><?php \_e('Browse Text','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
  | 1113 |  | <td><input type="text" name="drag\_n\_drop\_browse\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_browse\_text') ); ?>" placeholder="~~<?php esc\_attr\_e( 'Browse Files', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~" /></td> |
  |  | 1100 | <td><input type="text" name="drag\_n\_drop\_browse\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_browse\_text') ); ?>" placeholder="Browse Files" /></td> |
  | 1114 | 1101 | </tr> |
  | 1115 | 1102 | </table> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1136) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1123) |  |
  | 1136 | 1123 | <tr valign="top"> |
  | 1137 | 1124 | <th scope="row"><?php \_e('Max File Limit','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
  | 1138 |  | <td><input type="text" name="drag\_n\_drop\_error\_max\_file" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_max\_file') ); ?>" placeholder="" /><p class="description">~~<?php esc\_html\_e( 'Example: `Note : Some of the files are not uploaded ( Only %count% files allowed )`', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~</p></td> |
  |  | 1125 | <td><input type="text" name="drag\_n\_drop\_error\_max\_file" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_max\_file') ); ?>" placeholder="" /><p class="description">Example: `Note : Some of the files are not uploaded ( Only %count% files allowed )`</p></td> |
  | 1139 | 1126 | </tr> |
  | 1140 | 1127 | <tr valign="top"> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1149) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1136) |  |
  | 1149 | 1136 | <tr valign="top"> |
  | 1150 | 1137 | <th scope="row"><?php \_e('Don\'t delete files','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
  | 1151 |  | <td><input type="checkbox" name="drag\_n\_drop\_disable\_auto\_delete" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_auto\_delete')); ?>>~~<?php esc\_html\_e( ' Yes ', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?><br><p class="description"><em><?php esc\_html\_e( 'The default will automatically delete files 1-2 hours after submissions, if you want to keep files check "Yes" above.', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~</em></p></td> |
  |  | 1138 | <td><input type="checkbox" name="drag\_n\_drop\_disable\_auto\_delete" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_auto\_delete')); ?>> Yes <br><p class="description"><em>The default will automatically delete files 1-2 hours after submissions, if you want to keep files check "Yes" above.</em></p></td> |
  | 1152 | 1139 | </tr> |
  | 1153 | 1140 | </table> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1158) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1145) |  |
  | 1158 | 1145 | <tr valign="top"> |
  | 1159 | 1146 | <th scope="row"><?php \_e('Fix Spam','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
  | 1160 |  | <td><input type="checkbox" name="drag\_n\_drop\_fix\_spam" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_fix\_spam')); ?>>~~<?php esc\_html\_e( ' Yes ', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?><p class="description"><em><?php esc\_html\_e( 'If a “spam” answer is the response, Contact Form 7 will suspend the email and show a message saying, “There was an error trying to send your message", force to send message by checking this option.', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~</em></p></td> |
  |  | 1147 | <td><input type="checkbox" name="drag\_n\_drop\_fix\_spam" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_fix\_spam')); ?>> Yes <p class="description"><em>If a “spam” answer is the response, Contact Form 7 will suspend the email and show a message saying, “There was an error trying to send your message", force to send message by checking this option..</em></p></td> |
  | 1161 | 1148 | </tr> |
  | 1162 | 1149 | </table> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1167) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1154) |  |
  | 1167 | 1154 | <tr valign="top"> |
  | 1168 | 1155 | <th scope="row"><?php \_e('Enable jQuery','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
  | 1169 |  | <td><input type="checkbox" name="drag\_n\_drop\_use\_jquery" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_use\_jquery')); ?>>~~<?php esc\_html\_e( ' Yes ', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?><p class="description"><em><?php esc\_html\_e( 'Activate this option in case there are any problems with our plugin when utilizing native Javascript.', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~</em></p></td> |
  |  | 1156 | <td><input type="checkbox" name="drag\_n\_drop\_use\_jquery" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_use\_jquery')); ?>> Yes <p class="description"><em>Activate this option in case there are any problems with our plugin when utilizing native Javascript.</em></p></td> |
  | 1170 | 1157 | </tr> |
  | 1171 | 1158 | </table> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1176) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1163) |  |
  | 1176 | 1163 | <tr valign="top"> |
  | 1177 | 1164 | <th scope="row"><?php \_e('Disable Submit button','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
  | 1178 |  | <td><input type="checkbox" name="drag\_n\_drop\_disable\_btn" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_btn')); ?>>~~<?php esc\_html\_e( ' Yes ', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?><p class="description"><?php esc\_html\_e( 'Disable submit button if there\'s an error.', 'drag-and-drop-multiple-file-upload-contact-form-7' ); ?>~~</p></td> |
  |  | 1165 | <td><input type="checkbox" name="drag\_n\_drop\_disable\_btn" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_btn')); ?>> Yes <p class="description">Disable submit button if there's an error.</p></td> |
  | 1179 | 1166 | </tr> |
  | 1180 | 1167 | </table> |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2968538#L1237) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/inc/dnd-upload-cf7.php?rev=2987252#L1224) |  |
  | 1237 | 1224 | function dnd\_custom\_plugin\_row\_meta( $links, $file ) { |
  | 1238 | 1225 | if ( strpos( $file, 'drag-n-drop-upload-cf7.php' ) !== false ) { |
  | 1239 |  | $new\_links = array('pro-version' => '<a href="https://codedropz.com/purchase-plugin/" target="\_blank" style="font-weight:bold; color:#f4a647;">~~' . esc\_html\_\_( 'Pro Version', 'drag-and-drop-multiple-file-upload-contact-form-7' ) . '~~</a>'); |
  |  | 1226 | $new\_links = array('pro-version' => '<a href="https://codedropz.com/purchase-plugin/" target="\_blank" style="font-weight:bold; color:#f4a647;">Pro Version</a>'); |
  | 1240 | 1227 | $links = array\_merge( $links, $new\_links ); |
  | 1241 | 1228 | } |
* ## [drag-and-drop-multiple-file-upload-contact-form-7/trunk/readme.txt](/changeset/2987252/drag-and-drop-multiple-file-upload-contact-form-7/trunk/readme.txt?old=2968538&old_path=drag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk%2Freadme.txt "Show the [2968538:2987252] differences restricted to drag-and-drop-multiple-file-upload-contact-form-7/trunk/readme.txt")

  | [r2968538](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/readme.txt?rev=2968538#L5 "Show revision 2968538 of this file in browser") | [r2987252](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/readme.txt?rev=2987252#L5 "Show revision 2987252 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Requires at least: 3.0.1 |
  | 6 | 6 | Tested up to: 6.3 |
  | 7 |  | Stable tag: 1.3.7.~~3~~ |
  |  | 7 | Stable tag: 1.3.7.4 |
  | 8 | 8 | Requires PHP: 5.2.4 |
  | 9 | 9 | License: GPLv2 or later |
  | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/readme.txt?rev=2968538#L157) | […](/browser/drag-and-drop-multiple-file-upload-contact-form-7/trunk/readme.txt?rev=2987252#L157) |  |
  | 157 | 157 | == Changelog == |
  | 158 | 158 |  |
  |  | 159 | = 1.3.7.4 = |
  |  | 160 | - Fixes - Security Updates "Unauthenticated Arbitrary File Upload" (Thanks to @István from Wordfence) |
  |  | 161 |  |
  | 159 | 162 | = 1.3.7.3 = |
  | 160 | 163 | - New - Added Chinese (Taiwan) Translation (Thanks to: Alex Lion) |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2987252&old=2968538&new_path=%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk&old_path=%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk)
* [Zip Archive](?format=zip&new=2987252&old=2968538&new_path=%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk&old_path=%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_51ba6a26_20250114_191427.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Ftags%2F1.3.7.2%2Finc%2Fdnd-upload-cf7.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php)

---

# [source:](/browser?order=name "Go to repository root") [drag-and-drop-multiple-file-upload-contact-form-7](/browser/drag-and-drop-multiple-file-upload-contact-form-7?order=name "View drag-and-drop-multiple-file-upload-contact-form-7")/[tags](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags?order=name "View tags")/[1.3.7.2](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2?order=name "View 1.3.7.2")/[inc](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc?order=name "View inc")/[dnd-upload-cf7.php](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?order=name "View dnd-upload-cf7.php")

View diff against:

View revision:

| [Last change](/changeset/2968538/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php "View differences") on this file was [2968538](/changeset/2968538/ "View changeset 2968538"), checked in by glenwpcoder, [16 months ago](/timeline?from=2023-09-19T04%3A40%3A32Z&precision=second "See timeline at 09/19/2023 04:40:32 AM") |
| --- |
| * Released version 1.3.7.3 |
| **File size:** 51.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* @Description : Plugin main core |
| [5](#L5) | \* @Package : Drag & Drop Multiple File Upload - Contact Form 7 |
| [6](#L6) | \* @Author : Glen Don L. Mongaya |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | if ( ! defined( 'ABSPATH' ) || ! defined('dnd\_upload\_cf7') ) { |
| [10](#L10) | exit; |
| [11](#L11) | } |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* Begin : begin plugin hooks |
| [15](#L15) | \*/ |
| [16](#L16) |  |
| [17](#L17) | add\_action( 'wpcf7\_init', 'dnd\_cf7\_upload\_add\_form\_tag\_file' ); |
| [18](#L18) | add\_action( 'wpcf7\_enqueue\_scripts', 'dnd\_cf7\_scripts' ); |
| [19](#L19) |  |
| [20](#L20) | // Hook on plugins loaded |
| [21](#L21) | add\_action('plugins\_loaded','dnd\_cf7\_upload\_plugins\_loaded'); |
| [22](#L22) |  |
| [23](#L23) | // Ajax Upload |
| [24](#L24) | add\_action( 'wp\_ajax\_dnd\_codedropz\_upload', 'dnd\_upload\_cf7\_upload' ); |
| [25](#L25) | add\_action( 'wp\_ajax\_nopriv\_dnd\_codedropz\_upload', 'dnd\_upload\_cf7\_upload' ); |
| [26](#L26) |  |
| [27](#L27) | // Hook - Ajax Delete |
| [28](#L28) | add\_action('wp\_ajax\_nopriv\_dnd\_codedropz\_upload\_delete', 'dnd\_codedropz\_upload\_delete'); |
| [29](#L29) | add\_action('wp\_ajax\_dnd\_codedropz\_upload\_delete','dnd\_codedropz\_upload\_delete'); |
| [30](#L30) |  |
| [31](#L31) | // Ajax Nonce check |
| [32](#L32) | add\_action('wp\_ajax\_\_wpcf7\_check\_nonce', 'dnd\_wpcf7\_nonce\_check'); |
| [33](#L33) | add\_action('wp\_ajax\_nopriv\_\_wpcf7\_check\_nonce', 'dnd\_wpcf7\_nonce\_check'); |
| [34](#L34) |  |
| [35](#L35) | // Hook mail cf7 |
| [36](#L36) | add\_filter('wpcf7\_posted\_data', 'dnd\_wpcf7\_posted\_data', 10, 1); |
| [37](#L37) | add\_action('wpcf7\_before\_send\_mail','dnd\_cf7\_before\_send\_mail', 30, 1); |
| [38](#L38) | add\_action('wpcf7\_mail\_components','dnd\_cf7\_mail\_components', 50, 2); |
| [39](#L39) |  |
| [40](#L40) | // Auto clean up dir/files |
| [41](#L41) | add\_action('template\_redirect', 'dnd\_cf7\_auto\_clean\_dir', 20, 0 ); |
| [42](#L42) |  |
| [43](#L43) | // Add row meta links |
| [44](#L44) | add\_filter( 'plugin\_row\_meta', 'dnd\_custom\_plugin\_row\_meta', 10, 2 ); |
| [45](#L45) |  |
| [46](#L46) | // Add custom mime-type |
| [47](#L47) | add\_filter('upload\_mimes', 'dnd\_extra\_mime\_types', 1, 1); |
| [48](#L48) |  |
| [49](#L49) | // Plugin settings |
| [50](#L50) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( dnd\_upload\_cf7\_directory ) .'/drag-n-drop-upload-cf7.php', 'dnd\_cf7\_upload\_links' ); |
| [51](#L51) |  |
| [52](#L52) | // Add Submenu - Settings |
| [53](#L53) | add\_action('admin\_menu', 'dnd\_admin\_settings'); |
| [54](#L54) |  |
| [55](#L55) | // Add custom script in footer |
| [56](#L56) | add\_action('wp\_footer','dnd\_custom\_scripts'); |
| [57](#L57) | add\_action('wp\_footer','dnd\_custom\_style'); |
| [58](#L58) |  |
| [59](#L59) | // Flamingo Hooks |
| [60](#L60) | add\_action('before\_delete\_post', 'dnd\_remove\_uploaded\_files'); |
| [61](#L61) |  |
| [62](#L62) | // Nonce |
| [63](#L63) | function dnd\_wpcf7\_nonce\_check(){ |
| [64](#L64) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', false, false ) ){ |
| [65](#L65) | wp\_send\_json\_success( wp\_create\_nonce( "dnd-cf7-security-nonce" ) ); |
| [66](#L66) | } |
| [67](#L67) | } |
| [68](#L68) |  |
| [69](#L69) | // Add links to settings |
| [70](#L70) | function dnd\_cf7\_upload\_links( $actions ) { |
| [71](#L71) | $upload\_links = array('<a href="' . admin\_url( 'admin.php?page=drag-n-drop-upload' ) . '">Settings</a>',); |
| [72](#L72) | $actions = array\_merge( $upload\_links, $actions ); |
| [73](#L73) | return $actions; |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | // Load plugin text-domain |
| [77](#L77) | function dnd\_cf7\_upload\_plugins\_loaded() { |
| [78](#L78) |  |
| [79](#L79) | // Load language domain |
| [80](#L80) | load\_plugin\_textdomain( 'drag-and-drop-multiple-file-upload-contact-form-7', false, dirname( dirname( plugin\_basename( \_\_FILE\_\_ ) ) ) . '/languages' ); |
| [81](#L81) |  |
| [82](#L82) | // Create dir |
| [83](#L83) | $dir = dnd\_get\_upload\_dir(); |
| [84](#L84) | if( isset( $dir['upload\_dir'] ) && is\_dir( $dir['upload\_dir'] ) ) { |
| [85](#L85) | // Generate .htaccess file` |
| [86](#L86) | $htaccess\_file = path\_join( dirname( $dir['upload\_dir'] ), '.htaccess' ); |
| [87](#L87) | if ( ! file\_exists( $htaccess\_file ) ) { |
| [88](#L88) | if ( $handle = fopen( $htaccess\_file, 'w' ) ) { |
| [89](#L89) | fwrite( $handle, "Options -Indexes \n <Files \*.php> \n deny from all \n </Files>" ); |
| [90](#L90) | fclose( $handle ); |
| [91](#L91) | } |
| [92](#L92) | } |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | // fix spam |
| [96](#L96) | if( get\_option('drag\_n\_drop\_fix\_spam') == 'yes' ) { |
| [97](#L97) | add\_filter('wpcf7\_spam', function(){ |
| [98](#L98) | return false; |
| [99](#L99) | }); |
| [100](#L100) | } |
| [101](#L101) | } |
| [102](#L102) |  |
| [103](#L103) | // Remove uploaded files when item is deleted permanently. |
| [104](#L104) | function dnd\_remove\_uploaded\_files( $post\_id ) { |
| [105](#L105) | $post\_type = get\_post\_type( $post\_id ); |
| [106](#L106) | $page = get\_post( $post\_id ); |
| [107](#L107) | if( $post\_type == 'flamingo\_inbound' ) { |
| [108](#L108) | preg\_match\_all( '/(.\*?)(\/'.wpcf7\_dnd\_dir.'\/wpcf7-files\/.\*$)/m', $page->post\_content, $matches ); |
| [109](#L109) | if( $matches[0] && count( $matches[0] ) > 0 ) { |
| [110](#L110) | foreach( $matches[0] as $files ) { |
| [111](#L111) | $new\_file = str\_replace( site\_url().'/', wp\_normalize\_path( ABSPATH ), $files ); |
| [112](#L112) | if( file\_exists( $new\_file ) ) { |
| [113](#L113) | wp\_delete\_file( $new\_file ); |
| [114](#L114) | } |
| [115](#L115) | } |
| [116](#L116) | } |
| [117](#L117) | } |
| [118](#L118) | } |
| [119](#L119) |  |
| [120](#L120) | // Modify contact form posted\_data |
| [121](#L121) | function dnd\_wpcf7\_posted\_data( $posted\_data ){ |
| [122](#L122) |  |
| [123](#L123) | // Subbmisson instance from CF7 |
| [124](#L124) | $submission = WPCF7\_Submission::get\_instance(); |
| [125](#L125) |  |
| [126](#L126) | // Make sure we have the data |
| [127](#L127) | if ( ! $posted\_data ) { |
| [128](#L128) | $posted\_data = $submission->get\_posted\_data(); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | // Scan and get all form tags from cf7 generator |
| [132](#L132) | $forms\_tags = $submission->get\_contact\_form(); |
| [133](#L133) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [134](#L134) |  |
| [135](#L135) | if( $forms = $forms\_tags->scan\_form\_tags() ) { |
| [136](#L136) | foreach( $forms as $field ) { |
| [137](#L137) | $field\_name = $field->name; |
| [138](#L138) | if( $field->basetype == 'mfile' && isset( $posted\_data[$field\_name] ) && ! empty( $posted\_data[$field\_name] ) ) { |
| [139](#L139) | foreach( $posted\_data[$field\_name] as $key => $file ) { |
| [140](#L140) | $posted\_data[$field\_name][$key] = trailingslashit( $uploads\_dir['upload\_url'] ) . wp\_basename( $file ); |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | return $posted\_data; |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | // Hooks for admin settings |
| [150](#L150) | function dnd\_admin\_settings() { |
| [151](#L151) | add\_submenu\_page( 'wpcf7', 'Drag & Drop Uploader - Settings', 'Drag & Drop Upload', 'manage\_options', 'drag-n-drop-upload','dnd\_upload\_admin\_settings'); |
| [152](#L152) | add\_action('admin\_init','dnd\_upload\_register\_settings'); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | // Add custom mime-types |
| [156](#L156) | function dnd\_extra\_mime\_types( $mime\_types ){ |
| [157](#L157) | $mime\_types['xls'] = 'application/excel, application/vnd.ms-excel, application/x-excel, application/x-msexcel'; |
| [158](#L158) | $mime\_types['xlsx'] = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'; |
| [159](#L159) | return $mime\_types; |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) | // Default Error Message |
| [163](#L163) | function dnd\_cf7\_error\_msg( $error\_key ) { |
| [164](#L164) |  |
| [165](#L165) | // Array of default error message |
| [166](#L166) | $errors = array( |
| [167](#L167) | 'server\_limit'          =>      \_\_('The uploaded file exceeds the maximum upload size of your server.','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [168](#L168) | 'failed\_upload'         =>      \_\_('Uploading a file fails for any reason','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [169](#L169) | 'large\_file'            =>      \_\_('Uploaded file is too large','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [170](#L170) | 'invalid\_type'          =>      \_\_('Uploaded file is not allowed for file type','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [171](#L171) | 'max\_file\_limit'        =>      \_\_('Note : Some of the files are not uploaded ( Only %count% files allowed )','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [172](#L172) | 'required'                      =>      \_\_('This field is required.', 'drag-and-drop-multiple-file-upload-contact-form-7' ), |
| [173](#L173) | 'min\_file'                      =>      \_\_('The minimum file upload is','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [174](#L174) | ); |
| [175](#L175) |  |
| [176](#L176) | // return error message based on $error\_key request |
| [177](#L177) | if( isset( $errors[ $error\_key ] ) ) { |
| [178](#L178) | return $errors[ $error\_key ]; |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) | return false; |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | // Get folder path |
| [185](#L185) | function dnd\_get\_upload\_dir() { |
| [186](#L186) | $upload = wp\_upload\_dir(); |
| [187](#L187) | $uploads\_dir = wpcf7\_dnd\_dir . '/wpcf7-files'; |
| [188](#L188) |  |
| [189](#L189) | // If save as attachment ( also : Check if upload use year and month folders ) |
| [190](#L190) | if( get\_option('drag\_n\_drop\_mail\_attachment') == 'yes' ) { |
| [191](#L191) | $uploads\_dir = ( get\_option('uploads\_use\_yearmonth\_folders') ? wpcf7\_dnd\_dir . $upload['subdir'] : wpcf7\_dnd\_dir ); |
| [192](#L192) | } |
| [193](#L193) |  |
| [194](#L194) | // Create directory |
| [195](#L195) | if ( ! is\_dir( trailingslashit( $upload['basedir'] ) . $uploads\_dir ) ) { |
| [196](#L196) | wp\_mkdir\_p( trailingslashit( $upload['basedir'] ) . $uploads\_dir ); |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | // Make sure directory exist before returning |
| [200](#L200) | if( file\_exists( trailingslashit( $upload['basedir'] ) . $uploads\_dir ) ) { |
| [201](#L201) | return array( |
| [202](#L202) | 'upload\_dir'    =>      trailingslashit( $upload['basedir'] ) . $uploads\_dir, |
| [203](#L203) | 'upload\_url'    =>      trailingslashit( $upload['baseurl'] ) . $uploads\_dir |
| [204](#L204) | ); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | return trailingslashit( $upload['basedir'] ) . $uploads\_dir; |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | // Clean up directory - From Contact Form 7 |
| [211](#L211) | function dnd\_cf7\_auto\_clean\_dir( $seconds = 3600, $max = 60 ) { |
| [212](#L212) | if ( is\_admin() || 'GET' != $\_SERVER['REQUEST\_METHOD'] || is\_robots() || is\_feed() || is\_trackback() ) { |
| [213](#L213) | return; |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | // Disable auto delete |
| [217](#L217) | if( get\_option('drag\_n\_drop\_disable\_auto\_delete') == 'yes' ) { |
| [218](#L218) | return; |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | // Setup dirctory path |
| [222](#L222) | $upload = wp\_upload\_dir(); |
| [223](#L223) | $dir = trailingslashit( $upload['basedir'] ) . wpcf7\_dnd\_dir . '/wpcf7-files/'; |
| [224](#L224) |  |
| [225](#L225) | // Make sure dir is readable or writable |
| [226](#L226) | if ( ! is\_dir( $dir ) || ! is\_readable( $dir ) || ! wp\_is\_writable( $dir ) ) { |
| [227](#L227) | return; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | $seconds = apply\_filters( 'dnd\_cf7\_auto\_delete\_files', $seconds ); |
| [231](#L231) | $max = absint( $max ); |
| [232](#L232) | $count = 0; |
| [233](#L233) |  |
| [234](#L234) | if ( $handle = @opendir( $dir ) ) { |
| [235](#L235) | while ( false !== ( $file = readdir( $handle ) ) ) { |
| [236](#L236) | if ( $file == "." || $file == ".." ) { |
| [237](#L237) | continue; |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | // Get file time of files OLD files. |
| [241](#L241) | $mtime = @filemtime( $dir . $file ); |
| [242](#L242) |  |
| [243](#L243) | if ( $mtime && time() < $mtime + absint( $seconds ) ) { // less than $seconds old |
| [244](#L244) | continue; |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | // Delete files from dir |
| [248](#L248) | if( $file != '.htaccess' ) { |
| [249](#L249) | wp\_delete\_file( $dir . $file ); |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) | $count += 1; |
| [253](#L253) |  |
| [254](#L254) | if ( $max <= $count ) { |
| [255](#L255) | break; |
| [256](#L256) | } |
| [257](#L257) | } |
| [258](#L258) | @closedir( $handle ); |
| [259](#L259) | } |
| [260](#L260) | @rmdir( $dir ); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | // Hooks before sending the email - ( append links to body email ) |
| [264](#L264) | function dnd\_cf7\_before\_send\_mail( $wpcf7 ){ |
| [265](#L265) | global $\_mail; |
| [266](#L266) |  |
| [267](#L267) | // Get upload path / dir |
| [268](#L268) | $upload\_path = dnd\_get\_upload\_dir(); |
| [269](#L269) |  |
| [270](#L270) | // Mail Counter |
| [271](#L271) | $\_mail = 0; |
| [272](#L272) |  |
| [273](#L273) | // Check If send attachment as link |
| [274](#L274) | if( ! get\_option('drag\_n\_drop\_mail\_attachment') ) { |
| [275](#L275) | return $wpcf7; |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | // cf7 instance |
| [279](#L279) | $submission = WPCF7\_Submission::get\_instance(); |
| [280](#L280) |  |
| [281](#L281) | // Check for submission |
| [282](#L282) | if( $submission ) { |
| [283](#L283) |  |
| [284](#L284) | // Get posted data |
| [285](#L285) | $submitted['posted\_data'] = $submission->get\_posted\_data(); |
| [286](#L286) |  |
| [287](#L287) | // Parse fields |
| [288](#L288) | $fields = $wpcf7->scan\_form\_tags(); |
| [289](#L289) |  |
| [290](#L290) | // Links |
| [291](#L291) | $links = array(); |
| [292](#L292) |  |
| [293](#L293) | // Prop email |
| [294](#L294) | $mail = $wpcf7->prop('mail'); |
| [295](#L295) | $mail\_2 = $wpcf7->prop('mail\_2'); |
| [296](#L296) |  |
| [297](#L297) | // Default upload path |
| [298](#L298) | $simple\_path = dirname( $upload\_path['upload\_url'] ); // dirname - remove duplicate form dir (/wpcf-dnd-uploads/wpcf7-dnd-uploads/example.jpg) |
| [299](#L299) |  |
| [300](#L300) | // Loop fields and replace mfile code |
| [301](#L301) | foreach( $fields as $field ) { |
| [302](#L302) | if( $field->basetype == 'mfile') { |
| [303](#L303) | if( isset( $submitted['posted\_data'][$field->name] ) && ! empty( $submitted['posted\_data'][$field->name] ) ) { |
| [304](#L304) |  |
| [305](#L305) | // Get posted\_data files |
| [306](#L306) | $files = $submitted['posted\_data'][$field->name]; |
| [307](#L307) |  |
| [308](#L308) | // Links - 1 |
| [309](#L309) | $mail\_links = dnd\_cf7\_links( $files, $mail['use\_html'] ); |
| [310](#L310) | $mail['body'] = str\_replace( "[$field->name]", "\n" . implode( "\n", $mail\_links ), $mail['body'] ); |
| [311](#L311) |  |
| [312](#L312) | // Links - 2 |
| [313](#L313) | if( $mail\_2['active'] ) { |
| [314](#L314) | $mail\_links\_2 = dnd\_cf7\_links( $files, $mail\_2['use\_html'] ); |
| [315](#L315) | $mail\_2['body'] = str\_replace( "[$field->name]", "\n" . implode( "\n", $mail\_links\_2 ), $mail\_2['body'] ); |
| [316](#L316) | } |
| [317](#L317) | } |
| [318](#L318) | } |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | // For debug |
| [322](#L322) | if( defined('dnd\_cf7\_debug') ){ |
| [323](#L323) | print\_r($mail); |
| [324](#L324) | print\_r($mail\_2); |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | // Save the email body |
| [328](#L328) | $wpcf7->set\_properties( array("mail" => $mail) ); |
| [329](#L329) |  |
| [330](#L330) | // if mail 2 |
| [331](#L331) | if( $mail\_2['active'] ) { |
| [332](#L332) | $wpcf7->set\_properties( array("mail\_2" => $mail\_2) ); |
| [333](#L333) | } |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | return $wpcf7; |
| [337](#L337) | } |
| [338](#L338) |  |
| [339](#L339) | // Get file links. |
| [340](#L340) | function dnd\_cf7\_links( $files, $use\_html = false) { |
| [341](#L341) |  |
| [342](#L342) | // check and make sure we have files |
| [343](#L343) | if( ! $files ) { |
| [344](#L344) | return; |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | // Setup html links |
| [348](#L348) | $links = array(); |
| [349](#L349) | foreach( $files as $file ) { |
| [350](#L350) | $links[] = ( $use\_html ? '<a href="'. esc\_url( $file ) .'">'. wp\_basename( $file ) .'</a>' : $file ); |
| [351](#L351) | } |
| [352](#L352) |  |
| [353](#L353) | // Allow other themes/plugin to modify data. |
| [354](#L354) | return apply\_filters('dndcf7\_before\_send\_files', $links, $files ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | // Log message... |
| [358](#L358) | function dnd\_logs( $message, $email = false ) { |
| [359](#L359) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [360](#L360) | $file = fopen( $uploads\_dir['upload\_dir']."/logs.txt", "a") or die("Unable to open file!"); |
| [361](#L361) | fwrite( $file, "\n". ( is\_array( $message ) ? print\_r( $message, true ) : $message ) ); |
| [362](#L362) | fclose( $file ); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | // hooks - Custom cf7 Mail components ( Attached File on Email ) |
| [366](#L366) | function dnd\_cf7\_mail\_components( $components, $form ) { |
| [367](#L367) | global $\_mail; |
| [368](#L368) |  |
| [369](#L369) | if( ! $form ) { |
| [370](#L370) | return; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | // Get upload directory |
| [374](#L374) | $uploads\_dir = dnd\_get\_upload\_dir(); |
| [375](#L375) |  |
| [376](#L376) | // cf7 - Submission Object |
| [377](#L377) | $submission = WPCF7\_Submission::get\_instance(); |
| [378](#L378) |  |
| [379](#L379) | // get all form fields |
| [380](#L380) | $fields = $form->scan\_form\_tags(); |
| [381](#L381) |  |
| [382](#L382) | // Send email link as an attachment. |
| [383](#L383) | if( get\_option('drag\_n\_drop\_mail\_attachment') == 'yes' ) { |
| [384](#L384) | return $components; |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | // Get mail,mail\_2 attachment [tags] |
| [388](#L388) | $mail = array('mail','mail\_2'); |
| [389](#L389) | $props\_mail = array(); |
| [390](#L390) |  |
| [391](#L391) | foreach( $mail as $single\_mail ) { |
| [392](#L392) | $props\_mail[] = $form->prop( $single\_mail ); |
| [393](#L393) | } |
| [394](#L394) |  |
| [395](#L395) | // Get email attachments (mail, mail\_2) |
| [396](#L396) | $mail = $props\_mail[ $\_mail ]; |
| [397](#L397) | if( $mail['active'] && $mail['attachments'] ) { |
| [398](#L398) |  |
| [399](#L399) | // Loop fields get mfile only. |
| [400](#L400) | foreach( $fields as $field ) { |
| [401](#L401) |  |
| [402](#L402) | // If field type equal to mfile which our default field. |
| [403](#L403) | if( $field->basetype == 'mfile') { |
| [404](#L404) |  |
| [405](#L405) | // Make sure we have files to attach |
| [406](#L406) | if( isset( $\_POST[ $field->name ] ) && count( $\_POST[ $field->name ] ) > 0 ) { |
| [407](#L407) |  |
| [408](#L408) | // Check and make sure [upload-file-xxx] exists in attachments - fields |
| [409](#L409) | if ( false !== strpos( $mail['attachments'], "[{$field->name}]" ) ) { |
| [410](#L410) |  |
| [411](#L411) | // Loop all the files and attach to cf7 components |
| [412](#L412) | foreach( $\_POST[ $field->name ] as $\_file ) { |
| [413](#L413) |  |
| [414](#L414) | // Join dir and a new file name ( get from <input type="hidden" name="upload-file-333"> ) |
| [415](#L415) | $new\_file\_name = trailingslashit( $uploads\_dir['upload\_dir'] ) . wp\_basename( $\_file ); |
| [416](#L416) |  |
| [417](#L417) | // Check if submitted and file exists then file is ready. |
| [418](#L418) | if ( $submission && file\_exists( $new\_file\_name )  ) { |
| [419](#L419) | $components['attachments'][] = $new\_file\_name; |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | } |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | // Debug |
| [431](#L431) | if( defined('dnd\_cf7\_debug') ){ |
| [432](#L432) | print\_r($components); |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | // Increment mail counter |
| [436](#L436) | $\_mail = $\_mail + 1; |
| [437](#L437) |  |
| [438](#L438) | // Return setup components |
| [439](#L439) | return $components; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | // Load js and css |
| [443](#L443) | function dnd\_cf7\_scripts() { |
| [444](#L444) |  |
| [445](#L445) | // Get plugin version |
| [446](#L446) | $version = dnd\_upload\_cf7\_version; |
| [447](#L447) |  |
| [448](#L448) | // enque script (Use native Javascript or jQuery) |
| [449](#L449) | if( get\_option('drag\_n\_drop\_use\_jquery') == 'yes' ){ |
| [450](#L450) | wp\_enqueue\_script( 'codedropz-uploader', plugins\_url ('/assets/js/codedropz-uploader-jquery.js', dirname(\_\_FILE\_\_) ), array('jquery','contact-form-7'), $version, true ); |
| [451](#L451) | }else{ |
| [452](#L452) | wp\_enqueue\_script( 'codedropz-uploader', plugins\_url ('/assets/js/codedropz-uploader-min.js', dirname(\_\_FILE\_\_) ), '', $version, true ); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | // All data options |
| [456](#L456) | $data\_options = apply\_filters('dnd\_cf7\_data\_options', |
| [457](#L457) | array( |
| [458](#L458) | 'tag'                           =>      ( get\_option('drag\_n\_drop\_heading\_tag') ? get\_option('drag\_n\_drop\_heading\_tag') : 'h3' ), |
| [459](#L459) | 'text'                          =>      ( get\_option('drag\_n\_drop\_text') ? get\_option('drag\_n\_drop\_text') : \_\_('Drag & Drop Files Here','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [460](#L460) | 'or\_separator'          =>      ( get\_option('drag\_n\_drop\_separator') ? get\_option('drag\_n\_drop\_separator') : \_\_('or','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [461](#L461) | 'browse'                        =>      ( get\_option('drag\_n\_drop\_browse\_text') ? get\_option('drag\_n\_drop\_browse\_text') : \_\_('Browse Files','drag-and-drop-multiple-file-upload-contact-form-7') ), |
| [462](#L462) | 'server\_max\_error'      =>      ( get\_option('drag\_n\_drop\_error\_server\_limit') ? get\_option('drag\_n\_drop\_error\_server\_limit') : dnd\_cf7\_error\_msg('server\_limit') ), |
| [463](#L463) | 'large\_file'            =>      ( get\_option('drag\_n\_drop\_error\_files\_too\_large') ? get\_option('drag\_n\_drop\_error\_files\_too\_large') : dnd\_cf7\_error\_msg('large\_file') ), |
| [464](#L464) | 'inavalid\_type'         =>      ( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ), |
| [465](#L465) | 'max\_file\_limit'        =>      ( get\_option('drag\_n\_drop\_error\_max\_file') ? get\_option('drag\_n\_drop\_error\_max\_file') : dnd\_cf7\_error\_msg('max\_file\_limit') ), |
| [466](#L466) | 'required'                      =>      dnd\_cf7\_error\_msg('required'), |
| [467](#L467) | 'delete'                        =>      array( |
| [468](#L468) | 'text'              =>      \_\_('deleting','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [469](#L469) | 'title'             =>      \_\_('Remove','drag-and-drop-multiple-file-upload-contact-form-7') |
| [470](#L470) | ) |
| [471](#L471) | ) |
| [472](#L472) | ); |
| [473](#L473) |  |
| [474](#L474) | //  registered script with data for a JavaScript variable. |
| [475](#L475) | wp\_localize\_script( 'codedropz-uploader', 'dnd\_cf7\_uploader', |
| [476](#L476) | array( |
| [477](#L477) | 'ajax\_url'                              =>      admin\_url( 'admin-ajax.php' ), |
| [478](#L478) | 'ajax\_nonce'                    =>      wp\_create\_nonce( "dnd-cf7-security-nonce" ), |
| [479](#L479) | 'drag\_n\_drop\_upload'    =>  $data\_options, |
| [480](#L480) | 'dnd\_text\_counter'      =>      \_\_('of','drag-and-drop-multiple-file-upload-contact-form-7'), |
| [481](#L481) | 'disable\_btn'           =>      ( get\_option('drag\_n\_drop\_disable\_btn') == 'yes' ? true : false ) |
| [482](#L482) | ) |
| [483](#L483) | ); |
| [484](#L484) |  |
| [485](#L485) | // enque style |
| [486](#L486) | //wp\_enqueue\_style( 'dnd-upload-cf7', plugins\_url ('/assets/css/dnd-upload-cf7.css', dirname(\_\_FILE\_\_) ), '', $version ); |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | // Generate tag |
| [490](#L490) | function dnd\_cf7\_upload\_add\_form\_tag\_file() { |
| [491](#L491) | wpcf7\_add\_form\_tag(     array( 'mfile ', 'mfile\*'), 'dnd\_cf7\_upload\_form\_tag\_handler', array( 'name-attr' => true ) ); |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | // Form tag handler from the tag - callback |
| [495](#L495) | function dnd\_cf7\_upload\_form\_tag\_handler( $tag ) { |
| [496](#L496) |  |
| [497](#L497) | // check and make sure tag name is not empty |
| [498](#L498) | if ( empty( $tag->name ) ) { |
| [499](#L499) | return ''; |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | // Validate our fields |
| [503](#L503) | $validation\_error = wpcf7\_get\_validation\_error( $tag->name ); |
| [504](#L504) |  |
| [505](#L505) | // Generate class |
| [506](#L506) | $class = wpcf7\_form\_controls\_class( 'drag-n-drop-file d-none' ); |
| [507](#L507) |  |
| [508](#L508) | // Add not-valid class if there's an error. |
| [509](#L509) | if ( $validation\_error ) { |
| [510](#L510) | $class .= ' wpcf7-not-valid'; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | // Get current form Object |
| [514](#L514) | $form = WPCF7\_ContactForm::get\_current(); |
| [515](#L515) |  |
| [516](#L516) | // Setup element attributes |
| [517](#L517) | $atts = array(); |
| [518](#L518) |  |
| [519](#L519) | $atts['size'] = $tag->get\_size\_option( '40' ); |
| [520](#L520) | $atts['class'] = $tag->get\_class\_option( $class ); |
| [521](#L521) | $atts['id'] = $tag->get\_id\_option(); |
| [522](#L522) | $atts['tabindex'] = $tag->get\_option( 'tabindex', 'signed\_int', true ); |
| [523](#L523) |  |
| [524](#L524) | // If file is required |
| [525](#L525) | if ( $tag->is\_required() ) { |
| [526](#L526) | $atts['aria-required'] = 'true'; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | // Set invalid attributes if there's validation error |
| [530](#L530) | $atts['aria-invalid'] = $validation\_error ? 'true' : 'false'; |
| [531](#L531) |  |
| [532](#L532) | // Set input type and name |
| [533](#L533) | $atts['type'] = 'file'; |
| [534](#L534) | $atts['multiple'] = 'multiple'; |
| [535](#L535) | $atts['data-name'] = $tag->name; |
| [536](#L536) | $atts['data-type'] = $tag->get\_option( 'filetypes','', true); |
| [537](#L537) | $atts['data-limit'] = $tag->get\_option( 'limit','', true); |
| [538](#L538) | $atts['data-min'] = $tag->get\_option( 'min-file', '', true ); |
| [539](#L539) | $atts['data-max'] = $tag->get\_option( 'max-file','', true); |
| [540](#L540) | $atts['data-id'] = ( $form ? $form->id() : 0 ); |
| [541](#L541) | $atts['data-version'] = 'free version '. dnd\_upload\_cf7\_version; |
| [542](#L542) |  |
| [543](#L543) | // Accept data attributes |
| [544](#L544) | $types = explode('|', $atts['data-type'] ); |
| [545](#L545) |  |
| [546](#L546) | if( $types && ! wp\_is\_mobile() ) { |
| [547](#L547) | $type = implode(', .', array\_map( 'trim', $types ) ); |
| [548](#L548) | if( $type != '\*' ) { |
| [549](#L549) | $atts['accept'] = '.' . $type; |
| [550](#L550) | } |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | // Allow blacklist |
| [554](#L554) | if( $tag->get\_option('blacklist-types', '', true) ){ |
| [555](#L555) | $atts['data-black-list'] = $tag->get\_option('blacklist-types', '', true); |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | // Combine and format attrbiutes |
| [559](#L559) | $atts = wpcf7\_format\_atts( $atts ); |
| [560](#L560) |  |
| [561](#L561) | // Return our element and attributes |
| [562](#L562) | return sprintf('<span class="wpcf7-form-control-wrap" data-name="%1$s"><input %2$s />%3$s</span>',      sanitize\_html\_class( $tag->name ), $atts, $validation\_error ); |
| [563](#L563) | } |
| [564](#L564) |  |
| [565](#L565) | // Encode type filter to support multipart since this is input type file |
| [566](#L566) | add\_filter( 'wpcf7\_form\_enctype', 'dnd\_upload\_cf7\_form\_enctype\_filter' ); |
| [567](#L567) |  |
| [568](#L568) | function dnd\_upload\_cf7\_form\_enctype\_filter( $enctype ) { |
| [569](#L569) | $multipart = (bool) wpcf7\_scan\_form\_tags( array( 'type' => array( 'drag\_drop\_file', 'drag\_drop\_file\*' ) ) ); |
| [570](#L570) |  |
| [571](#L571) | if ( $multipart ) { |
| [572](#L572) | $enctype = 'multipart/form-data'; |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | return $enctype; |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | // 3rd party compatability... |
| [579](#L579) | function dnd\_cf7\_conditional\_fields( $form\_id ) { |
| [580](#L580) |  |
| [581](#L581) | if( ! $form\_id ) { |
| [582](#L582) | return false; |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | // Get visible groups |
| [586](#L586) | $groups = array(); |
| [587](#L587) |  |
| [588](#L588) | // Get current form object |
| [589](#L589) | $cf7\_post = get\_post( $form\_id ); |
| [590](#L590) |  |
| [591](#L591) | // Extract group shortcode |
| [592](#L592) | $regex = get\_shortcode\_regex( array('group') ); |
| [593](#L593) |  |
| [594](#L594) | // Match pattern |
| [595](#L595) | preg\_match\_all( '/'. $regex .'/s', $cf7\_post->post\_content, $matches ); |
| [596](#L596) |  |
| [597](#L597) | if( array\_key\_exists( 3, $matches )) { |
| [598](#L598) | foreach( $matches[3] as $index => $group\_name ) { |
| [599](#L599) | $name = array\_filter( explode(" ", $group\_name ) ); |
| [600](#L600) | preg\_match('/\[mfile[\*|\s].\*?\]/', $matches[0][$index], $file\_matches ); |
| [601](#L601) | if( $file\_matches ) { |
| [602](#L602) | $field\_name = shortcode\_parse\_atts( $file\_matches[0] ); |
| [603](#L603) | $field\_name = preg\_replace( '/[^a-zA-Z0-9-\_]/','', $field\_name[1] ); |
| [604](#L604) | $groups[ $field\_name ] = $name[1]; |
| [605](#L605) | } |
| [606](#L606) | } |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | return $groups; |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | // Validation + upload handling filter |
| [613](#L613) | add\_filter( 'wpcf7\_validate\_mfile', 'dnd\_upload\_cf7\_validation\_filter', 10, 2 ); |
| [614](#L614) | add\_filter( 'wpcf7\_validate\_mfile\*', 'dnd\_upload\_cf7\_validation\_filter', 10, 2 ); |
| [615](#L615) |  |
| [616](#L616) | function dnd\_upload\_cf7\_validation\_filter( $result, $tag ) { |
| [617](#L617) | $name = $tag->name; |
| [618](#L618) | $id = $tag->get\_id\_option(); |
| [619](#L619) | $multiple\_files = ( ( isset( $\_POST[ $name ] ) && is\_countable( $\_POST[ $name ] ) && count( $\_POST[ $name ] ) > 0 ) ? $\_POST[ $name ] : null ); |
| [620](#L620) | $min\_file = $tag->get\_option( 'min-file','', true); |
| [621](#L621) |  |
| [622](#L622) | // Check minimum upload |
| [623](#L623) | if( $multiple\_files && count( $multiple\_files ) < (int) $min\_file ) { |
| [624](#L624) | $min\_file\_error = ( get\_option('drag\_n\_drop\_error\_min\_file') ? get\_option('drag\_n\_drop\_error\_min\_file') : dnd\_cf7\_error\_msg('min\_file') ); |
| [625](#L625) | $result->invalidate( $tag, $min\_file\_error .' '. (int)$min\_file ); |
| [626](#L626) | return $result; |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | // Cf7 Conditional Field |
| [630](#L630) | if( in\_array('cf7-conditional-fields/contact-form-7-conditional-fields.php', get\_option('active\_plugins') ) ){ |
| [631](#L631) |  |
| [632](#L632) | $hidden\_groups = json\_decode( stripslashes( $\_POST['\_wpcf7cf\_hidden\_groups'] ) ); |
| [633](#L633) | $form\_id = WPCF7\_ContactForm::get\_current()->id(); |
| [634](#L634) | $group\_fields = dnd\_cf7\_conditional\_fields( $form\_id ); |
| [635](#L635) |  |
| [636](#L636) | if( is\_null( $multiple\_files ) && $tag->is\_required() ) { |
| [637](#L637) | if( isset( $group\_fields[ $name ] ) && ! in\_array( $group\_fields[ $name ], $hidden\_groups ) ) { |
| [638](#L638) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [639](#L639) | }elseif( ! array\_key\_exists( $name, $group\_fields ) ) { |
| [640](#L640) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [641](#L641) | } |
| [642](#L642) | return $result; |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | return $result; |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | // Check if we have files or if it's empty |
| [649](#L649) | if( is\_null( $multiple\_files ) && $tag->is\_required() ) { |
| [650](#L650) | $result->invalidate( $tag, wpcf7\_get\_message( 'invalid\_required' ) ); |
| [651](#L651) | return $result; |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | return $result; |
| [655](#L655) | } |
| [656](#L656) |  |
| [657](#L657) | // Generate Admin From Tag |
| [658](#L658) | add\_action( 'wpcf7\_admin\_init', 'dnd\_upload\_cf7\_add\_tag\_generator', 50 ); |
| [659](#L659) |  |
| [660](#L660) | function dnd\_upload\_cf7\_add\_tag\_generator() { |
| [661](#L661) | $tag\_generator = WPCF7\_TagGenerator::get\_instance(); |
| [662](#L662) | $tag\_generator->add( 'upload-file', \_\_( 'multiple file upload', 'drag-and-drop-multiple-file-upload-contact-form-7' ),'dnd\_upload\_cf7\_tag\_generator\_file' ); |
| [663](#L663) | } |
| [664](#L664) |  |
| [665](#L665) | // Display form in admin |
| [666](#L666) | function dnd\_upload\_cf7\_tag\_generator\_file( $contact\_form, $args = '' ) { |
| [667](#L667) |  |
| [668](#L668) | // Parse data and get our options |
| [669](#L669) | $args = wp\_parse\_args( $args, array() ); |
| [670](#L670) |  |
| [671](#L671) | // Our multiple upload field |
| [672](#L672) | $type = 'mfile'; |
| [673](#L673) |  |
| [674](#L674) | $description = \_\_( "Generate a form-tag for a file uploading field. For more details, see %s.", 'contact-form-7' ); |
| [675](#L675) | $desc\_link = wpcf7\_link( \_\_( 'https://contactform7.com/file-uploading-and-attachment/', 'contact-form-7' ), \_\_( 'File Uploading and Attachment', 'contact-form-7' ) ); |
| [676](#L676) |  |
| [677](#L677) | ?> |
| [678](#L678) |  |
| [679](#L679) | <div class="control-box"> |
| [680](#L680) | <fieldset> |
| [681](#L681) | <legend><?php echo sprintf( esc\_html( $description ), $desc\_link ); ?></legend> |
| [682](#L682) | <table class="form-table"> |
| [683](#L683) | <tbody> |
| [684](#L684) | <tr> |
| [685](#L685) | <th scope="row"><?php echo esc\_html( \_\_( 'Field type', 'contact-form-7' ) ); ?></th> |
| [686](#L686) | <td> |
| [687](#L687) | <fieldset> |
| [688](#L688) | <legend class="screen-reader-text"><?php echo esc\_html( \_\_( 'Field type', 'contact-form-7' ) ); ?></legend> |
| [689](#L689) | <label><input type="checkbox" name="required" /> <?php echo esc\_html( \_\_( 'Required field', 'contact-form-7' ) ); ?></label> |
| [690](#L690) | </fieldset> |
| [691](#L691) | </td> |
| [692](#L692) | </tr> |
| [693](#L693) | <tr> |
| [694](#L694) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-name' ); ?>"><?php echo esc\_html( \_\_( 'Name', 'contact-form-7' ) ); ?></label></th> |
| [695](#L695) | <td><input type="text" name="name" class="tg-name oneline" id="<?php echo esc\_attr( $args['content'] . '-name' ); ?>" /></td> |
| [696](#L696) | </tr> |
| [697](#L697) | <tr> |
| [698](#L698) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>"><?php echo esc\_html( \_\_( "File size limit (bytes)", 'contact-form-7' ) ); ?></label></th> |
| [699](#L699) | <td><input type="text" name="limit" class="filesize oneline option" id="<?php echo esc\_attr( $args['content'] . '-limit' ); ?>" /></td> |
| [700](#L700) | </tr> |
| [701](#L701) | <tr> |
| [702](#L702) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>"><?php echo esc\_html( \_\_( 'Acceptable file types', 'contact-form-7' ) ); ?></label></th> |
| [703](#L703) | <td><input type="text" name="filetypes" class="filetype oneline option" placeholder="jpeg|png|jpg|gif" id="<?php echo esc\_attr( $args['content'] . '-filetypes' ); ?>" /></td> |
| [704](#L704) | </tr> |
| [705](#L705) | <tr> |
| [706](#L706) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>"><?php echo esc\_html( \_\_( 'Blacklist file types', 'contact-form-7' ) ); ?></label></th> |
| [707](#L707) | <td><input type="text" name="blacklist-types" class="filetype oneline option" placeholder="exe|bat|com" id="<?php echo esc\_attr( $args['content'] . '-blacklist-types' ); ?>" /></td> |
| [708](#L708) | </tr> |
| [709](#L709) | <tr> |
| [710](#L710) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>"><?php echo esc\_html( \_\_( 'Minimum file upload', 'contact-form-7' ) ); ?></label></th> |
| [711](#L711) | <td><input type="text" name="min-file" class="filetype oneline option" placeholder="5" id="<?php echo esc\_attr( $args['content'] . '-min-file' ); ?>" /></td> |
| [712](#L712) | </tr> |
| [713](#L713) | <tr> |
| [714](#L714) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>"><?php echo esc\_html( \_\_( 'Max file upload', 'contact-form-7' ) ); ?></label></th> |
| [715](#L715) | <td><input type="text" name="max-file" class="filetype oneline option" placeholder="10" id="<?php echo esc\_attr( $args['content'] . '-max-file' ); ?>" /></td> |
| [716](#L716) | </tr> |
| [717](#L717) | <tr> |
| [718](#L718) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-id' ); ?>"><?php echo esc\_html( \_\_( 'Id attribute', 'contact-form-7' ) ); ?></label></th> |
| [719](#L719) | <td><input type="text" name="id" class="idvalue oneline option" id="<?php echo esc\_attr( $args['content'] . '-id' ); ?>" /></td> |
| [720](#L720) | </tr> |
| [721](#L721) | <tr> |
| [722](#L722) | <th scope="row"><label for="<?php echo esc\_attr( $args['content'] . '-class' ); ?>"><?php echo esc\_html( \_\_( 'Class attribute', 'contact-form-7' ) ); ?></label></th> |
| [723](#L723) | <td><input type="text" name="class" class="classvalue oneline option" id="<?php echo esc\_attr( $args['content'] . '-class' ); ?>" /></td> |
| [724](#L724) | </tr> |
| [725](#L725) | </tbody> |
| [726](#L726) | </table> |
| [727](#L727) | </fieldset> |
| [728](#L728) | </div> |
| [729](#L729) |  |
| [730](#L730) | <div class="insert-box"> |
| [731](#L731) | <input type="text" name="<?php echo $type; ?>" class="tag code" readonly="readonly" onfocus="this.select()" /> |
| [732](#L732) | <div class="submitbox"> |
| [733](#L733) | <input type="button" class="button button-primary insert-tag" value="<?php echo esc\_attr( \_\_( 'Insert Tag', 'contact-form-7' ) ); ?>" /> |
| [734](#L734) | </div> |
| [735](#L735) | <br class="clear" /> |
| [736](#L736) | <p class="description mail-tag"> |
| [737](#L737) | <label for="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>"><?php echo sprintf( esc\_html( \_\_( "To attach the file uploaded through this field to mail, you need to insert the corresponding mail-tag (%s) into the File Attachments field on the Mail tab.", 'contact-form-7' ) ), '<strong><span class="mail-tag"></span></strong>' ); ?><input type="text" class="mail-tag code hidden" readonly="readonly" id="<?php echo esc\_attr( $args['content'] . '-mailtag' ); ?>" /></label> |
| [738](#L738) | </p> |
| [739](#L739) | </div> |
| [740](#L740) |  |
| [741](#L741) | <?php |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) | // Get allowed types |
| [745](#L745) | function dnd\_cf7\_get\_allowed\_types( $form\_id ) { |
| [746](#L746) |  |
| [747](#L747) | $tags = dnd\_get\_upload\_form( $form\_id ); |
| [748](#L748) | $supported\_types = array(); |
| [749](#L749) |  |
| [750](#L750) | // Loop all upload tags |
| [751](#L751) | if( $tags && is\_array( $tags ) ) { |
| [752](#L752) | foreach( $tags as $tag ) { |
| [753](#L753) |  |
| [754](#L754) | // Get file types option & remove not allowed character.. |
| [755](#L755) | $types = preg\_replace( '/[^a-zA-Z0-9\*|\']/', '', $tag->get\_option('filetypes','', true ) ); |
| [756](#L756) |  |
| [757](#L757) | // Assign if filetypes is present otherwise use the default ext list. |
| [758](#L758) | $supported\_types[ $tag->name ] = ( $types ? $types : dnd\_upload\_default\_ext() ); |
| [759](#L759) | } |
| [760](#L760) | } |
| [761](#L761) |  |
| [762](#L762) | return $supported\_types; |
| [763](#L763) | } |
| [764](#L764) |  |
| [765](#L765) | // Get file size option |
| [766](#L766) | function dnd\_cf7\_get\_size\_limit( $form\_id ) { |
| [767](#L767) |  |
| [768](#L768) | $tags = dnd\_get\_upload\_form( $form\_id ); |
| [769](#L769) | $allowed\_size = array(); |
| [770](#L770) |  |
| [771](#L771) | // Loop all upload tags |
| [772](#L772) | if( $tags && is\_array( $tags ) ) { |
| [773](#L773) | foreach( $tags as $tag ) { |
| [774](#L774) |  |
| [775](#L775) | // Get file types option & remove not allowed character.. |
| [776](#L776) | $limit = $tag->get\_option('limit','', true ); |
| [777](#L777) |  |
| [778](#L778) | // Assign if filetypes is present otherwise use the default ext list. |
| [779](#L779) | $allowed\_size[ $tag->name ] = ( $limit ? $limit : 10485760 ); //default 10MB |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) |  |
| [783](#L783) | return $allowed\_size; |
| [784](#L784) | } |
| [785](#L785) |  |
| [786](#L786) | // Get contact form data |
| [787](#L787) | function dnd\_get\_upload\_form( $form\_id ){ |
| [788](#L788) |  |
| [789](#L789) | // Initialize contact form instance |
| [790](#L790) | $form = WPCF7\_ContactForm::get\_instance( $form\_id ); |
| [791](#L791) |  |
| [792](#L792) | // Check if not valid object and null |
| [793](#L793) | if( ! $form && ! is\_object( $form ) ) { |
| [794](#L794) | return false; |
| [795](#L795) | } |
| [796](#L796) |  |
| [797](#L797) | // Get specific tag (mfile is for dnd file upload) |
| [798](#L798) | $tags = $form->scan\_form\_tags( array( 'type' => array('mfile', 'mfile\*') ) ); |
| [799](#L799) |  |
| [800](#L800) | if( $tags ){ |
| [801](#L801) | return $tags; |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) | return false; |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | // Begin process upload |
| [808](#L808) | function dnd\_upload\_cf7\_upload() { |
| [809](#L809) |  |
| [810](#L810) | // cf7 form id & upload name |
| [811](#L811) | $cf7\_id = sanitize\_text\_field( (int)$\_POST['form\_id']); |
| [812](#L812) |  |
| [813](#L813) | // Get the name of upload field. |
| [814](#L814) | $cf7\_upload\_name = sanitize\_text\_field( $\_POST['upload\_name'] ); |
| [815](#L815) |  |
| [816](#L816) | // Get allowed ext list @expected : png|jpeg|jpg |
| [817](#L817) | $allowed\_types = dnd\_cf7\_get\_allowed\_types( $cf7\_id ); |
| [818](#L818) |  |
| [819](#L819) | // File size limit |
| [820](#L820) | $size\_limit = dnd\_cf7\_get\_size\_limit( $cf7\_id ); |
| [821](#L821) |  |
| [822](#L822) | // check and verify ajax request |
| [823](#L823) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', 'security', false ) ) { |
| [824](#L824) | wp\_send\_json\_error('The security nonce is invalid or expired.'); |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | // Get blacklist Types |
| [828](#L828) | $blacklist\_types = ( isset( $\_POST['blacklist-types'] ) ?  explode( '|', sanitize\_text\_field( $\_POST['blacklist-types'] ) ) : '' ); |
| [829](#L829) |  |
| [830](#L830) | // Get upload dir |
| [831](#L831) | $path = dnd\_get\_upload\_dir(); |
| [832](#L832) |  |
| [833](#L833) | // input type file 'name' |
| [834](#L834) | $name = 'upload-file'; |
| [835](#L835) |  |
| [836](#L836) | // Get File ( name, type, tmp\_name, size, error ) |
| [837](#L837) | $file = isset( $\_FILES[$name] ) ? $\_FILES[$name] : null; |
| [838](#L838) |  |
| [839](#L839) | // Tells whether the file was uploaded via HTTP POST |
| [840](#L840) | if ( ! is\_uploaded\_file( $file['tmp\_name'] ) ) { |
| [841](#L841) | $failed\_error = get\_option('drag\_n\_drop\_error\_failed\_to\_upload'); |
| [842](#L842) | wp\_send\_json\_error( '('. $file['error'] .') ' . ( $failed\_error ? $failed\_error : dnd\_cf7\_error\_msg('failed\_upload') ) ); |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | /\* Get allowed extension \*/ |
| [846](#L846) | $supported\_type = ( isset( $allowed\_types["$cf7\_upload\_name"] ) ? $allowed\_types["$cf7\_upload\_name"] : dnd\_upload\_default\_ext() ); |
| [847](#L847) |  |
| [848](#L848) | // Create type pattern for anti script |
| [849](#L849) | $file\_type\_pattern = dnd\_upload\_cf7\_filetypes( $supported\_type ); |
| [850](#L850) |  |
| [851](#L851) | // Get file extension |
| [852](#L852) | $extension = strtolower( pathinfo( $file['name'], PATHINFO\_EXTENSION ) ); |
| [853](#L853) |  |
| [854](#L854) | // Validate File Types |
| [855](#L855) | if( $blacklist\_types && in\_array( $extension, $blacklist\_types ) && $supported\_type == '\*' ){ |
| [856](#L856) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [857](#L857) | } |
| [858](#L858) |  |
| [859](#L859) | // validate file type |
| [860](#L860) | if ( ( ! preg\_match( $file\_type\_pattern, $file['name'] ) || ! dnd\_cf7\_validate\_type( $extension, $supported\_type ) ) && $supported\_type != '\*' ) { |
| [861](#L861) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [862](#L862) | } |
| [863](#L863) |  |
| [864](#L864) | // validate mime type |
| [865](#L865) | if( $supported\_type && $supported\_type != '\*' ){ |
| [866](#L866) |  |
| [867](#L867) | // wheather if we validate mime type |
| [868](#L868) | $validate\_mime = apply\_filters('dnd\_cf7\_validate\_mime', false ); |
| [869](#L869) |  |
| [870](#L870) | if( $validate\_mime ){ |
| [871](#L871) |  |
| [872](#L872) | if( ! function\_exists('wp\_check\_filetype\_and\_ext') ){ |
| [873](#L873) | require\_once ABSPATH .'wp-admin/includes/file.php'; |
| [874](#L874) | } |
| [875](#L875) |  |
| [876](#L876) | // Get file type and extension name |
| [877](#L877) | $wp\_filetype = wp\_check\_filetype\_and\_ext( $file['tmp\_name'], $file['name'] ); //[ext, type] |
| [878](#L878) | $valid\_mimes = explode('|', $supported\_type); // array[png, jpg] |
| [879](#L879) |  |
| [880](#L880) | if( empty( $wp\_filetype['type'] ) || empty( $wp\_filetype['ext'] ) || ! in\_array( $wp\_filetype['ext'], $valid\_mimes ) ){ |
| [881](#L881) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_invalid\_file') ? get\_option('drag\_n\_drop\_error\_invalid\_file') : dnd\_cf7\_error\_msg('invalid\_type') ); |
| [882](#L882) | } |
| [883](#L883) | } |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | // validate file size limit |
| [887](#L887) | if( isset( $size\_limit["$cf7\_upload\_name"] ) && $file['size'] > $size\_limit["$cf7\_upload\_name"] ) { |
| [888](#L888) | wp\_send\_json\_error( get\_option('drag\_n\_drop\_error\_files\_too\_large') ? get\_option('drag\_n\_drop\_error\_files\_too\_large') : dnd\_cf7\_error\_msg('large\_file') ); |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | // Create file name |
| [892](#L892) | $filename = wp\_basename( $file['name'] ); |
| [893](#L893) | $filename = wpcf7\_canonicalize( $filename, 'as-is' ); |
| [894](#L894) |  |
| [895](#L895) | // Check if string is ascii then proceed with antiscript function ( remove or clean filename ) |
| [896](#L896) | if( dnd\_cf7\_check\_ascii( $filename ) ){ |
| [897](#L897) | $filename = wpcf7\_antiscript\_file\_name( $filename ); |
| [898](#L898) | } |
| [899](#L899) |  |
| [900](#L900) | // Add filter on upload file name |
| [901](#L901) | $filename = apply\_filters( 'wpcf7\_upload\_file\_name', $filename, $file['name'] ); |
| [902](#L902) |  |
| [903](#L903) | // Generate new filename |
| [904](#L904) | $filename = wp\_unique\_filename( $path['upload\_dir'], $filename ); |
| [905](#L905) | $new\_file = path\_join( $path['upload\_dir'], $filename ); |
| [906](#L906) |  |
| [907](#L907) | // Upload File |
| [908](#L908) | if ( false === move\_uploaded\_file( $file['tmp\_name'], $new\_file ) ) { |
| [909](#L909) | $failed\_error = get\_option('drag\_n\_drop\_error\_failed\_to\_upload'); |
| [910](#L910) | wp\_send\_json\_error( '('. $file['error'] .') ' . ( $failed\_error ? $failed\_error : dnd\_cf7\_error\_msg('failed\_upload') ) ); |
| [911](#L911) | }else{ |
| [912](#L912) |  |
| [913](#L913) | // Setup path and files url |
| [914](#L914) | $files = array( |
| [915](#L915) | 'path'  =>      basename( $path['upload\_dir'] ), |
| [916](#L916) | 'file'  =>      str\_replace('/','-', $filename) |
| [917](#L917) | ); |
| [918](#L918) |  |
| [919](#L919) | // Change file permission to 0400 |
| [920](#L920) | chmod( $new\_file, 0644 ); |
| [921](#L921) |  |
| [922](#L922) | // Allow other plugin to hook |
| [923](#L923) | do\_action('wpcf7\_upload\_file\_name\_custom', $new\_file, $filename ); |
| [924](#L924) |  |
| [925](#L925) | // Return json files |
| [926](#L926) | wp\_send\_json\_success( $files ); |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | die; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | // Check if a string is ASCII. |
| [933](#L933) | function dnd\_cf7\_check\_ascii( $string ) { |
| [934](#L934) | if ( function\_exists( 'mb\_check\_encoding' ) ) { |
| [935](#L935) | if ( mb\_check\_encoding( $string, 'ASCII' ) ) { |
| [936](#L936) | return true; |
| [937](#L937) | } |
| [938](#L938) | } elseif ( ! preg\_match( '/[^\x00-\x7F]/', $string ) ) { |
| [939](#L939) | return true; |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | return false; |
| [943](#L943) | } |
| [944](#L944) |  |
| [945](#L945) | // Delete file |
| [946](#L946) | function dnd\_codedropz\_upload\_delete() { |
| [947](#L947) |  |
| [948](#L948) | // Get folder directory |
| [949](#L949) | $dir = dnd\_get\_upload\_dir(); |
| [950](#L950) |  |
| [951](#L951) | // check and verify ajax request); |
| [952](#L952) | if( ! check\_ajax\_referer( 'dnd-cf7-security-nonce', 'security', false ) ) { |
| [953](#L953) | wp\_send\_json\_error('The security nonce is invalid or expired.'); |
| [954](#L954) | } |
| [955](#L955) |  |
| [956](#L956) |  |
| [957](#L957) | // Sanitize Path |
| [958](#L958) | $get\_path = ( isset( $\_POST['path'] ) ? sanitize\_text\_field( $\_POST['path'] ) : null ); |
| [959](#L959) |  |
| [960](#L960) | //limit the user input to a file name and to ignore injected path names |
| [961](#L961) | $path = basename( $get\_path ); |
| [962](#L962) |  |
| [963](#L963) | // Make sure path is set |
| [964](#L964) | if( ! is\_null( $path ) ) { |
| [965](#L965) |  |
| [966](#L966) | // Check valid filename & extensions |
| [967](#L967) | if( preg\_match\_all('/wp-|(\.php|\.exe|\.js|\.phtml|\.cgi|\.aspx|\.asp|\.bat)/', $path ) ) { |
| [968](#L968) | die('File not safe'); |
| [969](#L969) | } |
| [970](#L970) |  |
| [971](#L971) | // Concatenate path and upload directory |
| [972](#L972) | $file\_path = realpath( trailingslashit( $dir['upload\_dir'] ) . trim( $path ) ); |
| [973](#L973) |  |
| [974](#L974) | // Check if is in the correct upload\_dir |
| [975](#L975) | if( ! preg\_match("/". wpcf7\_dnd\_dir ."/i", $file\_path ) ) { |
| [976](#L976) | die('It\'s not a valid upload directory'); |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | // Check if file exists |
| [980](#L980) | if( file\_exists( $file\_path ) ){ |
| [981](#L981) | wp\_delete\_file( $file\_path ); |
| [982](#L982) | if( ! file\_exists( $file\_path ) ) { |
| [983](#L983) | wp\_send\_json\_success('File Deleted!'); |
| [984](#L984) | } |
| [985](#L985) | } |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | die; |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | // Setup file type pattern for validation |
| [992](#L992) | function dnd\_upload\_cf7\_filetypes( $types ) { |
| [993](#L993) | $file\_type\_pattern = ''; |
| [994](#L994) |  |
| [995](#L995) | // If contact form 7 5.0 and up |
| [996](#L996) | if( function\_exists('wpcf7\_acceptable\_filetypes') ) { |
| [997](#L997) | $file\_type\_pattern = wpcf7\_acceptable\_filetypes( $types, 'regex' ); |
| [998](#L998) | $file\_type\_pattern = '/\.(' . $file\_type\_pattern . ')$/i'; |
| [999](#L999) | }else{ |
| [1000](#L1000) | $allowed\_file\_types = array(); |
| [1001](#L1001) | $file\_types = explode( '|', $types ); |
| [1002](#L1002) |  |
| [1003](#L1003) | foreach ( $file\_types as $file\_type ) { |
| [1004](#L1004) | $file\_type = trim( $file\_type, '.' ); |
| [1005](#L1005) | $file\_type = str\_replace( array( '.', '+', '\*', '?' ), array( '\.', '\+', '\\*', '\?' ), $file\_type ); |
| [1006](#L1006) | $allowed\_file\_types[] = $file\_type; |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | $allowed\_file\_types = array\_unique( $allowed\_file\_types ); |
| [1010](#L1010) | $file\_type\_pattern = implode( '|', $allowed\_file\_types ); |
| [1011](#L1011) |  |
| [1012](#L1012) | $file\_type\_pattern = trim( $file\_type\_pattern, '|' ); |
| [1013](#L1013) | $file\_type\_pattern = '(' . $file\_type\_pattern . ')'; |
| [1014](#L1014) | $file\_type\_pattern = '/\.' . $file\_type\_pattern . '$/i'; |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | return $file\_type\_pattern; |
| [1018](#L1018) | } |
| [1019](#L1019) |  |
| [1020](#L1020) | // Add more validation for file extension |
| [1021](#L1021) | function dnd\_cf7\_validate\_type( $extension, $supported\_types ) { |
| [1022](#L1022) | $valid = true; |
| [1023](#L1023) | $extension = preg\_replace( '/[^A-Za-z0-9,|]/', '', $extension ); |
| [1024](#L1024) |  |
| [1025](#L1025) | // not allowed file types |
| [1026](#L1026) | $not\_allowed = array( 'php', 'php3','php4','phtml','exe','script', 'app', 'asp', 'bas', 'bat', 'cer', 'cgi', 'chm', 'cmd', 'com', 'cpl', 'crt', 'csh', 'csr', 'dll', 'drv', 'fxp', 'flv', 'hlp', 'hta', 'htaccess', 'htm', 'htpasswd', 'inf', 'ins', 'isp', 'jar', 'js', 'jse', 'jsp', 'ksh', 'lnk', 'mdb', 'mde', 'mdt', 'mdw', 'msc', 'msi', 'msp', 'mst', 'ops', 'pcd', 'pif', 'pl', 'prg', 'ps1', 'ps2', 'py', 'rb', 'reg', 'scr', 'sct', 'sh', 'shb', 'shs', 'sys', 'swf', 'tmp', 'torrent', 'url', 'vb', 'vbe', 'vbs', 'vbscript', 'wsc', 'wsf', 'wsf', 'wsh' ); |
| [1027](#L1027) |  |
| [1028](#L1028) | // allowed ext. |
| [1029](#L1029) | $allowed\_ext = array('ipt'); |
| [1030](#L1030) |  |
| [1031](#L1031) | // Search in $not\_allowed extension and match |
| [1032](#L1032) | foreach( $not\_allowed as $single\_ext ) { |
| [1033](#L1033) | if ( strpos( $single\_ext, $extension, 0 ) !== false && ! in\_array( $extension, $allowed\_ext )) { |
| [1034](#L1034) | $valid = false; |
| [1035](#L1035) | break; |
| [1036](#L1036) | } |
| [1037](#L1037) | } |
| [1038](#L1038) |  |
| [1039](#L1039) | // If pass on first validation - check extension if exists in allowed types |
| [1040](#L1040) | if( $valid === true ) { |
| [1041](#L1041) | $extensions = explode('|', strtolower( $supported\_types ) ); |
| [1042](#L1042) | if( ! in\_array( $extension, $extensions ) ) { |
| [1043](#L1043) | $valid = false; |
| [1044](#L1044) | } |
| [1045](#L1045) | } |
| [1046](#L1046) |  |
| [1047](#L1047) | return $valid; |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | // Admin Settings |
| [1051](#L1051) | function dnd\_upload\_admin\_settings( ) { |
| [1052](#L1052) | echo '<div class="wrap">'; |
| [1053](#L1053) | echo '<h1>Drag & Drop Uploader - Settings</h1>'; |
| [1054](#L1054) |  |
| [1055](#L1055) | echo '<div class="update-nag notice" style="width: 98%;padding: 0px 10px;margin-bottom: 5px;">'; |
| [1056](#L1056) | echo '<p>Checkout more features on <a href="https://codedropz.com/purchase-plugin/" target="\_blank">Pro Version</a></p>'; |
| [1057](#L1057) | echo '</div>'; |
| [1058](#L1058) |  |
| [1059](#L1059) | // Error settings |
| [1060](#L1060) | settings\_errors(); |
| [1061](#L1061) |  |
| [1062](#L1062) | echo '<form method="post" action="options.php"> '; |
| [1063](#L1063) | settings\_fields( 'drag-n-drop-upload-file-cf7' ); |
| [1064](#L1064) | do\_settings\_sections( 'drag-n-drop-upload-file-cf7' ); |
| [1065](#L1065) | ?> |
| [1066](#L1066) |  |
| [1067](#L1067) | <table class="form-table" style="display:none;"> |
| [1068](#L1068) | <tr valign="top"> |
| [1069](#L1069) | <th scope="row"><?php \_e('Translate To','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1070](#L1070) | <td><?php wp\_dropdown\_languages( array('name' => 'drag\_n\_drop\_lang', 'id' => 'drag\_n\_drop\_lang') ); ?> |
| [1071](#L1071) | <div style="margin-top:20px;"> |
| [1072](#L1072) | <strong>Translated: </strong><a href="">abc</a> |
| [1073](#L1073) | </div> |
| [1074](#L1074) | </td> |
| [1075](#L1075) | </tr> |
| [1076](#L1076) | </table> |
| [1077](#L1077) |  |
| [1078](#L1078) | <table class="form-table"> |
| [1079](#L1079) | <tr valign="top"> |
| [1080](#L1080) | <th scope="row"><?php \_e('Send Attachment as links?','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1081](#L1081) | <td><input name="drag\_n\_drop\_mail\_attachment" type="checkbox" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_mail\_attachment')); ?>></td> |
| [1082](#L1082) | </tr> |
| [1083](#L1083) | </table> |
| [1084](#L1084) |  |
| [1085](#L1085) | <h2><?php \_e('Uploader Info','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1086](#L1086) |  |
| [1087](#L1087) | <table class="form-table"> |
| [1088](#L1088) | <tr valign="top"> |
| [1089](#L1089) | <th scope="row"><?php \_e('Heading Tag','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1090](#L1090) | <td> |
| [1091](#L1091) | <select name="drag\_n\_drop\_heading\_tag"> |
| [1092](#L1092) | <option value="h1" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h1'); ?>>H1</option> |
| [1093](#L1093) | <option value="h2" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h2'); ?>>H2</option> |
| [1094](#L1094) | <option value="h3" <?php selected( get\_option('drag\_n\_drop\_heading\_tag','h3'), 'h3'); ?>>H3</option> |
| [1095](#L1095) | <option value="h4" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h4'); ?>>H4</option> |
| [1096](#L1096) | <option value="h5" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h5'); ?>>H5</option> |
| [1097](#L1097) | <option value="h6" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'h6'); ?>>H6</option> |
| [1098](#L1098) | <option value="span" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'span'); ?>>Span</option> |
| [1099](#L1099) | <option value="div" <?php selected( get\_option('drag\_n\_drop\_heading\_tag'), 'div'); ?>>Div</option> |
| [1100](#L1100) | </select> |
| [1101](#L1101) | </td> |
| [1102](#L1102) | </tr> |
| [1103](#L1103) | <tr valign="top"> |
| [1104](#L1104) | <th scope="row"><?php \_e('Drag & Drop Text','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1105](#L1105) | <td><input type="text" name="drag\_n\_drop\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_text') ); ?>" placeholder="Drag & Drop Files Here" /></td> |
| [1106](#L1106) | </tr> |
| [1107](#L1107) | <tr valign="top"> |
| [1108](#L1108) | <th scope="row"></th> |
| [1109](#L1109) | <td><input type="text" name="drag\_n\_drop\_separator" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_separator') ); ?>" placeholder="or" /></td> |
| [1110](#L1110) | </tr> |
| [1111](#L1111) | <tr valign="top"> |
| [1112](#L1112) | <th scope="row"><?php \_e('Browse Text','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1113](#L1113) | <td><input type="text" name="drag\_n\_drop\_browse\_text" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_browse\_text') ); ?>" placeholder="Browse Files" /></td> |
| [1114](#L1114) | </tr> |
| [1115](#L1115) | </table> |
| [1116](#L1116) |  |
| [1117](#L1117) | <h2><?php \_e('Error Message','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1118](#L1118) |  |
| [1119](#L1119) | <table class="form-table"> |
| [1120](#L1120) | <tr valign="top"> |
| [1121](#L1121) | <th scope="row"><?php \_e('File exceeds server limit','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1122](#L1122) | <td><input type="text" name="drag\_n\_drop\_error\_server\_limit" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_server\_limit') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('server\_limit'); ?>" /></td> |
| [1123](#L1123) | </tr> |
| [1124](#L1124) | <tr valign="top"> |
| [1125](#L1125) | <th scope="row"><?php \_e('Failed to Upload','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1126](#L1126) | <td><input type="text" name="drag\_n\_drop\_error\_failed\_to\_upload" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_failed\_to\_upload') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('failed\_upload'); ?>" /></td> |
| [1127](#L1127) | </tr> |
| [1128](#L1128) | <tr valign="top"> |
| [1129](#L1129) | <th scope="row"><?php \_e('Files too large','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1130](#L1130) | <td><input type="text" name="drag\_n\_drop\_error\_files\_too\_large" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_files\_too\_large') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('large\_file'); ?>" /></td> |
| [1131](#L1131) | </tr> |
| [1132](#L1132) | <tr valign="top"> |
| [1133](#L1133) | <th scope="row"><?php \_e('Invalid file Type','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1134](#L1134) | <td><input type="text" name="drag\_n\_drop\_error\_invalid\_file" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_invalid\_file') ); ?>" placeholder="<?php echo dnd\_cf7\_error\_msg('invalid\_type'); ?>" /></td> |
| [1135](#L1135) | </tr> |
| [1136](#L1136) | <tr valign="top"> |
| [1137](#L1137) | <th scope="row"><?php \_e('Max File Limit','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1138](#L1138) | <td><input type="text" name="drag\_n\_drop\_error\_max\_file" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_max\_file') ); ?>" placeholder="" /><p class="description">Example: `Note : Some of the files are not uploaded ( Only %count% files allowed )`</p></td> |
| [1139](#L1139) | </tr> |
| [1140](#L1140) | <tr valign="top"> |
| [1141](#L1141) | <th scope="row"><?php \_e('Minimum File','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1142](#L1142) | <td><input type="text" name="drag\_n\_drop\_error\_min\_file" placeholder="" class="regular-text" value="<?php echo esc\_attr( get\_option('drag\_n\_drop\_error\_min\_file') ); ?>" placeholder="" /></td> |
| [1143](#L1143) | </tr> |
| [1144](#L1144) | </table> |
| [1145](#L1145) |  |
| [1146](#L1146) | <h2><?php \_e('Auto Delete Files','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1147](#L1147) |  |
| [1148](#L1148) | <table class="form-table"> |
| [1149](#L1149) | <tr valign="top"> |
| [1150](#L1150) | <th scope="row"><?php \_e('Don\'t delete files','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1151](#L1151) | <td><input type="checkbox" name="drag\_n\_drop\_disable\_auto\_delete" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_auto\_delete')); ?>> Yes <br><p class="description"><em>The default will automatically delete files 1-2 hours after submissions, if you want to keep files check "Yes" above.</em></p></td> |
| [1152](#L1152) | </tr> |
| [1153](#L1153) | </table> |
| [1154](#L1154) |  |
| [1155](#L1155) | <h2><?php \_e('Spam Filtering Issue','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1156](#L1156) |  |
| [1157](#L1157) | <table class="form-table"> |
| [1158](#L1158) | <tr valign="top"> |
| [1159](#L1159) | <th scope="row"><?php \_e('Fix Spam','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1160](#L1160) | <td><input type="checkbox" name="drag\_n\_drop\_fix\_spam" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_fix\_spam')); ?>> Yes <p class="description"><em>If a “spam” answer is the response, Contact Form 7 will suspend the email and show a message saying, “There was an error trying to send your message", force to send message by checking this option..</em></p></td> |
| [1161](#L1161) | </tr> |
| [1162](#L1162) | </table> |
| [1163](#L1163) |  |
| [1164](#L1164) | <h2><?php \_e('Use jQuery','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1165](#L1165) |  |
| [1166](#L1166) | <table class="form-table"> |
| [1167](#L1167) | <tr valign="top"> |
| [1168](#L1168) | <th scope="row"><?php \_e('Enable jQuery','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1169](#L1169) | <td><input type="checkbox" name="drag\_n\_drop\_use\_jquery" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_use\_jquery')); ?>> Yes <p class="description"><em>Activate this option in case there are any problems with our plugin when utilizing native Javascript.</em></p></td> |
| [1170](#L1170) | </tr> |
| [1171](#L1171) | </table> |
| [1172](#L1172) |  |
| [1173](#L1173) | <h2 style="display:none;"><?php \_e('Disable Button','drag-and-drop-multiple-file-upload-contact-form-7'); ?></h2> |
| [1174](#L1174) |  |
| [1175](#L1175) | <table style="display:none;" class="form-table"> |
| [1176](#L1176) | <tr valign="top"> |
| [1177](#L1177) | <th scope="row"><?php \_e('Disable Submit button','drag-and-drop-multiple-file-upload-contact-form-7'); ?></th> |
| [1178](#L1178) | <td><input type="checkbox" name="drag\_n\_drop\_disable\_btn" value="yes" <?php checked('yes', get\_option('drag\_n\_drop\_disable\_btn')); ?>> Yes <p class="description">Disable submit button if there's an error.</p></td> |
| [1179](#L1179) | </tr> |
| [1180](#L1180) | </table> |
| [1181](#L1181) |  |
| [1182](#L1182) | <?php submit\_button(); ?> |
| [1183](#L1183) |  |
| [1184](#L1184) | <?php |
| [1185](#L1185) | echo '</form>'; |
| [1186](#L1186) | echo '</div>'; |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | // Add script in footer |
| [1190](#L1190) | function dnd\_custom\_scripts() { |
| [1191](#L1191) | if( ! in\_array('jquery-validation-for-contact-form-7/jquery-validation-for-contact-form-7.php', get\_option('active\_plugins') ) ){ |
| [1192](#L1192) | return; |
| [1193](#L1193) | } |
| [1194](#L1194) | ?> |
| [1195](#L1195) | <script type="text/javascript"> |
| [1196](#L1196) | // Contact form 7 - Jquery validation |
| [1197](#L1197) | jQuery(document).ready(function($){ |
| [1198](#L1198) | jQuery('.wpcf7-form-control.wpcf7-submit').click(function(e){ |
| [1199](#L1199) | var uploadFields = $(this).parents('form').find('.wpcf7-drag-n-drop-file'); |
| [1200](#L1200) | var valid = true; |
| [1201](#L1201) | if( uploadFields.length > 0 ) { |
| [1202](#L1202) | jQuery.each(uploadFields, function(i,field){ |
| [1203](#L1203) | if( $(field).attr('aria-required') == 'true' ) { |
| [1204](#L1204) | parentsWrap = $(field).parents('.codedropz-upload-wrapper'); |
| [1205](#L1205) | parentsWrap.removeClass('invalid'); |
| [1206](#L1206) | parentsWrap.find('label').remove(); |
| [1207](#L1207) | if( $('[type="hidden"][name="'+$(field).attr('data-name')+'[]"]').length == 0 ) { |
| [1208](#L1208) | parentsWrap.append('<label class="error-new">'+ dnd\_cf7\_uploader.drag\_n\_drop\_upload.required +'</label>').addClass('invalid'); |
| [1209](#L1209) | valid = false; |
| [1210](#L1210) | } |
| [1211](#L1211) | } |
| [1212](#L1212) | }); |
| [1213](#L1213) | if( ! valid ) { |
| [1214](#L1214) | return false; |
| [1215](#L1215) | } |
| [1216](#L1216) | } |
| [1217](#L1217) | return true; |
| [1218](#L1218) | }); |
| [1219](#L1219) | }); |
| [1220](#L1220) | </script> |
| [1221](#L1221) | <?php |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | // Custom css style - Inline |
| [1225](#L1225) | function dnd\_custom\_style(){ |
| [1226](#L1226) | echo '<style id="multiple-file-upload">'; |
| [1227](#L1227) | include dnd\_upload\_cf7\_directory . '/assets/css/dnd-upload-cf7.css'; |
| [1228](#L1228) | echo '</style>'; |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | // Define custom (safe) file extension. |
| [1232](#L1232) | function dnd\_upload\_default\_ext() { |
| [1233](#L1233) | return apply\_filters('dnd\_cf7\_default\_ext', 'jpg|jpeg|JPG|png|gif|pdf|doc|docx|ppt|pptx|odt|avi|ogg|m4a|mov|mp3|mp4|mpg|wav|wmv|xls' ); |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | // Add custom links |
| [1237](#L1237) | function dnd\_custom\_plugin\_row\_meta( $links, $file ) { |
| [1238](#L1238) | if ( strpos( $file, 'drag-n-drop-upload-cf7.php' ) !== false ) { |
| [1239](#L1239) | $new\_links = array('pro-version' => '<a href="https://codedropz.com/purchase-plugin/" target="\_blank" style="font-weight:bold; color:#f4a647;">Pro Version</a>'); |
| [1240](#L1240) | $links = array\_merge( $links, $new\_links ); |
| [1241](#L1241) | } |
| [1242](#L1242) | return $links; |
| [1243](#L1243) | } |
| [1244](#L1244) |  |
| [1245](#L1245) | // Save admin settings |
| [1246](#L1246) | function dnd\_upload\_register\_settings() { |
| [1247](#L1247) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_heading\_tag','sanitize\_text\_field' ); |
| [1248](#L1248) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_mail\_attachment','sanitize\_text\_field' ); |
| [1249](#L1249) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_text','sanitize\_text\_field' ); |
| [1250](#L1250) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_separator','sanitize\_text\_field' ); |
| [1251](#L1251) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_browse\_text','sanitize\_text\_field' ); |
| [1252](#L1252) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_server\_limit','sanitize\_text\_field' ); |
| [1253](#L1253) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_failed\_to\_upload','sanitize\_text\_field' ); |
| [1254](#L1254) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_files\_too\_large','sanitize\_text\_field' ); |
| [1255](#L1255) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_invalid\_file','sanitize\_text\_field' ); |
| [1256](#L1256) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_max\_file','sanitize\_text\_field' ); |
| [1257](#L1257) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_error\_min\_file','sanitize\_text\_field' ); |
| [1258](#L1258) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_disable\_btn','sanitize\_text\_field' ); |
| [1259](#L1259) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_disable\_auto\_delete','sanitize\_text\_field' ); |
| [1260](#L1260) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_fix\_spam','sanitize\_text\_field' ); |
| [1261](#L1261) | register\_setting( 'drag-n-drop-upload-file-cf7', 'drag\_n\_drop\_use\_jquery','sanitize\_text\_field' ); |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | function dnd\_upload\_cf7\_lang() { |
| [1265](#L1265) | $lang = null; |
| [1266](#L1266) |  |
| [1267](#L1267) | // Polylang & WPML compatiblity |
| [1268](#L1268) | if( function\_exists('pll\_current\_language') ) { |
| [1269](#L1269) | $lang = pll\_current\_language(); |
| [1270](#L1270) | }elseif( class\_exists('SitePress') ) { |
| [1271](#L1271) | $lang = ICL\_LANGUAGE\_CODE; |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | // If english / default lang leave empty. |
| [1275](#L1275) | if( $lang ) { |
| [1276](#L1276) | $lang = ( $lang == 'en' ? '' : '-'.$lang ); |
| [1277](#L1277) | } |
| [1278](#L1278) |  |
| [1279](#L1279) | return apply\_filters('dndmfu\_wc\_lang', $lang ); |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | /\*add\_action('admin\_footer', function(){ |
| [1283](#L1283) | if( isset( $\_GET['page'] ) && $\_GET['page'] == 'drag-n-drop-upload' ) { |
| [1284](#L1284) | ?> |
| [1285](#L1285) | <script type="text/javascript"> |
| [1286](#L1286) | jQuery('document').ready(function($){ |
| [1287](#L1287) | $('#drag\_n\_drop\_lang').change(function(){ |
| [1288](#L1288) | window.location.href = "<?php echo admin\_url('admin.php?page=drag-n-drop-upload&lang-code='); ?>" + $(this).val(); |
| [1289](#L1289) | }); |
| [1290](#L1290) | }); |
| [1291](#L1291) | </script> |
| [1292](#L1292) | <?php |
| [1293](#L1293) | } |
| [1294](#L1294) | });\*/ |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php?format=txt)
* [Original Format](/export/3222448/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_8c6f0e55_20250114_191437.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Drag and Drop Multiple File Upload - Contact Form 7 <= 1.3.7.3 - Unauthenticated Arbitrary File Upload

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Drag and Drop Multiple File Upload - Contact Form 7 <= 1.3.7.3 - Unauthenticated Arbitrary File Upload

8.1

**Unrestricted Upload of File with Dangerous Type**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-5822](https://www.cve.org/CVERecord?id=CVE-2023-5822) |
| --- | --- |
| CVSS | 8.1 (High) |
| Publicly Published | November 1, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Drag and Drop Multiple File Upload - Contact Form 7 plugin for WordPress is vulnerable to arbitrary file uploads due to insufficient file type validation in the 'dnd\_upload\_cf7\_upload' function in versions up to, and including, 1.3.7.3. This makes it possible for unauthenticated attackers to upload arbitrary files on the affected site's server which may make remote code execution possible. This can be exploited if a user authorized to edit form, which means editor privileges or above, has added a 'multiple file upload' form field with '\*' acceptable file types.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php#L828)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php#L855)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/drag-and-drop-multiple-file-upload-contact-form-7/tags/1.3.7.2/inc/dnd-upload-cf7.php#L904)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=2987252%40drag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk&old=2968538%40drag-and-drop-multiple-file-upload-contact-form-7%2Ftrunk&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Fdrag-and-drop-multiple-file-upload-contact-form-7-1374-unauthenticated-arbitrary-file-upload&t=Drag%20and%20Drop%20Multiple%20File%20Upload%20-%20Contact%20Form%207%20%3C%3D%201.3.7.3%20-%20Unauthenticated%20Arbitrary%20File%20Upload "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Fdrag-and-drop-multiple-file-upload-contact-form-7-1374-unauthenticated-arbitrary-file-upload&text=Drag%20and%20Drop%20Multiple%20File%20Upload%20-%20Contact%20Form%207%20%3C%3D%201.3.7.3%20-%20Unauthenticated%20Arbitrary%20File%20Upload "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fdrag-and-drop-multiple-file-upload-contact-form-7%2Fdrag-and-drop-multiple-file-upload-contact-form-7-1374-unauthenticated-arbitrary-file-upload "LinkedIn")
Email

## Vulnerability Details for Drag and Drop Multiple File Upload – Contact Form 7

#### [Drag and Drop Multiple File Upload – Contact Form 7](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/drag-and-drop-multiple-file-upload-contact-form-7)

| Software Type | Plugin |
| --- | --- |
| Software Slug | drag-and-drop-multiple-file-upload-contact-form-7 [(view on wordpress.org)](https://wordpress.org/plugins/drag-and-drop-multiple-file-upload-contact-form-7) |
| Patched? | Yes |
| Remediation | Update to version 1.3.7.4, or a newer patched version |
| Affected Version | * <= 1.3.7.3 |
| Patched Version | * 1.3.7.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


