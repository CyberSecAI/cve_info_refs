=== Content from discourse.ubuntu.com_70c067d7_20250114_181622.html ===


![Ubuntu Community Hub](data:image/svg;base64...)
Loading

[Ubuntu Community Hub](/)

# [Easy multi-user LXD setup](/t/easy-multi-user-lxd-setup/26215)

[Project Discussion](/c/project/desktop/8)

[Desktop](/c/project/desktop/8)

[lxd](https://discourse.ubuntu.com/tag/lxd)

[alexmurray](https://discourse.ubuntu.com/u/alexmurray)

January 19, 2022, 4:59am

4

Thanks [@stgraber](/u/stgraber) - that worked like a charm ![:slight_smile:](https://discourse.ubuntu.com/images/emoji/twitter/slight_smile.png?v=12 ":slight_smile:")

For posterity, it was as simple as:

```
# remove my user from the lxd group
sudo gpasswd -d $USER lxd

# reboot to cleanly logout and back in again without being in
# the lxd group anymore

# set the lxd user group to just my user's primary group since
# there is no other  users on my local machine
sudo snap set lxd daemon.user.group=$USER

# lxc will have created a new project called user-$UID for your user
lxc project list
# set this as the default project
lxc project switch user-$UID

# then migrate instances to this user's project by stopping them all
# and then moving them across
sudo lxc stop --all
# moving may take a while depending on how many containers/vms you have
for instance in $(sudo lxc list --format json | jq ".[].name" -r); do
  sudo lxc move $instance --target-project user-$UID
done

# then I can use those instances from my local user as before

```

3 Likes

[show post in topic](/t/easy-multi-user-lxd-setup/26215#post_4)

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](https://www.ubuntu.com/legal)
* [Privacy Policy](https://www.ubuntu.com/legal/terms-and-policies/privacy-policy)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled

[##### Discourse](/)



=== Content from bugs.launchpad.net_f96b65e5_20250114_181620.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[lxd package](https://launchpad.net/ubuntu/%2Bsource/lxd)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/lxd)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/lxd)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/lxd)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/lxd)

# Privilege escalation via LXD (local root exploit)

Bug #1829071 reported by
[Chris Moberly](https://launchpad.net/~chris.moberly)
on 2019-05-14

[262](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [lxd (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd "Latest release: 3.0.3-0ubuntu1~18.04.2, uploaded to main on 2022-03-25 00:11:09.800799+00:00 by Stéphane Graber (stgraber), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Won't Fix | Undecided | Unassigned |  |

### Bug Description

Hello Ubuntu team,

I'm a big fan of the LXD snap and am quite enjoying the technology. Below is a brief write-up of an issue I believe you may want to review. Thanks for your time and your hard work on such an amazing OS.

Any member of the local `lxd` group can immediately escalate their privileges to root on the host operating system. This is regardless of whether or not that user has been granted sudo rights and does not require them to enter their password. The vulnerability exists even with the LXD snap package.

This issue is not about container break-outs and requires an attacker to already have local access to the system and be a member of the `lxd` user group.

LXD is a root process that carries out actions for anyone with write access to the LXD UNIX socket. It often does not attempt to match privileges of the calling user. There are multiple methods to exploit this. One of them is to use the LXD API to mount the host's root filesystem into a container. This gives a low-privilege user root access to the host filesystem. This is demonstrated in the exploit attached.

To use the attached exploit, first launch an LXC container using LXD. Then, run `lxd\_root.sh <container name>` as a member of the `lxd` user group.

There are other, slightly more in-depth, exploitation methods as well. An example would be to create an LXD proxy device that maps a UNIX socket on the host OS into the container. This mapping will be done using a root process, so that a low-privilege user can simply use the `lxc` command to enter that container and communicate with the socket using root's peer credentials. Using this strategy, one could obtain root-level command execution by speaking to systemd's private socket, for example, linking a new malicious service and starting it. I've built a very rough proof of concept to confirm this works as well, but it is not quite ready to share.

The LXD package maintainers are aware of this and have deemed it not a security issue. Some examples of existing public discussions are:

 - <https://github.com/lxc/lxd/issues/2003>

 - <https://github.com/lxc/lxd/issues/3844>

I'm raising this issue on the Ubuntu bug tracker as it is a Canonical-sponsored project and Ubuntu users are told to add users to this account without warning them that it breaks Ubuntu's intended security model. Some examples are here:

 - <https://blog.ubuntu.com/2015/04/28/getting-started-with-lxd-the-container-lightervisor>

 - <https://help.ubuntu.com/lts/serverguide/lxd.html>

And of course the official LXD getting started guide here:

 - <https://linuxcontainers.org/lxd/getting-started-cli/>

The links above states `If the "lxd" group is missing on your system, create it, then restart the LXD daemon. You can then add trusted users to it. Anyone added to this group will have full control over LXD.` When, in fact, it should state that anyone added to this group will have full control over the host OS, bypassing intended privileged access checks like a sudo password requirement.

I think it would be worthwhile making this extremely clear in all official Ubuntu documentation and blogs, as well.

From my perspective, this looks like a typical root exploit worthy of a CVE and a customer notification. I'm submitting this as a private bug so that you can review before making public. As the vulnerability has already been discussed on GitHub, the issue of course is already in the public domain.

Thanks for reading!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Moberly (chris.moberly)](https://launchpad.net/~chris.moberly) wrote on 2019-05-14: |  |  | [#1](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/1) |
| --- | --- | --- | --- |

* [lxd\_root.sh](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Battachment/5263728/%2Bfiles/lxd_root.sh)
  [Edit](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Battachment/5263728)
  (1.6 KiB,
  text/x-sh)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Moberly (chris.moberly)](https://launchpad.net/~chris.moberly) wrote on 2019-05-14: |  |  | [#2](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/2) |
| --- | --- | --- | --- |

* [screenshot of exploit](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Battachment/5263729/%2Bfiles/lxd_root-screenshot.png)
  [Edit](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Battachment/5263729)
  (41.3 KiB,
  image/png)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Moberly (chris.moberly)](https://launchpad.net/~chris.moberly) wrote on 2019-05-14: |  |  | [#3](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/3) |
| --- | --- | --- | --- |

Just a note, others who have found and are providing details on how to exploit this:

- <https://reboare.github.io/lxd/lxd-escape.html>

- <https://calap.co/blog/hackistanbul-ctf-brazil-writeup--2018-09-10.html>

Just a note, others who have found and are providing details on how to exploit this:
- https://reboare.github.io/lxd/lxd-escape.html
- https://calap.co/blog/hackistanbul-ctf-brazil-writeup--2018-09-10.html

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2019-05-14: |  |  | [#4](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/4) |
| --- | --- | --- | --- |

Hello Chris, good to hear from you again.

I believe the LXD team considers lxd group access equivalent to root access.

Stéphane, can you comment further?

Thanks

Hello Chris, good to hear from you again.
I believe the LXD team considers lxd group access equivalent to root access.
Stéphane, can you comment further?
Thanks

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2019-05-14:  [**Re: [Bug 1829071] [NEW] Privilege escalation via LXD (local root exploit)**](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/5) |  |  | [#5](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/5) |
| --- | --- | --- | --- |

The logic is based (as in copy/pasted) from what was done for libvirt

with libvirtd offering similar privileges to lxd as far as being able to

quickly become root on the system.

If this is considered to be an actual issue, then we need to look at all

packages in the archive which rely on the same logic to add existing

users of the admin & sudo groups into their own group for interaction

with a privileged daemon that can allow escalation to root.

Worth noting that the LXD snap while it does create the group, doesn't

add users to it (as finding a suitable base group that works on all

distros proved difficult).

The logic is based (as in copy/pasted) from what was done for libvirt
with libvirtd offering similar privileges to lxd as far as being able to
quickly become root on the system.
If this is considered to be an actual issue, then we need to look at all
packages in the archive which rely on the same logic to add existing
users of the admin & sudo groups into their own group for interaction
with a privileged daemon that can allow escalation to root.
Worth noting that the LXD snap while it does create the group, doesn't
add users to it (as finding a suitable base group that works on all
distros proved difficult).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Moberly (chris.moberly)](https://launchpad.net/~chris.moberly) wrote on 2019-05-14: |  |  | [#6](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/6) |
| --- | --- | --- | --- |

Hi guys

Thanks for the quick reply. I understand that the developers consider the lxd group as equivalent to root. I dont think this is made clear to system administrators, though. I think most would appreciate a heads up that they are turning users into root. Even a documentation update as mentioned in my initial report would be a major improvement.

Docs talking about things like unprivileged containers should also include this info. These are read by folks probably intending to build secure environments, not realising that their "unprivileged" set has actually reduced overall system security.

Hi guys
Thanks for the quick reply. I understand that the developers consider the lxd group as equivalent to root. I dont think this is made clear to system administrators, though. I think most would appreciate a heads up that they are turning users into root. Even a documentation update as mentioned in my initial report would be a major improvement.
Docs talking about things like unprivileged containers should also include this info. These are read by folks probably intending to build secure environments, not realising that their "unprivileged" set has actually reduced overall system security.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Moberly (chris.moberly)](https://launchpad.net/~chris.moberly) wrote on 2019-05-17: |  |  | [#7](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/7) |
| --- | --- | --- | --- |

Hello again folks,

I just noticed the LXD snap is included in a default installation of Ubuntu 19.04 Server. I really don't mean to pick on LXD (I actually really love the tool and think the team is doing awesome work), but I want to make a few points clear:

- In default installations of Ubuntu, users who follow the official documentation to create their first LXD container are introducing a privilege escalation vulnerability on their systems with no warning.

- Users who follow guides to create "unprivileged" containers are in fact creating containers under the context of their accounts that are members of the LXD group, which is essentially root due to multiple vulnerabilities.

- Savvy attackers have been able to figure this out using Google for at least two years now.

- I have multiple fully working exploits (including the new attack leveraging relayed UNIX socket creds) and a detailed technical write-up I am ready to publish.

If the stance is still "this is not a security issue" - I understand and respect that, and will assume there is no issue with publishing the exploits for other security researchers.

Thanks again for reading, I know you are all quite busy juggling many projects.

Thanks!

Hello again folks,
I just noticed the LXD snap is included in a default installation of Ubuntu 19.04 Server. I really don't mean to pick on LXD (I actually really love the tool and think the team is doing awesome work), but I want to make a few points clear:
- In default installations of Ubuntu, users who follow the official documentation to create their first LXD container are introducing a privilege escalation vulnerability on their systems with no warning.
- Users who follow guides to create "unprivileged" containers are in fact creating containers under the context of their accounts that are members of the LXD group, which is essentially root due to multiple vulnerabilities.
- Savvy attackers have been able to figure this out using Google for at least two years now.
- I have multiple fully working exploits (including the new attack leveraging relayed UNIX socket creds) and a detailed technical write-up I am ready to publish.
If the stance is still "this is not a security issue" - I understand and respect that, and will assume there is no issue with publishing the exploits for other security researchers.
Thanks again for reading, I know you are all quite busy juggling many projects.
Thanks!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Christian Brauner (cbrauner)](https://launchpad.net/~cbrauner) wrote on 2019-05-17: |  |  | [#8](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/8) |
| --- | --- | --- | --- |

Would like to hear what Jann thinks about this too.

Would like to hear what Jann thinks about this too.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2019-05-17: |  |  | [#9](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/9) |
| --- | --- | --- | --- |

So far we've done some tweaks to the following documents:

 - <https://linuxcontainers.org/lxd/getting-started-cli/#access-control>

 - <https://lxd.readthedocs.io/en/latest/security/>

 - <https://github.com/lxc/lxd#security>

So far we've done some tweaks to the following documents:
- https://linuxcontainers.org/lxd/getting-started-cli/#access-control
- https://lxd.readthedocs.io/en/latest/security/
- https://github.com/lxc/lxd#security

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Moberly (chris.moberly)](https://launchpad.net/~chris.moberly) wrote on 2019-05-17: |  |  | [#10](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/10) |
| --- | --- | --- | --- |

This is great, thank you for such quick action. I think this is a definite improvement.

It is still my personal opinion that these are legitimate privilege escalation vulnerabilities, but at least this provides users with a bit of warning.

As a final thought:

- Specifically related to UNIX socket in the proxy device: root processes are allowed to choose which peer credentials are sent in socket message ancillary data. LXD could be designed to pass the creds of the user who instantiated the proxy connection, as opposed to root creds. This would mitigate the issue.

- Specifically to mounting the filesystem. The mount could be done in such a way to replicate the privileges of the initiating user. This would mitigate the issue.

I will update my write-up to state that documentation has been clarified and that there are no plans for remediate these issues.

This is great, thank you for such quick action. I think this is a definite improvement.
It is still my personal opinion that these are legitimate privilege escalation vulnerabilities, but at least this provides users with a bit of warning.
As a final thought:
- Specifically related to UNIX socket in the proxy device: root processes are allowed to choose which peer credentials are sent in socket message ancillary data. LXD could be designed to pass the creds of the user who instantiated the proxy connection, as opposed to root creds. This would mitigate the issue.
- Specifically to mounting the filesystem. The mount could be done in such a way to replicate the privileges of the initiating user. This would mitigate the issue.
I will update my write-up to state that documentation has been clarified and that there are no plans for remediate these issues.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Moberly (chris.moberly)](https://launchpad.net/~chris.moberly) wrote on 2019-05-21: |  |  | [#11](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/11) |
| --- | --- | --- | --- |

Hi everyone,

Any objections to switching this bug to public? The bug remains unclassified.

Hi everyone,
Any objections to switching this bug to public? The bug remains unclassified.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Alex Murray (alexmurray)](https://launchpad.net/~alexmurray) wrote on 2019-05-21: |  |  | [#12](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/12) |
| --- | --- | --- | --- |

Since this is already public via other sources I have no objections - I would like to see Chris' suggestions in comment:10 investigated by the LXD team to see if these would be suitable as future features to try and attenuate the authority which comes via lxd.

Since this is already public via other sources I have no objections - I would like to see Chris' suggestions in comment:10 investigated by the LXD team to see if these would be suitable as future features to try and attenuate the authority which comes via lxd.

| **information type**: | Private Security → Public Security |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Chris Moberly (chris.moberly)](https://launchpad.net/~chris.moberly) wrote on 2019-05-21: |  |  | [#13](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/13) |
| --- | --- | --- | --- |

Thanks everyone! I appreciate you time and attention on this. Thanks again for your hard work on the LXD project in general, it's a great tool.

Thanks everyone! I appreciate you time and attention on this. Thanks again for your hard work on the LXD project in general, it's a great tool.

[Marc Deslauriers (mdeslaur)](https://launchpad.net/~mdeslaur)
on 2019-06-28

| Changed in lxd (Ubuntu): | |
| --- | --- |
| **status**: | New → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2020-03-22: |  |  | [#14](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/comments/14) |
| --- | --- | --- | --- |

For the deb we won't be changing the logic at this point and it's in line with what's done for libvirt, changing behavior at this point would cause more harm than good.

For the snap, we don't auto-add users and as mentioned earlier, have updated our various documentations (those we maintain anyway) to be clearer about the privileges granted to those with access to the API (and mentioning RBAC for those wanting a safer option).

For the deb we won't be changing the logic at this point and it's in line with what's done for libvirt, changing behavior at this point would cause more harm than good.
For the snap, we don't auto-add users and as mentioned earlier, have updated our various documentations (those we maintain anyway) to be clearer about the privileges granted to those with access to the API (and mentioning RBAC for those wanting a safer option).

| Changed in lxd (Ubuntu): | |
| --- | --- |
| **status**: | Confirmed → Won't Fix |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/lxd/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Bug attachments

* [lxd\_root.sh](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Battachment/5263728/%2Bfiles/lxd_root.sh)
  [Edit](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Battachment/5263728 "Change attachment details")
* [screenshot of exploit](https://bugs.launchpad.net/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Battachment/5263729/%2Bfiles/lxd_root-screenshot.png)
  [Edit](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Battachment/5263729 "Change attachment details")

* [Add attachment](/ubuntu/%2Bsource/lxd/%2Bbug/1829071/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))


