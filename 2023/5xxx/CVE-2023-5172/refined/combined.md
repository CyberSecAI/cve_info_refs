=== Content from www.mozilla.org_f0f8a38e_20250114_175744.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2023-41

## Security Vulnerabilities fixed in Firefox 118

Announced
September 26, 2023
Impact
high
Products
Firefox
Fixed in

* Firefox 118

#### [#CVE-2023-5168: Out-of-bounds write in FilterNodeD2D1](#CVE-2023-5168)

Reporter
sonakkbi
Impact
high
##### Description

A compromised content process could have provided malicious data to `FilterNodeD2D1` resulting in an out-of-bounds write, leading to a potentially exploitable crash in a privileged process.
*This bug only affects Firefox on Windows. Other operating systems are unaffected.*

##### References

* [Bug 1846683](https://bugzilla.mozilla.org/show_bug.cgi?id=1846683)

#### [#CVE-2023-5169: Out-of-bounds write in PathOps](#CVE-2023-5169)

Reporter
sonakkbi
Impact
high
##### Description

A compromised content process could have provided malicious data in a `PathRecording` resulting in an out-of-bounds write, leading to a potentially exploitable crash in a privileged process.

##### References

* [Bug 1846685](https://bugzilla.mozilla.org/show_bug.cgi?id=1846685)

#### [#CVE-2023-5170: Memory leak from a privileged process](#CVE-2023-5170)

Reporter
sonakkbi
Impact
high
##### Description

In canvas rendering, a compromised content process could have caused a surface to change unexpectedly, leading to a memory leak of a privileged process. This memory leak could be used to effect a sandbox escape if the correct data was leaked.

##### References

* [Bug 1846686](https://bugzilla.mozilla.org/show_bug.cgi?id=1846686)

#### [#CVE-2023-5171: Use-after-free in Ion Compiler](#CVE-2023-5171)

Reporter
Lukas Bernhard
Impact
high
##### Description

During Ion compilation, a Garbage Collection could have resulted in a use-after-free condition, allowing an attacker to write two NUL bytes, and cause a potentially exploitable crash.

##### References

* [Bug 1851599](https://bugzilla.mozilla.org/show_bug.cgi?id=1851599)

#### [#CVE-2023-5172: Memory Corruption in Ion Hints](#CVE-2023-5172)

Reporter
Mozilla Fuzzing Team
Impact
high
##### Description

A hashtable in the Ion Engine could have been mutated while there was a live interior reference, leading to a potential use-after-free and exploitable crash.

##### References

* [Bug 1852218](https://bugzilla.mozilla.org/show_bug.cgi?id=1852218)

#### [#CVE-2023-5173: Out-of-bounds write in HTTP Alternate Services](#CVE-2023-5173)

Reporter
Ronald Crane
Impact
moderate
##### Description

In a non-standard configuration of Firefox, an integer overflow could have occurred based on network traffic (possibly under influence of a local unprivileged webpage), leading to an out-of-bounds write to privileged process memory.
*This bug only affects Firefox if a non-standard preference allowing non-HTTPS Alternate Services (`network.http.altsvc.oe`) is enabled.*

##### References

* [Bug 1823172](https://bugzilla.mozilla.org/show_bug.cgi?id=1823172)

#### [#CVE-2023-5174: Double-free in process spawning on Windows](#CVE-2023-5174)

Reporter
Ronald Crane
Impact
moderate
##### Description

If Windows failed to duplicate a handle during process creation, the sandbox code may have inadvertently freed a pointer twice, resulting in a use-after-free and a potentially exploitable crash.
*This bug only affects Firefox on Windows when run in non-standard configurations (such as using `runas`). Other operating systems are unaffected.*

##### References

* [Bug 1848454](https://bugzilla.mozilla.org/show_bug.cgi?id=1848454)

#### [#CVE-2023-5175: Use-after-free of ImageBitmap during process shutdown](#CVE-2023-5175)

Reporter
Yangkang of 360 ATA Team
Impact
low
##### Description

During process shutdown, it was possible that an `ImageBitmap` was created that would later be used after being freed from a different codepath, leading to a potentially exploitable crash.

##### References

* [Bug 1849704](https://bugzilla.mozilla.org/show_bug.cgi?id=1849704)

#### [#CVE-2023-5176: Memory safety bugs fixed in Firefox 118, Firefox ESR 115.3, and Thunderbird 115.3](#CVE-2023-5176)

Reporter
Chris Peterson, Andrew McCreight, André Bargull, Nika Layzell and the Mozilla Fuzzing Team
Impact
high
##### Description

Memory safety bugs present in Firefox 117, Firefox ESR 115.2, and Thunderbird 115.2. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 118, Firefox ESR 115.3, and Thunderbird 115.3](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1836353%2C1842674%2C1843824%2C1843962%2C1848890%2C1850180%2C1850983%2C1851195)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from security.gentoo.org_897e22ca_20250114_175743.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# Mozilla Firefox: Multiple Vulnerabilities — GLSA **202401-10**

Multiple vulnerabilities have been found in Mozilla Firefox, the worst of which could lead to remote code execution.

### Affected packages

| Package | **www-client/firefox** on all architectures |
| --- | --- |
| Affected versions | < **121.0**< **115.6.0** |
| Unaffected versions | >= **121.0**>= **115.6.0** |

| Package | **www-client/firefox-bin** on all architectures |
| --- | --- |
| Affected versions | < **121.0**< **115.6.0** |
| Unaffected versions | >= **121.0**>= **115.6.0** |

### Background

Mozilla Firefox is a popular open-source web browser from the Mozilla project.

### Description

Multiple vulnerabilities have been discovered in Mozilla Firefox. Please review the CVE identifiers referenced below for details.

### Impact

Please review the referenced CVE identifiers for details.

### Workaround

There is no known workaround at this time.

### Resolution

All Mozilla Firefox ESR binary users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-bin-115.6.0:esr"

```

All Mozilla Firefox ESR users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-115.6.0:esr"

```

All Mozilla Firefox binary users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-bin-121.0:rapid"

```

All Mozilla Firefox users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-121.0:rapid"

```
### References

* [CVE-2023-3482](https://nvd.nist.gov/vuln/detail/CVE-2023-3482)
* [CVE-2023-4058](https://nvd.nist.gov/vuln/detail/CVE-2023-4058)
* [CVE-2023-4579](https://nvd.nist.gov/vuln/detail/CVE-2023-4579)
* [CVE-2023-4863](https://nvd.nist.gov/vuln/detail/CVE-2023-4863)
* [CVE-2023-5129](https://nvd.nist.gov/vuln/detail/CVE-2023-5129)
* [CVE-2023-5170](https://nvd.nist.gov/vuln/detail/CVE-2023-5170)
* [CVE-2023-5172](https://nvd.nist.gov/vuln/detail/CVE-2023-5172)
* [CVE-2023-5173](https://nvd.nist.gov/vuln/detail/CVE-2023-5173)
* [CVE-2023-5175](https://nvd.nist.gov/vuln/detail/CVE-2023-5175)
* [CVE-2023-5722](https://nvd.nist.gov/vuln/detail/CVE-2023-5722)
* [CVE-2023-5723](https://nvd.nist.gov/vuln/detail/CVE-2023-5723)
* [CVE-2023-5729](https://nvd.nist.gov/vuln/detail/CVE-2023-5729)
* [CVE-2023-5731](https://nvd.nist.gov/vuln/detail/CVE-2023-5731)
* [CVE-2023-5758](https://nvd.nist.gov/vuln/detail/CVE-2023-5758)
* [CVE-2023-6135](https://nvd.nist.gov/vuln/detail/CVE-2023-6135)
* [CVE-2023-6210](https://nvd.nist.gov/vuln/detail/CVE-2023-6210)
* [CVE-2023-6211](https://nvd.nist.gov/vuln/detail/CVE-2023-6211)
* [CVE-2023-6213](https://nvd.nist.gov/vuln/detail/CVE-2023-6213)
* [CVE-2023-6856](https://nvd.nist.gov/vuln/detail/CVE-2023-6856)
* [CVE-2023-6857](https://nvd.nist.gov/vuln/detail/CVE-2023-6857)
* [CVE-2023-6858](https://nvd.nist.gov/vuln/detail/CVE-2023-6858)
* [CVE-2023-6859](https://nvd.nist.gov/vuln/detail/CVE-2023-6859)
* [CVE-2023-6860](https://nvd.nist.gov/vuln/detail/CVE-2023-6860)
* [CVE-2023-6861](https://nvd.nist.gov/vuln/detail/CVE-2023-6861)
* [CVE-2023-6862](https://nvd.nist.gov/vuln/detail/CVE-2023-6862)
* [CVE-2023-6863](https://nvd.nist.gov/vuln/detail/CVE-2023-6863)
* [CVE-2023-6864](https://nvd.nist.gov/vuln/detail/CVE-2023-6864)
* [CVE-2023-6865](https://nvd.nist.gov/vuln/detail/CVE-2023-6865)
* [CVE-2023-6866](https://nvd.nist.gov/vuln/detail/CVE-2023-6866)
* [CVE-2023-6867](https://nvd.nist.gov/vuln/detail/CVE-2023-6867)
* [CVE-2023-6868](https://nvd.nist.gov/vuln/detail/CVE-2023-6868)
* [CVE-2023-6869](https://nvd.nist.gov/vuln/detail/CVE-2023-6869)
* [CVE-2023-6870](https://nvd.nist.gov/vuln/detail/CVE-2023-6870)
* [CVE-2023-6871](https://nvd.nist.gov/vuln/detail/CVE-2023-6871)
* [CVE-2023-6872](https://nvd.nist.gov/vuln/detail/CVE-2023-6872)
* [CVE-2023-6873](https://nvd.nist.gov/vuln/detail/CVE-2023-6873)
* [CVE-2023-32205](https://nvd.nist.gov/vuln/detail/CVE-2023-32205)
* [CVE-2023-32206](https://nvd.nist.gov/vuln/detail/CVE-2023-32206)
* [CVE-2023-32207](https://nvd.nist.gov/vuln/detail/CVE-2023-32207)
* [CVE-2023-32208](https://nvd.nist.gov/vuln/detail/CVE-2023-32208)
* [CVE-2023-32209](https://nvd.nist.gov/vuln/detail/CVE-2023-32209)
* [CVE-2023-32210](https://nvd.nist.gov/vuln/detail/CVE-2023-32210)
* [CVE-2023-32211](https://nvd.nist.gov/vuln/detail/CVE-2023-32211)
* [CVE-2023-32212](https://nvd.nist.gov/vuln/detail/CVE-2023-32212)
* [CVE-2023-32213](https://nvd.nist.gov/vuln/detail/CVE-2023-32213)
* [CVE-2023-32214](https://nvd.nist.gov/vuln/detail/CVE-2023-32214)
* [CVE-2023-32215](https://nvd.nist.gov/vuln/detail/CVE-2023-32215)
* [CVE-2023-32216](https://nvd.nist.gov/vuln/detail/CVE-2023-32216)
* [CVE-2023-34414](https://nvd.nist.gov/vuln/detail/CVE-2023-34414)
* [CVE-2023-34415](https://nvd.nist.gov/vuln/detail/CVE-2023-34415)
* [CVE-2023-34416](https://nvd.nist.gov/vuln/detail/CVE-2023-34416)
* [CVE-2023-34417](https://nvd.nist.gov/vuln/detail/CVE-2023-34417)
* [CVE-2023-37203](https://nvd.nist.gov/vuln/detail/CVE-2023-37203)
* [CVE-2023-37204](https://nvd.nist.gov/vuln/detail/CVE-2023-37204)
* [CVE-2023-37205](https://nvd.nist.gov/vuln/detail/CVE-2023-37205)
* [CVE-2023-37206](https://nvd.nist.gov/vuln/detail/CVE-2023-37206)
* [CVE-2023-37209](https://nvd.nist.gov/vuln/detail/CVE-2023-37209)
* [CVE-2023-37210](https://nvd.nist.gov/vuln/detail/CVE-2023-37210)
* [CVE-2023-37212](https://nvd.nist.gov/vuln/detail/CVE-2023-37212)
* MFSA-2023-40
* MFSA-TMP-2023-0002

**Release date**

January 07, 2024

**Latest revision**

January 07, 2024: 1

**Severity**

high

**Exploitable**

remote

**Bugzilla entries**

* [908245](https://bugs.gentoo.org/show_bug.cgi?id=908245)
* [914073](https://bugs.gentoo.org/show_bug.cgi?id=914073)
* [918433](https://bugs.gentoo.org/show_bug.cgi?id=918433)
* [920507](https://bugs.gentoo.org/show_bug.cgi?id=920507)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from bugzilla.mozilla.org_0b6597f1_20250114_175742.html ===


![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1852218)
* [XML](/show_bug.cgi?ctype=xml&id=1852218)

Closed
[Bug 1852218](/show_bug.cgi?id=1852218)
(CVE-2023-5172)

Opened 1 year ago
Closed 1 year ago

# Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137

## Categories

### (Core :: JavaScript Engine: JIT, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT#JavaScript%20Engine%3A%20JIT)

JavaScript Engine: JIT
▾

Core :: JavaScript Engine: JIT
JavaScript engine's JIT compilers
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S4

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

119 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| Accessibility Severity | --- |
| a11y-review | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected) |
| firefox-esr115 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=unaffected) |
| firefox117 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=wontfix) |
| firefox118 | [+](/buglist.cgi?f1=cf_tracking_firefox118&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed) |
| firefox119 | [+](/buglist.cgi?f1=cf_tracking_firefox119&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=verified) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | unaffected |
| firefox-esr115 | --- | unaffected |
| firefox-esr128 | --- | --- |
| firefox117 |  | wontfix |
| firefox118 | + | fixed |
| firefox119 | + | verified |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: decoder, Assigned: iain)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/1243fc5f2c1c56a2f77ca1be38837e68?d=mm&size=40)  [iain](/user_profile?user_id=623993)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?d=mm&size=40)  [decoder](/user_profile?user_id=395101)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

10 people

## References

### (Blocks 1 open bug, Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[sm-jits](/show_bug.cgi?id=1729516 "NEW - [meta] Just-In-Time Compilers")

Dependency [tree](/showdependencytree.cgi?id=1852218&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1852218)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[1837192](/show_bug.cgi?id=1837192 "RESOLVED FIXED - Consider caching hints for eager Ion compilation")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (5 keywords, Whiteboard: [bugmon:update,bisected,confirmed] [adv-main118+r])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-5172

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[bugmon:update,bisected,confirmed] [adv-main118+r]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files)

| [Detailed Crash Information](/attachment.cgi?id=9352172)  [1 year ago](#c1)  [Christian Holler (:decoder)](/user_profile?user_id=395101)   4.63 KB, text/plain |  | [Details](/attachment.cgi?id=9352172&action=edit) |
| --- | --- | --- |
| [Testcase](/attachment.cgi?id=9352173)  [1 year ago](#c2)  [Christian Holler (:decoder)](/user_profile?user_id=395101)   1.07 KB, text/plain |  | [Details](/attachment.cgi?id=9352173&action=edit) |
| [Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!](/attachment.cgi?id=9352291)  [1 year ago](#c5)  [Iain Ireland [:iain]](/user_profile?user_id=623993)   48 bytes, text/x-phabricator-request | pascalc : [approval-mozilla-beta+](#c21 "1 year ago")  RyanVM : [approval-mozilla-release-](#c14 "1 year ago")  tjr : [sec-approval+](#c11 "1 year ago") | [Details](/attachment.cgi?id=9352291&action=edit) | [Review](/attachment.cgi?id=9352291) |
| [advisory.txt](/attachment.cgi?id=9354379)  [1 year ago](#c23)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   176 bytes, text/plain |  | [Details](/attachment.cgi?id=9354379&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1852218#c0)• 1 year ago |
|  | |

The following testcase crashes on mozilla-central revision 20230907-f829a45e2207 (debug build, run with --fuzzing-safe --no-threads --disable-oom-functions --baseline-eager --ion-warmup-threshold=0):

```
function patchSrc(src, exc) {
  try {
    let srcParts = src.split("\n");
    let srcLine = "d262 = undefined;"
    srcParts.splice(exc.lineNumber - 1, 0, srcLine);
    return srcParts.join("\n");
  } catch(exc) {}
}
initGlobals = new Set(Object.keys(this));
loadFile(`
//xorefuzz-dcd-selectmode
/*---
description: SingleNameBinding does assign name
defines: [DETACHBUFFER]
---*/
function DETACHBUFFER(buffer) {
  d262.detachArrayBuffer(buffer);
}
assert = initGlobals;
assert.sameValue = DETACHBUFFER;
`);
loadFile(`
//xorefuzz-dcd-evaluate
// GENERATED, DO NOT EDIT
// file: temporalHelpers.js
// Copyright (C) 2021 Igalia, S.L. All rights reserved.
// This code is governed by the BSD license found in the LICENSE file.
/*---
---*/
C55 = class {
  [1 * 1] = () => {};
};
c29 = new C55();
assert.sameValue();
`);
function loadFile(lfVarx) {
    try {
      evaluate(lfVarx);
    } catch (lfVare) {
      if (lfVare.toString().indexOf("is not defined") >= 0 || lfVare.toString().indexOf("is undefined") >= 0) {
        newSrc = patchSrc(lfVarx, lfVare);
        loadFile(newSrc);
      }
    }
}

```

Backtrace:

```
received signal SIGSEGV, Segmentation fault.
#0  0x00005555580a0d59 in bool mozilla::detail::HashTable<mozilla::HashMapEntry<unsigned int, js::jit::JitHintsMap::IonHint*>, mozilla::HashMap<unsigned int, js::jit::JitHintsMap::IonHint*, mozilla::DefaultHasher<unsigned int, void>, js::SystemAllocPolicy>::MapHashPolicy, js::SystemAllocPolicy>::add<unsigned int&, js::jit::JitHintsMap::IonHint*&>(mozilla::detail::HashTable<mozilla::HashMapEntry<unsigned int, js::jit::JitHintsMap::IonHint*>, mozilla::HashMap<unsigned int, js::jit::JitHintsMap::IonHint*, mozilla::DefaultHasher<unsigned int, void>, js::SystemAllocPolicy>::MapHashPolicy, js::SystemAllocPolicy>::AddPtr&, unsigned int&, js::jit::JitHintsMap::IonHint*&) ()
#1  0x000055555809b6a4 in js::jit::JitHintsMap::addIonHint(unsigned int, mozilla::detail::HashTable<mozilla::HashMapEntry<unsigned int, js::jit::JitHintsMap::IonHint*>, mozilla::HashMap<unsigned int, js::jit::JitHintsMap::IonHint*, mozilla::DefaultHasher<unsigned int, void>, js::SystemAllocPolicy>::MapHashPolicy, js::SystemAllocPolicy>::AddPtr&) ()
#2  0x000055555809bc11 in js::jit::JitHintsMap::recordIonCompilation(JSScript*) ()
#3  0x0000555557f6536d in js::jit::CodeGenerator::link(JSContext*, js::jit::WarpSnapshot const*) ()
#4  0x0000555557f9d522 in js::jit::Compile(JSContext*, JS::Handle<JSScript*>, js::jit::BaselineFrame*, unsigned char*) ()
#5  0x0000555557f9c7c8 in js::jit::CanEnterIon(JSContext*, js::RunState&) ()
#6  0x000055555808bc3c in js::jit::MaybeEnterJit(JSContext*, js::RunState&) ()
#7  0x0000555557040e2f in js::RunScript(JSContext*, js::RunState&) ()
#8  0x0000555557041811 in js::InternalCallOrConstruct(JSContext*, JS::CallArgs const&, js::MaybeConstruct, js::CallReason) ()
#9  0x0000555557043a27 in InternalConstruct(JSContext*, js::AnyConstructArgs const&, js::CallReason) ()
#10 0x0000555557b95bd5 in js::jit::DoCallFallback(JSContext*, js::jit::BaselineFrame*, js::jit::ICFallbackStub*, unsigned int, JS::Value*, JS::MutableHandle<JS::Value>) ()
#11 0x0000003afc1c0f07 in ?? ()
[...]
#22 0x0000000000000000 in ?? ()
rax	0x55555583caad	93824995281581
rbx	0x7ffff33fc000	140737274429440
rcx	0x5555588e7888	93825046313096
rdx	0x0	0
rsi	0x7ffff6abd770	140737331844976
rdi	0x7ffff6abc540	140737331840320
rbp	0x7ffffff85850	140737487853648
rsp	0x7ffffff85820	140737487853600
r8	0x7ffff6abd770	140737331844976
r9	0x7ffff7fe3840	140737354020928
r10	0x2	2
r11	0x0	0
r12	0x7ffffff85874	140737487853684
r13	0xffffffffffffff	72057594037927935
r14	0x7ffffff858b0	140737487853744
r15	0xeb674046c8035882	-1484146879447738238
rip	0x5555580a0d59 <bool mozilla::detail::HashTable<mozilla::HashMapEntry<unsigned int, js::jit::JitHintsMap::IonHint*>, mozilla::HashMap<unsigned int, js::jit::JitHintsMap::IonHint*, mozilla::DefaultHasher<unsigned int, void>, js::SystemAllocPolicy>::MapHashPolicy, js::SystemAllocPolicy>::add<unsigned int&, js::jit::JitHintsMap::IonHint*&>(mozilla::detail::HashTable<mozilla::HashMapEntry<unsigned int, js::jit::JitHintsMap::IonHint*>, mozilla::HashMap<unsigned int, js::jit::JitHintsMap::IonHint*, mozilla::DefaultHasher<unsigned int, void>, js::SystemAllocPolicy>::MapHashPolicy, js::SystemAllocPolicy>::AddPtr&, unsigned int&, js::jit::JitHintsMap::IonHint*&)+1177>
=> 0x5555580a0d59 <_ZN7mozilla6detail9HashTableINS_12HashMapEntryIjPN2js3jit11JitHintsMap7IonHintEEENS_7HashMapIjS7_NS_13DefaultHasherIjvEENS3_17SystemAllocPolicyEE13MapHashPolicyESC_E3addIJRjRS7_EEEbRNSF_6AddPtrEDpOT_+1177>:	movl   $0x859,0x0
   0x5555580a0d64 <_ZN7mozilla6detail9HashTableINS_12HashMapEntryIjPN2js3jit11JitHintsMap7IonHintEEENS_7HashMapIjS7_NS_13DefaultHasherIjvEENS3_17SystemAllocPolicyEE13MapHashPolicyESC_E3addIJRjRS7_EEEbRNSF_6AddPtrEDpOT_+1188>:	callq  0x555556f36513 <abort>

```

The testcase here reproduces reliably for me after 6-10 seconds but it does not reduce further and is comment-sensitive (so don't be rude around it ;)).

To me, this looks like a subtle form of memory corruption going on in JITs, marking s-s.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1852218#c1)• 1 year ago |
|  | |

Attached file
[Detailed Crash Information](attachment.cgi?id=9352172)
— [Details](attachment.cgi?id=9352172&action=edit)

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1852218#c2)• 1 year ago |
|  | |

Attached file
[Testcase](attachment.cgi?id=9352173)
— [Details](attachment.cgi?id=9352173&action=edit)

|  | [Bugmon [:jkratzer for issues]](/user_profile?user_id=676404) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1852218#c3)• 1 year ago |
|  | |

Verified bug as reproducible on mozilla-central 20230908034814-3096b15a785a.

Unable to bisect testcase (Unable to launch the start build!):

> Start: c3cd822e69a160e5358aa061d34f990b40ab100e (20220909043058)
>
> End: f829a45e22076f02abeee8ca0f757a842da4f4de (20230907040951)
>
> BuildFlags: BuildFlags(asan=None, tsan=None, debug=True, fuzzing=None, coverage=None, valgrind=None, no\_opt=None, fuzzilli=None, nyx=None)

Whiteboard: [bugmon:update,bisect] → [bugmon:update,bisected,confirmed]

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1852218#c4)• 1 year ago |
|  | |

This is a bug in Denis's jit-hints work. I don't think it's security sensitive.

To avoid having to do multiple lookups, after checking to see if we have an existing hint, we pass the lookup result into [addIonHint](https://searchfox.org/mozilla-central/rev/7fe1954b761abeff36122b4a6ac74619704ee787/js/src/jit/JitHints.cpp#21-27). Before we add the hint, we check to see if we have exceeded IonHintMaxEntries, in which case we remove the oldest hint first.

In debug builds, hash tables store the number of mutations that have taken place and cache that number in each lookup result to make sure we don't mutate the hashtable between the lookup and the eventual insertion. Removing an existing hint violates this rule.

I think we can fix the bug by simply delaying the hint removal until after we've added the new hint.

Here's a reduced testcase:

```
// |jit-test| --fast-warmup; --no-threads

function makeIonCompiledScript(n) {
  let src = "";
  for (var i = 0; i < n; i++) {
    src += "\n";
  }
  src += "function f() {}";
  eval(src);
  for (var i = 0; i < 50; i++) {
    f();
  }
  return f;
}

for (var i = 0; i < 5010; i++) {
  makeIonCompiledScript(i);
}

```

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1852218#c5)• 1 year ago |
|  | |

Attached file
[Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!](attachment.cgi?id=9352291)
— [Details](attachment.cgi?id=9352291&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a42185_600971)• 1 year ago |

Assignee: nobody → iirelandStatus: NEW → ASSIGNED

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1852218#c6)• 1 year ago |
|  | |

(In reply to Iain Ireland [:iain] from [comment #4](/show_bug.cgi?id=1852218#c4 "VERIFIED FIXED - Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137"))

> This is a bug in Denis's jit-hints work. I don't think it's security sensitive.

I think this is a security issue. remove() can call shrinkIfUnderloaded(), which can call changeTableSize() which will reallocate the hashtable's storage, thereby invalidating internal pointers into the hash table like `p`.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a44888_406194)• 1 year ago |

Keywords: [csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)Regressed by: [1837192](/show_bug.cgi?id=1837192 "RESOLVED FIXED - Consider caching hints for eager Ion compilation")

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1852218#c7)• 1 year ago |
|  | |

(Unless I'm misunderstanding how add ptr works for HashTable...)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1852218#c8)• 1 year ago |
|  | |

Set release status flags based on info from the regressing [bug 1837192](/show_bug.cgi?id=1837192 "RESOLVED FIXED - Consider caching hints for eager Ion compilation")

[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected)
[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=unaffected)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a46246_75935)• 1 year ago |

[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=wontfix)
[tracking-firefox118](/buglist.cgi?f1=cf_tracking_firefox118&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox118&o1=equals&v1=%2B)
[tracking-firefox119](/buglist.cgi?f1=cf_tracking_firefox119&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox119&o1=equals&v1=%2B)

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1852218#c9)• 1 year ago |
|  | |

In this particular case I think we will avoid shrinkIfUnderloaded because we never actually decrease the overall number of entries in the hash table. We keep adding entries until we hit 5000, and then each time we add an entry after that we remove the oldest.

If there's something that can go badly wrong here, I think it would have to be something like:

1. Fill up the hint map.
2. Add a new hint which hashes to the same bucket as the oldest hint. Get back a slot based on that collision.
3. Remove the old hint. It looks like we take a [slightly different path](https://searchfox.org/mozilla-central/rev/c1fb133ca4901985070e519c92322b432fa254c5/mfbt/HashTable.h#1157) depending on whether there's been a collision for that slot, marking it as Free rather than Removed.
4. Add the new hint. The hash table is now in a slightly inconsistent state.
5. ???
6. Profit!

More broadly, though, you're right that we should probably treat this as s-s.

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1852218#c10)• 1 year ago |
|  | |

Comment on [attachment 9352291](/attachment.cgi?id=9352291 "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") [[details]](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!")

[Bug 1852218](/show_bug.cgi?id=1852218 "VERIFIED FIXED - Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137"): Remove old hints after adding new hints r=dpalmeiro!

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Fairly difficult. If you can control hash collisions then you can get the hash table into an inconsistent state, but I don't think you can reallocate the backing storage.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: 117, 118, 119
* **If not all supported branches, which bug introduced the flaw?**: [Bug 1837192](/show_bug.cgi?id=1837192 "RESOLVED FIXED - Consider caching hints for eager Ion compilation")
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: The patch should apply cleanly.
* **How likely is this patch to cause regressions; how much testing does it need?**: Unlikely. It reorders a small amount of code.
* **Is Android affected?**: Yes
[Attachment #9352291](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") -
Flags: sec-approval?

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1852218#c11)• 1 year ago |
|  | |

Comment on [attachment 9352291](/attachment.cgi?id=9352291 "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") [[details]](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!")

[Bug 1852218](/show_bug.cgi?id=1852218 "VERIFIED FIXED - Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137"): Remove old hints after adding new hints r=dpalmeiro!

Approved to land and uplift

[Attachment #9352291](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") -
Flags: sec-approval? → sec-approval+

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1852218#c12)• 1 year ago |
|  | |

Comment on [attachment 9352291](/attachment.cgi?id=9352291 "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") [[details]](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!")

[Bug 1852218](/show_bug.cgi?id=1852218 "VERIFIED FIXED - Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137"): Remove old hints after adding new hints r=dpalmeiro!

### Beta/Release Uplift Approval Request

* **User impact if declined**: Hashtable invariants are violated. I can't rule out the possibility that it's exploitable.
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: Yes
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: It reorders a small section of code to avoid mutating a hashtable with a live AddPtr.
* **String changes made/needed**:
* **Is Android affected?**: Yes
[Attachment #9352291](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") -
Flags: approval-mozilla-release?
[Attachment #9352291](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") -
Flags: approval-mozilla-beta?

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1852218#c13)• 1 year ago |
|  | |

Pushed by iireland@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/754947adaad8>
Remove old hints after adding new hints r=dpalmeiro

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1852218#c14)• 1 year ago |
|  | |

Comment on [attachment 9352291](/attachment.cgi?id=9352291 "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") [[details]](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!")

[Bug 1852218](/show_bug.cgi?id=1852218 "VERIFIED FIXED - Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137"): Remove old hints after adding new hints r=dpalmeiro!

This can ride 118 to release.

[Attachment #9352291](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") -
Flags: approval-mozilla-release? → approval-mozilla-release-

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1852218#c15)• 1 year ago |
|  | |

Backed out for failing its own test on Spidermonkey ARM64.

<https://hg.mozilla.org/integration/autoland/rev/754947adaad8ea8d87b61fb678ae58db5edb1ea6>

[Push with failures](https://treeherder.mozilla.org/jobs?repo=autoland&group_state=expanded&resultStatus=pending%2Crunning%2Ctestfailed%2Cbusted%2Cexception&revision=754947adaad8ea8d87b61fb678ae58db5edb1ea6&selectedTaskRun=ZimAs-9hT7CzUd9p6lvjqQ.0)

[Failure log](https://treeherder.mozilla.org/logviewer?job_id=428710442&repo=autoland)

> TEST-UNEXPECTED-FAIL | js/src/jit-test/tests/[bug1852218](/show_bug.cgi?id=1852218 "VERIFIED FIXED - Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137").js | Timeout (code -6, args "--fast-warmup --no-threads") [150.3 s]

Flags: needinfo?(iireland)

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1852218#c16)• 1 year ago |
|  | |

Backout by sstanca@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/8cc42aa6860e>
Backed out changeset 754947adaad8 for causing SM bustages in [bug1852218](/show_bug.cgi?id=1852218 "VERIFIED FIXED - Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137").js. CLOSED TREE

|  | [Iain Ireland [:iain]](/user_profile?user_id=623993)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1852218#c17)• 1 year ago |
|  | |

Weird. I don't see why this test should be especially slow in the simulator.

It should be fine to disable this in the arm64 simulator, anyway.

Flags: needinfo?(iireland)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a311398_600971)• 1 year ago |

[Attachment #9352291](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") -
Attachment description: Bug 1852218: Remove old hints after adding new hints r=dpalmeiro → Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1852218#c18)• 1 year ago |
|  | |

Pushed by iireland@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/78b325d096c9>
Remove old hints after adding new hints r=dpalmeiro

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a375193_422187)• 1 year ago |

Blocks: [sm-jits](/show_bug.cgi?id=1729516 "NEW - [meta] Just-In-Time Compilers")Severity: -- → S4Priority: -- → P1

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1852218#c19)• 1 year ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/78b325d096c9>

Group: javascript-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 1 year ago
[status-firefox119](/buglist.cgi?f1=cf_status_firefox119&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 119 Branch

|  | [Bugmon [:jkratzer for issues]](/user_profile?user_id=676404) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1852218#c20)• 1 year ago |
|  | |

Verified bug as fixed on rev mozilla-central 20230912163015-fc9333c3b9f7.

Removing bugmon keyword as no further action possible. Please review the bug and re-add the keyword for further analysis.

Status: RESOLVED → VERIFIED
[status-firefox119](/buglist.cgi?f1=cf_status_firefox119&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox119&o1=equals&v1=verified)Keywords: [bugmon](/buglist.cgi?keywords=bugmon&resolution=---)

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1852218#c21)• 1 year ago |
|  | |

Comment on [attachment 9352291](/attachment.cgi?id=9352291 "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") [[details]](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!")

[Bug 1852218](/show_bug.cgi?id=1852218 "VERIFIED FIXED - Assertion failure: aPtr.mMutationCount == mMutationCount, at dist/include/mozilla/HashTable.h:2137"): Remove old hints after adding new hints r=dpalmeiro!

Approved for 118.0b9 (last beta) thanks.

[Attachment #9352291](/attachment.cgi?id=9352291&action=edit "Bug 1852218: Remove old hints after adding new hints r=dpalmeiro!") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1852218#c22)• 1 year ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/3694c9cea635>

|  | [Pascal Chevrel:pascalc](/user_profile?user_id=24572) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a462332_24572)• 1 year ago |

[status-firefox118](/buglist.cgi?f1=cf_status_firefox118&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox118&o1=equals&v1=fixed)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a889651_578488)• 1 year ago |

Whiteboard: [bugmon:update,bisected,confirmed] → [bugmon:update,bisected,confirmed] [adv-main118+]r

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a1148406_578488)• 1 year ago |

Whiteboard: [bugmon:update,bisected,confirmed] [adv-main118+]r → [bugmon:update,bisected,confirmed] [adv-main118+r]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1852218#c23)• 1 year ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9354379)
— [Details](attachment.cgi?id=9354379&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a10194742_1689)• 1 year ago |

Group: core-security-release

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1852218#a10199706_1689)• 1 year ago |

Alias: CVE-2023-5172
You need to [log in](/show_bug.cgi?id=1852218&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Christian Holler (:decoder)](/user_profile?user_id=395101)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


