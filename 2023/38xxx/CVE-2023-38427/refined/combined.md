=== Content from cdn.kernel.org_8bb1e92b_20250114_185202.html ===
commit f2427f9a3730e9a1a11b69f6b767f7f2fad87523
Author: Greg Kroah-Hartman
Date: Wed Jun 14 11:17:06 2023 +0200
Linux 6.3.8
Link: https://lore.kernel.org/r/20230612101715.129581706@linuxfoundation.org
Tested-by: Ronald Warsow
Tested-by: Allen Pais
Tested-by: Chris Paterson (CIP)
Tested-by: Shuah Khan
Tested-by: Bagas Sanjaya
Tested-by: Ron Economos
Tested-by: Linux Kernel Functional Testing
Tested-by: Jon Hunter
Tested-by: Conor Dooley
Tested-by: Sudip Mukherjee
Tested-by: Rudi Heitbaum
Tested-by: Salvatore Bonaccorso
Tested-by: Justin M. Forbes
Tested-by: Guenter Roeck
Signed-off-by: Greg Kroah-Hartman
commit ae1e575368e3d2e4951eebead7c4fa907c7adc05
Author: Greg Kroah-Hartman
Date: Mon Jun 12 12:06:32 2023 +0200
Revert "staging: rtl8192e: Replace macro RTL\_PCI\_DEVICE with PCI\_DEVICE"
This reverts commit 21d58e5ac3062e931d9f5a9eb58a6caacb910856 which is
commit fda2093860df4812d69052a8cf4997e53853a340 upstream.
Ben reports that this should not have been backported to the older
kernels as the rest of the macro is not empty. It was a clean-up patch
in 6.4-rc1 only, it did not add new device ids.
Reported-by: Ben Hutchings
Cc: Philipp Hortmann
Cc: Sasha Levin
Link: https://lore.kernel.org/r/aa0d401a7f63448cd4c2fe4a2d7e8495d9aa123e.camel@decadent.org.uk
Signed-off-by: Greg Kroah-Hartman
commit ee32e3e86530597e92ba8835fd170be1404f5b66
Author: Ping-Ke Shih
Date: Sat May 27 16:29:37 2023 +0800
wifi: rtw88: correct PS calculation for SUPPORTS\_DYNAMIC\_PS
commit 3918dd0177ee08970683a2c22a3388825d82fd79 upstream.
This driver relies on IEEE80211\_CONF\_PS of hw->conf.flags to turn off PS or
turn on dynamic PS controlled by driver and firmware. Though this would be
incorrect, it did work before because the flag is always recalculated until
the commit 28977e790b5d ("wifi: mac80211: skip powersave recalc if driver SUPPORTS\_DYNAMIC\_PS")
is introduced by kernel 5.20 to skip to recalculate IEEE80211\_CONF\_PS
of hw->conf.flags if driver sets SUPPORTS\_DYNAMIC\_PS.
Correct this by doing recalculation while BSS\_CHANGED\_PS is changed and
interface is added or removed. It is allowed to enter PS only if single
one station vif is working. Without this fix, driver doesn't enter PS
anymore that causes higher power consumption.
Fixes: bcde60e599fb ("rtw88: remove misleading module parameter rtw\_fw\_support\_lps")
Cc: stable@vger.kernel.org # 6.1+
Signed-off-by: Ping-Ke Shih
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230527082939.11206-2-pkshih@realtek.com
Signed-off-by: Greg Kroah-Hartman
commit c009ddc88325ec508f3fd3da646d0f19ebf1bbb1
Author: Ping-Ke Shih
Date: Sat May 27 16:29:38 2023 +0800
wifi: rtw89: correct PS calculation for SUPPORTS\_DYNAMIC\_PS
commit 26a125f550a3bf86ac91d38752f4d446426dfe1c upstream.
This driver relies on IEEE80211\_CONF\_PS of hw->conf.flags to turn off PS or
turn on dynamic PS controlled by driver and firmware. Though this would be
incorrect, it did work before because the flag is always recalculated until
the commit 28977e790b5d ("wifi: mac80211: skip powersave recalc if driver SUPPORTS\_DYNAMIC\_PS")
is introduced by kernel 5.20 to skip to recalculate IEEE80211\_CONF\_PS
of hw->conf.flags if driver sets SUPPORTS\_DYNAMIC\_PS.
Correct this by doing recalculation while BSS\_CHANGED\_PS is changed and
interface is added or removed. For now, it is allowed to enter PS only if
single one station vif is working, and it could possible to have PS per
vif after firmware can support it. Without this fix, driver doesn't
enter PS anymore that causes higher power consumption.
Fixes: e3ec7017f6a2 ("rtw89: add Realtek 802.11ax driver")
Cc: stable@vger.kernel.org # 6.1+
Signed-off-by: Ping-Ke Shih
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/20230527082939.11206-3-pkshih@realtek.com
Signed-off-by: Greg Kroah-Hartman
commit ae9517ee037d8061b2f296828e2bb8fd9ea20b3d
Author: Theodore Ts'o
Date: Thu Jun 8 10:06:40 2023 -0400
ext4: only check dquot\_initialize\_needed() when debugging
commit dea9d8f7643fab07bf89a1155f1f94f37d096a5e upstream.
ext4\_xattr\_block\_set() relies on its caller to call dquot\_initialize()
on the inode. To assure that this has happened there are WARN\_ON
checks. Unfortunately, this is subject to false positives if there is
an antagonist thread which is flipping the file system at high rates
between r/o and rw. So only do the check if EXT4\_XATTR\_DEBUG is
enabled.
Link: https://lore.kernel.org/r/20230608044056.GA1418535@mit.edu
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit e7469a611403d53d53d779e089fe3ee37aac14a7
Author: Theodore Ts'o
Date: Thu Jun 8 09:57:04 2023 -0400
Revert "ext4: don't clear SB\_RDONLY when remounting r/w until quota is re-enabled"
commit 1b29243933098cdbc31b579b5616e183b4275e2f upstream.
This reverts commit a44be64bbecb15a452496f60db6eacfee2b59c79.
Link: https://lore.kernel.org/r/653b3359-2005-21b1-039d-c55ca4cffdcc@gmail.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit b0167893c00e25a8ac99876e30334138a27e21a1
Author: Ruihan Li
Date: Wed May 3 21:39:36 2023 +0800
Bluetooth: Fix UAF in hci\_conn\_hash\_flush again
commit a2ac591cb4d83e1f2d4b4adb3c14b2c79764650a upstream.
Commit 06149746e720 ("Bluetooth: hci\_conn: Add support for linking
multiple hcon") reintroduced a previously fixed bug [1] ("KASAN:
slab-use-after-free Read in hci\_conn\_hash\_flush"). This bug was
originally fixed by commit 5dc7d23e167e ("Bluetooth: hci\_conn: Fix
possible UAF").
The hci\_conn\_unlink function was added to avoid invalidating the link
traversal caused by successive hci\_conn\_del operations releasing extra
connections. However, currently hci\_conn\_unlink itself also releases
extra connections, resulted in the reintroduced bug.
This patch follows a more robust solution for cleaning up all
connections, by repeatedly removing the first connection until there are
none left. This approach does not rely on the inner workings of
hci\_conn\_del and ensures proper cleanup of all connections.
Meanwhile, we need to make sure that hci\_conn\_del never fails. Indeed it
doesn't, as it now always returns zero. To make this a bit clearer, this
patch also changes its return type to void.
Reported-by: syzbot+8bb72f86fc823817bc5d@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-bluetooth/000000000000aa920505f60d25ad@google.com/
Fixes: 06149746e720 ("Bluetooth: hci\_conn: Add support for linking multiple hcon")
Signed-off-by: Ruihan Li
Co-developed-by: Luiz Augusto von Dentz
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit f864d47132a2bad7b4a71a5abfcf3f784658d93d
Author: Ruihan Li
Date: Wed May 3 21:39:35 2023 +0800
Bluetooth: Refcnt drop must be placed last in hci\_conn\_unlink
commit 2910431ab0e500dfc5df12299bb15eef0f30b43e upstream.
If hci\_conn\_put(conn->parent) reduces conn->parent's reference count to
zero, it can immediately deallocate conn->parent. At the same time,
conn->link->list has its head in conn->parent, causing use-after-free
problems in the latter list\_del\_rcu(&conn->link->list).
This problem can be easily solved by reordering the two operations,
i.e., first performing the list removal with list\_del\_rcu and then
decreasing the refcnt with hci\_conn\_put.
Reported-by: Luiz Augusto von Dentz
Closes: https://lore.kernel.org/linux-bluetooth/CABBYNZ+1kce8\_RJrLNOXd\_8=Mdpb=2bx4Nto-hFORk=qiOkoCg@mail.gmail.com/
Fixes: 06149746e720 ("Bluetooth: hci\_conn: Add support for linking multiple hcon")
Signed-off-by: Ruihan Li
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 75e35bd4b7935ceed2aacd82f55940e73bf0b63b
Author: Ruihan Li
Date: Wed May 3 21:39:34 2023 +0800
Bluetooth: Fix potential double free caused by hci\_conn\_unlink
commit ca1fd42e7dbfcb34890ffbf1f2f4b356776dab6f upstream.
The hci\_conn\_unlink function is being called by hci\_conn\_del, which
means it should not call hci\_conn\_del with the input parameter conn
again. If it does, conn may have already been released when
hci\_conn\_unlink returns, leading to potential UAF and double-free
issues.
This patch resolves the problem by modifying hci\_conn\_unlink to release
only conn's child links when necessary, but never release conn itself.
Reported-by: syzbot+690b90b14f14f43f4688@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-bluetooth/000000000000484a8205faafe216@google.com/
Fixes: 06149746e720 ("Bluetooth: hci\_conn: Add support for linking multiple hcon")
Signed-off-by: Ruihan Li
Signed-off-by: Luiz Augusto von Dentz
Reported-by: syzbot+690b90b14f14f43f4688@syzkaller.appspotmail.com
Reported-by: Luiz Augusto von Dentz
Reported-by: syzbot+8bb72f86fc823817bc5d@syzkaller.appspotmail.com
Signed-off-by: Greg Kroah-Hartman
commit e9cb7be2fcbaee9e808b729e92948d38d52e5add
Author: Namjae Jeon
Date: Tue May 30 23:10:31 2023 +0900
ksmbd: check the validation of pdu\_size in ksmbd\_conn\_handler\_loop
commit 368ba06881c395f1c9a7ba22203cf8d78b4addc0 upstream.
The length field of netbios header must be greater than the SMB header
sizes(smb1 or smb2 header), otherwise the packet is an invalid SMB packet.
If `pdu\_size` is 0, ksmbd allocates a 4 bytes chunk to `conn->request\_buf`.
In the function `get\_smb2\_cmd\_val` ksmbd will read cmd from
`rcv\_hdr->Command`, which is `conn->request\_buf + 12`, causing the KASAN
detector to print the following error message:
[ 7.205018] BUG: KASAN: slab-out-of-bounds in get\_smb2\_cmd\_val+0x45/0x60
[ 7.205423] Read of size 2 at addr ffff8880062d8b50 by task ksmbd:42632/248
...
[ 7.207125]
[ 7.209191] get\_smb2\_cmd\_val+0x45/0x60
[ 7.209426] ksmbd\_conn\_enqueue\_request+0x3a/0x100
[ 7.209712] ksmbd\_server\_process\_request+0x72/0x160
[ 7.210295] ksmbd\_conn\_handler\_loop+0x30c/0x550
[ 7.212280] kthread+0x160/0x190
[ 7.212762] ret\_from\_fork+0x1f/0x30
[ 7.212981]
Cc: stable@vger.kernel.org
Reported-by: Chih-Yen Chang
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit ed75e6a5a5b5dfed211054dbb2a18ffe05439838
Author: Namjae Jeon
Date: Tue May 30 21:42:34 2023 +0900
ksmbd: fix posix\_acls and acls dereferencing possible ERR\_PTR()
commit 25933573ef48f3586f559c2cac6c436c62dcf63f upstream.
Dan reported the following error message:
fs/smb/server/smbacl.c:1296 smb\_check\_perm\_dacl()
error: 'posix\_acls' dereferencing possible ERR\_PTR()
fs/smb/server/vfs.c:1323 ksmbd\_vfs\_make\_xattr\_posix\_acl()
error: 'posix\_acls' dereferencing possible ERR\_PTR()
fs/smb/server/vfs.c:1830 ksmbd\_vfs\_inherit\_posix\_acl()
error: 'acls' dereferencing possible ERR\_PTR()
\_\_get\_acl() returns a mix of error pointers and NULL. This change it
with IS\_ERR\_OR\_NULL().
Fixes: e2f34481b24d ("cifsd: add server-side procedures for SMB3")
Cc: stable@vger.kernel.org
Reported-by: Dan Carpenter
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 61dfe01204daf5469f21cc639f710f9e28e929c8
Author: Namjae Jeon
Date: Sun May 28 00:23:41 2023 +0900
ksmbd: fix out-of-bound read in parse\_lease\_state()
commit fc6c6a3c324c1b3e93a03d0cfa3749c781f23de0 upstream.
This bug is in parse\_lease\_state, and it is caused by the missing check
of `struct create\_context`. When the ksmbd traverses the create\_contexts,
it doesn't check if the field of `NameOffset` and `Next` is valid,
The KASAN message is following:
[ 6.664323] BUG: KASAN: slab-out-of-bounds in parse\_lease\_state+0x7d/0x280
[ 6.664738] Read of size 2 at addr ffff888005c08988 by task kworker/0:3/103
...
[ 6.666644] Call Trace:
[ 6.666796]
[ 6.666933] dump\_stack\_lvl+0x33/0x50
[ 6.667167] print\_report+0xcc/0x620
[ 6.667903] kasan\_report+0xae/0xe0
[ 6.668374] kasan\_check\_range+0x35/0x1b0
[ 6.668621] parse\_lease\_state+0x7d/0x280
[ 6.668868] smb2\_open+0xbe8/0x4420
[ 6.675137] handle\_ksmbd\_work+0x282/0x820
Use smb2\_find\_context\_vals() to find smb2 create request lease context.
smb2\_find\_context\_vals validate create context fields.
Cc: stable@vger.kernel.org
Reported-by: Chih-Yen Chang
Tested-by: Chih-Yen Chang
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 205279b96b5c40c60c6de4f9342416e02ee279f1
Author: Namjae Jeon
Date: Sun May 28 00:23:09 2023 +0900
ksmbd: fix out-of-bound read in deassemble\_neg\_contexts()
commit f1a411873c85b642f13b01f21b534c2bab81fc1b upstream.
The check in the beginning is
`clen + sizeof(struct smb2\_neg\_context) <= len\_of\_ctxts`,
but in the end of loop, `len\_of\_ctxts` will subtract
`((clen + 7) & ~0x7) + sizeof(struct smb2\_neg\_context)`, which causes
integer underflow when clen does the 8 alignment. We should use
`(clen + 7) & ~0x7` in the check to avoid underflow from happening.
Then there are some variables that need to be declared unsigned
instead of signed.
[ 11.671070] BUG: KASAN: slab-out-of-bounds in smb2\_handle\_negotiate+0x799/0x1610
[ 11.671533] Read of size 2 at addr ffff888005e86cf2 by task kworker/0:0/7
...
[ 11.673383] Call Trace:
[ 11.673541]
[ 11.673679] dump\_stack\_lvl+0x33/0x50
[ 11.673913] print\_report+0xcc/0x620
[ 11.674671] kasan\_report+0xae/0xe0
[ 11.675171] kasan\_check\_range+0x35/0x1b0
[ 11.675412] smb2\_handle\_negotiate+0x799/0x1610
[ 11.676217] ksmbd\_smb\_negotiate\_common+0x526/0x770
[ 11.676795] handle\_ksmbd\_work+0x274/0x810
...
Cc: stable@vger.kernel.org
Signed-off-by: Chih-Yen Chang
Tested-by: Chih-Yen Chang
Signed-off-by: Namjae Jeon
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit eb08dc8762d15a60575ba97d58cb90236f20e04a
Author: Shannon Nelson
Date: Mon Apr 24 15:50:31 2023 -0700
vhost\_vdpa: support PACKED when setting-getting vring\_base
[ Upstream commit beee7fdb5b56a46415a4992d28dd4c2d06eb52df ]
Use the right structs for PACKED or split vqs when setting and
getting the vring base.
Fixes: 4c8cf31885f6 ("vhost: introduce vDPA-based backend")
Signed-off-by: Shannon Nelson
Message-Id: <20230424225031.18947-4-shannon.nelson@amd.com>
Signed-off-by: Michael S. Tsirkin
Acked-by: Jason Wang
Signed-off-by: Sasha Levin
commit ef817ef00a99ee36ff8aff72f1b715675b806633
Author: Shannon Nelson
Date: Mon Apr 24 15:50:30 2023 -0700
vhost: support PACKED when setting-getting vring\_base
[ Upstream commit 55d8122f5cd62d5aaa225d7167dcd14a44c850b9 ]
Use the right structs for PACKED or split vqs when setting and
getting the vring base.
Fixes: 4c8cf31885f6 ("vhost: introduce vDPA-based backend")
Signed-off-by: Shannon Nelson
Message-Id: <20230424225031.18947-3-shannon.nelson@amd.com>
Signed-off-by: Michael S. Tsirkin
Acked-by: Jason Wang
Signed-off-by: Sasha Levin
commit 6391fe9de0132af62f369e079332caee148f41b5
Author: Dragos Tatulea
Date: Tue May 16 12:58:01 2023 +0300
vdpa/mlx5: Fix hang when cvq commands are triggered during device unregister
[ Upstream commit 73790bdfba076c0886f0f14fd46ff2c70ee31ce9 ]
Currently the vdpa device is unregistered after the workqueue that
processes vq commands is disabled. However, the device unregister
process can still send commands to the cvq (a vlan delete for example)
which leads to a hang because the handing workqueue has been disabled
and the command never finishes:
[ 2263.095764] rcu: INFO: rcu\_sched self-detected stall on CPU
[ 2263.096307] rcu: 9-....: (5250 ticks this GP) idle=dac4/1/0x4000000000000000 softirq=111009/111009 fqs=2544
[ 2263.097154] rcu: (t=5251 jiffies g=393549 q=347 ncpus=10)
[ 2263.097648] CPU: 9 PID: 94300 Comm: kworker/u20:2 Not tainted 6.3.0-rc6\_for\_upstream\_min\_debug\_2023\_04\_14\_00\_02 #1
[ 2263.098535] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 2263.099481] Workqueue: mlx5\_events mlx5\_vhca\_state\_work\_handler [mlx5\_core]
[ 2263.100143] RIP: 0010:virtnet\_send\_command+0x109/0x170
[ 2263.100621] Code: 1d df f5 ff 85 c0 78 5c 48 8b 7b 08 e8 d0 c5 f5 ff 84 c0 75 11 eb 22 48 8b 7b 08 e8 01 b7 f5 ff 84 c0 75 15 f3 90 48 8b 7b 08 <48> 8d 74 24 04 e8 8d c5 f5 ff 48 85 c0 74 de 48 8b 83 f8 00 00 00
[ 2263.102148] RSP: 0018:ffff888139cf36e8 EFLAGS: 00000246
[ 2263.102624] RAX: 0000000000000000 RBX: ffff888166bea940 RCX: 0000000000000001
[ 2263.103244] RDX: 0000000000000000 RSI: ffff888139cf36ec RDI: ffff888146763800
[ 2263.103864] RBP: ffff888139cf3710 R08: ffff88810d201000 R09: 0000000000000000
[ 2263.104473] R10: 0000000000000002 R11: 0000000000000003 R12: 0000000000000002
[ 2263.105082] R13: 0000000000000002 R14: ffff888114528400 R15: ffff888166bea000
[ 2263.105689] FS: 0000000000000000(0000) GS:ffff88852cc80000(0000) knlGS:0000000000000000
[ 2263.106404] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 2263.106925] CR2: 00007f31f394b000 CR3: 000000010615b006 CR4: 0000000000370ea0
[ 2263.107542] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 2263.108163] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 2263.108769] Call Trace:
[ 2263.109059]
[ 2263.109320] ? check\_preempt\_wakeup+0x11f/0x230
[ 2263.109750] virtnet\_vlan\_rx\_kill\_vid+0x5a/0xa0
[ 2263.110180] vlan\_vid\_del+0x9c/0x170
[ 2263.110546] vlan\_device\_event+0x351/0x760 [8021q]
[ 2263.111004] raw\_notifier\_call\_chain+0x41/0x60
[ 2263.111426] dev\_close\_many+0xcb/0x120
[ 2263.111808] unregister\_netdevice\_many\_notify+0x130/0x770
[ 2263.112297] ? wq\_worker\_running+0xa/0x30
[ 2263.112688] unregister\_netdevice\_queue+0x89/0xc0
[ 2263.113128] unregister\_netdev+0x18/0x20
[ 2263.113512] virtnet\_remove+0x4f/0x230
[ 2263.113885] virtio\_dev\_remove+0x31/0x70
[ 2263.114273] device\_release\_driver\_internal+0x18f/0x1f0
[ 2263.114746] bus\_remove\_device+0xc6/0x130
[ 2263.115146] device\_del+0x173/0x3c0
[ 2263.115502] ? kernfs\_find\_ns+0x35/0xd0
[ 2263.115895] device\_unregister+0x1a/0x60
[ 2263.116279] unregister\_virtio\_device+0x11/0x20
[ 2263.116706] device\_release\_driver\_internal+0x18f/0x1f0
[ 2263.117182] bus\_remove\_device+0xc6/0x130
[ 2263.117576] device\_del+0x173/0x3c0
[ 2263.117929] ? vdpa\_dev\_remove+0x20/0x20 [vdpa]
[ 2263.118364] device\_unregister+0x1a/0x60
[ 2263.118752] mlx5\_vdpa\_dev\_del+0x4c/0x80 [mlx5\_vdpa]
[ 2263.119232] vdpa\_match\_remove+0x21/0x30 [vdpa]
[ 2263.119663] bus\_for\_each\_dev+0x71/0xc0
[ 2263.120054] vdpa\_mgmtdev\_unregister+0x57/0x70 [vdpa]
[ 2263.120520] mlx5v\_remove+0x12/0x20 [mlx5\_vdpa]
[ 2263.120953] auxiliary\_bus\_remove+0x18/0x30
[ 2263.121356] device\_release\_driver\_internal+0x18f/0x1f0
[ 2263.121830] bus\_remove\_device+0xc6/0x130
[ 2263.122223] device\_del+0x173/0x3c0
[ 2263.122581] ? devl\_param\_driverinit\_value\_get+0x29/0x90
[ 2263.123070] mlx5\_rescan\_drivers\_locked+0xc4/0x2d0 [mlx5\_core]
[ 2263.123633] mlx5\_unregister\_device+0x54/0x80 [mlx5\_core]
[ 2263.124169] mlx5\_uninit\_one+0x54/0x150 [mlx5\_core]
[ 2263.124656] mlx5\_sf\_dev\_remove+0x45/0x90 [mlx5\_core]
[ 2263.125153] auxiliary\_bus\_remove+0x18/0x30
[ 2263.125560] device\_release\_driver\_internal+0x18f/0x1f0
[ 2263.126052] bus\_remove\_device+0xc6/0x130
[ 2263.126451] device\_del+0x173/0x3c0
[ 2263.126815] mlx5\_sf\_dev\_remove+0x39/0xf0 [mlx5\_core]
[ 2263.127318] mlx5\_sf\_dev\_state\_change\_handler+0x178/0x270 [mlx5\_core]
[ 2263.127920] blocking\_notifier\_call\_chain+0x5a/0x80
[ 2263.128379] mlx5\_vhca\_state\_work\_handler+0x151/0x200 [mlx5\_core]
[ 2263.128951] process\_one\_work+0x1bb/0x3c0
[ 2263.129355] ? process\_one\_work+0x3c0/0x3c0
[ 2263.129766] worker\_thread+0x4d/0x3c0
[ 2263.130140] ? process\_one\_work+0x3c0/0x3c0
[ 2263.130548] kthread+0xb9/0xe0
[ 2263.130895] ? kthread\_complete\_and\_exit+0x20/0x20
[ 2263.131349] ret\_from\_fork+0x1f/0x30
[ 2263.131717]
The fix is to disable and destroy the workqueue after the device
unregister. It is expected that vhost will not trigger kicks after
the unregister. But even if it would, the wq is disabled already by
setting the pointer to NULL (done so in the referenced commit).
Fixes: ad6dc1daaf29 ("vdpa/mlx5: Avoid processing works if workqueue was destroyed")
Signed-off-by: Dragos Tatulea
Message-Id: <20230516095800.3549932-1-dtatulea@nvidia.com>
Signed-off-by: Michael S. Tsirkin
Reviewed-by: Tariq Toukan
Acked-by: Jason Wang
Signed-off-by: Sasha Levin
commit 76364a97be5fbf57358d73fd3cb66b088c48615a
Author: Sheng Zhao
Date: Tue May 30 11:36:26 2023 +0800
vduse: avoid empty string for dev name
[ Upstream commit a90e8608eb0ed93d31ac0feb055f77ce59512542 ]
Syzkaller hits a kernel WARN when the first character of the dev name
provided is NULL. Solution is to add a NULL check before calling
cdev\_device\_add() in vduse\_create\_dev().
kobject: (0000000072042169): attempted to be registered with empty name!
WARNING: CPU: 0 PID: 112695 at lib/kobject.c:236
Call Trace:
kobject\_add\_varg linux/src/lib/kobject.c:390 [inline]
kobject\_add+0xf6/0x150 linux/src/lib/kobject.c:442
device\_add+0x28f/0xc20 linux/src/drivers/base/core.c:2167
cdev\_device\_add+0x83/0xc0 linux/src/fs/char\_dev.c:546
vduse\_create\_dev linux/src/drivers/vdpa/vdpa\_user/vduse\_dev.c:2254 [inline]
vduse\_ioctl+0x7b5/0xf30 linux/src/drivers/vdpa/vdpa\_user/vduse\_dev.c:2316
vfs\_ioctl linux/src/fs/ioctl.c:47 [inline]
file\_ioctl linux/src/fs/ioctl.c:510 [inline]
do\_vfs\_ioctl+0x14b/0xa80 linux/src/fs/ioctl.c:697
ksys\_ioctl+0x7c/0xa0 linux/src/fs/ioctl.c:714
\_\_do\_sys\_ioctl linux/src/fs/ioctl.c:721 [inline]
\_\_se\_sys\_ioctl linux/src/fs/ioctl.c:719 [inline]
\_\_x64\_sys\_ioctl+0x42/0x50 linux/src/fs/ioctl.c:719
do\_syscall\_64+0x94/0x330 linux/src/arch/x86/entry/common.c:291
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
Fixes: c8a6153b6c59 ("vduse: Introduce VDUSE - vDPA Device in Userspace")
Cc: "Xie Yongji"
Reported-by: Xianjun Zeng
Signed-off-by: Sheng Zhao
Message-Id: <20230530033626.1266794-1-sheng.zhao@bytedance.com>
Signed-off-by: Michael S. Tsirkin
Acked-by: Jason Wang
Reviewed-by: Xie Yongji
Cc: "Michael S. Tsirkin", "Jason Wang",
Reviewed-by: Xie Yongji
Signed-off-by: Sasha Levin
commit ddfc58117c6f16524acbf22bbb8b7ccbb5ad34f5
Author: Ruan Jinjie
Date: Thu May 4 15:29:10 2023 +0800
riscv: fix kprobe \_\_user string arg print fault issue
[ Upstream commit 99a670b2069c725a7b50318aa681d9cae8f89325 ]
On riscv qemu platform, when add kprobe event on do\_sys\_open() to show
filename string arg, it just print fault as follow:
echo 'p:myprobe do\_sys\_open dfd=$arg1 filename=+0($arg2):string flags=$arg3
mode=$arg4' > kprobe\_events
bash-166 [000] ...1. 360.195367: myprobe: (do\_sys\_open+0x0/0x84)
dfd=0xffffffffffffff9c filename=(fault) flags=0x8241 mode=0x1b6
bash-166 [000] ...1. 360.219369: myprobe: (do\_sys\_open+0x0/0x84)
dfd=0xffffffffffffff9c filename=(fault) flags=0x8241 mode=0x1b6
bash-191 [000] ...1. 360.378827: myprobe: (do\_sys\_open+0x0/0x84)
dfd=0xffffffffffffff9c filename=(fault) flags=0x98800 mode=0x0
As riscv do not select ARCH\_HAS\_NON\_OVERLAPPING\_ADDRESS\_SPACE,
the +0($arg2) addr is processed as a kernel address though it is a
userspace address, cause the above filename=(fault) print. So select
ARCH\_HAS\_NON\_OVERLAPPING\_ADDRESS\_SPACE to avoid the issue, after that the
kprobe trace is ok as below:
bash-166 [000] ...1. 96.767641: myprobe: (do\_sys\_open+0x0/0x84)
dfd=0xffffffffffffff9c filename="/dev/null" flags=0x8241 mode=0x1b6
bash-166 [000] ...1. 96.793751: myprobe: (do\_sys\_open+0x0/0x84)
dfd=0xffffffffffffff9c filename="/dev/null" flags=0x8241 mode=0x1b6
bash-177 [000] ...1. 96.962354: myprobe: (do\_sys\_open+0x0/0x84)
dfd=0xffffffffffffff9c filename="/sys/kernel/debug/tracing/events/kprobes/"
flags=0x98800 mode=0x0
Signed-off-by: Ruan Jinjie
Acked-by: Björn Töpel
Fixes: 0ebeea8ca8a4 ("bpf: Restrict bpf\_probe\_read{, str}() only to archs where they work")
Link: https://lore.kernel.org/r/20230504072910.3742842-1-ruanjinjie@huawei.com
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit d270475cf3f3e8d9a82bfb40a14cfb03d6ce40d5
Author: Charles Keepax
Date: Fri Jun 2 11:11:36 2023 +0100
soundwire: stream: Add missing clear of alloc\_slave\_rt
[ Upstream commit 58d95889f3c2064c6139ee94bb0e4d86e1ad4eab ]
The current path that skips allocating the slave runtime does not clear
the alloc\_slave\_rt flag, this is clearly incorrect. Add the missing
clear, so the runtime won't be erroneously cleaned up.
Fixes: f3016b891c8c ("soundwire: stream: sdw\_stream\_add\_ functions can be called multiple times")
Reviewed-by: Pierre-Louis Bossart
Signed-off-by: Charles Keepax
Link: https://lore.kernel.org/r/20230602101140.2040141-1-ckeepax@opensource.cirrus.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 0171d0c73ec660a9e9c7342ffecf246a168c9532
Author: Randy Dunlap
Date: Wed Jun 7 19:54:24 2023 -0700
eeprom: at24: also select REGMAP
[ Upstream commit 7f3c782b3914e510b646a77aedc3adeac2e4a63b ]
Selecting only REGMAP\_I2C can leave REGMAP unset, causing build errors,
so also select REGMAP to prevent the build errors.
../drivers/misc/eeprom/at24.c:540:42: warning: 'struct regmap\_config' declared inside parameter list will not be visible outside of this definition or declaration
540 | struct regmap\_config \*regmap\_config)
../drivers/misc/eeprom/at24.c: In function 'at24\_make\_dummy\_client':
../drivers/misc/eeprom/at24.c:552:18: error: implicit declaration of function 'devm\_regmap\_init\_i2c' [-Werror=implicit-function-declaration]
552 | regmap = devm\_regmap\_init\_i2c(dummy\_client, regmap\_config);
../drivers/misc/eeprom/at24.c:552:16: warning: assignment to 'struct regmap \*' from 'int' makes pointer from integer without a cast [-Wint-conversion]
552 | regmap = devm\_regmap\_init\_i2c(dummy\_client, regmap\_config);
../drivers/misc/eeprom/at24.c: In function 'at24\_probe':
../drivers/misc/eeprom/at24.c:586:16: error: variable 'regmap\_config' has initializer but incomplete type
586 | struct regmap\_config regmap\_config = { };
../drivers/misc/eeprom/at24.c:586:30: error: storage size of 'regmap\_config' isn't known
586 | struct regmap\_config regmap\_config = { };
../drivers/misc/eeprom/at24.c:586:30: warning: unused variable 'regmap\_config' [-Wunused-variable]
Fixes: 5c015258478e ("eeprom: at24: add basic regmap\_i2c support")
Signed-off-by: Randy Dunlap
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Sasha Levin
commit ea035a20a461e7bf632ae5e5167662d3459ba215
Author: Hsieh-Tseng Shen
Date: Tue Apr 25 18:28:28 2023 +0800
riscv: mm: Ensure prot of VM\_WRITE and VM\_EXEC must be readable
[ Upstream commit 6569fc12e442ea973d96db39e542aa19a7bc3a79 ]
Commit 8aeb7b17f04e ("RISC-V: Make mmap() with PROT\_WRITE imply PROT\_READ")
allows riscv to use mmap with PROT\_WRITE only, and meanwhile mmap with w+x
is also permitted. However, when userspace tries to access this page with
PROT\_WRITE|PROT\_EXEC, which causes infinite loop at load page fault as
well as it triggers soft lockup. According to riscv privileged spec,
"Writable pages must also be marked readable". The fix to drop the
`PAGE\_COPY\_READ\_EXEC` and then `PAGE\_COPY\_EXEC` would be just used instead.
This aligns the other arches (i.e arm64) for protection\_map.
Fixes: 8aeb7b17f04e ("RISC-V: Make mmap() with PROT\_WRITE imply PROT\_READ")
Signed-off-by: Hsieh-Tseng Shen
Reviewed-by: Alexandre Ghiti
Link: https://lore.kernel.org/r/20230425102828.1616812-1-woodrow.shen@sifive.com
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit b18c218585d0ef1228c77aa78698717182abfd6d
Author: Uwe Kleine-König
Date: Thu Mar 9 10:58:19 2023 +0100
i2c: sprd: Delete i2c adapter in .remove's error path
[ Upstream commit ca0aa17f2db3468fd017038d23a78e17388e2f67 ]
If pm runtime resume fails the .remove callback used to exit early. This
resulted in an error message by the driver core but the device gets
removed anyhow. This lets the registered i2c adapter stay around with an
unbound parent device.
So only skip clk disabling if resume failed, but do delete the adapter.
Fixes: 8b9ec0719834 ("i2c: Add Spreadtrum I2C controller driver")
Signed-off-by: Uwe Kleine-König
Reviewed-by: Andi Shyti
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit 2a137366586cf97e0d9ce90fc1a9fc67c24f86d3
Author: Kent Gibson
Date: Tue Jun 6 20:00:34 2023 +0800
gpio: sim: fix memory corruption when adding named lines and unnamed hogs
[ Upstream commit 95ae9979bfe3174c2ee8d64409c44532f2881907 ]
When constructing the sim, gpio-sim constructs an array of named lines,
sized based on the largest offset of any named line, and then initializes
that array with the names of all lines, including unnamed hogs with higher
offsets. In doing so it writes NULLs beyond the extent of the array.
Add a check that only named lines are used to initialize the array.
Fixes: cb8c474e79be ("gpio: sim: new testing module")
Signed-off-by: Kent Gibson
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Sasha Levin
commit 2ac1d1f54c228ea31e735e5b80605dc5af4773e7
Author: Balint Dobszay
Date: Thu Jun 1 16:07:49 2023 +0200
firmware: arm\_ffa: Set handle field to zero in memory descriptor
[ Upstream commit 3aa0519a4780f1b8e11966bd879d4a2934ba455f ]
As described in the commit 111a833dc5cb ("firmware: arm\_ffa: Set
reserved/MBZ fields to zero in the memory descriptors") some fields in
the memory descriptor have to be zeroed explicitly. The handle field is
one of these, but it was left out from that change, fix this now.
Fixes: 111a833dc5cb ("firmware: arm\_ffa: Set reserved/MBZ fields to zero in the memory descriptors")
Reported-by: Imre Kis
Signed-off-by: Balint Dobszay
Link: https://lore.kernel.org/r/20230601140749.93812-1-balint.dobszay@arm.com
Signed-off-by: Sudeep Holla
Signed-off-by: Sasha Levin
commit ad2bd77d20983ad58639361f4aadf9085dc757de
Author: Marek Behún
Date: Sun May 21 14:19:40 2023 +0200
i2c: mv64xxx: Fix reading invalid status value in atomic mode
[ Upstream commit 5578d0a79b6430fa1543640dd6f2d397d0886ce7 ]
There seems to be a bug within the mv64xxx I2C controller, wherein the
status register may not necessarily contain valid value immediately
after the IFLG flag is set in the control register.
My theory is that the controller:
- first sets the IFLG in control register
- then updates the status register
- then raises an interrupt
This may sometime cause weird bugs when in atomic mode, since in this
mode we do not wait for an interrupt, but instead we poll the control
register for IFLG and read status register immediately after.
I encountered -ENXIO from mv64xxx\_i2c\_fsm() due to this issue when using
this driver in atomic mode.
Note that I've only seen this issue on Armada 385, I don't know whether
other SOCs with this controller are also affected. Also note that this
fix has been in U-Boot for over 4 years [1] without anybody complaining,
so it should not cause regressions.
[1] https://source.denx.de/u-boot/u-boot/-/commit/d50e29662f78
Fixes: 544a8d75f3d6 ("i2c: mv64xxx: Add atomic\_xfer method to driver")
Signed-off-by: Marek Behún
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit bf37668af4174d694c513be07fd617f0dcced800
Author: Adam Ford
Date: Sun May 28 06:22:54 2023 -0500
arm64: dts: imx8mn-beacon: Fix SPI CS pinmux
[ Upstream commit 9bf2e534313fcf420367668cc1f30e10469901dc ]
The final production baseboard had a different chip select than
earlier prototype boards. When the newer board was released,
the SPI stopped working because the wrong pin was used in the device
tree and conflicted with the UART RTS. Fix the pinmux for
production boards.
Fixes: 36ca3c8ccb53 ("arm64: dts: imx: Add Beacon i.MX8M Nano development kit")
Signed-off-by: Adam Ford
Signed-off-by: Shawn Guo
Signed-off-by: Sasha Levin
commit e15f24ab5c6a183cff1b6d6aec7cce48377f1832
Author: Tian Lan
Date: Sat May 13 18:12:27 2023 -0400
blk-mq: fix blk\_mq\_hw\_ctx active request accounting
[ Upstream commit ddad59331a4e16088468ca0ad228a9fe32d7955a ]
The nr\_active counter continues to increase over time which causes the
blk\_mq\_get\_tag to hang until the thread is rescheduled to a different
core despite there are still tags available.
kernel-stack
INFO: task inboundIOReacto:3014879 blocked for more than 2 seconds
Not tainted 6.1.15-amd64 #1 Debian 6.1.15~debian11
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:inboundIOReacto state:D stack:0 pid:3014879 ppid:4557 flags:0x00000000
Call Trace:
\_\_schedule+0x351/0xa20
scheduler+0x5d/0xe0
io\_schedule+0x42/0x70
blk\_mq\_get\_tag+0x11a/0x2a0
? dequeue\_task\_stop+0x70/0x70
\_\_blk\_mq\_alloc\_requests+0x191/0x2e0
kprobe output showing RQF\_MQ\_INFLIGHT bit is not cleared before
\_\_blk\_mq\_free\_request being called.
320 320 kworker/29:1H \_\_blk\_mq\_free\_request rq\_flags 0x220c0 in-flight 1
b'\_\_blk\_mq\_free\_request+0x1 [kernel]'
b'bt\_iter+0x50 [kernel]'
b'blk\_mq\_queue\_tag\_busy\_iter+0x318 [kernel]'
b'blk\_mq\_timeout\_work+0x7c [kernel]'
b'process\_one\_work+0x1c4 [kernel]'
b'worker\_thread+0x4d [kernel]'
b'kthread+0xe6 [kernel]'
b'ret\_from\_fork+0x1f [kernel]'
Signed-off-by: Tian Lan
Fixes: 2e315dc07df0 ("blk-mq: grab rq->refcount before calling ->fn in blk\_mq\_tagset\_busy\_iter")
Reviewed-by: Ming Lei
Link: https://lore.kernel.org/r/20230513221227.497327-1-tilan7663@gmail.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 721b78b745b2015660d2842606fceb60a143e998
Author: Robert Hancock
Date: Thu Jun 1 19:19:35 2023 -0600
ASoC: simple-card-utils: fix PCM constraint error check
[ Upstream commit 635071f5fee31550e921644b2becc42b3ff1036c ]
The code in asoc\_simple\_startup was treating any non-zero return from
snd\_pcm\_hw\_constraint\_minmax as an error, when this can return 1 in some
normal cases and only negative values indicate an error.
When this happened, it caused asoc\_simple\_startup to disable the clocks
it just enabled and return 1, which was not treated as an error by the
calling code which only checks for negative return values. Then when the
PCM is eventually shut down, it causes the clock framework to complain
about disabling clocks that were not enabled.
Fix the check for snd\_pcm\_hw\_constraint\_minmax return value to only
treat negative values as an error.
Fixes: 5ca2ab459817 ("ASoC: simple-card-utils: Add new system-clock-fixed flag")
Signed-off-by: Robert Hancock
Link: https://lore.kernel.org/r/20230602011936.231931-1-robert.hancock@calian.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit d76b9c2424e76a6cc122334ee34420040c17f253
Author: Trevor Wu
Date: Thu Jun 1 11:33:18 2023 +0800
ASoC: mediatek: mt8195: fix use-after-free in driver remove path
[ Upstream commit dc93f0dcb436dfd24a06c5b3c0f4c5cd9296e8e5 ]
During mt8195\_afe\_init\_clock(), mt8195\_audsys\_clk\_register() was called
followed by several other devm functions. At mt8195\_afe\_deinit\_clock()
located at mt8195\_afe\_pcm\_dev\_remove(), mt8195\_audsys\_clk\_unregister()
was called.
However, there was an issue with the order in which these functions were
called. Specifically, the remove callback of platform\_driver was called
before devres released the resource, resulting in a use-after-free issue
during remove time.
At probe time, the order of calls was:
1. mt8195\_audsys\_clk\_register
2. afe\_priv->clk = devm\_kcalloc
3. afe\_priv->clk[i] = devm\_clk\_get
At remove time, the order of calls was:
1. mt8195\_audsys\_clk\_unregister
3. free afe\_priv->clk[i]
2. free afe\_priv->clk
To resolve the problem, we can utilize devm\_add\_action\_or\_reset() in
mt8195\_audsys\_clk\_register() so that the remove order can be changed to
3->2->1.
Fixes: 6746cc858259 ("ASoC: mediatek: mt8195: add platform driver")
Signed-off-by: Trevor Wu
Reviewed-by: Douglas Anderson
Reviewed-by: AngeloGioacchino Del Regno
Link: https://lore.kernel.org/r/20230601033318.10408-3-trevor.wu@mediatek.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 9d05002879bd97b2abacfcf8b218885c33ecaf73
Author: Uwe Kleine-König
Date: Wed Mar 15 16:06:45 2023 +0100
ASoC: mediatek: mt8195-afe-pcm: Convert to platform remove callback returning void
[ Upstream commit 6461fee68064ba970e3ba90241fe5f5e038aa9d4 ]
The .remove() callback for a platform driver returns an int which makes
many driver authors wrongly assume it's possible to do error handling by
returning an error code. However the value returned is (mostly) ignored
and this typically results in resource leaks. To improve here there is a
quest to make the remove callback return void. In the first step of this
quest all drivers are converted to .remove\_new() which already returns
void.
Trivially convert this driver from always returning zero in the remove
callback to the void returning variant.
Signed-off-by: Uwe Kleine-König
Reviewed-by: AngeloGioacchino Del Regno
Acked-by: Takashi Iwai
Acked-by: Nicolas Ferre
Link: https://lore.kernel.org/r/20230315150745.67084-114-u.kleine-koenig@pengutronix.de
Signed-off-by: Mark Brown
Stable-dep-of: dc93f0dcb436 ("ASoC: mediatek: mt8195: fix use-after-free in driver remove path")
Signed-off-by: Sasha Levin
commit 4ac5abfd3119e04c4ed630ba645dbbc30060b104
Author: Trevor Wu
Date: Thu Jun 1 11:33:17 2023 +0800
ASoC: mediatek: mt8188: fix use-after-free in driver remove path
[ Upstream commit fd67a7a1a22ce47fcbc094c4b6e164c34c652cbe ]
During mt8188\_afe\_init\_clock(), mt8188\_audsys\_clk\_register() was called
followed by several other devm functions. The caller of
mt8188\_afe\_init\_clock() utilized devm\_add\_action\_or\_reset() to call
mt8188\_afe\_deinit\_clock(). However, the order was incorrect, causing a
use-after-free issue during remove time.
At probe time, the order of calls was:
1. mt8188\_audsys\_clk\_register
2. afe\_priv->clk = devm\_kcalloc
3. afe\_priv->clk[i] = devm\_clk\_get
At remove time, the order of calls was:
1. mt8188\_audsys\_clk\_unregister
3. free afe\_priv->clk[i]
2. free afe\_priv->clk
To resolve the problem, it's necessary to move devm\_add\_action\_or\_reset()
to the appropriate position so that the remove order can be 3->2->1.
Fixes: f6b026479b13 ("ASoC: mediatek: mt8188: support audio clock control")
Signed-off-by: Trevor Wu
Reviewed-by: Douglas Anderson
Reviewed-by: AngeloGioacchino Del Regno
Link: https://lore.kernel.org/r/20230601033318.10408-2-trevor.wu@mediatek.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 7588ef142a8f3ab9b40e553cca25fc0965707133
Author: Vijendar Mukunda
Date: Thu May 25 16:59:55 2023 +0530
ASoC: amd: ps: fix for acp\_lock access in pdm driver
[ Upstream commit b6b5c6426efe27cbd954409a50604d99c79bd42b ]
Sending the mutex address(acp\_lock) as platform
data during ACP PDM platform driver register sequence,
its creating copy of the platform data.
Referencing this platform data in ACP PDM driver results
incorrect reference to the common lock usage.
Instead of directly passing the lock address as platform
data, retrieve it from parent driver data structure
and use the same lock reference in ACP PDM driver.
Fixes: 45aa83cb9388 ("ASoC: amd: ps: use acp\_lock to protect common registers in pdm driver")
Signed-off-by: Vijendar Mukunda
Link: https://lore.kernel.org/r/20230525113000.1290758-1-Vijendar.Mukunda@amd.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 4fd0ca9f8348ce3934c7c6c1ff576fb4f49f8d98
Author: Shenwei Wang
Date: Fri May 26 10:38:54 2023 -0500
arm64: dts: imx8-ss-dma: assign default clock rate for lpuarts
[ Upstream commit ca50d7765587fe0a8351a6e8d9742cfd4811d925 ]
Add the assigned-clocks and assigned-clock-rates properties for the
LPUARTx nodes. Without these properties, the default clock rate
used would be 0, which can cause the UART ports to fail when open.
Fixes: 35f4e9d7530f ("arm64: dts: imx8: split adma ss into dma and audio ss")
Signed-off-by: Shenwei Wang
Reviewed-by: Fabio Estevam
Signed-off-by: Shawn Guo
Signed-off-by: Sasha Levin
commit 636516f2377d1c8568d817fb74778f44de377adf
Author: Shenwei Wang
Date: Thu May 18 08:54:21 2023 -0500
arm64: dts: imx8qm-mek: correct GPIOs for USDHC2 CD and WP signals
[ Upstream commit 2b28fc688cdff225c41cdd22857500e187453ed7 ]
The USDHC2 CD and WP sginal should be on LSIO\_GPIO5.
Fixes: 307fd14d4b14 ("arm64: dts: imx: add imx8qm mek support")
Signed-off-by: Shenwei Wang
Reviewed-by: Fabio Estevam
Signed-off-by: Shawn Guo
Signed-off-by: Sasha Levin
commit 4a88286579ed4a3508b92155deb60a8c7f45d087
Author: Douglas Anderson
Date: Mon May 15 17:19:29 2023 -0700
arm64: dts: qcom: sc7180-lite: Fix SDRAM freq for misidentified sc7180-lite boards
[ Upstream commit 3a735530c159b75e1402c08abe1ba4eb99a1f7a3 ]
In general, the three SKUs of sc7180 (lite, normal, and pro) are
handled dynamically.
The cpufreq table in sc7180.dtsi includes the superset of all CPU
frequencies. The "qcom-cpufreq-hw" driver in Linux shows that we can
dynamically detect which frequencies are actually available on the
currently running CPU and then we can just enable those ones.
The GPU is similarly dynamic. The nvmem has a fuse in it (see
"gpu\_speed\_bin" in sc7180.dtsi) that the GPU driver can use to figure
out which frequencies to enable.
There is one part, however, that is not so dynamic. The way SDRAM
frequency works in sc7180 is that it's tied to cpufreq. At the busiest
cpufreq operating points we'll pick the top supported SDRAM frequency.
They ramp down together.
For the "pro" SKU of sc7180, we only enable one extra cpufreq step.
That extra cpufreq step runs SDRAM at the same speed as the step
below. Thus, for normal and pro things are OK. There is no sc7180-pro
device tree snippet.
For the "lite" SKU if sc7180, however, things aren't so easy. The
"lite" SKU drops 3 cpufreq entries but can still run SDRAM at max
frequency. That messed things up with the whole scheme. This is why we
added the "sc7180-lite" fragment in commit 8fd01e01fd6f ("arm64: dts:
qcom: sc7180-lite: Tweak DDR/L3 scaling on SC7180-lite").
When the lite scheme came about, it was agreed that the WiFi SKUs of
lazor would \_always\_ be "lite" and would, in fact, be the only "lite"
devices. Unfortunately, this decision changed and folks didn't realize
that it would be a problem. Specifically, some later lazor WiFi-only
devices were built with "pro" CPUs.
Building WiFi-only lazor with "pro" CPUs isn't the end of the world.
The SDRAM will ramp up a little sooner than it otherwise would, but
aside from a small power hit things work OK. One problem, though, is
that the SDRAM scaling becomes a bit quirky. Specifically, with the
current tables we'll max out SDRAM frequency at 2.1GHz but then
\_lower\_ it at 2.2GHz / 2.3GHz only to raise it back to max for 2.4GHz
and 2.55GHz.
Let's at least fix this so that the SDRAM frequency doesn't go down in
that quirky way. On true "lite" SKUs this change will be a no-op
because the operating points we're touching are disabled. This change
is only useful when a board that thinks it has a "lite" CPU actually
has a "normal" or "pro" one stuffed.
Fixes: 8fd01e01fd6f ("arm64: dts: qcom: sc7180-lite: Tweak DDR/L3 scaling on SC7180-lite")
Signed-off-by: Douglas Anderson
Reviewed-by: Konrad Dybcio
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230515171929.1.Ic8dee2cb79ce39ffc04eab2a344dde47b2f9459f@changeid
Signed-off-by: Sasha Levin
commit df7c6db9171d8154574dbb1f84d8ed52df5add5d
Author: Dan Carpenter
Date: Fri Apr 21 13:44:21 2023 +0300
soc: qcom: rmtfs: Fix error code in probe()
[ Upstream commit 7b374a2fc8665bfb8a0d93b617463cc0732f533a ]
Return an error code if of\_property\_count\_u32\_elems() fails. Don't
return success.
Fixes: e656cd0bcf3d ("soc: qcom: rmtfs: Optionally map RMTFS to more VMs")
Signed-off-by: Dan Carpenter
Reviewed-by: Konrad Dybcio
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/76b21a14-70ff-4ca9-927d-587543c6699c@kili.mountain
Signed-off-by: Sasha Levin
commit 4b6ff4aa5f1467dc09e03452dd1761dd882ccf2f
Author: Christophe JAILLET
Date: Mon Apr 17 00:29:35 2023 +0200
soc: qcom: ramp\_controller: Fix an error handling path in qcom\_ramp\_controller\_probe()
[ Upstream commit b3d0dcc8e359cf5d57fb6308bc9750af5da574b3 ]
'qrc' is known to be non-NULL at this point.
Checking for 'qrc->desc' was expected instead, so use it.
Fixes: a723c95fa137 ("soc: qcom: Add Qualcomm Ramp Controller driver")
Signed-off-by: Christophe JAILLET
Reviewed-by: AngeloGioacchino Del Regno
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/84727a79d0261b4112411aec23b553504015c02c.1681684138.git.christophe.jaillet@wanadoo.fr
Signed-off-by: Sasha Levin
commit 71105f760515d0f2864c320dfdef10267f86cb70
Author: Srinivas Kandagatla
Date: Tue May 23 16:46:05 2023 +0100
ASoC: codecs: wsa881x: do not set can\_multi\_write flag
[ Upstream commit 6e7a6d4797ef521c0762914610ed682e102b9d36 ]
regmap-sdw does not support multi register writes, so there is
no point in setting this flag. This also leads to incorrect
programming of WSA codecs with regmap\_multi\_reg\_write() call.
This invalid configuration should have been rejected by regmap-sdw.
Fixes: a0aab9e1404a ("ASoC: codecs: add wsa881x amplifier support")
Signed-off-by: Srinivas Kandagatla
Link: https://lore.kernel.org/r/20230523154605.4284-2-srinivas.kandagatla@linaro.org
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit ad4f0cbf8a3d216c33a4da83d8a5f0cf93300782
Author: Srinivas Kandagatla
Date: Tue May 23 16:46:04 2023 +0100
ASoC: codecs: wsa883x: do not set can\_multi\_write flag
[ Upstream commit 40ba0411074485e2cf1bf8ee0f3db27bdff88394 ]
regmap-sdw does not support multi register writes, so there is
no point in setting this flag. This also leads to incorrect
programming of WSA codecs with regmap\_multi\_reg\_write() call.
This invalid configuration should have been rejected by regmap-sdw.
Fixes: 43b8c7dc85a1 ("ASoC: codecs: add wsa883x amplifier support")
Signed-off-by: Srinivas Kandagatla
Link: https://lore.kernel.org/r/20230523154605.4284-1-srinivas.kandagatla@linaro.org
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit b8cd81c74af99f350f2a24864fd2cda84217d014
Author: Claudiu Beznea
Date: Tue May 23 08:27:50 2023 +0300
ARM: dts: at91: sama7g5ek: fix debounce delay property for shdwc
[ Upstream commit 6b0db163ff9200a55dc77a652dad1d4b0a853f63 ]
There is no atmel,shdwc-debouncer property for SHDWC. The right DT property
is debounce-delay-us. Use it.
Fixes: 16b161bcf5d4 ("ARM: dts: at91: sama7g5: add shdwc node")
Signed-off-by: Claudiu Beznea
Acked-by: Nicolas Ferre
Link: https://lore.kernel.org/r/20230523052750.184223-1-claudiu.beznea@microchip.com
Signed-off-by: Sasha Levin
commit 427d4a73efce3d817da17878b8502e9646b41e4c
Author: Claudiu Beznea
Date: Thu May 18 09:25:11 2023 +0300
ARM: at91: pm: fix imbalanced reference counter for ethernet devices
[ Upstream commit ccd4923d18d5698a5910d516646ce125b9155d47 ]
The of\_find\_device\_by\_node() function is returning a struct platform\_device
object with the embedded struct device member's reference counter
incremented. This needs to be dropped when done with the platform device
returned by of\_find\_device\_by\_node().
at91\_pm\_eth\_quirk\_is\_valid() calls of\_find\_device\_by\_node() on
suspend and resume path. On suspend it calls of\_find\_device\_by\_node() and
on resume and failure paths it drops the counter of
struct platform\_device::dev.
In case ethernet device may not wakeup there is a put\_device() on
at91\_pm\_eth\_quirk\_is\_valid() which is wrong as it colides with
put\_device() on resume path leading to the reference counter of struct
device embedded in struct platform\_device to be messed, stack trace to be
displayed (after 5 consecutive suspend/resume cycles) and execution to
hang.
Along with this the error path of at91\_pm\_config\_quirks() had been also
adapted to decrement propertly the reference counter of struct device
embedded in struct platform\_device.
Fixes: b7fc72c63399 ("ARM: at91: pm: add quirks for pm")
Signed-off-by: Claudiu Beznea
Acked-by: Nicolas Ferre
Link: https://lore.kernel.org/r/20230518062511.2988500-1-claudiu.beznea@microchip.com
Signed-off-by: Sasha Levin
commit 1d6e542fb823afdca696bac3182104622d623d90
Author: Konrad Dybcio
Date: Wed May 17 19:06:13 2023 +0200
arm64: dts: qcom: sm6375-pdx225: Fix remoteproc firmware paths
[ Upstream commit a14da6144d16ef27e3022835fa282a3740b8ad7b ]
They were previously missing the SoC name. Fix it.
Fixes: a2ad207c412b ("arm64: dts: qcom: sm6375-pdx225: Enable ADSP & CDSP")
Signed-off-by: Konrad Dybcio
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230517-topic-murray-fwname-v1-1-923e87312249@linaro.org
Signed-off-by: Sasha Levin
commit eed41b6475eb31b32f4eeeed8f6eac09326ae2fc
Author: Bjorn Andersson
Date: Fri May 12 08:04:25 2023 -0700
arm64: dts: qcom: sc8280xp: Flush RSC sleep & wake votes
[ Upstream commit ce7c014937c442be677963848c7db62eccd94eac ]
The rpmh driver will cache sleep and wake votes until the cluster
power-domain is about to enter idle, to avoid unnecessary writes. So
associate the apps\_rsc with the cluster pd, so that it can be notified
about this event.
Without this, only AMC votes are being commited.
Signed-off-by: Bjorn Andersson
Reviewed-by: Konrad Dybcio
Fixes: 152d1faf1e2f ("arm64: dts: qcom: add SC8280XP platform")
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230512150425.3171122-1-quic\_bjorande@quicinc.com
Signed-off-by: Sasha Levin
commit a8d16e939d1ae3f1bce18871820ce4eac7655367
Author: Krzysztof Kozlowski
Date: Sat May 13 13:29:13 2023 +0200
soc: qcom: rpmh-rsc: drop redundant unsigned >=0 comparision
[ Upstream commit 3395d36e6805786c26d13188735bc796b9d7a7c9 ]
Unsigned int "minor" is always >= 0 as reported by Smatch:
drivers/soc/qcom/rpmh-rsc.c:1076 rpmh\_rsc\_probe() warn: always true condition '(drv->ver.minor >= 0) => (0-u32max >= 0)'
Fixes: 88704a0cd719 ("soc: qcom: rpmh-rsc: Support RSC v3 minor versions")
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230513112913.176009-1-krzysztof.kozlowski@linaro.org
Signed-off-by: Sasha Levin
commit c539a19ac20dcdf1d2df8c281a238ad1a1a20c89
Author: Ruihan Li
Date: Mon May 15 21:09:58 2023 +0800
mm: page\_table\_check: Ensure user pages are not slab pages
commit 44d0fb387b53e56c8a050bac5c7d460e21eb226f upstream.
The current uses of PageAnon in page table check functions can lead to
type confusion bugs between struct page and slab [1], if slab pages are
accidentally mapped into the user space. This is because slab reuses the
bits in struct page to store its internal states, which renders PageAnon
ineffective on slab pages.
Since slab pages are not expected to be mapped into the user space, this
patch adds BUG\_ON(PageSlab(page)) checks to make sure that slab pages
are not inadvertently mapped. Otherwise, there must be some bugs in the
kernel.
Reported-by: syzbot+fcf1a817ceb50935ce99@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/lkml/000000000000258e5e05fae79fc1@google.com/ [1]
Fixes: df4e817b7108 ("mm: page table check")
Cc:  # 5.17
Signed-off-by: Ruihan Li
Acked-by: Pasha Tatashin
Link: https://lore.kernel.org/r/20230515130958.32471-5-lrh2000@pku.edu.cn
Signed-off-by: Greg Kroah-Hartman
commit 0209337600e1e8158c9bc391ee25baedfc0571ca
Author: Ruihan Li
Date: Mon May 15 21:09:57 2023 +0800
mm: page\_table\_check: Make it dependent on EXCLUSIVE\_SYSTEM\_RAM
commit 81a31a860bb61d54eb688af2568d9332ed9b8942 upstream.
Without EXCLUSIVE\_SYSTEM\_RAM, users are allowed to map arbitrary
physical memory regions into the userspace via /dev/mem. At the same
time, pages may change their properties (e.g., from anonymous pages to
named pages) while they are still being mapped in the userspace, leading
to "corruption" detected by the page table check.
To avoid these false positives, this patch makes PAGE\_TABLE\_CHECK
depends on EXCLUSIVE\_SYSTEM\_RAM. This dependency is understandable
because PAGE\_TABLE\_CHECK is a hardening technique but /dev/mem without
STRICT\_DEVMEM (i.e., !EXCLUSIVE\_SYSTEM\_RAM) is itself a security
problem.
Even with EXCLUSIVE\_SYSTEM\_RAM, I/O pages may be still allowed to be
mapped via /dev/mem. However, these pages are always considered as named
pages, so they won't break the logic used in the page table check.
Cc:  # 5.17
Signed-off-by: Ruihan Li
Acked-by: David Hildenbrand
Acked-by: Pasha Tatashin
Link: https://lore.kernel.org/r/20230515130958.32471-4-lrh2000@pku.edu.cn
Signed-off-by: Greg Kroah-Hartman
commit 9f024c0a5b1822c2b77e64d8098423533c0351d7
Author: Ruihan Li
Date: Mon May 15 21:09:56 2023 +0800
usb: usbfs: Use consistent mmap functions
commit d0b861653f8c16839c3035875b556afc4472f941 upstream.
When hcd->localmem\_pool is non-null, localmem\_pool is used to allocate
DMA memory. In this case, the dma address will be properly returned (in
dma\_handle), and dma\_mmap\_coherent should be used to map this memory
into the user space. However, the current implementation uses
pfn\_remap\_range, which is supposed to map normal pages.
Instead of repeating the logic in the memory allocation function, this
patch introduces a more robust solution. Here, the type of allocated
memory is checked by testing whether dma\_handle is properly set. If
dma\_handle is properly returned, it means some DMA pages are allocated
and dma\_mmap\_coherent should be used to map them. Otherwise, normal
pages are allocated and pfn\_remap\_range should be called. This ensures
that the correct mmap functions are used consistently, independently
with logic details that determine which type of memory gets allocated.
Fixes: a0e710a7def4 ("USB: usbfs: fix mmap dma mismatch")
Cc: stable@vger.kernel.org
Signed-off-by: Ruihan Li
Link: https://lore.kernel.org/r/20230515130958.32471-3-lrh2000@pku.edu.cn
Signed-off-by: Greg Kroah-Hartman
commit c4287d025082cb3c830761bc0196777895ab547f
Author: Ruihan Li
Date: Mon May 15 21:09:55 2023 +0800
usb: usbfs: Enforce page requirements for mmap
commit 0143d148d1e882fb1538dc9974c94d63961719b9 upstream.
The current implementation of usbdev\_mmap uses usb\_alloc\_coherent to
allocate memory pages that will later be mapped into the user space.
Meanwhile, usb\_alloc\_coherent employs three different methods to
allocate memory, as outlined below:
\* If hcd->localmem\_pool is non-null, it uses gen\_pool\_dma\_alloc to
allocate memory;
\* If DMA is not available, it uses kmalloc to allocate memory;
\* Otherwise, it uses dma\_alloc\_coherent.
However, it should be noted that gen\_pool\_dma\_alloc does not guarantee
that the resulting memory will be page-aligned. Furthermore, trying to
map slab pages (i.e., memory allocated by kmalloc) into the user space
is not resonable and can lead to problems, such as a type confusion bug
when PAGE\_TABLE\_CHECK=y [1].
To address these issues, this patch introduces hcd\_alloc\_coherent\_pages,
which addresses the above two problems. Specifically,
hcd\_alloc\_coherent\_pages uses gen\_pool\_dma\_alloc\_align instead of
gen\_pool\_dma\_alloc to ensure that the memory is page-aligned. To replace
kmalloc, hcd\_alloc\_coherent\_pages directly allocates pages by calling
\_\_get\_free\_pages.
Reported-by: syzbot+fcf1a817ceb50935ce99@syzkaller.appspotmail.comm
Closes: https://lore.kernel.org/lkml/000000000000258e5e05fae79fc1@google.com/ [1]
Fixes: f7d34b445abc ("USB: Add support for usbfs zerocopy.")
Fixes: ff2437befd8f ("usb: host: Fix excessive alignment restriction for local memory allocations")
Cc: stable@vger.kernel.org
Signed-off-by: Ruihan Li
Acked-by: Alan Stern
Link: https://lore.kernel.org/r/20230515130958.32471-2-lrh2000@pku.edu.cn
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 887eaa540412df8205e9013121a88c7764336146
Author: Martin Hundebøll
Date: Fri May 12 08:49:25 2023 +0200
pinctrl: meson-axg: add missing GPIOA\_18 gpio group
commit 5b10ff013e8a57f8845615ac2cc37edf7f6eef05 upstream.
Without this, the gpio cannot be explicitly mux'ed to its gpio function.
Fixes: 83c566806a68a ("pinctrl: meson-axg: Add new pinctrl driver for Meson AXG SoC")
Cc: stable@vger.kernel.org
Signed-off-by: Martin Hundebøll
Reviewed-by: Neil Armstrong
Reviewed-by: Dmitry Rokosov
Link: https://lore.kernel.org/r/20230512064925.133516-1-martin@geanix.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 6784c691231af4cf991aa2b465b17689ee80173f
Author: Krzysztof Kozlowski
Date: Sat May 13 13:17:47 2023 +0200
soc: qcom: icc-bwmon: fix incorrect error code passed to dev\_err\_probe()
commit 3530167c6fe8001de6c026a3058eaca4c8a5329f upstream.
Pass to dev\_err\_probe() PTR\_ERR from actual dev\_pm\_opp\_find\_bw\_floor()
call which failed, instead of previous ret which at this point is 0.
Failure of dev\_pm\_opp\_find\_bw\_floor() would result in prematurely ending
the probe with success.
Fixes smatch warnings:
drivers/soc/qcom/icc-bwmon.c:776 bwmon\_probe() warn: passing zero to 'dev\_err\_probe'
drivers/soc/qcom/icc-bwmon.c:781 bwmon\_probe() warn: passing zero to 'dev\_err\_probe'
Reported-by: kernel test robot
Reported-by: Dan Carpenter
Link: https://lore.kernel.org/r/202305131657.76XeHDjF-lkp@intel.com/
Cc:
Fixes: b9c2ae6cac40 ("soc: qcom: icc-bwmon: Add bandwidth monitoring driver")
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230513111747.132532-1-krzysztof.kozlowski@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit 49427c717f1021c0f937c4b2f5b8f6a0f4099c71
Author: Brett Creeley
Date: Mon Jun 5 12:59:25 2023 -0700
virtio\_net: use control\_buf for coalesce params
commit accc1bf23068c1cdc4c2b015320ba856e210dd98 upstream.
Commit 699b045a8e43 ("net: virtio\_net: notifications coalescing
support") added coalescing command support for virtio\_net. However,
the coalesce commands are using buffers on the stack, which is causing
the device to see DMA errors. There should also be a complaint from
check\_for\_stack() in debug\_dma\_map\_xyz(). Fix this by adding and using
coalesce params from the control\_buf struct, which aligns with other
commands.
Cc: stable@vger.kernel.org
Fixes: 699b045a8e43 ("net: virtio\_net: notifications coalescing support")
Reviewed-by: Shannon Nelson
Signed-off-by: Allen Hubbe
Signed-off-by: Brett Creeley
Acked-by: Jason Wang
Reviewed-by: Xuan Zhuo
Acked-by: Michael S. Tsirkin
Link: https://lore.kernel.org/r/20230605195925.51625-1-brett.creeley@amd.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 40a9ec704b1b2a74fc88e4cc1efc5bebfef0a1c0
Author: Ilya Dryomov
Date: Mon Jun 5 16:33:35 2023 +0200
rbd: get snapshot context after exclusive lock is ensured to be held
commit 870611e4877eff1e8413c3fb92a585e45d5291f6 upstream.
Move capturing the snapshot context into the image request state
machine, after exclusive lock is ensured to be held for the duration of
dealing with the image request. This is needed to ensure correctness
of fast-diff states (OBJECT\_EXISTS vs OBJECT\_EXISTS\_CLEAN) and object
deltas computed based off of them. Otherwise the object map that is
forked for the snapshot isn't guaranteed to accurately reflect the
contents of the snapshot when the snapshot is taken under I/O. This
breaks differential backup and snapshot-based mirroring use cases with
fast-diff enabled: since some object deltas may be incomplete, the
destination image may get corrupted.
Cc: stable@vger.kernel.org
Link: https://tracker.ceph.com/issues/61472
Signed-off-by: Ilya Dryomov
Reviewed-by: Dongsheng Yang
Signed-off-by: Greg Kroah-Hartman
commit b57d8a8ef75c29b4c519b90f269128ee48674339
Author: Ilya Dryomov
Date: Mon Jun 5 16:33:35 2023 +0200
rbd: move RBD\_OBJ\_FLAG\_COPYUP\_ENABLED flag setting
commit 09fe05c57b5aaf23e2c35036c98ea9f282b19a77 upstream.
Move RBD\_OBJ\_FLAG\_COPYUP\_ENABLED flag setting into the object request
state machine to allow for the snapshot context to be captured in the
image request state machine rather than in rbd\_queue\_workfn().
Cc: stable@vger.kernel.org
Signed-off-by: Ilya Dryomov
Reviewed-by: Dongsheng Yang
Signed-off-by: Greg Kroah-Hartman
commit faeeb7b6924f86721e697e1eadf125378dddf560
Author: Rijo Thomas
Date: Tue May 9 13:02:40 2023 +0530
tee: amdtee: Add return\_origin to 'struct tee\_cmd\_load\_ta'
commit 436eeae0411acdfc54521ddea80ee76d4ae8a7ea upstream.
After TEE has completed processing of TEE\_CMD\_ID\_LOAD\_TA, set proper
value in 'return\_origin' argument passed by open\_session() call. To do
so, add 'return\_origin' field to the structure tee\_cmd\_load\_ta. The
Trusted OS shall update return\_origin as part of TEE processing.
This change to 'struct tee\_cmd\_load\_ta' interface requires a similar update
in AMD-TEE Trusted OS's TEE\_CMD\_ID\_LOAD\_TA interface.
This patch has been verified on Phoenix Birman setup. On older APUs,
return\_origin value will be 0.
Cc: stable@vger.kernel.org
Fixes: 757cc3e9ff1d ("tee: add AMD-TEE driver")
Tested-by: Sourabh Das
Signed-off-by: Rijo Thomas
Acked-by: Sumit Garg
Signed-off-by: Jens Wiklander
Signed-off-by: Greg Kroah-Hartman
commit 7b544ae0499e835bf15987870440f05b7094e451
Author: Johan Hovold
Date: Wed May 31 10:57:59 2023 +0200
Bluetooth: hci\_qca: fix debugfs registration
commit 47c5d829a3e326b7395352a10fc8a6effe7afa15 upstream.
Since commit 3e4be65eb82c ("Bluetooth: hci\_qca: Add poweroff support
during hci down for wcn3990"), the setup callback which registers the
debugfs interface can be called multiple times.
This specifically leads to the following error when powering on the
controller:
debugfs: Directory 'ibs' with parent 'hci0' already present!
Add a driver flag to avoid trying to register the debugfs interface more
than once.
Fixes: 3e4be65eb82c ("Bluetooth: hci\_qca: Add poweroff support during hci down for wcn3990")
Cc: stable@vger.kernel.org # 4.20
Signed-off-by: Johan Hovold
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 4a01cda0e5346065626f2e9405098986387725b9
Author: Johan Hovold
Date: Wed May 31 10:57:58 2023 +0200
Bluetooth: fix debugfs registration
commit fe2ccc6c29d53e14d3c8b3ddf8ad965a92e074ee upstream.
Since commit ec6cef9cd98d ("Bluetooth: Fix SMP channel registration for
unconfigured controllers") the debugfs interface for unconfigured
controllers will be created when the controller is configured.
There is however currently nothing preventing a controller from being
configured multiple time (e.g. setting the device address using btmgmt)
which results in failed attempts to register the already registered
debugfs entries:
debugfs: File 'features' in directory 'hci0' already present!
debugfs: File 'manufacturer' in directory 'hci0' already present!
debugfs: File 'hci\_version' in directory 'hci0' already present!
...
debugfs: File 'quirk\_simultaneous\_discovery' in directory 'hci0' already present!
Add a controller flag to avoid trying to register the debugfs interface
more than once.
Fixes: ec6cef9cd98d ("Bluetooth: Fix SMP channel registration for unconfigured controllers")
Cc: stable@vger.kernel.org # 4.0
Signed-off-by: Johan Hovold
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit b0b97e7bc76e5326f02d07585d0ba78634187bda
Author: Luiz Augusto von Dentz
Date: Tue May 30 13:48:44 2023 -0700
Bluetooth: Fix use-after-free in hci\_remove\_ltk/hci\_remove\_irk
commit c5d2b6fa26b5b8386a9cc902cdece3a46bef2bd2 upstream.
Similar to commit 0f7d9b31ce7a ("netfilter: nf\_tables: fix use-after-free
in nft\_set\_catchall\_destroy()"). We can not access k after kfree\_rcu()
call.
Cc: stable@vger.kernel.org
Signed-off-by: Min Li
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 9cc771a5d77d5d5f3250d4ba68210b9b5f64b730
Author: Jan Höppner
Date: Fri Jun 9 17:37:50 2023 +0200
s390/dasd: Use correct lock while counting channel queue length
commit ccc45cb4e7271c74dbb27776ae8f73d84557f5c6 upstream.
The lock around counting the channel queue length in the BIODASDINFO
ioctl was incorrectly changed to the dasd\_block->queue\_lock with commit
583d6535cb9d ("dasd: remove dead code"). This can lead to endless list
iterations and a subsequent crash.
The queue\_lock is supposed to be used only for queue lists belonging to
dasd\_block. For dasd\_device related queue lists the ccwdev lock must be
used.
Fix the mentioned issues by correctly using the ccwdev lock instead of
the queue lock.
Fixes: 583d6535cb9d ("dasd: remove dead code")
Cc: stable@vger.kernel.org # v5.0+
Signed-off-by: Jan Höppner
Reviewed-by: Stefan Haberland
Signed-off-by: Stefan Haberland
Link: https://lore.kernel.org/r/20230609153750.1258763-2-sth@linux.ibm.com
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 19887a85ad934e7282aa2154c99c68cf3d35dcb6
Author: Andrzej Kacprowski
Date: Wed Jun 7 11:45:02 2023 +0200
accel/ivpu: Fix sporadic VPU boot failure
commit a3efabee5878b8d7b1863debb78cb7129d07a346 upstream.
Wait for AON bit in HOST\_SS\_CPR\_RST\_CLR to return 0 before
starting VPUIP power up sequence, otherwise the VPU device
may sporadically fail to boot.
An error in power up sequence is propagated to the runtime
power management - the device will be in an error state
until the VPU driver is reloaded.
Fixes: 35b137630f08 ("accel/ivpu: Introduce a new DRM driver for Intel VPU")
Cc: stable@vger.kernel.org # 6.3.x
Signed-off-by: Andrzej Kacprowski
Reviewed-by: Krystian Pradzynski
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230607094502.388489-1-stanislaw.gruszka@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit d50a2a9f82ede54483a73c92eb63a49ca5d0b79b
Author: Andrzej Kacprowski
Date: Thu May 25 12:38:17 2023 +0200
accel/ivpu: Do not trigger extra VPU reset if the VPU is idle
commit 9f7e3611f6c828fcb6001c39d8e7a523a4f31525 upstream.
Turning off the PLL and entering D0i3 will reset the VPU so
an explicit IP reset is redundant.
But if the VPU is active, it may interfere with PLL disabling
and to avoid that, we have to issue an additional IP reset
to silence the VPU before turning off the PLL.
Fixes: a8fed6d1e0b9 ("accel/ivpu: Fix power down sequence")
Cc: stable@vger.kernel.org # 6.3.x
Signed-off-by: Andrzej Kacprowski
Reviewed-by: Stanislaw Gruszka
Reviewed-by: Jeffrey Hugo
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230525103818.877590-1-stanislaw.gruszka@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 888c56409ac423d5bdf45aa8bd32fbde5a59752b
Author: Xiubo Li
Date: Thu Jun 1 08:59:31 2023 +0800
ceph: fix use-after-free bug for inodes when flushing capsnaps
commit 409e873ea3c1fd3079909718bbeb06ac1ec7f38b upstream.
There is a race between capsnaps flush and removing the inode from
'mdsc->snap\_flush\_list' list:
== Thread A == == Thread B ==
ceph\_queue\_cap\_snap()
-> allocate 'capsnapA'
->ihold('&ci->vfs\_inode')
->add 'capsnapA' to 'ci->i\_cap\_snaps'
->add 'ci' to 'mdsc->snap\_flush\_list'
...
== Thread C ==
ceph\_flush\_snaps()
->\_\_ceph\_flush\_snaps()
->\_\_send\_flush\_snap()
handle\_cap\_flushsnap\_ack()
->iput('&ci->vfs\_inode')
this also will release 'ci'
...
== Thread D ==
ceph\_handle\_snap()
->flush\_snaps()
->iterate 'mdsc->snap\_flush\_list'
->get the stale 'ci'
->remove 'ci' from ->ihold(&ci->vfs\_inode) this
'mdsc->snap\_flush\_list' will WARNING
To fix this we will increase the inode's i\_count ref when adding 'ci'
to the 'mdsc->snap\_flush\_list' list.
[ idryomov: need\_put int -> bool ]
Cc: stable@vger.kernel.org
Link: https://bugzilla.redhat.com/show\_bug.cgi?id=2209299
Signed-off-by: Xiubo Li
Reviewed-by: Milind Changire
Reviewed-by: Ilya Dryomov
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit ccbb5df0bd77bf2440471dd9187820929a89400e
Author: Geliang Tang
Date: Sun Jun 4 20:25:20 2023 -0700
selftests: mptcp: update userspace pm subflow tests
commit 6c160b636c91e71e50c39134f78257cc35305ff0 upstream.
To align with what is done by the in-kernel PM, update userspace pm
subflow selftests, by sending the a remove\_addrs command together
before the remove\_subflows command. This will get a RM\_ADDR in
chk\_rm\_nr().
Fixes: d9a4594edabf ("mptcp: netlink: Add MPTCP\_PM\_CMD\_REMOVE")
Fixes: 5e986ec46874 ("selftests: mptcp: userspace pm subflow tests")
Link: https://github.com/multipath-tcp/mptcp\_net-next/issues/379
Cc: stable@vger.kernel.org
Reviewed-by: Matthieu Baerts
Signed-off-by: Geliang Tang
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 43c6c7ec5e45a71d4f208f565b2090eb3d4b5f1f
Author: Geliang Tang
Date: Sun Jun 4 20:25:18 2023 -0700
selftests: mptcp: update userspace pm addr tests
commit 48d73f609dcceeb563b0d960e59bf0362581e39c upstream.
This patch is linked to the previous commit ("mptcp: only send RM\_ADDR in
nl\_cmd\_remove").
To align with what is done by the in-kernel PM, update userspace pm addr
selftests, by sending a remove\_subflows command together after the
remove\_addrs command.
Fixes: d9a4594edabf ("mptcp: netlink: Add MPTCP\_PM\_CMD\_REMOVE")
Fixes: 97040cf9806e ("selftests: mptcp: userspace pm address tests")
Cc: stable@vger.kernel.org
Reviewed-by: Matthieu Baerts
Signed-off-by: Geliang Tang
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 37bdac08578f00ed16675e885529cfc5adcd66da
Author: Geliang Tang
Date: Sun Jun 4 20:25:21 2023 -0700
mptcp: update userspace pm infos
commit 77e4b94a3de692a09b79945ecac5b8e6b77f10c1 upstream.
Increase pm subflows counter on both server side and client side when
userspace pm creates a new subflow, and decrease the counter when it
closes a subflow.
Increase add\_addr\_signaled counter in mptcp\_nl\_cmd\_announce() when the
address is announced by userspace PM.
This modification is similar to how the in-kernel PM is updating the
counter: when additional subflows are created/removed.
Fixes: 9ab4807c84a4 ("mptcp: netlink: Add MPTCP\_PM\_CMD\_ANNOUNCE")
Fixes: 702c2f646d42 ("mptcp: netlink: allow userspace-driven subflow establishment")
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/329
Cc: stable@vger.kernel.org
Reviewed-by: Matthieu Baerts
Signed-off-by: Geliang Tang
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e7b59f6b2eed3816d8d2fc7b6001c6dad5e7e20d
Author: Geliang Tang
Date: Sun Jun 4 20:25:19 2023 -0700
mptcp: add address into userspace pm list
commit 24430f8bf51655c5ab7ddc2fafe939dd3cd0dd47 upstream.
Add the address into userspace\_pm\_local\_addr\_list when the subflow is
created. Make sure it can be found in mptcp\_nl\_cmd\_remove(). And delete
it in the new helper mptcp\_userspace\_pm\_delete\_local\_addr().
By doing this, the "REMOVE" command also works with subflows that have
been created via the "SUB\_CREATE" command instead of restricting to
the addresses that have been announced via the "ANNOUNCE" command.
Fixes: d9a4594edabf ("mptcp: netlink: Add MPTCP\_PM\_CMD\_REMOVE")
Link: https://github.com/multipath-tcp/mptcp\_net-next/issues/379
Cc: stable@vger.kernel.org
Reviewed-by: Matthieu Baerts
Signed-off-by: Geliang Tang
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 745e81de3332c284ac90410b74388a0e447f7308
Author: Geliang Tang
Date: Sun Jun 4 20:25:17 2023 -0700
mptcp: only send RM\_ADDR in nl\_cmd\_remove
commit 8b1c94da1e481090f24127b2c420b0c0b0421ce3 upstream.
The specifications from [1] about the "REMOVE" command say:
Announce that an address has been lost to the peer
It was then only supposed to send a RM\_ADDR and not trying to delete
associated subflows.
A new helper mptcp\_pm\_remove\_addrs() is then introduced to do just
that, compared to mptcp\_pm\_remove\_addrs\_and\_subflows() also removing
subflows.
To delete a subflow, the userspace daemon can use the "SUB\_DESTROY"
command, see mptcp\_nl\_cmd\_sf\_destroy().
Fixes: d9a4594edabf ("mptcp: netlink: Add MPTCP\_PM\_CMD\_REMOVE")
Link: https://github.com/multipath-tcp/mptcp/blob/mptcp\_v0.96/include/uapi/linux/mptcp.h [1]
Cc: stable@vger.kernel.org
Reviewed-by: Matthieu Baerts
Signed-off-by: Geliang Tang
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d21ca6ee111d79d9613b8c1e59bf57ee5e040a2b
Author: Fedor Pchelkin
Date: Fri May 26 20:19:10 2023 +0300
can: j1939: avoid possible use-after-free when j1939\_can\_rx\_register fails
commit 9f16eb106aa5fce15904625661312623ec783ed3 upstream.
Syzkaller reports the following failure:
BUG: KASAN: use-after-free in kref\_put include/linux/kref.h:64 [inline]
BUG: KASAN: use-after-free in j1939\_priv\_put+0x25/0xa0 net/can/j1939/main.c:172
Write of size 4 at addr ffff888141c15058 by task swapper/3/0
CPU: 3 PID: 0 Comm: swapper/3 Not tainted 5.10.144-syzkaller #0
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x107/0x167 lib/dump\_stack.c:118
print\_address\_description.constprop.0+0x1c/0x220 mm/kasan/report.c:385
\_\_kasan\_report mm/kasan/report.c:545 [inline]
kasan\_report.cold+0x1f/0x37 mm/kasan/report.c:562
check\_memory\_region\_inline mm/kasan/generic.c:186 [inline]
check\_memory\_region+0x145/0x190 mm/kasan/generic.c:192
instrument\_atomic\_read\_write include/linux/instrumented.h:101 [inline]
atomic\_fetch\_sub\_release include/asm-generic/atomic-instrumented.h:220 [inline]
\_\_refcount\_sub\_and\_test include/linux/refcount.h:272 [inline]
\_\_refcount\_dec\_and\_test include/linux/refcount.h:315 [inline]
refcount\_dec\_and\_test include/linux/refcount.h:333 [inline]
kref\_put include/linux/kref.h:64 [inline]
j1939\_priv\_put+0x25/0xa0 net/can/j1939/main.c:172
j1939\_sk\_sock\_destruct+0x44/0x90 net/can/j1939/socket.c:374
\_\_sk\_destruct+0x4e/0x820 net/core/sock.c:1784
rcu\_do\_batch kernel/rcu/tree.c:2485 [inline]
rcu\_core+0xb35/0x1a30 kernel/rcu/tree.c:2726
\_\_do\_softirq+0x289/0x9a3 kernel/softirq.c:298
asm\_call\_irq\_on\_stack+0x12/0x20

\_\_run\_on\_irqstack arch/x86/include/asm/irq\_stack.h:26 [inline]
run\_on\_irqstack\_cond arch/x86/include/asm/irq\_stack.h:77 [inline]
do\_softirq\_own\_stack+0xaa/0xe0 arch/x86/kernel/irq\_64.c:77
invoke\_softirq kernel/softirq.c:393 [inline]
\_\_irq\_exit\_rcu kernel/softirq.c:423 [inline]
irq\_exit\_rcu+0x136/0x200 kernel/softirq.c:435
sysvec\_apic\_timer\_interrupt+0x4d/0x100 arch/x86/kernel/apic/apic.c:1095
asm\_sysvec\_apic\_timer\_interrupt+0x12/0x20 arch/x86/include/asm/idtentry.h:635
Allocated by task 1141:
kasan\_save\_stack+0x1b/0x40 mm/kasan/common.c:48
kasan\_set\_track mm/kasan/common.c:56 [inline]
\_\_kasan\_kmalloc.constprop.0+0xc9/0xd0 mm/kasan/common.c:461
kmalloc include/linux/slab.h:552 [inline]
kzalloc include/linux/slab.h:664 [inline]
j1939\_priv\_create net/can/j1939/main.c:131 [inline]
j1939\_netdev\_start+0x111/0x860 net/can/j1939/main.c:268
j1939\_sk\_bind+0x8ea/0xd30 net/can/j1939/socket.c:485
\_\_sys\_bind+0x1f2/0x260 net/socket.c:1645
\_\_do\_sys\_bind net/socket.c:1656 [inline]
\_\_se\_sys\_bind net/socket.c:1654 [inline]
\_\_x64\_sys\_bind+0x6f/0xb0 net/socket.c:1654
do\_syscall\_64+0x33/0x40 arch/x86/entry/common.c:46
entry\_SYSCALL\_64\_after\_hwframe+0x61/0xc6
Freed by task 1141:
kasan\_save\_stack+0x1b/0x40 mm/kasan/common.c:48
kasan\_set\_track+0x1c/0x30 mm/kasan/common.c:56
kasan\_set\_free\_info+0x1b/0x30 mm/kasan/generic.c:355
\_\_kasan\_slab\_free+0x112/0x170 mm/kasan/common.c:422
slab\_free\_hook mm/slub.c:1542 [inline]
slab\_free\_freelist\_hook+0xad/0x190 mm/slub.c:1576
slab\_free mm/slub.c:3149 [inline]
kfree+0xd9/0x3b0 mm/slub.c:4125
j1939\_netdev\_start+0x5ee/0x860 net/can/j1939/main.c:300
j1939\_sk\_bind+0x8ea/0xd30 net/can/j1939/socket.c:485
\_\_sys\_bind+0x1f2/0x260 net/socket.c:1645
\_\_do\_sys\_bind net/socket.c:1656 [inline]
\_\_se\_sys\_bind net/socket.c:1654 [inline]
\_\_x64\_sys\_bind+0x6f/0xb0 net/socket.c:1654
do\_syscall\_64+0x33/0x40 arch/x86/entry/common.c:46
entry\_SYSCALL\_64\_after\_hwframe+0x61/0xc6
It can be caused by this scenario:
CPU0 CPU1
j1939\_sk\_bind(socket0, ndev0, ...)
j1939\_netdev\_start()
j1939\_sk\_bind(socket1, ndev0, ...)
j1939\_netdev\_start()
mutex\_lock(&j1939\_netdev\_lock)
j1939\_priv\_set(ndev0, priv)
mutex\_unlock(&j1939\_netdev\_lock)
if (priv\_new)
kref\_get(&priv\_new->rx\_kref)
return priv\_new;
/\* inside j1939\_sk\_bind() \*/
jsk->priv = priv
j1939\_can\_rx\_register(priv) // fails
j1939\_priv\_set(ndev, NULL)
kfree(priv)
j1939\_sk\_sock\_destruct()
j1939\_priv\_put() // <- uaf
To avoid this, call j1939\_can\_rx\_register() under j1939\_netdev\_lock so
that a concurrent thread cannot process j1939\_priv before
j1939\_can\_rx\_register() returns.
Found by Linux Verification Center (linuxtesting.org) with Syzkaller.
Fixes: 9d71dd0c7009 ("can: add support of SAE J1939 protocol")
Signed-off-by: Fedor Pchelkin
Tested-by: Oleksij Rempel
Acked-by: Oleksij Rempel
Link: https://lore.kernel.org/r/20230526171910.227615-3-pchelkin@ispras.ru
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 429470d360fcaf9d89fa7a9736911f073be8dc25
Author: Fedor Pchelkin
Date: Fri May 26 20:19:09 2023 +0300
can: j1939: change j1939\_netdev\_lock type to mutex
commit cd9c790de2088b0d797dc4d244b4f174f9962554 upstream.
It turns out access to j1939\_can\_rx\_register() needs to be serialized,
otherwise j1939\_priv can be corrupted when parallel threads call
j1939\_netdev\_start() and j1939\_can\_rx\_register() fails. This issue is
thoroughly covered in other commit which serializes access to
j1939\_can\_rx\_register().
Change j1939\_netdev\_lock type to mutex so that we do not need to remove
GFP\_KERNEL from can\_rx\_register().
j1939\_netdev\_lock seems to be used in normal contexts where mutex usage
is not prohibited.
Found by Linux Verification Center (linuxtesting.org) with Syzkaller.
Fixes: 9d71dd0c7009 ("can: add support of SAE J1939 protocol")
Suggested-by: Alexey Khoroshilov
Signed-off-by: Fedor Pchelkin
Tested-by: Oleksij Rempel
Acked-by: Oleksij Rempel
Link: https://lore.kernel.org/r/20230526171910.227615-2-pchelkin@ispras.ru
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit ee99e1fe2f29e8e2acd34f239675de35aa753073
Author: Oleksij Rempel
Date: Fri May 26 10:19:46 2023 +0200
can: j1939: j1939\_sk\_send\_loop\_abort(): improved error queue handling in J1939 Socket
commit 2a84aea80e925ecba6349090559754f8e8eb68ef upstream.
This patch addresses an issue within the j1939\_sk\_send\_loop\_abort()
function in the j1939/socket.c file, specifically in the context of
Transport Protocol (TP) sessions.
Without this patch, when a TP session is initiated and a Clear To Send
(CTS) frame is received from the remote side requesting one data packet,
the kernel dispatches the first Data Transport (DT) frame and then waits
for the next CTS. If the remote side doesn't respond with another CTS,
the kernel aborts due to a timeout. This leads to the user-space
receiving an EPOLLERR on the socket, and the socket becomes active.
However, when trying to read the error queue from the socket with
sock.recvmsg(, , socket.MSG\_ERRQUEUE), it returns -EAGAIN,
given that the socket is non-blocking. This situation results in an
infinite loop: the user-space repeatedly calls epoll(), epoll() returns
the socket file descriptor with EPOLLERR, but the socket then blocks on
the recv() of ERRQUEUE.
This patch introduces an additional check for the J1939\_SOCK\_ERRQUEUE
flag within the j1939\_sk\_send\_loop\_abort() function. If the flag is set,
it indicates that the application has subscribed to receive error queue
messages. In such cases, the kernel can communicate the current transfer
state via the error queue. This allows for the function to return early,
preventing the unnecessary setting of the socket into an error state,
and breaking the infinite loop. It is crucial to note that a socket
error is only needed if the application isn't using the error queue, as,
without it, the application wouldn't be aware of transfer issues.
Fixes: 9d71dd0c7009 ("can: add support of SAE J1939 protocol")
Reported-by: David Jander
Tested-by: David Jander
Signed-off-by: Oleksij Rempel
Link: https://lore.kernel.org/r/20230526081946.715190-1-o.rempel@pengutronix.de
Cc: stable@vger.kernel.org
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit e7bea51a185aa6f9012ec1b0174bf40287e7eddd
Author: Gustavo A. R. Silva
Date: Fri Jun 2 13:42:47 2023 -0600
wifi: iwlwifi: mvm: Fix -Warray-bounds bug in iwl\_mvm\_wait\_d3\_notif()
commit 7a4615b9a9da5225b22b36a20508555dd133ac24 upstream.
kmemdup() at line 2735 is not duplicating enough memory for
notif->tid\_tear\_down and notif->station\_id. As it only duplicates
612 bytes: up to offsetofend(struct iwl\_wowlan\_info\_notif,
received\_beacons), this is the range of [0, 612) bytes.
2735 notif = kmemdup(notif\_v1,
2736 offsetofend(struct iwl\_wowlan\_info\_notif,
2737 received\_beacons),
2738 GFP\_ATOMIC);
which evidently does not cover bytes 612 and 613 for members
tid\_tear\_down and station\_id in struct iwl\_wowlan\_info\_notif.
See below:
$ pahole -C iwl\_wowlan\_info\_notif drivers/net/wireless/intel/iwlwifi/mvm/d3.o
struct iwl\_wowlan\_info\_notif {
struct iwl\_wowlan\_gtk\_status\_v3 gtk[2]; /\* 0 488 \*/
/\* --- cacheline 7 boundary (448 bytes) was 40 bytes ago --- \*/
struct iwl\_wowlan\_igtk\_status igtk[2]; /\* 488 80 \*/
/\* --- cacheline 8 boundary (512 bytes) was 56 bytes ago --- \*/
\_\_le64 replay\_ctr; /\* 568 8 \*/
/\* --- cacheline 9 boundary (576 bytes) --- \*/
\_\_le16 pattern\_number; /\* 576 2 \*/
\_\_le16 reserved1; /\* 578 2 \*/
\_\_le16 qos\_seq\_ctr[8]; /\* 580 16 \*/
\_\_le32 wakeup\_reasons; /\* 596 4 \*/
\_\_le32 num\_of\_gtk\_rekeys; /\* 600 4 \*/
\_\_le32 transmitted\_ndps; /\* 604 4 \*/
\_\_le32 received\_beacons; /\* 608 4 \*/
u8 tid\_tear\_down; /\* 612 1 \*/
u8 station\_id; /\* 613 1 \*/
u8 reserved2[2]; /\* 614 2 \*/
/\* size: 616, cachelines: 10, members: 13 \*/
/\* last cacheline: 40 bytes \*/
};
Therefore, when the following assignments take place, actually no memory
has been allocated for those objects:
2743 notif->tid\_tear\_down = notif\_v1->tid\_tear\_down;
2744 notif->station\_id = notif\_v1->station\_id;
Fix this by allocating space for the whole notif object and zero out the
remaining space in memory after member station\_id.
This also fixes the following -Warray-bounds issues:
CC drivers/net/wireless/intel/iwlwifi/mvm/d3.o
drivers/net/wireless/intel/iwlwifi/mvm/d3.c: In function ‘iwl\_mvm\_wait\_d3\_notif’:
drivers/net/wireless/intel/iwlwifi/mvm/d3.c:2743:30: warning: array subscript ‘struct iwl\_wowlan\_info\_notif[0]’ is partly outside array bounds of ‘unsigned char[612]’ [-Warray-bounds=]
2743 | notif->tid\_tear\_down = notif\_v1->tid\_tear\_down;
|
from drivers/net/wireless/intel/iwlwifi/mvm/d3.c:7:
In function ‘kmemdup’,
inlined from ‘iwl\_mvm\_wait\_d3\_notif’ at drivers/net/wireless/intel/iwlwifi/mvm/d3.c:2735:12:
include/linux/fortify-string.h:765:16: note: object of size 612 allocated by ‘\_\_real\_kmemdup’
765 | return \_\_real\_kmemdup(p, size, gfp);
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~
drivers/net/wireless/intel/iwlwifi/mvm/d3.c: In function ‘iwl\_mvm\_wait\_d3\_notif’:
drivers/net/wireless/intel/iwlwifi/mvm/d3.c:2744:30: warning: array subscript ‘struct iwl\_wowlan\_info\_notif[0]’ is partly outside array bounds of ‘unsigned char[612]’ [-Warray-bounds=]
2744 | notif->station\_id = notif\_v1->station\_id;
| ^~
In function ‘kmemdup’,
inlined from ‘iwl\_mvm\_wait\_d3\_notif’ at drivers/net/wireless/intel/iwlwifi/mvm/d3.c:2735:12:
include/linux/fortify-string.h:765:16: note: object of size 612 allocated by ‘\_\_real\_kmemdup’
765 | return \_\_real\_kmemdup(p, size, gfp);
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~
Link: https://github.com/KSPP/linux/issues/306
Fixes: 905d50ddbc83 ("wifi: iwlwifi: mvm: support wowlan info notification version 2")
Cc: stable@vger.kernel.org
Signed-off-by: Gustavo A. R. Silva
Acked-by: Gregory Greenman
Link: https://lore.kernel.org/r/ZHpGN555FwAKGduH@work
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 150e80c980b13df24ada0e38fe7be5aac25e1f86
Author: Samson Tam
Date: Tue May 9 16:40:19 2023 -0400
drm/amd/display: add ODM case when looking for first split pipe
commit 59de751e3845d699e02dc4da47322b92d83a41e2 upstream.
[Why]
When going from ODM 2:1 single display case to max displays, second
odm pipe needs to be repurposed for one of the new single displays.
However, acquire\_first\_split\_pipe() only handles MPC case and not
ODM case
[How]
Add ODM conditions in acquire\_first\_split\_pipe()
Add commit\_minimal\_transition\_state() in commit\_streams() to handle
odm 2:1 exit first, and then process new streams
Handle ODM condition in commit\_minimal\_transition\_state()
Cc: Mario Limonciello
Cc: Alex Deucher
Cc: stable@vger.kernel.org
Acked-by: Stylon Wang
Signed-off-by: Samson Tam
Reviewed-by: Alvin Lee
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit fffbac8af47db7a622dd7fe67a3b492c2210ca1d
Author: Alvin Lee
Date: Fri May 19 11:38:15 2023 -0400
drm/amd/display: Reduce sdp bw after urgent to 90%
commit e1a600208286c197c2696e51fc313e49889315bd upstream.
[Description]
Reduce expected SDP bandwidth due to poor QoS and
arbitration issues on high bandwidth configs
Cc: Mario Limonciello
Cc: Alex Deucher
Cc: stable@vger.kernel.org
Acked-by: Stylon Wang
Signed-off-by: Alvin Lee
Reviewed-by: Nevenko Stupar
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 3cd737d6919d365d23a13df893b7b2ee5032f3f3
Author: Lijo Lazar
Date: Fri Mar 31 16:30:01 2023 +0530
drm/amd/pm: Fix power context allocation in SMU13
commit 1d13c49cf4e246b218d71873f1bb1bbd376aa10e upstream.
Use the right data structure for allocation.
Signed-off-by: Lijo Lazar
Reviewed-by: Hawking Zhang
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 6967fd887755a6d1346b081d618ae555d9d7492f
Author: Mario Limonciello
Date: Tue May 30 11:57:59 2023 -0500
drm/amd: Disallow s0ix without BIOS support again
commit 30c3d3b70aba2464ee8c91025e91428f92464077 upstream.
commit cf488dcd0ab7 ("drm/amd: Allow s0ix without BIOS support") showed
improvements to power consumption over suspend when s0ix wasn't enabled in
BIOS and the system didn't support S3.
This patch however was misguided because the reason the system didn't
support S3 was because SMT was disabled in OEM BIOS setup.
This prevented the BIOS from allowing S3.
Also allowing GPUs to use the s2idle path actually causes problems if
they're invoked on systems that may not support s2idle in the platform
firmware. `systemd` has a tendency to try to use `s2idle` if `deep` fails
for any reason, which could lead to unexpected flows.
The original commit also fixed a problem during resume from suspend to idle
without hardware support, but this is no longer necessary with commit
ca4751866397 ("drm/amd: Don't allow s0ix on APUs older than Raven")
Revert commit cf488dcd0ab7 ("drm/amd: Allow s0ix without BIOS support")
to make it match the expected behavior again.
Cc: Rafael Ávila de Espíndola
Link: https://github.com/torvalds/linux/blob/v6.1/drivers/gpu/drm/amd/amdgpu/amdgpu\_acpi.c#L1060
Closes: https://gitlab.freedesktop.org/drm/amd/-/issues/2599
Reviewed-by: Alex Deucher
Signed-off-by: Mario Limonciello
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 644b74a215eec1fd39cccae66b734a1824702161
Author: YiPeng Chai
Date: Wed May 24 17:14:15 2023 +0800
drm/amdgpu: change reserved vram info print
commit dac652220ba0e5a2ef2da2a47a60b60aea333fdb upstream.
The link object of mgr->reserved\_pages is the blocks
variable in struct amdgpu\_vram\_reservation, not the
link variable in struct drm\_buddy\_block.
Signed-off-by: YiPeng Chai
Reviewed-by: Arunpravin Paneer Selvam
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit c1f2ff6bd529e5e9f0b073ed2821211f22435d5b
Author: Chia-I Wu
Date: Thu Jun 1 14:48:08 2023 -0700
drm/amdgpu: fix xclk freq on CHIP\_STONEY
commit b447b079cf3a9971ea4d31301e673f49612ccc18 upstream.
According to Alex, most APUs from that time seem to have the same issue
(vbios says 48Mhz, actual is 100Mhz). I only have a CHIP\_STONEY so I
limit the fixup to CHIP\_STONEY
Signed-off-by: Chia-I Wu
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 5028c814c3caf1f383905826446beeac1c518818
Author: Evan Quan
Date: Thu Apr 6 12:08:21 2023 +0800
drm/amd/pm: conditionally disable pcie lane switching for some sienna\_cichlid SKUs
commit 38e4ced804796c5725e2a52ec3601951552c4a97 upstream.
Disable the pcie lane switching for some sienna\_cichlid SKUs since it
might not work well on some platforms.
Signed-off-by: Evan Quan
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 23bf77b1ed053634df713b1853b5995ada279f84
Author: Andi Shyti
Date: Fri May 26 14:41:38 2023 +0200
drm/i915/gt: Use the correct error value when kernel\_context() fails
commit 40023959dbab3c6ad56fa7213770e63d197b69fb upstream.
kernel\_context() returns an error pointer. Use pointer-error
conversion functions to evaluate its return value, rather than
checking for a '0' return.
Fixes: eb5c10cbbc2f ("drm/i915: Remove I915\_USER\_PRIORITY\_SHIFT")
Reported-by: Dan Carpenter
Signed-off-by: Andi Shyti
Cc: Chris Wilson
Cc:  # v5.13+
Reviewed-by: Andrzej Hajda
Acked-by: Tejas Upadhyay
Link: https://patchwork.freedesktop.org/patch/msgid/20230526124138.2006110-1-andi.shyti@linux.intel.com
(cherry picked from commit edad9ee94f17adc75d3b13ab51bbe3d615ce1e7e)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Greg Kroah-Hartman
commit 6de30a67e3a81afc601dedaaf2aafc82729dd072
Author: Stefan Binding
Date: Mon Jun 5 16:33:08 2023 +0100
ALSA: hda/realtek: Add quirks for Asus ROG 2024 laptops using CS35L41
commit 811dd426a9b16cf61a86fdb12d5f5b983cbfb130 upstream.
Add support for Asus ROG 2024 models using CS35L41 SPI with Internal
Boost.
Signed-off-by: Stefan Binding
Cc:
Link: https://lore.kernel.org/r/20230605153308.448550-1-sbinding@opensource.cirrus.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 43c68a0cbbe590121723e2cb89746df2b260e2e0
Author: RenHai
Date: Fri Jun 2 08:36:04 2023 +0800
ALSA: hda/realtek: Add Lenovo P3 Tower platform
commit 7ca4c8d4d3f41c2cd9b4cf22bb829bf03dac0956 upstream.
Headset microphone on this platform does not work without
ALC897\_FIXUP\_HEADSET\_MIC\_PIN fixup.
Signed-off-by: RenHai
Cc:
Link: https://lore.kernel.org/r/20230602003604.975892-1-kean0048@gmail.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 03eb2a10280b1b359a834a9dbb6f68ce09154aca
Author: Ai Chao
Date: Fri May 26 17:47:04 2023 +0800
ALSA: hda/realtek: Add a quirk for HP Slim Desktop S01
commit 527c356b51f3ddee02c9ed5277538f85e30a2cdc upstream.
Add a quirk for HP Slim Desktop S01 to fixup headset MIC no presence.
Signed-off-by: Ai Chao
Cc:
Link: https://lore.kernel.org/r/20230526094704.14597-1-aichao@kylinos.cn
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 286e17a1c3baeb1b1cd36b63ee16e8a6e63d558e
Author: Jaroslav Kysela
Date: Tue Jun 6 09:31:22 2023 +0200
ALSA: ice1712,ice1724: fix the kcontrol->id initialization
commit b9a4efd61b6b9f62f83752959e75a5dae20624fa upstream.
The new xarray lookup code requires to know complete kcontrol->id before
snd\_ctl\_add() call. Reorder the code to make the initialization properly.
Cc: stable@kernel.org # v5.19+
Reported-by: Martin Zidek
Signed-off-by: Jaroslav Kysela
Link: https://lore.kernel.org/r/20230606073122.597491-1-perex@perex.cz
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 23dfdc7770feb09a183cef57858700e362132e20
Author: Tim Crawford
Date: Mon Jun 5 10:38:34 2023 -0600
ALSA: hda/realtek: Add quirk for Clevo NS50AU
commit da209f7a80dd633a32cbcbafe9e9f778933119c1 upstream.
Fixes headset detection on Clevo NS50AU.
Signed-off-by: Tim Crawford
Cc:
Link: https://lore.kernel.org/r/20230605163834.24653-1-tcrawford@system76.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 7bf12707fa3db4c14fbe8ab93efb421d8ca93bf8
Author: Takashi Iwai
Date: Tue Jun 6 11:38:53 2023 +0200
ALSA: cmipci: Fix kctl->id initialization
commit f2f312ad88c68a7f4a7789b9269ae33af3c7c7e9 upstream.
cmipci driver replaces the kctl->id.device after assigning the kctl
via snd\_ctl\_add(). This doesn't work any longer with the new Xarray
lookup change. It has to be set before snd\_ctl\_add() call instead.
Fixes: c27e1efb61c5 ("ALSA: control: Use xarray for faster lookups")
Cc:
Reviewed-by: Jaroslav Kysela
Link: https://lore.kernel.org/r/20230606093855.14685-3-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit a1374d2683442633f8ad2169f8f31df45048e008
Author: Takashi Iwai
Date: Tue Jun 6 11:38:54 2023 +0200
ALSA: gus: Fix kctl->id initialization
commit c5ae57b1bb99bd6f50b90428fabde397c2aeba0f upstream.
GUS driver replaces the kctl->id.index after assigning the kctl via
snd\_ctl\_add(). This doesn't work any longer with the new Xarray
lookup change. It has to be set before snd\_ctl\_add() call instead.
Fixes: c27e1efb61c5 ("ALSA: control: Use xarray for faster lookups")
Cc:
Reviewed-by: Jaroslav Kysela
Link: https://lore.kernel.org/r/20230606093855.14685-4-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit cf671d2462d9af50c328bcc185d2c7b9726f8093
Author: Takashi Iwai
Date: Tue Jun 6 11:38:52 2023 +0200
ALSA: ymfpci: Fix kctl->id initialization
commit c9b83ae4a1609b1914ba7fc70826a3f3a8b234db upstream.
ymfpci driver replaces the kctl->id.device after assigning the kctl
via snd\_ctl\_add(). This doesn't work any longer with the new Xarray
lookup change. It has to be set before snd\_ctl\_add() call instead.
Fixes: c27e1efb61c5 ("ALSA: control: Use xarray for faster lookups")
Cc:
Reviewed-by: Jaroslav Kysela
Link: https://lore.kernel.org/r/20230606093855.14685-2-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 9b9263b578122d23faa635218ef9b80dfa1f6498
Author: Takashi Iwai
Date: Tue Jun 6 11:38:55 2023 +0200
ALSA: hda: Fix kctl->id initialization
commit 5c219a340850233aecbb444af964653ecd3d1370 upstream.
HD-audio core code replaces the kctl->id.index of SPDIF-related
controls after assigning via snd\_ctl\_add(). This doesn't work any
longer with the new Xarray lookup change. The change of the kctl->id
content has to be done via snd\_ctl\_rename\_id() helper, instead.
Fixes: c27e1efb61c5 ("ALSA: control: Use xarray for faster lookups")
Cc:
Reviewed-by: Jaroslav Kysela
Link: https://lore.kernel.org/r/20230606093855.14685-5-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ab68e1f294527994b4019b7449ee920358b09e21
Author: Dmitry Torokhov
Date: Fri May 5 11:16:07 2023 -0700
Input: fix open count when closing inhibited device
commit 978134c4b192ed04ecf699be3e1b4d23b5d20457 upstream.
Because the kernel increments device's open count in input\_open\_device()
even if device is inhibited, the counter should always be decremented in
input\_close\_device() to keep it balanced.
Fixes: a181616487db ("Input: Add "inhibited" property")
Reviewed-by: Peter Hutterer
Link: https://lore.kernel.org/r/ZFFz0xAdPNSL3PT7@google.com
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 3c078a31648db3ec9409ea91b810973be11d1b3c
Author: Dmitry Torokhov
Date: Thu May 11 12:08:37 2023 -0700
Input: psmouse - fix OOB access in Elantech protocol
commit 7b63a88bb62ba2ddf5fcd956be85fe46624628b9 upstream.
The kernel only allocate 5 MT slots; check that transmitted slot ID
falls within the acceptable range.
Link: https://lore.kernel.org/r/ZFnEL91nrT789dbG@google.com
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 2085c98d48287254ffa655fa7a5eae451f8f0039
Author: Maximilian Weigand
Date: Mon May 1 17:07:49 2023 -0700
Input: cyttsp5 - fix array length
commit 529de2f1ca3f0898c0d905b7d355a43dce1de7dc upstream.
The cmd array should be initialized with the proper command size and not
with the actual command value that is sent to the touchscreen.
Signed-off-by: Maximilian Weigand
Reviewed-by: Alistair Francis
Link: https://lore.kernel.org/r/20230501113010.891786-2-mweigand@mweigand.net
Fixes: 5b0c03e24a06 ("Input: Add driver for Cypress Generation 5 touchscreen")
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 5ff3e47659c057270455b6c5ed7cea59f07ae71e
Author: Ismael Ferreras Morezuelas
Date: Tue May 23 14:45:10 2023 -0700
Input: xpad - delete a Razer DeathAdder mouse VID/PID entry
commit feee70f4568650cf44c573488798ffc0a2faeea3 upstream.
While doing my research to improve the xpad device names I noticed
that the 1532:0037 VID/PID seems to be used by the DeathAdder 2013,
so that Razer Sabertooth instance looked wrong and very suspect to
me. I didn't see any mention in the official drivers, either.
After doing more research, it turns out that the xpad list
is used by many other projects (like Steam) as-is [1], this
issue was reported [2] and Valve/Sam Lantinga fixed it [3]:
[1]: https://github.com/libsdl-org/SDL/blob/dcc5eef0e2395854b254ea2873a4899edab347c6/src/joystick/controller\_type.h#L251
[2]: https://steamcommunity.com/app/353380/discussions/0/1743392486228754770/
[3]: https://hg.libsdl.org/SDL/rev/29809f6f0271
(With multiple Internet users reporting similar issues, not linked here)
After not being able to find the correct VID/PID combination anywhere
on the Internet and not receiving any reply from Razer support I did
some additional detective work, it seems like it presents itself as
"Razer Sabertooth Gaming Controller (XBOX360)", code 1689:FE00.
Leaving us with this:
\* Razer Sabertooth (1689:fe00)
\* Razer Sabertooth Elite (24c6:5d04)
\* Razer DeathAdder 2013 (1532:0037) [note: not a gamepad]
So, to sum things up; remove this conflicting/duplicate entry:
{ 0x1532, 0x0037, "Razer Sabertooth", 0, XTYPE\_XBOX360 },
As the real/correct one is already present there, even if
the Internet as a whole insists on presenting it as the
Razer Sabertooth Elite, which (by all accounts) is not:
{ 0x1689, 0xfe00, "Razer Sabertooth", 0, XTYPE\_XBOX360 },
Actual change in SDL2 referencing this kernel issue:
https://github.com/libsdl-org/SDL/commit/e5e54169754ca5d3e86339d968b20126d9da0a15
For more information of the device, take a look here:
https://github.com/xboxdrv/xboxdrv/pull/59
You can see a lsusb dump here: https://github.com/xboxdrv/xboxdrv/files/76581/Qa6dBcrv.txt
Fixes: f554f619b70 ("Input: xpad - sync device IDs with xboxdrv")
Signed-off-by: Ismael Ferreras Morezuelas
Reviewed-by: Cameron Gutman
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/5c12dbdb-5774-fc68-5c58-ca596383663e@gmail.com
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 775ff622dd9bdd14e70e764e69495876d7ae1f7e
Author: Vladislav Efanov
Date: Fri May 26 19:16:32 2023 +0300
batman-adv: Broken sync while rescheduling delayed work
commit abac3ac97fe8734b620e7322a116450d7f90aa43 upstream.
Syzkaller got a lot of crashes like:
KASAN: use-after-free Write in \*\_timers\*
All of these crashes point to the same memory area:
The buggy address belongs to the object at ffff88801f870000
which belongs to the cache kmalloc-8k of size 8192
The buggy address is located 5320 bytes inside of
8192-byte region [ffff88801f870000, ffff88801f872000)
This area belongs to :
batadv\_priv->batadv\_priv\_dat->delayed\_work->timer\_list
The reason for these issues is the lack of synchronization. Delayed
work (batadv\_dat\_purge) schedules new timer/work while the device
is being deleted. As the result new timer/delayed work is set after
cancel\_delayed\_work\_sync() was called. So after the device is freed
the timer list contains pointer to already freed memory.
Found by Linux Verification Center (linuxtesting.org) with syzkaller.
Cc: stable@kernel.org
Fixes: 2f1dfbe18507 ("batman-adv: Distributed ARP Table - implement local storage")
Signed-off-by: Vladislav Efanov
Acked-by: Sven Eckelmann
Signed-off-by: Simon Wunderlich
Signed-off-by: Greg Kroah-Hartman
commit 181295bfd8428d3c24a3ad708eeeaaa1ebdc056a
Author: Dmitry Baryshkov
Date: Mon Apr 10 19:59:08 2023 +0300
drm/msm/a6xx: initialize GMU mutex earlier
[ Upstream commit 12abd735f0300600bfc01b2a3832b966312df205 ]
Move GMU mutex initialization earlier to make sure that it is always
initialized. a6xx\_destroy can be called from ther failure path before
GMU initialization.
This fixes the following backtrace:
------------[ cut here ]------------
DEBUG\_LOCKS\_WARN\_ON(lock->magic != lock)
WARNING: CPU: 0 PID: 58 at kernel/locking/mutex.c:582 \_\_mutex\_lock+0x1ec/0x3d0
Modules linked in:
CPU: 0 PID: 58 Comm: kworker/u16:1 Not tainted 6.3.0-rc5-00155-g187c06436519 #565
Hardware name: Qualcomm Technologies, Inc. SM8350 HDK (DT)
Workqueue: events\_unbound deferred\_probe\_work\_func
pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : \_\_mutex\_lock+0x1ec/0x3d0
lr : \_\_mutex\_lock+0x1ec/0x3d0
sp : ffff800008993620
x29: ffff800008993620 x28: 0000000000000002 x27: ffff47b253c52800
x26: 0000000001000606 x25: ffff47b240bb2810 x24: fffffffffffffff4
x23: 0000000000000000 x22: ffffc38bba15ac14 x21: 0000000000000002
x20: ffff800008993690 x19: ffff47b2430cc668 x18: fffffffffffe98f0
x17: 6f74616c75676572 x16: 20796d6d75642067 x15: 0000000000000038
x14: 0000000000000000 x13: ffffc38bbba050b8 x12: 0000000000000666
x11: 0000000000000222 x10: ffffc38bbba603e8 x9 : ffffc38bbba050b8
x8 : 00000000ffffefff x7 : ffffc38bbba5d0b8 x6 : 0000000000000222
x5 : 000000000000bff4 x4 : 40000000fffff222 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000000 x0 : ffff47b240cb1880
Call trace:
\_\_mutex\_lock+0x1ec/0x3d0
mutex\_lock\_nested+0x2c/0x38
a6xx\_destroy+0xa0/0x138
a6xx\_gpu\_init+0x41c/0x618
adreno\_bind+0x188/0x290
component\_bind\_all+0x118/0x248
msm\_drm\_bind+0x1c0/0x670
try\_to\_bring\_up\_aggregate\_device+0x164/0x1d0
\_\_component\_add+0xa8/0x16c
component\_add+0x14/0x20
dsi\_dev\_attach+0x20/0x2c
dsi\_host\_attach+0x9c/0x144
devm\_mipi\_dsi\_attach+0x34/0xac
lt9611uxc\_attach\_dsi.isra.0+0x84/0xfc
lt9611uxc\_probe+0x5b8/0x67c
i2c\_device\_probe+0x1ac/0x358
really\_probe+0x148/0x2ac
\_\_driver\_probe\_device+0x78/0xe0
driver\_probe\_device+0x3c/0x160
\_\_device\_attach\_driver+0xb8/0x138
bus\_for\_each\_drv+0x84/0xe0
\_\_device\_attach+0x9c/0x188
device\_initial\_probe+0x14/0x20
bus\_probe\_device+0xac/0xb0
deferred\_probe\_work\_func+0x8c/0xc8
process\_one\_work+0x2bc/0x594
worker\_thread+0x228/0x438
kthread+0x108/0x10c
ret\_from\_fork+0x10/0x20
irq event stamp: 299345
hardirqs last enabled at (299345): [] put\_cpu\_partial+0x1c8/0x22c
hardirqs last disabled at (299344): [] put\_cpu\_partial+0x1c0/0x22c
softirqs last enabled at (296752): [] \_stext+0x434/0x4e8
softirqs last disabled at (296741): [] \_\_\_\_do\_softirq+0x10/0x1c
---[ end trace 0000000000000000 ]---
Fixes: 4cd15a3e8b36 ("drm/msm/a6xx: Make GPU destroy a bit safer")
Cc: Douglas Anderson
Signed-off-by: Dmitry Baryshkov
Reviewed-by: Douglas Anderson
Patchwork: https://patchwork.freedesktop.org/patch/531540/
Signed-off-by: Rob Clark
Signed-off-by: Sasha Levin
commit 11c6580cc31538bf202f7646523d3089f0cb9275
Author: Somnath Kotur
Date: Wed Jun 7 00:54:09 2023 -0700
bnxt\_en: Implement .set\_port / .unset\_port UDP tunnel callbacks
[ Upstream commit 1eb4ef12591348c440ac9d6efcf7521e73cf2b10 ]
As per the new udp tunnel framework, drivers which need to know the
details of a port entry (i.e. port type) when it gets deleted should
use the .set\_port / .unset\_port callbacks.
Implementing the current .udp\_tunnel\_sync callback would mean that the
deleted tunnel port entry would be all zeros. This used to work on
older firmware because it would not check the input when deleting a
tunnel port. With newer firmware, the delete will now fail and
subsequent tunnel port allocation will fail as a result.
Fixes: 442a35a5a7aa ("bnxt: convert to new udp\_tunnel\_nic infra")
Reviewed-by: Kalesh Anakkur Purayil
Signed-off-by: Somnath Kotur
Signed-off-by: Michael Chan
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 637fa17e6efabd0092e870dca38545ea47660cee
Author: Pavan Chebbi
Date: Wed Jun 7 00:54:08 2023 -0700
bnxt\_en: Prevent kernel panic when receiving unexpected PHC\_UPDATE event
[ Upstream commit 319a7827df9784048abe072afe6b4fb4501d8de4 ]
The firmware can send PHC\_RTC\_UPDATE async event on a PF that may not
have PTP registered. In such a case, there will be a null pointer
deference for bp->ptp\_cfg when we try to handle the event.
Fix it by not registering for this event with the firmware if !bp->ptp\_cfg.
Also, check that bp->ptp\_cfg is valid before proceeding when we receive
the event.
Fixes: 8bcf6f04d4a5 ("bnxt\_en: Handle async event when the PHC is updated in RTC mode")
Signed-off-by: Pavan Chebbi
Signed-off-by: Michael Chan
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit b41a23551ed8d688ec9fcc54758e476fe925cc9e
Author: Vikas Gupta
Date: Wed Jun 7 00:54:07 2023 -0700
bnxt\_en: Skip firmware fatal error recovery if chip is not accessible
[ Upstream commit 83474a9b252ab23e6003865c2775024344cb9c09 ]
Driver starts firmware fatal error recovery by detecting
heartbeat failure or fw reset count register changing. But
these checks are not reliable if the device is not accessible.
This can happen while DPC (Downstream Port containment) is in
progress. Skip firmware fatal recovery if pci\_device\_is\_present()
returns false.
Fixes: acfb50e4e773 ("bnxt\_en: Add FW fatal devlink\_health\_reporter.")
Reviewed-by: Somnath Kotur
Reviewed-by: Pavan Chebbi
Signed-off-by: Vikas Gupta
Signed-off-by: Michael Chan
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 0d4a88949a32dc03acb25684daba5e784fd27cc0
Author: Somnath Kotur
Date: Wed Jun 7 00:54:06 2023 -0700
bnxt\_en: Query default VLAN before VNIC setup on a VF
[ Upstream commit 1a9e4f501bc6ff1b6ecb60df54fbf2b54db43bfe ]
We need to call bnxt\_hwrm\_func\_qcfg() on a VF to query the default
VLAN that may be setup by the PF. If a default VLAN is enabled,
the VF cannot support VLAN acceleration on the receive side and
the VNIC must be setup to strip out the default VLAN tag. If a
default VLAN is not enabled, the VF can support VLAN acceleration
on the receive side. The VNIC should be set up to strip or not
strip the VLAN based on the RX VLAN acceleration setting.
Without this call to determine the default VLAN before calling
bnxt\_setup\_vnic(), the VNIC may not be set up correctly. For
example, bnxt\_setup\_vnic() may set up to strip the VLAN tag based
on stale default VLAN information. If RX VLAN acceleration is
not enabled, the VLAN tag will be incorrectly stripped and the
RX data path will not work correctly.
Fixes: cf6645f8ebc6 ("bnxt\_en: Add function for VF driver to query default VLAN.")
Reviewed-by: Pavan Chebbi
Signed-off-by: Somnath Kotur
Signed-off-by: Michael Chan
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 55dd3c2db8805014f0b9a6a464a2cdda73a6d7b1
Author: Sreekanth Reddy
Date: Wed Jun 7 00:54:05 2023 -0700
bnxt\_en: Don't issue AP reset during ethtool's reset operation
[ Upstream commit 1d997801c7cc6a7f542e46d5a6bf16f893ad3fe9 ]
Only older NIC controller's firmware uses the PROC AP reset type.
Firmware on 5731X/5741X and newer chips does not support this reset
type. When bnxt\_reset() issues a series of resets, this PROC AP
reset may actually fail on these newer chips because the firmware
is not ready to accept this unsupported command yet. Avoid this
unnecessary error by skipping this reset type on chips that don't
support it.
Fixes: 7a13240e3718 ("bnxt\_en: fix ethtool\_reset\_flags ABI violations")
Reviewed-by: Pavan Chebbi
Signed-off-by: Sreekanth Reddy
Signed-off-by: Michael Chan
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 7965d918047f39b130e01691c1d870661b58d011
Author: Pavan Chebbi
Date: Wed Jun 7 00:54:04 2023 -0700
bnxt\_en: Fix bnxt\_hwrm\_update\_rss\_hash\_cfg()
[ Upstream commit 095d5dc0c1d9f3284e3c575ccf4c0e8b04b548f8 ]
We must specify the vnic id of the vnic in the input structure of this
firmware message. Otherwise we will get an error from the firmware.
Fixes: 98a4322b70e8 ("bnxt\_en: update RSS config using difference algorithm")
Reviewed-by: Kalesh Anakkur Purayil
Reviewed-by: Somnath Kotur
Signed-off-by: Pavan Chebbi
Signed-off-by: Michael Chan
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit a096f7b8c8629e1184e355255c0e8ec4ca47e560
Author: Stanislaw Gruszka
Date: Thu May 25 12:38:18 2023 +0200
accel/ivpu: Do not use mutex\_lock\_interruptible
[ Upstream commit b563e47957af4ff71736c5cc4120a59b055ab583 ]
If we get signal when waiting for the mmu->lock we do not invalidate
current MMU configuration that might result in undefined behavior.
Additionally there is little or no benefit on break waiting for
ipc->lock. In current code base, we keep this lock for short periods.
Fixes: 263b2ba5fc93 ("accel/ivpu: Add Intel VPU MMU support")
Reviewed-by: Krystian Pradzynski
Reviewed-by: Jeffrey Hugo
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230525103818.877590-2-stanislaw.gruszka@linux.intel.com
Signed-off-by: Sasha Levin
commit cb459a104b8c3a23242668d99863cf52f7686337
Author: Florian Fainelli
Date: Tue Jun 6 14:43:47 2023 -0700
net: bcmgenet: Fix EEE implementation
[ Upstream commit a9f31047baca57d47440c879cf259b86f900260c ]
We had a number of short comings:
- EEE must be re-evaluated whenever the state machine detects a link
change as wight be switching from a link partner with EEE
enabled/disabled
- tx\_lpi\_enabled controls whether EEE should be enabled/disabled for the
transmit path, which applies to the TBUF block
- We do not need to forcibly enable EEE upon system resume, as the PHY
state machine will trigger a link event that will do that, too
Fixes: 6ef398ea60d9 ("net: bcmgenet: add EEE support")
Signed-off-by: Florian Fainelli
Reviewed-by: Russell King (Oracle)
Link: https://lore.kernel.org/r/20230606214348.2408018-1-florian.fainelli@broadcom.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit c66ad0cddab764e89bcfdfba1f0abcb9100e40ef
Author: Ben Hutchings
Date: Fri Jun 2 20:28:15 2023 +0200
lib: cpu\_rmap: Fix potential use-after-free in irq\_cpu\_rmap\_release()
[ Upstream commit 7c5d4801ecf0564c860033d89726b99723c55146 ]
irq\_cpu\_rmap\_release() calls cpu\_rmap\_put(), which may free the rmap.
So we need to clear the pointer to our glue structure in rmap before
doing that, not after.
Fixes: 4e0473f1060a ("lib: cpu\_rmap: Avoid use after free on rmap->obj array entries")
Signed-off-by: Ben Hutchings
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/ZHo0vwquhOy3FaXc@decadent.org.uk
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 25b33bab2b3fb3c0a71014642d28f95982665a00
Author: Horatio Zhang
Date: Mon May 29 14:23:37 2023 -0400
drm/amdgpu: fix Null pointer dereference error in amdgpu\_device\_recover\_vram
[ Upstream commit 2a1eb1a343208ce7d6839b73d62aece343e693ff ]
Use the function of amdgpu\_bo\_vm\_destroy to handle the resource release
of shadow bo. During the amdgpu\_mes\_self\_test, shadow bo released, but
vmbo->shadow\_list was not, which caused a null pointer reference error
in amdgpu\_device\_recover\_vram when GPU reset.
Fixes: 6c032c37ac3e ("drm/amdgpu: Fix vram recover doesn't work after whole GPU reset (v2)")
Signed-off-by: xinhui pan
Signed-off-by: Horatio Zhang
Acked-by: Feifei Xu
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit e70f3fd548669f5e5015ce4a66cc476e23ef5874
Author: Jiri Olsa
Date: Tue Jun 6 11:17:14 2023 -0700
bpf: Add extra path pointer check to d\_path helper
[ Upstream commit f46fab0e36e611a2389d3843f34658c849b6bd60 ]
Anastasios reported crash on stable 5.15 kernel with following
BPF attached to lsm hook:
SEC("lsm.s/bprm\_creds\_for\_exec")
int BPF\_PROG(bprm\_creds\_for\_exec, struct linux\_binprm \*bprm)
{
struct path \*path = &bprm->executable->f\_path;
char p[128] = { 0 };
bpf\_d\_path(path, p, 128);
return 0;
}
But bprm->executable can be NULL, so bpf\_d\_path call will crash:
BUG: kernel NULL pointer dereference, address: 0000000000000018
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP DEBUG\_PAGEALLOC NOPTI
...
RIP: 0010:d\_path+0x22/0x280
...
Call Trace:
bpf\_d\_path+0x21/0x60
bpf\_prog\_db9cf176e84498d9\_bprm\_creds\_for\_exec+0x94/0x99
bpf\_trampoline\_6442506293\_0+0x55/0x1000
bpf\_lsm\_bprm\_creds\_for\_exec+0x5/0x10
security\_bprm\_creds\_for\_exec+0x29/0x40
bprm\_execve+0x1c1/0x900
do\_execveat\_common.isra.0+0x1af/0x260
\_\_x64\_sys\_execve+0x32/0x40
It's problem for all stable trees with bpf\_d\_path helper, which was
added in 5.9.
This issue is fixed in current bpf code, where we identify and mark
trusted pointers, so the above code would fail even to load.
For the sake of the stable trees and to workaround potentially broken
verifier in the future, adding the code that reads the path object from
the passed pointer and verifies it's valid in kernel space.
Fixes: 6e22ab9da793 ("bpf: Add d\_path helper")
Reported-by: Anastasios Papagiannis
Suggested-by: Alexei Starovoitov
Signed-off-by: Jiri Olsa
Signed-off-by: Daniel Borkmann
Acked-by: Stanislav Fomichev
Acked-by: Yonghong Song
Link: https://lore.kernel.org/bpf/20230606181714.532998-1-jolsa@kernel.org
Signed-off-by: Sasha Levin
commit 16299c79217742c7c70829428f7572d60314e752
Author: Hangyu Hua
Date: Wed Jun 7 10:23:01 2023 +0800
net: sched: fix possible refcount leak in tc\_chain\_tmplt\_add()
[ Upstream commit 44f8baaf230c655c249467ca415b570deca8df77 ]
try\_module\_get will be called in tcf\_proto\_lookup\_ops. So module\_put needs
to be called to drop the refcount if ops don't implement the required
function.
Fixes: 9f407f1768d3 ("net: sched: introduce chain templates")
Signed-off-by: Hangyu Hua
Reviewed-by: Larysa Zaremba
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ce6bd2af12e1f9cf2f45fd9cf57736f76b15364e
Author: Eric Dumazet
Date: Tue Jun 6 13:13:04 2023 +0000
net: sched: act\_police: fix sparse errors in tcf\_police\_dump()
[ Upstream commit 682881ee45c81daa883dcd4fe613b0b0d988bb22 ]
Fixes following sparse errors:
net/sched/act\_police.c:360:28: warning: dereference of noderef expression
net/sched/act\_police.c:362:45: warning: dereference of noderef expression
net/sched/act\_police.c:362:45: warning: dereference of noderef expression
net/sched/act\_police.c:368:28: warning: dereference of noderef expression
net/sched/act\_police.c:370:45: warning: dereference of noderef expression
net/sched/act\_police.c:370:45: warning: dereference of noderef expression
net/sched/act\_police.c:376:45: warning: dereference of noderef expression
net/sched/act\_police.c:376:45: warning: dereference of noderef expression
Fixes: d1967e495a8d ("net\_sched: act\_police: add 2 new attributes to support police 64bit rate and peakrate")
Signed-off-by: Eric Dumazet
Reviewed-by: Simon Horman
Acked-by: Jamal Hadi Salim
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6ede0583c4288d1b12fc3a66d2ca12cfb20d715e
Author: Eelco Chaudron
Date: Tue Jun 6 13:56:35 2023 +0200
net: openvswitch: fix upcall counter access before allocation
[ Upstream commit de9df6c6b27e22d7bdd20107947ef3a20e687de5 ]
Currently, the per cpu upcall counters are allocated after the vport is
created and inserted into the system. This could lead to the datapath
accessing the counters before they are allocated resulting in a kernel
Oops.
Here is an example:
PID: 59693 TASK: ffff0005f4f51500 CPU: 0 COMMAND: "ovs-vswitchd"
#0 [ffff80000a39b5b0] \_\_switch\_to at ffffb70f0629f2f4
#1 [ffff80000a39b5d0] \_\_schedule at ffffb70f0629f5cc
#2 [ffff80000a39b650] preempt\_schedule\_common at ffffb70f0629fa60
#3 [ffff80000a39b670] dynamic\_might\_resched at ffffb70f0629fb58
#4 [ffff80000a39b680] mutex\_lock\_killable at ffffb70f062a1388
#5 [ffff80000a39b6a0] pcpu\_alloc at ffffb70f0594460c
#6 [ffff80000a39b750] \_\_alloc\_percpu\_gfp at ffffb70f05944e68
#7 [ffff80000a39b760] ovs\_vport\_cmd\_new at ffffb70ee6961b90 [openvswitch]
...
PID: 58682 TASK: ffff0005b2f0bf00 CPU: 0 COMMAND: "kworker/0:3"
#0 [ffff80000a5d2f40] machine\_kexec at ffffb70f056a0758
#1 [ffff80000a5d2f70] \_\_crash\_kexec at ffffb70f057e2994
#2 [ffff80000a5d3100] crash\_kexec at ffffb70f057e2ad8
#3 [ffff80000a5d3120] die at ffffb70f0628234c
#4 [ffff80000a5d31e0] die\_kernel\_fault at ffffb70f062828a8
#5 [ffff80000a5d3210] \_\_do\_kernel\_fault at ffffb70f056a31f4
#6 [ffff80000a5d3240] do\_bad\_area at ffffb70f056a32a4
#7 [ffff80000a5d3260] do\_translation\_fault at ffffb70f062a9710
#8 [ffff80000a5d3270] do\_mem\_abort at ffffb70f056a2f74
#9 [ffff80000a5d32a0] el1\_abort at ffffb70f06297dac
#10 [ffff80000a5d32d0] el1h\_64\_sync\_handler at ffffb70f06299b24
#11 [ffff80000a5d3410] el1h\_64\_sync at ffffb70f056812dc
#12 [ffff80000a5d3430] ovs\_dp\_upcall at ffffb70ee6963c84 [openvswitch]
#13 [ffff80000a5d3470] ovs\_dp\_process\_packet at ffffb70ee6963fdc [openvswitch]
#14 [ffff80000a5d34f0] ovs\_vport\_receive at ffffb70ee6972c78 [openvswitch]
#15 [ffff80000a5d36f0] netdev\_port\_receive at ffffb70ee6973948 [openvswitch]
#16 [ffff80000a5d3720] netdev\_frame\_hook at ffffb70ee6973a28 [openvswitch]
#17 [ffff80000a5d3730] \_\_netif\_receive\_skb\_core.constprop.0 at ffffb70f06079f90
We moved the per cpu upcall counter allocation to the existing vport
alloc and free functions to solve this.
Fixes: 95637d91fefd ("net: openvswitch: release vport resources on failure")
Fixes: 1933ea365aa7 ("net: openvswitch: Add support to count upcall packets")
Signed-off-by: Eelco Chaudron
Reviewed-by: Simon Horman
Acked-by: Aaron Conole
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 673817c917304add15dc20202f7d8cb18ad62deb
Author: Eric Dumazet
Date: Tue Jun 6 11:42:33 2023 +0000
net: sched: move rtm\_tca\_policy declaration to include file
[ Upstream commit 886bc7d6ed3357975c5f1d3c784da96000d4bbb4 ]
rtm\_tca\_policy is used from net/sched/sch\_api.c and net/sched/cls\_api.c,
thus should be declared in an include file.
This fixes the following sparse warning:
net/sched/sch\_api.c:1434:25: warning: symbol 'rtm\_tca\_policy' was not declared. Should it be static?
Fixes: e331473fee3d ("net/sched: cls\_api: add missing validation of netlink attributes")
Signed-off-by: Eric Dumazet
Acked-by: Jamal Hadi Salim
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c7a1cabefee6b07b2b0c3f1ea2745c13ae804236
Author: Michal Schmidt
Date: Tue Jun 6 10:12:53 2023 -0700
ice: make writes to /dev/gnssX synchronous
[ Upstream commit bf15bb38ec7f4ff522da5c20e1673dbda7159938 ]
The current ice driver's GNSS write implementation buffers writes and
works through them asynchronously in a kthread. That's bad because:
- The GNSS write\_raw operation is supposed to be synchronous[1][2].
- There is no upper bound on the number of pending writes.
Userspace can submit writes much faster than the driver can process,
consuming unlimited amounts of kernel memory.
A patch that's currently on review[3] ("[v3,net] ice: Write all GNSS
buffers instead of first one") would add one more problem:
- The possibility of waiting for a very long time to flush the write
work when doing rmmod, softlockups.
To fix these issues, simplify the implementation: Drop the buffering,
the write\_work, and make the writes synchronous.
I tested this with gpsd and ubxtool.
[1] https://events19.linuxfoundation.org/wp-content/uploads/2017/12/The-GNSS-Subsystem-Johan-Hovold-Hovold-Consulting-AB.pdf
"User interface" slide.
[2] A comment in drivers/gnss/core.c:gnss\_write():
/\* Ignoring O\_NONBLOCK, write\_raw() is synchronous. \*/
[3] https://patchwork.ozlabs.org/project/intel-wired-lan/patch/20230217120541.16745-1-karol.kolacinski@intel.com/
Fixes: d6b98c8d242a ("ice: add write functionality for GNSS TTY")
Signed-off-by: Michal Schmidt
Reviewed-by: Simon Horman
Tested-by: Sunitha Mekala  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e60837c1694bf686e85141b590eed39d68038c8c
Author: Tvrtko Ursulin
Date: Mon Jun 5 14:11:35 2023 +0100
drm/i915/selftests: Add some missing error propagation
[ Upstream commit 79d0150d2d983a4f6efee676cea06027f586fcd0 ]
Add some missing error propagation in live\_parallel\_switch.
To avoid needlessly burdening the various backport processes, note I am
not marking it as a fix against any patches and not copying stable since
it is debug/selftests only code.
Signed-off-by: Tvrtko Ursulin
Reported-by: Dan Carpenter
Cc: Andi Shyti
Reviewed-by: Andi Shyti
Fixes: 50d16d44cce4 ("drm/i915/selftests: Exercise context switching in parallel")
Fixes: 6407cf533217 ("drm/i915/selftests: Stop using kthread\_stop()")
Link: https://patchwork.freedesktop.org/patch/msgid/20230605131135.396854-1-tvrtko.ursulin@linux.intel.com
(cherry picked from commit 412fa1f097f48c8c1321806dd25e46618e0da147)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit 3a4741bb13caf482b877b10ac1bcf7390cad7077
Author: Eric Dumazet
Date: Tue Jun 6 11:19:29 2023 +0000
net: sched: add rcu annotations around qdisc->qdisc\_sleeping
[ Upstream commit d636fc5dd692c8f4e00ae6e0359c0eceeb5d9bdb ]
syzbot reported a race around qdisc->qdisc\_sleeping [1]
It is time we add proper annotations to reads and writes to/from
qdisc->qdisc\_sleeping.
[1]
BUG: KCSAN: data-race in dev\_graft\_qdisc / qdisc\_lookup\_rcu
read to 0xffff8881286fc618 of 8 bytes by task 6928 on cpu 1:
qdisc\_lookup\_rcu+0x192/0x2c0 net/sched/sch\_api.c:331
\_\_tcf\_qdisc\_find+0x74/0x3c0 net/sched/cls\_api.c:1174
tc\_get\_tfilter+0x18f/0x990 net/sched/cls\_api.c:2547
rtnetlink\_rcv\_msg+0x7af/0x8c0 net/core/rtnetlink.c:6386
netlink\_rcv\_skb+0x126/0x220 net/netlink/af\_netlink.c:2546
rtnetlink\_rcv+0x1c/0x20 net/core/rtnetlink.c:6413
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1339 [inline]
netlink\_unicast+0x56f/0x640 net/netlink/af\_netlink.c:1365
netlink\_sendmsg+0x665/0x770 net/netlink/af\_netlink.c:1913
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_\_\_sys\_sendmsg+0x375/0x4c0 net/socket.c:2503
\_\_\_sys\_sendmsg net/socket.c:2557 [inline]
\_\_sys\_sendmsg+0x1e3/0x270 net/socket.c:2586
\_\_do\_sys\_sendmsg net/socket.c:2595 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2593 [inline]
\_\_x64\_sys\_sendmsg+0x46/0x50 net/socket.c:2593
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
write to 0xffff8881286fc618 of 8 bytes by task 6912 on cpu 0:
dev\_graft\_qdisc+0x4f/0x80 net/sched/sch\_generic.c:1115
qdisc\_graft+0x7d0/0xb60 net/sched/sch\_api.c:1103
tc\_modify\_qdisc+0x712/0xf10 net/sched/sch\_api.c:1693
rtnetlink\_rcv\_msg+0x807/0x8c0 net/core/rtnetlink.c:6395
netlink\_rcv\_skb+0x126/0x220 net/netlink/af\_netlink.c:2546
rtnetlink\_rcv+0x1c/0x20 net/core/rtnetlink.c:6413
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1339 [inline]
netlink\_unicast+0x56f/0x640 net/netlink/af\_netlink.c:1365
netlink\_sendmsg+0x665/0x770 net/netlink/af\_netlink.c:1913
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_\_\_sys\_sendmsg+0x375/0x4c0 net/socket.c:2503
\_\_\_sys\_sendmsg net/socket.c:2557 [inline]
\_\_sys\_sendmsg+0x1e3/0x270 net/socket.c:2586
\_\_do\_sys\_sendmsg net/socket.c:2595 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2593 [inline]
\_\_x64\_sys\_sendmsg+0x46/0x50 net/socket.c:2593
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 6912 Comm: syz-executor.5 Not tainted 6.4.0-rc3-syzkaller-00190-g0d85b27b0cc6 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 05/16/2023
Fixes: 3a7d0d07a386 ("net: sched: extend Qdisc with rcu")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Cc: Vlad Buslov
Acked-by: Jamal Hadi Salim
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit bced76c83b231e610e59fc7331db6ac30ae9bdcb
Author: Eric Dumazet
Date: Tue Jun 6 07:41:15 2023 +0000
rfs: annotate lockless accesses to RFS sock flow table
[ Upstream commit 5c3b74a92aa285a3df722bf6329ba7ccf70346d6 ]
Add READ\_ONCE()/WRITE\_ONCE() on accesses to the sock flow table.
This also prevents a (smart ?) compiler to remove the condition in:
if (table->ents[index] != newval)
table->ents[index] = newval;
We need the condition to avoid dirtying a shared cache line.
Fixes: fec5e652e58f ("rfs: Receive Flow Steering")
Signed-off-by: Eric Dumazet
Reviewed-by: Simon Horman
Reviewed-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cf7436ec9d18a3a3cab187ffb8ee5db6d3e9d778
Author: Eric Dumazet
Date: Tue Jun 6 07:41:14 2023 +0000
rfs: annotate lockless accesses to sk->sk\_rxhash
[ Upstream commit 1e5c647c3f6d4f8497dedcd226204e1880e0ffb3 ]
Add READ\_ONCE()/WRITE\_ONCE() on accesses to sk->sk\_rxhash.
This also prevents a (smart ?) compiler to remove the condition in:
if (sk->sk\_rxhash != newval)
sk->sk\_rxhash = newval;
We need the condition to avoid dirtying a shared cache line.
Fixes: fec5e652e58f ("rfs: Receive Flow Steering")
Signed-off-by: Eric Dumazet
Reviewed-by: Simon Horman
Reviewed-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 679fed7e3b30e8ff8695983d3553d89b2b110059
Author: Eric Dumazet
Date: Mon Jun 5 16:16:47 2023 +0000
tcp: gso: really support BIG TCP
[ Upstream commit 82a01ab35bd02ba4b0b4e12bc95c5b69240eb7b0 ]
We missed that tcp\_gso\_segment() was assuming skb->len was smaller than 65535 :
oldlen = (u16)~skb->len;
This part came with commit 0718bcc09b35 ("[NET]: Fix CHECKSUM\_HW GSO problems.")
This leads to wrong TCP checksum.
Adapt the code to accept arbitrary packet length.
v2:
- use two csum\_add() instead of csum\_fold() (Alexander Duyck)
- Change delta type to \_\_wsum to reduce casts (Alexander Duyck)
Fixes: 09f3d1a3a52c ("ipv6/gso: remove temporary HBH/jumbo header")
Signed-off-by: Eric Dumazet
Reviewed-by: Alexander Duyck
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230605161647.3624428-1-edumazet@google.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 1a62bdd2f9400a568e4a2772e72b498a539df1c2
Author: Kuniyuki Iwashima
Date: Mon Jun 5 11:06:17 2023 -0700
ipv6: rpl: Fix Route of Death.
[ Upstream commit a2f4c143d76b1a47c91ef9bc46907116b111da0b ]
A remote DoS vulnerability of RPL Source Routing is assigned CVE-2023-2156.
The Source Routing Header (SRH) has the following format:
0 1 2 3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Header | Hdr Ext Len | Routing Type | Segments Left |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| CmprI | CmprE | Pad | Reserved |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| |
. .
. Addresses[1..n] .
. .
| |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
The originator of an SRH places the first hop's IPv6 address in the IPv6
header's IPv6 Destination Address and the second hop's IPv6 address as
the first address in Addresses[1..n].
The CmprI and CmprE fields indicate the number of prefix octets that are
shared with the IPv6 Destination Address. When CmprI or CmprE is not 0,
Addresses[1..n] are compressed as follows:
1..n-1 : (16 - CmprI) bytes
n : (16 - CmprE) bytes
Segments Left indicates the number of route segments remaining. When the
value is not zero, the SRH is forwarded to the next hop. Its address
is extracted from Addresses[n - Segment Left + 1] and swapped with IPv6
Destination Address.
When Segment Left is greater than or equal to 2, the size of SRH is not
changed because Addresses[1..n-1] are decompressed and recompressed with
CmprI.
OTOH, when Segment Left changes from 1 to 0, the new SRH could have a
different size because Addresses[1..n-1] are decompressed with CmprI and
recompressed with CmprE.
Let's say CmprI is 15 and CmprE is 0. When we receive SRH with Segment
Left >= 2, Addresses[1..n-1] have 1 byte for each, and Addresses[n] has
16 bytes. When Segment Left is 1, Addresses[1..n-1] is decompressed to
16 bytes and not recompressed. Finally, the new SRH will need more room
in the header, and the size is (16 - 1) \* (n - 1) bytes.
Here the max value of n is 255 as Segment Left is u8, so in the worst case,
we have to allocate 3825 bytes in the skb headroom. However, now we only
allocate a small fixed buffer that is IPV6\_RPL\_SRH\_WORST\_SWAP\_SIZE (16 + 7
bytes). If the decompressed size overflows the room, skb\_push() hits BUG()
below [0].
Instead of allocating the fixed buffer for every packet, let's allocate
enough headroom only when we receive SRH with Segment Left 1.
[0]:
skbuff: skb\_under\_panic: text:ffffffff81c9f6e2 len:576 put:576 head:ffff8880070b5180 data:ffff8880070b4fb0 tail:0x70 end:0x140 dev:lo
kernel BUG at net/core/skbuff.c:200!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
CPU: 0 PID: 154 Comm: python3 Not tainted 6.4.0-rc4-00190-gc308e9ec0047 #7
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:skb\_panic (net/core/skbuff.c:200)
Code: 4f 70 50 8b 87 bc 00 00 00 50 8b 87 b8 00 00 00 50 ff b7 c8 00 00 00 4c 8b 8f c0 00 00 00 48 c7 c7 80 6e 77 82 e8 ad 8b 60 ff <0f> 0b 66 66 2e 0f 1f 84 00 00 00 00 00 90 90 90 90 90 90 90 90 90
RSP: 0018:ffffc90000003da0 EFLAGS: 00000246
RAX: 0000000000000085 RBX: ffff8880058a6600 RCX: 0000000000000000
RDX: 0000000000000000 RSI: ffff88807dc1c540 RDI: ffff88807dc1c540
RBP: ffffc90000003e48 R08: ffffffff82b392c8 R09: 00000000ffffdfff
R10: ffffffff82a592e0 R11: ffffffff82b092e0 R12: ffff888005b1c800
R13: ffff8880070b51b8 R14: ffff888005b1ca18 R15: ffff8880070b5190
FS: 00007f4539f0b740(0000) GS:ffff88807dc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000055670baf3000 CR3: 0000000005b0e000 CR4: 00000000007506f0
PKRU: 55555554
Call Trace:
skb\_push (net/core/skbuff.c:210)
ipv6\_rthdr\_rcv (./include/linux/skbuff.h:2880 net/ipv6/exthdrs.c:634 net/ipv6/exthdrs.c:718)
ip6\_protocol\_deliver\_rcu (net/ipv6/ip6\_input.c:437 (discriminator 5))
ip6\_input\_finish (./include/linux/rcupdate.h:805 net/ipv6/ip6\_input.c:483)
\_\_netif\_receive\_skb\_one\_core (net/core/dev.c:5494)
process\_backlog (./include/linux/rcupdate.h:805 net/core/dev.c:5934)
\_\_napi\_poll (net/core/dev.c:6496)
net\_rx\_action (net/core/dev.c:6565 net/core/dev.c:6696)
\_\_do\_softirq (./arch/x86/include/asm/jump\_label.h:27 ./include/linux/jump\_label.h:207 ./include/trace/events/irq.h:142 kernel/softirq.c:572)
do\_softirq (kernel/softirq.c:472 kernel/softirq.c:459)

\_\_local\_bh\_enable\_ip (kernel/softirq.c:396)
\_\_dev\_queue\_xmit (net/core/dev.c:4272)
ip6\_finish\_output2 (./include/net/neighbour.h:544 net/ipv6/ip6\_output.c:134)
rawv6\_sendmsg (./include/net/dst.h:458 ./include/linux/netfilter.h:303 net/ipv6/raw.c:656 net/ipv6/raw.c:914)
sock\_sendmsg (net/socket.c:724 net/socket.c:747)
\_\_sys\_sendto (net/socket.c:2144)
\_\_x64\_sys\_sendto (net/socket.c:2156 net/socket.c:2152 net/socket.c:2152)
do\_syscall\_64 (arch/x86/entry/common.c:50 arch/x86/entry/common.c:80)
entry\_SYSCALL\_64\_after\_hwframe (arch/x86/entry/entry\_64.S:120)
RIP: 0033:0x7f453a138aea
Code: d8 64 89 02 48 c7 c0 ff ff ff ff eb b8 0f 1f 00 f3 0f 1e fa 41 89 ca 64 8b 04 25 18 00 00 00 85 c0 75 15 b8 2c 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 7e c3 0f 1f 44 00 00 41 54 48 83 ec 30 44 89
RSP: 002b:00007ffcc212a1c8 EFLAGS: 00000246 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 00007ffcc212a288 RCX: 00007f453a138aea
RDX: 0000000000000060 RSI: 00007f4539084c20 RDI: 0000000000000003
RBP: 00007f4538308e80 R08: 00007ffcc212a300 R09: 000000000000001c
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: ffffffffc4653600 R14: 0000000000000001 R15: 00007f4539712d1b

Modules linked in:
Fixes: 8610c7c6e3bd ("net: ipv6: add support for rpl sr exthdr")
Reported-by: Max VA
Closes: https://www.interruptlabs.co.uk/articles/linux-ipv6-route-of-death
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Link: https://lore.kernel.org/r/20230605180617.67284-1-kuniyu@amazon.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit dada3ba887f90f994f4607f73eb6d65b0a1365c8
Author: Erico Nunes
Date: Tue Jun 6 16:32:47 2023 +0200
drm/lima: fix sched context destroy
[ Upstream commit 6eea63c7090b20ee41032d3e478e617b219d69aa ]
The drm sched entity must be flushed before finishing, to account for
jobs potentially still in flight at that time.
Lima did not do this flush until now, so switch the destroy call to the
drm\_sched\_entity\_destroy() wrapper which will take care of that.
This fixes a regression on lima which started since the rework in
commit 2fdb8a8f07c2 ("drm/scheduler: rework entity flush, kill and fini")
where some specific types of applications may hang indefinitely.
Fixes: 2fdb8a8f07c2 ("drm/scheduler: rework entity flush, kill and fini")
Reviewed-by: Vasily Khoruzhick
Signed-off-by: Erico Nunes
Signed-off-by: Qiang Yu
Link: https://patchwork.freedesktop.org/patch/msgid/20230606143247.433018-1-nunes.erico@gmail.com
Signed-off-by: Sasha Levin
commit d2d15270080824c30a6a395ad0912c5db7f5a64d
Author: Pablo Neira Ayuso
Date: Tue Jun 6 16:32:44 2023 +0200
netfilter: nf\_tables: out-of-bound check in chain blob
[ Upstream commit 08e42a0d3ad30f276f9597b591f975971a1b0fcf ]
Add current size of rule expressions to the boundary check.
Fixes: 2c865a8a28a1 ("netfilter: nf\_tables: add rule blob layout")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 53cd8f588f6df5b760a8b678c940db467f5310dc
Author: Kuniyuki Iwashima
Date: Thu May 18 10:33:00 2023 -0700
netfilter: ipset: Add schedule point in call\_ad().
[ Upstream commit 24e227896bbf003165e006732dccb3516f87f88e ]
syzkaller found a repro that causes Hung Task [0] with ipset. The repro
first creates an ipset and then tries to delete a large number of IPs
from the ipset concurrently:
IPSET\_ATTR\_IPADDR\_IPV4 : 172.20.20.187
IPSET\_ATTR\_CIDR : 2
The first deleting thread hogs a CPU with nfnl\_lock(NFNL\_SUBSYS\_IPSET)
held, and other threads wait for it to be released.
Previously, the same issue existed in set->variant->uadt() that could run
so long under ip\_set\_lock(set). Commit 5e29dc36bd5e ("netfilter: ipset:
Rework long task execution when adding/deleting entries") tried to fix it,
but the issue still exists in the caller with another mutex.
While adding/deleting many IPs, we should release the CPU periodically to
prevent someone from abusing ipset to hang the system.
Note we need to increment the ipset's refcnt to prevent the ipset from
being destroyed while rescheduling.
[0]:
INFO: task syz-executor174:268 blocked for more than 143 seconds.
Not tainted 6.4.0-rc1-00145-gba79e9a73284 #1
"echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
task:syz-executor174 state:D stack:0 pid:268 ppid:260 flags:0x0000000d
Call trace:
\_\_switch\_to+0x308/0x714 arch/arm64/kernel/process.c:556
context\_switch kernel/sched/core.c:5343 [inline]
\_\_schedule+0xd84/0x1648 kernel/sched/core.c:6669
schedule+0xf0/0x214 kernel/sched/core.c:6745
schedule\_preempt\_disabled+0x58/0xf0 kernel/sched/core.c:6804
\_\_mutex\_lock\_common kernel/locking/mutex.c:679 [inline]
\_\_mutex\_lock+0x6fc/0xdb0 kernel/locking/mutex.c:747
\_\_mutex\_lock\_slowpath+0x14/0x20 kernel/locking/mutex.c:1035
mutex\_lock+0x98/0xf0 kernel/locking/mutex.c:286
nfnl\_lock net/netfilter/nfnetlink.c:98 [inline]
nfnetlink\_rcv\_msg+0x480/0x70c net/netfilter/nfnetlink.c:295
netlink\_rcv\_skb+0x1c0/0x350 net/netlink/af\_netlink.c:2546
nfnetlink\_rcv+0x18c/0x199c net/netfilter/nfnetlink.c:658
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1339 [inline]
netlink\_unicast+0x664/0x8cc net/netlink/af\_netlink.c:1365
netlink\_sendmsg+0x6d0/0xa4c net/netlink/af\_netlink.c:1913
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_\_\_sys\_sendmsg+0x4b8/0x810 net/socket.c:2503
\_\_\_sys\_sendmsg net/socket.c:2557 [inline]
\_\_sys\_sendmsg+0x1f8/0x2a4 net/socket.c:2586
\_\_do\_sys\_sendmsg net/socket.c:2595 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2593 [inline]
\_\_arm64\_sys\_sendmsg+0x80/0x94 net/socket.c:2593
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:38 [inline]
invoke\_syscall+0x84/0x270 arch/arm64/kernel/syscall.c:52
el0\_svc\_common+0x134/0x24c arch/arm64/kernel/syscall.c:142
do\_el0\_svc+0x64/0x198 arch/arm64/kernel/syscall.c:193
el0\_svc+0x2c/0x7c arch/arm64/kernel/entry-common.c:637
el0t\_64\_sync\_handler+0x84/0xf0 arch/arm64/kernel/entry-common.c:655
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:591
Reported-by: syzkaller
Fixes: a7b4f989a629 ("netfilter: ipset: IP set core support")
Signed-off-by: Kuniyuki Iwashima
Acked-by: Jozsef Kadlecsik
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 0c48383e967d061592fcaa7d285aca526bea21be
Author: Tijs Van Buggenhout
Date: Thu May 25 12:25:26 2023 +0200
netfilter: conntrack: fix NULL pointer dereference in nf\_confirm\_cthelper
[ Upstream commit e1f543dc660b44618a1bd72ddb4ca0828a95f7ad ]
An nf\_conntrack\_helper from nf\_conn\_help may become NULL after DNAT.
Observed when TCP port 1720 (Q931\_PORT), associated with h323 conntrack
helper, is DNAT'ed to another destination port (e.g. 1730), while
nfqueue is being used for final acceptance (e.g. snort).
This happenned after transition from kernel 4.14 to 5.10.161.
Workarounds:
\* keep the same port (1720) in DNAT
\* disable nfqueue
\* disable/unload h323 NAT helper
$ linux-5.10/scripts/decode\_stacktrace.sh vmlinux < /tmp/kernel.log
BUG: kernel NULL pointer dereference, address: 0000000000000084
[..]
RIP: 0010:nf\_conntrack\_update (net/netfilter/nf\_conntrack\_core.c:2080 net/netfilter/nf\_conntrack\_core.c:2134) nf\_conntrack
[..]
nfqnl\_reinject (net/netfilter/nfnetlink\_queue.c:237) nfnetlink\_queue
nfqnl\_recv\_verdict (net/netfilter/nfnetlink\_queue.c:1230) nfnetlink\_queue
nfnetlink\_rcv\_msg (net/netfilter/nfnetlink.c:241) nfnetlink
[..]
Fixes: ee04805ff54a ("netfilter: conntrack: make conntrack userspace helpers work again")
Signed-off-by: Tijs Van Buggenhout
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 2431f65d3709b1107e9462679c82a799e2c793e1
Author: Jeremy Sowden
Date: Thu May 25 15:07:24 2023 +0100
netfilter: nft\_bitwise: fix register tracking
[ Upstream commit 14e8b293903785590a0ef168745ac84250cb1f4c ]
At the end of `nft\_bitwise\_reduce`, there is a loop which is intended to
update the bitwise expression associated with each tracked destination
register. However, currently, it just updates the first register
repeatedly. Fix it.
Fixes: 34cc9e52884a ("netfilter: nf\_tables: cancel tracking for clobbered destination registers")
Signed-off-by: Jeremy Sowden
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit a1f6b02a40c1e18f50a661631ec83802459d9378
Author: Gavrilov Ilia
Date: Wed May 24 12:25:27 2023 +0000
netfilter: nf\_tables: Add null check for nla\_nest\_start\_noflag() in nft\_dump\_basechain\_hook()
[ Upstream commit bd058763a624a1fb5c20f3c46e632d623c043676 ]
The nla\_nest\_start\_noflag() function may fail and return NULL;
the return value needs to be checked.
Found by InfoTeCS on behalf of Linux Verification Center
(linuxtesting.org) with SVACE.
Fixes: d54725cd11a5 ("netfilter: nf\_tables: support for multiple devices per netdev hook")
Signed-off-by: Gavrilov Ilia
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 235325b8a5db6226ae84f95b38a92c563a3ed63f
Author: Yonghong Song
Date: Tue Jun 6 10:22:02 2023 -0700
selftests/bpf: Fix sockopt\_sk selftest
[ Upstream commit 69844e335d8c22454746c7903776533d8b4ab8fa ]
Commit f4e4534850a9 ("net/netlink: fix NETLINK\_LIST\_MEMBERSHIPS length report")
fixed NETLINK\_LIST\_MEMBERSHIPS length report which caused
selftest sockopt\_sk failure. The failure log looks like
test\_sockopt\_sk:PASS:join\_cgroup /sockopt\_sk 0 nsec
run\_test:PASS:skel\_load 0 nsec
run\_test:PASS:setsockopt\_link 0 nsec
run\_test:PASS:getsockopt\_link 0 nsec
getsetsockopt:FAIL:Unexpected NETLINK\_LIST\_MEMBERSHIPS value unexpected Unexpected NETLINK\_LIST\_MEMBERSHIPS value: actual 8 != expected 4
run\_test:PASS:getsetsockopt 0 nsec
#201 sockopt\_sk:FAIL
In net/netlink/af\_netlink.c, function netlink\_getsockopt(), for NETLINK\_LIST\_MEMBERSHIPS,
nlk->ngroups equals to 36. Before Commit f4e4534850a9, the optlen is calculated as
ALIGN(nlk->ngroups / 8, sizeof(u32)) = 4
After that commit, the optlen is
ALIGN(BITS\_TO\_BYTES(nlk->ngroups), sizeof(u32)) = 8
Fix the test by setting the expected optlen to be 8.
Fixes: f4e4534850a9 ("net/netlink: fix NETLINK\_LIST\_MEMBERSHIPS length report")
Signed-off-by: Yonghong Song
Signed-off-by: Andrii Nakryiko
Link: https://lore.kernel.org/bpf/20230606172202.1606249-1-yhs@fb.com
Signed-off-by: Sasha Levin
commit ae14f7f86c3e64878e00d576d941510713b55e17
Author: Stanislav Fomichev
Date: Tue Apr 18 15:53:39 2023 -0700
selftests/bpf: Verify optval=NULL case
[ Upstream commit 833d67ecdc5f35f1ebf59d0fccc1ce771434be9c ]
Make sure we get optlen exported instead of getting EFAULT.
Signed-off-by: Stanislav Fomichev
Signed-off-by: Daniel Borkmann
Link: https://lore.kernel.org/bpf/20230418225343.553806-3-sdf@google.com
Stable-dep-of: 69844e335d8c ("selftests/bpf: Fix sockopt\_sk selftest")
Signed-off-by: Sasha Levin
commit 1a3ceea31b5783487d4490b3741adff3455e0bf4
Author: Johannes Berg
Date: Tue Jun 6 14:34:47 2023 +0200
wifi: cfg80211: fix locking in sched scan stop work
[ Upstream commit 3e54ed8247c94c8bdf370bd872bd9dfe72b1b12b ]
This should use wiphy\_lock() now instead of acquiring the
RTNL, since cfg80211\_stop\_sched\_scan\_req() now needs that.
Fixes: a05829a7222e ("cfg80211: avoid holding the RTNL when calling the driver")
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit f372fe8d4917c8124f1febdaf59f2da1dd24ba7a
Author: Stanislaw Gruszka
Date: Thu Apr 13 08:38:10 2023 +0200
accel/ivpu: Reserve all non-command bo's using DMA\_RESV\_USAGE\_BOOKKEEP
[ Upstream commit 411360257c1f4fccaa20143098b6d3fcc9d4e4dc ]
Use DMA\_RESV\_USAGE\_BOOKKEEP reservation for buffer objects, except for
command buffers for which we use DMA\_RESV\_USAGE\_WRITE (since VPU can
write to command buffer context save area).
Fixes: 0ec8671837a6 ("accel/ivpu: Fix S3 system suspend when not idle")
Reviewed-by: Jeffrey Hugo
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230413063810.3167511-1-stanislaw.gruszka@linux.intel.com
Signed-off-by: Sasha Levin
commit 3643d8bdf9c2a5cc6edce7fa9c7629a4ea28dc1c
Author: Randy Dunlap
Date: Thu May 25 21:45:19 2023 -0700
accel/ivpu: ivpu\_ipc needs GENERIC\_ALLOCATOR
[ Upstream commit 50d30040eb856ff6b0382b4d9dc332dc15597729 ]
Drivers that use the gen\_pool\*() family of functions should
select GENERIC\_ALLOCATOR to prevent build errors like these:
ld: drivers/accel/ivpu/ivpu\_ipc.o: in function `gen\_pool\_free':
include/linux/genalloc.h:172: undefined reference to `gen\_pool\_free\_owner'
ld: drivers/accel/ivpu/ivpu\_ipc.o: in function `gen\_pool\_alloc\_algo':
include/linux/genalloc.h:138: undefined reference to `gen\_pool\_alloc\_algo\_owner'
ld: drivers/accel/ivpu/ivpu\_ipc.o: in function `gen\_pool\_free':
include/linux/genalloc.h:172: undefined reference to `gen\_pool\_free\_owner'
ld: drivers/accel/ivpu/ivpu\_ipc.o: in function `ivpu\_ipc\_init':
drivers/accel/ivpu/ivpu\_ipc.c:441: undefined reference to `devm\_gen\_pool\_create'
ld: drivers/accel/ivpu/ivpu\_ipc.o: in function `gen\_pool\_add\_virt':
include/linux/genalloc.h:104: undefined reference to `gen\_pool\_add\_owner'
Fixes: 5d7422cfb498 ("accel/ivpu: Add IPC driver and JSM messages")
Signed-off-by: Randy Dunlap
Reported-by: kernel test robot
Link: https://lore.kernel.org/all/202305221206.1TaugDKP-lkp@intel.com/
Cc: Oded Gabbay
Cc: dri-devel@lists.freedesktop.org
Cc: Jacek Lawrynowicz
Cc: Stanislaw Gruszka
Cc: Andrzej Kacprowski
Cc: Krystian Pradzynski
Cc: Jeffrey Hugo
Cc: Daniel Vetter
Reviewed-by: Jeffrey Hugo
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230526044519.13441-1-rdunlap@infradead.org
Signed-off-by: Sasha Levin
commit 37b62b50aa89a0854bb5da63bd31f7642dbf3c5e
Author: Manish Chopra
Date: Mon Jun 5 16:56:00 2023 +0530
qed/qede: Fix scheduling while atomic
[ Upstream commit 42510dffd0e2c27046905f742172ed6662af5557 ]
Statistics read through bond interface via sysfs causes
below bug and traces as it triggers the bonding module to
collect the slave device statistics while holding the spinlock,
beneath that qede->qed driver statistics flow gets scheduled out
due to usleep\_range() used in PTT acquire logic
[ 3673.988874] Hardware name: HPE ProLiant DL365 Gen10 Plus/ProLiant DL365 Gen10 Plus, BIOS A42 10/29/2021
[ 3673.988878] Call Trace:
[ 3673.988891] dump\_stack\_lvl+0x34/0x44
[ 3673.988908] \_\_schedule\_bug.cold+0x47/0x53
[ 3673.988918] \_\_schedule+0x3fb/0x560
[ 3673.988929] schedule+0x43/0xb0
[ 3673.988932] schedule\_hrtimeout\_range\_clock+0xbf/0x1b0
[ 3673.988937] ? \_\_hrtimer\_init+0xc0/0xc0
[ 3673.988950] usleep\_range+0x5e/0x80
[ 3673.988955] qed\_ptt\_acquire+0x2b/0xd0 [qed]
[ 3673.988981] \_qed\_get\_vport\_stats+0x141/0x240 [qed]
[ 3673.989001] qed\_get\_vport\_stats+0x18/0x80 [qed]
[ 3673.989016] qede\_fill\_by\_demand\_stats+0x37/0x400 [qede]
[ 3673.989028] qede\_get\_stats64+0x19/0xe0 [qede]
[ 3673.989034] dev\_get\_stats+0x5c/0xc0
[ 3673.989045] netstat\_show.constprop.0+0x52/0xb0
[ 3673.989055] dev\_attr\_show+0x19/0x40
[ 3673.989065] sysfs\_kf\_seq\_show+0x9b/0xf0
[ 3673.989076] seq\_read\_iter+0x120/0x4b0
[ 3673.989087] new\_sync\_read+0x118/0x1a0
[ 3673.989095] vfs\_read+0xf3/0x180
[ 3673.989099] ksys\_read+0x5f/0xe0
[ 3673.989102] do\_syscall\_64+0x3b/0x90
[ 3673.989109] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 3673.989115] RIP: 0033:0x7f8467d0b082
[ 3673.989119] Code: c0 e9 b2 fe ff ff 50 48 8d 3d ca 05 08 00 e8 35 e7 01 00 0f 1f 44 00 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 0f 05 <48> 3d 00 f0 ff ff 77 56 c3 0f 1f 44 00 00 48 83 ec 28 48 89 54 24
[ 3673.989121] RSP: 002b:00007ffffb21fd08 EFLAGS: 00000246 ORIG\_RAX: 0000000000000000
[ 3673.989127] RAX: ffffffffffffffda RBX: 000000000100eca0 RCX: 00007f8467d0b082
[ 3673.989128] RDX: 00000000000003ff RSI: 00007ffffb21fdc0 RDI: 0000000000000003
[ 3673.989130] RBP: 00007f8467b96028 R08: 0000000000000010 R09: 00007ffffb21ec00
[ 3673.989132] R10: 00007ffffb27b170 R11: 0000000000000246 R12: 00000000000000f0
[ 3673.989134] R13: 0000000000000003 R14: 00007f8467b92000 R15: 0000000000045a05
[ 3673.989139] CPU: 30 PID: 285188 Comm: read\_all Kdump: loaded Tainted: G W OE
Fix this by collecting the statistics asynchronously from a periodic
delayed work scheduled at default stats coalescing interval and return
the recent copy of statisitcs from .ndo\_get\_stats64(), also add ability
to configure/retrieve stats coalescing interval using below commands -
ethtool -C ethx stats-block-usecs
ethtool -c ethx
Fixes: 133fac0eedc3 ("qede: Add basic ethtool support")
Cc: Sudarsana Kalluru
Cc: David Miller
Signed-off-by: Manish Chopra
Link: https://lore.kernel.org/r/20230605112600.48238-1-manishc@marvell.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit cea6af203d96368ecfc4d8047ee2eb3713c56e55
Author: Johannes Berg
Date: Sun Jun 4 12:11:15 2023 +0300
wifi: mac80211: don't translate beacon/presp addrs
[ Upstream commit 47c171a426e305f2225b92ed7b5e0a990c95f6d4 ]
Don't do link address translation for beacons and probe responses,
this leads to reporting multiple scan list entries for the same AP
(one with the MLD address) which just breaks things.
We might need to extend this in the future for some other (action)
frames that aren't MLD addressed.
Fixes: 42fb9148c078 ("wifi: mac80211: do link->MLD address translation on RX")
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230604120651.62adead1b43a.Ifc25eed26ebf3b269f60b1ec10060156d0e7ec0d@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit b133381ad2690b44c6f4f18580adfc2701f76c5f
Author: Johannes Berg
Date: Sun Jun 4 12:11:16 2023 +0300
wifi: mac80211: mlme: fix non-inheritence element
[ Upstream commit 68c228557d52616cf040651abefda9839de7086a ]
There were two bugs when creating the non-inheritence
element:
1) 'at\_extension' needs to be declared outside the loop,
otherwise the value resets every iteration and we
can never really switch properly
2) 'added' never got set to true, so we always cut off
the extension element again at the end of the function
This shows another issue that we might add a list but no
extension list, but we need to make the extension list a
zero-length one in that case.
Fix all these issues. While at it, add a comment explaining
the trim.
Fixes: 81151ce462e5 ("wifi: mac80211: support MLO authentication/association with one link")
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230604120651.3addaa5c4782.If3a78f9305997ad7ef4ba7ffc17a8234c956f613@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 33ed7c2b6739a95e22c468fd93339f0835847572
Author: Johannes Berg
Date: Sun Jun 4 12:11:18 2023 +0300
wifi: cfg80211: reject bad AP MLD address
[ Upstream commit 727073ca5e55ab6a07df316250be8a12606e8677 ]
When trying to authenticate, if the AP MLD address isn't
a valid address, mac80211 can throw a warning. Avoid that
by rejecting such addresses.
Fixes: d648c23024bd ("wifi: nl80211: support MLO in auth/assoc")
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230604120651.89188912bd1d.I8dbc6c8ee0cb766138803eec59508ef4ce477709@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 16971b41c2eb38e259c596b6ddfa1ff3ba266d13
Author: Johannes Berg
Date: Sun Jun 4 12:11:23 2023 +0300
wifi: mac80211: use correct iftype HE cap
[ Upstream commit c37ab22bb1a43cdca8bf69cc0a22f1ccfc449e68 ]
We already check that the right iftype capa exists,
but then don't use it. Assign it to a variable so we
can actually use it, and then do that.
Fixes: bac2fd3d7534 ("mac80211: remove use of ieee80211\_get\_he\_sta\_cap()")
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230604120651.0e908e5c5fdd.Iac142549a6144ac949ebd116b921a59ae5282735@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 65f907344c42f2cb2dc7f6b1fdc0e615c57f263d
Author: Sungwoo Kim
Date: Sat Jun 3 08:28:09 2023 -0400
Bluetooth: L2CAP: Add missing checks for invalid DCID
[ Upstream commit 75767213f3d9b97f63694d02260b6a49a2271876 ]
When receiving a connect response we should make sure that the DCID is
within the valid range and that we don't already have another channel
allocated for the same DCID.
Missing checks may violate the specification (BLUETOOTH CORE SPECIFICATION
Version 5.4 | Vol 3, Part A, Page 1046).
Fixes: 40624183c202 ("Bluetooth: L2CAP: Add missing checks for invalid LE DCID")
Signed-off-by: Sungwoo Kim
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 99cba97ad0b7c5fbc57ed55fc637377cd9d8e126
Author: Pauli Virtanen
Date: Thu Jun 1 09:34:45 2023 +0300
Bluetooth: ISO: use correct CIS order in Set CIG Parameters event
[ Upstream commit 71e9588435c38112d6a8686d3d8e7cc1de8fe22c ]
The order of CIS handle array in Set CIG Parameters response shall match
the order of the CIS\_ID array in the command (Core v5.3 Vol 4 Part E Sec
7.8.97). We send CIS\_IDs mainly in the order of increasing CIS\_ID (but
with "last" CIS first if it has fixed CIG\_ID). In handling of the
reply, we currently assume this is also the same as the order of
hci\_conn in hdev->conn\_hash, but that is not true.
Match the correct hci\_conn to the correct handle by matching them based
on the CIG+CIS combination. The CIG+CIS combination shall be unique for
ISO\_LINK hci\_conn at state >= BT\_BOUND, which we maintain in
hci\_le\_set\_cig\_params.
Fixes: 26afbd826ee3 ("Bluetooth: Add initial implementation of CIS connections")
Signed-off-by: Pauli Virtanen
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit c329dd3846361cfa521b85112ca89dafff1b7c03
Author: Luiz Augusto von Dentz
Date: Tue Apr 11 16:14:25 2023 -0700
Bluetooth: hci\_conn: Fix not matching by CIS ID
[ Upstream commit c14516faede33c2c31da45cf950d55dbff42962e ]
This fixes only matching CIS by address which prevents creating new hcon
if upper layer is requesting a specific CIS ID.
Signed-off-by: Luiz Augusto von Dentz
Stable-dep-of: 71e9588435c3 ("Bluetooth: ISO: use correct CIS order in Set CIG Parameters event")
Signed-off-by: Sasha Levin
commit f72fc94a17d45be98aecfd59c39b5b24a6a342e2
Author: Luiz Augusto von Dentz
Date: Tue Apr 11 16:02:22 2023 -0700
Bluetooth: hci\_conn: Add support for linking multiple hcon
[ Upstream commit 06149746e7203d5ffe2d6faf9799ee36203aa8b8 ]
Since it is required for some configurations to have multiple CIS with
the same peer which is now covered by iso-tester in the following test
cases:
ISO AC 6(i) - Success
ISO AC 7(i) - Success
ISO AC 8(i) - Success
ISO AC 9(i) - Success
ISO AC 11(i) - Success
Signed-off-by: Luiz Augusto von Dentz
Stable-dep-of: 71e9588435c3 ("Bluetooth: ISO: use correct CIS order in Set CIG Parameters event")
Signed-off-by: Sasha Levin
commit dbea8c26517d863430d66aa95ed09290560a6830
Author: Pauli Virtanen
Date: Thu Jun 1 09:34:44 2023 +0300
Bluetooth: ISO: don't try to remove CIG if there are bound CIS left
[ Upstream commit 6c242c64a09e78349fb0a5f0a6f8076a3d7c0bb4 ]
Consider existing BOUND & CONNECT state CIS to block CIG removal.
Otherwise, under suitable timing conditions we may attempt to remove CIG
while Create CIS is pending, which fails.
Fixes: 26afbd826ee3 ("Bluetooth: Add initial implementation of CIS connections")
Signed-off-by: Pauli Virtanen
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 0bf9d8f4e7e010cccd2aba164773f0ab9d1963e6
Author: Ying Hsu
Date: Wed May 31 03:44:56 2023 +0000
Bluetooth: Fix l2cap\_disconnect\_req deadlock
[ Upstream commit 02c5ea5246a44d6ffde0fddebfc1d56188052976 ]
L2CAP assumes that the locks conn->chan\_lock and chan->lock are
acquired in the order conn->chan\_lock, chan->lock to avoid
potential deadlock.
For example, l2sock\_shutdown acquires these locks in the order:
mutex\_lock(&conn->chan\_lock)
l2cap\_chan\_lock(chan)
However, l2cap\_disconnect\_req acquires chan->lock in
l2cap\_get\_chan\_by\_scid first and then acquires conn->chan\_lock
before calling l2cap\_chan\_del. This means that these locks are
acquired in unexpected order, which leads to potential deadlock:
l2cap\_chan\_lock(c)
mutex\_lock(&conn->chan\_lock)
This patch releases chan->lock before acquiring the conn\_chan\_lock
to avoid the potential deadlock.
Fixes: a2a9339e1c9d ("Bluetooth: L2CAP: Fix use-after-free in l2cap\_disconnect\_{req,rsp}")
Signed-off-by: Ying Hsu
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit f202d27efbc76851fbe08ddea378123e234f11a3
Author: Zhengping Jiang
Date: Wed May 24 17:11:58 2023 -0700
Bluetooth: hci\_sync: add lock to protect HCI\_UNREGISTER
[ Upstream commit 1857c19941c87eb36ad47f22a406be5dfe5eff9f ]
When the HCI\_UNREGISTER flag is set, no jobs should be scheduled. Fix
potential race when HCI\_UNREGISTER is set after the flag is tested in
hci\_cmd\_sync\_queue.
Fixes: 0b94f2651f56 ("Bluetooth: hci\_sync: Fix queuing commands when HCI\_UNREGISTER is set")
Signed-off-by: Zhengping Jiang
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit c574a3376112220682b997d49af28d19bdd86ac4
Author: Pauli Virtanen
Date: Sun May 21 15:48:29 2023 +0000
Bluetooth: ISO: Fix CIG auto-allocation to select configurable CIG
[ Upstream commit e6a7a46b8636efe95c75bed63a57fc05c13feba4 ]
Make CIG auto-allocation to select the first CIG\_ID that is still
configurable. Also use correct CIG\_ID range (see Core v5.3 Vol 4 Part E
Sec 7.8.97 p.2553).
Previously, it would always select CIG\_ID 0 regardless of anything,
because cis\_list with data.cis == 0xff (BT\_ISO\_QOS\_CIS\_UNSET) would not
count any CIS. Since we are not adding CIS here, use find\_cis instead.
Fixes: 26afbd826ee3 ("Bluetooth: Add initial implementation of CIS connections")
Signed-off-by: Pauli Virtanen
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 134b9d5704356b9ceb8390edf2c8104bbed84869
Author: Pauli Virtanen
Date: Sun May 21 15:48:28 2023 +0000
Bluetooth: ISO: consider right CIS when removing CIG at cleanup
[ Upstream commit 31c5f9164949347c9cb34f041a7e04fdc08b1b85 ]
When looking for CIS blocking CIG removal, consider only the CIS with
the right CIG ID. Don't try to remove CIG with unset CIG ID.
Fixes: 26afbd826ee3 ("Bluetooth: Add initial implementation of CIS connections")
Signed-off-by: Pauli Virtanen
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 2c4ee77d4cd911fde81a630f84aeb153fffe018f
Author: Iulia Tanasescu
Date: Fri Mar 31 18:38:01 2023 +0300
Bluetooth: Split bt\_iso\_qos into dedicated structures
[ Upstream commit 0fe8c8d071343fa9278980ce4b6f8e6ea24a2ed1 ]
Split bt\_iso\_qos into dedicated unicast and broadcast
structures and add additional broadcast parameters.
Fixes: eca0ae4aea66 ("Bluetooth: Add initial implementation of BIS connections")
Signed-off-by: Iulia Tanasescu
Signed-off-by: Luiz Augusto von Dentz
Stable-dep-of: 31c5f9164949 ("Bluetooth: ISO: consider right CIS when removing CIG at cleanup")
Signed-off-by: Sasha Levin
commit fe0721447469f957d8d4ae878aeba0fe9a137e3a
Author: Jouni Högander
Date: Tue May 30 13:16:49 2023 +0300
drm/i915: Use 18 fast wake AUX sync len
[ Upstream commit 2d6f2f79e06571d41eb1223abebe9097511c9544 ]
HW default for wake sync pulses is 18. 10 precharge and 8 preamble. There
is no reason to change this especially as it is causing problems with
certain eDP panels.
v3: Change "Fixes:" commit
v2: Remove "fast wake" repeat from subject
Signed-off-by: Jouni Högander
Fixes: e1c71f8f9180 ("drm/i915: Fix fast wake AUX sync len")
Closes: https://gitlab.freedesktop.org/drm/intel/-/issues/8475
Reviewed-by: Luca Coelho
Link: https://patchwork.freedesktop.org/patch/msgid/20230530101649.2549949-1-jouni.hogander@intel.com
(cherry picked from commit b29a20f7c4995a059ed764ce42389857426397c7)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit ba384ccd2c0ceed2aad6aa0fa8c9569a82af13b7
Author: Ville Syrjälä
Date: Wed Mar 29 20:24:34 2023 +0300
drm/i915: Explain the magic numbers for AUX SYNC/precharge length
[ Upstream commit 26bfc3f36f2104c174dfc72415547d5c28ef3f1c ]
Replace the hardcoded final numbers in the AUX SYNC/precharge
setup, and derive those from numbers from the (e)DP specs.
The new functions can serve as the single point of truth for
the number of SYNC pulses we use.
Cc: Jouni Högander
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20230329172434.18744-2-ville.syrjala@linux.intel.com
Reviewed-by: Jouni Högander
Stable-dep-of: 2d6f2f79e065 ("drm/i915: Use 18 fast wake AUX sync len")
Signed-off-by: Sasha Levin
commit cc15581052f21a8daa97f8c551ac56931e7dc304
Author: Eric Dumazet
Date: Fri Jun 2 12:37:47 2023 +0000
net/sched: fq\_pie: ensure reasonable TCA\_FQ\_PIE\_QUANTUM values
[ Upstream commit cd2b8113c2e8b9f5a88a942e1eaca61eba401b85 ]
We got multiple syzbot reports, all duplicates of the following [1]
syzbot managed to install fq\_pie with a zero TCA\_FQ\_PIE\_QUANTUM,
thus triggering infinite loops.
Use limits similar to sch\_fq, with commits
3725a269815b ("pkt\_sched: fq: avoid hang when quantum 0") and
d9e15a273306 ("pkt\_sched: fq: do not accept silly TCA\_FQ\_QUANTUM")
[1]
watchdog: BUG: soft lockup - CPU#0 stuck for 26s! [swapper/0:0]
Modules linked in:
irq event stamp: 172817
hardirqs last enabled at (172816): [] \_\_el1\_irq arch/arm64/kernel/entry-common.c:476 [inline]
hardirqs last enabled at (172816): [] el1\_interrupt+0x58/0x68 arch/arm64/kernel/entry-common.c:486
hardirqs last disabled at (172817): [] \_\_el1\_irq arch/arm64/kernel/entry-common.c:468 [inline]
hardirqs last disabled at (172817): [] el1\_interrupt+0x24/0x68 arch/arm64/kernel/entry-common.c:486
softirqs last enabled at (167634): [] softirq\_handle\_end kernel/softirq.c:414 [inline]
softirqs last enabled at (167634): [] \_\_do\_softirq+0xac0/0xd54 kernel/softirq.c:600
softirqs last disabled at (167701): [] \_\_\_\_do\_softirq+0x14/0x20 arch/arm64/kernel/irq.c:80
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 6.4.0-rc3-syzkaller-geb0f1697d729 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 04/28/2023
pstate: 80400005 (Nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : fq\_pie\_qdisc\_dequeue+0x10c/0x8ac net/sched/sch\_fq\_pie.c:246
lr : fq\_pie\_qdisc\_dequeue+0xe4/0x8ac net/sched/sch\_fq\_pie.c:240
sp : ffff800008007210
x29: ffff800008007280 x28: ffff0000c86f7890 x27: ffff0000cb20c2e8
x26: ffff0000cb20c2f0 x25: dfff800000000000 x24: ffff0000cb20c2e0
x23: ffff0000c86f7880 x22: 0000000000000040 x21: 1fffe000190def10
x20: ffff0000cb20c2e0 x19: ffff0000cb20c2e0 x18: ffff800008006e60
x17: 0000000000000000 x16: ffff80000850af6c x15: 0000000000000302
x14: 0000000000000100 x13: 0000000000000000 x12: 0000000000000001
x11: 0000000000000302 x10: 0000000000000100 x9 : 0000000000000000
x8 : 0000000000000000 x7 : ffff80000841c468 x6 : 0000000000000000
x5 : 0000000000000001 x4 : 0000000000000001 x3 : 0000000000000000
x2 : ffff0000cb20c2e0 x1 : ffff0000cb20c2e0 x0 : 0000000000000001
Call trace:
fq\_pie\_qdisc\_dequeue+0x10c/0x8ac net/sched/sch\_fq\_pie.c:246
dequeue\_skb net/sched/sch\_generic.c:292 [inline]
qdisc\_restart net/sched/sch\_generic.c:397 [inline]
\_\_qdisc\_run+0x1fc/0x231c net/sched/sch\_generic.c:415
\_\_dev\_xmit\_skb net/core/dev.c:3868 [inline]
\_\_dev\_queue\_xmit+0xc80/0x3318 net/core/dev.c:4210
dev\_queue\_xmit include/linux/netdevice.h:3085 [inline]
neigh\_connected\_output+0x2f8/0x38c net/core/neighbour.c:1581
neigh\_output include/net/neighbour.h:544 [inline]
ip6\_finish\_output2+0xd60/0x1a1c net/ipv6/ip6\_output.c:134
\_\_ip6\_finish\_output net/ipv6/ip6\_output.c:195 [inline]
ip6\_finish\_output+0x538/0x8c8 net/ipv6/ip6\_output.c:206
NF\_HOOK\_COND include/linux/netfilter.h:292 [inline]
ip6\_output+0x270/0x594 net/ipv6/ip6\_output.c:227
dst\_output include/net/dst.h:458 [inline]
NF\_HOOK include/linux/netfilter.h:303 [inline]
ndisc\_send\_skb+0xc30/0x1790 net/ipv6/ndisc.c:508
ndisc\_send\_rs+0x47c/0x5d4 net/ipv6/ndisc.c:718
addrconf\_rs\_timer+0x300/0x58c net/ipv6/addrconf.c:3936
call\_timer\_fn+0x19c/0x8cc kernel/time/timer.c:1700
expire\_timers kernel/time/timer.c:1751 [inline]
\_\_run\_timers+0x55c/0x734 kernel/time/timer.c:2022
run\_timer\_softirq+0x7c/0x114 kernel/time/timer.c:2035
\_\_do\_softirq+0x2d0/0xd54 kernel/softirq.c:571
\_\_\_\_do\_softirq+0x14/0x20 arch/arm64/kernel/irq.c:80
call\_on\_irq\_stack+0x24/0x4c arch/arm64/kernel/entry.S:882
do\_softirq\_own\_stack+0x20/0x2c arch/arm64/kernel/irq.c:85
invoke\_softirq kernel/softirq.c:452 [inline]
\_\_irq\_exit\_rcu+0x28c/0x534 kernel/softirq.c:650
irq\_exit\_rcu+0x14/0x84 kernel/softirq.c:662
\_\_el1\_irq arch/arm64/kernel/entry-common.c:472 [inline]
el1\_interrupt+0x38/0x68 arch/arm64/kernel/entry-common.c:486
el1h\_64\_irq\_handler+0x18/0x24 arch/arm64/kernel/entry-common.c:491
el1h\_64\_irq+0x64/0x68 arch/arm64/kernel/entry.S:587
\_\_daif\_local\_irq\_enable arch/arm64/include/asm/irqflags.h:33 [inline]
arch\_local\_irq\_enable+0x8/0xc arch/arm64/include/asm/irqflags.h:55
cpuidle\_idle\_call kernel/sched/idle.c:170 [inline]
do\_idle+0x1f0/0x4e8 kernel/sched/idle.c:282
cpu\_startup\_entry+0x24/0x28 kernel/sched/idle.c:379
rest\_init+0x2dc/0x2f4 init/main.c:735
start\_kernel+0x0/0x55c init/main.c:834
start\_kernel+0x3f0/0x55c init/main.c:1088
\_\_primary\_switched+0xb8/0xc0 arch/arm64/kernel/head.S:523
Fixes: ec97ecf1ebe4 ("net: sched: add Flow Queue PIE packet scheduler")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Reviewed-by: Jamal Hadi Salim
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 625663c722c7972ca53c11778c05770ced3e6012
Author: Wei Fang
Date: Fri Jun 2 17:46:59 2023 +0800
net: enetc: correct rx\_bytes statistics of XDP
[ Upstream commit fdebd850cc065495abf1d64756496050bb22db67 ]
The rx\_bytes statistics of XDP are always zero, because rx\_byte\_cnt
is not updated after it is initialized to 0. So fix it.
Fixes: d1b15102dd16 ("net: enetc: add support for XDP\_DROP and XDP\_PASS")
Signed-off-by: Wei Fang
Reviewed-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5062df8af641aa47ea60d2a6a4f3cd52cc103ded
Author: Wei Fang
Date: Fri Jun 2 17:46:58 2023 +0800
net: enetc: correct the statistics of rx bytes
[ Upstream commit 7190d0ff0e17690a9b1279d84a06473600ba2060 ]
The rx\_bytes of struct net\_device\_stats should count the length of
ethernet frames excluding the FCS. However, there are two problems
with the rx\_bytes statistics of the current enetc driver. one is
that the length of VLAN header is not counted if the VLAN extraction
feature is enabled. The other is that the length of L2 header is not
counted, because eth\_type\_trans() is invoked before updating rx\_bytes
which will subtract the length of L2 header from skb->len.
BTW, the rx\_bytes statistics of XDP path also have similar problem,
I will fix it in another patch.
Fixes: a800abd3ecb9 ("net: enetc: move skb creation into enetc\_build\_skb")
Signed-off-by: Wei Fang
Reviewed-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d3aea02f0fe101f2fc67678dbbc2303fa7ff9698
Author: Wen Gu
Date: Thu Jun 1 16:41:52 2023 +0800
net/smc: Avoid to access invalid RMBs' MRs in SMCRv1 ADD LINK CONT
[ Upstream commit c308e9ec004721a656c193243eab61a8be324657 ]
SMCRv1 has a similar issue to SMCRv2 (see link below) that may access
invalid MRs of RMBs when construct LLC ADD LINK CONT messages.
BUG: kernel NULL pointer dereference, address: 0000000000000014
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 5 PID: 48 Comm: kworker/5:0 Kdump: loaded Tainted: G W E 6.4.0-rc3+ #49
Workqueue: events smc\_llc\_add\_link\_work [smc]
RIP: 0010:smc\_llc\_add\_link\_cont+0x160/0x270 [smc]
RSP: 0018:ffffa737801d3d50 EFLAGS: 00010286
RAX: ffff964f82144000 RBX: ffffa737801d3dd8 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff964f81370c30
RBP: ffffa737801d3dd4 R08: ffff964f81370000 R09: ffffa737801d3db0
R10: 0000000000000001 R11: 0000000000000060 R12: ffff964f82e70000
R13: ffff964f81370c38 R14: ffffa737801d3dd3 R15: 0000000000000001
FS: 0000000000000000(0000) GS:ffff9652bfd40000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000014 CR3: 000000008fa20004 CR4: 00000000003706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
smc\_llc\_srv\_rkey\_exchange+0xa7/0x190 [smc]
smc\_llc\_srv\_add\_link+0x3ae/0x5a0 [smc]
smc\_llc\_add\_link\_work+0xb8/0x140 [smc]
process\_one\_work+0x1e5/0x3f0
worker\_thread+0x4d/0x2f0
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xe5/0x120
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x2c/0x50

When an alernate RNIC is available in system, SMC will try to add a new
link based on the RNIC for resilience. All the RMBs in use will be mapped
to the new link. Then the RMBs' MRs corresponding to the new link will
be filled into LLC messages. For SMCRv1, they are ADD LINK CONT messages.
However smc\_llc\_add\_link\_cont() may mistakenly access to unused RMBs which
haven't been mapped to the new link and have no valid MRs, thus causing a
crash. So this patch fixes it.
Fixes: 87f88cda2128 ("net/smc: rkey processing for a new link as SMC client")
Link: https://lore.kernel.org/r/1685101741-74826-3-git-send-email-guwen@linux.alibaba.com
Signed-off-by: Wen Gu
Reviewed-by: Wenjia Zhang
Reviewed-by: Tony Lu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 86b385fa6cb57bcde0bedc38d813f5e615bb531e
Author: Eric Dumazet
Date: Thu Jun 1 16:04:44 2023 +0000
net/ipv6: fix bool/int mismatch for skip\_notify\_on\_dev\_down
[ Upstream commit edf2e1d2019b2730d6076dbe4c040d37d7c10bbe ]
skip\_notify\_on\_dev\_down ctl table expects this field
to be an int (4 bytes), not a bool (1 byte).
Because proc\_dou8vec\_minmax() was added in 5.13,
this patch converts skip\_notify\_on\_dev\_down to an int.
Following patch then converts the field to u8 and use proc\_dou8vec\_minmax().
Fixes: 7c6bb7d2faaf ("net/ipv6: Add knob to skip DELROUTE message on device down")
Signed-off-by: Eric Dumazet
Reviewed-by: David Ahern
Acked-by: Matthieu Baerts
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 18fada1191de316c607c309159216f7072073fd5
Author: Rhys Rustad-Elliott
Date: Fri Jun 2 19:02:02 2023 +0000
bpf: Fix elem\_size not being set for inner maps
[ Upstream commit cba41bb78d70aad98d8e61e019fd48c561f7f396 ]
Commit d937bc3449fa ("bpf: make uniform use of array->elem\_size
everywhere in arraymap.c") changed array\_map\_gen\_lookup to use
array->elem\_size instead of round\_up(map->value\_size, 8) as the element
size when generating code to access a value in an array map.
array->elem\_size, however, is not set by bpf\_map\_meta\_alloc when
initializing an BPF\_MAP\_TYPE\_ARRAY\_OF\_MAPS or BPF\_MAP\_TYPE\_HASH\_OF\_MAPS.
This results in array\_map\_gen\_lookup incorrectly outputting code that
always accesses index 0 in the array (as the index will be calculated
via a multiplication with the element size, which is incorrectly set to
0).
Set elem\_size on the bpf\_array object when allocating an array or hash
of maps to fix this.
Fixes: d937bc3449fa ("bpf: make uniform use of array->elem\_size everywhere in arraymap.c")
Signed-off-by: Rhys Rustad-Elliott
Link: https://lore.kernel.org/r/20230602190110.47068-2-me@rhysre.net
Signed-off-by: Martin KaFai Lau
Signed-off-by: Sasha Levin
commit bc9c287cb79d7ca365955e420aefbd7b83761d53
Author: KP Singh
Date: Fri Jun 2 02:26:12 2023 +0200
bpf: Fix UAF in task local storage
[ Upstream commit b0fd1852bcc21accca6260ef245356d5c141ff66 ]
When task local storage was generalized for tracing programs, the
bpf\_task\_local\_storage callback was moved from a BPF LSM hook
callback for security\_task\_free LSM hook to it's own callback. But a
failure case in bad\_fork\_cleanup\_security was missed which, when
triggered, led to a dangling task owner pointer and a subsequent
use-after-free. Move the bpf\_task\_storage\_free to the very end of
free\_task to handle all failure cases.
This issue was noticed when a BPF LSM program was attached to the
task\_alloc hook on a kernel with KASAN enabled. The program used
bpf\_task\_storage\_get to copy the task local storage from the current
task to the new task being created.
Fixes: a10787e6d58c ("bpf: Enable task local storage for tracing programs")
Reported-by: Kuba Piecuch
Signed-off-by: KP Singh
Acked-by: Song Liu
Link: https://lore.kernel.org/r/20230602002612.1117381-1-kpsingh@kernel.org
Signed-off-by: Martin KaFai Lau
Signed-off-by: Sasha Levin
commit 2c38ddb1b93663095dc79383c956a61355826765
Author: Akihiro Suda
Date: Thu Jun 1 12:13:05 2023 +0900
net/ipv4: ping\_group\_range: allow GID from 2147483648 to 4294967294
[ Upstream commit e209fee4118fe9a449d4d805361eb2de6796be39 ]
With this commit, all the GIDs ("0 4294967294") can be written to the
"net.ipv4.ping\_group\_range" sysctl.
Note that 4294967295 (0xffffffff) is an invalid GID (see gid\_valid() in
include/linux/uidgid.h), and an attempt to register this number will cause
-EINVAL.
Prior to this commit, only up to GID 2147483647 could be covered.
Documentation/networking/ip-sysctl.rst had "0 4294967295" as an example
value, but this example was wrong and causing -EINVAL.
Fixes: c319b4d76b9e ("net: ipv4: add IPPROTO\_ICMP socket kind")
Co-developed-by: Kuniyuki Iwashima
Signed-off-by: Kuniyuki Iwashima
Signed-off-by: Akihiro Suda
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ade5a6864875e054d7e76da84d72c288d81f8ce1
Author: Alexander Sverdlin
Date: Wed May 31 16:38:26 2023 +0200
net: dsa: lan9303: allow vid != 0 in port\_fdb\_{add|del} methods
[ Upstream commit 5a59a58ec25d44f853c26bdbfda47d73b3067435 ]
LAN9303 doesn't associate FDB (ALR) entries with VLANs, it has just one
global Address Logic Resolution table [1].
Ignore VID in port\_fdb\_{add|del} methods, go on with the global table. This
is the same semantics as hellcreek or RZ/N1 implement.
Visible symptoms:
LAN9303\_MDIO 5b050000.ethernet-1:00: port 2 failed to delete 00:xx:xx:xx:xx:cf vid 1 from fdb: -2
LAN9303\_MDIO 5b050000.ethernet-1:00: port 2 failed to add 00:xx:xx:xx:xx:cf vid 1 to fdb: -95
[1] https://ww1.microchip.com/downloads/en/DeviceDoc/00002308A.pdf
Fixes: 0620427ea0d6 ("net: dsa: lan9303: Add fdb/mdb manipulation")
Signed-off-by: Alexander Sverdlin
Reviewed-by: Vladimir Oltean
Link: https://lore.kernel.org/r/20230531143826.477267-1-alexander.sverdlin@siemens.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 726baae13e7bea9270a207aa88bdfd21836ee119
Author: Qingfang DENG
Date: Thu Jun 1 09:54:32 2023 +0800
neighbour: fix unaligned access to pneigh\_entry
[ Upstream commit ed779fe4c9b5a20b4ab4fd6f3e19807445bb78c7 ]
After the blamed commit, the member key is longer 4-byte aligned. On
platforms that do not support unaligned access, e.g., MIPS32R2 with
unaligned\_action set to 1, this will trigger a crash when accessing
an IPv6 pneigh\_entry, as the key is cast to an in6\_addr pointer.
Change the type of the key to u32 to make it aligned.
Fixes: 62dd93181aaa ("[IPV6] NDISC: Set per-entry is\_router flag in Proxy NA.")
Signed-off-by: Qingfang DENG
Link: https://lore.kernel.org/r/20230601015432.159066-1-dqfext@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 303742b31a2d2da09d574a9505beccaafec3268d
Author: Eric Dumazet
Date: Tue May 30 19:51:49 2023 +0000
bpf, sockmap: Avoid potential NULL dereference in sk\_psock\_verdict\_data\_ready()
[ Upstream commit b320a45638296b63be8d9a901ca8bc43716b1ae1 ]
syzbot found sk\_psock(sk) could return NULL when called
from sk\_psock\_verdict\_data\_ready().
Just make sure to handle this case.
[1]
general protection fault, probably for non-canonical address 0xdffffc000000005c: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x00000000000002e0-0x00000000000002e7]
CPU: 0 PID: 15 Comm: ksoftirqd/0 Not tainted 6.4.0-rc3-syzkaller-00588-g4781e965e655 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 05/16/2023
RIP: 0010:sk\_psock\_verdict\_data\_ready+0x19f/0x3c0 net/core/skmsg.c:1213
Code: 4c 89 e6 e8 63 70 5e f9 4d 85 e4 75 75 e8 19 74 5e f9 48 8d bb e0 02 00 00 48 b8 00 00 00 00 00 fc ff df 48 89 fa 48 c1 ea 03 <80> 3c 02 00 0f 85 07 02 00 00 48 89 ef ff 93 e0 02 00 00 e8 29 fd
RSP: 0018:ffffc90000147688 EFLAGS: 00010206
RAX: dffffc0000000000 RBX: 0000000000000000 RCX: 0000000000000100
RDX: 000000000000005c RSI: ffffffff8825ceb7 RDI: 00000000000002e0
RBP: ffff888076518c40 R08: 0000000000000007 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000001 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000008000 R15: ffff888076518c40
FS: 0000000000000000(0000) GS:ffff8880b9800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f901375bab0 CR3: 000000004bf26000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
tcp\_data\_ready+0x10a/0x520 net/ipv4/tcp\_input.c:5006
tcp\_data\_queue+0x25d3/0x4c50 net/ipv4/tcp\_input.c:5080
tcp\_rcv\_established+0x829/0x1f90 net/ipv4/tcp\_input.c:6019
tcp\_v4\_do\_rcv+0x65a/0x9c0 net/ipv4/tcp\_ipv4.c:1726
tcp\_v4\_rcv+0x2cbf/0x3340 net/ipv4/tcp\_ipv4.c:2148
ip\_protocol\_deliver\_rcu+0x9f/0x480 net/ipv4/ip\_input.c:205
ip\_local\_deliver\_finish+0x2ec/0x520 net/ipv4/ip\_input.c:233
NF\_HOOK include/linux/netfilter.h:303 [inline]
NF\_HOOK include/linux/netfilter.h:297 [inline]
ip\_local\_deliver+0x1ae/0x200 net/ipv4/ip\_input.c:254
dst\_input include/net/dst.h:468 [inline]
ip\_rcv\_finish+0x1cf/0x2f0 net/ipv4/ip\_input.c:449
NF\_HOOK include/linux/netfilter.h:303 [inline]
NF\_HOOK include/linux/netfilter.h:297 [inline]
ip\_rcv+0xae/0xd0 net/ipv4/ip\_input.c:569
\_\_netif\_receive\_skb\_one\_core+0x114/0x180 net/core/dev.c:5491
\_\_netif\_receive\_skb+0x1f/0x1c0 net/core/dev.c:5605
process\_backlog+0x101/0x670 net/core/dev.c:5933
\_\_napi\_poll+0xb7/0x6f0 net/core/dev.c:6499
napi\_poll net/core/dev.c:6566 [inline]
net\_rx\_action+0x8a9/0xcb0 net/core/dev.c:6699
\_\_do\_softirq+0x1d4/0x905 kernel/softirq.c:571
run\_ksoftirqd kernel/softirq.c:939 [inline]
run\_ksoftirqd+0x31/0x60 kernel/softirq.c:931
smpboot\_thread\_fn+0x659/0x9e0 kernel/smpboot.c:164
kthread+0x344/0x440 kernel/kthread.c:379
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:308

Fixes: 6df7f764cd3c ("bpf, sockmap: Wake up polling after data copy")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Signed-off-by: Daniel Borkmann
Reviewed-by: John Fastabend
Link: https://lore.kernel.org/bpf/20230530195149.68145-1-edumazet@google.com
Signed-off-by: Sasha Levin
commit fc86c412afd814e748b54acfbf22d0b4f3850f69
Author: Lorenzo Bianconi
Date: Wed May 24 16:39:32 2023 +0200
wifi: mt76: mt7615: fix possible race in mt7615\_mac\_sta\_poll
[ Upstream commit 30bc32c7c1f975cc3c14e1c7dc437266311282cf ]
Grab sta\_poll\_lock spinlock in mt7615\_mac\_sta\_poll routine in order to
avoid possible races with mt7615\_mac\_add\_txs() or mt7615\_mac\_fill\_rx()
removing msta pointer from sta\_poll\_list.
Fixes: a621372a04ac ("mt76: mt7615: rework mt7615\_mac\_sta\_poll for usb code")
Signed-off-by: Lorenzo Bianconi
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/48b23404b759de4f1db2ef85975c72a4aeb1097c.1684938695.git.lorenzo@kernel.org
Signed-off-by: Sasha Levin
commit 2f77eb2f02cc33513e57f636165c38fab3136940
Author: David Howells
Date: Wed Jun 7 09:47:13 2023 +0100
afs: Fix setting of mtime when creating a file/dir/symlink
[ Upstream commit a27648c742104a833a01c54becc24429898d85bf ]
kafs incorrectly passes a zero mtime (ie. 1st Jan 1970) to the server when
creating a file, dir or symlink because the mtime recorded in the
afs\_operation struct gets passed to the server by the marshalling routines,
but the afs\_mkdir(), afs\_create() and afs\_symlink() functions don't set it.
This gets masked if a file or directory is subsequently modified.
Fix this by filling in op->mtime before calling the create op.
Fixes: e49c7b2f6de7 ("afs: Build an abstraction around an "operation" concept")
Signed-off-by: David Howells
Reviewed-by: Jeffrey Altman
Reviewed-by: Marc Dionne
cc: linux-afs@lists.infradead.org
cc: linux-fsdevel@vger.kernel.org
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit b4efa42b1bd02ff462a161e546e3f85a56916237
Author: Stephan Gerhold
Date: Thu May 18 15:04:25 2023 +0200
spi: qup: Request DMA before enabling clocks
[ Upstream commit 0c331fd1dccfba657129380ee084b95c1cedfbef ]
It is usually better to request all necessary resources (clocks,
regulators, ...) before starting to make use of them. That way they do
not change state in case one of the resources is not available yet and
probe deferral (-EPROBE\_DEFER) is necessary. This is particularly
important for DMA channels and IOMMUs which are not enforced by
fw\_devlink yet (unless you use fw\_devlink.strict=1).
spi-qup does this in the wrong order, the clocks are enabled and
disabled again when the DMA channels are not available yet.
This causes issues in some cases: On most SoCs one of the SPI QUP
clocks is shared with the UART controller. When using earlycon UART is
actively used during boot but might not have probed yet, usually for
the same reason (waiting for the DMA controller). In this case, the
brief enable/disable cycle ends up gating the clock and further UART
console output will halt the system completely.
Avoid this by requesting the DMA channels before changing the clock
state.
Fixes: 612762e82ae6 ("spi: qup: Add DMA capabilities")
Signed-off-by: Stephan Gerhold
Link: https://lore.kernel.org/r/20230518-spi-qup-clk-defer-v1-1-f49fc9ca4e02@gerhold.net
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 3369b1e0f464d1e4baad7827da4dff39f0541094
Author: Maximilian Luz
Date: Thu May 25 23:32:17 2023 +0200
platform/surface: aggregator\_tabletsw: Add support for book mode in KIP subsystem
[ Upstream commit 9bed667033e66083d363a11e9414ad401ecc242c ]
Devices with a type-cover have an additional "book" mode, deactivating
type-cover input and turning off its backlight. This is currently
unsupported, leading to the warning
surface\_aggregator\_tablet\_mode\_switch 01:0e:01:00:01: unknown KIP cover state: 6
Therefore, add support for this state and map it to enable tablet-mode.
Fixes: 9f794056db5b ("platform/surface: Add KIP/POS tablet-mode switch driver")
Signed-off-by: Maximilian Luz
Link: https://lore.kernel.org/r/20230525213218.2797480-2-luzmaximilian@gmail.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit cc211b57c349e93bb629cf34fbe29d9906e344fb
Author: Maximilian Luz
Date: Thu May 25 23:01:10 2023 +0200
platform/surface: aggregator: Allow completion work-items to be executed in parallel
[ Upstream commit 539e0a7f9105d19c00629c3f4da00330488e8c60 ]
Currently, event completion work-items are restricted to be run strictly
in non-parallel fashion by the respective workqueue. However, this has
lead to some problems:
In some instances, the event notifier function called inside this
completion workqueue takes a non-negligible amount of time to execute.
One such example is the battery event handling code (surface\_battery.c),
which can result in a full battery information refresh, involving
further synchronous communication with the EC inside the event handler.
This is made worse if the communication fails spuriously, generally
incurring a multi-second timeout.
Since the event completions are run strictly non-parallel, this blocks
other events from being propagated to the respective subsystems. This
becomes especially noticeable for keyboard and touchpad input, which
also funnel their events through this system. Here, users have reported
occasional multi-second "freezes".
Note, however, that the event handling system was never intended to run
purely sequentially. Instead, we have one work struct per EC/SAM
subsystem, processing the event queue for that subsystem. These work
structs were intended to run in parallel, allowing sequential processing
of work items for each subsystem but parallel processing of work items
across subsystems.
The only restriction to this is the way the workqueue is created.
Therefore, replace create\_workqueue() with alloc\_workqueue() and do not
restrict the maximum number of parallel work items to be executed on
that queue, resolving any cross-subsystem blockage.
Fixes: c167b9c7e3d6 ("platform/surface: Add Surface Aggregator subsystem")
Link: https://github.com/linux-surface/linux-surface/issues/1026
Signed-off-by: Maximilian Luz
Link: https://lore.kernel.org/r/20230525210110.2785470-1-luzmaximilian@gmail.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit fa16ef475d14cdd347633b5037bcd712196bd57a
Author: Daniel Golle
Date: Mon May 1 19:33:14 2023 +0100
spi: mt65xx: make sure operations completed before unloading
[ Upstream commit 4be47a5d59cbc9396a6ffd327913eb4c8d67a32f ]
When unloading the spi-mt65xx kernel module during an ongoing spi-mem
operation the kernel will Oops shortly after unloading the module.
This is because wait\_for\_completion\_timeout was still running and
returning into the no longer loaded module:
Internal error: Oops: 0000000096000005 [#1] SMP
Modules linked in: [many, but spi-mt65xx is no longer there]
CPU: 0 PID: 2578 Comm: block Tainted: G W O 6.3.0-next-20230428+ #0
Hardware name: Bananapi BPI-R3 (DT)
pstate: 804000c5 (Nzcv daIF +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : \_\_lock\_acquire+0x18c/0x20e8
lr : \_\_lock\_acquire+0x9b8/0x20e8
sp : ffffffc009ec3400
x29: ffffffc009ec3400 x28: 0000000000000001 x27: 0000000000000004
x26: ffffff80082888c8 x25: 0000000000000000 x24: 0000000000000000
x23: ffffffc009609da8 x22: ffffff8008288000 x21: ffffff8008288968
x20: 00000000000003c2 x19: ffffff8008be7990 x18: 00000000000002af
x17: 0000000000000000 x16: 0000000000000000 x15: ffffffc008d78970
x14: 000000000000080d x13: 00000000000002af x12: 00000000ffffffea
x11: 00000000ffffefff x10: ffffffc008dd0970 x9 : ffffffc008d78918
x8 : 0000000000017fe8 x7 : 0000000000000001 x6 : 0000000000000000
x5 : ffffff807fb53910 x4 : 0000000000000000 x3 : 0000000000000027
x2 : 0000000000000027 x1 : 0000000000000000 x0 : 00000000000c03c2
Call trace:
\_\_lock\_acquire+0x18c/0x20e8
lock\_acquire+0x100/0x2a4
\_raw\_spin\_lock\_irq+0x58/0x74
\_\_wait\_for\_common+0xe0/0x1b4
wait\_for\_completion\_timeout+0x1c/0x24
0xffffffc000acc8a4 <--- used to be mtk\_spi\_transfer\_wait
spi\_mem\_exec\_op+0x390/0x3ec
spi\_mem\_no\_dirmap\_read+0x6c/0x88
spi\_mem\_dirmap\_read+0xcc/0x12c
spinand\_read\_page+0xf8/0x1dc
spinand\_mtd\_read+0x1b4/0x2fc
mtd\_read\_oob\_std+0x58/0x7c
mtd\_read\_oob+0x8c/0x148
mtd\_read+0x50/0x6c
...
Prevent this by completing in mtk\_spi\_remove if needed.
Fixes: 9f763fd20da7 ("spi: mediatek: add spi memory support for ipm design")
Signed-off-by: Daniel Golle
Link: https://lore.kernel.org/r/ZFAF6pJxMu1z6k4w@makrotopia.org
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin


=== Content from security.netapp.com_485f099f_20250114_185204.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [July 2023 Linux Kernel 6.3.7 Vulnerabilities in NetApp Products](https://security.netapp.com/advisory/ntap-20230824-0011)

## July 2023 Linux Kernel 6.3.7 Vulnerabilities in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20230824-0011 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20230824-0011 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20230824-0011 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20230824-0011 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20230824-0011
**Version:**
5.0

**Last updated:**
10/18/2024

**Status:**
Interim.

**CVEs:** CVE-2023-38427, CVE-2023-38431

Overview
#### Summary

Multiple NetApp products incorporate Linux kernel. Linux kernel versions prior to 6.3.8 are susceptible to vulnerabilities which when successfully exploited could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Impact

Successful exploitation of these vulnerabilities could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2023-38427](https://nvd.nist.gov/vuln/detail/CVE-2023-38427) | 9.8 (CRITICAL) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2023-38431](https://nvd.nist.gov/vuln/detail/CVE-2023-38431) | 9.1 (CRITICAL) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

Affected Products
#### Affected Products

* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp SolidFire & HCI Management Node

#### Products Under Investigation

* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Compute Node (Bootstrap OS)

#### Products Not Affected

* AFF BIOS - A700s
* AFF Baseboard Management Controller (BMC) - A700s
* ATTO FibreBridge - 7600N
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ Unified Manager for VMware vSphere
* Active IQ mobile app
* Astra Control Center
* Astra Control Center - NetApp Kubernetes Monitoring Operator
* Astra Trident
* Astra Trident Autosupport
* BlueXP Classification
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Volumes ONTAP Mediator
* Data Infrastructure Insights Acquisition Unit (formerly Cloud Insights Acquisition Unit)
* Data Infrastructure Insights Storage Workload Security Agent (formerly Cloud Insights Storage Workload Security Agent)
* Data Infrastructure Insights Telegraf Agent (formerly Cloud Insights Telegraf Agent)
* E-Series BIOS
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Powershell Tools
* Element Python SDK
* FAS/AFF BIOS - 2820
* FAS/AFF BIOS - 8300/8700/A400/C400
* FAS/AFF BIOS - A250/500f/C250
* FAS/AFF BIOS - A300/8200/C190/A220/2720/2750/A150
* FAS/AFF BIOS - A320
* FAS/AFF BIOS - A700/9000
* FAS/AFF BIOS - A800/C800
* FAS/AFF BIOS - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400
* FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250
* FAS/AFF Baseboard Management Controller (BMC) - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - C190/A150/A220/FAS2720/FAS2750
* FAS/AFF Baseboard Management Controller (BMC) - FAS2820
* FAS/AFF Service Processor - A300/8200
* FAS/AFF Service Processor - A700/9000
* Global File Cache
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* IOM12 SAS Disk Shelf Firmware
* IOM12B SAS Disk Shelf Firmware
* IOM12E SAS Disk Shelf Firmware
* IOM12F SAS Disk Shelf Firmware
* IOM12G SAS Disk Shelf Firmware
* IOM6 SAS Disk Shelf Firmware
* IOM6E SAS Disk Shelf Firmware
* Management Services for Element Software and NetApp HCI
* MetroCluster DataCollector
* MetroCluster Tiebreaker
* Multipath I/O (SANtricity DSM for Windows MPIO)
* NetApp BlueXP
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Host Collection
* NetApp E-Series SANtricity Collection
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Kubernetes Monitoring Operator
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SolidFire & HCI Storage Node (Element Software)
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9 (formerly Clustered Data ONTAP)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* ONTAP tools for VMware vSphere 9
* OnCommand Insight
* OnCommand Workflow Automation
* RcfFileGenerator for MetroCluster IP
* SANtricity Storage Plugin for vCenter
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID BIOS SG1000/SG100/SG1100/SG110
* StorageGRID BIOS SG5660/SG5612/SG5760/SG5712
* StorageGRID BIOS SG6060/SGF6024/SGF6112/SG6160
* StorageGRID Baseboard Management Controller (BMC) - SG6060/SG6160/SGF6024/SGF6112/SG100/SG110/SG1000/SG1100
* System Manager 9.x

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S** | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2876227.html) for more information. |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20230824-0011>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20230824 | Initial Public Release |
| 2.0 | 20231003 | SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine and NetApp SolidFire & HCI Storage Node (Element Software) moved to Products Not Affected |
| 3.0 | 20231101 | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S moved to Won't Fix status and Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 4.0 | 20231130 | NetApp HCI Baseboard Management Controller (BMC) - H615C, NetApp HCI Baseboard Management Controller (BMC) - H610C, and NetApp HCI Baseboard Management Controller (BMC) - H610S moved to Products Not Affected, NetApp SolidFire & HCI Management Node moved to Affected Products |
| 5.0 | 20241018 | AFF Baseboard Management Controller (BMC) - A700s moved to Products Not Affected |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from git.kernel.org_69444a57_20250114_185203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/fs/smb/server)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/smb/server?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/smb/server?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/smb/server?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/fs/smb/server) | log msg author committer range |
| --- | --- |

path: [root](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)/[fs](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)/[smb](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/smb?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)/[server](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/smb/server?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2023-05-28 00:23:09 +0900 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2023-06-02 12:30:57 -0500 |
| commit | [f1a411873c85b642f13b01f21b534c2bab81fc1b](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/smb/server?id=f1a411873c85b642f13b01f21b534c2bab81fc1b) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/fs/smb/server?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)) | |
| tree | [caa7166af42776ef80dfa2c61ee0cf78ad881bc3](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=f1a411873c85b642f13b01f21b534c2bab81fc1b) /[fs/smb/server](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/smb/server?id=f1a411873c85b642f13b01f21b534c2bab81fc1b) | |
| parent | [8828003759391029fc45c15ac346622cdae19b6d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/smb/server?id=8828003759391029fc45c15ac346622cdae19b6d) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/smb/server?id=f1a411873c85b642f13b01f21b534c2bab81fc1b&id2=8828003759391029fc45c15ac346622cdae19b6d)) | |
| download | [linux-f1a411873c85b642f13b01f21b534c2bab81fc1b.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-f1a411873c85b642f13b01f21b534c2bab81fc1b.tar.gz) | |

ksmbd: fix out-of-bound read in deassemble\_neg\_contexts()The check in the beginning is
`clen + sizeof(struct smb2\_neg\_context) <= len\_of\_ctxts`,
but in the end of loop, `len\_of\_ctxts` will subtract
`((clen + 7) & ~0x7) + sizeof(struct smb2\_neg\_context)`, which causes
integer underflow when clen does the 8 alignment. We should use
`(clen + 7) & ~0x7` in the check to avoid underflow from happening.
Then there are some variables that need to be declared unsigned
instead of signed.
[ 11.671070] BUG: KASAN: slab-out-of-bounds in smb2\_handle\_negotiate+0x799/0x1610
[ 11.671533] Read of size 2 at addr ffff888005e86cf2 by task kworker/0:0/7
...
[ 11.673383] Call Trace:
[ 11.673541] <TASK>
[ 11.673679] dump\_stack\_lvl+0x33/0x50
[ 11.673913] print\_report+0xcc/0x620
[ 11.674671] kasan\_report+0xae/0xe0
[ 11.675171] kasan\_check\_range+0x35/0x1b0
[ 11.675412] smb2\_handle\_negotiate+0x799/0x1610
[ 11.676217] ksmbd\_smb\_negotiate\_common+0x526/0x770
[ 11.676795] handle\_ksmbd\_work+0x274/0x810
...
Cc: stable@vger.kernel.org
Signed-off-by: Chih-Yen Chang <cc85nod@gmail.com>
Tested-by: Chih-Yen Chang <cc85nod@gmail.com>
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=f1a411873c85b642f13b01f21b534c2bab81fc1b) (limited to 'fs/smb/server')

| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/smb/server/smb2pdu.c?id=f1a411873c85b642f13b01f21b534c2bab81fc1b) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 7 deletions

| diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 7a81541de60214..25c0ba04c59df9 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/smb/server/smb2pdu.c?id=8828003759391029fc45c15ac346622cdae19b6d)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/smb/server/smb2pdu.c?id=f1a411873c85b642f13b01f21b534c2bab81fc1b)@@ -963,13 +963,13 @@ static void decode\_sign\_cap\_ctxt(struct ksmbd\_conn \*conn,  static \_\_le32 deassemble\_neg\_contexts(struct ksmbd\_conn \*conn, struct smb2\_negotiate\_req \*req,- int len\_of\_smb)+ unsigned int len\_of\_smb) { /\* +4 is to account for the RFC1001 len field \*/ struct smb2\_neg\_context \*pctx = (struct smb2\_neg\_context \*)req; int i = 0, len\_of\_ctxts;- int offset = le32\_to\_cpu(req->NegotiateContextOffset);- int neg\_ctxt\_cnt = le16\_to\_cpu(req->NegotiateContextCount);+ unsigned int offset = le32\_to\_cpu(req->NegotiateContextOffset);+ unsigned int neg\_ctxt\_cnt = le16\_to\_cpu(req->NegotiateContextCount); \_\_le32 status = STATUS\_INVALID\_PARAMETER;  ksmbd\_debug(SMB, "decoding %d negotiate contexts\n", neg\_ctxt\_cnt);@@ -983,7 +983,7 @@ static \_\_le32 deassemble\_neg\_contexts(struct ksmbd\_conn \*conn, while (i++ < neg\_ctxt\_cnt) { int clen, ctxt\_len; - if (len\_of\_ctxts < sizeof(struct smb2\_neg\_context))+ if (len\_of\_ctxts < (int)sizeof(struct smb2\_neg\_context)) break;  pctx = (struct smb2\_neg\_context \*)((char \*)pctx + offset);@@ -1038,9 +1038,8 @@ static \_\_le32 deassemble\_neg\_contexts(struct ksmbd\_conn \*conn, }  /\* offsets must be 8 byte aligned \*/- clen = (clen + 7) & ~0x7;- offset = clen + sizeof(struct smb2\_neg\_context);- len\_of\_ctxts -= clen + sizeof(struct smb2\_neg\_context);+ offset = (ctxt\_len + 7) & ~0x7;+ len\_of\_ctxts -= offset; } return status; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 18:50:40 +0000


