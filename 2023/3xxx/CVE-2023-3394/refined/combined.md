=== Content from huntr.dev_b4495b8a_20250114_183836.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)

=== Content from github.com_7a86ae97_20250114_183833.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffossbilling%2Ffossbilling%2Fcommit%2Fb9c35a174750f1463aea86168524efce6cd48ef7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffossbilling%2Ffossbilling%2Fcommit%2Fb9c35a174750f1463aea86168524efce6cd48ef7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=FOSSBilling%2FFOSSBilling)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FOSSBilling](/FOSSBilling)
/
**[FOSSBilling](/FOSSBilling/FOSSBilling)**
Public

* [Notifications](/login?return_to=%2FFOSSBilling%2FFOSSBilling) You must be signed in to change notification settings
* [Fork
  199](/login?return_to=%2FFOSSBilling%2FFOSSBilling)
* [Star
   914](/login?return_to=%2FFOSSBilling%2FFOSSBilling)

* [Code](/FOSSBilling/FOSSBilling)
* [Issues
  182](/FOSSBilling/FOSSBilling/issues)
* [Pull requests
  19](/FOSSBilling/FOSSBilling/pulls)
* [Actions](/FOSSBilling/FOSSBilling/actions)
* [Projects
  2](/FOSSBilling/FOSSBilling/projects)
* [Security](/FOSSBilling/FOSSBilling/security)
* [Insights](/FOSSBilling/FOSSBilling/pulse)

Additional navigation options

* [Code](/FOSSBilling/FOSSBilling)
* [Issues](/FOSSBilling/FOSSBilling/issues)
* [Pull requests](/FOSSBilling/FOSSBilling/pulls)
* [Actions](/FOSSBilling/FOSSBilling/actions)
* [Projects](/FOSSBilling/FOSSBilling/projects)
* [Security](/FOSSBilling/FOSSBilling/security)
* [Insights](/FOSSBilling/FOSSBilling/pulse)

## Commit

[Permalink](/FOSSBilling/FOSSBilling/commit/b9c35a174750f1463aea86168524efce6cd48ef7)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Replace Box\_Session and improve session handling ([#1332](https://github.com/FOSSBilling/FOSSBilling/pull/1332))

[Browse files](/FOSSBilling/FOSSBilling/tree/b9c35a174750f1463aea86168524efce6cd48ef7)
Browse the repository at this point in the history

```
* Replace Box_Session and improve session handling

* Improve weights, capitalize class name correctly

* Make the tests pass, update the SQL structure

* Tweak to the fingerprint class, fix more tests

* Regenerate session IDs when logging in

* Improve readability

* Update ServiceTest.php

* Tweak weights and added Huntr badge to the readme

* Improve readability, add PHPDocs, and updated weight

* Update SECURITY.md
```

* Loading branch information

[![@BelleNottelling](https://avatars.githubusercontent.com/u/17304943?s=40&v=4)](/BelleNottelling)

[BelleNottelling](/FOSSBilling/FOSSBilling/commits?author=BelleNottelling "View all commits by BelleNottelling")
authored
Jun 19, 2023

1 parent
[2f90e05](/FOSSBilling/FOSSBilling/commit/2f90e055d0024a48db87ca6e5f2274db7e82e21c)

commit b9c35a1

 Show file tree

 Hide file tree

Showing
**25 changed files**
with
**381 additions**
and
**206 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* README.md
  [README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5)
* SECURITY.md
  [SECURITY.md](#diff-f6ed156e4bf5c791680662464b94ea5d753f219ee816b385f67870e2c0d7d4c7)
* cspell.json
  [cspell.json](#diff-77519f787fe7e051a14c588f101d61e4d8f0d3b01bf8e16cb65d3838243d4e68)
* src

  + src/di.php
    [di.php](#diff-3327b052587598d10e9bf138ccb8a2709c976e645c74f27e8c35cdd2f58669d3)
  + install/sql

    - src/install/sql/content.sql
      [content.sql](#diff-bf404c7d1470893cdd3e97b304a955e14b0bbe24167c8ce7920d086cd8570aa8)
    - src/install/sql/structure.sql
      [structure.sql](#diff-a935cb25498831151fa4cb0abba3903594eb47c11ead0978c842c2b00f7bbf7c)
  + library

    - Box

      * src/library/Box/Session.php
        [Session.php](#diff-8150b225b4a3423c43939b97f6c84d973116b60476a91f5e63776d61f2457141)
    - FOSSBilling

      * src/library/FOSSBilling/Fingerprint.php
        [Fingerprint.php](#diff-4cc45d9c371507009d3f3e1fe3c7e4ea6dbfeba4b99b59edd8e043beb59f0fce)
      * src/library/FOSSBilling/Session.php
        [Session.php](#diff-4c47df5f9793f567f8202af64b890fc5e39704420ef22dbdaa1df71bf9fbec8f)
      * src/library/FOSSBilling/UpdatePatcher.php
        [UpdatePatcher.php](#diff-e2bcd8068464c35c8dd3c10bd21f1606c42cb8431d590175917a27f92117232c)
  + modules

    - Client/Api

      * src/modules/Client/Api/Guest.php
        [Guest.php](#diff-2d484427a6a1ce4a6518cf8b8ef0e8f37a2b67126efe7d45f18a2fac253e9118)
    - Cron

      * src/modules/Cron/Service.php
        [Service.php](#diff-985de2910ddfb473b50714a089189bd98e1a00752bacbee8656f9a93dc08a116)
    - Profile

      * Api

        + src/modules/Profile/Api/Admin.php
          [Admin.php](#diff-599e140940f77a93a8d701636fee2f1f98810e88c04c023f83db812f3902c333)
      * src/modules/Profile/Service.php
        [Service.php](#diff-787f369fd03af5049642284043317f59d420976f86931ccd1d348d8a23325725)
    - Staff

      * src/modules/Staff/Service.php
        [Service.php](#diff-e7a57945d627e1f243e7f41783a144496a4dbb1c5c9df1aa38f7c086282e0b51)
* tests

  + integration/bb-library/Box

    - tests/integration/bb-library/Box/DiTest.php
      [DiTest.php](#diff-6ca6ca0373db5f1dfd4438e2d56e84f8fafa6c5831cb11dac4955a5ccd60de57)
  + library/Box

    - tests/library/Box/Box\_SessionTest.php
      [Box\_SessionTest.php](#diff-e32160e693ebec80e0fa5f1b08fa97b5306f9a2703168301e36d5681f163ead9)
  + modules

    - Cart

      * tests/modules/Cart/ServiceTest.php
        [ServiceTest.php](#diff-12addb952d1c3d166826e2b0911a4e3a428fc8a23d11b8755c7472a2b7e01528)
    - Client/Api

      * tests/modules/Client/Api/AdminTest.php
        [AdminTest.php](#diff-ef3e33d4b1c7cd2dfac6fb9e875ffffe4ec4f608800709ee9a55713f15f1458d)
      * tests/modules/Client/Api/GuestTest.php
        [GuestTest.php](#diff-b66592ead04528f9d02d954aae736c81aa3ba05203276ff0e7f0be63376078f6)
    - Cron

      * tests/modules/Cron/ServiceTest.php
        [ServiceTest.php](#diff-40062109b1c024b0e48338dd983dcc4e214ff2f8895e8fe43cf2bbabb7b9361a)
    - Profile

      * Api

        + tests/modules/Profile/Api/AdminTest.php
          [AdminTest.php](#diff-5cac9c4878c56e77f7e0c3eed3f2e8bcf2205338e9f4a6397bd2a02c079c9c4c)
      * tests/modules/Profile/ServiceTest.php
        [ServiceTest.php](#diff-ba662b146af49186e3d2dcd06a102de18335a0173b8569250de5b310179991e0)
    - Staff

      * tests/modules/Staff/ServiceTest.php
        [ServiceTest.php](#diff-d6bda448ec63a68460940791f37b6b0c4cfcdc44315dba68548e9bb769d21ab4)
    - System

      * tests/modules/System/ServiceTest.php
        [ServiceTest.php](#diff-de4792c7b001d3ed41d4877f0cd5a1b03f38f350b7857ca5fb1c96b71664af87)

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5 "README.md")

Show comments

[View file](/FOSSBilling/FOSSBilling/blob/b9c35a174750f1463aea86168524efce6cd48ef7/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -22,6 +22,8 @@ |
|  |  | [![CodeFactor](https://www.codefactor.io/repository/github/FOSSBilling/FOSSBilling/badge)](https://www.codefactor.io/repository/github/fossbilling/fossbilling) |
|  |  | [![Financial Contributors](https://opencollective.com/FOSSBilling/tiers/badge.svg?color=brightgreen)](https://opencollective.com/fossbilling) |
|  |  | [![Crowdin](https://badges.crowdin.net/e/c70c78b4ab1e71424ce53dcf6bca9b12/localized.svg)](https://fossbilling.crowdin.com/FOSSBilling) |
|  |  | [![huntr](https://cdn.huntr.dev/huntr\_security\_badge\_mono.svg)](https://huntr.dev/repos/fossbilling/fossbilling/) |
|  |  |  |
|  |  | </div> |
|  |  |  |
|  |  | > \*\*Warning\*\* |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[SECURITY.md](#diff-f6ed156e4bf5c791680662464b94ea5d753f219ee816b385f67870e2c0d7d4c7 "SECURITY.md")

Show comments

[View file](/FOSSBilling/FOSSBilling/blob/b9c35a174750f1463aea86168524efce6cd48ef7/SECURITY.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -4,7 +4,8 @@ |
|  |  |  |
|  |  | | Version | Supported | |
|  |  | | ------- | ------------------ | |
|  |  | | 0.4.x | :white\_check\_mark: | |
|  |  | | 0.5.x | :white\_check\_mark: | |
|  |  | | 0.4.x | :x: | |
|  |  | | 0.3.x | :x: | |
|  |  | | 0.2.x | :x: | |
|  |  | | 0.1.x | :x: | |
| Expand Down | |  |

5 changes: 3 additions & 2 deletions

5
[cspell.json](#diff-77519f787fe7e051a14c588f101d61e4d8f0d3b01bf8e16cb65d3838243d4e68 "cspell.json")

Show comments

[View file](/FOSSBilling/FOSSBilling/blob/b9c35a174750f1463aea86168524efce6cd48ef7/cspell.json)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -226,7 +226,6 @@ |
|  |  | "gugl", |
|  |  | "cclogin", |
|  |  | "CURDATE", |
|  |  | "BOXCLR", |
|  |  | "vatnum", |
|  |  | "caid", |
|  |  | "ECB's", |
| Expand Down  Expand Up | | @@ -338,7 +337,9 @@ |
|  |  | "autoloader", |
|  |  | "qwertyuiopasdfghjklzxccvbnm", |
|  |  | "QWERTYUIOPASDFGHJKLZXCVBNM", |
|  |  | "subkeys" |
|  |  | "subkeys", |
|  |  | "httponly", |
|  |  | "samesite" |
|  |  | ], |
|  |  | "ignorePaths": [ |
|  |  | "tests/\*\*", |
| Expand Down | |  |

15 changes: 10 additions & 5 deletions

15
[src/di.php](#diff-3327b052587598d10e9bf138ccb8a2709c976e645c74f27e8c35cdd2f58669d3 "src/di.php")

Show comments

[View file](/FOSSBilling/FOSSBilling/blob/b9c35a174750f1463aea86168524efce6cd48ef7/src/di.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -224,15 +224,20 @@ |
|  |  | \* |
|  |  | \* @param void |
|  |  | \* |
|  |  | \* @return \Box\_Session |
|  |  | \* @return \FOSSBilling\Session |
|  |  | \*/ |
|  |  | $di['session'] = function () use ($di) { |
|  |  | $handler = new PdoSessionHandler($di['pdo']); |
|  |  | $mode = (isset($di['config']['security']['mode'])) ? $di['config']['security']['mode'] : 'strict'; |
|  |  | $lifespan = (isset($di['config']['security']['cookie\_lifespan'])) ? $di['config']['security']['cookie\_lifespan'] : 7200; |
|  |  | $secure = (isset($di['config']['security']['force\_https'])) ? $di['config']['security']['force\_https'] : true; |
|  |  |  |
|  |  | return new Box\_Session($handler, $mode, $lifespan, $secure); |
|  |  | $mode = $di['config']['security']['mode'] ?? 'strict'; |
|  |  | $lifespan = $di['config']['security']['cookie\_lifespan'] ?? 7200; |
|  |  | $secure = $di['config']['security']['force\_https'] ?? true; |
|  |  |  |
|  |  | $session = new \FOSSBilling\Session($handler, $mode, $lifespan, $secure); |
|  |  | $session->setDi($di); |
|  |  | $session->setupSession(); |
|  |  |  |
|  |  | return $session; |
|  |  | }; |
|  |  |  |
|  |  | /\* |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/install/sql/content.sql](#diff-bf404c7d1470893cdd3e97b304a955e14b0bbe24167c8ce7920d086cd8570aa8 "src/install/sql/content.sql")

Show comments

[View file](/FOSSBilling/FOSSBilling/blob/b9c35a174750f1463aea86168524efce6cd48ef7/src/install/sql/content.sql)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -316,7 +316,7 @@ LOCK TABLES `setting` WRITE; |
|  |  |  |
|  |  | INSERT INTO `setting` (`id`, `param`, `value`, `public`, `category`, `hash`, `created\_at`, `updated\_at`) |
|  |  | VALUES |
|  |  | (1,'last\_patch','33',0,NULL,NULL,'2022-12-01 12:00:00','2022-12-01 12:00:00'), |
|  |  | (1,'last\_patch','34',0,NULL,NULL,'2022-12-01 12:00:00','2022-12-01 12:00:00'), |
|  |  | (2,'company\_name','Company Name',0,NULL,NULL,'2022-12-01 12:00:00','2022-12-01 12:00:00'), |
|  |  | (3,'company\_email','company@email.com',0,NULL,NULL,'2022-12-01 12:00:00','2022-12-01 12:00:00'), |
|  |  | (4,'company\_signature','FOSSBilling.org - Client Management, Invoice and Support Software',0,NULL,NULL,'2022-12-01 12:00:00','2022-12-01 12:00:00'), |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[src/install/sql/structure.sql](#diff-a935cb25498831151fa4cb0abba3903594eb47c11ead0978c842c2b00f7bbf7c "src/install/sql/structure.sql")

Show comments

[View file](/FOSSBilling/FOSSBilling/blob/b9c35a174750f1463aea86168524efce6cd48ef7/src/install/sql/structure.sql)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1145,6 +1145,7 @@ CREATE TABLE `session` ( |
|  |  | `id` varchar(32) NOT NULL DEFAULT '', |
|  |  | `modified\_at` int(11) DEFAULT NULL, |
|  |  | `content` text, |
|  |  | `fingerprint` text, |
|  |  | UNIQUE KEY `unique\_id` (`id`) |
|  |  | ) ENGINE=InnoDB DEFAULT CHARSET=utf8; |
|  |  | /\*!40101 SET character\_set\_client = @saved\_cs\_client \*/; |
| Expand Down | |  |

88 changes: 0 additions & 88 deletions

88
[src/library/Box/Session.php](#diff-8150b225b4a3423c43939b97f6c84d973116b60476a91f5e63776d61f2457141 "src/library/Box/Session.php")

Show comments

[View file](/FOSSBilling/FOSSBilling/blob/2f90e055d0024a48db87ca6e5f2274db7e82e21c/src/library/Box/Session.php)
Edit file

Delete file

Load diff

This file was deleted.

Oops, something went wrong.

Retry

163 changes: 163 additions & 0 deletions

163
[src/library/FOSSBilling/Fingerprint.php](#diff-4cc45d9c371507009d3f3e1fe3c7e4ea6dbfeba4b99b59edd8e043beb59f0fce "src/library/FOSSBilling/Fingerprint.php")

Show comments

[View file](/FOSSBilling/FOSSBilling/blob/b9c35a174750f1463aea86168524efce6cd48ef7/src/library/FOSSBilling/Fingerprint.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,163 @@ |
|  |  | <?php |
|  |  | declare(strict\_types=1); |
|  |  | /\*\* |
|  |  | \* Copyright 2022-2023 FOSSBilling |
|  |  | \* Copyright 2011-2021 BoxBilling, Inc. |
|  |  | \* SPDX-License-Identifier: Apache-2.0 |
|  |  | \* |
|  |  | \* @copyright FOSSBilling (https://www.fossbilling.org) |
|  |  | \* @license http://www.apache.org/licenses/LICENSE-2.0 Apache-2.0 |
|  |  | \*/ |
|  |  |  |
|  |  | namespace FOSSBilling; |
|  |  |  |
|  |  | class Fingerprint |
|  |  | { |
|  |  | private array $fingerprintProperties; |
|  |  |  |
|  |  | public function \_\_construct() |
|  |  | { |
|  |  | $agentDetails = $this->extractAgentInfo(); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Sets up the fingerprint info for the existing request. |
|  |  | \* 'weight' is used to weigh specific parameters. |
|  |  | \* Example: The agent string has a weight of 2, one failure from it equal as 2 failures of other properties. |
|  |  | \* By doing this, we can prevent minor changes such as a browser update from requiring the user to re-authenticate. |
|  |  | \* But it does mean that if the that property and one-or-two other ones fail, the user will need to re-authenticate. |
|  |  | \*/ |
|  |  | $this->fingerprintProperties = [ |
|  |  | 'agentString' => [ |
|  |  | 'source' => $agentDetails['userAgent'], |
|  |  | 'weight' => 2, |
|  |  | ], |
|  |  | 'browser' => [ |
|  |  | 'source' => $agentDetails['browser'], |
|  |  | 'weight' => 100, // Always fail if this doesn't match. |
|  |  | ], |
|  |  | 'browserVersion' => [ |
|  |  | 'source' => $agentDetails['browserVersion'], |
|  |  | 'weight' => 1, |
|  |  | ], |
|  |  | 'os' => [ |
|  |  | 'source' => $agentDetails['os'], |
|  |  | 'weight' => 100, // Always fail if this doesn't match. |
|  |  | ], |
|  |  | 'ip' => [ |
|  |  | 'source' => $\_SERVER['REMOTE\_ADDR'] ?? '', |
|  |  | 'weight' => 3, |
|  |  | ], |
|  |  | 'referrer' => [ |
|  |  | 'source' => $\_SERVER['HTTP\_REFERER'] ?? '', |
|  |  | 'weight' => 1, |
|  |  | ], |
|  |  | 'forwardedFor' => [ |
|  |  | 'source' => $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ?? '', |
|  |  | 'weight' => 3, |
|  |  | ], |
|  |  | 'language' => [ |
|  |  | 'source' => $\_SERVER['HTTP\_ACCEPT\_LANGUAGE'] ?? '', |
|  |  | 'weight' => 2, |
|  |  | ], |
|  |  | 'encoding' => [ |
|  |  | 'source' => $\_SERVER['HTTP\_ACCEPT\_ENCODING'] ?? '', |
|  |  | 'weight' => 1, |
|  |  | ], |
|  |  | 'upgradeRequests' => [ |
|  |  | 'source' => $\_SERVER['HTTP\_UPGRADE\_INSECURE\_REQUESTS'] ?? '', |
|  |  | 'weight' => 1, |
|  |  | ], |
|  |  | ]; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Generates a fingerprint for the device that made the request to the server |
|  |  | \*/ |
|  |  | public function fingerprint(): array |
|  |  | { |
|  |  | $fingerprint = []; |
|  |  |  |
|  |  | foreach ($this->fingerprintProperties as $name => $properties) { |
|  |  | if (!empty($properties['source'])) { |
|  |  | $fingerprint[$name] = hash('md5', $properties['source']); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | return $fingerprint; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Compares a provided fingerprint against one generated for the device that made the request to the server. |
|  |  | \* This function creates a baseline "score" with the total of properties in the fingerprint. The final score must be at least half of the baseline. |
|  |  | \* - Each property can define a weight. For example, if the IP address doesn't match and the weight is set to 3, 3 will be selected from the total. |
|  |  | \* - This means with a total of 9 properties, the IP address being wrong would effectively be weighted as 3 properties and only two more differing properties will make it fail the check. |
|  |  | \* - If any property is found in one of the fingerprints and not the other, the baseline is incremented and the final score is decreased by it's weight. |
|  |  | \*/ |
|  |  | public function checkFingerprint(array $fingerprint): bool |
|  |  | { |
|  |  | $itemCount = 0; |
|  |  | $scoreSubtract = 0; |
|  |  |  |
|  |  | foreach ($this->fingerprintProperties as $name => $properties) { |
|  |  | $exitsInFingerprint = array\_key\_exists($name, $fingerprint); |
|  |  | $exitsInCurrentFingerprint = !empty($properties['source']); |
|  |  |  |
|  |  | if ((!$exitsInFingerprint && $exitsInCurrentFingerprint) || ($exitsInFingerprint && !$exitsInCurrentFingerprint)) { |
|  |  | //The property exists in one fingerprint and not the other, so we increment the total count and deduct from the score. |
|  |  | $itemCount++; |
|  |  | $scoreSubtract += $properties['weight']; |
|  |  | } elseif (!$exitsInFingerprint && !$exitsInCurrentFingerprint) { |
|  |  | // Do nothing in this case, as the property isn't in either fingerprint. |
|  |  | } else { |
|  |  | $itemCount++; |
|  |  | $hashedData = hash('md5', $properties['source']); |
|  |  |  |
|  |  | if ($fingerprint[$name] !== $hashedData) { |
|  |  | $scoreSubtract += $properties['weight']; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Remove the total score from the total number of items. The final score must be at least half the number of properties in order for the fingerprint to be considered valid. |
|  |  | $finalScore = $itemCount - $scoreSubtract; |
|  |  | return $finalScore >= ($itemCount / 2); |
|  |  | } |
|  |  |  |
|  |  | private function extractAgentInfo(): array |
|  |  | { |
|  |  | $userAgent = $\_SERVER['HTTP\_USER\_AGENT'] ?? ''; |
|  |  |  |
|  |  | // Extract the browser name |
|  |  | if (preg\_match('/(?:Chrome|CriOS)\/([0-9\.]+)/', $userAgent, $matches)) { |
|  |  | $browser = 'Chrome'; |
|  |  | $version = $matches[1]; |
|  |  | } elseif (preg\_match('/Firefox\/([0-9\.]+)/', $userAgent, $matches)) { |
|  |  | $browser = 'Firefox'; |
|  |  | $version = $matches[1]; |
|  |  | } elseif (preg\_match('/Safari\/([0-9\.]+)/', $userAgent, $matches)) { |
|  |  | $browser = 'Safari'; |
|  |  | $version = $matches[1]; |
|  |  | } else { |
|  |  | $browser = 'Unknown'; |
|  |  | $version = 'Unknown'; |
|  |  | } |
|  |  |  |
|  |  | // Extract the operating system |
|  |  | if (preg\_match('/Windows NT ([0-9\.]+)/', $userAgent, $matches)) { |
|  |  | $os = 'Windows NT ' . $matches[1]; |
|  |  | } elseif (preg\_match('/Mac OS X ([0-9\_]+)/', $userAgent, $matches)) { |
|  |  | $os = 'Mac OS X'; |
|  |  | } elseif (preg\_match('/Linux/', $userAgent)) { |
|  |  | $os = 'Linux'; |
|  |  | } else { |
|  |  | $os = 'Unknown'; |
|  |  | } |
|  |  |  |
|  |  | return [ |
|  |  | 'browser' => $browser, |
|  |  | 'browserVersion' => $version, |
|  |  | 'os' => $os, |
|  |  | 'userAgent' => $userAgent, |
|  |  | ]; |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b9c35a1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffossbilling%2Ffossbilling%2Fcommit%2Fb9c35a174750f1463aea86168524efce6cd48ef7) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


