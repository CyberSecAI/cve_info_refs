=== Content from gitee.com_cdb23ded_20250114_205300.html ===


[Sign in](/login)
[Sign up](/signup)

* [Explore](/explore)
* [Enterprise](/enterprises)
* [Education](/education)
* [Search](/search)
* [Help](/help)
* [Terms of use](/terms)
* [About Us](/about_us)

[![Gitee — A Git-based Code Hosting and Research Collaboration Platform](/static/images/logo.svg?t=158106664 "Gitee — A Git-based Code Hosting and Research Collaboration Platform")
![Gitee — A Git-based Code Hosting and Research Collaboration Platform](/static/images/logo-black.svg?t=158106664 "Gitee — A Git-based Code Hosting and Research Collaboration Platform")](https://gitee.com)
[Explore](/explore "Explore")[Enterprise](/enterprises "Enterprise")[Education](/education "Education")[Gitee Premium](https://gitee.cn?utm_source=giteecom "Gitee Premium")[Gitee AI](https://ai.gitee.com/?utm_sources=site_nav "Gitee AI")
[![Gitee — A Git-based Code Hosting and Research Collaboration Platform](/static/images/logo.svg?t=158106664 "Gitee — A Git-based Code Hosting and Research Collaboration Platform")
![Gitee — A Git-based Code Hosting and Research Collaboration Platform](/static/images/logo-black.svg?t=158106664 "Gitee — A Git-based Code Hosting and Research Collaboration Platform")](https://gitee.com)

![功能更新](https://cn-assets.gitee.com/assets/bulb_off-24ee940be20998aace89a3f040cbc704.svg)
![]()

I know
View Details

[Sign in](/login)[Sign up](/signup)

Fetch the repository succeeded.

[Open Source](/explore)
>
[Web Development](/explore/web-app-develop)
>
[Backend Management](/explore/backend)
&&

Donate
Please sign in before you donate.

Cancel
[Sign in](/login)

Scan WeChat QR to Pay

![]()

Cancel
Complete

Prompt
Switch to Alipay.

OK
Cancel

Watch

[Unwatch](/y_project/RuoYi/unwatch)[Watching](/y_project/RuoYi/watch)[Releases Only](/y_project/RuoYi/release_only_watch)[Ignoring](/y_project/RuoYi/ignoring_watch)

[5.9K](/y_project/RuoYi/watchers "5889")
[Star](/login)[44.2K](/y_project/RuoYi/stargazers "44186")
[Fork](/login "You must be signed in to fork a repository")[24.3K](/y_project/RuoYi/members "24327")
## [GVP](/gvp "GVP - Gitee Most Valuable Project")[若依](/y_project "若依")/[RuoYi](/y_project/RuoYi "RuoYi")

[Code](/y_project/RuoYi)[Issues
27](/y_project/RuoYi/issues)[Pull Requests
46](/y_project/RuoYi/pulls)[Wiki](/y_project/RuoYi/wikis)[Insights](/y_project/RuoYi/graph/master)[Pipelines](/y_project/RuoYi/gitee_go)

Service

[![Logo en](/static/images/logo-en.svg)](/y_project/RuoYi/pages)[![Maven](https://cn-assets.gitee.com/assets/maven-bd58aee84f266d64d4b8ce5b006a9fcf.png)](/y_project/RuoYi/javadoc)[![Sonar mini](https://cn-assets.gitee.com/assets/sonar_mini-5e1b54bb9f6c951d97fb778ef623afea.png)
Quality Analysis](/y_project/RuoYi/quality_analyses?platform=sonar_qube)[![Jenkins for gitee](https://cn-assets.gitee.com/assets/jenkins_for_gitee-554ec65c490d0f1f18de632c48acc4e7.png)
Jenkins for Gitee](https://gitee.com/help/articles/4193)[![Cloudbase](https://cn-assets.gitee.com/assets/cloudbase-1197b95ea3398aff1df7fe17c65a6d42.png?20200925)
Tencent CloudBase](https://gitee.com/help/articles/4318)[![Cloud serverless](https://cn-assets.gitee.com/assets/cloud_serverless-686cf926ced5d6d2f1d6e606d270b81e.png)
Tencent Cloud Serverless](https://gitee.com/help/articles/4330)[![Logo](https://cn-assets.gitee.com/assets/open_sca/logo-9049ced662b2f9936b8001e6f9cc4952.png)
悬镜安全](/y_project/RuoYi/open_sca)[![Sae](https://cn-assets.gitee.com/assets/SAE-f3aa9366a1e2b7fff4747402eb8f10c3.png)
Aliyun SAE](https://help.gitee.com/devops/connect/Aliyun-SAE)[![Codeblitz](https://cn-assets.gitee.com/assets/Codeblitz-8824e38875a106e16e29ff57ec977b08.png)
Codeblitz](https://codeblitz.cloud.alipay.com/gitee/y_project/RuoYi/tree/master)
Don’t show this again

Update failed. Please try again later!

[Issues](/y_project/RuoYi/issues)

 /
详情

Remove this flag
#### Content Risk Flag

This task is identified by  as the content contains sensitive information such as code security bugs, privacy leaks, etc., so it is only accessible to contributors of this repository.

## 因为sql语句过滤不当引起的sql注入和dos攻击

Done

#I78DOR

[springkill](/despised)
Opened this issue
2023-05-25 18:01

在若依全版本（也可能是4.x往后的版本），使用了正则表达式判断order的参数是否正确，这避免了大部分sql注入
```java
package com.ruoyi.common.utils.sql;
import com.ruoyi.common.exception.UtilException;
import com.ruoyi.common.utils.StringUtils;
/\*\*
\* sql操作工具类
\*
\* @author ruoyi
\*/
public class SqlUtil
{
/\*\*
\* 定义常用的 sql关键字
\*/
public static String SQL\_REGEX = "and |extractvalue|updatexml|exec |insert |select |delete |update |drop |count |chr |mid |master |truncate |char |declare |or |+|user()";
/\*\*
\* 仅支持字母、数字、下划线、空格、逗号、小数点（支持多个字段排序）
\*/
public static String SQL\_PATTERN = "[a-zA-Z0-9\_\\ \\,\\.]+";
/\*\*
\* 检查字符，防止注入绕过
\*/
public static String escapeOrderBySql(String value)
{
if (StringUtils.isNotEmpty(value) && !isValidOrderBySql(value))
{
throw new UtilException("参数不符合规范，不能进行查询");
}
return value;
}
/\*\*
\* 验证 order by 语法是否符合规范
\*/
public static boolean isValidOrderBySql(String value)
{
return value.matches(SQL\_PATTERN);
}
/\*\*
\* SQL关键字检查
\*/
public static void filterKeyword(String value)
{
if (StringUtils.isEmpty(value))
{
return;
}
String[] sqlKeywords = StringUtils.split(SQL\_REGEX, "\\|");
for (String sqlKeyword : sqlKeywords)
{
if (StringUtils.indexOfIgnoreCase(value, sqlKeyword) > -1)
{
throw new UtilException("参数存在SQL注入风险");
}
}
}
}
```
但是因为允许多个字段排序且并没有对字段的数量进行限制，order后的值仍然是用户部分可控的，所以可以构造一个庞大的请求，因为过于庞大，我将请求的内容以附件的形式发送
请求将调用java和mysqlyunxingsql语句，这个请求会大量消耗服务器的资源，cpu占用率很高，服务其运行缓慢，最终服务器崩溃，整过过程只需要很少量的请求就会导致ruoyi的崩溃（具体会不会崩溃取决于服务器性能，若果是2核2g的个人服务器，可能会导致整个服务器系统的崩溃），服务无法访问，但是内存仍然占用（大概1000个左右，测试环境使用4核8g的服务器）
同时，order by后接into可以向不包含.等特殊字符的文件中写入数据，采用16进制的方式代替文件名字符串可以绕过对引号的检测，也可以占用大量服务器的磁盘空间。
![image](https://github.com/yangzongzhuan/RuoYi/assets/118535366/68207bb8-5dfc-4634-a03b-4e7eaf7b0325)
![image](https://github.com/yangzongzhuan/RuoYi/assets/118535366/b06f3b44-4170-4f63-9ae1-5eaa8cb48544)
[poc.txt](https://github.com/yangzongzhuan/RuoYi/files/11563433/poc.txt)

在若依全版本（也可能是4.x往后的版本），使用了正则表达式判断order的参数是否正确，这避免了大部分sql注入
```java
package com.ruoyi.common.utils.sql;
import com.ruoyi.common.exception.UtilException;
import com.ruoyi.common.utils.StringUtils;
/\*\*
\* sql操作工具类
\*
\* @author ruoyi
\*/
public class SqlUtil
{
/\*\*
\* 定义常用的 sql关键字
\*/
public static String SQL\_REGEX = "and |extractvalue|updatexml|exec |insert |select |delete |update |drop |count |chr |mid |master |truncate |char |declare |or |+|user()";
/\*\*
\* 仅支持字母、数字、下划线、空格、逗号、小数点（支持多个字段排序）
\*/
public static String SQL\_PATTERN = "[a-zA-Z0-9\_\\ \\,\\.]+";
/\*\*
\* 检查字符，防止注入绕过
\*/
public static String escapeOrderBySql(String value)
{
if (StringUtils.isNotEmpty(value) && !isValidOrderBySql(value))
{
throw new UtilException("参数不符合规范，不能进行查询");
}
return value;
}
/\*\*
\* 验证 order by 语法是否符合规范
\*/
public static boolean isValidOrderBySql(String value)
{
return value.matches(SQL\_PATTERN);
}
/\*\*
\* SQL关键字检查
\*/
public static void filterKeyword(String value)
{
if (StringUtils.isEmpty(value))
{
return;
}
String[] sqlKeywords = StringUtils.split(SQL\_REGEX, "\\|");
for (String sqlKeyword : sqlKeywords)
{
if (StringUtils.indexOfIgnoreCase(value, sqlKeyword) > -1)
{
throw new UtilException("参数存在SQL注入风险");
}
}
}
}
```
但是因为允许多个字段排序且并没有对字段的数量进行限制，order后的值仍然是用户部分可控的，所以可以构造一个庞大的请求，因为过于庞大，我将请求的内容以附件的形式发送
请求将调用java和mysqlyunxingsql语句，这个请求会大量消耗服务器的资源，cpu占用率很高，服务其运行缓慢，最终服务器崩溃，整过过程只需要很少量的请求就会导致ruoyi的崩溃（具体会不会崩溃取决于服务器性能，若果是2核2g的个人服务器，可能会导致整个服务器系统的崩溃），服务无法访问，但是内存仍然占用（大概1000个左右，测试环境使用4核8g的服务器）
同时，order by后接into可以向不包含.等特殊字符的文件中写入数据，采用16进制的方式代替文件名字符串可以绕过对引号的检测，也可以占用大量服务器的磁盘空间。
![image](https://github.com/yangzongzhuan/RuoYi/assets/118535366/68207bb8-5dfc-4634-a03b-4e7eaf7b0325)
![image](https://github.com/yangzongzhuan/RuoYi/assets/118535366/b06f3b44-4170-4f63-9ae1-5eaa8cb48544)
[poc.txt](https://github.com/yangzongzhuan/RuoYi/files/11563433/poc.txt)

### Comments (7)

[![]()](/despised "despised")
[springkill](/despised "despised") created**任务**

[![]()](/despised "despised")
[springkill](/despised "despised") changed **issue state** from **待办的** to **进行中**

[![]()](/despised "despised")
[springkill](/despised "despised") changed **issue state** from **进行中** to **待办的**

Expand operation logs

Collapse operation logs

[![]()
springkill](/despised)

*复制链接地址*

您好，请问贵团队对此有何看法，谢谢

误判申诉

此处可能存在不合适展示的内容，页面不予展示。您可通过相关编辑功能自查并修改。

如您确认内容无涉及 不当用语 / 纯广告导流 / 暴力 / 低俗色情 / 侵权 / 盗版 / 虚假 / 无价值内容或违法国家有关法律法规的内容，可点击提交进行申诉，我们将尽快为您处理。

取消
提交

[![1151004 y project 1578942802](https://foruda.gitee.com/avatar/1676949889394125096/1151004_y_project_1578942802.png!avatar60)
若依](/y_project)owner

*复制链接地址*

这个不算是BUG，只是传入的参数过多导致的，和下载数据量差不多，这个最好的办法就是自己去限制一下，
post限制请求大小，或者order by 限制一下，
com.ruoyi.framework.web.page.PageDomain.getOrderBy

[![]()
springkill](/despised)
Reply
[若依](/y_project)
owner

*复制链接地址*

正常情况下不应该允许传入这么多参数的吧，怎么能不算是bug

[![1151004 y project 1578942802](https://foruda.gitee.com/avatar/1676949889394125096/1151004_y_project_1578942802.png!avatar60)
若依](/y_project)owner
Reply
[springkill](/despised)

*复制链接地址*

http可以设置请求参数大小，可以自己去设置 和框架没有关系，或者自己对order by截取一下长度，或判断超出xxxx抛出异常，这个在startpage方法里面可以做这些。

[![]()
springkill](/despised)
Reply
[若依](/y_project)
owner

*复制链接地址*

如果一个使用者不了解ruoyi的这个潜在问题，没有加以限制，攻击者就可以用少量的几台机器发起dos攻击，甚至无法使用ip黑名单进行封禁，因为请求数量过低
就像你回答的“对order by截取一下长度”，这就相当于使用者自己修复了这个问题，我觉得作为一个易用的框架应当要求使用者即使不熟悉代码也能轻松上手并且避免一些安全问题，如果全都是自己修改，那么前面的shiro反序列化是否也是因为用户没有修改默认密钥导致的，也不算问题，fastjson也是因为使用者没有正确设置autoType导致的，也不能算作安全问题呢。
传入数据，执行操作，只不过，一个是执行命令，另一个是进行服务器资源的大量损耗，这不简单是带宽损耗而是mysql的计算问题，还希望能仔细考虑

[![1151004 y project 1578942802](https://foruda.gitee.com/avatar/1676949889394125096/1151004_y_project_1578942802.png!avatar100)](/y_project "y_project")
[若依](/y_project "y_project") changed **issue state** from **待办的** to **已完成**

[![]()](/despised "despised")
[springkill](/despised "despised") changed **issue state** from **已完成** to **待办的**

[![1151004 y project 1578942802](https://foruda.gitee.com/avatar/1676949889394125096/1151004_y_project_1578942802.png!avatar100)](/y_project "y_project")
[若依](/y_project "y_project") changed **issue state** from **待办的** to **已完成**

[![]()
springkill](/despised)

*复制链接地址*

![输入图片说明](https://foruda.gitee.com/images/1688552605432931751/03146df4\_12981625.png "屏幕截图")
ruoyi系统中的这个拒绝服务可以称得上是一个安全问题，相似的漏洞如上图所示，按理说这种限制 \*\*不应由用户自身进行\*\* ，因为 \*\*大部分用户不会在使用时看源码和进行测试\*\* ，字段数量一共就那么几个传入字段不该在默认情况下可以达到上限
并且该漏洞的 \*\*触发点不在于数据量的大小而在于mysql在一个请求中不断地进行上万次排序导致的性能损耗以及cpu，内存的占用\*\* ，不只是网络层面那么简单

![+1](https://cn-assets.gitee.com/assets/emoji/+1-f866ad23f6584fa15376ddb4738e53cf.png)1

[![]()](/despised "despised")
[springkill](/despised "despised") changed **issue state** from **已完成** to **待办的**

[![1151004 y project 1578942802](https://foruda.gitee.com/avatar/1676949889394125096/1151004_y_project_1578942802.png!avatar60)
若依](/y_project)owner

*复制链接地址*

:ok\_hand: 已经限制了，更新仓库最新代码即可。[排序属性orderBy参数限制长度](https://gitee.com/y\_project/RuoYi/commit/e8d8325eadda7c41360621b9fc511c4d97cbffd5)
`https://gitee.com/y\_project/RuoYi/commit/e8d8325eadda7c41360621b9fc511c4d97cbffd5`

[![1151004 y project 1578942802](https://foruda.gitee.com/avatar/1676949889394125096/1151004_y_project_1578942802.png!avatar100)](/y_project "y_project")
[若依](/y_project "y_project") changed **issue state** from **待办的** to **已完成**

[Sign in](/login)
to comment

Status

Done

Backlog

Doing

Done

Closed

Assignees

Not set

Labels

Not set

[Label settings](/y_project/RuoYi/labels)

Milestones
No related milestones

No related milestones

Pull Requests
None yet

None yet

Successfully merging a pull request will close this issue.

Branches
No related branch

Branches (2)

Tags (30)

master
springboot3

v4.8.0
v4.7.9
v4.7.8
v4.7.7
v4.7.6
v4.7.5
v4.7.4
v4.7.3
v4.7.2
v4.7.1
v4.7.0
v4.6.2
v4.6.1
v4.6.0
v4.5.1
v4.5.0
v4.4
v4.3.1
v4.3
v4.2
v4.1
v4.0
v3.4
v3.3
v3.2
v3.1
v3.0
v2.4
v2.3
v2.2

Planed to start   -   Planed to end

-

Top level

Not Top

Top Level: High

Top Level: Medium

Top Level: Low

Priority

Not specified

Serious

Main

Secondary

Unimportant

参与者（2）
[![]()](/despised)
[![1151004 y project 1578942802](https://foruda.gitee.com/avatar/1676949889394125096/1151004_y_project_1578942802.png!avatar30)](/y_project)

Java
1
https://gitee.com/y\_project/RuoYi.git
git@gitee.com:y\_project/RuoYi.git
y\_project
RuoYi
RuoYi

[![Gitee — A Git-based Code Hosting and Research Collaboration Platform](/static/images/logo-black.svg?t=158106666)](https://gitee.com)
©OSCHINA. All rights reserved

[Git Resources](/all-about-git)

[Learning Git](https://help.gitee.com/learn-Git-Branching/)

[CopyCat](https://copycat.gitee.com/)

[Downloads](/appclient)

[Gitee Reward](/gitee_reward)

[Gitee Stars](/gitee-stars)

[Featured Projects](/gvp)

[Blog](https://blog.gitee.com/)

[Nonprofit](/enterprises#nonprofit-plan)

[Gitee Go](https://gitee.com/features/gitee-go)

[OpenAPI](/api/v5/swagger)

[Help Center](https://help.gitee.com)

[Self-services](/self_services)

[Updates](/help/articles/4378)

[About Us](/about_us)

[Join us](https://www.oschina.net/news/131099/oschina-hiring)

[Terms of use](/terms)

[Feedback](/oschina/git-osc/issues)

[Partners](/links.html)

![Exchange](https://cn-assets.gitee.com/assets/contact_qr-5e2c2a8da453396590e56a545bce4974.jpg)

Exchange

![微信服务号](https://cn-assets.gitee.com/assets/qrcode-weixin@2x-b74cc97a2ea80123ea53a737f709836d.png)

WeChat

client#oschina.cn
Enterprise:400-606-0201

Pro：
13670252304

13352947997

![开放原子开源基金会](https://cn-assets.gitee.com/assets/logo-openatom-d083391cc8a54e283529f3fc11cc38ca.svg)
[OpenAtom Foundation](https://www.openatom.org/)
Cooperative code hosting platform

![违法和不良信息举报中心](https://cn-assets.gitee.com/assets/12377@2x-1aa42ed2d2256f82a61ecf57be1ec244.png)
[违法和不良信息举报中心](https://12377.cn)

[粤ICP备12009483号](http://beian.miit.gov.cn/)

[简 体](/language/zh-CN)
/
[繁 體](/language/zh-TW)
/
[English](/language/en)

Going to Help Center
### Search

[Git 命令在线学习](https://oschina.gitee.io/learn-git-branching/?utm_source==gitee-help-widget "Git 命令在线学习")[如何在 Gitee 导入 GitHub 仓库](https://gitee.com/help/articles/4261?utm_source==gitee-help-widget "如何在 Gitee 导入 GitHub 仓库")
[Git 仓库基础操作](/help/articles/4114)

[企业版和社区版功能对比](/help/articles/4166)

[SSH 公钥设置](/help/articles/4191)

[如何处理代码冲突](/help/articles/4194)

[仓库体积过大，如何减小？](/help/articles/4232)

[如何找回被删除的仓库数据](/help/articles/4279)

[Gitee 产品配额说明](/help/articles/4283)

[GitHub仓库快速导入Gitee及同步更新](/help/articles/4284)

[什么是 Release（发行版）](/help/articles/4328)

[将 PHP 项目自动发布到 packagist.org](/help/articles/4354)

Comment

Repository Report

Back to the top

Login prompt

This operation requires login to the code cloud account. Please log in before operating.

Go to login

No account. Register


