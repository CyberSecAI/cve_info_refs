=== Content from www.wordfence.com_d300cdb8_20250115_091059.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# wpDiscuz <= 7.6.3 - Insecure Direct Object Reference to Comment Rating Increase/Decrease

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   wpDiscuz <= 7.6.3 - Insecure Direct Object Reference to Comment Rating Increase/Decrease

5.3

**Authorization Bypass Through User-Controlled Key**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2023-3869](https://www.cve.org/CVERecord?id=CVE-2023-3869) |
| --- | --- |
| CVSS | 5.3 (Medium) |
| Publicly Published | September 12, 2023 |
| Last Updated | October 20, 2023 |
| Researcher | [RE-ALTER](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/vladislav-pokrovsky) |

### Description

The wpDiscuz plugin for WordPress is vulnerable to unauthorized modification of data due to a missing authorization check on the voteOnComment function in versions up to, and including, 7.6.3. This makes it possible for unauthenticated attackers to increase or decrease the rating of a comment.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wpdiscuz/trunk/utils/class.WpdiscuzHelperAjax.php#L681)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdiscuz%2Fwpdiscuz-763-insecure-direct-object-reference-to-comment-rating-increasedecrease&t=wpDiscuz%20%3C%3D%207.6.3%20-%20Insecure%20Direct%20Object%20Reference%20to%20Comment%20Rating%20Increase%2FDecrease "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdiscuz%2Fwpdiscuz-763-insecure-direct-object-reference-to-comment-rating-increasedecrease&text=wpDiscuz%20%3C%3D%207.6.3%20-%20Insecure%20Direct%20Object%20Reference%20to%20Comment%20Rating%20Increase%2FDecrease "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdiscuz%2Fwpdiscuz-763-insecure-direct-object-reference-to-comment-rating-increasedecrease "LinkedIn")
Email

## Vulnerability Details for Comments – wpDiscuz

#### [Comments – wpDiscuz](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wpdiscuz)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wpdiscuz [(view on wordpress.org)](https://wordpress.org/plugins/wpdiscuz) |
| Patched? | Yes |
| Remediation | Update to version 7.6.4, or a newer patched version |
| Affected Version | * <= 7.6.3 |
| Patched Version | * 7.6.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_d28a5398_20250115_091057.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwpdiscuz%2Ftrunk%2Futils%2Fclass.WpdiscuzHelperAjax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wpdiscuz/trunk/utils/class.WpdiscuzHelperAjax.php?rev=3140700 "Revision 3140700")
* Next Revision →
* [Blame](/browser/wpdiscuz/trunk/utils/class.WpdiscuzHelperAjax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wpdiscuz/trunk/utils/class.WpdiscuzHelperAjax.php)

---

# [source:](/browser?order=name "Go to repository root") [wpdiscuz](/browser/wpdiscuz?order=name "View wpdiscuz")/[trunk](/browser/wpdiscuz/trunk?order=name "View trunk")/[utils](/browser/wpdiscuz/trunk/utils?order=name "View utils")/[class.WpdiscuzHelperAjax.php](/browser/wpdiscuz/trunk/utils/class.WpdiscuzHelperAjax.php?order=name "View class.WpdiscuzHelperAjax.php")

View diff against:

View revision:

| [Last change](/changeset/3164486/wpdiscuz/trunk/utils/class.WpdiscuzHelperAjax.php "View differences") on this file was [3164486](/changeset/3164486/ "View changeset 3164486"), checked in by AdvancedCoding, [3 months ago](/timeline?from=2024-10-07T18%3A27%3A24Z&precision=second "See timeline at 10/07/2024 06:27:24 PM") |
| --- |
| Comments - wpDiscuz v7.6.25 - 07.10.2024  * Added: New function. isBanned() and checking if voter is banned or not * Added: New option to enable/disable rates editing * Added: New phrase for rate edit confirmation popup * Added: Rate edit functionality * Added: wpDiscuz icon on the backend and the admin bar menu items * Fixed: Vulnerability with [WordPress](/wiki/WordPress) social login |
| **File size:** 65.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (!defined("ABSPATH")) { |
| [3](#L3) | exit(); |
| [4](#L4) | } |
| [5](#L5) |  |
| [6](#L6) | class WpdiscuzHelperAjax implements WpDiscuzConstants |
| [7](#L7) | { |
| [8](#L8) |  |
| [9](#L9) | private $options; |
| [10](#L10) |  |
| [11](#L11) | /\*\* |
| [12](#L12) | \* @var WpdiscuzDBManager |
| [13](#L13) | \*/ |
| [14](#L14) | private $dbManager; |
| [15](#L15) | private $helper; |
| [16](#L16) | private $helperEmail; |
| [17](#L17) | /\*\* |
| [18](#L18) | \* @var $wpdiscuzForm wpDiscuzForm |
| [19](#L19) | \*/ |
| [20](#L20) | private $wpdiscuzForm; |
| [21](#L21) |  |
| [22](#L22) | public function \_\_construct($options, $dbManager, $helper, $helperEmail, $wpdiscuzForm) |
| [23](#L23) | { |
| [24](#L24) | $this->options = $options; |
| [25](#L25) | $this->dbManager = $dbManager; |
| [26](#L26) | $this->helper = $helper; |
| [27](#L27) | $this->helperEmail = $helperEmail; |
| [28](#L28) | $this->wpdiscuzForm = $wpdiscuzForm; |
| [29](#L29) | add\_action("wp\_ajax\_wpdStickComment", [&$this, "stickComment"]); |
| [30](#L30) | add\_action("wp\_ajax\_wpdCloseThread", [&$this, "closeThread"]); |
| [31](#L31) | add\_action("wp\_ajax\_wpdDeactivate", [&$this, "deactivate"]); |
| [32](#L32) | add\_action("wp\_ajax\_wpdImportSTCR", [&$this, "importSTCR"]); |
| [33](#L33) | add\_action("wp\_ajax\_wpdImportLSTC", [&$this, "importLSTC"]); |
| [34](#L34) |  |
| [35](#L35) | add\_action("wp\_ajax\_wpdFollowUser", [&$this, "followUser"]); |
| [36](#L36) | add\_action("wp\_ajax\_wpdRegenerateVoteMetas", [&$this, "regenerateVoteMetas"]); |
| [37](#L37) | add\_action("wp\_ajax\_wpdRegenerateClosedComments", [&$this, "regenerateClosedComments"]); |
| [38](#L38) | add\_action("wp\_ajax\_wpdRegenerateVoteData", [&$this, "regenerateVoteData"]); |
| [39](#L39) | add\_action("wp\_ajax\_wpdSyncCommenterData", [&$this, "syncCommenterData"]); |
| [40](#L40) | add\_action("wp\_ajax\_wpdRebuildRatings", [&$this, "rebuildRatings"]); |
| [41](#L41) | add\_action("wp\_ajax\_wpdFixTables", [&$this, "fixTables"]); |
| [42](#L42) | if ($this->options->login["showActivityTab"] || $this->options->login["showSubscriptionsTab"] || $this->options->login["showFollowsTab"]) { |
| [43](#L43) | add\_action("wp\_ajax\_wpdDeleteComment", [&$this, "deleteComment"]); |
| [44](#L44) | add\_action("wp\_ajax\_wpdCancelSubscription", [&$this, "deleteSubscription"]); |
| [45](#L45) | add\_action("wp\_ajax\_wpdCancelFollow", [&$this, "deleteFollow"]); |
| [46](#L46) | add\_action("wp\_ajax\_wpdEmailDeleteLinks", [&$this->helperEmail, "emailDeleteLinksAction"]); |
| [47](#L47) | add\_action("wp\_ajax\_nopriv\_wpdGuestAction", [&$this, "guestAction"]); |
| [48](#L48) | } |
| [49](#L49) | if ($this->options->content["commentReadMoreLimit"]) { |
| [50](#L50) | add\_action("wp\_ajax\_wpdReadMore", [&$this, "readMore"]); |
| [51](#L51) | add\_action("wp\_ajax\_nopriv\_wpdReadMore", [&$this, "readMore"]); |
| [52](#L52) | } |
| [53](#L53) | add\_action("wp\_ajax\_wpdRedirect", [&$this, "redirect"]); |
| [54](#L54) | add\_action("wp\_ajax\_nopriv\_wpdRedirect", [&$this, "redirect"]); |
| [55](#L55) | if ($this->options->thread\_layouts["showVotingButtons"]) { |
| [56](#L56) | add\_action("wp\_ajax\_wpdVoteOnComment", [&$this, "voteOnComment"]); |
| [57](#L57) | add\_action("wp\_ajax\_nopriv\_wpdVoteOnComment", [&$this, "voteOnComment"]); |
| [58](#L58) | } |
| [59](#L59) | add\_action("wp\_ajax\_wpdGetInlineCommentForm", [&$this, "getInlineCommentForm"]); |
| [60](#L60) | add\_action("wp\_ajax\_nopriv\_wpdGetInlineCommentForm", [&$this, "getInlineCommentForm"]); |
| [61](#L61) | add\_action("wp\_ajax\_wpdGetLastInlineComments", [&$this, "getLastInlineComments"]); |
| [62](#L62) | add\_action("wp\_ajax\_nopriv\_wpdGetLastInlineComments", [&$this, "getLastInlineComments"]); |
| [63](#L63) | add\_action("wp\_ajax\_wpdEditComment", [&$this, "editComment"]); |
| [64](#L64) | add\_action("wp\_ajax\_nopriv\_wpdEditComment", [&$this, "editComment"]); |
| [65](#L65) | add\_action("wp\_ajax\_wpdUserRate", [&$this, "userRate"]); |
| [66](#L66) | add\_action("wp\_ajax\_nopriv\_wpdUserRate", [&$this, "userRate"]); |
| [67](#L67) | add\_action("wp\_ajax\_wpdUnsubscribe", [&$this, "unsubscribe"]); |
| [68](#L68) | add\_action("wp\_ajax\_nopriv\_wpdUnsubscribe", [&$this, "unsubscribe"]); |
| [69](#L69) | add\_action("wp\_ajax\_wpd\_stat\_brief", [&$this, "wpd\_stat\_brief"]); |
| [70](#L70) | add\_action("wp\_ajax\_wpd\_stat\_subs", [&$this, "wpd\_stat\_subs"]); |
| [71](#L71) | add\_action("wp\_ajax\_wpd\_stat\_graph", [&$this, "wpd\_stat\_graph"]); |
| [72](#L72) | add\_action("wp\_ajax\_wpd\_stat\_user", [&$this, "wpd\_stat\_user"]); |
| [73](#L73) | add\_action("wp\_ajax\_searchOption", [&$this, "searchOption"]); |
| [74](#L74) | add\_action("wp\_ajax\_wpdResetPostRating", [&$this, "resetPostRating"]); |
| [75](#L75) | add\_action("wp\_ajax\_wpdResetFieldsRatings", [&$this, "resetFieldsRatings"]); |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | public function stickComment() |
| [79](#L79) | { |
| [80](#L80) | $this->helper->validateNonce(); |
| [81](#L81) | $postId = WpdiscuzHelper::sanitize(INPUT\_POST, "postId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [82](#L82) | $commentId = WpdiscuzHelper::sanitize(INPUT\_POST, "commentId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [83](#L83) | if ($postId && $commentId) { |
| [84](#L84) | $comment = get\_comment($commentId); |
| [85](#L85) | $userCanStickComment = current\_user\_can("moderate\_comments"); |
| [86](#L86) | if (!$userCanStickComment) { |
| [87](#L87) | $post = get\_post($postId); |
| [88](#L88) | $currentUser = WpdiscuzHelper::getCurrentUser(); |
| [89](#L89) | $userCanStickComment = $post && isset($post->post\_author) && $currentUser && isset($currentUser->ID) && $post->post\_author == $currentUser->ID; |
| [90](#L90) | } |
| [91](#L91) | if ($userCanStickComment && $comment && isset($comment->comment\_ID) && $comment->comment\_ID && !$comment->comment\_parent) { |
| [92](#L92) | $commentarr = ["comment\_ID" => $commentId]; |
| [93](#L93) | if ($comment->comment\_type === self::WPDISCUZ\_STICKY\_COMMENT) { |
| [94](#L94) | $commentarr["comment\_type"] = WpdiscuzCore::$DEFAULT\_COMMENT\_TYPE; |
| [95](#L95) | $response = esc\_html($this->options->getPhrase("wc\_stick\_comment", ["comment" => $comment])); |
| [96](#L96) | } else { |
| [97](#L97) | $commentarr["comment\_type"] = self::WPDISCUZ\_STICKY\_COMMENT; |
| [98](#L98) | $response = esc\_html($this->options->getPhrase("wc\_unstick\_comment", ["comment" => $comment])); |
| [99](#L99) | } |
| [100](#L100) | $commentarr["wpdiscuz\_comment\_update"] = true; |
| [101](#L101) | if (wp\_update\_comment(wp\_slash($commentarr))) { |
| [102](#L102) | do\_action("wpdiscuz\_reset\_comments\_cache", $comment->comment\_post\_ID); |
| [103](#L103) | wp\_send\_json\_success($response); |
| [104](#L104) | } |
| [105](#L105) | } |
| [106](#L106) | } |
| [107](#L107) | } |
| [108](#L108) |  |
| [109](#L109) | public function closeThread() |
| [110](#L110) | { |
| [111](#L111) | $this->helper->validateNonce(); |
| [112](#L112) | $postId = WpdiscuzHelper::sanitize(INPUT\_POST, "postId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [113](#L113) | $commentId = WpdiscuzHelper::sanitize(INPUT\_POST, "commentId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [114](#L114) | if ($postId && $commentId) { |
| [115](#L115) | $comment = get\_comment($commentId); |
| [116](#L116) | $userCanCloseComment = current\_user\_can("moderate\_comments"); |
| [117](#L117) | if (!$userCanCloseComment) { |
| [118](#L118) | $post = get\_post($postId); |
| [119](#L119) | $currentUser = WpdiscuzHelper::getCurrentUser(); |
| [120](#L120) | $userCanCloseComment = !empty($post->post\_author) && !empty($currentUser->ID) && $post->post\_author == $currentUser->ID; |
| [121](#L121) | } |
| [122](#L122) | if ($userCanCloseComment && !empty($comment->comment\_ID) && !$comment->comment\_parent) { |
| [123](#L123) | $children = $comment->get\_children([ |
| [124](#L124) | "format" => "flat", |
| [125](#L125) | "status" => "all", |
| [126](#L126) | "post\_id" => $postId, |
| [127](#L127) | ]); |
| [128](#L128) | $response = []; |
| [129](#L129) | $isClosed = intval(get\_comment\_meta($comment->comment\_ID, self::META\_KEY\_CLOSED, true)); |
| [130](#L130) | if ($isClosed) { |
| [131](#L131) | $response["data"] = esc\_html($this->options->getPhrase("wc\_close\_comment", ["comment" => $comment])); |
| [132](#L132) | $response["icon"] = esc\_attr("fa-unlock"); |
| [133](#L133) | } else { |
| [134](#L134) | $response["data"] = esc\_html($this->options->getPhrase("wc\_open\_comment", ["comment" => $comment])); |
| [135](#L135) | $response["icon"] = esc\_attr("fa-lock"); |
| [136](#L136) | } |
| [137](#L137) | update\_comment\_meta($comment->comment\_ID, self::META\_KEY\_CLOSED, intval(!$isClosed)); |
| [138](#L138) | if ($children && is\_array($children)) { |
| [139](#L139) | foreach ($children as $k => $child) { |
| [140](#L140) | update\_comment\_meta($child->comment\_ID, self::META\_KEY\_CLOSED, intval(!$isClosed)); |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) | do\_action("wpdiscuz\_reset\_comments\_cache", $comment->comment\_post\_ID); |
| [144](#L144) | wp\_send\_json\_success($response); |
| [145](#L145) | } |
| [146](#L146) | } |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | public function deactivate() |
| [150](#L150) | { |
| [151](#L151) | $response = ["code" => 0]; |
| [152](#L152) | $json = filter\_input(INPUT\_POST, "deactivateData"); |
| [153](#L153) | if ($json) { |
| [154](#L154) | parse\_str($json, $data); |
| [155](#L155) | if (isset($data["never\_show"]) && ($v = intval($data["never\_show"]))) { |
| [156](#L156) | update\_option(self::OPTION\_SLUG\_DEACTIVATION, $v); |
| [157](#L157) | $response["code"] = "dismiss\_and\_deactivate"; |
| [158](#L158) | } else if (isset($data["deactivation\_reason"]) && ($reason = trim($data["deactivation\_reason"]))) { |
| [159](#L159) | if ($reason !== "I'll reactivate it later") { |
| [160](#L160) | $pluginData = get\_plugin\_data(WPDISCUZ\_DIR\_PATH . "/class.WpdiscuzCore.php"); |
| [161](#L161) | $blogTitle = get\_option("blogname"); |
| [162](#L162) | $to = "feedback@wpdiscuz.com"; |
| [163](#L163) | $subject = "[wpDiscuz Feedback - " . $pluginData["Version"] . "] - " . $reason; |
| [164](#L164) | $headers = []; |
| [165](#L165) | $contentType = "text/html"; |
| [166](#L166) | $fromName = html\_entity\_decode($blogTitle, ENT\_QUOTES); |
| [167](#L167) | $siteUrl = get\_site\_url(); |
| [168](#L168) | $parsedUrl = parse\_url($siteUrl); |
| [169](#L169) | $domain = isset($parsedUrl["host"]) ? WpdiscuzHelper::fixEmailFrom($parsedUrl["host"]) : ""; |
| [170](#L170) | $fromEmail = "no-reply@" . $domain; |
| [171](#L171) | $headers[] = "Content-Type:  $contentType; charset=UTF-8"; |
| [172](#L172) | $headers[] = "From: " . $fromName . " <" . $fromEmail . "> \r\n"; |
| [173](#L173) | $message = "<strong>Deactivation subject:</strong> " . $reason . "\r\n" . "<br/>"; |
| [174](#L174) | if (isset($data["deactivation\_reason\_desc"]) && ($reasonDesc = trim($data["deactivation\_reason\_desc"]))) { |
| [175](#L175) | $message .= "<strong>Deactivation reason:</strong> " . $reasonDesc . "\r\n" . "<br/>"; |
| [176](#L176) | } |
| [177](#L177) | if (isset($data["deactivation\_feedback\_email"]) && ($feedback\_email = trim($data["deactivation\_feedback\_email"]))) { |
| [178](#L178) | if (filter\_var($feedback\_email, FILTER\_VALIDATE\_EMAIL) === false) { |
| [179](#L179) | $response["code"] = "send\_and\_deactivate"; |
| [180](#L180) | wp\_die(json\_encode($response)); |
| [181](#L181) | } |
| [182](#L182) | $to = "support@wpdiscuz.com"; |
| [183](#L183) | $message .= "<strong>Feedback Email:</strong> " . $feedback\_email . "\r\n" . "<br/>"; |
| [184](#L184) | } |
| [185](#L185) | $subject = html\_entity\_decode($subject, ENT\_QUOTES); |
| [186](#L186) | $message = html\_entity\_decode($message, ENT\_QUOTES); |
| [187](#L187) | $sent = wp\_mail($to, $subject, do\_shortcode($message), $headers); |
| [188](#L188) | } |
| [189](#L189) | $response["code"] = "send\_and\_deactivate"; |
| [190](#L190) | } |
| [191](#L191) | } |
| [192](#L192) | wp\_die(json\_encode($response)); |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | /\*\* |
| [196](#L196) | \* Import subscriptions from "Subscribe To Comments Reloaded" plugin |
| [197](#L197) | \*/ |
| [198](#L198) | public function importSTCR() |
| [199](#L199) | { |
| [200](#L200) | $this->helper->validateNonce(); |
| [201](#L201) | $response = ["progress" => 0]; |
| [202](#L202) | $stcrData = isset($\_POST["stcrData"]) ? sanitize\_textarea\_field($\_POST["stcrData"]) : ""; |
| [203](#L203) | if ($stcrData) { |
| [204](#L204) | parse\_str($stcrData, $data); |
| [205](#L205) | $limit = 50; |
| [206](#L206) | $step = isset($data["stcr-step"]) ? intval($data["stcr-step"]) : 0; |
| [207](#L207) | $stcrSubscriptionsCount = isset($data["stcr-subscriptions-count"]) ? intval($data["stcr-subscriptions-count"]) : 0; |
| [208](#L208) | $nonce = isset($data["wpd-stcr-subscriptions"]) ? trim($data["wpd-stcr-subscriptions"]) : ""; |
| [209](#L209) | if (wp\_verify\_nonce($nonce, "wc\_tools\_form") && $stcrSubscriptionsCount) { |
| [210](#L210) | $offset = $limit \* $step; |
| [211](#L211) | if ($limit && $offset >= 0) { |
| [212](#L212) | $subscriptions = $this->dbManager->getStcrSubscriptions($limit, $offset); |
| [213](#L213) | if ($subscriptions) { |
| [214](#L214) | $this->dbManager->addStcrSubscriptions($subscriptions); |
| [215](#L215) | ++$step; |
| [216](#L216) | $response["step"] = $step; |
| [217](#L217) | $progress = $offset ? $offset \* 100 / $stcrSubscriptionsCount : $limit \* 100 / $stcrSubscriptionsCount; |
| [218](#L218) | $response["progress"] = ($prg = intval($progress)) > 100 ? 100 : $prg; |
| [219](#L219) | } else { |
| [220](#L220) | $response["progress"] = 100; |
| [221](#L221) | } |
| [222](#L222) | } |
| [223](#L223) | } |
| [224](#L224) | } |
| [225](#L225) | wp\_die(json\_encode($response)); |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | /\*\* |
| [229](#L229) | \* Import subscriptions from "Lightweight Subscribe To Comments" plugin |
| [230](#L230) | \*/ |
| [231](#L231) | public function importLSTC() |
| [232](#L232) | { |
| [233](#L233) | $this->helper->validateNonce(); |
| [234](#L234) | $response = ["progress" => 0]; |
| [235](#L235) | $lstcData = isset($\_POST["lstcData"]) ? sanitize\_textarea\_field($\_POST["lstcData"]) : ""; |
| [236](#L236) | if ($lstcData) { |
| [237](#L237) | parse\_str($lstcData, $data); |
| [238](#L238) | $limit = 50; |
| [239](#L239) | $step = isset($data["lstc-step"]) ? intval($data["lstc-step"]) : 0; |
| [240](#L240) | $lstcSubscriptionsCount = isset($data["lstc-subscriptions-count"]) ? intval($data["lstc-subscriptions-count"]) : 0; |
| [241](#L241) | $nonce = isset($data["wpd-lstc-subscriptions"]) ? trim($data["wpd-lstc-subscriptions"]) : ""; |
| [242](#L242) | if (wp\_verify\_nonce($nonce, "wc\_tools\_form") && $lstcSubscriptionsCount) { |
| [243](#L243) | $offset = $limit \* $step; |
| [244](#L244) | if ($limit && $offset >= 0) { |
| [245](#L245) | $subscriptions = $this->dbManager->getLstcSubscriptions($limit, $offset); |
| [246](#L246) | if ($subscriptions) { |
| [247](#L247) | $this->dbManager->addLstcSubscriptions($subscriptions); |
| [248](#L248) | ++$step; |
| [249](#L249) | $response["step"] = $step; |
| [250](#L250) | $progress = $offset ? $offset \* 100 / $lstcSubscriptionsCount : $limit \* 100 / $lstcSubscriptionsCount; |
| [251](#L251) | $response["progress"] = ($prg = intval($progress)) > 100 ? 100 : $prg; |
| [252](#L252) | } else { |
| [253](#L253) | $response["progress"] = 100; |
| [254](#L254) | } |
| [255](#L255) | } |
| [256](#L256) | } |
| [257](#L257) | } |
| [258](#L258) | wp\_die(json\_encode($response)); |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | public function deleteComment() |
| [262](#L262) | { |
| [263](#L263) | $this->helper->validateNonce(); |
| [264](#L264) | $commentId = WpdiscuzHelper::sanitize(INPUT\_POST, "id", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [265](#L265) | $currentUser = WpdiscuzHelper::getCurrentUser(); |
| [266](#L266) | if ($commentId && !empty($currentUser->ID) && $this->options->login["showActivityTab"] && ($comment = get\_comment($commentId)) && intval($currentUser->ID) === intval($comment->user\_id)) { |
| [267](#L267) | wp\_delete\_comment($commentId, true); |
| [268](#L268) | $this->helper->getActivityPage(); |
| [269](#L269) | } |
| [270](#L270) | } |
| [271](#L271) |  |
| [272](#L272) | public function deleteSubscription() |
| [273](#L273) | { |
| [274](#L274) | $this->helper->validateNonce(); |
| [275](#L275) | $subscriptionId = WpdiscuzHelper::sanitize(INPUT\_POST, "id", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [276](#L276) | $currentUser = WpdiscuzHelper::getCurrentUser(); |
| [277](#L277) | if ($subscriptionId && !empty($currentUser->ID) && $this->options->login["showSubscriptionsTab"] && ($subscription = $this->dbManager->getSubscriptionById($subscriptionId)) && $currentUser->user\_email === $subscription->email) { |
| [278](#L278) | $this->dbManager->unsubscribeById($subscriptionId); |
| [279](#L279) | $this->helper->getSubscriptionsPage(); |
| [280](#L280) | } |
| [281](#L281) | } |
| [282](#L282) |  |
| [283](#L283) | public function deleteFollow() |
| [284](#L284) | { |
| [285](#L285) | $this->helper->validateNonce(); |
| [286](#L286) | $followId = WpdiscuzHelper::sanitize(INPUT\_POST, "id", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [287](#L287) | $currentUser = WpdiscuzHelper::getCurrentUser(); |
| [288](#L288) | if ($followId && !empty($currentUser->ID) && $this->options->login["showFollowsTab"] && ($follow = $this->dbManager->getFollowById($followId)) && $currentUser->ID === intval($follow->follower\_id)) { |
| [289](#L289) | $this->dbManager->unfollowById($followId); |
| [290](#L290) | do\_action("wpdiscuz\_follow\_cancelled", (array)$follow); |
| [291](#L291) | $this->helper->getFollowsPage(); |
| [292](#L292) | } |
| [293](#L293) | } |
| [294](#L294) |  |
| [295](#L295) | public function guestAction() |
| [296](#L296) | { |
| [297](#L297) | $this->helper->validateNonce(); |
| [298](#L298) | $guestEmail = isset($\_COOKIE["comment\_author\_email\_" . COOKIEHASH]) ? $\_COOKIE["comment\_author\_email\_" . COOKIEHASH] : ""; |
| [299](#L299) | $guestAction = WpdiscuzHelper::sanitize(INPUT\_POST, "guestAction", "FILTER\_SANITIZE\_STRING"); |
| [300](#L300) | $postId = WpdiscuzHelper::sanitize(INPUT\_POST, "postId", FILTER\_SANITIZE\_NUMBER\_INT); |
| [301](#L301) | $post = get\_post($postId); |
| [302](#L302) | $response = [ |
| [303](#L303) | "code" => 0, |
| [304](#L304) | "message" => "<div class='wpd-guest-action-message wpd-guest-action-error'>" . esc\_html($this->options->getPhrase("wc\_user\_settings\_email\_error")) . "</div>" |
| [305](#L305) | ]; |
| [306](#L306) | if ($post && $guestEmail) { |
| [307](#L307) | $hashValue = $this->helperEmail->generateUserActionHash($guestEmail); |
| [308](#L308) | $mainUrl = site\_url("/wpdiscuzsubscription/"); |
| [309](#L309) | $link = ""; |
| [310](#L310) | $message = ""; |
| [311](#L311) | $siteUrl = get\_site\_url(); |
| [312](#L312) | $blogTitle = html\_entity\_decode(get\_option("blogname"), ENT\_QUOTES); |
| [313](#L313) | if ($guestAction === "deletecomments") { |
| [314](#L314) | $link = $mainUrl . "deletecomments/?key=$hashValue"; |
| [315](#L315) | $subject = $this->options->getPhrase("wc\_user\_settings\_delete\_all\_comments"); |
| [316](#L316) | $message = $this->options->getPhrase("wc\_user\_settings\_delete\_all\_comments\_message"); |
| [317](#L317) | if (strpos($message, "[DELETE\_COMMENTS\_URL]") !== false) { |
| [318](#L318) | $message = str\_replace("[DELETE\_COMMENTS\_URL]", $link, $message); |
| [319](#L319) | } |
| [320](#L320) | } elseif ($guestAction === "deleteSubscriptions") { |
| [321](#L321) | $subject = $this->options->getPhrase("wc\_user\_settings\_delete\_all\_subscriptions"); |
| [322](#L322) | $link = $mainUrl . "/deleteSubscriptions/?key=$hashValue"; |
| [323](#L323) | $message = $this->options->getPhrase("wc\_user\_settings\_delete\_all\_subscriptions\_message"); |
| [324](#L324) | if (strpos($message, "[DELETE\_SUBSCRIPTIONS\_URL]") !== false) { |
| [325](#L325) | $message = str\_replace("[DELETE\_SUBSCRIPTIONS\_URL]", $link, $message); |
| [326](#L326) | } |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | $subject = str\_replace(["[SITE\_URL]", "[BLOG\_TITLE]"], [$siteUrl, $blogTitle], $subject); |
| [330](#L330) | $message = str\_replace(["[SITE\_URL]", "[BLOG\_TITLE]"], [$siteUrl, $blogTitle], $message); |
| [331](#L331) |  |
| [332](#L332) | if ($this->helperEmail->userActionMail($guestEmail, $subject, $message)) { |
| [333](#L333) | $response["code"] = 1; |
| [334](#L334) | $parts = explode("@", $guestEmail); |
| [335](#L335) | $guestEmail = substr($parts[0], 0, min(1, strlen($parts[0]) - 1)) . str\_repeat("\*", max(1, strlen($parts[0]) - 1)) . "@" . $parts[1]; |
| [336](#L336) | $response["message"] = "<div class='wpd-guest-action-message wpd-guest-action-success'>" . esc\_html($this->options->getPhrase("wc\_user\_settings\_check\_email")) . " ($guestEmail)" . "</div>"; |
| [337](#L337) | } |
| [338](#L338) | } |
| [339](#L339) | wp\_die(json\_encode($response)); |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | public function followUser() |
| [343](#L343) | { |
| [344](#L344) | $this->helper->validateNonce(); |
| [345](#L345) | $postId = WpdiscuzHelper::sanitize(INPUT\_POST, "postId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [346](#L346) | $commentId = WpdiscuzHelper::sanitize(INPUT\_POST, "commentId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [347](#L347) | if ($postId && $commentId) { |
| [348](#L348) | $comment = get\_comment($commentId); |
| [349](#L349) | if ($comment && $comment->comment\_author\_email) { |
| [350](#L350) | $currentUser = WpdiscuzHelper::getCurrentUser(); |
| [351](#L351) | if ($currentUser && $currentUser->ID) { |
| [352](#L352) | $args = [ |
| [353](#L353) | "post\_id" => $comment->comment\_post\_ID, |
| [354](#L354) | "user\_id" => $comment->user\_id, |
| [355](#L355) | "user\_email" => $comment->comment\_author\_email, |
| [356](#L356) | "user\_name" => $comment->comment\_author, |
| [357](#L357) | "follower\_id" => $currentUser->ID, |
| [358](#L358) | "follower\_email" => $currentUser->user\_email, |
| [359](#L359) | "follower\_name" => $currentUser->display\_name, |
| [360](#L360) | "confirm" => $this->options->subscription["disableFollowConfirmForUsers"], |
| [361](#L361) | ]; |
| [362](#L362) | $followExists = $this->dbManager->isFollowExists($comment->comment\_author\_email, $currentUser->user\_email); |
| [363](#L363) | if ($followExists) { |
| [364](#L364) | $response = []; |
| [365](#L365) | if (intval($followExists["confirm"])) { // confirmed follow already exists |
| [366](#L366) | $response["code"] = "wc\_follow\_canceled"; |
| [367](#L367) | $this->dbManager->cancelFollow($followExists["id"], $followExists["activation\_key"]); |
| [368](#L368) | $response["followTip"] = esc\_attr($this->options->getPhrase("wc\_follow\_user", ["comment" => $comment])); |
| [369](#L369) | do\_action("wpdiscuz\_follow\_cancelled", $args); |
| [370](#L370) | } else { // follow exists but not confirmed yet, send confirm email again if neccessary |
| [371](#L371) | if ($this->options->subscription["disableFollowConfirmForUsers"]) { |
| [372](#L372) | $this->dbManager->confirmFollow($followExists["id"], $followExists["activation\_key"]); |
| [373](#L373) | $response["code"] = "wc\_follow\_success"; |
| [374](#L374) | $response["followClass"] = "wpd-follow-active"; |
| [375](#L375) | $response["followTip"] = esc\_attr($this->options->getPhrase("wc\_unfollow\_user", ["comment" => $comment])); |
| [376](#L376) | do\_action("wpdiscuz\_follow\_added", $args); |
| [377](#L377) | } else { |
| [378](#L378) | $this->followConfirmAction($comment->comment\_post\_ID, $followExists["id"], $followExists["activation\_key"], $args["follower\_email"]); |
| [379](#L379) | } |
| [380](#L380) | } |
| [381](#L381) | wp\_send\_json\_success($response); |
| [382](#L382) | } else { |
| [383](#L383) | $followData = $this->dbManager->addNewFollow($args); |
| [384](#L384) | if ($followData) { |
| [385](#L385) | if ($this->options->subscription["disableFollowConfirmForUsers"]) { |
| [386](#L386) | $response = []; |
| [387](#L387) | $response["code"] = "wc\_follow\_success"; |
| [388](#L388) | $response["followClass"] = "wpd-follow-active"; |
| [389](#L389) | $response["followTip"] = esc\_attr($this->options->getPhrase("wc\_unfollow\_user", ["comment" => $comment])); |
| [390](#L390) | do\_action("wpdiscuz\_follow\_added", $args); |
| [391](#L391) | $response["callbackFunctions"] = []; |
| [392](#L392) | $response = apply\_filters("wpdiscuz\_ajax\_callbacks", $response, $action = "wpdFollowUser"); |
| [393](#L393) | wp\_send\_json\_success($response); |
| [394](#L394) | } else { |
| [395](#L395) | $this->followConfirmAction($comment->comment\_post\_ID, $followData["id"], $followData["activation\_key"], $args["follower\_email"]); |
| [396](#L396) | } |
| [397](#L397) | } else { |
| [398](#L398) | wp\_send\_json\_error("wc\_follow\_not\_added"); |
| [399](#L399) | } |
| [400](#L400) | } |
| [401](#L401) | } else { |
| [402](#L402) | wp\_send\_json\_error("wc\_follow\_login\_to\_follow"); |
| [403](#L403) | } |
| [404](#L404) | } else { |
| [405](#L405) | wp\_send\_json\_error("wc\_follow\_impossible"); |
| [406](#L406) | } |
| [407](#L407) | } |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | private function followConfirmAction($postId, $id, $key, $email) |
| [411](#L411) | { |
| [412](#L412) | $send = $this->helperEmail->followConfirmEmail($postId, $id, $key, $email); |
| [413](#L413) | if ($send) { |
| [414](#L414) | wp\_send\_json\_success(["code" => "wc\_follow\_email\_confirm"]); |
| [415](#L415) | } else { |
| [416](#L416) | $this->dbManager->cancelFollow($id, $key); |
| [417](#L417) | wp\_send\_json\_error("wc\_follow\_email\_confirm\_fail"); |
| [418](#L418) | } |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | public function regenerateVoteMetas() |
| [422](#L422) | { |
| [423](#L423) | $this->helper->validateNonce(); |
| [424](#L424) | $response = ["progress" => 0]; |
| [425](#L425) | $voteRegenerateData = isset($\_POST["voteRegenerateData"]) ? $\_POST["voteRegenerateData"] : ""; |
| [426](#L426) | if ($voteRegenerateData) { |
| [427](#L427) | parse\_str($voteRegenerateData, $data); |
| [428](#L428) | $limit = !empty($data["vote-regenerate-limit"]) ? intval($data["vote-regenerate-limit"]) : 500; |
| [429](#L429) | $step = !empty($data["vote-regenerate-step"]) ? intval($data["vote-regenerate-step"]) : 0; |
| [430](#L430) | $voteRegenerateCount = !empty($data["vote-regenerate-count"]) ? intval($data["vote-regenerate-count"]) : 0; |
| [431](#L431) | $voteRegenerateStartId = !empty($data["vote-regenerate-start-id"]) ? intval($data["vote-regenerate-start-id"]) : 0; |
| [432](#L432) | $nonce = !empty($data["wpd-vote-regenerate"]) ? trim($data["wpd-vote-regenerate"]) : ""; |
| [433](#L433) | if (wp\_verify\_nonce($nonce, "wc\_tools\_form") && $voteRegenerateCount && $voteRegenerateStartId >= 0 && $limit) { |
| [434](#L434) | $voteRegenerateVoteData = $this->dbManager->getVoteRegenerateData($voteRegenerateStartId, $limit); |
| [435](#L435) | if ($voteRegenerateVoteData) { |
| [436](#L436) | $this->dbManager->regenerateVoteMetas($voteRegenerateVoteData); |
| [437](#L437) | ++$step; |
| [438](#L438) | $progress = $step \* $limit \* 100 / $voteRegenerateCount; |
| [439](#L439) | $response["progress"] = ($p = intval($progress)) > 100 ? 100 : $p; |
| [440](#L440) | $response["startId"] = $voteRegenerateVoteData[count($voteRegenerateVoteData) - 1]; |
| [441](#L441) | if ($response["progress"] == 100) { |
| [442](#L442) | update\_option(self::OPTION\_SLUG\_SHOW\_VOTE\_REG\_MESSAGE, "0"); |
| [443](#L443) | } |
| [444](#L444) | } else { |
| [445](#L445) | $response["progress"] = 100; |
| [446](#L446) | $response["startId"] = 0; |
| [447](#L447) | update\_option(self::OPTION\_SLUG\_SHOW\_VOTE\_REG\_MESSAGE, "0"); |
| [448](#L448) | } |
| [449](#L449) | $response["step"] = $step; |
| [450](#L450) | } |
| [451](#L451) | } |
| [452](#L452) | wp\_die(json\_encode($response)); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | public function regenerateClosedComments() |
| [456](#L456) | { |
| [457](#L457) | $this->helper->validateNonce(); |
| [458](#L458) | $response = ["progress" => 0]; |
| [459](#L459) | $closedRegenerateData = isset($\_POST["closedRegenerateData"]) ? sanitize\_textarea\_field($\_POST["closedRegenerateData"]) : ""; |
| [460](#L460) | if ($closedRegenerateData) { |
| [461](#L461) | parse\_str($closedRegenerateData, $data); |
| [462](#L462) | $limit = !empty($data["closed-regenerate-limit"]) ? intval($data["closed-regenerate-limit"]) : 500; |
| [463](#L463) | $step = isset($data["closed-regenerate-step"]) ? intval($data["closed-regenerate-step"]) : 0; |
| [464](#L464) | $closedRegenerateCount = isset($data["closed-regenerate-count"]) ? intval($data["closed-regenerate-count"]) : 0; |
| [465](#L465) | $closedRegenerateStartId = isset($data["closed-regenerate-start-id"]) ? intval($data["closed-regenerate-start-id"]) : 0; |
| [466](#L466) | $nonce = isset($data["wpd-closed-regenerate"]) ? trim($data["wpd-closed-regenerate"]) : ""; |
| [467](#L467) | if (wp\_verify\_nonce($nonce, "wc\_tools\_form") && $closedRegenerateCount && $closedRegenerateStartId >= 0 && $limit) { |
| [468](#L468) | $closedRegenerateClosedData = $this->dbManager->getClosedRegenerateData($closedRegenerateStartId, $limit); |
| [469](#L469) | if ($closedRegenerateClosedData) { |
| [470](#L470) | $this->dbManager->regenerateClosedComments($closedRegenerateClosedData); |
| [471](#L471) | ++$step; |
| [472](#L472) | $progress = $step \* $limit \* 100 / $closedRegenerateCount; |
| [473](#L473) | $response["progress"] = ($p = intval($progress)) > 100 ? 100 : $p; |
| [474](#L474) | $response["startId"] = $closedRegenerateClosedData[count($closedRegenerateClosedData) - 1]; |
| [475](#L475) | if ($response["progress"] == 100) { |
| [476](#L476) | update\_option(self::OPTION\_SLUG\_SHOW\_CLOSED\_REG\_MESSAGE, "0"); |
| [477](#L477) | } |
| [478](#L478) | } else { |
| [479](#L479) | $response["progress"] = 100; |
| [480](#L480) | $response["startId"] = 0; |
| [481](#L481) | update\_option(self::OPTION\_SLUG\_SHOW\_CLOSED\_REG\_MESSAGE, "0"); |
| [482](#L482) | } |
| [483](#L483) | $response["step"] = $step; |
| [484](#L484) | } |
| [485](#L485) | } |
| [486](#L486) | wp\_die(json\_encode($response)); |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | public function regenerateVoteData() |
| [490](#L490) | { |
| [491](#L491) | $response = ["progress" => 0]; |
| [492](#L492) | $regenerateVoteData = isset($\_POST["regenerateVoteData"]) ? sanitize\_textarea\_field($\_POST["regenerateVoteData"]) : ""; |
| [493](#L493) | if ($regenerateVoteData) { |
| [494](#L494) | parse\_str($regenerateVoteData, $data); |
| [495](#L495) | $limit = !empty($data["regenerate-vote-data-limit"]) ? intval($data["regenerate-vote-data-limit"]) : 500; |
| [496](#L496) | $step = isset($data["regenerate-vote-data-step"]) ? intval($data["regenerate-vote-data-step"]) : 0; |
| [497](#L497) | $regenerateVoteDataCount = isset($data["regenerate-vote-data-count"]) ? intval($data["regenerate-vote-data-count"]) : 0; |
| [498](#L498) | $regenerateVoteDataStartId = isset($data["regenerate-vote-data-start-id"]) ? intval($data["regenerate-vote-data-start-id"]) : 0; |
| [499](#L499) | $nonce = isset($data["wpd-regenerate-vote-data"]) ? trim($data["wpd-regenerate-vote-data"]) : ""; |
| [500](#L500) | if (wp\_verify\_nonce($nonce, "wc\_tools\_form") && $regenerateVoteDataCount && $regenerateVoteDataStartId >= 0 && $limit) { |
| [501](#L501) | $voteDataRegenerateData = $this->dbManager->getVoteDataRegenerateData($regenerateVoteDataStartId, $limit); |
| [502](#L502) | if ($voteDataRegenerateData) { |
| [503](#L503) | $this->dbManager->regenerateVoteData($voteDataRegenerateData); |
| [504](#L504) | ++$step; |
| [505](#L505) | $progress = $step \* $limit \* 100 / $regenerateVoteDataCount; |
| [506](#L506) | $response["progress"] = ($p = intval($progress)) > 100 ? 100 : $p; |
| [507](#L507) | $response["startId"] = $voteDataRegenerateData[count($voteDataRegenerateData) - 1]; |
| [508](#L508) | if ($response["progress"] == 100) { |
| [509](#L509) | update\_option(self::OPTION\_SLUG\_SHOW\_VOTE\_DATA\_REG\_MESSAGE, "0"); |
| [510](#L510) | } |
| [511](#L511) | } else { |
| [512](#L512) | $response["progress"] = 100; |
| [513](#L513) | $response["startId"] = 0; |
| [514](#L514) | update\_option(self::OPTION\_SLUG\_SHOW\_VOTE\_DATA\_REG\_MESSAGE, "0"); |
| [515](#L515) | } |
| [516](#L516) | $response["step"] = $step; |
| [517](#L517) | } |
| [518](#L518) | } |
| [519](#L519) | wp\_die(json\_encode($response)); |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) | public function syncCommenterData() |
| [523](#L523) | { |
| [524](#L524) | $this->helper->validateNonce(); |
| [525](#L525) | $syncCommenterData = !empty($\_POST["syncCommenterData"]) ? sanitize\_textarea\_field($\_POST["syncCommenterData"]) : ""; |
| [526](#L526) | if ($syncCommenterData) { |
| [527](#L527) | parse\_str($syncCommenterData, $data); |
| [528](#L528) | $nonce = !empty($data["wpd-sync-commenters"]) ? trim($data["wpd-sync-commenters"]) : ""; |
| [529](#L529) | if (wp\_verify\_nonce($nonce, "wc\_tools\_form")) { |
| [530](#L530) | $this->dbManager->updateCommentersData(); |
| [531](#L531) | update\_option(self::OPTION\_SLUG\_SHOW\_SYNC\_COMMENTERS\_MESSAGE, "0"); |
| [532](#L532) | wp\_send\_json\_success(); |
| [533](#L533) | } |
| [534](#L534) | } |
| [535](#L535) | wp\_send\_json\_error(); |
| [536](#L536) | } |
| [537](#L537) |  |
| [538](#L538) | public function rebuildRatings() |
| [539](#L539) | { |
| [540](#L540) | $this->helper->validateNonce(); |
| [541](#L541) | $response = ["progress" => 0]; |
| [542](#L542) | $rebuildRatings = isset($\_POST["rebuildRatings"]) ? sanitize\_textarea\_field($\_POST["rebuildRatings"]) : ""; |
| [543](#L543) | if ($rebuildRatings) { |
| [544](#L544) | parse\_str($rebuildRatings, $data); |
| [545](#L545) | $step = isset($data["rebuild-ratings-step"]) ? intval($data["rebuild-ratings-step"]) : 0; |
| [546](#L546) | $rebuildRatingsCount = isset($data["rebuild-ratings-count"]) ? intval($data["rebuild-ratings-count"]) : 0; |
| [547](#L547) | $rebuildRatingsStartId = isset($data["rebuild-ratings-start-id"]) ? intval($data["rebuild-ratings-start-id"]) : 0; |
| [548](#L548) | $nonce = isset($data["wpd-rebuild-ratings"]) ? trim($data["wpd-rebuild-ratings"]) : ""; |
| [549](#L549) | if (wp\_verify\_nonce($nonce, "wc\_tools\_form") && $rebuildRatingsCount && $rebuildRatingsStartId >= 0) { |
| [550](#L550) | $limit = 1; |
| [551](#L551) | $rebuildRatingsData = $this->dbManager->getRebuildRatingsData($rebuildRatingsStartId, $limit); |
| [552](#L552) | if ($rebuildRatingsData) { |
| [553](#L553) | $this->dbManager->rebuildRatings($rebuildRatingsData); |
| [554](#L554) | ++$step; |
| [555](#L555) | $progress = $step \* $limit \* 100 / $rebuildRatingsCount; |
| [556](#L556) | $response["progress"] = ($p = intval($progress)) > 100 ? 100 : $p; |
| [557](#L557) | $response["startId"] = $rebuildRatingsData[count($rebuildRatingsData) - 1]["meta\_id"]; |
| [558](#L558) | if ($response["progress"] == 100) { |
| [559](#L559) | update\_option(self::OPTION\_SLUG\_SHOW\_RATING\_REBUIL\_MSG, "0"); |
| [560](#L560) | } |
| [561](#L561) | } else { |
| [562](#L562) | $response["progress"] = 100; |
| [563](#L563) | $response["startId"] = 0; |
| [564](#L564) | update\_option(self::OPTION\_SLUG\_SHOW\_RATING\_REBUIL\_MSG, "0"); |
| [565](#L565) | } |
| [566](#L566) | $response["step"] = $step; |
| [567](#L567) | } |
| [568](#L568) | } |
| [569](#L569) | wp\_die(json\_encode($response)); |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | public function fixTables() |
| [573](#L573) | { |
| [574](#L574) | $this->helper->validateNonce(); |
| [575](#L575) | $fixTables = isset($\_POST["fixTables"]) ? sanitize\_textarea\_field($\_POST["fixTables"]) : ""; |
| [576](#L576) | if ($fixTables) { |
| [577](#L577) | parse\_str($fixTables, $data); |
| [578](#L578) | $nonce = !empty($data["wpd-fix-tables"]) ? trim($data["wpd-fix-tables"]) : ""; |
| [579](#L579) | if (wp\_verify\_nonce($nonce, "wc\_tools\_form")) { |
| [580](#L580) | $this->dbManager->fixTables(); |
| [581](#L581) | wp\_send\_json\_success(); |
| [582](#L582) | } |
| [583](#L583) | } |
| [584](#L584) | wp\_send\_json\_error(); |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | /\*\* |
| [588](#L588) | \* loads the comment content on click via ajax |
| [589](#L589) | \*/ |
| [590](#L590) | public function readMore() |
| [591](#L591) | { |
| [592](#L592) | $commentId = WpdiscuzHelper::sanitize(INPUT\_POST, "commentId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [593](#L593) | if ($commentId) { |
| [594](#L594) | $comment = get\_comment($commentId); |
| [595](#L595) | $form = $this->wpdiscuzForm->getForm($comment->comment\_post\_ID); |
| [596](#L596) | if ($form->isUserCanSeeComments(WpdiscuzHelper::getCurrentUser(), $comment->comment\_post\_ID)) { |
| [597](#L597) | $commentContent = $this->helper->filterCommentText($comment->comment\_content); |
| [598](#L598) | if ($this->options->content["enableImageConversion"]) { |
| [599](#L599) | $commentContent = $this->helper->makeClickable($commentContent); |
| [600](#L600) | } |
| [601](#L601) | $commentContent = apply\_filters("comment\_text", $commentContent, $comment, ["is\_wpdiscuz\_comment" => true]); |
| [602](#L602) | $commentContent = apply\_filters("wpdiscuz\_after\_read\_more", $commentContent, $comment, ["is\_wpdiscuz\_comment" => true]); |
| [603](#L603) | $inlineContent = ""; |
| [604](#L604) | if ($inlineFormID = intval(get\_comment\_meta($comment->comment\_ID, self::META\_KEY\_FEEDBACK\_FORM\_ID, true))) { |
| [605](#L605) | $feedbackForm = $this->dbManager->getFeedbackForm($inlineFormID); |
| [606](#L606) | $inlineContent = "<div class='wpd-inline-feedback-wrapper'><span class='wpd-inline-feedback-info'>" . esc\_html($this->options->getPhrase("wc\_feedback\_content\_text")) . "</span> <i class=\"fas fa-quote-left\"></i>" . wp\_trim\_words($feedbackForm->content, apply\_filters("wpdiscuz\_feedback\_content\_words\_count", 20)) . "&quot;  <a class='wpd-feedback-content-link' data-feedback-content-id='{$feedbackForm->id}' href='#wpd-inline-{$feedbackForm->id}'>" . esc\_html($this->options->getPhrase("wc\_read\_more")) . "</a></div>"; |
| [607](#L607) | } |
| [608](#L608) | $components = $this->helper->getComponents($form->getTheme(), $form->getLayout()); |
| [609](#L609) | $response = [ |
| [610](#L610) | "message" => str\_replace(["{TEXT\_WRAPPER\_CLASSES}", "{TEXT}"], [ |
| [611](#L611) | "wpd-comment-text", |
| [612](#L612) | $inlineContent . $commentContent |
| [613](#L613) | ], $components["text.html"]), |
| [614](#L614) | "callbackFunctions" => [], |
| [615](#L615) | ]; |
| [616](#L616) | $response = apply\_filters("wpdiscuz\_ajax\_callbacks", $response, $action = "wpdReadMore"); |
| [617](#L617) | wp\_send\_json\_success($response); |
| [618](#L618) | } else { |
| [619](#L619) | wp\_send\_json\_error("error"); |
| [620](#L620) | } |
| [621](#L621) | } else { |
| [622](#L622) | wp\_send\_json\_error("error"); |
| [623](#L623) | } |
| [624](#L624) | } |
| [625](#L625) |  |
| [626](#L626) | /\*\* |
| [627](#L627) | \* redirect first commenter to the selected page from options |
| [628](#L628) | \*/ |
| [629](#L629) | public function redirect() |
| [630](#L630) | { |
| [631](#L631) | $commentId = WpdiscuzHelper::sanitize(INPUT\_POST, "commentId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [632](#L632) | if ($this->options->general["redirectPage"] && $commentId) { |
| [633](#L633) | $comment = get\_comment($commentId); |
| [634](#L634) | if ($comment->comment\_ID) { |
| [635](#L635) | $userCommentCount = get\_comments(["author\_email" => $comment->comment\_author\_email, "count" => true]); |
| [636](#L636) | if ($userCommentCount == 1) { |
| [637](#L637) | wp\_send\_json\_success(get\_permalink($this->options->general["redirectPage"])); |
| [638](#L638) | } |
| [639](#L639) | } |
| [640](#L640) | } |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) | public function voteOnComment() |
| [644](#L644) | { |
| [645](#L645) | $this->helper->validateNonce(); |
| [646](#L646) | if($this->helper->isBanned()){ |
| [647](#L647) | wp\_send\_json\_error("wc\_banned\_user"); |
| [648](#L648) | } |
| [649](#L649) | $isUserLoggedIn = is\_user\_logged\_in(); |
| [650](#L650) | if (!$this->options->thread\_layouts["isGuestCanVote"] && !$isUserLoggedIn) { |
| [651](#L651) | wp\_send\_json\_error("wc\_login\_to\_vote"); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | $commentId = WpdiscuzHelper::sanitize(INPUT\_POST, "commentId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [655](#L655) | $voteType = WpdiscuzHelper::sanitize(INPUT\_POST, "voteType", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [656](#L656) |  |
| [657](#L657) | if ($commentId && $voteType && ($voteType != -1 || ($voteType == -1 && $this->options->thread\_layouts["enableDislikeButton"]))) { |
| [658](#L658) | if ($isUserLoggedIn) { |
| [659](#L659) | $userIdOrIp = get\_current\_user\_id(); |
| [660](#L660) | } else { |
| [661](#L661) | $userIdOrIp = md5($this->helper->getRealIPAddr()); |
| [662](#L662) | } |
| [663](#L663) | $isUserVoted = $this->dbManager->isUserVoted($userIdOrIp, $commentId); |
| [664](#L664) | $comment = get\_comment($commentId); |
| [665](#L665) | if (!$isUserLoggedIn && md5($comment->comment\_author\_IP) == $userIdOrIp) { |
| [666](#L666) | wp\_send\_json\_error("wc\_deny\_voting\_from\_same\_ip"); |
| [667](#L667) | } |
| [668](#L668) | if ($comment->user\_id == $userIdOrIp) { |
| [669](#L669) | wp\_send\_json\_error("wc\_self\_vote"); |
| [670](#L670) | } |
| [671](#L671) | $response = []; |
| [672](#L672) | if ($isUserVoted != "") { |
| [673](#L673) | $isUserVotedInt = intval($isUserVoted); |
| [674](#L674) | $vote = $isUserVotedInt + $voteType; |
| [675](#L675) | if (($vote >= -1 && $vote <= 1) || ($vote == 2 && !$this->options->thread\_layouts["enableDislikeButton"])) { |
| [676](#L676) | if ($vote == 2) { |
| [677](#L677) | $vote = 0; |
| [678](#L678) | $voteType = -1; |
| [679](#L679) | } |
| [680](#L680) | $this->dbManager->updateVoteType($userIdOrIp, $commentId, $vote, current\_time("timestamp")); |
| [681](#L681) | $voteCount = intval(get\_comment\_meta($commentId, self::META\_KEY\_VOTES, true)) + $voteType; |
| [682](#L682) | update\_comment\_meta($commentId, self::META\_KEY\_VOTES, "" . $voteCount); |
| [683](#L683) | $votesSeparate = get\_comment\_meta($commentId, self::META\_KEY\_VOTES\_SEPARATE, true); |
| [684](#L684) | $votesSeparate = is\_array($votesSeparate) ? $votesSeparate : ["like" => 0, "dislike" => 0]; |
| [685](#L685) | if ($vote == 0) { |
| [686](#L686) | if ($isUserVotedInt == 1) { |
| [687](#L687) | $votesSeparate["like"] -= 1; |
| [688](#L688) | } else if ($isUserVotedInt == -1) { |
| [689](#L689) | $votesSeparate["dislike"] -= 1; |
| [690](#L690) | } |
| [691](#L691) | } else { |
| [692](#L692) | if ($voteType == 1) { |
| [693](#L693) | $votesSeparate["like"] += 1; |
| [694](#L694) | } else if ($voteType == -1) { |
| [695](#L695) | $votesSeparate["dislike"] += 1; |
| [696](#L696) | } |
| [697](#L697) | } |
| [698](#L698) | update\_comment\_meta($commentId, self::META\_KEY\_VOTES\_SEPARATE, $votesSeparate); |
| [699](#L699) | do\_action("wpdiscuz\_update\_vote", $voteType, $isUserVoted, $comment); |
| [700](#L700) | if ($this->options->thread\_layouts["votingButtonsStyle"]) { |
| [701](#L701) | $response["buttonsStyle"] = "separate"; |
| [702](#L702) | $response["likeCount"] = esc\_html($votesSeparate["like"]); |
| [703](#L703) | $response["likeCountHumanReadable"] = esc\_html($this->helper->getNumber($votesSeparate["like"])); |
| [704](#L704) | $response["dislikeCount"] = esc\_html(-$votesSeparate["dislike"]); |
| [705](#L705) | $response["dislikeCountHumanReadable"] = esc\_html($this->helper->getNumber(-$votesSeparate["dislike"])); |
| [706](#L706) | } else { |
| [707](#L707) | $response["buttonsStyle"] = "total"; |
| [708](#L708) | $response["votes"] = esc\_html($voteCount); |
| [709](#L709) | $response["votesHumanReadable"] = esc\_html($this->helper->getNumber($voteCount)); |
| [710](#L710) | } |
| [711](#L711) | $response["curUserReaction"] = $vote; |
| [712](#L712) | } else { |
| [713](#L713) | wp\_send\_json\_error("wc\_vote\_only\_one\_time"); |
| [714](#L714) | } |
| [715](#L715) | } else { |
| [716](#L716) | $this->dbManager->addVoteType($userIdOrIp, $commentId, $voteType, intval($isUserLoggedIn), $comment->comment\_post\_ID, current\_time("timestamp")); |
| [717](#L717) | $voteCount = intval(get\_comment\_meta($commentId, self::META\_KEY\_VOTES, true)) + $voteType; |
| [718](#L718) | update\_comment\_meta($commentId, self::META\_KEY\_VOTES, "" . $voteCount); |
| [719](#L719) | $votesSeparate = get\_comment\_meta($commentId, self::META\_KEY\_VOTES\_SEPARATE, true); |
| [720](#L720) | $votesSeparate = is\_array($votesSeparate) ? $votesSeparate : ["like" => 0, "dislike" => 0]; |
| [721](#L721) | if ($voteType == 1) { |
| [722](#L722) | $votesSeparate["like"] += 1; |
| [723](#L723) | } else if ($voteType == -1) { |
| [724](#L724) | $votesSeparate["dislike"] += 1; |
| [725](#L725) | } |
| [726](#L726) | update\_comment\_meta($commentId, self::META\_KEY\_VOTES\_SEPARATE, $votesSeparate); |
| [727](#L727) | do\_action("wpdiscuz\_add\_vote", $voteType, $comment); |
| [728](#L728) | if ($this->options->thread\_layouts["votingButtonsStyle"]) { |
| [729](#L729) | $response["buttonsStyle"] = "separate"; |
| [730](#L730) | $response["likeCount"] = esc\_html($votesSeparate["like"]); |
| [731](#L731) | $response["likeCountHumanReadable"] = esc\_html($this->helper->getNumber($votesSeparate["like"])); |
| [732](#L732) | $response["dislikeCount"] = esc\_html(-$votesSeparate["dislike"]); |
| [733](#L733) | $response["dislikeCountHumanReadable"] = esc\_html($this->helper->getNumber(-$votesSeparate["dislike"])); |
| [734](#L734) | } else { |
| [735](#L735) | $response["buttonsStyle"] = "total"; |
| [736](#L736) | $response["votes"] = esc\_html($voteCount); |
| [737](#L737) | $response["votesHumanReadable"] = esc\_html($this->helper->getNumber($voteCount)); |
| [738](#L738) | } |
| [739](#L739) | $response["curUserReaction"] = $voteType; |
| [740](#L740) | } |
| [741](#L741) | $response["callbackFunctions"] = []; |
| [742](#L742) | $response = apply\_filters("wpdiscuz\_ajax\_callbacks", $response, $action = "wpdVoteOnComment"); |
| [743](#L743) | $response = apply\_filters("wpdiscuz\_comment\_vote", $response); |
| [744](#L744) | if ($this->options->thread\_display["mostVotedByDefault"]) { |
| [745](#L745) | do\_action("wpdiscuz\_reset\_comments\_cache", $comment->comment\_post\_ID); |
| [746](#L746) | } else { |
| [747](#L747) | do\_action("wpdiscuz\_reset\_comments\_extra\_cache", $comment->comment\_post\_ID); |
| [748](#L748) | } |
| [749](#L749) | do\_action("wpdiscuz\_clean\_post\_cache", $comment->comment\_post\_ID, "comment\_voted"); |
| [750](#L750) | wp\_send\_json\_success($response); |
| [751](#L751) | } else { |
| [752](#L752) | wp\_send\_json\_error("wc\_voting\_error"); |
| [753](#L753) | } |
| [754](#L754) | } |
| [755](#L755) |  |
| [756](#L756) | public function getInlineCommentForm() |
| [757](#L757) | { |
| [758](#L758) | $post\_id = WpdiscuzHelper::sanitize(INPUT\_POST, "postId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [759](#L759) | if ($post\_id && apply\_filters("wpdiscuz\_enable\_feedback\_shortcode\_button", true) && $this->dbManager->postHasFeedbackForms($post\_id)) { |
| [760](#L760) | $currentUser = WpdiscuzHelper::getCurrentUser(); |
| [761](#L761) | $form = $this->wpdiscuzForm->getForm($post\_id); |
| [762](#L762) | if ($form->isUserCanComment($currentUser, $post\_id)) { |
| [763](#L763) | $response = "<div class='wpd-inline-form'>"; |
| [764](#L764) | $response .= "<form method='post' class='wpd\_inline\_comm\_form' autocomplete='off'>"; |
| [765](#L765) | $response .= "<textarea name='wpd\_inline\_comment' class='wpd-inline-comment-content' placeholder='" . esc\_attr($this->options->getPhrase("wc\_inline\_form\_comment")) . "'></textarea>"; |
| [766](#L766) | $response .= "<label class='wpd-inline-notification'><input name='wpd\_inline\_notify\_me' class='wpd-inline-notify-me' type='checkbox' value='1' />&nbsp;" . esc\_html($this->options->getPhrase("wc\_inline\_form\_notify")) . '</label>'; |
| [767](#L767) | $response .= "<div class='wpd-inline-form-second-row'>"; |
| [768](#L768) | if (empty($currentUser->ID)) { |
| [769](#L769) | $response .= "<input name='wpd\_inline\_name' class='wpd-inline-name-input' placeholder='" . esc\_html($this->options->getPhrase("wc\_inline\_form\_name")) . "' required='required' />"; |
| [770](#L770) | $response .= "<input name='wpd\_inline\_email' class='wpd-inline-name-input' placeholder='" . esc\_html($this->options->getPhrase("wc\_inline\_form\_email")) . "' />"; |
| [771](#L771) | } |
| [772](#L772) | $response .= "<button class='wpd-inline-submit wpd\_not\_clicked' type='submit' name='wpd\_inline\_submit'><span>" . esc\_html($this->options->getPhrase("wc\_inline\_form\_comment\_button")) . "</span><svg xmlns='https://www.w3.org/2000/svg' class='wpd-inline-submit-icon' width='24' height='24' viewBox='0 0 24 24'><path class='wpd-inline-submit-icon-first' d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2z'/><path class='wpd-inline-submit-icon-second' d='M0 0h24v24H0z'/></svg></button>"; |
| [773](#L773) | $response .= "</div>"; |
| [774](#L774) | $response .= apply\_filters("wpdiscuz\_after\_feedback\_form\_fields", "", $post\_id); |
| [775](#L775) | $response .= wp\_nonce\_field("wpd\_inline\_nonce\_" . $post\_id, "\_wpd\_inline\_nonce", false, false); |
| [776](#L776) | $response .= "</form>"; |
| [777](#L777) | $response .= "</div>"; |
| [778](#L778) | wp\_send\_json\_success($response); |
| [779](#L779) | } |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) |  |
| [783](#L783) | public function getLastInlineComments() |
| [784](#L784) | { |
| [785](#L785) | $inline\_form\_id = WpdiscuzHelper::sanitize(INPUT\_POST, "inline\_form\_id", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [786](#L786) | if ($inline\_form\_id && apply\_filters("wpdiscuz\_enable\_feedback\_shortcode\_button", true) && ($inline\_form = $this->dbManager->getFeedbackForm($inline\_form\_id))) { |
| [787](#L787) | $args = [ |
| [788](#L788) | "orderby" => $this->options->thread\_display["orderCommentsBy"], |
| [789](#L789) | "order" => "DESC", |
| [790](#L790) | "number" => 3, |
| [791](#L791) | "status" => !$this->options->wp["isPaginate"] && current\_user\_can("moderate\_comments") ? "all" : "approve", |
| [792](#L792) | "meta\_query" => [ |
| [793](#L793) | [ |
| [794](#L794) | "key" => self::META\_KEY\_FEEDBACK\_FORM\_ID, |
| [795](#L795) | "value" => $inline\_form->id, |
| [796](#L796) | "compare" => "=", |
| [797](#L797) | ], |
| [798](#L798) | ], |
| [799](#L799) | ]; |
| [800](#L800) | $comments = get\_comments($args); |
| [801](#L801) | $content = ""; |
| [802](#L802) | if ($comments) { |
| [803](#L803) | $content .= "<div class='wpd-last-inline-comments-wrapper'>"; |
| [804](#L804) | $content .= "<div class='wpd-last-inline-comments'>"; |
| [805](#L805) | foreach ($comments as $k => $comment) { |
| [806](#L806) | $content .= "<div class='wpd-last-inline-comment' data-inline-comment-id='" . esc\_attr($comment->comment\_ID) . "'>"; |
| [807](#L807) | $content .= "<div>"; |
| [808](#L808) | $content .= "<span class='wpd-last-inline-comment-author-avatar'>" . get\_avatar($comment->comment\_author\_email, 16) . "</span>"; |
| [809](#L809) | $content .= "<span class='wpd-last-inline-comment-author-name'>" . esc\_html($comment->comment\_author) . "</span>"; |
| [810](#L810) | $content .= "<span class='wpd-last-inline-comment-date'>" . esc\_html($this->helper->dateDiff($comment->comment\_date\_gmt)) . "</span>"; |
| [811](#L811) | $content .= "</div>"; |
| [812](#L812) | $commentContent = function\_exists("mb\_substr") ? mb\_substr($comment->comment\_content, 0, 85) : substr($comment->comment\_content, 0, 85); |
| [813](#L813) | if (strlen($comment->comment\_content) > strlen($commentContent)) { |
| [814](#L814) | $commentContent .= "&nbsp;<a href='" . get\_comment\_link($comment) . "' class='wpd-load-inline-comment' title='" . esc\_html\_\_("Read More", "wpdiscuz") . "'>[...]</a>"; |
| [815](#L815) | } |
| [816](#L816) | $content .= "<span class='wpd-last-inline-comment-text'>" . wp\_unslash($commentContent) . "</span>"; |
| [817](#L817) | $content .= "</div>"; |
| [818](#L818) | } |
| [819](#L819) | $content .= "</div>"; |
| [820](#L820) | if (!$this->options->wp["isPaginate"]) { |
| [821](#L821) | $content .= "<a href='' class='wpd-view-all-inline-comments'>" . esc\_html($this->options->getPhrase("wc\_inline\_comments\_view\_all")) . "</a>"; |
| [822](#L822) | } |
| [823](#L823) | $content .= "</div>"; |
| [824](#L824) | } |
| [825](#L825) | wp\_send\_json\_success($content); |
| [826](#L826) | } else { |
| [827](#L827) | wp\_send\_json\_error("wc\_msg\_required\_fields"); |
| [828](#L828) | } |
| [829](#L829) | } |
| [830](#L830) |  |
| [831](#L831) | /\*\* |
| [832](#L832) | \* get comment text from db |
| [833](#L833) | \*/ |
| [834](#L834) | public function editComment() |
| [835](#L835) | { |
| [836](#L836) | $this->helper->validateNonce(); |
| [837](#L837) | $commentId = WpdiscuzHelper::sanitize(INPUT\_POST, "commentId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [838](#L838) | if ($commentId) { |
| [839](#L839) | $comment = get\_comment($commentId); |
| [840](#L840) | $postID = $comment->comment\_post\_ID; |
| [841](#L841) | $form = $this->wpdiscuzForm->getForm($postID); |
| [842](#L842) | $form->initFormFields(); |
| [843](#L843) | $currentUser = WpdiscuzHelper::getCurrentUser(); |
| [844](#L844) | $highLevelUser = current\_user\_can("moderate\_comments"); |
| [845](#L845) | $isCurrentUserCanEdit = $this->helper->isCommentEditable($comment) && $this->helper->canUserEditComment($comment, $currentUser); |
| [846](#L846) | if (!intval(get\_comment\_meta($comment->comment\_ID, self::META\_KEY\_CLOSED, true)) && ($highLevelUser || $isCurrentUserCanEdit)) { |
| [847](#L847) | wp\_send\_json\_success($form->renderEditFrontCommentForm($comment)); |
| [848](#L848) | } else { |
| [849](#L849) | wp\_send\_json\_error("wc\_comment\_edit\_not\_possible"); |
| [850](#L850) | } |
| [851](#L851) | } else { |
| [852](#L852) | wp\_send\_json\_error("wc\_comment\_edit\_not\_possible"); |
| [853](#L853) | } |
| [854](#L854) | } |
| [855](#L855) |  |
| [856](#L856) | public function userRate() |
| [857](#L857) | { |
| [858](#L858) | $this->helper->validateNonce(); |
| [859](#L859) | $rating = WpdiscuzHelper::sanitize(INPUT\_POST, "rating", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [860](#L860) | $post\_id = WpdiscuzHelper::sanitize(INPUT\_POST, "postId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [861](#L861) | /\*\* |
| [862](#L862) | \* @var $form \wpdFormAttr\Form |
| [863](#L863) | \*/ |
| [864](#L864) | $form = $this->wpdiscuzForm->getForm($post\_id); |
| [865](#L865) | $form->initFormMeta(); |
| [866](#L866) | $formOptions = $form->getGeneralOptions(); |
| [867](#L867) | if ($rating && $post\_id && $form) { |
| [868](#L868) | $currentUser = $this->helper->getCurrentUser(); |
| [869](#L869) | if (!empty($currentUser->ID)) { |
| [870](#L870) | $rateId = $this->dbManager->isUserRated($currentUser->ID, "", $post\_id); |
| [871](#L871) | if (!$rateId || ($rateId && $formOptions["is\_rate\_editable"])) { |
| [872](#L872) | $this->dbManager->addRate($post\_id, $currentUser->ID, "", $rating, current\_time("timestamp"), $rateId); |
| [873](#L873) | $data = $this->dbManager->getPostRatingData($post\_id); |
| [874](#L874) | $votes = 0; |
| [875](#L875) | foreach ($data as $value) { |
| [876](#L876) | $votes += $value; |
| [877](#L877) | } |
| [878](#L878) | $count = count($data); |
| [879](#L879) | update\_post\_meta($post\_id, self::POSTMETA\_POST\_RATING, round($votes / $count, 1)); |
| [880](#L880) | update\_post\_meta($post\_id, self::POSTMETA\_POST\_RATING\_COUNT, $count); |
| [881](#L881) | do\_action("wpdiscuz\_add\_rating", $rating, $post\_id); |
| [882](#L882) | do\_action("wpdiscuz\_clean\_post\_cache", $post\_id, "user\_rated"); |
| [883](#L883) | $response = ["callbackFunctions" => []]; |
| [884](#L884) | $response = apply\_filters("wpdiscuz\_ajax\_callbacks", $response, $action = "wpdUserRate"); |
| [885](#L885) | wp\_send\_json\_success($response); |
| [886](#L886) | } else { |
| [887](#L887) | wp\_send\_json\_error("wc\_cannot\_rate\_again"); |
| [888](#L888) | } |
| [889](#L889) | } else if ($form->getUserCanRateOnPost()) { |
| [890](#L890) | $userIp = md5($this->helper->getRealIPAddr()); |
| [891](#L891) | $rateId = $this->dbManager->isUserRated(0, $userIp, $post\_id); |
| [892](#L892) | if (!$rateId || ($rateId && $formOptions["is\_rate\_editable"])) { |
| [893](#L893) | $this->dbManager->addRate($post\_id, 0, $userIp, $rating, current\_time("timestamp"), $rateId); |
| [894](#L894) | $data = $this->dbManager->getPostRatingData($post\_id); |
| [895](#L895) | $votes = 0; |
| [896](#L896) | foreach ($data as $value) { |
| [897](#L897) | $votes += $value; |
| [898](#L898) | } |
| [899](#L899) | $count = count($data); |
| [900](#L900) | update\_post\_meta($post\_id, self::POSTMETA\_POST\_RATING, round($votes / $count, 1)); |
| [901](#L901) | update\_post\_meta($post\_id, self::POSTMETA\_POST\_RATING\_COUNT, $count); |
| [902](#L902) | do\_action("wpdiscuz\_add\_rating", $rating, $post\_id); |
| [903](#L903) | do\_action("wpdiscuz\_clean\_post\_cache", $post\_id, "user\_rated"); |
| [904](#L904) | $response = ["callbackFunctions" => []]; |
| [905](#L905) | $response = apply\_filters("wpdiscuz\_ajax\_callbacks", $response, $action = "wpdUserRate"); |
| [906](#L906) | wp\_send\_json\_success($response); |
| [907](#L907) | } else { |
| [908](#L908) | wp\_send\_json\_error("wc\_cannot\_rate\_again"); |
| [909](#L909) | } |
| [910](#L910) | } else { |
| [911](#L911) | wp\_send\_json\_error("wc\_not\_allowed\_to\_rate"); |
| [912](#L912) | } |
| [913](#L913) | } else { |
| [914](#L914) | wp\_send\_json\_error("wc\_msg\_required\_fields"); |
| [915](#L915) | } |
| [916](#L916) | } |
| [917](#L917) |  |
| [918](#L918) | public function unsubscribe() |
| [919](#L919) | { |
| [920](#L920) | $this->helper->validateNonce(); |
| [921](#L921) | $sid = WpdiscuzHelper::sanitize(INPUT\_POST, "sid", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [922](#L922) | $skey = WpdiscuzHelper::sanitize(INPUT\_POST, "skey", "FILTER\_SANITIZE\_STRING"); |
| [923](#L923) | if ($sid && $skey) { |
| [924](#L924) | $this->dbManager->unsubscribe($sid, $skey); |
| [925](#L925) | wp\_send\_json\_success(esc\_html($this->options->getPhrase("wc\_unsubscribe\_message"))); |
| [926](#L926) | } |
| [927](#L927) | wp\_send\_json\_error("Something is wrong"); |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | public function wpd\_stat\_brief() |
| [931](#L931) | { |
| [932](#L932) | check\_ajax\_referer("wpd-option-nonce", "security"); |
| [933](#L933) | if (!current\_user\_can("manage\_options")) { |
| [934](#L934) | wp\_send\_json\_error("Permission denied"); |
| [935](#L935) | } |
| [936](#L936) | wp\_send\_json\_success(["all" => esc\_html($this->dbManager->getCommentsCount()), "inline" => esc\_html($this->dbManager->getInlineCommentsCount()), "threads" => esc\_html($this->dbManager->getThreadsCount()), "replies" => esc\_html($this->dbManager->getRepliesCount()), "users" => esc\_html($this->dbManager->getUserCommentersCount()), "guests" => esc\_html($this->dbManager->getGuestCommentersCount())]); |
| [937](#L937) | } |
| [938](#L938) |  |
| [939](#L939) | public function wpd\_stat\_subs() |
| [940](#L940) | { |
| [941](#L941) | check\_ajax\_referer("wpd-option-nonce", "security"); |
| [942](#L942) | if (!current\_user\_can("manage\_options")) { |
| [943](#L943) | wp\_die("Permission denied"); |
| [944](#L944) | } |
| [945](#L945) | ob\_start(); |
| [946](#L946) | ?> |
| [947](#L947) | <ul class="wpd-box-list"> |
| [948](#L948) | <li> |
| [949](#L949) | <div class="wpd-list-label"><?php esc\_html\_e("Subscribers", "wpdiscuz") ?></div> |
| [950](#L950) | <div class="wpd-list-val"><?php echo esc\_html($this->dbManager->getAllSubscribersCount()); ?></div> |
| [951](#L951) | </li> |
| [952](#L952) | <li> |
| [953](#L953) | <div class="wpd-list-label"><?php esc\_html\_e("Subscription - posts", "wpdiscuz") ?></div> |
| [954](#L954) | <div class="wpd-list-val"><?php echo esc\_html($this->dbManager->getPostSubscribersCount()); ?></div> |
| [955](#L955) | </li> |
| [956](#L956) | <li> |
| [957](#L957) | <div class="wpd-list-label"><?php esc\_html\_e("Subscription - all comments", "wpdiscuz") ?></div> |
| [958](#L958) | <div class="wpd-list-val"><?php echo esc\_html($this->dbManager->getAllCommentSubscribersCount()); ?></div> |
| [959](#L959) | </li> |
| [960](#L960) | <li> |
| [961](#L961) | <div class="wpd-list-label"><?php esc\_html\_e("Subscription - comment", "wpdiscuz") ?></div> |
| [962](#L962) | <div class="wpd-list-val"><?php echo esc\_html($this->dbManager->getCommentSubscribersCount()); ?></div> |
| [963](#L963) | </li> |
| [964](#L964) | <li> |
| [965](#L965) | <div class="wpd-list-label"><?php esc\_html\_e("Followers", "wpdiscuz") ?></div> |
| [966](#L966) | <div class="wpd-list-val"><?php echo esc\_html($this->dbManager->getFollowersCount()); ?></div> |
| [967](#L967) | </li> |
| [968](#L968) | <li> |
| [969](#L969) | <div class="wpd-list-label"><?php esc\_html\_e("Following", "wpdiscuz") ?></div> |
| [970](#L970) | <div class="wpd-list-val"><?php echo esc\_html($this->dbManager->getFollowingCount()); ?></div> |
| [971](#L971) | </li> |
| [972](#L972) | </ul> |
| [973](#L973) | <?php |
| [974](#L974) | wp\_die(ob\_get\_clean()); |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) | public function wpd\_stat\_graph() |
| [978](#L978) | { |
| [979](#L979) | check\_ajax\_referer("wpd-option-nonce", "security"); |
| [980](#L980) | if (!current\_user\_can("manage\_options")) { |
| [981](#L981) | wp\_send\_json\_error("Permission denied"); |
| [982](#L982) | } |
| [983](#L983) | $interval = WpdiscuzHelper::sanitize(INPUT\_POST, "interval", "FILTER\_SANITIZE\_STRING"); |
| [984](#L984) | if ($interval) { |
| [985](#L985) | $all = $this->dbManager->getGraphAllComments($interval); |
| [986](#L986) | $inline = $this->dbManager->getGraphInlineComments($interval); |
| [987](#L987) | $diffInline = array\_diff(array\_keys($all), array\_keys($inline)); |
| [988](#L988) | $diffAll = array\_diff(array\_keys($inline), array\_keys($all)); |
| [989](#L989) | $combInline = array\_combine($diffInline, array\_pad([], count($diffInline), 0)); |
| [990](#L990) | $combAll = array\_combine($diffAll, array\_pad([], count($diffAll), 0)); |
| [991](#L991) | foreach ($combAll as $key => $val) { |
| [992](#L992) | $all[$key] = $val; |
| [993](#L993) | } |
| [994](#L994) | foreach ($combInline as $key => $val) { |
| [995](#L995) | $inline[$key] = $val; |
| [996](#L996) | } |
| [997](#L997) | ksort($all); |
| [998](#L998) | ksort($inline); |
| [999](#L999) | $data = [ |
| [1000](#L1000) | "el" => "<canvas id='wpdChart'></canvas>", |
| [1001](#L1001) | "all" => array\_values($all), |
| [1002](#L1002) | "inline" => array\_values($inline), |
| [1003](#L1003) | "labels" => array\_map(function ($v) { |
| [1004](#L1004) | return esc\_html(date("d M", $v)); |
| [1005](#L1005) | }, array\_keys($all)), |
| [1006](#L1006) | ]; |
| [1007](#L1007) | wp\_send\_json\_success($data); |
| [1008](#L1008) | } |
| [1009](#L1009) | wp\_send\_json\_error(); |
| [1010](#L1010) | } |
| [1011](#L1011) |  |
| [1012](#L1012) | public function wpd\_stat\_user() |
| [1013](#L1013) | { |
| [1014](#L1014) | check\_ajax\_referer("wpd-option-nonce", "security"); |
| [1015](#L1015) | if (!current\_user\_can("manage\_options")) { |
| [1016](#L1016) | wp\_send\_json\_error("Permission denied"); |
| [1017](#L1017) | } |
| [1018](#L1018) | $orderby = WpdiscuzHelper::sanitize(INPUT\_POST, "orderby", "FILTER\_SANITIZE\_STRING"); |
| [1019](#L1019) | $order = WpdiscuzHelper::sanitize(INPUT\_POST, "order", "FILTER\_SANITIZE\_STRING"); |
| [1020](#L1020) | $page = WpdiscuzHelper::sanitize(INPUT\_POST, "page", "FILTER\_SANITIZE\_STRING"); |
| [1021](#L1021) | if ($orderby && $order && $page) { |
| [1022](#L1022) | ob\_start(); |
| [1023](#L1023) | ?> |
| [1024](#L1024) | <table class="wpd-user-table" cellpadding="0" cellspacing="0" width="100%"> |
| [1025](#L1025) | <tr> |
| [1026](#L1026) | <th> |
| [1027](#L1027) | <?php esc\_html\_e("Comment Author", "wpdiscuz") ?> |
| [1028](#L1028) | </th> |
| [1029](#L1029) | <th class="wpd-sort-field<?php echo esc\_attr("comments" === $orderby ? " wpd-active" : ""); ?>" |
| [1030](#L1030) | data-orderby="comments"> |
| [1031](#L1031) | <?php esc\_html\_e("Comments", "wpdiscuz") ?> |
| [1032](#L1032) | <span<?php echo "comments" !== $orderby ? " style='display:none;'" : ""; ?> class="dashicons <?php echo esc\_attr("comments" === $orderby && "desc" === $order ? "dashicons-arrow-down-alt2" : "dashicons-arrow-up-alt2"); ?>"></span> |
| [1033](#L1033) | </th> |
| [1034](#L1034) | <th class="wpd-sort-field<?php echo esc\_attr("subscriptions" === $orderby ? " wpd-active" : ""); ?>" |
| [1035](#L1035) | data-orderby="subscriptions"> |
| [1036](#L1036) | <?php esc\_html\_e("Subscriptions", "wpdiscuz") ?> |
| [1037](#L1037) | <span<?php echo "subscriptions" !== $orderby ? " style='display:none;'" : ""; ?> class="dashicons <?php echo esc\_attr("subscriptions" === $orderby && "desc" === $order ? "dashicons-arrow-down-alt2" : "dashicons-arrow-up-alt2"); ?>"></span> |
| [1038](#L1038) | </th> |
| [1039](#L1039) | <th class="wpd-sort-field<?php echo esc\_attr("following" === $orderby ? " wpd-active" : ""); ?>" |
| [1040](#L1040) | data-orderby="following"> |
| [1041](#L1041) | <?php esc\_html\_e("Following", "wpdiscuz") ?> |
| [1042](#L1042) | <span<?php echo "following" !== $orderby ? " style='display:none;'" : ""; ?> class="dashicons <?php echo esc\_attr("following" === $orderby && "desc" === $order ? "dashicons-arrow-down-alt2" : "dashicons-arrow-up-alt2"); ?>"></span> |
| [1043](#L1043) | </th> |
| [1044](#L1044) | <th class="wpd-sort-field<?php echo esc\_attr("followers" === $orderby ? " wpd-active" : ""); ?>" |
| [1045](#L1045) | data-orderby="followers"> |
| [1046](#L1046) | <?php esc\_html\_e("Followers", "wpdiscuz") ?> |
| [1047](#L1047) | <span<?php echo "followers" !== $orderby ? " style='display:none;'" : ""; ?> class="dashicons <?php echo esc\_attr("followers" === $orderby && "desc" === $order ? "dashicons-arrow-down-alt2" : "dashicons-arrow-up-alt2"); ?>"></span> |
| [1048](#L1048) | </th> |
| [1049](#L1049) | <th class="wpd-sort-field<?php echo esc\_attr("last\_activity" === $orderby ? " wpd-active" : ""); ?>" |
| [1050](#L1050) | data-orderby="last\_activity"> |
| [1051](#L1051) | <?php esc\_html\_e("Last Activity", "wpdiscuz") ?> |
| [1052](#L1052) | <span<?php echo "last\_activity" !== $orderby ? " style='display:none;'" : ""; ?> class="dashicons <?php echo esc\_attr("last\_activity" === $orderby && "desc" === $order ? "dashicons-arrow-down-alt2" : "dashicons-arrow-up-alt2"); ?>"></span> |
| [1053](#L1053) | </th> |
| [1054](#L1054) | </tr> |
| [1055](#L1055) | <?php |
| [1056](#L1056) | $data = []; |
| [1057](#L1057) | $activeUsers = $this->dbManager->getActiveUsers($orderby, $order, $page); |
| [1058](#L1058) | $more = false; |
| [1059](#L1059) | if (count($activeUsers) > 6) { |
| [1060](#L1060) | $more = true; |
| [1061](#L1061) | array\_pop($activeUsers); |
| [1062](#L1062) | } |
| [1063](#L1063) | $data["more"] = $more; |
| [1064](#L1064) | foreach ($activeUsers as $k => $val) { |
| [1065](#L1065) | ?> |
| [1066](#L1066) | <tr> |
| [1067](#L1067) | <td> |
| [1068](#L1068) | <?php echo get\_avatar($val["comment\_author\_email"], 24); ?> |
| [1069](#L1069) | <span class="wpd-name"><?php echo esc\_html($val["comment\_author"]); ?></span> |
| [1070](#L1070) | </td> |
| [1071](#L1071) | <td<?php echo "comments" === $orderby ? " class='wpd-active'" : ""; ?>><?php echo esc\_html(number\_format($val["count"])); ?></td> |
| [1072](#L1072) | <td<?php echo "subscriptions" === $orderby ? " class='wpd-active'" : ""; ?>><?php echo esc\_html(number\_format($val["scount"])); ?></td> |
| [1073](#L1073) | <td<?php echo "following" === $orderby ? " class='wpd-active'" : ""; ?>><?php echo esc\_html(number\_format($val["ficount"])); ?></td> |
| [1074](#L1074) | <td<?php echo "followers" === $orderby ? " class='wpd-active'" : ""; ?>><?php echo esc\_html(number\_format($val["fwcount"])); ?></td> |
| [1075](#L1075) | <td<?php echo "last\_activity" === $orderby ? " class='wpd-active'" : ""; ?>><?php echo esc\_html(date("d M, y", strtotime($val["last\_date"]))); ?></td> |
| [1076](#L1076) | </tr> |
| [1077](#L1077) | <?php |
| [1078](#L1078) | } |
| [1079](#L1079) | ?> |
| [1080](#L1080) | </table> |
| [1081](#L1081) | <?php |
| [1082](#L1082) | $data["body"] = ob\_get\_clean(); |
| [1083](#L1083) | wp\_send\_json\_success($data); |
| [1084](#L1084) | } |
| [1085](#L1085) | wp\_send\_json\_error(esc\_html\_\_("Something is wrong")); |
| [1086](#L1086) | } |
| [1087](#L1087) |  |
| [1088](#L1088) | public function searchOption() |
| [1089](#L1089) | { |
| [1090](#L1090) | $search = WpdiscuzHelper::sanitize(INPUT\_POST, "s", "FILTER\_SANITIZE\_STRING"); |
| [1091](#L1091) | if ($search) { |
| [1092](#L1092) | $optionsObject = $this->options; |
| [1093](#L1093) | $settings = $this->options->settingsArray(); |
| [1094](#L1094) | $result = []; |
| [1095](#L1095) | foreach ($settings as $type) { |
| [1096](#L1096) | foreach ($type as $tabKey => $tab) { |
| [1097](#L1097) | foreach ($tab["options"] as $optKey => $val) { |
| [1098](#L1098) |  |
| [1099](#L1099) | if (stripos($tab["title"], $search) !== false || stripos($tab["title\_original"], $search) !== false) { |
| [1100](#L1100) | if (!isset($result[$tabKey])) { |
| [1101](#L1101) | $result[$tabKey] = ["<a href='" . esc\_url\_raw(admin\_url("admin.php?page=" . self::PAGE\_SETTINGS . "&wpd\_tab=" . $tabKey)) . "' tabindex='" . esc\_attr($tab["title"]) . "' class='wpd-opt-search-tabtitle'>" . esc\_html($tab["title"]) . "</a>"]; |
| [1102](#L1102) | } |
| [1103](#L1103) | } |
| [1104](#L1104) |  |
| [1105](#L1105) | if ((isset($val["label"]) && stripos($val["label"], $search) !== false) || |
| [1106](#L1106) | (isset($val["description"]) && stripos($val["description"], $search) !== false) || |
| [1107](#L1107) | (isset($val["label\_original"]) && stripos($val["label\_original"], $search) !== false) || |
| [1108](#L1108) | (isset($val["description\_original"]) && stripos($val["description\_original"], $search) !== false) || |
| [1109](#L1109) | stripos($optKey, $search)) { |
| [1110](#L1110) |  |
| [1111](#L1111) | $fragment = empty($val["accordion"]) ? "wpd\_tab={$tabKey}#wpdOpt-{$optKey}" : "&wpd\_tab={$tabKey}#{$val["accordion"]}#wpdOpt-{$optKey}"; |
| [1112](#L1112) |  |
| [1113](#L1113) | if (isset($result[$tabKey])) { |
| [1114](#L1114) | $result[$tabKey][$optKey] = "<a href='" . esc\_url\_raw(admin\_url("admin.php?page=" . self::PAGE\_SETTINGS . "&" . $fragment)) . "' tabindex='" . esc\_attr($tabKey . "-" . $optKey) . "' class='wpd-opt-search-taboption'>" . esc\_html($val["label"]) . "</a>"; |
| [1115](#L1115) | } else { |
| [1116](#L1116) | $result[$tabKey] = ["<a href='" . esc\_url\_raw(admin\_url("admin.php?page=" . self::PAGE\_SETTINGS . "&wpd\_tab=" . $tabKey)) . "' tabindex='" . esc\_attr($tab["title"]) . "' class='wpd-opt-search-tabtitle'>" . esc\_html($tab["title"]) . "</a>"]; |
| [1117](#L1117) |  |
| [1118](#L1118) | if (!isset($result[$tabKey][$optKey])) { |
| [1119](#L1119) | $result[$tabKey][$optKey] = "<a href='" . esc\_url\_raw(admin\_url("admin.php?page=" . self::PAGE\_SETTINGS . "&" . $fragment)) . "' tabindex='" . esc\_attr($tabKey . "-" . $optKey) . "' class='wpd-opt-search-taboption'>" . esc\_html($val["label"]) . "</a>"; |
| [1120](#L1120) | } |
| [1121](#L1121) | } |
| [1122](#L1122) | } |
| [1123](#L1123) | } |
| [1124](#L1124) | } |
| [1125](#L1125) | } |
| [1126](#L1126) | $output = ""; |
| [1127](#L1127) | foreach ($result as $tabKey => $tabOptions) { |
| [1128](#L1128) | if (is\_array($tabOptions) && !empty($tabOptions)) { |
| [1129](#L1129) | foreach ($tabOptions as $tabOption) { |
| [1130](#L1130) | $output .= $tabOption; |
| [1131](#L1131) | } |
| [1132](#L1132) | } |
| [1133](#L1133) | } |
| [1134](#L1134) |  |
| [1135](#L1135) | wp\_die($output); |
| [1136](#L1136) | } |
| [1137](#L1137) | } |
| [1138](#L1138) |  |
| [1139](#L1139) | public function resetPostRating() |
| [1140](#L1140) | { |
| [1141](#L1141) | check\_ajax\_referer("wpd-reset-rating", "security"); |
| [1142](#L1142) | $postId = WpdiscuzHelper::sanitize(INPUT\_POST, "postId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [1143](#L1143) | if ($postId) { |
| [1144](#L1144) | if (current\_user\_can("edit\_post", $postId)) { |
| [1145](#L1145) | delete\_post\_meta($postId, self::POSTMETA\_POST\_RATING); |
| [1146](#L1146) | delete\_post\_meta($postId, self::POSTMETA\_POST\_RATING\_COUNT); |
| [1147](#L1147) | $this->dbManager->removeRatings($postId); |
| [1148](#L1148) | do\_action("wpdiscuz\_clean\_post\_cache", $postId, "ratings\_reset"); |
| [1149](#L1149) | wp\_send\_json\_success(); |
| [1150](#L1150) | } |
| [1151](#L1151) | } |
| [1152](#L1152) | wp\_send\_json\_error(); |
| [1153](#L1153) | } |
| [1154](#L1154) |  |
| [1155](#L1155) | public function resetFieldsRatings() |
| [1156](#L1156) | { |
| [1157](#L1157) | check\_ajax\_referer("wpd-reset-rating", "security"); |
| [1158](#L1158) | $postId = WpdiscuzHelper::sanitize(INPUT\_POST, "postId", FILTER\_SANITIZE\_NUMBER\_INT, 0); |
| [1159](#L1159) | if ($postId) { |
| [1160](#L1160) | if (current\_user\_can("edit\_post", $postId)) { |
| [1161](#L1161) | $postMeta = get\_post\_meta($postId, self::POSTMETA\_RATING\_COUNT, true); |
| [1162](#L1162) | if ($postMeta) { |
| [1163](#L1163) | foreach ($postMeta as $key => $value) { |
| [1164](#L1164) | $this->dbManager->deleteCommentMeta($key); |
| [1165](#L1165) | update\_post\_meta($postId, self::POSTMETA\_RATING\_SEPARATE\_AVG . $key, 0); |
| [1166](#L1166) | update\_post\_meta($postId, self::POSTMETA\_RATING\_SEPARATE\_COUNT . $key, 0); |
| [1167](#L1167) | } |
| [1168](#L1168) | update\_post\_meta($postId, self::POSTMETA\_RATING\_COUNT, []); |
| [1169](#L1169) | } |
| [1170](#L1170) | wp\_send\_json\_success(); |
| [1171](#L1171) | } |
| [1172](#L1172) | } |
| [1173](#L1173) | wp\_send\_json\_error(); |
| [1174](#L1174) | } |
| [1175](#L1175) |  |
| [1176](#L1176) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wpdiscuz/trunk/utils/class.WpdiscuzHelperAjax.php?format=txt)
* [Original Format](/export/3222700/wpdiscuz/trunk/utils/class.WpdiscuzHelperAjax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


