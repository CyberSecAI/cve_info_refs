=== Content from plugins.trac.wordpress.org_c765dc2c_20250114_203707.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Finstawp-connect%2Ftags%2F0.0.9.18%2Fincludes%2Fclass-instawp-rest-apis.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/instawp-connect/tags/0.0.9.18/includes/class-instawp-rest-apis.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/instawp-connect/tags/0.0.9.18/includes/class-instawp-rest-apis.php)

---

# [source:](/browser?order=name "Go to repository root") [instawp-connect](/browser/instawp-connect?order=name "View instawp-connect")/[tags](/browser/instawp-connect/tags?order=name "View tags")/[0.0.9.18](/browser/instawp-connect/tags/0.0.9.18?order=name "View 0.0.9.18")/[includes](/browser/instawp-connect/tags/0.0.9.18/includes?order=name "View includes")/[class-instawp-rest-apis.php](/browser/instawp-connect/tags/0.0.9.18/includes/class-instawp-rest-apis.php?order=name "View class-instawp-rest-apis.php")

View diff against:

View revision:

| [Last change](/changeset/2940719/instawp-connect/tags/0.0.9.18/includes/class-instawp-rest-apis.php "View differences") on this file was [2940719](/changeset/2940719/ "View changeset 2940719"), checked in by instawp, [18 months ago](/timeline?from=2023-07-20T09%3A13%3A12Z&precision=second "See timeline at 07/20/2023 09:13:12 AM") |
| --- |
| Update to version 0.0.9.18 from GitHub |
| **File size:** 54.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* |
| [4](#L4) | \* @link       https://instawp.com/ |
| [5](#L5) | \* @since      1.0 |
| [6](#L6) | \* |
| [7](#L7) | \* @package    instawp |
| [8](#L8) | \* @subpackage instawp/includes |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | /\*\* |
| [12](#L12) | \* |
| [13](#L13) | \* @since      1.0 |
| [14](#L14) | \* @package    instawp |
| [15](#L15) | \* @subpackage instawp/includes |
| [16](#L16) | \* @author     instawp team |
| [17](#L17) | \*/ |
| [18](#L18) |  |
| [19](#L19) | if ( ! defined('INSTAWP\_PLUGIN\_DIR') ) { |
| [20](#L20) | die; |
| [21](#L21) | } |
| [22](#L22) |  |
| [23](#L23) | require\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-db.php'; |
| [24](#L24) |  |
| [25](#L25) | class InstaWP\_Rest\_Apis{ |
| [26](#L26) |  |
| [27](#L27) | private $wpdb; |
| [28](#L28) |  |
| [29](#L29) | private $InstaWP\_db; |
| [30](#L30) |  |
| [31](#L31) | private $tables; |
| [32](#L32) |  |
| [33](#L33) | public function \_\_construct(){ |
| [34](#L34) | global $wpdb; |
| [35](#L35) |  |
| [36](#L36) | $this->wpdb = $wpdb; |
| [37](#L37) |  |
| [38](#L38) | $this->InstaWP\_db = new InstaWP\_DB(); |
| [39](#L39) |  |
| [40](#L40) | $this->tables = $this->InstaWP\_db->tables; |
| [41](#L41) |  |
| [42](#L42) | /\* |
| [43](#L43) | \* Initiate Sync |
| [44](#L44) | \* Endpoint : /wp-json/instawp-connect/v1/sync |
| [45](#L45) | \* HOOK - rest\_api\_init |
| [46](#L46) | \*/ |
| [47](#L47) |  |
| [48](#L48) | add\_action( 'rest\_api\_init', function () { |
| [49](#L49) | register\_rest\_route( 'instawp-connect/v1', '/sync', |
| [50](#L50) | array( |
| [51](#L51) | 'methods' => 'POST', |
| [52](#L52) | 'callback' => [$this, 'events\_receiver'], |
| [53](#L53) | 'permission\_callback' => [$this, 'check\_permission'], |
| [54](#L54) | ) ); |
| [55](#L55) | } ); |
| [56](#L56) | } |
| [57](#L57) |  |
| [58](#L58) | function check\_permission(){ |
| [59](#L59) | return true; |
| [60](#L60) | } |
| [61](#L61) |  |
| [62](#L62) | public function get\_post\_by\_reference\_Id($post\_type, $reference\_id, $post\_name) { |
| [63](#L63) | $post = get\_posts( array( |
| [64](#L64) | 'post\_type'=> $post\_type, |
| [65](#L65) | 'meta\_key'   => 'instawp\_event\_sync\_reference\_id', |
| [66](#L66) | 'meta\_value' => $reference\_id |
| [67](#L67) | ) ); |
| [68](#L68) | if(!empty($post)){ |
| [69](#L69) | $post = $post[0]; |
| [70](#L70) | }else { |
| [71](#L71) | $post  = instawp\_get\_post\_by\_name($post\_name, $post\_type); |
| [72](#L72) | } |
| [73](#L73) | return $post; |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | public function create\_or\_update\_post($post, $post\_meta) { |
| [77](#L77) | $reference\_id = isset($post\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
| [78](#L78) | $destination\_post = $this->get\_post\_by\_reference\_Id($post['post\_type'], $reference\_id, $post['post\_name']); |
| [79](#L79) | unset($post['ID']); |
| [80](#L80) | if(!empty($destination\_post)){ |
| [81](#L81) | #The post exists,Then update |
| [82](#L82) | $post\_id = $post['ID'] = $destination\_post->ID; |
| [83](#L83) | //$post['post\_parent'] = $destination\_post->post\_parent; |
| [84](#L84) | $postData = $this->postData($post); |
| [85](#L85) | wp\_update\_post($postData); |
| [86](#L86) | #post meta |
| [87](#L87) | $this->add\_update\_postmeta($post\_meta, $destination\_post->ID); |
| [88](#L88) | }else{ |
| [89](#L89) | $postData = $this->postData($post); |
| [90](#L90) | #The post does not exist,Then insert |
| [91](#L91) | $post\_id = wp\_insert\_post($postData); |
| [92](#L92) | #post meta |
| [93](#L93) | $this->add\_update\_postmeta( $post\_meta, $post\_id ); |
| [94](#L94) | } |
| [95](#L95) | return $post\_id; |
| [96](#L96) | } |
| [97](#L97) |  |
| [98](#L98) | /\*\* |
| [99](#L99) | \* Reciver |
| [100](#L100) | \* @param array $data Options for the function. |
| [101](#L101) | \* @return string|null |
| [102](#L102) | \*/ |
| [103](#L103) | public function events\_receiver($req) { |
| [104](#L104) | // error\_reporting(E\_ALL); |
| [105](#L105) | // ini\_set('display\_errors', 1); |
| [106](#L106) | $body = $req->get\_body(); |
| [107](#L107) | $bodyArr = json\_decode($body); |
| [108](#L108) | $encrypted\_contents = json\_decode($bodyArr->encrypted\_contents); |
| [109](#L109) | $sync\_id = $bodyArr->sync\_id; |
| [110](#L110) | $source\_connect\_id = $bodyArr->source\_connect\_id; |
| [111](#L111) | $is\_enabled = false; |
| [112](#L112) |  |
| [113](#L113) |  |
| [114](#L114) | if(get\_option('syncing\_enabled\_disabled')){ |
| [115](#L115) | $is\_enabled = true; |
| [116](#L116) | } |
| [117](#L117) |  |
| [118](#L118) | #forcely disable the syncing at the destination |
| [119](#L119) | update\_option('syncing\_enabled\_disabled', 0); |
| [120](#L120) |  |
| [121](#L121) | if(!empty($encrypted\_contents) && is\_array($encrypted\_contents)){ |
| [122](#L122) | $total\_op = count($encrypted\_contents); |
| [123](#L123) | $count = 1; |
| [124](#L124) | $progress\_status = 'pending'; |
| [125](#L125) | $changes = $sync\_response = []; |
| [126](#L126) | foreach($encrypted\_contents as $v){ |
| [127](#L127) |  |
| [128](#L128) | $source\_id = (isset($v->source\_id) && !empty($v->source\_id)) ? intval($v->source\_id) : null; |
| [129](#L129) |  |
| [130](#L130) | /\* |
| [131](#L131) | \*Post Oprations |
| [132](#L132) | \*/ |
| [133](#L133) | //create and update |
| [134](#L134) | if(isset($v->event\_slug) && ($v->event\_slug == 'post\_change' ||$v->event\_slug == 'post\_new') ){ |
| [135](#L135) | $posts = isset($v->details->posts) ? (array) $v->details->posts : ''; |
| [136](#L136) | $postmeta = isset($v->details->postmeta) ? (array) $v->details->postmeta : ''; |
| [137](#L137) | $featured\_image = isset($v->details->featured\_image) ? (array) $v->details->featured\_image : ''; |
| [138](#L138) | $media = isset($v->details->media) ? (array) $v->details->media : ''; |
| [139](#L139) |  |
| [140](#L140) | $parent\_post = isset($v->details->parent->post) ? (array) $v->details->parent->post : []; |
| [141](#L141) |  |
| [142](#L142) | #check for the post parent |
| [143](#L143) | if(!empty($parent\_post)){ |
| [144](#L144) | $parent\_post\_meta = isset($v->details->parent->post\_meta) ? (array) $v->details->parent->post\_meta : []; |
| [145](#L145) | $reference\_id = isset($parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
| [146](#L146) | $destination\_post = $this->get\_post\_by\_reference\_Id($parent\_post['post\_type'], $reference\_id, $parent\_post['post\_name']); |
| [147](#L147) | if(!empty($destination\_post)){ |
| [148](#L148) | $posts['post\_parent'] = $destination\_post->ID; |
| [149](#L149) | } |
| [150](#L150) | } |
| [151](#L151) |  |
| [152](#L152) | if($posts['post\_type'] == 'attachment'){ |
| [153](#L153) | //create or update the attachments |
| [154](#L154) | $posts['ID'] = $this->handle\_attachments($posts, $postmeta, $posts['guid']); |
| [155](#L155) | #update meta |
| [156](#L156) | $this->add\_update\_postmeta($postmeta,$posts['ID']); |
| [157](#L157) | }else{ |
| [158](#L158) | $posts['ID'] = $this->create\_or\_update\_post($posts, $postmeta); |
| [159](#L159) | } |
| [160](#L160) |  |
| [161](#L161) | #feature image import |
| [162](#L162) | if(isset($featured\_image['media']) && !empty($featured\_image['media'])){ |
| [163](#L163) | $att\_id = $this->handle\_attachments((array) $featured\_image['media'],(array) $featured\_image['media\_meta'], $featured\_image['featured\_image\_url']); |
| [164](#L164) | if(isset($att\_id) && !empty($att\_id)){ |
| [165](#L165) | set\_post\_thumbnail($posts['ID'],$att\_id); |
| [166](#L166) | } |
| [167](#L167) | } |
| [168](#L168) |  |
| [169](#L169) | #if post type is product then set gallery |
| [170](#L170) | if(get\_post\_type($posts['ID']) == 'product'){ |
| [171](#L171) | if(isset($v->details->product\_gallery) && !empty($v->details->product\_gallery)){ |
| [172](#L172) | $product\_gallery = $v->details->product\_gallery; |
| [173](#L173) | $gallery\_ids = []; |
| [174](#L174) | //pr($product\_gallery); |
| [175](#L175) | foreach($product\_gallery as $gallery){ |
| [176](#L176) | if(isset($gallery->media) && !empty($gallery->media) && isset($gallery->url) && $gallery->url !=''){ |
| [177](#L177) | $gallery\_ids[] = $this->handle\_attachments((array) $gallery->media,(array) $gallery->media\_meta, $gallery->url); |
| [178](#L178) | } |
| [179](#L179) | } |
| [180](#L180) | $this->set\_product\_gallery($posts['ID'],$gallery\_ids); |
| [181](#L181) | } |
| [182](#L182) | } |
| [183](#L183) |  |
| [184](#L184) | #terms in post |
| [185](#L185) | $taxonomies = (array) $v->details->taxonomies; |
| [186](#L186) | $this->reset\_post\_terms( $posts['ID']); //rest the terms for all taxo |
| [187](#L187) | if(!empty($taxonomies) && is\_array($taxonomies)){ |
| [188](#L188) | foreach($taxonomies as $taxonomy => $terms){ |
| [189](#L189) | $terms = (array) $terms; |
| [190](#L190) | $term\_ids = []; |
| [191](#L191) | # if term not exist then create first |
| [192](#L192) | if(!empty($terms) && is\_array($terms)){ |
| [193](#L193) | foreach($terms as $term){ |
| [194](#L194) | $term = (array) $term; |
| [195](#L195) | if(!term\_exists($term['slug'],$taxonomy)){ |
| [196](#L196) | $inserted\_term = wp\_insert\_term( |
| [197](#L197) | $term['name'],   // the term |
| [198](#L198) | $taxonomy, // the taxonomy |
| [199](#L199) | array( |
| [200](#L200) | 'description' => $term['description'], |
| [201](#L201) | 'slug'        => $term['slug'], |
| [202](#L202) | 'parent'      => 0 |
| [203](#L203) | ) |
| [204](#L204) | ); |
| [205](#L205) | $term\_ids[] = $inserted\_term['term\_id']; |
| [206](#L206) | }else{ |
| [207](#L207) | $get\_term\_by =(array) get\_term\_by('slug',$term['slug'] , $taxonomy); |
| [208](#L208) | $term\_ids[] = $get\_term\_by['term\_id']; |
| [209](#L209) | } |
| [210](#L210) | } |
| [211](#L211) | } |
| [212](#L212) | #set terms in post |
| [213](#L213) | wp\_set\_post\_terms( $posts['ID'], $term\_ids, $taxonomy ); |
| [214](#L214) | } |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | # media upload from content |
| [218](#L218) | $this->upload\_content\_media($media,$posts['ID']); |
| [219](#L219) |  |
| [220](#L220) | #message |
| [221](#L221) | $message = 'Sync successfully.'; |
| [222](#L222) | $status = 'completed'; |
| [223](#L223) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [224](#L224) | #changes |
| [225](#L225) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | //Post trash |
| [229](#L229) | if(isset($v->event\_slug) && $v->event\_slug == 'post\_trash'){ |
| [230](#L230) | if(isset($source\_id)){ |
| [231](#L231) | $posts = (array) $v->details->posts; |
| [232](#L232) | $postmeta = (array) $v->details->postmeta; |
| [233](#L233) | $post\_by\_reference\_id = get\_posts( array( |
| [234](#L234) | 'post\_type'=> $posts['post\_type'], |
| [235](#L235) | 'meta\_key'   => 'instawp\_event\_sync\_reference\_id', |
| [236](#L236) | 'meta\_value' => isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
| [237](#L237) | ) ); |
| [238](#L238) |  |
| [239](#L239) | if(!empty($post\_by\_reference\_id)){ |
| [240](#L240) | $post\_id = $post\_by\_reference\_id[0]->ID; |
| [241](#L241) | $rel = wp\_trash\_post($post\_id);  //Post data on success, false or null on failure. |
| [242](#L242) | $status = $this->sync\_post\_status($rel); |
| [243](#L243) | $message = $this->sync\_message($rel); |
| [244](#L244) | }else{ |
| [245](#L245) | $post\_check\_data = instawp\_get\_post\_by\_name(str\_replace('\_\_trashed','', $posts['post\_name']), $posts['post\_type']); |
| [246](#L246) | if(!empty($post\_check\_data)){ |
| [247](#L247) | $rel = wp\_trash\_post($post\_check\_data->ID);  //Post data on success, false or null on failure. |
| [248](#L248) | $status = $this->sync\_post\_status($rel); |
| [249](#L249) | $message = $this->sync\_message($rel); |
| [250](#L250) | }else{ |
| [251](#L251) | $status = 'pending'; |
| [252](#L252) | $message = $this->notExistMsg(); |
| [253](#L253) | } |
| [254](#L254) | } |
| [255](#L255) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [256](#L256) | #changes |
| [257](#L257) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [258](#L258) | } |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | //Post permanently delete |
| [262](#L262) | if(isset($v->event\_slug) && $v->event\_slug == 'post\_delete'){ |
| [263](#L263) | if(isset($source\_id)){ |
| [264](#L264) | $posts = (array) $v->details->posts; |
| [265](#L265) | $postmeta = (array) $v->details->postmeta; |
| [266](#L266) | $post\_by\_reference\_id = get\_posts([ |
| [267](#L267) | 'post\_status' => 'trash', |
| [268](#L268) | 'post\_type'   => $posts['post\_type'], |
| [269](#L269) | 'nopaging'    => TRUE, |
| [270](#L270) | 'meta\_query' => array( |
| [271](#L271) | array( |
| [272](#L272) | 'key'     => 'instawp\_event\_sync\_reference\_id', |
| [273](#L273) | 'value'   =>  isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
| [274](#L274) | 'compare' => '=', |
| [275](#L275) | ), |
| [276](#L276) | ), |
| [277](#L277) | ]); |
| [278](#L278) |  |
| [279](#L279) | if(!empty($post\_by\_reference\_id)){ |
| [280](#L280) | $post\_id = $post\_by\_reference\_id[0]->ID; |
| [281](#L281) | $rel = wp\_delete\_post($post\_id);  //Post data on success, false or null on failure. |
| [282](#L282) | $status = $this->sync\_post\_status($rel); |
| [283](#L283) | $message = $this->sync\_message($rel); |
| [284](#L284) | }else{ |
| [285](#L285) | $post\_check\_data = instawp\_get\_post\_by\_name($posts['post\_name'], $posts['post\_type']); |
| [286](#L286) | if(!empty($post\_check\_data)){ |
| [287](#L287) | $rel = wp\_delete\_post($post\_check\_data->ID);  //Post data on success, false or null on failure. |
| [288](#L288) | $status = $this->sync\_post\_status($rel); |
| [289](#L289) | $message = $this->sync\_message($rel); |
| [290](#L290) | }else{ |
| [291](#L291) | $status = 'pending'; |
| [292](#L292) | $message = $this->notExistMsg(); |
| [293](#L293) | } |
| [294](#L294) | } |
| [295](#L295) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [296](#L296) | #changes |
| [297](#L297) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [298](#L298) | } |
| [299](#L299) | } |
| [300](#L300) |  |
| [301](#L301) | //Post restored |
| [302](#L302) | if(isset($v->event\_slug) && $v->event\_slug == 'untrashed\_post'){ |
| [303](#L303) | if(isset($source\_id)){ |
| [304](#L304) | $posts = (array) $v->details->posts; |
| [305](#L305) | $postmeta = (array) $v->details->postmeta; |
| [306](#L306) | $post\_by\_reference\_id = get\_posts([ |
| [307](#L307) | 'post\_status' => 'trash', |
| [308](#L308) | 'post\_type'   => $posts['post\_type'], |
| [309](#L309) | 'nopaging'    => TRUE, |
| [310](#L310) | 'meta\_query' => array( |
| [311](#L311) | array( |
| [312](#L312) | 'key'     => 'instawp\_event\_sync\_reference\_id', |
| [313](#L313) | 'value'   =>  isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
| [314](#L314) | 'compare' => '=', |
| [315](#L315) | ), |
| [316](#L316) | ), |
| [317](#L317) | ]); |
| [318](#L318) |  |
| [319](#L319) |  |
| [320](#L320) | if(!empty($post\_by\_reference\_id)){ |
| [321](#L321) | $post\_id = $post\_by\_reference\_id[0]->ID; |
| [322](#L322) | $rel = wp\_untrash\_post($post\_id); |
| [323](#L323) | $status = $this->sync\_post\_status($rel); |
| [324](#L324) | $message = $this->sync\_message($rel); |
| [325](#L325) | }else{ |
| [326](#L326) | $post\_check\_data = instawp\_get\_post\_by\_name($posts['post\_name'].'\_\_trashed', $posts['post\_type']); |
| [327](#L327) | if(!empty($post\_check\_data)){ |
| [328](#L328) | $rel = wp\_untrash\_post($post\_check\_data->ID); |
| [329](#L329) | $status = $this->sync\_post\_status($rel); |
| [330](#L330) | $message = $this->sync\_message($rel); |
| [331](#L331) | }else{ |
| [332](#L332) | $status = 'pending'; |
| [333](#L333) | $message = $this->notExistMsg(); |
| [334](#L334) | } |
| [335](#L335) | } |
| [336](#L336) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [337](#L337) | #changes |
| [338](#L338) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | /\* |
| [343](#L343) | \*Plugin Oprations |
| [344](#L344) | \*/ |
| [345](#L345) | //Plugin actiavte |
| [346](#L346) | if(isset($v->details) && $v->event\_slug == 'activate\_plugin'){ |
| [347](#L347) | $check\_plugin\_installed = $this->check\_plugin\_installed($v->details); |
| [348](#L348) | if($check\_plugin\_installed != 1){ |
| [349](#L349) | $pluginData = get\_plugin\_data($v->details); |
| [350](#L350) | if(!empty($pluginData['TextDomain'])){ |
| [351](#L351) | $this->plugin\_install($pluginData['TextDomain']); |
| [352](#L352) | } |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | $this->plugin\_activation($v->details); |
| [356](#L356) | #message |
| [357](#L357) | $message = 'Sync successfully.'; |
| [358](#L358) | $status = 'completed'; |
| [359](#L359) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [360](#L360) | #changes |
| [361](#L361) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | //Plugin deactiavte |
| [365](#L365) | if(isset($v->event\_slug) && $v->event\_slug == 'deactivate\_plugin'){ |
| [366](#L366) | $this->plugin\_deactivation($v->details); |
| [367](#L367) | #message |
| [368](#L368) | $message = 'Sync successfully.'; |
| [369](#L369) | $status = 'completed'; |
| [370](#L370) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [371](#L371) | #changes |
| [372](#L372) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | /\* |
| [376](#L376) | \* Taxonomy Oprations |
| [377](#L377) | \*/ |
| [378](#L378) |  |
| [379](#L379) | //create and update |
| [380](#L380) | if(isset($v->event\_slug) && ($v->event\_slug == 'create\_taxonomy' || $v->event\_slug == 'edit\_taxonomy')){ |
| [381](#L381) | if(isset($source\_id)){ |
| [382](#L382) | $details = (array) $v->details; |
| [383](#L383) | $wp\_terms = $this->wp\_terms\_data($source\_id,$details); |
| [384](#L384) | $wp\_term\_taxonomy = $this->wp\_term\_taxonomy\_data($source\_id,$details); |
| [385](#L385) | if(!term\_exists($source\_id,$v->event\_type)){ |
| [386](#L386) | if($v->event\_slug == 'create\_taxonomy'){ |
| [387](#L387) | $this->insert\_taxonomy($source\_id,$wp\_terms,$wp\_term\_taxonomy); |
| [388](#L388) | clean\_term\_cache($source\_id); |
| [389](#L389) | } |
| [390](#L390) | } |
| [391](#L391) | if(term\_exists($source\_id,$v->event\_type)){ |
| [392](#L392) | if($v->event\_slug == 'edit\_taxonomy'){ |
| [393](#L393) | $this->update\_taxonomy($source\_id,$wp\_terms,$wp\_term\_taxonomy); |
| [394](#L394) | } |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | #message |
| [398](#L398) | $message = 'Sync successfully.'; |
| [399](#L399) | $status = 'completed'; |
| [400](#L400) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [401](#L401) | #changes |
| [402](#L402) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [403](#L403) |  |
| [404](#L404) | } |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | //Delete |
| [408](#L408) | if(isset($v->event\_slug) && $v->event\_slug == 'delete\_taxonomy'){ |
| [409](#L409) | if(isset($source\_id)){ |
| [410](#L410) | if(term\_exists($source\_id,$v->event\_type)){ |
| [411](#L411) | $rel = wp\_delete\_term($source\_id,$v->event\_type); |
| [412](#L412) | $status = $this->sync\_post\_status($rel); |
| [413](#L413) | $message = $this->sync\_message($rel); |
| [414](#L414) | } |
| [415](#L415) | }else{ |
| [416](#L416) | $status = 'pending'; |
| [417](#L417) | $message = $this->notExistMsg(); |
| [418](#L418) | } |
| [419](#L419) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [420](#L420) | #changes |
| [421](#L421) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Customizer settings update |
| [426](#L426) | \*/ |
| [427](#L427) |  |
| [428](#L428) | if(isset($v->event\_slug) && $v->event\_slug == 'customizer\_changes'){ |
| [429](#L429) | $details = isset($v->details) ? $v->details : ''; |
| [430](#L430) |  |
| [431](#L431) | #custom logo |
| [432](#L432) | $this->customizer\_custom\_logo($details->custom\_logo); |
| [433](#L433) |  |
| [434](#L434) | #background image |
| [435](#L435) | $this->customizer\_background\_image($details->background\_image); |
| [436](#L436) |  |
| [437](#L437) | #site icon |
| [438](#L438) | $this->customizer\_site\_icon($details->site\_icon); |
| [439](#L439) |  |
| [440](#L440) | #background color |
| [441](#L441) | if(isset($details->background\_color) && !empty($details->background\_color)){ |
| [442](#L442) | set\_theme\_mod( 'background\_color', $details->background\_color ); |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | #Site Title |
| [446](#L446) | update\_option( 'blogname', $details->name ); |
| [447](#L447) |  |
| [448](#L448) | #Tagline |
| [449](#L449) | $this->blogDescription($details->description); |
| [450](#L450) |  |
| [451](#L451) | #Homepage Settings |
| [452](#L452) | if(isset($details->show\_on\_front) && !empty($details->show\_on\_front)){ |
| [453](#L453) | update\_option( 'show\_on\_front', $details->show\_on\_front ); |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | #for 'Astra' theme |
| [457](#L457) | if( isset($details->astra\_settings) && !empty($details->astra\_settings) ){ |
| [458](#L458) | $astra\_settings = $this->object\_to\_array($details->astra\_settings); |
| [459](#L459) | update\_option( 'astra-settings', $astra\_settings ); |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | #nav menu locations |
| [463](#L463) | if(!empty($details->nav\_menu\_locations)){ |
| [464](#L464) | $menu\_array = (array) $details->nav\_menu\_locations; |
| [465](#L465) | set\_theme\_mod( 'nav\_menu\_locations', $menu\_array ); |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | #Custom css post id |
| [469](#L469) | $custom\_css\_post = (array) $details->custom\_css\_post; |
| [470](#L470) | if(!empty($details->custom\_css\_post)){ |
| [471](#L471) | if (get\_post\_status($custom\_css\_post['ID']) ) { |
| [472](#L472) | #The post exists,Then update |
| [473](#L473) | $postData = $this->postData($custom\_css\_post,'update'); |
| [474](#L474) | wp\_update\_post($postData); |
| [475](#L475) |  |
| [476](#L476) | } else { |
| [477](#L477) | $postData = $this->postData($custom\_css\_post,'insert'); |
| [478](#L478) | #The post does not exist,Then insert |
| [479](#L479) | wp\_insert\_post($postData); |
| [480](#L480) | } |
| [481](#L481) | set\_theme\_mod( 'custom\_css\_post\_id', $custom\_css\_post['ID'] ); |
| [482](#L482) | } |
| [483](#L483) | $current\_theme = wp\_get\_theme(); |
| [484](#L484) | if($current\_theme->Name == 'Astra'){ #for 'Astra' theme |
| [485](#L485) | $astra\_theme\_setting = isset($details->astra\_theme\_customizer\_settings) ? (array) $details->astra\_theme\_customizer\_settings : ''; |
| [486](#L486) | $this->setAstraCostmizerSetings($astra\_theme\_setting); |
| [487](#L487) | }else if($current\_theme->Name == 'Divi'){  #for 'Divi' theme |
| [488](#L488) | $divi\_settings = isset($details->divi\_settings) ? (array) $details->divi\_settings : ''; |
| [489](#L489) | if(!empty($divi\_settings) &&  is\_array($divi\_settings)){ |
| [490](#L490) | update\_option('et\_divi',$divi\_settings); |
| [491](#L491) | } |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | #message |
| [495](#L495) | $message = 'Sync successfully.'; |
| [496](#L496) | $status = 'completed'; |
| [497](#L497) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [498](#L498) | #changes |
| [499](#L499) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | /\*\* |
| [503](#L503) | \* Woocommerce attributes |
| [504](#L504) | \*/ |
| [505](#L505) |  |
| [506](#L506) | #create&upadte woocommerce attribute |
| [507](#L507) | if(isset($v->event\_slug) && ($v->event\_slug == 'woocommerce\_attribute\_added' || $v->event\_slug == 'woocommerce\_attribute\_updated')){ |
| [508](#L508) | $details = isset($v->details) ? (array) $v->details : ''; |
| [509](#L509) | if(!empty($details)){ |
| [510](#L510) | $attribute = wc\_get\_attribute(208); |
| [511](#L511) | if(!empty($attribute)){ |
| [512](#L512) | unset($details['id']); |
| [513](#L513) | wc\_update\_attribute($v->source\_id,$attribute); |
| [514](#L514) |  |
| [515](#L515) | #message |
| [516](#L516) | $message = 'Sync successfully.'; |
| [517](#L517) | $status = 'completed'; |
| [518](#L518) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [519](#L519) | #changes |
| [520](#L520) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [521](#L521) | }else{ |
| [522](#L522) | $this->woocommerce\_create\_attribute($v->source\_id,$details); |
| [523](#L523) |  |
| [524](#L524) | #message |
| [525](#L525) | $message = 'Sync successfully.'; |
| [526](#L526) | $status = 'completed'; |
| [527](#L527) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [528](#L528) | #changes |
| [529](#L529) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [530](#L530) |  |
| [531](#L531) | } |
| [532](#L532) | } |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | if(isset($v->event\_slug) && $v->event\_slug == 'woocommerce\_attribute\_deleted'){ |
| [536](#L536) | wc\_delete\_attribute($v->source\_id); |
| [537](#L537) | #message |
| [538](#L538) | $message = 'Sync successfully.'; |
| [539](#L539) | $status = 'completed'; |
| [540](#L540) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [541](#L541) | #changes |
| [542](#L542) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | /\*\* |
| [546](#L546) | \* Users actions |
| [547](#L547) | \*/ |
| [548](#L548) | if(isset($v->event\_type) && $v->event\_type == 'users'){ |
| [549](#L549) | $user\_data = isset($v->details->user\_data) ? (array) $v->details->user\_data : ''; |
| [550](#L550) | $user\_meta = isset($v->details->user\_meta) ? (array) $v->details->user\_meta : ''; |
| [551](#L551) | //$user = get\_userdata($v->source\_id); |
| [552](#L552) | $user\_table = $this->wpdb->prefix.'users'; |
| [553](#L553) |  |
| [554](#L554) | $get\_user\_by\_reference\_id = get\_users(array( |
| [555](#L555) | 'meta\_key' => 'instawp\_event\_user\_sync\_reference\_id', |
| [556](#L556) | 'meta\_value' => isset($user\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $user\_meta['instawp\_event\_sync\_reference\_id'][0] : '', |
| [557](#L557) | )); |
| [558](#L558) |  |
| [559](#L559) | $user =  !empty($get\_user\_by\_reference\_id) ? $get\_user\_by\_reference\_id[0] : get\_user\_by('email', $user\_data['email']); |
| [560](#L560) |  |
| [561](#L561) | //Create user if not exits |
| [562](#L562) | if( isset($v->event\_slug) && ($v->event\_slug == 'user\_register') ){ |
| [563](#L563) | if(!$user){ |
| [564](#L564) | unset($user\_data['ID']); |
| [565](#L565) | array\_merge($user\_data, ['role'=>$v->details->role ]); |
| [566](#L566) | $user = wp\_insert\_user($user\_data); |
| [567](#L567) | $this->add\_update\_usermeta($user\_meta,$v->source\_id); |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | //Update user |
| [572](#L572) | if( isset($v->event\_slug) && ($v->event\_slug == 'profile\_update') ){ |
| [573](#L573) | $this->InstaWP\_db->update($user\_table,$user\_data,array( 'ID' => $v->source\_id )); |
| [574](#L574) | $this->add\_update\_usermeta($user\_meta,$v->source\_id); |
| [575](#L575) | $user->add\_role( $v->details->role ); |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | //Delete user |
| [579](#L579) | if( isset($v->event\_slug) && ($v->event\_slug == 'delete\_user') ){ |
| [580](#L580) | if(isset($user->data->user\_email)){ |
| [581](#L581) | if($user->data->user\_email == $user\_data['data']->user\_email){ |
| [582](#L582) | wp\_delete\_user($v->source\_id); |
| [583](#L583) | } |
| [584](#L584) | } |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | #message |
| [588](#L588) | $message = 'Sync successfully.'; |
| [589](#L589) | $status = 'completed'; |
| [590](#L590) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [591](#L591) | #changes |
| [592](#L592) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | /\* |
| [596](#L596) | \* widget |
| [597](#L597) | \*/ |
| [598](#L598) | if(isset($v->event\_type) && $v->event\_type == 'widget'){ |
| [599](#L599) | $widget\_block = (array) $v->details->widget\_block; |
| [600](#L600) | $appp = (array) $v->details; |
| [601](#L601) | $dataIns = [ |
| [602](#L602) | 'data' => json\_encode($appp) |
| [603](#L603) | ]; |
| [604](#L604) | $this->InstaWP\_db->insert('wp\_testing',$dataIns); |
| [605](#L605) |  |
| [606](#L606) | $widget\_block\_arr = []; |
| [607](#L607) | foreach($widget\_block as $widget\_key => $widget\_val){ |
| [608](#L608) | if($widget\_key == '\_multiwidget'){ |
| [609](#L609) | $widget\_block\_arr[$widget\_key] = $widget\_val; |
| [610](#L610) | }else{ |
| [611](#L611) | $widget\_val\_arr = (array) $widget\_val; |
| [612](#L612) | $widget\_block\_arr[$widget\_key] = ['content' => $widget\_val\_arr['content']]; |
| [613](#L613) | } |
| [614](#L614) | } |
| [615](#L615) | update\_option('widget\_block',$widget\_block\_arr); |
| [616](#L616) | #message |
| [617](#L617) | $message = 'Sync successfully.'; |
| [618](#L618) | $status = 'completed'; |
| [619](#L619) | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
| [620](#L620) | #changes |
| [621](#L621) | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
| [622](#L622) | } |
| [623](#L623) | /\* |
| [624](#L624) | \* Update api for cloud |
| [625](#L625) | \*/ |
| [626](#L626) | $progress = intval($count/$total\_op \* 100); |
| [627](#L627) | $progress\_status = ($progress > 100 ) ?  'in\_progress': 'completed'; |
| [628](#L628) | #Sync update |
| [629](#L629) | $syncUpdate = [ |
| [630](#L630) | 'progress' => $progress, |
| [631](#L631) | 'status' => $progress\_status, |
| [632](#L632) | 'message' => $message, |
| [633](#L633) | 'changes' => ['changes' => $changes,'sync\_response' => $sync\_response], |
| [634](#L634) | ]; |
| [635](#L635) | $this->sync\_update($sync\_id,$syncUpdate,$source\_connect\_id); |
| [636](#L636) | $count++; |
| [637](#L637) | } |
| [638](#L638) | } |
| [639](#L639) |  |
| [640](#L640) | #Sync history save |
| [641](#L641) | $this->sync\_history\_save($body,$changes,'Complete'); |
| [642](#L642) |  |
| [643](#L643) | #enable is back if syncing already enabled at the destination |
| [644](#L644) | if($is\_enabled){ |
| [645](#L645) | update\_option('syncing\_enabled\_disabled', 1); |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | return new WP\_REST\_Response( |
| [649](#L649) | array( |
| [650](#L650) | 'encrypted\_contents' => $encrypted\_contents, |
| [651](#L651) | 'source\_connect\_id' => $source\_connect\_id, |
| [652](#L652) | 'changes' => ['changes' => $changes,'sync\_response' => $sync\_response], |
| [653](#L653) | 'sync\_id' => $sync\_id |
| [654](#L654) | ) |
| [655](#L655) | ); |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | /\*\* |
| [659](#L659) | \* This function is for upload media which are coming form widgets. |
| [660](#L660) | \*/ |
| [661](#L661) | public function upload\_widgets\_media($media = null, $content = null){ |
| [662](#L662) | $media = json\_decode(reset($media)); |
| [663](#L663) | $new = $old = []; |
| [664](#L664) | $newContent = ''; |
| [665](#L665) | if(!empty($media)){ |
| [666](#L666) | foreach($media as $v){ |
| [667](#L667) | $v = (array) $v; |
| [668](#L668) | if(isset($v['attachment\_id']) && isset($v['attachment\_url'])){ |
| [669](#L669) | $attachment\_id = $this->insert\_attachment($v['attachment\_id'],$v['attachment\_url']); |
| [670](#L670) | $new[] = wp\_get\_attachment\_url($attachment\_id); |
| [671](#L671) | $old[] = $v['attachment\_url']; |
| [672](#L672) | } |
| [673](#L673) | } |
| [674](#L674) | $newContent = str\_replace($old, $new, $content); #str\_replace(old,new,str) |
| [675](#L675) | } |
| [676](#L676) | return $newContent; |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | public function user\_id\_exists($user\_id){ |
| [680](#L680) | $table\_name = $this->wpdb->prefix.'users'; |
| [681](#L681) | $count = $this->wpdb->get\_var($this->wpdb->prepare("SELECT COUNT(\*) FROM $table\_name WHERE ID = %d",$user\_id)); |
| [682](#L682) | if($count == 1){ return true; }else{ return false; } |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | public function blogDescription($v = null){ |
| [686](#L686) | $this->wpdb->update($this->wpdb->prefix.'options',['option\_value' => $v],array( 'option\_name' => 'blogdescription' )); |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) | /\*\* |
| [690](#L690) | \* object to array conversation |
| [691](#L691) | \*/ |
| [692](#L692) | public function object\_to\_array($data) { |
| [693](#L693) | if ((! is\_array($data)) and (! is\_object($data))){ |
| [694](#L694) | return; |
| [695](#L695) | } |
| [696](#L696) | $result = array(); |
| [697](#L697) | $data = (array) $data; |
| [698](#L698) | foreach ($data as $key => $value) { |
| [699](#L699) | if (is\_object($value)) |
| [700](#L700) | $value = (array) $value; |
| [701](#L701) | if (is\_array($value)) |
| [702](#L702) | $result[$key] = $this->object\_to\_array($value); |
| [703](#L703) | else |
| [704](#L704) | $result[$key] = $value; |
| [705](#L705) | } |
| [706](#L706) | return $result; |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | /\*\* |
| [710](#L710) | \* Create woocommerce attribute |
| [711](#L711) | \*/ |
| [712](#L712) | public function woocommerce\_create\_attribute($source\_id,$data = null){ |
| [713](#L713) | $format = array( '%s', '%s', '%s', '%s', '%d' ); |
| [714](#L714) | $data['attribute\_id'] = intval($source\_id); |
| [715](#L715) | $results = $this->wpdb->insert( |
| [716](#L716) | $this->wpdb->prefix . 'woocommerce\_attribute\_taxonomies', |
| [717](#L717) | $data, |
| [718](#L718) | $format |
| [719](#L719) | ); |
| [720](#L720) |  |
| [721](#L721) | if ( is\_wp\_error( $results ) ) { |
| [722](#L722) | return new WP\_Error( 'cannot\_create\_attribute', 'Can not create attribute!', array( 'status' => 400 ) ); |
| [723](#L723) | } |
| [724](#L724) | $id = $this->wpdb->insert\_id; |
| [725](#L725) | /\*\* |
| [726](#L726) | \* Attribute added. |
| [727](#L727) | \* |
| [728](#L728) | \* @param int   $id   Added attribute ID. |
| [729](#L729) | \* @param array $data Attribute data. |
| [730](#L730) | \*/ |
| [731](#L731) | do\_action( 'woocommerce\_attribute\_added', $id, $data ); |
| [732](#L732) | // Clear cache and flush rewrite rules. |
| [733](#L733) | wp\_schedule\_single\_event( time(), 'woocommerce\_flush\_rewrite\_rules' ); |
| [734](#L734) | delete\_transient( 'wc\_attribute\_taxonomies' ); |
| [735](#L735) | WC\_Cache\_Helper::invalidate\_cache\_group( 'woocommerce-attributes' ); |
| [736](#L736) | } |
| [737](#L737) |  |
| [738](#L738) | /\*\* |
| [739](#L739) | \* Set product gallery |
| [740](#L740) | \*/ |
| [741](#L741) | public function set\_product\_gallery($product\_id = null, $gallery\_ids = null){ |
| [742](#L742) | $product = new WC\_product($product\_id); |
| [743](#L743) | $product->set\_gallery\_image\_ids( $gallery\_ids ); |
| [744](#L744) | $product->save(); |
| [745](#L745) | } |
| [746](#L746) |  |
| [747](#L747) | public function customizer\_site\_icon($data = null){ |
| [748](#L748) | $attachment\_id = $data->id; |
| [749](#L749) | $url = $data->url; |
| [750](#L750) | if(isset($attachment\_id) && !empty($attachment\_id)){ |
| [751](#L751) | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
| [752](#L752) | if(!empty($attUrl)){ |
| [753](#L753) | update\_option('site\_icon',$attachment\_id); |
| [754](#L754) | }else{ |
| [755](#L755) | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
| [756](#L756) | update\_option('site\_icon',$attachment\_id); |
| [757](#L757) | } |
| [758](#L758) | }else{ |
| [759](#L759) | update\_option('site\_icon',$attachment\_id); |
| [760](#L760) | } |
| [761](#L761) | } |
| [762](#L762) |  |
| [763](#L763) | public function customizer\_custom\_logo($data){ |
| [764](#L764) | $attachment\_id = $data->id; |
| [765](#L765) | $url = $data->url; |
| [766](#L766) | if(isset($attachment\_id) && !empty($attachment\_id)){ |
| [767](#L767) | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
| [768](#L768) | if(!empty($attUrl)){ |
| [769](#L769) | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
| [770](#L770) | }else{ |
| [771](#L771) | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
| [772](#L772) | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
| [773](#L773) | } |
| [774](#L774) | }else{ |
| [775](#L775) | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
| [776](#L776) | } |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) | public function customizer\_background\_image($data = null){ |
| [780](#L780) | $attachment\_id = $data->id; |
| [781](#L781) | $url = $data->url; |
| [782](#L782) | if(isset($attachment\_id) && !empty($attachment\_id)){ |
| [783](#L783) | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
| [784](#L784) | if(!empty($attUrl)){ |
| [785](#L785) | set\_theme\_mod( 'background\_image', $attUrl ); |
| [786](#L786) | }else{ |
| [787](#L787) | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
| [788](#L788) | $attachment\_url = wp\_get\_attachment\_url(intval($attachment\_id)); |
| [789](#L789) | set\_theme\_mod( 'background\_image', $attachment\_url ); |
| [790](#L790) | } |
| [791](#L791) | }else{ |
| [792](#L792) | set\_theme\_mod( 'background\_image', $url ); |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | if(isset($data->background\_preset) && !empty($data->background\_preset)){ |
| [796](#L796) | set\_theme\_mod( 'background\_preset', $data->background\_preset ); |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | if(isset($data->background\_size) && !empty($data->background\_size)){ |
| [800](#L800) | set\_theme\_mod( 'background\_size', $data->background\_size ); |
| [801](#L801) | } |
| [802](#L802) |  |
| [803](#L803) | if(isset($data->background\_repeat) && !empty($data->background\_repeat)){ |
| [804](#L804) | set\_theme\_mod( 'background\_repeat', $data->background\_repeat ); |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | if(isset($data->background\_attachment) && !empty($data->background\_attachment)){ |
| [808](#L808) | set\_theme\_mod( 'background\_attachment', $data->background\_attachment ); |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | if(isset($data->background\_position\_x) && !empty($data->background\_position\_x)){ |
| [812](#L812) | set\_theme\_mod( 'background\_position\_x', $data->background\_position\_x ); |
| [813](#L813) | } |
| [814](#L814) |  |
| [815](#L815) | if(isset($data->background\_position\_y) && !empty($data->background\_position\_y)){ |
| [816](#L816) | set\_theme\_mod( 'background\_position\_y', $data->background\_position\_y ); |
| [817](#L817) | } |
| [818](#L818) | } |
| [819](#L819) |  |
| [820](#L820) | /\*\* |
| [821](#L821) | \* This function is for upload media which are coming form content. |
| [822](#L822) | \*/ |
| [823](#L823) | public function upload\_content\_media($media = null, $post\_id = null){ |
| [824](#L824) | $media = json\_decode(reset($media)); |
| [825](#L825) | $post = get\_post($post\_id); |
| [826](#L826) | $content = $post->post\_content; |
| [827](#L827) | $new = $old = []; |
| [828](#L828) | if(!empty($media)){ |
| [829](#L829) | foreach($media as $v){ |
| [830](#L830) | $v = (array) $v; |
| [831](#L831) | if(isset($v['attachment\_id']) && isset($v['attachment\_url'])){ |
| [832](#L832) | $attachment\_id = $this->handle\_attachments((array) $v['attachment\_media'], (array) $v['attachment\_media\_meta'], $v['attachment\_url']); |
| [833](#L833) | $new[] = wp\_get\_attachment\_url($attachment\_id); |
| [834](#L834) | $old[] = $v['attachment\_url']; |
| [835](#L835) | } |
| [836](#L836) | } |
| [837](#L837) | $newContent = str\_replace($old, $new, $content); #str\_replace(old,new,str) |
| [838](#L838) | $arg = array( |
| [839](#L839) | 'ID'            => $post\_id, |
| [840](#L840) | 'post\_content'  => $newContent, |
| [841](#L841) | ); |
| [842](#L842) | wp\_update\_post( $arg ); |
| [843](#L843) | } |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | public function notExistMsg(){ |
| [847](#L847) | return "ID is not exists."; |
| [848](#L848) | } |
| [849](#L849) |  |
| [850](#L850) | public function wp\_terms\_data($term\_id = null, $arr = []){ |
| [851](#L851) | return [ |
| [852](#L852) | 'term\_id' => $term\_id, |
| [853](#L853) | 'name' => $arr['name'], |
| [854](#L854) | 'slug' => $arr['slug'] |
| [855](#L855) | ]; |
| [856](#L856) | } |
| [857](#L857) | public function wp\_term\_taxonomy\_data($term\_id = null, $arr = []){ |
| [858](#L858) | return [ |
| [859](#L859) | 'term\_taxonomy\_id' => $term\_id, |
| [860](#L860) | 'term\_id' => $term\_id, |
| [861](#L861) | 'taxonomy' => $arr['taxonomy'], |
| [862](#L862) | 'description' => $arr['description'], |
| [863](#L863) | 'parent' => $arr['parent'] |
| [864](#L864) | ]; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | public function insert\_taxonomy($term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null){ |
| [868](#L868) | $this->InstaWP\_db->insert($this->wpdb->prefix.'terms',$wp\_terms); |
| [869](#L869) | $this->InstaWP\_db->insert($this->wpdb->prefix.'term\_taxonomy',$wp\_term\_taxonomy); |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | public function update\_taxonomy($term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null){ |
| [873](#L873) | $this->wpdb->update($this->wpdb->prefix.'terms',$wp\_terms,array( 'term\_id' => $term\_id )); |
| [874](#L874) | $this->wpdb->update($this->wpdb->prefix.'term\_taxonomy',$wp\_term\_taxonomy,array( 'term\_id' => $term\_id )); |
| [875](#L875) | } |
| [876](#L876) |  |
| [877](#L877) | public function reset\_post\_terms($post\_id){ |
| [878](#L878) | $this->wpdb->query( |
| [879](#L879) | $this->wpdb->prepare( |
| [880](#L880) | "DELETE FROM {$this->wpdb->prefix}term\_relationships WHERE object\_id = %d", |
| [881](#L881) | $post\_id, |
| [882](#L882) | ) |
| [883](#L883) | ); |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | public function add\_update\_postmeta($meta\_data = null, $post\_id = null){ |
| [887](#L887) |  |
| [888](#L888) | if(!empty($meta\_data) && is\_array($meta\_data)){ |
| [889](#L889) | foreach($meta\_data as $k => $v){ |
| [890](#L890) | if(isset($v[0])){ |
| [891](#L891) | $checkSerialize = @unserialize($v[0]); |
| [892](#L892) | $metaVal = ($checkSerialize !== false || $v[0] === 'b:0;') ? unserialize($v[0]) : $v[0]; |
| [893](#L893) | if ( metadata\_exists('post',$post\_id,$k) ) { |
| [894](#L894) | update\_post\_meta($post\_id,$k,$metaVal); |
| [895](#L895) | }else{ |
| [896](#L896) | add\_post\_meta($post\_id,$k,$metaVal); |
| [897](#L897) | } |
| [898](#L898) | } |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | //if \_elementor\_css this key not existing then it's giving a error. |
| [902](#L902) | if(array\_key\_exists('\_elementor\_version',$meta\_data)){ |
| [903](#L903) | if(!array\_key\_exists('\_elementor\_css',$meta\_data)){ |
| [904](#L904) | /\*$elementor\_css = [ |
| [905](#L905) | 'time' => time(), |
| [906](#L906) | 'fonts' => [], |
| [907](#L907) | 'icons' => [], |
| [908](#L908) | 'dynamic\_elements\_ids' => [], |
| [909](#L909) | 'status' => 'empty', |
| [910](#L910) | 'css' => '' |
| [911](#L911) | ]; |
| [912](#L912) | \*/ |
| [913](#L913) | $elementor\_css = []; |
| [914](#L914) | add\_post\_meta($post\_id,'\_elementor\_css',$elementor\_css); |
| [915](#L915) | } |
| [916](#L916) | } |
| [917](#L917) |  |
| [918](#L918) | //delete the edit lock post |
| [919](#L919) | delete\_post\_meta($post\_id,'\_edit\_lock'); |
| [920](#L920) | } |
| [921](#L921) | } |
| [922](#L922) |  |
| [923](#L923) | public function postData($posts = null, $op = null){ |
| [924](#L924) | $args = array( |
| [925](#L925) | 'post\_author' => $posts['post\_author'], |
| [926](#L926) | 'post\_date' => $posts['post\_date'], |
| [927](#L927) | 'post\_date\_gmt' => $posts['post\_date\_gmt'], |
| [928](#L928) | 'post\_content' => $posts['post\_content'], |
| [929](#L929) | 'post\_title' => $posts['post\_title'], |
| [930](#L930) | 'post\_excerpt' => $posts['post\_excerpt'], |
| [931](#L931) | 'post\_status' => $posts['post\_status'], |
| [932](#L932) | 'comment\_status' => $posts['comment\_status'], |
| [933](#L933) | 'ping\_status' => $posts['ping\_status'], |
| [934](#L934) | 'post\_password' => $posts['post\_password'], |
| [935](#L935) | 'post\_name' => $posts['post\_name'], |
| [936](#L936) | 'to\_ping' => $posts['to\_ping'], |
| [937](#L937) | 'pinged' => $posts['pinged'], |
| [938](#L938) | 'post\_modified' => $posts['post\_modified'], |
| [939](#L939) | 'post\_modified\_gmt' => $posts['post\_modified\_gmt'], |
| [940](#L940) | 'post\_content\_filtered' => $posts['post\_content\_filtered'], |
| [941](#L941) | 'post\_parent' => $posts['post\_parent'], |
| [942](#L942) | //'guid' => $posts['guid'], |
| [943](#L943) | 'menu\_order' => $posts['menu\_order'], |
| [944](#L944) | 'post\_type' => $posts['post\_type'], |
| [945](#L945) | 'post\_mime\_type' => $posts['post\_mime\_type'], |
| [946](#L946) | 'comment\_count' => $posts['comment\_count'], |
| [947](#L947) | 'filter' => $posts['filter'], |
| [948](#L948) | ); |
| [949](#L949) | #ID to update existing post |
| [950](#L950) | if(isset($posts['ID']) && $posts['ID'] > 0){ |
| [951](#L951) | $args = array\_merge(['ID'=> $posts['ID'] ],$args); |
| [952](#L952) | } |
| [953](#L953) | return $args; |
| [954](#L954) | } |
| [955](#L955) |  |
| [956](#L956) | # import attechments form source to destination. |
| [957](#L957) | public function handle\_attachments($attachment\_post, $attachment\_post\_meta, $file){ |
| [958](#L958) | $reference\_id = ''; |
| [959](#L959) | if(isset($attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0])){ |
| [960](#L960) | $reference\_id = $attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0]; |
| [961](#L961) | } |
| [962](#L962) | $attachment\_id = $this->get\_post\_by\_reference\_Id($attachment\_post['post\_type'], $reference\_id, $attachment\_post['post\_name']); |
| [963](#L963) | if(!$attachment\_id){ |
| [964](#L964) | $filename = basename($file); |
| [965](#L965) | $arrContextOptions=array( |
| [966](#L966) | "ssl"=>array( |
| [967](#L967) | "verify\_peer"=>false, |
| [968](#L968) | "verify\_peer\_name"=>false, |
| [969](#L969) | ), |
| [970](#L970) | ); |
| [971](#L971) | $parent\_post\_id = 0; |
| [972](#L972) | $upload\_file = wp\_upload\_bits($filename, null, file\_get\_contents($file,false, stream\_context\_create($arrContextOptions))); |
| [973](#L973) | if (!$upload\_file['error']) { |
| [974](#L974) | $wp\_filetype = wp\_check\_filetype($filename, null ); |
| [975](#L975) | $attachment = array( |
| [976](#L976) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [977](#L977) | 'post\_parent' => $parent\_post\_id, |
| [978](#L978) | 'post\_title' => preg\_replace('/\.[^.]+$/', '', $filename), |
| [979](#L979) | 'post\_content' => '', |
| [980](#L980) | 'post\_status' => 'inherit' |
| [981](#L981) | ); |
| [982](#L982) | require\_once(ABSPATH . "wp-admin" . '/includes/image.php'); |
| [983](#L983) | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
| [984](#L984) | require\_once(ABSPATH . "wp-admin" . '/includes/media.php'); |
| [985](#L985) | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
| [986](#L986) | if (!is\_wp\_error($attachment\_id)) { |
| [987](#L987) | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
| [988](#L988) | wp\_update\_attachment\_metadata( $attachment\_id,  $attachment\_data ); |
| [989](#L989) | $this->add\_update\_postmeta(['instawp\_event\_sync\_reference\_id' =>[$reference\_id]], $attachment\_id); |
| [990](#L990) | } |
| [991](#L991) | return $attachment\_id; |
| [992](#L992) | } |
| [993](#L993) | return; |
| [994](#L994) | } |
| [995](#L995) | return $attachment\_id; |
| [996](#L996) | } |
| [997](#L997) | # import attechments form source to destination. |
| [998](#L998) | public function insert\_attachment($attachment\_id = null, $file = null){ |
| [999](#L999) | $filename = basename($file); |
| [1000](#L1000) | $arrContextOptions=array( |
| [1001](#L1001) | "ssl"=>array( |
| [1002](#L1002) | "verify\_peer"=>false, |
| [1003](#L1003) | "verify\_peer\_name"=>false, |
| [1004](#L1004) | ), |
| [1005](#L1005) | ); |
| [1006](#L1006) | $parent\_post\_id = 0; |
| [1007](#L1007) | $upload\_file = wp\_upload\_bits($filename, null, file\_get\_contents($file,false, stream\_context\_create($arrContextOptions))); |
| [1008](#L1008) | if (!$upload\_file['error']) { |
| [1009](#L1009) | $wp\_filetype = wp\_check\_filetype($filename, null ); |
| [1010](#L1010) | $attachment = array( |
| [1011](#L1011) | 'import\_id' => $attachment\_id, |
| [1012](#L1012) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [1013](#L1013) | 'post\_parent' => $parent\_post\_id, |
| [1014](#L1014) | 'post\_title' => preg\_replace('/\.[^.]+$/', '', $filename), |
| [1015](#L1015) | 'post\_content' => '', |
| [1016](#L1016) | 'post\_status' => 'inherit' |
| [1017](#L1017) | ); |
| [1018](#L1018) | require\_once(ABSPATH . "wp-admin" . '/includes/image.php'); |
| [1019](#L1019) | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
| [1020](#L1020) | require\_once(ABSPATH . "wp-admin" . '/includes/media.php'); |
| [1021](#L1021) | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
| [1022](#L1022) | if (!is\_wp\_error($attachment\_id)) { |
| [1023](#L1023) | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
| [1024](#L1024) | wp\_update\_attachment\_metadata( $attachment\_id,  $attachment\_data ); |
| [1025](#L1025) | } |
| [1026](#L1026) | } |
| [1027](#L1027) | return $attachment\_id; |
| [1028](#L1028) | } |
| [1029](#L1029) |  |
| [1030](#L1030) | #Insert history |
| [1031](#L1031) | public function sync\_history\_save($body = null, $changes = null,$status = null){ |
| [1032](#L1032) | $dir = 'dev-to-live'; |
| [1033](#L1033) | $date = date('Y-m-d H:i:s'); |
| [1034](#L1034) | $bodyArr = json\_decode($body); |
| [1035](#L1035) | $message = isset($bodyArr->sync\_message) ? $bodyArr->sync\_message : ''; |
| [1036](#L1036) | $data = [ |
| [1037](#L1037) | 'encrypted\_contents' => $bodyArr->encrypted\_contents, |
| [1038](#L1038) | 'changes' => json\_encode($changes), |
| [1039](#L1039) | 'sync\_response' => '', |
| [1040](#L1040) | 'direction' => $dir, |
| [1041](#L1041) | 'status' => $status, |
| [1042](#L1042) | 'user\_id' => isset($bodyArr->upload\_wp\_user) ? $bodyArr->upload\_wp\_user : '', |
| [1043](#L1043) | 'changes\_sync\_id' => isset($bodyArr->sync\_id) ? $bodyArr->sync\_id : '', |
| [1044](#L1044) | 'sync\_message' => $message, |
| [1045](#L1045) | 'source\_connect\_id' => '', |
| [1046](#L1046) | 'source\_url' => isset($bodyArr->source\_url) ? $bodyArr->source\_url : '', |
| [1047](#L1047) | 'date' => $date, |
| [1048](#L1048) | ]; |
| [1049](#L1049) | $this->InstaWP\_db->insert($this->tables['sh\_table'],$data); |
| [1050](#L1050) | } |
| [1051](#L1051) |  |
| [1052](#L1052) | #Plugin activate. |
| [1053](#L1053) | public function plugin\_activation( $plugin ) { |
| [1054](#L1054) | if( ! function\_exists('activate\_plugin') ) { |
| [1055](#L1055) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [1056](#L1056) | } |
| [1057](#L1057) |  |
| [1058](#L1058) | if( ! is\_plugin\_active( $plugin ) ) { |
| [1059](#L1059) | activate\_plugin( $plugin ); |
| [1060](#L1060) | } |
| [1061](#L1061) | } |
| [1062](#L1062) |  |
| [1063](#L1063) | #Plugin deactivate. |
| [1064](#L1064) | public function plugin\_deactivation( $plugin ) { |
| [1065](#L1065) | if( ! function\_exists('deactivate\_plugins') ) { |
| [1066](#L1066) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [1067](#L1067) | } |
| [1068](#L1068) | if( is\_plugin\_active( $plugin ) ) { |
| [1069](#L1069) | deactivate\_plugins( $plugin ); |
| [1070](#L1070) | } |
| [1071](#L1071) | } |
| [1072](#L1072) |  |
| [1073](#L1073) | public function sync\_message($rel = null){ |
| [1074](#L1074) | if(isset($rel->ID)){ |
| [1075](#L1075) | $message = 'Sync successfully.'; |
| [1076](#L1076) | }else{ |
| [1077](#L1077) | $message = 'Something went wrong.'; |
| [1078](#L1078) | } |
| [1079](#L1079) | return $message; |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | public function sync\_post\_status($rel = null){ |
| [1083](#L1083) | $status = 'in\_progress'; |
| [1084](#L1084) | if(isset($rel->ID)){ |
| [1085](#L1085) | $status = 'completed'; |
| [1086](#L1086) | }else{ |
| [1087](#L1087) | $status = 'pending'; |
| [1088](#L1088) | } |
| [1089](#L1089) | return $status; |
| [1090](#L1090) | } |
| [1091](#L1091) |  |
| [1092](#L1092) | public function sync\_opration\_response($status = null, $message = null, $v = null){ |
| [1093](#L1093) | return [ |
| [1094](#L1094) | 'id' => $v->id, |
| [1095](#L1095) | 'status' => $status, |
| [1096](#L1096) | 'message' => $message |
| [1097](#L1097) | ]; |
| [1098](#L1098) | } |
| [1099](#L1099) |  |
| [1100](#L1100) | public function sync\_update($sync\_id = null, $data = null, $source\_connect\_id = null){ |
| [1101](#L1101) | global $InstaWP\_Curl; |
| [1102](#L1102) | $api\_doamin = InstaWP\_Setting::get\_api\_domain(); |
| [1103](#L1103) | $connect\_id = intval($source\_connect\_id); |
| [1104](#L1104) | $endpoint = '/api/v2/connects/'.$connect\_id.'/syncs/'.$sync\_id; |
| [1105](#L1105) | $url = $api\_doamin.$endpoint; #https://stage.instawp.io/api/v2/connects/241/syncs/450 |
| [1106](#L1106) | $api\_key = $this->get\_api\_key(); |
| [1107](#L1107) |  |
| [1108](#L1108) | try{ |
| [1109](#L1109) | $curl = curl\_init(); |
| [1110](#L1110) | curl\_setopt\_array($curl, array( |
| [1111](#L1111) | CURLOPT\_URL => $url, |
| [1112](#L1112) | CURLOPT\_RETURNTRANSFER => true, |
| [1113](#L1113) | CURLOPT\_ENCODING => '', |
| [1114](#L1114) | CURLOPT\_MAXREDIRS => 10, |
| [1115](#L1115) | CURLOPT\_TIMEOUT => 0, |
| [1116](#L1116) | CURLOPT\_FOLLOWLOCATION => true, |
| [1117](#L1117) | CURLOPT\_HTTP\_VERSION => CURL\_HTTP\_VERSION\_1\_1, |
| [1118](#L1118) | CURLOPT\_CUSTOMREQUEST => 'PATCH', |
| [1119](#L1119) | CURLOPT\_POSTFIELDS => json\_encode($data), |
| [1120](#L1120) | CURLOPT\_HTTPHEADER => array( |
| [1121](#L1121) | 'Authorization: Bearer '.$api\_key.'', |
| [1122](#L1122) | 'Content-Type: application/json' |
| [1123](#L1123) | ), |
| [1124](#L1124) | )); |
| [1125](#L1125) |  |
| [1126](#L1126) | $response = curl\_exec($curl); |
| [1127](#L1127) | return $response; |
| [1128](#L1128) | } catch (Exception $e) { |
| [1129](#L1129) | return $e->getMessage(); |
| [1130](#L1130) | } |
| [1131](#L1131) | } |
| [1132](#L1132) |  |
| [1133](#L1133) | function get\_api\_key(){ |
| [1134](#L1134) | $instawp\_api\_options = get\_option('instawp\_api\_options'); |
| [1135](#L1135) | return $instawp\_api\_options['api\_key']; |
| [1136](#L1136) | } |
| [1137](#L1137) |  |
| [1138](#L1138) | /\* |
| [1139](#L1139) | \* Create elementor css file 'post-{post\_id}.css' |
| [1140](#L1140) | \*/ |
| [1141](#L1141) | public function create\_elementor\_css\_file($data = null, $post\_id = null){ |
| [1142](#L1142) | $upload\_dir = wp\_upload\_dir(); |
| [1143](#L1143) | $filename = 'post-'.$post\_id.'.css'; |
| [1144](#L1144) | $filePath = $upload\_dir['basedir'].'/elementor/css/'.$filename; |
| [1145](#L1145) | $file = fopen($filePath, "w+");//w+,w |
| [1146](#L1146) | fwrite($file, $data); |
| [1147](#L1147) | fclose($file); |
| [1148](#L1148) | } |
| [1149](#L1149) |  |
| [1150](#L1150) | /\*\* |
| [1151](#L1151) | \* Plugin install |
| [1152](#L1152) | \*/ |
| [1153](#L1153) | public function plugin\_install($plugin\_slug){ |
| [1154](#L1154) | include\_once( ABSPATH . 'wp-admin/includes/plugin-install.php' ); //for plugins\_api.. |
| [1155](#L1155) | $api = plugins\_api( 'plugin\_information', array( |
| [1156](#L1156) | 'slug' => $plugin\_slug, |
| [1157](#L1157) | 'fields' => array( |
| [1158](#L1158) | 'short\_description' => false, |
| [1159](#L1159) | 'sections' => false, |
| [1160](#L1160) | 'requires' => false, |
| [1161](#L1161) | 'rating' => false, |
| [1162](#L1162) | 'ratings' => false, |
| [1163](#L1163) | 'downloaded' => false, |
| [1164](#L1164) | 'last\_updated' => false, |
| [1165](#L1165) | 'added' => false, |
| [1166](#L1166) | 'tags' => false, |
| [1167](#L1167) | 'compatibility' => false, |
| [1168](#L1168) | 'homepage' => false, |
| [1169](#L1169) | 'donate\_link' => false, |
| [1170](#L1170) | ), |
| [1171](#L1171) | )); |
| [1172](#L1172) | //includes necessary for Plugin\_Upgrader and Plugin\_Installer\_Skin |
| [1173](#L1173) | include\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
| [1174](#L1174) | include\_once( ABSPATH . 'wp-admin/includes/misc.php' ); |
| [1175](#L1175) | include\_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' ); |
| [1176](#L1176) | $upgrader = new Plugin\_Upgrader( new Plugin\_Installer\_Skin( compact('title', 'url', 'nonce', 'plugin', 'api') ) ); |
| [1177](#L1177) | $upgrader->install($api->download\_link); |
| [1178](#L1178) | } |
| [1179](#L1179) |  |
| [1180](#L1180) | /\*\* |
| [1181](#L1181) | \* Check if plugin is installed by getting all plugins from the plugins dir |
| [1182](#L1182) | \* |
| [1183](#L1183) | \* @param $plugin\_slug |
| [1184](#L1184) | \* |
| [1185](#L1185) | \* @return bool |
| [1186](#L1186) | \*/ |
| [1187](#L1187) | public function check\_plugin\_installed( $plugin\_slug ): bool { |
| [1188](#L1188) | $installed\_plugins = get\_plugins(); |
| [1189](#L1189) | return array\_key\_exists( $plugin\_slug, $installed\_plugins ) || in\_array( $plugin\_slug, $installed\_plugins, true ); |
| [1190](#L1190) | } |
| [1191](#L1191) |  |
| [1192](#L1192) | //add and update user meta |
| [1193](#L1193) | public function add\_update\_usermeta($user\_meta = null, $user\_id = null){ |
| [1194](#L1194) | if(!empty($user\_meta) && is\_array($user\_meta)){ |
| [1195](#L1195) | foreach($user\_meta as $k => $v){ |
| [1196](#L1196) | if(isset($v[0])){ |
| [1197](#L1197) | $checkSerialize = @unserialize($v[0]); |
| [1198](#L1198) | $metaVal = ($checkSerialize !== false || $v[0] === 'b:0;') ? unserialize($v[0]) : $v[0]; |
| [1199](#L1199) | if ( metadata\_exists('user',$user\_id,$k) ) { |
| [1200](#L1200) | update\_user\_meta($user\_id,$k,$metaVal); |
| [1201](#L1201) | }else{ |
| [1202](#L1202) | add\_user\_meta($user\_id,$k,$metaVal); |
| [1203](#L1203) | } |
| [1204](#L1204) | } |
| [1205](#L1205) | } |
| [1206](#L1206) | } |
| [1207](#L1207) | } |
| [1208](#L1208) |  |
| [1209](#L1209) | /\*\* |
| [1210](#L1210) | \* Set Astra Costmizer Setings |
| [1211](#L1211) | \*/ |
| [1212](#L1212) | function setAstraCostmizerSetings($arr = null){ |
| [1213](#L1213) | #Checkout |
| [1214](#L1214) | update\_option('woocommerce\_checkout\_company\_field',$arr['woocommerce\_checkout\_company\_field']); |
| [1215](#L1215) | update\_option('woocommerce\_checkout\_address\_2\_field',$arr['woocommerce\_checkout\_address\_2\_field']); |
| [1216](#L1216) | update\_option('woocommerce\_checkout\_phone\_field',$arr['woocommerce\_checkout\_phone\_field']); |
| [1217](#L1217) | update\_option('woocommerce\_checkout\_highlight\_required\_fields',$arr['woocommerce\_checkout\_highlight\_required\_fields']); |
| [1218](#L1218) | update\_option('wp\_page\_for\_privacy\_policy',$arr['wp\_page\_for\_privacy\_policy']); |
| [1219](#L1219) | update\_option('woocommerce\_terms\_page\_id',$arr['woocommerce\_terms\_page\_id']); |
| [1220](#L1220) | update\_option('woocommerce\_checkout\_privacy\_policy\_text',$arr['woocommerce\_checkout\_privacy\_policy\_text']); |
| [1221](#L1221) | update\_option('woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text',$arr['woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text']); |
| [1222](#L1222) |  |
| [1223](#L1223) | #product catalog |
| [1224](#L1224) | update\_option('woocommerce\_shop\_page\_display',$arr['woocommerce\_shop\_page\_display']); |
| [1225](#L1225) | update\_option('woocommerce\_default\_catalog\_orderby',$arr['woocommerce\_default\_catalog\_orderby']); |
| [1226](#L1226) | update\_option('woocommerce\_category\_archive\_display',$arr['woocommerce\_category\_archive\_display']); |
| [1227](#L1227) |  |
| [1228](#L1228) | #Product Images |
| [1229](#L1229) | update\_option('woocommerce\_single\_image\_width',$arr['woocommerce\_single\_image\_width']); |
| [1230](#L1230) | update\_option('woocommerce\_thumbnail\_image\_width',$arr['woocommerce\_thumbnail\_image\_width']); |
| [1231](#L1231) | update\_option('woocommerce\_thumbnail\_cropping',$arr['woocommerce\_thumbnail\_cropping']); |
| [1232](#L1232) | update\_option('woocommerce\_thumbnail\_cropping\_custom\_width',$arr['woocommerce\_thumbnail\_cropping\_custom\_width']); |
| [1233](#L1233) | update\_option('woocommerce\_thumbnail\_cropping\_custom\_height',$arr['woocommerce\_thumbnail\_cropping\_custom\_height']); |
| [1234](#L1234) |  |
| [1235](#L1235) | #Store Notice |
| [1236](#L1236) | update\_option('woocommerce\_demo\_store',$arr['woocommerce\_demo\_store']); |
| [1237](#L1237) | update\_option('woocommerce\_demo\_store\_notice',$arr['woocommerce\_demo\_store\_notice']); |
| [1238](#L1238) | } |
| [1239](#L1239) | } |
| [1240](#L1240) | new InstaWP\_Rest\_Apis(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/instawp-connect/tags/0.0.9.18/includes/class-instawp-rest-apis.php?format=txt)
* [Original Format](/export/3222468/instawp-connect/tags/0.0.9.18/includes/class-instawp-rest-apis.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_72cfe6f4_20250114_203719.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# InstaWP Connect <= 0.0.9.18 - Missing Authorization to Unauthenticated Post/Taxonomy/User Add/Change/Delete, Customizer Setting Change, Plugin Installation/Activation/Deactication via events\_receiver

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   InstaWP Connect <= 0.0.9.18 - Missing Authorization to Unauthenticated Post/Taxonomy/User Add/Change/Delete, Customizer Setting Change, Plugin Installation/Activation/Deactication via events\_receiver

9.8

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-3956](https://www.cve.org/CVERecord?id=CVE-2023-3956) |
| --- | --- |
| CVSS | 9.8 (Critical) |
| Publicly Published | July 26, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The InstaWP Connect plugin for WordPress is vulnerable to unauthorized access of data, modification of data and loss of data due to a missing capability check on the 'events\_receiver' function in versions up to, and including, 0.0.9.18. This makes it possible for unauthenticated attackers to add, modify or delete post and taxonomy, install, activate or deactivate plugin, change customizer settings, add or modify or delete user including administrator user.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/instawp-connect/tags/0.0.9.18/includes/class-instawp-rest-apis.php#L103)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2942363/instawp-connect#file5)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Finstawp-connect%2Finstawp-connect-00918-missing-authorization-to-unauthenticated-posttaxonomyuser-addchangedelete-customizer-setting-change-plugin-installationactivationdeactication-via-events-receiver&t=InstaWP%20Connect%20%3C%3D%200.0.9.18%20-%20Missing%20Authorization%20to%20Unauthenticated%20Post%2FTaxonomy%2FUser%20Add%2FChange%2FDelete%2C%20Customizer%20Setting%20Change%2C%20Plugin%20Installation%2FActivation%2FDeactication%20via%20events_receiver "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Finstawp-connect%2Finstawp-connect-00918-missing-authorization-to-unauthenticated-posttaxonomyuser-addchangedelete-customizer-setting-change-plugin-installationactivationdeactication-via-events-receiver&text=InstaWP%20Connect%20%3C%3D%200.0.9.18%20-%20Missing%20Authorization%20to%20Unauthenticated%20Post%2FTaxonomy%2FUser%20Add%2FChange%2FDelete%2C%20Customizer%20Setting%20Change%2C%20Plugin%20Installation%2FActivation%2FDeactication%20via%20events_receiver "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Finstawp-connect%2Finstawp-connect-00918-missing-authorization-to-unauthenticated-posttaxonomyuser-addchangedelete-customizer-setting-change-plugin-installationactivationdeactication-via-events-receiver "LinkedIn")
Email

## Vulnerability Details for InstaWP Connect – 1-click WP Staging & Migration

#### [InstaWP Connect – 1-click WP Staging & Migration](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/instawp-connect)

| Software Type | Plugin |
| --- | --- |
| Software Slug | instawp-connect [(view on wordpress.org)](https://wordpress.org/plugins/instawp-connect) |
| Patched? | Yes |
| Remediation | Update to version 0.0.9.19, or a newer patched version |
| Affected Version | * <= 0.0.9.18 |
| Patched Version | * 0.0.9.19 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_b9042991_20250114_203717.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2942363%2Finstawp-connect)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2940719/instawp-connect "Changeset 2940719 for instawp-connect")
* [Next Change](/changeset/2944585/instawp-connect "Changeset 2944585 for instawp-connect") →

---

# Changeset [2942363](/changeset/2942363 "Show full changeset") for [instawp-connect](/browser/instawp-connect?rev=2942363 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
07/24/2023 08:04:07 AM
([18 months](/timeline?from=2023-07-24T08%3A04%3A07Z&precision=second "See timeline at 07/24/2023 08:04:07 AM") ago)

Author:
instawp
Message:

Update to version 0.0.9.19 from GitHub

Location:
[instawp-connect](/browser/instawp-connect?rev=2942363)
Files:

10 added
6 deleted
14 edited
1 copied

* [tags/0.0.9.19](/browser/instawp-connect/tags/0.0.9.19?rev=2942363 "Show entry in browser")
  (copied)
  *(copied from [instawp-connect/trunk](/browser/instawp-connect/trunk?rev=2940719 "Show original file (revision 2942362)"))*
* [tags/0.0.9.19/composer.json](/browser/instawp-connect/trunk/composer.json?rev=2846670 "Show what was removed (content at revision 2942362)")
  (deleted)
* [tags/0.0.9.19/composer.lock](/browser/instawp-connect/trunk/composer.lock?rev=2940719 "Show what was removed (content at revision 2942362)")
  (deleted)
* [tags/0.0.9.19/includes/class-instawp-file-management.php](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-file-management.php?rev=2942363 "Show entry in browser")
  (added)
* [tags/0.0.9.19/includes/class-instawp-rest-api.php](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php?rev=2942363 "Show entry in browser")
  (modified)
  ([6 diffs](#file4 "Show differences"))
* [tags/0.0.9.19/includes/class-instawp-rest-apis.php](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-apis.php?rev=2942363 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [tags/0.0.9.19/includes/class-instawp-tools.php](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-tools.php?rev=2942363 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [tags/0.0.9.19/includes/class-instawp.php](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp.php?rev=2942363 "Show entry in browser")
  (modified)
  ([3 diffs](#file7 "Show differences"))
* [tags/0.0.9.19/includes/class-intawp-ajax-fn.php](/browser/instawp-connect/tags/0.0.9.19/includes/class-intawp-ajax-fn.php?rev=2942363 "Show entry in browser")
  (modified)
  ([2 diffs](#file8 "Show differences"))
* [tags/0.0.9.19/includes/file-manager](/browser/instawp-connect/tags/0.0.9.19/includes/file-manager?rev=2942363 "Show entry in browser")
  (added)
* [tags/0.0.9.19/includes/file-manager/config.php](/browser/instawp-connect/tags/0.0.9.19/includes/file-manager/config.php?rev=2942363 "Show entry in browser")
  (added)
* [tags/0.0.9.19/includes/file-manager/custom.css](/browser/instawp-connect/tags/0.0.9.19/includes/file-manager/custom.css?rev=2942363 "Show entry in browser")
  (added)
* [tags/0.0.9.19/includes/file-manager/translation.json](/browser/instawp-connect/tags/0.0.9.19/includes/file-manager/translation.json?rev=2942363 "Show entry in browser")
  (added)
* [tags/0.0.9.19/instawp-connect.php](/browser/instawp-connect/tags/0.0.9.19/instawp-connect.php?rev=2942363 "Show entry in browser")
  (modified)
  ([4 diffs](#file13 "Show differences"))
* [tags/0.0.9.19/readme.txt](/browser/instawp-connect/tags/0.0.9.19/readme.txt?rev=2942363 "Show entry in browser")
  (modified)
  ([2 diffs](#file14 "Show differences"))
* [tags/0.0.9.19/vendor/fzaninotto/faker/composer.json](/browser/instawp-connect/trunk/vendor/fzaninotto/faker/composer.json?rev=2843438 "Show what was removed (content at revision 2942362)")
  (deleted)
* [trunk/composer.json](/browser/instawp-connect/trunk/composer.json?rev=2846670 "Show what was removed (content at revision 2942362)")
  (deleted)
* [trunk/composer.lock](/browser/instawp-connect/trunk/composer.lock?rev=2940719 "Show what was removed (content at revision 2942362)")
  (deleted)
* [trunk/includes/class-instawp-file-management.php](/browser/instawp-connect/trunk/includes/class-instawp-file-management.php?rev=2942363 "Show entry in browser")
  (added)
* [trunk/includes/class-instawp-rest-api.php](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2942363 "Show entry in browser")
  (modified)
  ([6 diffs](#file19 "Show differences"))
* [trunk/includes/class-instawp-rest-apis.php](/browser/instawp-connect/trunk/includes/class-instawp-rest-apis.php?rev=2942363 "Show entry in browser")
  (modified)
  ([1 diff](#file20 "Show differences"))
* [trunk/includes/class-instawp-tools.php](/browser/instawp-connect/trunk/includes/class-instawp-tools.php?rev=2942363 "Show entry in browser")
  (modified)
  ([2 diffs](#file21 "Show differences"))
* [trunk/includes/class-instawp.php](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2942363 "Show entry in browser")
  (modified)
  ([3 diffs](#file22 "Show differences"))
* [trunk/includes/class-intawp-ajax-fn.php](/browser/instawp-connect/trunk/includes/class-intawp-ajax-fn.php?rev=2942363 "Show entry in browser")
  (modified)
  ([2 diffs](#file23 "Show differences"))
* [trunk/includes/file-manager](/browser/instawp-connect/trunk/includes/file-manager?rev=2942363 "Show entry in browser")
  (added)
* [trunk/includes/file-manager/config.php](/browser/instawp-connect/trunk/includes/file-manager/config.php?rev=2942363 "Show entry in browser")
  (added)
* [trunk/includes/file-manager/custom.css](/browser/instawp-connect/trunk/includes/file-manager/custom.css?rev=2942363 "Show entry in browser")
  (added)
* [trunk/includes/file-manager/translation.json](/browser/instawp-connect/trunk/includes/file-manager/translation.json?rev=2942363 "Show entry in browser")
  (added)
* [trunk/instawp-connect.php](/browser/instawp-connect/trunk/instawp-connect.php?rev=2942363 "Show entry in browser")
  (modified)
  ([4 diffs](#file28 "Show differences"))
* [trunk/readme.txt](/browser/instawp-connect/trunk/readme.txt?rev=2942363 "Show entry in browser")
  (modified)
  ([2 diffs](#file29 "Show differences"))
* [trunk/vendor/fzaninotto/faker/composer.json](/browser/instawp-connect/trunk/vendor/fzaninotto/faker/composer.json?rev=2843438 "Show what was removed (content at revision 2942362)")
  (deleted)

### Legend:

Unmodified
Added
Removed

* ## [instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php](/changeset/2942363/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php "Show the changeset 2942363 restricted to instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L42 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php?rev=2942363#L42 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 42 | 42 | ) ); |
  | 43 | 43 |  |
  | 44 |  | ~~register\_rest\_route( $this->namespace . '/' . $this->version, 'test', array(~~ |
  | 45 |  | ~~'methods'             => 'POST',~~ |
  | 46 |  | ~~'callback'            => array( $this, 'test' ),~~ |
  | 47 |  | ~~'permission\_callback' => '\_\_return\_true',~~ |
  | 48 |  | ~~) );~~ |
  | 49 |  |  |
  | 50 | 44 | register\_rest\_route( $this->namespace . '/' . $this->version, 'config', array( |
  | 51 | 45 | 'methods'             => 'POST', |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L54) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php?rev=2942363#L48) |  |
  | 54 | 48 | ) ); |
  | 55 | 49 |  |
  | 56 |  | register\_rest\_route( $this->namespace . '/' . $this->version, 'task\_status/(?P<task\_id>\w+)', array( |
  | 57 |  | 'methods'             => 'GET', |
  | 58 |  | 'callback'            => array( $this, 'task\_status' ), |
  | 59 |  | 'permission\_callback' => '\_\_return\_true', |
  | 60 |  | ) ); |
  | 61 |  |  |
  | 62 |  | register\_rest\_route( $this->namespace . '/' . $this->version, 'upload\_status/(?P<task\_id>\w+)', array( |
  | 63 |  | 'methods'             => 'GET', |
  | 64 |  | 'callback'            => array( $this, 'upload\_status' ), |
  | 65 |  | 'permission\_callback' => '\_\_return\_true', |
  | 66 |  | ) ); |
  |  | 50 | //      register\_rest\_route( $this->namespace . '/' . $this->version, 'task\_status/(?P<task\_id>\w+)', array( |
  |  | 51 | //          'methods'             => 'GET', |
  |  | 52 | //          'callback'            => array( $this, 'task\_status' ), |
  |  | 53 | //          'permission\_callback' => '\_\_return\_true', |
  |  | 54 | //      ) ); |
  |  | 55 |  |
  |  | 56 | //      register\_rest\_route( $this->namespace . '/' . $this->version, 'upload\_status/(?P<task\_id>\w+)', array( |
  |  | 57 | //          'methods'             => 'GET', |
  |  | 58 | //          'callback'            => array( $this, 'upload\_status' ), |
  |  | 59 | //          'permission\_callback' => '\_\_return\_true', |
  |  | 60 | //      ) ); |
  | 67 | 61 |  |
  | 68 | 62 | register\_rest\_route( $this->namespace . '/' . $this->version\_2, '/auto-login-code', array( |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L120) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php?rev=2942363#L114) |  |
  | 120 | 114 | ) ); |
  | 121 | 115 |  |
  |  | 116 | register\_rest\_route( $this->namespace . '/' . $this->version\_2, '/file-manager', array( |
  |  | 117 | 'methods'             => 'POST', |
  |  | 118 | 'callback'            => array( $this, 'file\_manager' ), |
  |  | 119 | 'permission\_callback' => '\_\_return\_true', |
  |  | 120 | ) ); |
  |  | 121 |  |
  | 122 | 122 | register\_rest\_route( $this->namespace . '/' . $this->version\_2, '/logs', array( |
  | 123 | 123 | 'methods'             => 'GET', |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L567) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php?rev=2942363#L567) |  |
  | 567 | 567 | \* @return WP\_Error|bool |
  | 568 | 568 | \*/ |
  | 569 |  | p~~rivate~~ function validate\_api\_request( WP\_REST\_Request $request, $check\_management = false ) { |
  |  | 569 | public function validate\_api\_request( WP\_REST\_Request $request, $check\_management = false ) { |
  | 570 | 570 |  |
  | 571 | 571 | if ( $check\_management && ( ! defined( 'INSTAWP\_ALLOW\_MANAGE' ) || ( defined( 'INSTAWP\_ALLOW\_MANAGE' ) && true !== INSTAWP\_ALLOW\_MANAGE ) ) ) { |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L1590) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php?rev=2942363#L1590) |  |
  | 1590 | 1590 |  |
  | 1591 | 1591 | /\*\* |
  |  | 1592 | \* Handle file manager system. |
  |  | 1593 | \* |
  |  | 1594 | \* @param WP\_REST\_Request $request |
  |  | 1595 | \* |
  |  | 1596 | \* @return WP\_REST\_Response |
  |  | 1597 | \*/ |
  |  | 1598 | public function file\_manager( WP\_REST\_Request $request ) { |
  |  | 1599 |  |
  |  | 1600 | $response = $this->validate\_api\_request( $request, true ); |
  |  | 1601 | if ( is\_wp\_error( $response ) ) { |
  |  | 1602 | return $this->throw\_error( $response ); |
  |  | 1603 | } |
  |  | 1604 |  |
  |  | 1605 | $file\_name = InstaWP\_Setting::get\_option( 'instawp\_file\_manager\_name', '' ); |
  |  | 1606 |  |
  |  | 1607 | if ( ! empty( $file\_name ) ) { |
  |  | 1608 | as\_unschedule\_all\_actions( 'instawp\_clean\_file\_manager', [ $file\_name ], 'instawp-connect' ); |
  |  | 1609 |  |
  |  | 1610 | $file\_path = InstaWP\_File\_Management::get\_file\_path( $file\_name ); |
  |  | 1611 | if ( file\_exists( $file\_path ) ) { |
  |  | 1612 | @unlink( $file\_path ); |
  |  | 1613 | } |
  |  | 1614 | } |
  |  | 1615 |  |
  |  | 1616 | $url       = 'https://raw.githubusercontent.com/InstaWP/tinyfilemanager/master/tinyfilemanager.php'; |
  |  | 1617 | $username  = InstaWP\_Tools::get\_random\_string( 15 ); |
  |  | 1618 | $password  = InstaWP\_Tools::get\_random\_string( 20 ); |
  |  | 1619 | $file\_name = InstaWP\_Tools::get\_random\_string( 20 ); |
  |  | 1620 | $token     = md5( $username . '|' . $password. '|' . $file\_name ); |
  |  | 1621 |  |
  |  | 1622 | $search  = [ |
  |  | 1623 | 'Tiny File Manager', |
  |  | 1624 | 'CCP Programmers', |
  |  | 1625 | 'tinyfilemanager.github.io', |
  |  | 1626 | 'FM\_SELF\_URL', |
  |  | 1627 | 'FM\_SESSION\_ID', |
  |  | 1628 | "'translation.json'", |
  |  | 1629 | '</style>', |
  |  | 1630 | ]; |
  |  | 1631 | $replace = [ |
  |  | 1632 | 'InstaWP File Manager', |
  |  | 1633 | 'InstaWP', |
  |  | 1634 | 'instawp.com', |
  |  | 1635 | 'INSTAWP\_FILE\_MANAGER\_SELF\_URL', |
  |  | 1636 | 'INSTAWP\_FILE\_MANAGER\_SESSION\_ID', |
  |  | 1637 | "\_\_DIR\_\_ . '/translation.json'", |
  |  | 1638 | '<?php if ( file\_exists( \_\_DIR\_\_ . "/custom.css" ) ) { echo file\_get\_contents( \_\_DIR\_\_ . "/custom.css" ); } ?></style>', |
  |  | 1639 | ]; |
  |  | 1640 |  |
  |  | 1641 | $file = file\_get\_contents( $url ); |
  |  | 1642 | $file = str\_replace( $search, $replace, $file ); |
  |  | 1643 | $file = preg\_replace( '!/\\*.\*?\\*/!s', '', $file ); |
  |  | 1644 |  |
  |  | 1645 | $file\_path        = InstaWP\_File\_Management::get\_file\_path( $file\_name ); |
  |  | 1646 | $file\_manager\_url = InstaWP\_File\_Management::get\_file\_manager\_url( $file\_name ); |
  |  | 1647 |  |
  |  | 1648 | $results = [ |
  |  | 1649 | 'login\_url' => add\_query\_arg( [ |
  |  | 1650 | 'action' => 'instawp-file-manager-auto-login', |
  |  | 1651 | 'token'  => hash( 'sha256', $token ), |
  |  | 1652 | ], admin\_url( 'admin-post.php' ) ), |
  |  | 1653 | ]; |
  |  | 1654 |  |
  |  | 1655 | $config\_file = InstaWP\_Tools::get\_config\_file(); |
  |  | 1656 |  |
  |  | 1657 | try { |
  |  | 1658 | $result = file\_put\_contents( $file\_path, $file, LOCK\_EX ); |
  |  | 1659 | if ( false === $result ) { |
  |  | 1660 | throw new Exception( esc\_html\_\_( 'Failed to create the file manager file.', 'instawp-connect' ) ); |
  |  | 1661 | } |
  |  | 1662 |  |
  |  | 1663 | $file       = file( $file\_path ); |
  |  | 1664 | $new\_line   = "if ( ! defined( 'INSTAWP\_PLUGIN\_DIR' ) ) { die; }"; |
  |  | 1665 | $first\_line = array\_shift( $file ); |
  |  | 1666 | array\_unshift( $file, $new\_line ); |
  |  | 1667 | array\_unshift( $file, $first\_line ); |
  |  | 1668 |  |
  |  | 1669 | $fp = fopen( $file\_path, 'w' ); |
  |  | 1670 | fwrite( $fp, implode( '', $file ) ); |
  |  | 1671 | fclose( $fp ); |
  |  | 1672 |  |
  |  | 1673 | if ( ! class\_exists( 'InstaWP\_WP\_Config' ) ) { |
  |  | 1674 | require\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-wp-config.php'; |
  |  | 1675 | } |
  |  | 1676 |  |
  |  | 1677 | $args = [ |
  |  | 1678 | 'normalize' => true, |
  |  | 1679 | 'add'       => true, |
  |  | 1680 | 'raw'       => false, |
  |  | 1681 | ]; |
  |  | 1682 |  |
  |  | 1683 | $config = new InstaWP\_WP\_Config( $config\_file ); |
  |  | 1684 | $config->update( 'constant', 'INSTAWP\_FILE\_MANAGER\_USERNAME', $username, $args ); |
  |  | 1685 | $config->update( 'constant', 'INSTAWP\_FILE\_MANAGER\_PASSWORD', $password, $args ); |
  |  | 1686 | $config->update( 'constant', 'INSTAWP\_FILE\_MANAGER\_SELF\_URL', $file\_manager\_url, $args ); |
  |  | 1687 | $config->update( 'constant', 'INSTAWP\_FILE\_MANAGER\_SESSION\_ID', 'instawp\_file\_manager', $args ); |
  |  | 1688 |  |
  |  | 1689 | set\_transient( 'instawp\_file\_manager\_login\_token', $token, ( 15 \* MINUTE\_IN\_SECONDS ) ); |
  |  | 1690 | InstaWP\_Setting::update\_option( 'instawp\_file\_manager\_name', $file\_name ); |
  |  | 1691 |  |
  |  | 1692 | flush\_rewrite\_rules(); |
  |  | 1693 | as\_schedule\_single\_action( time() + DAY\_IN\_SECONDS, 'instawp\_clean\_file\_manager', [ $file\_name ], 'instawp-connect', false, 5 ); |
  |  | 1694 | } catch ( Exception $e ) { |
  |  | 1695 | $results = [ |
  |  | 1696 | 'success' => false, |
  |  | 1697 | 'message' => $e->getMessage(), |
  |  | 1698 | ]; |
  |  | 1699 | } |
  |  | 1700 |  |
  |  | 1701 | return $this->send\_response( $results ); |
  |  | 1702 | } |
  |  | 1703 |  |
  |  | 1704 | /\*\* |
  | 1592 | 1705 | \* Handle response to retrieve debug logs. |
  | 1593 | 1706 | \* |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L1691) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-api.php?rev=2942363#L1804) |  |
  | 1691 | 1804 | \* @return WP\_REST\_Response|WP\_Error|WP\_HTTP\_Response |
  | 1692 | 1805 | \*/ |
  | 1693 |  | p~~rivate~~ function throw\_error( $error ) { |
  |  | 1806 | public function throw\_error( $error ) { |
  | 1694 | 1807 | $response = new WP\_REST\_Response( [ |
  | 1695 | 1808 | 'success' => false, |
* ## [instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-apis.php](/changeset/2942363/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-apis.php "Show the changeset 2942363 restricted to instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-apis.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-instawp-rest-apis.php?rev=2940719#L17 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-rest-apis.php?rev=2942363#L17 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 17 | 17 | \*/ |
  | 18 | 18 |  |
  | 19 |  | if ( ! defined(~~'INSTAWP\_PLUGIN\_DIR'~~) ) { |
  | 20 |  | die; |
  |  | 19 | if ( ! defined( 'INSTAWP\_PLUGIN\_DIR' ) ) { |
  |  | 20 | die; |
  | 21 | 21 | } |
  | 22 | 22 |  |
  | 23 | 23 | require\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-db.php'; |
  | 24 | 24 |  |
  | 25 |  | class InstaWP\_Rest\_Apis{ |
  | 26 |  |  |
  | 27 |  | private $wpdb; |
  | 28 |  |  |
  | 29 |  | private $InstaWP\_db; |
  | 30 |  |  |
  | 31 |  | private $tables; |
  | 32 |  |  |
  | 33 |  | public function \_\_construct(){ |
  | 34 |  | global $wpdb; |
  | 35 |  |  |
  | 36 |  | $this->wpdb = $wpdb; |
  | 37 |  |  |
  | 38 |  | $this->InstaWP\_db = new InstaWP\_DB(); |
  | 39 |  |  |
  | 40 |  | $this->tables = $this->InstaWP\_db->tables; |
  | 41 |  |  |
  | 42 |  | /\* |
  | 43 |  | \* Initiate Sync |
  | 44 |  | \* Endpoint : /wp-json/instawp-connect/v1/sync |
  | 45 |  | \* HOOK - rest\_api\_init |
  | 46 |  | \*/ |
  | 47 |  |  |
  | 48 |  | add\_action( 'rest\_api\_init', function () { |
  | 49 |  | register\_rest\_route( 'instawp-connect/v1', '/sync', |
  | 50 |  | array( |
  | 51 |  | 'methods' => 'POST', |
  | 52 |  | 'callback' => [$this, 'events\_receiver'], |
  | 53 |  | 'permission\_callback' => [$this, 'check\_permission'], |
  | 54 |  | ) ); |
  | 55 |  | } ); |
  | 56 |  | } |
  | 57 |  |  |
  | 58 |  | function check\_permission(){ |
  | 59 |  | return true; |
  | 60 |  | } |
  | 61 |  |  |
  | 62 |  | public function get\_post\_by\_reference\_Id($post\_type, $reference\_id, $post\_name) { |
  | 63 |  | $post = get\_posts( array( |
  | 64 |  | 'post\_type'=> $post\_type, |
  | 65 |  | 'meta\_key'   => 'instawp\_event\_sync\_reference\_id', |
  | 66 |  | 'meta\_value' => $reference\_id |
  | 67 |  | ) ); |
  | 68 |  | if(!empty($post)){ |
  | 69 |  | $post = $post[0]; |
  | 70 |  | }else { |
  | 71 |  | $post  = instawp\_get\_post\_by\_name($post\_name, $post\_type); |
  | 72 |  | } |
  | 73 |  | return $post; |
  | 74 |  | } |
  | 75 |  |  |
  | 76 |  | public function create\_or\_update\_post($post, $post\_meta) { |
  | 77 |  | $reference\_id = isset($post\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
  | 78 |  | $destination\_post = $this->get\_post\_by\_reference\_Id($post['post\_type'], $reference\_id, $post['post\_name']); |
  | 79 |  | unset($post['ID']); |
  | 80 |  | if(!empty($destination\_post)){ |
  | 81 |  | #The post exists,Then update |
  | 82 |  | $post\_id = $post['ID'] = $destination\_post->ID; |
  | 83 |  | //$post['post\_parent'] = $destination\_post->post\_parent; |
  | 84 |  | $postData = $this->postData($post); |
  | 85 |  | wp\_update\_post($postData); |
  | 86 |  | #post meta |
  | 87 |  | $this->add\_update\_postmeta($post\_meta, $destination\_post->ID); |
  | 88 |  | }else{ |
  | 89 |  | $postData = $this->postData($post); |
  | 90 |  | #The post does not exist,Then insert |
  | 91 |  | $post\_id = wp\_insert\_post($postData); |
  | 92 |  | #post meta |
  | 93 |  | $this->add\_update\_postmeta( $post\_meta, $post\_id ); |
  | 94 |  | } |
  | 95 |  | return $post\_id; |
  | 96 |  | } |
  | 97 |  |  |
  | 98 |  | /\*\* |
  | 99 |  | \* Reciver |
  | 100 |  | \* @param array $data Options for the function. |
  | 101 |  | \* @return string|null |
  | 102 |  | \*/ |
  | 103 |  | public function events\_receiver($req) { |
  | 104 |  | // error\_reporting(E\_ALL); |
  | 105 |  | // ini\_set('display\_errors', 1); |
  | 106 |  | $body = $req->get\_body(); |
  | 107 |  | $bodyArr = json\_decode($body); |
  | 108 |  | $encrypted\_contents = json\_decode($bodyArr->encrypted\_contents); |
  | 109 |  | $sync\_id = $bodyArr->sync\_id; |
  | 110 |  | $source\_connect\_id = $bodyArr->source\_connect\_id; |
  | 111 |  | $is\_enabled = false; |
  | 112 |  |  |
  | 113 |  |  |
  | 114 |  | if(get\_option('syncing\_enabled\_disabled')){ |
  | 115 |  | $is\_enabled = true; |
  | 116 |  | } |
  | 117 |  |  |
  | 118 |  | #forcely disable the syncing at the destination |
  | 119 |  | update\_option('syncing\_enabled\_disabled', 0); |
  | 120 |  |  |
  | 121 |  | if(!empty($encrypted\_contents) && is\_array($encrypted\_contents)){ |
  | 122 |  | $total\_op = count($encrypted\_contents); |
  | 123 |  | $count = 1; |
  | 124 |  | $progress\_status = 'pending'; |
  | 125 |  | $changes = $sync\_response = []; |
  | 126 |  | foreach($encrypted\_contents as $v){ |
  | 127 |  |  |
  | 128 |  | $source\_id = (isset($v->source\_id) && !empty($v->source\_id)) ? intval($v->source\_id) : null; |
  | 129 |  |  |
  | 130 |  | /\* |
  | 131 |  | \*Post Oprations |
  | 132 |  | \*/ |
  | 133 |  | //create and update |
  | 134 |  | if(isset($v->event\_slug) && ($v->event\_slug == 'post\_change' ||$v->event\_slug == 'post\_new') ){ |
  | 135 |  | $posts = isset($v->details->posts) ? (array) $v->details->posts : ''; |
  | 136 |  | $postmeta = isset($v->details->postmeta) ? (array) $v->details->postmeta : ''; |
  | 137 |  | $featured\_image = isset($v->details->featured\_image) ? (array) $v->details->featured\_image : ''; |
  | 138 |  | $media = isset($v->details->media) ? (array) $v->details->media : ''; |
  | 139 |  |  |
  | 140 |  | $parent\_post = isset($v->details->parent->post) ? (array) $v->details->parent->post : []; |
  | 141 |  |  |
  | 142 |  | #check for the post parent |
  | 143 |  | if(!empty($parent\_post)){ |
  | 144 |  | $parent\_post\_meta = isset($v->details->parent->post\_meta) ? (array) $v->details->parent->post\_meta : []; |
  | 145 |  | $reference\_id = isset($parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
  | 146 |  | $destination\_post = $this->get\_post\_by\_reference\_Id($parent\_post['post\_type'], $reference\_id, $parent\_post['post\_name']); |
  | 147 |  | if(!empty($destination\_post)){ |
  | 148 |  | $posts['post\_parent'] = $destination\_post->ID; |
  | 149 |  | } |
  | 150 |  | } |
  | 151 |  |  |
  | 152 |  | if($posts['post\_type'] == 'attachment'){ |
  | 153 |  | //create or update the attachments |
  | 154 |  | $posts['ID'] = $this->handle\_attachments($posts, $postmeta, $posts['guid']); |
  | 155 |  | #update meta |
  | 156 |  | $this->add\_update\_postmeta($postmeta,$posts['ID']); |
  | 157 |  | }else{ |
  | 158 |  | $posts['ID'] = $this->create\_or\_update\_post($posts, $postmeta); |
  | 159 |  | } |
  | 160 |  |  |
  | 161 |  | #feature image import |
  | 162 |  | if(isset($featured\_image['media']) && !empty($featured\_image['media'])){ |
  | 163 |  | $att\_id = $this->handle\_attachments((array) $featured\_image['media'],(array) $featured\_image['media\_meta'], $featured\_image['featured\_image\_url']); |
  | 164 |  | if(isset($att\_id) && !empty($att\_id)){ |
  | 165 |  | set\_post\_thumbnail($posts['ID'],$att\_id); |
  | 166 |  | } |
  | 167 |  | } |
  | 168 |  |  |
  | 169 |  | #if post type is product then set gallery |
  | 170 |  | if(get\_post\_type($posts['ID']) == 'product'){ |
  | 171 |  | if(isset($v->details->product\_gallery) && !empty($v->details->product\_gallery)){ |
  | 172 |  | $product\_gallery = $v->details->product\_gallery; |
  | 173 |  | $gallery\_ids = []; |
  | 174 |  | //pr($product\_gallery); |
  | 175 |  | foreach($product\_gallery as $gallery){ |
  | 176 |  | if(isset($gallery->media) && !empty($gallery->media) && isset($gallery->url) && $gallery->url !=''){ |
  | 177 |  | $gallery\_ids[] = $this->handle\_attachments((array) $gallery->media,(array) $gallery->media\_meta, $gallery->url); |
  | 178 |  | } |
  | 179 |  | } |
  | 180 |  | $this->set\_product\_gallery($posts['ID'],$gallery\_ids); |
  | 181 |  | } |
  | 182 |  | } |
  | 183 |  |  |
  | 184 |  | #terms in post |
  | 185 |  | $taxonomies = (array) $v->details->taxonomies; |
  | 186 |  | $this->reset\_post\_terms( $posts['ID']); //rest the terms for all taxo |
  | 187 |  | if(!empty($taxonomies) && is\_array($taxonomies)){ |
  | 188 |  | foreach($taxonomies as $taxonomy => $terms){ |
  | 189 |  | $terms = (array) $terms; |
  | 190 |  | $term\_ids = []; |
  | 191 |  | # if term not exist then create first |
  | 192 |  | if(!empty($terms) && is\_array($terms)){ |
  | 193 |  | foreach($terms as $term){ |
  | 194 |  | $term = (array) $term; |
  | 195 |  | if(!term\_exists($term['slug'],$taxonomy)){ |
  | 196 |  | $inserted\_term = wp\_insert\_term( |
  | 197 |  | $term['name'],   // the term |
  | 198 |  | $taxonomy, // the taxonomy |
  | 199 |  | array( |
  | 200 |  | 'description' => $term['description'], |
  | 201 |  | 'slug'        => $term['slug'], |
  | 202 |  | 'parent'      => 0 |
  | 203 |  | ) |
  | 204 |  | ); |
  | 205 |  | $term\_ids[] = $inserted\_term['term\_id']; |
  | 206 |  | }else{ |
  | 207 |  | $get\_term\_by =(array) get\_term\_by('slug',$term['slug'] , $taxonomy); |
  | 208 |  | $term\_ids[] = $get\_term\_by['term\_id']; |
  | 209 |  | } |
  | 210 |  | } |
  | 211 |  | } |
  | 212 |  | #set terms in post |
  | 213 |  | wp\_set\_post\_terms( $posts['ID'], $term\_ids, $taxonomy ); |
  | 214 |  | } |
  | 215 |  | } |
  | 216 |  |  |
  | 217 |  | # media upload from content |
  | 218 |  | $this->upload\_content\_media($media,$posts['ID']); |
  | 219 |  |  |
  | 220 |  | #message |
  | 221 |  | $message = 'Sync successfully.'; |
  | 222 |  | $status = 'completed'; |
  | 223 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 224 |  | #changes |
  | 225 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 226 |  | } |
  | 227 |  |  |
  | 228 |  | //Post trash |
  | 229 |  | if(isset($v->event\_slug) && $v->event\_slug == 'post\_trash'){ |
  | 230 |  | if(isset($source\_id)){ |
  | 231 |  | $posts = (array) $v->details->posts; |
  | 232 |  | $postmeta = (array) $v->details->postmeta; |
  | 233 |  | $post\_by\_reference\_id = get\_posts( array( |
  | 234 |  | 'post\_type'=> $posts['post\_type'], |
  | 235 |  | 'meta\_key'   => 'instawp\_event\_sync\_reference\_id', |
  | 236 |  | 'meta\_value' => isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  | 237 |  | ) ); |
  | 238 |  |  |
  | 239 |  | if(!empty($post\_by\_reference\_id)){ |
  | 240 |  | $post\_id = $post\_by\_reference\_id[0]->ID; |
  | 241 |  | $rel = wp\_trash\_post($post\_id);  //Post data on success, false or null on failure. |
  | 242 |  | $status = $this->sync\_post\_status($rel); |
  | 243 |  | $message = $this->sync\_message($rel); |
  | 244 |  | }else{ |
  | 245 |  | $post\_check\_data = instawp\_get\_post\_by\_name(str\_replace('\_\_trashed','', $posts['post\_name']), $posts['post\_type']); |
  | 246 |  | if(!empty($post\_check\_data)){ |
  | 247 |  | $rel = wp\_trash\_post($post\_check\_data->ID);  //Post data on success, false or null on failure. |
  | 248 |  | $status = $this->sync\_post\_status($rel); |
  | 249 |  | $message = $this->sync\_message($rel); |
  | 250 |  | }else{ |
  | 251 |  | $status = 'pending'; |
  | 252 |  | $message = $this->notExistMsg(); |
  | 253 |  | } |
  | 254 |  | } |
  | 255 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 256 |  | #changes |
  | 257 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 258 |  | } |
  | 259 |  | } |
  | 260 |  |  |
  | 261 |  | //Post permanently delete |
  | 262 |  | if(isset($v->event\_slug) && $v->event\_slug == 'post\_delete'){ |
  | 263 |  | if(isset($source\_id)){ |
  | 264 |  | $posts = (array) $v->details->posts; |
  | 265 |  | $postmeta = (array) $v->details->postmeta; |
  | 266 |  | $post\_by\_reference\_id = get\_posts([ |
  | 267 |  | 'post\_status' => 'trash', |
  | 268 |  | 'post\_type'   => $posts['post\_type'], |
  | 269 |  | 'nopaging'    => TRUE, |
  | 270 |  | 'meta\_query' => array( |
  | 271 |  | array( |
  | 272 |  | 'key'     => 'instawp\_event\_sync\_reference\_id', |
  | 273 |  | 'value'   =>  isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  | 274 |  | 'compare' => '=', |
  | 275 |  | ), |
  | 276 |  | ), |
  | 277 |  | ]); |
  | 278 |  |  |
  | 279 |  | if(!empty($post\_by\_reference\_id)){ |
  | 280 |  | $post\_id = $post\_by\_reference\_id[0]->ID; |
  | 281 |  | $rel = wp\_delete\_post($post\_id);  //Post data on success, false or null on failure. |
  | 282 |  | $status = $this->sync\_post\_status($rel); |
  | 283 |  | $message = $this->sync\_message($rel); |
  | 284 |  | }else{ |
  | 285 |  | $post\_check\_data = instawp\_get\_post\_by\_name($posts['post\_name'], $posts['post\_type']); |
  | 286 |  | if(!empty($post\_check\_data)){ |
  | 287 |  | $rel = wp\_delete\_post($post\_check\_data->ID);  //Post data on success, false or null on failure. |
  | 288 |  | $status = $this->sync\_post\_status($rel); |
  | 289 |  | $message = $this->sync\_message($rel); |
  | 290 |  | }else{ |
  | 291 |  | $status = 'pending'; |
  | 292 |  | $message = $this->notExistMsg(); |
  | 293 |  | } |
  | 294 |  | } |
  | 295 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 296 |  | #changes |
  | 297 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 298 |  | } |
  | 299 |  | } |
  | 300 |  |  |
  | 301 |  | //Post restored |
  | 302 |  | if(isset($v->event\_slug) && $v->event\_slug == 'untrashed\_post'){ |
  | 303 |  | if(isset($source\_id)){ |
  | 304 |  | $posts = (array) $v->details->posts; |
  | 305 |  | $postmeta = (array) $v->details->postmeta; |
  | 306 |  | $post\_by\_reference\_id = get\_posts([ |
  | 307 |  | 'post\_status' => 'trash', |
  | 308 |  | 'post\_type'   => $posts['post\_type'], |
  | 309 |  | 'nopaging'    => TRUE, |
  | 310 |  | 'meta\_query' => array( |
  | 311 |  | array( |
  | 312 |  | 'key'     => 'instawp\_event\_sync\_reference\_id', |
  | 313 |  | 'value'   =>  isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  | 314 |  | 'compare' => '=', |
  | 315 |  | ), |
  | 316 |  | ), |
  | 317 |  | ]); |
  | 318 |  |  |
  | 319 |  |  |
  | 320 |  | if(!empty($post\_by\_reference\_id)){ |
  | 321 |  | $post\_id = $post\_by\_reference\_id[0]->ID; |
  | 322 |  | $rel = wp\_untrash\_post($post\_id); |
  | 323 |  | $status = $this->sync\_post\_status($rel); |
  | 324 |  | $message = $this->sync\_message($rel); |
  | 325 |  | }else{ |
  | 326 |  | $post\_check\_data = instawp\_get\_post\_by\_name($posts['post\_name'].'\_\_trashed', $posts['post\_type']); |
  | 327 |  | if(!empty($post\_check\_data)){ |
  | 328 |  | $rel = wp\_untrash\_post($post\_check\_data->ID); |
  | 329 |  | $status = $this->sync\_post\_status($rel); |
  | 330 |  | $message = $this->sync\_message($rel); |
  | 331 |  | }else{ |
  | 332 |  | $status = 'pending'; |
  | 333 |  | $message = $this->notExistMsg(); |
  | 334 |  | } |
  | 335 |  | } |
  | 336 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 337 |  | #changes |
  | 338 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 339 |  | } |
  | 340 |  | } |
  | 341 |  |  |
  | 342 |  | /\* |
  | 343 |  | \*Plugin Oprations |
  | 344 |  | \*/ |
  | 345 |  | //Plugin actiavte |
  | 346 |  | if(isset($v->details) && $v->event\_slug == 'activate\_plugin'){ |
  | 347 |  | $check\_plugin\_installed = $this->check\_plugin\_installed($v->details); |
  | 348 |  | if($check\_plugin\_installed != 1){ |
  | 349 |  | $pluginData = get\_plugin\_data($v->details); |
  | 350 |  | if(!empty($pluginData['TextDomain'])){ |
  | 351 |  | $this->plugin\_install($pluginData['TextDomain']); |
  | 352 |  | } |
  | 353 |  | } |
  | 354 |  |  |
  | 355 |  | $this->plugin\_activation($v->details); |
  | 356 |  | #message |
  | 357 |  | $message = 'Sync successfully.'; |
  | 358 |  | $status = 'completed'; |
  | 359 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 360 |  | #changes |
  | 361 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 362 |  | } |
  | 363 |  |  |
  | 364 |  | //Plugin deactiavte |
  | 365 |  | if(isset($v->event\_slug) && $v->event\_slug == 'deactivate\_plugin'){ |
  | 366 |  | $this->plugin\_deactivation($v->details); |
  | 367 |  | #message |
  | 368 |  | $message = 'Sync successfully.'; |
  | 369 |  | $status = 'completed'; |
  | 370 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 371 |  | #changes |
  | 372 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 373 |  | } |
  | 374 |  |  |
  | 375 |  | /\* |
  | 376 |  | \* Taxonomy Oprations |
  | 377 |  | \*/ |
  | 378 |  |  |
  | 379 |  | //create and update |
  | 380 |  | if(isset($v->event\_slug) && ($v->event\_slug == 'create\_taxonomy' || $v->event\_slug == 'edit\_taxonomy')){ |
  | 381 |  | if(isset($source\_id)){ |
  | 382 |  | $details = (array) $v->details; |
  | 383 |  | $wp\_terms = $this->wp\_terms\_data($source\_id,$details); |
  | 384 |  | $wp\_term\_taxonomy = $this->wp\_term\_taxonomy\_data($source\_id,$details); |
  | 385 |  | if(!term\_exists($source\_id,$v->event\_type)){ |
  | 386 |  | if($v->event\_slug == 'create\_taxonomy'){ |
  | 387 |  | $this->insert\_taxonomy($source\_id,$wp\_terms,$wp\_term\_taxonomy); |
  | 388 |  | clean\_term\_cache($source\_id); |
  | 389 |  | } |
  | 390 |  | } |
  | 391 |  | if(term\_exists($source\_id,$v->event\_type)){ |
  | 392 |  | if($v->event\_slug == 'edit\_taxonomy'){ |
  | 393 |  | $this->update\_taxonomy($source\_id,$wp\_terms,$wp\_term\_taxonomy); |
  | 394 |  | } |
  | 395 |  | } |
  | 396 |  |  |
  | 397 |  | #message |
  | 398 |  | $message = 'Sync successfully.'; |
  | 399 |  | $status = 'completed'; |
  | 400 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 401 |  | #changes |
  | 402 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 403 |  |  |
  | 404 |  | } |
  | 405 |  | } |
  | 406 |  |  |
  | 407 |  | //Delete |
  | 408 |  | if(isset($v->event\_slug) && $v->event\_slug == 'delete\_taxonomy'){ |
  | 409 |  | if(isset($source\_id)){ |
  | 410 |  | if(term\_exists($source\_id,$v->event\_type)){ |
  | 411 |  | $rel = wp\_delete\_term($source\_id,$v->event\_type); |
  | 412 |  | $status = $this->sync\_post\_status($rel); |
  | 413 |  | $message = $this->sync\_message($rel); |
  | 414 |  | } |
  | 415 |  | }else{ |
  | 416 |  | $status = 'pending'; |
  | 417 |  | $message = $this->notExistMsg(); |
  | 418 |  | } |
  | 419 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 420 |  | #changes |
  | 421 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 422 |  | } |
  | 423 |  |  |
  | 424 |  | /\*\* |
  | 425 |  | \* Customizer settings update |
  | 426 |  | \*/ |
  | 427 |  |  |
  | 428 |  | if(isset($v->event\_slug) && $v->event\_slug == 'customizer\_changes'){ |
  | 429 |  | $details = isset($v->details) ? $v->details : ''; |
  | 430 |  |  |
  | 431 |  | #custom logo |
  | 432 |  | $this->customizer\_custom\_logo($details->custom\_logo); |
  | 433 |  |  |
  | 434 |  | #background image |
  | 435 |  | $this->customizer\_background\_image($details->background\_image); |
  | 436 |  |  |
  | 437 |  | #site icon |
  | 438 |  | $this->customizer\_site\_icon($details->site\_icon); |
  | 439 |  |  |
  | 440 |  | #background color |
  | 441 |  | if(isset($details->background\_color) && !empty($details->background\_color)){ |
  | 442 |  | set\_theme\_mod( 'background\_color', $details->background\_color ); |
  | 443 |  | } |
  | 444 |  |  |
  | 445 |  | #Site Title |
  | 446 |  | update\_option( 'blogname', $details->name ); |
  | 447 |  |  |
  | 448 |  | #Tagline |
  | 449 |  | $this->blogDescription($details->description); |
  | 450 |  |  |
  | 451 |  | #Homepage Settings |
  | 452 |  | if(isset($details->show\_on\_front) && !empty($details->show\_on\_front)){ |
  | 453 |  | update\_option( 'show\_on\_front', $details->show\_on\_front ); |
  | 454 |  | } |
  | 455 |  |  |
  | 456 |  | #for 'Astra' theme |
  | 457 |  | if( isset($details->astra\_settings) && !empty($details->astra\_settings) ){ |
  | 458 |  | $astra\_settings = $this->object\_to\_array($details->astra\_settings); |
  | 459 |  | update\_option( 'astra-settings', $astra\_settings ); |
  | 460 |  | } |
  | 461 |  |  |
  | 462 |  | #nav menu locations |
  | 463 |  | if(!empty($details->nav\_menu\_locations)){ |
  | 464 |  | $menu\_array = (array) $details->nav\_menu\_locations; |
  | 465 |  | set\_theme\_mod( 'nav\_menu\_locations', $menu\_array ); |
  | 466 |  | } |
  | 467 |  |  |
  | 468 |  | #Custom css post id |
  | 469 |  | $custom\_css\_post = (array) $details->custom\_css\_post; |
  | 470 |  | if(!empty($details->custom\_css\_post)){ |
  | 471 |  | if (get\_post\_status($custom\_css\_post['ID']) ) { |
  | 472 |  | #The post exists,Then update |
  | 473 |  | $postData = $this->postData($custom\_css\_post,'update'); |
  | 474 |  | wp\_update\_post($postData); |
  | 475 |  |  |
  | 476 |  | } else { |
  | 477 |  | $postData = $this->postData($custom\_css\_post,'insert'); |
  | 478 |  | #The post does not exist,Then insert |
  | 479 |  | wp\_insert\_post($postData); |
  | 480 |  | } |
  | 481 |  | set\_theme\_mod( 'custom\_css\_post\_id', $custom\_css\_post['ID'] ); |
  | 482 |  | } |
  | 483 |  | $current\_theme = wp\_get\_theme(); |
  | 484 |  | if($current\_theme->Name == 'Astra'){ #for 'Astra' theme |
  | 485 |  | $astra\_theme\_setting = isset($details->astra\_theme\_customizer\_settings) ? (array) $details->astra\_theme\_customizer\_settings : ''; |
  | 486 |  | $this->setAstraCostmizerSetings($astra\_theme\_setting); |
  | 487 |  | }else if($current\_theme->Name == 'Divi'){  #for 'Divi' theme |
  | 488 |  | $divi\_settings = isset($details->divi\_settings) ? (array) $details->divi\_settings : ''; |
  | 489 |  | if(!empty($divi\_settings) &&  is\_array($divi\_settings)){ |
  | 490 |  | update\_option('et\_divi',$divi\_settings); |
  | 491 |  | } |
  | 492 |  | } |
  | 493 |  |  |
  | 494 |  | #message |
  | 495 |  | $message = 'Sync successfully.'; |
  | 496 |  | $status = 'completed'; |
  | 497 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 498 |  | #changes |
  | 499 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 500 |  | } |
  | 501 |  |  |
  | 502 |  | /\*\* |
  | 503 |  | \* Woocommerce attributes |
  | 504 |  | \*/ |
  | 505 |  |  |
  | 506 |  | #create&upadte woocommerce attribute |
  | 507 |  | if(isset($v->event\_slug) && ($v->event\_slug == 'woocommerce\_attribute\_added' || $v->event\_slug == 'woocommerce\_attribute\_updated')){ |
  | 508 |  | $details = isset($v->details) ? (array) $v->details : ''; |
  | 509 |  | if(!empty($details)){ |
  | 510 |  | $attribute = wc\_get\_attribute(208); |
  | 511 |  | if(!empty($attribute)){ |
  | 512 |  | unset($details['id']); |
  | 513 |  | wc\_update\_attribute($v->source\_id,$attribute); |
  | 514 |  |  |
  | 515 |  | #message |
  | 516 |  | $message = 'Sync successfully.'; |
  | 517 |  | $status = 'completed'; |
  | 518 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 519 |  | #changes |
  | 520 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 521 |  | }else{ |
  | 522 |  | $this->woocommerce\_create\_attribute($v->source\_id,$details); |
  | 523 |  |  |
  | 524 |  | #message |
  | 525 |  | $message = 'Sync successfully.'; |
  | 526 |  | $status = 'completed'; |
  | 527 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 528 |  | #changes |
  | 529 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 530 |  |  |
  | 531 |  | } |
  | 532 |  | } |
  | 533 |  | } |
  | 534 |  |  |
  | 535 |  | if(isset($v->event\_slug) && $v->event\_slug == 'woocommerce\_attribute\_deleted'){ |
  | 536 |  | wc\_delete\_attribute($v->source\_id); |
  | 537 |  | #message |
  | 538 |  | $message = 'Sync successfully.'; |
  | 539 |  | $status = 'completed'; |
  | 540 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 541 |  | #changes |
  | 542 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 543 |  | } |
  | 544 |  |  |
  | 545 |  | /\*\* |
  | 546 |  | \* Users actions |
  | 547 |  | \*/ |
  | 548 |  | if(isset($v->event\_type) && $v->event\_type == 'users'){ |
  | 549 |  | $user\_data = isset($v->details->user\_data) ? (array) $v->details->user\_data : ''; |
  | 550 |  | $user\_meta = isset($v->details->user\_meta) ? (array) $v->details->user\_meta : ''; |
  | 551 |  | //$user = get\_userdata($v->source\_id); |
  | 552 |  | $user\_table = $this->wpdb->prefix.'users'; |
  | 553 |  |  |
  | 554 |  | $get\_user\_by\_reference\_id = get\_users(array( |
  | 555 |  | 'meta\_key' => 'instawp\_event\_user\_sync\_reference\_id', |
  | 556 |  | 'meta\_value' => isset($user\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $user\_meta['instawp\_event\_sync\_reference\_id'][0] : '', |
  | 557 |  | )); |
  | 558 |  |  |
  | 559 |  | $user =  !empty($get\_user\_by\_reference\_id) ? $get\_user\_by\_reference\_id[0] : get\_user\_by('email', $user\_data['email']); |
  | 560 |  |  |
  | 561 |  | //Create user if not exits |
  | 562 |  | if( isset($v->event\_slug) && ($v->event\_slug == 'user\_register') ){ |
  | 563 |  | if(!$user){ |
  | 564 |  | unset($user\_data['ID']); |
  | 565 |  | array\_merge($user\_data, ['role'=>$v->details->role ]); |
  | 566 |  | $user = wp\_insert\_user($user\_data); |
  | 567 |  | $this->add\_update\_usermeta($user\_meta,$v->source\_id); |
  | 568 |  | } |
  | 569 |  | } |
  | 570 |  |  |
  | 571 |  | //Update user |
  | 572 |  | if( isset($v->event\_slug) && ($v->event\_slug == 'profile\_update') ){ |
  | 573 |  | $this->InstaWP\_db->update($user\_table,$user\_data,array( 'ID' => $v->source\_id )); |
  | 574 |  | $this->add\_update\_usermeta($user\_meta,$v->source\_id); |
  | 575 |  | $user->add\_role( $v->details->role ); |
  | 576 |  | } |
  | 577 |  |  |
  | 578 |  | //Delete user |
  | 579 |  | if( isset($v->event\_slug) && ($v->event\_slug == 'delete\_user') ){ |
  | 580 |  | if(isset($user->data->user\_email)){ |
  | 581 |  | if($user->data->user\_email == $user\_data['data']->user\_email){ |
  | 582 |  | wp\_delete\_user($v->source\_id); |
  | 583 |  | } |
  | 584 |  | } |
  | 585 |  | } |
  | 586 |  |  |
  | 587 |  | #message |
  | 588 |  | $message = 'Sync successfully.'; |
  | 589 |  | $status = 'completed'; |
  | 590 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 591 |  | #changes |
  | 592 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 593 |  | } |
  | 594 |  |  |
  | 595 |  | /\* |
  | 596 |  | \* widget |
  | 597 |  | \*/ |
  | 598 |  | if(isset($v->event\_type) && $v->event\_type == 'widget'){ |
  | 599 |  | $widget\_block = (array) $v->details->widget\_block; |
  | 600 |  | $appp = (array) $v->details; |
  | 601 |  | $dataIns = [ |
  | 602 |  | 'data' => json\_encode($appp) |
  | 603 |  | ]; |
  | 604 |  | $this->InstaWP\_db->insert('wp\_testing',$dataIns); |
  | 605 |  |  |
  | 606 |  | $widget\_block\_arr = []; |
  | 607 |  | foreach($widget\_block as $widget\_key => $widget\_val){ |
  | 608 |  | if($widget\_key == '\_multiwidget'){ |
  | 609 |  | $widget\_block\_arr[$widget\_key] = $widget\_val; |
  | 610 |  | }else{ |
  | 611 |  | $widget\_val\_arr = (array) $widget\_val; |
  | 612 |  | $widget\_block\_arr[$widget\_key] = ['content' => $widget\_val\_arr['content']]; |
  | 613 |  | } |
  | 614 |  | } |
  | 615 |  | update\_option('widget\_block',$widget\_block\_arr); |
  | 616 |  | #message |
  | 617 |  | $message = 'Sync successfully.'; |
  | 618 |  | $status = 'completed'; |
  | 619 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 620 |  | #changes |
  | 621 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 622 |  | } |
  | 623 |  | /\* |
  | 624 |  | \* Update api for cloud |
  | 625 |  | \*/ |
  | 626 |  | $progress = intval($count/$total\_op \* 100); |
  | 627 |  | $progress\_status = ($progress > 100 ) ?  'in\_progress': 'completed'; |
  | 628 |  | #Sync update |
  | 629 |  | $syncUpdate = [ |
  | 630 |  | 'progress' => $progress, |
  | 631 |  | 'status' => $progress\_status, |
  | 632 |  | 'message' => $message, |
  | 633 |  | 'changes' => ['changes' => $changes,'sync\_response' => $sync\_response], |
  | 634 |  | ]; |
  | 635 |  | $this->sync\_update($sync\_id,$syncUpdate,$source\_connect\_id); |
  | 636 |  | $count++; |
  | 637 |  | } |
  | 638 |  | } |
  | 639 |  |  |
  | 640 |  | #Sync history save |
  | 641 |  | $this->sync\_history\_save($body,$changes,'Complete'); |
  | 642 |  |  |
  | 643 |  | #enable is back if syncing already enabled at the destination |
  | 644 |  | if($is\_enabled){ |
  | 645 |  | update\_option('syncing\_enabled\_disabled', 1); |
  | 646 |  | } |
  | 647 |  |  |
  | 648 |  | return new WP\_REST\_Response( |
  | 649 |  | array( |
  | 650 |  | 'encrypted\_contents' => $encrypted\_contents, |
  | 651 |  | 'source\_connect\_id' => $source\_connect\_id, |
  | 652 |  | 'changes' => ['changes' => $changes,'sync\_response' => $sync\_response], |
  | 653 |  | 'sync\_id' => $sync\_id |
  | 654 |  | ) |
  | 655 |  | ); |
  | 656 |  | } |
  | 657 |  |  |
  | 658 |  | /\*\* |
  | 659 |  | \* This function is for upload media which are coming form widgets. |
  | 660 |  | \*/ |
  | 661 |  | public function upload\_widgets\_media($media = null, $content = null){ |
  | 662 |  | $media = json\_decode(reset($media)); |
  | 663 |  | $new = $old = []; |
  | 664 |  | $newContent = ''; |
  | 665 |  | if(!empty($media)){ |
  | 666 |  | foreach($media as $v){ |
  | 667 |  | $v = (array) $v; |
  | 668 |  | if(isset($v['attachment\_id']) && isset($v['attachment\_url'])){ |
  | 669 |  | $attachment\_id = $this->insert\_attachment($v['attachment\_id'],$v['attachment\_url']); |
  | 670 |  | $new[] = wp\_get\_attachment\_url($attachment\_id); |
  | 671 |  | $old[] = $v['attachment\_url']; |
  | 672 |  | } |
  | 673 |  | } |
  | 674 |  | $newContent = str\_replace($old, $new, $content); #str\_replace(old,new,str) |
  | 675 |  | } |
  | 676 |  | return $newContent; |
  | 677 |  | } |
  | 678 |  |  |
  | 679 |  | public function user\_id\_exists($user\_id){ |
  | 680 |  | $table\_name = $this->wpdb->prefix.'users'; |
  | 681 |  | $count = $this->wpdb->get\_var($this->wpdb->prepare("SELECT COUNT(\*) FROM $table\_name WHERE ID = %d",$user\_id)); |
  | 682 |  | if($count == 1){ return true; }else{ return false; } |
  | 683 |  | } |
  | 684 |  |  |
  | 685 |  | public function blogDescription($v = null){ |
  | 686 |  | $this->wpdb->update($this->wpdb->prefix.'options',['option\_value' => $v],array( 'option\_name' => 'blogdescription' )); |
  | 687 |  | } |
  | 688 |  |  |
  | 689 |  | /\*\* |
  | 690 |  | \* object to array conversation |
  | 691 |  | \*/ |
  | 692 |  | public function object\_to\_array($data) { |
  | 693 |  | if ((! is\_array($data)) and (! is\_object($data))){ |
  | 694 |  | return; |
  | 695 |  | } |
  | 696 |  | $result = array(); |
  | 697 |  | $data = (array) $data; |
  | 698 |  | foreach ($data as $key => $value) { |
  | 699 |  | if (is\_object($value)) |
  | 700 |  | $value = (array) $value; |
  | 701 |  | if (is\_array($value)) |
  | 702 |  | $result[$key] = $this->object\_to\_array($value); |
  | 703 |  | else |
  | 704 |  | $result[$key] = $value; |
  | 705 |  | } |
  | 706 |  | return $result; |
  | 707 |  | } |
  | 708 |  |  |
  | 709 |  | /\*\* |
  | 710 |  | \* Create woocommerce attribute |
  | 711 |  | \*/ |
  | 712 |  | public function woocommerce\_create\_attribute($source\_id,$data = null){ |
  | 713 |  | $format = array( '%s', '%s', '%s', '%s', '%d' ); |
  | 714 |  | $data['attribute\_id'] = intval($source\_id); |
  | 715 |  | $results = $this->wpdb->insert( |
  | 716 |  | $this->wpdb->prefix . 'woocommerce\_attribute\_taxonomies', |
  | 717 |  | $data, |
  | 718 |  | $format |
  | 719 |  | ); |
  | 720 |  |  |
  | 721 |  | if ( is\_wp\_error( $results ) ) { |
  | 722 |  | return new WP\_Error( 'cannot\_create\_attribute', 'Can not create attribute!', array( 'status' => 400 ) ); |
  | 723 |  | } |
  | 724 |  | $id = $this->wpdb->insert\_id; |
  | 725 |  | /\*\* |
  | 726 |  | \* Attribute added. |
  | 727 |  | \* |
  | 728 |  | \* @param int   $id   Added attribute ID. |
  | 729 |  | \* @param array $data Attribute data. |
  | 730 |  | \*/ |
  | 731 |  | do\_action( 'woocommerce\_attribute\_added', $id, $data ); |
  | 732 |  | // Clear cache and flush rewrite rules. |
  | 733 |  | wp\_schedule\_single\_event( time(), 'woocommerce\_flush\_rewrite\_rules' ); |
  | 734 |  | delete\_transient( 'wc\_attribute\_taxonomies' ); |
  | 735 |  | WC\_Cache\_Helper::invalidate\_cache\_group( 'woocommerce-attributes' ); |
  | 736 |  | } |
  | 737 |  |  |
  | 738 |  | /\*\* |
  | 739 |  | \* Set product gallery |
  | 740 |  | \*/ |
  | 741 |  | public function set\_product\_gallery($product\_id = null, $gallery\_ids = null){ |
  | 742 |  | $product = new WC\_product($product\_id); |
  | 743 |  | $product->set\_gallery\_image\_ids( $gallery\_ids ); |
  | 744 |  | $product->save(); |
  | 745 |  | } |
  | 746 |  |  |
  | 747 |  | public function customizer\_site\_icon($data = null){ |
  | 748 |  | $attachment\_id = $data->id; |
  | 749 |  | $url = $data->url; |
  | 750 |  | if(isset($attachment\_id) && !empty($attachment\_id)){ |
  | 751 |  | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
  | 752 |  | if(!empty($attUrl)){ |
  | 753 |  | update\_option('site\_icon',$attachment\_id); |
  | 754 |  | }else{ |
  | 755 |  | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
  | 756 |  | update\_option('site\_icon',$attachment\_id); |
  | 757 |  | } |
  | 758 |  | }else{ |
  | 759 |  | update\_option('site\_icon',$attachment\_id); |
  | 760 |  | } |
  | 761 |  | } |
  | 762 |  |  |
  | 763 |  | public function customizer\_custom\_logo($data){ |
  | 764 |  | $attachment\_id = $data->id; |
  | 765 |  | $url = $data->url; |
  | 766 |  | if(isset($attachment\_id) && !empty($attachment\_id)){ |
  | 767 |  | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
  | 768 |  | if(!empty($attUrl)){ |
  | 769 |  | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  | 770 |  | }else{ |
  | 771 |  | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
  | 772 |  | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  | 773 |  | } |
  | 774 |  | }else{ |
  | 775 |  | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  | 776 |  | } |
  | 777 |  | } |
  | 778 |  |  |
  | 779 |  | public function customizer\_background\_image($data = null){ |
  | 780 |  | $attachment\_id = $data->id; |
  | 781 |  | $url = $data->url; |
  | 782 |  | if(isset($attachment\_id) && !empty($attachment\_id)){ |
  | 783 |  | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
  | 784 |  | if(!empty($attUrl)){ |
  | 785 |  | set\_theme\_mod( 'background\_image', $attUrl ); |
  | 786 |  | }else{ |
  | 787 |  | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
  | 788 |  | $attachment\_url = wp\_get\_attachment\_url(intval($attachment\_id)); |
  | 789 |  | set\_theme\_mod( 'background\_image', $attachment\_url ); |
  | 790 |  | } |
  | 791 |  | }else{ |
  | 792 |  | set\_theme\_mod( 'background\_image', $url ); |
  | 793 |  | } |
  | 794 |  |  |
  | 795 |  | if(isset($data->background\_preset) && !empty($data->background\_preset)){ |
  | 796 |  | set\_theme\_mod( 'background\_preset', $data->background\_preset ); |
  | 797 |  | } |
  | 798 |  |  |
  | 799 |  | if(isset($data->background\_size) && !empty($data->background\_size)){ |
  | 800 |  | set\_theme\_mod( 'background\_size', $data->background\_size ); |
  | 801 |  | } |
  | 802 |  |  |
  | 803 |  | if(isset($data->background\_repeat) && !empty($data->background\_repeat)){ |
  | 804 |  | set\_theme\_mod( 'background\_repeat', $data->background\_repeat ); |
  | 805 |  | } |
  | 806 |  |  |
  | 807 |  | if(isset($data->background\_attachment) && !empty($data->background\_attachment)){ |
  | 808 |  | set\_theme\_mod( 'background\_attachment', $data->background\_attachment ); |
  | 809 |  | } |
  | 810 |  |  |
  | 811 |  | if(isset($data->background\_position\_x) && !empty($data->background\_position\_x)){ |
  | 812 |  | set\_theme\_mod( 'background\_position\_x', $data->background\_position\_x ); |
  | 813 |  | } |
  | 814 |  |  |
  | 815 |  | if(isset($data->background\_position\_y) && !empty($data->background\_position\_y)){ |
  | 816 |  | set\_theme\_mod( 'background\_position\_y', $data->background\_position\_y ); |
  | 817 |  | } |
  | 818 |  | } |
  | 819 |  |  |
  | 820 |  | /\*\* |
  | 821 |  | \* This function is for upload media which are coming form content. |
  | 822 |  | \*/ |
  | 823 |  | public function upload\_content\_media($media = null, $post\_id = null){ |
  | 824 |  | $media = json\_decode(reset($media)); |
  | 825 |  | $post = get\_post($post\_id); |
  | 826 |  | $content = $post->post\_content; |
  | 827 |  | $new = $old = []; |
  | 828 |  | if(!empty($media)){ |
  | 829 |  | foreach($media as $v){ |
  | 830 |  | $v = (array) $v; |
  | 831 |  | if(isset($v['attachment\_id']) && isset($v['attachment\_url'])){ |
  | 832 |  | $attachment\_id = $this->handle\_attachments((array) $v['attachment\_media'], (array) $v['attachment\_media\_meta'], $v['attachment\_url']); |
  | 833 |  | $new[] = wp\_get\_attachment\_url($attachment\_id); |
  | 834 |  | $old[] = $v['attachment\_url']; |
  | 835 |  | } |
  | 836 |  | } |
  | 837 |  | $newContent = str\_replace($old, $new, $content); #str\_replace(old,new,str) |
  | 838 |  | $arg = array( |
  | 839 |  | 'ID'            => $post\_id, |
  | 840 |  | 'post\_content'  => $newContent, |
  | 841 |  | ); |
  | 842 |  | wp\_update\_post( $arg ); |
  | 843 |  | } |
  | 844 |  | } |
  | 845 |  |  |
  | 846 |  | public function notExistMsg(){ |
  | 847 |  | return "ID is not exists."; |
  | 848 |  | } |
  | 849 |  |  |
  | 850 |  | public function wp\_terms\_data($term\_id = null, $arr = []){ |
  | 851 |  | return [ |
  | 852 |  | 'term\_id' => $term\_id, |
  | 853 |  | 'name' => $arr['name'], |
  | 854 |  | 'slug' => $arr['slug'] |
  | 855 |  | ]; |
  | 856 |  | } |
  | 857 |  | public function wp\_term\_taxonomy\_data($term\_id = null, $arr = []){ |
  | 858 |  | return [ |
  | 859 |  | 'term\_taxonomy\_id' => $term\_id, |
  | 860 |  | 'term\_id' => $term\_id, |
  | 861 |  | 'taxonomy' => $arr['taxonomy'], |
  | 862 |  | 'description' => $arr['description'], |
  | 863 |  | 'parent' => $arr['parent'] |
  | 864 |  | ]; |
  | 865 |  | } |
  | 866 |  |  |
  | 867 |  | public function insert\_taxonomy($term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null){ |
  | 868 |  | $this->InstaWP\_db->insert($this->wpdb->prefix.'terms',$wp\_terms); |
  | 869 |  | $this->InstaWP\_db->insert($this->wpdb->prefix.'term\_taxonomy',$wp\_term\_taxonomy); |
  | 870 |  | } |
  | 871 |  |  |
  | 872 |  | public function update\_taxonomy($term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null){ |
  | 873 |  | $this->wpdb->update($this->wpdb->prefix.'terms',$wp\_terms,array( 'term\_id' => $term\_id )); |
  | 874 |  | $this->wpdb->update($this->wpdb->prefix.'term\_taxonomy',$wp\_term\_taxonomy,array( 'term\_id' => $term\_id )); |
  | 875 |  | } |
  | 876 |  |  |
  | 877 |  | public function reset\_post\_terms($post\_id){ |
  | 878 |  | $this->wpdb->query( |
  | 879 |  | $this->wpdb->prepare( |
  | 880 |  | "DELETE FROM {$this->wpdb->prefix}term\_relationships WHERE object\_id = %d", |
  | 881 |  | $post\_id, |
  | 882 |  | ) |
  | 883 |  | ); |
  | 884 |  | } |
  | 885 |  |  |
  | 886 |  | public function add\_update\_postmeta($meta\_data = null, $post\_id = null){ |
  | 887 |  |  |
  | 888 |  | if(!empty($meta\_data) && is\_array($meta\_data)){ |
  | 889 |  | foreach($meta\_data as $k => $v){ |
  | 890 |  | if(isset($v[0])){ |
  | 891 |  | $checkSerialize = @unserialize($v[0]); |
  | 892 |  | $metaVal = ($checkSerialize !== false || $v[0] === 'b:0;') ? unserialize($v[0]) : $v[0]; |
  | 893 |  | if ( metadata\_exists('post',$post\_id,$k) ) { |
  | 894 |  | update\_post\_meta($post\_id,$k,$metaVal); |
  | 895 |  | }else{ |
  | 896 |  | add\_post\_meta($post\_id,$k,$metaVal); |
  | 897 |  | } |
  | 898 |  | } |
  | 899 |  | } |
  | 900 |  |  |
  | 901 |  | //if \_elementor\_css this key not existing then it's giving a error. |
  | 902 |  | if(array\_key\_exists('\_elementor\_version',$meta\_data)){ |
  | 903 |  | if(!array\_key\_exists('\_elementor\_css',$meta\_data)){ |
  | 904 |  | /\*$elementor\_css = [ |
  | 905 |  | 'time' => time(), |
  | 906 |  | 'fonts' => [], |
  | 907 |  | 'icons' => [], |
  | 908 |  | 'dynamic\_elements\_ids' => [], |
  | 909 |  | 'status' => 'empty', |
  | 910 |  | 'css' => '' |
  | 911 |  | ]; |
  | 912 |  | \*/ |
  | 913 |  | $elementor\_css = []; |
  | 914 |  | add\_post\_meta($post\_id,'\_elementor\_css',$elementor\_css); |
  | 915 |  | } |
  | 916 |  | } |
  | 917 |  |  |
  | 918 |  | //delete the edit lock post |
  | 919 |  | delete\_post\_meta($post\_id,'\_edit\_lock'); |
  | 920 |  | } |
  | 921 |  | } |
  | 922 |  |  |
  | 923 |  | public function postData($posts = null, $op = null){ |
  | 924 |  | $args = array( |
  | 925 |  | 'post\_author' => $posts['post\_author'], |
  | 926 |  | 'post\_date' => $posts['post\_date'], |
  | 927 |  | 'post\_date\_gmt' => $posts['post\_date\_gmt'], |
  | 928 |  | 'post\_content' => $posts['post\_content'], |
  | 929 |  | 'post\_title' => $posts['post\_title'], |
  | 930 |  | 'post\_excerpt' => $posts['post\_excerpt'], |
  | 931 |  | 'post\_status' => $posts['post\_status'], |
  | 932 |  | 'comment\_status' => $posts['comment\_status'], |
  | 933 |  | 'ping\_status' => $posts['ping\_status'], |
  | 934 |  | 'post\_password' => $posts['post\_password'], |
  | 935 |  | 'post\_name' => $posts['post\_name'], |
  | 936 |  | 'to\_ping' => $posts['to\_ping'], |
  | 937 |  | 'pinged' => $posts['pinged'], |
  | 938 |  | 'post\_modified' => $posts['post\_modified'], |
  | 939 |  | 'post\_modified\_gmt' => $posts['post\_modified\_gmt'], |
  | 940 |  | 'post\_content\_filtered' => $posts['post\_content\_filtered'], |
  | 941 |  | 'post\_parent' => $posts['post\_parent'], |
  | 942 |  | //'guid' => $posts['guid'], |
  | 943 |  | 'menu\_order' => $posts['menu\_order'], |
  | 944 |  | 'post\_type' => $posts['post\_type'], |
  | 945 |  | 'post\_mime\_type' => $posts['post\_mime\_type'], |
  | 946 |  | 'comment\_count' => $posts['comment\_count'], |
  | 947 |  | 'filter' => $posts['filter'], |
  | 948 |  | ); |
  | 949 |  | #ID to update existing post |
  | 950 |  | if(isset($posts['ID']) && $posts['ID'] > 0){ |
  | 951 |  | $args = array\_merge(['ID'=> $posts['ID'] ],$args); |
  | 952 |  | } |
  | 953 |  | return $args; |
  | 954 |  | } |
  | 955 |  |  |
  | 956 |  | # import attechments form source to destination. |
  | 957 |  | public function handle\_attachments($attachment\_post, $attachment\_post\_meta, $file){ |
  | 958 |  | $reference\_id = ''; |
  | 959 |  | if(isset($attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0])){ |
  | 960 |  | $reference\_id = $attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0]; |
  | 961 |  | } |
  | 962 |  | $attachment\_id = $this->get\_post\_by\_reference\_Id($attachment\_post['post\_type'], $reference\_id, $attachment\_post['post\_name']); |
  | 963 |  | if(!$attachment\_id){ |
  | 964 |  | $filename = basename($file); |
  | 965 |  | $arrContextOptions=array( |
  | 966 |  | "ssl"=>array( |
  | 967 |  | "verify\_peer"=>false, |
  | 968 |  | "verify\_peer\_name"=>false, |
  | 969 |  | ), |
  | 970 |  | ); |
  | 971 |  | $parent\_post\_id = 0; |
  | 972 |  | $upload\_file = wp\_upload\_bits($filename, null, file\_get\_contents($file,false, stream\_context\_create($arrContextOptions))); |
  | 973 |  | if (!$upload\_file['error']) { |
  | 974 |  | $wp\_filetype = wp\_check\_filetype($filename, null ); |
  | 975 |  | $attachment = array( |
  | 976 |  | 'post\_mime\_type' => $wp\_filetype['type'], |
  | 977 |  | 'post\_parent' => $parent\_post\_id, |
  | 978 |  | 'post\_title' => preg\_replace('/\.[^.]+$/', '', $filename), |
  | 979 |  | 'post\_content' => '', |
  | 980 |  | 'post\_status' => 'inherit' |
  | 981 |  | ); |
  | 982 |  | require\_once(ABSPATH . "wp-admin" . '/includes/image.php'); |
  | 983 |  | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
  | 984 |  | require\_once(ABSPATH . "wp-admin" . '/includes/media.php'); |
  | 985 |  | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
  | 986 |  | if (!is\_wp\_error($attachment\_id)) { |
  | 987 |  | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
  | 988 |  | wp\_update\_attachment\_metadata( $attachment\_id,  $attachment\_data ); |
  | 989 |  | $this->add\_update\_postmeta(['instawp\_event\_sync\_reference\_id' =>[$reference\_id]], $attachment\_id); |
  | 990 |  | } |
  | 991 |  | return $attachment\_id; |
  | 992 |  | } |
  | 993 |  | return; |
  | 994 |  | } |
  | 995 |  | return $attachment\_id; |
  | 996 |  | } |
  | 997 |  | # import attechments form source to destination. |
  | 998 |  | public function insert\_attachment($attachment\_id = null, $file = null){ |
  | 999 |  | $filename = basename($file); |
  | 1000 |  | $arrContextOptions=array( |
  | 1001 |  | "ssl"=>array( |
  | 1002 |  | "verify\_peer"=>false, |
  | 1003 |  | "verify\_peer\_name"=>false, |
  | 1004 |  | ), |
  | 1005 |  | ); |
  | 1006 |  | $parent\_post\_id = 0; |
  | 1007 |  | $upload\_file = wp\_upload\_bits($filename, null, file\_get\_contents($file,false, stream\_context\_create($arrContextOptions))); |
  | 1008 |  | if (!$upload\_file['error']) { |
  | 1009 |  | $wp\_filetype = wp\_check\_filetype($filename, null ); |
  | 1010 |  | $attachment = array( |
  | 1011 |  | 'import\_id' => $attachment\_id, |
  | 1012 |  | 'post\_mime\_type' => $wp\_filetype['type'], |
  | 1013 |  | 'post\_parent' => $parent\_post\_id, |
  | 1014 |  | 'post\_title' => preg\_replace('/\.[^.]+$/', '', $filename), |
  | 1015 |  | 'post\_content' => '', |
  | 1016 |  | 'post\_status' => 'inherit' |
  | 1017 |  | ); |
  | 1018 |  | require\_once(ABSPATH . "wp-admin" . '/includes/image.php'); |
  | 1019 |  | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
  | 1020 |  | require\_once(ABSPATH . "wp-admin" . '/includes/media.php'); |
  | 1021 |  | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
  | 1022 |  | if (!is\_wp\_error($attachment\_id)) { |
  | 1023 |  | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
  | 1024 |  | wp\_update\_attachment\_metadata( $attachment\_id,  $attachment\_data ); |
  | 1025 |  | } |
  | 1026 |  | } |
  | 1027 |  | return $attachment\_id; |
  | 1028 |  | } |
  | 1029 |  |  |
  | 1030 |  | #Insert history |
  | 1031 |  | public function sync\_history\_save($body = null, $changes = null,$status = null){ |
  | 1032 |  | $dir = 'dev-to-live'; |
  | 1033 |  | $date = date('Y-m-d H:i:s'); |
  | 1034 |  | $bodyArr = json\_decode($body); |
  | 1035 |  | $message = isset($bodyArr->sync\_message) ? $bodyArr->sync\_message : ''; |
  | 1036 |  | $data = [ |
  | 1037 |  | 'encrypted\_contents' => $bodyArr->encrypted\_contents, |
  | 1038 |  | 'changes' => json\_encode($changes), |
  | 1039 |  | 'sync\_response' => '', |
  | 1040 |  | 'direction' => $dir, |
  | 1041 |  | 'status' => $status, |
  | 1042 |  | 'user\_id' => isset($bodyArr->upload\_wp\_user) ? $bodyArr->upload\_wp\_user : '', |
  | 1043 |  | 'changes\_sync\_id' => isset($bodyArr->sync\_id) ? $bodyArr->sync\_id : '', |
  | 1044 |  | 'sync\_message' => $message, |
  | 1045 |  | 'source\_connect\_id' => '', |
  | 1046 |  | 'source\_url' => isset($bodyArr->source\_url) ? $bodyArr->source\_url : '', |
  | 1047 |  | 'date' => $date, |
  | 1048 |  | ]; |
  | 1049 |  | $this->InstaWP\_db->insert($this->tables['sh\_table'],$data); |
  | 1050 |  | } |
  | 1051 |  |  |
  | 1052 |  | #Plugin activate. |
  | 1053 |  | public function plugin\_activation( $plugin ) { |
  | 1054 |  | if( ! function\_exists('activate\_plugin') ) { |
  | 1055 |  | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  | 1056 |  | } |
  | 1057 |  |  |
  | 1058 |  | if( ! is\_plugin\_active( $plugin ) ) { |
  | 1059 |  | activate\_plugin( $plugin ); |
  | 1060 |  | } |
  | 1061 |  | } |
  | 1062 |  |  |
  | 1063 |  | #Plugin deactivate. |
  | 1064 |  | public function plugin\_deactivation( $plugin ) { |
  | 1065 |  | if( ! function\_exists('deactivate\_plugins') ) { |
  | 1066 |  | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  | 1067 |  | } |
  | 1068 |  | if( is\_plugin\_active( $plugin ) ) { |
  | 1069 |  | deactivate\_plugins( $plugin ); |
  | 1070 |  | } |
  | 1071 |  | } |
  | 1072 |  |  |
  | 1073 |  | public function sync\_message($rel = null){ |
  | 1074 |  | if(isset($rel->ID)){ |
  | 1075 |  | $message = 'Sync successfully.'; |
  | 1076 |  | }else{ |
  | 1077 |  | $message = 'Something went wrong.'; |
  | 1078 |  | } |
  | 1079 |  | return $message; |
  | 1080 |  | } |
  | 1081 |  |  |
  | 1082 |  | public function sync\_post\_status($rel = null){ |
  | 1083 |  | $status = 'in\_progress'; |
  | 1084 |  | if(isset($rel->ID)){ |
  | 1085 |  | $status = 'completed'; |
  | 1086 |  | }else{ |
  | 1087 |  | $status = 'pending'; |
  | 1088 |  | } |
  | 1089 |  | return $status; |
  | 1090 |  | } |
  | 1091 |  |  |
  | 1092 |  | public function sync\_opration\_response($status = null, $message = null, $v = null){ |
  | 1093 |  | return [ |
  | 1094 |  | 'id' => $v->id, |
  | 1095 |  | 'status' => $status, |
  | 1096 |  | 'message' => $message |
  | 1097 |  | ]; |
  | 1098 |  | } |
  | 1099 |  |  |
  | 1100 |  | public function sync\_update($sync\_id = null, $data = null, $source\_connect\_id = null){ |
  | 1101 |  | global $InstaWP\_Curl; |
  | 1102 |  | $api\_doamin = InstaWP\_Setting::get\_api\_domain(); |
  | 1103 |  | $connect\_id = intval($source\_connect\_id); |
  | 1104 |  | $endpoint = '/api/v2/connects/'.$connect\_id.'/syncs/'.$sync\_id; |
  | 1105 |  | $url = $api\_doamin.$endpoint; #https://stage.instawp.io/api/v2/connects/241/syncs/450 |
  | 1106 |  | $api\_key = $this->get\_api\_key(); |
  | 1107 |  |  |
  | 1108 |  | try{ |
  | 1109 |  | $curl = curl\_init(); |
  | 1110 |  | curl\_setopt\_array($curl, array( |
  | 1111 |  | CURLOPT\_URL => $url, |
  | 1112 |  | CURLOPT\_RETURNTRANSFER => true, |
  | 1113 |  | CURLOPT\_ENCODING => '', |
  | 1114 |  | CURLOPT\_MAXREDIRS => 10, |
  | 1115 |  | CURLOPT\_TIMEOUT => 0, |
  | 1116 |  | CURLOPT\_FOLLOWLOCATION => true, |
  | 1117 |  | CURLOPT\_HTTP\_VERSION => CURL\_HTTP\_VERSION\_1\_1, |
  | 1118 |  | CURLOPT\_CUSTOMREQUEST => 'PATCH', |
  | 1119 |  | CURLOPT\_POSTFIELDS => json\_encode($data), |
  | 1120 |  | CURLOPT\_HTTPHEADER => array( |
  | 1121 |  | 'Authorization: Bearer '.$api\_key.'', |
  | 1122 |  | 'Content-Type: application/json' |
  | 1123 |  | ), |
  | 1124 |  | )); |
  | 1125 |  |  |
  | 1126 |  | $response = curl\_exec($curl); |
  | 1127 |  | return $response; |
  | 1128 |  | } catch (Exception $e) { |
  | 1129 |  | return $e->getMessage(); |
  | 1130 |  | } |
  | 1131 |  | } |
  | 1132 |  |  |
  | 1133 |  | function get\_api\_key(){ |
  | 1134 |  | $instawp\_api\_options = get\_option('instawp\_api\_options'); |
  | 1135 |  | return $instawp\_api\_options['api\_key']; |
  | 1136 |  | } |
  | 1137 |  |  |
  | 1138 |  | /\* |
  | 1139 |  | \* Create elementor css file 'post-{post\_id}.css' |
  | 1140 |  | \*/ |
  | 1141 |  | public function create\_elementor\_css\_file($data = null, $post\_id = null){ |
  | 1142 |  | $upload\_dir = wp\_upload\_dir(); |
  | 1143 |  | $filename = 'post-'.$post\_id.'.css'; |
  | 1144 |  | $filePath = $upload\_dir['basedir'].'/elementor/css/'.$filename; |
  | 1145 |  | $file = fopen($filePath, "w+");//w+,w |
  | 1146 |  | fwrite($file, $data); |
  | 1147 |  | fclose($file); |
  | 1148 |  | } |
  | 1149 |  |  |
  | 1150 |  | /\*\* |
  | 1151 |  | \* Plugin install |
  | 1152 |  | \*/ |
  | 1153 |  | public function plugin\_install($plugin\_slug){ |
  | 1154 |  | include\_once( ABSPATH . 'wp-admin/includes/plugin-install.php' ); //for plugins\_api.. |
  | 1155 |  | $api = plugins\_api( 'plugin\_information', array( |
  | 1156 |  | 'slug' => $plugin\_slug, |
  | 1157 |  | 'fields' => array( |
  | 1158 |  | 'short\_description' => false, |
  | 1159 |  | 'sections' => false, |
  | 1160 |  | 'requires' => false, |
  | 1161 |  | 'rating' => false, |
  | 1162 |  | 'ratings' => false, |
  | 1163 |  | 'downloaded' => false, |
  | 1164 |  | 'last\_updated' => false, |
  | 1165 |  | 'added' => false, |
  | 1166 |  | 'tags' => false, |
  | 1167 |  | 'compatibility' => false, |
  | 1168 |  | 'homepage' => false, |
  | 1169 |  | 'donate\_link' => false, |
  | 1170 |  | ), |
  | 1171 |  | )); |
  | 1172 |  | //includes necessary for Plugin\_Upgrader and Plugin\_Installer\_Skin |
  | 1173 |  | include\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
  | 1174 |  | include\_once( ABSPATH . 'wp-admin/includes/misc.php' ); |
  | 1175 |  | include\_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' ); |
  | 1176 |  | $upgrader = new Plugin\_Upgrader( new Plugin\_Installer\_Skin( compact('title', 'url', 'nonce', 'plugin', 'api') ) ); |
  | 1177 |  | $upgrader->install($api->download\_link); |
  | 1178 |  | } |
  | 1179 |  |  |
  | 1180 |  | /\*\* |
  | 1181 |  | \* Check if plugin is installed by getting all plugins from the plugins dir |
  | 1182 |  | \* |
  | 1183 |  | \* @param $plugin\_slug |
  | 1184 |  | \* |
  | 1185 |  | \* @return bool |
  | 1186 |  | \*/ |
  | 1187 |  | public function check\_plugin\_installed( $plugin\_slug ): bool { |
  | 1188 |  | $installed\_plugins = get\_plugins(); |
  | 1189 |  | return array\_key\_exists( $plugin\_slug, $installed\_plugins ) || in\_array( $plugin\_slug, $installed\_plugins, true ); |
  | 1190 |  | } |
  | 1191 |  |  |
  | 1192 |  | //add and update user meta |
  | 1193 |  | public function add\_update\_usermeta($user\_meta = null, $user\_id = null){ |
  | 1194 |  | if(!empty($user\_meta) && is\_array($user\_meta)){ |
  | 1195 |  | foreach($user\_meta as $k => $v){ |
  | 1196 |  | if(isset($v[0])){ |
  | 1197 |  | $checkSerialize = @unserialize($v[0]); |
  | 1198 |  | $metaVal = ($checkSerialize !== false || $v[0] === 'b:0;') ? unserialize($v[0]) : $v[0]; |
  | 1199 |  | if ( metadata\_exists('user',$user\_id,$k) ) { |
  | 1200 |  | update\_user\_meta($user\_id,$k,$metaVal); |
  | 1201 |  | }else{ |
  | 1202 |  | add\_user\_meta($user\_id,$k,$metaVal); |
  | 1203 |  | } |
  | 1204 |  | } |
  | 1205 |  | } |
  | 1206 |  | } |
  | 1207 |  | } |
  | 1208 |  |  |
  | 1209 |  | /\*\* |
  | 1210 |  | \* Set Astra Costmizer Setings |
  | 1211 |  | \*/ |
  | 1212 |  | function setAstraCostmizerSetings($arr = null){ |
  | 1213 |  | #Checkout |
  | 1214 |  | update\_option('woocommerce\_checkout\_company\_field',$arr['woocommerce\_checkout\_company\_field']); |
  | 1215 |  | update\_option('woocommerce\_checkout\_address\_2\_field',$arr['woocommerce\_checkout\_address\_2\_field']); |
  | 1216 |  | update\_option('woocommerce\_checkout\_phone\_field',$arr['woocommerce\_checkout\_phone\_field']); |
  | 1217 |  | update\_option('woocommerce\_checkout\_highlight\_required\_fields',$arr['woocommerce\_checkout\_highlight\_required\_fields']); |
  | 1218 |  | update\_option('wp\_page\_for\_privacy\_policy',$arr['wp\_page\_for\_privacy\_policy']); |
  | 1219 |  | update\_option('woocommerce\_terms\_page\_id',$arr['woocommerce\_terms\_page\_id']); |
  | 1220 |  | update\_option('woocommerce\_checkout\_privacy\_policy\_text',$arr['woocommerce\_checkout\_privacy\_policy\_text']); |
  | 1221 |  | update\_option('woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text',$arr['woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text']); |
  | 1222 |  |  |
  | 1223 |  | #product catalog |
  | 1224 |  | update\_option('woocommerce\_shop\_page\_display',$arr['woocommerce\_shop\_page\_display']); |
  | 1225 |  | update\_option('woocommerce\_default\_catalog\_orderby',$arr['woocommerce\_default\_catalog\_orderby']); |
  | 1226 |  | update\_option('woocommerce\_category\_archive\_display',$arr['woocommerce\_category\_archive\_display']); |
  | 1227 |  |  |
  | 1228 |  | #Product Images |
  | 1229 |  | update\_option('woocommerce\_single\_image\_width',$arr['woocommerce\_single\_image\_width']); |
  | 1230 |  | update\_option('woocommerce\_thumbnail\_image\_width',$arr['woocommerce\_thumbnail\_image\_width']); |
  | 1231 |  | update\_option('woocommerce\_thumbnail\_cropping',$arr['woocommerce\_thumbnail\_cropping']); |
  | 1232 |  | update\_option('woocommerce\_thumbnail\_cropping\_custom\_width',$arr['woocommerce\_thumbnail\_cropping\_custom\_width']); |
  | 1233 |  | update\_option('woocommerce\_thumbnail\_cropping\_custom\_height',$arr['woocommerce\_thumbnail\_cropping\_custom\_height']); |
  | 1234 |  |  |
  | 1235 |  | #Store Notice |
  | 1236 |  | update\_option('woocommerce\_demo\_store',$arr['woocommerce\_demo\_store']); |
  | 1237 |  | update\_option('woocommerce\_demo\_store\_notice',$arr['woocommerce\_demo\_store\_notice']); |
  | 1238 |  | } |
  |  | 25 | if ( ! class\_exists( 'InstaWP\_Backup\_Api' ) ) { |
  |  | 26 | require\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-rest-api.php'; |
  | 1239 | 27 | } |
  |  | 28 |  |
  |  | 29 |  |
  |  | 30 | class InstaWP\_Rest\_Apis extends InstaWP\_Backup\_Api { |
  |  | 31 |  |
  |  | 32 | private $wpdb; |
  |  | 33 |  |
  |  | 34 | private $InstaWP\_db; |
  |  | 35 |  |
  |  | 36 | private $tables; |
  |  | 37 |  |
  |  | 38 | public function \_\_construct() { |
  |  | 39 |  |
  |  | 40 | parent::\_\_construct(); |
  |  | 41 |  |
  |  | 42 | global $wpdb; |
  |  | 43 |  |
  |  | 44 | $this->wpdb = $wpdb; |
  |  | 45 |  |
  |  | 46 | $this->InstaWP\_db = new InstaWP\_DB(); |
  |  | 47 |  |
  |  | 48 | $this->tables = $this->InstaWP\_db->tables; |
  |  | 49 |  |
  |  | 50 | /\* |
  |  | 51 | \* Initiate Sync |
  |  | 52 | \* Endpoint : /wp-json/instawp-connect/v1/sync |
  |  | 53 | \* HOOK - rest\_api\_init |
  |  | 54 | \*/ |
  |  | 55 |  |
  |  | 56 | add\_action( 'rest\_api\_init', function () { |
  |  | 57 | register\_rest\_route( 'instawp-connect/v1', '/sync', |
  |  | 58 | array( |
  |  | 59 | 'methods'             => 'POST', |
  |  | 60 | 'callback'            => [ $this, 'events\_receiver' ], |
  |  | 61 | 'permission\_callback' => [ $this, 'check\_permission' ], |
  |  | 62 | ) |
  |  | 63 | ); |
  |  | 64 | } ); |
  |  | 65 | } |
  |  | 66 |  |
  |  | 67 | function check\_permission() { |
  |  | 68 | return true; |
  |  | 69 | } |
  |  | 70 |  |
  |  | 71 | public function get\_post\_by\_reference\_Id( $post\_type, $reference\_id, $post\_name ) { |
  |  | 72 | $post = get\_posts( array( |
  |  | 73 | 'post\_type'   => $post\_type, |
  |  | 74 | 'meta\_key'    => 'instawp\_event\_sync\_reference\_id', |
  |  | 75 | 'meta\_value'  => $reference\_id, |
  |  | 76 | 'post\_status' => 'any' |
  |  | 77 | ) ); |
  |  | 78 | if ( ! empty( $post ) ) { |
  |  | 79 | $post = $post[0]; |
  |  | 80 | } else { |
  |  | 81 | $post = instawp\_get\_post\_by\_name( $post\_name, $post\_type ); |
  |  | 82 | } |
  |  | 83 |  |
  |  | 84 | return $post; |
  |  | 85 | } |
  |  | 86 |  |
  |  | 87 | public function create\_or\_update\_post( $post, $post\_meta ) { |
  |  | 88 | $reference\_id     = isset( $post\_meta['instawp\_event\_sync\_reference\_id'][0] ) ? $post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
  |  | 89 | $destination\_post = $this->get\_post\_by\_reference\_Id( $post['post\_type'], $reference\_id, $post['post\_name'] ); |
  |  | 90 | unset( $post['ID'] ); |
  |  | 91 | if ( ! empty( $destination\_post ) ) { |
  |  | 92 | #The post exists,Then update |
  |  | 93 | $post\_id = $post['ID'] = $destination\_post->ID; |
  |  | 94 | //$post['post\_parent'] = $destination\_post->post\_parent; |
  |  | 95 | $postData = $this->postData( $post ); |
  |  | 96 | wp\_update\_post( $postData ); |
  |  | 97 | #post meta |
  |  | 98 | $this->add\_update\_postmeta( $post\_meta, $destination\_post->ID ); |
  |  | 99 | } else { |
  |  | 100 | $postData = $this->postData( $post ); |
  |  | 101 | #The post does not exist,Then insert |
  |  | 102 | $post\_id = wp\_insert\_post( $postData ); |
  |  | 103 | #post meta |
  |  | 104 | $this->add\_update\_postmeta( $post\_meta, $post\_id ); |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 | return $post\_id; |
  |  | 108 | } |
  |  | 109 |  |
  |  | 110 |  |
  |  | 111 | /\*\* |
  |  | 112 | \* Handle events receiver api |
  |  | 113 | \* |
  |  | 114 | \* @param WP\_REST\_Request $req |
  |  | 115 | \* |
  |  | 116 | \* @return WP\_Error|WP\_HTTP\_Response|WP\_REST\_Response |
  |  | 117 | \*/ |
  |  | 118 | public function events\_receiver( WP\_REST\_Request $req ) { |
  |  | 119 |  |
  |  | 120 | $response = $this->validate\_api\_request( $req ); |
  |  | 121 | if ( is\_wp\_error( $response ) ) { |
  |  | 122 | return $this->throw\_error( $response ); |
  |  | 123 | } |
  |  | 124 |  |
  |  | 125 | $body               = $req->get\_body(); |
  |  | 126 | $bodyArr            = json\_decode( $body ); |
  |  | 127 | $encrypted\_contents = json\_decode( $bodyArr->encrypted\_contents ); |
  |  | 128 | $sync\_id            = $bodyArr->sync\_id; |
  |  | 129 | $source\_connect\_id  = $bodyArr->source\_connect\_id; |
  |  | 130 | $is\_enabled         = false; |
  |  | 131 |  |
  |  | 132 |  |
  |  | 133 | if ( get\_option( 'syncing\_enabled\_disabled' ) ) { |
  |  | 134 | $is\_enabled = true; |
  |  | 135 | } |
  |  | 136 |  |
  |  | 137 | #forcely disable the syncing at the destination |
  |  | 138 | update\_option( 'syncing\_enabled\_disabled', 0 ); |
  |  | 139 |  |
  |  | 140 | if ( ! empty( $encrypted\_contents ) && is\_array( $encrypted\_contents ) ) { |
  |  | 141 | $total\_op        = count( $encrypted\_contents ); |
  |  | 142 | $count           = 1; |
  |  | 143 | $progress\_status = 'pending'; |
  |  | 144 | $changes         = $sync\_response = []; |
  |  | 145 | foreach ( $encrypted\_contents as $v ) { |
  |  | 146 |  |
  |  | 147 | $source\_id = ( isset( $v->source\_id ) && ! empty( $v->source\_id ) ) ? intval( $v->source\_id ) : null; |
  |  | 148 |  |
  |  | 149 | /\* |
  |  | 150 | \*Post Operations |
  |  | 151 | \*/ |
  |  | 152 | //create and update |
  |  | 153 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'post\_change' || $v->event\_slug == 'post\_new' ) ) { |
  |  | 154 | $posts          = isset( $v->details->posts ) ? (array) $v->details->posts : ''; |
  |  | 155 | $postmeta       = isset( $v->details->postmeta ) ? (array) $v->details->postmeta : ''; |
  |  | 156 | $featured\_image = isset( $v->details->featured\_image ) ? (array) $v->details->featured\_image : ''; |
  |  | 157 | $media          = isset( $v->details->media ) ? (array) $v->details->media : ''; |
  |  | 158 |  |
  |  | 159 | $parent\_post = isset( $v->details->parent->post ) ? (array) $v->details->parent->post : []; |
  |  | 160 |  |
  |  | 161 | #check for the post parent |
  |  | 162 | if ( ! empty( $parent\_post ) ) { |
  |  | 163 | $parent\_post\_meta = isset( $v->details->parent->post\_meta ) ? (array) $v->details->parent->post\_meta : []; |
  |  | 164 | $reference\_id     = isset( $parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0] ) ? $parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
  |  | 165 | $destination\_post = $this->get\_post\_by\_reference\_Id( $parent\_post['post\_type'], $reference\_id, $parent\_post['post\_name'] ); |
  |  | 166 | if ( ! empty( $destination\_post ) ) { |
  |  | 167 | $posts['post\_parent'] = $destination\_post->ID; |
  |  | 168 | } |
  |  | 169 | } |
  |  | 170 |  |
  |  | 171 | if ( $posts['post\_type'] == 'attachment' ) { |
  |  | 172 | //create or update the attachments |
  |  | 173 | $posts['ID'] = $this->handle\_attachments( $posts, $postmeta, $posts['guid'] ); |
  |  | 174 | #update meta |
  |  | 175 | $this->add\_update\_postmeta( $postmeta, $posts['ID'] ); |
  |  | 176 | } else { |
  |  | 177 | $posts['ID'] = $this->create\_or\_update\_post( $posts, $postmeta ); |
  |  | 178 | } |
  |  | 179 |  |
  |  | 180 | #feature image import |
  |  | 181 | if ( isset( $featured\_image['media'] ) && ! empty( $featured\_image['media'] ) ) { |
  |  | 182 | $att\_id = $this->handle\_attachments( (array) $featured\_image['media'], (array) $featured\_image['media\_meta'], $featured\_image['featured\_image\_url'] ); |
  |  | 183 | if ( isset( $att\_id ) && ! empty( $att\_id ) ) { |
  |  | 184 | set\_post\_thumbnail( $posts['ID'], $att\_id ); |
  |  | 185 | } |
  |  | 186 | } |
  |  | 187 |  |
  |  | 188 | #if post type is product then set gallery |
  |  | 189 | if ( get\_post\_type( $posts['ID'] ) == 'product' ) { |
  |  | 190 | if ( isset( $v->details->product\_gallery ) && ! empty( $v->details->product\_gallery ) ) { |
  |  | 191 | $product\_gallery = $v->details->product\_gallery; |
  |  | 192 | $gallery\_ids     = []; |
  |  | 193 | //pr($product\_gallery); |
  |  | 194 | foreach ( $product\_gallery as $gallery ) { |
  |  | 195 | if ( isset( $gallery->media ) && ! empty( $gallery->media ) && isset( $gallery->url ) && $gallery->url != '' ) { |
  |  | 196 | $gallery\_ids[] = $this->handle\_attachments( (array) $gallery->media, (array) $gallery->media\_meta, $gallery->url ); |
  |  | 197 | } |
  |  | 198 | } |
  |  | 199 | $this->set\_product\_gallery( $posts['ID'], $gallery\_ids ); |
  |  | 200 | } |
  |  | 201 | } |
  |  | 202 |  |
  |  | 203 | #terms in post |
  |  | 204 | $taxonomies = (array) $v->details->taxonomies; |
  |  | 205 | $this->reset\_post\_terms( $posts['ID'] ); //rest the terms for all taxo |
  |  | 206 | if ( ! empty( $taxonomies ) && is\_array( $taxonomies ) ) { |
  |  | 207 | foreach ( $taxonomies as $taxonomy => $terms ) { |
  |  | 208 | $terms    = (array) $terms; |
  |  | 209 | $term\_ids = []; |
  |  | 210 | # if term not exist then create first |
  |  | 211 | if ( ! empty( $terms ) && is\_array( $terms ) ) { |
  |  | 212 | foreach ( $terms as $term ) { |
  |  | 213 | $term = (array) $term; |
  |  | 214 | if ( ! term\_exists( $term['slug'], $taxonomy ) ) { |
  |  | 215 | $inserted\_term = wp\_insert\_term( |
  |  | 216 | $term['name'],   // the term |
  |  | 217 | $taxonomy, // the taxonomy |
  |  | 218 | array( |
  |  | 219 | 'description' => $term['description'], |
  |  | 220 | 'slug'        => $term['slug'], |
  |  | 221 | 'parent'      => 0 |
  |  | 222 | ) |
  |  | 223 | ); |
  |  | 224 | $term\_ids[]    = $inserted\_term['term\_id']; |
  |  | 225 | } else { |
  |  | 226 | $get\_term\_by = (array) get\_term\_by( 'slug', $term['slug'], $taxonomy ); |
  |  | 227 | $term\_ids[]  = $get\_term\_by['term\_id']; |
  |  | 228 | } |
  |  | 229 | } |
  |  | 230 | } |
  |  | 231 | #set terms in post |
  |  | 232 | wp\_set\_post\_terms( $posts['ID'], $term\_ids, $taxonomy ); |
  |  | 233 | } |
  |  | 234 | } |
  |  | 235 |  |
  |  | 236 | # media upload from content |
  |  | 237 | $this->upload\_content\_media( $media, $posts['ID'] ); |
  |  | 238 |  |
  |  | 239 | #message |
  |  | 240 | $message         = 'Sync successfully.'; |
  |  | 241 | $status          = 'completed'; |
  |  | 242 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 243 | #changes |
  |  | 244 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 245 | } |
  |  | 246 |  |
  |  | 247 | //Post trash |
  |  | 248 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'post\_trash' ) { |
  |  | 249 | if ( isset( $source\_id ) ) { |
  |  | 250 | $posts                = (array) $v->details->posts; |
  |  | 251 | $postmeta             = (array) $v->details->postmeta; |
  |  | 252 | $post\_by\_reference\_id = get\_posts( array( |
  |  | 253 | 'post\_type'  => $posts['post\_type'], |
  |  | 254 | 'meta\_key'   => 'instawp\_event\_sync\_reference\_id', |
  |  | 255 | 'meta\_value' => isset( $postmeta['instawp\_event\_sync\_reference\_id'][0] ) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  |  | 256 | ) ); |
  |  | 257 |  |
  |  | 258 | if ( ! empty( $post\_by\_reference\_id ) ) { |
  |  | 259 | $post\_id = $post\_by\_reference\_id[0]->ID; |
  |  | 260 | $rel     = wp\_trash\_post( $post\_id );  //Post data on success, false or null on failure. |
  |  | 261 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 262 | $message = $this->sync\_message( $rel ); |
  |  | 263 | } else { |
  |  | 264 | $post\_check\_data = instawp\_get\_post\_by\_name( str\_replace( '\_\_trashed', '', $posts['post\_name'] ), $posts['post\_type'] ); |
  |  | 265 | if ( ! empty( $post\_check\_data ) ) { |
  |  | 266 | $rel     = wp\_trash\_post( $post\_check\_data->ID );  //Post data on success, false or null on failure. |
  |  | 267 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 268 | $message = $this->sync\_message( $rel ); |
  |  | 269 | } else { |
  |  | 270 | $status  = 'pending'; |
  |  | 271 | $message = $this->notExistMsg(); |
  |  | 272 | } |
  |  | 273 | } |
  |  | 274 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 275 | #changes |
  |  | 276 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 277 | } |
  |  | 278 | } |
  |  | 279 |  |
  |  | 280 | //Post permanently delete |
  |  | 281 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'post\_delete' ) { |
  |  | 282 | if ( isset( $source\_id ) ) { |
  |  | 283 | $posts                = (array) $v->details->posts; |
  |  | 284 | $postmeta             = (array) $v->details->postmeta; |
  |  | 285 | $post\_by\_reference\_id = get\_posts( [ |
  |  | 286 | 'post\_status' => 'trash', |
  |  | 287 | 'post\_type'   => $posts['post\_type'], |
  |  | 288 | 'nopaging'    => true, |
  |  | 289 | 'meta\_query'  => array( |
  |  | 290 | array( |
  |  | 291 | 'key'     => 'instawp\_event\_sync\_reference\_id', |
  |  | 292 | 'value'   => isset( $postmeta['instawp\_event\_sync\_reference\_id'][0] ) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  |  | 293 | 'compare' => '=', |
  |  | 294 | ), |
  |  | 295 | ), |
  |  | 296 | ] ); |
  |  | 297 |  |
  |  | 298 | if ( ! empty( $post\_by\_reference\_id ) ) { |
  |  | 299 | $post\_id = $post\_by\_reference\_id[0]->ID; |
  |  | 300 | $rel     = wp\_delete\_post( $post\_id );  //Post data on success, false or null on failure. |
  |  | 301 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 302 | $message = $this->sync\_message( $rel ); |
  |  | 303 | } else { |
  |  | 304 | $post\_check\_data = instawp\_get\_post\_by\_name( $posts['post\_name'], $posts['post\_type'] ); |
  |  | 305 | if ( ! empty( $post\_check\_data ) ) { |
  |  | 306 | $rel     = wp\_delete\_post( $post\_check\_data->ID );  //Post data on success, false or null on failure. |
  |  | 307 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 308 | $message = $this->sync\_message( $rel ); |
  |  | 309 | } else { |
  |  | 310 | $status  = 'pending'; |
  |  | 311 | $message = $this->notExistMsg(); |
  |  | 312 | } |
  |  | 313 | } |
  |  | 314 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 315 | #changes |
  |  | 316 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 317 | } |
  |  | 318 | } |
  |  | 319 |  |
  |  | 320 | //Post restored |
  |  | 321 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'untrashed\_post' ) { |
  |  | 322 | if ( isset( $source\_id ) ) { |
  |  | 323 | $posts                = (array) $v->details->posts; |
  |  | 324 | $postmeta             = (array) $v->details->postmeta; |
  |  | 325 | $post\_by\_reference\_id = get\_posts( [ |
  |  | 326 | 'post\_status' => 'trash', |
  |  | 327 | 'post\_type'   => $posts['post\_type'], |
  |  | 328 | 'nopaging'    => true, |
  |  | 329 | 'meta\_query'  => array( |
  |  | 330 | array( |
  |  | 331 | 'key'     => 'instawp\_event\_sync\_reference\_id', |
  |  | 332 | 'value'   => isset( $postmeta['instawp\_event\_sync\_reference\_id'][0] ) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  |  | 333 | 'compare' => '=', |
  |  | 334 | ), |
  |  | 335 | ), |
  |  | 336 | ] ); |
  |  | 337 |  |
  |  | 338 |  |
  |  | 339 | if ( ! empty( $post\_by\_reference\_id ) ) { |
  |  | 340 | $post\_id = $post\_by\_reference\_id[0]->ID; |
  |  | 341 | $rel     = wp\_untrash\_post( $post\_id ); |
  |  | 342 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 343 | $message = $this->sync\_message( $rel ); |
  |  | 344 | } else { |
  |  | 345 | $post\_check\_data = instawp\_get\_post\_by\_name( $posts['post\_name'] . '\_\_trashed', $posts['post\_type'] ); |
  |  | 346 | if ( ! empty( $post\_check\_data ) ) { |
  |  | 347 | $rel     = wp\_untrash\_post( $post\_check\_data->ID ); |
  |  | 348 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 349 | $message = $this->sync\_message( $rel ); |
  |  | 350 | } else { |
  |  | 351 | $status  = 'pending'; |
  |  | 352 | $message = $this->notExistMsg(); |
  |  | 353 | } |
  |  | 354 | } |
  |  | 355 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 356 | #changes |
  |  | 357 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 358 | } |
  |  | 359 | } |
  |  | 360 |  |
  |  | 361 | /\* |
  |  | 362 | \*Plugin Oprations |
  |  | 363 | \*/ |
  |  | 364 | //Plugin actiavte |
  |  | 365 | if ( isset( $v->details ) && $v->event\_slug == 'activate\_plugin' ) { |
  |  | 366 | $check\_plugin\_installed = $this->check\_plugin\_installed( $v->details ); |
  |  | 367 | if ( $check\_plugin\_installed != 1 ) { |
  |  | 368 | $pluginData = get\_plugin\_data( $v->details ); |
  |  | 369 | if ( ! empty( $pluginData['TextDomain'] ) ) { |
  |  | 370 | $this->plugin\_install( $pluginData['TextDomain'] ); |
  |  | 371 | } |
  |  | 372 | } |
  |  | 373 |  |
  |  | 374 | $this->plugin\_activation( $v->details ); |
  |  | 375 | #message |
  |  | 376 | $message         = 'Sync successfully.'; |
  |  | 377 | $status          = 'completed'; |
  |  | 378 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 379 | #changes |
  |  | 380 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 381 | } |
  |  | 382 |  |
  |  | 383 | //Plugin deactiavte |
  |  | 384 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'deactivate\_plugin' ) { |
  |  | 385 | $this->plugin\_deactivation( $v->details ); |
  |  | 386 | #message |
  |  | 387 | $message         = 'Sync successfully.'; |
  |  | 388 | $status          = 'completed'; |
  |  | 389 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 390 | #changes |
  |  | 391 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 392 | } |
  |  | 393 |  |
  |  | 394 | /\* |
  |  | 395 | \* Taxonomy Oprations |
  |  | 396 | \*/ |
  |  | 397 |  |
  |  | 398 | //create and update |
  |  | 399 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'create\_taxonomy' || $v->event\_slug == 'edit\_taxonomy' ) ) { |
  |  | 400 | if ( isset( $source\_id ) ) { |
  |  | 401 | $details          = (array) $v->details; |
  |  | 402 | $wp\_terms         = $this->wp\_terms\_data( $source\_id, $details ); |
  |  | 403 | $wp\_term\_taxonomy = $this->wp\_term\_taxonomy\_data( $source\_id, $details ); |
  |  | 404 | if ( ! term\_exists( $source\_id, $v->event\_type ) ) { |
  |  | 405 | if ( $v->event\_slug == 'create\_taxonomy' ) { |
  |  | 406 | $this->insert\_taxonomy( $source\_id, $wp\_terms, $wp\_term\_taxonomy ); |
  |  | 407 | clean\_term\_cache( $source\_id ); |
  |  | 408 | } |
  |  | 409 | } |
  |  | 410 | if ( term\_exists( $source\_id, $v->event\_type ) ) { |
  |  | 411 | if ( $v->event\_slug == 'edit\_taxonomy' ) { |
  |  | 412 | $this->update\_taxonomy( $source\_id, $wp\_terms, $wp\_term\_taxonomy ); |
  |  | 413 | } |
  |  | 414 | } |
  |  | 415 |  |
  |  | 416 | #message |
  |  | 417 | $message         = 'Sync successfully.'; |
  |  | 418 | $status          = 'completed'; |
  |  | 419 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 420 | #changes |
  |  | 421 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 422 |  |
  |  | 423 | } |
  |  | 424 | } |
  |  | 425 |  |
  |  | 426 | //Delete |
  |  | 427 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'delete\_taxonomy' ) { |
  |  | 428 | if ( isset( $source\_id ) ) { |
  |  | 429 | if ( term\_exists( $source\_id, $v->event\_type ) ) { |
  |  | 430 | $rel     = wp\_delete\_term( $source\_id, $v->event\_type ); |
  |  | 431 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 432 | $message = $this->sync\_message( $rel ); |
  |  | 433 | } |
  |  | 434 | } else { |
  |  | 435 | $status  = 'pending'; |
  |  | 436 | $message = $this->notExistMsg(); |
  |  | 437 | } |
  |  | 438 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 439 | #changes |
  |  | 440 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 441 | } |
  |  | 442 |  |
  |  | 443 | /\*\* |
  |  | 444 | \* Customizer settings update |
  |  | 445 | \*/ |
  |  | 446 |  |
  |  | 447 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'customizer\_changes' ) { |
  |  | 448 | $details = isset( $v->details ) ? $v->details : ''; |
  |  | 449 |  |
  |  | 450 | #custom logo |
  |  | 451 | $this->customizer\_custom\_logo( $details->custom\_logo ); |
  |  | 452 |  |
  |  | 453 | #background image |
  |  | 454 | $this->customizer\_background\_image( $details->background\_image ); |
  |  | 455 |  |
  |  | 456 | #site icon |
  |  | 457 | $this->customizer\_site\_icon( $details->site\_icon ); |
  |  | 458 |  |
  |  | 459 | #background color |
  |  | 460 | if ( isset( $details->background\_color ) && ! empty( $details->background\_color ) ) { |
  |  | 461 | set\_theme\_mod( 'background\_color', $details->background\_color ); |
  |  | 462 | } |
  |  | 463 |  |
  |  | 464 | #Site Title |
  |  | 465 | update\_option( 'blogname', $details->name ); |
  |  | 466 |  |
  |  | 467 | #Tagline |
  |  | 468 | $this->blogDescription( $details->description ); |
  |  | 469 |  |
  |  | 470 | #Homepage Settings |
  |  | 471 | if ( isset( $details->show\_on\_front ) && ! empty( $details->show\_on\_front ) ) { |
  |  | 472 | update\_option( 'show\_on\_front', $details->show\_on\_front ); |
  |  | 473 | } |
  |  | 474 |  |
  |  | 475 | #for 'Astra' theme |
  |  | 476 | if ( isset( $details->astra\_settings ) && ! empty( $details->astra\_settings ) ) { |
  |  | 477 | $astra\_settings = $this->object\_to\_array( $details->astra\_settings ); |
  |  | 478 | update\_option( 'astra-settings', $astra\_settings ); |
  |  | 479 | } |
  |  | 480 |  |
  |  | 481 | #nav menu locations |
  |  | 482 | if ( ! empty( $details->nav\_menu\_locations ) ) { |
  |  | 483 | $menu\_array = (array) $details->nav\_menu\_locations; |
  |  | 484 | set\_theme\_mod( 'nav\_menu\_locations', $menu\_array ); |
  |  | 485 | } |
  |  | 486 |  |
  |  | 487 | #Custom css post id |
  |  | 488 | $custom\_css\_post = (array) $details->custom\_css\_post; |
  |  | 489 | if ( ! empty( $details->custom\_css\_post ) ) { |
  |  | 490 | if ( get\_post\_status( $custom\_css\_post['ID'] ) ) { |
  |  | 491 | #The post exists,Then update |
  |  | 492 | $postData = $this->postData( $custom\_css\_post, 'update' ); |
  |  | 493 | wp\_update\_post( $postData ); |
  |  | 494 |  |
  |  | 495 | } else { |
  |  | 496 | $postData = $this->postData( $custom\_css\_post, 'insert' ); |
  |  | 497 | #The post does not exist,Then insert |
  |  | 498 | wp\_insert\_post( $postData ); |
  |  | 499 | } |
  |  | 500 | set\_theme\_mod( 'custom\_css\_post\_id', $custom\_css\_post['ID'] ); |
  |  | 501 | } |
  |  | 502 | $current\_theme = wp\_get\_theme(); |
  |  | 503 | if ( $current\_theme->Name == 'Astra' ) { #for 'Astra' theme |
  |  | 504 | $astra\_theme\_setting = isset( $details->astra\_theme\_customizer\_settings ) ? (array) $details->astra\_theme\_customizer\_settings : ''; |
  |  | 505 | $this->setAstraCostmizerSetings( $astra\_theme\_setting ); |
  |  | 506 | } else if ( $current\_theme->Name == 'Divi' ) {  #for 'Divi' theme |
  |  | 507 | $divi\_settings = isset( $details->divi\_settings ) ? (array) $details->divi\_settings : ''; |
  |  | 508 | if ( ! empty( $divi\_settings ) && is\_array( $divi\_settings ) ) { |
  |  | 509 | update\_option( 'et\_divi', $divi\_settings ); |
  |  | 510 | } |
  |  | 511 | } |
  |  | 512 |  |
  |  | 513 | #message |
  |  | 514 | $message         = 'Sync successfully.'; |
  |  | 515 | $status          = 'completed'; |
  |  | 516 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 517 | #changes |
  |  | 518 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 519 | } |
  |  | 520 |  |
  |  | 521 | /\*\* |
  |  | 522 | \* Woocommerce attributes |
  |  | 523 | \*/ |
  |  | 524 |  |
  |  | 525 | #create&upadte woocommerce attribute |
  |  | 526 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'woocommerce\_attribute\_added' || $v->event\_slug == 'woocommerce\_attribute\_updated' ) ) { |
  |  | 527 | $details = isset( $v->details ) ? (array) $v->details : ''; |
  |  | 528 | if ( ! empty( $details ) ) { |
  |  | 529 | $attribute = wc\_get\_attribute( 208 ); |
  |  | 530 | if ( ! empty( $attribute ) ) { |
  |  | 531 | unset( $details['id'] ); |
  |  | 532 | wc\_update\_attribute( $v->source\_id, $attribute ); |
  |  | 533 |  |
  |  | 534 | #message |
  |  | 535 | $message         = 'Sync successfully.'; |
  |  | 536 | $status          = 'completed'; |
  |  | 537 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 538 | #changes |
  |  | 539 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 540 | } else { |
  |  | 541 | $this->woocommerce\_create\_attribute( $v->source\_id, $details ); |
  |  | 542 |  |
  |  | 543 | #message |
  |  | 544 | $message         = 'Sync successfully.'; |
  |  | 545 | $status          = 'completed'; |
  |  | 546 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 547 | #changes |
  |  | 548 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 549 |  |
  |  | 550 | } |
  |  | 551 | } |
  |  | 552 | } |
  |  | 553 |  |
  |  | 554 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'woocommerce\_attribute\_deleted' ) { |
  |  | 555 | wc\_delete\_attribute( $v->source\_id ); |
  |  | 556 | #message |
  |  | 557 | $message         = 'Sync successfully.'; |
  |  | 558 | $status          = 'completed'; |
  |  | 559 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 560 | #changes |
  |  | 561 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 562 | } |
  |  | 563 |  |
  |  | 564 | /\*\* |
  |  | 565 | \* Users actions |
  |  | 566 | \*/ |
  |  | 567 | if ( isset( $v->event\_type ) && $v->event\_type == 'users' ) { |
  |  | 568 | $user\_data = isset( $v->details->user\_data ) ? (array) $v->details->user\_data : ''; |
  |  | 569 | $user\_meta = isset( $v->details->user\_meta ) ? (array) $v->details->user\_meta : ''; |
  |  | 570 | //$user = get\_userdata($v->source\_id); |
  |  | 571 | $user\_table = $this->wpdb->prefix . 'users'; |
  |  | 572 |  |
  |  | 573 | $get\_user\_by\_reference\_id = get\_users( array( |
  |  | 574 | 'meta\_key'   => 'instawp\_event\_user\_sync\_reference\_id', |
  |  | 575 | 'meta\_value' => isset( $user\_meta['instawp\_event\_sync\_reference\_id'][0] ) ? $user\_meta['instawp\_event\_sync\_reference\_id'][0] : '', |
  |  | 576 | ) ); |
  |  | 577 |  |
  |  | 578 | $user = ! empty( $get\_user\_by\_reference\_id ) ? $get\_user\_by\_reference\_id[0] : get\_user\_by( 'email', $user\_data['email'] ); |
  |  | 579 |  |
  |  | 580 | //Create user if not exits |
  |  | 581 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'user\_register' ) ) { |
  |  | 582 | if ( ! $user ) { |
  |  | 583 | unset( $user\_data['ID'] ); |
  |  | 584 | array\_merge( $user\_data, [ 'role' => $v->details->role ] ); |
  |  | 585 | $user = wp\_insert\_user( $user\_data ); |
  |  | 586 | $this->add\_update\_usermeta( $user\_meta, $v->source\_id ); |
  |  | 587 | } |
  |  | 588 | } |
  |  | 589 |  |
  |  | 590 | //Update user |
  |  | 591 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'profile\_update' ) ) { |
  |  | 592 | $this->InstaWP\_db->update( $user\_table, $user\_data, array( 'ID' => $v->source\_id ) ); |
  |  | 593 | $this->add\_update\_usermeta( $user\_meta, $v->source\_id ); |
  |  | 594 | $user->add\_role( $v->details->role ); |
  |  | 595 | } |
  |  | 596 |  |
  |  | 597 | //Delete user |
  |  | 598 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'delete\_user' ) ) { |
  |  | 599 | if ( isset( $user->data->user\_email ) ) { |
  |  | 600 | if ( $user->data->user\_email == $user\_data['data']->user\_email ) { |
  |  | 601 | wp\_delete\_user( $v->source\_id ); |
  |  | 602 | } |
  |  | 603 | } |
  |  | 604 | } |
  |  | 605 |  |
  |  | 606 | #message |
  |  | 607 | $message         = 'Sync successfully.'; |
  |  | 608 | $status          = 'completed'; |
  |  | 609 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 610 | #changes |
  |  | 611 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 612 | } |
  |  | 613 |  |
  |  | 614 | /\* |
  |  | 615 | \* widget |
  |  | 616 | \*/ |
  |  | 617 | if ( isset( $v->event\_type ) && $v->event\_type == 'widget' ) { |
  |  | 618 | $widget\_block = (array) $v->details->widget\_block; |
  |  | 619 | $appp         = (array) $v->details; |
  |  | 620 | $dataIns      = [ |
  |  | 621 | 'data' => json\_encode( $appp ) |
  |  | 622 | ]; |
  |  | 623 | $this->InstaWP\_db->insert( 'wp\_testing', $dataIns ); |
  |  | 624 |  |
  |  | 625 | $widget\_block\_arr = []; |
  |  | 626 | foreach ( $widget\_block as $widget\_key => $widget\_val ) { |
  |  | 627 | if ( $widget\_key == '\_multiwidget' ) { |
  |  | 628 | $widget\_block\_arr[ $widget\_key ] = $widget\_val; |
  |  | 629 | } else { |
  |  | 630 | $widget\_val\_arr                  = (array) $widget\_val; |
  |  | 631 | $widget\_block\_arr[ $widget\_key ] = [ 'content' => $widget\_val\_arr['content'] ]; |
  |  | 632 | } |
  |  | 633 | } |
  |  | 634 | update\_option( 'widget\_block', $widget\_block\_arr ); |
  |  | 635 | #message |
  |  | 636 | $message         = 'Sync successfully.'; |
  |  | 637 | $status          = 'completed'; |
  |  | 638 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 639 | #changes |
  |  | 640 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 641 | } |
  |  | 642 | /\* |
  |  | 643 | \* Update api for cloud |
  |  | 644 | \*/ |
  |  | 645 | $progress        = intval( $count / $total\_op \* 100 ); |
  |  | 646 | $progress\_status = ( $progress > 100 ) ? 'in\_progress' : 'completed'; |
  |  | 647 | #Sync update |
  |  | 648 | $syncUpdate = [ |
  |  | 649 | 'progress' => $progress, |
  |  | 650 | 'status'   => $progress\_status, |
  |  | 651 | 'message'  => $message, |
  |  | 652 | 'changes'  => [ 'changes' => $changes, 'sync\_response' => $sync\_response ], |
  |  | 653 | ]; |
  |  | 654 | $this->sync\_update( $sync\_id, $syncUpdate, $source\_connect\_id ); |
  |  | 655 | $count ++; |
  |  | 656 | } |
  |  | 657 | } |
  |  | 658 |  |
  |  | 659 | #Sync history save |
  |  | 660 | $this->sync\_history\_save( $body, $changes, 'Complete' ); |
  |  | 661 |  |
  |  | 662 | #enable is back if syncing already enabled at the destination |
  |  | 663 | if ( $is\_enabled ) { |
  |  | 664 | update\_option( 'syncing\_enabled\_disabled', 1 ); |
  |  | 665 | } |
  |  | 666 |  |
  |  | 667 | return new WP\_REST\_Response( |
  |  | 668 | array( |
  |  | 669 | 'encrypted\_contents' => $encrypted\_contents, |
  |  | 670 | 'source\_connect\_id'  => $source\_connect\_id, |
  |  | 671 | 'changes'            => [ 'changes' => $changes, 'sync\_response' => $sync\_response ], |
  |  | 672 | 'sync\_id'            => $sync\_id |
  |  | 673 | ) |
  |  | 674 | ); |
  |  | 675 | } |
  |  | 676 |  |
  |  | 677 | /\*\* |
  |  | 678 | \* This function is for upload media which are coming form widgets. |
  |  | 679 | \*/ |
  |  | 680 | public function upload\_widgets\_media( $media = null, $content = null ) { |
  |  | 681 | $media      = json\_decode( reset( $media ) ); |
  |  | 682 | $new        = $old = []; |
  |  | 683 | $newContent = ''; |
  |  | 684 | if ( ! empty( $media ) ) { |
  |  | 685 | foreach ( $media as $v ) { |
  |  | 686 | $v = (array) $v; |
  |  | 687 | if ( isset( $v['attachment\_id'] ) && isset( $v['attachment\_url'] ) ) { |
  |  | 688 | $attachment\_id = $this->insert\_attachment( $v['attachment\_id'], $v['attachment\_url'] ); |
  |  | 689 | $new[]         = wp\_get\_attachment\_url( $attachment\_id ); |
  |  | 690 | $old[]         = $v['attachment\_url']; |
  |  | 691 | } |
  |  | 692 | } |
  |  | 693 | $newContent = str\_replace( $old, $new, $content ); #str\_replace(old,new,str) |
  |  | 694 | } |
  |  | 695 |  |
  |  | 696 | return $newContent; |
  |  | 697 | } |
  |  | 698 |  |
  |  | 699 | public function user\_id\_exists( $user\_id ) { |
  |  | 700 | $table\_name = $this->wpdb->prefix . 'users'; |
  |  | 701 | $count      = $this->wpdb->get\_var( $this->wpdb->prepare( "SELECT COUNT(\*) FROM $table\_name WHERE ID = %d", $user\_id ) ); |
  |  | 702 | if ( $count == 1 ) { |
  |  | 703 | return true; |
  |  | 704 | } else { |
  |  | 705 | return false; |
  |  | 706 | } |
  |  | 707 | } |
  |  | 708 |  |
  |  | 709 | public function blogDescription( $v = null ) { |
  |  | 710 | $this->wpdb->update( $this->wpdb->prefix . 'options', [ 'option\_value' => $v ], array( 'option\_name' => 'blogdescription' ) ); |
  |  | 711 | } |
  |  | 712 |  |
  |  | 713 | /\*\* |
  |  | 714 | \* object to array conversation |
  |  | 715 | \*/ |
  |  | 716 | public function object\_to\_array( $data ) { |
  |  | 717 | if ( ( ! is\_array( $data ) ) and ( ! is\_object( $data ) ) ) { |
  |  | 718 | return; |
  |  | 719 | } |
  |  | 720 | $result = array(); |
  |  | 721 | $data   = (array) $data; |
  |  | 722 | foreach ( $data as $key => $value ) { |
  |  | 723 | if ( is\_object( $value ) ) { |
  |  | 724 | $value = (array) $value; |
  |  | 725 | } |
  |  | 726 | if ( is\_array( $value ) ) { |
  |  | 727 | $result[ $key ] = $this->object\_to\_array( $value ); |
  |  | 728 | } else { |
  |  | 729 | $result[ $key ] = $value; |
  |  | 730 | } |
  |  | 731 | } |
  |  | 732 |  |
  |  | 733 | return $result; |
  |  | 734 | } |
  |  | 735 |  |
  |  | 736 | /\*\* |
  |  | 737 | \* Create woocommerce attribute |
  |  | 738 | \*/ |
  |  | 739 | public function woocommerce\_create\_attribute( $source\_id, $data = null ) { |
  |  | 740 | $format               = array( '%s', '%s', '%s', '%s', '%d' ); |
  |  | 741 | $data['attribute\_id'] = intval( $source\_id ); |
  |  | 742 | $results              = $this->wpdb->insert( |
  |  | 743 | $this->wpdb->prefix . 'woocommerce\_attribute\_taxonomies', |
  |  | 744 | $data, |
  |  | 745 | $format |
  |  | 746 | ); |
  |  | 747 |  |
  |  | 748 | if ( is\_wp\_error( $results ) ) { |
  |  | 749 | return new WP\_Error( 'cannot\_create\_attribute', 'Can not create attribute!', array( 'status' => 400 ) ); |
  |  | 750 | } |
  |  | 751 | $id = $this->wpdb->insert\_id; |
  |  | 752 | /\*\* |
  |  | 753 | \* Attribute added. |
  |  | 754 | \* |
  |  | 755 | \* @param int $id Added attribute ID. |
  |  | 756 | \* @param array $data Attribute data. |
  |  | 757 | \*/ |
  |  | 758 | do\_action( 'woocommerce\_attribute\_added', $id, $data ); |
  |  | 759 | // Clear cache and flush rewrite rules. |
  |  | 760 | wp\_schedule\_single\_event( time(), 'woocommerce\_flush\_rewrite\_rules' ); |
  |  | 761 | delete\_transient( 'wc\_attribute\_taxonomies' ); |
  |  | 762 | WC\_Cache\_Helper::invalidate\_cache\_group( 'woocommerce-attributes' ); |
  |  | 763 | } |
  |  | 764 |  |
  |  | 765 | /\*\* |
  |  | 766 | \* Set product gallery |
  |  | 767 | \*/ |
  |  | 768 | public function set\_product\_gallery( $product\_id = null, $gallery\_ids = null ) { |
  |  | 769 | $product = new WC\_product( $product\_id ); |
  |  | 770 | $product->set\_gallery\_image\_ids( $gallery\_ids ); |
  |  | 771 | $product->save(); |
  |  | 772 | } |
  |  | 773 |  |
  |  | 774 | public function customizer\_site\_icon( $data = null ) { |
  |  | 775 | $attachment\_id = $data->id; |
  |  | 776 | $url           = $data->url; |
  |  | 777 | if ( isset( $attachment\_id ) && ! empty( $attachment\_id ) ) { |
  |  | 778 | $attUrl = wp\_get\_attachment\_url( intval( $attachment\_id ) ); |
  |  | 779 | if ( ! empty( $attUrl ) ) { |
  |  | 780 | update\_option( 'site\_icon', $attachment\_id ); |
  |  | 781 | } else { |
  |  | 782 | $attachment\_id = $this->insert\_attachment( $attachment\_id, $url ); |
  |  | 783 | update\_option( 'site\_icon', $attachment\_id ); |
  |  | 784 | } |
  |  | 785 | } else { |
  |  | 786 | update\_option( 'site\_icon', $attachment\_id ); |
  |  | 787 | } |
  |  | 788 | } |
  |  | 789 |  |
  |  | 790 | public function customizer\_custom\_logo( $data ) { |
  |  | 791 | $attachment\_id = $data->id; |
  |  | 792 | $url           = $data->url; |
  |  | 793 | if ( isset( $attachment\_id ) && ! empty( $attachment\_id ) ) { |
  |  | 794 | $attUrl = wp\_get\_attachment\_url( intval( $attachment\_id ) ); |
  |  | 795 | if ( ! empty( $attUrl ) ) { |
  |  | 796 | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  |  | 797 | } else { |
  |  | 798 | $attachment\_id = $this->insert\_attachment( $attachment\_id, $url ); |
  |  | 799 | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  |  | 800 | } |
  |  | 801 | } else { |
  |  | 802 | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  |  | 803 | } |
  |  | 804 | } |
  |  | 805 |  |
  |  | 806 | public function customizer\_background\_image( $data = null ) { |
  |  | 807 | $attachment\_id = $data->id; |
  |  | 808 | $url           = $data->url; |
  |  | 809 | if ( isset( $attachment\_id ) && ! empty( $attachment\_id ) ) { |
  |  | 810 | $attUrl = wp\_get\_attachment\_url( intval( $attachment\_id ) ); |
  |  | 811 | if ( ! empty( $attUrl ) ) { |
  |  | 812 | set\_theme\_mod( 'background\_image', $attUrl ); |
  |  | 813 | } else { |
  |  | 814 | $attachment\_id  = $this->insert\_attachment( $attachment\_id, $url ); |
  |  | 815 | $attachment\_url = wp\_get\_attachment\_url( intval( $attachment\_id ) ); |
  |  | 816 | set\_theme\_mod( 'background\_image', $attachment\_url ); |
  |  | 817 | } |
  |  | 818 | } else { |
  |  | 819 | set\_theme\_mod( 'background\_image', $url ); |
  |  | 820 | } |
  |  | 821 |  |
  |  | 822 | if ( isset( $data->background\_preset ) && ! empty( $data->background\_preset ) ) { |
  |  | 823 | set\_theme\_mod( 'background\_preset', $data->background\_preset ); |
  |  | 824 | } |
  |  | 825 |  |
  |  | 826 | if ( isset( $data->background\_size ) && ! empty( $data->background\_size ) ) { |
  |  | 827 | set\_theme\_mod( 'background\_size', $data->background\_size ); |
  |  | 828 | } |
  |  | 829 |  |
  |  | 830 | if ( isset( $data->background\_repeat ) && ! empty( $data->background\_repeat ) ) { |
  |  | 831 | set\_theme\_mod( 'background\_repeat', $data->background\_repeat ); |
  |  | 832 | } |
  |  | 833 |  |
  |  | 834 | if ( isset( $data->background\_attachment ) && ! empty( $data->background\_attachment ) ) { |
  |  | 835 | set\_theme\_mod( 'background\_attachment', $data->background\_attachment ); |
  |  | 836 | } |
  |  | 837 |  |
  |  | 838 | if ( isset( $data->background\_position\_x ) && ! empty( $data->background\_position\_x ) ) { |
  |  | 839 | set\_theme\_mod( 'background\_position\_x', $data->background\_position\_x ); |
  |  | 840 | } |
  |  | 841 |  |
  |  | 842 | if ( isset( $data->background\_position\_y ) && ! empty( $data->background\_position\_y ) ) { |
  |  | 843 | set\_theme\_mod( 'background\_position\_y', $data->background\_position\_y ); |
  |  | 844 | } |
  |  | 845 | } |
  |  | 846 |  |
  |  | 847 | /\*\* |
  |  | 848 | \* This function is for upload media which are coming form content. |
  |  | 849 | \*/ |
  |  | 850 | public function upload\_content\_media( $media = null, $post\_id = null ) { |
  |  | 851 | $media   = json\_decode( reset( $media ) ); |
  |  | 852 | $post    = get\_post( $post\_id ); |
  |  | 853 | $content = $post->post\_content; |
  |  | 854 | $new     = $old = []; |
  |  | 855 | if ( ! empty( $media ) ) { |
  |  | 856 | foreach ( $media as $v ) { |
  |  | 857 | $v = (array) $v; |
  |  | 858 | if ( isset( $v['attachment\_id'] ) && isset( $v['attachment\_url'] ) ) { |
  |  | 859 | $attachment\_id = $this->handle\_attachments( (array) $v['attachment\_media'], (array) $v['attachment\_media\_meta'], $v['attachment\_url'] ); |
  |  | 860 | $new[]         = wp\_get\_attachment\_url( $attachment\_id ); |
  |  | 861 | $old[]         = $v['attachment\_url']; |
  |  | 862 | } |
  |  | 863 | } |
  |  | 864 | $newContent = str\_replace( $old, $new, $content ); #str\_replace(old,new,str) |
  |  | 865 | $arg        = array( |
  |  | 866 | 'ID'           => $post\_id, |
  |  | 867 | 'post\_content' => $newContent, |
  |  | 868 | ); |
  |  | 869 | wp\_update\_post( $arg ); |
  |  | 870 | } |
  |  | 871 | } |
  |  | 872 |  |
  |  | 873 | public function notExistMsg() { |
  |  | 874 | return "ID is not exists."; |
  |  | 875 | } |
  |  | 876 |  |
  |  | 877 | public function wp\_terms\_data( $term\_id = null, $arr = [] ) { |
  |  | 878 | return [ |
  |  | 879 | 'term\_id' => $term\_id, |
  |  | 880 | 'name'    => $arr['name'], |
  |  | 881 | 'slug'    => $arr['slug'] |
  |  | 882 | ]; |
  |  | 883 | } |
  |  | 884 |  |
  |  | 885 | public function wp\_term\_taxonomy\_data( $term\_id = null, $arr = [] ) { |
  |  | 886 | return [ |
  |  | 887 | 'term\_taxonomy\_id' => $term\_id, |
  |  | 888 | 'term\_id'          => $term\_id, |
  |  | 889 | 'taxonomy'         => $arr['taxonomy'], |
  |  | 890 | 'description'      => $arr['description'], |
  |  | 891 | 'parent'           => $arr['parent'] |
  |  | 892 | ]; |
  |  | 893 | } |
  |  | 894 |  |
  |  | 895 | public function insert\_taxonomy( $term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null ) { |
  |  | 896 | $this->InstaWP\_db->insert( $this->wpdb->prefix . 'terms', $wp\_terms ); |
  |  | 897 | $this->InstaWP\_db->insert( $this->wpdb->prefix . 'term\_taxonomy', $wp\_term\_taxonomy ); |
  |  | 898 | } |
  |  | 899 |  |
  |  | 900 | public function update\_taxonomy( $term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null ) { |
  |  | 901 | $this->wpdb->update( $this->wpdb->prefix . 'terms', $wp\_terms, array( 'term\_id' => $term\_id ) ); |
  |  | 902 | $this->wpdb->update( $this->wpdb->prefix . 'term\_taxonomy', $wp\_term\_taxonomy, array( 'term\_id' => $term\_id ) ); |
  |  | 903 | } |
  |  | 904 |  |
  |  | 905 | public function reset\_post\_terms( $post\_id ) { |
  |  | 906 | $this->wpdb->query( |
  |  | 907 | $this->wpdb->prepare( |
  |  | 908 | "DELETE FROM {$this->wpdb->prefix}term\_relationships WHERE object\_id = %d", |
  |  | 909 | $post\_id, |
  |  | 910 | ) |
  |  | 911 | ); |
  |  | 912 | } |
  |  | 913 |  |
  |  | 914 | public function add\_update\_postmeta( $meta\_data = null, $post\_id = null ) { |
  |  | 915 |  |
  |  | 916 | if ( ! empty( $meta\_data ) && is\_array( $meta\_data ) ) { |
  |  | 917 | foreach ( $meta\_data as $k => $v ) { |
  |  | 918 | if ( isset( $v[0] ) ) { |
  |  | 919 | $checkSerialize = @unserialize( $v[0] ); |
  |  | 920 | $metaVal        = ( $checkSerialize !== false || $v[0] === 'b:0;' ) ? unserialize( $v[0] ) : $v[0]; |
  |  | 921 | if ( metadata\_exists( 'post', $post\_id, $k ) ) { |
  |  | 922 | update\_post\_meta( $post\_id, $k, $metaVal ); |
  |  | 923 | } else { |
  |  | 924 | add\_post\_meta( $post\_id, $k, $metaVal ); |
  |  | 925 | } |
  |  | 926 | } |
  |  | 927 | } |
  |  | 928 |  |
  |  | 929 | //if \_elementor\_css this key not existing then it's giving a error. |
  |  | 930 | if ( array\_key\_exists( '\_elementor\_version', $meta\_data ) ) { |
  |  | 931 | if ( ! array\_key\_exists( '\_elementor\_css', $meta\_data ) ) { |
  |  | 932 | /\*$elementor\_css = [ |
  |  | 933 | 'time' => time(), |
  |  | 934 | 'fonts' => [], |
  |  | 935 | 'icons' => [], |
  |  | 936 | 'dynamic\_elements\_ids' => [], |
  |  | 937 | 'status' => 'empty', |
  |  | 938 | 'css' => '' |
  |  | 939 | ]; |
  |  | 940 | \*/ |
  |  | 941 | $elementor\_css = []; |
  |  | 942 | add\_post\_meta( $post\_id, '\_elementor\_css', $elementor\_css ); |
  |  | 943 | } |
  |  | 944 | } |
  |  | 945 |  |
  |  | 946 | //delete the edit lock post |
  |  | 947 | delete\_post\_meta( $post\_id, '\_edit\_lock' ); |
  |  | 948 | } |
  |  | 949 | } |
  |  | 950 |  |
  |  | 951 | public function postData( $posts = null, $op = null ) { |
  |  | 952 | $args = array( |
  |  | 953 | 'post\_author'           => $posts['post\_author'], |
  |  | 954 | 'post\_date'             => $posts['post\_date'], |
  |  | 955 | 'post\_date\_gmt'         => $posts['post\_date\_gmt'], |
  |  | 956 | 'post\_content'          => $posts['post\_content'], |
  |  | 957 | 'post\_title'            => $posts['post\_title'], |
  |  | 958 | 'post\_excerpt'          => $posts['post\_excerpt'], |
  |  | 959 | 'post\_status'           => $posts['post\_status'], |
  |  | 960 | 'comment\_status'        => $posts['comment\_status'], |
  |  | 961 | 'ping\_status'           => $posts['ping\_status'], |
  |  | 962 | 'post\_password'         => $posts['post\_password'], |
  |  | 963 | 'post\_name'             => $posts['post\_name'], |
  |  | 964 | 'to\_ping'               => $posts['to\_ping'], |
  |  | 965 | 'pinged'                => $posts['pinged'], |
  |  | 966 | 'post\_modified'         => $posts['post\_modified'], |
  |  | 967 | 'post\_modified\_gmt'     => $posts['post\_modified\_gmt'], |
  |  | 968 | 'post\_content\_filtered' => $posts['post\_content\_filtered'], |
  |  | 969 | 'post\_parent'           => $posts['post\_parent'], |
  |  | 970 | //'guid' => $posts['guid'], |
  |  | 971 | 'menu\_order'            => $posts['menu\_order'], |
  |  | 972 | 'post\_type'             => $posts['post\_type'], |
  |  | 973 | 'post\_mime\_type'        => $posts['post\_mime\_type'], |
  |  | 974 | 'comment\_count'         => $posts['comment\_count'], |
  |  | 975 | 'filter'                => $posts['filter'], |
  |  | 976 | ); |
  |  | 977 | #ID to update existing post |
  |  | 978 | if ( isset( $posts['ID'] ) && $posts['ID'] > 0 ) { |
  |  | 979 | $args = array\_merge( [ 'ID' => $posts['ID'] ], $args ); |
  |  | 980 | } |
  |  | 981 |  |
  |  | 982 | return $args; |
  |  | 983 | } |
  |  | 984 |  |
  |  | 985 | # import attechments form source to destination. |
  |  | 986 | public function handle\_attachments( $attachment\_post, $attachment\_post\_meta, $file ) { |
  |  | 987 | $reference\_id = ''; |
  |  | 988 | if ( isset( $attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0] ) ) { |
  |  | 989 | $reference\_id = $attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0]; |
  |  | 990 | } |
  |  | 991 | $attachment\_id = $this->get\_post\_by\_reference\_Id( $attachment\_post['post\_type'], $reference\_id, $attachment\_post['post\_name'] ); |
  |  | 992 | if ( ! $attachment\_id ) { |
  |  | 993 | $filename          = basename( $file ); |
  |  | 994 | $arrContextOptions = array( |
  |  | 995 | "ssl" => array( |
  |  | 996 | "verify\_peer"      => false, |
  |  | 997 | "verify\_peer\_name" => false, |
  |  | 998 | ), |
  |  | 999 | ); |
  |  | 1000 | $parent\_post\_id    = 0; |
  |  | 1001 | $upload\_file       = wp\_upload\_bits( $filename, null, file\_get\_contents( $file, false, stream\_context\_create( $arrContextOptions ) ) ); |
  |  | 1002 | if ( ! $upload\_file['error'] ) { |
  |  | 1003 | $wp\_filetype = wp\_check\_filetype( $filename, null ); |
  |  | 1004 | $attachment  = array( |
  |  | 1005 | 'post\_mime\_type' => $wp\_filetype['type'], |
  |  | 1006 | 'post\_parent'    => $parent\_post\_id, |
  |  | 1007 | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', $filename ), |
  |  | 1008 | 'post\_content'   => '', |
  |  | 1009 | 'post\_status'    => 'inherit' |
  |  | 1010 | ); |
  |  | 1011 | require\_once( ABSPATH . "wp-admin" . '/includes/image.php' ); |
  |  | 1012 | require\_once( ABSPATH . "wp-admin" . '/includes/file.php' ); |
  |  | 1013 | require\_once( ABSPATH . "wp-admin" . '/includes/media.php' ); |
  |  | 1014 | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
  |  | 1015 | if ( ! is\_wp\_error( $attachment\_id ) ) { |
  |  | 1016 | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
  |  | 1017 | wp\_update\_attachment\_metadata( $attachment\_id, $attachment\_data ); |
  |  | 1018 | $this->add\_update\_postmeta( [ 'instawp\_event\_sync\_reference\_id' => [ $reference\_id ] ], $attachment\_id ); |
  |  | 1019 | } |
  |  | 1020 |  |
  |  | 1021 | return $attachment\_id; |
  |  | 1022 | } |
  |  | 1023 |  |
  |  | 1024 | return; |
  |  | 1025 | } |
  |  | 1026 |  |
  |  | 1027 | return $attachment\_id; |
  |  | 1028 | } |
  |  | 1029 |  |
  |  | 1030 | # import attechments form source to destination. |
  |  | 1031 | public function insert\_attachment( $attachment\_id = null, $file = null ) { |
  |  | 1032 | $filename          = basename( $file ); |
  |  | 1033 | $arrContextOptions = array( |
  |  | 1034 | "ssl" => array( |
  |  | 1035 | "verify\_peer"      => false, |
  |  | 1036 | "verify\_peer\_name" => false, |
  |  | 1037 | ), |
  |  | 1038 | ); |
  |  | 1039 | $parent\_post\_id    = 0; |
  |  | 1040 | $upload\_file       = wp\_upload\_bits( $filename, null, file\_get\_contents( $file, false, stream\_context\_create( $arrContextOptions ) ) ); |
  |  | 1041 | if ( ! $upload\_file['error'] ) { |
  |  | 1042 | $wp\_filetype = wp\_check\_filetype( $filename, null ); |
  |  | 1043 | $attachment  = array( |
  |  | 1044 | 'import\_id'      => $attachment\_id, |
  |  | 1045 | 'post\_mime\_type' => $wp\_filetype['type'], |
  |  | 1046 | 'post\_parent'    => $parent\_post\_id, |
  |  | 1047 | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', $filename ), |
  |  | 1048 | 'post\_content'   => '', |
  |  | 1049 | 'post\_status'    => 'inherit' |
  |  | 1050 | ); |
  |  | 1051 | require\_once( ABSPATH . "wp-admin" . '/includes/image.php' ); |
  |  | 1052 | require\_once( ABSPATH . "wp-admin" . '/includes/file.php' ); |
  |  | 1053 | require\_once( ABSPATH . "wp-admin" . '/includes/media.php' ); |
  |  | 1054 | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
  |  | 1055 | if ( ! is\_wp\_error( $attachment\_id ) ) { |
  |  | 1056 | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
  |  | 1057 | wp\_update\_attachment\_metadata( $attachment\_id, $attachment\_data ); |
  |  | 1058 | } |
  |  | 1059 | } |
  |  | 1060 |  |
  |  | 1061 | return $attachment\_id; |
  |  | 1062 | } |
  |  | 1063 |  |
  |  | 1064 | #Insert history |
  |  | 1065 | public function sync\_history\_save( $body = null, $changes = null, $status = null ) { |
  |  | 1066 | $dir     = 'dev-to-live'; |
  |  | 1067 | $date    = date( 'Y-m-d H:i:s' ); |
  |  | 1068 | $bodyArr = json\_decode( $body ); |
  |  | 1069 | $message = isset( $bodyArr->sync\_message ) ? $bodyArr->sync\_message : ''; |
  |  | 1070 | $data    = [ |
  |  | 1071 | 'encrypted\_contents' => $bodyArr->encrypted\_contents, |
  |  | 1072 | 'changes'            => json\_encode( $changes ), |
  |  | 1073 | 'sync\_response'      => '', |
  |  | 1074 | 'direction'          => $dir, |
  |  | 1075 | 'status'             => $status, |
  |  | 1076 | 'user\_id'            => isset( $bodyArr->upload\_wp\_user ) ? $bodyArr->upload\_wp\_user : '', |
  |  | 1077 | 'changes\_sync\_id'    => isset( $bodyArr->sync\_id ) ? $bodyArr->sync\_id : '', |
  |  | 1078 | 'sync\_message'       => $message, |
  |  | 1079 | 'source\_connect\_id'  => '', |
  |  | 1080 | 'source\_url'         => isset( $bodyArr->source\_url ) ? $bodyArr->source\_url : '', |
  |  | 1081 | 'date'               => $date, |
  |  | 1082 | ]; |
  |  | 1083 | $this->InstaWP\_db->insert( $this->tables['sh\_table'], $data ); |
  |  | 1084 | } |
  |  | 1085 |  |
  |  | 1086 | #Plugin activate. |
  |  | 1087 | public function plugin\_activation( $plugin ) { |
  |  | 1088 | if ( ! function\_exists( 'activate\_plugin' ) ) { |
  |  | 1089 | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  |  | 1090 | } |
  |  | 1091 |  |
  |  | 1092 | if ( ! is\_plugin\_active( $plugin ) ) { |
  |  | 1093 | activate\_plugin( $plugin ); |
  |  | 1094 | } |
  |  | 1095 | } |
  |  | 1096 |  |
  |  | 1097 | #Plugin deactivate. |
  |  | 1098 | public function plugin\_deactivation( $plugin ) { |
  |  | 1099 | if ( ! function\_exists( 'deactivate\_plugins' ) ) { |
  |  | 1100 | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  |  | 1101 | } |
  |  | 1102 | if ( is\_plugin\_active( $plugin ) ) { |
  |  | 1103 | deactivate\_plugins( $plugin ); |
  |  | 1104 | } |
  |  | 1105 | } |
  |  | 1106 |  |
  |  | 1107 | public function sync\_message( $rel = null ) { |
  |  | 1108 | if ( isset( $rel->ID ) ) { |
  |  | 1109 | $message = 'Sync successfully.'; |
  |  | 1110 | } else { |
  |  | 1111 | $message = 'Something went wrong.'; |
  |  | 1112 | } |
  |  | 1113 |  |
  |  | 1114 | return $message; |
  |  | 1115 | } |
  |  | 1116 |  |
  |  | 1117 | public function sync\_post\_status( $rel = null ) { |
  |  | 1118 | $status = 'in\_progress'; |
  |  | 1119 | if ( isset( $rel->ID ) ) { |
  |  | 1120 | $status = 'completed'; |
  |  | 1121 | } else { |
  |  | 1122 | $status = 'pending'; |
  |  | 1123 | } |
  |  | 1124 |  |
  |  | 1125 | return $status; |
  |  | 1126 | } |
  |  | 1127 |  |
  |  | 1128 | public function sync\_opration\_response( $status = null, $message = null, $v = null ) { |
  |  | 1129 | return [ |
  |  | 1130 | 'id'      => $v->id, |
  |  | 1131 | 'status'  => $status, |
  |  | 1132 | 'message' => $message |
  |  | 1133 | ]; |
  |  | 1134 | } |
  |  | 1135 |  |
  |  | 1136 | public function sync\_update( $sync\_id = null, $data = null, $source\_connect\_id = null ) { |
  |  | 1137 | global $InstaWP\_Curl; |
  |  | 1138 | $api\_doamin = InstaWP\_Setting::get\_api\_domain(); |
  |  | 1139 | $connect\_id = intval( $source\_connect\_id ); |
  |  | 1140 | $endpoint   = '/api/v2/connects/' . $connect\_id . '/syncs/' . $sync\_id; |
  |  | 1141 | $url        = $api\_doamin . $endpoint; #https://stage.instawp.io/api/v2/connects/241/syncs/450 |
  |  | 1142 | $api\_key    = $this->get\_api\_key(); |
  |  | 1143 |  |
  |  | 1144 | try { |
  |  | 1145 | $curl = curl\_init(); |
  |  | 1146 | curl\_setopt\_array( $curl, array( |
  |  | 1147 | CURLOPT\_URL            => $url, |
  |  | 1148 | CURLOPT\_RETURNTRANSFER => true, |
  |  | 1149 | CURLOPT\_ENCODING       => '', |
  |  | 1150 | CURLOPT\_MAXREDIRS      => 10, |
  |  | 1151 | CURLOPT\_TIMEOUT        => 0, |
  |  | 1152 | CURLOPT\_FOLLOWLOCATION => true, |
  |  | 1153 | CURLOPT\_HTTP\_VERSION   => CURL\_HTTP\_VERSION\_1\_1, |
  |  | 1154 | CURLOPT\_CUSTOMREQUEST  => 'PATCH', |
  |  | 1155 | CURLOPT\_POSTFIELDS     => json\_encode( $data ), |
  |  | 1156 | CURLOPT\_HTTPHEADER     => array( |
  |  | 1157 | 'Authorization: Bearer ' . $api\_key . '', |
  |  | 1158 | 'Content-Type: application/json' |
  |  | 1159 | ), |
  |  | 1160 | ) ); |
  |  | 1161 |  |
  |  | 1162 | $response = curl\_exec( $curl ); |
  |  | 1163 |  |
  |  | 1164 | return $response; |
  |  | 1165 | } catch ( Exception $e ) { |
  |  | 1166 | return $e->getMessage(); |
  |  | 1167 | } |
  |  | 1168 | } |
  |  | 1169 |  |
  |  | 1170 | function get\_api\_key() { |
  |  | 1171 | $instawp\_api\_options = get\_option( 'instawp\_api\_options' ); |
  |  | 1172 |  |
  |  | 1173 | return $instawp\_api\_options['api\_key']; |
  |  | 1174 | } |
  |  | 1175 |  |
  |  | 1176 | /\* |
  |  | 1177 | \* Create elementor css file 'post-{post\_id}.css' |
  |  | 1178 | \*/ |
  |  | 1179 | public function create\_elementor\_css\_file( $data = null, $post\_id = null ) { |
  |  | 1180 | $upload\_dir = wp\_upload\_dir(); |
  |  | 1181 | $filename   = 'post-' . $post\_id . '.css'; |
  |  | 1182 | $filePath   = $upload\_dir['basedir'] . '/elementor/css/' . $filename; |
  |  | 1183 | $file       = fopen( $filePath, "w+" );//w+,w |
  |  | 1184 | fwrite( $file, $data ); |
  |  | 1185 | fclose( $file ); |
  |  | 1186 | } |
  |  | 1187 |  |
  |  | 1188 | /\*\* |
  |  | 1189 | \* Plugin install |
  |  | 1190 | \*/ |
  |  | 1191 | public function plugin\_install( $plugin\_slug ) { |
  |  | 1192 | include\_once( ABSPATH . 'wp-admin/includes/plugin-install.php' ); //for plugins\_api.. |
  |  | 1193 | $api = plugins\_api( 'plugin\_information', array( |
  |  | 1194 | 'slug'   => $plugin\_slug, |
  |  | 1195 | 'fields' => array( |
  |  | 1196 | 'short\_description' => false, |
  |  | 1197 | 'sections'          => false, |
  |  | 1198 | 'requires'          => false, |
  |  | 1199 | 'rating'            => false, |
  |  | 1200 | 'ratings'           => false, |
  |  | 1201 | 'downloaded'        => false, |
  |  | 1202 | 'last\_updated'      => false, |
  |  | 1203 | 'added'             => false, |
  |  | 1204 | 'tags'              => false, |
  |  | 1205 | 'compatibility'     => false, |
  |  | 1206 | 'homepage'          => false, |
  |  | 1207 | 'donate\_link'       => false, |
  |  | 1208 | ), |
  |  | 1209 | ) ); |
  |  | 1210 | //includes necessary for Plugin\_Upgrader and Plugin\_Installer\_Skin |
  |  | 1211 | include\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
  |  | 1212 | include\_once( ABSPATH . 'wp-admin/includes/misc.php' ); |
  |  | 1213 | include\_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' ); |
  |  | 1214 | $upgrader = new Plugin\_Upgrader( new Plugin\_Installer\_Skin( compact( 'title', 'url', 'nonce', 'plugin', 'api' ) ) ); |
  |  | 1215 | $upgrader->install( $api->download\_link ); |
  |  | 1216 | } |
  |  | 1217 |  |
  |  | 1218 | /\*\* |
  |  | 1219 | \* Check if plugin is installed by getting all plugins from the plugins dir |
  |  | 1220 | \* |
  |  | 1221 | \* @param $plugin\_slug |
  |  | 1222 | \* |
  |  | 1223 | \* @return bool |
  |  | 1224 | \*/ |
  |  | 1225 | public function check\_plugin\_installed( $plugin\_slug ): bool { |
  |  | 1226 | $installed\_plugins = get\_plugins(); |
  |  | 1227 |  |
  |  | 1228 | return array\_key\_exists( $plugin\_slug, $installed\_plugins ) || in\_array( $plugin\_slug, $installed\_plugins, true ); |
  |  | 1229 | } |
  |  | 1230 |  |
  |  | 1231 | //add and update user meta |
  |  | 1232 | public function add\_update\_usermeta( $user\_meta = null, $user\_id = null ) { |
  |  | 1233 | if ( ! empty( $user\_meta ) && is\_array( $user\_meta ) ) { |
  |  | 1234 | foreach ( $user\_meta as $k => $v ) { |
  |  | 1235 | if ( isset( $v[0] ) ) { |
  |  | 1236 | $checkSerialize = @unserialize( $v[0] ); |
  |  | 1237 | $metaVal        = ( $checkSerialize !== false || $v[0] === 'b:0;' ) ? unserialize( $v[0] ) : $v[0]; |
  |  | 1238 | if ( metadata\_exists( 'user', $user\_id, $k ) ) { |
  |  | 1239 | update\_user\_meta( $user\_id, $k, $metaVal ); |
  |  | 1240 | } else { |
  |  | 1241 | add\_user\_meta( $user\_id, $k, $metaVal ); |
  |  | 1242 | } |
  |  | 1243 | } |
  |  | 1244 | } |
  |  | 1245 | } |
  |  | 1246 | } |
  |  | 1247 |  |
  |  | 1248 | /\*\* |
  |  | 1249 | \* Set Astra Costmizer Setings |
  |  | 1250 | \*/ |
  |  | 1251 | function setAstraCostmizerSetings( $arr = null ) { |
  |  | 1252 | #Checkout |
  |  | 1253 | update\_option( 'woocommerce\_checkout\_company\_field', $arr['woocommerce\_checkout\_company\_field'] ); |
  |  | 1254 | update\_option( 'woocommerce\_checkout\_address\_2\_field', $arr['woocommerce\_checkout\_address\_2\_field'] ); |
  |  | 1255 | update\_option( 'woocommerce\_checkout\_phone\_field', $arr['woocommerce\_checkout\_phone\_field'] ); |
  |  | 1256 | update\_option( 'woocommerce\_checkout\_highlight\_required\_fields', $arr['woocommerce\_checkout\_highlight\_required\_fields'] ); |
  |  | 1257 | update\_option( 'wp\_page\_for\_privacy\_policy', $arr['wp\_page\_for\_privacy\_policy'] ); |
  |  | 1258 | update\_option( 'woocommerce\_terms\_page\_id', $arr['woocommerce\_terms\_page\_id'] ); |
  |  | 1259 | update\_option( 'woocommerce\_checkout\_privacy\_policy\_text', $arr['woocommerce\_checkout\_privacy\_policy\_text'] ); |
  |  | 1260 | update\_option( 'woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text', $arr['woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text'] ); |
  |  | 1261 |  |
  |  | 1262 | #product catalog |
  |  | 1263 | update\_option( 'woocommerce\_shop\_page\_display', $arr['woocommerce\_shop\_page\_display'] ); |
  |  | 1264 | update\_option( 'woocommerce\_default\_catalog\_orderby', $arr['woocommerce\_default\_catalog\_orderby'] ); |
  |  | 1265 | update\_option( 'woocommerce\_category\_archive\_display', $arr['woocommerce\_category\_archive\_display'] ); |
  |  | 1266 |  |
  |  | 1267 | #Product Images |
  |  | 1268 | update\_option( 'woocommerce\_single\_image\_width', $arr['woocommerce\_single\_image\_width'] ); |
  |  | 1269 | update\_option( 'woocommerce\_thumbnail\_image\_width', $arr['woocommerce\_thumbnail\_image\_width'] ); |
  |  | 1270 | update\_option( 'woocommerce\_thumbnail\_cropping', $arr['woocommerce\_thumbnail\_cropping'] ); |
  |  | 1271 | update\_option( 'woocommerce\_thumbnail\_cropping\_custom\_width', $arr['woocommerce\_thumbnail\_cropping\_custom\_width'] ); |
  |  | 1272 | update\_option( 'woocommerce\_thumbnail\_cropping\_custom\_height', $arr['woocommerce\_thumbnail\_cropping\_custom\_height'] ); |
  |  | 1273 |  |
  |  | 1274 | #Store Notice |
  |  | 1275 | update\_option( 'woocommerce\_demo\_store', $arr['woocommerce\_demo\_store'] ); |
  |  | 1276 | update\_option( 'woocommerce\_demo\_store\_notice', $arr['woocommerce\_demo\_store\_notice'] ); |
  |  | 1277 | } |
  |  | 1278 | } |
  |  | 1279 |  |
  | 1240 | 1280 | new InstaWP\_Rest\_Apis(); |
* ## [instawp-connect/tags/0.0.9.19/includes/class-instawp-tools.php](/changeset/2942363/instawp-connect/tags/0.0.9.19/includes/class-instawp-tools.php "Show the changeset 2942363 restricted to instawp-connect/tags/0.0.9.19/includes/class-instawp-tools.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-instawp-tools.php?rev=2940719#L6 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-tools.php?rev=2942363#L6 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 |  |
  | 7 | 7 | class InstaWP\_Tools { |
  | 8 |  |  |
  | 9 |  |  |
  | 10 | 8 |  |
  | 11 | 9 | public static function write\_log( $message = '', $type = 'notice' ) { |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-tools.php?rev=2940719#L170) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp-tools.php?rev=2942363#L168) |  |
  | 170 | 168 | return $parts; |
  | 171 | 169 | } |
  |  | 170 |  |
  |  | 171 | /\*\* |
  |  | 172 | \* Returns the random string based on length. |
  |  | 173 | \* |
  |  | 174 | \* @param int $length |
  |  | 175 | \* |
  |  | 176 | \* @return string |
  |  | 177 | \*/ |
  |  | 178 | public static function get\_random\_string( $length ) { |
  |  | 179 | $length = $length / 2; |
  |  | 180 | if ( function\_exists( 'random\_bytes' ) ) { |
  |  | 181 | $result = random\_bytes( $length ); |
  |  | 182 | } else { |
  |  | 183 | $result = openssl\_random\_pseudo\_bytes( $length ); |
  |  | 184 | } |
  |  | 185 |  |
  |  | 186 | return bin2hex( $result ); |
  |  | 187 | } |
  | 172 | 188 | } |
* ## [instawp-connect/tags/0.0.9.19/includes/class-instawp.php](/changeset/2942363/instawp-connect/tags/0.0.9.19/includes/class-instawp.php "Show the changeset 2942363 restricted to instawp-connect/tags/0.0.9.19/includes/class-instawp.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2940719#L342 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp.php?rev=2942363#L342 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 342 | 342 |  |
  | 343 | 343 | include\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-error-log.php'; |
  |  | 344 | include\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-file-management.php'; |
  | 344 | 345 | include\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-backuplist.php'; |
  | 345 | 346 | include\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-restore-data.php'; |
  | […](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2940719#L689) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp.php?rev=2942363#L690) |  |
  | 689 | 690 |  |
  | 690 | 691 | if ( ! $api\_response\_status ) { |
  | 691 |  | return array( 'can\_proceed' => false, 'message' => esc\_html\_\_( 'Could not fetch API data.', 'instawp-connect' ) ); |
  |  | 692 | return array( |
  |  | 693 | 'can\_proceed'  => false, |
  |  | 694 | 'message'      => esc\_html\_\_( 'Could not fetch API data.', 'instawp-connect' ), |
  |  | 695 | 'api\_options'  => InstaWP\_Setting::get\_option( 'instawp\_api\_options', array() ), |
  |  | 696 | 'connect\_id'   => $connect\_id, |
  |  | 697 | 'api\_response' => $api\_response, |
  |  | 698 | ); |
  | 692 | 699 | } |
  | 693 | 700 |  |
  | […](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2940719#L7608) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-instawp.php?rev=2942363#L7615) |  |
  | 7608 | 7615 | $blacklisted\_constants        = [ |
  | 7609 | 7616 | 'INSTAWP\_ALLOW\_MANAGE', |
  |  | 7617 | 'INSTAWP\_FILE\_MANAGER\_USERNAME', |
  |  | 7618 | 'INSTAWP\_FILE\_MANAGER\_PASSWORD', |
  |  | 7619 | 'INSTAWP\_FILE\_MANAGER\_SELF\_URL', |
  |  | 7620 | 'INSTAWP\_FILE\_MANAGER\_SESSION\_ID', |
  | 7610 | 7621 | 'DB\_NAME', |
  | 7611 | 7622 | 'DB\_USER', |
* ## [instawp-connect/tags/0.0.9.19/includes/class-intawp-ajax-fn.php](/changeset/2942363/instawp-connect/tags/0.0.9.19/includes/class-intawp-ajax-fn.php "Show the changeset 2942363 restricted to instawp-connect/tags/0.0.9.19/includes/class-intawp-ajax-fn.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-intawp-ajax-fn.php?rev=2940719#L84 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/tags/0.0.9.19/includes/class-intawp-ajax-fn.php?rev=2942363#L84 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 84 | 84 | $page           = isset( $\_POST['epage'] ) ? abs( (int) $\_POST['epage'] ) : 1; |
  | 85 | 85 | $offset         = ( $page \* $items\_per\_page ) - $items\_per\_page; |
  | 86 |  | $events         = $wpdb->get\_results( $query . " ORDER BY id DESC LIMIT ${offset}, ${items\_per\_page}"); |
  |  | 86 | $events         = $wpdb->get\_results( $query . " GROUP BY `source\_id`,`date` ORDER BY id DESC LIMIT ${offset}, ${items\_per\_page}"); |
  | 87 | 87 | $totalPage      = ceil($total / $items\_per\_page); |
  | 88 | 88 |  |
  | […](/browser/instawp-connect/trunk/includes/class-intawp-ajax-fn.php?rev=2940719#L247) | […](/browser/instawp-connect/tags/0.0.9.19/includes/class-intawp-ajax-fn.php?rev=2942363#L247) |  |
  | 247 | 247 | ]); |
  | 248 | 248 |  |
  | 249 |  | //    echo $packed\_data; |
  |  | 249 | //    echo $packed\_data; |
  | 250 | 250 | //    exit(); |
  | 251 | 251 | $resp = $this->sync\_upload($packed\_data,null); |
* ## [instawp-connect/tags/0.0.9.19/instawp-connect.php](/changeset/2942363/instawp-connect/tags/0.0.9.19/instawp-connect.php "Show the changeset 2942363 restricted to instawp-connect/tags/0.0.9.19/instawp-connect.php")

  | [r2940719](/browser/instawp-connect/trunk/instawp-connect.php?rev=2940719#L8 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/tags/0.0.9.19/instawp-connect.php?rev=2942363#L8 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 8 | 8 | \* Plugin Name:       InstaWP Connect |
  | 9 | 9 | \* Description:       Create 1-click staging, migration and manage your prod sites. |
  | 10 |  | \* Version:           0.0.9.1~~8~~ |
  |  | 10 | \* Version:           0.0.9.19 |
  | 11 | 11 | \* Author:            InstaWP Team |
  | 12 | 12 | \* Author URI:        https://instawp.com/ |
  | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2940719#L25) | […](/browser/instawp-connect/tags/0.0.9.19/instawp-connect.php?rev=2942363#L25) |  |
  | 25 | 25 |  |
  | 26 | 26 |  |
  | 27 |  | define( 'INSTAWP\_PLUGIN\_VERSION', '0.0.9.1~~8~~' ); |
  |  | 27 | define( 'INSTAWP\_PLUGIN\_VERSION', '0.0.9.19' ); |
  | 28 | 28 | define( 'INSTAWP\_RESTORE\_INIT', 'init' ); |
  | 29 | 29 | define( 'INSTAWP\_RESTORE\_READY', 'ready' ); |
  | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2940719#L124) | […](/browser/instawp-connect/tags/0.0.9.19/instawp-connect.php?rev=2942363#L124) |  |
  | 124 | 124 | InstaWP\_Setting::set\_api\_domain(); |
  | 125 | 125 | error\_log( "Settled on activation" ); |
  | 126 |  |  |
  |  | 126 |  |
  |  | 127 | global $wp\_rewrite; |
  | 127 | 128 | if ( get\_option( 'permalink\_structure' ) == '' ) { |
  | 128 |  | ~~global $wp\_rewrite;~~ |
  | 129 | 129 | $wp\_rewrite->set\_permalink\_structure( '/%postname%/' ); |
  | 130 |  | ~~$wp\_rewrite->flush\_rules();~~ |
  | 131 | 130 | } |
  |  | 131 | $wp\_rewrite->flush\_rules(); |
  | 132 | 132 | add\_option( 'instawp\_do\_activation\_redirect', true ); |
  | 133 | 133 | } |
  | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2940719#L135) | […](/browser/instawp-connect/tags/0.0.9.19/instawp-connect.php?rev=2942363#L135) |  |
  | 135 | 135 | /\*Deactivate Hook Handle\*/ |
  | 136 | 136 | function instawp\_plugin\_deactivate() { |
  |  | 137 | flush\_rewrite\_rules(); |
  | 137 | 138 | as\_unschedule\_all\_actions( 'instawp\_handle\_heartbeat', [], 'instawp-connect' ); |
  | 138 | 139 | } |
* ## [instawp-connect/tags/0.0.9.19/readme.txt](/changeset/2942363/instawp-connect/tags/0.0.9.19/readme.txt "Show the changeset 2942363 restricted to instawp-connect/tags/0.0.9.19/readme.txt")

  | [r2940719](/browser/instawp-connect/trunk/readme.txt?rev=2940719#L5 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/tags/0.0.9.19/readme.txt?rev=2942363#L5 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Tested up to: 6.2.2 |
  | 6 | 6 | Requires PHP: 7.0 |
  | 7 |  | Stable tag: 0.0.9.1~~8~~ |
  |  | 7 | Stable tag: 0.0.9.19 |
  | 8 | 8 | License: GPLv3 or later |
  | 9 | 9 | License URI: https://www.gnu.org/licenses/gpl-3.0.en.html |
  | […](/browser/instawp-connect/trunk/readme.txt?rev=2940719#L124) | […](/browser/instawp-connect/tags/0.0.9.19/readme.txt?rev=2942363#L124) |  |
  | 124 | 124 | - 20/07/2023 - FIX - Minor changes on the migration user interface. |
  | 125 | 125 |  |
  | 126 |  |  |
  | 127 |  |  |
  |  | 126 | = 0.0.9.19 = |
  |  | 127 | - 24/07/2023 - FIX - Fix Sync API vulnerability issue, disclosure by WordFence. |
* ## [instawp-connect/trunk/includes/class-instawp-rest-api.php](/changeset/2942363/instawp-connect/trunk/includes/class-instawp-rest-api.php "Show the changeset 2942363 restricted to instawp-connect/trunk/includes/class-instawp-rest-api.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L42 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2942363#L42 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 42 | 42 | ) ); |
  | 43 | 43 |  |
  | 44 |  | ~~register\_rest\_route( $this->namespace . '/' . $this->version, 'test', array(~~ |
  | 45 |  | ~~'methods'             => 'POST',~~ |
  | 46 |  | ~~'callback'            => array( $this, 'test' ),~~ |
  | 47 |  | ~~'permission\_callback' => '\_\_return\_true',~~ |
  | 48 |  | ~~) );~~ |
  | 49 |  |  |
  | 50 | 44 | register\_rest\_route( $this->namespace . '/' . $this->version, 'config', array( |
  | 51 | 45 | 'methods'             => 'POST', |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L54) | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2942363#L48) |  |
  | 54 | 48 | ) ); |
  | 55 | 49 |  |
  | 56 |  | register\_rest\_route( $this->namespace . '/' . $this->version, 'task\_status/(?P<task\_id>\w+)', array( |
  | 57 |  | 'methods'             => 'GET', |
  | 58 |  | 'callback'            => array( $this, 'task\_status' ), |
  | 59 |  | 'permission\_callback' => '\_\_return\_true', |
  | 60 |  | ) ); |
  | 61 |  |  |
  | 62 |  | register\_rest\_route( $this->namespace . '/' . $this->version, 'upload\_status/(?P<task\_id>\w+)', array( |
  | 63 |  | 'methods'             => 'GET', |
  | 64 |  | 'callback'            => array( $this, 'upload\_status' ), |
  | 65 |  | 'permission\_callback' => '\_\_return\_true', |
  | 66 |  | ) ); |
  |  | 50 | //      register\_rest\_route( $this->namespace . '/' . $this->version, 'task\_status/(?P<task\_id>\w+)', array( |
  |  | 51 | //          'methods'             => 'GET', |
  |  | 52 | //          'callback'            => array( $this, 'task\_status' ), |
  |  | 53 | //          'permission\_callback' => '\_\_return\_true', |
  |  | 54 | //      ) ); |
  |  | 55 |  |
  |  | 56 | //      register\_rest\_route( $this->namespace . '/' . $this->version, 'upload\_status/(?P<task\_id>\w+)', array( |
  |  | 57 | //          'methods'             => 'GET', |
  |  | 58 | //          'callback'            => array( $this, 'upload\_status' ), |
  |  | 59 | //          'permission\_callback' => '\_\_return\_true', |
  |  | 60 | //      ) ); |
  | 67 | 61 |  |
  | 68 | 62 | register\_rest\_route( $this->namespace . '/' . $this->version\_2, '/auto-login-code', array( |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L120) | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2942363#L114) |  |
  | 120 | 114 | ) ); |
  | 121 | 115 |  |
  |  | 116 | register\_rest\_route( $this->namespace . '/' . $this->version\_2, '/file-manager', array( |
  |  | 117 | 'methods'             => 'POST', |
  |  | 118 | 'callback'            => array( $this, 'file\_manager' ), |
  |  | 119 | 'permission\_callback' => '\_\_return\_true', |
  |  | 120 | ) ); |
  |  | 121 |  |
  | 122 | 122 | register\_rest\_route( $this->namespace . '/' . $this->version\_2, '/logs', array( |
  | 123 | 123 | 'methods'             => 'GET', |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L567) | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2942363#L567) |  |
  | 567 | 567 | \* @return WP\_Error|bool |
  | 568 | 568 | \*/ |
  | 569 |  | p~~rivate~~ function validate\_api\_request( WP\_REST\_Request $request, $check\_management = false ) { |
  |  | 569 | public function validate\_api\_request( WP\_REST\_Request $request, $check\_management = false ) { |
  | 570 | 570 |  |
  | 571 | 571 | if ( $check\_management && ( ! defined( 'INSTAWP\_ALLOW\_MANAGE' ) || ( defined( 'INSTAWP\_ALLOW\_MANAGE' ) && true !== INSTAWP\_ALLOW\_MANAGE ) ) ) { |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L1590) | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2942363#L1590) |  |
  | 1590 | 1590 |  |
  | 1591 | 1591 | /\*\* |
  |  | 1592 | \* Handle file manager system. |
  |  | 1593 | \* |
  |  | 1594 | \* @param WP\_REST\_Request $request |
  |  | 1595 | \* |
  |  | 1596 | \* @return WP\_REST\_Response |
  |  | 1597 | \*/ |
  |  | 1598 | public function file\_manager( WP\_REST\_Request $request ) { |
  |  | 1599 |  |
  |  | 1600 | $response = $this->validate\_api\_request( $request, true ); |
  |  | 1601 | if ( is\_wp\_error( $response ) ) { |
  |  | 1602 | return $this->throw\_error( $response ); |
  |  | 1603 | } |
  |  | 1604 |  |
  |  | 1605 | $file\_name = InstaWP\_Setting::get\_option( 'instawp\_file\_manager\_name', '' ); |
  |  | 1606 |  |
  |  | 1607 | if ( ! empty( $file\_name ) ) { |
  |  | 1608 | as\_unschedule\_all\_actions( 'instawp\_clean\_file\_manager', [ $file\_name ], 'instawp-connect' ); |
  |  | 1609 |  |
  |  | 1610 | $file\_path = InstaWP\_File\_Management::get\_file\_path( $file\_name ); |
  |  | 1611 | if ( file\_exists( $file\_path ) ) { |
  |  | 1612 | @unlink( $file\_path ); |
  |  | 1613 | } |
  |  | 1614 | } |
  |  | 1615 |  |
  |  | 1616 | $url       = 'https://raw.githubusercontent.com/InstaWP/tinyfilemanager/master/tinyfilemanager.php'; |
  |  | 1617 | $username  = InstaWP\_Tools::get\_random\_string( 15 ); |
  |  | 1618 | $password  = InstaWP\_Tools::get\_random\_string( 20 ); |
  |  | 1619 | $file\_name = InstaWP\_Tools::get\_random\_string( 20 ); |
  |  | 1620 | $token     = md5( $username . '|' . $password. '|' . $file\_name ); |
  |  | 1621 |  |
  |  | 1622 | $search  = [ |
  |  | 1623 | 'Tiny File Manager', |
  |  | 1624 | 'CCP Programmers', |
  |  | 1625 | 'tinyfilemanager.github.io', |
  |  | 1626 | 'FM\_SELF\_URL', |
  |  | 1627 | 'FM\_SESSION\_ID', |
  |  | 1628 | "'translation.json'", |
  |  | 1629 | '</style>', |
  |  | 1630 | ]; |
  |  | 1631 | $replace = [ |
  |  | 1632 | 'InstaWP File Manager', |
  |  | 1633 | 'InstaWP', |
  |  | 1634 | 'instawp.com', |
  |  | 1635 | 'INSTAWP\_FILE\_MANAGER\_SELF\_URL', |
  |  | 1636 | 'INSTAWP\_FILE\_MANAGER\_SESSION\_ID', |
  |  | 1637 | "\_\_DIR\_\_ . '/translation.json'", |
  |  | 1638 | '<?php if ( file\_exists( \_\_DIR\_\_ . "/custom.css" ) ) { echo file\_get\_contents( \_\_DIR\_\_ . "/custom.css" ); } ?></style>', |
  |  | 1639 | ]; |
  |  | 1640 |  |
  |  | 1641 | $file = file\_get\_contents( $url ); |
  |  | 1642 | $file = str\_replace( $search, $replace, $file ); |
  |  | 1643 | $file = preg\_replace( '!/\\*.\*?\\*/!s', '', $file ); |
  |  | 1644 |  |
  |  | 1645 | $file\_path        = InstaWP\_File\_Management::get\_file\_path( $file\_name ); |
  |  | 1646 | $file\_manager\_url = InstaWP\_File\_Management::get\_file\_manager\_url( $file\_name ); |
  |  | 1647 |  |
  |  | 1648 | $results = [ |
  |  | 1649 | 'login\_url' => add\_query\_arg( [ |
  |  | 1650 | 'action' => 'instawp-file-manager-auto-login', |
  |  | 1651 | 'token'  => hash( 'sha256', $token ), |
  |  | 1652 | ], admin\_url( 'admin-post.php' ) ), |
  |  | 1653 | ]; |
  |  | 1654 |  |
  |  | 1655 | $config\_file = InstaWP\_Tools::get\_config\_file(); |
  |  | 1656 |  |
  |  | 1657 | try { |
  |  | 1658 | $result = file\_put\_contents( $file\_path, $file, LOCK\_EX ); |
  |  | 1659 | if ( false === $result ) { |
  |  | 1660 | throw new Exception( esc\_html\_\_( 'Failed to create the file manager file.', 'instawp-connect' ) ); |
  |  | 1661 | } |
  |  | 1662 |  |
  |  | 1663 | $file       = file( $file\_path ); |
  |  | 1664 | $new\_line   = "if ( ! defined( 'INSTAWP\_PLUGIN\_DIR' ) ) { die; }"; |
  |  | 1665 | $first\_line = array\_shift( $file ); |
  |  | 1666 | array\_unshift( $file, $new\_line ); |
  |  | 1667 | array\_unshift( $file, $first\_line ); |
  |  | 1668 |  |
  |  | 1669 | $fp = fopen( $file\_path, 'w' ); |
  |  | 1670 | fwrite( $fp, implode( '', $file ) ); |
  |  | 1671 | fclose( $fp ); |
  |  | 1672 |  |
  |  | 1673 | if ( ! class\_exists( 'InstaWP\_WP\_Config' ) ) { |
  |  | 1674 | require\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-wp-config.php'; |
  |  | 1675 | } |
  |  | 1676 |  |
  |  | 1677 | $args = [ |
  |  | 1678 | 'normalize' => true, |
  |  | 1679 | 'add'       => true, |
  |  | 1680 | 'raw'       => false, |
  |  | 1681 | ]; |
  |  | 1682 |  |
  |  | 1683 | $config = new InstaWP\_WP\_Config( $config\_file ); |
  |  | 1684 | $config->update( 'constant', 'INSTAWP\_FILE\_MANAGER\_USERNAME', $username, $args ); |
  |  | 1685 | $config->update( 'constant', 'INSTAWP\_FILE\_MANAGER\_PASSWORD', $password, $args ); |
  |  | 1686 | $config->update( 'constant', 'INSTAWP\_FILE\_MANAGER\_SELF\_URL', $file\_manager\_url, $args ); |
  |  | 1687 | $config->update( 'constant', 'INSTAWP\_FILE\_MANAGER\_SESSION\_ID', 'instawp\_file\_manager', $args ); |
  |  | 1688 |  |
  |  | 1689 | set\_transient( 'instawp\_file\_manager\_login\_token', $token, ( 15 \* MINUTE\_IN\_SECONDS ) ); |
  |  | 1690 | InstaWP\_Setting::update\_option( 'instawp\_file\_manager\_name', $file\_name ); |
  |  | 1691 |  |
  |  | 1692 | flush\_rewrite\_rules(); |
  |  | 1693 | as\_schedule\_single\_action( time() + DAY\_IN\_SECONDS, 'instawp\_clean\_file\_manager', [ $file\_name ], 'instawp-connect', false, 5 ); |
  |  | 1694 | } catch ( Exception $e ) { |
  |  | 1695 | $results = [ |
  |  | 1696 | 'success' => false, |
  |  | 1697 | 'message' => $e->getMessage(), |
  |  | 1698 | ]; |
  |  | 1699 | } |
  |  | 1700 |  |
  |  | 1701 | return $this->send\_response( $results ); |
  |  | 1702 | } |
  |  | 1703 |  |
  |  | 1704 | /\*\* |
  | 1592 | 1705 | \* Handle response to retrieve debug logs. |
  | 1593 | 1706 | \* |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2940719#L1691) | […](/browser/instawp-connect/trunk/includes/class-instawp-rest-api.php?rev=2942363#L1804) |  |
  | 1691 | 1804 | \* @return WP\_REST\_Response|WP\_Error|WP\_HTTP\_Response |
  | 1692 | 1805 | \*/ |
  | 1693 |  | p~~rivate~~ function throw\_error( $error ) { |
  |  | 1806 | public function throw\_error( $error ) { |
  | 1694 | 1807 | $response = new WP\_REST\_Response( [ |
  | 1695 | 1808 | 'success' => false, |
* ## [instawp-connect/trunk/includes/class-instawp-rest-apis.php](/changeset/2942363/instawp-connect/trunk/includes/class-instawp-rest-apis.php "Show the changeset 2942363 restricted to instawp-connect/trunk/includes/class-instawp-rest-apis.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-instawp-rest-apis.php?rev=2940719#L17 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/trunk/includes/class-instawp-rest-apis.php?rev=2942363#L17 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 17 | 17 | \*/ |
  | 18 | 18 |  |
  | 19 |  | if ( ! defined(~~'INSTAWP\_PLUGIN\_DIR'~~) ) { |
  | 20 |  | die; |
  |  | 19 | if ( ! defined( 'INSTAWP\_PLUGIN\_DIR' ) ) { |
  |  | 20 | die; |
  | 21 | 21 | } |
  | 22 | 22 |  |
  | 23 | 23 | require\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-db.php'; |
  | 24 | 24 |  |
  | 25 |  | class InstaWP\_Rest\_Apis{ |
  | 26 |  |  |
  | 27 |  | private $wpdb; |
  | 28 |  |  |
  | 29 |  | private $InstaWP\_db; |
  | 30 |  |  |
  | 31 |  | private $tables; |
  | 32 |  |  |
  | 33 |  | public function \_\_construct(){ |
  | 34 |  | global $wpdb; |
  | 35 |  |  |
  | 36 |  | $this->wpdb = $wpdb; |
  | 37 |  |  |
  | 38 |  | $this->InstaWP\_db = new InstaWP\_DB(); |
  | 39 |  |  |
  | 40 |  | $this->tables = $this->InstaWP\_db->tables; |
  | 41 |  |  |
  | 42 |  | /\* |
  | 43 |  | \* Initiate Sync |
  | 44 |  | \* Endpoint : /wp-json/instawp-connect/v1/sync |
  | 45 |  | \* HOOK - rest\_api\_init |
  | 46 |  | \*/ |
  | 47 |  |  |
  | 48 |  | add\_action( 'rest\_api\_init', function () { |
  | 49 |  | register\_rest\_route( 'instawp-connect/v1', '/sync', |
  | 50 |  | array( |
  | 51 |  | 'methods' => 'POST', |
  | 52 |  | 'callback' => [$this, 'events\_receiver'], |
  | 53 |  | 'permission\_callback' => [$this, 'check\_permission'], |
  | 54 |  | ) ); |
  | 55 |  | } ); |
  | 56 |  | } |
  | 57 |  |  |
  | 58 |  | function check\_permission(){ |
  | 59 |  | return true; |
  | 60 |  | } |
  | 61 |  |  |
  | 62 |  | public function get\_post\_by\_reference\_Id($post\_type, $reference\_id, $post\_name) { |
  | 63 |  | $post = get\_posts( array( |
  | 64 |  | 'post\_type'=> $post\_type, |
  | 65 |  | 'meta\_key'   => 'instawp\_event\_sync\_reference\_id', |
  | 66 |  | 'meta\_value' => $reference\_id |
  | 67 |  | ) ); |
  | 68 |  | if(!empty($post)){ |
  | 69 |  | $post = $post[0]; |
  | 70 |  | }else { |
  | 71 |  | $post  = instawp\_get\_post\_by\_name($post\_name, $post\_type); |
  | 72 |  | } |
  | 73 |  | return $post; |
  | 74 |  | } |
  | 75 |  |  |
  | 76 |  | public function create\_or\_update\_post($post, $post\_meta) { |
  | 77 |  | $reference\_id = isset($post\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
  | 78 |  | $destination\_post = $this->get\_post\_by\_reference\_Id($post['post\_type'], $reference\_id, $post['post\_name']); |
  | 79 |  | unset($post['ID']); |
  | 80 |  | if(!empty($destination\_post)){ |
  | 81 |  | #The post exists,Then update |
  | 82 |  | $post\_id = $post['ID'] = $destination\_post->ID; |
  | 83 |  | //$post['post\_parent'] = $destination\_post->post\_parent; |
  | 84 |  | $postData = $this->postData($post); |
  | 85 |  | wp\_update\_post($postData); |
  | 86 |  | #post meta |
  | 87 |  | $this->add\_update\_postmeta($post\_meta, $destination\_post->ID); |
  | 88 |  | }else{ |
  | 89 |  | $postData = $this->postData($post); |
  | 90 |  | #The post does not exist,Then insert |
  | 91 |  | $post\_id = wp\_insert\_post($postData); |
  | 92 |  | #post meta |
  | 93 |  | $this->add\_update\_postmeta( $post\_meta, $post\_id ); |
  | 94 |  | } |
  | 95 |  | return $post\_id; |
  | 96 |  | } |
  | 97 |  |  |
  | 98 |  | /\*\* |
  | 99 |  | \* Reciver |
  | 100 |  | \* @param array $data Options for the function. |
  | 101 |  | \* @return string|null |
  | 102 |  | \*/ |
  | 103 |  | public function events\_receiver($req) { |
  | 104 |  | // error\_reporting(E\_ALL); |
  | 105 |  | // ini\_set('display\_errors', 1); |
  | 106 |  | $body = $req->get\_body(); |
  | 107 |  | $bodyArr = json\_decode($body); |
  | 108 |  | $encrypted\_contents = json\_decode($bodyArr->encrypted\_contents); |
  | 109 |  | $sync\_id = $bodyArr->sync\_id; |
  | 110 |  | $source\_connect\_id = $bodyArr->source\_connect\_id; |
  | 111 |  | $is\_enabled = false; |
  | 112 |  |  |
  | 113 |  |  |
  | 114 |  | if(get\_option('syncing\_enabled\_disabled')){ |
  | 115 |  | $is\_enabled = true; |
  | 116 |  | } |
  | 117 |  |  |
  | 118 |  | #forcely disable the syncing at the destination |
  | 119 |  | update\_option('syncing\_enabled\_disabled', 0); |
  | 120 |  |  |
  | 121 |  | if(!empty($encrypted\_contents) && is\_array($encrypted\_contents)){ |
  | 122 |  | $total\_op = count($encrypted\_contents); |
  | 123 |  | $count = 1; |
  | 124 |  | $progress\_status = 'pending'; |
  | 125 |  | $changes = $sync\_response = []; |
  | 126 |  | foreach($encrypted\_contents as $v){ |
  | 127 |  |  |
  | 128 |  | $source\_id = (isset($v->source\_id) && !empty($v->source\_id)) ? intval($v->source\_id) : null; |
  | 129 |  |  |
  | 130 |  | /\* |
  | 131 |  | \*Post Oprations |
  | 132 |  | \*/ |
  | 133 |  | //create and update |
  | 134 |  | if(isset($v->event\_slug) && ($v->event\_slug == 'post\_change' ||$v->event\_slug == 'post\_new') ){ |
  | 135 |  | $posts = isset($v->details->posts) ? (array) $v->details->posts : ''; |
  | 136 |  | $postmeta = isset($v->details->postmeta) ? (array) $v->details->postmeta : ''; |
  | 137 |  | $featured\_image = isset($v->details->featured\_image) ? (array) $v->details->featured\_image : ''; |
  | 138 |  | $media = isset($v->details->media) ? (array) $v->details->media : ''; |
  | 139 |  |  |
  | 140 |  | $parent\_post = isset($v->details->parent->post) ? (array) $v->details->parent->post : []; |
  | 141 |  |  |
  | 142 |  | #check for the post parent |
  | 143 |  | if(!empty($parent\_post)){ |
  | 144 |  | $parent\_post\_meta = isset($v->details->parent->post\_meta) ? (array) $v->details->parent->post\_meta : []; |
  | 145 |  | $reference\_id = isset($parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
  | 146 |  | $destination\_post = $this->get\_post\_by\_reference\_Id($parent\_post['post\_type'], $reference\_id, $parent\_post['post\_name']); |
  | 147 |  | if(!empty($destination\_post)){ |
  | 148 |  | $posts['post\_parent'] = $destination\_post->ID; |
  | 149 |  | } |
  | 150 |  | } |
  | 151 |  |  |
  | 152 |  | if($posts['post\_type'] == 'attachment'){ |
  | 153 |  | //create or update the attachments |
  | 154 |  | $posts['ID'] = $this->handle\_attachments($posts, $postmeta, $posts['guid']); |
  | 155 |  | #update meta |
  | 156 |  | $this->add\_update\_postmeta($postmeta,$posts['ID']); |
  | 157 |  | }else{ |
  | 158 |  | $posts['ID'] = $this->create\_or\_update\_post($posts, $postmeta); |
  | 159 |  | } |
  | 160 |  |  |
  | 161 |  | #feature image import |
  | 162 |  | if(isset($featured\_image['media']) && !empty($featured\_image['media'])){ |
  | 163 |  | $att\_id = $this->handle\_attachments((array) $featured\_image['media'],(array) $featured\_image['media\_meta'], $featured\_image['featured\_image\_url']); |
  | 164 |  | if(isset($att\_id) && !empty($att\_id)){ |
  | 165 |  | set\_post\_thumbnail($posts['ID'],$att\_id); |
  | 166 |  | } |
  | 167 |  | } |
  | 168 |  |  |
  | 169 |  | #if post type is product then set gallery |
  | 170 |  | if(get\_post\_type($posts['ID']) == 'product'){ |
  | 171 |  | if(isset($v->details->product\_gallery) && !empty($v->details->product\_gallery)){ |
  | 172 |  | $product\_gallery = $v->details->product\_gallery; |
  | 173 |  | $gallery\_ids = []; |
  | 174 |  | //pr($product\_gallery); |
  | 175 |  | foreach($product\_gallery as $gallery){ |
  | 176 |  | if(isset($gallery->media) && !empty($gallery->media) && isset($gallery->url) && $gallery->url !=''){ |
  | 177 |  | $gallery\_ids[] = $this->handle\_attachments((array) $gallery->media,(array) $gallery->media\_meta, $gallery->url); |
  | 178 |  | } |
  | 179 |  | } |
  | 180 |  | $this->set\_product\_gallery($posts['ID'],$gallery\_ids); |
  | 181 |  | } |
  | 182 |  | } |
  | 183 |  |  |
  | 184 |  | #terms in post |
  | 185 |  | $taxonomies = (array) $v->details->taxonomies; |
  | 186 |  | $this->reset\_post\_terms( $posts['ID']); //rest the terms for all taxo |
  | 187 |  | if(!empty($taxonomies) && is\_array($taxonomies)){ |
  | 188 |  | foreach($taxonomies as $taxonomy => $terms){ |
  | 189 |  | $terms = (array) $terms; |
  | 190 |  | $term\_ids = []; |
  | 191 |  | # if term not exist then create first |
  | 192 |  | if(!empty($terms) && is\_array($terms)){ |
  | 193 |  | foreach($terms as $term){ |
  | 194 |  | $term = (array) $term; |
  | 195 |  | if(!term\_exists($term['slug'],$taxonomy)){ |
  | 196 |  | $inserted\_term = wp\_insert\_term( |
  | 197 |  | $term['name'],   // the term |
  | 198 |  | $taxonomy, // the taxonomy |
  | 199 |  | array( |
  | 200 |  | 'description' => $term['description'], |
  | 201 |  | 'slug'        => $term['slug'], |
  | 202 |  | 'parent'      => 0 |
  | 203 |  | ) |
  | 204 |  | ); |
  | 205 |  | $term\_ids[] = $inserted\_term['term\_id']; |
  | 206 |  | }else{ |
  | 207 |  | $get\_term\_by =(array) get\_term\_by('slug',$term['slug'] , $taxonomy); |
  | 208 |  | $term\_ids[] = $get\_term\_by['term\_id']; |
  | 209 |  | } |
  | 210 |  | } |
  | 211 |  | } |
  | 212 |  | #set terms in post |
  | 213 |  | wp\_set\_post\_terms( $posts['ID'], $term\_ids, $taxonomy ); |
  | 214 |  | } |
  | 215 |  | } |
  | 216 |  |  |
  | 217 |  | # media upload from content |
  | 218 |  | $this->upload\_content\_media($media,$posts['ID']); |
  | 219 |  |  |
  | 220 |  | #message |
  | 221 |  | $message = 'Sync successfully.'; |
  | 222 |  | $status = 'completed'; |
  | 223 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 224 |  | #changes |
  | 225 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 226 |  | } |
  | 227 |  |  |
  | 228 |  | //Post trash |
  | 229 |  | if(isset($v->event\_slug) && $v->event\_slug == 'post\_trash'){ |
  | 230 |  | if(isset($source\_id)){ |
  | 231 |  | $posts = (array) $v->details->posts; |
  | 232 |  | $postmeta = (array) $v->details->postmeta; |
  | 233 |  | $post\_by\_reference\_id = get\_posts( array( |
  | 234 |  | 'post\_type'=> $posts['post\_type'], |
  | 235 |  | 'meta\_key'   => 'instawp\_event\_sync\_reference\_id', |
  | 236 |  | 'meta\_value' => isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  | 237 |  | ) ); |
  | 238 |  |  |
  | 239 |  | if(!empty($post\_by\_reference\_id)){ |
  | 240 |  | $post\_id = $post\_by\_reference\_id[0]->ID; |
  | 241 |  | $rel = wp\_trash\_post($post\_id);  //Post data on success, false or null on failure. |
  | 242 |  | $status = $this->sync\_post\_status($rel); |
  | 243 |  | $message = $this->sync\_message($rel); |
  | 244 |  | }else{ |
  | 245 |  | $post\_check\_data = instawp\_get\_post\_by\_name(str\_replace('\_\_trashed','', $posts['post\_name']), $posts['post\_type']); |
  | 246 |  | if(!empty($post\_check\_data)){ |
  | 247 |  | $rel = wp\_trash\_post($post\_check\_data->ID);  //Post data on success, false or null on failure. |
  | 248 |  | $status = $this->sync\_post\_status($rel); |
  | 249 |  | $message = $this->sync\_message($rel); |
  | 250 |  | }else{ |
  | 251 |  | $status = 'pending'; |
  | 252 |  | $message = $this->notExistMsg(); |
  | 253 |  | } |
  | 254 |  | } |
  | 255 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 256 |  | #changes |
  | 257 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 258 |  | } |
  | 259 |  | } |
  | 260 |  |  |
  | 261 |  | //Post permanently delete |
  | 262 |  | if(isset($v->event\_slug) && $v->event\_slug == 'post\_delete'){ |
  | 263 |  | if(isset($source\_id)){ |
  | 264 |  | $posts = (array) $v->details->posts; |
  | 265 |  | $postmeta = (array) $v->details->postmeta; |
  | 266 |  | $post\_by\_reference\_id = get\_posts([ |
  | 267 |  | 'post\_status' => 'trash', |
  | 268 |  | 'post\_type'   => $posts['post\_type'], |
  | 269 |  | 'nopaging'    => TRUE, |
  | 270 |  | 'meta\_query' => array( |
  | 271 |  | array( |
  | 272 |  | 'key'     => 'instawp\_event\_sync\_reference\_id', |
  | 273 |  | 'value'   =>  isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  | 274 |  | 'compare' => '=', |
  | 275 |  | ), |
  | 276 |  | ), |
  | 277 |  | ]); |
  | 278 |  |  |
  | 279 |  | if(!empty($post\_by\_reference\_id)){ |
  | 280 |  | $post\_id = $post\_by\_reference\_id[0]->ID; |
  | 281 |  | $rel = wp\_delete\_post($post\_id);  //Post data on success, false or null on failure. |
  | 282 |  | $status = $this->sync\_post\_status($rel); |
  | 283 |  | $message = $this->sync\_message($rel); |
  | 284 |  | }else{ |
  | 285 |  | $post\_check\_data = instawp\_get\_post\_by\_name($posts['post\_name'], $posts['post\_type']); |
  | 286 |  | if(!empty($post\_check\_data)){ |
  | 287 |  | $rel = wp\_delete\_post($post\_check\_data->ID);  //Post data on success, false or null on failure. |
  | 288 |  | $status = $this->sync\_post\_status($rel); |
  | 289 |  | $message = $this->sync\_message($rel); |
  | 290 |  | }else{ |
  | 291 |  | $status = 'pending'; |
  | 292 |  | $message = $this->notExistMsg(); |
  | 293 |  | } |
  | 294 |  | } |
  | 295 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 296 |  | #changes |
  | 297 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 298 |  | } |
  | 299 |  | } |
  | 300 |  |  |
  | 301 |  | //Post restored |
  | 302 |  | if(isset($v->event\_slug) && $v->event\_slug == 'untrashed\_post'){ |
  | 303 |  | if(isset($source\_id)){ |
  | 304 |  | $posts = (array) $v->details->posts; |
  | 305 |  | $postmeta = (array) $v->details->postmeta; |
  | 306 |  | $post\_by\_reference\_id = get\_posts([ |
  | 307 |  | 'post\_status' => 'trash', |
  | 308 |  | 'post\_type'   => $posts['post\_type'], |
  | 309 |  | 'nopaging'    => TRUE, |
  | 310 |  | 'meta\_query' => array( |
  | 311 |  | array( |
  | 312 |  | 'key'     => 'instawp\_event\_sync\_reference\_id', |
  | 313 |  | 'value'   =>  isset($postmeta['instawp\_event\_sync\_reference\_id'][0]) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  | 314 |  | 'compare' => '=', |
  | 315 |  | ), |
  | 316 |  | ), |
  | 317 |  | ]); |
  | 318 |  |  |
  | 319 |  |  |
  | 320 |  | if(!empty($post\_by\_reference\_id)){ |
  | 321 |  | $post\_id = $post\_by\_reference\_id[0]->ID; |
  | 322 |  | $rel = wp\_untrash\_post($post\_id); |
  | 323 |  | $status = $this->sync\_post\_status($rel); |
  | 324 |  | $message = $this->sync\_message($rel); |
  | 325 |  | }else{ |
  | 326 |  | $post\_check\_data = instawp\_get\_post\_by\_name($posts['post\_name'].'\_\_trashed', $posts['post\_type']); |
  | 327 |  | if(!empty($post\_check\_data)){ |
  | 328 |  | $rel = wp\_untrash\_post($post\_check\_data->ID); |
  | 329 |  | $status = $this->sync\_post\_status($rel); |
  | 330 |  | $message = $this->sync\_message($rel); |
  | 331 |  | }else{ |
  | 332 |  | $status = 'pending'; |
  | 333 |  | $message = $this->notExistMsg(); |
  | 334 |  | } |
  | 335 |  | } |
  | 336 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 337 |  | #changes |
  | 338 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 339 |  | } |
  | 340 |  | } |
  | 341 |  |  |
  | 342 |  | /\* |
  | 343 |  | \*Plugin Oprations |
  | 344 |  | \*/ |
  | 345 |  | //Plugin actiavte |
  | 346 |  | if(isset($v->details) && $v->event\_slug == 'activate\_plugin'){ |
  | 347 |  | $check\_plugin\_installed = $this->check\_plugin\_installed($v->details); |
  | 348 |  | if($check\_plugin\_installed != 1){ |
  | 349 |  | $pluginData = get\_plugin\_data($v->details); |
  | 350 |  | if(!empty($pluginData['TextDomain'])){ |
  | 351 |  | $this->plugin\_install($pluginData['TextDomain']); |
  | 352 |  | } |
  | 353 |  | } |
  | 354 |  |  |
  | 355 |  | $this->plugin\_activation($v->details); |
  | 356 |  | #message |
  | 357 |  | $message = 'Sync successfully.'; |
  | 358 |  | $status = 'completed'; |
  | 359 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 360 |  | #changes |
  | 361 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 362 |  | } |
  | 363 |  |  |
  | 364 |  | //Plugin deactiavte |
  | 365 |  | if(isset($v->event\_slug) && $v->event\_slug == 'deactivate\_plugin'){ |
  | 366 |  | $this->plugin\_deactivation($v->details); |
  | 367 |  | #message |
  | 368 |  | $message = 'Sync successfully.'; |
  | 369 |  | $status = 'completed'; |
  | 370 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 371 |  | #changes |
  | 372 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 373 |  | } |
  | 374 |  |  |
  | 375 |  | /\* |
  | 376 |  | \* Taxonomy Oprations |
  | 377 |  | \*/ |
  | 378 |  |  |
  | 379 |  | //create and update |
  | 380 |  | if(isset($v->event\_slug) && ($v->event\_slug == 'create\_taxonomy' || $v->event\_slug == 'edit\_taxonomy')){ |
  | 381 |  | if(isset($source\_id)){ |
  | 382 |  | $details = (array) $v->details; |
  | 383 |  | $wp\_terms = $this->wp\_terms\_data($source\_id,$details); |
  | 384 |  | $wp\_term\_taxonomy = $this->wp\_term\_taxonomy\_data($source\_id,$details); |
  | 385 |  | if(!term\_exists($source\_id,$v->event\_type)){ |
  | 386 |  | if($v->event\_slug == 'create\_taxonomy'){ |
  | 387 |  | $this->insert\_taxonomy($source\_id,$wp\_terms,$wp\_term\_taxonomy); |
  | 388 |  | clean\_term\_cache($source\_id); |
  | 389 |  | } |
  | 390 |  | } |
  | 391 |  | if(term\_exists($source\_id,$v->event\_type)){ |
  | 392 |  | if($v->event\_slug == 'edit\_taxonomy'){ |
  | 393 |  | $this->update\_taxonomy($source\_id,$wp\_terms,$wp\_term\_taxonomy); |
  | 394 |  | } |
  | 395 |  | } |
  | 396 |  |  |
  | 397 |  | #message |
  | 398 |  | $message = 'Sync successfully.'; |
  | 399 |  | $status = 'completed'; |
  | 400 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 401 |  | #changes |
  | 402 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 403 |  |  |
  | 404 |  | } |
  | 405 |  | } |
  | 406 |  |  |
  | 407 |  | //Delete |
  | 408 |  | if(isset($v->event\_slug) && $v->event\_slug == 'delete\_taxonomy'){ |
  | 409 |  | if(isset($source\_id)){ |
  | 410 |  | if(term\_exists($source\_id,$v->event\_type)){ |
  | 411 |  | $rel = wp\_delete\_term($source\_id,$v->event\_type); |
  | 412 |  | $status = $this->sync\_post\_status($rel); |
  | 413 |  | $message = $this->sync\_message($rel); |
  | 414 |  | } |
  | 415 |  | }else{ |
  | 416 |  | $status = 'pending'; |
  | 417 |  | $message = $this->notExistMsg(); |
  | 418 |  | } |
  | 419 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 420 |  | #changes |
  | 421 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 422 |  | } |
  | 423 |  |  |
  | 424 |  | /\*\* |
  | 425 |  | \* Customizer settings update |
  | 426 |  | \*/ |
  | 427 |  |  |
  | 428 |  | if(isset($v->event\_slug) && $v->event\_slug == 'customizer\_changes'){ |
  | 429 |  | $details = isset($v->details) ? $v->details : ''; |
  | 430 |  |  |
  | 431 |  | #custom logo |
  | 432 |  | $this->customizer\_custom\_logo($details->custom\_logo); |
  | 433 |  |  |
  | 434 |  | #background image |
  | 435 |  | $this->customizer\_background\_image($details->background\_image); |
  | 436 |  |  |
  | 437 |  | #site icon |
  | 438 |  | $this->customizer\_site\_icon($details->site\_icon); |
  | 439 |  |  |
  | 440 |  | #background color |
  | 441 |  | if(isset($details->background\_color) && !empty($details->background\_color)){ |
  | 442 |  | set\_theme\_mod( 'background\_color', $details->background\_color ); |
  | 443 |  | } |
  | 444 |  |  |
  | 445 |  | #Site Title |
  | 446 |  | update\_option( 'blogname', $details->name ); |
  | 447 |  |  |
  | 448 |  | #Tagline |
  | 449 |  | $this->blogDescription($details->description); |
  | 450 |  |  |
  | 451 |  | #Homepage Settings |
  | 452 |  | if(isset($details->show\_on\_front) && !empty($details->show\_on\_front)){ |
  | 453 |  | update\_option( 'show\_on\_front', $details->show\_on\_front ); |
  | 454 |  | } |
  | 455 |  |  |
  | 456 |  | #for 'Astra' theme |
  | 457 |  | if( isset($details->astra\_settings) && !empty($details->astra\_settings) ){ |
  | 458 |  | $astra\_settings = $this->object\_to\_array($details->astra\_settings); |
  | 459 |  | update\_option( 'astra-settings', $astra\_settings ); |
  | 460 |  | } |
  | 461 |  |  |
  | 462 |  | #nav menu locations |
  | 463 |  | if(!empty($details->nav\_menu\_locations)){ |
  | 464 |  | $menu\_array = (array) $details->nav\_menu\_locations; |
  | 465 |  | set\_theme\_mod( 'nav\_menu\_locations', $menu\_array ); |
  | 466 |  | } |
  | 467 |  |  |
  | 468 |  | #Custom css post id |
  | 469 |  | $custom\_css\_post = (array) $details->custom\_css\_post; |
  | 470 |  | if(!empty($details->custom\_css\_post)){ |
  | 471 |  | if (get\_post\_status($custom\_css\_post['ID']) ) { |
  | 472 |  | #The post exists,Then update |
  | 473 |  | $postData = $this->postData($custom\_css\_post,'update'); |
  | 474 |  | wp\_update\_post($postData); |
  | 475 |  |  |
  | 476 |  | } else { |
  | 477 |  | $postData = $this->postData($custom\_css\_post,'insert'); |
  | 478 |  | #The post does not exist,Then insert |
  | 479 |  | wp\_insert\_post($postData); |
  | 480 |  | } |
  | 481 |  | set\_theme\_mod( 'custom\_css\_post\_id', $custom\_css\_post['ID'] ); |
  | 482 |  | } |
  | 483 |  | $current\_theme = wp\_get\_theme(); |
  | 484 |  | if($current\_theme->Name == 'Astra'){ #for 'Astra' theme |
  | 485 |  | $astra\_theme\_setting = isset($details->astra\_theme\_customizer\_settings) ? (array) $details->astra\_theme\_customizer\_settings : ''; |
  | 486 |  | $this->setAstraCostmizerSetings($astra\_theme\_setting); |
  | 487 |  | }else if($current\_theme->Name == 'Divi'){  #for 'Divi' theme |
  | 488 |  | $divi\_settings = isset($details->divi\_settings) ? (array) $details->divi\_settings : ''; |
  | 489 |  | if(!empty($divi\_settings) &&  is\_array($divi\_settings)){ |
  | 490 |  | update\_option('et\_divi',$divi\_settings); |
  | 491 |  | } |
  | 492 |  | } |
  | 493 |  |  |
  | 494 |  | #message |
  | 495 |  | $message = 'Sync successfully.'; |
  | 496 |  | $status = 'completed'; |
  | 497 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 498 |  | #changes |
  | 499 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 500 |  | } |
  | 501 |  |  |
  | 502 |  | /\*\* |
  | 503 |  | \* Woocommerce attributes |
  | 504 |  | \*/ |
  | 505 |  |  |
  | 506 |  | #create&upadte woocommerce attribute |
  | 507 |  | if(isset($v->event\_slug) && ($v->event\_slug == 'woocommerce\_attribute\_added' || $v->event\_slug == 'woocommerce\_attribute\_updated')){ |
  | 508 |  | $details = isset($v->details) ? (array) $v->details : ''; |
  | 509 |  | if(!empty($details)){ |
  | 510 |  | $attribute = wc\_get\_attribute(208); |
  | 511 |  | if(!empty($attribute)){ |
  | 512 |  | unset($details['id']); |
  | 513 |  | wc\_update\_attribute($v->source\_id,$attribute); |
  | 514 |  |  |
  | 515 |  | #message |
  | 516 |  | $message = 'Sync successfully.'; |
  | 517 |  | $status = 'completed'; |
  | 518 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 519 |  | #changes |
  | 520 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 521 |  | }else{ |
  | 522 |  | $this->woocommerce\_create\_attribute($v->source\_id,$details); |
  | 523 |  |  |
  | 524 |  | #message |
  | 525 |  | $message = 'Sync successfully.'; |
  | 526 |  | $status = 'completed'; |
  | 527 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 528 |  | #changes |
  | 529 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 530 |  |  |
  | 531 |  | } |
  | 532 |  | } |
  | 533 |  | } |
  | 534 |  |  |
  | 535 |  | if(isset($v->event\_slug) && $v->event\_slug == 'woocommerce\_attribute\_deleted'){ |
  | 536 |  | wc\_delete\_attribute($v->source\_id); |
  | 537 |  | #message |
  | 538 |  | $message = 'Sync successfully.'; |
  | 539 |  | $status = 'completed'; |
  | 540 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 541 |  | #changes |
  | 542 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 543 |  | } |
  | 544 |  |  |
  | 545 |  | /\*\* |
  | 546 |  | \* Users actions |
  | 547 |  | \*/ |
  | 548 |  | if(isset($v->event\_type) && $v->event\_type == 'users'){ |
  | 549 |  | $user\_data = isset($v->details->user\_data) ? (array) $v->details->user\_data : ''; |
  | 550 |  | $user\_meta = isset($v->details->user\_meta) ? (array) $v->details->user\_meta : ''; |
  | 551 |  | //$user = get\_userdata($v->source\_id); |
  | 552 |  | $user\_table = $this->wpdb->prefix.'users'; |
  | 553 |  |  |
  | 554 |  | $get\_user\_by\_reference\_id = get\_users(array( |
  | 555 |  | 'meta\_key' => 'instawp\_event\_user\_sync\_reference\_id', |
  | 556 |  | 'meta\_value' => isset($user\_meta['instawp\_event\_sync\_reference\_id'][0]) ? $user\_meta['instawp\_event\_sync\_reference\_id'][0] : '', |
  | 557 |  | )); |
  | 558 |  |  |
  | 559 |  | $user =  !empty($get\_user\_by\_reference\_id) ? $get\_user\_by\_reference\_id[0] : get\_user\_by('email', $user\_data['email']); |
  | 560 |  |  |
  | 561 |  | //Create user if not exits |
  | 562 |  | if( isset($v->event\_slug) && ($v->event\_slug == 'user\_register') ){ |
  | 563 |  | if(!$user){ |
  | 564 |  | unset($user\_data['ID']); |
  | 565 |  | array\_merge($user\_data, ['role'=>$v->details->role ]); |
  | 566 |  | $user = wp\_insert\_user($user\_data); |
  | 567 |  | $this->add\_update\_usermeta($user\_meta,$v->source\_id); |
  | 568 |  | } |
  | 569 |  | } |
  | 570 |  |  |
  | 571 |  | //Update user |
  | 572 |  | if( isset($v->event\_slug) && ($v->event\_slug == 'profile\_update') ){ |
  | 573 |  | $this->InstaWP\_db->update($user\_table,$user\_data,array( 'ID' => $v->source\_id )); |
  | 574 |  | $this->add\_update\_usermeta($user\_meta,$v->source\_id); |
  | 575 |  | $user->add\_role( $v->details->role ); |
  | 576 |  | } |
  | 577 |  |  |
  | 578 |  | //Delete user |
  | 579 |  | if( isset($v->event\_slug) && ($v->event\_slug == 'delete\_user') ){ |
  | 580 |  | if(isset($user->data->user\_email)){ |
  | 581 |  | if($user->data->user\_email == $user\_data['data']->user\_email){ |
  | 582 |  | wp\_delete\_user($v->source\_id); |
  | 583 |  | } |
  | 584 |  | } |
  | 585 |  | } |
  | 586 |  |  |
  | 587 |  | #message |
  | 588 |  | $message = 'Sync successfully.'; |
  | 589 |  | $status = 'completed'; |
  | 590 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 591 |  | #changes |
  | 592 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 593 |  | } |
  | 594 |  |  |
  | 595 |  | /\* |
  | 596 |  | \* widget |
  | 597 |  | \*/ |
  | 598 |  | if(isset($v->event\_type) && $v->event\_type == 'widget'){ |
  | 599 |  | $widget\_block = (array) $v->details->widget\_block; |
  | 600 |  | $appp = (array) $v->details; |
  | 601 |  | $dataIns = [ |
  | 602 |  | 'data' => json\_encode($appp) |
  | 603 |  | ]; |
  | 604 |  | $this->InstaWP\_db->insert('wp\_testing',$dataIns); |
  | 605 |  |  |
  | 606 |  | $widget\_block\_arr = []; |
  | 607 |  | foreach($widget\_block as $widget\_key => $widget\_val){ |
  | 608 |  | if($widget\_key == '\_multiwidget'){ |
  | 609 |  | $widget\_block\_arr[$widget\_key] = $widget\_val; |
  | 610 |  | }else{ |
  | 611 |  | $widget\_val\_arr = (array) $widget\_val; |
  | 612 |  | $widget\_block\_arr[$widget\_key] = ['content' => $widget\_val\_arr['content']]; |
  | 613 |  | } |
  | 614 |  | } |
  | 615 |  | update\_option('widget\_block',$widget\_block\_arr); |
  | 616 |  | #message |
  | 617 |  | $message = 'Sync successfully.'; |
  | 618 |  | $status = 'completed'; |
  | 619 |  | $sync\_response[] = $this->sync\_opration\_response($status,$message,$v); |
  | 620 |  | #changes |
  | 621 |  | $changes[$v->event\_type] = $changes[$v->event\_type] + 1; |
  | 622 |  | } |
  | 623 |  | /\* |
  | 624 |  | \* Update api for cloud |
  | 625 |  | \*/ |
  | 626 |  | $progress = intval($count/$total\_op \* 100); |
  | 627 |  | $progress\_status = ($progress > 100 ) ?  'in\_progress': 'completed'; |
  | 628 |  | #Sync update |
  | 629 |  | $syncUpdate = [ |
  | 630 |  | 'progress' => $progress, |
  | 631 |  | 'status' => $progress\_status, |
  | 632 |  | 'message' => $message, |
  | 633 |  | 'changes' => ['changes' => $changes,'sync\_response' => $sync\_response], |
  | 634 |  | ]; |
  | 635 |  | $this->sync\_update($sync\_id,$syncUpdate,$source\_connect\_id); |
  | 636 |  | $count++; |
  | 637 |  | } |
  | 638 |  | } |
  | 639 |  |  |
  | 640 |  | #Sync history save |
  | 641 |  | $this->sync\_history\_save($body,$changes,'Complete'); |
  | 642 |  |  |
  | 643 |  | #enable is back if syncing already enabled at the destination |
  | 644 |  | if($is\_enabled){ |
  | 645 |  | update\_option('syncing\_enabled\_disabled', 1); |
  | 646 |  | } |
  | 647 |  |  |
  | 648 |  | return new WP\_REST\_Response( |
  | 649 |  | array( |
  | 650 |  | 'encrypted\_contents' => $encrypted\_contents, |
  | 651 |  | 'source\_connect\_id' => $source\_connect\_id, |
  | 652 |  | 'changes' => ['changes' => $changes,'sync\_response' => $sync\_response], |
  | 653 |  | 'sync\_id' => $sync\_id |
  | 654 |  | ) |
  | 655 |  | ); |
  | 656 |  | } |
  | 657 |  |  |
  | 658 |  | /\*\* |
  | 659 |  | \* This function is for upload media which are coming form widgets. |
  | 660 |  | \*/ |
  | 661 |  | public function upload\_widgets\_media($media = null, $content = null){ |
  | 662 |  | $media = json\_decode(reset($media)); |
  | 663 |  | $new = $old = []; |
  | 664 |  | $newContent = ''; |
  | 665 |  | if(!empty($media)){ |
  | 666 |  | foreach($media as $v){ |
  | 667 |  | $v = (array) $v; |
  | 668 |  | if(isset($v['attachment\_id']) && isset($v['attachment\_url'])){ |
  | 669 |  | $attachment\_id = $this->insert\_attachment($v['attachment\_id'],$v['attachment\_url']); |
  | 670 |  | $new[] = wp\_get\_attachment\_url($attachment\_id); |
  | 671 |  | $old[] = $v['attachment\_url']; |
  | 672 |  | } |
  | 673 |  | } |
  | 674 |  | $newContent = str\_replace($old, $new, $content); #str\_replace(old,new,str) |
  | 675 |  | } |
  | 676 |  | return $newContent; |
  | 677 |  | } |
  | 678 |  |  |
  | 679 |  | public function user\_id\_exists($user\_id){ |
  | 680 |  | $table\_name = $this->wpdb->prefix.'users'; |
  | 681 |  | $count = $this->wpdb->get\_var($this->wpdb->prepare("SELECT COUNT(\*) FROM $table\_name WHERE ID = %d",$user\_id)); |
  | 682 |  | if($count == 1){ return true; }else{ return false; } |
  | 683 |  | } |
  | 684 |  |  |
  | 685 |  | public function blogDescription($v = null){ |
  | 686 |  | $this->wpdb->update($this->wpdb->prefix.'options',['option\_value' => $v],array( 'option\_name' => 'blogdescription' )); |
  | 687 |  | } |
  | 688 |  |  |
  | 689 |  | /\*\* |
  | 690 |  | \* object to array conversation |
  | 691 |  | \*/ |
  | 692 |  | public function object\_to\_array($data) { |
  | 693 |  | if ((! is\_array($data)) and (! is\_object($data))){ |
  | 694 |  | return; |
  | 695 |  | } |
  | 696 |  | $result = array(); |
  | 697 |  | $data = (array) $data; |
  | 698 |  | foreach ($data as $key => $value) { |
  | 699 |  | if (is\_object($value)) |
  | 700 |  | $value = (array) $value; |
  | 701 |  | if (is\_array($value)) |
  | 702 |  | $result[$key] = $this->object\_to\_array($value); |
  | 703 |  | else |
  | 704 |  | $result[$key] = $value; |
  | 705 |  | } |
  | 706 |  | return $result; |
  | 707 |  | } |
  | 708 |  |  |
  | 709 |  | /\*\* |
  | 710 |  | \* Create woocommerce attribute |
  | 711 |  | \*/ |
  | 712 |  | public function woocommerce\_create\_attribute($source\_id,$data = null){ |
  | 713 |  | $format = array( '%s', '%s', '%s', '%s', '%d' ); |
  | 714 |  | $data['attribute\_id'] = intval($source\_id); |
  | 715 |  | $results = $this->wpdb->insert( |
  | 716 |  | $this->wpdb->prefix . 'woocommerce\_attribute\_taxonomies', |
  | 717 |  | $data, |
  | 718 |  | $format |
  | 719 |  | ); |
  | 720 |  |  |
  | 721 |  | if ( is\_wp\_error( $results ) ) { |
  | 722 |  | return new WP\_Error( 'cannot\_create\_attribute', 'Can not create attribute!', array( 'status' => 400 ) ); |
  | 723 |  | } |
  | 724 |  | $id = $this->wpdb->insert\_id; |
  | 725 |  | /\*\* |
  | 726 |  | \* Attribute added. |
  | 727 |  | \* |
  | 728 |  | \* @param int   $id   Added attribute ID. |
  | 729 |  | \* @param array $data Attribute data. |
  | 730 |  | \*/ |
  | 731 |  | do\_action( 'woocommerce\_attribute\_added', $id, $data ); |
  | 732 |  | // Clear cache and flush rewrite rules. |
  | 733 |  | wp\_schedule\_single\_event( time(), 'woocommerce\_flush\_rewrite\_rules' ); |
  | 734 |  | delete\_transient( 'wc\_attribute\_taxonomies' ); |
  | 735 |  | WC\_Cache\_Helper::invalidate\_cache\_group( 'woocommerce-attributes' ); |
  | 736 |  | } |
  | 737 |  |  |
  | 738 |  | /\*\* |
  | 739 |  | \* Set product gallery |
  | 740 |  | \*/ |
  | 741 |  | public function set\_product\_gallery($product\_id = null, $gallery\_ids = null){ |
  | 742 |  | $product = new WC\_product($product\_id); |
  | 743 |  | $product->set\_gallery\_image\_ids( $gallery\_ids ); |
  | 744 |  | $product->save(); |
  | 745 |  | } |
  | 746 |  |  |
  | 747 |  | public function customizer\_site\_icon($data = null){ |
  | 748 |  | $attachment\_id = $data->id; |
  | 749 |  | $url = $data->url; |
  | 750 |  | if(isset($attachment\_id) && !empty($attachment\_id)){ |
  | 751 |  | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
  | 752 |  | if(!empty($attUrl)){ |
  | 753 |  | update\_option('site\_icon',$attachment\_id); |
  | 754 |  | }else{ |
  | 755 |  | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
  | 756 |  | update\_option('site\_icon',$attachment\_id); |
  | 757 |  | } |
  | 758 |  | }else{ |
  | 759 |  | update\_option('site\_icon',$attachment\_id); |
  | 760 |  | } |
  | 761 |  | } |
  | 762 |  |  |
  | 763 |  | public function customizer\_custom\_logo($data){ |
  | 764 |  | $attachment\_id = $data->id; |
  | 765 |  | $url = $data->url; |
  | 766 |  | if(isset($attachment\_id) && !empty($attachment\_id)){ |
  | 767 |  | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
  | 768 |  | if(!empty($attUrl)){ |
  | 769 |  | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  | 770 |  | }else{ |
  | 771 |  | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
  | 772 |  | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  | 773 |  | } |
  | 774 |  | }else{ |
  | 775 |  | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  | 776 |  | } |
  | 777 |  | } |
  | 778 |  |  |
  | 779 |  | public function customizer\_background\_image($data = null){ |
  | 780 |  | $attachment\_id = $data->id; |
  | 781 |  | $url = $data->url; |
  | 782 |  | if(isset($attachment\_id) && !empty($attachment\_id)){ |
  | 783 |  | $attUrl = wp\_get\_attachment\_url(intval($attachment\_id)); |
  | 784 |  | if(!empty($attUrl)){ |
  | 785 |  | set\_theme\_mod( 'background\_image', $attUrl ); |
  | 786 |  | }else{ |
  | 787 |  | $attachment\_id = $this->insert\_attachment($attachment\_id,$url); |
  | 788 |  | $attachment\_url = wp\_get\_attachment\_url(intval($attachment\_id)); |
  | 789 |  | set\_theme\_mod( 'background\_image', $attachment\_url ); |
  | 790 |  | } |
  | 791 |  | }else{ |
  | 792 |  | set\_theme\_mod( 'background\_image', $url ); |
  | 793 |  | } |
  | 794 |  |  |
  | 795 |  | if(isset($data->background\_preset) && !empty($data->background\_preset)){ |
  | 796 |  | set\_theme\_mod( 'background\_preset', $data->background\_preset ); |
  | 797 |  | } |
  | 798 |  |  |
  | 799 |  | if(isset($data->background\_size) && !empty($data->background\_size)){ |
  | 800 |  | set\_theme\_mod( 'background\_size', $data->background\_size ); |
  | 801 |  | } |
  | 802 |  |  |
  | 803 |  | if(isset($data->background\_repeat) && !empty($data->background\_repeat)){ |
  | 804 |  | set\_theme\_mod( 'background\_repeat', $data->background\_repeat ); |
  | 805 |  | } |
  | 806 |  |  |
  | 807 |  | if(isset($data->background\_attachment) && !empty($data->background\_attachment)){ |
  | 808 |  | set\_theme\_mod( 'background\_attachment', $data->background\_attachment ); |
  | 809 |  | } |
  | 810 |  |  |
  | 811 |  | if(isset($data->background\_position\_x) && !empty($data->background\_position\_x)){ |
  | 812 |  | set\_theme\_mod( 'background\_position\_x', $data->background\_position\_x ); |
  | 813 |  | } |
  | 814 |  |  |
  | 815 |  | if(isset($data->background\_position\_y) && !empty($data->background\_position\_y)){ |
  | 816 |  | set\_theme\_mod( 'background\_position\_y', $data->background\_position\_y ); |
  | 817 |  | } |
  | 818 |  | } |
  | 819 |  |  |
  | 820 |  | /\*\* |
  | 821 |  | \* This function is for upload media which are coming form content. |
  | 822 |  | \*/ |
  | 823 |  | public function upload\_content\_media($media = null, $post\_id = null){ |
  | 824 |  | $media = json\_decode(reset($media)); |
  | 825 |  | $post = get\_post($post\_id); |
  | 826 |  | $content = $post->post\_content; |
  | 827 |  | $new = $old = []; |
  | 828 |  | if(!empty($media)){ |
  | 829 |  | foreach($media as $v){ |
  | 830 |  | $v = (array) $v; |
  | 831 |  | if(isset($v['attachment\_id']) && isset($v['attachment\_url'])){ |
  | 832 |  | $attachment\_id = $this->handle\_attachments((array) $v['attachment\_media'], (array) $v['attachment\_media\_meta'], $v['attachment\_url']); |
  | 833 |  | $new[] = wp\_get\_attachment\_url($attachment\_id); |
  | 834 |  | $old[] = $v['attachment\_url']; |
  | 835 |  | } |
  | 836 |  | } |
  | 837 |  | $newContent = str\_replace($old, $new, $content); #str\_replace(old,new,str) |
  | 838 |  | $arg = array( |
  | 839 |  | 'ID'            => $post\_id, |
  | 840 |  | 'post\_content'  => $newContent, |
  | 841 |  | ); |
  | 842 |  | wp\_update\_post( $arg ); |
  | 843 |  | } |
  | 844 |  | } |
  | 845 |  |  |
  | 846 |  | public function notExistMsg(){ |
  | 847 |  | return "ID is not exists."; |
  | 848 |  | } |
  | 849 |  |  |
  | 850 |  | public function wp\_terms\_data($term\_id = null, $arr = []){ |
  | 851 |  | return [ |
  | 852 |  | 'term\_id' => $term\_id, |
  | 853 |  | 'name' => $arr['name'], |
  | 854 |  | 'slug' => $arr['slug'] |
  | 855 |  | ]; |
  | 856 |  | } |
  | 857 |  | public function wp\_term\_taxonomy\_data($term\_id = null, $arr = []){ |
  | 858 |  | return [ |
  | 859 |  | 'term\_taxonomy\_id' => $term\_id, |
  | 860 |  | 'term\_id' => $term\_id, |
  | 861 |  | 'taxonomy' => $arr['taxonomy'], |
  | 862 |  | 'description' => $arr['description'], |
  | 863 |  | 'parent' => $arr['parent'] |
  | 864 |  | ]; |
  | 865 |  | } |
  | 866 |  |  |
  | 867 |  | public function insert\_taxonomy($term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null){ |
  | 868 |  | $this->InstaWP\_db->insert($this->wpdb->prefix.'terms',$wp\_terms); |
  | 869 |  | $this->InstaWP\_db->insert($this->wpdb->prefix.'term\_taxonomy',$wp\_term\_taxonomy); |
  | 870 |  | } |
  | 871 |  |  |
  | 872 |  | public function update\_taxonomy($term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null){ |
  | 873 |  | $this->wpdb->update($this->wpdb->prefix.'terms',$wp\_terms,array( 'term\_id' => $term\_id )); |
  | 874 |  | $this->wpdb->update($this->wpdb->prefix.'term\_taxonomy',$wp\_term\_taxonomy,array( 'term\_id' => $term\_id )); |
  | 875 |  | } |
  | 876 |  |  |
  | 877 |  | public function reset\_post\_terms($post\_id){ |
  | 878 |  | $this->wpdb->query( |
  | 879 |  | $this->wpdb->prepare( |
  | 880 |  | "DELETE FROM {$this->wpdb->prefix}term\_relationships WHERE object\_id = %d", |
  | 881 |  | $post\_id, |
  | 882 |  | ) |
  | 883 |  | ); |
  | 884 |  | } |
  | 885 |  |  |
  | 886 |  | public function add\_update\_postmeta($meta\_data = null, $post\_id = null){ |
  | 887 |  |  |
  | 888 |  | if(!empty($meta\_data) && is\_array($meta\_data)){ |
  | 889 |  | foreach($meta\_data as $k => $v){ |
  | 890 |  | if(isset($v[0])){ |
  | 891 |  | $checkSerialize = @unserialize($v[0]); |
  | 892 |  | $metaVal = ($checkSerialize !== false || $v[0] === 'b:0;') ? unserialize($v[0]) : $v[0]; |
  | 893 |  | if ( metadata\_exists('post',$post\_id,$k) ) { |
  | 894 |  | update\_post\_meta($post\_id,$k,$metaVal); |
  | 895 |  | }else{ |
  | 896 |  | add\_post\_meta($post\_id,$k,$metaVal); |
  | 897 |  | } |
  | 898 |  | } |
  | 899 |  | } |
  | 900 |  |  |
  | 901 |  | //if \_elementor\_css this key not existing then it's giving a error. |
  | 902 |  | if(array\_key\_exists('\_elementor\_version',$meta\_data)){ |
  | 903 |  | if(!array\_key\_exists('\_elementor\_css',$meta\_data)){ |
  | 904 |  | /\*$elementor\_css = [ |
  | 905 |  | 'time' => time(), |
  | 906 |  | 'fonts' => [], |
  | 907 |  | 'icons' => [], |
  | 908 |  | 'dynamic\_elements\_ids' => [], |
  | 909 |  | 'status' => 'empty', |
  | 910 |  | 'css' => '' |
  | 911 |  | ]; |
  | 912 |  | \*/ |
  | 913 |  | $elementor\_css = []; |
  | 914 |  | add\_post\_meta($post\_id,'\_elementor\_css',$elementor\_css); |
  | 915 |  | } |
  | 916 |  | } |
  | 917 |  |  |
  | 918 |  | //delete the edit lock post |
  | 919 |  | delete\_post\_meta($post\_id,'\_edit\_lock'); |
  | 920 |  | } |
  | 921 |  | } |
  | 922 |  |  |
  | 923 |  | public function postData($posts = null, $op = null){ |
  | 924 |  | $args = array( |
  | 925 |  | 'post\_author' => $posts['post\_author'], |
  | 926 |  | 'post\_date' => $posts['post\_date'], |
  | 927 |  | 'post\_date\_gmt' => $posts['post\_date\_gmt'], |
  | 928 |  | 'post\_content' => $posts['post\_content'], |
  | 929 |  | 'post\_title' => $posts['post\_title'], |
  | 930 |  | 'post\_excerpt' => $posts['post\_excerpt'], |
  | 931 |  | 'post\_status' => $posts['post\_status'], |
  | 932 |  | 'comment\_status' => $posts['comment\_status'], |
  | 933 |  | 'ping\_status' => $posts['ping\_status'], |
  | 934 |  | 'post\_password' => $posts['post\_password'], |
  | 935 |  | 'post\_name' => $posts['post\_name'], |
  | 936 |  | 'to\_ping' => $posts['to\_ping'], |
  | 937 |  | 'pinged' => $posts['pinged'], |
  | 938 |  | 'post\_modified' => $posts['post\_modified'], |
  | 939 |  | 'post\_modified\_gmt' => $posts['post\_modified\_gmt'], |
  | 940 |  | 'post\_content\_filtered' => $posts['post\_content\_filtered'], |
  | 941 |  | 'post\_parent' => $posts['post\_parent'], |
  | 942 |  | //'guid' => $posts['guid'], |
  | 943 |  | 'menu\_order' => $posts['menu\_order'], |
  | 944 |  | 'post\_type' => $posts['post\_type'], |
  | 945 |  | 'post\_mime\_type' => $posts['post\_mime\_type'], |
  | 946 |  | 'comment\_count' => $posts['comment\_count'], |
  | 947 |  | 'filter' => $posts['filter'], |
  | 948 |  | ); |
  | 949 |  | #ID to update existing post |
  | 950 |  | if(isset($posts['ID']) && $posts['ID'] > 0){ |
  | 951 |  | $args = array\_merge(['ID'=> $posts['ID'] ],$args); |
  | 952 |  | } |
  | 953 |  | return $args; |
  | 954 |  | } |
  | 955 |  |  |
  | 956 |  | # import attechments form source to destination. |
  | 957 |  | public function handle\_attachments($attachment\_post, $attachment\_post\_meta, $file){ |
  | 958 |  | $reference\_id = ''; |
  | 959 |  | if(isset($attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0])){ |
  | 960 |  | $reference\_id = $attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0]; |
  | 961 |  | } |
  | 962 |  | $attachment\_id = $this->get\_post\_by\_reference\_Id($attachment\_post['post\_type'], $reference\_id, $attachment\_post['post\_name']); |
  | 963 |  | if(!$attachment\_id){ |
  | 964 |  | $filename = basename($file); |
  | 965 |  | $arrContextOptions=array( |
  | 966 |  | "ssl"=>array( |
  | 967 |  | "verify\_peer"=>false, |
  | 968 |  | "verify\_peer\_name"=>false, |
  | 969 |  | ), |
  | 970 |  | ); |
  | 971 |  | $parent\_post\_id = 0; |
  | 972 |  | $upload\_file = wp\_upload\_bits($filename, null, file\_get\_contents($file,false, stream\_context\_create($arrContextOptions))); |
  | 973 |  | if (!$upload\_file['error']) { |
  | 974 |  | $wp\_filetype = wp\_check\_filetype($filename, null ); |
  | 975 |  | $attachment = array( |
  | 976 |  | 'post\_mime\_type' => $wp\_filetype['type'], |
  | 977 |  | 'post\_parent' => $parent\_post\_id, |
  | 978 |  | 'post\_title' => preg\_replace('/\.[^.]+$/', '', $filename), |
  | 979 |  | 'post\_content' => '', |
  | 980 |  | 'post\_status' => 'inherit' |
  | 981 |  | ); |
  | 982 |  | require\_once(ABSPATH . "wp-admin" . '/includes/image.php'); |
  | 983 |  | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
  | 984 |  | require\_once(ABSPATH . "wp-admin" . '/includes/media.php'); |
  | 985 |  | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
  | 986 |  | if (!is\_wp\_error($attachment\_id)) { |
  | 987 |  | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
  | 988 |  | wp\_update\_attachment\_metadata( $attachment\_id,  $attachment\_data ); |
  | 989 |  | $this->add\_update\_postmeta(['instawp\_event\_sync\_reference\_id' =>[$reference\_id]], $attachment\_id); |
  | 990 |  | } |
  | 991 |  | return $attachment\_id; |
  | 992 |  | } |
  | 993 |  | return; |
  | 994 |  | } |
  | 995 |  | return $attachment\_id; |
  | 996 |  | } |
  | 997 |  | # import attechments form source to destination. |
  | 998 |  | public function insert\_attachment($attachment\_id = null, $file = null){ |
  | 999 |  | $filename = basename($file); |
  | 1000 |  | $arrContextOptions=array( |
  | 1001 |  | "ssl"=>array( |
  | 1002 |  | "verify\_peer"=>false, |
  | 1003 |  | "verify\_peer\_name"=>false, |
  | 1004 |  | ), |
  | 1005 |  | ); |
  | 1006 |  | $parent\_post\_id = 0; |
  | 1007 |  | $upload\_file = wp\_upload\_bits($filename, null, file\_get\_contents($file,false, stream\_context\_create($arrContextOptions))); |
  | 1008 |  | if (!$upload\_file['error']) { |
  | 1009 |  | $wp\_filetype = wp\_check\_filetype($filename, null ); |
  | 1010 |  | $attachment = array( |
  | 1011 |  | 'import\_id' => $attachment\_id, |
  | 1012 |  | 'post\_mime\_type' => $wp\_filetype['type'], |
  | 1013 |  | 'post\_parent' => $parent\_post\_id, |
  | 1014 |  | 'post\_title' => preg\_replace('/\.[^.]+$/', '', $filename), |
  | 1015 |  | 'post\_content' => '', |
  | 1016 |  | 'post\_status' => 'inherit' |
  | 1017 |  | ); |
  | 1018 |  | require\_once(ABSPATH . "wp-admin" . '/includes/image.php'); |
  | 1019 |  | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
  | 1020 |  | require\_once(ABSPATH . "wp-admin" . '/includes/media.php'); |
  | 1021 |  | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
  | 1022 |  | if (!is\_wp\_error($attachment\_id)) { |
  | 1023 |  | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
  | 1024 |  | wp\_update\_attachment\_metadata( $attachment\_id,  $attachment\_data ); |
  | 1025 |  | } |
  | 1026 |  | } |
  | 1027 |  | return $attachment\_id; |
  | 1028 |  | } |
  | 1029 |  |  |
  | 1030 |  | #Insert history |
  | 1031 |  | public function sync\_history\_save($body = null, $changes = null,$status = null){ |
  | 1032 |  | $dir = 'dev-to-live'; |
  | 1033 |  | $date = date('Y-m-d H:i:s'); |
  | 1034 |  | $bodyArr = json\_decode($body); |
  | 1035 |  | $message = isset($bodyArr->sync\_message) ? $bodyArr->sync\_message : ''; |
  | 1036 |  | $data = [ |
  | 1037 |  | 'encrypted\_contents' => $bodyArr->encrypted\_contents, |
  | 1038 |  | 'changes' => json\_encode($changes), |
  | 1039 |  | 'sync\_response' => '', |
  | 1040 |  | 'direction' => $dir, |
  | 1041 |  | 'status' => $status, |
  | 1042 |  | 'user\_id' => isset($bodyArr->upload\_wp\_user) ? $bodyArr->upload\_wp\_user : '', |
  | 1043 |  | 'changes\_sync\_id' => isset($bodyArr->sync\_id) ? $bodyArr->sync\_id : '', |
  | 1044 |  | 'sync\_message' => $message, |
  | 1045 |  | 'source\_connect\_id' => '', |
  | 1046 |  | 'source\_url' => isset($bodyArr->source\_url) ? $bodyArr->source\_url : '', |
  | 1047 |  | 'date' => $date, |
  | 1048 |  | ]; |
  | 1049 |  | $this->InstaWP\_db->insert($this->tables['sh\_table'],$data); |
  | 1050 |  | } |
  | 1051 |  |  |
  | 1052 |  | #Plugin activate. |
  | 1053 |  | public function plugin\_activation( $plugin ) { |
  | 1054 |  | if( ! function\_exists('activate\_plugin') ) { |
  | 1055 |  | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  | 1056 |  | } |
  | 1057 |  |  |
  | 1058 |  | if( ! is\_plugin\_active( $plugin ) ) { |
  | 1059 |  | activate\_plugin( $plugin ); |
  | 1060 |  | } |
  | 1061 |  | } |
  | 1062 |  |  |
  | 1063 |  | #Plugin deactivate. |
  | 1064 |  | public function plugin\_deactivation( $plugin ) { |
  | 1065 |  | if( ! function\_exists('deactivate\_plugins') ) { |
  | 1066 |  | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  | 1067 |  | } |
  | 1068 |  | if( is\_plugin\_active( $plugin ) ) { |
  | 1069 |  | deactivate\_plugins( $plugin ); |
  | 1070 |  | } |
  | 1071 |  | } |
  | 1072 |  |  |
  | 1073 |  | public function sync\_message($rel = null){ |
  | 1074 |  | if(isset($rel->ID)){ |
  | 1075 |  | $message = 'Sync successfully.'; |
  | 1076 |  | }else{ |
  | 1077 |  | $message = 'Something went wrong.'; |
  | 1078 |  | } |
  | 1079 |  | return $message; |
  | 1080 |  | } |
  | 1081 |  |  |
  | 1082 |  | public function sync\_post\_status($rel = null){ |
  | 1083 |  | $status = 'in\_progress'; |
  | 1084 |  | if(isset($rel->ID)){ |
  | 1085 |  | $status = 'completed'; |
  | 1086 |  | }else{ |
  | 1087 |  | $status = 'pending'; |
  | 1088 |  | } |
  | 1089 |  | return $status; |
  | 1090 |  | } |
  | 1091 |  |  |
  | 1092 |  | public function sync\_opration\_response($status = null, $message = null, $v = null){ |
  | 1093 |  | return [ |
  | 1094 |  | 'id' => $v->id, |
  | 1095 |  | 'status' => $status, |
  | 1096 |  | 'message' => $message |
  | 1097 |  | ]; |
  | 1098 |  | } |
  | 1099 |  |  |
  | 1100 |  | public function sync\_update($sync\_id = null, $data = null, $source\_connect\_id = null){ |
  | 1101 |  | global $InstaWP\_Curl; |
  | 1102 |  | $api\_doamin = InstaWP\_Setting::get\_api\_domain(); |
  | 1103 |  | $connect\_id = intval($source\_connect\_id); |
  | 1104 |  | $endpoint = '/api/v2/connects/'.$connect\_id.'/syncs/'.$sync\_id; |
  | 1105 |  | $url = $api\_doamin.$endpoint; #https://stage.instawp.io/api/v2/connects/241/syncs/450 |
  | 1106 |  | $api\_key = $this->get\_api\_key(); |
  | 1107 |  |  |
  | 1108 |  | try{ |
  | 1109 |  | $curl = curl\_init(); |
  | 1110 |  | curl\_setopt\_array($curl, array( |
  | 1111 |  | CURLOPT\_URL => $url, |
  | 1112 |  | CURLOPT\_RETURNTRANSFER => true, |
  | 1113 |  | CURLOPT\_ENCODING => '', |
  | 1114 |  | CURLOPT\_MAXREDIRS => 10, |
  | 1115 |  | CURLOPT\_TIMEOUT => 0, |
  | 1116 |  | CURLOPT\_FOLLOWLOCATION => true, |
  | 1117 |  | CURLOPT\_HTTP\_VERSION => CURL\_HTTP\_VERSION\_1\_1, |
  | 1118 |  | CURLOPT\_CUSTOMREQUEST => 'PATCH', |
  | 1119 |  | CURLOPT\_POSTFIELDS => json\_encode($data), |
  | 1120 |  | CURLOPT\_HTTPHEADER => array( |
  | 1121 |  | 'Authorization: Bearer '.$api\_key.'', |
  | 1122 |  | 'Content-Type: application/json' |
  | 1123 |  | ), |
  | 1124 |  | )); |
  | 1125 |  |  |
  | 1126 |  | $response = curl\_exec($curl); |
  | 1127 |  | return $response; |
  | 1128 |  | } catch (Exception $e) { |
  | 1129 |  | return $e->getMessage(); |
  | 1130 |  | } |
  | 1131 |  | } |
  | 1132 |  |  |
  | 1133 |  | function get\_api\_key(){ |
  | 1134 |  | $instawp\_api\_options = get\_option('instawp\_api\_options'); |
  | 1135 |  | return $instawp\_api\_options['api\_key']; |
  | 1136 |  | } |
  | 1137 |  |  |
  | 1138 |  | /\* |
  | 1139 |  | \* Create elementor css file 'post-{post\_id}.css' |
  | 1140 |  | \*/ |
  | 1141 |  | public function create\_elementor\_css\_file($data = null, $post\_id = null){ |
  | 1142 |  | $upload\_dir = wp\_upload\_dir(); |
  | 1143 |  | $filename = 'post-'.$post\_id.'.css'; |
  | 1144 |  | $filePath = $upload\_dir['basedir'].'/elementor/css/'.$filename; |
  | 1145 |  | $file = fopen($filePath, "w+");//w+,w |
  | 1146 |  | fwrite($file, $data); |
  | 1147 |  | fclose($file); |
  | 1148 |  | } |
  | 1149 |  |  |
  | 1150 |  | /\*\* |
  | 1151 |  | \* Plugin install |
  | 1152 |  | \*/ |
  | 1153 |  | public function plugin\_install($plugin\_slug){ |
  | 1154 |  | include\_once( ABSPATH . 'wp-admin/includes/plugin-install.php' ); //for plugins\_api.. |
  | 1155 |  | $api = plugins\_api( 'plugin\_information', array( |
  | 1156 |  | 'slug' => $plugin\_slug, |
  | 1157 |  | 'fields' => array( |
  | 1158 |  | 'short\_description' => false, |
  | 1159 |  | 'sections' => false, |
  | 1160 |  | 'requires' => false, |
  | 1161 |  | 'rating' => false, |
  | 1162 |  | 'ratings' => false, |
  | 1163 |  | 'downloaded' => false, |
  | 1164 |  | 'last\_updated' => false, |
  | 1165 |  | 'added' => false, |
  | 1166 |  | 'tags' => false, |
  | 1167 |  | 'compatibility' => false, |
  | 1168 |  | 'homepage' => false, |
  | 1169 |  | 'donate\_link' => false, |
  | 1170 |  | ), |
  | 1171 |  | )); |
  | 1172 |  | //includes necessary for Plugin\_Upgrader and Plugin\_Installer\_Skin |
  | 1173 |  | include\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
  | 1174 |  | include\_once( ABSPATH . 'wp-admin/includes/misc.php' ); |
  | 1175 |  | include\_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' ); |
  | 1176 |  | $upgrader = new Plugin\_Upgrader( new Plugin\_Installer\_Skin( compact('title', 'url', 'nonce', 'plugin', 'api') ) ); |
  | 1177 |  | $upgrader->install($api->download\_link); |
  | 1178 |  | } |
  | 1179 |  |  |
  | 1180 |  | /\*\* |
  | 1181 |  | \* Check if plugin is installed by getting all plugins from the plugins dir |
  | 1182 |  | \* |
  | 1183 |  | \* @param $plugin\_slug |
  | 1184 |  | \* |
  | 1185 |  | \* @return bool |
  | 1186 |  | \*/ |
  | 1187 |  | public function check\_plugin\_installed( $plugin\_slug ): bool { |
  | 1188 |  | $installed\_plugins = get\_plugins(); |
  | 1189 |  | return array\_key\_exists( $plugin\_slug, $installed\_plugins ) || in\_array( $plugin\_slug, $installed\_plugins, true ); |
  | 1190 |  | } |
  | 1191 |  |  |
  | 1192 |  | //add and update user meta |
  | 1193 |  | public function add\_update\_usermeta($user\_meta = null, $user\_id = null){ |
  | 1194 |  | if(!empty($user\_meta) && is\_array($user\_meta)){ |
  | 1195 |  | foreach($user\_meta as $k => $v){ |
  | 1196 |  | if(isset($v[0])){ |
  | 1197 |  | $checkSerialize = @unserialize($v[0]); |
  | 1198 |  | $metaVal = ($checkSerialize !== false || $v[0] === 'b:0;') ? unserialize($v[0]) : $v[0]; |
  | 1199 |  | if ( metadata\_exists('user',$user\_id,$k) ) { |
  | 1200 |  | update\_user\_meta($user\_id,$k,$metaVal); |
  | 1201 |  | }else{ |
  | 1202 |  | add\_user\_meta($user\_id,$k,$metaVal); |
  | 1203 |  | } |
  | 1204 |  | } |
  | 1205 |  | } |
  | 1206 |  | } |
  | 1207 |  | } |
  | 1208 |  |  |
  | 1209 |  | /\*\* |
  | 1210 |  | \* Set Astra Costmizer Setings |
  | 1211 |  | \*/ |
  | 1212 |  | function setAstraCostmizerSetings($arr = null){ |
  | 1213 |  | #Checkout |
  | 1214 |  | update\_option('woocommerce\_checkout\_company\_field',$arr['woocommerce\_checkout\_company\_field']); |
  | 1215 |  | update\_option('woocommerce\_checkout\_address\_2\_field',$arr['woocommerce\_checkout\_address\_2\_field']); |
  | 1216 |  | update\_option('woocommerce\_checkout\_phone\_field',$arr['woocommerce\_checkout\_phone\_field']); |
  | 1217 |  | update\_option('woocommerce\_checkout\_highlight\_required\_fields',$arr['woocommerce\_checkout\_highlight\_required\_fields']); |
  | 1218 |  | update\_option('wp\_page\_for\_privacy\_policy',$arr['wp\_page\_for\_privacy\_policy']); |
  | 1219 |  | update\_option('woocommerce\_terms\_page\_id',$arr['woocommerce\_terms\_page\_id']); |
  | 1220 |  | update\_option('woocommerce\_checkout\_privacy\_policy\_text',$arr['woocommerce\_checkout\_privacy\_policy\_text']); |
  | 1221 |  | update\_option('woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text',$arr['woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text']); |
  | 1222 |  |  |
  | 1223 |  | #product catalog |
  | 1224 |  | update\_option('woocommerce\_shop\_page\_display',$arr['woocommerce\_shop\_page\_display']); |
  | 1225 |  | update\_option('woocommerce\_default\_catalog\_orderby',$arr['woocommerce\_default\_catalog\_orderby']); |
  | 1226 |  | update\_option('woocommerce\_category\_archive\_display',$arr['woocommerce\_category\_archive\_display']); |
  | 1227 |  |  |
  | 1228 |  | #Product Images |
  | 1229 |  | update\_option('woocommerce\_single\_image\_width',$arr['woocommerce\_single\_image\_width']); |
  | 1230 |  | update\_option('woocommerce\_thumbnail\_image\_width',$arr['woocommerce\_thumbnail\_image\_width']); |
  | 1231 |  | update\_option('woocommerce\_thumbnail\_cropping',$arr['woocommerce\_thumbnail\_cropping']); |
  | 1232 |  | update\_option('woocommerce\_thumbnail\_cropping\_custom\_width',$arr['woocommerce\_thumbnail\_cropping\_custom\_width']); |
  | 1233 |  | update\_option('woocommerce\_thumbnail\_cropping\_custom\_height',$arr['woocommerce\_thumbnail\_cropping\_custom\_height']); |
  | 1234 |  |  |
  | 1235 |  | #Store Notice |
  | 1236 |  | update\_option('woocommerce\_demo\_store',$arr['woocommerce\_demo\_store']); |
  | 1237 |  | update\_option('woocommerce\_demo\_store\_notice',$arr['woocommerce\_demo\_store\_notice']); |
  | 1238 |  | } |
  |  | 25 | if ( ! class\_exists( 'InstaWP\_Backup\_Api' ) ) { |
  |  | 26 | require\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-rest-api.php'; |
  | 1239 | 27 | } |
  |  | 28 |  |
  |  | 29 |  |
  |  | 30 | class InstaWP\_Rest\_Apis extends InstaWP\_Backup\_Api { |
  |  | 31 |  |
  |  | 32 | private $wpdb; |
  |  | 33 |  |
  |  | 34 | private $InstaWP\_db; |
  |  | 35 |  |
  |  | 36 | private $tables; |
  |  | 37 |  |
  |  | 38 | public function \_\_construct() { |
  |  | 39 |  |
  |  | 40 | parent::\_\_construct(); |
  |  | 41 |  |
  |  | 42 | global $wpdb; |
  |  | 43 |  |
  |  | 44 | $this->wpdb = $wpdb; |
  |  | 45 |  |
  |  | 46 | $this->InstaWP\_db = new InstaWP\_DB(); |
  |  | 47 |  |
  |  | 48 | $this->tables = $this->InstaWP\_db->tables; |
  |  | 49 |  |
  |  | 50 | /\* |
  |  | 51 | \* Initiate Sync |
  |  | 52 | \* Endpoint : /wp-json/instawp-connect/v1/sync |
  |  | 53 | \* HOOK - rest\_api\_init |
  |  | 54 | \*/ |
  |  | 55 |  |
  |  | 56 | add\_action( 'rest\_api\_init', function () { |
  |  | 57 | register\_rest\_route( 'instawp-connect/v1', '/sync', |
  |  | 58 | array( |
  |  | 59 | 'methods'             => 'POST', |
  |  | 60 | 'callback'            => [ $this, 'events\_receiver' ], |
  |  | 61 | 'permission\_callback' => [ $this, 'check\_permission' ], |
  |  | 62 | ) |
  |  | 63 | ); |
  |  | 64 | } ); |
  |  | 65 | } |
  |  | 66 |  |
  |  | 67 | function check\_permission() { |
  |  | 68 | return true; |
  |  | 69 | } |
  |  | 70 |  |
  |  | 71 | public function get\_post\_by\_reference\_Id( $post\_type, $reference\_id, $post\_name ) { |
  |  | 72 | $post = get\_posts( array( |
  |  | 73 | 'post\_type'   => $post\_type, |
  |  | 74 | 'meta\_key'    => 'instawp\_event\_sync\_reference\_id', |
  |  | 75 | 'meta\_value'  => $reference\_id, |
  |  | 76 | 'post\_status' => 'any' |
  |  | 77 | ) ); |
  |  | 78 | if ( ! empty( $post ) ) { |
  |  | 79 | $post = $post[0]; |
  |  | 80 | } else { |
  |  | 81 | $post = instawp\_get\_post\_by\_name( $post\_name, $post\_type ); |
  |  | 82 | } |
  |  | 83 |  |
  |  | 84 | return $post; |
  |  | 85 | } |
  |  | 86 |  |
  |  | 87 | public function create\_or\_update\_post( $post, $post\_meta ) { |
  |  | 88 | $reference\_id     = isset( $post\_meta['instawp\_event\_sync\_reference\_id'][0] ) ? $post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
  |  | 89 | $destination\_post = $this->get\_post\_by\_reference\_Id( $post['post\_type'], $reference\_id, $post['post\_name'] ); |
  |  | 90 | unset( $post['ID'] ); |
  |  | 91 | if ( ! empty( $destination\_post ) ) { |
  |  | 92 | #The post exists,Then update |
  |  | 93 | $post\_id = $post['ID'] = $destination\_post->ID; |
  |  | 94 | //$post['post\_parent'] = $destination\_post->post\_parent; |
  |  | 95 | $postData = $this->postData( $post ); |
  |  | 96 | wp\_update\_post( $postData ); |
  |  | 97 | #post meta |
  |  | 98 | $this->add\_update\_postmeta( $post\_meta, $destination\_post->ID ); |
  |  | 99 | } else { |
  |  | 100 | $postData = $this->postData( $post ); |
  |  | 101 | #The post does not exist,Then insert |
  |  | 102 | $post\_id = wp\_insert\_post( $postData ); |
  |  | 103 | #post meta |
  |  | 104 | $this->add\_update\_postmeta( $post\_meta, $post\_id ); |
  |  | 105 | } |
  |  | 106 |  |
  |  | 107 | return $post\_id; |
  |  | 108 | } |
  |  | 109 |  |
  |  | 110 |  |
  |  | 111 | /\*\* |
  |  | 112 | \* Handle events receiver api |
  |  | 113 | \* |
  |  | 114 | \* @param WP\_REST\_Request $req |
  |  | 115 | \* |
  |  | 116 | \* @return WP\_Error|WP\_HTTP\_Response|WP\_REST\_Response |
  |  | 117 | \*/ |
  |  | 118 | public function events\_receiver( WP\_REST\_Request $req ) { |
  |  | 119 |  |
  |  | 120 | $response = $this->validate\_api\_request( $req ); |
  |  | 121 | if ( is\_wp\_error( $response ) ) { |
  |  | 122 | return $this->throw\_error( $response ); |
  |  | 123 | } |
  |  | 124 |  |
  |  | 125 | $body               = $req->get\_body(); |
  |  | 126 | $bodyArr            = json\_decode( $body ); |
  |  | 127 | $encrypted\_contents = json\_decode( $bodyArr->encrypted\_contents ); |
  |  | 128 | $sync\_id            = $bodyArr->sync\_id; |
  |  | 129 | $source\_connect\_id  = $bodyArr->source\_connect\_id; |
  |  | 130 | $is\_enabled         = false; |
  |  | 131 |  |
  |  | 132 |  |
  |  | 133 | if ( get\_option( 'syncing\_enabled\_disabled' ) ) { |
  |  | 134 | $is\_enabled = true; |
  |  | 135 | } |
  |  | 136 |  |
  |  | 137 | #forcely disable the syncing at the destination |
  |  | 138 | update\_option( 'syncing\_enabled\_disabled', 0 ); |
  |  | 139 |  |
  |  | 140 | if ( ! empty( $encrypted\_contents ) && is\_array( $encrypted\_contents ) ) { |
  |  | 141 | $total\_op        = count( $encrypted\_contents ); |
  |  | 142 | $count           = 1; |
  |  | 143 | $progress\_status = 'pending'; |
  |  | 144 | $changes         = $sync\_response = []; |
  |  | 145 | foreach ( $encrypted\_contents as $v ) { |
  |  | 146 |  |
  |  | 147 | $source\_id = ( isset( $v->source\_id ) && ! empty( $v->source\_id ) ) ? intval( $v->source\_id ) : null; |
  |  | 148 |  |
  |  | 149 | /\* |
  |  | 150 | \*Post Operations |
  |  | 151 | \*/ |
  |  | 152 | //create and update |
  |  | 153 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'post\_change' || $v->event\_slug == 'post\_new' ) ) { |
  |  | 154 | $posts          = isset( $v->details->posts ) ? (array) $v->details->posts : ''; |
  |  | 155 | $postmeta       = isset( $v->details->postmeta ) ? (array) $v->details->postmeta : ''; |
  |  | 156 | $featured\_image = isset( $v->details->featured\_image ) ? (array) $v->details->featured\_image : ''; |
  |  | 157 | $media          = isset( $v->details->media ) ? (array) $v->details->media : ''; |
  |  | 158 |  |
  |  | 159 | $parent\_post = isset( $v->details->parent->post ) ? (array) $v->details->parent->post : []; |
  |  | 160 |  |
  |  | 161 | #check for the post parent |
  |  | 162 | if ( ! empty( $parent\_post ) ) { |
  |  | 163 | $parent\_post\_meta = isset( $v->details->parent->post\_meta ) ? (array) $v->details->parent->post\_meta : []; |
  |  | 164 | $reference\_id     = isset( $parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0] ) ? $parent\_post\_meta['instawp\_event\_sync\_reference\_id'][0] : ''; |
  |  | 165 | $destination\_post = $this->get\_post\_by\_reference\_Id( $parent\_post['post\_type'], $reference\_id, $parent\_post['post\_name'] ); |
  |  | 166 | if ( ! empty( $destination\_post ) ) { |
  |  | 167 | $posts['post\_parent'] = $destination\_post->ID; |
  |  | 168 | } |
  |  | 169 | } |
  |  | 170 |  |
  |  | 171 | if ( $posts['post\_type'] == 'attachment' ) { |
  |  | 172 | //create or update the attachments |
  |  | 173 | $posts['ID'] = $this->handle\_attachments( $posts, $postmeta, $posts['guid'] ); |
  |  | 174 | #update meta |
  |  | 175 | $this->add\_update\_postmeta( $postmeta, $posts['ID'] ); |
  |  | 176 | } else { |
  |  | 177 | $posts['ID'] = $this->create\_or\_update\_post( $posts, $postmeta ); |
  |  | 178 | } |
  |  | 179 |  |
  |  | 180 | #feature image import |
  |  | 181 | if ( isset( $featured\_image['media'] ) && ! empty( $featured\_image['media'] ) ) { |
  |  | 182 | $att\_id = $this->handle\_attachments( (array) $featured\_image['media'], (array) $featured\_image['media\_meta'], $featured\_image['featured\_image\_url'] ); |
  |  | 183 | if ( isset( $att\_id ) && ! empty( $att\_id ) ) { |
  |  | 184 | set\_post\_thumbnail( $posts['ID'], $att\_id ); |
  |  | 185 | } |
  |  | 186 | } |
  |  | 187 |  |
  |  | 188 | #if post type is product then set gallery |
  |  | 189 | if ( get\_post\_type( $posts['ID'] ) == 'product' ) { |
  |  | 190 | if ( isset( $v->details->product\_gallery ) && ! empty( $v->details->product\_gallery ) ) { |
  |  | 191 | $product\_gallery = $v->details->product\_gallery; |
  |  | 192 | $gallery\_ids     = []; |
  |  | 193 | //pr($product\_gallery); |
  |  | 194 | foreach ( $product\_gallery as $gallery ) { |
  |  | 195 | if ( isset( $gallery->media ) && ! empty( $gallery->media ) && isset( $gallery->url ) && $gallery->url != '' ) { |
  |  | 196 | $gallery\_ids[] = $this->handle\_attachments( (array) $gallery->media, (array) $gallery->media\_meta, $gallery->url ); |
  |  | 197 | } |
  |  | 198 | } |
  |  | 199 | $this->set\_product\_gallery( $posts['ID'], $gallery\_ids ); |
  |  | 200 | } |
  |  | 201 | } |
  |  | 202 |  |
  |  | 203 | #terms in post |
  |  | 204 | $taxonomies = (array) $v->details->taxonomies; |
  |  | 205 | $this->reset\_post\_terms( $posts['ID'] ); //rest the terms for all taxo |
  |  | 206 | if ( ! empty( $taxonomies ) && is\_array( $taxonomies ) ) { |
  |  | 207 | foreach ( $taxonomies as $taxonomy => $terms ) { |
  |  | 208 | $terms    = (array) $terms; |
  |  | 209 | $term\_ids = []; |
  |  | 210 | # if term not exist then create first |
  |  | 211 | if ( ! empty( $terms ) && is\_array( $terms ) ) { |
  |  | 212 | foreach ( $terms as $term ) { |
  |  | 213 | $term = (array) $term; |
  |  | 214 | if ( ! term\_exists( $term['slug'], $taxonomy ) ) { |
  |  | 215 | $inserted\_term = wp\_insert\_term( |
  |  | 216 | $term['name'],   // the term |
  |  | 217 | $taxonomy, // the taxonomy |
  |  | 218 | array( |
  |  | 219 | 'description' => $term['description'], |
  |  | 220 | 'slug'        => $term['slug'], |
  |  | 221 | 'parent'      => 0 |
  |  | 222 | ) |
  |  | 223 | ); |
  |  | 224 | $term\_ids[]    = $inserted\_term['term\_id']; |
  |  | 225 | } else { |
  |  | 226 | $get\_term\_by = (array) get\_term\_by( 'slug', $term['slug'], $taxonomy ); |
  |  | 227 | $term\_ids[]  = $get\_term\_by['term\_id']; |
  |  | 228 | } |
  |  | 229 | } |
  |  | 230 | } |
  |  | 231 | #set terms in post |
  |  | 232 | wp\_set\_post\_terms( $posts['ID'], $term\_ids, $taxonomy ); |
  |  | 233 | } |
  |  | 234 | } |
  |  | 235 |  |
  |  | 236 | # media upload from content |
  |  | 237 | $this->upload\_content\_media( $media, $posts['ID'] ); |
  |  | 238 |  |
  |  | 239 | #message |
  |  | 240 | $message         = 'Sync successfully.'; |
  |  | 241 | $status          = 'completed'; |
  |  | 242 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 243 | #changes |
  |  | 244 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 245 | } |
  |  | 246 |  |
  |  | 247 | //Post trash |
  |  | 248 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'post\_trash' ) { |
  |  | 249 | if ( isset( $source\_id ) ) { |
  |  | 250 | $posts                = (array) $v->details->posts; |
  |  | 251 | $postmeta             = (array) $v->details->postmeta; |
  |  | 252 | $post\_by\_reference\_id = get\_posts( array( |
  |  | 253 | 'post\_type'  => $posts['post\_type'], |
  |  | 254 | 'meta\_key'   => 'instawp\_event\_sync\_reference\_id', |
  |  | 255 | 'meta\_value' => isset( $postmeta['instawp\_event\_sync\_reference\_id'][0] ) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  |  | 256 | ) ); |
  |  | 257 |  |
  |  | 258 | if ( ! empty( $post\_by\_reference\_id ) ) { |
  |  | 259 | $post\_id = $post\_by\_reference\_id[0]->ID; |
  |  | 260 | $rel     = wp\_trash\_post( $post\_id );  //Post data on success, false or null on failure. |
  |  | 261 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 262 | $message = $this->sync\_message( $rel ); |
  |  | 263 | } else { |
  |  | 264 | $post\_check\_data = instawp\_get\_post\_by\_name( str\_replace( '\_\_trashed', '', $posts['post\_name'] ), $posts['post\_type'] ); |
  |  | 265 | if ( ! empty( $post\_check\_data ) ) { |
  |  | 266 | $rel     = wp\_trash\_post( $post\_check\_data->ID );  //Post data on success, false or null on failure. |
  |  | 267 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 268 | $message = $this->sync\_message( $rel ); |
  |  | 269 | } else { |
  |  | 270 | $status  = 'pending'; |
  |  | 271 | $message = $this->notExistMsg(); |
  |  | 272 | } |
  |  | 273 | } |
  |  | 274 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 275 | #changes |
  |  | 276 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 277 | } |
  |  | 278 | } |
  |  | 279 |  |
  |  | 280 | //Post permanently delete |
  |  | 281 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'post\_delete' ) { |
  |  | 282 | if ( isset( $source\_id ) ) { |
  |  | 283 | $posts                = (array) $v->details->posts; |
  |  | 284 | $postmeta             = (array) $v->details->postmeta; |
  |  | 285 | $post\_by\_reference\_id = get\_posts( [ |
  |  | 286 | 'post\_status' => 'trash', |
  |  | 287 | 'post\_type'   => $posts['post\_type'], |
  |  | 288 | 'nopaging'    => true, |
  |  | 289 | 'meta\_query'  => array( |
  |  | 290 | array( |
  |  | 291 | 'key'     => 'instawp\_event\_sync\_reference\_id', |
  |  | 292 | 'value'   => isset( $postmeta['instawp\_event\_sync\_reference\_id'][0] ) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  |  | 293 | 'compare' => '=', |
  |  | 294 | ), |
  |  | 295 | ), |
  |  | 296 | ] ); |
  |  | 297 |  |
  |  | 298 | if ( ! empty( $post\_by\_reference\_id ) ) { |
  |  | 299 | $post\_id = $post\_by\_reference\_id[0]->ID; |
  |  | 300 | $rel     = wp\_delete\_post( $post\_id );  //Post data on success, false or null on failure. |
  |  | 301 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 302 | $message = $this->sync\_message( $rel ); |
  |  | 303 | } else { |
  |  | 304 | $post\_check\_data = instawp\_get\_post\_by\_name( $posts['post\_name'], $posts['post\_type'] ); |
  |  | 305 | if ( ! empty( $post\_check\_data ) ) { |
  |  | 306 | $rel     = wp\_delete\_post( $post\_check\_data->ID );  //Post data on success, false or null on failure. |
  |  | 307 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 308 | $message = $this->sync\_message( $rel ); |
  |  | 309 | } else { |
  |  | 310 | $status  = 'pending'; |
  |  | 311 | $message = $this->notExistMsg(); |
  |  | 312 | } |
  |  | 313 | } |
  |  | 314 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 315 | #changes |
  |  | 316 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 317 | } |
  |  | 318 | } |
  |  | 319 |  |
  |  | 320 | //Post restored |
  |  | 321 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'untrashed\_post' ) { |
  |  | 322 | if ( isset( $source\_id ) ) { |
  |  | 323 | $posts                = (array) $v->details->posts; |
  |  | 324 | $postmeta             = (array) $v->details->postmeta; |
  |  | 325 | $post\_by\_reference\_id = get\_posts( [ |
  |  | 326 | 'post\_status' => 'trash', |
  |  | 327 | 'post\_type'   => $posts['post\_type'], |
  |  | 328 | 'nopaging'    => true, |
  |  | 329 | 'meta\_query'  => array( |
  |  | 330 | array( |
  |  | 331 | 'key'     => 'instawp\_event\_sync\_reference\_id', |
  |  | 332 | 'value'   => isset( $postmeta['instawp\_event\_sync\_reference\_id'][0] ) ? $postmeta['instawp\_event\_sync\_reference\_id'][0] : '', |
  |  | 333 | 'compare' => '=', |
  |  | 334 | ), |
  |  | 335 | ), |
  |  | 336 | ] ); |
  |  | 337 |  |
  |  | 338 |  |
  |  | 339 | if ( ! empty( $post\_by\_reference\_id ) ) { |
  |  | 340 | $post\_id = $post\_by\_reference\_id[0]->ID; |
  |  | 341 | $rel     = wp\_untrash\_post( $post\_id ); |
  |  | 342 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 343 | $message = $this->sync\_message( $rel ); |
  |  | 344 | } else { |
  |  | 345 | $post\_check\_data = instawp\_get\_post\_by\_name( $posts['post\_name'] . '\_\_trashed', $posts['post\_type'] ); |
  |  | 346 | if ( ! empty( $post\_check\_data ) ) { |
  |  | 347 | $rel     = wp\_untrash\_post( $post\_check\_data->ID ); |
  |  | 348 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 349 | $message = $this->sync\_message( $rel ); |
  |  | 350 | } else { |
  |  | 351 | $status  = 'pending'; |
  |  | 352 | $message = $this->notExistMsg(); |
  |  | 353 | } |
  |  | 354 | } |
  |  | 355 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 356 | #changes |
  |  | 357 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 358 | } |
  |  | 359 | } |
  |  | 360 |  |
  |  | 361 | /\* |
  |  | 362 | \*Plugin Oprations |
  |  | 363 | \*/ |
  |  | 364 | //Plugin actiavte |
  |  | 365 | if ( isset( $v->details ) && $v->event\_slug == 'activate\_plugin' ) { |
  |  | 366 | $check\_plugin\_installed = $this->check\_plugin\_installed( $v->details ); |
  |  | 367 | if ( $check\_plugin\_installed != 1 ) { |
  |  | 368 | $pluginData = get\_plugin\_data( $v->details ); |
  |  | 369 | if ( ! empty( $pluginData['TextDomain'] ) ) { |
  |  | 370 | $this->plugin\_install( $pluginData['TextDomain'] ); |
  |  | 371 | } |
  |  | 372 | } |
  |  | 373 |  |
  |  | 374 | $this->plugin\_activation( $v->details ); |
  |  | 375 | #message |
  |  | 376 | $message         = 'Sync successfully.'; |
  |  | 377 | $status          = 'completed'; |
  |  | 378 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 379 | #changes |
  |  | 380 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 381 | } |
  |  | 382 |  |
  |  | 383 | //Plugin deactiavte |
  |  | 384 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'deactivate\_plugin' ) { |
  |  | 385 | $this->plugin\_deactivation( $v->details ); |
  |  | 386 | #message |
  |  | 387 | $message         = 'Sync successfully.'; |
  |  | 388 | $status          = 'completed'; |
  |  | 389 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 390 | #changes |
  |  | 391 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 392 | } |
  |  | 393 |  |
  |  | 394 | /\* |
  |  | 395 | \* Taxonomy Oprations |
  |  | 396 | \*/ |
  |  | 397 |  |
  |  | 398 | //create and update |
  |  | 399 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'create\_taxonomy' || $v->event\_slug == 'edit\_taxonomy' ) ) { |
  |  | 400 | if ( isset( $source\_id ) ) { |
  |  | 401 | $details          = (array) $v->details; |
  |  | 402 | $wp\_terms         = $this->wp\_terms\_data( $source\_id, $details ); |
  |  | 403 | $wp\_term\_taxonomy = $this->wp\_term\_taxonomy\_data( $source\_id, $details ); |
  |  | 404 | if ( ! term\_exists( $source\_id, $v->event\_type ) ) { |
  |  | 405 | if ( $v->event\_slug == 'create\_taxonomy' ) { |
  |  | 406 | $this->insert\_taxonomy( $source\_id, $wp\_terms, $wp\_term\_taxonomy ); |
  |  | 407 | clean\_term\_cache( $source\_id ); |
  |  | 408 | } |
  |  | 409 | } |
  |  | 410 | if ( term\_exists( $source\_id, $v->event\_type ) ) { |
  |  | 411 | if ( $v->event\_slug == 'edit\_taxonomy' ) { |
  |  | 412 | $this->update\_taxonomy( $source\_id, $wp\_terms, $wp\_term\_taxonomy ); |
  |  | 413 | } |
  |  | 414 | } |
  |  | 415 |  |
  |  | 416 | #message |
  |  | 417 | $message         = 'Sync successfully.'; |
  |  | 418 | $status          = 'completed'; |
  |  | 419 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 420 | #changes |
  |  | 421 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 422 |  |
  |  | 423 | } |
  |  | 424 | } |
  |  | 425 |  |
  |  | 426 | //Delete |
  |  | 427 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'delete\_taxonomy' ) { |
  |  | 428 | if ( isset( $source\_id ) ) { |
  |  | 429 | if ( term\_exists( $source\_id, $v->event\_type ) ) { |
  |  | 430 | $rel     = wp\_delete\_term( $source\_id, $v->event\_type ); |
  |  | 431 | $status  = $this->sync\_post\_status( $rel ); |
  |  | 432 | $message = $this->sync\_message( $rel ); |
  |  | 433 | } |
  |  | 434 | } else { |
  |  | 435 | $status  = 'pending'; |
  |  | 436 | $message = $this->notExistMsg(); |
  |  | 437 | } |
  |  | 438 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 439 | #changes |
  |  | 440 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 441 | } |
  |  | 442 |  |
  |  | 443 | /\*\* |
  |  | 444 | \* Customizer settings update |
  |  | 445 | \*/ |
  |  | 446 |  |
  |  | 447 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'customizer\_changes' ) { |
  |  | 448 | $details = isset( $v->details ) ? $v->details : ''; |
  |  | 449 |  |
  |  | 450 | #custom logo |
  |  | 451 | $this->customizer\_custom\_logo( $details->custom\_logo ); |
  |  | 452 |  |
  |  | 453 | #background image |
  |  | 454 | $this->customizer\_background\_image( $details->background\_image ); |
  |  | 455 |  |
  |  | 456 | #site icon |
  |  | 457 | $this->customizer\_site\_icon( $details->site\_icon ); |
  |  | 458 |  |
  |  | 459 | #background color |
  |  | 460 | if ( isset( $details->background\_color ) && ! empty( $details->background\_color ) ) { |
  |  | 461 | set\_theme\_mod( 'background\_color', $details->background\_color ); |
  |  | 462 | } |
  |  | 463 |  |
  |  | 464 | #Site Title |
  |  | 465 | update\_option( 'blogname', $details->name ); |
  |  | 466 |  |
  |  | 467 | #Tagline |
  |  | 468 | $this->blogDescription( $details->description ); |
  |  | 469 |  |
  |  | 470 | #Homepage Settings |
  |  | 471 | if ( isset( $details->show\_on\_front ) && ! empty( $details->show\_on\_front ) ) { |
  |  | 472 | update\_option( 'show\_on\_front', $details->show\_on\_front ); |
  |  | 473 | } |
  |  | 474 |  |
  |  | 475 | #for 'Astra' theme |
  |  | 476 | if ( isset( $details->astra\_settings ) && ! empty( $details->astra\_settings ) ) { |
  |  | 477 | $astra\_settings = $this->object\_to\_array( $details->astra\_settings ); |
  |  | 478 | update\_option( 'astra-settings', $astra\_settings ); |
  |  | 479 | } |
  |  | 480 |  |
  |  | 481 | #nav menu locations |
  |  | 482 | if ( ! empty( $details->nav\_menu\_locations ) ) { |
  |  | 483 | $menu\_array = (array) $details->nav\_menu\_locations; |
  |  | 484 | set\_theme\_mod( 'nav\_menu\_locations', $menu\_array ); |
  |  | 485 | } |
  |  | 486 |  |
  |  | 487 | #Custom css post id |
  |  | 488 | $custom\_css\_post = (array) $details->custom\_css\_post; |
  |  | 489 | if ( ! empty( $details->custom\_css\_post ) ) { |
  |  | 490 | if ( get\_post\_status( $custom\_css\_post['ID'] ) ) { |
  |  | 491 | #The post exists,Then update |
  |  | 492 | $postData = $this->postData( $custom\_css\_post, 'update' ); |
  |  | 493 | wp\_update\_post( $postData ); |
  |  | 494 |  |
  |  | 495 | } else { |
  |  | 496 | $postData = $this->postData( $custom\_css\_post, 'insert' ); |
  |  | 497 | #The post does not exist,Then insert |
  |  | 498 | wp\_insert\_post( $postData ); |
  |  | 499 | } |
  |  | 500 | set\_theme\_mod( 'custom\_css\_post\_id', $custom\_css\_post['ID'] ); |
  |  | 501 | } |
  |  | 502 | $current\_theme = wp\_get\_theme(); |
  |  | 503 | if ( $current\_theme->Name == 'Astra' ) { #for 'Astra' theme |
  |  | 504 | $astra\_theme\_setting = isset( $details->astra\_theme\_customizer\_settings ) ? (array) $details->astra\_theme\_customizer\_settings : ''; |
  |  | 505 | $this->setAstraCostmizerSetings( $astra\_theme\_setting ); |
  |  | 506 | } else if ( $current\_theme->Name == 'Divi' ) {  #for 'Divi' theme |
  |  | 507 | $divi\_settings = isset( $details->divi\_settings ) ? (array) $details->divi\_settings : ''; |
  |  | 508 | if ( ! empty( $divi\_settings ) && is\_array( $divi\_settings ) ) { |
  |  | 509 | update\_option( 'et\_divi', $divi\_settings ); |
  |  | 510 | } |
  |  | 511 | } |
  |  | 512 |  |
  |  | 513 | #message |
  |  | 514 | $message         = 'Sync successfully.'; |
  |  | 515 | $status          = 'completed'; |
  |  | 516 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 517 | #changes |
  |  | 518 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 519 | } |
  |  | 520 |  |
  |  | 521 | /\*\* |
  |  | 522 | \* Woocommerce attributes |
  |  | 523 | \*/ |
  |  | 524 |  |
  |  | 525 | #create&upadte woocommerce attribute |
  |  | 526 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'woocommerce\_attribute\_added' || $v->event\_slug == 'woocommerce\_attribute\_updated' ) ) { |
  |  | 527 | $details = isset( $v->details ) ? (array) $v->details : ''; |
  |  | 528 | if ( ! empty( $details ) ) { |
  |  | 529 | $attribute = wc\_get\_attribute( 208 ); |
  |  | 530 | if ( ! empty( $attribute ) ) { |
  |  | 531 | unset( $details['id'] ); |
  |  | 532 | wc\_update\_attribute( $v->source\_id, $attribute ); |
  |  | 533 |  |
  |  | 534 | #message |
  |  | 535 | $message         = 'Sync successfully.'; |
  |  | 536 | $status          = 'completed'; |
  |  | 537 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 538 | #changes |
  |  | 539 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 540 | } else { |
  |  | 541 | $this->woocommerce\_create\_attribute( $v->source\_id, $details ); |
  |  | 542 |  |
  |  | 543 | #message |
  |  | 544 | $message         = 'Sync successfully.'; |
  |  | 545 | $status          = 'completed'; |
  |  | 546 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 547 | #changes |
  |  | 548 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 549 |  |
  |  | 550 | } |
  |  | 551 | } |
  |  | 552 | } |
  |  | 553 |  |
  |  | 554 | if ( isset( $v->event\_slug ) && $v->event\_slug == 'woocommerce\_attribute\_deleted' ) { |
  |  | 555 | wc\_delete\_attribute( $v->source\_id ); |
  |  | 556 | #message |
  |  | 557 | $message         = 'Sync successfully.'; |
  |  | 558 | $status          = 'completed'; |
  |  | 559 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 560 | #changes |
  |  | 561 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 562 | } |
  |  | 563 |  |
  |  | 564 | /\*\* |
  |  | 565 | \* Users actions |
  |  | 566 | \*/ |
  |  | 567 | if ( isset( $v->event\_type ) && $v->event\_type == 'users' ) { |
  |  | 568 | $user\_data = isset( $v->details->user\_data ) ? (array) $v->details->user\_data : ''; |
  |  | 569 | $user\_meta = isset( $v->details->user\_meta ) ? (array) $v->details->user\_meta : ''; |
  |  | 570 | //$user = get\_userdata($v->source\_id); |
  |  | 571 | $user\_table = $this->wpdb->prefix . 'users'; |
  |  | 572 |  |
  |  | 573 | $get\_user\_by\_reference\_id = get\_users( array( |
  |  | 574 | 'meta\_key'   => 'instawp\_event\_user\_sync\_reference\_id', |
  |  | 575 | 'meta\_value' => isset( $user\_meta['instawp\_event\_sync\_reference\_id'][0] ) ? $user\_meta['instawp\_event\_sync\_reference\_id'][0] : '', |
  |  | 576 | ) ); |
  |  | 577 |  |
  |  | 578 | $user = ! empty( $get\_user\_by\_reference\_id ) ? $get\_user\_by\_reference\_id[0] : get\_user\_by( 'email', $user\_data['email'] ); |
  |  | 579 |  |
  |  | 580 | //Create user if not exits |
  |  | 581 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'user\_register' ) ) { |
  |  | 582 | if ( ! $user ) { |
  |  | 583 | unset( $user\_data['ID'] ); |
  |  | 584 | array\_merge( $user\_data, [ 'role' => $v->details->role ] ); |
  |  | 585 | $user = wp\_insert\_user( $user\_data ); |
  |  | 586 | $this->add\_update\_usermeta( $user\_meta, $v->source\_id ); |
  |  | 587 | } |
  |  | 588 | } |
  |  | 589 |  |
  |  | 590 | //Update user |
  |  | 591 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'profile\_update' ) ) { |
  |  | 592 | $this->InstaWP\_db->update( $user\_table, $user\_data, array( 'ID' => $v->source\_id ) ); |
  |  | 593 | $this->add\_update\_usermeta( $user\_meta, $v->source\_id ); |
  |  | 594 | $user->add\_role( $v->details->role ); |
  |  | 595 | } |
  |  | 596 |  |
  |  | 597 | //Delete user |
  |  | 598 | if ( isset( $v->event\_slug ) && ( $v->event\_slug == 'delete\_user' ) ) { |
  |  | 599 | if ( isset( $user->data->user\_email ) ) { |
  |  | 600 | if ( $user->data->user\_email == $user\_data['data']->user\_email ) { |
  |  | 601 | wp\_delete\_user( $v->source\_id ); |
  |  | 602 | } |
  |  | 603 | } |
  |  | 604 | } |
  |  | 605 |  |
  |  | 606 | #message |
  |  | 607 | $message         = 'Sync successfully.'; |
  |  | 608 | $status          = 'completed'; |
  |  | 609 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 610 | #changes |
  |  | 611 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 612 | } |
  |  | 613 |  |
  |  | 614 | /\* |
  |  | 615 | \* widget |
  |  | 616 | \*/ |
  |  | 617 | if ( isset( $v->event\_type ) && $v->event\_type == 'widget' ) { |
  |  | 618 | $widget\_block = (array) $v->details->widget\_block; |
  |  | 619 | $appp         = (array) $v->details; |
  |  | 620 | $dataIns      = [ |
  |  | 621 | 'data' => json\_encode( $appp ) |
  |  | 622 | ]; |
  |  | 623 | $this->InstaWP\_db->insert( 'wp\_testing', $dataIns ); |
  |  | 624 |  |
  |  | 625 | $widget\_block\_arr = []; |
  |  | 626 | foreach ( $widget\_block as $widget\_key => $widget\_val ) { |
  |  | 627 | if ( $widget\_key == '\_multiwidget' ) { |
  |  | 628 | $widget\_block\_arr[ $widget\_key ] = $widget\_val; |
  |  | 629 | } else { |
  |  | 630 | $widget\_val\_arr                  = (array) $widget\_val; |
  |  | 631 | $widget\_block\_arr[ $widget\_key ] = [ 'content' => $widget\_val\_arr['content'] ]; |
  |  | 632 | } |
  |  | 633 | } |
  |  | 634 | update\_option( 'widget\_block', $widget\_block\_arr ); |
  |  | 635 | #message |
  |  | 636 | $message         = 'Sync successfully.'; |
  |  | 637 | $status          = 'completed'; |
  |  | 638 | $sync\_response[] = $this->sync\_opration\_response( $status, $message, $v ); |
  |  | 639 | #changes |
  |  | 640 | $changes[ $v->event\_type ] = $changes[ $v->event\_type ] + 1; |
  |  | 641 | } |
  |  | 642 | /\* |
  |  | 643 | \* Update api for cloud |
  |  | 644 | \*/ |
  |  | 645 | $progress        = intval( $count / $total\_op \* 100 ); |
  |  | 646 | $progress\_status = ( $progress > 100 ) ? 'in\_progress' : 'completed'; |
  |  | 647 | #Sync update |
  |  | 648 | $syncUpdate = [ |
  |  | 649 | 'progress' => $progress, |
  |  | 650 | 'status'   => $progress\_status, |
  |  | 651 | 'message'  => $message, |
  |  | 652 | 'changes'  => [ 'changes' => $changes, 'sync\_response' => $sync\_response ], |
  |  | 653 | ]; |
  |  | 654 | $this->sync\_update( $sync\_id, $syncUpdate, $source\_connect\_id ); |
  |  | 655 | $count ++; |
  |  | 656 | } |
  |  | 657 | } |
  |  | 658 |  |
  |  | 659 | #Sync history save |
  |  | 660 | $this->sync\_history\_save( $body, $changes, 'Complete' ); |
  |  | 661 |  |
  |  | 662 | #enable is back if syncing already enabled at the destination |
  |  | 663 | if ( $is\_enabled ) { |
  |  | 664 | update\_option( 'syncing\_enabled\_disabled', 1 ); |
  |  | 665 | } |
  |  | 666 |  |
  |  | 667 | return new WP\_REST\_Response( |
  |  | 668 | array( |
  |  | 669 | 'encrypted\_contents' => $encrypted\_contents, |
  |  | 670 | 'source\_connect\_id'  => $source\_connect\_id, |
  |  | 671 | 'changes'            => [ 'changes' => $changes, 'sync\_response' => $sync\_response ], |
  |  | 672 | 'sync\_id'            => $sync\_id |
  |  | 673 | ) |
  |  | 674 | ); |
  |  | 675 | } |
  |  | 676 |  |
  |  | 677 | /\*\* |
  |  | 678 | \* This function is for upload media which are coming form widgets. |
  |  | 679 | \*/ |
  |  | 680 | public function upload\_widgets\_media( $media = null, $content = null ) { |
  |  | 681 | $media      = json\_decode( reset( $media ) ); |
  |  | 682 | $new        = $old = []; |
  |  | 683 | $newContent = ''; |
  |  | 684 | if ( ! empty( $media ) ) { |
  |  | 685 | foreach ( $media as $v ) { |
  |  | 686 | $v = (array) $v; |
  |  | 687 | if ( isset( $v['attachment\_id'] ) && isset( $v['attachment\_url'] ) ) { |
  |  | 688 | $attachment\_id = $this->insert\_attachment( $v['attachment\_id'], $v['attachment\_url'] ); |
  |  | 689 | $new[]         = wp\_get\_attachment\_url( $attachment\_id ); |
  |  | 690 | $old[]         = $v['attachment\_url']; |
  |  | 691 | } |
  |  | 692 | } |
  |  | 693 | $newContent = str\_replace( $old, $new, $content ); #str\_replace(old,new,str) |
  |  | 694 | } |
  |  | 695 |  |
  |  | 696 | return $newContent; |
  |  | 697 | } |
  |  | 698 |  |
  |  | 699 | public function user\_id\_exists( $user\_id ) { |
  |  | 700 | $table\_name = $this->wpdb->prefix . 'users'; |
  |  | 701 | $count      = $this->wpdb->get\_var( $this->wpdb->prepare( "SELECT COUNT(\*) FROM $table\_name WHERE ID = %d", $user\_id ) ); |
  |  | 702 | if ( $count == 1 ) { |
  |  | 703 | return true; |
  |  | 704 | } else { |
  |  | 705 | return false; |
  |  | 706 | } |
  |  | 707 | } |
  |  | 708 |  |
  |  | 709 | public function blogDescription( $v = null ) { |
  |  | 710 | $this->wpdb->update( $this->wpdb->prefix . 'options', [ 'option\_value' => $v ], array( 'option\_name' => 'blogdescription' ) ); |
  |  | 711 | } |
  |  | 712 |  |
  |  | 713 | /\*\* |
  |  | 714 | \* object to array conversation |
  |  | 715 | \*/ |
  |  | 716 | public function object\_to\_array( $data ) { |
  |  | 717 | if ( ( ! is\_array( $data ) ) and ( ! is\_object( $data ) ) ) { |
  |  | 718 | return; |
  |  | 719 | } |
  |  | 720 | $result = array(); |
  |  | 721 | $data   = (array) $data; |
  |  | 722 | foreach ( $data as $key => $value ) { |
  |  | 723 | if ( is\_object( $value ) ) { |
  |  | 724 | $value = (array) $value; |
  |  | 725 | } |
  |  | 726 | if ( is\_array( $value ) ) { |
  |  | 727 | $result[ $key ] = $this->object\_to\_array( $value ); |
  |  | 728 | } else { |
  |  | 729 | $result[ $key ] = $value; |
  |  | 730 | } |
  |  | 731 | } |
  |  | 732 |  |
  |  | 733 | return $result; |
  |  | 734 | } |
  |  | 735 |  |
  |  | 736 | /\*\* |
  |  | 737 | \* Create woocommerce attribute |
  |  | 738 | \*/ |
  |  | 739 | public function woocommerce\_create\_attribute( $source\_id, $data = null ) { |
  |  | 740 | $format               = array( '%s', '%s', '%s', '%s', '%d' ); |
  |  | 741 | $data['attribute\_id'] = intval( $source\_id ); |
  |  | 742 | $results              = $this->wpdb->insert( |
  |  | 743 | $this->wpdb->prefix . 'woocommerce\_attribute\_taxonomies', |
  |  | 744 | $data, |
  |  | 745 | $format |
  |  | 746 | ); |
  |  | 747 |  |
  |  | 748 | if ( is\_wp\_error( $results ) ) { |
  |  | 749 | return new WP\_Error( 'cannot\_create\_attribute', 'Can not create attribute!', array( 'status' => 400 ) ); |
  |  | 750 | } |
  |  | 751 | $id = $this->wpdb->insert\_id; |
  |  | 752 | /\*\* |
  |  | 753 | \* Attribute added. |
  |  | 754 | \* |
  |  | 755 | \* @param int $id Added attribute ID. |
  |  | 756 | \* @param array $data Attribute data. |
  |  | 757 | \*/ |
  |  | 758 | do\_action( 'woocommerce\_attribute\_added', $id, $data ); |
  |  | 759 | // Clear cache and flush rewrite rules. |
  |  | 760 | wp\_schedule\_single\_event( time(), 'woocommerce\_flush\_rewrite\_rules' ); |
  |  | 761 | delete\_transient( 'wc\_attribute\_taxonomies' ); |
  |  | 762 | WC\_Cache\_Helper::invalidate\_cache\_group( 'woocommerce-attributes' ); |
  |  | 763 | } |
  |  | 764 |  |
  |  | 765 | /\*\* |
  |  | 766 | \* Set product gallery |
  |  | 767 | \*/ |
  |  | 768 | public function set\_product\_gallery( $product\_id = null, $gallery\_ids = null ) { |
  |  | 769 | $product = new WC\_product( $product\_id ); |
  |  | 770 | $product->set\_gallery\_image\_ids( $gallery\_ids ); |
  |  | 771 | $product->save(); |
  |  | 772 | } |
  |  | 773 |  |
  |  | 774 | public function customizer\_site\_icon( $data = null ) { |
  |  | 775 | $attachment\_id = $data->id; |
  |  | 776 | $url           = $data->url; |
  |  | 777 | if ( isset( $attachment\_id ) && ! empty( $attachment\_id ) ) { |
  |  | 778 | $attUrl = wp\_get\_attachment\_url( intval( $attachment\_id ) ); |
  |  | 779 | if ( ! empty( $attUrl ) ) { |
  |  | 780 | update\_option( 'site\_icon', $attachment\_id ); |
  |  | 781 | } else { |
  |  | 782 | $attachment\_id = $this->insert\_attachment( $attachment\_id, $url ); |
  |  | 783 | update\_option( 'site\_icon', $attachment\_id ); |
  |  | 784 | } |
  |  | 785 | } else { |
  |  | 786 | update\_option( 'site\_icon', $attachment\_id ); |
  |  | 787 | } |
  |  | 788 | } |
  |  | 789 |  |
  |  | 790 | public function customizer\_custom\_logo( $data ) { |
  |  | 791 | $attachment\_id = $data->id; |
  |  | 792 | $url           = $data->url; |
  |  | 793 | if ( isset( $attachment\_id ) && ! empty( $attachment\_id ) ) { |
  |  | 794 | $attUrl = wp\_get\_attachment\_url( intval( $attachment\_id ) ); |
  |  | 795 | if ( ! empty( $attUrl ) ) { |
  |  | 796 | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  |  | 797 | } else { |
  |  | 798 | $attachment\_id = $this->insert\_attachment( $attachment\_id, $url ); |
  |  | 799 | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  |  | 800 | } |
  |  | 801 | } else { |
  |  | 802 | set\_theme\_mod( 'custom\_logo', $attachment\_id ); |
  |  | 803 | } |
  |  | 804 | } |
  |  | 805 |  |
  |  | 806 | public function customizer\_background\_image( $data = null ) { |
  |  | 807 | $attachment\_id = $data->id; |
  |  | 808 | $url           = $data->url; |
  |  | 809 | if ( isset( $attachment\_id ) && ! empty( $attachment\_id ) ) { |
  |  | 810 | $attUrl = wp\_get\_attachment\_url( intval( $attachment\_id ) ); |
  |  | 811 | if ( ! empty( $attUrl ) ) { |
  |  | 812 | set\_theme\_mod( 'background\_image', $attUrl ); |
  |  | 813 | } else { |
  |  | 814 | $attachment\_id  = $this->insert\_attachment( $attachment\_id, $url ); |
  |  | 815 | $attachment\_url = wp\_get\_attachment\_url( intval( $attachment\_id ) ); |
  |  | 816 | set\_theme\_mod( 'background\_image', $attachment\_url ); |
  |  | 817 | } |
  |  | 818 | } else { |
  |  | 819 | set\_theme\_mod( 'background\_image', $url ); |
  |  | 820 | } |
  |  | 821 |  |
  |  | 822 | if ( isset( $data->background\_preset ) && ! empty( $data->background\_preset ) ) { |
  |  | 823 | set\_theme\_mod( 'background\_preset', $data->background\_preset ); |
  |  | 824 | } |
  |  | 825 |  |
  |  | 826 | if ( isset( $data->background\_size ) && ! empty( $data->background\_size ) ) { |
  |  | 827 | set\_theme\_mod( 'background\_size', $data->background\_size ); |
  |  | 828 | } |
  |  | 829 |  |
  |  | 830 | if ( isset( $data->background\_repeat ) && ! empty( $data->background\_repeat ) ) { |
  |  | 831 | set\_theme\_mod( 'background\_repeat', $data->background\_repeat ); |
  |  | 832 | } |
  |  | 833 |  |
  |  | 834 | if ( isset( $data->background\_attachment ) && ! empty( $data->background\_attachment ) ) { |
  |  | 835 | set\_theme\_mod( 'background\_attachment', $data->background\_attachment ); |
  |  | 836 | } |
  |  | 837 |  |
  |  | 838 | if ( isset( $data->background\_position\_x ) && ! empty( $data->background\_position\_x ) ) { |
  |  | 839 | set\_theme\_mod( 'background\_position\_x', $data->background\_position\_x ); |
  |  | 840 | } |
  |  | 841 |  |
  |  | 842 | if ( isset( $data->background\_position\_y ) && ! empty( $data->background\_position\_y ) ) { |
  |  | 843 | set\_theme\_mod( 'background\_position\_y', $data->background\_position\_y ); |
  |  | 844 | } |
  |  | 845 | } |
  |  | 846 |  |
  |  | 847 | /\*\* |
  |  | 848 | \* This function is for upload media which are coming form content. |
  |  | 849 | \*/ |
  |  | 850 | public function upload\_content\_media( $media = null, $post\_id = null ) { |
  |  | 851 | $media   = json\_decode( reset( $media ) ); |
  |  | 852 | $post    = get\_post( $post\_id ); |
  |  | 853 | $content = $post->post\_content; |
  |  | 854 | $new     = $old = []; |
  |  | 855 | if ( ! empty( $media ) ) { |
  |  | 856 | foreach ( $media as $v ) { |
  |  | 857 | $v = (array) $v; |
  |  | 858 | if ( isset( $v['attachment\_id'] ) && isset( $v['attachment\_url'] ) ) { |
  |  | 859 | $attachment\_id = $this->handle\_attachments( (array) $v['attachment\_media'], (array) $v['attachment\_media\_meta'], $v['attachment\_url'] ); |
  |  | 860 | $new[]         = wp\_get\_attachment\_url( $attachment\_id ); |
  |  | 861 | $old[]         = $v['attachment\_url']; |
  |  | 862 | } |
  |  | 863 | } |
  |  | 864 | $newContent = str\_replace( $old, $new, $content ); #str\_replace(old,new,str) |
  |  | 865 | $arg        = array( |
  |  | 866 | 'ID'           => $post\_id, |
  |  | 867 | 'post\_content' => $newContent, |
  |  | 868 | ); |
  |  | 869 | wp\_update\_post( $arg ); |
  |  | 870 | } |
  |  | 871 | } |
  |  | 872 |  |
  |  | 873 | public function notExistMsg() { |
  |  | 874 | return "ID is not exists."; |
  |  | 875 | } |
  |  | 876 |  |
  |  | 877 | public function wp\_terms\_data( $term\_id = null, $arr = [] ) { |
  |  | 878 | return [ |
  |  | 879 | 'term\_id' => $term\_id, |
  |  | 880 | 'name'    => $arr['name'], |
  |  | 881 | 'slug'    => $arr['slug'] |
  |  | 882 | ]; |
  |  | 883 | } |
  |  | 884 |  |
  |  | 885 | public function wp\_term\_taxonomy\_data( $term\_id = null, $arr = [] ) { |
  |  | 886 | return [ |
  |  | 887 | 'term\_taxonomy\_id' => $term\_id, |
  |  | 888 | 'term\_id'          => $term\_id, |
  |  | 889 | 'taxonomy'         => $arr['taxonomy'], |
  |  | 890 | 'description'      => $arr['description'], |
  |  | 891 | 'parent'           => $arr['parent'] |
  |  | 892 | ]; |
  |  | 893 | } |
  |  | 894 |  |
  |  | 895 | public function insert\_taxonomy( $term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null ) { |
  |  | 896 | $this->InstaWP\_db->insert( $this->wpdb->prefix . 'terms', $wp\_terms ); |
  |  | 897 | $this->InstaWP\_db->insert( $this->wpdb->prefix . 'term\_taxonomy', $wp\_term\_taxonomy ); |
  |  | 898 | } |
  |  | 899 |  |
  |  | 900 | public function update\_taxonomy( $term\_id = null, $wp\_terms = null, $wp\_term\_taxonomy = null ) { |
  |  | 901 | $this->wpdb->update( $this->wpdb->prefix . 'terms', $wp\_terms, array( 'term\_id' => $term\_id ) ); |
  |  | 902 | $this->wpdb->update( $this->wpdb->prefix . 'term\_taxonomy', $wp\_term\_taxonomy, array( 'term\_id' => $term\_id ) ); |
  |  | 903 | } |
  |  | 904 |  |
  |  | 905 | public function reset\_post\_terms( $post\_id ) { |
  |  | 906 | $this->wpdb->query( |
  |  | 907 | $this->wpdb->prepare( |
  |  | 908 | "DELETE FROM {$this->wpdb->prefix}term\_relationships WHERE object\_id = %d", |
  |  | 909 | $post\_id, |
  |  | 910 | ) |
  |  | 911 | ); |
  |  | 912 | } |
  |  | 913 |  |
  |  | 914 | public function add\_update\_postmeta( $meta\_data = null, $post\_id = null ) { |
  |  | 915 |  |
  |  | 916 | if ( ! empty( $meta\_data ) && is\_array( $meta\_data ) ) { |
  |  | 917 | foreach ( $meta\_data as $k => $v ) { |
  |  | 918 | if ( isset( $v[0] ) ) { |
  |  | 919 | $checkSerialize = @unserialize( $v[0] ); |
  |  | 920 | $metaVal        = ( $checkSerialize !== false || $v[0] === 'b:0;' ) ? unserialize( $v[0] ) : $v[0]; |
  |  | 921 | if ( metadata\_exists( 'post', $post\_id, $k ) ) { |
  |  | 922 | update\_post\_meta( $post\_id, $k, $metaVal ); |
  |  | 923 | } else { |
  |  | 924 | add\_post\_meta( $post\_id, $k, $metaVal ); |
  |  | 925 | } |
  |  | 926 | } |
  |  | 927 | } |
  |  | 928 |  |
  |  | 929 | //if \_elementor\_css this key not existing then it's giving a error. |
  |  | 930 | if ( array\_key\_exists( '\_elementor\_version', $meta\_data ) ) { |
  |  | 931 | if ( ! array\_key\_exists( '\_elementor\_css', $meta\_data ) ) { |
  |  | 932 | /\*$elementor\_css = [ |
  |  | 933 | 'time' => time(), |
  |  | 934 | 'fonts' => [], |
  |  | 935 | 'icons' => [], |
  |  | 936 | 'dynamic\_elements\_ids' => [], |
  |  | 937 | 'status' => 'empty', |
  |  | 938 | 'css' => '' |
  |  | 939 | ]; |
  |  | 940 | \*/ |
  |  | 941 | $elementor\_css = []; |
  |  | 942 | add\_post\_meta( $post\_id, '\_elementor\_css', $elementor\_css ); |
  |  | 943 | } |
  |  | 944 | } |
  |  | 945 |  |
  |  | 946 | //delete the edit lock post |
  |  | 947 | delete\_post\_meta( $post\_id, '\_edit\_lock' ); |
  |  | 948 | } |
  |  | 949 | } |
  |  | 950 |  |
  |  | 951 | public function postData( $posts = null, $op = null ) { |
  |  | 952 | $args = array( |
  |  | 953 | 'post\_author'           => $posts['post\_author'], |
  |  | 954 | 'post\_date'             => $posts['post\_date'], |
  |  | 955 | 'post\_date\_gmt'         => $posts['post\_date\_gmt'], |
  |  | 956 | 'post\_content'          => $posts['post\_content'], |
  |  | 957 | 'post\_title'            => $posts['post\_title'], |
  |  | 958 | 'post\_excerpt'          => $posts['post\_excerpt'], |
  |  | 959 | 'post\_status'           => $posts['post\_status'], |
  |  | 960 | 'comment\_status'        => $posts['comment\_status'], |
  |  | 961 | 'ping\_status'           => $posts['ping\_status'], |
  |  | 962 | 'post\_password'         => $posts['post\_password'], |
  |  | 963 | 'post\_name'             => $posts['post\_name'], |
  |  | 964 | 'to\_ping'               => $posts['to\_ping'], |
  |  | 965 | 'pinged'                => $posts['pinged'], |
  |  | 966 | 'post\_modified'         => $posts['post\_modified'], |
  |  | 967 | 'post\_modified\_gmt'     => $posts['post\_modified\_gmt'], |
  |  | 968 | 'post\_content\_filtered' => $posts['post\_content\_filtered'], |
  |  | 969 | 'post\_parent'           => $posts['post\_parent'], |
  |  | 970 | //'guid' => $posts['guid'], |
  |  | 971 | 'menu\_order'            => $posts['menu\_order'], |
  |  | 972 | 'post\_type'             => $posts['post\_type'], |
  |  | 973 | 'post\_mime\_type'        => $posts['post\_mime\_type'], |
  |  | 974 | 'comment\_count'         => $posts['comment\_count'], |
  |  | 975 | 'filter'                => $posts['filter'], |
  |  | 976 | ); |
  |  | 977 | #ID to update existing post |
  |  | 978 | if ( isset( $posts['ID'] ) && $posts['ID'] > 0 ) { |
  |  | 979 | $args = array\_merge( [ 'ID' => $posts['ID'] ], $args ); |
  |  | 980 | } |
  |  | 981 |  |
  |  | 982 | return $args; |
  |  | 983 | } |
  |  | 984 |  |
  |  | 985 | # import attechments form source to destination. |
  |  | 986 | public function handle\_attachments( $attachment\_post, $attachment\_post\_meta, $file ) { |
  |  | 987 | $reference\_id = ''; |
  |  | 988 | if ( isset( $attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0] ) ) { |
  |  | 989 | $reference\_id = $attachment\_post\_meta['instawp\_event\_sync\_reference\_id'][0]; |
  |  | 990 | } |
  |  | 991 | $attachment\_id = $this->get\_post\_by\_reference\_Id( $attachment\_post['post\_type'], $reference\_id, $attachment\_post['post\_name'] ); |
  |  | 992 | if ( ! $attachment\_id ) { |
  |  | 993 | $filename          = basename( $file ); |
  |  | 994 | $arrContextOptions = array( |
  |  | 995 | "ssl" => array( |
  |  | 996 | "verify\_peer"      => false, |
  |  | 997 | "verify\_peer\_name" => false, |
  |  | 998 | ), |
  |  | 999 | ); |
  |  | 1000 | $parent\_post\_id    = 0; |
  |  | 1001 | $upload\_file       = wp\_upload\_bits( $filename, null, file\_get\_contents( $file, false, stream\_context\_create( $arrContextOptions ) ) ); |
  |  | 1002 | if ( ! $upload\_file['error'] ) { |
  |  | 1003 | $wp\_filetype = wp\_check\_filetype( $filename, null ); |
  |  | 1004 | $attachment  = array( |
  |  | 1005 | 'post\_mime\_type' => $wp\_filetype['type'], |
  |  | 1006 | 'post\_parent'    => $parent\_post\_id, |
  |  | 1007 | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', $filename ), |
  |  | 1008 | 'post\_content'   => '', |
  |  | 1009 | 'post\_status'    => 'inherit' |
  |  | 1010 | ); |
  |  | 1011 | require\_once( ABSPATH . "wp-admin" . '/includes/image.php' ); |
  |  | 1012 | require\_once( ABSPATH . "wp-admin" . '/includes/file.php' ); |
  |  | 1013 | require\_once( ABSPATH . "wp-admin" . '/includes/media.php' ); |
  |  | 1014 | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
  |  | 1015 | if ( ! is\_wp\_error( $attachment\_id ) ) { |
  |  | 1016 | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
  |  | 1017 | wp\_update\_attachment\_metadata( $attachment\_id, $attachment\_data ); |
  |  | 1018 | $this->add\_update\_postmeta( [ 'instawp\_event\_sync\_reference\_id' => [ $reference\_id ] ], $attachment\_id ); |
  |  | 1019 | } |
  |  | 1020 |  |
  |  | 1021 | return $attachment\_id; |
  |  | 1022 | } |
  |  | 1023 |  |
  |  | 1024 | return; |
  |  | 1025 | } |
  |  | 1026 |  |
  |  | 1027 | return $attachment\_id; |
  |  | 1028 | } |
  |  | 1029 |  |
  |  | 1030 | # import attechments form source to destination. |
  |  | 1031 | public function insert\_attachment( $attachment\_id = null, $file = null ) { |
  |  | 1032 | $filename          = basename( $file ); |
  |  | 1033 | $arrContextOptions = array( |
  |  | 1034 | "ssl" => array( |
  |  | 1035 | "verify\_peer"      => false, |
  |  | 1036 | "verify\_peer\_name" => false, |
  |  | 1037 | ), |
  |  | 1038 | ); |
  |  | 1039 | $parent\_post\_id    = 0; |
  |  | 1040 | $upload\_file       = wp\_upload\_bits( $filename, null, file\_get\_contents( $file, false, stream\_context\_create( $arrContextOptions ) ) ); |
  |  | 1041 | if ( ! $upload\_file['error'] ) { |
  |  | 1042 | $wp\_filetype = wp\_check\_filetype( $filename, null ); |
  |  | 1043 | $attachment  = array( |
  |  | 1044 | 'import\_id'      => $attachment\_id, |
  |  | 1045 | 'post\_mime\_type' => $wp\_filetype['type'], |
  |  | 1046 | 'post\_parent'    => $parent\_post\_id, |
  |  | 1047 | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', $filename ), |
  |  | 1048 | 'post\_content'   => '', |
  |  | 1049 | 'post\_status'    => 'inherit' |
  |  | 1050 | ); |
  |  | 1051 | require\_once( ABSPATH . "wp-admin" . '/includes/image.php' ); |
  |  | 1052 | require\_once( ABSPATH . "wp-admin" . '/includes/file.php' ); |
  |  | 1053 | require\_once( ABSPATH . "wp-admin" . '/includes/media.php' ); |
  |  | 1054 | $attachment\_id = wp\_insert\_attachment( $attachment, $upload\_file['file'], $parent\_post\_id ); |
  |  | 1055 | if ( ! is\_wp\_error( $attachment\_id ) ) { |
  |  | 1056 | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $upload\_file['file'] ); |
  |  | 1057 | wp\_update\_attachment\_metadata( $attachment\_id, $attachment\_data ); |
  |  | 1058 | } |
  |  | 1059 | } |
  |  | 1060 |  |
  |  | 1061 | return $attachment\_id; |
  |  | 1062 | } |
  |  | 1063 |  |
  |  | 1064 | #Insert history |
  |  | 1065 | public function sync\_history\_save( $body = null, $changes = null, $status = null ) { |
  |  | 1066 | $dir     = 'dev-to-live'; |
  |  | 1067 | $date    = date( 'Y-m-d H:i:s' ); |
  |  | 1068 | $bodyArr = json\_decode( $body ); |
  |  | 1069 | $message = isset( $bodyArr->sync\_message ) ? $bodyArr->sync\_message : ''; |
  |  | 1070 | $data    = [ |
  |  | 1071 | 'encrypted\_contents' => $bodyArr->encrypted\_contents, |
  |  | 1072 | 'changes'            => json\_encode( $changes ), |
  |  | 1073 | 'sync\_response'      => '', |
  |  | 1074 | 'direction'          => $dir, |
  |  | 1075 | 'status'             => $status, |
  |  | 1076 | 'user\_id'            => isset( $bodyArr->upload\_wp\_user ) ? $bodyArr->upload\_wp\_user : '', |
  |  | 1077 | 'changes\_sync\_id'    => isset( $bodyArr->sync\_id ) ? $bodyArr->sync\_id : '', |
  |  | 1078 | 'sync\_message'       => $message, |
  |  | 1079 | 'source\_connect\_id'  => '', |
  |  | 1080 | 'source\_url'         => isset( $bodyArr->source\_url ) ? $bodyArr->source\_url : '', |
  |  | 1081 | 'date'               => $date, |
  |  | 1082 | ]; |
  |  | 1083 | $this->InstaWP\_db->insert( $this->tables['sh\_table'], $data ); |
  |  | 1084 | } |
  |  | 1085 |  |
  |  | 1086 | #Plugin activate. |
  |  | 1087 | public function plugin\_activation( $plugin ) { |
  |  | 1088 | if ( ! function\_exists( 'activate\_plugin' ) ) { |
  |  | 1089 | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  |  | 1090 | } |
  |  | 1091 |  |
  |  | 1092 | if ( ! is\_plugin\_active( $plugin ) ) { |
  |  | 1093 | activate\_plugin( $plugin ); |
  |  | 1094 | } |
  |  | 1095 | } |
  |  | 1096 |  |
  |  | 1097 | #Plugin deactivate. |
  |  | 1098 | public function plugin\_deactivation( $plugin ) { |
  |  | 1099 | if ( ! function\_exists( 'deactivate\_plugins' ) ) { |
  |  | 1100 | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
  |  | 1101 | } |
  |  | 1102 | if ( is\_plugin\_active( $plugin ) ) { |
  |  | 1103 | deactivate\_plugins( $plugin ); |
  |  | 1104 | } |
  |  | 1105 | } |
  |  | 1106 |  |
  |  | 1107 | public function sync\_message( $rel = null ) { |
  |  | 1108 | if ( isset( $rel->ID ) ) { |
  |  | 1109 | $message = 'Sync successfully.'; |
  |  | 1110 | } else { |
  |  | 1111 | $message = 'Something went wrong.'; |
  |  | 1112 | } |
  |  | 1113 |  |
  |  | 1114 | return $message; |
  |  | 1115 | } |
  |  | 1116 |  |
  |  | 1117 | public function sync\_post\_status( $rel = null ) { |
  |  | 1118 | $status = 'in\_progress'; |
  |  | 1119 | if ( isset( $rel->ID ) ) { |
  |  | 1120 | $status = 'completed'; |
  |  | 1121 | } else { |
  |  | 1122 | $status = 'pending'; |
  |  | 1123 | } |
  |  | 1124 |  |
  |  | 1125 | return $status; |
  |  | 1126 | } |
  |  | 1127 |  |
  |  | 1128 | public function sync\_opration\_response( $status = null, $message = null, $v = null ) { |
  |  | 1129 | return [ |
  |  | 1130 | 'id'      => $v->id, |
  |  | 1131 | 'status'  => $status, |
  |  | 1132 | 'message' => $message |
  |  | 1133 | ]; |
  |  | 1134 | } |
  |  | 1135 |  |
  |  | 1136 | public function sync\_update( $sync\_id = null, $data = null, $source\_connect\_id = null ) { |
  |  | 1137 | global $InstaWP\_Curl; |
  |  | 1138 | $api\_doamin = InstaWP\_Setting::get\_api\_domain(); |
  |  | 1139 | $connect\_id = intval( $source\_connect\_id ); |
  |  | 1140 | $endpoint   = '/api/v2/connects/' . $connect\_id . '/syncs/' . $sync\_id; |
  |  | 1141 | $url        = $api\_doamin . $endpoint; #https://stage.instawp.io/api/v2/connects/241/syncs/450 |
  |  | 1142 | $api\_key    = $this->get\_api\_key(); |
  |  | 1143 |  |
  |  | 1144 | try { |
  |  | 1145 | $curl = curl\_init(); |
  |  | 1146 | curl\_setopt\_array( $curl, array( |
  |  | 1147 | CURLOPT\_URL            => $url, |
  |  | 1148 | CURLOPT\_RETURNTRANSFER => true, |
  |  | 1149 | CURLOPT\_ENCODING       => '', |
  |  | 1150 | CURLOPT\_MAXREDIRS      => 10, |
  |  | 1151 | CURLOPT\_TIMEOUT        => 0, |
  |  | 1152 | CURLOPT\_FOLLOWLOCATION => true, |
  |  | 1153 | CURLOPT\_HTTP\_VERSION   => CURL\_HTTP\_VERSION\_1\_1, |
  |  | 1154 | CURLOPT\_CUSTOMREQUEST  => 'PATCH', |
  |  | 1155 | CURLOPT\_POSTFIELDS     => json\_encode( $data ), |
  |  | 1156 | CURLOPT\_HTTPHEADER     => array( |
  |  | 1157 | 'Authorization: Bearer ' . $api\_key . '', |
  |  | 1158 | 'Content-Type: application/json' |
  |  | 1159 | ), |
  |  | 1160 | ) ); |
  |  | 1161 |  |
  |  | 1162 | $response = curl\_exec( $curl ); |
  |  | 1163 |  |
  |  | 1164 | return $response; |
  |  | 1165 | } catch ( Exception $e ) { |
  |  | 1166 | return $e->getMessage(); |
  |  | 1167 | } |
  |  | 1168 | } |
  |  | 1169 |  |
  |  | 1170 | function get\_api\_key() { |
  |  | 1171 | $instawp\_api\_options = get\_option( 'instawp\_api\_options' ); |
  |  | 1172 |  |
  |  | 1173 | return $instawp\_api\_options['api\_key']; |
  |  | 1174 | } |
  |  | 1175 |  |
  |  | 1176 | /\* |
  |  | 1177 | \* Create elementor css file 'post-{post\_id}.css' |
  |  | 1178 | \*/ |
  |  | 1179 | public function create\_elementor\_css\_file( $data = null, $post\_id = null ) { |
  |  | 1180 | $upload\_dir = wp\_upload\_dir(); |
  |  | 1181 | $filename   = 'post-' . $post\_id . '.css'; |
  |  | 1182 | $filePath   = $upload\_dir['basedir'] . '/elementor/css/' . $filename; |
  |  | 1183 | $file       = fopen( $filePath, "w+" );//w+,w |
  |  | 1184 | fwrite( $file, $data ); |
  |  | 1185 | fclose( $file ); |
  |  | 1186 | } |
  |  | 1187 |  |
  |  | 1188 | /\*\* |
  |  | 1189 | \* Plugin install |
  |  | 1190 | \*/ |
  |  | 1191 | public function plugin\_install( $plugin\_slug ) { |
  |  | 1192 | include\_once( ABSPATH . 'wp-admin/includes/plugin-install.php' ); //for plugins\_api.. |
  |  | 1193 | $api = plugins\_api( 'plugin\_information', array( |
  |  | 1194 | 'slug'   => $plugin\_slug, |
  |  | 1195 | 'fields' => array( |
  |  | 1196 | 'short\_description' => false, |
  |  | 1197 | 'sections'          => false, |
  |  | 1198 | 'requires'          => false, |
  |  | 1199 | 'rating'            => false, |
  |  | 1200 | 'ratings'           => false, |
  |  | 1201 | 'downloaded'        => false, |
  |  | 1202 | 'last\_updated'      => false, |
  |  | 1203 | 'added'             => false, |
  |  | 1204 | 'tags'              => false, |
  |  | 1205 | 'compatibility'     => false, |
  |  | 1206 | 'homepage'          => false, |
  |  | 1207 | 'donate\_link'       => false, |
  |  | 1208 | ), |
  |  | 1209 | ) ); |
  |  | 1210 | //includes necessary for Plugin\_Upgrader and Plugin\_Installer\_Skin |
  |  | 1211 | include\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
  |  | 1212 | include\_once( ABSPATH . 'wp-admin/includes/misc.php' ); |
  |  | 1213 | include\_once( ABSPATH . 'wp-admin/includes/class-wp-upgrader.php' ); |
  |  | 1214 | $upgrader = new Plugin\_Upgrader( new Plugin\_Installer\_Skin( compact( 'title', 'url', 'nonce', 'plugin', 'api' ) ) ); |
  |  | 1215 | $upgrader->install( $api->download\_link ); |
  |  | 1216 | } |
  |  | 1217 |  |
  |  | 1218 | /\*\* |
  |  | 1219 | \* Check if plugin is installed by getting all plugins from the plugins dir |
  |  | 1220 | \* |
  |  | 1221 | \* @param $plugin\_slug |
  |  | 1222 | \* |
  |  | 1223 | \* @return bool |
  |  | 1224 | \*/ |
  |  | 1225 | public function check\_plugin\_installed( $plugin\_slug ): bool { |
  |  | 1226 | $installed\_plugins = get\_plugins(); |
  |  | 1227 |  |
  |  | 1228 | return array\_key\_exists( $plugin\_slug, $installed\_plugins ) || in\_array( $plugin\_slug, $installed\_plugins, true ); |
  |  | 1229 | } |
  |  | 1230 |  |
  |  | 1231 | //add and update user meta |
  |  | 1232 | public function add\_update\_usermeta( $user\_meta = null, $user\_id = null ) { |
  |  | 1233 | if ( ! empty( $user\_meta ) && is\_array( $user\_meta ) ) { |
  |  | 1234 | foreach ( $user\_meta as $k => $v ) { |
  |  | 1235 | if ( isset( $v[0] ) ) { |
  |  | 1236 | $checkSerialize = @unserialize( $v[0] ); |
  |  | 1237 | $metaVal        = ( $checkSerialize !== false || $v[0] === 'b:0;' ) ? unserialize( $v[0] ) : $v[0]; |
  |  | 1238 | if ( metadata\_exists( 'user', $user\_id, $k ) ) { |
  |  | 1239 | update\_user\_meta( $user\_id, $k, $metaVal ); |
  |  | 1240 | } else { |
  |  | 1241 | add\_user\_meta( $user\_id, $k, $metaVal ); |
  |  | 1242 | } |
  |  | 1243 | } |
  |  | 1244 | } |
  |  | 1245 | } |
  |  | 1246 | } |
  |  | 1247 |  |
  |  | 1248 | /\*\* |
  |  | 1249 | \* Set Astra Costmizer Setings |
  |  | 1250 | \*/ |
  |  | 1251 | function setAstraCostmizerSetings( $arr = null ) { |
  |  | 1252 | #Checkout |
  |  | 1253 | update\_option( 'woocommerce\_checkout\_company\_field', $arr['woocommerce\_checkout\_company\_field'] ); |
  |  | 1254 | update\_option( 'woocommerce\_checkout\_address\_2\_field', $arr['woocommerce\_checkout\_address\_2\_field'] ); |
  |  | 1255 | update\_option( 'woocommerce\_checkout\_phone\_field', $arr['woocommerce\_checkout\_phone\_field'] ); |
  |  | 1256 | update\_option( 'woocommerce\_checkout\_highlight\_required\_fields', $arr['woocommerce\_checkout\_highlight\_required\_fields'] ); |
  |  | 1257 | update\_option( 'wp\_page\_for\_privacy\_policy', $arr['wp\_page\_for\_privacy\_policy'] ); |
  |  | 1258 | update\_option( 'woocommerce\_terms\_page\_id', $arr['woocommerce\_terms\_page\_id'] ); |
  |  | 1259 | update\_option( 'woocommerce\_checkout\_privacy\_policy\_text', $arr['woocommerce\_checkout\_privacy\_policy\_text'] ); |
  |  | 1260 | update\_option( 'woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text', $arr['woocommerce\_checkout\_terms\_and\_conditions\_checkbox\_text'] ); |
  |  | 1261 |  |
  |  | 1262 | #product catalog |
  |  | 1263 | update\_option( 'woocommerce\_shop\_page\_display', $arr['woocommerce\_shop\_page\_display'] ); |
  |  | 1264 | update\_option( 'woocommerce\_default\_catalog\_orderby', $arr['woocommerce\_default\_catalog\_orderby'] ); |
  |  | 1265 | update\_option( 'woocommerce\_category\_archive\_display', $arr['woocommerce\_category\_archive\_display'] ); |
  |  | 1266 |  |
  |  | 1267 | #Product Images |
  |  | 1268 | update\_option( 'woocommerce\_single\_image\_width', $arr['woocommerce\_single\_image\_width'] ); |
  |  | 1269 | update\_option( 'woocommerce\_thumbnail\_image\_width', $arr['woocommerce\_thumbnail\_image\_width'] ); |
  |  | 1270 | update\_option( 'woocommerce\_thumbnail\_cropping', $arr['woocommerce\_thumbnail\_cropping'] ); |
  |  | 1271 | update\_option( 'woocommerce\_thumbnail\_cropping\_custom\_width', $arr['woocommerce\_thumbnail\_cropping\_custom\_width'] ); |
  |  | 1272 | update\_option( 'woocommerce\_thumbnail\_cropping\_custom\_height', $arr['woocommerce\_thumbnail\_cropping\_custom\_height'] ); |
  |  | 1273 |  |
  |  | 1274 | #Store Notice |
  |  | 1275 | update\_option( 'woocommerce\_demo\_store', $arr['woocommerce\_demo\_store'] ); |
  |  | 1276 | update\_option( 'woocommerce\_demo\_store\_notice', $arr['woocommerce\_demo\_store\_notice'] ); |
  |  | 1277 | } |
  |  | 1278 | } |
  |  | 1279 |  |
  | 1240 | 1280 | new InstaWP\_Rest\_Apis(); |
* ## [instawp-connect/trunk/includes/class-instawp-tools.php](/changeset/2942363/instawp-connect/trunk/includes/class-instawp-tools.php "Show the changeset 2942363 restricted to instawp-connect/trunk/includes/class-instawp-tools.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-instawp-tools.php?rev=2940719#L6 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/trunk/includes/class-instawp-tools.php?rev=2942363#L6 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 |  |
  | 7 | 7 | class InstaWP\_Tools { |
  | 8 |  |  |
  | 9 |  |  |
  | 10 | 8 |  |
  | 11 | 9 | public static function write\_log( $message = '', $type = 'notice' ) { |
  | […](/browser/instawp-connect/trunk/includes/class-instawp-tools.php?rev=2940719#L170) | […](/browser/instawp-connect/trunk/includes/class-instawp-tools.php?rev=2942363#L168) |  |
  | 170 | 168 | return $parts; |
  | 171 | 169 | } |
  |  | 170 |  |
  |  | 171 | /\*\* |
  |  | 172 | \* Returns the random string based on length. |
  |  | 173 | \* |
  |  | 174 | \* @param int $length |
  |  | 175 | \* |
  |  | 176 | \* @return string |
  |  | 177 | \*/ |
  |  | 178 | public static function get\_random\_string( $length ) { |
  |  | 179 | $length = $length / 2; |
  |  | 180 | if ( function\_exists( 'random\_bytes' ) ) { |
  |  | 181 | $result = random\_bytes( $length ); |
  |  | 182 | } else { |
  |  | 183 | $result = openssl\_random\_pseudo\_bytes( $length ); |
  |  | 184 | } |
  |  | 185 |  |
  |  | 186 | return bin2hex( $result ); |
  |  | 187 | } |
  | 172 | 188 | } |
* ## [instawp-connect/trunk/includes/class-instawp.php](/changeset/2942363/instawp-connect/trunk/includes/class-instawp.php "Show the changeset 2942363 restricted to instawp-connect/trunk/includes/class-instawp.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2940719#L342 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2942363#L342 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 342 | 342 |  |
  | 343 | 343 | include\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-error-log.php'; |
  |  | 344 | include\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-file-management.php'; |
  | 344 | 345 | include\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-backuplist.php'; |
  | 345 | 346 | include\_once INSTAWP\_PLUGIN\_DIR . '/includes/class-instawp-restore-data.php'; |
  | […](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2940719#L689) | […](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2942363#L690) |  |
  | 689 | 690 |  |
  | 690 | 691 | if ( ! $api\_response\_status ) { |
  | 691 |  | return array( 'can\_proceed' => false, 'message' => esc\_html\_\_( 'Could not fetch API data.', 'instawp-connect' ) ); |
  |  | 692 | return array( |
  |  | 693 | 'can\_proceed'  => false, |
  |  | 694 | 'message'      => esc\_html\_\_( 'Could not fetch API data.', 'instawp-connect' ), |
  |  | 695 | 'api\_options'  => InstaWP\_Setting::get\_option( 'instawp\_api\_options', array() ), |
  |  | 696 | 'connect\_id'   => $connect\_id, |
  |  | 697 | 'api\_response' => $api\_response, |
  |  | 698 | ); |
  | 692 | 699 | } |
  | 693 | 700 |  |
  | […](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2940719#L7608) | […](/browser/instawp-connect/trunk/includes/class-instawp.php?rev=2942363#L7615) |  |
  | 7608 | 7615 | $blacklisted\_constants        = [ |
  | 7609 | 7616 | 'INSTAWP\_ALLOW\_MANAGE', |
  |  | 7617 | 'INSTAWP\_FILE\_MANAGER\_USERNAME', |
  |  | 7618 | 'INSTAWP\_FILE\_MANAGER\_PASSWORD', |
  |  | 7619 | 'INSTAWP\_FILE\_MANAGER\_SELF\_URL', |
  |  | 7620 | 'INSTAWP\_FILE\_MANAGER\_SESSION\_ID', |
  | 7610 | 7621 | 'DB\_NAME', |
  | 7611 | 7622 | 'DB\_USER', |
* ## [instawp-connect/trunk/includes/class-intawp-ajax-fn.php](/changeset/2942363/instawp-connect/trunk/includes/class-intawp-ajax-fn.php "Show the changeset 2942363 restricted to instawp-connect/trunk/includes/class-intawp-ajax-fn.php")

  | [r2940719](/browser/instawp-connect/trunk/includes/class-intawp-ajax-fn.php?rev=2940719#L84 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/trunk/includes/class-intawp-ajax-fn.php?rev=2942363#L84 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 84 | 84 | $page           = isset( $\_POST['epage'] ) ? abs( (int) $\_POST['epage'] ) : 1; |
  | 85 | 85 | $offset         = ( $page \* $items\_per\_page ) - $items\_per\_page; |
  | 86 |  | $events         = $wpdb->get\_results( $query . " ORDER BY id DESC LIMIT ${offset}, ${items\_per\_page}"); |
  |  | 86 | $events         = $wpdb->get\_results( $query . " GROUP BY `source\_id`,`date` ORDER BY id DESC LIMIT ${offset}, ${items\_per\_page}"); |
  | 87 | 87 | $totalPage      = ceil($total / $items\_per\_page); |
  | 88 | 88 |  |
  | […](/browser/instawp-connect/trunk/includes/class-intawp-ajax-fn.php?rev=2940719#L247) | […](/browser/instawp-connect/trunk/includes/class-intawp-ajax-fn.php?rev=2942363#L247) |  |
  | 247 | 247 | ]); |
  | 248 | 248 |  |
  | 249 |  | //    echo $packed\_data; |
  |  | 249 | //    echo $packed\_data; |
  | 250 | 250 | //    exit(); |
  | 251 | 251 | $resp = $this->sync\_upload($packed\_data,null); |
* ## [instawp-connect/trunk/instawp-connect.php](/changeset/2942363/instawp-connect/trunk/instawp-connect.php "Show the changeset 2942363 restricted to instawp-connect/trunk/instawp-connect.php")

  | [r2940719](/browser/instawp-connect/trunk/instawp-connect.php?rev=2940719#L8 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/trunk/instawp-connect.php?rev=2942363#L8 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 8 | 8 | \* Plugin Name:       InstaWP Connect |
  | 9 | 9 | \* Description:       Create 1-click staging, migration and manage your prod sites. |
  | 10 |  | \* Version:           0.0.9.1~~8~~ |
  |  | 10 | \* Version:           0.0.9.19 |
  | 11 | 11 | \* Author:            InstaWP Team |
  | 12 | 12 | \* Author URI:        https://instawp.com/ |
  | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2940719#L25) | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2942363#L25) |  |
  | 25 | 25 |  |
  | 26 | 26 |  |
  | 27 |  | define( 'INSTAWP\_PLUGIN\_VERSION', '0.0.9.1~~8~~' ); |
  |  | 27 | define( 'INSTAWP\_PLUGIN\_VERSION', '0.0.9.19' ); |
  | 28 | 28 | define( 'INSTAWP\_RESTORE\_INIT', 'init' ); |
  | 29 | 29 | define( 'INSTAWP\_RESTORE\_READY', 'ready' ); |
  | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2940719#L124) | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2942363#L124) |  |
  | 124 | 124 | InstaWP\_Setting::set\_api\_domain(); |
  | 125 | 125 | error\_log( "Settled on activation" ); |
  | 126 |  |  |
  |  | 126 |  |
  |  | 127 | global $wp\_rewrite; |
  | 127 | 128 | if ( get\_option( 'permalink\_structure' ) == '' ) { |
  | 128 |  | ~~global $wp\_rewrite;~~ |
  | 129 | 129 | $wp\_rewrite->set\_permalink\_structure( '/%postname%/' ); |
  | 130 |  | ~~$wp\_rewrite->flush\_rules();~~ |
  | 131 | 130 | } |
  |  | 131 | $wp\_rewrite->flush\_rules(); |
  | 132 | 132 | add\_option( 'instawp\_do\_activation\_redirect', true ); |
  | 133 | 133 | } |
  | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2940719#L135) | […](/browser/instawp-connect/trunk/instawp-connect.php?rev=2942363#L135) |  |
  | 135 | 135 | /\*Deactivate Hook Handle\*/ |
  | 136 | 136 | function instawp\_plugin\_deactivate() { |
  |  | 137 | flush\_rewrite\_rules(); |
  | 137 | 138 | as\_unschedule\_all\_actions( 'instawp\_handle\_heartbeat', [], 'instawp-connect' ); |
  | 138 | 139 | } |
* ## [instawp-connect/trunk/readme.txt](/changeset/2942363/instawp-connect/trunk/readme.txt "Show the changeset 2942363 restricted to instawp-connect/trunk/readme.txt")

  | [r2940719](/browser/instawp-connect/trunk/readme.txt?rev=2940719#L5 "Show revision 2940719 of this file in browser") | [r2942363](/browser/instawp-connect/trunk/readme.txt?rev=2942363#L5 "Show revision 2942363 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Tested up to: 6.2.2 |
  | 6 | 6 | Requires PHP: 7.0 |
  | 7 |  | Stable tag: 0.0.9.1~~8~~ |
  |  | 7 | Stable tag: 0.0.9.19 |
  | 8 | 8 | License: GPLv3 or later |
  | 9 | 9 | License URI: https://www.gnu.org/licenses/gpl-3.0.en.html |
  | […](/browser/instawp-connect/trunk/readme.txt?rev=2940719#L124) | […](/browser/instawp-connect/trunk/readme.txt?rev=2942363#L124) |  |
  | 124 | 124 | - 20/07/2023 - FIX - Minor changes on the migration user interface. |
  | 125 | 125 |  |
  | 126 |  |  |
  | 127 |  |  |
  |  | 126 | = 0.0.9.19 = |
  |  | 127 | - 24/07/2023 - FIX - Fix Sync API vulnerability issue, disclosure by WordFence. |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2942363)
* [Zip Archive](?format=zip&new=2942363)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


