=== Content from github.com_6f8ef115_20250114_233133.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgithub%2Fcmark-gfm%2Fsecurity%2Fadvisories%2FGHSA-66g8-4hjf-77xh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgithub%2Fcmark-gfm%2Fsecurity%2Fadvisories%2FGHSA-66g8-4hjf-77xh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=github%2Fcmark-gfm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[github](/github)
/
**[cmark-gfm](/github/cmark-gfm)**
Public

forked from [commonmark/cmark](/commonmark/cmark)

* [Notifications](/login?return_to=%2Fgithub%2Fcmark-gfm) You must be signed in to change notification settings
* [Fork
  176](/login?return_to=%2Fgithub%2Fcmark-gfm)
* [Star
   919](/login?return_to=%2Fgithub%2Fcmark-gfm)

* [Code](/github/cmark-gfm)
* [Issues
  103](/github/cmark-gfm/issues)
* [Pull requests
  18](/github/cmark-gfm/pulls)
* [Actions](/github/cmark-gfm/actions)
* [Security](/github/cmark-gfm/security)
* [Insights](/github/cmark-gfm/pulse)

Additional navigation options

* [Code](/github/cmark-gfm)
* [Issues](/github/cmark-gfm/issues)
* [Pull requests](/github/cmark-gfm/pulls)
* [Actions](/github/cmark-gfm/actions)
* [Security](/github/cmark-gfm/security)
* [Insights](/github/cmark-gfm/pulse)

# Quadratic complexity bugs may lead to a denial of service

Moderate

[anticomputer](/anticomputer)
published
GHSA-66g8-4hjf-77xh
Mar 31, 2023

## Package

cmark-gfm

## Affected versions

<= 0.29.0.gfm.9

## Patched versions

0.29.0.gfm.10

## Description

### Impact

Two polynomial time complexity issues in cmark-gfm may lead to unbounded resource exhaustion and subsequent denial of service.

### Proof of concept

Issue 1:

```
python3 -c 'n = 10000; print(">"*n + "a*"*n)' | cmark-gfm
```

Issue 2:

```
python3 -c 'n = 10000; print(" -" * n + "x" + "\n" * n)' | cmark-gfm
```

Increasing the number 10000 in the above commands causes the running time to increase quadratically.

### Patches

These vulnerabilities have been patched in 0.29.0.gfm.10.

### Note on cmark and cmark-gfm

[cmark-gfm](https://github.com/github/cmark-gfm) is a fork of [cmark](https://github.com/commonmark/cmark) that adds the GitHub Flavored Markdown extensions. The two codebases have diverged over time, but share a common core. These bugs affect both `cmark` and `cmark-gfm`.

### Credit

We would like to thank [@nwellnhof](https://github.com/nwellnhof) for reporting the first vulnerability (issue 1). Issue 2 was subsequently found by GitHub Security Lab.

### References

<https://en.wikipedia.org/wiki/Time_complexity>

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [github/cmark-gfm](https://github.com/github/cmark-gfm)

### Severity

Moderate

### CVE ID

CVE-2023-24824

### Weaknesses

[CWE-407](/advisories?query=cwe%3A407)

### Credits

* [![@nwellnhof](https://avatars.githubusercontent.com/u/63962?s=40&v=4)](/nwellnhof)
  [nwellnhof](/nwellnhof)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b6ab09f2_20250114_233131.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgithub%2Fcmark-gfm%2Fcommit%2F2300c1bd2c8226108885bf019655c4159cf26b59)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgithub%2Fcmark-gfm%2Fcommit%2F2300c1bd2c8226108885bf019655c4159cf26b59)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=github%2Fcmark-gfm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[github](/github)
/
**[cmark-gfm](/github/cmark-gfm)**
Public

forked from [commonmark/cmark](/commonmark/cmark)

* [Notifications](/login?return_to=%2Fgithub%2Fcmark-gfm) You must be signed in to change notification settings
* [Fork
  176](/login?return_to=%2Fgithub%2Fcmark-gfm)
* [Star
   919](/login?return_to=%2Fgithub%2Fcmark-gfm)

* [Code](/github/cmark-gfm)
* [Issues
  103](/github/cmark-gfm/issues)
* [Pull requests
  18](/github/cmark-gfm/pulls)
* [Actions](/github/cmark-gfm/actions)
* [Security](/github/cmark-gfm/security)
* [Insights](/github/cmark-gfm/pulse)

Additional navigation options

* [Code](/github/cmark-gfm)
* [Issues](/github/cmark-gfm/issues)
* [Pull requests](/github/cmark-gfm/pulls)
* [Actions](/github/cmark-gfm/actions)
* [Security](/github/cmark-gfm/security)
* [Insights](/github/cmark-gfm/pulse)

## Commit

[Permalink](/github/cmark-gfm/commit/2300c1bd2c8226108885bf019655c4159cf26b59)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-66g8-4hjf-77xh](https://github.com/github/cmark-gfm/security/advisories/GHSA-66g8-4hjf-77xh "GHSA-66g8-4hjf-77xh")

[Browse files](/github/cmark-gfm/tree/2300c1bd2c8226108885bf019655c4159cf26b59)
Browse the repository at this point in the history

```
Keep a count of the number of open blocks (WIP)
```

* Loading branch information

[![@anticomputer](https://avatars.githubusercontent.com/u/13686387?s=40&v=4)](/anticomputer)

[anticomputer](/github/cmark-gfm/commits?author=anticomputer "View all commits by anticomputer")
authored
Mar 31, 2023

2 parents
[c32ef78](/github/cmark-gfm/commit/c32ef78bae851cb83b7ad52d0fbff880acdcd44a)
+
[6e4493d](/github/cmark-gfm/commit/6e4493d628e71e8e6b25918bbd69733f37f8b03a)

commit 2300c1b

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**198 additions**
and
**26 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* api\_test

  + api\_test/main.c
    [main.c](#diff-e75261f3103d7043ec51540969cd48b105127e2672bfa27acfbdd1f2d0c85553)
* extensions

  + extensions/table.c
    [table.c](#diff-013fac9bd58a7cb5ff9ac3b1f3e52ecedea83f1cfeff2ff2e23fdc40f2326cfe)
* src

  + src/blocks.c
    [blocks.c](#diff-ff2c140f34db7cd4527b9a207321297bf557d686e129846bc3d5b96311cf7c9f)
  + src/cmark-gfm.h
    [cmark-gfm.h](#diff-00457cd1e714e31403d8bc9e03b85ec8e83125db5580ea3f577b28b05d3a4768)
  + src/node.c
    [node.c](#diff-1d65b73480a2525c526a825836ce591783871f606261eca5b7af7b3bfd31a6b3)
  + src/node.h
    [node.h](#diff-7c19dd5fd5584cd4a8111f4c82a9f49f4aa1bdb9470ad11daa90f3d394a23b4e)
  + src/parser.h
    [parser.h](#diff-613ded7e24c817a4580bc8519193bebe7cf9aafc49cf68f5b84fea2797bb219c)
  + src/syntax\_extension.c
    [syntax\_extension.c](#diff-2a10f109b9d7ddd2abeaa6358d4ec78d871249619444fee008573d5c7ecaf90a)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[api\_test/main.c](#diff-e75261f3103d7043ec51540969cd48b105127e2672bfa27acfbdd1f2d0c85553 "api_test/main.c")

Show comments

[View file](/github/cmark-gfm/blob/2300c1bd2c8226108885bf019655c4159cf26b59/api_test/main.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1133,6 +1133,7 @@ int main() { |
|  |  | int retval; |
|  |  | test\_batch\_runner \*runner = test\_batch\_runner\_new(); |
|  |  |  |
|  |  | cmark\_enable\_safety\_checks(true); |
|  |  | version(runner); |
|  |  | constructor(runner); |
|  |  | accessors(runner); |
| Expand Down | |  |

6 changes: 6 additions & 0 deletions

6
[extensions/table.c](#diff-013fac9bd58a7cb5ff9ac3b1f3e52ecedea83f1cfeff2ff2e23fdc40f2326cfe "extensions/table.c")

Show comments

[View file](/github/cmark-gfm/blob/2300c1bd2c8226108885bf019655c4159cf26b59/extensions/table.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -311,12 +311,18 @@ static cmark\_node \*try\_opening\_table\_header(cmark\_syntax\_extension \*self, |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | assert(cmark\_node\_get\_type(parent\_container) == CMARK\_NODE\_PARAGRAPH); |
|  |  | if (!cmark\_node\_set\_type(parent\_container, CMARK\_NODE\_TABLE)) { |
|  |  | free\_table\_row(parser->mem, header\_row); |
|  |  | free\_table\_row(parser->mem, marker\_row); |
|  |  | return parent\_container; |
|  |  | } |
|  |  |  |
|  |  | // Update the node counts after parent\_container changed type. |
|  |  | assert(parent\_container->next == NULL); |
|  |  | decr\_open\_block\_count(parser, CMARK\_NODE\_PARAGRAPH); |
|  |  | incr\_open\_block\_count(parser, CMARK\_NODE\_TABLE); |
|  |  |  |
|  |  | if (header\_row->paragraph\_offset) { |
|  |  | try\_inserting\_table\_header\_paragraph(parser, parent\_container, (unsigned char \*)parent\_string, |
|  |  | header\_row->paragraph\_offset); |
| Expand Down | |  |

119 changes: 107 additions & 12 deletions

119
[src/blocks.c](#diff-ff2c140f34db7cd4527b9a207321297bf557d686e129846bc3d5b96311cf7c9f "src/blocks.c")

Show comments

[View file](/github/cmark-gfm/blob/2300c1bd2c8226108885bf019655c4159cf26b59/src/blocks.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -70,6 +70,22 @@ static void S\_parser\_feed(cmark\_parser \*parser, const unsigned char \*buffer, |
|  |  | static void S\_process\_line(cmark\_parser \*parser, const unsigned char \*buffer, |
|  |  | bufsize\_t bytes); |
|  |  |  |
|  |  | static void subtract\_open\_block\_counts(cmark\_parser \*parser, cmark\_node \*node) { |
|  |  | do { |
|  |  | decr\_open\_block\_count(parser, S\_type(node)); |
|  |  | node->flags &= ~CMARK\_NODE\_\_OPEN\_BLOCK; |
|  |  | node = node->last\_child; |
|  |  | } while (node); |
|  |  | } |
|  |  |  |
|  |  | static void add\_open\_block\_counts(cmark\_parser \*parser, cmark\_node \*node) { |
|  |  | do { |
|  |  | incr\_open\_block\_count(parser, S\_type(node)); |
|  |  | node->flags |= CMARK\_NODE\_\_OPEN\_BLOCK; |
|  |  | node = node->last\_child; |
|  |  | } while (node); |
|  |  | } |
|  |  |  |
|  |  | static cmark\_node \*make\_block(cmark\_mem \*mem, cmark\_node\_type tag, |
|  |  | int start\_line, int start\_column) { |
|  |  | cmark\_node \*e; |
| Expand Down  Expand Up | | @@ -129,6 +145,7 @@ static void cmark\_parser\_reset(cmark\_parser \*parser) { |
|  |  | parser->refmap = cmark\_reference\_map\_new(parser->mem); |
|  |  | parser->root = document; |
|  |  | parser->current = document; |
|  |  | add\_open\_block\_counts(parser, document); |
|  |  |  |
|  |  | parser->syntax\_extensions = saved\_exts; |
|  |  | parser->inline\_syntax\_extensions = saved\_inline\_exts; |
| Expand Down  Expand Up | | @@ -242,15 +259,18 @@ static void remove\_trailing\_blank\_lines(cmark\_strbuf \*ln) { |
|  |  | // Check to see if a node ends with a blank line, descending |
|  |  | // if needed into lists and sublists. |
|  |  | static bool S\_ends\_with\_blank\_line(cmark\_node \*node) { |
|  |  | if (S\_last\_line\_checked(node)) { |
|  |  | return(S\_last\_line\_blank(node)); |
|  |  | } else if ((S\_type(node) == CMARK\_NODE\_LIST || |
|  |  | S\_type(node) == CMARK\_NODE\_ITEM) && node->last\_child) { |
|  |  | S\_set\_last\_line\_checked(node); |
|  |  | return(S\_ends\_with\_blank\_line(node->last\_child)); |
|  |  | } else { |
|  |  | S\_set\_last\_line\_checked(node); |
|  |  | return (S\_last\_line\_blank(node)); |
|  |  | while (true) { |
|  |  | if (S\_last\_line\_checked(node)) { |
|  |  | return(S\_last\_line\_blank(node)); |
|  |  | } else if ((S\_type(node) == CMARK\_NODE\_LIST || |
|  |  | S\_type(node) == CMARK\_NODE\_ITEM) && node->last\_child) { |
|  |  | S\_set\_last\_line\_checked(node); |
|  |  | node = node->last\_child; |
|  |  | continue; |
|  |  | } else { |
|  |  | S\_set\_last\_line\_checked(node); |
|  |  | return (S\_last\_line\_blank(node)); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -310,6 +330,12 @@ static cmark\_node \*finalize(cmark\_parser \*parser, cmark\_node \*b) { |
|  |  | has\_content = resolve\_reference\_link\_definitions(parser, b); |
|  |  | if (!has\_content) { |
|  |  | // remove blank node (former reference def) |
|  |  | if (b->flags & CMARK\_NODE\_\_OPEN\_BLOCK) { |
|  |  | decr\_open\_block\_count(parser, S\_type(b)); |
|  |  | if (b->prev) { |
|  |  | add\_open\_block\_counts(parser, b->prev); |
|  |  | } |
|  |  | } |
|  |  | cmark\_node\_free(b); |
|  |  | } |
|  |  | break; |
| Expand Down  Expand Up | | @@ -382,6 +408,17 @@ static cmark\_node \*finalize(cmark\_parser \*parser, cmark\_node \*b) { |
|  |  | return parent; |
|  |  | } |
|  |  |  |
|  |  | // Recalculates the number of open blocks. Returns true if it matches what's currently stored |
|  |  | // in parser. (Used to check that the counts in parser, which are updated incrementally, are |
|  |  | // correct.) |
|  |  | bool check\_open\_block\_counts(cmark\_parser \*parser) { |
|  |  | cmark\_parser tmp\_parser = {0}; // Only used for its open\_block\_counts and total\_open\_blocks fields. |
|  |  | add\_open\_block\_counts(&tmp\_parser, parser->root); |
|  |  | return |
|  |  | tmp\_parser.total\_open\_blocks == parser->total\_open\_blocks && |
|  |  | memcmp(tmp\_parser.open\_block\_counts, parser->open\_block\_counts, sizeof(parser->open\_block\_counts)) == 0; |
|  |  | } |
|  |  |  |
|  |  | // Add a node as child of another. Return pointer to child. |
|  |  | static cmark\_node \*add\_child(cmark\_parser \*parser, cmark\_node \*parent, |
|  |  | cmark\_node\_type block\_type, int start\_column) { |
| Expand All | | @@ -400,11 +437,14 @@ static cmark\_node \*add\_child(cmark\_parser \*parser, cmark\_node \*parent, |
|  |  | if (parent->last\_child) { |
|  |  | parent->last\_child->next = child; |
|  |  | child->prev = parent->last\_child; |
|  |  | subtract\_open\_block\_counts(parser, parent->last\_child); |
|  |  | } else { |
|  |  | parent->first\_child = child; |
|  |  | child->prev = NULL; |
|  |  | } |
|  |  | parent->last\_child = child; |
|  |  | add\_open\_block\_counts(parser, child); |
|  |  |  |
|  |  | return child; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -1047,8 +1087,14 @@ static cmark\_node \*check\_open\_blocks(cmark\_parser \*parser, cmark\_chunk \*input, |
|  |  | \*all\_matched = false; |
|  |  | cmark\_node \*container = parser->root; |
|  |  | cmark\_node\_type cont\_type; |
|  |  | cmark\_parser tmp\_parser; // Only used for its open\_block\_counts and total\_open\_blocks fields. |
|  |  | memcpy(tmp\_parser.open\_block\_counts, parser->open\_block\_counts, sizeof(parser->open\_block\_counts)); |
|  |  | tmp\_parser.total\_open\_blocks = parser->total\_open\_blocks; |
|  |  |  |
|  |  | assert(check\_open\_block\_counts(parser)); |
|  |  |  |
|  |  | while (S\_last\_child\_is\_open(container)) { |
|  |  | decr\_open\_block\_count(&tmp\_parser, S\_type(container)); |
|  |  | container = container->last\_child; |
|  |  | cont\_type = S\_type(container); |
|  |  |  |
| Expand All | | @@ -1060,6 +1106,53 @@ static cmark\_node \*check\_open\_blocks(cmark\_parser \*parser, cmark\_chunk \*input, |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | // This block of code is a workaround for the quadratic performance |
|  |  | // issue described here (issue 2): |
|  |  | // |
|  |  | // https://github.com/github/cmark-gfm/security/advisories/GHSA-66g8-4hjf-77xh |
|  |  | // |
|  |  | // If the current line is empty then we might be able to skip directly |
|  |  | // to the end of the list of open blocks. To determine whether this is |
|  |  | // possible, we have been maintaining a count of the number of |
|  |  | // different types of open blocks. The main criterium is that every |
|  |  | // remaining block, except the last element of the list, is a LIST or |
|  |  | // ITEM. The code below checks the conditions, and if they're ok, skips |
|  |  | // forward to parser->current. |
|  |  | if (parser->blank && parser->indent == 0) { // Current line is empty |
|  |  | // Make sure that parser->current doesn't point to a closed block. |
|  |  | if (parser->current->flags & CMARK\_NODE\_\_OPEN\_BLOCK) { |
|  |  | if (parser->current->flags & CMARK\_NODE\_\_OPEN) { |
|  |  | const size\_t n\_list = read\_open\_block\_count(&tmp\_parser, CMARK\_NODE\_LIST); |
|  |  | const size\_t n\_item = read\_open\_block\_count(&tmp\_parser, CMARK\_NODE\_ITEM); |
|  |  | // At most one block can be something other than a LIST or ITEM. |
|  |  | if (n\_list + n\_item + 1 >= tmp\_parser.total\_open\_blocks) { |
|  |  | // Check that parser->current is suitable for jumping to. |
|  |  | switch (S\_type(parser->current)) { |
|  |  | case CMARK\_NODE\_LIST: |
|  |  | case CMARK\_NODE\_ITEM: |
|  |  | if (n\_list + n\_item != tmp\_parser.total\_open\_blocks) { |
|  |  | if (parser->current->last\_child == NULL) { |
|  |  | // There's another node type somewhere in the middle of |
|  |  | // the list, so don't attempt the optimization. |
|  |  | break; |
|  |  | } |
|  |  | } |
|  |  | // fall through |
|  |  | case CMARK\_NODE\_CODE\_BLOCK: |
|  |  | case CMARK\_NODE\_PARAGRAPH: |
|  |  | case CMARK\_NODE\_HTML\_BLOCK: |
|  |  | // Jump to parser->current |
|  |  | container = parser->current; |
|  |  | cont\_type = S\_type(container); |
|  |  | break; |
|  |  | default: |
|  |  | break; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | switch (cont\_type) { |
|  |  | case CMARK\_NODE\_BLOCK\_QUOTE: |
|  |  | if (!parse\_block\_quote\_prefix(parser, input)) |
| Expand Down  Expand Up | | @@ -1193,8 +1286,9 @@ static void open\_new\_blocks(cmark\_parser \*parser, cmark\_node \*\*container, |
|  |  | has\_content = resolve\_reference\_link\_definitions(parser, \*container); |
|  |  |  |
|  |  | if (has\_content) { |
|  |  |  |
|  |  | (\*container)->type = (uint16\_t)CMARK\_NODE\_HEADING; |
|  |  | cmark\_node\_set\_type(\*container, CMARK\_NODE\_HEADING); |
|  |  | decr\_open\_block\_count(parser, CMARK\_NODE\_PARAGRAPH); |
|  |  | incr\_open\_block\_count(parser, CMARK\_NODE\_HEADING); |
|  |  | (\*container)->as.heading.level = lev; |
|  |  | (\*container)->as.heading.setext = true; |
|  |  | S\_advance\_offset(parser, input, input->len - 1 - parser->offset, false); |
| Expand Down  Expand Up | | @@ -1349,7 +1443,7 @@ static void add\_text\_to\_container(cmark\_parser \*parser, cmark\_node \*container, |
|  |  | S\_set\_last\_line\_blank(container, last\_line\_blank); |
|  |  |  |
|  |  | tmp = container; |
|  |  | while (tmp->parent) { |
|  |  | while (tmp->parent && S\_last\_line\_blank(tmp->parent)) { |
|  |  | S\_set\_last\_line\_blank(tmp->parent, false); |
|  |  | tmp = tmp->parent; |
|  |  | } |
| Expand Down  Expand Up | | @@ -1478,6 +1572,7 @@ static void S\_process\_line(cmark\_parser \*parser, const unsigned char \*buffer, |
|  |  |  |
|  |  | parser->line\_number++; |
|  |  |  |
|  |  | assert(parser->current->next == NULL); |
|  |  | last\_matched\_container = check\_open\_blocks(parser, &input, &all\_matched); |
|  |  |  |
|  |  | if (!last\_matched\_container) |
| Expand Down | |  |

10 changes: 10 additions & 0 deletions

10
[src/cmark-gfm.h](#diff-00457cd1e714e31403d8bc9e03b85ec8e83125db5580ea3f577b28b05d3a4768 "src/cmark-gfm.h")

Show comments

[View file](/github/cmark-gfm/blob/2300c1bd2c8226108885bf019655c4159cf26b59/src/cmark-gfm.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,6 +37,16 @@ char \*cmark\_markdown\_to\_html(const char \*text, size\_t len, int options); |
|  |  | #define CMARK\_NODE\_TYPE\_MASK (0xc000) |
|  |  | #define CMARK\_NODE\_VALUE\_MASK (0x3fff) |
|  |  |  |
|  |  | /\*\* |
|  |  | \* This is the maximum number of block types (CMARK\_NODE\_DOCUMENT, |
|  |  | \* CMARK\_NODE\_HEADING, ...). It needs to be bigger than the number of |
|  |  | \* hardcoded block types (below) to allow for extensions (see |
|  |  | \* cmark\_syntax\_extension\_add\_node). But it also determines the size of the |
|  |  | \* open\_block\_counts array in the cmark\_parser struct, so we don't want it |
|  |  | \* to be excessively large. |
|  |  | \*/ |
|  |  | #define CMARK\_NODE\_TYPE\_BLOCK\_LIMIT 0x20 |
|  |  |  |
|  |  | typedef enum { |
|  |  | /\* Error status \*/ |
|  |  | CMARK\_NODE\_NONE = 0x0000, |
| Expand Down | |  |

30 changes: 20 additions & 10 deletions

30
[src/node.c](#diff-1d65b73480a2525c526a825836ce591783871f606261eca5b7af7b3bfd31a6b3 "src/node.c")

Show comments

[View file](/github/cmark-gfm/blob/2300c1bd2c8226108885bf019655c4159cf26b59/src/node.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -5,6 +5,16 @@ |
|  |  | #include "node.h" |
|  |  | #include "syntax\_extension.h" |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Expensive safety checks are off by default, but can be enabled |
|  |  | \* by calling cmark\_enable\_safety\_checks(). |
|  |  | \*/ |
|  |  | static bool enable\_safety\_checks = false; |
|  |  |  |
|  |  | void cmark\_enable\_safety\_checks(bool enable) { |
|  |  | enable\_safety\_checks = enable; |
|  |  | } |
|  |  |  |
|  |  | static void S\_node\_unlink(cmark\_node \*node); |
|  |  |  |
|  |  | #define NODE\_MEM(node) cmark\_node\_mem(node) |
| Expand Down  Expand Up | | @@ -70,23 +80,23 @@ bool cmark\_node\_can\_contain\_type(cmark\_node \*node, cmark\_node\_type child\_type) { |
|  |  | } |
|  |  |  |
|  |  | static bool S\_can\_contain(cmark\_node \*node, cmark\_node \*child) { |
|  |  | cmark\_node \*cur; |
|  |  |  |
|  |  | if (node == NULL || child == NULL) { |
|  |  | return false; |
|  |  | } |
|  |  | if (NODE\_MEM(node) != NODE\_MEM(child)) { |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | // Verify that child is not an ancestor of node or equal to node. |
|  |  | cur = node; |
|  |  | do { |
|  |  | if (cur == child) { |
|  |  | return false; |
|  |  | } |
|  |  | cur = cur->parent; |
|  |  | } while (cur != NULL); |
|  |  | if (enable\_safety\_checks) { |
|  |  | // Verify that child is not an ancestor of node or equal to node. |
|  |  | cmark\_node \*cur = node; |
|  |  | do { |
|  |  | if (cur == child) { |
|  |  | return false; |
|  |  | } |
|  |  | cur = cur->parent; |
|  |  | } while (cur != NULL); |
|  |  | } |
|  |  |  |
|  |  | return cmark\_node\_can\_contain\_type(node, (cmark\_node\_type) child->type); |
|  |  | } |
| Expand Down | |  |

14 changes: 11 additions & 3 deletions

14
[src/node.h](#diff-7c19dd5fd5584cd4a8111f4c82a9f49f4aa1bdb9470ad11daa90f3d394a23b4e "src/node.h")

Show comments

[View file](/github/cmark-gfm/blob/2300c1bd2c8226108885bf019655c4159cf26b59/src/node.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -50,12 +50,13 @@ typedef struct { |
|  |  |  |
|  |  | enum cmark\_node\_\_internal\_flags { |
|  |  | CMARK\_NODE\_\_OPEN = (1 << 0), |
|  |  | CMARK\_NODE\_\_LAST\_LINE\_BLANK = (1 << 1), |
|  |  | CMARK\_NODE\_\_LAST\_LINE\_CHECKED = (1 << 2), |
|  |  | CMARK\_NODE\_\_OPEN\_BLOCK = (1 << 1), |
|  |  | CMARK\_NODE\_\_LAST\_LINE\_BLANK = (1 << 2), |
|  |  | CMARK\_NODE\_\_LAST\_LINE\_CHECKED = (1 << 3), |
|  |  |  |
|  |  | // Extensions can register custom flags by calling `cmark\_register\_node\_flag`. |
|  |  | // This is the starting value for the custom flags. |
|  |  | CMARK\_NODE\_\_REGISTER\_FIRST = (1 << 3), |
|  |  | CMARK\_NODE\_\_REGISTER\_FIRST = (1 << 4), |
|  |  | }; |
|  |  |  |
|  |  | typedef uint16\_t cmark\_node\_internal\_flags; |
| Expand Down  Expand Up | | @@ -144,6 +145,13 @@ static CMARK\_INLINE bool CMARK\_NODE\_INLINE\_P(cmark\_node \*node) { |
|  |  |  |
|  |  | CMARK\_GFM\_EXPORT bool cmark\_node\_can\_contain\_type(cmark\_node \*node, cmark\_node\_type child\_type); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Enable (or disable) extra safety checks. These extra checks cause |
|  |  | \* extra performance overhead (in some cases quadratic), so they are only |
|  |  | \* intended to be used during testing. |
|  |  | \*/ |
|  |  | CMARK\_GFM\_EXPORT void cmark\_enable\_safety\_checks(bool enable); |
|  |  |  |
|  |  | #ifdef \_\_cplusplus |
|  |  | } |
|  |  | #endif |
| Expand Down | |  |

39 changes: 39 additions & 0 deletions

39
[src/parser.h](#diff-613ded7e24c817a4580bc8519193bebe7cf9aafc49cf68f5b84fea2797bb219c "src/parser.h")

Show comments

[View file](/github/cmark-gfm/blob/2300c1bd2c8226108885bf019655c4159cf26b59/src/parser.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -50,8 +50,47 @@ struct cmark\_parser { |
|  |  | cmark\_llist \*syntax\_extensions; |
|  |  | cmark\_llist \*inline\_syntax\_extensions; |
|  |  | cmark\_ispunct\_func backslash\_ispunct; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* The "open" blocks are the blocks visited by the loop in |
|  |  | \* check\_open\_blocks (blocks.c). I.e. the blocks in this list: |
|  |  | \* |
|  |  | \* parser->root->last\_child->...->last\_child |
|  |  | \* |
|  |  | \* open\_block\_counts is used to keep track of how many of each type of |
|  |  | \* node are currently in the open blocks list. Knowing these counts can |
|  |  | \* sometimes help to end the loop in check\_open\_blocks early, improving |
|  |  | \* efficiency. |
|  |  | \* |
|  |  | \* The count is stored at this offset: type - CMARK\_NODE\_TYPE\_BLOCK - 1 |
|  |  | \* For example, CMARK\_NODE\_LIST (0x8003) is stored at offset 2. |
|  |  | \*/ |
|  |  | size\_t open\_block\_counts[CMARK\_NODE\_TYPE\_BLOCK\_LIMIT]; |
|  |  | size\_t total\_open\_blocks; |
|  |  | }; |
|  |  |  |
|  |  | static CMARK\_INLINE void incr\_open\_block\_count(cmark\_parser \*parser, cmark\_node\_type type) { |
|  |  | assert(type > CMARK\_NODE\_TYPE\_BLOCK); |
|  |  | assert(type <= CMARK\_NODE\_TYPE\_BLOCK + CMARK\_NODE\_TYPE\_BLOCK\_LIMIT); |
|  |  | parser->open\_block\_counts[type - CMARK\_NODE\_TYPE\_BLOCK - 1]++; |
|  |  | parser->total\_open\_blocks++; |
|  |  | } |
|  |  |  |
|  |  | static CMARK\_INLINE void decr\_open\_block\_count(cmark\_parser \*parser, cmark\_node\_type type) { |
|  |  | assert(type > CMARK\_NODE\_TYPE\_BLOCK); |
|  |  | assert(type <= CMARK\_NODE\_TYPE\_BLOCK + CMARK\_NODE\_TYPE\_BLOCK\_LIMIT); |
|  |  | assert(parser->open\_block\_counts[type - CMARK\_NODE\_TYPE\_BLOCK - 1] > 0); |
|  |  | parser->open\_block\_counts[type - CMARK\_NODE\_TYPE\_BLOCK - 1]--; |
|  |  | assert(parser->total\_open\_blocks > 0); |
|  |  | parser->total\_open\_blocks--; |
|  |  | } |
|  |  |  |
|  |  | static CMARK\_INLINE size\_t read\_open\_block\_count(cmark\_parser \*parser, cmark\_node\_type type) { |
|  |  | assert(type > CMARK\_NODE\_TYPE\_BLOCK); |
|  |  | assert(type <= CMARK\_NODE\_TYPE\_BLOCK + CMARK\_NODE\_TYPE\_BLOCK\_LIMIT); |
|  |  | return parser->open\_block\_counts[type - CMARK\_NODE\_TYPE\_BLOCK - 1]; |
|  |  | } |
|  |  |  |
|  |  | #ifdef \_\_cplusplus |
|  |  | } |
|  |  | #endif |
| Expand Down | |  |

5 changes: 4 additions & 1 deletion

5
[src/syntax\_extension.c](#diff-2a10f109b9d7ddd2abeaa6358d4ec78d871249619444fee008573d5c7ecaf90a "src/syntax_extension.c")

Show comments

[View file](/github/cmark-gfm/blob/2300c1bd2c8226108885bf019655c4159cf26b59/src/syntax_extension.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,7 +29,10 @@ cmark\_syntax\_extension \*cmark\_syntax\_extension\_new(const char \*name) { |
|  |  | cmark\_node\_type cmark\_syntax\_extension\_add\_node(int is\_inline) { |
|  |  | cmark\_node\_type \*ref = !is\_inline ? &CMARK\_NODE\_LAST\_BLOCK : &CMARK\_NODE\_LAST\_INLINE; |
|  |  |  |
|  |  | if ((\*ref & CMARK\_NODE\_VALUE\_MASK) == CMARK\_NODE\_VALUE\_MASK) { |
|  |  | if ((\*ref & CMARK\_NODE\_VALUE\_MASK) >= CMARK\_NODE\_TYPE\_BLOCK\_LIMIT) { |
|  |  | // This assertion will fail if you try to register more extensions than |
|  |  | // are currently allowed by CMARK\_NODE\_TYPE\_BLOCK\_MAXNUM. Try increasing |
|  |  | // the limit. |
|  |  | assert(false); |
|  |  | return (cmark\_node\_type) 0; |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2300c1b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgithub%2Fcmark-gfm%2Fcommit%2F2300c1bd2c8226108885bf019655c4159cf26b59) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


