=== Content from github.com_e68274c0_20250114_230231.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funpoly%2Funpoly-rails%2F)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funpoly%2Funpoly-rails%2F)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=unpoly%2Funpoly-rails)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unpoly](/unpoly)
/
**[unpoly-rails](/unpoly/unpoly-rails)**
Public

* [Notifications](/login?return_to=%2Funpoly%2Funpoly-rails) You must be signed in to change notification settings
* [Fork
  5](/login?return_to=%2Funpoly%2Funpoly-rails)
* [Star
   18](/login?return_to=%2Funpoly%2Funpoly-rails)

Ruby on Rails bindings for Unpoly

### License

[MIT license](/unpoly/unpoly-rails/blob/master/LICENSE)

[18
stars](/unpoly/unpoly-rails/stargazers) [5
forks](/unpoly/unpoly-rails/forks) [Branches](/unpoly/unpoly-rails/branches) [Tags](/unpoly/unpoly-rails/tags) [Activity](/unpoly/unpoly-rails/activity)
 [Star](/login?return_to=%2Funpoly%2Funpoly-rails)

 [Notifications](/login?return_to=%2Funpoly%2Funpoly-rails) You must be signed in to change notification settings

* [Code](/unpoly/unpoly-rails)
* [Issues
  0](/unpoly/unpoly-rails/issues)
* [Pull requests
  0](/unpoly/unpoly-rails/pulls)
* [Actions](/unpoly/unpoly-rails/actions)
* [Projects
  0](/unpoly/unpoly-rails/projects)
* [Security](/unpoly/unpoly-rails/security)
* [Insights](/unpoly/unpoly-rails/pulse)

Additional navigation options

* [Code](/unpoly/unpoly-rails)
* [Issues](/unpoly/unpoly-rails/issues)
* [Pull requests](/unpoly/unpoly-rails/pulls)
* [Actions](/unpoly/unpoly-rails/actions)
* [Projects](/unpoly/unpoly-rails/projects)
* [Security](/unpoly/unpoly-rails/security)
* [Insights](/unpoly/unpoly-rails/pulse)

# unpoly/unpoly-rails

    master[Branches](/unpoly/unpoly-rails/branches)[Tags](/unpoly/unpoly-rails/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[101 Commits](/unpoly/unpoly-rails/commits/master/) | | |
| [assets](/unpoly/unpoly-rails/tree/master/assets "assets") | | [assets](/unpoly/unpoly-rails/tree/master/assets "assets") |  |  |
| [lib](/unpoly/unpoly-rails/tree/master/lib "lib") | | [lib](/unpoly/unpoly-rails/tree/master/lib "lib") |  |  |
| [spec](/unpoly/unpoly-rails/tree/master/spec "spec") | | [spec](/unpoly/unpoly-rails/tree/master/spec "spec") |  |  |
| [.gitignore](/unpoly/unpoly-rails/blob/master/.gitignore ".gitignore") | | [.gitignore](/unpoly/unpoly-rails/blob/master/.gitignore ".gitignore") |  |  |
| [.rspec](/unpoly/unpoly-rails/blob/master/.rspec ".rspec") | | [.rspec](/unpoly/unpoly-rails/blob/master/.rspec ".rspec") |  |  |
| [.ruby-version](/unpoly/unpoly-rails/blob/master/.ruby-version ".ruby-version") | | [.ruby-version](/unpoly/unpoly-rails/blob/master/.ruby-version ".ruby-version") |  |  |
| [.yardopts](/unpoly/unpoly-rails/blob/master/.yardopts ".yardopts") | | [.yardopts](/unpoly/unpoly-rails/blob/master/.yardopts ".yardopts") |  |  |
| [Gemfile](/unpoly/unpoly-rails/blob/master/Gemfile "Gemfile") | | [Gemfile](/unpoly/unpoly-rails/blob/master/Gemfile "Gemfile") |  |  |
| [Gemfile.lock](/unpoly/unpoly-rails/blob/master/Gemfile.lock "Gemfile.lock") | | [Gemfile.lock](/unpoly/unpoly-rails/blob/master/Gemfile.lock "Gemfile.lock") |  |  |
| [LICENSE](/unpoly/unpoly-rails/blob/master/LICENSE "LICENSE") | | [LICENSE](/unpoly/unpoly-rails/blob/master/LICENSE "LICENSE") |  |  |
| [README.md](/unpoly/unpoly-rails/blob/master/README.md "README.md") | | [README.md](/unpoly/unpoly-rails/blob/master/README.md "README.md") |  |  |
| [Rakefile](/unpoly/unpoly-rails/blob/master/Rakefile "Rakefile") | | [Rakefile](/unpoly/unpoly-rails/blob/master/Rakefile "Rakefile") |  |  |
| [unpoly-rails.gemspec](/unpoly/unpoly-rails/blob/master/unpoly-rails.gemspec "unpoly-rails.gemspec") | | [unpoly-rails.gemspec](/unpoly/unpoly-rails/blob/master/unpoly-rails.gemspec "unpoly-rails.gemspec") |  |  |
| View all files | | |

## Repository files navigation

* README
* MIT license
# unpoly-rails: Ruby on Rails bindings for Unpoly

[Unpoly](https://unpoly.com) is an [unobtrusive JavaScript](https://en.wikipedia.org/wiki/Unobtrusive_JavaScript) framework for server-side web applications.

The `unpoly-rails` gem helps integrating Unpoly with [Ruby on Rails](https://rubyonrails.org/) applications.

This branch tracks the next major version, Unpoly **3.x**.

If you're using Unpoly **2.x**, use the [`2.x-stable`](https://github.com/unpoly/unpoly-rails/tree/2.x-stable) branch.

If you're using Unpoly **1.x** or **0.x**, use the [`1.x-stable`](https://github.com/unpoly/unpoly/tree/1.x-stable/lib/unpoly/rails) branch in the [`unpoly`](https://github.com/unpoly/unpoly-rails/tree/2.x-stable) repository.

## Installing the gem

Add the following line to your `Gemfile`:

```
gem 'unpoly-rails'
```

Now run `bundle install` and restart your development server.

## Installing frontend assets

### With esbuild or Webpacker

If you're using [esbuild](https://esbuild.github.io/) or [Webpacker](https://edgeguides.rubyonrails.org/webpacker.html), install the [`unpoly` npm package](https://unpoly.com/install/npm) to get Unpoly's frontend files.

Now `import` Unpoly from your `application.js` pack:

```
import 'unpoly/unpoly.js'
import 'unpoly/unpoly.css'
```

You may need to import [additional files](https://unpoly.com/install), e.g. when migrating from an old Unpoly version.

### With the Asset Pipeline

If you're using the [Asset Pipeline](https://guides.rubyonrails.org/asset_pipeline.html), this `unpoly-rails` gem also contains Unpoly's frontend files. The files are automatically added to the Asset Pipeline's [search path](https://guides.rubyonrails.org/asset_pipeline.html#search-paths).

Add the following line to your `application.js` manifest:

```
//= require unpoly
```

Also add the following line to your `application.css` manifest:

```
/*
 *= require unpoly
 */
```

You may need to require [additional files](https://unpoly.com/install), e.g. when migrating from an old Unpoly version.

## Server protocol helpers

This `unpoly-rails` gem implements the [optional server protocol](https://unpoly.com/up.protocol) by providing the following helper methods to your controllers, views and helpers.

### Detecting a fragment update

Use `up?` to test whether the current request is a [fragment update](https://unpoly.com/up.link):

```
up? # => true or false
```

To retrieve the CSS selector that is being [updated](https://unpoly.com/up.link), use `up.target`:

```
up.target # => '.content'
```

The Unpoly frontend will expect an HTML response containing an element that matches this selector. Your Rails app is free to render a smaller response that only contains HTML matching the targeted selector. You may call `up.target?` to test whether a given CSS selector has been targeted:

```
if up.target?('.sidebar')
  render('expensive_sidebar_partial')
end
```

Fragment updates may target different selectors for successful (HTTP status `200 OK`) and failed (status `4xx` or `5xx`) responses.
Use these methods to inspect the target for failed responses:

* `up.fail_target`: The CSS selector targeted for a failed response
* `up.fail_target?(selector)`: Whether the given selector is targeted for a failed response
* `up.any_target?(selector)`: Whether the given selector is targeted for either a successful or a failed response

### Changing the render target

The server may instruct the frontend to render a different target by assigning a new CSS selector to the `up.target` property:

```
unless signed_in?
  up.target = 'body'
  render 'sign_in'
end
```

The frontend will use the server-provided target for both successful (HTTP status `200 OK`) and failed (status `4xx` or `5xx`) responses.

### Rendering nothing

Sometimes it's OK to render nothing, e.g. when you know that the current layer is to be closed.

In this case use `head(:no_content)`:

```
class NotesController < ApplicationController
  def create
    @note = Note.new(note_params)
    if @note.save
      if up.layer.overlay?
        up.layer.accept(@note.id)
        head :no_content
      else
        redirect_to @note
      end
    end
  end
end
```

### Pushing a document title to the client

To force Unpoly to set a document title when processing the response:

```
up.title = 'Title from server'
```

This is useful when you skip rendering the `<head>` in an Unpoly request.

### Emitting events on the frontend

You may use `up.emit` to emit an event on the `document` after the
fragment was updated:

```
class UsersController < ApplicationController

  def show
    @user = User.find(params[:id])
    up.emit('user:selected', id: @user.id)
  end

end
```

If you wish to emit an event on the current [layer](https://unpoly.com/up.layer)
instead of the `document`, use `up.layer.emit`:

```
class UsersController < ApplicationController

  def show
    @user = User.find(params[:id])
    up.layer.emit('user:selected', id: @user.id)
  end

end
```

### Detecting an Unpoly form validation

To test whether the current request is a [form validation](https://unpoly.com/input-up-validate):

```
up.validate?
```

When detecting a validation request, the server is expected to validate (but not save) the form submission and render a new copy of the form with validation errors. A typical saving action should behave like this:

```
class UsersController < ApplicationController

  def create
    user_params = params[:user].permit(:email, :password)
    @user = User.new(user_params)
    if up.validate?
      @user.valid?  # run validations, but don't save to the database
      render 'form' # render form with error messages
    elsif @user.save?
      sign_in @user
    else
      render 'form', status: :bad_request
    end
  end

end
```

You may also access the [names of the fields that triggered the validation request](https://unpoly.com/X-Up-Validate):

```
up.validate_names # => ['email', 'password']
```

You may also test if a given field name is being validated:

```
up.validate_name?('email') # => true
```

### Detecting a fragment reload

When Unpoly [reloads](https://unpoly.com/up.reload) or [polls](https://unpoly.com/up-poll) a fragment, the server will often render the same HTML. You can configure your controller actions to only render HTML if the underlying content changed since an earlier request.

Only rendering when needed saves **CPU time** on your server, which spends most of its response time rendering HTML. This also reduces the **bandwidth cost** for a request/response exchange to **~1 KB**.

When a fragment is reloaded, Unpoly sends an [`If-Modified-Since`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-Modified-Since) request header with the fragment's earlier [`Last-Modified`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified) time. It also sends an [`If-None-Match`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match) header with the fragment's earlier [`ETag`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag).

Rails' [conditional GET support](https://guides.rubyonrails.org/caching_with_rails.html#conditional-get-support) lets you compare and set modification times and ETags with methods like `#fresh_when` or `#stale?`:

```
class MessagesController < ApplicationController

  def index
    @messages = current_user.messages.order(time: :desc)

    # If the request's ETag and last modification time matches the given `@messages`,
    # does not render and send a a `304 Not Modified` response.
    # If the request's ETag or last modification time does not match, we will render
    # the `index` view with fresh `ETag` and `Last-Modified` headers.
    fresh_when(@messages)
  end

end
```

### Allowing callbacks with a strict CSP

When your Content Security Policy disallows `eval()`, Unpoly cannot directly run callbacks HTML attributes. This affects `[up-]` attributes like `[up-on-loaded]` or `[up-on-accepted]`. See [Unpoly's CSP guide](https://unpoly.com/csp) for details.

The following callback would crash the fragment update with an error like `Uncaught EvalError: call to Function() blocked by CSP`:

```
link_to 'Click me', '/path, 'up-follow': true, 'up-on-loaded': "alert()"
```

Unpoly lets your work around this by prefixing your callback with your response's [CSP nonce](https://content-security-policy.com/nonce/):

```
link_to 'Click me', '/path', 'up-follow': true, 'up-on-loaded': 'nonce-kO52Iphm8BAVrcdGcNYjIA== alert()')
```

To keep your callbacks compact, you may use the `up.safe_callback` helper for this:

```
link_to 'Click me', '/path, 'up-follow': true, 'up-on-loaded': up.safe_callback("alert()")
```

For this to work you must also include the `<meta name="csp-nonce">` tag in the `<head>` of your initial page. Rails has a [`csp_meta_tag`](https://api.rubyonrails.org/classes/ActionView/Helpers/CspHelper.html#method-i-csp_meta_tag) helper for that purpose.

Note

Prefixing nonces only works for `[up-on...]` attributes. You cannot use it for native HTML attributes like `[onclick]`.

### Working with context

Calling `up.context` will return the [context](https://unpoly.com/up.context) object of the targeted layer.

The context is a JSON object shared between the frontend and the server.
It persists for a series of Unpoly navigation, but is cleared when the user makes a full page load.
Different Unpoly [layers](https://unpoly.com/up.layer) will usually have separate context objects,
although layers may choose to share their context scope.

You may read and change the context object. Changes will be sent to the frontend with your response.

```
class GamesController < ApplicationController

  def restart
    up.context[:lives] = 3
    render 'stage1'
  end

end
```

Keys can be accessed as either strings or symbols:

```
puts "You have " + up.layer.context[:lives] + " lives left"
puts "You have " + up.layer.context['lives'] + " lives left"
```

You may delete a key from the frontend by calling `up.context.delete`:

```
up.context.delete(:foo)
```

You may replace the entire context by calling `up.context.replace`:

```
context_from_file = JSON.parse(File.read('context.json))
up.context.replace(context_from_file)
```

`up.context` is an alias for `up.layer.context`.

### Accessing the targeted layer

Use the methods below to interact with the [layer](/unpoly/unpoly-rails/blob/master/up.layer) of the fragment being targeted.

Note that fragment updates may target different layers for successful (HTTP status `200 OK`) and failed (status `4xx` or `5xx`) responses.

#### `up.layer.mode`

Returns the [mode](https://unpoly.com/up.layer.mode) of the targeted layer (e.g. `"root"` or `"modal"`).

#### `up.layer.root?`

Returns whether the targeted layer is the root layer.

#### `up.layer.overlay?`

Returns whether the targeted layer is an overlay (not the root layer).

#### `up.layer.context`

Returns the [context](https://unpoly.com/up.context) object of the targeted layer.
See documentation for `up.context`, which is an alias for `up.layer.context`.

#### `up.layer.accept(value)`

[Accepts](https://unpoly.com/up.layer.accept) the current overlay.

Does nothing if the root layer is targeted.

Note that Rails expects every controller action to render or redirect.
Your action should either call `up.render_nothing` or respond with `text/html` content matching the requested target.

#### `up.layer.dismiss(value)`

[Dismisses](https://unpoly.com/up.layer.dismisses) the current overlay.

Does nothing if the root layer is targeted.

Note that Rails expects every controller action to render or redirect.
Your action should either call `up.render_nothing` or respond with `text/html` content matching the requested target.

#### `up.layer.emit(type, options)`

[Emits an event](https://unpoly.com/up.layer.emit) on the targeted layer.

#### `up.fail_layer.mode`

Returns the [mode](https://unpoly.com/up.layer.mode) of the layer targeted for a failed response.

#### `up.fail_layer.root?`

Returns whether the layer targeted for a failed response is the root layer.

#### `up.fail_layer.overlay?`

Returns whether the layer targeted for a failed response is an overlay.

#### `up.fail_layer.context`

Returns the [context](https://unpoly.com/up.context) object of the layer targeted for a failed response.

### Expiring the client-side cache

The Unpoly frontend [caches server responses](https://unpoly.com/caching) for a few minutes, making requests to these URLs return instantly.
Only `GET` requests are cached. The entire cache is expired after every non-`GET` request (like `POST` or `PUT`).

The server may override these defaults. For instance, the server can expire Unpoly's client-side response cache, even for `GET` requests:

```
up.cache.expire
```

You may also expire a single URL or [URL pattern](https://unpoly.com/url-patterns):

```
up.cache.expire('/notes/*')
```

You may also prevent cache expiration for an unsafe request:

```
up.cache.expire(false)
```

Here is an longer example where the server uses careful cache management to avoid expiring too much of the client-side cache:

```
def NotesController < ApplicationController

  def create
    @note = Note.create!(params[:note].permit(...))
    if @note.save
      up.cache.expire('/notes/*') # Only expire affected entries
      redirect_to(@note)
    else
      up.cache.expire(false) # Keep the cache fresh because we haven't saved
      render 'new'
    end
  end
  ...
end
```

### Evicting pages from the client-side cache

Instead of *expiring* pages from the cache you may also *evict*. The difference is that expired pages can still be rendered instantly and are then [revalidated](/unpoly/unpoly-rails/blob/master/caching#revalidation) with the server. Evicted pages are erased from the cache.

You may also expire all entries matching an [URL pattern](https://unpoly.com/url-patterns):

To evict the entire client-side cache:

```
up.cache.evict
```

You may also evict a single URL or [URL pattern](https://unpoly.com/url-patterns):

```
up.cache.evict('/notes/*')
```

### Unpoly headers are preserved through redirects

`unpoly-rails` patches [`redirect_to`](https://api.rubyonrails.org/classes/ActionController/Redirecting.html#method-i-redirect_to)
so [Unpoly-related request and response headers](https://unpoly.com/up.protocol) are preserved for the action you redirect to.

### Accessing Unpoly request headers automatically sets a `Vary` response header

Accessing [Unpoly-related request headers](https://unpoly.com/up.protocol) through helper methods like `up.target` will automatically add a [`Vary`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Vary) response header. This is to indicate that the request header influenced the response and the response should be cached separately for each request header value.

For example, a controller may access the request's `X-Up-Mode` through the `up.layer.mode` helper:

```
def create
  # ...

  if up.layer.mode == 'modal' # Sets Vary header
    up.layer.accept
  else
    redirect_to :show
  end
end
```

`unpoly-rails` will automatically add a `Vary` header to the response:

```
Vary: X-Up-Mode
```

There are cases when reading an Unpoly request header does not necessarily influence the response, e.g. for logging. In that cases no `Vary` header should be set. To do so, call the helper method inside an `up.no_vary` block:

```
up.no_vary do
  Rails.logger.info("Unpoly mode is " + up.layer.mode.inspect) # No Vary header is set
end
```

Note that accessing `response.headers[]` directly never sets a `Vary` header:

```
Rails.logger.info("Unpoly mode is " + response.headers['X-Up-Mode']) # No Vary header is set
```

### Automatic redirect detection

`unpoly-rails` installs a [`before_action`](https://api.rubyonrails.org/classes/AbstractController/Callbacks/ClassMethods.html#method-i-before_action) into all controllers which echoes the request's URL as a response header `X-Up-Location` and the request's
HTTP method as `X-Up-Method`.

### Automatic method detection for initial page load

`unpoly-rails` sets an `_up_method` cookie that Unpoly needs to detect the request method for the initial page load.

If the initial page was loaded with a non-`GET` HTTP method, Unpoly will fall back to full page loads for all actions that require `pushState`.

The reason for this is that some browsers remember the method of the initial page load and don't let the application change it, even with `pushState`. Thus, when the user reloads the page much later, an affected browser might request a `POST`, `PUT`, etc. instead of the correct method.

## What you still need to do manually

### Failed form submissions must return a non-200 status code

Unpoly lets you submit forms via AJAX by using the [`form[up-submit]`](https://unpoly.com/form-up-submit) selector or [`up.submit()`](https://unpoly.com/up.submit) function.

For Unpoly to be able to detect a failed form submission,
the form must be re-rendered with a non-200 HTTP status code.
We recommend to use either 400 (bad request) or 422 (unprocessable entity).

To do so in Rails, pass a [`:status` option to `render`](http://guides.rubyonrails.org/layouts_and_rendering.html#the-status-option):

```
class UsersController < ApplicationController

  def create
    user_params = params[:user].permit(:email, :password)
    @user = User.new(user_params)
    if @user.save?
      sign_in @user
    else
      render 'form', status: :bad_request
    end
  end

end
```

## Development

### Before you make a PR

Before you create a pull request, please have some discussion about the proposed change by [opening an issue on GitHub](https://github.com/unpoly/unpoly/issues/new).

### Running tests

* Install the Ruby version from `.ruby-version` (currently 2.3.8)
* Install Bundler by running `gem install bundler`
* Install dependencies by running `bundle install`
* Run `bundle exec rspec`

The tests run against a minimal Rails app that lives in `spec/dummy`.

### Making a new release

Install the `unpoly-rails` and [`unpoly`](https://github.com/unpoly/unpoly) repositories into the same parent folder:

```
projects/
  unpoly/
  unpoly-rails/

```

During development `unpoly-rails` will use assets from the folder `assets/unpoly-dev`, which is symlinked against the `dist` folder of the ``unpoly` repo.

Before packaging the gem, a rake task will copy symlinked files `assets/unpoly-dev/*` to `assets/unpoly/*`. The latter is packaged into the gem and distributed.

```
projects/
  unpoly/
    dist/
      unpoly.js
      unpoly.css
  unpoly-rails
    assets/
      unpoly-dev   -> ../../unpoly/dist
        unpoly.js  -> ../../unpoly/dist/unpoly.js
        unpoly.css -> ../../unpoly/dist/unpoly.css
      unpoly
        unpoly.js
        unpoly.css

```

Making a new release of `unpoly-rails` involves the following steps:

* Make a new build of unpoly (`npm run build`)
* Make a new release of the unpoly npm package
* Bump the version in `lib/unpoly/rails/version.rb` to match that in Unpoly's `package.json`
* Commit and push the changes
* Run `rake gem:release`

## About

Ruby on Rails bindings for Unpoly

### Resources

[Readme](#readme-ov-file)
### License

[MIT license](#MIT-1-ov-file)

[Activity](/unpoly/unpoly-rails/activity)
[Custom properties](/unpoly/unpoly-rails/custom-properties)
### Stars

[**18**
stars](/unpoly/unpoly-rails/stargazers)
### Watchers

[**3**
watching](/unpoly/unpoly-rails/watchers)
### Forks

[**5**
forks](/unpoly/unpoly-rails/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Funpoly%2Funpoly-rails&report=unpoly+%28user%29)

## [Releases](/unpoly/unpoly-rails/releases)

[53
tags](/unpoly/unpoly-rails/tags)

## [Packages 0](/orgs/unpoly/packages?repo_name=unpoly-rails)

No packages published

## [Contributors 5](/unpoly/unpoly-rails/graphs/contributors)

## Languages

* [Ruby
  99.9%](/unpoly/unpoly-rails/search?l=ruby)
* [JavaScript
  0.1%](/unpoly/unpoly-rails/search?l=javascript)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from makandracards.com_a5f953f8_20250114_230236.html ===

[![brand image](/assets/settings/company_makandra-16ef9535c5fca3c02d8e9b0fd7147e19ca8b3df18b0a73a839c25e24f0dd95ef.svg)cards](/)
[Decks](/sites)

[makandra Operations](/operations)

[Sign in](/session/new)
[Sign up](/users/new)

[Menu](/sites/menu?site_id=operations)

Query

[Help](/search_help)
136 cards

* [←](/operations?page=2)
* [1](/operations?page=1)
* [2](/operations?page=2)
* 3
* [4](/operations?page=4)
* [5](/operations?page=5)
* [6](/operations?page=6)
* [→](/operations?page=4)

[View](/operations/views?note_id=537537-nginx-proxy-buffer-tuning)

[SSH add/remove port forwarding to active session](/operations/575553-ssh-add-remove-port-forwarding-active-session)

Marc Dierig
1 year

[HowTo: List packages in an apt repository](/operations/559829-howto-list-packages-apt-repository)

Emma Heinle
1 year

[Don't use flock with GlusterFS](/operations/557524-flock-glusterfs)

Kim Klotz
1 year

[HowTo: Curl applications that are usually behind reverse proxies with TLS termination without the application redirecting to https schema](/operations/547304-howto-curl-applications-usually-behind-reverse-proxies)

Emma Heinle
1 year

[Parameter naming and checking in shell script](/operations/546171-parameter-naming-checking-script)

Moritz Kraus
1 year

[Get information about current running passenger processes](/operations/49204-get-information-current-running-passenger-processes)

Claus-Theodor Riegg
6 years

[Use Terraform grouping mode like Golang's Ellipsis expression](/operations/541333-terraform-grouping-mode-like-golangs-ellipsis-expression)

Claus-Theodor Riegg
1 year

[Get a more colorful output for man pages](/operations/541175-get-colorful-output-man-pages)

Claus-Theodor Riegg
1 year

[Nginx Proxy buffer tuning](/operations/537537-nginx-proxy-buffer-tuning)

Moritz Kraus
1 year

[Fix Imagemagick CVE-2022-44268 in Ubuntu packages](/operations/532974-fix-imagemagick-cve-2022-44268-ubuntu-packages)

Kim Klotz
1 year

[Check JVM settings of running java process](/operations/531812-check-jvm-settings-running-java-process)

Claus-Theodor Riegg
1 year

[Parsing multiline container logs with fluent-bit](/operations/531768-parsing-multiline-container-logs-fluent-bit)

Claus-Theodor Riegg
1 year

[Delete specific Redis-DBs](/operations/530893-delete-specific-redis-dbs)

Stefan Xenopol
1 year

[Desktop notification for failed systemd user services](/operations/529660-desktop-notification-failed-systemd-user-services)

Andreas Vöst
2 years

[Measure HTTP Connection times (TTFB) with curl](/operations/528263-measure-http-connection-times-ttfb-curl)

Kim Klotz
2 years

[Root-account tries to access mariadb-database regularly](/operations/528229-root-account-tries-access-mariadb-database-regularly)

Stefan Xenopol
2 years

[FAQ for When PostgreSQL Indexes Are Corrupted After Locale Changes](/operations/528079-faq-postgresql-indexes-corrupted-locale-changes)

Emma Heinle
2 years

[Mind your locales with glibc upgrades when using PostgreSQL](/operations/528030-mind-locales-glibc-upgrades-postgresql)

Emma Heinle
2 years

[How to prevent duplicate exported resources across a Puppet Infrastructure](/operations/527063-prevent-duplicate-exported-resources-across-puppet)

Moritz Kraus
2 years

[When to use a function over a defined in Puppet](/operations/527062-function-defined-puppet)

Moritz Kraus
2 years

[Create gitlab container expiry config in every repo in a group](/operations/526968-create-gitlab-container-expiry-config-every-repo-group)

Claus-Theodor Riegg
2 years

[MySQL client: Double check the used character set with utf8mb4](/operations/526916-mysql-client-double-check-used-character-set-utf8mb4)

Andreas Vöst
2 years

[Why doesn't my prometheus relabel\_config work?](/operations/526084-prometheus-relabel-config-work)

Claus-Theodor Riegg
2 years

[load balance unix sockets to UDP destinations](/operations/523483-load-balance-unix-sockets-udp-destinations)

Moritz Kraus
2 years

# Nginx Proxy buffer tuning

Updated 2023-03-30. Posted 2023-03-09. Visible to the public.

When a nginx reverse proxy complains about upstreams sending too big headers, tweaking the buffers responsibly can help to prevent this issue.

Example log message:

```
Copyupstream sent too big header while reading response header from upstream, client: 192.0.2.100, server: localhost, request: "GET /index.html HTTP/1.1", upstream: "http://198.51.100.123:80/index.html", host: "192.0.2.10:80"

```
## The cause

This behaviour was caused by an application that transforms parts of the query from the URL into a response header. If the query in the HTTP request was stuffed with a lot of fuzzy data, the response header rendered too big for the Nginx proxy to handle, resulting in a HTTP 503.

Due to the error, Nginx marks the upstream server as down for as long as `fail_timeout` is set to. When enough requests of this kind were sent, all backends were marked down.

So let's increase the size allowed for the headers and we are good, are we? But what parameter do we have to tune and which valued do we use?

### Buffer size

The size of the overall proxy buffer is set by `proxy_buffers`. By default Nginx uses eight memory pages. This defaults to `8 * 4k = 32k` on a system with a page size of 4k.

![Illustration UI/UX Design](/assets/ad_design_ui_ux-3ca31623683810fbe9460ae030737cd97751d03e73a26efe46a90f524e8ed18e.svg)
#### UI/UX Design by makandra brand

We make sure that your target audience has the best possible experience with your digital product. You get:

* Design tailored to your audience
* Proven processes customized to your needs
* An expert team of experienced designers

[Read more](https://makandra.com/user-experience)

### Header buffer size

The buffer for the headers are set by `proxy_buffer_size` and count against the overall buffer size. The default is one page.

### Maximum buffer usage

To limit the amount of buffer which is used to send data to the client is `proxy_busy_buffer_size` set to determine this limit. The default are two pages. This value includes the header buffers.

There are two rules affecting the min and max values of `proxy_busy_buffer_size`:

* the minimum equals to `proxy_buffer_size`
* the maximum is `proxy_buffers` minus one page

![Image](/operations/537537/attachments/30717)

### Maximum URI size

In Nginx the maximum length of the URI is determined by the size of *one* `large_client_header_buffers` since there is stored one line per request in this buffers. The default here is 8k. Larger request are rejected with 313 Request URI Too Large

## The solution

Since the maximum URI is 8k maximum, the response headers with the information from the URI can be 8k plus the other response headers. Adding a safety margin of 8k to the header buffer enables buffering of a whole line from the request with enough space to fit the regular response headers in.

Here are the required changes on a system with 4k pagesize:

* add two pages to `proxy_buffers`
* add two pages to `proxy_buffer_size`
* shift `proxy_busy_buffer_size` by two pages

```
Copyproxy_buffers 10 4k;
proxy_buffer_size 12k;
proxy_busy_buffers_size 16k;

```

[nginx\_buffers.drawio.png](/operations/537537-nginx-proxy-buffer-tuning/attachments/30717)

![](https://www.gravatar.com/avatar.php?gravatar_id=62f9822a7f68cce0c11a2f286a681631&size=250)
Moritz Kraus
[Say thanks](/operations/537537-nginx-proxy-buffer-tuning/tributes)5

Last edit

2023-03-30

Moritz Kraus

Attachments

[nginx\_buffers.drawio.png](/operations/537537-nginx-proxy-buffer-tuning/attachments/30717)

License
Source code in this card is licensed under the
[MIT License](/operations/537537-nginx-proxy-buffer-tuning/license).

[Privacy policy](/privacy_policy)
[Terms of service](/terms_of_service)
[Imprint](/imprint)

This website uses short-lived cookies to improve usability.

Accept

or

[learn more](/privacy_policy#cookies)



=== Content from github.com_148fb6fb_20250114_230233.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funpoly%2Funpoly-rails%2Fcommit%2Fcd9ad0007daceeb3b2354fdcab4f88350427bf16)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funpoly%2Funpoly-rails%2Fcommit%2Fcd9ad0007daceeb3b2354fdcab4f88350427bf16)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=unpoly%2Funpoly-rails)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unpoly](/unpoly)
/
**[unpoly-rails](/unpoly/unpoly-rails)**
Public

* [Notifications](/login?return_to=%2Funpoly%2Funpoly-rails) You must be signed in to change notification settings
* [Fork
  5](/login?return_to=%2Funpoly%2Funpoly-rails)
* [Star
   18](/login?return_to=%2Funpoly%2Funpoly-rails)

* [Code](/unpoly/unpoly-rails)
* [Issues
  0](/unpoly/unpoly-rails/issues)
* [Pull requests
  0](/unpoly/unpoly-rails/pulls)
* [Actions](/unpoly/unpoly-rails/actions)
* [Projects
  0](/unpoly/unpoly-rails/projects)
* [Security](/unpoly/unpoly-rails/security)
* [Insights](/unpoly/unpoly-rails/pulse)

Additional navigation options

* [Code](/unpoly/unpoly-rails)
* [Issues](/unpoly/unpoly-rails/issues)
* [Pull requests](/unpoly/unpoly-rails/pulls)
* [Actions](/unpoly/unpoly-rails/actions)
* [Projects](/unpoly/unpoly-rails/projects)
* [Security](/unpoly/unpoly-rails/security)
* [Insights](/unpoly/unpoly-rails/pulse)

## Commit

[Permalink](/unpoly/unpoly-rails/commit/cd9ad0007daceeb3b2354fdcab4f88350427bf16)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Only echo the request URL as X-Up-Location if it contains query param…

[Browse files](/unpoly/unpoly-rails/tree/cd9ad0007daceeb3b2354fdcab4f88350427bf16)
Browse the repository at this point in the history

```
…s prefixed with "_up"
```

* Loading branch information

[![@triskweline](https://avatars.githubusercontent.com/u/89953?s=40&v=4)](/triskweline)

[triskweline](/unpoly/unpoly-rails/commits?author=triskweline "View all commits by triskweline")
committed
Mar 30, 2023

1 parent
[b5056b8](/unpoly/unpoly-rails/commit/b5056b898f68446d3a1cdd27e5914a9d526f3160)

commit cd9ad00

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**22 additions**
and
**21 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* lib/unpoly/rails

  + lib/unpoly/rails/request\_echo\_headers.rb
    [request\_echo\_headers.rb](#diff-f8fe906cbc73683496873128d56dd7250f455c1f0691e628a7aa4310660ef33b)
* spec/unpoly/rails

  + spec/unpoly/rails/controller\_spec.rb
    [controller\_spec.rb](#diff-f02d5d8f53af52667360cde444b0875f62538d1bba1e5e705cf36a6dc1944e49)

## There are no files selected for viewing

8 changes: 6 additions & 2 deletions

8
[lib/unpoly/rails/request\_echo\_headers.rb](#diff-f8fe906cbc73683496873128d56dd7250f455c1f0691e628a7aa4310660ef33b "lib/unpoly/rails/request_echo_headers.rb")

Show comments

[View file](/unpoly/unpoly-rails/blob/cd9ad0007daceeb3b2354fdcab4f88350427bf16/lib/unpoly/rails/request_echo_headers.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,9 +18,13 @@ def self.included(base) |
|  |  | end |
|  |  |  |
|  |  | private |
|  |  |  |
|  |  |  |
|  |  | def set\_up\_request\_echo\_headers |
|  |  | response.headers['X-Up-Location'] = up.request\_url\_without\_up\_params |
|  |  | request\_url\_without\_up\_params = up.request\_url\_without\_up\_params |
|  |  | unless request\_url\_without\_up\_params == request.original\_url |
|  |  | response.headers['X-Up-Location'] = up.request\_url\_without\_up\_params |
|  |  | end |
|  |  |  |
|  |  | response.headers['X-Up-Method'] = request.method |
|  |  | end |
|  |  |  |
| Expand Down | |  |

35 changes: 16 additions & 19 deletions

35
[spec/unpoly/rails/controller\_spec.rb](#diff-f02d5d8f53af52667360cde444b0875f62538d1bba1e5e705cf36a6dc1944e49 "spec/unpoly/rails/controller_spec.rb")

Show comments

[View file](/unpoly/unpoly-rails/blob/cd9ad0007daceeb3b2354fdcab4f88350427bf16/spec/unpoly/rails/controller_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -995,31 +995,28 @@ def controller\_eval(headers: {}, &expression) |
|  |  |  |
|  |  | describe 'echoing of the request location' do |
|  |  |  |
|  |  | it 'echoes the current path in an X-Up-Location response header' do |
|  |  | it 'does not echo the current path in an X-Up-Location response header to prevent the user-controlled request URL from exceeding the maximum response header size' do |
|  |  | get '/binding\_test/text' |
|  |  | expect(response.headers['X-Up-Location']).to end\_with('/binding\_test/text') |
|  |  | expect(response.headers['X-Up-Location']).to be\_nil |
|  |  | end |
|  |  |  |
|  |  | it 'echoes the current path after a redirect' do |
|  |  | get '/binding\_test/redirect1' |
|  |  | expect(response).to be\_redirect |
|  |  | follow\_redirect! |
|  |  | expect(response.headers['X-Up-Location']).to end\_with('/binding\_test/redirect2') |
|  |  | end |
|  |  | describe 'when the request URL contains query params prefixed with "\_up-"' do |
|  |  |  |
|  |  | it 'echoes the current path with query params' do |
|  |  | get '/binding\_test/text?foo=bar' |
|  |  | expect(response.headers['X-Up-Location']).to end\_with('/binding\_test/text?foo=bar') |
|  |  | end |
|  |  | it 'removes params prefixed with "\_up-"' do |
|  |  | get '/binding\_test/text?\_up\_1&\_up\_2=y' |
|  |  | expect(response.headers['X-Up-Location']).to end\_with('/binding\_test/text') |
|  |  | end |
|  |  |  |
|  |  | it 'removes \_up-\* params' do |
|  |  | get '/binding\_test/text?\_up\_1=x&foo=bar&\_up\_2=y' |
|  |  | expect(response.headers['X-Up-Location']).to end\_with('/binding\_test/text?foo=bar') |
|  |  | end |
|  |  | it 'keeps params not prefixed with "\_up-"' do |
|  |  | get '/binding\_test/text?\_up\_1=x&foo=bar&\_up\_2=y' |
|  |  | expect(response.headers['X-Up-Location']).to end\_with('/binding\_test/text?foo=bar') |
|  |  | end |
|  |  |  |
|  |  | it 'does not mangle array params (BUGFIX)' do |
|  |  | get '/binding\_test/text?\_up\_1=x&foo%5B%5D=bar&foo%5B%5D=qux&\_up\_location=up\_location' |
|  |  | expect(response.headers['X-Up-Location']).to end\_with('/binding\_test/text?foo%5B%5D=bar&foo%5B%5D=qux') |
|  |  | end |
|  |  |  |
|  |  | it 'does not mangle array params (BUGFIX)' do |
|  |  | get '/binding\_test/text?foo%5B%5D=bar&foo%5B%5D=qux&\_up\_location=up\_location' |
|  |  | expect(response.headers['X-Up-Location']).to end\_with('/binding\_test/text?foo%5B%5D=bar&foo%5B%5D=qux') |
|  |  | end |
|  |  |  |
|  |  | end |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `cd9ad00`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funpoly%2Funpoly-rails%2Fcommit%2Fcd9ad0007daceeb3b2354fdcab4f88350427bf16) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from unpoly.com_7334390d_20250114_230240.html ===

[![Unpoly](/images/unpoly_logo-31fe0b97.svg)](/)

[3.9](/version_choice)

[API](/api)
[Tutorial](/tutorial)
[Demo](https://demo.unpoly.com)
[Install](/install)
[Changes](/changes)
[Community](/community)
 [GitHub](https://github.com/unpoly/unpoly)
 [Twitter](https://twitter.com/unpolyjs)

 [Menu](/menu/narrow)

[Menu](/api/menu)

 [Edit this page](https://github.com/unpoly/unpoly/blob/dac87d483c3f3a3f8de740e6a6e68057ca8ededa/src/unpoly/protocol.js?plain=1#L1:L32)
# [API](/api) Server protocol module up.protocol

Unpoly has an **optional** protocol your server may implement to exchange additional information
when Unpoly is [updating fragments](/up.link). The protocol mostly works by adding
additional HTTP headers (like [`X-Up-Target`](/X-Up-Target)) to requests and responses.

> #### Important
>
> While the protocol can help you optimize performance and handle some edge cases,
> implementing it is **entirely optional**. For instance, `unpoly.com` itself is a static site
> that uses Unpoly on the frontend and doesn't even have an active server component.

#### Contents

 [Existing implementations](#existing-implementations)
 [Guides](#topics)
 [Features](#features)
## Existing implementations

You should be able to implement the protocol in a very short time.

There are existing implementations for various web frameworks:

* [Ruby on Rails](/install/ruby)
* [Roda](https://github.com/adam12/roda-unpoly)
* [Rack](https://github.com/adam12/rack-unpoly) (Sinatra, Padrino, Hanami, Cuba, â¦)
* [Phoenix](https://elixirforum.com/t/unpoly-a-framework-like-turbolinks/3614/15) (Elixir)
* [PHP](https://github.com/webstronauts/php-unpoly) (Symfony, Laravel, Stack)
* [Python](https://gitlab.com/rocketduck/python-unpoly) (Python, including Django support)

---

## Guides

* [Optimizing responses](/optimizing-responses)
* [Conditional requests](/conditional-requests)
* [Working with strict Content Security Policies](/csp)

## Features

### All features

[HTTP
ETag
stable

This response header contains a hash identifying the content in the response body.](/ETag)
[HTTP
If-Modified-Since
stable

This request header contains the last modification time of a fragment that is being reloaded.](/If-Modified-Since)
[HTTP
If-None-Match
stable

This request header contains the ETag of a fragment that is being reloaded.](/If-None-Match)
[HTTP
Last-Modified
stable

This response header contains the time when the content in the response body was last modified.](/Last-Modified)
[HTTP
\_up\_method
stable

The server may set this optional cookie to echo the HTTP method of the initial request.](/_up_method)
[JS
up.protocol.config
stable

Configures strings used in the optional server protocol.](/up.protocol.config)
[HTTP
Vary
stable

Request headers that influenced a response should be listed in a `Vary` response header.](/Vary)
[HTTP
X-Up-Accept-Layer
stable

The server may set this response header to accept the targeted overlay
in response to a fragment update.](/X-Up-Accept-Layer)
[HTTP
X-Up-Clear-Cache
deprecated

The server may send this optional response header to control which previously cached responses should be expired after this response.](/X-Up-Clear-Cache)
[HTTP
X-Up-Context

experimental

This request header contains the targeted layer's context, serialized as JSON.](/X-Up-Context)
[HTTP
X-Up-Dismiss-Layer
stable

The server may set this response header to dismiss the targeted overlay
in response to a fragment update.](/X-Up-Dismiss-Layer)
[HTTP
X-Up-Events
stable

The server may set this response header to emit events with the
requested fragment update.](/X-Up-Events)
[HTTP
X-Up-Evict-Cache
stable

The server may send this optional response header to control which previously cached
responses should be evicted after this response.](/X-Up-Evict-Cache)
[HTTP
X-Up-Expire-Cache
stable

The server may send this optional response header to control which previously cached
responses should be expired after this response.](/X-Up-Expire-Cache)
[HTTP
X-Up-Fail-Context

experimental

This request header contains the context of the layer
targeted for a failed fragment update, serialized as JSON.](/X-Up-Fail-Context)
[HTTP
X-Up-Fail-Mode
stable

This request header contains the mode of the layer
targeted for a failed fragment update.](/X-Up-Fail-Mode)
[HTTP
X-Up-Fail-Target
stable

This request header contains the target selector for a failed fragment update.](/X-Up-Fail-Target)
[HTTP
X-Up-Location
stable

The server may set this response header to set a custom browser location after a fragment update.](/X-Up-Location)
[HTTP
X-Up-Method
stable

The server may set this optional response header to change the HTTP method after a fragment update.](/X-Up-Method)
[HTTP
X-Up-Mode
stable

This request header contains the targeted layer's mode.](/X-Up-Mode)
[HTTP
X-Up-Reload-From-Time
deprecated

This request header contains a timestamp of an existing fragment that is being reloaded.](/X-Up-Reload-From-Time)
[HTTP
X-Up-Target
stable

The `X-Up-Target` request and response headers allow the server read or change
the target selector for a fragment update.](/X-Up-Target)
[HTTP
X-Up-Title
stable

The server may set this optional response header to change the document title after a fragment update.](/X-Up-Title)
[HTTP
X-Up-Validate
stable

This request header contains the names of the form fields being validated.](/X-Up-Validate)
[HTTP
X-Up-Version
stable

This request header contains the current Unpoly version to mark this request as a fragment update.](/X-Up-Version)

Made by
[Henning Koch](https://twitter.com/triskweline)

[Imprint](/imprint)

[Privacy policy](/privacy)



=== Content from github.com_7f516db1_20250114_230235.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funpoly%2Funpoly-rails%2Fsecurity%2Fadvisories%2FGHSA-m875-3xf6-mf78)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funpoly%2Funpoly-rails%2Fsecurity%2Fadvisories%2FGHSA-m875-3xf6-mf78)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=unpoly%2Funpoly-rails)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unpoly](/unpoly)
/
**[unpoly-rails](/unpoly/unpoly-rails)**
Public

* [Notifications](/login?return_to=%2Funpoly%2Funpoly-rails) You must be signed in to change notification settings
* [Fork
  5](/login?return_to=%2Funpoly%2Funpoly-rails)
* [Star
   18](/login?return_to=%2Funpoly%2Funpoly-rails)

* [Code](/unpoly/unpoly-rails)
* [Issues
  0](/unpoly/unpoly-rails/issues)
* [Pull requests
  0](/unpoly/unpoly-rails/pulls)
* [Actions](/unpoly/unpoly-rails/actions)
* [Projects
  0](/unpoly/unpoly-rails/projects)
* [Security](/unpoly/unpoly-rails/security)
* [Insights](/unpoly/unpoly-rails/pulse)

Additional navigation options

* [Code](/unpoly/unpoly-rails)
* [Issues](/unpoly/unpoly-rails/issues)
* [Pull requests](/unpoly/unpoly-rails/pulls)
* [Actions](/unpoly/unpoly-rails/actions)
* [Projects](/unpoly/unpoly-rails/projects)
* [Security](/unpoly/unpoly-rails/security)
* [Insights](/unpoly/unpoly-rails/pulse)

# Possible Denial of Service in unpoly-rails

Moderate

[triskweline](/triskweline)
published
GHSA-m875-3xf6-mf78
Mar 30, 2023

## Package

bundler

unpoly-rails
([RubyGems](/advisories?query=ecosystem%3Arubygems))

## Affected versions

<2.7.2.2

## Patched versions

>=2.7.2.2

## Description

There is a possible Denial of Service (DoS) vulnerability in the unpoly-rails gem that implements the [Unpoly server protocol](https://unpoly.com/up.protocol) for Rails applications.

### Impact

This issues affects Rails applications that operate as an upstream of a load balancer's that uses [passive health checks](https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/#passive-health-checks).

The [unpoly-rails](https://github.com/unpoly/unpoly-rails/) gem echoes the request URL as an `X-Up-Location` response header. By making a request with exceedingly long URLs (paths or query string), an attacker can cause unpoly-rails to write a exceedingly large response header.

If the response header is too large to be parsed by a load balancer downstream of the Rails application, it may cause the load balancer to remove the upstream from a load balancing group. This causes that application instance to become unavailable until a configured timeout is reached or until an active healthcheck succeeds.

### Patches

The fixed release 2.7.2.2+ is available via RubyGems and GitHub.

### Workarounds

If you cannot upgrade to a fixed release, several workarounds are available:

* Configure your load balancer to use active health checks, e.g. by periodically requesting a route with a known response that indicates healthiness.
* Configure your load balancer so the [maximum size of response headers](https://makandracards.com/operations/537537-nginx-proxy-buffer-tuning) is at least twice the [maximum size of a URL](https://tryhexadecimal.com/guides/http/414-request-uri-too-long).
* Instead of changing your server configuration you may also configure your Rails application to delete redundant `X-Up-Location` headers set by unpoly-rails:

  ```
  class ApplicationController < ActionController::Base

    after_action :remove_redundant_up_location_header

    private

    def remove_redundant_up_location_header
      if request.original_url == response.headers['X-Up-Location']
        response.headers.delete('X-Up-Location')
      end
    end

  end
  ```

### References

* [Common HTTP Response Header Limits](https://maxchadwick.xyz/blog/http-response-header-size-limits)
* [Nginx Proxy buffer tuning](https://makandracards.com/operations/537537-nginx-proxy-buffer-tuning)
* [414 Request-URI too long](https://tryhexadecimal.com/guides/http/414-request-uri-too-long)
* [Unpoly server protocol](https://unpoly.com/up.protocol)

### Severity

Moderate

### CVE ID

CVE-2023-28846

### Weaknesses

No CWEs

### Credits

* [![@codener](https://avatars.githubusercontent.com/u/6445611?s=40&v=4)](/codener)
  [codener](/codener)
  Coordinator
* [![@triskweline](https://avatars.githubusercontent.com/u/89953?s=40&v=4)](/triskweline)
  [triskweline](/triskweline)
  Remediation developer
* [![@moritz-makandra](https://avatars.githubusercontent.com/u/74647721?s=40&v=4)](/moritz-makandra)
  [moritz-makandra](/moritz-makandra)
  Analyst
* [![@eheinle-mak](https://avatars.githubusercontent.com/u/46962857?s=40&v=4)](/eheinle-mak)
  [eheinle-mak](/eheinle-mak)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from docs.nginx.com_3a63b5d7_20250114_230229.html ===


[![NGINX Docs](https://docs.nginx.com/images/icons/NGINX-Docs-horiz-white-type.svg)](/)

* F5 Sites

  + [DevCentral](https://community.f5.com/)

    Connect & learn in our hosted community
  + [MyF5](https://my.f5.com/)

    Your key to everything F5, including support, registration keys, and subscriptions
  + [NGINX](https://nginx.org/)

    Learn more about NGINX Open Source and read the community blog

1. [Home](/)
2. [F5 NGINX Plus](/nginx/)
3. [Admin Guide](/nginx/admin-guide/)
4. [Load Balancer](/nginx/admin-guide/load-balancer/)
HTTP Health Checks

### [F5 NGINX Plus F5 NGINX Plus](https://docs.nginx.com/nginx/)

* Admin Guide

+ [Installing NGINX and NGINX Plus](#nginx--admin-guide--installing-nginx-and-nginx-plus)

+ [Installing NGINX Plus](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-plus/)

+ [Installing NGINX Open Source](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/)

+ [Installing NGINX Plus AMIs on Amazon EC2](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-plus-amazon-web-services/)

+ [Installing NGINX Plus on the Google Cloud Platform](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-plus-google-cloud-platform/)

+ [Installing NGINX Plus on Microsoft Azure](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-plus-microsoft-azure/)

+ [Deploying NGINX and NGINX Plus with Docker](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-docker/)

+ [Basic Functionality](#nginx--admin-guide--basic-functionality)

+ [Controlling NGINX Processes at Runtime](https://docs.nginx.com/nginx/admin-guide/basic-functionality/runtime-control/)

+ [Creating NGINX Plus and NGINX Configuration Files](https://docs.nginx.com/nginx/admin-guide/basic-functionality/managing-configuration-files/)

+ [Load Balancer](#nginx--admin-guide--load-balancer)

+ [HTTP Load Balancing](https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/)

+ [TCP and UDP Load Balancing](https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/)

+ [HTTP Health Checks](https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/)

+ [TCP Health Checks](https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-health-check/)

+ [UDP Health Checks](https://docs.nginx.com/nginx/admin-guide/load-balancer/udp-health-check/)

+ [gRPC Health Checks](https://docs.nginx.com/nginx/admin-guide/load-balancer/grpc-health-check/)

+ [Dynamic Configuration of Upstreams with the NGINX Plus API](https://docs.nginx.com/nginx/admin-guide/load-balancer/dynamic-configuration-api/)

+ [Accepting the PROXY Protocol](https://docs.nginx.com/nginx/admin-guide/load-balancer/using-proxy-protocol/)

+ [Content Cache](#nginx--admin-guide--content-cache)

+ [NGINX Content Caching](https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/)

+ [Web Server](#nginx--admin-guide--web-server)

+ [Configuring NGINX and NGINX Plus as a Web Server](https://docs.nginx.com/nginx/admin-guide/web-server/web-server/)

+ [Serving Static Content](https://docs.nginx.com/nginx/admin-guide/web-server/serving-static-content/)

+ [NGINX Reverse Proxy](https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/)

+ [Compression and Decompression](https://docs.nginx.com/nginx/admin-guide/web-server/compression/)

+ [Using NGINX and NGINX Plus as an Application Gateway with uWSGI and Django](https://docs.nginx.com/nginx/admin-guide/web-server/app-gateway-uwsgi-django/)

+ [Security Controls](#nginx--admin-guide--security-controls)

+ [NGINX SSL Termination](https://docs.nginx.com/nginx/admin-guide/security-controls/terminating-ssl-http/)

+ [SSL Termination for TCP Upstream Servers](https://docs.nginx.com/nginx/admin-guide/security-controls/terminating-ssl-tcp/)

+ [Restricting Access with HTTP Basic Authentication](https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/)

+ [Authentication Based on Subrequest Result](https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-subrequest-authentication/)

+ [Setting up JWT Authentication](https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-jwt-authentication/)

+ [Limiting Access to Proxied HTTP Resources](https://docs.nginx.com/nginx/admin-guide/security-controls/controlling-access-proxied-http/)

+ [Restricting Access to Proxied TCP Resources](https://docs.nginx.com/nginx/admin-guide/security-controls/controlling-access-proxied-tcp/)

+ [Restricting Access by Geographical Location](https://docs.nginx.com/nginx/admin-guide/security-controls/controlling-access-by-geoip/)

+ [Securing HTTP Traffic to Upstream Servers](https://docs.nginx.com/nginx/admin-guide/security-controls/securing-http-traffic-upstream/)

+ [Securing TCP Traffic to Upstream Servers](https://docs.nginx.com/nginx/admin-guide/security-controls/securing-tcp-traffic-upstream/)

+ [Dynamic Denylisting of IP Addresses](https://docs.nginx.com/nginx/admin-guide/security-controls/denylisting-ip-addresses/)

+ [Monitoring](#nginx--admin-guide--monitoring)

+ [Live Activity Monitoring](https://docs.nginx.com/nginx/admin-guide/monitoring/live-activity-monitoring/)

+ [Configuring Logging](https://docs.nginx.com/nginx/admin-guide/monitoring/logging/)

+ [Debugging NGINX](https://docs.nginx.com/nginx/admin-guide/monitoring/debugging/)

+ [NGINX Diagnostic Package](https://docs.nginx.com/nginx/admin-guide/monitoring/diagnostic-package/)

+ [Monitoring NGINX and NGINX Plus with the New Relic Plug-In](https://docs.nginx.com/nginx/admin-guide/monitoring/new-relic-plugin/)

+ [High Availability](#nginx--admin-guide--high-availability)

+ [High Availability Support for NGINX Plus in On-Premises Deployments](https://docs.nginx.com/nginx/admin-guide/high-availability/ha-keepalived/)

+ [Configuring Active-Active High Availability and Additional Passive Nodes with keepalived](https://docs.nginx.com/nginx/admin-guide/high-availability/ha-keepalived-nodes/)

+ [Synchronizing NGINX Configuration in a Cluster](https://docs.nginx.com/nginx/admin-guide/high-availability/configuration-sharing/)

+ [Runtime State Sharing in a Cluster](https://docs.nginx.com/nginx/admin-guide/high-availability/zone_sync/)

+ [How NGINX Plus Performs Zone Synchronization](https://docs.nginx.com/nginx/admin-guide/high-availability/zone_sync_details/)

+ [Dynamic Modules](#nginx--admin-guide--dynamic-modules)

+ [Dynamic Modules](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/dynamic-modules/)

+ [Brotli](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/brotli/)

+ [Cookie-Flag](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/cookie-flag/)

+ [Encrypted-Session](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/encrypted-session/)

+ [FIPS Status Check](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/fips/)

+ [GeoIP](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/geoip/)

+ [GeoIP2](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/geoip2/)

+ [Headers-More](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/headers-more/)

+ [HTTP Substitutions Filter](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/http-substitutions-filter/)

+ [Image-Filter](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/image-filter/)

+ [Lua](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/lua/)

+ [NGINX Developer Kit](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/ndk/)

+ [NGINX ModSecurity WAF](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/nginx-waf/)

+ [njs Scripting Language](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/nginscript/)

+ [OpenTelemetry](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/opentelemetry/)

+ [OpenTracing](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/opentracing/)

+ [Perl](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/perl/)

+ [Phusion Passenger Open Source](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/passenger-open-source/)

+ [Prometheus-njs](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/prometheus-njs/)

+ [RTMP](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/rtmp/)

+ [Set-Misc](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/set-misc/)

+ [SPNEGO](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/spnego/)

+ [Uninstalling a dynamic module](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/uninstall/)

+ [XSLT](https://docs.nginx.com/nginx/admin-guide/dynamic-modules/xslt/)

+ [Mail Proxy](#nginx--admin-guide--mail-proxy)

+ [Configuring NGINX as a Mail Proxy Server](https://docs.nginx.com/nginx/admin-guide/mail-proxy/mail-proxy/)

* Deployment Guides

+ [Amazon Web Services](#nginx--deployment-guides--amazon-web-services)

+ [Active-Active HA for NGINX Plus on AWS Using AWS Network Load Balancer](https://docs.nginx.com/nginx/deployment-guides/amazon-web-services/high-availability-network-load-balancer/)

+ [Active-Passive HA for NGINX Plus on AWS Using Elastic IP Addresses](https://docs.nginx.com/nginx/deployment-guides/amazon-web-services/high-availability-keepalived/)

+ [Global Server Load Balancing with Amazon Route 53 and NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/amazon-web-services/route-53-global-server-load-balancing/)

+ [Using NGINX or NGINX Plus as the Ingress Controller for Amazon Elastic Kubernetes Services](https://docs.nginx.com/nginx/deployment-guides/amazon-web-services/ingress-controller-elastic-kubernetes-services/)

+ [Creating Amazon EC2 Instances for NGINX Open Source and NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/amazon-web-services/ec2-instances-for-nginx/)

+ [Global Server Load Balancing](#nginx--deployment-guides--global-server-load-balancing)

+ [Global Server Load Balancing with NS1 and NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/global-server-load-balancing/ns1-global-server-load-balancing/)

+ [Google Cloud Platform](#nginx--deployment-guides--google-cloud-platform)

+ [All-Active HA for NGINX Plus on the Google Cloud Platform](https://docs.nginx.com/nginx/deployment-guides/google-cloud-platform/high-availability-all-active/)

+ [Load Balancing Third-Party Servers](#nginx--deployment-guides--load-balancing-third-party-servers)

+ [Load Balancing Apache Tomcat Servers with NGINX Open Source and NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/load-balance-third-party/apache-tomcat/)

+ [Load Balancing Microsoft Exchange Servers with NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/load-balance-third-party/microsoft-exchange/)

+ [Load Balancing Node.js Application Servers with NGINX Open Source and NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/load-balance-third-party/node-js/)

+ [Load Balancing Oracle E-Business Suite with NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/load-balance-third-party/oracle-e-business-suite/)

+ [Load Balancing Oracle WebLogic Server with NGINX Open Source and NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/load-balance-third-party/oracle-weblogic-server/)

+ [Load Balancing Wildfly and JBoss Application Servers with NGINX Open Source and NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/load-balance-third-party/wildfly/)

+ [Microsoft Azure](#nginx--deployment-guides--microsoft-azure)

+ [Active-Active HA for NGINX Plus on Microsoft Azure Using the Azure Standard Load Balancer](https://docs.nginx.com/nginx/deployment-guides/microsoft-azure/high-availability-standard-load-balancer/)

+ [Creating Microsoft Azure Virtual Machines for NGINX Open Source and F5 NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/microsoft-azure/virtual-machines-for-nginx/)

+ [Migrate Hardware ADCs](#nginx--deployment-guides--migrate-hardware-adcs)

+ [Migrating Load Balancer Configuration from Citrix ADC to NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/migrate-hardware-adc/citrix-adc-configuration/)

+ [Migrating Load Balancer Configuration from F5 BIG-IP LTM to F5 NGINX Plus](https://docs.nginx.com/nginx/deployment-guides/migrate-hardware-adc/f5-big-ip-configuration/)

+ [Set Up Single Sign-On for Proxied Applications](#nginx--deployment-guides--set-up-single-sign-on-for-proxied-applications)

+ [Single Sign-On with Amazon Cognito](https://docs.nginx.com/nginx/deployment-guides/single-sign-on/cognito/)

+ [Single Sign-On With Auth0](https://docs.nginx.com/nginx/deployment-guides/single-sign-on/auth0/)

+ [Single Sign-On with Keycloak](https://docs.nginx.com/nginx/deployment-guides/single-sign-on/keycloak/)

+ [Single Sign-On with Microsoft Active Directory FS](https://docs.nginx.com/nginx/deployment-guides/single-sign-on/active-directory-federation-services/)

+ [Single Sign-On with Okta](https://docs.nginx.com/nginx/deployment-guides/single-sign-on/okta/)

+ [Single Sign-On with OneLogin](https://docs.nginx.com/nginx/deployment-guides/single-sign-on/onelogin/)

+ [Single Sign-On with Ping Identity](https://docs.nginx.com/nginx/deployment-guides/single-sign-on/ping-identity/)

- [Setting Up an NGINX Demo Environment](https://docs.nginx.com/nginx/deployment-guides/setting-up-nginx-demo-environment/)

* [Releases](https://docs.nginx.com/nginx/releases/)
* [Technical Specs](https://docs.nginx.com/nginx/technical-specs/)
* [Open Source Components](https://docs.nginx.com/nginx/open-source-components/)
* [NGINX Plus FIPS Compliance](https://docs.nginx.com/nginx/fips-compliance-nginx-plus/)
* [NGINX Directives Index](https://docs.nginx.com/nginx/directives/)

Sidebar placeholder

# HTTP Health Checks

## Introduction

NGINX and F5 NGINX Plus can continually test your upstream servers, avoid the servers that have failed, and gracefully add the recovered servers into the loadâbalanced group.

## Prerequisites

* For passive health checks, [NGINX Open Source](https://nginx.org/en/) or [NGINX Plus](https://www.nginx.com/products/nginx)
* For active health checks and the [live activity monitoring dashboard](/nginx/admin-guide/monitoring/live-activity-monitoring/), NGINX Plus
* A loadâbalanced group of [HTTP upstream servers](/nginx/admin-guide/load-balancer/http-load-balancer/)

## Passive Health Checks

For passive health checks, NGINX and NGINX Plus monitor transactions as they happen, and try to resume failed connections. If the transaction still cannot be resumed, NGINX Open Source and NGINX Plus mark the server as unavailable and temporarily stop sending requests to it until it is marked active again.

The conditions under which an upstream server is marked unavailable are defined for each upstream server with parameters to the [`server`](https://nginx.org/en/docs/http/ngx_http_upstream_module.html#server) directive in the `upstream` block:

* [`fail_timeout`](https://nginx.org/en/docs/http/ngx_http_upstream_module.html#fail_timeout)Â â Sets the time during which a number of failed attempts must happen for the server to be marked unavailable, and also the time for which the server is marked unavailable (default is 10 seconds).
* [`max_fails`](https://nginx.org/en/docs/http/ngx_http_upstream_module.html#max_fails)Â â Sets the number of failed attempts that must occur during the `fail_timeout` period for the server to be marked unavailable (default is 1 attempt).

In the following example, if NGINX fails to send a request to a server or does not receive a response from it 3 times in 30 seconds, it marks the server as unavailable for 30 seconds:

```
upstream backend {
    server backend1.example.com;
    server backend2.example.com max_fails=3 fail_timeout=30s;
}

```

Note that if there is only a single server in a group, the `fail_timeout` and `max_fails` parameters are ignored and the server is never marked unavailable.

### Server Slow Start

A recently recovered server can be easily overwhelmed by connections, which may cause the server to be marked as unavailable again. Slow start allows an upstream server to gradually recover its weight from zero to its nominal value after it has been recovered or became available. This can be done with the [`slow_start`](https://nginx.org/en/docs/http/ngx_http_upstream_module.html#slow_start) parameter of the upstream [`server`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#match) directive:

```
upstream backend {
    server backend1.example.com slow_start=30s;
    server backend2.example.com;
    server 192.0.0.1 backup;
}

```

Note that if there is only a single server in a group, the `slow_start` parameter is ignored and the server is never marked unavailable. Slow start is exclusive to NGINX Plus.

## Active Health Checks

NGINX Plus can periodically check the health of upstream servers by sending special healthâcheck requests to each server and verifying the correct response.

To enable active health checks:

1. In the [`location`](https://nginx.org/en/docs/http/ngx_http_core_module.html#location) that passes requests ([`proxy_pass`](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass)) to an upstream group, include the [`health_check`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check) directive:

   ```
   server {
       location / {
           proxy_pass http://backend;
           health_check;
       }
   }

   ```

   This snippet defines a server that passes all requests (`location /`) to the upstream group called `backend`. It also enables advanced health monitoring with the [`health_check`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check) directive: by default, every five seconds NGINX Plus sends a request for “**/**” to each server in the `backend` group. If any communication error or timeout occurs (the server responds with a status code outside the range from `200` through `399`) the health check fails. The server is marked as unhealthy, and NGINX Plus does not send client requests to it until it once again passes a health check.

   Optionally you can specify another port for health checks, for example, for monitoring health of many services on the same host. Specify a new port with the [`port`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_port) parameter of the [`health_check`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check) directive:

   ```
   server {
       location / {
           proxy_pass   http://backend;
           health_check port=8080;
       }
   }

   ```
2. In the upstream server group, define a shared memory zone with the [`zone`](https://nginx.org/en/docs/http/ngx_http_upstream_module.html#zone) directive:

   ```
   http {
       upstream backend {
           zone backend 64k;
           server backend1.example.com;
           server backend2.example.com;
           server backend3.example.com;
           server backend4.example.com;
       }
   }

   ```

   The zone is shared among all worker processes and stores the configuration of the upstream group. This [enables](/nginx/admin-guide/load-balancer/http-load-balancer/#sharing-data-with-multiple-worker-processes) the worker processes to use the same set of counters to keep track of responses from the servers in the group.

   The defaults for active health checks can be overridden with parameters to the `health_check` directive:

   ```
   location / {
       proxy_pass   http://backend;
       health_check interval=10 fails=3 passes=2;
   }

   ```

   Here, the [`interval`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_interval) parameter increases the delay between health checks from the default 5 seconds to 10 seconds. The [`fails`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_fails) parameter requires the server to fail three health checks to be marked as unhealthy (up from the default one). Finally, the [`passes`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_passes) parameter means the server must pass two consecutive checks to be marked as healthy again instead of the default one.

   You can also enable connection caching with the [`keepalive_time`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_keepalive_time) parameter - in case of TLS upstreams the full TLS handshake won’t happen for every health check probe and the connection can be reused during the specified period of time:

   ```
   location / {
       proxy_http_version 1.1;
       proxy_set_header   Connection "";
       proxy_pass         https://backend;
       health_check       interval=1 keepalive_time=60s;
   }

   ```

### Specifying the Requested URI

Use the [`uri`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_uri) parameter of the [`health_check`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check) directive to set the URI to request in a health check:

```
location / {
    proxy_pass   http://backend;
    health_check uri=/some/path;
}

```

The specified URI is appended to the server domain name or IP address set for the server in the `upstream` block. For the first server in the sample `backend` group declared above, a health check requests the URI **“[http://backend1.example.com/some/path"](http://backend1.example.com/some/path%22)**.

### Defining Custom Conditions

You can set custom conditions that the response must satisfy for the server to pass the health check. The conditions are defined in a [`match`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#match) block, which is referenced in the [`match`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_match) parameter of the [`health_check`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check) directive.

1. On the `http {}` level, specify the `match` `{}` block and name it, for example, `server_ok`:

   ```
   http {
       #...
       match server_ok {
           # tests are here
       }
   }

   ```
2. Refer to the block from the [`health_check`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check) directive by specifying the [`match`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_match) parameter and the name of the [`match`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#match) block:

   ```
   http {
       #...
       match server_ok {
           status 200-399;
           body   !~ "maintenance mode";
       }
       server {
           #...
           location / {
               proxy_pass   http://backend;
               health_check match=server_ok;
           }
       }
   }

   ```

   Here the health check is passed if the status code of the response is in the range `200`â`399`, and its body does not contain the string `maintenance mode`.

The `match` directive enables NGINX Plus to check the status code, header fields, and the body of a response. Using this directive it is possible to verify whether the status is in a specified range, whether a response includes a header, or whether the header or body matches a regular expression. The `match` directive can contain one status condition, one body condition, and multiple header conditions. A response must satisfy all conditions defined in `match` block for the server to pass the health check.

For example, the following `match` directive matches responses that have status code `200`, the exact value `text/html` in the `Content-Type` header, and the text `Welcome to nginx!` in the body:

```
match welcome {
    status 200;
    header Content-Type = text/html;
    body   ~ "Welcome to nginx!";
}

```

The following example uses the exclamation point (`!`) to define characteristics the response must not have to pass the health check. In this case, the health check passes when the status code is something other than `301`, `302`, `303`, or `307`, and there is no `Refresh` header.

```
match not_redirect {
    status ! 301-303 307;
    header ! Refresh;
}

```
### Mandatory Health Checks

By default, when a new server is added to an upstream group, NGINX Plus considers it healthy and sends traffic to it immediately. But for some servers, particularly if they were added through the API interface or through DNS resolution, it would be good to perform health check first before allowing them to handle traffic.

The [`mandatory`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_mandatory) parameter requires every newly added server to pass all configured health checks before NGINX Plus sends traffic to it.

When combined with [`slow start`](#slow_start), it gives a new server more time to connect to databases and âwarm upâ before being asked to handle their full share of traffic.

Mandatory health checks can be marked as persistent, so that the previous state is remembered when reloading configuration. Specify the [`persistent`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_persistent) parameter together with the [`mandatory`](https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html#health_check_mandatory) parameter:

```
upstream my_upstream {
    zone   my_upstream 64k;
    server backend1.example.com slow_start=30s;
}
server {
    location / {
        proxy_pass   http://my_upstream;
        health_check mandatory persistent;
    }
}

```

Here the `mandatory` and `persistent` parameters of the `health_check` directive and the `slow_start` parameter of the `server` directive are specified. Servers that are added to the upstream group using the API or DNS interfaces are marked as unhealthy and receive no traffic until they pass the health check; at that point they start receiving a gradually increasing amount of traffic over a span of 30 seconds. If NGINX Plus configuration is reloaded and before reload the server was marked as healthy, mandatory health check are not performed and the server state is considered to be `up`.

Health checks can also be enabled for non-HTTP protocols, such as [FastCGI](https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html), [memcached](https://nginx.org/en/docs/http/ngx_http_memcached_module.html), [SCGI](https://nginx.org/en/docs/http/ngx_http_scgi_module.html), [uwsgi](https://nginx.org/en/docs/http/ngx_http_uwsgi_module.html), and also for [TCP and UDP](https://nginx.org/en/docs/stream/ngx_stream_upstream_hc_module.html#health_check).

---

---

Last modified August 22, 2024

### What's on This Page

* [Introduction](#introduction)
* [Prerequisites](#prerequisites)
* [Passive Health Checks](#passive-health-checks)
  + [Server Slow Start](#server-slow-start)
* [Active Health Checks](#active-health-checks)
  + [Specifying the Requested URI](#specifying-the-requested-uri)
  + [Defining Custom Conditions](#defining-custom-conditions)
  + [Mandatory Health Checks](#mandatory-health-checks)

![](https://docs.nginx.com/images/icons/NGINX-Part-of-F5-horiz-all-white-525x208@2x.png)
Found a bug? Looking for something new?

[Let Us Know](https://docs.nginx.com/feedback/)

Company

* [About F5 NGINX](https://www.f5.com/go/product/welcome-to-nginx)
* [Events](https://www.f5.com/company/events)

Resources

* [Blog](https://www.f5.com/company/blog/nginx)
* [FAQ](https://www.f5.com/go/faq/nginx-faq)
* [Professional Services](https://www.f5.com/services)
* [Training](https://www.f5.com/learn/training)

Products

* [F5 NGINX One](https://www.f5.com/products/nginx/one "F5 NGINX One")
* [F5 NGINX Plus](https://www.f5.com/products/nginx/nginx-plus "F5 NGINX Plus")
* [F5 NGINX App Protect](https://www.f5.com/products/nginx/nginx-app-protect "F5 NGINX App Protect")
* [F5 NGINX Instance Manager](https://www.f5.com/products/nginx/instance-manager "F5 NGINX Instance Manager")
* [F5 NGINX Ingress Controller](https://www.f5.com/products/nginx/nginx-ingress-controller "F5 NGINX Ingress Controller")
* [F5 NGINX Gateway Fabric](https://www.f5.com/products/nginx/nginx-gateway-fabric "F5 NGINX Gateway Fabric")
* [F5 NGINXaaS for Azure](https://www.f5.com/products/nginx/f5-nginxaas-for-azure "F5 NGINXaaS for Azure")

NGINX on GitHub

* [NGINX Open Source](https://github.com/nginx/nginx "NGINX Open Source")
* [NGINX Unit](https://github.com/nginx/unit "NGINX Unit")
* [NGINX Amplify](https://github.com/nginxinc/nginx-amplify-agent "NGINX Amplify")
* [NGINX Agent](https://github.com/nginx/Agent "NGINX Agent")
* [NGINX Kubernetes Ingress Controller](https://github.com/nginxinc/kubernetes-ingress "NGINX Kubernetes Ingress Controller")
* [NGINX Gateway Fabric](https://github.com/nginxinc/nginx-gateway-fabric "NGINX Gateway Fabric")

Social

[![F5 logo](https://docs.nginx.com/images/icons/Logo_F5.svg)](https://www.f5.com/)
Â©2025 F5, Inc. All rights reserved.

[Trademarks](https://www.f5.com/company/policies/trademarks) [Policies](https://www.f5.com/company/policies) [Open Source Components](https://docs.nginx.com/ossc) [Privacy](https://www.f5.com/company/policies/privacy-notice) [California Privacy](https://www.f5.com/company/policies/F5-California-privacy-summary) [Do Not Sell My Personal Information](https://www.f5.com/company/policies/privacy-notice#no-sell)



=== Content from tryhexadecimal.com_7e91b7af_20250114_230239.html ===

[Skip to content](#content)

[tryhexadecimal.com](https://www.tryhexadecimal.com/)

Menu

* [Home](https://www.tryhexadecimal.com/)
* [Support](https://www.tryhexadecimal.com/support/)
* [Docs](https://www.tryhexadecimal.com/docs/)
* [Pricing](https://www.tryhexadecimal.com/pricing/)

# Home

# Stop worrying about downtimes

Find peace of mind knowing that your websites and APIs are up and running.

Start monitoring now

Don’t leave your websites unattended.

No hidden fees, no feature bloat, no dark patterns, no shenanigans, no snake oil.

### Uptime monitoring

Stop losing money, trust, and sanity by monitoring your websites and APIs every minute. But when things go haywire, and they will go haywire, be the first to learn about it.

### Hosted status pages

Showcase your websites’ real-time availability and publish status updates on your status page. Your customers will certainly appreciate the transparency.

### Versatile alerting

Multiple recipients? Check. Notifications delivered via email, SMS, and Slack? Check. Configurable delay for the first notification? Check. Follow up notifications? Check. Per-website and global controls? Check. False positives? No!

### Resolve downtimes faster

During the downtime, instead of receiving generic “*your website is down*” message, you will have a reason for what might be causing the downtime, how to troubleshoot it, and all the necessary debug information. Incredibly useful if you’re on-call.

### Certificate monitoring

When calendar reminders and hacky shell scripts won’t cut it anymore. No more expired SSL/TLS certificates.

### Team accounts

Bring over your team members by emailing them a link. You know that sharing credentials over pastebin is a Bad Thing, right? *Right?!*

### Hands-on support

Instead of receiving canned, robotic responses to your support questions, get helpful, timely responses from the founder. Be sure that your emails won’t end up in `/dev/null`.

### Wide range of protocols

Are your servers running on the bleeding edge? From TLS 1.3 to HTTP/2 to IPv6, you have got yourself covered. Using legacy software with ancient protocols? You are covered as well.

SearchSearch

* [Home](https://www.tryhexadecimal.com/)
* [Support](https://www.tryhexadecimal.com/support/)
* [Docs](https://www.tryhexadecimal.com/docs/)
* [Pricing](https://www.tryhexadecimal.com/pricing/)

[tryhexadecimal.com](https://www.tryhexadecimal.com/)
[Proudly powered by WordPress](https://wordpress.org/)


