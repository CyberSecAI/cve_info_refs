=== Content from github.com_9acd6b3e_20250114_182251.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fcommit%2Fbf814387f42e9b0dea9d75c03db4723c88e7d962)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fcommit%2Fbf814387f42e9b0dea9d75c03db4723c88e7d962)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=FFmpeg%2FFFmpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FFmpeg](/FFmpeg)
/
**[FFmpeg](/FFmpeg/FFmpeg)**
Public

* [Notifications](/login?return_to=%2FFFmpeg%2FFFmpeg) You must be signed in to change notification settings
* [Fork
  12.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)
* [Star
   47.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)

* [Code](/FFmpeg/FFmpeg)
* [Pull requests
  1](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

Additional navigation options

* [Code](/FFmpeg/FFmpeg)
* [Pull requests](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

## Commit

[Permalink](/FFmpeg/FFmpeg/commit/bf814387f42e9b0dea9d75c03db4723c88e7d962)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

avcodec/jpegxl\_parser: fix OOB read regression

[Browse files](/FFmpeg/FFmpeg/tree/bf814387f42e9b0dea9d75c03db4723c88e7d962)
Browse the repository at this point in the history

```
In [f7ac351](https://github.com/FFmpeg/FFmpeg/commit/f7ac3512f5b5cb8eb149f37300b43461d8e93af3) the size of the dynamically
allocated buffer was shrunk, but it was made too small for very small
alphabet sizes. This patch restores the size to prevent an OOB read.

Reported-by: Cole Dilorenzo <coolkingcole@gmail.com>
Signed-off-by: Leo Izen <leo.izen@gmail.com>
```

* Loading branch information

[![@Traneptora](https://avatars.githubusercontent.com/u/1342577?s=40&v=4)](/Traneptora)

[Traneptora](/FFmpeg/FFmpeg/commits?author=Traneptora "View all commits by Traneptora")
committed
Oct 17, 2023

1 parent
[5ddab49](/FFmpeg/FFmpeg/commit/5ddab49d48343385eadb3a435a5491c476b66ecc)

commit bf81438

Showing
**1 changed file**
with
**17 additions**
and
**13 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

30 changes: 17 additions & 13 deletions

30
[libavcodec/jpegxl\_parser.c](#diff-bde7f52f086be7520759e97f4fdd7e808106bcdda8bef0f1f7bd5eb614c906a0 "libavcodec/jpegxl_parser.c")

Show comments

[View file](/FFmpeg/FFmpeg/blob/bf814387f42e9b0dea9d75c03db4723c88e7d962/libavcodec/jpegxl_parser.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -683,7 +683,7 @@ static int read\_vlc\_prefix(GetBitContext \*gb, JXLEntropyDecoder \*dec, JXLSymbolD |
|  |  | int repeat\_count\_prev = 0, repeat\_count\_zero = 0, prev = 8; |
|  |  | int total\_code = 0, len, hskip, num\_codes = 0, ret; |
|  |  |  |
|  |  | VLC level1\_vlc; |
|  |  | VLC level1\_vlc = { 0 }; |
|  |  |  |
|  |  | if (dist->alphabet\_size == 1) { |
|  |  | dist->vlc.bits = 0; |
| Expand All | | @@ -709,8 +709,10 @@ static int read\_vlc\_prefix(GetBitContext \*gb, JXLEntropyDecoder \*dec, JXLSymbolD |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (total\_code != 32 && num\_codes >= 2 || num\_codes < 1) |
|  |  | return AVERROR\_INVALIDDATA; |
|  |  | if (total\_code != 32 && num\_codes >= 2 || num\_codes < 1) { |
|  |  | ret = AVERROR\_INVALIDDATA; |
|  |  | goto end; |
|  |  | } |
|  |  |  |
|  |  | for (int i = 1; i < 19; i++) |
|  |  | level1\_codecounts[i] += level1\_codecounts[i - 1]; |
| Expand All | | @@ -726,29 +728,30 @@ static int read\_vlc\_prefix(GetBitContext \*gb, JXLEntropyDecoder \*dec, JXLSymbolD |
|  |  | if (ret < 0) |
|  |  | goto end; |
|  |  |  |
|  |  | buf = av\_mallocz(dist->alphabet\_size \* (2 \* sizeof(int8\_t) + sizeof(int16\_t) + sizeof(uint32\_t)) |
|  |  | buf = av\_mallocz(MAX\_PREFIX\_ALPHABET\_SIZE \* (2 \* sizeof(int8\_t) + sizeof(int16\_t) + sizeof(uint32\_t)) |
|  |  | + sizeof(uint32\_t)); |
|  |  | if (!buf) { |
|  |  | ret = AVERROR(ENOMEM); |
|  |  | goto end; |
|  |  | } |
|  |  |  |
|  |  | level2\_lens = (int8\_t \*)buf; |
|  |  | level2\_lens\_s = (int8\_t \*)(buf + dist->alphabet\_size \* sizeof(int8\_t)); |
|  |  | level2\_syms = (int16\_t \*)(buf + dist->alphabet\_size \* (2 \* sizeof(int8\_t))); |
|  |  | level2\_codecounts = (uint32\_t \*)(buf + dist->alphabet\_size \* (2 \* sizeof(int8\_t) + sizeof(int16\_t))); |
|  |  | level2\_lens\_s = (int8\_t \*)(buf + MAX\_PREFIX\_ALPHABET\_SIZE \* sizeof(int8\_t)); |
|  |  | level2\_syms = (int16\_t \*)(buf + MAX\_PREFIX\_ALPHABET\_SIZE \* (2 \* sizeof(int8\_t))); |
|  |  | level2\_codecounts = (uint32\_t \*)(buf + MAX\_PREFIX\_ALPHABET\_SIZE \* (2 \* sizeof(int8\_t) + sizeof(int16\_t))); |
|  |  |  |
|  |  | total\_code = 0; |
|  |  | for (int i = 0; i < dist->alphabet\_size; i++) { |
|  |  | len = get\_vlc2(gb, level1\_vlc.table, 5, 1); |
|  |  | if (get\_bits\_left(gb) < 0) { |
|  |  | ret = AVERROR\_BUFFER\_TOO\_SMALL; |
|  |  | goto end; |
|  |  | } |
|  |  | if (len == 16) { |
|  |  | int extra = 3 + get\_bits(gb, 2); |
|  |  | if (repeat\_count\_prev) |
|  |  | extra = 4 \* (repeat\_count\_prev - 2) - repeat\_count\_prev + extra; |
|  |  | if (i + extra > dist->alphabet\_size) { |
|  |  | ret = AVERROR\_INVALIDDATA; |
|  |  | goto end; |
|  |  | } |
|  |  | extra += 4 \* (repeat\_count\_prev - 2) - repeat\_count\_prev; |
|  |  | extra = FFMIN(extra, dist->alphabet\_size - i); |
|  |  | for (int j = 0; j < extra; j++) |
|  |  | level2\_lens[i + j] = prev; |
|  |  | total\_code += (32768 >> prev) \* extra; |
| Expand All | | @@ -759,7 +762,8 @@ static int read\_vlc\_prefix(GetBitContext \*gb, JXLEntropyDecoder \*dec, JXLSymbolD |
|  |  | } else if (len == 17) { |
|  |  | int extra = 3 + get\_bits(gb, 3); |
|  |  | if (repeat\_count\_zero > 0) |
|  |  | extra = 8 \* (repeat\_count\_zero - 2) - repeat\_count\_zero + extra; |
|  |  | extra += 8 \* (repeat\_count\_zero - 2) - repeat\_count\_zero; |
|  |  | extra = FFMIN(extra, dist->alphabet\_size - i); |
|  |  | i += extra - 1; |
|  |  | repeat\_count\_prev = 0; |
|  |  | repeat\_count\_zero += extra; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `bf81438`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fcommit%2Fbf814387f42e9b0dea9d75c03db4723c88e7d962) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from patchwork.ffmpeg.org_5217eaf6_20250114_182253.html ===

Toggle navigation

[Patchwork](/)
FFmpeg

* [Patches](/project/ffmpeg/list/)
* [Bundles](/project/ffmpeg/bundles/)
* [About this project](/project/ffmpeg/)

* [Login](/user/login/)
* [Register](/register/)
* [Mail settings](/mail/)

44263

[diff](/project/ffmpeg/patch/20231015004924.597746-1-leo.izen%40gmail.com/raw/ "Download patch diff")
[mbox](/project/ffmpeg/patch/20231015004924.597746-1-leo.izen%40gmail.com/mbox/ "Download patch mbox")
[series](/series/9878/mbox/ "Download patch mbox with dependencies")
# [FFmpeg-devel,v2] avcodec/jpegxl\_parser: fix OOB read regression

| Message ID | 20231015004924.597746-1-leo.izen@gmail.com |
| --- | --- |
| State | Accepted |
| Commit | bf814387f42e9b0dea9d75c03db4723c88e7d962 |
| Headers | show ``` Delivered-To: ffmpegpatchwork2@gmail.com Received: by 2002:a05:6a20:4b15:b0:15d:8365:d4b8 with SMTP id  fp21csp1820294pzb;         Sat, 14 Oct 2023 17:49:49 -0700 (PDT) X-Google-Smtp-Source:   AGHT+IHSeXIbiYdJi9bzC0h7qiz9i28mm6ZFGz3PQyVRD+S8jVRwfH4fNBiPEYcfrCHfGcjhWts/ X-Received: by 2002:a17:907:970a:b0:9be:e153:3f24 with SMTP id  jg10-20020a170907970a00b009bee1533f24mr2411374ejc.63.1697330989389;         Sat, 14 Oct 2023 17:49:49 -0700 (PDT) ARC-Seal: i=1; a=rsa-sha256; t=1697330989; cv=none;         d=google.com; s=arc-20160816;         b=efbynFxUicPMa24SNyVC0iUCQtLXT/oKmmdwVOmD0RozCvF8RDTy/xIq3WVOOkUnkC          8xfemuKnj3cyRJKHK76m1EOBGdQTnGT/Fn/b58t5XDp9B++k/QPdtQobpqeWLHPbssnT          c2c5zW2rdIq4rbizmi6qzv7ALfr27jKilX+/QXg6H5Al/70PSyWhzP+4omI2z36ZFYOJ          8JaUgfVx+wb5WwiWiDtKSJrqUJ2nSKqZbqJhUAqyyRPpsc/9MZsfJMgRaejdO+xnSbFx          LdHaO1Oo+l2DPb553+Sq0OZnisXRPbFZW6pEFtOuCUpZzwgcF6dNfzZPwsSfHQlfwVLp          5NAg== ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com;  s=arc-20160816;         h=sender:errors-to:content-transfer-encoding:cc:reply-to          :list-subscribe:list-help:list-post:list-archive:list-unsubscribe          :list-id:precedence:subject:mime-version:references:in-reply-to          :message-id:date:to:from:dkim-signature:delivered-to;         bh=gXY1gDMzHbANY9qfdDCdAVPrsJdKEfJJN9N/eNLrW6E=;         fh=VDN5+TNMvI4QcA450Y5zHrxzCeKSduY8ULDi31AwbZ8=;         b=eLB136mgSFeymCyRfOUZSsv7jeS1AL5TfE2/XcIZyGvb+h3YShJWmvtSWaKlpmiYIE          AvN4xaMy9Ds/QuP38fOqrgk407cyws1kMmA02NBPd2Aqol1Shz2G0Gqv6bi+P2MfVBCO          wZhJsAQMU1ZnwYalyvt91HhPe5O45/OQAnChhS5Wy69JN4VrpS8WvoIEuPVyNFO4uHsc          KfmXe/N5CfRZQUqtIk7OR5qQmKIzzQZAQrb8plHjZMQ6LIIZ9iXwZyQRGKOHQU9SPwVY          2Qo1Q29g/akphTEKiPNMor0r6VKJRW3KBAULcjW5LPjOXB7Jsq62vGI05taA6qs3v7Bm          nC2Q== ARC-Authentication-Results: i=1; mx.google.com;        dkim=neutral (body hash did not verify) header.i=@gmail.com  header.s=20230601 header.b=B8et2WDt;        spf=pass (google.com: domain of ffmpeg-devel-bounces@ffmpeg.org  designates 79.124.17.100 as permitted sender)  smtp.mailfrom=ffmpeg-devel-bounces@ffmpeg.org;        dmarc=fail (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com Return-Path: <ffmpeg-devel-bounces@ffmpeg.org> Received: from ffbox0-bg.mplayerhq.hu (ffbox0-bg.ffmpeg.org. [79.124.17.100])         by mx.google.com with ESMTP id  lr13-20020a170906fb8d00b0099bd73cbd7dsi1218793ejb.429.2023.10.14.17.49.48;         Sat, 14 Oct 2023 17:49:49 -0700 (PDT) Received-SPF: pass (google.com: domain of ffmpeg-devel-bounces@ffmpeg.org  designates 79.124.17.100 as permitted sender) client-ip=79.124.17.100; Authentication-Results: mx.google.com;        dkim=neutral (body hash did not verify) header.i=@gmail.com  header.s=20230601 header.b=B8et2WDt;        spf=pass (google.com: domain of ffmpeg-devel-bounces@ffmpeg.org  designates 79.124.17.100 as permitted sender)  smtp.mailfrom=ffmpeg-devel-bounces@ffmpeg.org;        dmarc=fail (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com Received: from [127.0.1.1] (localhost [127.0.0.1]) 	by ffbox0-bg.mplayerhq.hu (Postfix) with ESMTP id B951D68C734; 	Sun, 15 Oct 2023 03:49:45 +0300 (EEST) X-Original-To: ffmpeg-devel@ffmpeg.org Delivered-To: ffmpeg-devel@ffmpeg.org Received: from mail-qv1-f51.google.com (mail-qv1-f51.google.com  [209.85.219.51])  by ffbox0-bg.mplayerhq.hu (Postfix) with ESMTPS id 1CC5468ADCB  for <ffmpeg-devel@ffmpeg.org>; Sun, 15 Oct 2023 03:49:39 +0300 (EEST) Received: by mail-qv1-f51.google.com with SMTP id  6a1803df08f44-66d31e8d198so3501756d6.1  for <ffmpeg-devel@ffmpeg.org>; Sat, 14 Oct 2023 17:49:39 -0700 (PDT) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;  d=gmail.com; s=20230601; t=1697330977; x=1697935777; darn=ffmpeg.org;  h=content-transfer-encoding:mime-version:references:in-reply-to  :message-id:date:subject:cc:to:from:from:to:cc:subject:date  :message-id:reply-to;  bh=8a9f1q7SfC+IXA/qGeWrXQC10ygNtzOjydFihc0jZ+U=;  b=B8et2WDtvIC9VLVu0Wsz8H3PmfI4rfD7H4rIVszki64/05gh9BRfEtgkhsSI4I8jre  Obm0yAmAc5It+XXLMKynQ0mNMc+JAybNJKJiuMFtM4bkOzOYCGJ02EDrSNJWy0rhnfQP  6kpah7eRhfjrMXAeUKfL2jDS1jpf0DDRP+lQfGNGMZa4s6/hOe2n973T3jwwaj3VaSoT  J1I7omJvJIBjt/T48Fz012ddeV85sqAcV9W3Mfz0phk4G4c7FCRmtrzFnocvoL/tvx6l  NBBoVWiGIa9lW6P7/ULuEzp08yRWTJyySBLwmWBJRCapiQ0OlIwm5tRk1EKZLYIgmdDE  yt7Q== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;  d=1e100.net; s=20230601; t=1697330977; x=1697935777;  h=content-transfer-encoding:mime-version:references:in-reply-to  :message-id:date:subject:cc:to:from:x-gm-message-state:from:to:cc  :subject:date:message-id:reply-to;  bh=8a9f1q7SfC+IXA/qGeWrXQC10ygNtzOjydFihc0jZ+U=;  b=vh/KQRgwDmQgQgFWh3rcxRK4QaToLUMdsBiHmljendt9lguujY1z6jKKVEOZzccyG8  6nKhLPIBr+VfqjYBhjRq/SOYo5gE+vrr1r/fUE4iHJid5ntBWT2ERYYeXI+/XVujXkC6  WZJ1hym1xytwK4TttlMzfDdKsHzYb/3cA6GIOUjRZHAFcImcUIeqX67ar3huHMKgwjVN  qteIwayunBgSLyG6Ann6sR00Xwyk5cpL8o0hMPV3/FdiQonCnqjJO5JcVasPjB5/HnEs  uQ2EFftFWW/PUv9PuYhVodMMSWnhJpdrUFgsJrnhLDwtBZn8GbavBOPYLSqYfHt4G377  bhwg== X-Gm-Message-State: AOJu0Yy97n1txBQWlA23qg1UVYiAy+jOwwSowIGc91i/IbpO85vAcY3h  0EACPn6zTnjLH2alWOND1KEpeboMvkKY24cF X-Received: by 2002:a0c:ef90:0:b0:66d:1b9b:1964 with SMTP id  w16-20020a0cef90000000b0066d1b9b1964mr8260422qvr.2.1697330976959;  Sat, 14 Oct 2023 17:49:36 -0700 (PDT) Received: from gauss.local (c-68-56-149-176.hsd1.mi.comcast.net.  [68.56.149.176]) by smtp.gmail.com with ESMTPSA id  i17-20020ad44bb1000000b0065b22afe53csm2126872qvw.94.2023.10.14.17.49.36  (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);  Sat, 14 Oct 2023 17:49:36 -0700 (PDT) From: Leo Izen <leo.izen@gmail.com> To: ffmpeg-devel@ffmpeg.org Date: Sat, 14 Oct 2023 20:49:24 -0400 Message-ID: <20231015004924.597746-1-leo.izen@gmail.com> X-Mailer: git-send-email 2.42.0 In-Reply-To: <20231013014959.536776-1-leo.izen@gmail.com> References: <20231013014959.536776-1-leo.izen@gmail.com> MIME-Version: 1.0 Subject: [FFmpeg-devel] [PATCH v2] avcodec/jpegxl_parser: fix OOB read  regression X-BeenThere: ffmpeg-devel@ffmpeg.org X-Mailman-Version: 2.1.29 Precedence: list List-Id: FFmpeg development discussions and patches <ffmpeg-devel.ffmpeg.org> List-Unsubscribe: <https://ffmpeg.org/mailman/options/ffmpeg-devel>,  <mailto:ffmpeg-devel-request@ffmpeg.org?subject=unsubscribe> List-Archive: <https://ffmpeg.org/pipermail/ffmpeg-devel> List-Post: <mailto:ffmpeg-devel@ffmpeg.org> List-Help: <mailto:ffmpeg-devel-request@ffmpeg.org?subject=help> List-Subscribe: <https://ffmpeg.org/mailman/listinfo/ffmpeg-devel>,  <mailto:ffmpeg-devel-request@ffmpeg.org?subject=subscribe> Reply-To: FFmpeg development discussions and patches <ffmpeg-devel@ffmpeg.org> Cc: Cole Dilorenzo <coolkingcole@gmail.com>, Leo Izen <leo.izen@gmail.com> Content-Type: text/plain; charset="us-ascii" Content-Transfer-Encoding: 7bit Errors-To: ffmpeg-devel-bounces@ffmpeg.org Sender: "ffmpeg-devel" <ffmpeg-devel-bounces@ffmpeg.org> X-TUID: qND0o1HXGcXJ ``` |
| Series | [[FFmpeg-devel,v2] avcodec/jpegxl\_parser: fix OOB read regression](/project/ffmpeg/list/?series=9878) | expand   * [FFmpeg-devel,v2] avcodec/jpegxl\_parser: fix OOB read regression |

## Checks

| Context | Check | Description |
| --- | --- | --- |
| andriy/make\_x86 | success | Make finished |
| andriy/make\_fate\_x86 | success | Make fate finished |

## Commit Message

[Leo Izen](/project/ffmpeg/list/?submitter=306)
Oct. 15, 2023, 12:49 a.m. UTC
```

In f7ac3512f5b5cb8eb149f37300b43461d8e93af3 the size of the dynamically
allocated buffer was shrunk, but it was made too small for very small
alphabet sizes. This patch restores the size to prevent an OOB read.

Reported-by: Cole Dilorenzo <coolkingcole@gmail.com>
Signed-off-by: Leo Izen <leo.izen@gmail.com>
---
 libavcodec/jpegxl_parser.c | 30 +++++++++++++++++-------------
 1 file changed, 17 insertions(+), 13 deletions(-)

```
## Comments

[Leo Izen](/project/ffmpeg/list/?submitter=306)
Oct. 16, 2023, 10:44 a.m. UTC |
[#1](/comment/80347/)

Addressed

Unaddressed

```

On 10/14/23 20:49, Leo Izen wrote:
> In f7ac3512f5b5cb8eb149f37300b43461d8e93af3 the size of the dynamically
> allocated buffer was shrunk, but it was made too small for very small
> alphabet sizes. This patch restores the size to prevent an OOB read.
>
> Reported-by: Cole Dilorenzo <coolkingcole@gmail.com>
> Signed-off-by: Leo Izen <leo.izen@gmail.com>
> ---

Will push soon as it fixes a fuzzer case.

- Leo Izen

```

44263

[diff](/project/ffmpeg/patch/20231015004924.597746-1-leo.izen%40gmail.com/raw/ "Download patch diff")
[mbox](/project/ffmpeg/patch/20231015004924.597746-1-leo.izen%40gmail.com/mbox/ "Download patch mbox")
[series](/series/9878/mbox/ "Download patch mbox with dependencies")
## Patch

```

diff --git a/libavcodec/jpegxl_parser.c b/libavcodec/jpegxl_parser.c
index dde36b0d6e..630fc8a60b 100644
--- a/libavcodec/jpegxl_parser.c
+++ b/libavcodec/jpegxl_parser.c
@@ -683,7 +683,7 @@  static int read_vlc_prefix(GetBitContext *gb, JXLEntropyDecoder *dec, JXLSymbolD
     int repeat_count_prev = 0, repeat_count_zero = 0, prev = 8;
     int total_code = 0, len, hskip, num_codes = 0, ret;

-    VLC level1_vlc;
+    VLC level1_vlc = { 0 };

     if (dist->alphabet_size == 1) {
         dist->vlc.bits = 0;
@@ -709,8 +709,10 @@  static int read_vlc_prefix(GetBitContext *gb, JXLEntropyDecoder *dec, JXLSymbolD
         }
     }

-    if (total_code != 32 && num_codes >= 2 || num_codes < 1)
-        return AVERROR_INVALIDDATA;
+    if (total_code != 32 && num_codes >= 2 || num_codes < 1) {
+        ret = AVERROR_INVALIDDATA;
+        goto end;
+    }

     for (int i = 1; i < 19; i++)
          level1_codecounts[i] += level1_codecounts[i - 1];
@@ -726,7 +728,7 @@  static int read_vlc_prefix(GetBitContext *gb, JXLEntropyDecoder *dec, JXLSymbolD
     if (ret < 0)
         goto end;

-    buf = av_mallocz(dist->alphabet_size * (2 * sizeof(int8_t) + sizeof(int16_t) + sizeof(uint32_t))
+    buf = av_mallocz(MAX_PREFIX_ALPHABET_SIZE * (2 * sizeof(int8_t) + sizeof(int16_t) + sizeof(uint32_t))
                      + sizeof(uint32_t));
     if (!buf) {
         ret = AVERROR(ENOMEM);
@@ -734,21 +736,22 @@  static int read_vlc_prefix(GetBitContext *gb, JXLEntropyDecoder *dec, JXLSymbolD
     }

     level2_lens = (int8_t *)buf;
-    level2_lens_s = (int8_t *)(buf + dist->alphabet_size * sizeof(int8_t));
-    level2_syms = (int16_t *)(buf + dist->alphabet_size * (2 * sizeof(int8_t)));
-    level2_codecounts = (uint32_t *)(buf + dist->alphabet_size * (2 * sizeof(int8_t) + sizeof(int16_t)));
+    level2_lens_s = (int8_t *)(buf + MAX_PREFIX_ALPHABET_SIZE * sizeof(int8_t));
+    level2_syms = (int16_t *)(buf + MAX_PREFIX_ALPHABET_SIZE * (2 * sizeof(int8_t)));
+    level2_codecounts = (uint32_t *)(buf + MAX_PREFIX_ALPHABET_SIZE * (2 * sizeof(int8_t) + sizeof(int16_t)));

     total_code = 0;
     for (int i = 0; i < dist->alphabet_size; i++) {
         len = get_vlc2(gb, level1_vlc.table, 5, 1);
+        if (get_bits_left(gb) < 0) {
+            ret = AVERROR_BUFFER_TOO_SMALL;
+            goto end;
+        }
         if (len == 16) {
             int extra = 3 + get_bits(gb, 2);
             if (repeat_count_prev)
-                extra = 4 * (repeat_count_prev - 2) - repeat_count_prev + extra;
-            if (i + extra > dist->alphabet_size) {
-                ret = AVERROR_INVALIDDATA;
-                goto end;
-            }
+                extra += 4 * (repeat_count_prev - 2) - repeat_count_prev;
+            extra = FFMIN(extra, dist->alphabet_size - i);
             for (int j = 0; j < extra; j++)
                 level2_lens[i + j] = prev;
             total_code += (32768 >> prev) * extra;
@@ -759,7 +762,8 @@  static int read_vlc_prefix(GetBitContext *gb, JXLEntropyDecoder *dec, JXLSymbolD
         } else if (len == 17) {
             int extra = 3 + get_bits(gb, 3);
             if (repeat_count_zero > 0)
-                extra = 8 * (repeat_count_zero - 2) - repeat_count_zero + extra;
+                extra += 8 * (repeat_count_zero - 2) - repeat_count_zero;
+            extra = FFMIN(extra, dist->alphabet_size - i);
             i += extra - 1;
             repeat_count_prev = 0;
             repeat_count_zero += extra;

```

[patchwork](http://jk.ozlabs.org/projects/patchwork/) patch tracking system |
version v3.2.1.post13+gitb22f2c5 |
[about patchwork](/about/)



=== Content from patchwork.ffmpeg.org_caa36d18_20250114_182252.html ===

Toggle navigation

[Patchwork](/)
FFmpeg

* [Patches](/project/ffmpeg/list/)
* [Bundles](/project/ffmpeg/bundles/)
* [About this project](/project/ffmpeg/)

* [Login](/user/login/)
* [Register](/register/)
* [Mail settings](/mail/)

44236

[diff](/project/ffmpeg/patch/20231013014959.536776-1-leo.izen%40gmail.com/raw/ "Download patch diff")
[mbox](/project/ffmpeg/patch/20231013014959.536776-1-leo.izen%40gmail.com/mbox/ "Download patch mbox")
[series](/series/9863/mbox/ "Download patch mbox with dependencies")
# [FFmpeg-devel] avcodec/jpegxl\_parser: fix OOB read regression

| Message ID | 20231013014959.536776-1-leo.izen@gmail.com |
| --- | --- |
| State | New |
| Headers | show ``` Delivered-To: ffmpegpatchwork2@gmail.com Received: by 2002:a05:6a20:4b15:b0:15d:8365:d4b8 with SMTP id  fp21csp713155pzb;         Thu, 12 Oct 2023 18:50:14 -0700 (PDT) X-Google-Smtp-Source:   AGHT+IHiOq7Xe/kvoh1PCj8TbMcmuPVz14MZKZpmXxYcvja4R0Ty4eEzX+9+ZdgSN5pCyP45e6Fu X-Received: by 2002:a17:906:2dd:b0:9b2:babb:5fe9 with SMTP id  29-20020a17090602dd00b009b2babb5fe9mr21876101ejk.23.1697161814695;         Thu, 12 Oct 2023 18:50:14 -0700 (PDT) ARC-Seal: i=1; a=rsa-sha256; t=1697161814; cv=none;         d=google.com; s=arc-20160816;         b=MYcKqaQmiyvt7FNjIF/5JXVRXJamLiu/rYtdTsssduL2Mt5vVEaYyldtbepmJNu3eQ          TVDx7sTXS64oCuiaos5KJ8xkZjeKVdHdSNPDYn66MrRuSaGnlDEfnzLrujLcBJzfTynV          k0LBuqmnpvgGJsR52NGb4KkubM4MHCpjIDrvk93L6pa2O0KKRUmOp3s61Z0euJP851m7          iHzgmutqdBhPg4bsjUDwbtgLZsU+Clj2KJt82DS4MluTOSp9sqkSs/NHaQ3dAc/EPZU+          wn2/yGLEsvde+reDiTCWWZdsppjJRDcsaMvboqCXss9Thh3sTCyuUXyGSiSeJqVLOMTt          21JA== ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com;  s=arc-20160816;         h=sender:errors-to:content-transfer-encoding:cc:reply-to          :list-subscribe:list-help:list-post:list-archive:list-unsubscribe          :list-id:precedence:subject:mime-version:message-id:date:to:from          :dkim-signature:delivered-to;         bh=WN7pgs17lnwSCxgdodMYWHfMTzQtOrVgLrmlIv+zmzo=;         fh=VDN5+TNMvI4QcA450Y5zHrxzCeKSduY8ULDi31AwbZ8=;         b=pMYj+4Q8XlOI50LXW/z0SLIzhEl9U2k4VUCBP7PLMTI9Vl+K7Rnn32yB3ePJ3q2TLq          xId1GnI3jzd5rpHBALO7mHHYvdBM9XGQyy/7cF/c9wA0ywbdaykEmztVNA5ZneuuzWIf          RM+dcV0NQ6YqimMtyifvFGjFq+BOnkQaWK2EiMNXvbk3S+VD7BFsbdywN6LiI4Vpg0K/          XYoH4jhckSSttn6IlynJ6jDBNxF7U1aXLvYf+XNnDz4i36CTFTA+m0vIRZ9//HIdFHXY          Nogk98fd1jmMqPutUZJ83OgYsrC+Iqz2Vmv9Pgru5irTfP9NMwDR+eEtVKEQtxEUh4gx          UkXg== ARC-Authentication-Results: i=1; mx.google.com;        dkim=neutral (body hash did not verify) header.i=@gmail.com  header.s=20230601 header.b=MSuk2EfI;        spf=pass (google.com: domain of ffmpeg-devel-bounces@ffmpeg.org  designates 79.124.17.100 as permitted sender)  smtp.mailfrom=ffmpeg-devel-bounces@ffmpeg.org;        dmarc=fail (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com Return-Path: <ffmpeg-devel-bounces@ffmpeg.org> Received: from ffbox0-bg.mplayerhq.hu (ffbox0-bg.ffmpeg.org. [79.124.17.100])         by mx.google.com with ESMTP id  b13-20020a170906d10d00b009b2a7f2b02asi8150643ejz.687.2023.10.12.18.50.13;         Thu, 12 Oct 2023 18:50:14 -0700 (PDT) Received-SPF: pass (google.com: domain of ffmpeg-devel-bounces@ffmpeg.org  designates 79.124.17.100 as permitted sender) client-ip=79.124.17.100; Authentication-Results: mx.google.com;        dkim=neutral (body hash did not verify) header.i=@gmail.com  header.s=20230601 header.b=MSuk2EfI;        spf=pass (google.com: domain of ffmpeg-devel-bounces@ffmpeg.org  designates 79.124.17.100 as permitted sender)  smtp.mailfrom=ffmpeg-devel-bounces@ffmpeg.org;        dmarc=fail (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com Received: from [127.0.1.1] (localhost [127.0.0.1]) 	by ffbox0-bg.mplayerhq.hu (Postfix) with ESMTP id 5600B68C08B; 	Fri, 13 Oct 2023 04:50:10 +0300 (EEST) X-Original-To: ffmpeg-devel@ffmpeg.org Delivered-To: ffmpeg-devel@ffmpeg.org Received: from mail-qt1-f170.google.com (mail-qt1-f170.google.com  [209.85.160.170])  by ffbox0-bg.mplayerhq.hu (Postfix) with ESMTPS id EF4C968C79E  for <ffmpeg-devel@ffmpeg.org>; Fri, 13 Oct 2023 04:50:03 +0300 (EEST) Received: by mail-qt1-f170.google.com with SMTP id  d75a77b69052e-419bbf3dcb1so2656891cf.0  for <ffmpeg-devel@ffmpeg.org>; Thu, 12 Oct 2023 18:50:03 -0700 (PDT) DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;  d=gmail.com; s=20230601; t=1697161802; x=1697766602; darn=ffmpeg.org;  h=content-transfer-encoding:mime-version:message-id:date:subject:cc  :to:from:from:to:cc:subject:date:message-id:reply-to;  bh=WNUB9BISyNEkr8fXaYdXXf8d/3xbUFvqqY1PgboW7cM=;  b=MSuk2EfIKAhj2mxLfPN8Ni5Ltv4Es+CrcRcX2FzxQe81+Mmsgte66If1KFbSgeewZD  puEEATrpWOGwbNqWWneXyqP4pt5l5T+LgGnED7Ua6waE7kAELj8AyWNrNu++lkgY06HW  OSw+ZhzZKFZ1twOEBzXwBKffJl0LaBqaeTWfZKyCEEO0J4Kd3uqsqZfssfNAZtDpny61  +QW2G2cG2NkOAdyScLRF57YtOXvkMb1kBhK3LeYAnnVwSwsNNs6cqm7Hlu4fpvsMA7Zn  vIlPRqu5NfT/lEsPn0hUR2qnBK9daIVQ7UpfegPRxn348zM3YAa9N3Dmw6jYjQDtUvBn  93GQ== X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;  d=1e100.net; s=20230601; t=1697161802; x=1697766602;  h=content-transfer-encoding:mime-version:message-id:date:subject:cc  :to:from:x-gm-message-state:from:to:cc:subject:date:message-id  :reply-to;  bh=WNUB9BISyNEkr8fXaYdXXf8d/3xbUFvqqY1PgboW7cM=;  b=CC+V7G/fmamQEfz3rjIDJEVJlp2EVUoPLVESv9R7Ukf0RnQcs8Aa/cWsEL3+tfZ9Dj  1XXjqvKTGBYtr7m+2Z2fXBKuwtTOLgZpNfcKkvPmYW6eRmYzryWJPad3qjPip1V1Yb/Y  YAJ4QRw0R8iAQcXF0kmd22oGSCFRmCTVKEz/9vSHbPvDzjoQlzMYyNxeo32tCpSR7mrU  6ZsHZNnSn8kufJ9v+cKplGyM1uAvTt1P/N7lt+0xr9feqgtj1ToT1PludrqcPEUZ7Luk  VzFwCMy7Sl1gQi0FdEMsXglklBnail1VhzC/spe0QP54Vn+zUJ8YO2FOLTuiubWdvTm5  Iu/w== X-Gm-Message-State: AOJu0Yx5OdfoUwl570vor6qLgmhEo+BU6/AnVRRSXB6UiRI6hjYdBMKF  IUH3PKZrgQRyETzD3OcgOhJk+1/p8JpLrg== X-Received: by 2002:ac8:5a05:0:b0:412:2dd3:e0ed with SMTP id  n5-20020ac85a05000000b004122dd3e0edmr31288229qta.0.1697161802438;  Thu, 12 Oct 2023 18:50:02 -0700 (PDT) Received: from gauss.local (c-68-56-149-176.hsd1.mi.comcast.net.  [68.56.149.176]) by smtp.gmail.com with ESMTPSA id  h4-20020ac87444000000b004179e79069asm233967qtr.21.2023.10.12.18.50.01  (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);  Thu, 12 Oct 2023 18:50:02 -0700 (PDT) From: Leo Izen <leo.izen@gmail.com> To: ffmpeg-devel@ffmpeg.org Date: Thu, 12 Oct 2023 21:49:59 -0400 Message-ID: <20231013014959.536776-1-leo.izen@gmail.com> X-Mailer: git-send-email 2.42.0 MIME-Version: 1.0 Subject: [FFmpeg-devel] [PATCH] avcodec/jpegxl_parser: fix OOB read  regression X-BeenThere: ffmpeg-devel@ffmpeg.org X-Mailman-Version: 2.1.29 Precedence: list List-Id: FFmpeg development discussions and patches <ffmpeg-devel.ffmpeg.org> List-Unsubscribe: <https://ffmpeg.org/mailman/options/ffmpeg-devel>,  <mailto:ffmpeg-devel-request@ffmpeg.org?subject=unsubscribe> List-Archive: <https://ffmpeg.org/pipermail/ffmpeg-devel> List-Post: <mailto:ffmpeg-devel@ffmpeg.org> List-Help: <mailto:ffmpeg-devel-request@ffmpeg.org?subject=help> List-Subscribe: <https://ffmpeg.org/mailman/listinfo/ffmpeg-devel>,  <mailto:ffmpeg-devel-request@ffmpeg.org?subject=subscribe> Reply-To: FFmpeg development discussions and patches <ffmpeg-devel@ffmpeg.org> Cc: Cole Dilorenzo <coolkingcole@gmail.com>, Leo Izen <leo.izen@gmail.com> Content-Type: text/plain; charset="us-ascii" Content-Transfer-Encoding: 7bit Errors-To: ffmpeg-devel-bounces@ffmpeg.org Sender: "ffmpeg-devel" <ffmpeg-devel-bounces@ffmpeg.org> X-TUID: UtC3s5Noo1e5 ``` |
| Series | [[FFmpeg-devel] avcodec/jpegxl\_parser: fix OOB read regression](/project/ffmpeg/list/?series=9863) | expand   * [FFmpeg-devel] avcodec/jpegxl\_parser: fix OOB read regression |

## Checks

| Context | Check | Description |
| --- | --- | --- |
| andriy/make\_x86 | success | Make finished |
| andriy/make\_fate\_x86 | success | Make fate finished |

## Commit Message

[Leo Izen](/project/ffmpeg/list/?submitter=306)
Oct. 13, 2023, 1:49 a.m. UTC
```

In f7ac3512f5b5cb8eb149f37300b43461d8e93af3 the size of the dynamically
allocated buffer was shrunk, but it was made too small for very small
alphabet sizes. This patch sets a minimum size to prevent an OOB read.

Reported-by: Cole Dilorenzo <coolkingcole@gmail.com>
Signed-off-by: Leo Izen <leo.izen@gmail.com>
---
 libavcodec/jpegxl_parser.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

```

44236

[diff](/project/ffmpeg/patch/20231013014959.536776-1-leo.izen%40gmail.com/raw/ "Download patch diff")
[mbox](/project/ffmpeg/patch/20231013014959.536776-1-leo.izen%40gmail.com/mbox/ "Download patch mbox")
[series](/series/9863/mbox/ "Download patch mbox with dependencies")
## Patch

```

diff --git a/libavcodec/jpegxl_parser.c b/libavcodec/jpegxl_parser.c
index dde36b0d6e..e00e01e82b 100644
--- a/libavcodec/jpegxl_parser.c
+++ b/libavcodec/jpegxl_parser.c
@@ -726,8 +726,8 @@  static int read_vlc_prefix(GetBitContext *gb, JXLEntropyDecoder *dec, JXLSymbolD
     if (ret < 0)
         goto end;

-    buf = av_mallocz(dist->alphabet_size * (2 * sizeof(int8_t) + sizeof(int16_t) + sizeof(uint32_t))
-                     + sizeof(uint32_t));
+    buf = av_mallocz(dist->alphabet_size * (2 * sizeof(int8_t) + sizeof(int16_t))
+        + FFMAX(15, dist->alphabet_size + 1) * sizeof(uint32_t));
     if (!buf) {
         ret = AVERROR(ENOMEM);
         goto end;

```

[patchwork](http://jk.ozlabs.org/projects/patchwork/) patch tracking system |
version v3.2.1.post13+gitb22f2c5 |
[about patchwork](/about/)


