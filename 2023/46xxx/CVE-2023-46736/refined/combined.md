=== Content from github.com_26888feb_20250114_195639.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fespocrm%2Fespocrm%2Fsecurity%2Fadvisories%2FGHSA-g955-rwxx-jvf6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fespocrm%2Fespocrm%2Fsecurity%2Fadvisories%2FGHSA-g955-rwxx-jvf6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=espocrm%2Fespocrm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[espocrm](/espocrm)
/
**[espocrm](/espocrm/espocrm)**
Public

* [Notifications](/login?return_to=%2Fespocrm%2Fespocrm) You must be signed in to change notification settings
* [Fork
  592](/login?return_to=%2Fespocrm%2Fespocrm)
* [Star
   1.9k](/login?return_to=%2Fespocrm%2Fespocrm)

* [Code](/espocrm/espocrm)
* [Issues
  47](/espocrm/espocrm/issues)
* [Pull requests
  3](/espocrm/espocrm/pulls)
* [Actions](/espocrm/espocrm/actions)
* [Security](/espocrm/espocrm/security)
* [Insights](/espocrm/espocrm/pulse)

Additional navigation options

* [Code](/espocrm/espocrm)
* [Issues](/espocrm/espocrm/issues)
* [Pull requests](/espocrm/espocrm/pulls)
* [Actions](/espocrm/espocrm/actions)
* [Security](/espocrm/espocrm/security)
* [Insights](/espocrm/espocrm/pulse)

# SSRF via /Attachment/fromImageUrl endpoint

Moderate

[yurikuzn](/yurikuzn)
published
GHSA-g955-rwxx-jvf6
Dec 5, 2023

## Package

espocrm
(PHP)

## Affected versions

<=8.0.2

## Patched versions

8.0.5

## Description

### Summary

There is SSRF via the upload image from url api.

### Details

Users that can use the /Attachment/fromImageUrl can specify URL to point to an internal host. Even though there is check for content type, it can be bypassed by redirects in some cases.

### PoC

Login as a user who can access attachments APIs, with credentials, make a post request to /api/v1/Attachment/fromImageUrl

with the following data

```
{
"url": "http://localhost:8888",
"parentType": "Note",
 "field":  "attachments"
}

```

On server side, listen on `localhost:8888` and it will receive a request, which normally shouldn't be accessible from outside.

To bypass content type check, use a redirect, for example, by using `https://ssrf.localdomain.pw/img-with-body/301-http-127.0.0.1:8888-.i.jpg` as url, which spoofs the content type, and the actual response will be saved as an attachment. Then by using the /api/v1/Attachment/file/id endpoint the response can be retrieved.

### Impact

This SSRF can be leveraged to disclose internal information (in some cases), target internal hosts and bypass firewalls.

See [here](https://owasp.org/Top10/A10_2021-Server-Side_Request_Forgery_%28SSRF%29/) for more information on SSRF and [here](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html) for fix strategies

### Severity

Moderate

### CVE ID

CVE-2023-46736

### Weaknesses

[CWE-918](/advisories?query=cwe%3A918)

### Credits

* [![@asesidaa](https://avatars.githubusercontent.com/u/26689773?s=40&v=4)](/asesidaa)
  [asesidaa](/asesidaa)
  Reporter
* [![@yurikuzn](https://avatars.githubusercontent.com/u/1006792?s=40&v=4)](/yurikuzn)
  [yurikuzn](/yurikuzn)
  Remediation developer

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from owasp.org_a4790d71_20250114_195640.html ===


[Skip to content](#a102021-server-side-request-forgery-ssrf)

[![logo](../assets/OWASP_Logo_Transp.png)](.. "OWASP Top 10:2021")

OWASP Top 10:2021

A10 Server Side Request Forgery (SSRF)

* [en - English](../)
* [ar - ﺎﻠﻋﺮﺒﻳﺓ](../ar/)
* [de - Deutsch](../de/)
* [es - Español](../es/)
* [fr - Français](../fr/)
* [id - Indonesian](../id/)
* [it - Italiano](../it/)
* [ja - 日本語](../ja/)
* [pt\_BR - Português (Brasil)](../pt_BR/)
* [zh\_CN - 简体中文](../zh_CN/)
* [zh\_TW - 繁體中文](../zh_TW/)

[OWASP/Top10](https://github.com/OWASP/Top10 "Go to repository")

[![logo](../assets/OWASP_Logo_Transp.png)](.. "OWASP Top 10:2021")
OWASP Top 10:2021

[OWASP/Top10](https://github.com/OWASP/Top10 "Go to repository")

* [Home](..)
* [Notice](../0x00-notice/)
* [Introduction](../A00_2021_Introduction/)
* [How to use the OWASP Top 10 as a standard](../A00_2021_How_to_use_the_OWASP_Top_10_as_a_standard/)
* [How to start an AppSec program with the OWASP Top 10](../A00_2021-How_to_start_an_AppSec_program_with_the_OWASP_Top_10/)
* [About OWASP](../A00-about-owasp/)
* Top 10:2021 List

  Top 10:2021 List
  + [A01 Broken Access Control](../A01_2021-Broken_Access_Control/)
  + [A02 Cryptographic Failures](../A02_2021-Cryptographic_Failures/)
  + [A03 Injection](../A03_2021-Injection/)
  + [A04 Insecure Design](../A04_2021-Insecure_Design/)
  + [A05 Security Misconfiguration](../A05_2021-Security_Misconfiguration/)
  + [A06 Vulnerable and Outdated Components](../A06_2021-Vulnerable_and_Outdated_Components/)
  + [A07 Identification and Authentication Failures](../A07_2021-Identification_and_Authentication_Failures/)
  + [A08 Software and Data Integrity Failures](../A08_2021-Software_and_Data_Integrity_Failures/)
  + [A09 Security Logging and Monitoring Failures](../A09_2021-Security_Logging_and_Monitoring_Failures/)
  + A10 Server Side Request Forgery (SSRF)

    [A10 Server Side Request Forgery (SSRF)](./)

    Table of contents
    - [Factors](#factors)
    - [Overview](#overview)
    - [Description](#description)
    - [How to Prevent](#how-to-prevent)
      * [From Network layer](#from-network-layer)
      * [From Application layer:](#from-application-layer)
      * [Additional Measures to consider:](#additional-measures-to-consider)
    - [Example Attack Scenarios](#example-attack-scenarios)
    - [References](#references)
    - [List of Mapped CWEs](#list-of-mapped-cwes)
* [Next Steps](../A11_2021-Next_Steps/)

Table of contents

* [Factors](#factors)
* [Overview](#overview)
* [Description](#description)
* [How to Prevent](#how-to-prevent)
  + [From Network layer](#from-network-layer)
  + [From Application layer:](#from-application-layer)
  + [Additional Measures to consider:](#additional-measures-to-consider)
* [Example Attack Scenarios](#example-attack-scenarios)
* [References](#references)
* [List of Mapped CWEs](#list-of-mapped-cwes)

# A10:2021 – Server-Side Request Forgery (SSRF) icon

## Factors

| CWEs Mapped | Max Incidence Rate | Avg Incidence Rate | Avg Weighted Exploit | Avg Weighted Impact | Max Coverage | Avg Coverage | Total Occurrences | Total CVEs |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 1 | 2.72% | 2.72% | 8.28 | 6.72 | 67.72% | 67.72% | 9,503 | 385 |

## Overview

This category is added from the Top 10 community survey (#1). The data shows a
relatively low incidence rate with above average testing coverage and
above-average Exploit and Impact potential ratings. As new entries are
likely to be a single or small cluster of Common Weakness Enumerations (CWEs)
for attention and
awareness, the hope is that they are subject to focus and can be rolled
into a larger category in a future edition.

## Description

SSRF flaws occur whenever a web application is fetching a remote
resource without validating the user-supplied URL. It allows an attacker
to coerce the application to send a crafted request to an unexpected
destination, even when protected by a firewall, VPN, or another type of
network access control list (ACL).

As modern web applications provide end-users with convenient features,
fetching a URL becomes a common scenario. As a result, the incidence of
SSRF is increasing. Also, the severity of SSRF is becoming higher due to
cloud services and the complexity of architectures.

## How to Prevent

Developers can prevent SSRF by implementing some or all the following
defense in depth controls:

### **From Network layer**

* Segment remote resource access functionality in separate networks to
  reduce the impact of SSRF
* Enforce “deny by default” firewall policies or network access
  control rules to block all but essential intranet traffic.

  *Hints:*

  ~ Establish an ownership and a lifecycle for firewall rules based on applications.

### **From Application layer:**

* Sanitize and validate all client-supplied input data
* Enforce the URL schema, port, and destination with a positive allow
  list
* Do not send raw responses to clients
* Disable HTTP redirections
* Be aware of the URL consistency to avoid attacks such as DNS
  rebinding and “time of check, time of use” (TOCTOU) race conditions

Do not mitigate SSRF via the use of a deny list or regular expression.
Attackers have payload lists, tools, and skills to bypass deny lists.

### **Additional Measures to consider:**

* Don't deploy other security relevant services on front systems (e.g. OpenID).
  Control local traffic on these systems (e.g. localhost)
* For frontends with dedicated and manageable user groups use network encryption (e.g. VPNs)
  on independent systems to consider very high protection needs

## Example Attack Scenarios

Attackers can use SSRF to attack systems protected behind web
application firewalls, firewalls, or network ACLs, using scenarios such
as:

**Scenario #1:** Port scan internal servers – If the network architecture
is unsegmented, attackers can map out internal networks and determine if
ports are open or closed on internal servers from connection results or
elapsed time to connect or reject SSRF payload connections.

**Scenario #2:** Sensitive data exposure – Attackers can access local
files or internal services to gain sensitive information such
as `file:///etc/passwd` and `http://localhost:28017/`.

**Scenario #3:** Access metadata storage of cloud services – Most cloud
providers have metadata storage such as `http://169.254.169.254/`. An
attacker can read the metadata to gain sensitive information.

**Scenario #4:** Compromise internal services – The attacker can abuse
internal services to conduct further attacks such as Remote Code
Execution (RCE) or Denial of Service (DoS).

## References

* [OWASP - Server-Side Request Forgery Prevention Cheat
  Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
* [PortSwigger - Server-side request forgery
  (SSRF)](https://portswigger.net/web-security/ssrf)
* [Acunetix - What is Server-Side Request Forgery
  (SSRF)?](https://www.acunetix.com/blog/articles/server-side-request-forgery-vulnerability/)
* [SSRF
  bible](https://cheatsheetseries.owasp.org/assets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet_SSRF_Bible.pdf)
* [A New Era of SSRF - Exploiting URL Parser in Trending Programming
  Languages!](https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf)

## List of Mapped CWEs

[CWE-918 Server-Side Request Forgery (SSRF)](https://cwe.mitre.org/data/definitions/918.html)

© Copyright 2021 - OWASP Top 10 team - This work is licensed under a [Creative Commons Attribution 3.0 Unported License](http://creativecommons.org/licenses/by/3.0/deed.en_US).

Made with
[Material for MkDocs](https://squidfunk.github.io/mkdocs-material/)



=== Content from github.com_1696f912_20250114_195638.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fespocrm%2Fespocrm%2Fcommit%2Fc536cee6375e2088f961af13db7aaa652c983072)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fespocrm%2Fespocrm%2Fcommit%2Fc536cee6375e2088f961af13db7aaa652c983072)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=espocrm%2Fespocrm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[espocrm](/espocrm)
/
**[espocrm](/espocrm/espocrm)**
Public

* [Notifications](/login?return_to=%2Fespocrm%2Fespocrm) You must be signed in to change notification settings
* [Fork
  592](/login?return_to=%2Fespocrm%2Fespocrm)
* [Star
   1.9k](/login?return_to=%2Fespocrm%2Fespocrm)

* [Code](/espocrm/espocrm)
* [Issues
  47](/espocrm/espocrm/issues)
* [Pull requests
  3](/espocrm/espocrm/pulls)
* [Actions](/espocrm/espocrm/actions)
* [Security](/espocrm/espocrm/security)
* [Insights](/espocrm/espocrm/pulse)

Additional navigation options

* [Code](/espocrm/espocrm)
* [Issues](/espocrm/espocrm/issues)
* [Pull requests](/espocrm/espocrm/pulls)
* [Actions](/espocrm/espocrm/actions)
* [Security](/espocrm/espocrm/security)
* [Insights](/espocrm/espocrm/pulse)

## Commit

[Permalink](/espocrm/espocrm/commit/c536cee6375e2088f961af13db7aaa652c983072)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

image upload url check

[Browse files](/espocrm/espocrm/tree/c536cee6375e2088f961af13db7aaa652c983072)
Browse the repository at this point in the history

* Loading branch information

[![@yurikuzn](https://avatars.githubusercontent.com/u/1006792?s=40&v=4)](/yurikuzn)

[yurikuzn](/espocrm/espocrm/commits?author=yurikuzn "View all commits by yurikuzn")
committed
Nov 6, 2023

1 parent
[b1d2795](/espocrm/espocrm/commit/b1d2795347bf1255d03871e2076771e8578edd38)

commit c536cee

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**107 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* application/Espo

  + Core/Utils/Security

    - application/Espo/Core/Utils/Security/UrlCheck.php
      [UrlCheck.php](#diff-38074d6189fe354ee22463487f89eb957fa06896cbb5769b382858623eb7dd88)
  + Tools/Attachment

    - application/Espo/Tools/Attachment/UploadUrlService.php
      [UploadUrlService.php](#diff-f8b310691c0dfae97aeb5d862ce2169dffd343e20885e00fa9dae98c381e0169)

## There are no files selected for viewing

95 changes: 95 additions & 0 deletions

95
[application/Espo/Core/Utils/Security/UrlCheck.php](#diff-38074d6189fe354ee22463487f89eb957fa06896cbb5769b382858623eb7dd88 "application/Espo/Core/Utils/Security/UrlCheck.php")

Show comments

[View file](/espocrm/espocrm/blob/c536cee6375e2088f961af13db7aaa652c983072/application/Espo/Core/Utils/Security/UrlCheck.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,95 @@ |
|  |  | <?php |
|  |  | /\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* |
|  |  | \* This file is part of EspoCRM. |
|  |  | \* |
|  |  | \* EspoCRM - Open Source CRM application. |
|  |  | \* Copyright (C) 2014-2023 Yurii Kuznietsov, Taras Machyshyn, Oleksii Avramenko |
|  |  | \* Website: https://www.espocrm.com |
|  |  | \* |
|  |  | \* EspoCRM is free software: you can redistribute it and/or modify |
|  |  | \* it under the terms of the GNU General Public License as published by |
|  |  | \* the Free Software Foundation, either version 3 of the License, or |
|  |  | \* (at your option) any later version. |
|  |  | \* |
|  |  | \* EspoCRM is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the |
|  |  | \* GNU General Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the GNU General Public License |
|  |  | \* along with EspoCRM. If not, see http://www.gnu.org/licenses/. |
|  |  | \* |
|  |  | \* The interactive user interfaces in modified source and object code versions |
|  |  | \* of this program must display Appropriate Legal Notices, as required under |
|  |  | \* Section 5 of the GNU General Public License version 3. |
|  |  | \* |
|  |  | \* In accordance with Section 7(b) of the GNU General Public License version 3, |
|  |  | \* these Appropriate Legal Notices must retain the display of the "EspoCRM" word. |
|  |  | \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/ |
|  |  |  |
|  |  | namespace Espo\Core\Utils\Security; |
|  |  |  |
|  |  | use const DNS\_A; |
|  |  | use const FILTER\_FLAG\_NO\_PRIV\_RANGE; |
|  |  | use const FILTER\_FLAG\_NO\_RES\_RANGE; |
|  |  | use const FILTER\_VALIDATE\_IP; |
|  |  | use const FILTER\_VALIDATE\_URL; |
|  |  | use const PHP\_URL\_HOST; |
|  |  |  |
|  |  | class UrlCheck |
|  |  | { |
|  |  | public function isUrl(string $url): bool |
|  |  | { |
|  |  | return filter\_var($url, FILTER\_VALIDATE\_URL) !== false; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Checks whether a URL does not follow to an internal host. |
|  |  | \*/ |
|  |  | public function isNotInternalUrl(string $url): bool |
|  |  | { |
|  |  | if (!$this->isUrl($url)) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | $host = parse\_url($url, PHP\_URL\_HOST); |
|  |  |  |
|  |  | if (!is\_string($host)) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | $records = dns\_get\_record($host, DNS\_A); |
|  |  |  |
|  |  | if (filter\_var($host, FILTER\_VALIDATE\_IP)) { |
|  |  | return $this->ipAddressIsNotInternal($host); |
|  |  | } |
|  |  |  |
|  |  | if (!$records) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | foreach ($records as $record) { |
|  |  | /\*\* @var ?string $idAddress \*/ |
|  |  | $idAddress = $record['ip'] ?? null; |
|  |  |  |
|  |  | if (!$idAddress) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | if (!$this->ipAddressIsNotInternal($idAddress)) { |
|  |  | return false; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | private function ipAddressIsNotInternal(string $ipAddress): bool |
|  |  | { |
|  |  | return (bool) filter\_var( |
|  |  | $ipAddress, |
|  |  | FILTER\_VALIDATE\_IP, |
|  |  | FILTER\_FLAG\_NO\_PRIV\_RANGE | FILTER\_FLAG\_NO\_RES\_RANGE |
|  |  | ); |
|  |  | } |
|  |  | } |

14 changes: 12 additions & 2 deletions

14
[application/Espo/Tools/Attachment/UploadUrlService.php](#diff-f8b310691c0dfae97aeb5d862ce2169dffd343e20885e00fa9dae98c381e0169 "application/Espo/Tools/Attachment/UploadUrlService.php")

Show comments

[View file](/espocrm/espocrm/blob/c536cee6375e2088f961af13db7aaa652c983072/application/Espo/Tools/Attachment/UploadUrlService.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,8 +32,10 @@ |
|  |  | use Espo\Core\Exceptions\Error; |
|  |  | use Espo\Core\Exceptions\ErrorSilent; |
|  |  | use Espo\Core\Exceptions\Forbidden; |
|  |  | use Espo\Core\Exceptions\ForbiddenSilent; |
|  |  | use Espo\Core\Utils\File\MimeType; |
|  |  | use Espo\Core\Utils\Metadata; |
|  |  | use Espo\Core\Utils\Security\UrlCheck; |
|  |  | use Espo\Entities\Attachment as Attachment; |
|  |  | use Espo\ORM\EntityManager; |
|  |  | use Espo\Repositories\Attachment as AttachmentRepository; |
| Expand All | | @@ -51,7 +53,8 @@ public function \_\_construct( |
|  |  | Metadata $metadata, |
|  |  | EntityManager $entityManager, |
|  |  | MimeType $mimeType, |
|  |  | DetailsObtainer $detailsObtainer |
|  |  | DetailsObtainer $detailsObtainer, |
|  |  | private UrlCheck $urlCheck |
|  |  | ) { |
|  |  | $this->accessChecker = $accessChecker; |
|  |  | $this->metadata = $metadata; |
| Expand All | | @@ -68,6 +71,10 @@ public function \_\_construct( |
|  |  | \*/ |
|  |  | public function uploadImage(string $url, FieldData $data): Attachment |
|  |  | { |
|  |  | if (!$this->urlCheck->isNotInternalUrl($url)) { |
|  |  | throw new ForbiddenSilent("Not allowed URL."); |
|  |  | } |
|  |  |  |
|  |  | $attachment = $this->getAttachmentRepository()->getNew(); |
|  |  |  |
|  |  | $this->accessChecker->check($data); |
| Expand Down  Expand Up | | @@ -130,9 +137,12 @@ private function getImageDataByUrl(string $url): ?array |
|  |  | $opts[\CURLOPT\_SSL\_VERIFYPEER] = true; |
|  |  | $opts[\CURLOPT\_SSL\_VERIFYHOST] = 2; |
|  |  | $opts[\CURLOPT\_RETURNTRANSFER] = true; |
|  |  | $opts[\CURLOPT\_FOLLOWLOCATION] = true; |
|  |  | // Prevents Server Side Request Forgery by redirecting to an internal host. |
|  |  | $opts[\CURLOPT\_FOLLOWLOCATION] = false; |
|  |  | $opts[\CURLOPT\_MAXREDIRS] = 2; |
|  |  | $opts[\CURLOPT\_IPRESOLVE] = \CURL\_IPRESOLVE\_V4; |
|  |  | $opts[\CURLOPT\_PROTOCOLS] = \CURLPROTO\_HTTPS | \CURLPROTO\_HTTP; |
|  |  | $opts[\CURLOPT\_REDIR\_PROTOCOLS] = \CURLPROTO\_HTTPS; |
|  |  |  |
|  |  | $ch = curl\_init(); |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c536cee`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fespocrm%2Fespocrm%2Fcommit%2Fc536cee6375e2088f961af13db7aaa652c983072) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


