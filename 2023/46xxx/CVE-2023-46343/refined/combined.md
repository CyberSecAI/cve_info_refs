=== Content from cdn.kernel.org_b9a43e54_20250114_203037.html ===
commit d0e42510ae8347e27d416356291b7546fb7681f5
Author: Greg Kroah-Hartman
Date: Wed Oct 25 12:16:30 2023 +0200
Linux 6.5.9
Link: https://lore.kernel.org/r/20231023104833.832874523@linuxfoundation.org
Tested-by: SeongJae Park
Tested-by: Ricardo B. Marliere
Tested-by: Ronald Warsow
Tested-by: Justin M. Forbes
Tested-by: Florian Fainelli
Tested-by: Ron Economos
Tested-by: Bagas Sanjaya
Tested-by: Linux Kernel Functional Testing
Tested-by: Sudip Mukherjee
Tested-by: Salvatore Bonaccorso
Tested-by: Guenter Roeck
Tested-by: Miguel Ojeda  # Rust
Signed-off-by: Greg Kroah-Hartman
commit f879295c92b106ec953a5dab0f9ec0fae7b4da1c
Author: Matthieu Baerts
Date: Wed Oct 18 11:23:52 2023 -0700
selftests: mptcp: join: correctly check for no RST
commit b134a5805455d1886662a6516c965cdb9df9fbcc upstream.
The commit mentioned below was more tolerant with the number of RST seen
during a test because in some uncontrollable situations, multiple RST
can be generated.
But it was not taking into account the case where no RST are expected:
this validation was then no longer reporting issues for the 0 RST case
because it is not possible to have less than 0 RST in the counter. This
patch fixes the issue by adding a specific condition.
Fixes: 6bf41020b72b ("selftests: mptcp: update and extend fastclose test-cases")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau
Signed-off-by: Matthieu Baerts
Signed-off-by: Mat Martineau
Link: https://lore.kernel.org/r/20231018-send-net-20231018-v1-1-17ecb002e41d@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Matthieu Baerts
Signed-off-by: Greg Kroah-Hartman
commit 85577dd61990f105564432d944cd50ed7819d8e9
Author: Geliang Tang
Date: Wed Oct 18 11:23:55 2023 -0700
mptcp: avoid sending RST when closing the initial subflow
commit 14c56686a64c65ba716ff48f1f4b19c85f4cb2a9 upstream.
When closing the first subflow, the MPTCP protocol unconditionally
calls tcp\_disconnect(), which in turn generates a reset if the subflow
is established.
That is unexpected and different from what MPTCP does with MPJ
subflows, where resets are generated only on FASTCLOSE and other edge
scenarios.
We can't reuse for the first subflow the same code in place for MPJ
subflows, as MPTCP clean them up completely via a tcp\_close() call,
while must keep the first subflow socket alive for later re-usage, due
to implementation constraints.
This patch adds a new helper \_\_mptcp\_subflow\_disconnect() that
encapsulates, a logic similar to tcp\_close, issuing a reset only when
the MPTCP\_CF\_FASTCLOSE flag is set, and performing a clean shutdown
otherwise.
Fixes: c2b2ae3925b6 ("mptcp: handle correctly disconnect() failures")
Cc: stable@vger.kernel.org
Reviewed-by: Matthieu Baerts
Co-developed-by: Paolo Abeni
Signed-off-by: Paolo Abeni
Signed-off-by: Geliang Tang
Signed-off-by: Mat Martineau
Link: https://lore.kernel.org/r/20231018-send-net-20231018-v1-4-17ecb002e41d@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Matthieu Baerts
Signed-off-by: Greg Kroah-Hartman
commit 1978b69212ed7419acb4570c313343dd9ee10e43
Author: Kees Cook
Date: Wed Oct 11 09:31:44 2023 -0700
Bluetooth: hci\_sock: Correctly bounds check and pad HCI\_MON\_NEW\_INDEX name
commit cb3871b1cd135a6662b732fbc6b3db4afcdb4a64 upstream.
The code pattern of memcpy(dst, src, strlen(src)) is almost always
wrong. In this case it is wrong because it leaves memory uninitialized
if it is less than sizeof(ni->name), and overflows ni->name when longer.
Normally strtomem\_pad() could be used here, but since ni->name is a
trailing array in struct hci\_mon\_new\_index, compilers that don't support
-fstrict-flex-arrays=3 can't tell how large this array is via
\_\_builtin\_object\_size(). Instead, open-code the helper and use sizeof()
since it will work correctly.
Additionally mark ni->name as \_\_nonstring since it appears to not be a
%NUL terminated C string.
Cc: Luiz Augusto von Dentz
Cc: Edward AD
Cc: Marcel Holtmann
Cc: Johan Hedberg
Cc: "David S. Miller"
Cc: Eric Dumazet
Cc: Jakub Kicinski
Cc: Paolo Abeni
Cc: linux-bluetooth@vger.kernel.org
Cc: netdev@vger.kernel.org
Fixes: 18f547f3fc07 ("Bluetooth: hci\_sock: fix slab oob read in create\_monitor\_event")
Link: https://lore.kernel.org/lkml/202310110908.F2639D3276@keescook/
Signed-off-by: Kees Cook
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 2a3c9d689d6be78d5520739c682e6ad3235acfd4
Author: Miguel Ojeda
Date: Wed Oct 18 18:01:45 2023 +0200
kbuild: remove old Rust docs output path
commit 1db773da58df20772dcc037a47163ce472d39c4d upstream.
The Rust code documentation output path moved from `rust/doc` to
`Documentation/output/rust/rustdoc`. The `make cleandocs` target
takes care of cleaning it now since it is integrated with the rest
of the documentation.
Thus remove the old reference.
Fixes: 48fadf440075 ("docs: Move rustdoc output, cross-reference it")
Reviewed-by: Benno Lossin
Reviewed-by: Alice Ryhl
Reviewed-by: Andreas Hindborg
Link: https://lore.kernel.org/r/20231018160145.1017340-2-ojeda@kernel.org
Signed-off-by: Miguel Ojeda
Signed-off-by: Greg Kroah-Hartman
commit 8436370b5a7975137654ddafd46ec1f656f7740a
Author: Miguel Ojeda
Date: Wed Oct 18 18:01:44 2023 +0200
docs: rust: update Rust docs output path
commit bd9e54a42ce26026d67963c21b3fdfe8c7e68430 upstream.
The Rust code documentation output path moved from `rust/doc` to
`Documentation/output/rust/rustdoc`, thus update the old reference.
Fixes: 48fadf440075 ("docs: Move rustdoc output, cross-reference it")
Reviewed-by: Benno Lossin
Reviewed-by: Alice Ryhl
Reviewed-by: Andreas Hindborg
Link: https://lore.kernel.org/r/20231018160145.1017340-1-ojeda@kernel.org
Signed-off-by: Miguel Ojeda
Signed-off-by: Greg Kroah-Hartman
commit 47993576884271535857b61f6bc9ccbaac6c5b7c
Author: Johannes Berg
Date: Wed Oct 11 16:55:10 2023 +0200
net: rfkill: reduce data->mtx scope in rfkill\_fop\_open
commit f2ac54ebf85615a6d78f5eb213a8bbeeb17ebe5d upstream.
In syzbot runs, lockdep reports that there's a (potential)
deadlock here of data->mtx being locked recursively. This
isn't really a deadlock since they are different instances,
but lockdep cannot know, and teaching it would be far more
difficult than other fixes.
At the same time we don't even really \_need\_ the mutex to
be locked in rfkill\_fop\_open(), since we're modifying only
a completely fresh instance of 'data' (struct rfkill\_data)
that's not yet added to the global list.
However, to avoid any reordering etc. within the globally
locked section, and to make the code look more symmetric,
we should still lock the data->events list manipulation,
but also need to lock \_only\_ that. So do that.
Reported-by: syzbot+509238e523e032442b80@syzkaller.appspotmail.com
Fixes: 2c3dfba4cf84 ("rfkill: sync before userspace visibility/changes")
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 2ca5210807f17d2b89290204df86d7bebcb96282
Author: Edward AD
Date: Tue Oct 10 13:36:57 2023 +0800
Bluetooth: hci\_sock: fix slab oob read in create\_monitor\_event
commit 18f547f3fc074500ab5d419cf482240324e73a7e upstream.
When accessing hdev->name, the actual string length should prevail
Reported-by: syzbot+c90849c50ed209d77689@syzkaller.appspotmail.com
Fixes: dcda165706b9 ("Bluetooth: hci\_core: Fix build warnings")
Signed-off-by: Edward AD
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 5a7b9ca3ec2c4041afdf19b1e4cfcae1df04e420
Author: Jakub Kicinski
Date: Tue Oct 17 18:38:16 2023 -0700
net: move altnames together with the netdevice
commit 8e15aee621618a3ee3abecaf1fd8c1428098b7ef upstream.
The altname nodes are currently not moved to the new netns
when netdevice itself moves:
[ ~]# ip netns add test
[ ~]# ip -netns test link add name eth0 type dummy
[ ~]# ip -netns test link property add dev eth0 altname some-name
[ ~]# ip -netns test link show dev some-name
2: eth0:  mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
link/ether 1e:67:ed:19:3d:24 brd ff:ff:ff:ff:ff:ff
altname some-name
[ ~]# ip -netns test link set dev eth0 netns 1
[ ~]# ip link
...
3: eth0:  mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
link/ether 02:40:88:62:ec:b8 brd ff:ff:ff:ff:ff:ff
altname some-name
[ ~]# ip li show dev some-name
Device "some-name" does not exist.
Remove them from the hash table when device is unlisted
and add back when listed again.
Fixes: 36fbf1e52bd3 ("net: rtnetlink: add linkprop commands to add and delete alternative ifnames")
Reviewed-by: Jiri Pirko
Signed-off-by: Jakub Kicinski
Signed-off-by: Paolo Abeni
Signed-off-by: Greg Kroah-Hartman
commit b583bfcc5a36dbd1db1984dbfcfd23ba64d23604
Author: Kirill A. Shutemov
Date: Mon Oct 16 19:31:22 2023 +0300
efi/unaccepted: Fix soft lockups caused by parallel memory acceptance
[ Upstream commit 50e782a86c980d4f8292ef82ed8139282ca07a98 ]
Michael reported soft lockups on a system that has unaccepted memory.
This occurs when a user attempts to allocate and accept memory on
multiple CPUs simultaneously.
The root cause of the issue is that memory acceptance is serialized with
a spinlock, allowing only one CPU to accept memory at a time. The other
CPUs spin and wait for their turn, leading to starvation and soft lockup
reports.
To address this, the code has been modified to release the spinlock
while accepting memory. This allows for parallel memory acceptance on
multiple CPUs.
A newly introduced "accepting\_list" keeps track of which memory is
currently being accepted. This is necessary to prevent parallel
acceptance of the same memory block. If a collision occurs, the lock is
released and the process is retried.
Such collisions should rarely occur. The main path for memory acceptance
is the page allocator, which accepts memory in MAX\_ORDER chunks. As long
as MAX\_ORDER is equal to or larger than the unit\_size, collisions will
never occur because the caller fully owns the memory block being
accepted.
Aside from the page allocator, only memblock and deferered\_free\_range()
accept memory, but this only happens during boot.
The code has been tested with unit\_size == 128MiB to trigger collisions
and validate the retry codepath.
Fixes: 2053bc57f367 ("efi: Add unaccepted memory support")
Signed-off-by: Kirill A. Shutemov
Reported-by: Michael Roth
Reviewed-by: Vlastimil Babka
Tested-by: Michael Roth
[ardb: drop unnecessary cpu\_relax() call]
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
commit 1a19b7394a6c89c29fd49a34ecd5a7c33aaf8d5a
Author: Konrad Dybcio
Date: Mon Sep 11 22:07:15 2023 +0200
phy: qcom-qmp-combo: initialize PCS\_USB registers
[ Upstream commit 76d20290d0c66a84a7a40c6231e73d1ab25994e5 ]
Currently, PCS\_USB registers that have their initialization data in a
pcs\_usb\_tbl table are never initialized. Fix that.
Fixes: fc64623637da ("phy: qcom-qmp-combo,usb: add support for separate PCS\_USB region")
Reported-by: Adrien Thierry
Reviewed-by: Dmitry Baryshkov
Signed-off-by: Konrad Dybcio
Link: https://lore.kernel.org/r/20230829-topic-8550\_usbphy-v3-2-34ec434194c5@linaro.org
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 5389ae6d399d9cb46ab3283c838987b63bff3ad3
Author: Konrad Dybcio
Date: Mon Sep 11 22:07:14 2023 +0200
phy: qcom-qmp-combo: Square out 8550 POWER\_STATE\_CONFIG1
[ Upstream commit 112c23705c6dc59a05290c8e3e597e1b4e9c23fc ]
There are two instances of the POWER\_STATE\_CONFIG1 register: one in
the PCS space and another one in PCS\_USB.
The downstream init sequence pokes the latter one while we've been poking
the former one (and misnamed it as the latter one, impostor!). Fix that
up to avoid UB.
Fixes: 49742e9edab3 ("phy: qcom-qmp-combo: Add support for SM8550")
Reviewed-by: Abel Vesa
Reviewed-by: Dmitry Baryshkov
Signed-off-by: Konrad Dybcio
Link: https://lore.kernel.org/r/20230829-topic-8550\_usbphy-v3-1-34ec434194c5@linaro.org
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 43196ab56d1a4ffe4f9188f3e011929e05bdd101
Author: Adrien Thierry
Date: Mon Aug 28 11:23:51 2023 -0400
phy: qcom-qmp-usb: split PCS\_USB init table for sc8280xp and sa8775p
[ Upstream commit c599dc5cca4dd6a5c664e4a8837246e68a96cb4c ]
For sc8280xp and sa8775p, PCS and PCS\_USB initialization data is
described in the same table, thus the pcs\_usb offset is not being
applied during initialization of PCS\_USB registers. Fix this by adding
the appropriate pcs\_usb\_tbl tables.
Fixes: 8bd2d6e11c99 ("phy: qcom-qmp: Add SA8775P USB3 UNI phy")
Fixes: c0c7769cdae2 ("phy: qcom-qmp: Add SC8280XP USB3 UNI phy")
Reviewed-by: Dmitry Baryshkov
Signed-off-by: Adrien Thierry
Link: https://lore.kernel.org/r/20230828152353.16529-3-athierry@redhat.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit ddf000488df485f9d50520760c706770903b86bd
Author: Adrien Thierry
Date: Mon Aug 28 11:23:50 2023 -0400
phy: qcom-qmp-usb: initialize PCS\_USB registers
[ Upstream commit 2d3465a75c9f83684d17da6807423824bf260524 ]
Currently, PCS\_USB registers that have their initialization data in a
pcs\_usb\_tbl table are never initialized. Fix that.
Fixes: fc64623637da ("phy: qcom-qmp-combo,usb: add support for separate PCS\_USB region")
Signed-off-by: Adrien Thierry
Reviewed-by: Dmitry Baryshkov
Link: https://lore.kernel.org/r/20230828152353.16529-2-athierry@redhat.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 2a90676f997ae3fd7fe7280ba995c22ec16d5d0b
Author: Tony Lindgren
Date: Wed Sep 13 09:04:29 2023 +0300
phy: mapphone-mdm6600: Fix pinctrl\_pm handling for sleep pins
[ Upstream commit 3b384cc74b00b5ac21d18e4c1efc3c1da5300971 ]
Looks like the driver sleep pins configuration is unusable. Adding the
sleep pins causes the usb phy to not respond. We need to use the default
pins in probe, and only set sleep pins at phy\_mdm6600\_device\_power\_off().
As the modem can also be booted to a serial port mode for firmware
flashing, let's make the pin changes limited to probe and remove. For
probe, we get the default pins automatically. We only need to set the
sleep pins in phy\_mdm6600\_device\_power\_off() to prevent the modem from
waking up because the gpio line glitches.
If it turns out that we need a separate state for phy\_mdm6600\_power\_on()
and phy\_mdm6600\_power\_off(), we can use the pinctrl idle state.
Cc: Ivaylo Dimitrov
Cc: Merlijn Wajer
Cc: Pavel Machek
Cc: Sebastian Reichel
Fixes: 2ad2af081622 ("phy: mapphone-mdm6600: Improve phy related runtime PM calls")
Signed-off-by: Tony Lindgren
Reviewed-by: Sebastian Reichel
Link: https://lore.kernel.org/r/20230913060433.48373-3-tony@atomide.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit da02a53bd04ab991cf42ca9bf4c719427a553e9b
Author: Tony Lindgren
Date: Wed Sep 13 09:04:28 2023 +0300
phy: mapphone-mdm6600: Fix runtime PM for remove
[ Upstream commit b99e0ba9633af51638e5ee1668da2e33620c134f ]
Otherwise we will get an underflow on remove.
Cc: Ivaylo Dimitrov
Cc: Merlijn Wajer
Cc: Pavel Machek
Cc: Sebastian Reichel
Fixes: f7f50b2a7b05 ("phy: mapphone-mdm6600: Add runtime PM support for n\_gsm on USB suspend")
Signed-off-by: Tony Lindgren
Reviewed-by: Sebastian Reichel
Link: https://lore.kernel.org/r/20230913060433.48373-2-tony@atomide.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 9f35d798d13d42d1b03b3c2c6dd0838ae989911e
Author: Tony Lindgren
Date: Wed Sep 13 09:04:27 2023 +0300
phy: mapphone-mdm6600: Fix runtime disable on probe
[ Upstream commit 719606154c7033c068a5d4c1dc5f9163b814b3c8 ]
Commit d644e0d79829 ("phy: mapphone-mdm6600: Fix PM error handling in
phy\_mdm6600\_probe") caused a regression where we now unconditionally
disable runtime PM at the end of the probe while it is only needed on
errors.
Cc: Ivaylo Dimitrov
Cc: Merlijn Wajer
Cc: Miaoqian Lin
Cc: Pavel Machek
Reviewed-by: Sebastian Reichel
Fixes: d644e0d79829 ("phy: mapphone-mdm6600: Fix PM error handling in phy\_mdm6600\_probe")
Signed-off-by: Tony Lindgren
Link: https://lore.kernel.org/r/20230913060433.48373-1-tony@atomide.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 69cd191012486b1f040c1dca5e2e6ebe414bb107
Author: Miguel Ojeda
Date: Wed Oct 18 17:55:27 2023 +0200
rust: docs: fix logo replacement
[ Upstream commit cfd96726e61136e68a168813cedc4084f626208b ]
The static files placement by `rustdoc` changed in Rust 1.67.0 [1],
but the custom code we have to replace the logo in the generated
HTML files did not get updated.
Thus update it to have the Linux logo again in the output.
Hopefully `rustdoc` will eventually support a custom logo from
a local file [2], so that we do not need to maintain this hack
on our side.
Link: https://github.com/rust-lang/rust/pull/101702 [1]
Link: https://github.com/rust-lang/rfcs/pull/3226 [2]
Fixes: 3ed03f4da06e ("rust: upgrade to Rust 1.68.2")
Cc: stable@vger.kernel.org
Tested-by: Benno Lossin
Reviewed-by: Andreas Hindborg
Link: https://lore.kernel.org/r/20231018155527.1015059-1-ojeda@kernel.org
Signed-off-by: Miguel Ojeda
Signed-off-by: Sasha Levin
commit 43f4e8e32b97333184191bcde3ce9b673505d500
Author: Carlos Bilbao
Date: Tue Jul 18 10:15:33 2023 -0500
docs: Move rustdoc output, cross-reference it
[ Upstream commit 48fadf44007568e75c7af92857083058d57be403 ]
Generate rustdoc documentation with the rest of subsystem's documentation
in Documentation/output. Add a cross reference to the generated rustdoc in
Documentation/rust/index.rst if Sphinx target rustdoc is set.
Reviewed-by: Akira Yokosawa
Signed-off-by: Carlos Bilbao
Reviewed-by: Martin Rodriguez Reboredo
Signed-off-by: Jonathan Corbet
Link: https://lore.kernel.org/r/20230718151534.4067460-2-carlos.bilbao@amd.com
Stable-dep-of: cfd96726e611 ("rust: docs: fix logo replacement")
Signed-off-by: Sasha Levin
commit 362a407559f5912bc091e5caf0ea14479be36ce4
Author: Nicholas Piggin
Date: Mon Oct 16 22:43:00 2023 +1000
powerpc/qspinlock: Fix stale propagated yield\_cpu
commit f9bc9bbe8afdf83412728f0b464979a72a3b9ec2 upstream.
yield\_cpu is a sample of a preempted lock holder that gets propagated
back through the queue. Queued waiters use this to yield to the
preempted lock holder without continually sampling the lock word (which
would defeat the purpose of MCS queueing by bouncing the cache line).
The problem is that yield\_cpu can become stale. It can take some time to
be passed down the chain, and if any queued waiter gets preempted then
it will cease to propagate the yield\_cpu to later waiters.
This can result in yielding to a CPU that no longer holds the lock,
which is bad, but particularly if it is currently in H\_CEDE (idle),
then it appears to be preempted and some hypervisors (PowerVM) can
cause very long H\_CONFER latencies waiting for H\_CEDE wakeup. This
results in latency spikes and hard lockups on oversubscribed
partitions with lock contention.
This is a minimal fix. Before yielding to yield\_cpu, sample the lock
word to confirm yield\_cpu is still the owner, and bail out of it is not.
Thanks to a bunch of people who reported this and tracked down the
exact problem using tracepoints and dispatch trace logs.
Fixes: 28db61e207ea ("powerpc/qspinlock: allow propagation of yield CPU down the queue")
Cc: stable@vger.kernel.org # v6.2+
Reported-by: Srikar Dronamraju
Reported-by: Laurent Dufour
Reported-by: Shrikanth Hegde
Debugged-by: "Nysal Jan K.A"
Signed-off-by: Nicholas Piggin
Tested-by: Shrikanth Hegde
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20231016124305.139923-2-npiggin@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 164e66ef89d1a70656629cd8434a95ac303ecf41
Author: Michael Ellerman
Date: Thu Aug 24 22:28:49 2023 +1000
powerpc/mm: Allow ARCH\_FORCE\_MAX\_ORDER up to 12
[ Upstream commit ff9e8f41513669e290f6e1904e1bc75950584491 ]
Christophe reported that the change to ARCH\_FORCE\_MAX\_ORDER to limit the
range to 10 had broken his ability to configure hugepages:
# echo 1 > /sys/kernel/mm/hugepages/hugepages-8192kB/nr\_hugepages
sh: write error: Invalid argument
Several of the powerpc defconfigs previously set the
ARCH\_FORCE\_MAX\_ORDER value to 12, via the definition in
arch/powerpc/configs/fsl-emb-nonhw.config, used by:
mpc85xx\_defconfig
mpc85xx\_smp\_defconfig
corenet32\_smp\_defconfig
corenet64\_smp\_defconfig
mpc86xx\_defconfig
mpc86xx\_smp\_defconfig
Fix it by increasing the allowed range to 12 to restore the previous
behaviour.
Fixes: 358e526a1648 ("powerpc/mm: Reinstate ARCH\_FORCE\_MAX\_ORDER ranges")
Reported-by: Christophe Leroy
Closes: https://lore.kernel.org/all/8011d806-5b30-bf26-2bfe-a08c39d57e20@csgroup.eu/
Tested-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20230824122849.942072-1-mpe@ellerman.id.au
Signed-off-by: Sasha Levin
commit fefac8c4686fd81fde6830c6dae32f9001d2ac28
Author: Felix Kuehling
Date: Tue Oct 17 16:51:03 2023 -0400
drm/amdgpu: Fix possible null pointer dereference
[ Upstream commit 51b79f33817544e3b4df838d86e8e8e4388ff684 ]
abo->tbo.resource may be NULL in amdgpu\_vm\_bo\_update.
Fixes: 180253782038 ("drm/ttm: stop allocating dummy resources during BO creation")
Signed-off-by: Felix Kuehling
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 935df6cfa78afe6a8fb143bba2bd22981cc4060e
Author: Khaled Almahallawy
Date: Wed Oct 4 17:13:10 2023 -0700
drm/i915/cx0: Only clear/set the Pipe Reset bit of the PHY Lanes Owned
[ Upstream commit 5e4c16fe08c8b894b258f4110349dc9b642669f9 ]
Currently, with MFD/pin assignment D, the driver clears the pipe reset bit
of lane 1 which is not owned by display. This causes the display
to block S0iX.
By not clearing this bit for lane 1 and keeping whatever default, S0ix
started to work. This is already what the driver does at the end
of the phy lane reset sequence (Step#8)
Bspec: 65451
Fixes: 619a06dba6fa ("drm/i915/mtl: Reset only one lane in case of MFD")
Cc: Mika Kahola
Cc: Gustavo Sousa
Signed-off-by: Khaled Almahallawy
Reviewed-by: Gustavo Sousa
Signed-off-by: Radhakrishna Sripada
Link: https://patchwork.freedesktop.org/patch/msgid/20231005001310.154396-1-khaled.almahallawy@intel.com
(cherry picked from commit 4a07f063d20c46524f00976f4537de72d9f31c4e)
Signed-off-by: Rodrigo Vivi
Signed-off-by: Sasha Levin
commit fa8361159a12e32299f9fbc1092b3ab383319309
Author: Stephen Boyd
Date: Mon Oct 2 16:54:06 2023 -0700
drm/bridge: ti-sn65dsi86: Associate DSI device lifetime with auxiliary device
[ Upstream commit 7b821db95140e2c118567aee22a78bf85f3617e0 ]
The kernel produces a warning splat and the DSI device fails to register
in this driver if the i2c driver probes, populates child auxiliary
devices, and then somewhere in ti\_sn\_bridge\_probe() a function call
returns -EPROBE\_DEFER. When the auxiliary driver probe defers, the dsi
device created by devm\_mipi\_dsi\_device\_register\_full() is left
registered because the devm managed device used to manage the lifetime
of the DSI device is the parent i2c device, not the auxiliary device
that is being probed.
Associate the DSI device created and managed by this driver to the
lifetime of the auxiliary device, not the i2c device, so that the DSI
device is removed when the auxiliary driver unbinds. Similarly change
the device pointer used for dev\_err\_probe() so the deferred probe errors
are associated with the auxiliary device instead of the parent i2c
device so we can narrow down future problems faster.
Cc: Douglas Anderson
Cc: Maxime Ripard
Fixes: c3b75d4734cb ("drm/bridge: sn65dsi86: Register and attach our DSI device at probe")
Signed-off-by: Stephen Boyd
Reviewed-by: Neil Armstrong
Reviewed-by: Douglas Anderson
Signed-off-by: Douglas Anderson
Link: https://patchwork.freedesktop.org/patch/msgid/20231002235407.769399-1-swboyd@chromium.org
Signed-off-by: Sasha Levin
commit f5d03923f8bd85458348799c6476860b19e37f79
Author: Richard Fitzgerald
Date: Wed Oct 11 14:48:53 2023 +0100
ASoC: cs42l42: Fix missing include of gpio/consumer.h
[ Upstream commit d6cbc6a3a856a7d8047316d81e2e039e44432acb ]
The call to gpiod\_set\_value\_cansleep() in cs42l42\_sdw\_update\_status()
needs the header file gpio/consumer.h to be included.
This was introduced by commit 2d066c6a7865 ("ASoC: cs42l42: Avoid stale
SoundWire ATTACH after hard reset")
and caused error:
sound/soc/codecs/cs42l42-sdw.c:374:4: error: implicit declaration of
function ‘gpiod\_set\_value\_cansleep’;
did you mean gpio\_set\_value\_cansleep’?
Signed-off-by: Richard Fitzgerald
Fixes: 2d066c6a7865 ("ASoC: cs42l42: Avoid stale SoundWire ATTACH after hard reset")
Link: https://lore.kernel.org/r/20231011134853.20059-1-rf@opensource.cirrus.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 2756d8399ea4720943df4060fc87d1d7ac5dffcd
Author: Dan Carpenter
Date: Thu Oct 5 17:00:24 2023 +0300
ASoC: pxa: fix a memory leak in probe()
[ Upstream commit aa6464edbd51af4a2f8db43df866a7642b244b5f ]
Free the "priv" pointer before returning the error code.
Fixes: 90eb6b59d311 ("ASoC: pxa-ssp: add support for an external clock in devicetree")
Signed-off-by: Dan Carpenter
Link: https://lore.kernel.org/r/84ac2313-1420-471a-b2cb-3269a2e12a7c@moroto.mountain
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 8247e4d5cba5b2d09180c230ea88a1a702653dab
Author: Richard Fitzgerald
Date: Fri Oct 6 17:44:05 2023 +0100
ASoC: cs35l56: Fix illegal use of init\_completion()
[ Upstream commit af5fd122d7bd739a2b66405f6e8ab92557279325 ]
Fix cs35l56\_patch() to call reinit\_completion() to reinitialize
the completion object.
It was incorrectly using init\_completion().
Signed-off-by: Richard Fitzgerald
Fixes: e49611252900 ("ASoC: cs35l56: Add driver for Cirrus Logic CS35L56")
Link: https://lore.kernel.org/r/20231006164405.253796-1-rf@opensource.cirrus.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 9955bc6e6be926931917eecfc2bf9faebeaf0ffb
Author: Haibo Chen
Date: Tue Oct 17 18:42:36 2023 +0800
gpio: vf610: mask the gpio irq in system suspend and support wakeup
commit 430232619791e7de95191f2cd8ebaa4c380d17d0 upstream.
Add flag IRQCHIP\_MASK\_ON\_SUSPEND to make sure gpio irq is masked on
suspend, if lack this flag, current irq arctitecture will not mask
the irq, and these unmasked gpio irq will wrongly wakeup the system
even they are not config as wakeup source.
Also add flag IRQCHIP\_ENABLE\_WAKEUP\_ON\_SUSPEND to make sure the gpio
irq which is configed as wakeup source can work as expect.
Fixes: 7f2691a19627 ("gpio: vf610: add gpiolib/IRQ chip driver for Vybrid")
Signed-off-by: Haibo Chen
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit 96964c192aa2ab153cec4b89c89a5d8995dd4597
Author: Haibo Chen
Date: Wed Oct 18 11:00:17 2023 +0200
gpio: vf610: set value before the direction to avoid a glitch
commit fc363413ef8ea842ae7a99e3caf5465dafdd3a49 upstream.
We found a glitch when configuring the pad as output high. To avoid this
glitch, move the data value setting before direction config in the
function vf610\_gpio\_direction\_output().
Fixes: 659d8a62311f ("gpio: vf610: add imx7ulp support")
Signed-off-by: Haibo Chen
[Bartosz: tweak the commit message]
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit 204c78f852e65d6972900ce0aa6983355f396d74
Author: Andy Shevchenko
Date: Thu Oct 19 20:34:55 2023 +0300
gpiolib: acpi: Add missing memset(0) to acpi\_get\_gpiod\_from\_data()
commit 479ac419206b5fe4ce4e40de61ac3210a36711aa upstream.
When refactoring the acpi\_get\_gpiod\_from\_data() the change missed
cleaning up the variable on stack. Add missing memset().
Reported-by: Ferry Toth
Fixes: 16ba046e86e9 ("gpiolib: acpi: teach acpi\_find\_gpio() to handle data-only nodes")
Signed-off-by: Andy Shevchenko
Reviewed-by: Dmitry Torokhov
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit 0236504746dde0dc12730a0768445defb3126241
Author: Wedson Almeida Filho
Date: Sat Sep 30 11:49:58 2023 -0300
rust: error: fix the description for `ECHILD`
commit 17bfcd6a81535d7d580ddafb6e54806890aaca6c upstream.
A mistake was made and the description of `ECHILD` is wrong (it reuses
the description of `ENOEXEC`). This fixes it to reflect what's in
`errno-base.h`.
Signed-off-by: Wedson Almeida Filho
Reviewed-by: Martin Rodriguez Reboredo
Reviewed-by: Trevor Gross
Reviewed-by: Finn Behrens
Reviewed-by: Alice Ryhl
Fixes: 266def2a0f5b ("rust: error: add codes from `errno-base.h`")
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230930144958.46051-1-wedsonaf@gmail.com
[ Use the plural, as noticed by Benno. ]
Signed-off-by: Miguel Ojeda
Signed-off-by: Greg Kroah-Hartman
commit 56d2f7796ab8d8c06a46579b3a1c62bac92719eb
Author: Hans de Goede
Date: Tue Oct 17 11:07:25 2023 +0200
platform/x86: asus-wmi: Map 0x2a code, Ignore 0x2b and 0x2c events
commit 235985d1763f7aba92c1c64e5f5aaec26c2c9b18 upstream.
Newer Asus laptops send the following new WMI event codes when some
of the F1 - F12 "media" hotkeys are pressed:
0x2a Screen Capture
0x2b PrintScreen
0x2c CapsLock
Map 0x2a to KEY\_SELECTIVE\_SCREENSHOT mirroring how similar hotkeys
are mapped on other laptops.
PrintScreem and CapsLock are also reported as normal PS/2 keyboard events,
map these event codes to KE\_IGNORE to avoid "Unknown key code 0x%x\n" log
messages.
Reported-by: James John
Closes: https://lore.kernel.org/platform-driver-x86/a2c441fe-457e-44cf-a146-0ecd86b037cf@donjajo.com/
Closes: https://bbs.archlinux.org/viewtopic.php?pid=2123716
Signed-off-by: Hans de Goede
Link: https://lore.kernel.org/r/20231017090725.38163-4-hdegoede@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit 119a52c632d7a6e39398487749bfa3b9e326a43b
Author: Hans de Goede
Date: Tue Oct 17 11:07:24 2023 +0200
platform/x86: asus-wmi: Only map brightness codes when using asus-wmi backlight control
commit a5b92be2482e5f9ef30be4e4cda12ed484381493 upstream.
Older Asus laptops change the backlight level themselves and then send
WMI events with different codes for different backlight levels.
The asus-wmi.c code maps the entire range of codes reported on
brightness down keypresses to an internal ASUS\_WMI\_BRN\_DOWN code:
define NOTIFY\_BRNUP\_MIN 0x11
define NOTIFY\_BRNUP\_MAX 0x1f
define NOTIFY\_BRNDOWN\_MIN 0x20
define NOTIFY\_BRNDOWN\_MAX 0x2e
if (code >= NOTIFY\_BRNUP\_MIN && code <= NOTIFY\_BRNUP\_MAX)
code = ASUS\_WMI\_BRN\_UP;
else if (code >= NOTIFY\_BRNDOWN\_MIN && code <= NOTIFY\_BRNDOWN\_MAX)
code = ASUS\_WMI\_BRN\_DOWN;
This mapping is causing issues on new laptop models which actually
send 0x2b events for printscreen presses and 0x2c events for
capslock presses, which get translated into spurious brightness-down
presses.
This mapping is really only necessary when asus-wmi has registered
a backlight-device for backlight control. In this case the mapping
was used to decide to filter out the keypresss since in this case
the firmware has already modified the brightness itself and instead
of reporting a keypress asus-wmi will just report the new brightness
value to userspace.
OTOH when the firmware does not adjust the brightness itself then
it seems to always report 0x2e for brightness-down presses and
0x2f for brightness up presses independent of the actual brightness
level. So in this case the mapping of the code is not necessary
and this translation actually leads to spurious brightness-down
presses being send to userspace when pressing printscreen or capslock.
Modify asus\_wmi\_handle\_event\_code() to only do the mapping
when using asus-wmi backlight control to fix the spurious
brightness-down presses.
Reported-by: James John
Closes: https://lore.kernel.org/platform-driver-x86/a2c441fe-457e-44cf-a146-0ecd86b037cf@donjajo.com/
Closes: https://bbs.archlinux.org/viewtopic.php?pid=2123716
Signed-off-by: Hans de Goede
Link: https://lore.kernel.org/r/20231017090725.38163-3-hdegoede@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit 7422c4a4cbd900430b9305d441ab1285879d07a2
Author: Hans de Goede
Date: Tue Oct 17 11:07:23 2023 +0200
platform/x86: asus-wmi: Change ASUS\_WMI\_BRN\_DOWN code from 0x20 to 0x2e
commit f37cc2fc277b371fc491890afb7d8a26e36bb3a1 upstream.
Older Asus laptops change the backlight level themselves and then send
WMI events with different codes for different backlight levels.
The asus-wmi.c code maps the entire range of codes reported on
brightness down keypresses to an internal ASUS\_WMI\_BRN\_DOWN code:
define NOTIFY\_BRNUP\_MIN 0x11
define NOTIFY\_BRNUP\_MAX 0x1f
define NOTIFY\_BRNDOWN\_MIN 0x20
define NOTIFY\_BRNDOWN\_MAX 0x2e
if (code >= NOTIFY\_BRNUP\_MIN && code <= NOTIFY\_BRNUP\_MAX)
code = ASUS\_WMI\_BRN\_UP;
else if (code >= NOTIFY\_BRNDOWN\_MIN && code <= NOTIFY\_BRNDOWN\_MAX)
code = ASUS\_WMI\_BRN\_DOWN;
Before this commit all the NOTIFY\_BRNDOWN\_MIN - NOTIFY\_BRNDOWN\_MAX
aka 0x20 - 0x2e events were mapped to 0x20.
This mapping is causing issues on new laptop models which actually
send 0x2b events for printscreen presses and 0x2c events for
capslock presses, which get translated into spurious brightness-down
presses.
The plan is disable the 0x11-0x2e special mapping on laptops
where asus-wmi does not register a backlight-device to avoid
the spurious brightness-down keypresses. New laptops always send
0x2e for brightness-down presses, change the special internal
ASUS\_WMI\_BRN\_DOWN value from 0x20 to 0x2e to match this in
preparation for fixing the spurious brightness-down presses.
This change does not have any functional impact since all
of 0x20 - 0x2e is mapped to ASUS\_WMI\_BRN\_DOWN first and only
then checked against the keymap code and the new 0x2e
value is still in the 0x20 - 0x2e range.
Reported-by: James John
Closes: https://lore.kernel.org/platform-driver-x86/a2c441fe-457e-44cf-a146-0ecd86b037cf@donjajo.com/
Closes: https://bbs.archlinux.org/viewtopic.php?pid=2123716
Signed-off-by: Hans de Goede
Link: https://lore.kernel.org/r/20231017090725.38163-2-hdegoede@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit a3939c1a96eb30d98e9b8d2f46c23f7b87e85819
Author: Nikita Kravets
Date: Fri Oct 6 20:53:53 2023 +0300
platform/x86: msi-ec: Fix the 3rd config
commit 6284e67aa6cb3af870ed11dfcfafd80fd927777b upstream.
Fix the charge control address of CONF3 and remove an incorrect firmware
version which turned out to be a BIOS firmware and not an EC firmware.
Fixes: 392cacf2aa10 ("platform/x86: Add new msi-ec driver")
Cc: Aakash Singh
Cc: Jose Angel Pastrana
Signed-off-by: Nikita Kravets
Reviewed-by: Ilpo Järvinen
Link: https://lore.kernel.org/r/20231006175352.1753017-5-teackot@gmail.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit 61ab10af6843228c25867e8752fd3f1049a56711
Author: Srinivas Pandruvada
Date: Wed Oct 4 11:19:15 2023 -0700
platform/x86: intel-uncore-freq: Conditionally create attribute for read frequency
commit 4d73c6772ab771cbbe7e46a73e7c78ba490350fa upstream.
When the current uncore frequency can't be read, don't create attribute
"current\_freq\_khz" as any read will fail later. Some user space
applications like turbostat fail to continue with the failure. So, check
error during attribute creation.
Fixes: 414eef27283a ("platform/x86/intel/uncore-freq: Display uncore current frequency")
Signed-off-by: Srinivas Pandruvada
Reviewed-by: Ilpo Järvinen
Link: https://lore.kernel.org/r/20231004181915.1887913-1-srinivas.pandruvada@linux.intel.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit 18e77f174fc9bf46a3b5bfb5d653b7d3bc37aa4e
Author: Armin Wolf
Date: Sun Oct 15 01:54:49 2023 +0200
platform/surface: platform\_profile: Propagate error if profile registration fails
commit fe0e04cf66a12ffe6d1b43725ddaabd5599d024f upstream.
If platform\_profile\_register() fails, the driver does not propagate
the error, but instead probes successfully. This means when the driver
unbinds, the a warning might be issued by platform\_profile\_remove().
Fix this by propagating the error back to the caller of
surface\_platform\_profile\_probe().
Compile-tested only.
Fixes: b78b4982d763 ("platform/surface: Add platform profile driver")
Signed-off-by: Armin Wolf
Reviewed-by: Maximilian Luz
Tested-by: Maximilian Luz
Link: https://lore.kernel.org/r/20231014235449.288702-1-W\_Armin@gmx.de
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit 183aff269bfedae3feaadcc3d8024a4e7bb936af
Author: Dinghao Liu
Date: Thu Sep 21 15:14:12 2023 +0800
s390/cio: fix a memleak in css\_alloc\_subchannel
commit 63e8b94ad1840f02462633abdb363397f56bc642 upstream.
When dma\_set\_coherent\_mask() fails, sch->lock has not been
freed, which is allocated in css\_sch\_create\_locks(), leading
to a memleak.
Fixes: 4520a91a976e ("s390/cio: use dma helpers for setting masks")
Signed-off-by: Dinghao Liu
Message-Id: <20230921071412.13806-1-dinghao.liu@zju.edu.cn>
Link: https://lore.kernel.org/linux-s390/bd38baa8-7b9d-4d89-9422-7e943d626d6e@linux.ibm.com/
Reviewed-by: Halil Pasic
Reviewed-by: Peter Oberparleiter
Signed-off-by: Vasily Gorbik
Signed-off-by: Greg Kroah-Hartman
commit 6ccb89a7010ec60795695dc05774cd518956d718
Author: Orlando Chamberlain
Date: Tue Oct 17 22:14:45 2023 +1100
apple-gmux: Hard Code max brightness for MMIO gmux
commit 0e51cb42438b8754d8f4cee4c802a8c5bb2cd5e0 upstream.
The data in the max brightness port for iMacs with MMIO gmux incorrectly
reports 0x03ff, but it should be 0xffff. As all other MMIO gmux models
have 0xffff, hard code this for all MMIO gmux's so they all have the
proper brightness range accessible.
Fixes: 0c18184de990 ("platform/x86: apple-gmux: support MMIO gmux on T2 Macs")
Reported-by: Karsten Leipold
Signed-off-by: Orlando Chamberlain
Link: https://lore.kernel.org/r/20231017111444.19304-2-orlandoch.dev@gmail.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit efea19a2889cf89f609dd109765f5b86ee574e79
Author: Herbert Xu
Date: Mon Oct 16 16:35:36 2023 +0800
KEYS: asymmetric: Fix sign/verify on pkcs1pad without a hash
commit b11950356c4b416d2e87941f3aa7a8bf089db72b upstream.
The new sign/verify code broke the case of pkcs1pad without a
hash algorithm. Fix it by setting issig correctly for this case.
Fixes: 63ba4d67594a ("KEYS: asymmetric: Use new crypto interface without scatterlists")
Cc: stable@vger.kernel.org # v6.5
Reported-by: Denis Kenzior
Signed-off-by: Herbert Xu
Tested-by: Denis Kenzior
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 3e25a4bc5023483a2412207efeb91082e6765668
Author: Francis Laniel
Date: Fri Oct 20 13:42:50 2023 +0300
selftests/ftrace: Add new test case which checks non unique symbol
commit 03b80ff8023adae6780e491f66e932df8165e3a0 upstream.
If name\_show() is non unique, this test will try to install a kprobe on this
function which should fail returning EADDRNOTAVAIL.
On kernel where name\_show() is not unique, this test is skipped.
Link: https://lore.kernel.org/all/20231020104250.9537-3-flaniel@linux.microsoft.com/
Cc: stable@vger.kernel.org
Signed-off-by: Francis Laniel
Acked-by: Masami Hiramatsu (Google)
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Greg Kroah-Hartman
commit d78936d7da2789685cbbb2743d8dc0aca82255d5
Author: Francis Laniel
Date: Fri Oct 20 13:42:49 2023 +0300
tracing/kprobes: Return EADDRNOTAVAIL when func matches several symbols
commit b022f0c7e404887a7c5229788fc99eff9f9a80d5 upstream.
When a kprobe is attached to a function that's name is not unique (is
static and shares the name with other functions in the kernel), the
kprobe is attached to the first function it finds. This is a bug as the
function that it is attaching to is not necessarily the one that the
user wants to attach to.
Instead of blindly picking a function to attach to what is ambiguous,
error with EADDRNOTAVAIL to let the user know that this function is not
unique, and that the user must use another unique function with an
address offset to get to the function they want to attach to.
Link: https://lore.kernel.org/all/20231020104250.9537-2-flaniel@linux.microsoft.com/
Cc: stable@vger.kernel.org
Fixes: 413d37d1eb69 ("tracing: Add kprobe-based event tracer")
Suggested-by: Masami Hiramatsu
Signed-off-by: Francis Laniel
Link: https://lore.kernel.org/lkml/20230819101105.b0c104ae4494a7d1f2eea742@kernel.org/
Acked-by: Masami Hiramatsu (Google)
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Greg Kroah-Hartman
commit 9a7f36028015cad173ad6b0ca849e19a83cb37f9
Author: Niklas Schnelle
Date: Tue Oct 17 15:37:29 2023 +0200
s390/pci: fix iommu bitmap allocation
commit c1ae1c59c8c6e0b66a718308c623e0cb394dab6b upstream.
Since the fixed commits both zdev->iommu\_bitmap and zdev->lazy\_bitmap
are allocated as vzalloc(zdev->iommu\_pages / 8). The problem is that
zdev->iommu\_bitmap is a pointer to unsigned long but the above only
yields an allocation that is a multiple of sizeof(unsigned long) which
is 8 on s390x if the number of IOMMU pages is a multiple of 64.
This in turn is the case only if the effective IOMMU aperture is
a multiple of 64 \* 4K = 256K. This is usually the case and so didn't
cause visible issues since both the virt\_to\_phys(high\_memory) reduced
limit and hardware limits use nice numbers.
Under KVM, and in particular with QEMU limiting the IOMMU aperture to
the vfio DMA limit (default 65535), it is possible for the reported
aperture not to be a multiple of 256K however. In this case we end up
with an iommu\_bitmap whose allocation is not a multiple of
8 causing bitmap operations to access it out of bounds.
Sadly we can't just fix this in the obvious way and use bitmap\_zalloc()
because for large RAM systems (tested on 8 TiB) the zdev->iommu\_bitmap
grows too large for kmalloc(). So add our own bitmap\_vzalloc() wrapper.
This might be a candidate for common code, but this area of code will
be replaced by the upcoming conversion to use the common code DMA API on
s390 so just add a local routine.
Fixes: 224593215525 ("s390/pci: use virtual memory for iommu bitmap")
Fixes: 13954fd6913a ("s390/pci\_dma: improve lazy flush for unmap")
Cc: stable@vger.kernel.org
Reviewed-by: Matthew Rosato
Signed-off-by: Niklas Schnelle
Signed-off-by: Vasily Gorbik
Signed-off-by: Greg Kroah-Hartman
commit 20f925d38e1ecc1d36ee6bf6e325fb514a6f727d
Author: Peter Zijlstra
Date: Wed Oct 18 13:56:54 2023 +0200
perf: Disallow mis-matched inherited group reads
commit 32671e3799ca2e4590773fd0e63aaa4229e50c06 upstream.
Because group consistency is non-atomic between parent (filedesc) and children
(inherited) events, it is possible for PERF\_FORMAT\_GROUP read() to try and sum
non-matching counter groups -- with non-sensical results.
Add group\_generation to distinguish the case where a parent group removes and
adds an event and thus has the same number, but a different configuration of
events as inherited groups.
This became a problem when commit fa8c269353d5 ("perf/core: Invert
perf\_read\_group() loops") flipped the order of child\_list and sibling\_list.
Previously it would iterate the group (sibling\_list) first, and for each
sibling traverse the child\_list. In this order, only the group composition of
the parent is relevant. By flipping the order the group composition of the
child (inherited) events becomes an issue and the mis-match in group
composition becomes evident.
That said; even prior to this commit, while reading of a group that is not
equally inherited was not broken, it still made no sense.
(Ab)use ECHILD as error return to indicate issues with child process group
composition.
Fixes: fa8c269353d5 ("perf/core: Invert perf\_read\_group() loops")
Reported-by: Budimir Markovic
Signed-off-by: Peter Zijlstra (Intel)
Link: https://lkml.kernel.org/r/20231018115654.GK33217@noisy.programming.kicks-ass.net
Signed-off-by: Greg Kroah-Hartman
commit 12614cd08c2c11d3f380832c09214d56b75208f7
Author: Gil Fine
Date: Thu Aug 10 23:18:25 2023 +0300
thunderbolt: Call tb\_switch\_put() once DisplayPort bandwidth request is finished
commit ec4405ed92036f5bb487b5c2f9a28f9e36a3e3d5 upstream.
When handling DisplayPort bandwidth request tb\_switch\_find\_by\_route() is
called and it returns a router structure with reference count increased.
In order to avoid resource leak call tb\_switch\_put() when finished.
Fixes: 6ce3563520be ("thunderbolt: Add support for DisplayPort bandwidth allocation mode")
Cc: stable@vger.kernel.org
Signed-off-by: Gil Fine
Signed-off-by: Mika Westerberg
Signed-off-by: Greg Kroah-Hartman
commit 7cb7903eb22e24d3b5ecafb66a9231a7dca90364
Author: Puliang Lu
Date: Mon Oct 16 15:36:16 2023 +0800
USB: serial: option: add Fibocom to DELL custom modem FM101R-GL
commit 52480e1f1a259c93d749ba3961af0bffedfe7a7a upstream.
Update the USB serial option driver support for the Fibocom
FM101R-GL LTE modules as there are actually several different variants.
- VID:PID 413C:8213, FM101R-GL are laptop M.2 cards (with
MBIM interfaces for Linux)
- VID:PID 413C:8215, FM101R-GL ESIM are laptop M.2 cards (with
MBIM interface for Linux)
0x8213: mbim, tty
0x8215: mbim, tty
T: Bus=04 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 2 Spd=5000 MxCh= 0
D: Ver= 3.20 Cls=00(>ifc ) Sub=00 Prot=00 MxPS= 9 #Cfgs= 1
P: Vendor=413c ProdID=8213 Rev= 5.04
S: Manufacturer=Fibocom Wireless Inc.
S: Product=Fibocom FM101-GL Module
S: SerialNumber=a3b7cbf0
C:\* #Ifs= 3 Cfg#= 1 Atr=a0 MxPwr=896mA
A: FirstIf#= 0 IfCount= 2 Cls=02(comm.) Sub=0e Prot=00
I:\* If#= 0 Alt= 0 #EPs= 1 Cls=02(comm.) Sub=0e Prot=00 Driver=cdc\_mbim
E: Ad=81(I) Atr=03(Int.) MxPS= 64 Ivl=32ms
I: If#= 1 Alt= 0 #EPs= 0 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc\_mbim
I:\* If#= 1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc\_mbim
E: Ad=8e(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
E: Ad=0f(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
I:\* If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=40 Driver=(none)
E: Ad=83(I) Atr=03(Int.) MxPS= 10 Ivl=32ms
E: Ad=82(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
E: Ad=01(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
T: Bus=04 Lev=01 Prnt=01 Port=01 Cnt=01 Dev#= 3 Spd=5000 MxCh= 0
D: Ver= 3.20 Cls=00(>ifc ) Sub=00 Prot=00 MxPS= 9 #Cfgs= 1
P: Vendor=413c ProdID=8215 Rev= 5.04
S: Manufacturer=Fibocom Wireless Inc.
S: Product=Fibocom FM101-GL Module
S: SerialNumber=a3b7cbf0
C:\* #Ifs= 3 Cfg#= 1 Atr=a0 MxPwr=896mA
A: FirstIf#= 0 IfCount= 2 Cls=02(comm.) Sub=0e Prot=00
I:\* If#= 0 Alt= 0 #EPs= 1 Cls=02(comm.) Sub=0e Prot=00 Driver=cdc\_mbim
E: Ad=81(I) Atr=03(Int.) MxPS= 64 Ivl=32ms
I: If#= 1 Alt= 0 #EPs= 0 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc\_mbim
I:\* If#= 1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc\_mbim
E: Ad=8e(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
E: Ad=0f(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
I:\* If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=40 Driver=(none)
E: Ad=83(I) Atr=03(Int.) MxPS= 10 Ivl=32ms
E: Ad=82(I) Atr=02(Bulk) MxPS=1024 Ivl=0ms
E: Ad=01(O) Atr=02(Bulk) MxPS=1024 Ivl=0ms
Signed-off-by: Puliang Lu
Cc: stable@vger.kernel.org
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit d617569fc51778b44edb00472e8f4529f5dfff12
Author: Benoît Monin
Date: Mon Oct 2 17:51:40 2023 +0200
USB: serial: option: add entry for Sierra EM9191 with new firmware
commit 064f6e2ba9eb59b2c87b866e1e968e79ccedf9dd upstream.
Following a firmware update of the modem, the interface for the AT
command port changed, so add it back.
T: Bus=08 Lev=01 Prnt=01 Port=01 Cnt=02 Dev#= 2 Spd=5000 MxCh= 0
D: Ver= 3.20 Cls=00(>ifc ) Sub=00 Prot=00 MxPS= 9 #Cfgs= 1
P: Vendor=1199 ProdID=90d3 Rev=00.06
S: Manufacturer=Sierra Wireless, Incorporated
S: Product=Sierra Wireless EM9191
S: SerialNumber=xxxxxxxxxxxxxxxx
C: #Ifs= 4 Cfg#= 1 Atr=a0 MxPwr=896mA
I: If#=0x0 Alt= 0 #EPs= 1 Cls=02(commc) Sub=0e Prot=00 Driver=cdc\_mbim
I: If#=0x1 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=02 Driver=cdc\_mbim
I: If#=0x3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=40 Driver=(none)
I: If#=0x4 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=30 Driver=option
Signed-off-by: Benoît Monin
Cc: stable@vger.kernel.org
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 0b53c322db2fc688e4122388f73780f81a03bfec
Author: Fabio Porcedda
Date: Tue Sep 5 09:37:24 2023 +0200
USB: serial: option: add Telit LE910C4-WWX 0x1035 composition
commit 6a7be48e9bd18d309ba25c223a27790ad1bf0fa3 upstream.
Add support for the following Telit LE910C4-WWX composition:
0x1035: TTY, TTY, ECM
T: Bus=01 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#= 5 Spd=480 MxCh= 0
D: Ver= 2.00 Cls=ef(misc ) Sub=02 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=1bc7 ProdID=1035 Rev=00.00
S: Manufacturer=Telit
S: Product=LE910C4-WWX
S: SerialNumber=e1b117c7
C: #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=500mA
I: If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
E: Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=81(I) Atr=03(Int.) MxPS= 64 Ivl=2ms
E: Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I: If#= 1 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=fe Prot=ff Driver=option
E: Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=83(I) Atr=03(Int.) MxPS= 64 Ivl=2ms
E: Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I: If#= 2 Alt= 0 #EPs= 1 Cls=02(commc) Sub=06 Prot=00 Driver=cdc\_ether
E: Ad=85(I) Atr=03(Int.) MxPS= 64 Ivl=2ms
I: If#= 3 Alt= 1 #EPs= 2 Cls=0a(data ) Sub=00 Prot=00 Driver=cdc\_ether
E: Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=86(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
Signed-off-by: Fabio Porcedda
Cc: stable@vger.kernel.org
Reviewed-by: Daniele Palmas
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 06a2165f1d36c74bab70f82362d54a110501a8d0
Author: Maurizio Lombardi
Date: Mon Jul 31 12:37:58 2023 +0200
nvme-rdma: do not try to stop unallocated queues
commit 3820c4fdc247b6f0a4162733bdb8ddf8f2e8a1e4 upstream.
Trying to stop a queue which hasn't been allocated will result
in a warning due to calling mutex\_lock() against an uninitialized mutex.
DEBUG\_LOCKS\_WARN\_ON(lock->magic != lock)
WARNING: CPU: 4 PID: 104150 at kernel/locking/mutex.c:579
Call trace:
RIP: 0010:\_\_mutex\_lock+0x1173/0x14a0
nvme\_rdma\_stop\_queue+0x1b/0xa0 [nvme\_rdma]
nvme\_rdma\_teardown\_io\_queues.part.0+0xb0/0x1d0 [nvme\_rdma]
nvme\_rdma\_delete\_ctrl+0x50/0x100 [nvme\_rdma]
nvme\_do\_delete\_ctrl+0x149/0x158 [nvme\_core]
Signed-off-by: Maurizio Lombardi
Reviewed-by: Sagi Grimberg
Tested-by: Yi Zhang
Signed-off-by: Keith Busch
Signed-off-by: Greg Kroah-Hartman
commit 7d3641c2ed7a77264a4e8c6e405e51aec8c12f23
Author: Maurizio Lombardi
Date: Tue Oct 17 10:28:45 2023 +0200
nvmet-auth: complete a request only after freeing the dhchap pointers
commit f965b281fd872b2e18bd82dd97730db9834d0750 upstream.
It may happen that the work to destroy a queue
(for example nvmet\_tcp\_release\_queue\_work()) is started while
an auth-send or auth-receive command is still completing.
nvmet\_sq\_destroy() will block, waiting for all the references
to the sq to be dropped, the last reference is then
dropped when nvmet\_req\_complete() is called.
When this happens, both nvmet\_sq\_destroy() and
nvmet\_execute\_auth\_send()/\_receive() will free the dhchap pointers by
calling nvmet\_auth\_sq\_free().
Since there isn't any lock, the two threads may race against each other,
causing double frees and memory corruptions, as reported by KASAN.
Reproduced by stress blktests nvme/041 nvme/042 nvme/043
nvme nvme2: qid 0: authenticated with hash hmac(sha512) dhgroup ffdhe4096
==================================================================
BUG: KASAN: double-free in kfree+0xec/0x4b0
Call Trace:
kfree+0xec/0x4b0
nvmet\_auth\_sq\_free+0xe1/0x160 [nvmet]
nvmet\_execute\_auth\_send+0x482/0x16d0 [nvmet]
process\_one\_work+0x8e5/0x1510
Allocated by task 191846:
\_\_kasan\_kmalloc+0x81/0xa0
nvmet\_auth\_ctrl\_sesskey+0xf6/0x380 [nvmet]
nvmet\_auth\_reply+0x119/0x990 [nvmet]
Freed by task 143270:
kfree+0xec/0x4b0
nvmet\_auth\_sq\_free+0xe1/0x160 [nvmet]
process\_one\_work+0x8e5/0x1510
Fix this bug by calling nvmet\_req\_complete() only after freeing the
pointers, so we will prevent the race by holding the sq reference.
V2: remove redundant code
Fixes: db1312dd9548 ("nvmet: implement basic In-Band Authentication")
Signed-off-by: Maurizio Lombardi
Reviewed-by: Christoph Hellwig
Signed-off-by: Keith Busch
Signed-off-by: Greg Kroah-Hartman
commit f660a391e54c4a98efca065b9ee0fa821d11cb60
Author: Martin Wilck
Date: Mon Sep 4 17:26:38 2023 +0200
nvme-auth: use chap->s2 to indicate bidirectional authentication
commit 4ae55a7dce04989f289d5c5c8c8e5c37adc36c71 upstream.
Commit 546dea18c999 ("nvme-auth: check chap ctrl\_key once constructed")
replaced the condition "if (ctrl->ctrl\_key)" (indicating bidirectional
auth) by "if (chap->ctrl\_key)", because ctrl->ctrl\_key is a resource shared
with sysfs. But chap->ctrl\_key is set in
nvme\_auth\_process\_dhchap\_challenge() depending on the DHVLEN in the
DH-HMAC-CHAP Challenge message received from the controller, and will thus
be non-NULL for every DH-HMAC-CHAP exchange, even if unidirectional auth
was requested. This will lead to a protocol violation by sending a Success2
message in the unidirectional case (per NVMe base spec 2.0, the
authentication transaction ends after the Success1 message for
unidirectional auth). Use chap->s2 instead, which is non-zero if and only
if the host requested bi-directional authentication from the controller.
Fixes: 546dea18c999 ("nvme-auth: check chap ctrl\_key once constructed")
Signed-off-by: Martin Wilck
Reviewed-by: Daniel Wagner
Reviewed-by: Sagi Grimberg
Reviewed-by: Hannes Reinecke
Reviewed-by: Christoph Hellwig
Signed-off-by: Keith Busch
Signed-off-by: Greg Kroah-Hartman
commit 38f5ff32ccda6fc867657642a8462ea804157def
Author: Keith Busch
Date: Thu Oct 12 11:13:51 2023 -0700
nvme-pci: add BOGUS\_NID for Intel 0a54 device
commit 5c3f4066462a5f6cac04d3dd81c9f551fabbc6c7 upstream.
These ones claim cmic and nmic capable, so need special consideration to ignore
their duplicate identifiers.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=217981
Reported-by: welsh@cassens.com
Signed-off-by: Keith Busch
Signed-off-by: Greg Kroah-Hartman
commit 2194ee65b29dff84b0971b835d23e68c6d87ba25
Author: Keith Busch
Date: Mon Oct 16 13:12:47 2023 -0700
nvme: sanitize metadata bounce buffer for reads
commit 2b32c76e2b0154b98b9322ae7546b8156cd703e6 upstream.
User can request more metadata bytes than the device will write. Ensure
kernel buffer is initialized so we're not leaking unsanitized memory on
the copy-out.
Fixes: 0b7f1f26f95a51a ("nvme: use the block layer for userspace passthrough metadata")
Reviewed-by: Jens Axboe
Reviewed-by: Christoph Hellwig
Reviewed-by: Kanchan Joshi
Reviewed-by: Chaitanya Kulkarni
Signed-off-by: Keith Busch
Signed-off-by: Greg Kroah-Hartman
commit 16b99c6d6f344e0ac4775ebae606c2c08e298f4f
Author: Dai Ngo
Date: Mon Sep 18 23:30:20 2023 -0700
nfs42: client needs to strip file mode's suid/sgid bit after ALLOCATE op
commit f588d72bd95f748849685412b1f0c7959ca228cf upstream.
The Linux NFS server strips the SUID and SGID from the file mode
on ALLOCATE op.
Modify \_nfs42\_proc\_fallocate to add NFS\_INO\_REVAL\_FORCED to
nfs\_set\_cache\_invalid's argument to force update of the file
mode suid/sgid bit.
Suggested-by: Trond Myklebust
Signed-off-by: Dai Ngo
Reviewed-by: Jeff Layton
Tested-by: Jeff Layton
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 8183b745d8cdc4975edaf1a007172e2991f4d424
Author: Scott Mayhew
Date: Wed Oct 11 10:43:26 2023 -0400
NFS: Fix potential oops in nfs\_inode\_remove\_request()
commit 6a6d4644ce935ddec4f76223ac0ca68da56bd2d3 upstream.
Once a folio's private data has been cleared, it's possible for another
process to clear the folio->mapping (e.g. via invalidate\_complete\_folio2
or evict\_mapping\_folio), so it wouldn't be safe to call
nfs\_page\_to\_inode() after that.
Fixes: 0c493b5cf16e ("NFS: Convert buffered writes to use folios")
Signed-off-by: Scott Mayhew
Reviewed-by: Benjamin Coddington
Tested-by: Benjamin Coddington
Reviewed-by: Jeff Layton
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 4538b3bdcdef243f5c6691741d93e175e8ad1997
Author: Amir Goldstein
Date: Wed Oct 18 12:59:56 2023 +0300
fanotify: limit reporting of event with non-decodeable file handles
commit 97ac489775f26acfd46a8a60c2f84ce7cc79fa4b upstream.
Commit a95aef69a740 ("fanotify: support reporting non-decodeable file
handles") merged in v6.5-rc1, added the ability to use an fanotify group
with FAN\_REPORT\_FID mode to watch filesystems that do not support nfs
export, but do know how to encode non-decodeable file handles, with the
newly introduced AT\_HANDLE\_FID flag.
At the time that this commit was merged, there were no filesystems
in-tree with those traits.
Commit 16aac5ad1fa9 ("ovl: support encoding non-decodable file handles"),
merged in v6.6-rc1, added this trait to overlayfs, thus allowing fanotify
watching of overlayfs with FAN\_REPORT\_FID mode.
In retrospect, allowing an fanotify filesystem/mount mark on such
filesystem in FAN\_REPORT\_FID mode will result in getting events with
file handles, without the ability to resolve the filesystem objects from
those file handles (i.e. no open\_by\_handle\_at() support).
For v6.6, the safer option would be to allow this mode for inode marks
only, where the caller has the opportunity to use name\_to\_handle\_at() at
the time of setting the mark. In the future we can revise this decision.
Fixes: a95aef69a740 ("fanotify: support reporting non-decodeable file handles")
Signed-off-by: Amir Goldstein
Signed-off-by: Jan Kara
Message-Id: <20231018100000.2453965-2-amir73il@gmail.com>
Signed-off-by: Greg Kroah-Hartman
commit 62b7f49d3a78946d04066ce9067c2223ffb545f3
Author: Stanislaw Gruszka
Date: Tue Oct 17 14:13:53 2023 +0200
Revert "accel/ivpu: Use cached buffers for FW loading"
commit 610b5d219d1ccac8064556310cc0e62e3c202389 upstream.
This reverts commit 645d694559cab36fe6a57c717efcfa27d9321396.
The commit cause issues with memory access from the device side.
Switch back to write-combined memory mappings until the issues
will be properly addressed.
Add extra wmb() needed when boot\_params->save\_restore\_ret\_address() is
modified.
Reviewed-by: Karol Wachowski
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20231017121353.532466-1-stanislaw.gruszka@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 7d6179ce5b4ade212f8d6dd544ab18aa854fd5fa
Author: Adrian Hunter
Date: Thu Sep 28 10:16:05 2023 +0300
perf dlfilter: Fix use of addr\_location\_\_exit() in dlfilter\_\_object\_code()
commit 7a48b58eb5ff3798f0480d2da16bf27df9654fc7 upstream.
Stop calling addr\_location\_\_exit() when addr\_location\_\_init() was not
called.
Fixes: 0dd5041c9a0e ("perf addr\_location: Add init/exit/copy functions")
Cc: stable@vger.kernel.org
Signed-off-by: Adrian Hunter
Acked-by: Namhyung Kim
Link: https://lore.kernel.org/r/20230928071605.17624-1-adrian.hunter@intel.com
Signed-off-by: Namhyung Kim
Signed-off-by: Greg Kroah-Hartman
commit b2c39ae29f2b1bf16944659f0bca999f945b9de0
Author: Hanjun Guo
Date: Tue Oct 10 16:21:23 2023 +0800
ACPI: bus: Move acpi\_arm\_init() to the place of after acpi\_ghes\_init()
commit d5921c460e543228d100daf67dac7a03dfaaa40a upstream.
acpi\_agdi\_init() in acpi\_arm\_init() will register a SDEI event, so
it needs the SDEI subsystem to be initialized (which is done in
acpi\_ghes\_init()) before the AGDI driver probing.
In commit fcea0ccf4fd7 ("ACPI: bus: Consolidate all arm specific
initialisation into acpi\_arm\_init()"), the acpi\_agdi\_init() was
called before acpi\_ghes\_init() and it causes following failure:
| [ 0.515864] sdei: Failed to create event 1073741825: -5
| [ 0.515866] agdi agdi.0: Failed to register for SDEI event 1073741825
| [ 0.515867] agdi: probe of agdi.0 failed with error -5
| ...
| [ 0.516022] sdei: SDEIv1.0 (0x0) detected in firmware.
Fix it by moving acpi\_arm\_init() to the place of after
acpi\_ghes\_init().
Fixes: fcea0ccf4fd7 ("ACPI: bus: Consolidate all arm specific initialisation into acpi\_arm\_init()")
Reported-by: D Scott Phillips
Signed-off-by: Hanjun Guo
Reviewed-by: Sudeep Holla
Tested-by: D Scott Phillips
Cc: 6.5+  # 6.5+
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 14189248711ec47977bd600382eff4d6548d17f7
Author: Sunil V L
Date: Mon Oct 16 22:39:39 2023 +0530
ACPI: irq: Fix incorrect return value in acpi\_register\_gsi()
commit 0c21a18d5d6c6a73d098fb9b4701572370942df9 upstream.
acpi\_register\_gsi() should return a negative value in case of failure.
Currently, it returns the return value from irq\_create\_fwspec\_mapping().
However, irq\_create\_fwspec\_mapping() returns 0 for failure. Fix the
issue by returning -EINVAL if irq\_create\_fwspec\_mapping() returns zero.
Fixes: d44fa3d46079 ("ACPI: Add support for ResourceSource/IRQ domain mapping")
Cc: 4.11+  # 4.11+
Signed-off-by: Sunil V L
[ rjw: Rename a new local variable ]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit dba32abd641ded1fbbe8aaafb0d6be7ea3fc3ea9
Author: Olga Kornievskaia
Date: Mon Oct 9 10:59:01 2023 -0400
NFSv4.1: fixup use EXCHGID4\_FLAG\_USE\_PNFS\_DS for DS server
commit 379e4adfddd6a2f95a4f2029b8ddcbacf92b21f9 upstream.
This patches fixes commit 51d674a5e488 "NFSv4.1: use
EXCHGID4\_FLAG\_USE\_PNFS\_DS for DS server", purpose of that
commit was to mark EXCHANGE\_ID to the DS with the appropriate
flag.
However, connection to MDS can return both EXCHGID4\_FLAG\_USE\_PNFS\_DS
and EXCHGID4\_FLAG\_USE\_PNFS\_MDS set but previous patch would only
remember the USE\_PNFS\_DS and for the 2nd EXCHANGE\_ID send that
to the MDS.
Instead, just mark the pnfs path exclusively.
Fixes: 51d674a5e488 ("NFSv4.1: use EXCHGID4\_FLAG\_USE\_PNFS\_DS for DS server")
Signed-off-by: Olga Kornievskaia
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 2f1c0be27909e460fe2ae943d361280301909ee0
Author: Trond Myklebust
Date: Sun Oct 8 14:28:46 2023 -0400
pNFS/flexfiles: Check the layout validity in ff\_layout\_mirror\_prepare\_stats
commit e1c6cfbb3bd1377e2ddcbe06cf8fb1ec323ea7d3 upstream.
Ensure that we check the layout pointer and validity after dereferencing
it in ff\_layout\_mirror\_prepare\_stats.
Fixes: 08e2e5bc6c9a ("pNFS/flexfiles: Clean up layoutstats")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 0026f4f9657d9555d0d624c9b0d397150dcb63b7
Author: Trond Myklebust
Date: Sun Oct 8 14:20:19 2023 -0400
pNFS: Fix a hang in nfs4\_evict\_inode()
commit f63955721a8020e979b99cc417dcb6da3106aa24 upstream.
We are not allowed to call pnfs\_mark\_matching\_lsegs\_return() without
also holding a reference to the layout header, since doing so could lead
to the reference count going to zero when we call
pnfs\_layout\_remove\_lseg(). This again can lead to a hang when we get to
nfs4\_evict\_inode() and are unable to clear the layout pointer.
pnfs\_layout\_return\_unused\_byserver() is guilty of this behaviour, and
has been seen to trigger the refcount warning prior to a hang.
Fixes: b6d49ecd1081 ("NFSv4: Fix a pNFS layout related use-after-free race when freeing the inode")
Cc: stable@vger.kernel.org
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit 1e8fa3dd1ddb25f9157a17944c1e536c9787ec4e
Author: Andy Shevchenko
Date: Tue Oct 17 17:18:06 2023 +0300
Revert "pinctrl: avoid unsafe code pattern in find\_pinctrl()"
commit 62140a1e4dec4594d5d1e1d353747bf2ef434e8b upstream.
The commit breaks MMC enumeration on the Intel Merrifield
plaform.
Before:
[ 36.439057] mmc0: SDHCI controller on PCI [0000:00:01.0] using ADMA
[ 36.450924] mmc2: SDHCI controller on PCI [0000:00:01.3] using ADMA
[ 36.459355] mmc1: SDHCI controller on PCI [0000:00:01.2] using ADMA
[ 36.706399] mmc0: new DDR MMC card at address 0001
[ 37.058972] mmc2: new ultra high speed DDR50 SDIO card at address 0001
[ 37.278977] mmcblk0: mmc0:0001 H4G1d 3.64 GiB
[ 37.297300] mmcblk0: p1 p2 p3 p4 p5 p6 p7 p8 p9 p10
After:
[ 36.436704] mmc2: SDHCI controller on PCI [0000:00:01.3] using ADMA
[ 36.436720] mmc1: SDHCI controller on PCI [0000:00:01.0] using ADMA
[ 36.463685] mmc0: SDHCI controller on PCI [0000:00:01.2] using ADMA
[ 36.720627] mmc1: new DDR MMC card at address 0001
[ 37.068181] mmc2: new ultra high speed DDR50 SDIO card at address 0001
[ 37.279998] mmcblk1: mmc1:0001 H4G1d 3.64 GiB
[ 37.302670] mmcblk1: p1 p2 p3 p4 p5 p6 p7 p8 p9 p10
This reverts commit c153a4edff6ab01370fcac8e46f9c89cca1060c2.
Signed-off-by: Andy Shevchenko
Link: https://lore.kernel.org/r/20231017141806.535191-1-andriy.shevchenko@linux.intel.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 914f9b0cbefa3661a9dd184ab7fa40a9653fc895
Author: Krzysztof Kozlowski
Date: Fri Oct 13 16:57:05 2023 +0200
pinctrl: qcom: lpass-lpi: fix concurrent register updates
commit c8befdc411e5fd1bf95a13e8744c8ca79b412bee upstream.
The Qualcomm LPASS LPI pin controller driver uses one lock for guarding
Read-Modify-Write code for slew rate registers. However the pin
configuration and muxing registers have exactly the same RMW code but
are not protected.
Pin controller framework does not provide locking here, thus it is
possible to trigger simultaneous change of pin configuration registers
resulting in non-atomic changes.
Protect from concurrent access by re-using the same lock used to cover
the slew rate register. Using the same lock instead of adding second
one will make more sense, once we add support for newer Qualcomm SoC,
where slew rate is configured in the same register as pin
configuration/muxing.
Fixes: 6e261d1090d6 ("pinctrl: qcom: Add sm8250 lpass lpi pinctrl driver")
Cc: stable@vger.kernel.org
Reviewed-by: Linus Walleij
Signed-off-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20231013145705.219954-1-krzysztof.kozlowski@linaro.org
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 1e3d8720507e7bd1d460b6036207b9738e18b368
Author: Avri Altman
Date: Wed Sep 27 10:15:00 2023 +0300
mmc: core: Capture correct oemid-bits for eMMC cards
commit 84ee19bffc9306128cd0f1c650e89767079efeff upstream.
The OEMID is an 8-bit binary number rather than 16-bit as the current code
parses for. The OEMID occupies bits [111:104] in the CID register, see the
eMMC spec JESD84-B51 paragraph 7.2.3. It seems that the 16-bit comes from
the legacy MMC specs (v3.31 and before).
Let's fix the parsing by simply move to use 8-bit instead of 16-bit. This
means we ignore the impact on some of those old MMC cards that may be out
there, but on the other hand this shouldn't be a problem as the OEMID seems
not be an important feature for these cards.
Signed-off-by: Avri Altman
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230927071500.1791882-1-avri.altman@wdc.com
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit 67a5bfcf83dca806d5229a42ff7aac224bcf74c8
Author: Haibo Chen
Date: Wed Aug 30 17:39:22 2023 +0800
mmc: core: sdio: hold retuning if sdio in 1-bit mode
commit 32a9cdb8869dc111a0c96cf8e1762be9684af15b upstream.
tuning only support in 4-bit mode or 8 bit mode, so in 1-bit mode,
need to hold retuning.
Find this issue when use manual tuning method on imx93. When system
resume back, SDIO WIFI try to switch back to 4 bit mode, first will
trigger retuning, and all tuning command failed.
Signed-off-by: Haibo Chen
Acked-by: Adrian Hunter
Fixes: dfa13ebbe334 ("mmc: host: Add facility to support re-tuning")
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230830093922.3095850-1-haibo.chen@nxp.com
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit 1226f14ae02cd47ab6a6410291ac11a2cbfef6b4
Author: Ulf Hansson
Date: Wed Sep 13 13:29:21 2023 +0200
mmc: core: Fix error propagation for some ioctl commands
commit f19c5a73e6f78d69efce66cfdce31148c76a61a6 upstream.
Userspace has currently no way of checking the internal R1 response error
bits for some commands. This is a problem for some commands, like RPMB for
example. Typically, we may detect that the busy completion has successfully
ended, while in fact the card did not complete the requested operation.
To fix the problem, let's always poll with CMD13 for these commands and
during the polling, let's also aggregate the R1 response bits. Before
completing the ioctl request, let's propagate the R1 response bits too.
Reviewed-by: Avri Altman
Co-developed-by: Christian Loehle
Signed-off-by: Christian Loehle
Signed-off-by: Ulf Hansson
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230913112921.553019-1-ulf.hansson@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit 3d83022bf9b9ce5d74e69f777163387159199aac
Author: Pablo Sun
Date: Fri Sep 22 17:53:48 2023 +0800
mmc: mtk-sd: Use readl\_poll\_timeout\_atomic in msdc\_reset\_hw
commit c7bb120c1c66672b657e95d0942c989b8275aeb3 upstream.
Use atomic readl\_poll\_timeout\_atomic, because msdc\_reset\_hw
may be invoked in IRQ handler in the following context:
msdc\_irq() -> msdc\_cmd\_done() -> msdc\_reset\_hw()
The following kernel BUG stack trace can be observed on
Genio 1200 EVK after initializing MSDC1 hardware during kernel boot:
[ 1.187441] BUG: scheduling while atomic: swapper/0/0/0x00010002
[ 1.189157] Modules linked in:
[ 1.204633] CPU: 0 PID: 0 Comm: swapper/0 Tainted: G W 5.15.42-mtk+modified #1
[ 1.205713] Hardware name: MediaTek Genio 1200 EVK-P1V2-EMMC (DT)
[ 1.206484] Call trace:
[ 1.206796] dump\_backtrace+0x0/0x1ac
[ 1.207266] show\_stack+0x24/0x30
[ 1.207692] dump\_stack\_lvl+0x68/0x84
[ 1.208162] dump\_stack+0x1c/0x38
[ 1.208587] \_\_schedule\_bug+0x68/0x80
[ 1.209056] \_\_schedule+0x6ec/0x7c0
[ 1.209502] schedule+0x7c/0x110
[ 1.209915] schedule\_hrtimeout\_range\_clock+0xc4/0x1f0
[ 1.210569] schedule\_hrtimeout\_range+0x20/0x30
[ 1.211148] usleep\_range\_state+0x84/0xc0
[ 1.211661] msdc\_reset\_hw+0xc8/0x1b0
[ 1.212134] msdc\_cmd\_done.isra.0+0x4ac/0x5f0
[ 1.212693] msdc\_irq+0x104/0x2d4
[ 1.213121] \_\_handle\_irq\_event\_percpu+0x68/0x280
[ 1.213725] handle\_irq\_event+0x70/0x15c
[ 1.214230] handle\_fasteoi\_irq+0xb0/0x1a4
[ 1.214755] handle\_domain\_irq+0x6c/0x9c
[ 1.215260] gic\_handle\_irq+0xc4/0x180
[ 1.215741] call\_on\_irq\_stack+0x2c/0x54
[ 1.216245] do\_interrupt\_handler+0x5c/0x70
[ 1.216782] el1\_interrupt+0x30/0x80
[ 1.217242] el1h\_64\_irq\_handler+0x1c/0x2c
[ 1.217769] el1h\_64\_irq+0x78/0x7c
[ 1.218206] cpuidle\_enter\_state+0xc8/0x600
[ 1.218744] cpuidle\_enter+0x44/0x5c
[ 1.219205] do\_idle+0x224/0x2d0
[ 1.219624] cpu\_startup\_entry+0x30/0x80
[ 1.220129] rest\_init+0x108/0x134
[ 1.220568] arch\_call\_rest\_init+0x1c/0x28
[ 1.221094] start\_kernel+0x6c0/0x700
[ 1.221564] \_\_primary\_switched+0xc0/0xc8
Fixes: ffaea6ebfe9c ("mmc: mtk-sd: Use readl\_poll\_timeout instead of open-coded polling")
Signed-off-by: Pablo Sun
Reviewed-by: Chen-Yu Tsai
Reviewed-by: AngeloGioacchino Del Regno
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20230922095348.22182-1-pablo.sun@mediatek.com
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit 14eb82d5211701b6c6a2d1cf85b53659f12141f6
Author: Sven van Ashbrook
Date: Thu Aug 31 16:00:56 2023 +0000
mmc: sdhci-pci-gli: fix LPM negotiation so x86/S0ix SoCs can suspend
commit 1202d617e3d04c8d27a14ef30784a698c48170b3 upstream.
To improve the r/w performance of GL9763E, the current driver inhibits LPM
negotiation while the device is active.
This prevents a large number of SoCs from suspending, notably x86 systems
which commonly use S0ix as the suspend mechanism - for example, Intel
Alder Lake and Raptor Lake processors.
Failure description:
1. Userspace initiates s2idle suspend (e.g. via writing to
/sys/power/state)
2. This switches the runtime\_pm device state to active, which disables
LPM negotiation, then calls the "regular" suspend callback
3. With LPM negotiation disabled, the bus cannot enter low-power state
4. On a large number of SoCs, if the bus not in a low-power state, S0ix
cannot be entered, which in turn prevents the SoC from entering
suspend.
Fix by re-enabling LPM negotiation in the device's suspend callback.
Suggested-by: Stanislaw Kardach
Fixes: f9e5b33934ce ("mmc: host: Improve I/O read/write performance for GL9763E")
Cc: stable@vger.kernel.org
Signed-off-by: Sven van Ashbrook
Acked-by: Adrian Hunter
Link: https://lore.kernel.org/r/20230831160055.v3.1.I7ed1ca09797be2dd76ca914c57d88b32d24dac88@changeid
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit b6aa73574dd4072ffe32b7e28444b8189ca873ca
Author: Krzysztof Kozlowski
Date: Fri Aug 25 15:55:02 2023 +0200
dt-bindings: mmc: sdhci-msm: correct minimum number of clocks
commit 1bbac8d6af085408885675c1e29b2581250be124 upstream.
In the TXT binding before conversion, the "xo" clock was listed as
optional. Conversion kept it optional in "clock-names", but not in
"clocks". This fixes dbts\_check warnings like:
qcom-sdx65-mtp.dtb: mmc@8804000: clocks: [[13, 59], [13, 58]] is too short
Cc:
Fixes: a45537723f4b ("dt-bindings: mmc: sdhci-msm: Convert bindings to yaml")
Signed-off-by: Krzysztof Kozlowski
Acked-by: Conor Dooley
Link: https://lore.kernel.org/r/20230825135503.282135-1-krzysztof.kozlowski@linaro.org
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit 81f0c091c37a055c6d169086577f2d2ee1fa9b08
Author: Geert Uytterhoeven
Date: Wed Aug 30 17:00:34 2023 +0200
mtd: physmap-core: Restore map\_rom fallback
commit 6792b7fce610bcd1cf3e07af3607fe7e2c38c1d8 upstream.
When the exact mapping type driver was not available, the old
physmap\_of\_core driver fell back to mapping the region as ROM.
Unfortunately this feature was lost when the DT and pdata cases were
merged. Revive this useful feature.
Fixes: 642b1e8dbed7bbbf ("mtd: maps: Merge physmap\_of.c into physmap-core.c")
Signed-off-by: Geert Uytterhoeven
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/550e8c8c1da4c4baeb3d71ff79b14a18d4194f9e.1693407371.git.geert+renesas@glider.be
Signed-off-by: Greg Kroah-Hartman
commit 73df8fcfe7858d73ce967d9c0c8f9730df697cef
Author: Martin Kurbanov
Date: Tue Sep 5 17:56:37 2023 +0300
mtd: spinand: micron: correct bitmask for ecc status
commit 9836a987860e33943945d4b257729a4f94eae576 upstream.
Valid bitmask is 0x70 in the status register.
Fixes: a508e8875e13 ("mtd: spinand: Add initial support for Micron MT29F2G01ABAGD")
Signed-off-by: Martin Kurbanov
Reviewed-by: Frieder Schrempf
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20230905145637.139068-1-mmkurbanov@sberdevices.ru
Signed-off-by: Greg Kroah-Hartman
commit 13d605fb6b2be4212f3d289360887befd94a6ab6
Author: Rouven Czerwinski
Date: Fri Sep 22 16:17:16 2023 +0200
mtd: rawnand: Ensure the nand chip supports cached reads
commit f6ca3fb6978f94d95ee79f95085fc22e71ca17cc upstream.
Both the JEDEC and ONFI specification say that read cache sequential
support is an optional command. This means that we not only need to
check whether the individual controller supports the command, we also
need to check the parameter pages for both ONFI and JEDEC NAND flashes
before enabling sequential cache reads.
This fixes support for NAND flashes which don't support enabling cache
reads, i.e. Samsung K9F4G08U0F or Toshiba TC58NVG0S3HTA00.
Sequential cache reads are now only available for ONFI and JEDEC
devices, if individual vendors implement this, it needs to be enabled
per vendor.
Tested on i.MX6Q with a Samsung NAND flash chip that doesn't support
sequential reads.
Fixes: 003fe4b9545b ("mtd: rawnand: Support for sequential cache reads")
Cc: stable@vger.kernel.org
Signed-off-by: Rouven Czerwinski
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20230922141717.35977-1-r.czerwinski@pengutronix.de
Signed-off-by: Greg Kroah-Hartman
commit 2cdca57606b18a076b350453a70aa5d72856f2fb
Author: Miquel Raynal
Date: Mon Jul 17 21:42:20 2023 +0200
mtd: rawnand: arasan: Ensure program page operations are successful
commit 3a4a893dbb19e229db3b753f0462520b561dee98 upstream.
The NAND core complies with the ONFI specification, which itself
mentions that after any program or erase operation, a status check
should be performed to see whether the operation was finished \*and\*
successful.
The NAND core offers helpers to finish a page write (sending the
"PAGE PROG" command, waiting for the NAND chip to be ready again, and
checking the operation status). But in some cases, advanced controller
drivers might want to optimize this and craft their own page write
helper to leverage additional hardware capabilities, thus not always
using the core facilities.
Some drivers, like this one, do not use the core helper to finish a page
write because the final cycles are automatically managed by the
hardware. In this case, the additional care must be taken to manually
perform the final status check.
Let's read the NAND chip status at the end of the page write helper and
return -EIO upon error.
Cc: Michal Simek
Cc: stable@vger.kernel.org
Fixes: 88ffef1b65cf ("mtd: rawnand: arasan: Support the hardware BCH ECC engine")
Signed-off-by: Miquel Raynal
Acked-by: Michal Simek
Link: https://lore.kernel.org/linux-mtd/20230717194221.229778-2-miquel.raynal@bootlin.com
Signed-off-by: Greg Kroah-Hartman
commit d20ec8d2f31c1655c587f82690f5ffd2ce195ed4
Author: Miquel Raynal
Date: Mon Jul 17 21:42:19 2023 +0200
mtd: rawnand: marvell: Ensure program page operations are successful
commit 3e01d5254698ea3d18e09d96b974c762328352cd upstream.
The NAND core complies with the ONFI specification, which itself
mentions that after any program or erase operation, a status check
should be performed to see whether the operation was finished \*and\*
successful.
The NAND core offers helpers to finish a page write (sending the
"PAGE PROG" command, waiting for the NAND chip to be ready again, and
checking the operation status). But in some cases, advanced controller
drivers might want to optimize this and craft their own page write
helper to leverage additional hardware capabilities, thus not always
using the core facilities.
Some drivers, like this one, do not use the core helper to finish a page
write because the final cycles are automatically managed by the
hardware. In this case, the additional care must be taken to manually
perform the final status check.
Let's read the NAND chip status at the end of the page write helper and
return -EIO upon error.
Cc: stable@vger.kernel.org
Fixes: 02f26ecf8c77 ("mtd: nand: add reworked Marvell NAND controller driver")
Reported-by: Aviram Dali
Signed-off-by: Miquel Raynal
Tested-by: Ravi Chandra Minnikanti
Link: https://lore.kernel.org/linux-mtd/20230717194221.229778-1-miquel.raynal@bootlin.com
Signed-off-by: Greg Kroah-Hartman
commit 6225891e7960e3b239beb7a495dcf48f969c267b
Author: Miquel Raynal
Date: Mon Jul 17 21:42:21 2023 +0200
mtd: rawnand: pl353: Ensure program page operations are successful
commit 9777cc13fd2c3212618904636354be60835e10bb upstream.
The NAND core complies with the ONFI specification, which itself
mentions that after any program or erase operation, a status check
should be performed to see whether the operation was finished \*and\*
successful.
The NAND core offers helpers to finish a page write (sending the
"PAGE PROG" command, waiting for the NAND chip to be ready again, and
checking the operation status). But in some cases, advanced controller
drivers might want to optimize this and craft their own page write
helper to leverage additional hardware capabilities, thus not always
using the core facilities.
Some drivers, like this one, do not use the core helper to finish a page
write because the final cycles are automatically managed by the
hardware. In this case, the additional care must be taken to manually
perform the final status check.
Let's read the NAND chip status at the end of the page write helper and
return -EIO upon error.
Cc: Michal Simek
Cc: stable@vger.kernel.org
Fixes: 08d8c62164a3 ("mtd: rawnand: pl353: Add support for the ARM PL353 SMC NAND controller")
Signed-off-by: Miquel Raynal
Tested-by: Michal Simek
Link: https://lore.kernel.org/linux-mtd/20230717194221.229778-3-miquel.raynal@bootlin.com
Signed-off-by: Greg Kroah-Hartman
commit 42a17fc11578e3622794dcd335a87a074f9df626
Author: Bibek Kumar Patro
Date: Wed Sep 13 12:37:02 2023 +0530
mtd: rawnand: qcom: Unmap the right resource upon probe failure
commit 5279f4a9eed3ee7d222b76511ea7a22c89e7eefd upstream.
We currently provide the physical address of the DMA region
rather than the output of dma\_map\_resource() which is obviously wrong.
Fixes: 7330fc505af4 ("mtd: rawnand: qcom: stop using phys\_to\_dma()")
Cc: stable@vger.kernel.org
Reviewed-by: Manivannan Sadhasivam
Signed-off-by: Bibek Kumar Patro
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/linux-mtd/20230913070702.12707-1-quic\_bibekkum@quicinc.com
Signed-off-by: Greg Kroah-Hartman
commit 6f3e86a85ab2dbc97e8e7ef10a8f08a7677738d7
Author: Paolo Abeni
Date: Tue Oct 17 17:49:51 2023 +0200
tcp\_bpf: properly release resources on error paths
[ Upstream commit 68b54aeff804acceb02f228ea2e28419272c1fb9 ]
In the blamed commit below, I completely forgot to release the acquired
resources before erroring out in the TCP BPF code, as reported by Dan.
Address the issues by replacing the bogus return with a jump to the
relevant cleanup code.
Fixes: 419ce133ab92 ("tcp: allow again tcp\_disconnect() when threads are waiting")
Reported-by: Dan Carpenter
Signed-off-by: Paolo Abeni
Acked-by: Jakub Sitnicki
Reviewed-by: Eric Dumazet
Reviewed-by: John Fastabend
Link: https://lore.kernel.org/r/8f99194c698bcef12666f0a9a999c58f8b1cb52c.1697557782.git.pabeni@redhat.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 057fabf0ba7794851336bf850d2136238f1e956f
Author: Luiz Augusto von Dentz
Date: Thu Oct 5 13:59:59 2023 -0700
Bluetooth: hci\_event: Fix using memcmp when comparing keys
[ Upstream commit b541260615f601ae1b5d6d0cc54e790de706303b ]
memcmp is not consider safe to use with cryptographic secrets:
'Do not use memcmp() to compare security critical data, such as
cryptographic secrets, because the required CPU time depends on the
number of equal bytes.'
While usage of memcmp for ZERO\_KEY may not be considered a security
critical data, it can lead to more usage of memcmp with pairing keys
which could introduce more security problems.
Fixes: 455c2ff0a558 ("Bluetooth: Fix BR/EDR out-of-band pairing with only initiator data")
Fixes: 33155c4aae52 ("Bluetooth: hci\_event: Ignore NULL link key")
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 30fa7600e0580cabbbc50e1c94b5609a85469809
Author: Paolo Abeni
Date: Wed Oct 11 09:20:55 2023 +0200
tcp: allow again tcp\_disconnect() when threads are waiting
[ Upstream commit 419ce133ab928ab5efd7b50b2ef36ddfd4eadbd2 ]
As reported by Tom, .NET and applications build on top of it rely
on connect(AF\_UNSPEC) to async cancel pending I/O operations on TCP
socket.
The blamed commit below caused a regression, as such cancellation
can now fail.
As suggested by Eric, this change addresses the problem explicitly
causing blocking I/O operation to terminate immediately (with an error)
when a concurrent disconnect() is executed.
Instead of tracking the number of threads blocked on a given socket,
track the number of disconnect() issued on such socket. If such counter
changes after a blocking operation releasing and re-acquiring the socket
lock, error out the current operation.
Fixes: 4faeee0cf8a5 ("tcp: deny tcp\_disconnect() when threads are waiting")
Reported-by: Tom Deseyn
Closes: https://bugzilla.redhat.com/show\_bug.cgi?id=1886305
Suggested-by: Eric Dumazet
Signed-off-by: Paolo Abeni
Reviewed-by: Eric Dumazet
Link: https://lore.kernel.org/r/f3b95e47e3dbed840960548aebaa8d954372db41.1697008693.git.pabeni@redhat.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 3d45ae77292e5697366362b2393565eaed6789bd
Author: Hannes Reinecke
Date: Wed Jul 26 21:15:55 2023 +0200
net/tls: split tls\_rx\_reader\_lock
[ Upstream commit f9ae3204fb45d0749befc1cdff50f691c7461e5a ]
Split tls\_rx\_reader\_{lock,unlock} into an 'acquire/release' and
the actual locking part.
With that we can use the tls\_rx\_reader\_lock in situations where
the socket is already locked.
Suggested-by: Sagi Grimberg
Signed-off-by: Hannes Reinecke
Reviewed-by: Jakub Kicinski
Link: https://lore.kernel.org/r/20230726191556.41714-6-hare@suse.de
Signed-off-by: Jakub Kicinski
Stable-dep-of: 419ce133ab92 ("tcp: allow again tcp\_disconnect() when threads are waiting")
Signed-off-by: Sasha Levin
commit cb9a6db7a58f4c259f7ec3bfc871391c21f93dcc
Author: Amir Tzin
Date: Mon Sep 4 18:26:47 2023 +0300
net/mlx5e: Fix VF representors reporting zero counters to "ip -s" command
[ Upstream commit 80f1241484dd1b1d4eab1a0211d52ec2bd83e2f1 ]
Although vf\_vport entry of struct mlx5e\_stats is never updated, its
values are mistakenly copied to the caller structure in the VF
representor .ndo\_get\_stat\_64 callback mlx5e\_rep\_get\_stats(). Remove
redundant entry and use the updated one, rep\_stats, instead.
Fixes: 64b68e369649 ("net/mlx5: Refactor and expand rep vport stat group")
Reviewed-by: Patrisious Haddad
Signed-off-by: Amir Tzin
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 150de4a3f0c6fecea8ec6ab716daa680d01ad9c8
Author: Jianbo Liu
Date: Tue Sep 12 02:28:47 2023 +0000
net/mlx5e: Don't offload internal port if filter device is out device
[ Upstream commit 06b4eac9c4beda520b8a4dbbb8e33dba9d1c8fba ]
In the cited commit, if the routing device is ovs internal port, the
out device is set to uplink, and packets go out after encapsulation.
If filter device is uplink, it can trigger the following syndrome:
mlx5\_core 0000:08:00.0: mlx5\_cmd\_out\_err:803:(pid 3966): SET\_FLOW\_TABLE\_ENTRY(0x936) op\_mod(0x0) failed, status bad parameter(0x3), syndrome (0xcdb051), err(-22)
Fix this issue by not offloading internal port if filter device is out
device. In this case, packets are not forwarded to the root table to
be processed, the termination table is used instead to forward them
from uplink to uplink.
Fixes: 100ad4e2d758 ("net/mlx5e: Offload internal port as encap route device")
Signed-off-by: Jianbo Liu
Reviewed-by: Ariel Levkovich
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 8b7f7beba354fb0f973754415f7372446b3cb3c6
Author: Lama Kayal
Date: Tue Sep 12 10:06:24 2023 +0300
net/mlx5e: Take RTNL lock before triggering netdev notifiers
[ Upstream commit c51c673462a266fb813cf189f8190798a12d3124 ]
Hold RTNL lock when calling xdp\_set\_features() with a registered netdev,
as the call triggers the netdev notifiers. This could happen when
switching from nic profile to uplink representor for example.
Similar logic which fixed a similar scenario was previously introduced in
the following commit:
commit 72cc65497065 net/mlx5e: Take RTNL lock when needed before calling
xdp\_set\_features().
This fixes the following assertion and warning call trace:
RTNL: assertion failed at net/core/dev.c (1961)
WARNING: CPU: 13 PID: 2529 at net/core/dev.c:1961
call\_netdevice\_notifiers\_info+0x7c/0x80
Modules linked in: rpcrdma rdma\_ucm ib\_iser libiscsi
scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm mlx5\_ib
ib\_uverbs ib\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink
nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter rpcsec\_gss\_krb5
auth\_rpcgss oid\_registry overlay mlx5\_core zram zsmalloc fuse
CPU: 13 PID: 2529 Comm: devlink Not tainted
6.5.0\_for\_upstream\_min\_debug\_2023\_09\_07\_20\_04 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS
rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
RIP: 0010:call\_netdevice\_notifiers\_info+0x7c/0x80
Code: 8f ff 80 3d 77 0d 16 01 00 75 c5 ba a9 07 00 00 48
c7 c6 c4 bb 0d 82 48 c7 c7 18 c8 06 82 c6 05 5b 0d 16 01 01 e8 44 f6 8c
ff <0f> 0b eb a2 0f 1f 44 00 00 55 48 89 e5 41 54 48 83 e4 f0 48 83 ec
RSP: 0018:ffff88819930f7f0 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffffffff8309f740 RCX: 0000000000000027
RDX: ffff88885fb5b5c8 RSI: 0000000000000001 RDI: ffff88885fb5b5c0
RBP: 0000000000000028 R08: ffff88887ffabaa8 R09: 0000000000000003
R10: ffff88887fecbac0 R11: ffff88887ff7bac0 R12: ffff88819930f810
R13: ffff88810b7fea40 R14: ffff8881154e8fd8 R15: ffff888107e881a0
FS: 00007f3ad248f800(0000) GS:ffff88885fb40000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000563b85f164e0 CR3: 0000000113b5c006 CR4: 0000000000370ea0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
? \_\_warn+0x79/0x120
? call\_netdevice\_notifiers\_info+0x7c/0x80
? report\_bug+0x17c/0x190
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? call\_netdevice\_notifiers\_info+0x7c/0x80
call\_netdevice\_notifiers+0x2e/0x50
mlx5e\_set\_xdp\_feature+0x21/0x50 [mlx5\_core]
mlx5e\_build\_rep\_params+0x97/0x130 [mlx5\_core]
mlx5e\_init\_ul\_rep+0x9f/0x100 [mlx5\_core]
mlx5e\_netdev\_init\_profile+0x76/0x110 [mlx5\_core]
mlx5e\_netdev\_attach\_profile+0x1f/0x90 [mlx5\_core]
mlx5e\_netdev\_change\_profile+0x92/0x160 [mlx5\_core]
mlx5e\_vport\_rep\_load+0x329/0x4a0 [mlx5\_core]
mlx5\_esw\_offloads\_rep\_load+0x9e/0xf0 [mlx5\_core]
esw\_offloads\_enable+0x4bc/0xe90 [mlx5\_core]
mlx5\_eswitch\_enable\_locked+0x3c8/0x570 [mlx5\_core]
? kmalloc\_trace+0x25/0x80
mlx5\_devlink\_eswitch\_mode\_set+0x224/0x680 [mlx5\_core]
? devlink\_get\_from\_attrs\_lock+0x9e/0x110
devlink\_nl\_cmd\_eswitch\_set\_doit+0x60/0xe0
genl\_family\_rcv\_msg\_doit+0xd0/0x120
genl\_rcv\_msg+0x180/0x2b0
? devlink\_get\_from\_attrs\_lock+0x110/0x110
? devlink\_nl\_cmd\_eswitch\_get\_doit+0x290/0x290
? devlink\_pernet\_pre\_exit+0xf0/0xf0
? genl\_family\_rcv\_msg\_dumpit+0xf0/0xf0
netlink\_rcv\_skb+0x54/0x100
genl\_rcv+0x24/0x40
netlink\_unicast+0x1fc/0x2c0
netlink\_sendmsg+0x232/0x4a0
sock\_sendmsg+0x38/0x60
? \_copy\_from\_user+0x2a/0x60
\_\_sys\_sendto+0x110/0x160
? handle\_mm\_fault+0x161/0x260
? do\_user\_addr\_fault+0x276/0x620
\_\_x64\_sys\_sendto+0x20/0x30
do\_syscall\_64+0x3d/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
RIP: 0033:0x7f3ad231340a
Code: d8 64 89 02 48 c7 c0 ff ff ff ff eb b8 0f 1f 00 f3
0f 1e fa 41 89 ca 64 8b 04 25 18 00 00 00 85 c0 75 15 b8 2c 00 00 00 0f
05 <48> 3d 00 f0 ff ff 77 7e c3 0f 1f 44 00 00 41 54 48 83 ec 30 44 89
RSP: 002b:00007ffd70aad4b8 EFLAGS: 00000246 ORIG\_RAX: 000000000000002c
RAX: ffffffffffffffda RBX: 0000000000c36b00 RCX:00007f3ad231340a
RDX: 0000000000000038 RSI: 0000000000c36b00 RDI: 0000000000000003
RBP: 0000000000c36910 R08: 00007f3ad2625200 R09: 000000000000000c
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000001

---[ end trace 0000000000000000 ]---
------------[ cut here ]------------
Fixes: 4d5ab0ad964d ("net/mlx5e: take into account device reconfiguration for xdp\_features flag")
Signed-off-by: Lama Kayal
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit f2997256d0d85170b0dc997a1bc6d5491079d155
Author: Dragos Tatulea
Date: Mon Sep 25 17:50:18 2023 +0300
net/mlx5e: XDP, Fix XDP\_REDIRECT mpwqe page fragment leaks on shutdown
[ Upstream commit aaab619ccd07a32e5b29aa7e59b20de1dcc7a29e ]
When mlx5e\_xdp\_xmit is called without the XDP\_XMIT\_FLUSH set it is
possible that it leaves a mpwqe session open. That is ok during runtime:
the session will be closed on the next call to mlx5e\_xdp\_xmit. But
having a mpwqe session still open at XDP sq close time is problematic:
the pc counter is not updated before flushing the contents of the
xdpi\_fifo. This results in leaking page fragments.
The fix is to always close the mpwqe session at the end of
mlx5e\_xdp\_xmit, regardless of the XDP\_XMIT\_FLUSH flag being set or not.
Fixes: 5e0d2eef771e ("net/mlx5e: XDP, Support Enhanced Multi-Packet TX WQE")
Signed-off-by: Dragos Tatulea
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 7bef60897d24d92a4f5a58214d23d28a338962ab
Author: Dragos Tatulea
Date: Fri Sep 29 17:31:49 2023 +0300
net/mlx5e: RX, Fix page\_pool allocation failure recovery for legacy rq
[ Upstream commit ef9369e9c30846f5e052a11ccc70e1f6b8dc557a ]
When a page allocation fails during refill in mlx5e\_refill\_rx\_wqes, the
page will be released again on the next refill call. This triggers the
page\_pool negative page fragment count warning below:
[ 338.326070] WARNING: CPU: 4 PID: 0 at include/net/page\_pool/helpers.h:130 mlx5e\_page\_release\_fragmented.isra.0+0x42/0x50 [mlx5\_core]
...
[ 338.328993] RIP: 0010:mlx5e\_page\_release\_fragmented.isra.0+0x42/0x50 [mlx5\_core]
[ 338.329094] Call Trace:
[ 338.329097]
[ 338.329100] ? \_\_warn+0x7d/0x120
[ 338.329105] ? mlx5e\_page\_release\_fragmented.isra.0+0x42/0x50 [mlx5\_core]
[ 338.329173] ? report\_bug+0x155/0x180
[ 338.329179] ? handle\_bug+0x3c/0x60
[ 338.329183] ? exc\_invalid\_op+0x13/0x60
[ 338.329187] ? asm\_exc\_invalid\_op+0x16/0x20
[ 338.329192] ? mlx5e\_page\_release\_fragmented.isra.0+0x42/0x50 [mlx5\_core]
[ 338.329259] mlx5e\_post\_rx\_wqes+0x210/0x5a0 [mlx5\_core]
[ 338.329327] ? mlx5e\_poll\_rx\_cq+0x88/0x6f0 [mlx5\_core]
[ 338.329394] mlx5e\_napi\_poll+0x127/0x6b0 [mlx5\_core]
[ 338.329461] \_\_napi\_poll+0x25/0x1a0
[ 338.329465] net\_rx\_action+0x28a/0x300
[ 338.329468] \_\_do\_softirq+0xcd/0x279
[ 338.329473] irq\_exit\_rcu+0x6a/0x90
[ 338.329477] common\_interrupt+0x82/0xa0
[ 338.329482]
This patch fixes the legacy rq case by releasing all allocated fragments
and then setting the skip flag on all released fragments. It is
important to note that the number of released fragments will be higher
than the number of allocated fragments when an allocation error occurs.
Fixes: 3f93f82988bc ("net/mlx5e: RX, Defer page release in legacy rq for better recycling")
Tested-by: Chris Mason
Reported-by: Chris Mason
Closes: https://lore.kernel.org/netdev/117FF31A-7BE0-4050-B2BB-E41F224FF72F@meta.com
Signed-off-by: Dragos Tatulea
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit d630fe115ef95859340a4207b3a188ea8b9becf4
Author: Dragos Tatulea
Date: Mon Oct 2 14:05:29 2023 +0300
net/mlx5e: RX, Fix page\_pool allocation failure recovery for striding rq
[ Upstream commit be43b7489a3c4702799e50179da69c3df7d6899b ]
When a page allocation fails during refill in mlx5e\_post\_rx\_mpwqes, the
page will be released again on the next refill call. This triggers the
page\_pool negative page fragment count warning below:
[ 2436.447717] WARNING: CPU: 1 PID: 2419 at include/net/page\_pool/helpers.h:130 mlx5e\_page\_release\_fragmented.isra.0+0x42/0x50 [mlx5\_core]
...
[ 2436.447895] RIP: 0010:mlx5e\_page\_release\_fragmented.isra.0+0x42/0x50 [mlx5\_core]
[ 2436.447991] Call Trace:
[ 2436.447975] mlx5e\_post\_rx\_mpwqes+0x1d5/0xcf0 [mlx5\_core]
[ 2436.447994]
[ 2436.447996] ? \_\_warn+0x7d/0x120
[ 2436.448009] ? mlx5e\_handle\_rx\_cqe\_mpwrq+0x109/0x1d0 [mlx5\_core]
[ 2436.448002] ? mlx5e\_page\_release\_fragmented.isra.0+0x42/0x50 [mlx5\_core]
[ 2436.448044] ? mlx5e\_poll\_rx\_cq+0x87/0x6e0 [mlx5\_core]
[ 2436.448061] ? report\_bug+0x155/0x180
[ 2436.448065] ? handle\_bug+0x36/0x70
[ 2436.448067] ? exc\_invalid\_op+0x13/0x60
[ 2436.448070] ? asm\_exc\_invalid\_op+0x16/0x20
[ 2436.448079] mlx5e\_napi\_poll+0x122/0x6b0 [mlx5\_core]
[ 2436.448077] ? mlx5e\_page\_release\_fragmented.isra.0+0x42/0x50 [mlx5\_core]
[ 2436.448113] ? generic\_exec\_single+0x35/0x100
[ 2436.448117] \_\_napi\_poll+0x25/0x1a0
[ 2436.448120] net\_rx\_action+0x28a/0x300
[ 2436.448122] \_\_do\_softirq+0xcd/0x279
[ 2436.448126] irq\_exit\_rcu+0x6a/0x90
[ 2436.448128] sysvec\_apic\_timer\_interrupt+0x6e/0x90
[ 2436.448130]
This patch fixes the striding rq case by setting the skip flag on all
the wqe pages that were expected to have new pages allocated.
Fixes: 4c2a13236807 ("net/mlx5e: RX, Defer page release in striding rq for better recycling")
Tested-by: Chris Mason
Reported-by: Chris Mason
Closes: https://lore.kernel.org/netdev/117FF31A-7BE0-4050-B2BB-E41F224FF72F@meta.com
Signed-off-by: Dragos Tatulea
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit f0fbcbb7047200880569cca647c99b8a2bf82975
Author: Maher Sanalla
Date: Wed Sep 6 21:48:30 2023 +0300
net/mlx5: Handle fw tracer change ownership event based on MTRC
[ Upstream commit 92fd39634541eb0a11bf1bafbc8ba92d6ddb8dba ]
Currently, whenever fw issues a change ownership event, the PF that owns
the fw tracer drops its ownership directly and the other PFs try to pick
up the ownership via what MTRC register suggests.
In some cases, driver releases the ownership of the tracer and reacquires
it later on. Whenever the driver releases ownership of the tracer, fw
issues a change ownership event. This event can be delayed and come after
driver has reacquired ownership of the tracer. Thus the late event will
trigger the tracer owner PF to release the ownership again and lead to a
scenario where no PF is owning the tracer.
To prevent the scenario described above, when handling a change
ownership event, do not drop ownership of the tracer directly, instead
read the fw MTRC register to retrieve the up-to-date owner of the tracer
and set it accordingly in driver level.
Fixes: f53aaa31cce7 ("net/mlx5: FW tracer, implement tracer logic")
Signed-off-by: Maher Sanalla
Reviewed-by: Shay Drory
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit dc426bd9d813aa5754ce35adaa6f97f0585c06fc
Author: Shay Drory
Date: Sun Aug 27 13:31:53 2023 +0300
net/mlx5: E-switch, register event handler before arming the event
[ Upstream commit 7624e58a8b3a251e3e5108b32f2183b34453db32 ]
Currently, mlx5 is registering event handler for vport context change
event some time after arming the event. this can lead to missing an
event, which will result in wrong rules in the FDB.
Hence, register the event handler before arming the event.
This solution is valid since FW is sending vport context change event
only on vports which SW armed, and SW arming the vport when enabling
it, which is done after the FDB has been created.
Fixes: 6933a9379559 ("net/mlx5: E-Switch, Use async events chain")
Signed-off-by: Shay Drory
Reviewed-by: Mark Bloch
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 36eee433e85e5c3b749e0f8eef1dae6134ffef7f
Author: Pauli Virtanen
Date: Sat Sep 30 15:53:32 2023 +0300
Bluetooth: hci\_sync: always check if connection is alive before deleting
[ Upstream commit a239110ee8e0b0aafa265f0d54f7a16744855e70 ]
In hci\_abort\_conn\_sync it is possible that conn is deleted concurrently
by something else, also e.g. when waiting for hdev->lock. This causes
double deletion of the conn, so UAF or conn\_hash.list corruption.
Fix by having all code paths check that the connection is still in
conn\_hash before deleting it, while holding hdev->lock which prevents
any races.
Log (when powering off while BAP streaming, occurs rarely):
=======================================================================
kernel BUG at lib/list\_debug.c:56!
...
? \_\_list\_del\_entry\_valid (lib/list\_debug.c:56)
hci\_conn\_del (net/bluetooth/hci\_conn.c:154) bluetooth
hci\_abort\_conn\_sync (net/bluetooth/hci\_sync.c:5415) bluetooth
? \_\_pfx\_hci\_abort\_conn\_sync+0x10/0x10 [bluetooth]
? lock\_release+0x1d5/0x3c0
? hci\_disconnect\_all\_sync.constprop.0+0xb2/0x230 [bluetooth]
? \_\_pfx\_lock\_release+0x10/0x10
? \_\_kmem\_cache\_free+0x14d/0x2e0
hci\_disconnect\_all\_sync.constprop.0+0xda/0x230 [bluetooth]
? \_\_pfx\_hci\_disconnect\_all\_sync.constprop.0+0x10/0x10 [bluetooth]
? hci\_clear\_adv\_sync+0x14f/0x170 [bluetooth]
? \_\_pfx\_set\_powered\_sync+0x10/0x10 [bluetooth]
hci\_set\_powered\_sync+0x293/0x450 [bluetooth]
=======================================================================
Fixes: 94d9ba9f9888 ("Bluetooth: hci\_sync: Fix UAF in hci\_disconnect\_all\_sync")
Signed-off-by: Pauli Virtanen
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 3b9e2e14ba36230cf2b934d11fcc91f90fd49275
Author: Pauli Virtanen
Date: Thu Jul 27 00:25:25 2023 +0300
Bluetooth: hci\_sync: delete CIS in BT\_OPEN/CONNECT/BOUND when aborting
[ Upstream commit 2889bdd0a9a195533c2103e7b39ab0de844d72f6 ]
Dropped CIS that are in state BT\_OPEN/BT\_BOUND, and in state BT\_CONNECT
with HCI\_CONN\_CREATE\_CIS unset, should be cleaned up immediately.
Closing CIS ISO sockets should result to the hci\_conn be deleted, so
that potentially pending CIG removal can run.
hci\_abort\_conn cannot refer to them by handle, since their handle is
still unset if Set CIG Parameters has not yet completed.
This fixes CIS not being terminated if the socket is shut down
immediately after connection, so that the hci\_abort\_conn runs before Set
CIG Parameters completes. See new BlueZ test "ISO Connect Close - Success"
Signed-off-by: Pauli Virtanen
Signed-off-by: Luiz Augusto von Dentz
Stable-dep-of: a239110ee8e0 ("Bluetooth: hci\_sync: always check if connection is alive before deleting")
Signed-off-by: Sasha Levin
commit 8f3a578a9feff546936d385021381d38201eb6e9
Author: Iulia Tanasescu
Date: Thu Sep 28 10:52:57 2023 +0300
Bluetooth: ISO: Fix invalid context error
[ Upstream commit acab8ff29a2a226409cfe04e6d2e0896928c1b3a ]
This moves the hci\_le\_terminate\_big\_sync call from rx\_work
to cmd\_sync\_work, to avoid calling sleeping function from
an invalid context.
Reported-by: syzbot+c715e1bd8dfbcb1ab176@syzkaller.appspotmail.com
Fixes: a0bfde167b50 ("Bluetooth: ISO: Add support for connecting multiple BISes")
Signed-off-by: Iulia Tanasescu
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 98c78aef17bced280b250e743c5085d48fae53a2
Author: Luiz Augusto von Dentz
Date: Fri Aug 4 16:23:41 2023 -0700
Bluetooth: hci\_sync: Introduce PTR\_UINT/UINT\_PTR macros
[ Upstream commit a1f6c3aef13c9e7f8d459bd464e9e34da1342c0c ]
This introduces PTR\_UINT/UINT\_PTR macros and replace the use of
PTR\_ERR/ERR\_PTR.
Signed-off-by: Luiz Augusto von Dentz
Stable-dep-of: acab8ff29a2a ("Bluetooth: ISO: Fix invalid context error")
Signed-off-by: Sasha Levin
commit d924ba62fe867ca22008864c0b508ebde10f5abb
Author: Luiz Augusto von Dentz
Date: Tue Jun 27 15:55:47 2023 -0700
Bluetooth: hci\_sync: Fix not handling ISO\_LINK in hci\_abort\_conn\_sync
[ Upstream commit 04a51d616929eb96b7a3e547bc11d3bb46af2c9f ]
ISO\_LINK connections where not being handled properly on
hci\_abort\_conn\_sync which sometimes resulted in sending the wrong
commands, or in case of having the reject command being sent by the
socket code (iso.c) which is sort of a layer violation.
Signed-off-by: Luiz Augusto von Dentz
Stable-dep-of: acab8ff29a2a ("Bluetooth: ISO: Fix invalid context error")
Signed-off-by: Sasha Levin
commit 054dfb821c6e4328bca6a23b2bcb292fbf730cb0
Author: Jeff Moyer
Date: Thu Oct 5 13:55:31 2023 -0400
io-wq: fully initialize wqe before calling cpuhp\_state\_add\_instance\_nocalls()
[ Upstream commit 0f8baa3c9802fbfe313c901e1598397b61b91ada ]
I received a bug report with the following signature:
[ 1759.937637] BUG: unable to handle page fault for address: ffffffffffffffe8
[ 1759.944564] #PF: supervisor read access in kernel mode
[ 1759.949732] #PF: error\_code(0x0000) - not-present page
[ 1759.954901] PGD 7ab615067 P4D 7ab615067 PUD 7ab617067 PMD 0
[ 1759.960596] Oops: 0000 1 PREEMPT SMP PTI
[ 1759.964804] CPU: 15 PID: 109 Comm: cpuhp/15 Kdump: loaded Tainted: G X ------- — 5.14.0-362.3.1.el9\_3.x86\_64 #1
[ 1759.976609] Hardware name: HPE ProLiant DL380 Gen10/ProLiant DL380 Gen10, BIOS U30 06/20/2018
[ 1759.985181] RIP: 0010:io\_wq\_for\_each\_worker.isra.0+0x24/0xa0
[ 1759.990877] Code: 90 90 90 90 90 90 0f 1f 44 00 00 41 56 41 55 41 54 55 48 8d 6f 78 53 48 8b 47 78 48 39 c5 74 4f 49 89 f5 49 89 d4 48 8d 58 e8 <8b> 13 85 d2 74 32 8d 4a 01 89 d0 f0 0f b1 0b 75 5c 09 ca 78 3d 48
[ 1760.009758] RSP: 0000:ffffb6f403603e20 EFLAGS: 00010286
[ 1760.015013] RAX: 0000000000000000 RBX: ffffffffffffffe8 RCX: 0000000000000000
[ 1760.022188] RDX: ffffb6f403603e50 RSI: ffffffffb11e95b0 RDI: ffff9f73b09e9400
[ 1760.029362] RBP: ffff9f73b09e9478 R08: 000000000000000f R09: 0000000000000000
[ 1760.036536] R10: ffffffffffffff00 R11: ffffb6f403603d80 R12: ffffb6f403603e50
[ 1760.043712] R13: ffffffffb11e95b0 R14: ffffffffb28531e8 R15: ffff9f7a6fbdf548
[ 1760.050887] FS: 0000000000000000(0000) GS:ffff9f7a6fbc0000(0000) knlGS:0000000000000000
[ 1760.059025] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1760.064801] CR2: ffffffffffffffe8 CR3: 00000007ab610002 CR4: 00000000007706e0
[ 1760.071976] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 1760.079150] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 1760.086325] PKRU: 55555554
[ 1760.089044] Call Trace:
[ 1760.091501]
[ 1760.093612] ? show\_trace\_log\_lvl+0x1c4/0x2df
[ 1760.097995] ? show\_trace\_log\_lvl+0x1c4/0x2df
[ 1760.102377] ? \_\_io\_wq\_cpu\_online+0x54/0xb0
[ 1760.106584] ? \_\_die\_body.cold+0x8/0xd
[ 1760.110356] ? page\_fault\_oops+0x134/0x170
[ 1760.114479] ? kernelmode\_fixup\_or\_oops+0x84/0x110
[ 1760.119298] ? exc\_page\_fault+0xa8/0x150
[ 1760.123247] ? asm\_exc\_page\_fault+0x22/0x30
[ 1760.127458] ? \_\_pfx\_io\_wq\_worker\_affinity+0x10/0x10
[ 1760.132453] ? \_\_pfx\_io\_wq\_worker\_affinity+0x10/0x10
[ 1760.137446] ? io\_wq\_for\_each\_worker.isra.0+0x24/0xa0
[ 1760.142527] \_\_io\_wq\_cpu\_online+0x54/0xb0
[ 1760.146558] cpuhp\_invoke\_callback+0x109/0x460
[ 1760.151029] ? \_\_pfx\_io\_wq\_cpu\_offline+0x10/0x10
[ 1760.155673] ? \_\_pfx\_smpboot\_thread\_fn+0x10/0x10
[ 1760.160320] cpuhp\_thread\_fun+0x8d/0x140
[ 1760.164266] smpboot\_thread\_fn+0xd3/0x1a0
[ 1760.168297] kthread+0xdd/0x100
[ 1760.171457] ? \_\_pfx\_kthread+0x10/0x10
[ 1760.175225] ret\_from\_fork+0x29/0x50
[ 1760.178826]
[ 1760.181022] Modules linked in: rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfs lockd grace fscache netfs rfkill sunrpc vfat fat dm\_multipath intel\_rapl\_msr intel\_rapl\_common isst\_if\_common ipmi\_ssif nfit libnvdimm mgag200 i2c\_algo\_bit ioatdma drm\_shmem\_helper drm\_kms\_helper acpi\_ipmi syscopyarea x86\_pkg\_temp\_thermal sysfillrect ipmi\_si intel\_powerclamp sysimgblt ipmi\_devintf coretemp acpi\_power\_meter ipmi\_msghandler rapl pcspkr dca intel\_pch\_thermal intel\_cstate ses lpc\_ich intel\_uncore enclosure hpilo mei\_me mei acpi\_tad fuse drm xfs sd\_mod sg bnx2x nvme nvme\_core crct10dif\_pclmul crc32\_pclmul nvme\_common ghash\_clmulni\_intel smartpqi tg3 t10\_pi mdio uas libcrc32c crc32c\_intel scsi\_transport\_sas usb\_storage hpwdt wmi dm\_mirror dm\_region\_hash dm\_log dm\_mod
[ 1760.248623] CR2: ffffffffffffffe8
A cpu hotplug callback was issued before wq->all\_list was initialized.
This results in a null pointer dereference. The fix is to fully setup
the io\_wq before calling cpuhp\_state\_add\_instance\_nocalls().
Signed-off-by: Jeff Moyer
Link: https://lore.kernel.org/r/x49y1ghnecs.fsf@segfault.boston.devel.redhat.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit c63d66006bdcd21b9434ed83ea58bcdc8356beda
Author: Xuewen Yan
Date: Wed Jul 19 21:05:27 2023 +0800
cpufreq: schedutil: Update next\_freq when cpufreq\_limits change
[ Upstream commit 9e0bc36ab07c550d791bf17feeb479f1dfc42d89 ]
When cpufreq's policy is 'single', there is a scenario that will
cause sg\_policy's next\_freq to be unable to update.
When the CPU's util is always max, the cpufreq will be max,
and then if we change the policy's scaling\_max\_freq to be a
lower freq, indeed, the sg\_policy's next\_freq need change to
be the lower freq, however, because the cpu\_is\_busy, the next\_freq
would keep the max\_freq.
For example:
The cpu7 is a single CPU:
unisoc:/sys/devices/system/cpu/cpufreq/policy7 # while true;do done& [1] 4737
unisoc:/sys/devices/system/cpu/cpufreq/policy7 # taskset -p 80 4737
pid 4737's current affinity mask: ff
pid 4737's new affinity mask: 80
unisoc:/sys/devices/system/cpu/cpufreq/policy7 # cat scaling\_max\_freq
2301000
unisoc:/sys/devices/system/cpu/cpufreq/policy7 # cat scaling\_cur\_freq
2301000
unisoc:/sys/devices/system/cpu/cpufreq/policy7 # echo 2171000 > scaling\_max\_freq
unisoc:/sys/devices/system/cpu/cpufreq/policy7 # cat scaling\_max\_freq
2171000
At this time, the sg\_policy's next\_freq would stay at 2301000, which
is wrong.
To fix this, add a check for the ->need\_freq\_update flag.
[ mingo: Clarified the changelog. ]
Co-developed-by: Guohua Yan
Signed-off-by: Xuewen Yan
Signed-off-by: Guohua Yan
Signed-off-by: Ingo Molnar
Acked-by: "Rafael J. Wysocki"
Link: https://lore.kernel.org/r/20230719130527.8074-1-xuewen.yan@unisoc.com
Signed-off-by: Sasha Levin
commit 7bfc1d3e3d9374819c66158ad8fb90baac12cf26
Author: Renan Guilherme Lebre Ramos
Date: Wed Oct 4 19:59:00 2023 -0400
platform/x86: touchscreen\_dmi: Add info for the Positivo C4128B
[ Upstream commit aa7dcba3bae6869122828b144a3cfd231718089d ]
Add information for the Positivo C4128B, a notebook/tablet convertible.
Link: https://github.com/onitake/gsl-firmware/pull/217
Signed-off-by: Renan Guilherme Lebre Ramos
Link: https://lore.kernel.org/r/20231004235900.426240-1-japareaggae@gmail.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit ef807364984105dcd3823000d88b273f25d0cb3d
Author: Fabian Vogt
Date: Tue Oct 3 21:07:00 2023 +0200
HID: Add quirk to ignore the touchscreen battery on HP ENVY 15-eu0556ng
[ Upstream commit b009aa38a380becd98cc4e01c9b7626a11cb4905 ]
Like various other devices using similar hardware, this model reports a
perpetually empty battery (0-1%).
Join the others and apply HID\_BATTERY\_QUIRK\_IGNORE.
Signed-off-by: Fabian Vogt
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit 8db5b5641edbace14d5a9e34536509bb5cd6c960
Author: Martino Fontana
Date: Sun Sep 24 16:06:01 2023 +0200
HID: nintendo: reinitialize USB Pro Controller after resuming from suspend
[ Upstream commit 95ea4d9fd385fe335b989f22d409df079a042b7a ]
When suspending the computer, a Switch Pro Controller connected via USB will
lose its internal status. However, because the USB connection was technically
never lost, when resuming the computer, the driver will attempt to communicate
with the controller as if nothing happened (and fail).
Because of this, the user was forced to manually disconnect the controller
(or to press the sync button on the controller to power it off), so that it
can be re-initialized.
With this patch, the controller will be automatically re-initialized after
resuming from suspend.
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=216233
Signed-off-by: Martino Fontana
Reviewed-by: Daniel J. Ogorchock
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit 37640aaacb3f0cd3e1cf24faedcdf5d84881f659
Author: Rahul Rameshbabu
Date: Sun Sep 17 16:18:43 2023 +0000
HID: multitouch: Add required quirk for Synaptics 0xcd7e device
[ Upstream commit 1437e4547edf41689d7135faaca4222ef0081bc1 ]
Register the Synaptics device as a special multitouch device with certain
quirks that may improve usability of the touchpad device.
Reported-by: Rain
Closes: https://lore.kernel.org/linux-input/2bbb8e1d-1793-4df1-810f-cb0137341ff4@app.fastmail.com/
Signed-off-by: Rahul Rameshbabu
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit ae02f63718e646995cad47897118ceea9b60588b
Author: Kenneth Feng
Date: Fri Aug 11 12:25:26 2023 +0800
drm/amd/pm: add unique\_id for gc 11.0.3
[ Upstream commit 4953856f280b2b606089a72a93a1e9212a3adaca ]
add unique\_id for gc 11.0.3
Signed-off-by: Kenneth Feng
Reviewed-by: Feifei Xu
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit ac0893f7a48a282268252b0a62d3123f8390d88c
Author: Tomasz Swiatek
Date: Fri Sep 22 18:46:32 2023 +0200
platform/x86: touchscreen\_dmi: Add info for the BUSH Bush Windows tablet
[ Upstream commit 34c271e778c1d8589ee9c833eee5ecb6fbb03149 ]
Add touchscreen info for the BUSH Bush Windows tablet.
It was tested using gslx680\_ts\_acpi module and on patched kernel
installed on device.
Link: https://github.com/onitake/gsl-firmware/pull/215
Link: https://github.com/systemd/systemd/pull/29268
Signed-off-by: Tomasz Swiatek
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 3149ea595239eb187823a9d2b9df0bce4daf9bf9
Author: Filipe Manana
Date: Wed Sep 27 12:09:23 2023 +0100
btrfs: error out when reallocating block for defrag using a stale transaction
[ Upstream commit e36f94914021e58ee88a8856c7fdf35adf9c7ee1 ]
At btrfs\_realloc\_node() we have these checks to verify we are not using a
stale transaction (a past transaction with an unblocked state or higher),
and the only thing we do is to trigger two WARN\_ON(). This however is a
critical problem, highly unexpected and if it happens it's most likely due
to a bug, so we should error out and turn the fs into error state so that
such issue is much more easily noticed if it's triggered.
The problem is critical because in btrfs\_realloc\_node() we COW tree blocks,
and using such stale transaction will lead to not persisting the extent
buffers used for the COW operations, as allocating tree block adds the
range of the respective extent buffers to the ->dirty\_pages iotree of the
transaction, and a stale transaction, in the unlocked state or higher,
will not flush dirty extent buffers anymore, therefore resulting in not
persisting the tree block and resource leaks (not cleaning the dirty\_pages
iotree for example).
So do the following changes:
1) Return -EUCLEAN if we find a stale transaction;
2) Turn the fs into error state, with error -EUCLEAN, so that no
transaction can be committed, and generate a stack trace;
3) Combine both conditions into a single if statement, as both are related
and have the same error message;
4) Mark the check as unlikely, since this is not expected to ever happen.
Signed-off-by: Filipe Manana
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
commit 71e385e8e04217cf5bbe5066380faf861301b6cf
Author: Filipe Manana
Date: Wed Sep 27 12:09:22 2023 +0100
btrfs: error when COWing block from a root that is being deleted
[ Upstream commit a2caab29884397e583d09be6546259a83ebfbdb1 ]
At btrfs\_cow\_block() we check if the block being COWed belongs to a root
that is being deleted and if so we log an error message. However this is
an unexpected case and it indicates a bug somewhere, so we should return
an error and abort the transaction. So change this in the following ways:
1) Abort the transaction with -EUCLEAN, so that if the issue ever happens
it can easily be noticed;
2) Change the logged message level from error to critical, and change the
message itself to print the block's logical address and the ID of the
root;
3) Return -EUCLEAN to the caller;
4) As this is an unexpected scenario, that should never happen, mark the
check as unlikely, allowing the compiler to potentially generate better
code.
Signed-off-by: Filipe Manana
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
commit 55a0567f6461afadef27a345aa3bc6276f57ba72
Author: Filipe Manana
Date: Wed Sep 27 12:09:21 2023 +0100
btrfs: error out when COWing block using a stale transaction
[ Upstream commit 48774f3bf8b4dd3b1a0e155825c9ce48483db14c ]
At btrfs\_cow\_block() we have these checks to verify we are not using a
stale transaction (a past transaction with an unblocked state or higher),
and the only thing we do is to trigger a WARN with a message and a stack
trace. This however is a critical problem, highly unexpected and if it
happens it's most likely due to a bug, so we should error out and turn the
fs into error state so that such issue is much more easily noticed if it's
triggered.
The problem is critical because using such stale transaction will lead to
not persisting the extent buffer used for the COW operation, as allocating
a tree block adds the range of the respective extent buffer to the
->dirty\_pages iotree of the transaction, and a stale transaction, in the
unlocked state or higher, will not flush dirty extent buffers anymore,
therefore resulting in not persisting the tree block and resource leaks
(not cleaning the dirty\_pages iotree for example).
So do the following changes:
1) Return -EUCLEAN if we find a stale transaction;
2) Turn the fs into error state, with error -EUCLEAN, so that no
transaction can be committed, and generate a stack trace;
3) Combine both conditions into a single if statement, as both are related
and have the same error message;
4) Mark the check as unlikely, since this is not expected to ever happen.
Signed-off-by: Filipe Manana
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
commit 1472a1d9c2947eb9f02a03747274aadf99cf80aa
Author: Josef Bacik
Date: Tue Sep 26 15:47:27 2023 -0400
btrfs: fix some -Wmaybe-uninitialized warnings in ioctl.c
[ Upstream commit 9147b9ded499d9853bdf0e9804b7eaa99c4429ed ]
Jens reported the following warnings from -Wmaybe-uninitialized recent
Linus' branch.
In file included from ./include/asm-generic/rwonce.h:26,
from ./arch/arm64/include/asm/rwonce.h:71,
from ./include/linux/compiler.h:246,
from ./include/linux/export.h:5,
from ./include/linux/linkage.h:7,
from ./include/linux/kernel.h:17,
from fs/btrfs/ioctl.c:6:
In function ‘instrument\_copy\_from\_user\_before’,
inlined from ‘\_copy\_from\_user’ at ./include/linux/uaccess.h:148:3,
inlined from ‘copy\_from\_user’ at ./include/linux/uaccess.h:183:7,
inlined from ‘btrfs\_ioctl\_space\_info’ at fs/btrfs/ioctl.c:2999:6,
inlined from ‘btrfs\_ioctl’ at fs/btrfs/ioctl.c:4616:10:
./include/linux/kasan-checks.h:38:27: warning: ‘space\_args’ may be used
uninitialized [-Wmaybe-uninitialized]
38 | #define kasan\_check\_write \_\_kasan\_check\_write
./include/linux/instrumented.h:129:9: note: in expansion of macro
‘kasan\_check\_write’
129 | kasan\_check\_write(to, n);
| ^~~~~~~~~~~~~~~~~
./include/linux/kasan-checks.h: In function ‘btrfs\_ioctl’:
./include/linux/kasan-checks.h:20:6: note: by argument 1 of type ‘const
volatile void \*’ to ‘\_\_kasan\_check\_write’ declared here
20 | bool \_\_kasan\_check\_write(const volatile void \*p, unsigned int
size);
| ^~~~~~~~~~~~~~~~~~~
fs/btrfs/ioctl.c:2981:39: note: ‘space\_args’ declared here
2981 | struct btrfs\_ioctl\_space\_args space\_args;
| ^~~~~~~~~~
In function ‘instrument\_copy\_from\_user\_before’,
inlined from ‘\_copy\_from\_user’ at ./include/linux/uaccess.h:148:3,
inlined from ‘copy\_from\_user’ at ./include/linux/uaccess.h:183:7,
inlined from ‘\_btrfs\_ioctl\_send’ at fs/btrfs/ioctl.c:4343:9,
inlined from ‘btrfs\_ioctl’ at fs/btrfs/ioctl.c:4658:10:
./include/linux/kasan-checks.h:38:27: warning: ‘args32’ may be used
uninitialized [-Wmaybe-uninitialized]
38 | #define kasan\_check\_write \_\_kasan\_check\_write
./include/linux/instrumented.h:129:9: note: in expansion of macro
‘kasan\_check\_write’
129 | kasan\_check\_write(to, n);
| ^~~~~~~~~~~~~~~~~
./include/linux/kasan-checks.h: In function ‘btrfs\_ioctl’:
./include/linux/kasan-checks.h:20:6: note: by argument 1 of type ‘const
volatile void \*’ to ‘\_\_kasan\_check\_write’ declared here
20 | bool \_\_kasan\_check\_write(const volatile void \*p, unsigned int
size);
| ^~~~~~~~~~~~~~~~~~~
fs/btrfs/ioctl.c:4341:49: note: ‘args32’ declared here
4341 | struct btrfs\_ioctl\_send\_args\_32 args32;
| ^~~~~~
This was due to his config options and having KASAN turned on,
which adds some extra checks around copy\_from\_user(), which then
triggered the -Wmaybe-uninitialized checker for these cases.
Fix the warnings by initializing the different structs we're copying
into.
Reported-by: Jens Axboe
Signed-off-by: Josef Bacik
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
commit 9c91266a003b2f3c8a6b08b04bfcf157b2158a39
Author: Kai Uwe Broulik
Date: Sun Oct 1 13:47:10 2023 +0200
drm: panel-orientation-quirks: Add quirk for One Mix 2S
[ Upstream commit cbb7eb2dbd9472816e42a1b0fdb51af49abbf812 ]
The One Mix 2S is a mini laptop with a 1200x1920 portrait screen
mounted in a landscape oriented clamshell case. Because of the too
generic DMI strings this entry is also doing bios-date matching.
Signed-off-by: Kai Uwe Broulik
Reviewed-by: Hans de Goede
Signed-off-by: Liviu Dudau
Link: https://patchwork.freedesktop.org/patch/msgid/20231001114710.336172-1-foss-linux@broulik.de
Signed-off-by: Sasha Levin
commit 0fd1a377b08ec12a992b52581a1263dd963038b8
Author: Hangbin Liu
Date: Fri Sep 22 15:55:08 2023 +0800
ipv4/fib: send notify when delete source address routes
[ Upstream commit 4b2b606075e50cdae62ab2356b0a1e206947c354 ]
After deleting an interface address in fib\_del\_ifaddr(), the function
scans the fib\_info list for stray entries and calls fib\_flush() and
fib\_table\_flush(). Then the stray entries will be deleted silently and no
RTM\_DELROUTE notification will be sent.
This lack of notification can make routing daemons, or monitor like
`ip monitor route` miss the routing changes. e.g.
+ ip link add dummy1 type dummy
+ ip link add dummy2 type dummy
+ ip link set dummy1 up
+ ip link set dummy2 up
+ ip addr add 192.168.5.5/24 dev dummy1
+ ip route add 7.7.7.0/24 dev dummy2 src 192.168.5.5
+ ip -4 route
7.7.7.0/24 dev dummy2 scope link src 192.168.5.5
192.168.5.0/24 dev dummy1 proto kernel scope link src 192.168.5.5
+ ip monitor route
+ ip addr del 192.168.5.5/24 dev dummy1
Deleted 192.168.5.0/24 dev dummy1 proto kernel scope link src 192.168.5.5
Deleted broadcast 192.168.5.255 dev dummy1 table local proto kernel scope link src 192.168.5.5
Deleted local 192.168.5.5 dev dummy1 table local proto kernel scope host src 192.168.5.5
As Ido reminded, fib\_table\_flush() isn't only called when an address is
deleted, but also when an interface is deleted or put down. The lack of
notification in these cases is deliberate. And commit 7c6bb7d2faaf
("net/ipv6: Add knob to skip DELROUTE message on device down") introduced
a sysctl to make IPv6 behave like IPv4 in this regard. So we can't send
the route delete notify blindly in fib\_table\_flush().
To fix this issue, let's add a new flag in "struct fib\_info" to track the
deleted prefer source address routes, and only send notify for them.
After update:
+ ip monitor route
+ ip addr del 192.168.5.5/24 dev dummy1
Deleted 192.168.5.0/24 dev dummy1 proto kernel scope link src 192.168.5.5
Deleted broadcast 192.168.5.255 dev dummy1 table local proto kernel scope link src 192.168.5.5
Deleted local 192.168.5.5 dev dummy1 table local proto kernel scope host src 192.168.5.5
Deleted 7.7.7.0/24 dev dummy2 scope link src 192.168.5.5
Suggested-by: Thomas Haller
Signed-off-by: Hangbin Liu
Acked-by: Nicolas Dichtel
Reviewed-by: David Ahern
Link: https://lore.kernel.org/r/20230922075508.848925-1-liuhangbin@gmail.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 7a0ed30fbb66c2c8eb0b3024eae88c5e24da206a
Author: Kees Cook
Date: Fri Sep 22 09:50:39 2023 -0700
sky2: Make sure there is at least one frag\_addr available
[ Upstream commit 6a70e5cbedaf8ad10528ac9ac114f3ec20f422df ]
In the pathological case of building sky2 with 16k PAGE\_SIZE, the
frag\_addr[] array would never be used, so the original code was correct
that size should be 0. But the compiler now gets upset with 0 size arrays
in places where it hasn't eliminated the code that might access such an
array (it can't figure out that in this case an rx skb with fragments
would never be created). To keep the compiler happy, make sure there is
at least 1 frag\_addr in struct rx\_ring\_info:
In file included from include/linux/skbuff.h:28,
from include/net/net\_namespace.h:43,
from include/linux/netdevice.h:38,
from drivers/net/ethernet/marvell/sky2.c:18:
drivers/net/ethernet/marvell/sky2.c: In function 'sky2\_rx\_unmap\_skb':
include/linux/dma-mapping.h:416:36: warning: array subscript i is outside array bounds of 'dma\_addr\_t[0]' {aka 'long long unsigned int[]'} [-Warray-bounds=]
416 | #define dma\_unmap\_page(d, a, s, r) dma\_unmap\_page\_attrs(d, a, s, r, 0)
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
drivers/net/ethernet/marvell/sky2.c:1257:17: note: in expansion of macro 'dma\_unmap\_page'
1257 | dma\_unmap\_page(&pdev->dev, re->frag\_addr[i],
| ^~~~~~~~~~~~~~
In file included from drivers/net/ethernet/marvell/sky2.c:41:
drivers/net/ethernet/marvell/sky2.h:2198:25: note: while referencing 'frag\_addr'
2198 | dma\_addr\_t frag\_addr[ETH\_JUMBO\_MTU >> PAGE\_SHIFT];
| ^~~~~~~~~
With CONFIG\_PAGE\_SIZE\_16KB=y, PAGE\_SHIFT == 14, so:
#define ETH\_JUMBO\_MTU 9000
causes "ETH\_JUMBO\_MTU >> PAGE\_SHIFT" to be 0. Use "?: 1" to solve this build warning.
Cc: Mirko Lindner
Cc: Stephen Hemminger
Cc: "David S. Miller"
Cc: Eric Dumazet
Cc: Jakub Kicinski
Cc: Paolo Abeni
Cc: netdev@vger.kernel.org
Reported-by: kernel test robot
Closes: https://lore.kernel.org/oe-kbuild-all/202309191958.UBw1cjXk-lkp@intel.com/
Reviewed-by: Alexander Lobakin
Signed-off-by: Kees Cook
Reviewed-by: Gustavo A. R. Silva
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c2d0245661f6f3f03e61399dc62bc946751e891f
Author: Jeff Layton
Date: Tue Sep 19 09:17:28 2023 -0400
nfs: decrement nrequests counter before releasing the req
[ Upstream commit dd1b2026323a2d075ac553cecfd7a0c23c456c59 ]
I hit this panic in testing:
[ 6235.500016] run fstests generic/464 at 2023-09-18 22:51:24
[ 6288.410761] BUG: kernel NULL pointer dereference, address: 0000000000000000
[ 6288.412174] #PF: supervisor read access in kernel mode
[ 6288.413160] #PF: error\_code(0x0000) - not-present page
[ 6288.413992] PGD 0 P4D 0
[ 6288.414603] Oops: 0000 [#1] PREEMPT SMP PTI
[ 6288.415419] CPU: 0 PID: 340798 Comm: kworker/u18:8 Not tainted 6.6.0-rc1-gdcf620ceebac #95
[ 6288.416538] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-1.fc38 04/01/2014
[ 6288.417701] Workqueue: nfsiod rpc\_async\_release [sunrpc]
[ 6288.418676] RIP: 0010:nfs\_inode\_remove\_request+0xc8/0x150 [nfs]
[ 6288.419836] Code: ff ff 48 8b 43 38 48 8b 7b 10 a8 04 74 5b 48 85 ff 74 56 48 8b 07 a9 00 00 08 00 74 58 48 8b 07 f6 c4 10 74 50 e8 c8 44 b3 d5 <48> 8b 00 f0 48 ff 88 30 ff ff ff 5b 5d 41 5c c3 cc cc cc cc 48 8b
[ 6288.422389] RSP: 0018:ffffbd618353bda8 EFLAGS: 00010246
[ 6288.423234] RAX: 0000000000000000 RBX: ffff9a29f9a25280 RCX: 0000000000000000
[ 6288.424351] RDX: ffff9a29f9a252b4 RSI: 000000000000000b RDI: ffffef41448e3840
[ 6288.425345] RBP: ffffef41448e3840 R08: 0000000000000038 R09: ffffffffffffffff
[ 6288.426334] R10: 0000000000033f80 R11: ffff9a2a7fffa000 R12: ffff9a29093f98c4
[ 6288.427353] R13: 0000000000000000 R14: ffff9a29230f62e0 R15: ffff9a29230f62d0
[ 6288.428358] FS: 0000000000000000(0000) GS:ffff9a2a77c00000(0000) knlGS:0000000000000000
[ 6288.429513] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 6288.430427] CR2: 0000000000000000 CR3: 0000000264748002 CR4: 0000000000770ef0
[ 6288.431553] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 6288.432715] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 6288.433698] PKRU: 55555554
[ 6288.434196] Call Trace:
[ 6288.434667]
[ 6288.435132] ? \_\_die+0x1f/0x70
[ 6288.435723] ? page\_fault\_oops+0x159/0x450
[ 6288.436389] ? try\_to\_wake\_up+0x98/0x5d0
[ 6288.437044] ? do\_user\_addr\_fault+0x65/0x660
[ 6288.437728] ? exc\_page\_fault+0x7a/0x180
[ 6288.438368] ? asm\_exc\_page\_fault+0x22/0x30
[ 6288.439137] ? nfs\_inode\_remove\_request+0xc8/0x150 [nfs]
[ 6288.440112] ? nfs\_inode\_remove\_request+0xa0/0x150 [nfs]
[ 6288.440924] nfs\_commit\_release\_pages+0x16e/0x340 [nfs]
[ 6288.441700] ? \_\_pfx\_call\_transmit+0x10/0x10 [sunrpc]
[ 6288.442475] ? \_raw\_spin\_lock\_irqsave+0x23/0x50
[ 6288.443161] nfs\_commit\_release+0x15/0x40 [nfs]
[ 6288.443926] rpc\_free\_task+0x36/0x60 [sunrpc]
[ 6288.444741] rpc\_async\_release+0x29/0x40 [sunrpc]
[ 6288.445509] process\_one\_work+0x171/0x340
[ 6288.446135] worker\_thread+0x277/0x3a0
[ 6288.446724] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 6288.447376] kthread+0xf0/0x120
[ 6288.447903] ? \_\_pfx\_kthread+0x10/0x10
[ 6288.448500] ret\_from\_fork+0x2d/0x50
[ 6288.449078] ? \_\_pfx\_kthread+0x10/0x10
[ 6288.449665] ret\_from\_fork\_asm+0x1b/0x30
[ 6288.450283]
[ 6288.450688] Modules linked in: rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfs lockd grace sunrpc nls\_iso8859\_1 nls\_cp437 vfat fat 9p netfs ext4 kvm\_intel crc16 mbcache jbd2 joydev kvm xfs irqbypass virtio\_net pcspkr net\_failover psmouse failover 9pnet\_virtio cirrus drm\_shmem\_helper virtio\_balloon drm\_kms\_helper button evdev drm loop dm\_mod zram zsmalloc crct10dif\_pclmul crc32\_pclmul ghash\_clmulni\_intel sha512\_ssse3 sha512\_generic virtio\_blk nvme aesni\_intel crypto\_simd cryptd nvme\_core t10\_pi i6300esb crc64\_rocksoft\_generic crc64\_rocksoft crc64 virtio\_pci virtio virtio\_pci\_legacy\_dev virtio\_pci\_modern\_dev virtio\_ring serio\_raw btrfs blake2b\_generic libcrc32c crc32c\_generic crc32c\_intel xor raid6\_pq autofs4
[ 6288.460211] CR2: 0000000000000000
[ 6288.460787] ---[ end trace 0000000000000000 ]---
[ 6288.461571] RIP: 0010:nfs\_inode\_remove\_request+0xc8/0x150 [nfs]
[ 6288.462500] Code: ff ff 48 8b 43 38 48 8b 7b 10 a8 04 74 5b 48 85 ff 74 56 48 8b 07 a9 00 00 08 00 74 58 48 8b 07 f6 c4 10 74 50 e8 c8 44 b3 d5 <48> 8b 00 f0 48 ff 88 30 ff ff ff 5b 5d 41 5c c3 cc cc cc cc 48 8b
[ 6288.465136] RSP: 0018:ffffbd618353bda8 EFLAGS: 00010246
[ 6288.465963] RAX: 0000000000000000 RBX: ffff9a29f9a25280 RCX: 0000000000000000
[ 6288.467035] RDX: ffff9a29f9a252b4 RSI: 000000000000000b RDI: ffffef41448e3840
[ 6288.468093] RBP: ffffef41448e3840 R08: 0000000000000038 R09: ffffffffffffffff
[ 6288.469121] R10: 0000000000033f80 R11: ffff9a2a7fffa000 R12: ffff9a29093f98c4
[ 6288.470109] R13: 0000000000000000 R14: ffff9a29230f62e0 R15: ffff9a29230f62d0
[ 6288.471106] FS: 0000000000000000(0000) GS:ffff9a2a77c00000(0000) knlGS:0000000000000000
[ 6288.472216] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 6288.473059] CR2: 0000000000000000 CR3: 0000000264748002 CR4: 0000000000770ef0
[ 6288.474096] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 6288.475097] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 6288.476148] PKRU: 55555554
[ 6288.476665] note: kworker/u18:8[340798] exited with irqs disabled
Once we've released "req", it's not safe to dereference it anymore.
Decrement the nrequests counter before dropping the reference.
Signed-off-by: Jeff Layton
Reviewed-by: Benjamin Coddington
Tested-by: Benjamin Coddington
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit a6e63b4820847016011ee71be0689505746330d7
Author: Anna Schumaker
Date: Tue Sep 26 17:03:22 2023 -0400
SUNRPC/TLS: Lock the lower\_xprt during the tls handshake
[ Upstream commit 26e8bfa30dac2ccd29dd25f391dfc73475c33329 ]
Otherwise we run the risk of having the lower\_xprt freed from underneath
us, causing an oops that looks like this:
[ 224.150698] BUG: kernel NULL pointer dereference, address: 0000000000000018
[ 224.150951] #PF: supervisor read access in kernel mode
[ 224.151117] #PF: error\_code(0x0000) - not-present page
[ 224.151278] PGD 0 P4D 0
[ 224.151361] Oops: 0000 [#1] PREEMPT SMP NOPTI
[ 224.151499] CPU: 2 PID: 99 Comm: kworker/u10:6 Not tainted 6.6.0-rc3-g6465e260f487 #41264 a00b0960990fb7bc6d6a330ee03588b67f08a47b
[ 224.151977] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS unknown 2/2/2022
[ 224.152216] Workqueue: xprtiod xs\_tcp\_tls\_setup\_socket [sunrpc]
[ 224.152434] RIP: 0010:xs\_tcp\_tls\_setup\_socket+0x3cc/0x7e0 [sunrpc]
[ 224.152643] Code: 00 00 48 8b 7c 24 08 e9 f3 01 00 00 48 83 7b c0 00 0f 85 d2 01 00 00 49 8d 84 24 f8 05 00 00 48 89 44 24 10 48 8b 00 48 89 c5 <4c> 8b 68 18 66 41 83 3f 0a 75 71 45 31 ff 4c 89 ef 31 f6 e8 5c 76
[ 224.153246] RSP: 0018:ffffb00ec060fd18 EFLAGS: 00010246
[ 224.153427] RAX: 0000000000000000 RBX: ffff8c06c2e53e40 RCX: 0000000000000001
[ 224.153652] RDX: ffff8c073bca2408 RSI: 0000000000000282 RDI: ffff8c06c259ee00
[ 224.153868] RBP: 0000000000000000 R08: ffffffff9da55aa0 R09: 0000000000000001
[ 224.154084] R10: 00000034306c30f1 R11: 0000000000000002 R12: ffff8c06c2e51800
[ 224.154300] R13: ffff8c06c355d400 R14: 0000000004208160 R15: ffff8c06c2e53820
[ 224.154521] FS: 0000000000000000(0000) GS:ffff8c073bd00000(0000) knlGS:0000000000000000
[ 224.154763] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 224.154940] CR2: 0000000000000018 CR3: 0000000062c1e000 CR4: 0000000000750ee0
[ 224.155157] PKRU: 55555554
[ 224.155244] Call Trace:
[ 224.155325]
[ 224.155395] ? \_\_die\_body+0x68/0xb0
[ 224.155507] ? page\_fault\_oops+0x34c/0x3a0
[ 224.155635] ? \_raw\_spin\_unlock\_irqrestore+0xe/0x40
[ 224.155793] ? exc\_page\_fault+0x7a/0x1b0
[ 224.155916] ? asm\_exc\_page\_fault+0x26/0x30
[ 224.156047] ? xs\_tcp\_tls\_setup\_socket+0x3cc/0x7e0 [sunrpc ae3a15912ae37fd51dafbdbc2dbd069117f8f5c8]
[ 224.156367] ? xs\_tcp\_tls\_setup\_socket+0x2fe/0x7e0 [sunrpc ae3a15912ae37fd51dafbdbc2dbd069117f8f5c8]
[ 224.156697] ? \_\_pfx\_xs\_tls\_handshake\_done+0x10/0x10 [sunrpc ae3a15912ae37fd51dafbdbc2dbd069117f8f5c8]
[ 224.157013] process\_scheduled\_works+0x24e/0x450
[ 224.157158] worker\_thread+0x21c/0x2d0
[ 224.157275] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 224.157409] kthread+0xe8/0x110
[ 224.157510] ? \_\_pfx\_kthread+0x10/0x10
[ 224.157628] ret\_from\_fork+0x37/0x50
[ 224.157741] ? \_\_pfx\_kthread+0x10/0x10
[ 224.157859] ret\_from\_fork\_asm+0x1b/0x30
[ 224.157983]
Reviewed-by: Chuck Lever
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit e039d9b24920dccebc71308b1c3550e4f02dc3e1
Author: Chuck Lever
Date: Wed Sep 6 16:05:26 2023 -0400
SUNRPC: Fail quickly when server does not recognize TLS
[ Upstream commit 5623ecfcbec165f040a23248d39680f0cc5c0854 ]
rpcauth\_checkverf() should return a distinct error code when a
server recognizes the AUTH\_TLS probe but does not support TLS so
that the client's header decoder can respond appropriately and
quickly. No retries are necessary is in this case, since the server
has already affirmatively answered "TLS is unsupported".
Suggested-by: Trond Myklebust
Signed-off-by: Chuck Lever
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 20eb79ccdaa319bad8cf4efc3e5c187630c7ff7b
Author: Michał Mirosław
Date: Tue Sep 19 00:50:27 2023 +0200
regulator/core: Revert "fix kobject release warning and memory leak in regulator\_register()"
[ Upstream commit 6e800968f6a715c0661716d2ec5e1f56ed9f9c08 ]
This reverts commit 5f4b204b6b8153923d5be8002c5f7082985d153f.
Since rdev->dev now has a release() callback, the proper way of freeing
the initialized device can be restored.
Signed-off-by: Michał Mirosław
Link: https://lore.kernel.org/r/d7f469f3f7b1f0e1d52f9a7ede3f3c5703382090.1695077303.git.mirq-linux@rere.qmqm.pl
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 42dc95950d7d6eb94dd3e2d755b806b3cd181786
Author: Benjamin Berg
Date: Mon Sep 25 17:18:56 2023 +0200
wifi: cfg80211: avoid leaking stack data into trace
[ Upstream commit 334bf33eec5701a1e4e967bcb7cc8611a998334b ]
If the structure is not initialized then boolean types might be copied
into the tracing data without being initialised. This causes data from
the stack to leak into the trace and also triggers a UBSAN failure which
can easily be avoided here.
Signed-off-by: Benjamin Berg
Link: https://lore.kernel.org/r/20230925171855.a9271ef53b05.I8180bae663984c91a3e036b87f36a640ba409817@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 4d5ea9a1b21d9eb64dfbeda4dccdd886d9948c05
Author: Wen Gong
Date: Tue Aug 1 02:47:51 2023 -0400
wifi: mac80211: allow transmitting EAPOL frames with tainted key
[ Upstream commit 61304336c67358d49a989e5e0060d8c99bad6ca8 ]
Lower layer device driver stop/wake TX by calling ieee80211\_stop\_queue()/
ieee80211\_wake\_queue() while hw scan. Sometimes hw scan and PTK rekey are
running in parallel, when M4 sent from wpa\_supplicant arrive while the TX
queue is stopped, then the M4 will pending send, and then new key install
from wpa\_supplicant. After TX queue wake up by lower layer device driver,
the M4 will be dropped by below call stack.
When key install started, the current key flag is set KEY\_FLAG\_TAINTED in
ieee80211\_pairwise\_rekey(), and then mac80211 wait key install complete by
lower layer device driver. Meanwhile ieee80211\_tx\_h\_select\_key() will return
TX\_DROP for the M4 in step 12 below, and then ieee80211\_free\_txskb() called
by ieee80211\_tx\_dequeue(), so the M4 will not send and free, then the rekey
process failed becaue AP not receive M4. Please see details in steps below.
There are a interval between KEY\_FLAG\_TAINTED set for current key flag and
install key complete by lower layer device driver, the KEY\_FLAG\_TAINTED is
set in this interval, all packet including M4 will be dropped in this
interval, the interval is step 8~13 as below.
issue steps:
TX thread install key thread
1. stop\_queue -idle-
2. sending M4 -idle-
3. M4 pending -idle-
4. -idle- starting install key from wpa\_supplicant
5. -idle- =>ieee80211\_key\_replace()
6. -idle- =>ieee80211\_pairwise\_rekey() and set
currently key->flags |= KEY\_FLAG\_TAINTED
7. -idle- =>ieee80211\_key\_enable\_hw\_accel()
8. -idle- =>drv\_set\_key() and waiting key install
complete from lower layer device driver
9. wake\_queue -waiting state-
10. re-sending M4 -waiting state-
11. =>ieee80211\_tx\_h\_select\_key() -waiting state-
12. drop M4 by KEY\_FLAG\_TAINTED -waiting state-
13. -idle- install key complete with success/fail
success: clear flag KEY\_FLAG\_TAINTED
fail: start disconnect
Hence add check in step 11 above to allow the EAPOL send out in the
interval. If lower layer device driver use the old key/cipher to encrypt
the M4, then AP received/decrypt M4 correctly, after M4 send out, lower
layer device driver install the new key/cipher to hardware and return
success.
If lower layer device driver use new key/cipher to send the M4, then AP
will/should drop the M4, then it is same result with this issue, AP will/
should kick out station as well as this issue.
issue log:
kworker/u16:4-5238 [000] 6456.108926: stop\_queue: phy1 queue:0, reason:0
wpa\_supplicant-961 [003] 6456.119737: rdev\_tx\_control\_port: wiphy\_name=phy1 name=wlan0 ifindex=6 dest=ARRAY[9e, 05, 31, 20, 9b, d0] proto=36488 unencrypted=0
wpa\_supplicant-961 [003] 6456.119839: rdev\_return\_int\_cookie: phy1, returned 0, cookie: 504
wpa\_supplicant-961 [003] 6456.120287: rdev\_add\_key: phy1, netdev:wlan0(6), key\_index: 0, mode: 0, pairwise: true, mac addr: 9e:05:31:20:9b:d0
wpa\_supplicant-961 [003] 6456.120453: drv\_set\_key: phy1 vif:wlan0(2) sta:9e:05:31:20:9b:d0 cipher:0xfac04, flags=0x9, keyidx=0, hw\_key\_idx=0
kworker/u16:9-3829 [001] 6456.168240: wake\_queue: phy1 queue:0, reason:0
kworker/u16:9-3829 [001] 6456.168255: drv\_wake\_tx\_queue: phy1 vif:wlan0(2) sta:9e:05:31:20:9b:d0 ac:0 tid:7
kworker/u16:9-3829 [001] 6456.168305: cfg80211\_control\_port\_tx\_status: wdev(1), cookie: 504, ack: false
wpa\_supplicant-961 [003] 6459.167982: drv\_return\_int: phy1 - -110
issue call stack:
nl80211\_frame\_tx\_status+0x230/0x340 [cfg80211]
cfg80211\_control\_port\_tx\_status+0x1c/0x28 [cfg80211]
ieee80211\_report\_used\_skb+0x374/0x3e8 [mac80211]
ieee80211\_free\_txskb+0x24/0x40 [mac80211]
ieee80211\_tx\_dequeue+0x644/0x954 [mac80211]
ath10k\_mac\_tx\_push\_txq+0xac/0x238 [ath10k\_core]
ath10k\_mac\_op\_wake\_tx\_queue+0xac/0xe0 [ath10k\_core]
drv\_wake\_tx\_queue+0x80/0x168 [mac80211]
\_\_ieee80211\_wake\_txqs+0xe8/0x1c8 [mac80211]
\_ieee80211\_wake\_txqs+0xb4/0x120 [mac80211]
ieee80211\_wake\_txqs+0x48/0x80 [mac80211]
tasklet\_action\_common+0xa8/0x254
tasklet\_action+0x2c/0x38
\_\_do\_softirq+0xdc/0x384
Signed-off-by: Wen Gong
Link: https://lore.kernel.org/r/20230801064751.25803-1-quic\_wgong@quicinc.com
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 96b83be278ee9aef1ca686b8ae470f5c3a34cba2
Author: Johannes Berg
Date: Mon Sep 18 14:10:55 2023 +0300
wifi: mac80211: work around Cisco AP 9115 VHT MPDU length
[ Upstream commit 084cf2aeca97566db4fa15d55653c1cba2db83ed ]
Cisco AP module 9115 with FW 17.3 has a bug and sends a too
large maximum MPDU length in the association response
(indicating 12k) that it cannot actually process.
Work around that by taking the minimum between what's in the
association response and the BSS elements (from beacon or
probe response).
Signed-off-by: Johannes Berg
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230918140607.d1966a9a532e.I090225babb7cd4d1081ee9acd40e7de7e41c15ae@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 670894d8905ac4c3353be46cd46c9d4a29a00d82
Author: Ilan Peer
Date: Mon Sep 18 14:10:54 2023 +0300
wifi: cfg80211: Fix 6GHz scan configuration
[ Upstream commit 0914468adf92296c4cba8a2134e06e3dea150f2e ]
When the scan request includes a non broadcast BSSID, when adding the
scan parameters for 6GHz collocated scanning, do not include entries
that do not match the given BSSID.
Signed-off-by: Ilan Peer
Signed-off-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230918140607.6d31d2a96baf.I6c4e3e3075d1d1878ee41f45190fdc6b86f18708@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 5558f4312dca43cebfb9a1aab3d632be91bbb736
Author: Luiz Augusto von Dentz
Date: Fri Sep 15 14:42:27 2023 -0700
Bluetooth: hci\_core: Fix build warnings
[ Upstream commit dcda165706b9fbfd685898d46a6749d7d397e0c0 ]
This fixes the following warnings:
net/bluetooth/hci\_core.c: In function ‘hci\_register\_dev’:
net/bluetooth/hci\_core.c:2620:54: warning: ‘%d’ directive output may
be truncated writing between 1 and 10 bytes into a region of size 5
[-Wformat-truncation=]
2620 | snprintf(hdev->name, sizeof(hdev->name), "hci%d", id);
| ^~
net/bluetooth/hci\_core.c:2620:50: note: directive argument in the range
[0, 2147483647]
2620 | snprintf(hdev->name, sizeof(hdev->name), "hci%d", id);
| ^~~~~~~
net/bluetooth/hci\_core.c:2620:9: note: ‘snprintf’ output between 5 and
14 bytes into a destination of size 8
2620 | snprintf(hdev->name, sizeof(hdev->name), "hci%d", id);
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit c4ac1d80eaa6de82636adfa0c7a87f59694bac86
Author: Ying Hsu
Date: Thu Sep 7 04:39:34 2023 +0000
Bluetooth: Avoid redundant authentication
[ Upstream commit 1d8e801422d66e4b8c7b187c52196bef94eed887 ]
While executing the Android 13 CTS Verifier Secure Server test on a
ChromeOS device, it was observed that the Bluetooth host initiates
authentication for an RFCOMM connection after SSP completes.
When this happens, some Intel Bluetooth controllers, like AC9560, would
disconnect with "Connection Rejected due to Security Reasons (0x0e)".
Historically, BlueZ did not mandate this authentication while an
authenticated combination key was already in use for the connection.
This behavior was changed since commit 7b5a9241b780
("Bluetooth: Introduce requirements for security level 4").
So, this patch addresses the aforementioned disconnection issue by
restoring the previous behavior.
Signed-off-by: Ying Hsu
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit 6dd41ebf7c9ebe7de57facfa5938d0cb9092a2bb
Author: Rocky Liao
Date: Mon Aug 7 14:46:26 2023 +0800
Bluetooth: btusb: add shutdown function for QCA6174
[ Upstream commit 187f8b648cc16f07c66ab1d89d961bdcff779bf7 ]
We should send hci reset command before bt turn off, which can reset bt
firmware status.
Signed-off-by: Rocky Liao
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Sasha Levin
commit b095011d0dad7bb133b2b0b8966f7a0f8a95782c
Author: Ma Ke
Date: Mon Sep 18 10:40:59 2023 +0800
HID: holtek: fix slab-out-of-bounds Write in holtek\_kbd\_input\_event
[ Upstream commit ffe3b7837a2bb421df84d0177481db9f52c93a71 ]
There is a slab-out-of-bounds Write bug in hid-holtek-kbd driver.
The problem is the driver assumes the device must have an input
but some malicious devices violate this assumption.
Fix this by checking hid\_device's input is non-empty before its usage.
Signed-off-by: Ma Ke
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit b404427a7be20455f5ed753e3d85e394a97a350a
Author: Hans de Goede
Date: Mon Aug 28 00:24:38 2023 +0200
HID: logitech-hidpp: Add Bluetooth ID for the Logitech M720 Triathlon mouse
[ Upstream commit 2d866603e25b1ce7e536839f62d1faae1c03d92f ]
Using hidpp for the M720 adds battery info reporting and hires
scrolling support.
Signed-off-by: Hans de Goede
Signed-off-by: Bastien Nocera
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit 47a066e866aa50068f52adc6eed5ec8c739cd797
Author: Johannes Berg
Date: Thu Sep 14 15:45:17 2023 +0200
rfkill: sync before userspace visibility/changes
[ Upstream commit 2c3dfba4cf84ac4f306cc6653b37b6dd6859ae9d ]
If userspace quickly opens /dev/rfkill after a new
instance was created, it might see the old state of
the instance from before the sync work runs and may
even \_change\_ the state, only to have the sync work
change it again.
Fix this by doing the sync inline where needed, not
just for /dev/rfkill but also for sysfs.
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit f19e6337aa9be27c8bb05396b5e8317d4afca010
Author: Ben Greear
Date: Tue Aug 8 13:56:05 2023 -0700
wifi: iwlwifi: Ensure ack flag is properly cleared.
[ Upstream commit e8fbe99e87877f0412655f40d7c45bf8471470ac ]
Debugging indicates that nothing else is clearing the info->flags,
so some frames were flagged as ACKed when they should not be.
Explicitly clear the ack flag to ensure this does not happen.
Signed-off-by: Ben Greear
Acked-by: Gregory Greenman
Link: https://lore.kernel.org/r/20230808205605.4105670-1-greearb@candelatech.com
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 22d405f5c1e67fd1af4a3f6418f40867f26f7642
Author: Aditya Kumar Singh
Date: Tue Sep 5 12:18:57 2023 +0530
wifi: cfg80211: validate AP phy operation before starting it
[ Upstream commit 5112fa502708aaaf80acb78273fc8625f221eb11 ]
Many regulatories can have HE/EHT Operation as not permitted. In such
cases, AP should not be allowed to start if it is using a channel
having the no operation flag set. However, currently there is no such
check in place.
Fix this issue by validating such IEs sent during start AP against the
channel flags.
Signed-off-by: Aditya Kumar Singh
Reviewed-by: Jeff Johnson
Link: https://lore.kernel.org/r/20230905064857.1503-1-quic\_adisi@quicinc.com
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 84a89ef8acf3ce510cb2cbc22ca935aa8d5846c6
Author: Gustavo A. R. Silva
Date: Thu Aug 24 21:10:45 2023 -0600
wifi: mwifiex: Sanity check tlv\_len and tlv\_bitmap\_len
[ Upstream commit d5a93b7d2877aae4ba7590ad6cb65f8d33079489 ]
Add sanity checks for both `tlv\_len` and `tlv\_bitmap\_len` before
decoding data from `event\_buf`.
This prevents any malicious or buggy firmware from overflowing
`event\_buf` through large values for `tlv\_len` and `tlv\_bitmap\_len`.
Suggested-by: Dan Williams
Signed-off-by: Gustavo A. R. Silva
Reviewed-by: Kees Cook
Signed-off-by: Kalle Valo
Link: https://lore.kernel.org/r/d4f8780527d551552ee96f17a0229e02e1c200d1.1692931954.git.gustavoars@kernel.org
Signed-off-by: Sasha Levin
commit 26feeeb70477c137020163a9011236714a706b29
Author: Clément Léger
Date: Fri Sep 29 21:16:37 2023 +0200
tracing: relax trace\_event\_eval\_update() execution with cond\_resched()
[ Upstream commit 23cce5f25491968b23fb9c399bbfb25f13870cd9 ]
When kernel is compiled without preemption, the eval\_map\_work\_func()
(which calls trace\_event\_eval\_update()) will not be preempted up to its
complete execution. This can actually cause a problem since if another
CPU call stop\_machine(), the call will have to wait for the
eval\_map\_work\_func() function to finish executing in the workqueue
before being able to be scheduled. This problem was observe on a SMP
system at boot time, when the CPU calling the initcalls executed
clocksource\_done\_booting() which in the end calls stop\_machine(). We
observed a 1 second delay because one CPU was executing
eval\_map\_work\_func() and was not preempted by the stop\_machine() task.
Adding a call to cond\_resched() in trace\_event\_eval\_update() allows
other tasks to be executed and thus continue working asynchronously
like before without blocking any pending task at boot time.
Link: https://lore.kernel.org/linux-trace-kernel/20230929191637.416931-1-cleger@rivosinc.com
Cc: Masami Hiramatsu
Signed-off-by: Clément Léger
Tested-by: Atish Patra
Reviewed-by: Atish Patra
Signed-off-by: Steven Rostedt (Google)
Signed-off-by: Sasha Levin
commit 72ec64ea0e1236b17fa0c7f6f0409ef897405631
Author: Damien Le Moal
Date: Tue Sep 12 09:08:40 2023 +0900
ata: libata-eh: Fix compilation warning in ata\_eh\_link\_report()
[ Upstream commit 49728bdc702391902a473b9393f1620eea32acb0 ]
The 6 bytes length of the tries\_buf string in ata\_eh\_link\_report() is
too short and results in a gcc compilation warning with W-!:
drivers/ata/libata-eh.c: In function ‘ata\_eh\_link\_report’:
drivers/ata/libata-eh.c:2371:59: warning: ‘%d’ directive output may be truncated writing between 1 and 11 bytes into a region of size 4 [-Wformat-truncation=]
2371 | snprintf(tries\_buf, sizeof(tries\_buf), " t%d",
| ^~
drivers/ata/libata-eh.c:2371:56: note: directive argument in the range [-2147483648, 4]
2371 | snprintf(tries\_buf, sizeof(tries\_buf), " t%d",
| ^~~~~~
drivers/ata/libata-eh.c:2371:17: note: ‘snprintf’ output between 4 and 14 bytes into a destination of size 6
2371 | snprintf(tries\_buf, sizeof(tries\_buf), " t%d",
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
2372 | ap->eh\_tries);
| ~~~~~~~~~~~~~
Avoid this warning by increasing the string size to 16B.
Signed-off-by: Damien Le Moal
Reviewed-by: Hannes Reinecke
Tested-by: Geert Uytterhoeven
Reviewed-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 5bd7eba2174ce681ac1622c96a19250cfb0b3495
Author: Damien Le Moal
Date: Tue Sep 12 08:46:22 2023 +0900
ata: libata-core: Fix compilation warning in ata\_dev\_config\_ncq()
[ Upstream commit ed518d9ba980dc0d27c7d1dea1e627ba001d1977 ]
The 24 bytes length allocated to the ncq\_desc string in
ata\_dev\_config\_lba() for ata\_dev\_config\_ncq() to use is too short,
causing the following gcc compilation warnings when compiling with W=1:
drivers/ata/libata-core.c: In function ‘ata\_dev\_configure’:
drivers/ata/libata-core.c:2378:56: warning: ‘%d’ directive output may be truncated writing between 1 and 2 bytes into a region of size between 1 and 11 [-Wformat-truncation=]
2378 | snprintf(desc, desc\_sz, "NCQ (depth %d/%d)%s", hdepth,
| ^~
In function ‘ata\_dev\_config\_ncq’,
inlined from ‘ata\_dev\_config\_lba’ at drivers/ata/libata-core.c:2649:8,
inlined from ‘ata\_dev\_configure’ at drivers/ata/libata-core.c:2952:9:
drivers/ata/libata-core.c:2378:41: note: directive argument in the range [1, 32]
2378 | snprintf(desc, desc\_sz, "NCQ (depth %d/%d)%s", hdepth,
| ^~~~~~~~~~~~~~~~~~~~~
drivers/ata/libata-core.c:2378:17: note: ‘snprintf’ output between 16 and 31 bytes into a destination of size 24
2378 | snprintf(desc, desc\_sz, "NCQ (depth %d/%d)%s", hdepth,
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
2379 | ddepth, aa\_desc);
| ~~~~~~~~~~~~~~~~
Avoid these warnings and the potential truncation by changing the size
of the ncq\_desc string to 32 characters.
Signed-off-by: Damien Le Moal
Reviewed-by: Hannes Reinecke
Tested-by: Geert Uytterhoeven
Reviewed-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 21a696f3a91d05350f330e1c572423a4c611dcf6
Author: Chengfeng Ye
Date: Tue Sep 26 10:29:14 2023 +0000
gpio: timberdale: Fix potential deadlock on &tgpio->lock
[ Upstream commit 9e8bc2dda5a7a8e2babc9975f4b11c9a6196e490 ]
As timbgpio\_irq\_enable()/timbgpio\_irq\_disable() callback could be
executed under irq context, it could introduce double locks on
&tgpio->lock if it preempts other execution units requiring
the same locks.
timbgpio\_gpio\_set()
--> timbgpio\_update\_bit()
--> spin\_lock(&tgpio->lock)
--> timbgpio\_irq\_disable()
--> spin\_lock\_irqsave(&tgpio->lock)
This flaw was found by an experimental static analysis tool I am
developing for irq-related deadlock.
To prevent the potential deadlock, the patch uses spin\_lock\_irqsave()
on &tgpio->lock inside timbgpio\_gpio\_set() to prevent the possible
deadlock scenario.
Signed-off-by: Chengfeng Ye
Reviewed-by: Andy Shevchenko
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Sasha Levin
commit 6d3ab53ab7f943c1056062e00e12f281a5dd53b0
Author: Jacek Lawrynowicz
Date: Mon Sep 25 14:11:33 2023 +0200
accel/ivpu: Don't flood dmesg with VPU ready message
[ Upstream commit 002652555022728c42b5517c6c11265b8c3ab827 ]
Use ivpu\_dbg() to print the VPU ready message so it doesn't pollute
the dmesg.
Signed-off-by: Jacek Lawrynowicz
Reviewed-by: Stanislaw Gruszka
Reviewed-by: Jeffrey Hugo
Signed-off-by: Stanislaw Gruszka
Link: https://patchwork.freedesktop.org/patch/msgid/20230925121137.872158-3-stanislaw.gruszka@linux.intel.com
Signed-off-by: Sasha Levin
commit 90647d0da861c93d23379a2f1c8b72676ad01ef4
Author: Jeff Layton
Date: Wed Sep 13 09:33:12 2023 -0400
overlayfs: set ctime when setting mtime and atime
[ Upstream commit 03dbab3bba5f009d053635c729d1244f2c8bad38 ]
Nathan reported that he was seeing the new warning in
setattr\_copy\_mgtime pop when starting podman containers. Overlayfs is
trying to set the atime and mtime via notify\_change without also
setting the ctime.
POSIX states that when the atime and mtime are updated via utimes() that
we must also update the ctime to the current time. The situation with
overlayfs copy-up is analogies, so add ATTR\_CTIME to the bitmask.
notify\_change will fill in the value.
Reported-by: Nathan Chancellor
Signed-off-by: Jeff Layton
Tested-by: Nathan Chancellor
Acked-by: Christian Brauner
Acked-by: Amir Goldstein
Message-Id: <20230913-ctime-v1-1-c6bc509cbc27@kernel.org>
Signed-off-by: Christian Brauner
Signed-off-by: Sasha Levin
commit 2bc65f2ef8dae87d42afb47fac14cfca449d662f
Author: Heiner Kallweit
Date: Sat Sep 23 23:54:06 2023 +0200
i2c: mux: Avoid potential false error message in i2c\_mux\_add\_adapter
[ Upstream commit b13e59e74ff71a1004e0508107e91e9a84fd7388 ]
I2C\_CLASS\_DEPRECATED is a flag and not an actual class.
There's nothing speaking against both, parent and child, having
I2C\_CLASS\_DEPRECATED set. Therefore exclude it from the check.
Signed-off-by: Heiner Kallweit
Acked-by: Peter Rosin
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit c3d5ec9fe0eef7b7785032ad9d3e20a48bbb37d4
Author: Josef Bacik
Date: Tue Sep 5 12:15:24 2023 -0400
btrfs: initialize start\_slot in btrfs\_log\_prealloc\_extents
[ Upstream commit b4c639f699349880b7918b861e1bd360442ec450 ]
Jens reported a compiler warning when using
CONFIG\_CC\_OPTIMIZE\_FOR\_SIZE=y that looks like this
fs/btrfs/tree-log.c: In function ‘btrfs\_log\_prealloc\_extents’:
fs/btrfs/tree-log.c:4828:23: warning: ‘start\_slot’ may be used
uninitialized [-Wmaybe-uninitialized]
4828 | ret = copy\_items(trans, inode, dst\_path, path,
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
4829 | start\_slot, ins\_nr, 1, 0);
| ~~~~~~~~~~~~~~~~~~~~~~~~~
fs/btrfs/tree-log.c:4725:13: note: ‘start\_slot’ was declared here
4725 | int start\_slot;
| ^~~~~~~~~~
The compiler is incorrect, as we only use this code when ins\_len > 0,
and when ins\_len > 0 we have start\_slot properly initialized. However
we generally find the -Wmaybe-uninitialized warnings valuable, so
initialize start\_slot to get rid of the warning.
Reported-by: Jens Axboe
Tested-by: Jens Axboe
Signed-off-by: Josef Bacik
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
commit 43cd1b16afbed7c7b43c846859f6d3d6fb448716
Author: Filipe Manana
Date: Fri Sep 8 18:20:23 2023 +0100
btrfs: return -EUCLEAN for delayed tree ref with a ref count not equals to 1
[ Upstream commit 1bf76df3fee56d6637718e267f7c34ed70d0c7dc ]
When running a delayed tree reference, if we find a ref count different
from 1, we return -EIO. This isn't an IO error, as it indicates either a
bug in the delayed refs code or a memory corruption, so change the error
code from -EIO to -EUCLEAN. Also tag the branch as 'unlikely' as this is
not expected to ever happen, and change the error message to print the
tree block's bytenr without the parenthesis (and there was a missing space
between the 'block' word and the opening parenthesis), for consistency as
that's the style we used everywhere else.
Reviewed-by: Josef Bacik
Signed-off-by: Filipe Manana
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
commit 417753a1af5b740bb56933a976f58196a6a10375
Author: Filipe Manana
Date: Fri Sep 8 18:20:19 2023 +0100
btrfs: prevent transaction block reserve underflow when starting transaction
[ Upstream commit a7ddeeb079505961355cf0106154da0110f1fdff ]
When starting a transaction, with a non-zero number of items, we reserve
metadata space for that number of items and for delayed refs by doing a
call to btrfs\_block\_rsv\_add(), with the transaction block reserve passed
as the block reserve argument. This reserves metadata space and adds it
to the transaction block reserve. Later we migrate the space we reserved
for delayed references from the transaction block reserve into the delayed
refs block reserve, by calling btrfs\_migrate\_to\_delayed\_refs\_rsv().
btrfs\_migrate\_to\_delayed\_refs\_rsv() decrements the number of bytes to
migrate from the source block reserve, and this however may result in an
underflow in case the space added to the transaction block reserve ended
up being used by another task that has not reserved enough space for its
own use - examples are tasks doing reflinks or hole punching because they
end up calling btrfs\_replace\_file\_extents() -> btrfs\_drop\_extents() and
may need to modify/COW a variable number of leaves/paths, so they keep
trying to use space from the transaction block reserve when they need to
COW an extent buffer, and may end up trying to use more space then they
have reserved (1 unit/path only for removing file extent items).
This can be avoided by simply reserving space first without adding it to
the transaction block reserve, then add the space for delayed refs to the
delayed refs block reserve and finally add the remaining reserved space
to the transaction block reserve. This also makes the code a bit shorter
and simpler. So just do that.
Reviewed-by: Josef Bacik
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
commit e2829b94c62f643ca4c388a6400732033357de65
Author: Filipe Manana
Date: Fri Sep 8 18:20:18 2023 +0100
btrfs: fix race when refilling delayed refs block reserve
[ Upstream commit 2ed45c0f1879079b30248568c515cf60fc668d8a ]
If we have two (or more) tasks attempting to refill the delayed refs block
reserve we can end up with the delayed block reserve being over reserved,
that is, with a reserved space greater than its size. If this happens, we
are holding to more reserved space than necessary for a while.
The race happens like this:
1) The delayed refs block reserve has a size of 8M and a reserved space of
6M for example;
2) Task A calls btrfs\_delayed\_refs\_rsv\_refill();
3) Task B also calls btrfs\_delayed\_refs\_rsv\_refill();
4) Task A sees there's a 2M difference between the size and the reserved
space of the delayed refs rsv, so it will reserve 2M of space by
calling btrfs\_reserve\_metadata\_bytes();
5) Task B also sees that 2M difference, and like task A, it reserves
another 2M of metadata space;
6) Both task A and task B increase the reserved space of block reserve
by 2M, by calling btrfs\_block\_rsv\_add\_bytes(), so the block reserve
ends up with a size of 8M and a reserved space of 10M;
7) The extra, over reserved space will eventually be freed by some task
calling btrfs\_delayed\_refs\_rsv\_release() -> btrfs\_block\_rsv\_release()
-> block\_rsv\_release\_bytes(), as there we will detect the over reserve
and release that space.
So fix this by checking if we still need to add space to the delayed refs
block reserve after reserving the metadata space, and if we don't, just
release that space immediately.
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Sasha Levin
commit 98214257647741f26b136cfbc422a02228790ea2
Author: Chunhai Guo
Date: Fri Sep 15 22:51:31 2023 -0600
fs-writeback: do not requeue a clean inode having skipped pages
[ Upstream commit be049c3a088d512187407b7fd036cecfab46d565 ]
When writing back an inode and performing an fsync on it concurrently, a
deadlock issue may arise as shown below. In each writeback iteration, a
clean inode is requeued to the wb->b\_dirty queue due to non-zero
pages\_skipped, without anything actually being written. This causes an
infinite loop and prevents the plug from being flushed, resulting in a
deadlock. We now avoid requeuing the clean inode to prevent this issue.
wb\_writeback fsync (inode-Y)
blk\_start\_plug(&plug)
for (;;) {
iter i-1: some reqs with page-X added into plug->mq\_list // f2fs node page-X with PG\_writeback
filemap\_fdatawrite
\_\_filemap\_fdatawrite\_range // write inode-Y with sync\_mode WB\_SYNC\_ALL
do\_writepages
f2fs\_write\_data\_pages
\_\_f2fs\_write\_data\_pages // wb\_sync\_req[DATA]++ for WB\_SYNC\_ALL
f2fs\_write\_cache\_pages
f2fs\_write\_single\_data\_page
f2fs\_do\_write\_data\_page
f2fs\_outplace\_write\_data
f2fs\_update\_data\_blkaddr
f2fs\_wait\_on\_page\_writeback
wait\_on\_page\_writeback // wait for f2fs node page-X
iter i:
progress = \_\_writeback\_inodes\_wb(wb, work)
. writeback\_sb\_inodes
. \_\_writeback\_single\_inode // write inode-Y with sync\_mode WB\_SYNC\_NONE
. . do\_writepages
. . f2fs\_write\_data\_pages
. . . \_\_f2fs\_write\_data\_pages // skip writepages due to (wb\_sync\_req[DATA]>0)
. . . wbc->pages\_skipped += get\_dirty\_pages(inode) // wbc->pages\_skipped = 1
. if (!(inode->i\_state & I\_DIRTY\_ALL)) // i\_state = I\_SYNC | I\_SYNC\_QUEUED
. total\_wrote++; // total\_wrote = 1
. requeue\_inode // requeue inode-Y to wb->b\_dirty queue due to non-zero pages\_skipped
if (progress) // progress = 1
continue;
iter i+1:
queue\_io
// similar process with iter i, infinite for-loop !
}
blk\_finish\_plug(&plug) // flush plug won't be called
Signed-off-by: Chunhai Guo
Reviewed-by: Jan Kara
Message-Id: <20230916045131.957929-1-guochunhai@vivo.com>
Signed-off-by: Christian Brauner
Signed-off-by: Sasha Levin
commit 98e737c3e86c4cb6e5510409d12a9a8ad802eec7
Author: Rob Herring
Date: Wed Aug 30 14:56:34 2023 -0500
arm64: dts: mediatek: Fix "mediatek,merge-mute" and "mediatek,merge-fifo-en" types
[ Upstream commit 5f8456b1faefb06fcf6028dced9f37aa880c779d ]
"mediatek,merge-mute" and "mediatek,merge-fifo-en" properties are defined
and used as boolean properties which in DT have no value.
Signed-off-by: Rob Herring
Reviewed-by: AngeloGioacchino Del Regno
Link: https://lore.kernel.org/r/20230830195650.704737-1-robh@kernel.org
Signed-off-by: Arnd Bergmann
Signed-off-by: Sasha Levin
commit 245cade8fc9a3e2a7004bf6bdbea7f39daa7b3f1
Author: Tony Lindgren
Date: Mon Sep 11 07:07:38 2023 +0300
ARM: dts: ti: omap: Fix noisy serial with overrun-throttle-ms for mapphone
[ Upstream commit 5ad37b5e30433afa7a5513e3eb61f69fa0976785 ]
On mapphone devices we may get lots of noise on the micro-USB port in debug
uart mode until the phy-cpcap-usb driver probes. Let's limit the noise by
using overrun-throttle-ms.
Note that there is also a related separate issue where the charger cable
connected may cause random sysrq requests until phy-cpcap-usb probes that
still remains.
Cc: Ivaylo Dimitrov
Cc: Carl Philipp Klemm
Cc: Merlijn Wajer
Cc: Pavel Machek
Reviewed-by: Sebastian Reichel
Signed-off-by: Tony Lindgren
Signed-off-by: Sasha Levin
commit 94de81b46a8370a581ce9172ae70ba594f7301a2
Author: David Thompson
Date: Wed Aug 23 09:37:43 2023 -0400
pwr-mlxbf: extend Kconfig to include gpio-mlxbf3 dependency
[ Upstream commit 82f07f1acf417b81e793145c167dd5e156024de4 ]
The BlueField power handling driver (pwr-mlxbf.c) provides
functionality for both BlueField-2 and BlueField-3 based
platforms. This driver also depends on the SoC-specific
BlueField GPIO driver, whether gpio-mlxbf2 or gpio-mlxbf3.
This patch extends the Kconfig definition to include the
dependency on the gpio-mlxbf3 driver, if applicable.
Signed-off-by: David Thompson
Reviewed-by: Asmaa Mnebhi
Link: https://lore.kernel.org/r/20230823133743.31275-1-davthompson@nvidia.com
Signed-off-by: Sebastian Reichel
Signed-off-by: Sasha Levin
commit 6ebc25a77ed5f18b8910ecfad73927ac5a1d4a07
Author: Mårten Lindahl
Date: Mon Sep 11 14:43:01 2023 +0200
iio: light: vcnl4000: Don't power on/off chip in config
[ Upstream commit 7e87ab38eed09c9dec56da361d74158159ae84a3 ]
After enabling/disabling interrupts on the vcnl4040 chip the als and/or
ps sensor is powered on or off depending on the interrupt enable bits.
This is made as a last step in write\_event\_config.
But there is no reason to do this as the runtime PM handles the power
state of the sensors. Interfering with this may impact sensor readings.
Consider the following:
1. Userspace makes sensor data reading which triggers RPM resume
(sensor powered on) and a RPM suspend timeout. The timeout is 2000ms
before RPM suspend powers the sensor off if no new reading is made
within the timeout period.
2. Userspace disables interrupts => powers sensor off
3. Userspace reads sensor data = 0 because sensor is off and the
suspend timeout has not passed. For each new reading made within the
timeout period the timeout is renewed with 2000ms and RPM will not
make a new resume (device was not suspended). So the sensor will
not be powered on.
4. No further userspace reading for 2000ms ends RPM suspend timeout and
triggers suspend (powers off already powered off sensor).
Powering sensor off in (2) makes all consecutive readings made within
2000ms to the previous reading (3) return invalid data.
Skip setting power state when writing new event config.
Fixes: 546676121cb9 ("iio: light: vcnl4000: Add interrupt support for vcnl4040")
Fixes: bc292aaf9cb4 ("iio: light: vcnl4000: add illuminance irq vcnl4040/4200")
Signed-off-by: Mårten Lindahl
Link: https://lore.kernel.org/r/20230907-vcnl4000-pm-fix-v2-1-298e01f54db4@axis.com
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Sasha Levin
commit f7a69786fe5ec75d1cdd71b465e74a1adc68ef40
Author: Jakub Kicinski
Date: Tue Oct 17 18:38:14 2023 -0700
net: check for altname conflicts when changing netdev's netns
commit 7663d522099ecc464512164e660bc771b2ff7b64 upstream.
It's currently possible to create an altname conflicting
with an altname or real name of another device by creating
it in another netns and moving it over:
[ ~]$ ip link add dev eth0 type dummy
[ ~]$ ip netns add test
[ ~]$ ip -netns test link add dev ethX netns test type dummy
[ ~]$ ip -netns test link property add dev ethX altname eth0
[ ~]$ ip -netns test link set dev ethX netns 1
[ ~]$ ip link
...
3: eth0:  mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
link/ether 02:40:88:62:ec:b8 brd ff:ff:ff:ff:ff:ff
...
5: ethX:  mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
link/ether 26:b7:28:78:38:0f brd ff:ff:ff:ff:ff:ff
altname eth0
Create a macro for walking the altnames, this hopefully makes
it clearer that the list we walk contains only altnames.
Which is otherwise not entirely intuitive.
Fixes: 36fbf1e52bd3 ("net: rtnetlink: add linkprop commands to add and delete alternative ifnames")
Reviewed-by: Jiri Pirko
Signed-off-by: Jakub Kicinski
Signed-off-by: Paolo Abeni
Signed-off-by: Greg Kroah-Hartman
commit 95e76a1f998892bdd017c2daef8520f4f517058f
Author: Jakub Kicinski
Date: Tue Oct 17 18:38:13 2023 -0700
net: fix ifname in netlink ntf during netns move
commit 311cca40661f428b7aa114fb5af578cfdbe3e8b6 upstream.
dev\_get\_valid\_name() overwrites the netdev's name on success.
This makes it hard to use in prepare-commit-like fashion,
where we do validation first, and "commit" to the change
later.
Factor out a helper which lets us save the new name to a buffer.
Use it to fix the problem of notification on netns move having
incorrect name:
5: eth0:  mtu 1500 qdisc noop state DOWN group default
link/ether be:4d:58:f9:d5:40 brd ff:ff:ff:ff:ff:ff
6: eth1:  mtu 1500 qdisc noop state DOWN group default
link/ether 1e:4a:34:36:e3:cd brd ff:ff:ff:ff:ff:ff
[ ~]# ip link set dev eth0 netns 1 name eth1
ip monitor inside netns:
Deleted inet eth0
Deleted inet6 eth0
Deleted 5: eth1:  mtu 1500 qdisc noop state DOWN group default
link/ether be:4d:58:f9:d5:40 brd ff:ff:ff:ff:ff:ff new-netnsid 0 new-ifindex 7
Name is reported as eth1 in old netns for ifindex 5, already renamed.
Fixes: d90310243fd7 ("net: device name allocation cleanups")
Signed-off-by: Jakub Kicinski
Reviewed-by: Jiri Pirko
Signed-off-by: Paolo Abeni
Signed-off-by: Greg Kroah-Hartman
commit d1d14bcc14bc564d01448bb9063a58497e4fc784
Author: Jakub Kicinski
Date: Tue Oct 17 18:38:15 2023 -0700
net: avoid UAF on deleted altname
commit 1a83f4a7c156fa6bbd6b530e89fa3270bf3d9d1b upstream.
Altnames are accessed under RCU (dev\_get\_by\_name\_rcu())
but freed by kfree() with no synchronization point.
Each node has one or two allocations (node and a variable-size
name, sometimes the name is netdev->name). Adding rcu\_heads
here is a bit tedious. Besides most code which unlists the names
already has rcu barriers - so take the simpler approach of adding
synchronize\_rcu(). Note that the one on the unregistration path
(which matters more) is removed by the next fix.
Fixes: ff92741270bf ("net: introduce name\_node struct to be used in hashlist")
Reviewed-by: Jiri Pirko
Signed-off-by: Jakub Kicinski
Signed-off-by: Paolo Abeni
Signed-off-by: Greg Kroah-Hartman
commit f3036796e67da7a2d5de82a4e7ea4b1848a41b94
Author: Vladimir Oltean
Date: Tue Oct 17 17:31:44 2023 +0300
net: mdio-mux: fix C45 access returning -EIO after API change
commit 1f9f2143f24e224a8582a5d54918c43b9121eccc upstream.
The mii\_bus API conversion to read\_c45() and write\_c45() did not cover
the mdio-mux driver before read() and write() were made C22-only.
This broke arch/arm64/boot/dts/freescale/fsl-ls1028a-qds-13bb.dtso.
The -EOPNOTSUPP from mdiobus\_c45\_read() is transformed by
get\_phy\_c45\_devs\_in\_pkg() into -EIO, is further propagated to
of\_mdiobus\_register() and this makes the mdio-mux driver fail to probe
the entire child buses, not just the PHYs that cause access errors.
Fix the regression by introducing special c45 read and write accessors
to mdio-mux which forward the operation to the parent MDIO bus.
Fixes: db1a63aed89c ("net: phy: Remove fallback to old C45 method")
Signed-off-by: Vladimir Oltean
Reviewed-by: Florian Fainelli
Reviewed-by: Andrew Lunn
Reviewed-by: Russell King (Oracle)
Link: https://lore.kernel.org/r/20231017143144.3212657-1-vladimir.oltean@nxp.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit f53e11725233024d02f3f6efeb489cc660788567
Author: Willem de Bruijn
Date: Wed Oct 11 10:01:14 2023 -0400
net: more strict VIRTIO\_NET\_HDR\_GSO\_UDP\_L4 validation
commit fc8b2a619469378717e7270d2a4e1ef93c585f7a upstream.
Syzbot reported two new paths to hit an internal WARNING using the
new virtio gso type VIRTIO\_NET\_HDR\_GSO\_UDP\_L4.
RIP: 0010:skb\_checksum\_help+0x4a2/0x600 net/core/dev.c:3260
skb len=64521 gso\_size=344
and
RIP: 0010:skb\_warn\_bad\_offload+0x118/0x240 net/core/dev.c:3262
Older virtio types have historically had loose restrictions, leading
to many entirely impractical fuzzer generated packets causing
problems deep in the kernel stack. Ideally, we would have had strict
validation for all types from the start.
New virtio types can have tighter validation. Limit UDP GSO packets
inserted via virtio to the same limits imposed by the UDP\_SEGMENT
socket interface:
1. must use checksum offload
2. checksum offload matches UDP header
3. no more segments than UDP\_MAX\_SEGMENTS
4. UDP GSO does not take modifier flags, notably SKB\_GSO\_TCP\_ECN
Fixes: 860b7f27b8f7 ("linux/virtio\_net.h: Support USO offload in vnet header.")
Reported-by: syzbot+01cdbc31e9c0ae9b33ac@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/0000000000005039270605eb0b7f@google.com/
Reported-by: syzbot+c99d835ff081ca30f986@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/0000000000005426680605eb0b9f@google.com/
Signed-off-by: Willem de Bruijn
Reviewed-by: Eric Dumazet
Acked-by: Jason Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bd076ba9d76274da652a99ee546d0134752db690
Author: Gavrilov Ilia
Date: Mon Oct 16 14:08:59 2023 +0000
net: pktgen: Fix interface flags printing
commit 1d30162f35c7a73fc2f8cdcdcdbd690bedb99d1a upstream.
Device flags are displayed incorrectly:
1) The comparison (i == F\_FLOW\_SEQ) is always false, because F\_FLOW\_SEQ
is equal to (1 << FLOW\_SEQ\_SHIFT) == 2048, and the maximum value
of the 'i' variable is (NR\_PKT\_FLAG - 1) == 17. It should be compared
with FLOW\_SEQ\_SHIFT.
2) Similarly to the F\_IPSEC flag.
3) Also add spaces to the print end of the string literal "spi:%u"
to prevent the output from merging with the flag that follows.
Found by InfoTeCS on behalf of Linux Verification Center
(linuxtesting.org) with SVACE.
Fixes: 99c6d3d20d62 ("pktgen: Remove brute-force printing of flags")
Signed-off-by: Gavrilov Ilia
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 34f15aeeec579f0025a68e98d5e3efe35d2d4998
Author: Florian Fainelli
Date: Tue Oct 17 13:51:19 2023 -0700
net: phy: bcm7xxx: Add missing 16nm EPHY statistics
commit 6200e00e112ce2d17b066a20dd2476d9aecbefa6 upstream.
The .probe() function would allocate the necessary space and ensure that
the library call sizes the number of statistics but the callbacks
necessary to fetch the name and values were not wired up.
Reported-by: Justin Chen
Fixes: f68d08c437f9 ("net: phy: bcm7xxx: Add EPHY entry for 72165")
Reviewed-by: Andrew Lunn
Signed-off-by: Florian Fainelli
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20231017205119.416392-1-florian.fainelli@broadcom.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit d8bc92ce877ba3cadd7f81bfb9ad755c3e3c201f
Author: Aaron Conole
Date: Wed Oct 11 15:49:36 2023 -0400
selftests: openvswitch: Add version check for pyroute2
commit 92e37f20f20a23fec4626ae72eda50f127acb130 upstream.
Paolo Abeni reports that on some systems the pyroute2 version isn't
new enough to run the test suite. Ensure that we support a minimum
version of 0.6 for all cases (which does include the existing ones).
The 0.6.1 version was released in May of 2021, so should be
propagated to most installations at this point.
The alternative that Paolo proposed was to only skip when the
add-flow is being run. This would be okay for most cases, except
if a future test case is added that needs to do flow dump without
an associated add (just guessing). In that case, it could also be
broken and we would need additional skip logic anyway. Just draw
a line in the sand now.
Fixes: 25f16c873fb1 ("selftests: add openvswitch selftest suite")
Reported-by: Paolo Abeni
Closes: https://lore.kernel.org/lkml/8470c431e0930d2ea204a9363a60937289b7fdbe.camel@redhat.com/
Signed-off-by: Aaron Conole
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit eeaa4fcd1f727b21dcc9ccab8fcd31ff4f0981ac
Author: Pablo Neira Ayuso
Date: Wed Oct 18 13:18:39 2023 +0200
netfilter: nf\_tables: revert do not remove elements if set backend implements .abort
commit f86fb94011aeb3b26337fc22204ca726aeb8bc24 upstream.
nf\_tables\_abort\_release() path calls nft\_set\_elem\_destroy() for
NFT\_MSG\_NEWSETELEM which releases the element, however, a reference to
the element still remains in the working copy.
Fixes: ebd032fa8818 ("netfilter: nf\_tables: do not remove elements if set backend implements .abort")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Florian Westphal
Signed-off-by: Greg Kroah-Hartman
commit 2ec18541f390026e95c4eeda4cc88741566a9cf7
Author: Pablo Neira Ayuso
Date: Wed Oct 4 13:12:58 2023 +0200
netfilter: nf\_tables: do not remove elements if set backend implements .abort
commit ebd032fa881882fef2acb9da1bbde48d8233241d upstream.
pipapo set backend maintains two copies of the datastructure, removing
the elements from the copy that is going to be discarded slows down
the abort path significantly, from several minutes to few seconds after
this patch.
Fixes: 212ed75dc5fb ("netfilter: nf\_tables: integrate pipapo into commit protocol")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Florian Westphal
Signed-off-by: Greg Kroah-Hartman
commit d6ba6de49c2d52df811513515ea17ecbbb6ba51a
Author: Xingyuan Mo
Date: Mon Oct 9 18:36:14 2023 +0800
nf\_tables: fix NULL pointer dereference in nft\_inner\_init()
commit 52177bbf19e6e9398375a148d2e13ed492b40b80 upstream.
We should check whether the NFTA\_INNER\_NUM netlink attribute is present
before accessing it, otherwise a null pointer deference error will occur.
Call Trace:
dump\_stack\_lvl+0x4f/0x90
print\_report+0x3f0/0x620
kasan\_report+0xcd/0x110
\_\_asan\_load4+0x84/0xa0
nft\_inner\_init+0x128/0x2e0
nf\_tables\_newrule+0x813/0x1230
nfnetlink\_rcv\_batch+0xec3/0x1170
nfnetlink\_rcv+0x1e4/0x220
netlink\_unicast+0x34e/0x4b0
netlink\_sendmsg+0x45c/0x7e0
\_\_sys\_sendto+0x355/0x370
\_\_x64\_sys\_sendto+0x84/0xa0
do\_syscall\_64+0x3f/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
Fixes: 3a07327d10a0 ("netfilter: nft\_inner: support for inner tunnel header matching")
Signed-off-by: Xingyuan Mo
Signed-off-by: Florian Westphal
Signed-off-by: Greg Kroah-Hartman
commit 8a544721329e711f85358f73fe56964cdedeb531
Author: Xingyuan Mo
Date: Mon Oct 9 18:36:15 2023 +0800
nf\_tables: fix NULL pointer dereference in nft\_expr\_inner\_parse()
commit 505ce0630ad5d31185695f8a29dde8d29f28faa7 upstream.
We should check whether the NFTA\_EXPR\_NAME netlink attribute is present
before accessing it, otherwise a null pointer deference error will occur.
Call Trace:
dump\_stack\_lvl+0x4f/0x90
print\_report+0x3f0/0x620
kasan\_report+0xcd/0x110
\_\_asan\_load2+0x7d/0xa0
nla\_strcmp+0x2f/0x90
\_\_nft\_expr\_type\_get+0x41/0xb0
nft\_expr\_inner\_parse+0xe3/0x200
nft\_inner\_init+0x1be/0x2e0
nf\_tables\_newrule+0x813/0x1230
nfnetlink\_rcv\_batch+0xec3/0x1170
nfnetlink\_rcv+0x1e4/0x220
netlink\_unicast+0x34e/0x4b0
netlink\_sendmsg+0x45c/0x7e0
\_\_sys\_sendto+0x355/0x370
\_\_x64\_sys\_sendto+0x84/0xa0
do\_syscall\_64+0x3f/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
Fixes: 3a07327d10a0 ("netfilter: nft\_inner: support for inner tunnel header matching")
Signed-off-by: Xingyuan Mo
Signed-off-by: Florian Westphal
Signed-off-by: Greg Kroah-Hartman
commit 60a2031111700d4f278d1ad675aff86a4b241c48
Author: Pablo Neira Ayuso
Date: Mon Oct 2 11:57:42 2023 +0200
netfilter: nf\_tables: do not refresh timeout when resetting element
commit 4c90bba60c26db7dc7df450f748e86440149786e upstream.
The dump and reset command should not refresh the timeout, this command
is intended to allow users to list existing stateful objects and reset
them, element expiration should be refresh via transaction instead with
a specific command to achieve this, otherwise this is entering combo
semantics that will be hard to be undone later (eg. a user asking to
retrieve counters but \_not\_ requiring to refresh expiration).
Fixes: 079cd633219d ("netfilter: nf\_tables: Introduce NFT\_MSG\_GETSETELEM\_RESET")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Florian Westphal
Signed-off-by: Greg Kroah-Hartman
commit bfc88a6ce66eab9eca311ce76a368038ac6493a1
Author: Christoph Paasch
Date: Thu Oct 12 21:14:48 2023 -0700
netlink: Correct offload\_xstats size
commit 503930f8e113edc86f92b767efb4ea57bdffffb2 upstream.
rtnl\_offload\_xstats\_get\_size\_hw\_s\_info\_one() conditionalizes the
size-computation for IFLA\_OFFLOAD\_XSTATS\_HW\_S\_INFO\_USED based on whether
or not the device has offload\_xstats enabled.
However, rtnl\_offload\_xstats\_fill\_hw\_s\_info\_one() is adding the u8 for
that field uncondtionally.
syzkaller triggered a WARNING in rtnl\_stats\_get due to this:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 754 at net/core/rtnetlink.c:5982 rtnl\_stats\_get+0x2f4/0x300
Modules linked in:
CPU: 0 PID: 754 Comm: syz-executor148 Not tainted 6.6.0-rc2-g331b78eb12af #45
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.el7 04/01/2014
RIP: 0010:rtnl\_stats\_get+0x2f4/0x300 net/core/rtnetlink.c:5982
Code: ff ff 89 ee e8 7d 72 50 ff 83 fd a6 74 17 e8 33 6e 50 ff 4c 89 ef be 02 00 00 00 e8 86 00 fa ff e9 7b fe ff ff e8 1c 6e 50 ff <0f> 0b eb e5 e8 73 79 7b 00 0f 1f 00 90 90 90 90 90 90 90 90 90 90
RSP: 0018:ffffc900006837c0 EFLAGS: 00010293
RAX: ffffffff81cf7f24 RBX: ffff8881015d9000 RCX: ffff888101815a00
RDX: 0000000000000000 RSI: 00000000ffffffa6 RDI: 00000000ffffffa6
RBP: 00000000ffffffa6 R08: ffffffff81cf7f03 R09: 0000000000000001
R10: ffff888101ba47b9 R11: ffff888101815a00 R12: ffff8881017dae00
R13: ffff8881017dad00 R14: ffffc90000683ab8 R15: ffffffff83c1f740
FS: 00007fbc22dbc740(0000) GS:ffff88813bc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020000046 CR3: 000000010264e003 CR4: 0000000000170ef0
Call Trace:
rtnetlink\_rcv\_msg+0x677/0x710 net/core/rtnetlink.c:6480
netlink\_rcv\_skb+0xea/0x1c0 net/netlink/af\_netlink.c:2545
netlink\_unicast+0x430/0x500 net/netlink/af\_netlink.c:1342
netlink\_sendmsg+0x4fc/0x620 net/netlink/af\_netlink.c:1910
sock\_sendmsg+0xa8/0xd0 net/socket.c:730
\_\_\_\_sys\_sendmsg+0x22a/0x320 net/socket.c:2541
\_\_\_sys\_sendmsg+0x143/0x190 net/socket.c:2595
\_\_x64\_sys\_sendmsg+0xd8/0x150 net/socket.c:2624
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x47/0xa0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0xd8
RIP: 0033:0x7fbc22e8d6a9
Code: 5c c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 4f 37 0d 00 f7 d8 64 89 01 48
RSP: 002b:00007ffc4320e778 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 00000000004007d0 RCX: 00007fbc22e8d6a9
RDX: 0000000000000000 RSI: 0000000020000000 RDI: 0000000000000003
RBP: 0000000000000001 R08: 0000000000000000 R09: 00000000004007d0
R10: 0000000000000008 R11: 0000000000000246 R12: 00007ffc4320e898
R13: 00007ffc4320e8a8 R14: 00000000004004a0 R15: 00007fbc22fa5a80

---[ end trace 0000000000000000 ]---
Which didn't happen prior to commit bf9f1baa279f ("net: add dedicated
kmem\_cache for typical/small skb->head") as the skb always was large
enough.
Fixes: 0e7788fd7622 ("net: rtnetlink: Add UAPI for obtaining L3 offload xstats")
Signed-off-by: Christoph Paasch
Reviewed-by: Petr Machata
Link: https://lore.kernel.org/r/20231013041448.8229-1-cpaasch@apple.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 0317bd5e189fc4fd0cc908deb6966fcef50ae7cf
Author: Pablo Neira Ayuso
Date: Tue Oct 17 12:28:27 2023 +0200
netfilter: nft\_set\_rbtree: .deactivate fails if element has expired
commit d111692a59c1470ae530cbb39bcf0346c950ecc7 upstream.
This allows to remove an expired element which is not possible in other
existing set backends, this is more noticeable if gc-interval is high so
expired elements remain in the tree. On-demand gc also does not help in
this case, because this is delete element path. Return NULL if element
has expired.
Fixes: 8d8540c4f5e0 ("netfilter: nft\_set\_rbtree: add timeout support")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Florian Westphal
Signed-off-by: Greg Kroah-Hartman
commit 6d466bfe7bf3621261a077b785eb3e260b0eba08
Author: Phil Sutter
Date: Fri Oct 13 22:02:24 2023 +0200
selftests: netfilter: Run nft\_audit.sh in its own netns
commit 2e2d9c7d4d37d74873583d7b0c94eac8b6869486 upstream.
Don't mess with the host's firewall ruleset. Since audit logging is not
per-netns, add an initial delay of a second so other selftests' netns
cleanups have a chance to finish.
Fixes: e8dbde59ca3f ("selftests: netfilter: Test nf\_tables audit logging")
Signed-off-by: Phil Sutter
Signed-off-by: Florian Westphal
Signed-off-by: Greg Kroah-Hartman
commit 79fbd1c110b31420d2183c3fb7cbe7a34db0ee0e
Author: Aaron Conole
Date: Wed Oct 11 15:49:39 2023 -0400
selftests: openvswitch: Fix the ct\_tuple for v4
commit 8eff0e062201e26739c74ac2355b7362622b7190 upstream.
The ct\_tuple v4 data structure decode / encode routines were using
the v6 IP address decode and relying on default encode. This could
cause exceptions during encode / decode depending on how a ct4
tuple would appear in a netlink message.
Caught during code review.
Fixes: e52b07aa1a54 ("selftests: openvswitch: add flow dump support")
Signed-off-by: Aaron Conole
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7b624e1f9d20d8f70e48e250b3c8a13b73bccbc0
Author: Aaron Conole
Date: Wed Oct 11 15:49:37 2023 -0400
selftests: openvswitch: Catch cases where the tests are killed
commit af846afad5ca1c1a24d320adf9e48255e97db84e upstream.
In case of fatal signal, or early abort at least cleanup the current
test case.
Fixes: 25f16c873fb1 ("selftests: add openvswitch selftest suite")
Signed-off-by: Aaron Conole
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4efeda952519d3ba762c408877a8af46e9cfe9f7
Author: Geert Uytterhoeven
Date: Mon Oct 16 14:49:04 2023 +0200
neighbor: tracing: Move pin6 inside CONFIG\_IPV6=y section
commit 2915240eddba96b37de4c7e9a3d0ac6f9548454b upstream.
When CONFIG\_IPV6=n, and building with W=1:
In file included from include/trace/define\_trace.h:102,
from include/trace/events/neigh.h:255,
from net/core/net-traces.c:51:
include/trace/events/neigh.h: In function ‘trace\_event\_raw\_event\_neigh\_create’:
include/trace/events/neigh.h:42:34: error: variable ‘pin6’ set but not used [-Werror=unused-but-set-variable]
42 | struct in6\_addr \*pin6;
| ^~~~
include/trace/trace\_events.h:402:11: note: in definition of macro ‘DECLARE\_EVENT\_CLASS’
402 | { assign; } \
| ^~~~~~
include/trace/trace\_events.h:44:30: note: in expansion of macro ‘PARAMS’
44 | PARAMS(assign), \
| ^~~~~~
include/trace/events/neigh.h:23:1: note: in expansion of macro ‘TRACE\_EVENT’
23 | TRACE\_EVENT(neigh\_create,
| ^~~~~~~~~~~
include/trace/events/neigh.h:41:9: note: in expansion of macro ‘TP\_fast\_assign’
41 | TP\_fast\_assign(
| ^~~~~~~~~~~~~~
In file included from include/trace/define\_trace.h:103,
from include/trace/events/neigh.h:255,
from net/core/net-traces.c:51:
include/trace/events/neigh.h: In function ‘perf\_trace\_neigh\_create’:
include/trace/events/neigh.h:42:34: error: variable ‘pin6’ set but not used [-Werror=unused-but-set-variable]
42 | struct in6\_addr \*pin6;
| ^~~~
include/trace/perf.h:51:11: note: in definition of macro ‘DECLARE\_EVENT\_CLASS’
51 | { assign; } \
| ^~~~~~
include/trace/trace\_events.h:44:30: note: in expansion of macro ‘PARAMS’
44 | PARAMS(assign), \
| ^~~~~~
include/trace/events/neigh.h:23:1: note: in expansion of macro ‘TRACE\_EVENT’
23 | TRACE\_EVENT(neigh\_create,
| ^~~~~~~~~~~
include/trace/events/neigh.h:41:9: note: in expansion of macro ‘TP\_fast\_assign’
41 | TP\_fast\_assign(
| ^~~~~~~~~~~~~~
Indeed, the variable pin6 is declared and initialized unconditionally,
while it is only used and needlessly re-initialized when support for
IPv6 is enabled.
Fix this by dropping the unused variable initialization, and moving the
variable declaration inside the existing section protected by a check
for CONFIG\_IPV6.
Fixes: fc651001d2c5ca4f ("neighbor: Add tracepoint to \_\_neigh\_create")
Signed-off-by: Geert Uytterhoeven
Reviewed-by: Simon Horman
Tested-by: Simon Horman  # build-tested
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a851f8c9353329122031d93351c32150acf046ca
Author: Pedro Tammela
Date: Tue Oct 17 11:36:02 2023 -0300
net/sched: sch\_hfsc: upgrade 'rt' to 'sc' when it becomes a inner curve
commit a13b67c9a015c4e21601ef9aa4ec9c5d972df1b4 upstream.
Christian Theune says:
I upgraded from 6.1.38 to 6.1.55 this morning and it broke my traffic shaping script,
leaving me with a non-functional uplink on a remote router.
A 'rt' curve cannot be used as a inner curve (parent class), but we were
allowing such configurations since the qdisc was introduced. Such
configurations would trigger a UAF as Budimir explains:
The parent will have vttree\_insert() called on it in init\_vf(),
but will not have vttree\_remove() called on it in update\_vf()
because it does not have the HFSC\_FSC flag set.
The qdisc always assumes that inner classes have the HFSC\_FSC flag set.
This is by design as it doesn't make sense 'qdisc wise' for an 'rt'
curve to be an inner curve.
Budimir's original patch disallows users to add classes with a 'rt'
parent, but this is too strict as it breaks users that have been using
'rt' as a inner class. Another approach, taken by this patch, is to
upgrade the inner 'rt' into a 'sc', warning the user in the process.
It avoids the UAF reported by Budimir while also being more permissive
to bad scripts/users/code using 'rt' as a inner class.
Users checking the `tc class ls [...]` or `tc class get [...]` dumps would
observe the curve change and are potentially breaking with this change.
v1->v2: https://lore.kernel.org/all/20231013151057.2611860-1-pctammela@mojatatu.com/
- Correct 'Fixes' tag and merge with revert (Jakub)
Cc: Christian Theune
Cc: Budimir Markovic
Fixes: b3d26c5702c7 ("net/sched: sch\_hfsc: Ensure inner classes have fsc curve")
Signed-off-by: Pedro Tammela
Acked-by: Jamal Hadi Salim
Link: https://lore.kernel.org/r/20231017143602.3191556-1-pctammela@mojatatu.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 9e8ada3bf27e8cd8d7c0f79a736b0c8d465ed4ad
Author: Jiri Wiesner
Date: Tue Oct 10 18:39:33 2023 +0200
bonding: Return pointer to data after pull on skb
commit d93f3f992780af4a21e6c1ab86946b7c5602f1b9 upstream.
Since 429e3d123d9a ("bonding: Fix extraction of ports from the packet
headers"), header offsets used to compute a hash in bond\_xmit\_hash() are
relative to skb->data and not skb->head. If the tail of the header buffer
of an skb really needs to be advanced and the operation is successful, the
pointer to the data must be returned (and not a pointer to the head of the
buffer).
Fixes: 429e3d123d9a ("bonding: Fix extraction of ports from the packet headers")
Signed-off-by: Jiri Wiesner
Acked-by: Jay Vosburgh
Reviewed-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b72539b62d24234ac37813b887b94c89e05c097d
Author: Jinjie Ruan
Date: Wed Oct 11 11:24:19 2023 +0800
net: dsa: bcm\_sf2: Fix possible memory leak in bcm\_sf2\_mdio\_register()
commit 61b40cefe51af005c72dbdcf975a3d166c6e6406 upstream.
In bcm\_sf2\_mdio\_register(), the class\_find\_device() will call get\_device()
to increment reference count for priv->master\_mii\_bus->dev if
of\_mdio\_find\_bus() succeeds. If mdiobus\_alloc() or mdiobus\_register()
fails, it will call get\_device() twice without decrement reference count
for the device. And it is the same if bcm\_sf2\_mdio\_register() succeeds but
fails in bcm\_sf2\_sw\_probe(), or if bcm\_sf2\_sw\_probe() succeeds. If the
reference count has not decremented to zero, the dev related resource will
not be freed.
So remove the get\_device() in bcm\_sf2\_mdio\_register(), and call
put\_device() if mdiobus\_alloc() or mdiobus\_register() fails and in
bcm\_sf2\_mdio\_unregister() to solve the issue.
And as Simon suggested, unwind from errors for bcm\_sf2\_mdio\_register() and
just return 0 if it succeeds to make it cleaner.
Fixes: 461cd1b03e32 ("net: dsa: bcm\_sf2: Register our slave MDIO bus")
Signed-off-by: Jinjie Ruan
Suggested-by: Simon Horman
Reviewed-by: Simon Horman
Reviewed-by: Florian Fainelli
Link: https://lore.kernel.org/r/20231011032419.2423290-1-ruanjinjie@huawei.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit bcfb10a8d72259c522f7cb448e25fe5a1dc73a9b
Author: Michal Schmidt
Date: Wed Oct 11 16:33:32 2023 -0700
i40e: prevent crash on probe if hw registers have invalid values
commit fc6f716a5069180c40a8c9b63631e97da34f64a3 upstream.
The hardware provides the indexes of the first and the last available
queue and VF. From the indexes, the driver calculates the numbers of
queues and VFs. In theory, a faulty device might say the last index is
smaller than the first index. In that case, the driver's calculation
would underflow, it would attempt to write to non-existent registers
outside of the ioremapped range and crash.
I ran into this not by having a faulty device, but by an operator error.
I accidentally ran a QE test meant for i40e devices on an ice device.
The test used 'echo i40e > /sys/...ice PCI device.../driver\_override',
bound the driver to the device and crashed in one of the wr32 calls in
i40e\_clear\_hw.
Add checks to prevent underflows in the calculations of num\_queues and
num\_vfs. With this fix, the wrong device probing reports errors and
returns a failure without crashing.
Fixes: 838d41d92a90 ("i40e: clear all queues and interrupts")
Signed-off-by: Michal Schmidt
Reviewed-by: Simon Horman
Tested-by: Pucha Himasekhar Reddy  (A Contingent worker at Intel)
Link: https://lore.kernel.org/r/20231011233334.336092-2-jacob.e.keller@intel.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 3bbb112aa1387dbcf35c5f9968479f27dc03c626
Author: Shinas Rasheed
Date: Tue Oct 17 03:50:30 2023 -0700
octeon\_ep: update BQL sent bytes before ringing doorbell
commit a0ca6b9dfef0b3cc83aa8bb485ed61a018f84982 upstream.
Sometimes Tx is completed immediately after doorbell is updated, which
causes Tx completion routing to update completion bytes before the
same packet bytes are updated in sent bytes in transmit function, hence
hitting BUG\_ON() in dql\_completed(). To avoid this, update BQL
sent bytes before ringing doorbell.
Fixes: 37d79d059606 ("octeon\_ep: add Tx/Rx processing and interrupt support")
Signed-off-by: Shinas Rasheed
Link: https://lore.kernel.org/r/20231017105030.2310966-1-srasheed@marvell.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 48984949e51d10e57fe17e1c444508734ad89467
Author: Dan Carpenter
Date: Mon Oct 16 20:28:10 2023 +0300
net: usb: smsc95xx: Fix an error code in smsc95xx\_reset()
commit c53647a5df9e66dd9fedf240198e1fe50d88c286 upstream.
Return a negative error code instead of success.
Fixes: 2f7ca802bdae ("net: Add SMSC LAN9500 USB2.0 10/100 ethernet adapter driver")
Signed-off-by: Dan Carpenter
Reviewed-by: Andrew Lunn
Link: https://lore.kernel.org/r/147927f0-9ada-45cc-81ff-75a19dd30b76@moroto.mountain
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 394c8055fd0e7fd50b9a6d1a3ceae018a8ca10d6
Author: Eric Dumazet
Date: Tue Oct 17 19:23:04 2023 +0000
ipv4: fib: annotate races around nh->nh\_saddr\_genid and nh->nh\_saddr
commit 195374d893681da43a39796e53b30ac4f20400c4 upstream.
syzbot reported a data-race while accessing nh->nh\_saddr\_genid [1]
Add annotations, but leave the code lazy as intended.
[1]
BUG: KCSAN: data-race in fib\_select\_path / fib\_select\_path
write to 0xffff8881387166f0 of 4 bytes by task 6778 on cpu 1:
fib\_info\_update\_nhc\_saddr net/ipv4/fib\_semantics.c:1334 [inline]
fib\_result\_prefsrc net/ipv4/fib\_semantics.c:1354 [inline]
fib\_select\_path+0x292/0x330 net/ipv4/fib\_semantics.c:2269
ip\_route\_output\_key\_hash\_rcu+0x659/0x12c0 net/ipv4/route.c:2810
ip\_route\_output\_key\_hash net/ipv4/route.c:2644 [inline]
\_\_ip\_route\_output\_key include/net/route.h:134 [inline]
ip\_route\_output\_flow+0xa6/0x150 net/ipv4/route.c:2872
send4+0x1f5/0x520 drivers/net/wireguard/socket.c:61
wg\_socket\_send\_skb\_to\_peer+0x94/0x130 drivers/net/wireguard/socket.c:175
wg\_socket\_send\_buffer\_to\_peer+0xd6/0x100 drivers/net/wireguard/socket.c:200
wg\_packet\_send\_handshake\_initiation drivers/net/wireguard/send.c:40 [inline]
wg\_packet\_handshake\_send\_worker+0x10c/0x150 drivers/net/wireguard/send.c:51
process\_one\_work kernel/workqueue.c:2630 [inline]
process\_scheduled\_works+0x5b8/0xa30 kernel/workqueue.c:2703
worker\_thread+0x525/0x730 kernel/workqueue.c:2784
kthread+0x1d7/0x210 kernel/kthread.c:388
ret\_from\_fork+0x48/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304
read to 0xffff8881387166f0 of 4 bytes by task 6759 on cpu 0:
fib\_result\_prefsrc net/ipv4/fib\_semantics.c:1350 [inline]
fib\_select\_path+0x1cb/0x330 net/ipv4/fib\_semantics.c:2269
ip\_route\_output\_key\_hash\_rcu+0x659/0x12c0 net/ipv4/route.c:2810
ip\_route\_output\_key\_hash net/ipv4/route.c:2644 [inline]
\_\_ip\_route\_output\_key include/net/route.h:134 [inline]
ip\_route\_output\_flow+0xa6/0x150 net/ipv4/route.c:2872
send4+0x1f5/0x520 drivers/net/wireguard/socket.c:61
wg\_socket\_send\_skb\_to\_peer+0x94/0x130 drivers/net/wireguard/socket.c:175
wg\_socket\_send\_buffer\_to\_peer+0xd6/0x100 drivers/net/wireguard/socket.c:200
wg\_packet\_send\_handshake\_initiation drivers/net/wireguard/send.c:40 [inline]
wg\_packet\_handshake\_send\_worker+0x10c/0x150 drivers/net/wireguard/send.c:51
process\_one\_work kernel/workqueue.c:2630 [inline]
process\_scheduled\_works+0x5b8/0xa30 kernel/workqueue.c:2703
worker\_thread+0x525/0x730 kernel/workqueue.c:2784
kthread+0x1d7/0x210 kernel/kthread.c:388
ret\_from\_fork+0x48/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304
value changed: 0x959d3217 -> 0x959d3218
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 6759 Comm: kworker/u4:15 Not tainted 6.6.0-rc4-syzkaller-00029-gcbf3a2cb156a #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/06/2023
Workqueue: wg-kex-wg1 wg\_packet\_handshake\_send\_worker
Fixes: 436c3b66ec98 ("ipv4: Invalidate nexthop cache nh\_saddr more correctly.")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Reviewed-by: Simon Horman
Reviewed-by: David Ahern
Link: https://lore.kernel.org/r/20231017192304.82626-1-edumazet@google.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit dd6a8651b98f74f472e1e92c7fdac0ca7133f297
Author: Shailend Chand
Date: Sat Oct 14 01:41:21 2023 +0000
gve: Do not fully free QPL pages on prefill errors
commit 95535e37e8959f50e7aee365a5bdc9e5ed720443 upstream.
The prefill function should have only removed the page count bias it
added. Fully freeing the page will cause gve\_free\_queue\_page\_list to
free a page the driver no longer owns.
Fixes: 82fd151d38d9 ("gve: Reduce alloc and copy costs in the GQ rx path")
Signed-off-by: Shailend Chand
Link: https://lore.kernel.org/r/20231014014121.2843922-1-shailend@google.com
Signed-off-by: Paolo Abeni
Signed-off-by: Greg Kroah-Hartman
commit e6386242b4cd3c6c5913ec5edb012404da21077b
Author: Eric Dumazet
Date: Mon Oct 16 18:08:51 2023 +0000
tun: prevent negative ifindex
commit cbfbfe3aee718dc4c3c837f5d2463170ee59d78c upstream.
After commit 956db0a13b47 ("net: warn about attempts to register
negative ifindex") syzbot is able to trigger the following splat.
Negative ifindex are not supported.
WARNING: CPU: 1 PID: 6003 at net/core/dev.c:9596 dev\_index\_reserve+0x104/0x210
Modules linked in:
CPU: 1 PID: 6003 Comm: syz-executor926 Not tainted 6.6.0-rc4-syzkaller-g19af4a4ed414 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/06/2023
pstate: 80400005 (Nzcv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : dev\_index\_reserve+0x104/0x210
lr : dev\_index\_reserve+0x100/0x210
sp : ffff800096a878e0
x29: ffff800096a87930 x28: ffff0000d04380d0 x27: ffff0000d04380f8
x26: ffff0000d04380f0 x25: 1ffff00012d50f20 x24: 1ffff00012d50f1c
x23: dfff800000000000 x22: ffff8000929c21c0 x21: 00000000ffffffea
x20: ffff0000d04380e0 x19: ffff800096a87900 x18: ffff800096a874c0
x17: ffff800084df5008 x16: ffff80008051f9c4 x15: 0000000000000001
x14: 1fffe0001a087198 x13: 0000000000000000 x12: 0000000000000000
x11: 0000000000000000 x10: 0000000000000000 x9 : 0000000000000000
x8 : ffff0000d41c9bc0 x7 : 0000000000000000 x6 : 0000000000000000
x5 : ffff800091763d88 x4 : 0000000000000000 x3 : ffff800084e04748
x2 : 0000000000000001 x1 : 00000000fead71c7 x0 : 0000000000000000
Call trace:
dev\_index\_reserve+0x104/0x210
register\_netdevice+0x598/0x1074 net/core/dev.c:10084
tun\_set\_iff+0x630/0xb0c drivers/net/tun.c:2850
\_\_tun\_chr\_ioctl+0x788/0x2af8 drivers/net/tun.c:3118
tun\_chr\_ioctl+0x38/0x4c drivers/net/tun.c:3403
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:871 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:857 [inline]
\_\_arm64\_sys\_ioctl+0x14c/0x1c8 fs/ioctl.c:857
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:37 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:51
el0\_svc\_common+0x130/0x23c arch/arm64/kernel/syscall.c:136
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:155
el0\_svc+0x58/0x16c arch/arm64/kernel/entry-common.c:678
el0t\_64\_sync\_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:696
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:595
irq event stamp: 11348
hardirqs last enabled at (11347): [] \_\_raw\_spin\_unlock\_irqrestore include/linux/spinlock\_api\_smp.h:151 [inline]
hardirqs last enabled at (11347): [] \_raw\_spin\_unlock\_irqrestore+0x38/0x98 kernel/locking/spinlock.c:194
hardirqs last disabled at (11348): [] el1\_dbg+0x24/0x80 arch/arm64/kernel/entry-common.c:436
softirqs last enabled at (11138): [] spin\_unlock\_bh include/linux/spinlock.h:396 [inline]
softirqs last enabled at (11138): [] release\_sock+0x15c/0x1b0 net/core/sock.c:3531
softirqs last disabled at (11136): [] spin\_lock\_bh include/linux/spinlock.h:356 [inline]
softirqs last disabled at (11136): [] release\_sock+0x3c/0x1b0 net/core/sock.c:3518
Fixes: fb7589a16216 ("tun: Add ability to create tun device with given index")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Reviewed-by: Willem de Bruijn
Acked-by: Jason Wang
Link: https://lore.kernel.org/r/20231016180851.3560092-1-edumazet@google.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 50969e0e05d1768a327e820dee959b81abc030b8
Author: Mateusz Polchlopek
Date: Thu Oct 12 08:31:44 2023 -0400
docs: fix info about representor identification
commit a258c804aa8742763dce694b5e992d7ccf4294f2 upstream.
Update the "How are representors identified?" documentation
subchapter. For newer kernels driver should use
SET\_NETDEV\_DEVLINK\_PORT instead of ndo\_get\_devlink\_port()
callback.
Fixes: 7712b3e966ea ("Merge branch 'net-fix-netdev-to-devlink\_port-linkage-and-expose-to-user'")
Signed-off-by: Mateusz Polchlopek
Reviewed-by: Wojciech Drewek
Reviewed-by: Przemek Kitszel
Reviewed-by: Edward Cree
Link: https://lore.kernel.org/r/20231012123144.15768-1-mateusz.polchlopek@intel.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 5b62f58c828863d891370554893b21e94bc68ff1
Author: Kuniyuki Iwashima
Date: Mon Oct 9 18:38:14 2023 -0700
tcp: Fix listen() warning with v4-mapped-v6 address.
commit 8702cf12e6ba91616a72d684e90357977972991b upstream.
syzbot reported a warning [0] introduced by commit c48ef9c4aed3 ("tcp: Fix
bind() regression for v4-mapped-v6 non-wildcard address.").
After the cited commit, a v4 socket's address matches the corresponding
v4-mapped-v6 tb2 in inet\_bind2\_bucket\_match\_addr(), not vice versa.
During X.X.X.X -> ::ffff:X.X.X.X order bind()s, the second bind() uses
bhash and conflicts properly without checking bhash2 so that we need not
check if a v4-mapped-v6 sk matches the corresponding v4 address tb2 in
inet\_bind2\_bucket\_match\_addr(). However, the repro shows that we need
to check that in a no-conflict case.
The repro bind()s two sockets to the 2-tuples using SO\_REUSEPORT and calls
listen() for the first socket:
from socket import \*
s1 = socket()
s1.setsockopt(SOL\_SOCKET, SO\_REUSEPORT, 1)
s1.bind(('127.0.0.1', 0))
s2 = socket(AF\_INET6)
s2.setsockopt(SOL\_SOCKET, SO\_REUSEPORT, 1)
s2.bind(('::ffff:127.0.0.1', s1.getsockname()[1]))
s1.listen()
The second socket should belong to the first socket's tb2, but the second
bind() creates another tb2 bucket because inet\_bind2\_bucket\_find() returns
NULL in inet\_csk\_get\_port() as the v4-mapped-v6 sk does not match the
corresponding v4 address tb2.
bhash2[] -> tb2(::ffff:X.X.X.X) -> tb2(X.X.X.X)
Then, listen() for the first socket calls inet\_csk\_get\_port(), where the
v4 address matches the v4-mapped-v6 tb2 and WARN\_ON() is triggered.
To avoid that, we need to check if v4-mapped-v6 sk address matches with
the corresponding v4 address tb2 in inet\_bind2\_bucket\_match().
The same checks are needed in inet\_bind2\_bucket\_addr\_match() too, so we
can move all checks there and call it from inet\_bind2\_bucket\_match().
Note that now tb->family is just an address family of tb->(v6\_)?rcv\_saddr
and not of sockets in the bucket. This could be refactored later by
defining tb->rcv\_saddr as tb->v6\_rcv\_saddr.s6\_addr32[3] and prepending
::ffff: when creating v4 tb2.
[0]:
WARNING: CPU: 0 PID: 5049 at net/ipv4/inet\_connection\_sock.c:587 inet\_csk\_get\_port+0xf96/0x2350 net/ipv4/inet\_connection\_sock.c:587
Modules linked in:
CPU: 0 PID: 5049 Comm: syz-executor288 Not tainted 6.6.0-rc2-syzkaller-00018-g2cf0f7156238 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/04/2023
RIP: 0010:inet\_csk\_get\_port+0xf96/0x2350 net/ipv4/inet\_connection\_sock.c:587
Code: 7c 24 08 e8 4c b6 8a 01 31 d2 be 88 01 00 00 48 c7 c7 e0 94 ae 8b e8 59 2e a3 f8 2e 2e 2e 31 c0 e9 04 fe ff ff e8 ca 88 d0 f8 <0f> 0b e9 0f f9 ff ff e8 be 88 d0 f8 49 8d 7e 48 e8 65 ca 5a 00 31
RSP: 0018:ffffc90003abfbf0 EFLAGS: 00010293
RAX: 0000000000000000 RBX: ffff888026429100 RCX: 0000000000000000
RDX: ffff88807edcbb80 RSI: ffffffff88b73d66 RDI: ffff888026c49f38
RBP: ffff888026c49f30 R08: 0000000000000005 R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000000 R12: ffffffff9260f200
R13: ffff888026c49880 R14: 0000000000000000 R15: ffff888026429100
FS: 00005555557d5380(0000) GS:ffff8880b9800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000045ad50 CR3: 0000000025754000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
inet\_csk\_listen\_start+0x155/0x360 net/ipv4/inet\_connection\_sock.c:1256
\_\_inet\_listen\_sk+0x1b8/0x5c0 net/ipv4/af\_inet.c:217
inet\_listen+0x93/0xd0 net/ipv4/af\_inet.c:239
\_\_sys\_listen+0x194/0x270 net/socket.c:1866
\_\_do\_sys\_listen net/socket.c:1875 [inline]
\_\_se\_sys\_listen net/socket.c:1873 [inline]
\_\_x64\_sys\_listen+0x53/0x80 net/socket.c:1873
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x38/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
RIP: 0033:0x7f3a5bce3af9
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 c1 17 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffc1a1c79e8 EFLAGS: 00000246 ORIG\_RAX: 0000000000000032
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f3a5bce3af9
RDX: 00007f3a5bce3af9 RSI: 0000000000000000 RDI: 0000000000000003
RBP: 00007f3a5bd565f0 R08: 0000000000000006 R09: 0000000000000006
R10: 0000000000000006 R11: 0000000000000246 R12: 0000000000000001
R13: 431bde82d7b634db R14: 0000000000000001 R15: 0000000000000001

Fixes: c48ef9c4aed3 ("tcp: Fix bind() regression for v4-mapped-v6 non-wildcard address.")
Reported-by: syzbot+71e724675ba3958edb31@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=71e724675ba3958edb31
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Eric Dumazet
Link: https://lore.kernel.org/r/20231010013814.70571-1-kuniyu@amazon.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 5019131495d5098e5fc8c798d27f694a9791162e
Author: Eric Dumazet
Date: Tue Oct 17 12:45:26 2023 +0000
tcp: tsq: relax tcp\_small\_queue\_check() when rtx queue contains a single skb
commit f921a4a5bffa8a0005b190fb9421a7fc1fd716b6 upstream.
In commit 75eefc6c59fd ("tcp: tsq: add a shortcut in tcp\_small\_queue\_check()")
we allowed to send an skb regardless of TSQ limits being hit if rtx queue
was empty or had a single skb, in order to better fill the pipe
when/if TX completions were slow.
Then later, commit 75c119afe14f ("tcp: implement rb-tree based
retransmit queue") accidentally removed the special case for
one skb in rtx queue.
Stefan Wahren reported a regression in single TCP flow throughput
using a 100Mbit fec link, starting from commit 65466904b015 ("tcp: adjust
TSO packet sizes based on min\_rtt"). This last commit only made the
regression more visible, because it locked the TCP flow on a particular
behavior where TSQ prevented two skbs being pushed downstream,
adding silences on the wire between each TSO packet.
Many thanks to Stefan for his invaluable help !
Fixes: 75c119afe14f ("tcp: implement rb-tree based retransmit queue")
Link: https://lore.kernel.org/netdev/7f31ddc8-9971-495e-a1f6-819df542e0af@gmx.net/
Reported-by: Stefan Wahren
Tested-by: Stefan Wahren
Signed-off-by: Eric Dumazet
Acked-by: Neal Cardwell
Link: https://lore.kernel.org/r/20231017124526.4060202-1-edumazet@google.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit f74b518c4bb7fd1b1185025c23f8ef09a10232bc
Author: Neal Cardwell
Date: Sun Oct 15 13:47:00 2023 -0400
tcp: fix excessive TLP and RACK timeouts from HZ rounding
commit 1c2709cfff1dedbb9591e989e2f001484208d914 upstream.
We discovered from packet traces of slow loss recovery on kernels with
the default HZ=250 setting (and min\_rtt < 1ms) that after reordering,
when receiving a SACKed sequence range, the RACK reordering timer was
firing after about 16ms rather than the desired value of roughly
min\_rtt/4 + 2ms. The problem is largely due to the RACK reorder timer
calculation adding in TCP\_TIMEOUT\_MIN, which is 2 jiffies. On kernels
with HZ=250, this is 2\*4ms = 8ms. The TLP timer calculation has the
exact same issue.
This commit fixes the TLP transmit timer and RACK reordering timer
floor calculation to more closely match the intended 2ms floor even on
kernels with HZ=250. It does this by adding in a new
TCP\_TIMEOUT\_MIN\_US floor of 2000 us and then converting to jiffies,
instead of the current approach of converting to jiffies and then
adding th TCP\_TIMEOUT\_MIN value of 2 jiffies.
Our testing has verified that on kernels with HZ=1000, as expected,
this does not produce significant changes in behavior, but on kernels
with the default HZ=250 the latency improvement can be large. For
example, our tests show that for HZ=250 kernels at low RTTs this fix
roughly halves the latency for the RACK reorder timer: instead of
mostly firing at 16ms it mostly fires at 8ms.
Suggested-by: Eric Dumazet
Signed-off-by: Neal Cardwell
Signed-off-by: Yuchung Cheng
Fixes: bb4d991a28cc ("tcp: adjust tail loss probe timeout")
Reviewed-by: Eric Dumazet
Link: https://lore.kernel.org/r/20231015174700.2206872-1-ncardwell.sw@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit db4cf95a7636f16240d2e9e647828f884c8e63ee
Author: Josua Mayer
Date: Wed Oct 4 18:39:28 2023 +0200
net: rfkill: gpio: prevent value glitch during probe
commit b2f750c3a80b285cd60c9346f8c96bd0a2a66cde upstream.
When either reset- or shutdown-gpio have are initially deasserted,
e.g. after a reboot - or when the hardware does not include pull-down,
there will be a short toggle of both IOs to logical 0 and back to 1.
It seems that the rfkill default is unblocked, so the driver should not
glitch to output low during probe.
It can lead e.g. to unexpected lte modem reconnect:
[1] root@localhost:~# dmesg | grep "usb 2-1"
[ 2.136124] usb 2-1: new SuperSpeed USB device number 2 using xhci-hcd
[ 21.215278] usb 2-1: USB disconnect, device number 2
[ 28.833977] usb 2-1: new SuperSpeed USB device number 3 using xhci-hcd
The glitch has been discovered on an arm64 board, now that device-tree
support for the rfkill-gpio driver has finally appeared :).
Change the flags for devm\_gpiod\_get\_optional from GPIOD\_OUT\_LOW to
GPIOD\_ASIS to avoid any glitches.
The rfkill driver will set the intended value during rfkill\_sync\_work.
Fixes: 7176ba23f8b5 ("net: rfkill: add generic gpio rfkill driver")
Signed-off-by: Josua Mayer
Link: https://lore.kernel.org/r/20231004163928.14609-1-josua@solid-run.com
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit c5b46524c3678c25b1c75399338bb518a97a622d
Author: Ma Ke
Date: Sat Oct 7 08:59:53 2023 +0800
net: ipv6: fix return value check in esp\_remove\_trailer
commit dad4e491e30b20f4dc615c9da65d2142d703b5c2 upstream.
In esp\_remove\_trailer(), to avoid an unexpected result returned by
pskb\_trim, we should check the return value of pskb\_trim().
Signed-off-by: Ma Ke
Signed-off-by: Steffen Klassert
Signed-off-by: Greg Kroah-Hartman
commit 10b6501383791fe2dddab7d3cbf9f12b95209418
Author: Ma Ke
Date: Mon Oct 9 09:13:37 2023 +0800
net: ipv4: fix return value check in esp\_remove\_trailer
commit 513f61e2193350c7a345da98559b80f61aec4fa6 upstream.
In esp\_remove\_trailer(), to avoid an unexpected result returned by
pskb\_trim, we should check the return value of pskb\_trim().
Signed-off-by: Ma Ke
Signed-off-by: Steffen Klassert
Signed-off-by: Greg Kroah-Hartman
commit 89ffd5e26ec3c1379468c1ad2ab2053b085895fa
Author: Johannes Berg
Date: Mon Oct 9 10:18:01 2023 +0200
wifi: cfg80211: use system\_unbound\_wq for wiphy work
commit 91d20ab9d9ca035527af503d00e1e30d6c375f2a upstream.
Since wiphy work items can run pretty much arbitrary
code in the stack/driver, it can take longer to run
all of this, so we shouldn't be using system\_wq via
schedule\_work(). Also, we lock the wiphy (which is
the reason this exists), so use system\_unbound\_wq.
Reported-and-tested-by: Kalle Valo
Fixes: a3ee4dc84c4e ("wifi: cfg80211: add a work abstraction with special semantics")
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit c91f8adb7414c9b3043d6a121e70e7e0fbde6a1f
Author: Masami Hiramatsu (Google)
Date: Tue Oct 17 08:49:45 2023 +0900
fprobe: Fix to ensure the number of active retprobes is not zero
commit 700b2b439766e8aab8a7174991198497345bd411 upstream.
The number of active retprobes can be zero but it is not acceptable,
so return EINVAL error if detected.
Link: https://lore.kernel.org/all/169750018550.186853.11198884812017796410.stgit@devnote2/
Reported-by: wuqiang.matt
Closes: https://lore.kernel.org/all/20231016222103.cb9f426edc60220eabd8aa6a@kernel.org/
Fixes: 5b0ab78998e3 ("fprobe: Add exit\_handler support")
Signed-off-by: Masami Hiramatsu (Google)
Signed-off-by: Greg Kroah-Hartman
commit e0cc481c1fa0c67f02cde340913f02fdb4d006dd
Author: Dong Chenchen
Date: Tue Aug 15 22:18:34 2023 +0800
net: xfrm: skip policies marked as dead while reinserting policies
commit 6d41d4fe28724db16ca1016df0713a07e0cc7448 upstream.
BUG: KASAN: slab-use-after-free in xfrm\_policy\_inexact\_list\_reinsert+0xb6/0x430
Read of size 1 at addr ffff8881051f3bf8 by task ip/668
CPU: 2 PID: 668 Comm: ip Not tainted 6.5.0-rc5-00182-g25aa0bebba72-dirty #64
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.13 04/01/2014
Call Trace:
dump\_stack\_lvl+0x72/0xa0
print\_report+0xd0/0x620
kasan\_report+0xb6/0xf0
xfrm\_policy\_inexact\_list\_reinsert+0xb6/0x430
xfrm\_policy\_inexact\_insert\_node.constprop.0+0x537/0x800
xfrm\_policy\_inexact\_alloc\_chain+0x23f/0x320
xfrm\_policy\_inexact\_insert+0x6b/0x590
xfrm\_policy\_insert+0x3b1/0x480
xfrm\_add\_policy+0x23c/0x3c0
xfrm\_user\_rcv\_msg+0x2d0/0x510
netlink\_rcv\_skb+0x10d/0x2d0
xfrm\_netlink\_rcv+0x49/0x60
netlink\_unicast+0x3fe/0x540
netlink\_sendmsg+0x528/0x970
sock\_sendmsg+0x14a/0x160
\_\_\_\_sys\_sendmsg+0x4fc/0x580
\_\_\_sys\_sendmsg+0xef/0x160
\_\_sys\_sendmsg+0xf7/0x1b0
do\_syscall\_64+0x3f/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x73/0xdd
The root cause is:
cpu 0 cpu1
xfrm\_dump\_policy
xfrm\_policy\_walk
list\_move\_tail
xfrm\_add\_policy
... ...
xfrm\_policy\_inexact\_list\_reinsert
list\_for\_each\_entry\_reverse
if (!policy->bydst\_reinsert)
//read non-existent policy
xfrm\_dump\_policy\_done
xfrm\_policy\_walk\_done
list\_del(&walk->walk.all);
If dump\_one\_policy() returns err (triggered by netlink socket),
xfrm\_policy\_walk() will move walk initialized by socket to list
net->xfrm.policy\_all. so this socket becomes visible in the global
policy list. The head \*walk can be traversed when users add policies
with different prefixlen and trigger xfrm\_policy node merge.
The issue can also be triggered by policy list traversal while rehashing
and flushing policies.
It can be fixed by skip such "policies" with walk.dead set to 1.
Fixes: 9cf545ebd591 ("xfrm: policy: store inexact policies in a tree ordered by destination address")
Fixes: 12a169e7d8f4 ("ipsec: Put dumpers on the dump list")
Signed-off-by: Dong Chenchen
Signed-off-by: Steffen Klassert
Signed-off-by: Greg Kroah-Hartman
commit 071bba39638f6532040aca3bdabba469186f631c
Author: Eric Dumazet
Date: Tue Sep 5 13:23:03 2023 +0000
xfrm: interface: use DEV\_STATS\_INC()
commit f7c4e3e5d4f6609b4725a97451948ca2e425379a upstream.
syzbot/KCSAN reported data-races in xfrm whenever dev->stats fields
are updated.
It appears all of these updates can happen from multiple cpus.
Adopt SMP safe DEV\_STATS\_INC() to update dev->stats fields.
BUG: KCSAN: data-race in xfrmi\_xmit / xfrmi\_xmit
read-write to 0xffff88813726b160 of 8 bytes by task 23986 on cpu 1:
xfrmi\_xmit+0x74e/0xb20 net/xfrm/xfrm\_interface\_core.c:583
\_\_netdev\_start\_xmit include/linux/netdevice.h:4889 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4903 [inline]
xmit\_one net/core/dev.c:3544 [inline]
dev\_hard\_start\_xmit+0x11b/0x3f0 net/core/dev.c:3560
\_\_dev\_queue\_xmit+0xeee/0x1de0 net/core/dev.c:4340
dev\_queue\_xmit include/linux/netdevice.h:3082 [inline]
neigh\_connected\_output+0x231/0x2a0 net/core/neighbour.c:1581
neigh\_output include/net/neighbour.h:542 [inline]
ip\_finish\_output2+0x74a/0x850 net/ipv4/ip\_output.c:230
ip\_finish\_output+0xf4/0x240 net/ipv4/ip\_output.c:318
NF\_HOOK\_COND include/linux/netfilter.h:293 [inline]
ip\_output+0xe5/0x1b0 net/ipv4/ip\_output.c:432
dst\_output include/net/dst.h:458 [inline]
ip\_local\_out net/ipv4/ip\_output.c:127 [inline]
ip\_send\_skb+0x72/0xe0 net/ipv4/ip\_output.c:1487
udp\_send\_skb+0x6a4/0x990 net/ipv4/udp.c:963
udp\_sendmsg+0x1249/0x12d0 net/ipv4/udp.c:1246
inet\_sendmsg+0x63/0x80 net/ipv4/af\_inet.c:840
sock\_sendmsg\_nosec net/socket.c:730 [inline]
sock\_sendmsg net/socket.c:753 [inline]
\_\_\_\_sys\_sendmsg+0x37c/0x4d0 net/socket.c:2540
\_\_\_sys\_sendmsg net/socket.c:2594 [inline]
\_\_sys\_sendmmsg+0x269/0x500 net/socket.c:2680
\_\_do\_sys\_sendmmsg net/socket.c:2709 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2706 [inline]
\_\_x64\_sys\_sendmmsg+0x57/0x60 net/socket.c:2706
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
read-write to 0xffff88813726b160 of 8 bytes by task 23987 on cpu 0:
xfrmi\_xmit+0x74e/0xb20 net/xfrm/xfrm\_interface\_core.c:583
\_\_netdev\_start\_xmit include/linux/netdevice.h:4889 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4903 [inline]
xmit\_one net/core/dev.c:3544 [inline]
dev\_hard\_start\_xmit+0x11b/0x3f0 net/core/dev.c:3560
\_\_dev\_queue\_xmit+0xeee/0x1de0 net/core/dev.c:4340
dev\_queue\_xmit include/linux/netdevice.h:3082 [inline]
neigh\_connected\_output+0x231/0x2a0 net/core/neighbour.c:1581
neigh\_output include/net/neighbour.h:542 [inline]
ip\_finish\_output2+0x74a/0x850 net/ipv4/ip\_output.c:230
ip\_finish\_output+0xf4/0x240 net/ipv4/ip\_output.c:318
NF\_HOOK\_COND include/linux/netfilter.h:293 [inline]
ip\_output+0xe5/0x1b0 net/ipv4/ip\_output.c:432
dst\_output include/net/dst.h:458 [inline]
ip\_local\_out net/ipv4/ip\_output.c:127 [inline]
ip\_send\_skb+0x72/0xe0 net/ipv4/ip\_output.c:1487
udp\_send\_skb+0x6a4/0x990 net/ipv4/udp.c:963
udp\_sendmsg+0x1249/0x12d0 net/ipv4/udp.c:1246
inet\_sendmsg+0x63/0x80 net/ipv4/af\_inet.c:840
sock\_sendmsg\_nosec net/socket.c:730 [inline]
sock\_sendmsg net/socket.c:753 [inline]
\_\_\_\_sys\_sendmsg+0x37c/0x4d0 net/socket.c:2540
\_\_\_sys\_sendmsg net/socket.c:2594 [inline]
\_\_sys\_sendmmsg+0x269/0x500 net/socket.c:2680
\_\_do\_sys\_sendmmsg net/socket.c:2709 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2706 [inline]
\_\_x64\_sys\_sendmmsg+0x57/0x60 net/socket.c:2706
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x00000000000010d7 -> 0x00000000000010d8
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 23987 Comm: syz-executor.5 Not tainted 6.5.0-syzkaller-10885-g0468be89b3fa #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/26/2023
Fixes: f203b76d7809 ("xfrm: Add virtual xfrm interfaces")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Cc: Steffen Klassert
Signed-off-by: Steffen Klassert
Signed-off-by: Greg Kroah-Hartman
commit abfe309fc6dc98273564248a4a71980b6f1067d0
Author: Eric Dumazet
Date: Fri Sep 8 18:13:59 2023 +0000
xfrm: fix a data-race in xfrm\_gen\_index()
commit 3e4bc23926b83c3c67e5f61ae8571602754131a6 upstream.
xfrm\_gen\_index() mutual exclusion uses net->xfrm.xfrm\_policy\_lock.
This means we must use a per-netns idx\_generator variable,
instead of a static one.
Alternative would be to use an atomic variable.
syzbot reported:
BUG: KCSAN: data-race in xfrm\_sk\_policy\_insert / xfrm\_sk\_policy\_insert
write to 0xffffffff87005938 of 4 bytes by task 29466 on cpu 0:
xfrm\_gen\_index net/xfrm/xfrm\_policy.c:1385 [inline]
xfrm\_sk\_policy\_insert+0x262/0x640 net/xfrm/xfrm\_policy.c:2347
xfrm\_user\_policy+0x413/0x540 net/xfrm/xfrm\_state.c:2639
do\_ipv6\_setsockopt+0x1317/0x2ce0 net/ipv6/ipv6\_sockglue.c:943
ipv6\_setsockopt+0x57/0x130 net/ipv6/ipv6\_sockglue.c:1012
rawv6\_setsockopt+0x21e/0x410 net/ipv6/raw.c:1054
sock\_common\_setsockopt+0x61/0x70 net/core/sock.c:3697
\_\_sys\_setsockopt+0x1c9/0x230 net/socket.c:2263
\_\_do\_sys\_setsockopt net/socket.c:2274 [inline]
\_\_se\_sys\_setsockopt net/socket.c:2271 [inline]
\_\_x64\_sys\_setsockopt+0x66/0x80 net/socket.c:2271
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
read to 0xffffffff87005938 of 4 bytes by task 29460 on cpu 1:
xfrm\_sk\_policy\_insert+0x13e/0x640
xfrm\_user\_policy+0x413/0x540 net/xfrm/xfrm\_state.c:2639
do\_ipv6\_setsockopt+0x1317/0x2ce0 net/ipv6/ipv6\_sockglue.c:943
ipv6\_setsockopt+0x57/0x130 net/ipv6/ipv6\_sockglue.c:1012
rawv6\_setsockopt+0x21e/0x410 net/ipv6/raw.c:1054
sock\_common\_setsockopt+0x61/0x70 net/core/sock.c:3697
\_\_sys\_setsockopt+0x1c9/0x230 net/socket.c:2263
\_\_do\_sys\_setsockopt net/socket.c:2274 [inline]
\_\_se\_sys\_setsockopt net/socket.c:2271 [inline]
\_\_x64\_sys\_setsockopt+0x66/0x80 net/socket.c:2271
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x00006ad8 -> 0x00006b18
Reported by Kernel Concurrency Sanitizer on:
CPU: 1 PID: 29460 Comm: syz-executor.1 Not tainted 6.5.0-rc5-syzkaller-00243-g9106536c1aa3 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 07/26/2023
Fixes: 1121994c803f ("netns xfrm: policy insertion in netns")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Cc: Steffen Klassert
Cc: Herbert Xu
Acked-by: Herbert Xu
Signed-off-by: Steffen Klassert
Signed-off-by: Greg Kroah-Hartman
commit 71998cd436fd1951d884e2515957b87be34a4372
Author: Zhang Changzhong
Date: Fri Sep 15 19:20:41 2023 +0800
xfrm6: fix inet6\_dev refcount underflow problem
commit cc9b364bb1d58d3dae270c7a931a8cc717dc2b3b upstream.
There are race conditions that may lead to inet6\_dev refcount underflow
in xfrm6\_dst\_destroy() and rt6\_uncached\_list\_flush\_dev().
One of the refcount underflow bugs is shown below:
(cpu 1) | (cpu 2)
xfrm6\_dst\_destroy() |
... |
in6\_dev\_put() |
| rt6\_uncached\_list\_flush\_dev()
... | ...
| in6\_dev\_put()
rt6\_uncached\_list\_del() | ...
... |
xfrm6\_dst\_destroy() calls rt6\_uncached\_list\_del() after in6\_dev\_put(),
so rt6\_uncached\_list\_flush\_dev() has a chance to call in6\_dev\_put()
again for the same inet6\_dev.
Fix it by moving in6\_dev\_put() after rt6\_uncached\_list\_del() in
xfrm6\_dst\_destroy().
Fixes: 510c321b5571 ("xfrm: reuse uncached\_list to track xdsts")
Signed-off-by: Zhang Changzhong
Reviewed-by: Xin Long
Signed-off-by: Steffen Klassert
Signed-off-by: Greg Kroah-Hartman
commit de0bfd6026c85de3a0a0db2766ab740733d1631e
Author: Eric Dumazet
Date: Wed Oct 11 10:24:29 2023 +0000
xfrm: fix a data-race in xfrm\_lookup\_with\_ifid()
commit de5724ca38fd5e442bae9c1fab31942b6544012d upstream.
syzbot complains about a race in xfrm\_lookup\_with\_ifid() [1]
When preparing commit 0a9e5794b21e ("xfrm: annotate data-race
around use\_time") I thought xfrm\_lookup\_with\_ifid() was modifying
a still private structure.
[1]
BUG: KCSAN: data-race in xfrm\_lookup\_with\_ifid / xfrm\_lookup\_with\_ifid
write to 0xffff88813ea41108 of 8 bytes by task 8150 on cpu 1:
xfrm\_lookup\_with\_ifid+0xce7/0x12d0 net/xfrm/xfrm\_policy.c:3218
xfrm\_lookup net/xfrm/xfrm\_policy.c:3270 [inline]
xfrm\_lookup\_route+0x3b/0x100 net/xfrm/xfrm\_policy.c:3281
ip6\_dst\_lookup\_flow+0x98/0xc0 net/ipv6/ip6\_output.c:1246
send6+0x241/0x3c0 drivers/net/wireguard/socket.c:139
wg\_socket\_send\_skb\_to\_peer+0xbd/0x130 drivers/net/wireguard/socket.c:178
wg\_socket\_send\_buffer\_to\_peer+0xd6/0x100 drivers/net/wireguard/socket.c:200
wg\_packet\_send\_handshake\_initiation drivers/net/wireguard/send.c:40 [inline]
wg\_packet\_handshake\_send\_worker+0x10c/0x150 drivers/net/wireguard/send.c:51
process\_one\_work kernel/workqueue.c:2630 [inline]
process\_scheduled\_works+0x5b8/0xa30 kernel/workqueue.c:2703
worker\_thread+0x525/0x730 kernel/workqueue.c:2784
kthread+0x1d7/0x210 kernel/kthread.c:388
ret\_from\_fork+0x48/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304
write to 0xffff88813ea41108 of 8 bytes by task 15867 on cpu 0:
xfrm\_lookup\_with\_ifid+0xce7/0x12d0 net/xfrm/xfrm\_policy.c:3218
xfrm\_lookup net/xfrm/xfrm\_policy.c:3270 [inline]
xfrm\_lookup\_route+0x3b/0x100 net/xfrm/xfrm\_policy.c:3281
ip6\_dst\_lookup\_flow+0x98/0xc0 net/ipv6/ip6\_output.c:1246
send6+0x241/0x3c0 drivers/net/wireguard/socket.c:139
wg\_socket\_send\_skb\_to\_peer+0xbd/0x130 drivers/net/wireguard/socket.c:178
wg\_socket\_send\_buffer\_to\_peer+0xd6/0x100 drivers/net/wireguard/socket.c:200
wg\_packet\_send\_handshake\_initiation drivers/net/wireguard/send.c:40 [inline]
wg\_packet\_handshake\_send\_worker+0x10c/0x150 drivers/net/wireguard/send.c:51
process\_one\_work kernel/workqueue.c:2630 [inline]
process\_scheduled\_works+0x5b8/0xa30 kernel/workqueue.c:2703
worker\_thread+0x525/0x730 kernel/workqueue.c:2784
kthread+0x1d7/0x210 kernel/kthread.c:388
ret\_from\_fork+0x48/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304
value changed: 0x00000000651cd9d1 -> 0x00000000651cd9d2
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 15867 Comm: kworker/u4:58 Not tainted 6.6.0-rc4-syzkaller-00016-g5e62ed3b1c8a #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 09/06/2023
Workqueue: wg-kex-wg2 wg\_packet\_handshake\_send\_worker
Fixes: 0a9e5794b21e ("xfrm: annotate data-race around use\_time")
Reported-by: syzbot
Signed-off-by: Eric Dumazet
Cc: Steffen Klassert
Signed-off-by: Steffen Klassert
Signed-off-by: Greg Kroah-Hartman
commit 40aa935e9e6b4699bd8b8078a028556c395bf1d2
Author: Manish Chopra
Date: Fri Oct 13 18:48:12 2023 +0530
qed: fix LL2 RX buffer allocation
commit 2f3389c73832ad90b63208c0fc281ad080114c7a upstream.
Driver allocates the LL2 rx buffers from kmalloc()
area to construct the skb using slab\_build\_skb()
The required size allocation seems to have overlooked
for accounting both skb\_shared\_info size and device
placement padding bytes which results into the below
panic when doing skb\_put() for a standard MTU sized frame.
skbuff: skb\_over\_panic: text:ffffffffc0b0225f len:1514 put:1514
head:ff3dabceaf39c000 data:ff3dabceaf39c042 tail:0x62c end:0x566
dev:
…
skb\_panic+0x48/0x4a
skb\_put.cold+0x10/0x10
qed\_ll2b\_complete\_rx\_packet+0x14f/0x260 [qed]
qed\_ll2\_rxq\_handle\_completion.constprop.0+0x169/0x200 [qed]
qed\_ll2\_rxq\_completion+0xba/0x320 [qed]
qed\_int\_sp\_dpc+0x1a7/0x1e0 [qed]
This patch fixes this by accouting skb\_shared\_info and device
placement padding size bytes when allocating the buffers.
Cc: David S. Miller
Fixes: 0a7fb11c23c0 ("qed: Add Light L2 support")
Signed-off-by: Manish Chopra
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 27e7ea6c3ad86982129d47cd1b08903aedaff9ae
Author: Johan Hovold
Date: Tue Oct 3 17:55:56 2023 +0200
ASoC: codecs: wcd938x: fix runtime PM imbalance on remove
commit 3ebebb2c1eca92a15107b2d7aeff34196fd9e217 upstream.
Make sure to balance the runtime PM operations, including the disable
count, on driver unbind.
Fixes: 16572522aece ("ASoC: codecs: wcd938x-sdw: add SoundWire driver")
Cc: stable@vger.kernel.org # 5.14
Cc: Srinivas Kandagatla
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20231003155558.27079-6-johan+linaro@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit f0c191c0977ac9a9bfb7079716320eea2fee06a5
Author: Johan Hovold
Date: Tue Oct 3 17:55:55 2023 +0200
ASoC: codecs: wcd938x: fix regulator leaks on probe errors
commit 69a026a2357ee69983690d07976de44ef26ee38a upstream.
Make sure to disable and free the regulators on probe errors and on
driver unbind.
Fixes: 16572522aece ("ASoC: codecs: wcd938x-sdw: add SoundWire driver")
Cc: stable@vger.kernel.org # 5.14
Cc: Srinivas Kandagatla
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20231003155558.27079-5-johan+linaro@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 3d4a0f272ff2a6027677e95d76900319fc1b865a
Author: Johan Hovold
Date: Tue Oct 3 17:55:54 2023 +0200
ASoC: codecs: wcd938x: fix resource leaks on bind errors
commit da29b94ed3547cee9d510d02eca4009f2de476cf upstream.
Add the missing code to release resources on bind errors, including the
references taken by wcd938x\_sdw\_device\_get() which also need to be
dropped on unbind().
Fixes: 16572522aece ("ASoC: codecs: wcd938x-sdw: add SoundWire driver")
Cc: stable@vger.kernel.org # 5.14
Cc: Srinivas Kandagatla
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20231003155558.27079-4-johan+linaro@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 6165999b6f653f14c6ceddf83c8db3f4243452a5
Author: Johan Hovold
Date: Tue Oct 3 17:55:53 2023 +0200
ASoC: codecs: wcd938x: fix unbind tear down order
commit fa2f8a991ba4aa733ac1c3b1be0c86148aa4c52c upstream.
Make sure to deregister the component before tearing down the resources
it depends on during unbind().
Fixes: 16572522aece ("ASoC: codecs: wcd938x-sdw: add SoundWire driver")
Cc: stable@vger.kernel.org # 5.14
Cc: Srinivas Kandagatla
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20231003155558.27079-3-johan+linaro@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 2324407dbdfaf29511a56590ca9809d3c97c4e25
Author: Johan Hovold
Date: Tue Oct 3 17:55:52 2023 +0200
ASoC: codecs: wcd938x: drop bogus bind error handling
commit bfbc79de60c53e5fed505390440b87ef59ee268c upstream.
Drop the bogus error handling for a soundwire device backcast during
bind() that cannot fail.
Fixes: 16572522aece ("ASoC: codecs: wcd938x-sdw: add SoundWire driver")
Cc: stable@vger.kernel.org # 5.14
Cc: Srinivas Kandagatla
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20231003155558.27079-2-johan+linaro@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit ea75399184ec73548b30dded9fad9d1ee057fb9c
Author: Johan Hovold
Date: Tue Oct 3 17:55:58 2023 +0200
ASoC: codecs: wcd938x-sdw: fix runtime PM imbalance on probe errors
commit c5c0383082eace13da2ffceeea154db2780165e7 upstream.
Make sure to balance the runtime PM operations, including the disable
count, on probe errors and on driver unbind.
Fixes: 16572522aece ("ASoC: codecs: wcd938x-sdw: add SoundWire driver")
Cc: stable@vger.kernel.org # 5.14
Cc: Srinivas Kandagatla
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20231003155558.27079-8-johan+linaro@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit fe672874b96871cd176c50a612d1beab7bffa729
Author: Johan Hovold
Date: Tue Oct 3 17:55:57 2023 +0200
ASoC: codecs: wcd938x-sdw: fix use after free on driver unbind
commit f0dfdcbe706462495d47982eecd13a61aabd644d upstream.
Make sure to deregister the component when the driver is being unbound
and before the underlying device-managed resources are freed.
Fixes: 16572522aece ("ASoC: codecs: wcd938x-sdw: add SoundWire driver")
Cc: stable@vger.kernel.org # 5.14
Cc: Srinivas Kandagatla
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20231003155558.27079-7-johan+linaro@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 15d4d00e27dff0a62942901b0dea7ecfccff4458
Author: Luka Guzenko
Date: Tue Oct 17 00:13:28 2023 +0200
ALSA: hda/relatek: Enable Mute LED on HP Laptop 15s-fq5xxx
commit 56e85993896b914032d11e32ecbf8415e7b2f621 upstream.
This HP Laptop uses ALC236 codec with COEF 0x07 controlling the
mute LED. Enable existing quirk for this device.
Signed-off-by: Luka Guzenko
Cc:
Link: https://lore.kernel.org/r/20231016221328.1521674-1-l.guzenko@web.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 302a721307ada3b0899caadf814d34967423016e
Author: Artem Borisov
Date: Sat Oct 14 10:50:42 2023 +0300
ALSA: hda/realtek: Add quirk for ASUS ROG GU603ZV
commit 5dedc9f53eef7ec07b23686381100d03fb259f50 upstream.
Enables the SPI-connected Cirrus amp and the required pins
for headset mic detection.
As of BIOS version 313 it is still necessary to modify the
ACPI table to add the related \_DSD properties:
https://gist.github.com/Flex1911/1bce378645fc95a5743671bd5deabfc8
Signed-off-by: Artem Borisov
Cc:
Link: https://lore.kernel.org/r/20231014075044.17474-1-dedsa2002@gmail.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 56d5acef3b3cb7708f27ba7ade65b95cfff6e2be
Author: Kailang Yang
Date: Tue Oct 17 15:30:24 2023 +0800
ALSA: hda/realtek - Fixed ASUS platform headset Mic issue
commit c8c0a03ec1be6b3f3ec1ce91685351235212db19 upstream.
ASUS platform Headset Mic was disable by default.
Assigned verb table for Mic pin will enable it.
Signed-off-by: Kailang Yang
Cc:
Link: https://lore.kernel.org/r/1155d914c20c40569f56d36c79254879@realtek.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ac1084e2b0b46830a4dc91ce69a5adb7506b70a9
Author: Hamza Mahfooz
Date: Thu Oct 12 14:49:27 2023 -0400
drm/edid: add 8 bpc quirk to the BenQ GW2765
commit 88630e91f12677848c0c4a5790ec0d691f8859fa upstream.
The BenQ GW2765 reports that it supports higher (> 8) bpc modes, but
when trying to set them we end up with a black screen. So, limit it to 8
bpc modes.
Cc: stable@vger.kernel.org # 6.5+
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2610
Reviewed-by: Harry Wentland
Signed-off-by: Hamza Mahfooz
Link: https://patchwork.freedesktop.org/patch/msgid/20231012184927.133137-1-hamza.mahfooz@amd.com
Signed-off-by: Greg Kroah-Hartman
commit 6eb4a83e612af65bab8492957cba5813c1a5e538
Author: Karol Herbst
Date: Wed Oct 11 13:41:34 2023 +0200
drm/nouveau/disp: fix DP capable DSM connectors
commit 4366faf43308bd91c59a20c43a9f853a9c3bb6e4 upstream.
Just special case DP DSM connectors until we properly figure out how to
deal with this.
This resolves user regressions on GPUs with such connectors without
reverting the original fix.
Cc: Lyude Paul
Cc: stable@vger.kernel.org # 6.4+
Closes: https://gitlab.freedesktop.org/drm/nouveau/-/issues/255
Fixes: 2b5d1c29f6c4 ("drm/nouveau/disp: PIOR DP uses GPIO for HPD, not PMGR AUX interrupts")
Signed-off-by: Karol Herbst
Reviewed-by: Lyude Paul
Link: https://patchwork.freedesktop.org/patch/msgid/20231011114134.861818-1-kherbst@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit aa01884d65016ba2b528ba1704d8772f181426f3
Author: Chen-Yu Tsai
Date: Wed Oct 4 16:32:24 2023 +0800
drm/mediatek: Correctly free sg\_table in gem prime vmap
commit dcc583c225e659d5da34b4ad83914fd6b51e3dbf upstream.
The MediaTek DRM driver implements GEM PRIME vmap by fetching the
sg\_table for the object, iterating through the pages, and then
vmapping them. In essence, unlike the GEM DMA helpers which vmap
when the object is first created or imported, the MediaTek version
does it on request.
Unfortunately, the code never correctly frees the sg\_table contents.
This results in a kernel memory leak. On a Hayato device with a text
console on the internal display, this results in the system running
out of memory in a few days from all the console screen cursor updates.
Add sg\_free\_table() to correctly free the contents of the sg\_table. This
was missing despite explicitly required by mtk\_gem\_prime\_get\_sg\_table().
Also move the "out" shortcut label to after the kfree() call for the
sg\_table. Having sg\_free\_table() together with kfree() makes more sense.
The shortcut is only used when the object already has a kernel address,
in which case the pointer is NULL and kfree() does nothing. Hence this
change causes no functional change.
Fixes: 3df64d7b0a4f ("drm/mediatek: Implement gem prime vmap/vunmap function")
Cc:
Signed-off-by: Chen-Yu Tsai
Reviewed-by: CK Hu
Link: https://patchwork.kernel.org/project/dri-devel/patch/20231004083226.1940055-1-wenst@chromium.org/
Signed-off-by: Chun-Kuang Hu
Signed-off-by: Greg Kroah-Hartman
commit 2c9e90773fab4ac6ee22a3000f239b3c36aa4128
Author: Ville Syrjälä
Date: Thu Oct 12 16:28:01 2023 +0300
drm/i915: Retry gtt fault when out of fence registers
commit e339c6d628fe66c9b64bf31040a55770952aec57 upstream.
If we can't find a free fence register to handle a fault in the GMADR
range just return VM\_FAULT\_NOPAGE without populating the PTE so that
userspace will retry the access and trigger another fault. Eventually
we should find a free fence and the fault will get properly handled.
A further improvement idea might be to reserve a fence (or one per CPU?)
for the express purpose of handling faults without having to retry. But
that would require some additional work.
Looks like this may have gotten broken originally by
commit 39965b376601 ("drm/i915: don't trash the gtt when running out of fences")
as that changed the errno to -EDEADLK which wasn't handle by the gtt
fault code either. But later in commit 2feeb52859fc ("drm/i915/gt: Fix
-EDEADLK handling regression") I changed it again to -ENOBUFS as -EDEADLK
was now getting used for the ww mutex dance. So this fix only makes
sense after that last commit.
Cc: stable@vger.kernel.org
Closes: https://gitlab.freedesktop.org/drm/intel/-/issues/9479
Fixes: 2feeb52859fc ("drm/i915/gt: Fix -EDEADLK handling regression")
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20231012132801.16292-1-ville.syrjala@linux.intel.com
Reviewed-by: Andi Shyti
(cherry picked from commit 7f403caabe811b88ab0de3811ff3f4782c415761)
Signed-off-by: Rodrigo Vivi
Signed-off-by: Greg Kroah-Hartman
commit 675f0e9bb716fa3252979145b9b1a950140e94e9
Author: Sagi Grimberg
Date: Mon Oct 2 13:54:28 2023 +0300
nvmet-tcp: Fix a possible UAF in queue intialization setup
commit d920abd1e7c4884f9ecd0749d1921b7ab19ddfbd upstream.
From Alon:
"Due to a logical bug in the NVMe-oF/TCP subsystem in the Linux kernel,
a malicious user can cause a UAF and a double free, which may lead to
RCE (may also lead to an LPE in case the attacker already has local
privileges)."
Hence, when a queue initialization fails after the ahash requests are
allocated, it is guaranteed that the queue removal async work will be
called, hence leave the deallocation to the queue removal.
Also, be extra careful not to continue processing the socket, so set
queue rcv\_state to NVMET\_TCP\_RECV\_ERR upon a socket error.
Cc: stable@vger.kernel.org
Reported-by: Alon Zahavi
Tested-by: Alon Zahavi
Signed-off-by: Sagi Grimberg
Reviewed-by: Christoph Hellwig
Reviewed-by: Chaitanya Kulkarni
Signed-off-by: Keith Busch
Signed-off-by: Greg Kroah-Hartman
commit 7053f66e945de2a1429bb0446710d54ded670926
Author: Jens Axboe
Date: Wed Oct 18 08:09:27 2023 -0600
io\_uring: fix crash with IORING\_SETUP\_NO\_MMAP and invalid SQ ring address
commit 8b51a3956d44ea6ade962874ade14de9a7d16556 upstream.
If we specify a valid CQ ring address but an invalid SQ ring address,
we'll correctly spot this and free the allocated pages and clear them
to NULL. However, we don't clear the ring page count, and hence will
attempt to free the pages again. We've already cleared the address of
the page array when freeing them, but we don't check for that. This
causes the following crash:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
Oops [#1]
Modules linked in:
CPU: 0 PID: 20 Comm: kworker/u2:1 Not tainted 6.6.0-rc5-dirty #56
Hardware name: ucbbar,riscvemu-bare (DT)
Workqueue: events\_unbound io\_ring\_exit\_work
epc : io\_pages\_free+0x2a/0x58
ra : io\_rings\_free+0x3a/0x50
epc : ffffffff808811a2 ra : ffffffff80881406 sp : ffff8f80000c3cd0
status: 0000000200000121 badaddr: 0000000000000000 cause: 000000000000000d
[] io\_pages\_free+0x2a/0x58
[] io\_rings\_free+0x3a/0x50
[] io\_ring\_exit\_work+0x37e/0x424
[] process\_one\_work+0x10c/0x1f4
[] worker\_thread+0x252/0x31c
[] kthread+0xc4/0xe0
[] ret\_from\_fork+0xa/0x1c
Check for a NULL array in io\_pages\_free(), but also clear the page counts
when we free them to be on the safer side.
Reported-by: rtm@csail.mit.edu
Fixes: 03d89a2de25b ("io\_uring: support for user allocated memory for rings/sqes")
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Moyer
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 55b97a33e5aafd3a53eb74aa7bf3b1e9a01a3de4
Author: Florian Westphal
Date: Sun Oct 8 19:36:53 2023 +0200
netfilter: nft\_payload: fix wrong mac header matching
commit d351c1ea2de3e36e608fc355d8ae7d0cc80e6cd6 upstream.
mcast packets get looped back to the local machine.
Such packets have a 0-length mac header, we should treat
this like "mac header not set" and abort rule evaluation.
As-is, we just copy data from the network header instead.
Fixes: 96518518cc41 ("netfilter: add nftables")
Reported-by: Blažej Krajňák
Signed-off-by: Florian Westphal
Signed-off-by: Greg Kroah-Hartman
commit fd9c3d0fb4880e3ff37e0a80d0500a0ac16744dd
Author: Bagas Sanjaya
Date: Tue Oct 17 15:08:12 2023 +0700
Revert "net: wwan: iosm: enable runtime pm support for 7560"
commit 1db34aa58d80988f5ee99d2fd9d8f7489c3b0681 upstream.
Runtime power management support breaks Intel LTE modem where dmesg dump
showes timeout errors:
```
[ 72.027442] iosm 0000:01:00.0: msg timeout
[ 72.531638] iosm 0000:01:00.0: msg timeout
[ 73.035414] iosm 0000:01:00.0: msg timeout
[ 73.540359] iosm 0000:01:00.0: msg timeout
```
Furthermore, when shutting down with `poweroff` and modem attached, the
system rebooted instead of powering down as expected. The modem works
again only after power cycling.
Revert runtime power management support for IOSM driver as introduced by
commit e4f5073d53be6c ("net: wwan: iosm: enable runtime pm support for
7560").
Fixes: e4f5073d53be ("net: wwan: iosm: enable runtime pm support for 7560")
Reported-by: Martin
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=217996
Link: https://lore.kernel.org/r/267abf02-4b60-4a2e-92cd-709e3da6f7d3@gmail.com/
Signed-off-by: Bagas Sanjaya
Reviewed-by: Loic Poulain
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9312862d7d03cdc50d79f1444181e42d1b9188c2
Author: Konstantin Komarov
Date: Fri Jun 30 16:22:53 2023 +0400
fs/ntfs3: fix deadlock in mark\_as\_free\_ex
commit bfbe5b31caa74ab97f1784fe9ade5f45e0d3de91 upstream.
Reported-by: syzbot+e94d98936a0ed08bde43@syzkaller.appspotmail.com
Signed-off-by: Konstantin Komarov
Signed-off-by: Greg Kroah-Hartman
commit 93600a9e5d2444c1eab5be2edb4d1815b0cd48f1
Author: Konstantin Komarov
Date: Fri Jun 30 16:25:25 2023 +0400
fs/ntfs3: Fix shift-out-of-bounds in ntfs\_fill\_super
commit 91a4b1ee78cb100b19b70f077c247f211110348f upstream.
Reported-by: syzbot+478c1bf0e6bf4a8f3a04@syzkaller.appspotmail.com
Signed-off-by: Konstantin Komarov
Signed-off-by: Greg Kroah-Hartman
commit 15db99c9c7c7600b5cdd685e6611aebc9bdf969b
Author: Zeng Heng
Date: Thu Apr 20 15:46:22 2023 +0800
fs/ntfs3: fix panic about slab-out-of-bounds caused by ntfs\_list\_ea()
commit 8e7e27b2ee1e19c4040d4987e345f678a74c0aed upstream.
Here is a BUG report about linux-6.1 from syzbot, but it still remains
within upstream:
BUG: KASAN: slab-out-of-bounds in ntfs\_list\_ea fs/ntfs3/xattr.c:191 [inline]
BUG: KASAN: slab-out-of-bounds in ntfs\_listxattr+0x401/0x570 fs/ntfs3/xattr.c:710
Read of size 1 at addr ffff888021acaf3d by task syz-executor128/3632
Call Trace:
kasan\_report+0x139/0x170 mm/kasan/report.c:495
ntfs\_list\_ea fs/ntfs3/xattr.c:191 [inline]
ntfs\_listxattr+0x401/0x570 fs/ntfs3/xattr.c:710
vfs\_listxattr fs/xattr.c:457 [inline]
listxattr+0x293/0x2d0 fs/xattr.c:804
path\_listxattr fs/xattr.c:828 [inline]
\_\_do\_sys\_llistxattr fs/xattr.c:846 [inline]
Before derefering field members of `ea` in unpacked\_ea\_size(), we need to
check whether the EA\_FULL struct is located in access validate range.
Similarly, when derefering `ea->name` field member, we need to check
whethe the ea->name is located in access validate range, too.
Fixes: be71b5cba2e6 ("fs/ntfs3: Add attrib operations")
Reported-by: syzbot+9fcea5ef6dc4dc72d334@syzkaller.appspotmail.com
Signed-off-by: Zeng Heng
[almaz.alexandrovich@paragon-software.com: took the ret variable out of the loop block]
Signed-off-by: Konstantin Komarov
Signed-off-by: Greg Kroah-Hartman
commit ebcabbe6e00f303cfcebc28cbfa34f0efb76259a
Author: Ziqi Zhao
Date: Wed Aug 9 12:11:18 2023 -0700
fs/ntfs3: Fix possible null-pointer dereference in hdr\_find\_e()
commit 1f9b94af923c88539426ed811ae7e9543834a5c5 upstream.
Upon investigation of the C reproducer provided by Syzbot, it seemed
the reproducer was trying to mount a corrupted NTFS filesystem, then
issue a rename syscall to some nodes in the filesystem. This can be
shown by modifying the reproducer to only include the mount syscall,
and investigating the filesystem by e.g. `ls` and `rm` commands. As a
result, during the problematic call to `hdr\_fine\_e`, the `inode` being
supplied did not go through `indx\_init`, hence the `cmp` function
pointer was never set.
The fix is simply to check whether `cmp` is not set, and return NULL
if that's the case, in order to be consistent with other error
scenarios of the `hdr\_find\_e` method. The rationale behind this patch
is that:
- We should prevent crashing the kernel even if the mounted filesystem
is corrupted. Any syscalls made on the filesystem could return
invalid, but the kernel should be able to sustain these calls.
- Only very specific corruption would lead to this bug, so it would be
a pretty rare case in actual usage anyways. Therefore, introducing a
check to specifically protect against this bug seems appropriate.
Because of its rarity, an `unlikely` clause is used to wrap around
this nullity check.
Reported-by: syzbot+60cf892fc31d1f4358fc@syzkaller.appspotmail.com
Signed-off-by: Ziqi Zhao
Signed-off-by: Konstantin Komarov
Signed-off-by: Greg Kroah-Hartman
commit a1f9acb20402c60e633e8e0b88cbae04a47e79d2
Author: Pavel Skripkin
Date: Thu Jul 13 22:41:46 2023 +0300
fs/ntfs3: Fix OOB read in ntfs\_init\_from\_boot
commit 34e6552a442f268eefd408e47f4f2d471aa64829 upstream.
Syzbot was able to create a device which has the last sector of size
512.
After failing to boot from initial sector, reading from boot info from
offset 511 causes OOB read.
To prevent such reports add sanity check to validate if size of buffer\_head
if big enough to hold ntfs3 bootinfo
Fixes: 6a4cd3ea7d77 ("fs/ntfs3: Alternative boot if primary boot is corrupted")
Reported-by: syzbot+53ce40c8c0322c06aea5@syzkaller.appspotmail.com
Signed-off-by: Pavel Skripkin
Signed-off-by: Konstantin Komarov
Signed-off-by: Greg Kroah-Hartman
commit 40cadbcba00c9cf3c8c8bcfd61555f4a2f990e96
Author: Catalin Marinas
Date: Fri Oct 6 17:39:34 2023 +0100
mm: slab: Do not create kmalloc caches smaller than arch\_slab\_minalign()
commit c15cdea517414e0b29a11e0a0e2443d127c9109b upstream.
Commit b035f5a6d852 ("mm: slab: reduce the kmalloc() minimum alignment
if DMA bouncing possible") allows architectures with non-coherent DMA to
define a small ARCH\_KMALLOC\_MINALIGN (e.g. sizeof(unsigned long long))
and this has been enabled on arm64. With KASAN\_HW\_TAGS enabled, however,
ARCH\_SLAB\_MINALIGN becomes 16 on arm64 (arch\_slab\_minalign() dynamically
selects it since commit d949a8155d13 ("mm: make minimum slab alignment a
runtime property")). This can lead to a situation where kmalloc-8 caches
are attempted to be created with a kmem\_caches.size aligned to 16. When
the cache is mergeable, it can lead to kernel warnings like:
sysfs: cannot create duplicate filename '/kernel/slab/:d-0000016'
CPU: 0 PID: 1 Comm: swapper/0 Not tainted 6.6.0-rc1-00001-gda98843cd306-dirty #5
Hardware name: QEMU QEMU Virtual Machine, BIOS 0.0.0 02/06/2015
Call trace:
dump\_backtrace+0x90/0xe8
show\_stack+0x18/0x24
dump\_stack\_lvl+0x48/0x60
dump\_stack+0x18/0x24
sysfs\_warn\_dup+0x64/0x80
sysfs\_create\_dir\_ns+0xe8/0x108
kobject\_add\_internal+0x98/0x264
kobject\_init\_and\_add+0x8c/0xd8
sysfs\_slab\_add+0x12c/0x248
slab\_sysfs\_init+0x98/0x14c
do\_one\_initcall+0x6c/0x1b0
kernel\_init\_freeable+0x1c0/0x288
kernel\_init+0x24/0x1e0
ret\_from\_fork+0x10/0x20
kobject: kobject\_add\_internal failed for :d-0000016 with -EEXIST, don't try to register things with the same name in the same directory.
SLUB: Unable to add boot slab dma-kmalloc-8 to sysfs
Limit the \_\_kmalloc\_minalign() return value (used to create the
kmalloc-\* caches) to arch\_slab\_minalign() so that kmalloc-8 caches are
skipped when KASAN\_HW\_TAGS is enabled (both config and runtime).
Reported-by: Mark Rutland
Fixes: b035f5a6d852 ("mm: slab: reduce the kmalloc() minimum alignment if DMA bouncing possible")
Signed-off-by: Catalin Marinas
Cc: Peter Collingbourne
Cc: stable@vger.kernel.org # 6.5.x
Signed-off-by: Vlastimil Babka
Signed-off-by: Greg Kroah-Hartman
commit a9feea2fee9ce57acedbab82b1bef6ffe0b558ac
Author: Matthieu Baerts
Date: Wed Oct 18 11:23:56 2023 -0700
selftests: mptcp: join: no RST when rm subflow/addr
commit 2cfaa8b3b7aece3c7b13dd10db20dcea65875692 upstream.
Recently, we noticed that some RST were wrongly generated when removing
the initial subflow.
This patch makes sure RST are not sent when removing any subflows or any
addresses.
Fixes: c2b2ae3925b6 ("mptcp: handle correctly disconnect() failures")
Cc: stable@vger.kernel.org
Acked-by: Paolo Abeni
Signed-off-by: Matthieu Baerts
Signed-off-by: Mat Martineau
Link: https://lore.kernel.org/r/20231018-send-net-20231018-v1-5-17ecb002e41d@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit f080044ecc35a9274e2c818557c864301bb776f8
Author: Paolo Abeni
Date: Wed Oct 18 11:23:54 2023 -0700
mptcp: more conservative check for zero probes
commit 72377ab2d671befd6390a1d5677f5cca61235b65 upstream.
Christoph reported that the MPTCP protocol can find the subflow-level
write queue unexpectedly not empty while crafting a zero-window probe,
hitting a warning:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 188 at net/mptcp/protocol.c:1312 mptcp\_sendmsg\_frag+0xc06/0xe70
Modules linked in:
CPU: 0 PID: 188 Comm: kworker/0:2 Not tainted 6.6.0-rc2-g1176aa719d7a #47
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.el7 04/01/2014
Workqueue: events mptcp\_worker
RIP: 0010:mptcp\_sendmsg\_frag+0xc06/0xe70 net/mptcp/protocol.c:1312
RAX: 47d0530de347ff6a RBX: 47d0530de347ff6b RCX: ffff8881015d3c00
RDX: ffff8881015d3c00 RSI: 47d0530de347ff6b RDI: 47d0530de347ff6b
RBP: 47d0530de347ff6b R08: ffffffff8243c6a8 R09: ffffffff82042d9c
R10: 0000000000000002 R11: ffffffff82056850 R12: ffff88812a13d580
R13: 0000000000000001 R14: ffff88812b375e50 R15: ffff88812bbf3200
FS: 0000000000000000(0000) GS:ffff88813bc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000695118 CR3: 0000000115dfc001 CR4: 0000000000170ef0
Call Trace:
\_\_subflow\_push\_pending+0xa4/0x420 net/mptcp/protocol.c:1545
\_\_mptcp\_push\_pending+0x128/0x3b0 net/mptcp/protocol.c:1614
mptcp\_release\_cb+0x218/0x5b0 net/mptcp/protocol.c:3391
release\_sock+0xf6/0x100 net/core/sock.c:3521
mptcp\_worker+0x6e8/0x8f0 net/mptcp/protocol.c:2746
process\_scheduled\_works+0x341/0x690 kernel/workqueue.c:2630
worker\_thread+0x3a7/0x610 kernel/workqueue.c:2784
kthread+0x143/0x180 kernel/kthread.c:388
ret\_from\_fork+0x4d/0x60 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1b/0x30 arch/x86/entry/entry\_64.S:304

The root cause of the issue is that expectations are wrong: e.g. due
to MPTCP-level re-injection we can hit the critical condition.
Explicitly avoid the zero-window probe when the subflow write queue
is not empty and drop the related warnings.
Reported-by: Christoph Paasch
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/444
Fixes: f70cad1085d1 ("mptcp: stop relying on tcp\_tx\_skb\_cache")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau
Signed-off-by: Paolo Abeni
Signed-off-by: Mat Martineau
Link: https://lore.kernel.org/r/20231018-send-net-20231018-v1-3-17ecb002e41d@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit b454bd5583a7cc368f1751ad4e83fb82606a7d86
Author: Paolo Abeni
Date: Wed Oct 18 11:23:53 2023 -0700
tcp: check mptcp-level constraints for backlog coalescing
commit 6db8a37dfc541e059851652cfd4f0bb13b8ff6af upstream.
The MPTCP protocol can acquire the subflow-level socket lock and
cause the tcp backlog usage. When inserting new skbs into the
backlog, the stack will try to coalesce them.
Currently, we have no check in place to ensure that such coalescing
will respect the MPTCP-level DSS, and that may cause data stream
corruption, as reported by Christoph.
Address the issue by adding the relevant admission check for coalescing
in tcp\_add\_backlog().
Note the issue is not easy to reproduce, as the MPTCP protocol tries
hard to avoid acquiring the subflow-level socket lock.
Fixes: 648ef4b88673 ("mptcp: Implement MPTCP receive path")
Cc: stable@vger.kernel.org
Reported-by: Christoph Paasch
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/420
Reviewed-by: Mat Martineau
Signed-off-by: Paolo Abeni
Signed-off-by: Mat Martineau
Link: https://lore.kernel.org/r/20231018-send-net-20231018-v1-2-17ecb002e41d@kernel.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 6952b951ac9b581eb18cc9dfcbafa6969c015ad0
Author: Dan Clash
Date: Thu Oct 12 14:55:18 2023 -0700
audit,io\_uring: io\_uring openat triggers audit reference count underflow
commit 03adc61edad49e1bbecfb53f7ea5d78f398fe368 upstream.
An io\_uring openat operation can update an audit reference count
from multiple threads resulting in the call trace below.
A call to io\_uring\_submit() with a single openat op with a flag of
IOSQE\_ASYNC results in the following reference count updates.
These first part of the system call performs two increments that do not race.
do\_syscall\_64()
\_\_do\_sys\_io\_uring\_enter()
io\_submit\_sqes()
io\_openat\_prep()
\_\_io\_openat\_prep()
getname()
getname\_flags() /\* update 1 (increment) \*/
\_\_audit\_getname() /\* update 2 (increment) \*/
The openat op is queued to an io\_uring worker thread which starts the
opportunity for a race. The system call exit performs one decrement.
do\_syscall\_64()
syscall\_exit\_to\_user\_mode()
syscall\_exit\_to\_user\_mode\_prepare()
\_\_audit\_syscall\_exit()
audit\_reset\_context()
putname() /\* update 3 (decrement) \*/
The io\_uring worker thread performs one increment and two decrements.
These updates can race with the system call decrement.
io\_wqe\_worker()
io\_worker\_handle\_work()
io\_wq\_submit\_work()
io\_issue\_sqe()
io\_openat()
io\_openat2()
do\_filp\_open()
path\_openat()
\_\_audit\_inode() /\* update 4 (increment) \*/
putname() /\* update 5 (decrement) \*/
\_\_audit\_uring\_exit()
audit\_reset\_context()
putname() /\* update 6 (decrement) \*/
The fix is to change the refcnt member of struct audit\_names
from int to atomic\_t.
kernel BUG at fs/namei.c:262!
Call Trace:
...
? putname+0x68/0x70
audit\_reset\_context.part.0.constprop.0+0xe1/0x300
\_\_audit\_uring\_exit+0xda/0x1c0
io\_issue\_sqe+0x1f3/0x450
? lock\_timer\_base+0x3b/0xd0
io\_wq\_submit\_work+0x8d/0x2b0
? \_\_try\_to\_del\_timer\_sync+0x67/0xa0
io\_worker\_handle\_work+0x17c/0x2b0
io\_wqe\_worker+0x10a/0x350
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/lkml/MW2PR2101MB1033FFF044A258F84AEAA584F1C9A@MW2PR2101MB1033.namprd21.prod.outlook.com/
Fixes: 5bd2182d58e9 ("audit,io\_uring,io-wq: add some basic audit support to io\_uring")
Signed-off-by: Dan Clash
Link: https://lore.kernel.org/r/20231012215518.GA4048@linuxonhyperv3.guj3yctzbm1etfxqx2vob5hsef.xx.internal.cloudapp.net
Reviewed-by: Jens Axboe
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit a672863f5645d5fa6426fe406a9ae681347952a4
Author: Maxim Levitsky
Date: Thu Sep 28 20:33:53 2023 +0300
x86: KVM: SVM: refresh AVIC inhibition in svm\_leave\_nested()
commit 3fdc6087df3be73a212a81ce5dd6516638568806 upstream.
svm\_leave\_nested() similar to a nested VM exit, get the vCPU out of nested
mode and thus should end the local inhibition of AVIC on this vCPU.
Failure to do so, can lead to hangs on guest reboot.
Raise the KVM\_REQ\_APICV\_UPDATE request to refresh the AVIC state of the
current vCPU in this case.
Fixes: f44509f849fe ("KVM: x86: SVM: allow AVIC to co-exist with a nested guest running")
Cc: stable@vger.kernel.org
Signed-off-by: Maxim Levitsky
Reviewed-by: Sean Christopherson
Message-Id: <20230928173354.217464-4-mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 7996dc48ba783888ca4c36b391849f8733b990f3
Author: Maxim Levitsky
Date: Thu Sep 28 20:33:52 2023 +0300
x86: KVM: SVM: add support for Invalid IPI Vector interception
commit 2dcf37abf9d3aab7f975002d29fc7c17272def38 upstream.
In later revisions of AMD's APM, there is a new 'incomplete IPI' exit code:
"Invalid IPI Vector - The vector for the specified IPI was set to an
illegal value (VEC < 16)"
Note that tests on Zen2 machine show that this VM exit doesn't happen and
instead AVIC just does nothing.
Add support for this exit code by doing nothing, instead of filling
the kernel log with errors.
Also replace an unthrottled 'pr\_err()' if another unknown incomplete
IPI exit happens with vcpu\_unimpl()
(e.g in case AMD adds yet another 'Invalid IPI' exit reason)
Cc:
Signed-off-by: Maxim Levitsky
Reviewed-by: Sean Christopherson
Message-Id: <20230928173354.217464-3-mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 94805f9d3a3fb1f091bcc08b9c4846c4346706eb
Author: Maxim Levitsky
Date: Thu Sep 28 20:33:51 2023 +0300
x86: KVM: SVM: always update the x2avic msr interception
commit b65235f6e102354ccafda601eaa1c5bef5284d21 upstream.
The following problem exists since x2avic was enabled in the KVM:
svm\_set\_x2apic\_msr\_interception is called to enable the interception of
the x2apic msrs.
In particular it is called at the moment the guest resets its apic.
Assuming that the guest's apic was in x2apic mode, the reset will bring
it back to the xapic mode.
The svm\_set\_x2apic\_msr\_interception however has an erroneous check for
'!apic\_x2apic\_mode()' which prevents it from doing anything in this case.
As a result of this, all x2apic msrs are left unintercepted, and that
exposes the bare metal x2apic (if enabled) to the guest.
Oops.
Remove the erroneous '!apic\_x2apic\_mode()' check to fix that.
This fixes CVE-2023-5090
Fixes: 4d1d7942e36a ("KVM: SVM: Introduce logic to (de)activate x2AVIC mode")
Cc: stable@vger.kernel.org
Signed-off-by: Maxim Levitsky
Reviewed-by: Suravee Suthikulpanit
Tested-by: Suravee Suthikulpanit
Reviewed-by: Sean Christopherson
Message-Id: <20230928173354.217464-2-mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 3365b42624bfb06d988ac2ed4185a5eea3bf9ccc
Author: Sean Christopherson
Date: Wed Sep 27 17:19:53 2023 -0700
KVM: x86: Constrain guest-supported xfeatures only at KVM\_GET\_XSAVE{2}
commit 8647c52e9504c99752a39f1d44f6268f82c40a5c upstream.
Mask off xfeatures that aren't exposed to the guest only when saving guest
state via KVM\_GET\_XSAVE{2} instead of modifying user\_xfeatures directly.
Preserving the maximal set of xfeatures in user\_xfeatures restores KVM's
ABI for KVM\_SET\_XSAVE, which prior to commit ad856280ddea ("x86/kvm/fpu:
Limit guest user\_xfeatures to supported bits of XCR0") allowed userspace
to load xfeatures that are supported by the host, irrespective of what
xfeatures are exposed to the guest.
There is no known use case where userspace \*intentionally\* loads xfeatures
that aren't exposed to the guest, but the bug fixed by commit ad856280ddea
was specifically that KVM\_GET\_SAVE{2} would save xfeatures that weren't
exposed to the guest, e.g. would lead to userspace unintentionally loading
guest-unsupported xfeatures when live migrating a VM.
Restricting KVM\_SET\_XSAVE to guest-supported xfeatures is especially
problematic for QEMU-based setups, as QEMU has a bug where instead of
terminating the VM if KVM\_SET\_XSAVE fails, QEMU instead simply stops
loading guest state, i.e. resumes the guest after live migration with
incomplete guest state, and ultimately results in guest data corruption.
Note, letting userspace restore all host-supported xfeatures does not fix
setups where a VM is migrated from a host \*without\* commit ad856280ddea,
to a target with a subset of host-supported xfeatures. However there is
no way to safely address that scenario, e.g. KVM could silently drop the
unsupported features, but that would be a clear violation of KVM's ABI and
so would require userspace to opt-in, at which point userspace could
simply be updated to sanitize the to-be-loaded XSAVE state.
Reported-by: Tyler Stachecki
Closes: https://lore.kernel.org/all/20230914010003.358162-1-tstachecki@bloomberg.net
Fixes: ad856280ddea ("x86/kvm/fpu: Limit guest user\_xfeatures to supported bits of XCR0")
Cc: stable@vger.kernel.org
Cc: Leonardo Bras
Signed-off-by: Sean Christopherson
Acked-by: Dave Hansen
Message-Id: <20230928001956.924301-3-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 3de2cf8d8287af49a52f28b35ed8bca281c757a8
Author: Roman Kagan
Date: Thu May 4 14:00:42 2023 +0200
KVM: x86/pmu: Truncate counter value to allowed width on write
commit b29a2acd36dd7a33c63f260df738fb96baa3d4f8 upstream.
Performance counters are defined to have width less than 64 bits. The
vPMU code maintains the counters in u64 variables but assumes the value
to fit within the defined width. However, for Intel non-full-width
counters (MSR\_IA32\_PERFCTRx) the value receieved from the guest is
truncated to 32 bits and then sign-extended to full 64 bits. If a
negative value is set, it's sign-extended to 64 bits, but then in
kvm\_pmu\_incr\_counter() it's incremented, truncated, and compared to the
previous value for overflow detection.
That previous value is not truncated, so it always evaluates bigger than
the truncated new one, and a PMI is injected. If the PMI handler writes
a negative counter value itself, the vCPU never quits the PMI loop.
Turns out that Linux PMI handler actually does write the counter with
the value just read with RDPMC, so when no full-width support is exposed
via MSR\_IA32\_PERF\_CAPABILITIES, and the guest initializes the counter to
a negative value, it locks up.
This has been observed in the field, for example, when the guest configures
atop to use perfevents and runs two instances of it simultaneously.
To address the problem, maintain the invariant that the counter value
always fits in the defined bit width, by truncating the received value
in the respective set\_msr methods. For better readability, factor the
out into a helper function, pmc\_write\_counter(), shared by vmx and svm
parts.
Fixes: 9cd803d496e7 ("KVM: x86: Update vPMCs when retiring instructions")
Cc: stable@vger.kernel.org
Signed-off-by: Roman Kagan
Link: https://lore.kernel.org/all/20230504120042.785651-1-rkagan@amazon.de
Tested-by: Like Xu
[sean: tweak changelog, s/set/write in the helper]
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit 4d16224bcc3b4dc1b9e614f83c6edf21c14ce5d1
Author: Sean Christopherson
Date: Wed Sep 27 17:19:52 2023 -0700
x86/fpu: Allow caller to constrain xfeatures when copying to uabi buffer
commit 18164f66e6c59fda15c198b371fa008431efdb22 upstream.
Plumb an xfeatures mask into \_\_copy\_xstate\_to\_uabi\_buf() so that KVM can
constrain which xfeatures are saved into the userspace buffer without
having to modify the user\_xfeatures field in KVM's guest\_fpu state.
KVM's ABI for KVM\_GET\_XSAVE{2} is that features that are not exposed to
guest must not show up in the effective xstate\_bv field of the buffer.
Saving only the guest-supported xfeatures allows userspace to load the
saved state on a different host with a fewer xfeatures, so long as the
target host supports the xfeatures that are exposed to the guest.
KVM currently sets user\_xfeatures directly to restrict KVM\_GET\_XSAVE{2} to
the set of guest-supported xfeatures, but doing so broke KVM's historical
ABI for KVM\_SET\_XSAVE, which allows userspace to load any xfeatures that
are supported by the \*host\*.
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson
Message-Id: <20230928001956.924301-2-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 11b975cb82cc6d88e8b04f77a673077ac5c30c8b
Author: Joerg Roedel
Date: Mon Oct 16 14:42:50 2023 +0200
x86/sev: Check for user-space IOIO pointing to kernel space
Upstream commit: 63e44bc52047f182601e7817da969a105aa1f721
Check the memory operand of INS/OUTS before emulating the instruction.
The #VC exception can get raised from user-space, but the memory operand
can be manipulated to access kernel memory before the emulation actually
begins and after the exception handler has run.
[ bp: Massage commit message. ]
Fixes: 597cfe48212a ("x86/boot/compressed/64: Setup a GHCB-based VC Exception handler")
Reported-by: Tom Dohrmann
Signed-off-by: Joerg Roedel
Signed-off-by: Borislav Petkov (AMD)
Cc:
Signed-off-by: Greg Kroah-Hartman
commit dcb55b683118e411da93dbaea86e73a06bb21870
Author: Joerg Roedel
Date: Wed Jun 21 17:42:42 2023 +0200
x86/sev: Check IOBM for IOIO exceptions from user-space
Upstream commit: b9cb9c45583b911e0db71d09caa6b56469eb2bdf
Check the IO permission bitmap (if present) before emulating IOIO #VC
exceptions for user-space. These permissions are checked by hardware
already before the #VC is raised, but due to the VC-handler decoding
race it needs to be checked again in software.
Fixes: 25189d08e516 ("x86/sev-es: Add support for handling IOIO exceptions")
Reported-by: Tom Dohrmann
Signed-off-by: Joerg Roedel
Signed-off-by: Borislav Petkov (AMD)
Tested-by: Tom Dohrmann
Cc:
Signed-off-by: Greg Kroah-Hartman
commit f44a58134e6a532c73796cabedea68939cf7792f
Author: Borislav Petkov (AMD)
Date: Thu Oct 5 11:06:36 2023 +0200
x86/sev: Disable MMIO emulation from user mode
Upstream commit: a37cd2a59d0cb270b1bba568fd3a3b8668b9d3ba
A virt scenario can be constructed where MMIO memory can be user memory.
When that happens, a race condition opens between when the hardware
raises the #VC and when the #VC handler gets to emulate the instruction.
If the MOVS is replaced with a MOVS accessing kernel memory in that
small race window, then write to kernel memory happens as the access
checks are not done at emulation time.
Disable MMIO emulation in user mode temporarily until a sensible use
case appears and justifies properly handling the race window.
Fixes: 0118b604c2c9 ("x86/sev-es: Handle MMIO String Instructions")
Reported-by: Tom Dohrmann
Signed-off-by: Borislav Petkov (AMD)
Tested-by: Tom Dohrmann
Cc:
Signed-off-by: Greg Kroah-Hartman
commit ecaf2578655383bc84eb218282ec2ad3db7211eb
Author: Jim Mattson
Date: Mon Sep 25 17:34:47 2023 +0000
KVM: x86: Mask LVTPC when handling a PMI
commit a16eb25b09c02a54c1c1b449d4b6cfa2cf3f013a upstream.
Per the SDM, "When the local APIC handles a performance-monitoring
counters interrupt, it automatically sets the mask flag in the LVT
performance counter register." Add this behavior to KVM's local APIC
emulation.
Failure to mask the LVTPC entry results in spurious PMIs, e.g. when
running Linux as a guest, PMI handlers that do a "late\_ack" spew a large
number of "dazed and confused" spurious NMI warnings.
Fixes: f5132b01386b ("KVM: Expose a version 2 architectural PMU to a guests")
Cc: stable@vger.kernel.org
Signed-off-by: Jim Mattson
Tested-by: Mingwei Zhang
Signed-off-by: Mingwei Zhang
Link: https://lore.kernel.org/r/20230925173448.3518223-3-mizhang@google.com
[sean: massage changelog, correct Fixes]
Signed-off-by: Sean Christopherson
Signed-off-by: Greg Kroah-Hartman
commit 9379a0ef18528f614ff04e54b89a2e4797f97100
Author: Johan Hovold
Date: Fri Oct 6 10:21:04 2023 +0200
regmap: fix NULL deref on lookup
commit c6df843348d6b71ea986266c12831cb60c2cf325 upstream.
Not all regmaps have a name so make sure to check for that to avoid
dereferencing a NULL pointer when dev\_get\_regmap() is used to lookup a
named regmap.
Fixes: e84861fec32d ("regmap: dev\_get\_regmap\_match(): fix string comparison")
Cc: stable@vger.kernel.org # 5.8
Cc: Marc Kleine-Budde
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20231006082104.16707-1-johan+linaro@kernel.org
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit bb6cacc439ddd2cd51227ab193f4f91cfc7f014f
Author: Krzysztof Kozlowski
Date: Fri Oct 13 20:41:29 2023 +0200
nfc: nci: fix possible NULL pointer dereference in send\_acknowledge()
commit 7937609cd387246aed994e81aa4fa951358fba41 upstream.
Handle memory allocation failure from nci\_skb\_alloc() (calling
alloc\_skb()) to avoid possible NULL pointer dereference.
Reported-by: 黄思聪
Fixes: 391d8a2da787 ("NFC: Add NCI over SPI receive")
Cc:
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20231013184129.18738-1-krzysztof.kozlowski@linaro.org
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit e7acd6209f21690318a4d6adf22a683263710667
Author: Zygo Blaxell
Date: Sat Oct 7 01:14:21 2023 -0400
btrfs: fix stripe length calculation for non-zoned data chunk allocation
commit 8a540e990d7da36813cb71a4a422712bfba448a4 upstream.
Commit f6fca3917b4d "btrfs: store chunk size in space-info struct"
broke data chunk allocations on non-zoned multi-device filesystems when
using default chunk\_size. Commit 5da431b71d4b "btrfs: fix the max chunk
size and stripe length calculation" partially fixed that, and this patch
completes the fix for that case.
After commit f6fca3917b4d and 5da431b71d4b, the sequence of events for
a data chunk allocation on a non-zoned filesystem is:
1. btrfs\_create\_chunk calls init\_alloc\_chunk\_ctl, which copies
space\_info->chunk\_size (default 10 GiB) to ctl->max\_stripe\_len
unmodified. Before f6fca3917b4d, ctl->max\_stripe\_len value was
1 GiB for non-zoned data chunks and not configurable.
2. btrfs\_create\_chunk calls gather\_device\_info which consumes
and produces more fields of chunk\_ctl.
3. gather\_device\_info multiplies ctl->max\_stripe\_len by
ctl->dev\_stripes (which is 1 in all cases except dup)
and calls find\_free\_dev\_extent with that number as num\_bytes.
4. find\_free\_dev\_extent locates the first dev\_extent hole on
a device which is at least as large as num\_bytes. With default
max\_chunk\_size from f6fca3917b4d, it finds the first hole which is
longer than 10 GiB, or the largest hole if that hole is shorter
than 10 GiB. This is different from the pre-f6fca3917b4d
behavior, where num\_bytes is 1 GiB, and find\_free\_dev\_extent
may choose a different hole.
5. gather\_device\_info repeats step 4 with all devices to find
the first or largest dev\_extent hole that can be allocated on
each device.
6. gather\_device\_info sorts the device list by the hole size
on each device, using total unallocated space on each device to
break ties, then returns to btrfs\_create\_chunk with the list.
7. btrfs\_create\_chunk calls decide\_stripe\_size\_regular.
8. decide\_stripe\_size\_regular finds the largest stripe\_len that
fits across the first nr\_devs device dev\_extent holes that were
found by gather\_device\_info (and satisfies other constraints
on stripe\_len that are not relevant here).
9. decide\_stripe\_size\_regular caps the length of the stripe it
computed at 1 GiB. This cap appeared in 5da431b71d4b to correct
one of the other regressions introduced in f6fca3917b4d.
10. btrfs\_create\_chunk creates a new chunk with the above
computed size and number of devices.
At step 4, gather\_device\_info() has found a location where stripe up to
10 GiB in length could be allocated on several devices, and selected
which devices should have a dev\_extent allocated on them, but at step
9, only 1 GiB of the space that was found on each device can be used.
This mismatch causes new suboptimal chunk allocation cases that did not
occur in pre-f6fca3917b4d kernels.
Consider a filesystem using raid1 profile with 3 devices. After some
balances, device 1 has 10x 1 GiB unallocated space, while devices 2
and 3 have 1x 10 GiB unallocated space, i.e. the same total amount of
space, but distributed across different numbers of dev\_extent holes.
For visualization, let's ignore all the chunks that were allocated before
this point, and focus on the remaining holes:
Device 1: [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (10x 1 GiB unallocated)
Device 2: [\_\_\_\_\_\_\_\_\_\_] (10 GiB contig unallocated)
Device 3: [\_\_\_\_\_\_\_\_\_\_] (10 GiB contig unallocated)
Before f6fca3917b4d, the allocator would fill these optimally by
allocating chunks with dev\_extents on devices 1 and 2 ([12]), 1 and 3
([13]), or 2 and 3 ([23]):
[after 0 chunk allocations]
Device 1: [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (10 GiB)
Device 2: [\_\_\_\_\_\_\_\_\_\_] (10 GiB)
Device 3: [\_\_\_\_\_\_\_\_\_\_] (10 GiB)
[after 1 chunk allocation]
Device 1: [12] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_]
Device 2: [12] [\_\_\_\_\_\_\_\_\_] (9 GiB)
Device 3: [\_\_\_\_\_\_\_\_\_\_] (10 GiB)
[after 2 chunk allocations]
Device 1: [12] [13] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (8 GiB)
Device 2: [12] [\_\_\_\_\_\_\_\_\_] (9 GiB)
Device 3: [13] [\_\_\_\_\_\_\_\_\_] (9 GiB)
[after 3 chunk allocations]
Device 1: [12] [13] [12] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (7 GiB)
Device 2: [12] [12] [\_\_\_\_\_\_\_\_] (8 GiB)
Device 3: [13] [\_\_\_\_\_\_\_\_\_] (9 GiB)
[...]
[after 12 chunk allocations]
Device 1: [12] [13] [12] [13] [12] [13] [12] [13] [\_] [\_] (2 GiB)
Device 2: [12] [12] [23] [23] [12] [12] [23] [23] [\_\_] (2 GiB)
Device 3: [13] [13] [23] [23] [13] [23] [13] [23] [\_\_] (2 GiB)
[after 13 chunk allocations]
Device 1: [12] [13] [12] [13] [12] [13] [12] [13] [12] [\_] (1 GiB)
Device 2: [12] [12] [23] [23] [12] [12] [23] [23] [12] [\_] (1 GiB)
Device 3: [13] [13] [23] [23] [13] [23] [13] [23] [\_\_] (2 GiB)
[after 14 chunk allocations]
Device 1: [12] [13] [12] [13] [12] [13] [12] [13] [12] [13] (full)
Device 2: [12] [12] [23] [23] [12] [12] [23] [23] [12] [\_] (1 GiB)
Device 3: [13] [13] [23] [23] [13] [23] [13] [23] [13] [\_] (1 GiB)
[after 15 chunk allocations]
Device 1: [12] [13] [12] [13] [12] [13] [12] [13] [12] [13] (full)
Device 2: [12] [12] [23] [23] [12] [12] [23] [23] [12] [23] (full)
Device 3: [13] [13] [23] [23] [13] [23] [13] [23] [13] [23] (full)
This allocates all of the space with no waste. The sorting function used
by gather\_device\_info considers free space holes above 1 GiB in length
to be equal to 1 GiB, so once find\_free\_dev\_extent locates a sufficiently
long hole on each device, all the holes appear equal in the sort, and the
comparison falls back to sorting devices by total free space. This keeps
usable space on each device equal so they can all be filled completely.
After f6fca3917b4d, the allocator prefers the devices with larger holes
over the devices with more free space, so it makes bad allocation choices:
[after 1 chunk allocation]
Device 1: [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (10 GiB)
Device 2: [23] [\_\_\_\_\_\_\_\_\_] (9 GiB)
Device 3: [23] [\_\_\_\_\_\_\_\_\_] (9 GiB)
[after 2 chunk allocations]
Device 1: [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (10 GiB)
Device 2: [23] [23] [\_\_\_\_\_\_\_\_] (8 GiB)
Device 3: [23] [23] [\_\_\_\_\_\_\_\_] (8 GiB)
[after 3 chunk allocations]
Device 1: [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (10 GiB)
Device 2: [23] [23] [23] [\_\_\_\_\_\_\_] (7 GiB)
Device 3: [23] [23] [23] [\_\_\_\_\_\_\_] (7 GiB)
[...]
[after 9 chunk allocations]
Device 1: [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (10 GiB)
Device 2: [23] [23] [23] [23] [23] [23] [23] [23] [23] [\_] (1 GiB)
Device 3: [23] [23] [23] [23] [23] [23] [23] [23] [23] [\_] (1 GiB)
[after 10 chunk allocations]
Device 1: [12] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (9 GiB)
Device 2: [23] [23] [23] [23] [23] [23] [23] [23] [12] (full)
Device 3: [23] [23] [23] [23] [23] [23] [23] [23] [\_] (1 GiB)
[after 11 chunk allocations]
Device 1: [12] [13] [\_] [\_] [\_] [\_] [\_] [\_] [\_] [\_] (8 GiB)
Device 2: [23] [23] [23] [23] [23] [23] [23] [23] [12] (full)
Device 3: [23] [23] [23] [23] [23] [23] [23] [23] [13] (full)
No further allocations are possible, with 8 GiB wasted (4 GiB of data
space). The sort in gather\_device\_info now considers free space in
holes longer than 1 GiB to be distinct, so it will prefer devices 2 and
3 over device 1 until all but 1 GiB is allocated on devices 2 and 3.
At that point, with only 1 GiB unallocated on every device, the largest
hole length on each device is equal at 1 GiB, so the sort finally moves
to ordering the devices with the most free space, but by this time it
is too late to make use of the free space on device 1.
Note that it's possible to contrive a case where the pre-f6fca3917b4d
allocator fails the same way, but these cases generally have extensive
dev\_extent fragmentation as a precondition (e.g. many holes of 768M
in length on one device, and few holes 1 GiB in length on the others).
With the regression in f6fca3917b4d, bad chunk allocation can occur even
under optimal conditions, when all dev\_extent holes are exact multiples
of stripe\_len in length, as in the example above.
Also note that post-f6fca3917b4d kernels do treat dev\_extent holes
larger than 10 GiB as equal, so the bad behavior won't show up on a
freshly formatted filesystem; however, as the filesystem ages and fills
up, and holes ranging from 1 GiB to 10 GiB in size appear, the problem
can show up as a failure to balance after adding or removing devices,
or an unexpected shortfall in available space due to unequal allocation.
To fix the regression and make data chunk allocation work
again, set ctl->max\_stripe\_len back to the original SZ\_1G, or
space\_info->chunk\_size if that's smaller (the latter can happen if the
user set space\_info->chunk\_size to less than 1 GiB via sysfs, or it's
a 32 MiB system chunk with a hardcoded chunk\_size and stripe\_len).
While researching the background of the earlier commits, I found that an
identical fix was already proposed at:
https://lore.kernel.org/linux-btrfs/de83ac46-a4a3-88d3-85ce-255b7abc5249@gmx.com/
The previous review missed one detail: ctl->max\_stripe\_len is used
before decide\_stripe\_size\_regular() is called, when it is too late for
the changes in that function to have any effect. ctl->max\_stripe\_len is
not used directly by decide\_stripe\_size\_regular(), but the parameter
does heavily influence the per-device free space data presented to
the function.
Fixes: f6fca3917b4d ("btrfs: store chunk size in space-info struct")
CC: stable@vger.kernel.org # 6.1+
Link: https://lore.kernel.org/linux-btrfs/20231007051421.19657-1-ce3g8jdj@umail.furryterror.org/
Reviewed-by: Qu Wenruo
Signed-off-by: Zygo Blaxell
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit c60f54a8868dbc6befda8c241ccf48a8c48ec479
Author: Dust Li
Date: Thu Oct 12 20:37:29 2023 +0800
net/smc: return the right falback reason when prefix checks fail
commit 4abbd2e3c1db671fa1286390f1310aec78386f1d upstream.
In the smc\_listen\_work(), if smc\_listen\_prfx\_check() failed,
the real reason: SMC\_CLC\_DECL\_DIFFPREFIX was dropped, and
SMC\_CLC\_DECL\_NOSMCDEV was returned.
Althrough this is also kind of SMC\_CLC\_DECL\_NOSMCDEV, but return
the real reason is much friendly for debugging.
Fixes: e49300a6bf62 ("net/smc: add listen processing for SMC-Rv2")
Signed-off-by: Dust Li
Reviewed-by: Alexandra Winter
Reviewed-by: Wenjia Zhang
Link: https://lore.kernel.org/r/20231012123729.29307-1-dust.li@linux.alibaba.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 74dcd829d94ffc5896f26115fa9ddbe614bfdf27
Author: Jesse Brandeburg
Date: Wed Oct 11 16:33:33 2023 -0700
ice: reset first in crash dump kernels
commit 0288c3e709e5fabd51e84715c5c798a02f43061a upstream.
When the system boots into the crash dump kernel after a panic, the ice
networking device may still have pending transactions that can cause errors
or machine checks when the device is re-enabled. This can prevent the crash
dump kernel from loading the driver or collecting the crash data.
To avoid this issue, perform a function level reset (FLR) on the ice device
via PCIe config space before enabling it on the crash kernel. This will
clear any outstanding transactions and stop all queues and interrupts.
Restore the config space after the FLR, otherwise it was found in testing
that the driver wouldn't load successfully.
The following sequence causes the original issue:
- Load the ice driver with modprobe ice
- Enable SR-IOV with 2 VFs: echo 2 > /sys/class/net/eth0/device/sriov\_num\_vfs
- Trigger a crash with echo c > /proc/sysrq-trigger
- Load the ice driver again (or let it load automatically) with modprobe ice
- The system crashes again during pcim\_enable\_device()
Fixes: 837f08fdecbe ("ice: Add basic driver framework for Intel(R) E800 Series")
Reported-by: Vishal Agrawal
Reviewed-by: Jay Vosburgh
Reviewed-by: Przemek Kitszel
Signed-off-by: Jesse Brandeburg
Tested-by: Pucha Himasekhar Reddy  (A Contingent worker at Intel)
Link: https://lore.kernel.org/r/20231011233334.336092-3-jacob.e.keller@intel.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 9e1dd9401dff3331f64cbb2eee02b9d9f9ad198b
Author: Mateusz Pacuszka
Date: Wed Oct 11 16:33:34 2023 -0700
ice: Fix safe mode when DDP is missing
commit 42066c4d5d344cdf8564556cdbe0aa36854fefa4 upstream.
One thing is broken in the safe mode, that is
ice\_deinit\_features() is being executed even
that ice\_init\_features() was not causing stack
trace during pci\_unregister\_driver().
Add check on the top of the function.
Fixes: 5b246e533d01 ("ice: split probe into smaller functions")
Signed-off-by: Mateusz Pacuszka
Signed-off-by: Jan Sokolowski
Reviewed-by: Przemek Kitszel
Tested-by: Pucha Himasekhar Reddy  (A Contingent worker at Intel)
Link: https://lore.kernel.org/r/20231011233334.336092-4-jacob.e.keller@intel.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit df23c09a7441ef3eb026876349d710f0276ef93b
Author: Jesse Brandeburg
Date: Tue Oct 10 13:30:59 2023 -0700
ice: fix over-shifted variable
commit 242e34500a32631f85c2b4eb6cb42a368a39e54f upstream.
Since the introduction of the ice driver the code has been
double-shifting the RSS enabling field, because the define already has
shifts in it and can't have the regular pattern of "a << shiftval &
mask" applied.
Most places in the code got it right, but one line was still wrong. Fix
this one location for easy backports to stable. An in-progress patch
fixes the defines to "standard" and will be applied as part of the
regular -next process sometime after this one.
Fixes: d76a60ba7afb ("ice: Add support for VLANs and offloads")
Reviewed-by: Przemek Kitszel
CC: stable@vger.kernel.org
Signed-off-by: Jesse Brandeburg
Reviewed-by: Simon Horman
Tested-by: Pucha Himasekhar Reddy  (A Contingent worker at Intel)
Signed-off-by: Jacob Keller
Link: https://lore.kernel.org/r/20231010203101.406248-1-jacob.e.keller@intel.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit 06a5e7bf1cabe89ab63fb59b3bab21fab137425d
Author: Luiz Augusto von Dentz
Date: Thu Aug 3 14:49:14 2023 -0700
Bluetooth: hci\_conn: Fix modifying handle while aborting
commit 16e3b6429159795a87add7584eb100b19aa1d70b upstream.
This introduces hci\_conn\_set\_handle which takes care of verifying the
conditions where the hci\_conn handle can be modified, including when
hci\_conn\_abort has been called and also checks that the handles is
valid as well.
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 5b7a24872c2a832fd55f169945cb14e41596cbce
Author: Arnd Bergmann
Date: Mon Oct 9 22:31:31 2023 +0200
Bluetooth: avoid memcmp() out of bounds warning
commit 9d1a3c74746428102d55371fbf74b484733937d9 upstream.
bacmp() is a wrapper around memcpy(), which contain compile-time
checks for buffer overflow. Since the hci\_conn\_request\_evt() also calls
bt\_dev\_dbg() with an implicit NULL pointer check, the compiler is now
aware of a case where 'hdev' is NULL and treats this as meaning that
zero bytes are available:
In file included from net/bluetooth/hci\_event.c:32:
In function 'bacmp',
inlined from 'hci\_conn\_request\_evt' at net/bluetooth/hci\_event.c:3276:7:
include/net/bluetooth/bluetooth.h:364:16: error: 'memcmp' specified bound 6 exceeds source size 0 [-Werror=stringop-overread]
364 | return memcmp(ba1, ba2, sizeof(bdaddr\_t));
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Add another NULL pointer check before the bacmp() to ensure the compiler
understands the code flow enough to not warn about it. Since the patch
that introduced the warning is marked for stable backports, this one
should also go that way to avoid introducing build regressions.
Fixes: 1ffc6f8cc332 ("Bluetooth: Reject connection with the device which has same BD\_ADDR")
Cc: Kees Cook
Cc: "Lee, Chun-Yi"
Cc: Luiz Augusto von Dentz
Cc: Marcel Holtmann
Cc: stable@vger.kernel.org
Signed-off-by: Arnd Bergmann
Reviewed-by: Kees Cook
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 75d889f692381fc50eb9d908004e37c0481bed78
Author: Luiz Augusto von Dentz
Date: Thu Oct 5 14:12:19 2023 -0700
Bluetooth: hci\_event: Fix coding style
commit 35d91d95a0cd61ebb90e0246dc917fd25e519b8c upstream.
This fixes the following code style problem:
ERROR: that open brace { should be on the previous line
+ if (!bacmp(&hdev->bdaddr, &ev->bdaddr))
+ {
Fixes: 1ffc6f8cc332 ("Bluetooth: Reject connection with the device which has same BD\_ADDR")
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit c4fb6456420a10ed6de0ed84988dfdf3b6aee51c
Author: Arkadiusz Bokowy
Date: Wed Sep 20 17:30:07 2023 +0200
Bluetooth: vhci: Fix race when opening vhci device
commit 92d4abd66f7080075793970fc8f241239e58a9e7 upstream.
When the vhci device is opened in the two-step way, i.e.: open device
then write a vendor packet with requested controller type, the device
shall respond with a vendor packet which includes HCI index of created
interface.
When the virtual HCI is created, the host sends a reset request to the
controller. This request is processed by the vhci\_send\_frame() function.
However, this request is send by a different thread, so it might happen
that this HCI request will be received before the vendor response is
queued in the read queue. This results in the HCI vendor response and
HCI reset request inversion in the read queue which leads to improper
behavior of btvirt:
> dmesg
[1754256.640122] Bluetooth: MGMT ver 1.22
[1754263.023806] Bluetooth: MGMT ver 1.22
[1754265.043775] Bluetooth: hci1: Opcode 0x c03 failed: -110
In order to synchronize vhci two-step open/setup process with virtual
HCI initialization, this patch adds internal lock when queuing data in
the vhci\_send\_frame() function.
Signed-off-by: Arkadiusz Bokowy
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 746dbb0fc6392eca23de27f8aa9d13979b564889
Author: Ziyang Xuan
Date: Wed Oct 4 20:42:24 2023 +0800
Bluetooth: Fix a refcnt underflow problem for hci\_conn
commit c7f59461f5a78994613afc112cdd73688aef9076 upstream.
Syzbot reports a warning as follows:
WARNING: CPU: 1 PID: 26946 at net/bluetooth/hci\_conn.c:619
hci\_conn\_timeout+0x122/0x210 net/bluetooth/hci\_conn.c:619
...
Call Trace:
process\_one\_work+0x884/0x15c0 kernel/workqueue.c:2630
process\_scheduled\_works kernel/workqueue.c:2703 [inline]
worker\_thread+0x8b9/0x1290 kernel/workqueue.c:2784
kthread+0x33c/0x440 kernel/kthread.c:388
ret\_from\_fork+0x45/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x11/0x20 arch/x86/entry/entry\_64.S:304

It is because the HCI\_EV\_SIMPLE\_PAIR\_COMPLETE event handler drops
hci\_conn directly without check Simple Pairing whether be enabled. But
the Simple Pairing process can only be used if both sides have the
support enabled in the host stack.
Add hci\_conn\_ssp\_enabled() for hci\_conn in HCI\_EV\_IO\_CAPA\_REQUEST and
HCI\_EV\_SIMPLE\_PAIR\_COMPLETE event handlers to fix the problem.
Fixes: 0493684ed239 ("[Bluetooth] Disable disconnect timer during Simple Pairing")
Signed-off-by: Ziyang Xuan
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 2f6495fe89e86341d438cbb0de89c149300d379f
Author: Lee, Chun-Yi
Date: Sun Oct 1 16:59:58 2023 +0800
Bluetooth: Reject connection with the device which has same BD\_ADDR
commit 1ffc6f8cc33268731fcf9629fc4438f6db1191fc upstream.
This change is used to relieve CVE-2020-26555. The description of
the CVE:
Bluetooth legacy BR/EDR PIN code pairing in Bluetooth Core Specification
1.0B through 5.2 may permit an unauthenticated nearby device to spoof
the BD\_ADDR of the peer device to complete pairing without knowledge
of the PIN. [1]
The detail of this attack is in IEEE paper:
BlueMirror: Reflections on Bluetooth Pairing and Provisioning Protocols
[2]
It's a reflection attack. The paper mentioned that attacker can induce
the attacked target to generate null link key (zero key) without PIN
code. In BR/EDR, the key generation is actually handled in the controller
which is below HCI.
A condition of this attack is that attacker should change the
BR\_ADDR of his hacking device (Host B) to equal to the BR\_ADDR with
the target device being attacked (Host A).
Thus, we reject the connection with device which has same BD\_ADDR
both on HCI\_Create\_Connection and HCI\_Connection\_Request to prevent
the attack. A similar implementation also shows in btstack project.
[3][4]
Cc: stable@vger.kernel.org
Link: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-26555 [1]
Link: https://ieeexplore.ieee.org/abstract/document/9474325/authors#authors [2]
Link: https://github.com/bluekitchen/btstack/blob/master/src/hci.c#L3523 [3]
Link: https://github.com/bluekitchen/btstack/blob/master/src/hci.c#L7297 [4]
Signed-off-by: Lee, Chun-Yi
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 0d04728e2743d145537ed95a9b6fd24f5cef8a51
Author: Lee, Chun-Yi
Date: Sun Oct 1 16:59:31 2023 +0800
Bluetooth: hci\_event: Ignore NULL link key
commit 33155c4aae5260475def6f7438e4e35564f4f3ba upstream.
This change is used to relieve CVE-2020-26555. The description of the
CVE:
Bluetooth legacy BR/EDR PIN code pairing in Bluetooth Core Specification
1.0B through 5.2 may permit an unauthenticated nearby device to spoof
the BD\_ADDR of the peer device to complete pairing without knowledge
of the PIN. [1]
The detail of this attack is in IEEE paper:
BlueMirror: Reflections on Bluetooth Pairing and Provisioning Protocols
[2]
It's a reflection attack. The paper mentioned that attacker can induce
the attacked target to generate null link key (zero key) without PIN
code. In BR/EDR, the key generation is actually handled in the controller
which is below HCI.
Thus, we can ignore null link key in the handler of "Link Key Notification
event" to relieve the attack. A similar implementation also shows in
btstack project. [3]
v3: Drop the connection when null link key be detected.
v2:
- Used Link: tag instead of Closes:
- Used bt\_dev\_dbg instead of BT\_DBG
- Added Fixes: tag
Cc: stable@vger.kernel.org
Fixes: 55ed8ca10f35 ("Bluetooth: Implement link key handling for the management interface")
Link: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-26555 [1]
Link: https://ieeexplore.ieee.org/abstract/document/9474325/authors#authors [2]
Link: https://github.com/bluekitchen/btstack/blob/master/src/hci.c#L3722 [3]
Signed-off-by: Lee, Chun-Yi
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman


=== Content from github.com_14d5577d_20250114_203040.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F7937609cd387246aed994e81aa4fa951358fba41)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F7937609cd387246aed994e81aa4fa951358fba41)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  434](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/7937609cd387246aed994e81aa4fa951358fba41)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

nfc: nci: fix possible NULL pointer dereference in send\_acknowledge()

[Browse files](/torvalds/linux/tree/7937609cd387246aed994e81aa4fa951358fba41)
Browse the repository at this point in the history

```
Handle memory allocation failure from nci_skb_alloc() (calling
alloc_skb()) to avoid possible NULL pointer dereference.

Reported-by: 黄思聪 <huangsicong@iie.ac.cn>
Fixes: [391d8a2](https://github.com/torvalds/linux/commit/391d8a2da787257aeaf952c974405b53926e3fb3) ("NFC: Add NCI over SPI receive")
Cc: <stable@vger.kernel.org>
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20231013184129.18738-1-krzysztof.kozlowski@linaro.org](https://lore.kernel.org/r/20231013184129.18738-1-krzysztof.kozlowski%40linaro.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
```

* Loading branch information

[![@krzk](https://avatars.githubusercontent.com/u/10425763?s=40&v=4)](/krzk) [![@kuba-moo](https://avatars.githubusercontent.com/u/6732289?s=40&v=4)](/kuba-moo)

[krzk](/torvalds/linux/commits?author=krzk "View all commits by krzk")
authored and
[kuba-moo](/torvalds/linux/commits?author=kuba-moo "View all commits by kuba-moo")
committed
Oct 17, 2023

1 parent
[503930f](/torvalds/linux/commit/503930f8e113edc86f92b767efb4ea57bdffffb2)

commit 7937609

Showing
**1 changed file**
with
**2 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[net/nfc/nci/spi.c](#diff-7cd4c3945539cdf537dcdcc37931f475dc818ce3d42f454a20d0fca1d38b572b "net/nfc/nci/spi.c")

Show comments

[View file](/torvalds/linux/blob/7937609cd387246aed994e81aa4fa951358fba41/net/nfc/nci/spi.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -151,6 +151,8 @@ static int send\_acknowledge(struct nci\_spi \*nspi, u8 acknowledge) |
|  |  | int ret; |
|  |  |  |
|  |  | skb = nci\_skb\_alloc(nspi->ndev, 0, GFP\_KERNEL); |
|  |  | if (!skb) |
|  |  | return -ENOMEM; |
|  |  |  |
|  |  | /\* add the NCI SPI header to the start of the buffer \*/ |
|  |  | hdr = skb\_push(skb, NCI\_SPI\_HDR\_LEN); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7937609`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F7937609cd387246aed994e81aa4fa951358fba41) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lore.kernel.org_55b8a1f4_20250114_203040.html ===

```
[netdev.vger.kernel.org archive mirror](../../?t=20231017005023)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#e38bdbaf8ae15305b77f6c5bc8e15d38f405623c7) [PATCH net-next] nfc: nci: fix possible NULL pointer dereference in send_acknowledge()
@ 2023-10-13 18:41 Krzysztof Kozlowski
  2023-10-16 11:28 ` [Simon Horman](#m02ac7f3d6ec657ce071e784d3d7c288dc4114d93)
  2023-10-17  0:50 ` [patchwork-bot+netdevbpf](#mf2060d60ac92f054fd3db21fe790c011cfadb02d)
  [0 siblings, 2 replies; 3+ messages in thread](#r38bdbaf8ae15305b77f6c5bc8e15d38f405623c7)
From: Krzysztof Kozlowski @ 2023-10-13 18:41 UTC ([permalink](../../20231013184129.18738-1-krzysztof.kozlowski%40linaro.org/) / [raw](../../20231013184129.18738-1-krzysztof.kozlowski%40linaro.org/raw))
  To: Krzysztof Kozlowski, David S. Miller, Eric Dumazet,
	Jakub Kicinski, Paolo Abeni, Samuel Ortiz, Frederic Danis, [netdev](../../../netdev/?t=20231013184207),
	[linux-kernel](../../../lkml/?t=20231013184207)
  Cc: 黄思聪, [stable](../../../stable/?t=20231013184207)

Handle memory allocation failure from nci_skb_alloc() (calling
alloc_skb()) to avoid possible NULL pointer dereference.

Reported-by: 黄思聪 <huangsicong@iie.ac.cn>
Fixes: 391d8a2da787 ("NFC: Add NCI over SPI receive")
Cc: <stable@vger.kernel.org>
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
---
 [net/nfc/nci/spi.c](#Z2e.:..:20231013184129.18738-1-krzysztof.kozlowski::40linaro.org:1net:nfc:nci:spi.c) | 2 ++
 1 file [changed](#e38bdbaf8ae15305b77f6c5bc8e15d38f405623c7), 2 insertions(+)

[diff](#iZ2e.:..:20231013184129.18738-1-krzysztof.kozlowski::40linaro.org:1net:nfc:nci:spi.c) --git a/net/nfc/nci/spi.c b/net/nfc/nci/spi.c
index 0935527d1d12..b68150c971d0 100644
--- a/net/nfc/nci/spi.c
+++ b/net/nfc/nci/spi.c
@@ -151,6 +151,8 @@ static int send_acknowledge(struct nci_spi *nspi, u8 acknowledge)
 	int ret;

 	skb = nci_skb_alloc(nspi->ndev, 0, GFP_KERNEL);
+	if (!skb)
+		return -ENOMEM;

 	/* add the NCI SPI header to the start of the buffer */
 	hdr = skb_push(skb, NCI_SPI_HDR_LEN);
--
2.34.1

[^](#m38bdbaf8ae15305b77f6c5bc8e15d38f405623c7) [permalink](../../20231013184129.18738-1-krzysztof.kozlowski%40linaro.org/) [raw](../../20231013184129.18738-1-krzysztof.kozlowski%40linaro.org/raw) [reply](../../20231013184129.18738-1-krzysztof.kozlowski%40linaro.org/#R) [related](../../20231013184129.18738-1-krzysztof.kozlowski%40linaro.org/#related)	[[flat](../../20231013184129.18738-1-krzysztof.kozlowski%40linaro.org/T/#u)|[nested](../../20231013184129.18738-1-krzysztof.kozlowski%40linaro.org/t/#u)] [3+ messages in thread](#r38bdbaf8ae15305b77f6c5bc8e15d38f405623c7)
```

---

```
[*](#e02ac7f3d6ec657ce071e784d3d7c288dc4114d93) Re: [PATCH net-next] nfc: nci: fix possible NULL pointer dereference in send_acknowledge()
  2023-10-13 18:41 [[PATCH net-next] nfc: nci: fix possible NULL pointer dereference in send_acknowledge()](#m38bdbaf8ae15305b77f6c5bc8e15d38f405623c7) Krzysztof Kozlowski
@ 2023-10-16 11:28 ` Simon Horman
  2023-10-17  0:50 ` [patchwork-bot+netdevbpf](#mf2060d60ac92f054fd3db21fe790c011cfadb02d)
  [1 sibling, 0 replies; 3+ messages in thread](#r02ac7f3d6ec657ce071e784d3d7c288dc4114d93)
From: Simon Horman @ 2023-10-16 11:28 UTC ([permalink](../../20231016112819.GL1501712%40kernel.org/) / [raw](../../20231016112819.GL1501712%40kernel.org/raw))
  To: Krzysztof Kozlowski
  Cc: David S. Miller, Eric Dumazet, Jakub Kicinski, Paolo Abeni,
	Samuel Ortiz, Frederic Danis, [netdev](../../../netdev/?t=20231016112824), [linux-kernel](../../../lkml/?t=20231016112824),
	黄思聪, [stable](../../../stable/?t=20231016112824)

On Fri, Oct 13, 2023 at 08:41:29PM +0200, Krzysztof Kozlowski wrote:
> Handle memory allocation failure from nci_skb_alloc() (calling
> alloc_skb()) to avoid possible NULL pointer dereference.
>
> Reported-by: 黄思聪 <huangsicong@iie.ac.cn>
> Fixes: 391d8a2da787 ("NFC: Add NCI over SPI receive")
> Cc: <stable@vger.kernel.org>
> Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>

Thanks,

I agree that nci_skb_alloc() may turn NULL and that this
is an appropriate way to handle that.

As an aside, I observe that the return value of send_acknowledge()
is not checked. But I don't think that affects the correctness of this
change.

Reviewed-by: Simon Horman <horms@kernel.org>

[^](#m02ac7f3d6ec657ce071e784d3d7c288dc4114d93) [permalink](../../20231016112819.GL1501712%40kernel.org/) [raw](../../20231016112819.GL1501712%40kernel.org/raw) [reply](../../20231016112819.GL1501712%40kernel.org/#R)	[[flat](../../20231016112819.GL1501712%40kernel.org/T/#u)|[nested](../../20231016112819.GL1501712%40kernel.org/t/#u)] [3+ messages in thread](#r02ac7f3d6ec657ce071e784d3d7c288dc4114d93)
```

---

```
[*](#ef2060d60ac92f054fd3db21fe790c011cfadb02d) Re: [PATCH net-next] nfc: nci: fix possible NULL pointer dereference in send_acknowledge()
  2023-10-13 18:41 [[PATCH net-next] nfc: nci: fix possible NULL pointer dereference in send_acknowledge()](#m38bdbaf8ae15305b77f6c5bc8e15d38f405623c7) Krzysztof Kozlowski
  2023-10-16 11:28 ` [Simon Horman](#m02ac7f3d6ec657ce071e784d3d7c288dc4114d93)
@ 2023-10-17  0:50 ` patchwork-bot+netdevbpf
  [1 sibling, 0 replies; 3+ messages in thread](#rf2060d60ac92f054fd3db21fe790c011cfadb02d)
From: patchwork-bot+netdevbpf @ 2023-10-17  0:50 UTC ([permalink](../../169750382271.30000.6808834861432208355.git-patchwork-notify%40kernel.org/) / [raw](../../169750382271.30000.6808834861432208355.git-patchwork-notify%40kernel.org/raw))
  To: Krzysztof Kozlowski
  Cc: davem, edumazet, kuba, pabeni, sameo, frederic.danis, [netdev](../../../netdev/?t=20231017005023),
	[linux-kernel](../../../lkml/?t=20231017005023), huangsicong, [stable](../../../stable/?t=20231017005023)

Hello:

This patch was applied to netdev/net.git (main)
by Jakub Kicinski <kuba@kernel.org>:

On Fri, 13 Oct 2023 20:41:29 +0200 you wrote:
> Handle memory allocation failure from nci_skb_alloc() (calling
> alloc_skb()) to avoid possible NULL pointer dereference.
>
> Reported-by: 黄思聪 <huangsicong@iie.ac.cn>
> Fixes: 391d8a2da787 ("NFC: Add NCI over SPI receive")
> Cc: <stable@vger.kernel.org>
> Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
>
> [...]

Here is the summary with links:
  - [net-next] nfc: nci: fix possible NULL pointer dereference in send_acknowledge()
    <https://git.kernel.org/netdev/net/c/7937609cd387>

You are awesome, thank you!
--
Deet-doot-dot, I am a bot.
<https://korg.docs.kernel.org/patchwork/pwbot.html>

[^](#mf2060d60ac92f054fd3db21fe790c011cfadb02d) [permalink](../../169750382271.30000.6808834861432208355.git-patchwork-notify%40kernel.org/) [raw](../../169750382271.30000.6808834861432208355.git-patchwork-notify%40kernel.org/raw) [reply](../../169750382271.30000.6808834861432208355.git-patchwork-notify%40kernel.org/#R)	[[flat](../../169750382271.30000.6808834861432208355.git-patchwork-notify%40kernel.org/T/#u)|[nested](../../169750382271.30000.6808834861432208355.git-patchwork-notify%40kernel.org/t/#u)] [3+ messages in thread](#rf2060d60ac92f054fd3db21fe790c011cfadb02d)
```

---

```
end of thread, other threads:[[~2023-10-17  0:50 UTC](../../?t=20231017005023) | [newest](../../)]

Thread overview: 3+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2023-10-13 18:41 [[PATCH net-next] nfc: nci: fix possible NULL pointer dereference in send_acknowledge()](#m38bdbaf8ae15305b77f6c5bc8e15d38f405623c7) Krzysztof Kozlowski
2023-10-16 11:28 ` [Simon Horman](#m02ac7f3d6ec657ce071e784d3d7c288dc4114d93)
2023-10-17  0:50 ` [patchwork-bot+netdevbpf](#mf2060d60ac92f054fd3db21fe790c011cfadb02d)

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```


=== Content from git.kernel.org_eec1b73f_20250114_203038.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=7937609cd387246aed994e81aa4fa951358fba41)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=7937609cd387246aed994e81aa4fa951358fba41)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7937609cd387246aed994e81aa4fa951358fba41)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=7937609cd387246aed994e81aa4fa951358fba41)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org> | 2023-10-13 20:41:29 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2023-10-16 17:34:53 -0700 |
| commit | [7937609cd387246aed994e81aa4fa951358fba41](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=7937609cd387246aed994e81aa4fa951358fba41) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=7937609cd387246aed994e81aa4fa951358fba41)) | |
| tree | [63070df34f7e0ad79b9e57621dabb0ae0d439b3d](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=7937609cd387246aed994e81aa4fa951358fba41) | |
| parent | [503930f8e113edc86f92b767efb4ea57bdffffb2](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=503930f8e113edc86f92b767efb4ea57bdffffb2) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=7937609cd387246aed994e81aa4fa951358fba41&id2=503930f8e113edc86f92b767efb4ea57bdffffb2)) | |
| download | [linux-7937609cd387246aed994e81aa4fa951358fba41.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-7937609cd387246aed994e81aa4fa951358fba41.tar.gz) | |

nfc: nci: fix possible NULL pointer dereference in send\_acknowledge()Handle memory allocation failure from nci\_skb\_alloc() (calling
alloc\_skb()) to avoid possible NULL pointer dereference.
Reported-by: 黄思聪 <huangsicong@iie.ac.cn>
Fixes: 391d8a2da787 ("NFC: Add NCI over SPI receive")
Cc: <stable@vger.kernel.org>
Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20231013184129.18738-1-krzysztof.kozlowski@linaro.org](https://lore.kernel.org/r/20231013184129.18738-1-krzysztof.kozlowski%40linaro.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=7937609cd387246aed994e81aa4fa951358fba41)

| -rw-r--r-- | [net/nfc/nci/spi.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/nfc/nci/spi.c?id=7937609cd387246aed994e81aa4fa951358fba41) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/net/nfc/nci/spi.c b/net/nfc/nci/spi.cindex 0935527d1d12b5..b68150c971d0b1 100644--- a/[net/nfc/nci/spi.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/nfc/nci/spi.c?id=503930f8e113edc86f92b767efb4ea57bdffffb2)+++ b/[net/nfc/nci/spi.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/nfc/nci/spi.c?id=7937609cd387246aed994e81aa4fa951358fba41)@@ -151,6 +151,8 @@ static int send\_acknowledge(struct nci\_spi \*nspi, u8 acknowledge) int ret;  skb = nci\_skb\_alloc(nspi->ndev, 0, GFP\_KERNEL);+ if (!skb)+ return -ENOMEM;  /\* add the NCI SPI header to the start of the buffer \*/ hdr = skb\_push(skb, NCI\_SPI\_HDR\_LEN); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 20:29:15 +0000


