=== Content from github.com_4a85fe31_20250114_190625.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcapnproto%2Fcapnproto%2Fcommit%2Fe7f22da9c01286a2b0e1e5fbdf3ec9ab3aa128ff)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcapnproto%2Fcapnproto%2Fcommit%2Fe7f22da9c01286a2b0e1e5fbdf3ec9ab3aa128ff)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=capnproto%2Fcapnproto)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[capnproto](/capnproto)
/
**[capnproto](/capnproto/capnproto)**
Public

* [Notifications](/login?return_to=%2Fcapnproto%2Fcapnproto) You must be signed in to change notification settings
* [Fork
  933](/login?return_to=%2Fcapnproto%2Fcapnproto)
* [Star
   11.9k](/login?return_to=%2Fcapnproto%2Fcapnproto)

* [Code](/capnproto/capnproto)
* [Issues
  179](/capnproto/capnproto/issues)
* [Pull requests
  72](/capnproto/capnproto/pulls)
* [Discussions](/capnproto/capnproto/discussions)
* [Actions](/capnproto/capnproto/actions)
* [Projects
  0](/capnproto/capnproto/projects)
* [Wiki](/capnproto/capnproto/wiki)
* [Security](/capnproto/capnproto/security)
* [Insights](/capnproto/capnproto/pulse)

Additional navigation options

* [Code](/capnproto/capnproto)
* [Issues](/capnproto/capnproto/issues)
* [Pull requests](/capnproto/capnproto/pulls)
* [Discussions](/capnproto/capnproto/discussions)
* [Actions](/capnproto/capnproto/actions)
* [Projects](/capnproto/capnproto/projects)
* [Wiki](/capnproto/capnproto/wiki)
* [Security](/capnproto/capnproto/security)
* [Insights](/capnproto/capnproto/pulse)

## Commit

[Permalink](/capnproto/capnproto/commit/e7f22da9c01286a2b0e1e5fbdf3ec9ab3aa128ff)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix inconsistent decision about whether a WebSocket message is compre…

[Browse files](/capnproto/capnproto/tree/e7f22da9c01286a2b0e1e5fbdf3ec9ab3aa128ff)
Browse the repository at this point in the history

```
…ssed.

When processing the header, we decide whether the mesasge is compressed based on the presence of the appropriate flag in the header. However, after receiving the whole message, we were expecting it to be compressed based only on whether the session had negotiated compression upfront. With this patch we only rely on the bits in the header (and throw if the header says it is compressed, but we didn't negotiate compression.)
```

* Loading branch information

[![@kentonv](https://avatars.githubusercontent.com/u/4001805?s=40&v=4)](/kentonv)

[kentonv](/capnproto/capnproto/commits?author=kentonv "View all commits by kentonv")
committed
Nov 21, 2023

1 parent
[55880d1](/capnproto/capnproto/commit/55880d1fc662f083d0e1024ee3ee8cd553859687)

commit e7f22da

Showing
**1 changed file**
with
**12 additions**
and
**5 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

17 changes: 12 additions & 5 deletions

17
[c++/src/kj/compat/http.c++](#diff-09d28b46bd98866f20dd7241e02c70338a76fdb59a483ed02d4c16bbe6bcc3a1 "c++/src/kj/compat/http.c++")

Show comments

[View file](/capnproto/capnproto/blob/e7f22da9c01286a2b0e1e5fbdf3ec9ab3aa128ff/c%2B%2B/src/kj/compat/http.c%2B%2B)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2574,6 +2574,7 @@ public: |
|  |  | } |
|  |  |  |
|  |  | bool isFin = recvHeader.isFin(); |
|  |  | bool isCompressed = false; |
|  |  |  |
|  |  | kj::Array<byte> message; // space to allocate |
|  |  | byte\* payloadTarget; // location into which to read payload (size is payloadLen) |
| Expand All | | @@ -2584,6 +2585,7 @@ public: |
|  |  | // Add 4 since we append 0x00 0x00 0xFF 0xFF to the tail of the payload. |
|  |  | // See: https://datatracker.ietf.org/doc/html/rfc7692#section-7.2.2 |
|  |  | amountToAllocate = payloadLen + 4; |
|  |  | isCompressed = true; |
|  |  | } else { |
|  |  | // Add space for NUL terminator when allocating text message. |
|  |  | amountToAllocate = payloadLen + (opcode == OPCODE\_TEXT && isFin); |
| Expand Down  Expand Up | | @@ -2632,7 +2634,8 @@ public: |
|  |  | Mask mask = recvHeader.getMask(); |
|  |  |  |
|  |  | auto handleMessage = |
|  |  | [this,opcode,payloadTarget,payloadLen,mask,isFin,maxSize,originalMaxSize,message=kj::mv(message)]() mutable |
|  |  | [this,opcode,payloadTarget,payloadLen,mask,isFin,maxSize,originalMaxSize, |
|  |  | isCompressed,message=kj::mv(message)]() mutable |
|  |  | -> kj::Promise<Message> { |
|  |  | if (!mask.isZero()) { |
|  |  | mask.apply(kj::arrayPtr(payloadTarget, payloadLen)); |
| Expand All | | @@ -2651,16 +2654,18 @@ public: |
|  |  | KJ\_UNREACHABLE; |
|  |  | case OPCODE\_TEXT: |
|  |  | #if KJ\_HAS\_ZLIB |
|  |  | KJ\_IF\_MAYBE(config, compressionConfig) { |
|  |  | if (isCompressed) { |
|  |  | auto& config = KJ\_ASSERT\_NONNULL(compressionConfig); |
|  |  | auto& decompressor = KJ\_ASSERT\_NONNULL(decompressionContext); |
|  |  | KJ\_ASSERT(message.size() >= 4); |
|  |  | auto tail = message.slice(message.size() - 4, message.size()); |
|  |  | // Note that we added an additional 4 bytes to `message`s capacity to account for these |
|  |  | // extra bytes. See `amountToAllocate` in the if(recvHeader.isCompressed()) block above. |
|  |  | const byte tailBytes[] = {0x00, 0x00, 0xFF, 0xFF}; |
|  |  | memcpy(tail.begin(), tailBytes, sizeof(tailBytes)); |
|  |  | // We have to append 0x00 0x00 0xFF 0xFF to the message before inflating. |
|  |  | // See: https://datatracker.ietf.org/doc/html/rfc7692#section-7.2.2 |
|  |  | if (config->inboundNoContextTakeover) { |
|  |  | if (config.inboundNoContextTakeover) { |
|  |  | // We must reset context on each message. |
|  |  | decompressor.reset(); |
|  |  | } |
| Expand All | | @@ -2675,16 +2680,18 @@ public: |
|  |  | return Message(kj::String(message.releaseAsChars())); |
|  |  | case OPCODE\_BINARY: |
|  |  | #if KJ\_HAS\_ZLIB |
|  |  | KJ\_IF\_MAYBE(config, compressionConfig) { |
|  |  | if (isCompressed) { |
|  |  | auto& config = KJ\_ASSERT\_NONNULL(compressionConfig); |
|  |  | auto& decompressor = KJ\_ASSERT\_NONNULL(decompressionContext); |
|  |  | KJ\_ASSERT(message.size() >= 4); |
|  |  | auto tail = message.slice(message.size() - 4, message.size()); |
|  |  | // Note that we added an additional 4 bytes to `message`s capacity to account for these |
|  |  | // extra bytes. See `amountToAllocate` in the if(recvHeader.isCompressed()) block above. |
|  |  | const byte tailBytes[] = {0x00, 0x00, 0xFF, 0xFF}; |
|  |  | memcpy(tail.begin(), tailBytes, sizeof(tailBytes)); |
|  |  | // We have to append 0x00 0x00 0xFF 0xFF to the message before inflating. |
|  |  | // See: https://datatracker.ietf.org/doc/html/rfc7692#section-7.2.2 |
|  |  | if (config->inboundNoContextTakeover) { |
|  |  | if (config.inboundNoContextTakeover) { |
|  |  | // We must reset context on each message. |
|  |  | decompressor.reset(); |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e7f22da`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcapnproto%2Fcapnproto%2Fcommit%2Fe7f22da9c01286a2b0e1e5fbdf3ec9ab3aa128ff) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ebaddeed_20250114_190625.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcapnproto%2Fcapnproto%2Fsecurity%2Fadvisories%2FGHSA-r89h-f468-62w3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcapnproto%2Fcapnproto%2Fsecurity%2Fadvisories%2FGHSA-r89h-f468-62w3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=capnproto%2Fcapnproto)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[capnproto](/capnproto)
/
**[capnproto](/capnproto/capnproto)**
Public

* [Notifications](/login?return_to=%2Fcapnproto%2Fcapnproto) You must be signed in to change notification settings
* [Fork
  933](/login?return_to=%2Fcapnproto%2Fcapnproto)
* [Star
   11.9k](/login?return_to=%2Fcapnproto%2Fcapnproto)

* [Code](/capnproto/capnproto)
* [Issues
  179](/capnproto/capnproto/issues)
* [Pull requests
  72](/capnproto/capnproto/pulls)
* [Discussions](/capnproto/capnproto/discussions)
* [Actions](/capnproto/capnproto/actions)
* [Projects
  0](/capnproto/capnproto/projects)
* [Wiki](/capnproto/capnproto/wiki)
* [Security](/capnproto/capnproto/security)
* [Insights](/capnproto/capnproto/pulse)

Additional navigation options

* [Code](/capnproto/capnproto)
* [Issues](/capnproto/capnproto/issues)
* [Pull requests](/capnproto/capnproto/pulls)
* [Discussions](/capnproto/capnproto/discussions)
* [Actions](/capnproto/capnproto/actions)
* [Projects](/capnproto/capnproto/projects)
* [Wiki](/capnproto/capnproto/wiki)
* [Security](/capnproto/capnproto/security)
* [Insights](/capnproto/capnproto/pulse)

# WebSocket message can cause crash

Moderate

[kentonv](/kentonv)
published
GHSA-r89h-f468-62w3
Nov 21, 2023

## Package

capnproto
(C++)

## Affected versions

1.0,1.0.1

## Patched versions

1.0.1.1

## Description

# Problem

When using the KJ HTTP library with WebSocket compression enabled, a buffer underrun can be caused by a remote peer. The underrun always writes a constant value that is not attacker-controlled, likely resulting in a crash, enabling a remote denial-of-service attack.

Most Cap'n Proto and KJ users are unlikely to have this functionality enabled and so unlikely to be affected. We suspect only [the Cloudflare Workers Runtime](https://github.com/cloudflare/workerd) is affected.

# Discovered by

Cloudflare Workers team

# Announced

2023-11-21

# CVE

CVE-2023-48230

# Impact

* If KJ HTTP is used with WebSocket compression enabled, a malicious peer may be able to cause a buffer underrun on a heap-allocated buffer.
* KJ HTTP is an optional library bundled with Cap'n Proto, but is not directly used by Cap'n Proto. If you haven't heard of it, you probably aren't using it.
* WebSocket compression is disabled by default. It must be enabled via a setting passed to the KJ HTTP library via `HttpClientSettings` or `HttpServerSettings`. We suspect no one uses this setting today except for Cloudflare Workers.
* The bytes written out-of-bounds are always a specific constant 4-byte string `{ 0x00, 0x00, 0xFF, 0xFF }`. Because this string is not controlled by the attacker, we suspect it is unlikely that remote code execution is possible. However, it cannot be ruled out.
* This functionality first appeared in Cap'n Proto 1.0. Previous versions are not affected.

# Fixed in

C++ fix:

* git commits:
  + `master` (1.x) branch: [e7f22da9c01286a2b0e1e5fbdf3ec9ab3aa128ff](https://github.com/capnproto/capnproto/commit/e7f22da9c01286a2b0e1e5fbdf3ec9ab3aa128ff)
  + `v2` branch: [75c5c1499aa6e7690b741204ff9af91cce526c59](https://github.com/capnproto/capnproto/commit/75c5c1499aa6e7690b741204ff9af91cce526c59)
* release 1.0.1.1:
  + Unix: [https://capnproto.org/capnproto-c++-1.0.1.1.tar.gz](https://capnproto.org/capnproto-c%2B%2B-1.0.1.1.tar.gz)
  + Windows: [https://capnproto.org/capnproto-c++-win32-1.0.1.1.zip](https://capnproto.org/capnproto-c%2B%2B-win32-1.0.1.1.zip)

# Details

KJ is a C++ toolkit library that evolved along with the Cap'n Proto C++ implementation. While it originally contained only a few utilities used by Cap'n Proto itself, it has grown over time with quite a few features. One of the larger features is an HTTP/1.1 implementation, complete with WebSocket support. KJ's HTTP library is used by the Cloudflare Workers runtime.

In 2022, the Cloudflare Workers team added support for the WebSocket compression extension to KJ HTTP. The feature is enabled by default for Workers whose [compatibility date](https://developers.cloudflare.com/workers/configuration/compatibility-dates/#websocket-compression) is `2023-08-15` or later. That is, this feature only became enabled by default recently, and only for new Workers or Workers that updated their compatibility date.

A bug in the code caused it to improperly handle the case where compression had been negotiated, but a particular message received from the peer was not compressed, i.e. did not have the compression bit set in the frame header. The code would correctly allocate buffer space for a non-compressed message. However, later on, the code incorrectly treated the message as compressed, and therefore attempted to prefix it with the constant string `{ 0x00, 0x00, 0xFF, 0xFF }` which must be added before passing the bytes to zlib. Since the buffer was not allocated with space for these bytes, they would be written into the four bytes preceding the buffer instead.

In most cases, this had the effect of overwriting state maintained by the memory allocator, causing a subsequent memory allocation operation to crash.

Because the bytes are always a constant string, not attacker-controlled, it seems difficult to leverage this overrun to achieve code execution. However, we cannot rule out an excessively clever exploit.

The bug was discovered when it was triggered in production, and was quickly patched. The occurrences in production were benign, not an attack. It is normal for some WebSocket implementations to negotiate compression but then opportunistically skip it when it doesn't help, which would trigger the bug.

### Severity

Moderate

### CVE ID

CVE-2023-48230

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_2d7778e6_20250114_190623.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcapnproto%2Fcapnproto%2Fcommit%2F75c5c1499aa6e7690b741204ff9af91cce526c59)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcapnproto%2Fcapnproto%2Fcommit%2F75c5c1499aa6e7690b741204ff9af91cce526c59)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=capnproto%2Fcapnproto)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[capnproto](/capnproto)
/
**[capnproto](/capnproto/capnproto)**
Public

* [Notifications](/login?return_to=%2Fcapnproto%2Fcapnproto) You must be signed in to change notification settings
* [Fork
  933](/login?return_to=%2Fcapnproto%2Fcapnproto)
* [Star
   11.9k](/login?return_to=%2Fcapnproto%2Fcapnproto)

* [Code](/capnproto/capnproto)
* [Issues
  179](/capnproto/capnproto/issues)
* [Pull requests
  72](/capnproto/capnproto/pulls)
* [Discussions](/capnproto/capnproto/discussions)
* [Actions](/capnproto/capnproto/actions)
* [Projects
  0](/capnproto/capnproto/projects)
* [Wiki](/capnproto/capnproto/wiki)
* [Security](/capnproto/capnproto/security)
* [Insights](/capnproto/capnproto/pulse)

Additional navigation options

* [Code](/capnproto/capnproto)
* [Issues](/capnproto/capnproto/issues)
* [Pull requests](/capnproto/capnproto/pulls)
* [Discussions](/capnproto/capnproto/discussions)
* [Actions](/capnproto/capnproto/actions)
* [Projects](/capnproto/capnproto/projects)
* [Wiki](/capnproto/capnproto/wiki)
* [Security](/capnproto/capnproto/security)
* [Insights](/capnproto/capnproto/pulse)

## Commit

[Permalink](/capnproto/capnproto/commit/75c5c1499aa6e7690b741204ff9af91cce526c59)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix inconsistent decision about whether a WebSocket message is compre…

[Browse files](/capnproto/capnproto/tree/75c5c1499aa6e7690b741204ff9af91cce526c59)
Browse the repository at this point in the history

```
…ssed.

When processing the header, we decide whether the mesasge is compressed based on the presence of the appropriate flag in the header. However, after receiving the whole message, we were expecting it to be compressed based only on whether the session had negotiated compression upfront. With this patch we only rely on the bits in the header (and throw if the header says it is compressed, but we didn't negotiate compression.)
```

* Loading branch information

[![@kentonv](https://avatars.githubusercontent.com/u/4001805?s=40&v=4)](/kentonv)

[kentonv](/capnproto/capnproto/commits?author=kentonv "View all commits by kentonv")
committed
Nov 16, 2023

1 parent
[cd841b4](/capnproto/capnproto/commit/cd841b4414e3f4f9affaef9adaeca2cb9b2300e0)

commit 75c5c14

Showing
**1 changed file**
with
**10 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

13 changes: 10 additions & 3 deletions

13
[c++/src/kj/compat/http.c++](#diff-09d28b46bd98866f20dd7241e02c70338a76fdb59a483ed02d4c16bbe6bcc3a1 "c++/src/kj/compat/http.c++")

Show comments

[View file](/capnproto/capnproto/blob/75c5c1499aa6e7690b741204ff9af91cce526c59/c%2B%2B/src/kj/compat/http.c%2B%2B)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2761,6 +2761,7 @@ public: |
|  |  | } |
|  |  |  |
|  |  | bool isFin = recvHeader.isFin(); |
|  |  | bool isCompressed = false; |
|  |  |  |
|  |  | kj::Array<byte> message; // space to allocate |
|  |  | byte\* payloadTarget; // location into which to read payload (size is payloadLen) |
| Expand All | | @@ -2771,6 +2772,7 @@ public: |
|  |  | // Add 4 since we append 0x00 0x00 0xFF 0xFF to the tail of the payload. |
|  |  | // See: https://datatracker.ietf.org/doc/html/rfc7692#section-7.2.2 |
|  |  | amountToAllocate = payloadLen + 4; |
|  |  | isCompressed = true; |
|  |  | } else { |
|  |  | // Add space for NUL terminator when allocating text message. |
|  |  | amountToAllocate = payloadLen + (opcode == OPCODE\_TEXT && isFin); |
| Expand Down  Expand Up | | @@ -2819,7 +2821,8 @@ public: |
|  |  | Mask mask = recvHeader.getMask(); |
|  |  |  |
|  |  | auto handleMessage = |
|  |  | [this,opcode,payloadTarget,payloadLen,mask,isFin,maxSize,originalMaxSize,message=kj::mv(message)]() mutable |
|  |  | [this,opcode,payloadTarget,payloadLen,mask,isFin,maxSize,originalMaxSize, |
|  |  | isCompressed,message=kj::mv(message)]() mutable |
|  |  | -> kj::Promise<Message> { |
|  |  | if (!mask.isZero()) { |
|  |  | mask.apply(kj::arrayPtr(payloadTarget, payloadLen)); |
| Expand All | | @@ -2838,8 +2841,10 @@ public: |
|  |  | KJ\_UNREACHABLE; |
|  |  | case OPCODE\_TEXT: |
|  |  | #if KJ\_HAS\_ZLIB |
|  |  | KJ\_IF\_SOME(config, compressionConfig) { |
|  |  | if (isCompressed) { |
|  |  | auto& config = KJ\_ASSERT\_NONNULL(compressionConfig); |
|  |  | auto& decompressor = KJ\_ASSERT\_NONNULL(decompressionContext); |
|  |  | KJ\_ASSERT(message.size() >= 4); |
|  |  | auto tail = message.slice(message.size() - 4, message.size()); |
|  |  | // Note that we added an additional 4 bytes to `message`s capacity to account for these |
|  |  | // extra bytes. See `amountToAllocate` in the if(recvHeader.isCompressed()) block above. |
| Expand All | | @@ -2862,8 +2867,10 @@ public: |
|  |  | return Message(kj::String(message.releaseAsChars())); |
|  |  | case OPCODE\_BINARY: |
|  |  | #if KJ\_HAS\_ZLIB |
|  |  | KJ\_IF\_SOME(config, compressionConfig) { |
|  |  | if (isCompressed) { |
|  |  | auto& config = KJ\_ASSERT\_NONNULL(compressionConfig); |
|  |  | auto& decompressor = KJ\_ASSERT\_NONNULL(decompressionContext); |
|  |  | KJ\_ASSERT(message.size() >= 4); |
|  |  | auto tail = message.slice(message.size() - 4, message.size()); |
|  |  | // Note that we added an additional 4 bytes to `message`s capacity to account for these |
|  |  | // extra bytes. See `amountToAllocate` in the if(recvHeader.isCompressed()) block above. |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `75c5c14`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcapnproto%2Fcapnproto%2Fcommit%2F75c5c1499aa6e7690b741204ff9af91cce526c59) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


