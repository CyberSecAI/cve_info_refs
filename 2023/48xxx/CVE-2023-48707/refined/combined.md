=== Content from github.com_093a7ca8_20250114_220028.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fsecurity%2Fadvisories%2FGHSA-v427-c49j-8w6x)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fsecurity%2Fadvisories%2FGHSA-v427-c49j-8w6x)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=codeigniter4%2Fshield)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[codeigniter4](/codeigniter4)
/
**[shield](/codeigniter4/shield)**
Public

* [Notifications](/login?return_to=%2Fcodeigniter4%2Fshield) You must be signed in to change notification settings
* [Fork
  132](/login?return_to=%2Fcodeigniter4%2Fshield)
* [Star
   372](/login?return_to=%2Fcodeigniter4%2Fshield)

* [Code](/codeigniter4/shield)
* [Issues
  5](/codeigniter4/shield/issues)
* [Pull requests
  12](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects
  0](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

Additional navigation options

* [Code](/codeigniter4/shield)
* [Issues](/codeigniter4/shield/issues)
* [Pull requests](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

# Cleartext Storage of Sensitive Information in HMAC SHA256 Authentication

Moderate

[kenjis](/kenjis)
published
GHSA-v427-c49j-8w6x
Nov 23, 2023

## Package

composer

codeigniter4/shield
([Composer](/advisories?query=ecosystem%3Acomposer))

## Affected versions

< 1.0.0-beta.8

## Patched versions

1.0.0-beta.8

## Description

### Impact

**secretKey**, an important key for HMAC SHA256 authentication, was stored in the database in raw form.

If a malicious person somehow had access to the data in the database, they could use the key and secretKey for HMAC SHA256 authentication to send requests impersonating that person.

### Patches

Upgrade to Shield v1.0.0-beta.8 or later.

After upgrading, all existing secret keys must be encrypted.

See <https://github.com/codeigniter4/shield/blob/develop/UPGRADING.md> for details.

### Workarounds

None.

### References

* <https://codeigniter4.github.io/shield/references/authentication/hmac/>

### For more information

If you have any questions or comments about this advisory:

* Open an issue or discussion in [codeigniter4/shield](https://github.com/codeigniter4/shield)
* Email us at security@codeigniter.com

### Severity

Moderate

5.0

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
High

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
Low

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:U/C:H/I:L/A:N

### CVE ID

CVE-2023-48707

### Weaknesses

[CWE-312](/advisories?query=cwe%3A312)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d3ec8cb4_20250114_220025.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fcommit%2Ff77c6ae20275ac1245330a2b9a523bf7e6f6202f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fcommit%2Ff77c6ae20275ac1245330a2b9a523bf7e6f6202f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=codeigniter4%2Fshield)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[codeigniter4](/codeigniter4)
/
**[shield](/codeigniter4/shield)**
Public

* [Notifications](/login?return_to=%2Fcodeigniter4%2Fshield) You must be signed in to change notification settings
* [Fork
  132](/login?return_to=%2Fcodeigniter4%2Fshield)
* [Star
   372](/login?return_to=%2Fcodeigniter4%2Fshield)

* [Code](/codeigniter4/shield)
* [Issues
  5](/codeigniter4/shield/issues)
* [Pull requests
  12](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects
  0](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

Additional navigation options

* [Code](/codeigniter4/shield)
* [Issues](/codeigniter4/shield/issues)
* [Pull requests](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

## Commit

[Permalink](/codeigniter4/shield/commit/f77c6ae20275ac1245330a2b9a523bf7e6f6202f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-v427-c49j-8w6x](https://github.com/advisories/GHSA-v427-c49j-8w6x "GHSA-v427-c49j-8w6x")

[Browse files](/codeigniter4/shield/tree/f77c6ae20275ac1245330a2b9a523bf7e6f6202f)
Browse the repository at this point in the history

```
fix: Cleartext Storage of Sensitive Information in HMAC SHA256 Authentication
```

* Loading branch information

[![@kenjis](https://avatars.githubusercontent.com/u/87955?s=40&v=4)](/kenjis)

[kenjis](/codeigniter4/shield/commits?author=kenjis "View all commits by kenjis")
authored
Nov 22, 2023

2 parents
[7d41423](/codeigniter4/shield/commit/7d414230d4b32dbffdc78045e0e8c305f2846230)
+
[363183d](/codeigniter4/shield/commit/363183dbf9298629a773464f01c23fd241f9a556)

commit f77c6ae

 Show file tree

 Hide file tree

Showing
**15 changed files**
with
**818 additions**
and
**40 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* UPGRADING.md
  [UPGRADING.md](#diff-f411a5009131db5a6c7242b49ca78488f2d274ef9e5e5f4de9262a42108a5386)
* docs

  + guides

    - docs/guides/api\_hmac\_keys.md
      [api\_hmac\_keys.md](#diff-f50e07b5c0268fc6cc1eef7f0eec2b877479d152e64a39cd9a53c85216dedc85)
  + references/authentication

    - docs/references/authentication/hmac.md
      [hmac.md](#diff-9f5b4bf7694d7c6a7acdc75f3d93861c82038d40ce0ce58ac61d2524f7e2e245)
* phpunit.xml.dist
  [phpunit.xml.dist](#diff-e35810879ec42bdd81797b3ccb72f6de28a8b4a0e3bfdba43183e133e866b892)
* src

  + Authentication

    - Authenticators

      * src/Authentication/Authenticators/HmacSha256.php
        [HmacSha256.php](#diff-e296899f7db51e66ae5504de03cb4c6f54637e9df9fb5685a645d40be4b11c43)
    - HMAC

      * src/Authentication/HMAC/HmacEncrypter.php
        [HmacEncrypter.php](#diff-3473740c075026f024181063b9d328968a88a0fb36be981cfe037a5bde7bd2fc)
  + Commands

    - src/Commands/Hmac.php
      [Hmac.php](#diff-15adf4d4c63e4fb5eca4d391e83d422df67716666227d463dafe74ddf46d12b3)
    - src/Commands/Setup.php
      [Setup.php](#diff-e7d447d4d562ef61dd55fbce6e722b0c0bcb132f869a551fd4cdbff9c47f7928)
  + Config

    - src/Config/AuthToken.php
      [AuthToken.php](#diff-030358efc956ecc8de95e9223e1ad956a988a25bbdabc40d7c0fd879989c5d89)
    - src/Config/BaseAuthToken.php
      [BaseAuthToken.php](#diff-707e636400788181d0865264fd08b7e0632bf1ef53349d3b9d1fa43519730ea4)
  + Models

    - src/Models/UserIdentityModel.php
      [UserIdentityModel.php](#diff-12f8a17432494066924f6a102ff6af33c7e2908398d935aacccbb59efd641310)
* tests

  + Authentication

    - Authenticators

      * tests/Authentication/Authenticators/HmacAuthenticatorTest.php
        [HmacAuthenticatorTest.php](#diff-c55cff55fb54e89b47faf5054701fab522cf25b39fe3aa1df27f64d7a5440a97)
    - Filters

      * tests/Authentication/Filters/HmacFilterTest.php
        [HmacFilterTest.php](#diff-80da4f5a71be5249183e84f8e5353c98509d5d2261269aa79948f1716ca5b810)
    - tests/Authentication/HasHmacTokensTest.php
      [HasHmacTokensTest.php](#diff-3fb6bf504ba8d8874e960df42dcb83990876705d7a70de8f07fd86ab55bdc50c)
  + Commands

    - tests/Commands/HmacTest.php
      [HmacTest.php](#diff-ccd8f751298d1eb64f455153f83f201fd20812bf3f5195beda84d869c76f7f18)

## There are no files selected for viewing

21 changes: 20 additions & 1 deletion

21
[UPGRADING.md](#diff-f411a5009131db5a6c7242b49ca78488f2d274ef9e5e5f4de9262a42108a5386 "UPGRADING.md")

Show comments

[View file](/codeigniter4/shield/blob/f77c6ae20275ac1245330a2b9a523bf7e6f6202f/UPGRADING.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -45,9 +45,28 @@ protected function redirectToDeniedUrl(): RedirectResponse |
|  |  | { |
|  |  | return redirect()->to(config('Auth')->groupDeniedRedirect()) |
|  |  | ->with('error', lang('Auth.notEnoughPrivilege')); |
|  |  | } |
|  |  | } |
|  |  | ``` |
|  |  |  |
|  |  | ### Fix to HMAC Secret Key Encryption |
|  |  |  |
|  |  | #### Config\AuthToken |
|  |  |  |
|  |  | If you are using the HMAC authentication you need to update the encryption settings in \*\*app/Config/AuthToken.php\*\*. |
|  |  | You will need to update and set the encryption key in `$hmacEncryptionKeys`. This should be set using \*\*.env\*\* and/or |
|  |  | system environment variables. Instructions on how to do that can be found in the |
|  |  | [Setting Your Encryption Key](https://codeigniter.com/user\_guide/libraries/encryption.html#setting-your-encryption-key) |
|  |  | section of the CodeIgniter 4 documentation and in [HMAC SHA256 Token Authenticator](./docs/references/authentication/hmac.md#hmac-secret-key-encryption). |
|  |  |  |
|  |  | You also may wish to adjust the default Driver `$hmacEncryptionDefaultDriver` and the default Digest |
|  |  | `$hmacEncryptionDefaultDigest`, these currently default to `'OpenSSL'` and `'SHA512'` respectively. |
|  |  |  |
|  |  | #### Encrypt Existing Keys |
|  |  |  |
|  |  | After updating the key in `$hmacEncryptionKeys` value, you will need to run `php spark shield:hmac encrypt` in order |
|  |  | to encrypt any existing HMAC tokens. This only needs to be run if you have existing unencrypted HMAC secretKeys in |
|  |  | stored in the database. |
|  |  |  |
|  |  | ## Version 1.0.0-beta.6 to 1.0.0-beta.7 |
|  |  |  |
|  |  | ### The minimum CodeIgniter version |
| Expand Down | |  |

32 changes: 26 additions & 6 deletions

32
[docs/guides/api\_hmac\_keys.md](#diff-f50e07b5c0268fc6cc1eef7f0eec2b877479d152e64a39cd9a53c85216dedc85 "docs/guides/api_hmac_keys.md")

Show comments

[View file](/codeigniter4/shield/blob/f77c6ae20275ac1245330a2b9a523bf7e6f6202f/docs/guides/api_hmac_keys.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -15,10 +15,11 @@ API. When making requests using HMAC keys, the token should be included in the ` |
|  |  | setting the `$authenticatorHeader['hmac']` value in the \*\*app/Config/AuthToken.php\*\* config file. |
|  |  |  |
|  |  | Tokens are issued with the `generateHmacToken()` method on the user. This returns a |
|  |  | `CodeIgniter\Shield\Entities\AccessToken` instance. These shared keys are saved to the database in plain text. The |
|  |  | `AccessToken` object returned when you generate it will include a `secret` field which will be the `key` and a `secret2` |
|  |  | field that will be the `secretKey`. You should display the `secretKey` to your user once, so they have a chance to copy |
|  |  | it somewhere safe, as this is the only time you should reveal this key. |
|  |  | `CodeIgniter\Shield\Entities\AccessToken` instance. The `AccessToken` object returned will include a `secret` field |
|  |  | which will be the '\*\*key\*\*' and a `rawSecretKey` field that will be the '\*\*secretKey\*\*'. You should display the |
|  |  | '\*\*secretKey\*\*' to your user immediately, so they have a chance to copy it somewhere safe, as this is the only time |
|  |  | you can reveal this key. The '\*\*key\*\*' and '\*\*secretKey\*\*' are saved to the database. The '\*\*secretKey\*\*' is stored |
|  |  | encrypted. |
|  |  |  |
|  |  | The `generateHmacToken()` method requires a name for the token. These are free strings and are often used to identify |
|  |  | the user/device the token was generated from/for, like 'Johns MacBook Air'. |
| Expand All | | @@ -27,7 +28,7 @@ the user/device the token was generated from/for, like 'Johns MacBook Air'. |
|  |  | $routes->get('hmac/token', static function () { |
|  |  | $token = auth()->user()->generateHmacToken(service('request')->getVar('token\_name')); |
|  |  |  |
|  |  | return json\_encode(['key' => $token->secret, 'secretKey' => $token->secret2]); |
|  |  | return json\_encode(['key' => $token->secret, 'secretKey' => $token->rawSecretKey]); |
|  |  | }); |
|  |  | ``` |
|  |  |  |
| Expand Down  Expand Up | | @@ -62,7 +63,7 @@ token is granted all access to all scopes. This might be enough for a smaller AP |
|  |  |  |
|  |  | ```php |
|  |  | $token = $user->generateHmacToken('token-name', ['users-read']); |
|  |  | return json\_encode(['key' => $token->secret, 'secretKey' => $token->secret2]); |
|  |  | return json\_encode(['key' => $token->secret, 'secretKey' => $token->rawSecretKey]); |
|  |  | ``` |
|  |  |  |
|  |  | !!! note |
| Expand All | | @@ -87,6 +88,25 @@ $user->revokeHmacToken($key); |
|  |  | $user->revokeAllHmacTokens(); |
|  |  | ``` |
|  |  |  |
|  |  | ## HMAC Secret Key Encryption |
|  |  |  |
|  |  | The HMAC Secret Key is stored encrypted. Before you start using HMAC, you will need to set/override the encryption key |
|  |  | in `$hmacEncryptionKeys` in \*\*app/Config/AuthToken.php\*\*. This should be set using \*\*.env\*\* and/or system |
|  |  | environment variables. Instructions on how to do that can be found in the |
|  |  | [Setting Your Encryption Key](https://codeigniter.com/user\_guide/libraries/encryption.html#setting-your-encryption-key) |
|  |  | section of the CodeIgniter 4 documentation. |
|  |  |  |
|  |  | You will also be able to adjust the default Driver `$hmacEncryptionDefaultDriver` and the default Digest |
|  |  | `$hmacEncryptionDefaultDigest`, these default to `'OpenSSL'` and `'SHA512'` respectively. |
|  |  |  |
|  |  | See [HMAC SHA256 Token Authenticator](../references/authentication/hmac.md#hmac-secret-key-encryption) for additional |
|  |  | details on setting these values. |
|  |  |  |
|  |  | ### Encryption Key Rotation |
|  |  |  |
|  |  | See [HMAC SHA256 Token Authenticator](../references/authentication/hmac.md#hmac-secret-key-encryption) for information on |
|  |  | how to set, rotate encryption keys and re-encrypt existing HMAC `'secretKey'` values. |
|  |  |  |
|  |  | ## Protecting Routes |
|  |  |  |
|  |  | The first way to specify which routes are protected is to use the `hmac` controller filter. |
| Expand Down | |  |

77 changes: 70 additions & 7 deletions

77
[docs/references/authentication/hmac.md](#diff-9f5b4bf7694d7c6a7acdc75f3d93861c82038d40ce0ce58ac61d2524f7e2e245 "docs/references/authentication/hmac.md")

Show comments

[View file](/codeigniter4/shield/blob/f77c6ae20275ac1245330a2b9a523bf7e6f6202f/docs/references/authentication/hmac.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -7,7 +7,7 @@ access to your API. These keys typically have a very long expiration time, often |
|  |  |  |
|  |  | These are also suitable for use with mobile applications. In this case, the user would register/sign-in |
|  |  | with their email/password. The application would create a new access token for them, with a recognizable |
|  |  | name, like John's iPhone 12, and return it to the mobile application, where it is stored and used |
|  |  | name, like "John's iPhone 12", and return it to the mobile application, where it is stored and used |
|  |  | in all future requests. |
|  |  |  |
|  |  | !!! note |
| Expand Down  Expand Up | | @@ -67,19 +67,19 @@ $token = $user->generateHmacToken('Work Laptop'); |
|  |  | ``` |
|  |  |  |
|  |  | This creates the keys/tokens using a cryptographically secure random string. The keys operate as shared keys. |
|  |  | This means they are stored as-is in the database. The method returns an instance of |
|  |  | `CodeIgniters\Shield\Authentication\Entities\AccessToken`. The field `secret` is the 'key' the field `secret2` is |
|  |  | the shared 'secretKey'. Both are required to when using this authentication method. |
|  |  | The '\*\*key\*\*' is stored as plain text in the database, the '\*\*secretKey\*\*' is stored encrypted. The method returns an |
|  |  | instance of `CodeIgniters\Shield\Authentication\Entities\AccessToken`. The field `secret` is the '\*\*key\*\*' the field |
|  |  | `rawSecretKey` is the shared '\*\*secretKey\*\*'. Both are required to when using this authentication method. |
|  |  |  |
|  |  | \*\*The plain text version of these keys should be displayed to the user immediately, so they can copy it for |
|  |  | their use.\*\* It is recommended that after that only the 'key' field is displayed to a user.  If a user loses the |
|  |  | 'secretKey', they should be required to generate a new set of keys to use. |
|  |  | their use.\*\* It is recommended that after that only the '\*\*key\*\*' field is displayed to a user. If a user loses the |
|  |  | '\*\*secretKey\*\*', they should be required to generate a new set of keys to use. |
|  |  |  |
|  |  | ```php |
|  |  | $token = $user->generateHmacToken('Work Laptop'); |
|  |  |  |
|  |  | echo 'Key: ' . $token->secret; |
|  |  | echo 'SecretKey: ' . $token->secret2; |
|  |  | echo 'SecretKey: ' . $token->rawSecretKey; |
|  |  | ``` |
|  |  |  |
|  |  | ## Revoking HMAC Keys |
| Expand Down  Expand Up | | @@ -156,3 +156,66 @@ if ($user->hmacTokenCant('forums.manage')) { |
|  |  | // do something.... |
|  |  | } |
|  |  | ``` |
|  |  |  |
|  |  | ## HMAC Secret Key Encryption |
|  |  |  |
|  |  | The HMAC Secret Key is stored encrypted. Before you start using HMAC, you will need to set/override the encryption key |
|  |  | in `$hmacEncryptionKeys` in \*\*app/Config/AuthToken.php\*\*. This should be set using \*\*.env\*\* and/or system |
|  |  | environment variables. Instructions on how to do that can be found in the |
|  |  | [Setting Your Encryption Key](https://codeigniter.com/user\_guide/libraries/encryption.html#setting-your-encryption-key) |
|  |  | section of the CodeIgniter 4 documentation. |
|  |  |  |
|  |  | You will also be able to adjust the default Driver `$hmacEncryptionDefaultDriver` and the default Digest |
|  |  | `$hmacEncryptionDefaultDigest`, these default to `'OpenSSL'` and `'SHA512'` respectively. These can also be |
|  |  | overridden for an individual key by including them in the keys array. |
|  |  |  |
|  |  | ```php |
|  |  | public $hmacEncryptionKeys = [ |
|  |  | 'k1' => [ |
|  |  | 'key' => 'hex2bin:923dfab5ddca0c7784c2c388a848a704f5e048736c1a852c862959da62ade8c7', |
|  |  | ], |
|  |  | ]; |
|  |  |  |
|  |  | public string $hmacEncryptionCurrentKey = 'k1'; |
|  |  | public string $hmacEncryptionDefaultDriver = 'OpenSSL'; |
|  |  | public string $hmacEncryptionDefaultDigest = 'SHA512'; |
|  |  | ``` |
|  |  |  |
|  |  | When it is time to update your encryption keys you will need to add an additional key to the above |
|  |  | `$hmacEncryptionKeys` array. Then adjust the `$hmacEncryptionCurrentKey` to point at the new key. After the new |
|  |  | encryption key is in place, run `php spark shield:hmac reencrypt` to re-encrypt all existing keys with the new |
|  |  | encryption key. You will need to leave the old key in the array as it will be used read the existing 'Secret Keys' |
|  |  | during re-encryption. |
|  |  |  |
|  |  | ```php |
|  |  | public $hmacEncryptionKeys = [ |
|  |  | 'k1' => [ |
|  |  | 'key' => 'hex2bin:923dfab5ddca0c7784c2c388a848a704f5e048736c1a852c862959da62ade8c7', |
|  |  | ], |
|  |  | 'k2' => [ |
|  |  | 'key' => 'hex2bin:451df599363b19be1434605fff8556a0bbfc50bede1bb33793dcde4d97fce4b0', |
|  |  | 'digest' => 'SHA256', |
|  |  | ], |
|  |  | ]; |
|  |  |  |
|  |  | public string $hmacEncryptionCurrentKey = 'k2'; |
|  |  | public string $hmacEncryptionDefaultDriver = 'OpenSSL'; |
|  |  | public string $hmacEncryptionDefaultDigest = 'SHA512'; |
|  |  |  |
|  |  | ``` |
|  |  |  |
|  |  | ```console |
|  |  | php spark shield:hmac reencrypt |
|  |  | ``` |
|  |  |  |
|  |  | You can (and should) set these values using environment variable and/or the \*\*.env\*\* file. To do this you will need to set |
|  |  | the values as JSON strings: |
|  |  |  |
|  |  | ```text |
|  |  | authtoken.hmacEncryptionKeys = '{"k1":{"key":"hex2bin:923dfab5ddca0c7784c2c388a848a704f5e048736c1a852c862959da62ade8c7"},"k2":{"key":"hex2bin:451df599363b19be1434605fff8556a0bbfc50bede1bb33793dcde4d97fce4b0"}}' |
|  |  | authtoken.hmacEncryptionCurrentKey = k2 |
|  |  | ``` |
|  |  |  |
|  |  | Depending on the set length of the Secret Key and the type of encryption used, it is possible for the encrypted value to |
|  |  | exceed the database column character limit of 255 characters. If this happens, creation of a new HMAC identity will |
|  |  | throw a `RuntimeException`. |

5 changes: 4 additions & 1 deletion

5
[phpunit.xml.dist](#diff-e35810879ec42bdd81797b3ccb72f6de28a8b4a0e3bfdba43183e133e866b892 "phpunit.xml.dist")

Show comments

[View file](/codeigniter4/shield/blob/f77c6ae20275ac1245330a2b9a523bf7e6f6202f/phpunit.xml.dist)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -93,7 +93,10 @@ |
|  |  | <!-- https://getcomposer.org/xdebug --> |
|  |  | <env name="COMPOSER\_DISABLE\_XDEBUG\_WARN" value="1"/> |
|  |  |  |
|  |  | <!-- Database configuration --> |
|  |  | <!-- Default HMAC encryption key --> |
|  |  | <env name="authtoken.hmacEncryptionKeys" value="{&quot;k1&quot;:{&quot;key&quot;:&quot;hex2bin:178ed94fd0b6d57dd31dd6b22fc601fab8ad191efac165a5f3f30a8ac09d813d&quot;},&quot;k2&quot;:{&quot;key&quot;:&quot;hex2bin:b0ab85bd0320824c496db2f40eb47c8712a6dfcfdf99b805988e22bdea6b9203&quot;}}"/> |
|  |  |  |
|  |  | <!-- Database configuration --> |
|  |  | <env name="database.tests.strictOn" value="true"/> |
|  |  | <!-- Uncomment to use alternate testing database configuration |
|  |  | <env name="database.tests.hostname" value="localhost"/> |
| Expand Down | |  |

6 changes: 5 additions & 1 deletion

6
[src/Authentication/Authenticators/HmacSha256.php](#diff-e296899f7db51e66ae5504de03cb4c6f54637e9df9fb5685a645d40be4b11c43 "src/Authentication/Authenticators/HmacSha256.php")

Show comments

[View file](/codeigniter4/shield/blob/f77c6ae20275ac1245330a2b9a523bf7e6f6202f/src/Authentication/Authenticators/HmacSha256.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,6 +17,7 @@ |
|  |  | use CodeIgniter\I18n\Time; |
|  |  | use CodeIgniter\Shield\Authentication\AuthenticationException; |
|  |  | use CodeIgniter\Shield\Authentication\AuthenticatorInterface; |
|  |  | use CodeIgniter\Shield\Authentication\HMAC\HmacEncrypter; |
|  |  | use CodeIgniter\Shield\Config\Auth; |
|  |  | use CodeIgniter\Shield\Entities\User; |
|  |  | use CodeIgniter\Shield\Exceptions\InvalidArgumentException; |
| Expand Down  Expand Up | | @@ -159,8 +160,11 @@ public function check(array $credentials): Result |
|  |  | ]); |
|  |  | } |
|  |  |  |
|  |  | $encrypter = new HmacEncrypter(); |
|  |  | $secretKey = $encrypter->decrypt($token->secret2); |
|  |  |  |
|  |  | // Check signature... |
|  |  | $hash = hash\_hmac('sha256', $credentials['body'], $token->secret2); |
|  |  | $hash = hash\_hmac('sha256', $credentials['body'], $secretKey); |
|  |  | if ($hash !== $signature) { |
|  |  | return new Result([ |
|  |  | 'success' => false, |
| Expand Down | |  |

153 changes: 153 additions & 0 deletions

153
[src/Authentication/HMAC/HmacEncrypter.php](#diff-3473740c075026f024181063b9d328968a88a0fb36be981cfe037a5bde7bd2fc "src/Authentication/HMAC/HmacEncrypter.php")

Show comments

[View file](/codeigniter4/shield/blob/f77c6ae20275ac1245330a2b9a523bf7e6f6202f/src/Authentication/HMAC/HmacEncrypter.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,153 @@ |
|  |  | <?php |
|  |  |  |
|  |  | declare(strict\_types=1); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* This file is part of CodeIgniter Shield. |
|  |  | \* |
|  |  | \* (c) CodeIgniter Foundation <admin@codeigniter.com> |
|  |  | \* |
|  |  | \* For the full copyright and license information, please view |
|  |  | \* the LICENSE file that was distributed with this source code. |
|  |  | \*/ |
|  |  |  |
|  |  | namespace CodeIgniter\Shield\Authentication\HMAC; |
|  |  |  |
|  |  | use CodeIgniter\Encryption\EncrypterInterface; |
|  |  | use CodeIgniter\Encryption\Exceptions\EncryptionException; |
|  |  | use CodeIgniter\Shield\Auth; |
|  |  | use CodeIgniter\Shield\Config\AuthToken; |
|  |  | use CodeIgniter\Shield\Exceptions\RuntimeException; |
|  |  | use Config\Encryption; |
|  |  | use Config\Services; |
|  |  | use Exception; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* HMAC Encrypter class |
|  |  | \* |
|  |  | \* This class handles the setup and configuration of the HMAC Encryption |
|  |  | \*/ |
|  |  | class HmacEncrypter |
|  |  | { |
|  |  | /\*\* |
|  |  | \* Codeigniter Encrypter |
|  |  | \* |
|  |  | \* @var array<string, EncrypterInterface> |
|  |  | \*/ |
|  |  | private array $encrypter; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Auth Token config |
|  |  | \*/ |
|  |  | private AuthToken $authConfig; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Constructor |
|  |  | \* Setup encryption configuration |
|  |  | \*/ |
|  |  | public function \_\_construct() |
|  |  | { |
|  |  | $this->authConfig = config('AuthToken'); |
|  |  |  |
|  |  | $this->getEncrypter($this->authConfig->hmacEncryptionCurrentKey); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Decrypt |
|  |  | \* |
|  |  | \* @param string $encString Encrypted string |
|  |  | \* |
|  |  | \* @return string Raw decrypted string |
|  |  | \* |
|  |  | \* @throws EncryptionException |
|  |  | \*/ |
|  |  | public function decrypt(string $encString): string |
|  |  | { |
|  |  | $matches = []; |
|  |  | // check for a match |
|  |  | if (preg\_match('/^\$b6\$(\w+?)\$(.+)\z/', $encString, $matches) !== 1) { |
|  |  | throw new EncryptionException('Unable to decrypt string'); |
|  |  | } |
|  |  |  |
|  |  | $encrypter = $this->getEncrypter($matches[1]); |
|  |  |  |
|  |  | return $encrypter->decrypt(base64\_decode($matches[2], true)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Encrypt |
|  |  | \* |
|  |  | \* @param string $rawString Raw string to encrypt |
|  |  | \* |
|  |  | \* @return string Encrypted string |
|  |  | \* |
|  |  | \* @throws EncryptionException |
|  |  | \* @throws RuntimeException |
|  |  | \*/ |
|  |  | public function encrypt(string $rawString): string |
|  |  | { |
|  |  | $currentKey = $this->authConfig->hmacEncryptionCurrentKey; |
|  |  |  |
|  |  | $encryptedString = '$b6$' . $currentKey . '$' . base64\_encode($this->encrypter[$currentKey]->encrypt($rawString)); |
|  |  |  |
|  |  | if (strlen($encryptedString) > $this->authConfig->secret2StorageLimit) { |
|  |  | throw new RuntimeException('Encrypted key too long. Unable to store value.'); |
|  |  | } |
|  |  |  |
|  |  | return $encryptedString; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Check if the string already encrypted |
|  |  | \*/ |
|  |  | public function isEncrypted(string $string): bool |
|  |  | { |
|  |  | return preg\_match('/^\$b6\$/', $string) === 1; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Check if the string already encrypted with the Current Set Key |
|  |  | \*/ |
|  |  | public function isEncryptedWithCurrentKey(string $string): bool |
|  |  | { |
|  |  | $currentKey = $this->authConfig->hmacEncryptionCurrentKey; |
|  |  |  |
|  |  | return preg\_match('/^\$b6\$' . $currentKey . '\$/', $string) === 1; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Generate Key |
|  |  | \* |
|  |  | \* @return string Secret Key in base64 format |
|  |  | \* |
|  |  | \* @throws Exception |
|  |  | \*/ |
|  |  | public function generateSecretKey(): string |
|  |  | { |
|  |  | return base64\_encode(random\_bytes($this->authConfig->hmacSecretKeyByteSize)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Retrieve encrypter for selected key |
|  |  | \* |
|  |  | \* @param string $encrypterKey Index Key for selected Encrypter |
|  |  | \*/ |
|  |  | private function getEncrypter(string $encrypterKey): EncrypterInterface |
|  |  | { |
|  |  | if (! isset($this->encrypter[$encrypterKey])) { |
|  |  | if (! isset($this->authConfig->hmacEncryptionKeys[$encrypterKey]['key'])) { |
|  |  | throw new RuntimeException('Encryption key does not exist.'); |
|  |  | } |
|  |  |  |
|  |  | $config = new Encryption(); |
|  |  |  |
|  |  | $config->key = $this->authConfig->hmacEncryptionKeys[$encrypterKey]['key']; |
|  |  | $config->driver = $this->authConfig->hmacEncryptionKeys[$encrypterKey]['driver'] ?? $this->authConfig->hmacEncryptionDefaultDriver; |
|  |  | $config->digest = $this->authConfig->hmacEncryptionKeys[$encrypterKey]['digest'] ?? $this->authConfig->hmacEncryptionDefaultDigest; |
|  |  |  |
|  |  | $this->encrypter[$encrypterKey] = Services::encrypter($config); |
|  |  | } |
|  |  |  |
|  |  | return $this->encrypter[$encrypterKey]; |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f77c6ae`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fcommit%2Ff77c6ae20275ac1245330a2b9a523bf7e6f6202f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


