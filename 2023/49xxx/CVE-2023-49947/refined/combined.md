=== Content from codeberg.org_db90279c_20250115_102916.html ===

This website requires JavaScript.
[![](https://design.codeberg.org/logo-kit/icon_inverted.svg)](/)

[Explore](/explore/repos)
[About](https://docs.codeberg.org/getting-started/what-is-codeberg/#what-is-codeberg-e.v.%3F)
[FAQ](https://docs.codeberg.org/getting-started/faq/)
[Help](https://docs.codeberg.org)
[Donate](https://donate.codeberg.org)

[Register](/user/cbrgp/IkPVBUy)
[Sign in](/user/login?redirect_to=%2fforgejo%2fforgejo%2fcommit%2f44df78edd40076b349d50dc5fb02af417a44cfab)

![forgejo/forgejo](/repo-avatars/73144-c883a242dec5299fbc06bbe3ee71d8c6)

[forgejo](/forgejo)/[forgejo](/forgejo/forgejo)

Watch

[70](/forgejo/forgejo/watchers)

Star

[1.9k](/forgejo/forgejo/stars)

Fork
You've already forked forgejo

[302](/forgejo/forgejo/forks)

[Code](/forgejo/forgejo)
[Issues
811](/forgejo/forgejo/issues)
[Pull requests
61](/forgejo/forgejo/pulls)
[Releases
62](/forgejo/forgejo/releases)
[Packages
1](/forgejo/forgejo/packages)
[Activity](/forgejo/forgejo/activity)
[Actions
1](/forgejo/forgejo/actions)

### Unify two factor check ([#27915](/forgejo/forgejo/issues/27915)) ([#27939](/forgejo/forgejo/issues/27939))

[Browse source](/forgejo/forgejo/src/commit/44df78edd40076b349d50dc5fb02af417a44cfab)

```
Backport of [#27915](/forgejo/forgejo/issues/27915)

Fixes [#27819](/forgejo/forgejo/issues/27819)

We have support for two factor logins with the normal web login and with
basic auth. For basic auth the two factor check was implemented at three
different places and you need to know that this check is necessary. This
PR moves the check into the basic auth itself.

(cherry picked from commit [00705da102](/forgejo/forgejo/commit/00705da102be929dfa41519b030be3bdd8c68472))
```
...

This commit is contained in:

![](/avatars/b1c221a5bd891a018c75a4b0e132f807?size=56 "KN4CK3R")
parent
[1fd3cc3217](/forgejo/forgejo/commit/1fd3cc32170ff9a36419083541bb2e1ad612df92)

commit
44df78edd4

Signed by:
![](/avatars/baa02ddebf727ef06a0ded0aee5a25cc?size=56 "Earl Warren")
[**earl-warren**](/earl-warren)

GPG key ID:
0579CB2928A78A00

 **5 changed files** with **76 additions** and **66 deletions**

[Show all changes](?style=unified&whitespace=show-all&show-outdated=)
[Ignore whitespace when comparing lines](?style=unified&whitespace=ignore-all&show-outdated=)
[Ignore changes in amount of whitespace](?style=unified&whitespace=ignore-change&show-outdated=)
[Ignore changes in whitespace at EOL](?style=unified&whitespace=ignore-eol&show-outdated=)

Show stats
[Download patch file](/forgejo/forgejo/commit/44df78edd40076b349d50dc5fb02af417a44cfab.patch)
[Download diff file](/forgejo/forgejo/commit/44df78edd40076b349d50dc5fb02af417a44cfab.diff)
Expand all files
Collapse all files

#### 27 [modules/context/api.go](#diff-544505b480d4f8699c8075e4f9f6ec0494fd4742 "modules/context/api.go") Unescape Escape [View file](/forgejo/forgejo/src/commit/44df78edd40076b349d50dc5fb02af417a44cfab/modules/context/api.go)

|  | |  |  | `@ -11,7 +11,6 @@ import (` |
|  |  |  |  | `"net/url"` |
|  |  |  |  | `"strings"` |
|  |  |  |  |  |
|  |  |  |  | `"code.gitea.io/gitea/models/auth"` |
|  |  |  |  | `repo_model "code.gitea.io/gitea/models/repo"` |
|  |  |  |  | `"code.gitea.io/gitea/models/unit"` |
|  |  |  |  | `user_model "code.gitea.io/gitea/models/user"` |
|  | |  |  | `@ -197,32 +196,6 @@ func (ctx *APIContext) SetLinkHeader(total, pageSize int) {` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `// CheckForOTP validates OTP` |
|  |  |  |  | `func (ctx *APIContext) CheckForOTP() {` |
|  |  |  |  | `if skip, ok := ctx.Data["SkipLocalTwoFA"]; ok && skip.(bool) {` |
|  |  |  |  | `return // Skip 2FA` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `otpHeader := ctx.Req.Header.Get("X-Gitea-OTP")` |
|  |  |  |  | `twofa, err := auth.GetTwoFactorByUID(ctx.Doer.ID)` |
|  |  |  |  | `if err != nil {` |
|  |  |  |  | `if auth.IsErrTwoFactorNotEnrolled(err) {` |
|  |  |  |  | `return // No 2FA enrollment for this user` |
|  |  |  |  | `}` |
|  |  |  |  | `ctx.Error(http.StatusInternalServerError, "GetTwoFactorByUID", err)` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `ok, err := twofa.ValidateTOTP(otpHeader)` |
|  |  |  |  | `if err != nil {` |
|  |  |  |  | `ctx.Error(http.StatusInternalServerError, "ValidateTOTP", err)` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `if !ok {` |
|  |  |  |  | `ctx.Error(http.StatusUnauthorized, "", nil)` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `// APIContexter returns apicontext as middleware` |
|  |  |  |  | `func APIContexter() func(http.Handler) http.Handler {` |
|  |  |  |  | `return func(next http.Handler) http.Handler {` |
|  | |  |  |  |

#### 11 [routers/api/v1/api.go](#diff-663f9aa6a727d1f114825e3d86bc8c8087770393 "routers/api/v1/api.go") Unescape Escape [View file](/forgejo/forgejo/src/commit/44df78edd40076b349d50dc5fb02af417a44cfab/routers/api/v1/api.go)

|  | |  |  | `@ -315,10 +315,6 @@ func reqToken() func(ctx *context.APIContext) {` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `if ctx.IsBasicAuth {` |
|  |  |  |  | `ctx.CheckForOTP()` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `if ctx.IsSigned {` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  | |  |  | `@ -340,7 +336,6 @@ func reqBasicAuth() func(ctx *context.APIContext) {` |
|  |  |  |  | `ctx.Error(http.StatusUnauthorized, "reqBasicAuth", "auth required")` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `ctx.CheckForOTP()` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  | |  |  | `@ -687,12 +682,6 @@ func bind[T any](_ T) any {` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `// The OAuth2 plugin is expected to be executed first, as it must ignore the user id stored` |
|  |  |  |  | `// in the session (if there is a user id stored in session other plugins might return the user` |
|  |  |  |  | `// object for that id).` |
|  |  |  |  | `//` |
|  |  |  |  | `// The Session plugin is expected to be executed second, in order to skip authentication` |
|  |  |  |  | `// for users that have already signed in.` |
|  |  |  |  | `func buildAuthGroup() *auth.Group {` |
|  |  |  |  | `group := auth.NewGroup(` |
|  |  |  |  | `&auth.OAuth2{},` |
|  | |  |  |  |

#### 24 [services/auth/basic.go](#diff-038d842c9238663bae930148a30a07df44c4949c "services/auth/basic.go") Unescape Escape [View file](/forgejo/forgejo/src/commit/44df78edd40076b349d50dc5fb02af417a44cfab/services/auth/basic.go)

|  | |  |  | `@ -15,6 +15,7 @@ import (` |
|  |  |  |  | `"code.gitea.io/gitea/modules/log"` |
|  |  |  |  | `"code.gitea.io/gitea/modules/setting"` |
|  |  |  |  | `"code.gitea.io/gitea/modules/timeutil"` |
|  |  |  |  | `"code.gitea.io/gitea/modules/util"` |
|  |  |  |  | `"code.gitea.io/gitea/modules/web/middleware"` |
|  |  |  |  | `)` |
|  |  |  |  |  |
|  | |  |  | `@ -132,11 +133,30 @@ func (b *Basic) Verify(req *http.Request, w http.ResponseWriter, store DataStore` |
|  |  |  |  | `return nil, err` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `if skipper, ok := source.Cfg.(LocalTwoFASkipper); ok && skipper.IsSkipLocalTwoFA() {` |
|  |  |  |  | `store.GetData()["SkipLocalTwoFA"] = true` |
|  |  |  |  | `if skipper, ok := source.Cfg.(LocalTwoFASkipper); !ok || !skipper.IsSkipLocalTwoFA() {` |
|  |  |  |  | `if err := validateTOTP(req, u); err != nil {` |
|  |  |  |  | `return nil, err` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `log.Trace("Basic Authorization: Logged in user %-v", u)` |
|  |  |  |  |  |
|  |  |  |  | `return u, nil` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `func validateTOTP(req *http.Request, u *user_model.User) error {` |
|  |  |  |  | `twofa, err := auth_model.GetTwoFactorByUID(u.ID)` |
|  |  |  |  | `if err != nil {` |
|  |  |  |  | `if auth_model.IsErrTwoFactorNotEnrolled(err) {` |
|  |  |  |  | `// No 2FA enrollment for this user` |
|  |  |  |  | `return nil` |
|  |  |  |  | `}` |
|  |  |  |  | `return err` |
|  |  |  |  | `}` |
|  |  |  |  | `if ok, err := twofa.ValidateTOTP(req.Header.Get("X-Gitea-OTP")); err != nil {` |
|  |  |  |  | `return err` |
|  |  |  |  | `} else if !ok {` |
|  |  |  |  | `return util.NewInvalidArgumentErrorf("invalid provided OTP")` |
|  |  |  |  | `}` |
|  |  |  |  | `return nil` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 26 [services/auth/middleware.go](#diff-20d6f2efb317894d3fce09b9b62db74819fbd416 "services/auth/middleware.go") Unescape Escape [View file](/forgejo/forgejo/src/commit/44df78edd40076b349d50dc5fb02af417a44cfab/services/auth/middleware.go)

|  | |  |  | `@ -7,7 +7,6 @@ import (` |
|  |  |  |  | `"net/http"` |
|  |  |  |  | `"strings"` |
|  |  |  |  |  |
|  |  |  |  | `"code.gitea.io/gitea/models/auth"` |
|  |  |  |  | `user_model "code.gitea.io/gitea/models/user"` |
|  |  |  |  | `"code.gitea.io/gitea/modules/context"` |
|  |  |  |  | `"code.gitea.io/gitea/modules/log"` |
|  | |  |  | `@ -216,31 +215,6 @@ func VerifyAuthWithOptionsAPI(options *VerifyOptions) func(ctx *context.APIConte` |
|  |  |  |  | `})` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `if ctx.IsSigned && ctx.IsBasicAuth {` |
|  |  |  |  | `if skip, ok := ctx.Data["SkipLocalTwoFA"]; ok && skip.(bool) {` |
|  |  |  |  | `return // Skip 2FA` |
|  |  |  |  | `}` |
|  |  |  |  | `twofa, err := auth.GetTwoFactorByUID(ctx.Doer.ID)` |
|  |  |  |  | `if err != nil {` |
|  |  |  |  | `if auth.IsErrTwoFactorNotEnrolled(err) {` |
|  |  |  |  | `return // No 2FA enrollment for this user` |
|  |  |  |  | `}` |
|  |  |  |  | `ctx.InternalServerError(err)` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `otpHeader := ctx.Req.Header.Get("X-Gitea-OTP")` |
|  |  |  |  | `ok, err := twofa.ValidateTOTP(otpHeader)` |
|  |  |  |  | `if err != nil {` |
|  |  |  |  | `ctx.InternalServerError(err)` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `if !ok {` |
|  |  |  |  | `ctx.JSON(http.StatusForbidden, map[string]string{` |
|  |  |  |  | `"message": "Only signed in user is allowed to call APIs.",` |
|  |  |  |  | `})` |
|  |  |  |  | `return` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `if options.AdminRequired {` |
|  | |  |  |  |

#### 54 [tests/integration/api\_twofa\_test.go](#diff-de37f6ccd0f9d4666d5973d44273c5651c9e6876 "tests/integration/api_twofa_test.go") Normal file Unescape Escape [View file](/forgejo/forgejo/src/commit/44df78edd40076b349d50dc5fb02af417a44cfab/tests/integration/api_twofa_test.go)

|  | |  |  | `@ -0,0 +1,54 @@` |
|  |  |  |  | `// Copyright 2023 The Gitea Authors. All rights reserved.` |
|  |  |  |  | `// SPDX-License-Identifier: MIT` |
|  |  |  |  |  |
|  |  |  |  | `package integration` |
|  |  |  |  |  |
|  |  |  |  | `import (` |
|  |  |  |  | `"net/http"` |
|  |  |  |  | `"testing"` |
|  |  |  |  | `"time"` |
|  |  |  |  |  |
|  |  |  |  | `auth_model "code.gitea.io/gitea/models/auth"` |
|  |  |  |  | `"code.gitea.io/gitea/models/unittest"` |
|  |  |  |  | `user_model "code.gitea.io/gitea/models/user"` |
|  |  |  |  | `"code.gitea.io/gitea/tests"` |
|  |  |  |  |  |
|  |  |  |  | `"github.com/pquerna/otp/totp"` |
|  |  |  |  | `"github.com/stretchr/testify/assert"` |
|  |  |  |  | `)` |
|  |  |  |  |  |
|  |  |  |  | `func TestAPITwoFactor(t *testing.T) {` |
|  |  |  |  | `defer tests.PrepareTestEnv(t)()` |
|  |  |  |  |  |
|  |  |  |  | `user := unittest.AssertExistsAndLoadBean(t, &user_model.User{ID: 16})` |
|  |  |  |  |  |
|  |  |  |  | `req := NewRequestf(t, "GET", "/api/v1/user")` |
|  |  |  |  | `req = AddBasicAuthHeader(req, user.Name)` |
|  |  |  |  | `MakeRequest(t, req, http.StatusOK)` |
|  |  |  |  |  |
|  |  |  |  | `otpKey, err := totp.Generate(totp.GenerateOpts{` |
|  |  |  |  | `SecretSize: 40,` |
|  |  |  |  | `Issuer: "gitea-test",` |
|  |  |  |  | `AccountName: user.Name,` |
|  |  |  |  | `})` |
|  |  |  |  | `assert.NoError(t, err)` |
|  |  |  |  |  |
|  |  |  |  | `tfa := &auth_model.TwoFactor{` |
|  |  |  |  | `UID: user.ID,` |
|  |  |  |  | `}` |
|  |  |  |  | `assert.NoError(t, tfa.SetSecret(otpKey.Secret()))` |
|  |  |  |  |  |
|  |  |  |  | `assert.NoError(t, auth_model.NewTwoFactor(tfa))` |
|  |  |  |  |  |
|  |  |  |  | `req = NewRequestf(t, "GET", "/api/v1/user")` |
|  |  |  |  | `req = AddBasicAuthHeader(req, user.Name)` |
|  |  |  |  | `MakeRequest(t, req, http.StatusUnauthorized)` |
|  |  |  |  |  |
|  |  |  |  | `passcode, err := totp.GenerateCode(otpKey.Secret(), time.Now())` |
|  |  |  |  | `assert.NoError(t, err)` |
|  |  |  |  |  |
|  |  |  |  | `req = NewRequestf(t, "GET", "/api/v1/user")` |
|  |  |  |  | `req = AddBasicAuthHeader(req, user.Name)` |
|  |  |  |  | `req.Header.Set("X-Gitea-OTP", passcode)` |
|  |  |  |  | `MakeRequest(t, req, http.StatusOK)` |
|  |  |  |  | `}` |

Write
Preview

Loading…

Cancel
Save

Reference in a new issue

**Repository**
forgejo/forgejo

**Title**

**Body**

Create issue

![](https://design.codeberg.org/logo-kit/icon_inverted.svg)

**Codeberg**

* [Documentation](https://docs.codeberg.org)
* [Community Issues](/Codeberg/Community/issues)
* [Contributing](/Codeberg/Contributing)* [Report Abuse](https://docs.codeberg.org/contact/#abuse)

**Association**

* [Who are we?](https://docs.codeberg.org/getting-started/what-is-codeberg/#what-is-codeberg-e.v.%3F)
* [Bylaws / Satzung](/codeberg/org/src/en/bylaws.md)
* [Donate](https://docs.codeberg.org/improving-codeberg/donate/)
* [Join / Support](https://join.codeberg.org)
* [Contact](https://docs.codeberg.org/contact/)

**Service**

* [Codeberg Pages](https://codeberg.page)
* [Weblate Translations](https://translate.codeberg.org)
* [Woodpecker CI](https://docs.codeberg.org/ci/#using-codeberg's-instance-of-woodpecker-ci)
* [Forgejo API](/api/swagger)
* [Status Page](https://status.codeberg.eu)

**Legal**

* [Imprint / Impressum](/codeberg/org/src/Imprint.md)
* [Privacy Policy](/codeberg/org/src/PrivacyPolicy.md)
* [Licenses](/assets/licenses.txt)
* [Terms of Use](/codeberg/org/src/TermsOfUse.md)

[Blog](https://blog.codeberg.org) |
[Mastodon](https://social.anoxinon.de/%40Codeberg) |
[Matrix Space](https://matrix.to/#/#codeberg-space:matrix.org) |
[Powered by Forgejo](/Codeberg-Infrastructure/forgejo)

English
Bahasa Indonesia
Deutsch
English
Español
Esperanto
Filipino
Français
Italiano
Latviešu
Magyar nyelv
Nederlands
Polski
Português de Portugal
Português do Brasil
Slovenščina
Suomi
Svenska
Türkçe
Čeština
Ελληνικά
Български
Русский
Українська
فارسی
日本語
简体中文
繁體中文（台灣）
繁體中文（香港）
한국어


