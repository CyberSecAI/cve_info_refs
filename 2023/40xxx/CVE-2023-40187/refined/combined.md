=== Content from github.com_d952250b_20250115_080732.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFreeRDP%2FFreeRDP%2Fsecurity%2Fadvisories%2FGHSA-pwf9-v5p9-ch4f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFreeRDP%2FFreeRDP%2Fsecurity%2Fadvisories%2FGHSA-pwf9-v5p9-ch4f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=FreeRDP%2FFreeRDP)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FreeRDP](/FreeRDP)
/
**[FreeRDP](/FreeRDP/FreeRDP)**
Public

* [Notifications](/login?return_to=%2FFreeRDP%2FFreeRDP) You must be signed in to change notification settings
* [Fork
  14.9k](/login?return_to=%2FFreeRDP%2FFreeRDP)
* [Star
   11.2k](/login?return_to=%2FFreeRDP%2FFreeRDP)

* [Code](/FreeRDP/FreeRDP)
* [Issues
  226](/FreeRDP/FreeRDP/issues)
* [Pull requests
  22](/FreeRDP/FreeRDP/pulls)
* [Discussions](/FreeRDP/FreeRDP/discussions)
* [Actions](/FreeRDP/FreeRDP/actions)
* [Projects
  0](/FreeRDP/FreeRDP/projects)
* [Wiki](/FreeRDP/FreeRDP/wiki)
* [Security](/FreeRDP/FreeRDP/security)
* [Insights](/FreeRDP/FreeRDP/pulse)

Additional navigation options

* [Code](/FreeRDP/FreeRDP)
* [Issues](/FreeRDP/FreeRDP/issues)
* [Pull requests](/FreeRDP/FreeRDP/pulls)
* [Discussions](/FreeRDP/FreeRDP/discussions)
* [Actions](/FreeRDP/FreeRDP/actions)
* [Projects](/FreeRDP/FreeRDP/projects)
* [Wiki](/FreeRDP/FreeRDP/wiki)
* [Security](/FreeRDP/FreeRDP/security)
* [Insights](/FreeRDP/FreeRDP/pulse)

# Use-After-Free in avc420\_ensure\_buffer, avc444\_ensure\_buffer

Moderate

[akallabeth](/akallabeth)
published
GHSA-pwf9-v5p9-ch4f
Aug 31, 2023

## Package

FreeRDP

## Affected versions

>= 3.0.0-beta1, <= 3.0.0beta2

## Patched versions

3.0.0-beta3

## Description

### Summary

Use-After-Free in avc420\_ensure\_buffer, avc444\_ensure\_buffer

### Affected

FreeRDP based clients only. FreeRDP proxy not affected as image decoding is not done by proxy (data passthrough)

### Details

[FreeRDP/libfreerdp/codec/h264.c](https://github.com/FreeRDP/FreeRDP/blob/5be5553e0da72178a4b94cc1ffbdace9ceb153e5/libfreerdp/codec/h264.c#L413-L427)

Lines 413 to 427
in
[5be5553](/FreeRDP/FreeRDP/commit/5be5553e0da72178a4b94cc1ffbdace9ceb153e5)

|  | for (x = 0; x < 3; x++) |
| --- | --- |
|  | { |
|  | BYTE\* tmp1; |
|  | BYTE\* tmp2; |
|  | piDstStride[x] = piMainStride[0]; |
|  | piDstSize[x] = piDstStride[x] \* padDstHeight; |
|  | tmp1 = winpr\_aligned\_recalloc(ppYUVDstData[x], piDstSize[x], 1, 16); |
|  | if (tmp1) |
|  | ppYUVDstData[x] = tmp1; |
|  | tmp2 = winpr\_aligned\_recalloc(ppOldYUVDstData[x], piDstSize[x], 1, 16); |
|  | if (tmp2) |
|  | ppOldYUVDstData[x] = tmp2; |
|  | if (!tmp1 || !tmp2) |
|  | goto fail; |
|  | } |

If `piDstSize[x]` is 0, `ppYUVDstData[x]` will be freed. However, without updating `ppYUVDstData[x]`, this leads to a Use-After-Free (UAF) vulnerability.
### PoC

1. Send `piDstSize[x]` == 0

### Impact

Use-After-Free leading to unexpected behavior

### Asan

```
==73963==ERROR: AddressSanitizer: heap-use-after-free on address 0x62900000a208 at pc 0x000101dfd6a8 bp 0x000170029320 sp 0x000170029318
READ of size 4 at 0x62900000a208 thread T4
    #0 0x101dfd6a4 in winpr_aligned_offset_recalloc alignment.c:202
    #1 0x101dfd188 in winpr_aligned_recalloc alignment.c:75
    #2 0x101292260 in avc444_ensure_buffer+0x34c (libfreerdp3.3.0.0.dylib:arm64+0x66260) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #3 0x101292b90 in avc444_process_rects+0x288 (libfreerdp3.3.0.0.dylib:arm64+0x66b90) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #4 0x1012928c4 in avc444_decompress+0x228 (libfreerdp3.3.0.0.dylib:arm64+0x668c4) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #5 0x10138d8d8 in gdi_SurfaceCommand_AVC444+0x94c (libfreerdp3.3.0.0.dylib:arm64+0x1618d8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #6 0x1013825e8 in gdi_SurfaceCommand+0x5b0 (libfreerdp3.3.0.0.dylib:arm64+0x1565e8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #7 0x10055c238 in rdpgfx_decode_AVC444+0xa0c (libfreerdp-client3.3.0.0.dylib:arm64+0xa8238) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #8 0x10055b0bc in rdpgfx_decode+0x178 (libfreerdp-client3.3.0.0.dylib:arm64+0xa70bc) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #9 0x100546a20 in rdpgfx_recv_wire_to_surface_1_pdu+0x14ec (libfreerdp-client3.3.0.0.dylib:arm64+0x92a20) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #10 0x10054427c in rdpgfx_recv_pdu+0x424 (libfreerdp-client3.3.0.0.dylib:arm64+0x9027c) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #11 0x1005433b0 in rdpgfx_on_data_received+0x444 (libfreerdp-client3.3.0.0.dylib:arm64+0x8f3b0) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #12 0x1004c68a4 in dvcman_call_on_receive+0x164 (libfreerdp-client3.3.0.0.dylib:arm64+0x128a4) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #13 0x1004c6710 in dvcman_receive_channel_data+0x440 (libfreerdp-client3.3.0.0.dylib:arm64+0x12710) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #14 0x1004c30f8 in drdynvc_process_data+0x2c8 (libfreerdp-client3.3.0.0.dylib:arm64+0xf0f8) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #15 0x1004c136c in drdynvc_order_recv+0x334 (libfreerdp-client3.3.0.0.dylib:arm64+0xd36c) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #16 0x1004c0db0 in drdynvc_virtual_channel_event_data_received+0x498 (libfreerdp-client3.3.0.0.dylib:arm64+0xcdb0) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #17 0x1004bfa98 in drdynvc_virtual_channel_open_event_ex+0x1ac (libfreerdp-client3.3.0.0.dylib:arm64+0xba98) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #18 0x1014839ec in freerdp_channels_data+0x5cc (libfreerdp3.3.0.0.dylib:arm64+0x2579ec) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #19 0x1015352a0 in freerdp_channel_process+0x6e0 (libfreerdp3.3.0.0.dylib:arm64+0x3092a0) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #20 0x1014e5600 in rdp_recv_tpkt_pdu+0x11e8 (libfreerdp3.3.0.0.dylib:arm64+0x2b9600) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #21 0x1014e43c0 in rdp_recv_pdu+0x34 (libfreerdp3.3.0.0.dylib:arm64+0x2b83c0) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #22 0x1014dfc28 in rdp_recv_callback_int+0x1408 (libfreerdp3.3.0.0.dylib:arm64+0x2b3c28) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #23 0x1014de750 in rdp_recv_callback+0x1d8 (libfreerdp3.3.0.0.dylib:arm64+0x2b2750) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #24 0x101504f04 in transport_check_fds+0x51c (libfreerdp3.3.0.0.dylib:arm64+0x2d8f04) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #25 0x1014e0530 in rdp_check_fds+0x170 (libfreerdp3.3.0.0.dylib:arm64+0x2b4530) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #26 0x10147b1a8 in freerdp_check_fds+0x1ac (libfreerdp3.3.0.0.dylib:arm64+0x24f1a8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #27 0x10147b878 in freerdp_check_event_handles+0x70 (libfreerdp3.3.0.0.dylib:arm64+0x24f878) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #28 0x1000d7700 in mac_client_thread+0x5a4 (MacFreeRDP:arm64+0x13700) (BuildId: 648033a131eb3f0f9702f5da3e9b172432000000200000000100000000000d00)
    #29 0x101d9d4ac in thread_launcher thread.c:520
    #30 0x1a20cbfa4 in _pthread_start+0x90 (libsystem_pthread.dylib:arm64+0x6fa4) (BuildId: 46d35233a0513f4fbba4ba56dddc4d1a32000000200000000100000000040d00)
    #31 0x6a050001a20c6d9c  (<unknown module>)

0x62900000a208 is located 8 bytes inside of 18472-byte region [0x62900000a200,0x62900000ea28)
freed by thread T4 here:
    #0 0x1023256e4 in wrap_free+0x90 (libclang_rt.asan_osx_dynamic.dylib:arm64+0x516e4) (BuildId: 4947f3677e4435f39b5765e7dbc19bf732000000200000000100000000000b00)
    #1 0x101dfdb50 in winpr_aligned_free alignment.c:264
    #2 0x101dfd96c in winpr_aligned_offset_recalloc alignment.c:227
    #3 0x101dfd188 in winpr_aligned_recalloc alignment.c:75
    #4 0x101292260 in avc444_ensure_buffer+0x34c (libfreerdp3.3.0.0.dylib:arm64+0x66260) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #5 0x101292b90 in avc444_process_rects+0x288 (libfreerdp3.3.0.0.dylib:arm64+0x66b90) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #6 0x1012928c4 in avc444_decompress+0x228 (libfreerdp3.3.0.0.dylib:arm64+0x668c4) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #7 0x10138d8d8 in gdi_SurfaceCommand_AVC444+0x94c (libfreerdp3.3.0.0.dylib:arm64+0x1618d8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #8 0x1013825e8 in gdi_SurfaceCommand+0x5b0 (libfreerdp3.3.0.0.dylib:arm64+0x1565e8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #9 0x10055c238 in rdpgfx_decode_AVC444+0xa0c (libfreerdp-client3.3.0.0.dylib:arm64+0xa8238) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #10 0x10055b0bc in rdpgfx_decode+0x178 (libfreerdp-client3.3.0.0.dylib:arm64+0xa70bc) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #11 0x100546a20 in rdpgfx_recv_wire_to_surface_1_pdu+0x14ec (libfreerdp-client3.3.0.0.dylib:arm64+0x92a20) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #12 0x10054427c in rdpgfx_recv_pdu+0x424 (libfreerdp-client3.3.0.0.dylib:arm64+0x9027c) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #13 0x1005433b0 in rdpgfx_on_data_received+0x444 (libfreerdp-client3.3.0.0.dylib:arm64+0x8f3b0) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #14 0x1004c68a4 in dvcman_call_on_receive+0x164 (libfreerdp-client3.3.0.0.dylib:arm64+0x128a4) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #15 0x1004c6710 in dvcman_receive_channel_data+0x440 (libfreerdp-client3.3.0.0.dylib:arm64+0x12710) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #16 0x1004c30f8 in drdynvc_process_data+0x2c8 (libfreerdp-client3.3.0.0.dylib:arm64+0xf0f8) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #17 0x1004c136c in drdynvc_order_recv+0x334 (libfreerdp-client3.3.0.0.dylib:arm64+0xd36c) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #18 0x1004c0db0 in drdynvc_virtual_channel_event_data_received+0x498 (libfreerdp-client3.3.0.0.dylib:arm64+0xcdb0) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #19 0x1004bfa98 in drdynvc_virtual_channel_open_event_ex+0x1ac (libfreerdp-client3.3.0.0.dylib:arm64+0xba98) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #20 0x1014839ec in freerdp_channels_data+0x5cc (libfreerdp3.3.0.0.dylib:arm64+0x2579ec) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #21 0x1015352a0 in freerdp_channel_process+0x6e0 (libfreerdp3.3.0.0.dylib:arm64+0x3092a0) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #22 0x1014e5600 in rdp_recv_tpkt_pdu+0x11e8 (libfreerdp3.3.0.0.dylib:arm64+0x2b9600) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #23 0x1014e43c0 in rdp_recv_pdu+0x34 (libfreerdp3.3.0.0.dylib:arm64+0x2b83c0) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #24 0x1014dfc28 in rdp_recv_callback_int+0x1408 (libfreerdp3.3.0.0.dylib:arm64+0x2b3c28) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #25 0x1014de750 in rdp_recv_callback+0x1d8 (libfreerdp3.3.0.0.dylib:arm64+0x2b2750) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #26 0x101504f04 in transport_check_fds+0x51c (libfreerdp3.3.0.0.dylib:arm64+0x2d8f04) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #27 0x1014e0530 in rdp_check_fds+0x170 (libfreerdp3.3.0.0.dylib:arm64+0x2b4530) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #28 0x10147b1a8 in freerdp_check_fds+0x1ac (libfreerdp3.3.0.0.dylib:arm64+0x24f1a8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #29 0x10147b878 in freerdp_check_event_handles+0x70 (libfreerdp3.3.0.0.dylib:arm64+0x24f878) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)

previously allocated by thread T4 here:
    #0 0x1023255b0 in wrap_malloc+0x8c (libclang_rt.asan_osx_dynamic.dylib:arm64+0x515b0) (BuildId: 4947f3677e4435f39b5765e7dbc19bf732000000200000000100000000000b00)
    #1 0x101dfcf18 in winpr_aligned_offset_malloc alignment.c:114
    #2 0x101dfd5b0 in winpr_aligned_offset_recalloc alignment.c:189
    #3 0x101dfd188 in winpr_aligned_recalloc alignment.c:75
    #4 0x101292260 in avc444_ensure_buffer+0x34c (libfreerdp3.3.0.0.dylib:arm64+0x66260) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #5 0x101292b90 in avc444_process_rects+0x288 (libfreerdp3.3.0.0.dylib:arm64+0x66b90) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #6 0x101292870 in avc444_decompress+0x1d4 (libfreerdp3.3.0.0.dylib:arm64+0x66870) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #7 0x10138d8d8 in gdi_SurfaceCommand_AVC444+0x94c (libfreerdp3.3.0.0.dylib:arm64+0x1618d8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #8 0x1013825e8 in gdi_SurfaceCommand+0x5b0 (libfreerdp3.3.0.0.dylib:arm64+0x1565e8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #9 0x10055c238 in rdpgfx_decode_AVC444+0xa0c (libfreerdp-client3.3.0.0.dylib:arm64+0xa8238) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #10 0x10055b0bc in rdpgfx_decode+0x178 (libfreerdp-client3.3.0.0.dylib:arm64+0xa70bc) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #11 0x100546a20 in rdpgfx_recv_wire_to_surface_1_pdu+0x14ec (libfreerdp-client3.3.0.0.dylib:arm64+0x92a20) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #12 0x10054427c in rdpgfx_recv_pdu+0x424 (libfreerdp-client3.3.0.0.dylib:arm64+0x9027c) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #13 0x1005433b0 in rdpgfx_on_data_received+0x444 (libfreerdp-client3.3.0.0.dylib:arm64+0x8f3b0) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #14 0x1004c68a4 in dvcman_call_on_receive+0x164 (libfreerdp-client3.3.0.0.dylib:arm64+0x128a4) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #15 0x1004c6694 in dvcman_receive_channel_data+0x3c4 (libfreerdp-client3.3.0.0.dylib:arm64+0x12694) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #16 0x1004c30f8 in drdynvc_process_data+0x2c8 (libfreerdp-client3.3.0.0.dylib:arm64+0xf0f8) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #17 0x1004c136c in drdynvc_order_recv+0x334 (libfreerdp-client3.3.0.0.dylib:arm64+0xd36c) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #18 0x1004c0db0 in drdynvc_virtual_channel_event_data_received+0x498 (libfreerdp-client3.3.0.0.dylib:arm64+0xcdb0) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #19 0x1004bfa98 in drdynvc_virtual_channel_open_event_ex+0x1ac (libfreerdp-client3.3.0.0.dylib:arm64+0xba98) (BuildId: 81736ad6ceca33b393c7b6a3c46ded1f32000000200000000100000000000d00)
    #20 0x1014839ec in freerdp_channels_data+0x5cc (libfreerdp3.3.0.0.dylib:arm64+0x2579ec) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #21 0x1015352a0 in freerdp_channel_process+0x6e0 (libfreerdp3.3.0.0.dylib:arm64+0x3092a0) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #22 0x1014e5600 in rdp_recv_tpkt_pdu+0x11e8 (libfreerdp3.3.0.0.dylib:arm64+0x2b9600) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #23 0x1014e43c0 in rdp_recv_pdu+0x34 (libfreerdp3.3.0.0.dylib:arm64+0x2b83c0) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #24 0x1014dfc28 in rdp_recv_callback_int+0x1408 (libfreerdp3.3.0.0.dylib:arm64+0x2b3c28) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #25 0x1014de750 in rdp_recv_callback+0x1d8 (libfreerdp3.3.0.0.dylib:arm64+0x2b2750) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #26 0x101504f04 in transport_check_fds+0x51c (libfreerdp3.3.0.0.dylib:arm64+0x2d8f04) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #27 0x1014e0530 in rdp_check_fds+0x170 (libfreerdp3.3.0.0.dylib:arm64+0x2b4530) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #28 0x10147b1a8 in freerdp_check_fds+0x1ac (libfreerdp3.3.0.0.dylib:arm64+0x24f1a8) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)
    #29 0x10147b878 in freerdp_check_event_handles+0x70 (libfreerdp3.3.0.0.dylib:arm64+0x24f878) (BuildId: d53c29501ead3efda935d2a95dab72b332000000200000000100000000000d00)

Thread T4 created by T0 here:
    #0 0x10231e91c in wrap_pthread_create+0x50 (libclang_rt.asan_osx_dynamic.dylib:arm64+0x4a91c) (BuildId: 4947f3677e4435f39b5765e7dbc19bf732000000200000000100000000000b00)
    #1 0x101d9a52c in winpr_StartThread thread.c:568
    #2 0x101d99c00 in CreateThread thread.c:650
    #3 0x1000d6e64 in -[MRDPView rdpStart:]+0x964 (MacFreeRDP:arm64+0x12e64) (BuildId: 648033a131eb3f0f9702f5da3e9b172432000000200000000100000000000d00)
    #4 0x1000d62b4 in mfreerdp_client_start+0x488 (MacFreeRDP:arm64+0x122b4) (BuildId: 648033a131eb3f0f9702f5da3e9b172432000000200000000100000000000d00)
    #5 0x1000ca18c in freerdp_client_start+0x190 (MacFreeRDP:arm64+0x618c) (BuildId: 648033a131eb3f0f9702f5da3e9b172432000000200000000100000000000d00)
    #6 0x10000678c in -[AppDelegate applicationDidFinishLaunching:]+0x53c (MacFreeRDP:arm64+0x10000678c) (BuildId: c0debf5af29834acb3c97ff2be5d5c4932000000200000000100000000000d00)
    #7 0x1a219f17c in __CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__+0x90 (CoreFoundation:arm64+0x7417c) (BuildId: 203e44018c2e3157a24b92f52551d43e32000000200000000100000000040d00)
    #8 0xeb690001a223aee8  (<unknown module>)
    #9 0x76370001a223ae30  (<unknown module>)
    #10 0x1d138001a21704c8  (<unknown module>)
    #11 0x677b8001a30ce8f0  (<unknown module>)
    #12 0x52530001a53d1154  (<unknown module>)
    #13 0xd7578001a53d0f04  (<unknown module>)
    #14 0xe9100001a53cefa0  (<unknown module>)
    #15 0xb6280001a53ceb9c  (<unknown module>)
    #16 0xf3510001a30f8b60  (<unknown module>)
    #17 0x3f298001a30f89c0  (<unknown module>)
    #18 0xc93d0001a84d1514  (<unknown module>)
    #19 0xb5018001a84d0e40  (<unknown module>)
    #20 0xba448001a84c9f14  (<unknown module>)
    #21 0x85e8001aba02b40  (<unknown module>)
    #22 0x3d738001a53ca044  (<unknown module>)
    #23 0xfb5d8001a53c8edc  (<unknown module>)
    #24 0xfb7d0001a53bd340  (<unknown module>)
    #25 0x450f8001a5394790  (<unknown module>)
    #26 0x6a74000100006020  (<unknown module>)
    #27 0x1a1d73f24  (<unknown module>)
    #28 0x56347ffffffffffc  (<unknown module>)

SUMMARY: AddressSanitizer: heap-use-after-free alignment.c:202 in winpr_aligned_offset_recalloc
Shadow bytes around the buggy address:
  0x629000009f80: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x62900000a000: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x62900000a080: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x62900000a100: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x62900000a180: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x62900000a200: fd[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x62900000a280: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x62900000a300: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x62900000a380: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x62900000a400: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x62900000a480: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb

```

### Severity

Moderate

### CVE ID

CVE-2023-40187

### Weaknesses

No CWEs

### Credits

* [![@pwn2carr](https://avatars.githubusercontent.com/u/131132521?s=40&v=4)](/pwn2carr)
  [pwn2carr](/pwn2carr)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from security.gentoo.org_689e052f_20250115_080732.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# FreeRDP: Multiple Vulnerabilities — GLSA **202401-16**

Multiple vulnerabilities have been discovered in FreeRDP, the worst of which could result in code execution.

### Affected packages

| Package | **net-misc/freerdp** on all architectures |
| --- | --- |
| Affected versions | < **2.11.0** |
| Unaffected versions | >= **2.11.0** |

### Background

FreeRDP is a free implementation of the remote desktop protocol.

### Description

Multiple vulnerabilities have been discovered in FreeRDP. Please review the CVE identifiers referenced below for details.

### Impact

Please review the referenced CVE identifiers for details.

### Workaround

There is no known workaround at this time.

### Resolution

All FreeRDP users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=net-misc/freerdp-2.11.0"

```
### References

* [CVE-2022-39316](https://nvd.nist.gov/vuln/detail/CVE-2022-39316)
* [CVE-2022-39317](https://nvd.nist.gov/vuln/detail/CVE-2022-39317)
* [CVE-2022-39318](https://nvd.nist.gov/vuln/detail/CVE-2022-39318)
* [CVE-2022-39319](https://nvd.nist.gov/vuln/detail/CVE-2022-39319)
* [CVE-2022-39320](https://nvd.nist.gov/vuln/detail/CVE-2022-39320)
* [CVE-2022-39347](https://nvd.nist.gov/vuln/detail/CVE-2022-39347)
* [CVE-2022-41877](https://nvd.nist.gov/vuln/detail/CVE-2022-41877)
* [CVE-2023-39350](https://nvd.nist.gov/vuln/detail/CVE-2023-39350)
* [CVE-2023-39351](https://nvd.nist.gov/vuln/detail/CVE-2023-39351)
* [CVE-2023-39352](https://nvd.nist.gov/vuln/detail/CVE-2023-39352)
* [CVE-2023-39353](https://nvd.nist.gov/vuln/detail/CVE-2023-39353)
* [CVE-2023-39354](https://nvd.nist.gov/vuln/detail/CVE-2023-39354)
* [CVE-2023-39355](https://nvd.nist.gov/vuln/detail/CVE-2023-39355)
* [CVE-2023-39356](https://nvd.nist.gov/vuln/detail/CVE-2023-39356)
* [CVE-2023-40181](https://nvd.nist.gov/vuln/detail/CVE-2023-40181)
* [CVE-2023-40186](https://nvd.nist.gov/vuln/detail/CVE-2023-40186)
* [CVE-2023-40187](https://nvd.nist.gov/vuln/detail/CVE-2023-40187)
* [CVE-2023-40188](https://nvd.nist.gov/vuln/detail/CVE-2023-40188)
* [CVE-2023-40567](https://nvd.nist.gov/vuln/detail/CVE-2023-40567)
* [CVE-2023-40569](https://nvd.nist.gov/vuln/detail/CVE-2023-40569)
* [CVE-2023-40574](https://nvd.nist.gov/vuln/detail/CVE-2023-40574)
* [CVE-2023-40575](https://nvd.nist.gov/vuln/detail/CVE-2023-40575)
* [CVE-2023-40576](https://nvd.nist.gov/vuln/detail/CVE-2023-40576)
* [CVE-2023-40589](https://nvd.nist.gov/vuln/detail/CVE-2023-40589)

**Release date**

January 12, 2024

**Latest revision**

January 12, 2024: 1

**Severity**

normal

**Exploitable**

remote

**Bugzilla entries**

* [881525](https://bugs.gentoo.org/show_bug.cgi?id=881525)
* [918546](https://bugs.gentoo.org/show_bug.cgi?id=918546)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from github.com_e1de8c08_20250115_080731.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFreeRDP%2FFreeRDP%2Fblob%2F5be5553e0da72178a4b94cc1ffbdace9ceb153e5%2Flibfreerdp%2Fcodec%2Fh264.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFreeRDP%2FFreeRDP%2Fblob%2F5be5553e0da72178a4b94cc1ffbdace9ceb153e5%2Flibfreerdp%2Fcodec%2Fh264.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=FreeRDP%2FFreeRDP)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FreeRDP](/FreeRDP)
/
**[FreeRDP](/FreeRDP/FreeRDP)**
Public

* [Notifications](/login?return_to=%2FFreeRDP%2FFreeRDP) You must be signed in to change notification settings
* [Fork
  14.9k](/login?return_to=%2FFreeRDP%2FFreeRDP)
* [Star
   11.2k](/login?return_to=%2FFreeRDP%2FFreeRDP)

* [Code](/FreeRDP/FreeRDP)
* [Issues
  226](/FreeRDP/FreeRDP/issues)
* [Pull requests
  22](/FreeRDP/FreeRDP/pulls)
* [Discussions](/FreeRDP/FreeRDP/discussions)
* [Actions](/FreeRDP/FreeRDP/actions)
* [Projects
  0](/FreeRDP/FreeRDP/projects)
* [Wiki](/FreeRDP/FreeRDP/wiki)
* [Security](/FreeRDP/FreeRDP/security)
* [Insights](/FreeRDP/FreeRDP/pulse)

Additional navigation options

* [Code](/FreeRDP/FreeRDP)
* [Issues](/FreeRDP/FreeRDP/issues)
* [Pull requests](/FreeRDP/FreeRDP/pulls)
* [Discussions](/FreeRDP/FreeRDP/discussions)
* [Actions](/FreeRDP/FreeRDP/actions)
* [Projects](/FreeRDP/FreeRDP/projects)
* [Wiki](/FreeRDP/FreeRDP/wiki)
* [Security](/FreeRDP/FreeRDP/security)
* [Insights](/FreeRDP/FreeRDP/pulse)

## Files

 5be5553
## Breadcrumbs

1. [FreeRDP](/FreeRDP/FreeRDP/tree/5be5553e0da72178a4b94cc1ffbdace9ceb153e5)
2. /[libfreerdp](/FreeRDP/FreeRDP/tree/5be5553e0da72178a4b94cc1ffbdace9ceb153e5/libfreerdp)
3. /[codec](/FreeRDP/FreeRDP/tree/5be5553e0da72178a4b94cc1ffbdace9ceb153e5/libfreerdp/codec)
/
# h264.c

Copy path Blame  Blame
## Latest commit

## History

[History](/FreeRDP/FreeRDP/commits/5be5553e0da72178a4b94cc1ffbdace9ceb153e5/libfreerdp/codec/h264.c)765 lines (650 loc) · 19.2 KB 5be5553
## Breadcrumbs

1. [FreeRDP](/FreeRDP/FreeRDP/tree/5be5553e0da72178a4b94cc1ffbdace9ceb153e5)
2. /[libfreerdp](/FreeRDP/FreeRDP/tree/5be5553e0da72178a4b94cc1ffbdace9ceb153e5/libfreerdp)
3. /[codec](/FreeRDP/FreeRDP/tree/5be5553e0da72178a4b94cc1ffbdace9ceb153e5/libfreerdp/codec)
/
# h264.c

Top
## File metadata and controls

* Code
* Blame

765 lines (650 loc) · 19.2 KB[Raw](https://github.com/FreeRDP/FreeRDP/raw/5be5553e0da72178a4b94cc1ffbdace9ceb153e5/libfreerdp/codec/h264.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765/\*\* \* FreeRDP: A Remote Desktop Protocol Implementation \* H.264 Bitmap Compression \* \* Copyright 2014 Mike McDonald <Mike.McDonald@software.dell.com> \* Copyright 2017 David Fort <contact@hardening-consulting.com> \* \* Licensed under the Apache License, Version 2.0 (the "License"); \* you may not use this file except in compliance with the License. \* You may obtain a copy of the License at \* \* http://www.apache.org/licenses/LICENSE-2.0 \* \* Unless required by applicable law or agreed to in writing, software \* distributed under the License is distributed on an "AS IS" BASIS, \* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. \* See the License for the specific language governing permissions and \* limitations under the License. \*/
#include <freerdp/config.h>
#include <winpr/crt.h>#include <winpr/print.h>#include <winpr/library.h>#include <winpr/bitstream.h>#include <winpr/synch.h>
#include <freerdp/primitives.h>#include <freerdp/codec/h264.h>#include <freerdp/codec/yuv.h>#include <freerdp/log.h>
#include "h264.h"
#define TAG FREERDP\_TAG("codec")
static BOOL avc444\_ensure\_buffer(H264\_CONTEXT\* h264, DWORD nDstHeight);
BOOL avc420\_ensure\_buffer(H264\_CONTEXT\* h264, UINT32 stride, UINT32 width, UINT32 height){ size\_t x; BOOL isNull = FALSE; UINT32 pheight = height;
 if (!h264) return FALSE;
 if (stride == 0) stride = width;
 if (stride % 16 != 0) stride += 16 - stride % 16;
 if (pheight % 16 != 0) pheight += 16 - pheight % 16;
 for (x = 0; x < 3; x++) { if (!h264->pYUVData[x] || !h264->pOldYUVData[x]) isNull = TRUE; }
 if (isNull || (width != h264->width) || (height != h264->height) || (stride != h264->iStride[0])) { h264->iStride[0] = stride; h264->iStride[1] = (stride + 1) / 2; h264->iStride[2] = (stride + 1) / 2; h264->width = width; h264->height = height;
 for (x = 0; x < 3; x++) { BYTE\* tmp1 = winpr\_aligned\_recalloc(h264->pYUVData[x], h264->iStride[x], pheight, 16); BYTE\* tmp2 = winpr\_aligned\_recalloc(h264->pOldYUVData[x], h264->iStride[x], pheight, 16); if (tmp1) h264->pYUVData[x] = tmp1; if (tmp2) h264->pOldYUVData[x] = tmp2; if (!tmp1 || !tmp2) return FALSE; } }
 return TRUE;}
INT32 avc420\_decompress(H264\_CONTEXT\* h264, const BYTE\* pSrcData, UINT32 SrcSize, BYTE\* pDstData, DWORD DstFormat, UINT32 nDstStep, UINT32 nDstWidth, UINT32 nDstHeight, const RECTANGLE\_16\* regionRects, UINT32 numRegionRects){ int status; const BYTE\* pYUVData[3];
 if (!h264 || h264->Compressor) return -1001;
 status = h264->subsystem->Decompress(h264, pSrcData, SrcSize);
 if (status == 0) return 1;
 if (status < 0) return status;
 pYUVData[0] = h264->pYUVData[0]; pYUVData[1] = h264->pYUVData[1]; pYUVData[2] = h264->pYUVData[2]; if (!yuv420\_context\_decode(h264->yuv, pYUVData, h264->iStride, h264->height, DstFormat, pDstData, nDstStep, regionRects, numRegionRects)) return -1002;
 return 1;}
static BOOL allocate\_h264\_metablock(UINT32 QP, RECTANGLE\_16\* rectangles, RDPGFX\_H264\_METABLOCK\* meta, size\_t count){ size\_t x;
 /\* [MS-RDPEGFX] 2.2.4.4.2 RDPGFX\_AVC420\_QUANT\_QUALITY \*/ if (!meta || (QP > UINT8\_MAX)) return FALSE;
 meta->regionRects = rectangles; if (count == 0) return TRUE;
 if (count > UINT32\_MAX) return FALSE;
 meta->quantQualityVals = calloc(count, sizeof(RDPGFX\_H264\_QUANT\_QUALITY));
 if (!meta->quantQualityVals || !meta->regionRects) return FALSE; meta->numRegionRects = (UINT32)count; for (x = 0; x < count; x++) { RDPGFX\_H264\_QUANT\_QUALITY\* cur = &meta->quantQualityVals[x]; cur->qp = (UINT8)QP;
 /\* qpVal bit 6 and 7 are flags, so mask them out here. \* qualityVal is [0-100] so 100 - qpVal [0-64] is always in range \*/ cur->qualityVal = 100 - (QP & 0x3F); } return TRUE;}
static INLINE BOOL diff\_tile(const RECTANGLE\_16\* regionRect, BYTE\* pYUVData[3], BYTE\* pOldYUVData[3], UINT32 const iStride[3]){ size\_t size, y; if (!regionRect || !pYUVData || !pOldYUVData || !iStride) return FALSE; size = regionRect->right - regionRect->left; if (regionRect->right > iStride[0]) return FALSE; if (regionRect->right / 2u > iStride[1]) return FALSE; if (regionRect->right / 2u > iStride[2]) return FALSE;
 for (y = regionRect->top; y < regionRect->bottom; y++) { const BYTE\* cur0 = &pYUVData[0][y \* iStride[0]]; const BYTE\* cur1 = &pYUVData[1][y \* iStride[1]]; const BYTE\* cur2 = &pYUVData[2][y \* iStride[2]]; const BYTE\* old0 = &pOldYUVData[0][y \* iStride[0]]; const BYTE\* old1 = &pOldYUVData[1][y \* iStride[1]]; const BYTE\* old2 = &pOldYUVData[2][y \* iStride[2]];
 if (memcmp(&cur0[regionRect->left], &old0[regionRect->left], size) != 0) return TRUE; if (memcmp(&cur1[regionRect->left / 2], &old1[regionRect->left / 2], size / 2) != 0) return TRUE; if (memcmp(&cur2[regionRect->left / 2], &old2[regionRect->left / 2], size / 2) != 0) return TRUE; } return FALSE;}
static BOOL detect\_changes(BOOL firstFrameDone, const UINT32 QP, const RECTANGLE\_16\* regionRect, BYTE\* pYUVData[3], BYTE\* pOldYUVData[3], UINT32 const iStride[3], RDPGFX\_H264\_METABLOCK\* meta){ size\_t count = 0, wc, hc; RECTANGLE\_16\* rectangles;
 if (!regionRect || !pYUVData || !pOldYUVData || !iStride || !meta) return FALSE;
 wc = (regionRect->right - regionRect->left) / 64 + 1; hc = (regionRect->bottom - regionRect->top) / 64 + 1; rectangles = calloc(wc \* hc, sizeof(RECTANGLE\_16)); if (!rectangles) return FALSE; if (!firstFrameDone) { rectangles[0] = \*regionRect; count = 1; } else { size\_t x, y; for (y = regionRect->top; y < regionRect->bottom; y += 64) { for (x = regionRect->left; x < regionRect->right; x += 64) { RECTANGLE\_16 rect; rect.left = (UINT16)MIN(UINT16\_MAX, regionRect->left + x); rect.top = (UINT16)MIN(UINT16\_MAX, regionRect->top + y); rect.right = (UINT16)MIN(UINT16\_MAX, MIN(regionRect->left + x + 64, regionRect->right)); rect.bottom = (UINT16)MIN(UINT16\_MAX, MIN(regionRect->top + y + 64, regionRect->bottom)); if (diff\_tile(&rect, pYUVData, pOldYUVData, iStride)) rectangles[count++] = rect; } } } if (!allocate\_h264\_metablock(QP, rectangles, meta, count)) return FALSE; return TRUE;}
INT32 avc420\_compress(H264\_CONTEXT\* h264, const BYTE\* pSrcData, DWORD SrcFormat, UINT32 nSrcStep, UINT32 nSrcWidth, UINT32 nSrcHeight, const RECTANGLE\_16\* regionRect, BYTE\*\* ppDstData, UINT32\* pDstSize, RDPGFX\_H264\_METABLOCK\* meta){ size\_t x; INT32 rc = -1; BYTE\* pYUVData[3] = { 0 }; const BYTE\* pcYUVData[3] = { 0 }; BYTE\* pOldYUVData[3] = { 0 };
 if (!h264 || !regionRect || !meta || !h264->Compressor) return -1;
 if (!h264->subsystem->Compress) return -1;
 if (!avc420\_ensure\_buffer(h264, nSrcStep, nSrcWidth, nSrcHeight)) return -1;
 if (h264->encodingBuffer) { for (x = 0; x < 3; x++) { pYUVData[x] = h264->pYUVData[x]; pOldYUVData[x] = h264->pOldYUVData[x]; } } else { for (x = 0; x < 3; x++) { pYUVData[x] = h264->pOldYUVData[x]; pOldYUVData[x] = h264->pYUVData[x]; } } h264->encodingBuffer = !h264->encodingBuffer;
 if (!yuv420\_context\_encode(h264->yuv, pSrcData, nSrcStep, SrcFormat, h264->iStride, pYUVData, regionRect, 1)) goto fail;
 if (!detect\_changes(h264->firstLumaFrameDone, h264->QP, regionRect, pYUVData, pOldYUVData, h264->iStride, meta)) goto fail;
 if (meta->numRegionRects == 0) { rc = 0; goto fail; }
 for (x = 0; x < 3; x++) pcYUVData[x] = pYUVData[x];
 rc = h264->subsystem->Compress(h264, pcYUVData, h264->iStride, ppDstData, pDstSize); if (rc >= 0) h264->firstLumaFrameDone = TRUE;
fail: if (rc < 0) free\_h264\_metablock(meta); return rc;}
INT32 avc444\_compress(H264\_CONTEXT\* h264, const BYTE\* pSrcData, DWORD SrcFormat, UINT32 nSrcStep, UINT32 nSrcWidth, UINT32 nSrcHeight, BYTE version, const RECTANGLE\_16\* region, BYTE\* op, BYTE\*\* ppDstData, UINT32\* pDstSize, BYTE\*\* ppAuxDstData, UINT32\* pAuxDstSize, RDPGFX\_H264\_METABLOCK\* meta, RDPGFX\_H264\_METABLOCK\* auxMeta){ int rc = -1; BYTE\* coded; UINT32 codedSize; BYTE\*\* pYUV444Data; BYTE\*\* pOldYUV444Data; BYTE\*\* pYUVData; BYTE\*\* pOldYUVData;
 if (!h264 || !h264->Compressor) return -1;
 if (!h264->subsystem->Compress) return -1;
 if (!avc420\_ensure\_buffer(h264, nSrcStep, nSrcWidth, nSrcHeight)) return -1;
 if (!avc444\_ensure\_buffer(h264, nSrcHeight)) return -1;
 if (h264->encodingBuffer) { pYUV444Data = h264->pOldYUV444Data; pOldYUV444Data = h264->pYUV444Data; pYUVData = h264->pOldYUVData; pOldYUVData = h264->pYUVData; } else { pYUV444Data = h264->pYUV444Data; pOldYUV444Data = h264->pOldYUV444Data; pYUVData = h264->pYUVData; pOldYUVData = h264->pOldYUVData; } h264->encodingBuffer = !h264->encodingBuffer;
 if (!yuv444\_context\_encode(h264->yuv, version, pSrcData, nSrcStep, SrcFormat, h264->iStride, pYUV444Data, pYUVData, region, 1)) goto fail;
 if (!detect\_changes(h264->firstLumaFrameDone, h264->QP, region, pYUV444Data, pOldYUV444Data, h264->iStride, meta)) goto fail; if (!detect\_changes(h264->firstChromaFrameDone, h264->QP, region, pYUVData, pOldYUVData, h264->iStride, auxMeta)) goto fail;
 /\* [MS-RDPEGFX] 2.2.4.5 RFX\_AVC444\_BITMAP\_STREAM \* LC: \* 0 ... Luma & Chroma \* 1 ... Luma \* 2 ... Chroma \*/ if ((meta->numRegionRects > 0) && (auxMeta->numRegionRects > 0)) \*op = 0; else if (meta->numRegionRects > 0) \*op = 1; else if (auxMeta->numRegionRects > 0) \*op = 2; else { WLog\_INFO(TAG, "no changes detected for luma or chroma frame"); rc = 0; goto fail; }
 if ((\*op == 0) || (\*op == 1)) { const BYTE\* pcYUV444Data[3] = { pYUV444Data[0], pYUV444Data[1], pYUV444Data[2] };
 if (h264->subsystem->Compress(h264, pcYUV444Data, h264->iStride, &coded, &codedSize) < 0) goto fail; h264->firstLumaFrameDone = TRUE; memcpy(h264->lumaData, coded, codedSize); \*ppDstData = h264->lumaData; \*pDstSize = codedSize; }
 if ((\*op == 0) || (\*op == 2)) { const BYTE\* pcYUVData[3] = { pYUVData[0], pYUVData[1], pYUVData[2] };
 if (h264->subsystem->Compress(h264, pcYUVData, h264->iStride, &coded, &codedSize) < 0) goto fail; h264->firstChromaFrameDone = TRUE; \*ppAuxDstData = coded; \*pAuxDstSize = codedSize; }
 rc = 1;fail: if (rc < 0) { free\_h264\_metablock(meta); free\_h264\_metablock(auxMeta); } return rc;}
static BOOL avc444\_ensure\_buffer(H264\_CONTEXT\* h264, DWORD nDstHeight){ UINT32 x; const UINT32\* piMainStride = h264->iStride; UINT32\* piDstSize = h264->iYUV444Size; UINT32\* piDstStride = h264->iYUV444Stride; BYTE\*\* ppYUVDstData = h264->pYUV444Data; BYTE\*\* ppOldYUVDstData = h264->pOldYUV444Data; const UINT32 pad = nDstHeight % 16; UINT32 padDstHeight = nDstHeight; /\* Need alignment to 16x16 blocks \*/
 if (pad != 0) padDstHeight += 16 - pad;
 if ((piMainStride[0] != piDstStride[0]) || (piDstSize[0] != piMainStride[0] \* padDstHeight)) { for (x = 0; x < 3; x++) { BYTE\* tmp1; BYTE\* tmp2; piDstStride[x] = piMainStride[0]; piDstSize[x] = piDstStride[x] \* padDstHeight; tmp1 = winpr\_aligned\_recalloc(ppYUVDstData[x], piDstSize[x], 1, 16); if (tmp1) ppYUVDstData[x] = tmp1; tmp2 = winpr\_aligned\_recalloc(ppOldYUVDstData[x], piDstSize[x], 1, 16); if (tmp2) ppOldYUVDstData[x] = tmp2; if (!tmp1 || !tmp2) goto fail; }
 { BYTE\* tmp = winpr\_aligned\_recalloc(h264->lumaData, piDstSize[0], 4, 16); if (!tmp) goto fail; h264->lumaData = tmp; } }
 for (x = 0; x < 3; x++) { if (!ppOldYUVDstData[x] || !ppYUVDstData[x] || (piDstSize[x] == 0) || (piDstStride[x] == 0)) { WLog\_Print(h264->log, WLOG\_ERROR, "YUV buffer not initialized! check your decoder settings"); goto fail; } }
 if (!h264->lumaData) goto fail;
 return TRUE;fail: return FALSE;}
static BOOL avc444\_process\_rects(H264\_CONTEXT\* h264, const BYTE\* pSrcData, UINT32 SrcSize, BYTE\* pDstData, UINT32 DstFormat, UINT32 nDstStep, UINT32 nDstWidth, UINT32 nDstHeight, const RECTANGLE\_16\* rects, UINT32 nrRects, avc444\_frame\_type type){ const BYTE\* pYUVData[3]; BYTE\* pYUVDstData[3]; UINT32\* piDstStride = h264->iYUV444Stride; BYTE\*\* ppYUVDstData = h264->pYUV444Data; const UINT32\* piStride = h264->iStride;
 if (h264->subsystem->Decompress(h264, pSrcData, SrcSize) < 0) return FALSE;
 pYUVData[0] = h264->pYUVData[0]; pYUVData[1] = h264->pYUVData[1]; pYUVData[2] = h264->pYUVData[2]; if (!avc444\_ensure\_buffer(h264, nDstHeight)) return FALSE;
 pYUVDstData[0] = ppYUVDstData[0]; pYUVDstData[1] = ppYUVDstData[1]; pYUVDstData[2] = ppYUVDstData[2]; if (!yuv444\_context\_decode(h264->yuv, (BYTE)type, pYUVData, piStride, h264->height, pYUVDstData, piDstStride, DstFormat, pDstData, nDstStep, rects, nrRects)) return FALSE;
 return TRUE;}
#if defined(AVC444\_FRAME\_STAT)static UINT64 op1 = 0;static double op1sum = 0;static UINT64 op2 = 0;static double op2sum = 0;static UINT64 op3 = 0;static double op3sum = 0;static double avg(UINT64\* count, double old, double size){ double tmp = size + \*count \* old; (\*count)++; tmp = tmp / \*count; return tmp;}#endif
INT32 avc444\_decompress(H264\_CONTEXT\* h264, BYTE op, const RECTANGLE\_16\* regionRects, UINT32 numRegionRects, const BYTE\* pSrcData, UINT32 SrcSize, const RECTANGLE\_16\* auxRegionRects, UINT32 numAuxRegionRect, const BYTE\* pAuxSrcData, UINT32 AuxSrcSize, BYTE\* pDstData, DWORD DstFormat, UINT32 nDstStep, UINT32 nDstWidth, UINT32 nDstHeight, UINT32 codecId){ INT32 status = -1; avc444\_frame\_type chroma = (codecId == RDPGFX\_CODECID\_AVC444) ? AVC444\_CHROMAv1 : AVC444\_CHROMAv2;
 if (!h264 || !regionRects || !pSrcData || !pDstData || h264->Compressor) return -1001;
 switch (op) { case 0: /\* YUV420 in stream 1 \* Chroma420 in stream 2 \*/ if (!avc444\_process\_rects(h264, pSrcData, SrcSize, pDstData, DstFormat, nDstStep, nDstWidth, nDstHeight, regionRects, numRegionRects, AVC444\_LUMA)) status = -1; else if (!avc444\_process\_rects(h264, pAuxSrcData, AuxSrcSize, pDstData, DstFormat, nDstStep, nDstWidth, nDstHeight, auxRegionRects, numAuxRegionRect, chroma)) status = -1; else status = 0;
 break;
 case 2: /\* Chroma420 in stream 1 \*/ if (!avc444\_process\_rects(h264, pSrcData, SrcSize, pDstData, DstFormat, nDstStep, nDstWidth, nDstHeight, regionRects, numRegionRects, chroma)) status = -1; else status = 0;
 break;
 case 1: /\* YUV420 in stream 1 \*/ if (!avc444\_process\_rects(h264, pSrcData, SrcSize, pDstData, DstFormat, nDstStep, nDstWidth, nDstHeight, regionRects, numRegionRects, AVC444\_LUMA)) status = -1; else status = 0;
 break;
 default: /\* WTF? \*/ break; }
#if defined(AVC444\_FRAME\_STAT)
 switch (op) { case 0: op1sum = avg(&op1, op1sum, SrcSize + AuxSrcSize); break;
 case 1: op2sum = avg(&op2, op2sum, SrcSize); break;
 case 2: op3sum = avg(&op3, op3sum, SrcSize); break;
 default: break; }
 WLog\_Print(h264->log, WLOG\_INFO, "luma=%" PRIu64 " [avg=%lf] chroma=%" PRIu64 " [avg=%lf] combined=%" PRIu64 " [avg=%lf]", op1, op1sum, op2, op2sum, op3, op3sum);#endif return status;}
#define MAX\_SUBSYSTEMS 10static INIT\_ONCE subsystems\_once = INIT\_ONCE\_STATIC\_INIT;static const H264\_CONTEXT\_SUBSYSTEM\* subSystems[MAX\_SUBSYSTEMS] = { 0 };
static BOOL CALLBACK h264\_register\_subsystems(PINIT\_ONCE once, PVOID param, PVOID\* context){ int i = 0;
#ifdef WITH\_MEDIACODEC { subSystems[i] = &g\_Subsystem\_mediacodec; i++; }#endif#if defined(\_WIN32) && defined(WITH\_MEDIA\_FOUNDATION) { subSystems[i] = &g\_Subsystem\_MF; i++; }#endif#ifdef WITH\_OPENH264 { subSystems[i] = &g\_Subsystem\_OpenH264; i++; }#endif#ifdef WITH\_VIDEO\_FFMPEG { subSystems[i] = &g\_Subsystem\_libavcodec; i++; }#endif return i > 0;}
static BOOL h264\_context\_init(H264\_CONTEXT\* h264){ int i;
 if (!h264) return FALSE;
 h264->log = WLog\_Get(TAG);
 if (!h264->log) return FALSE;
 h264->subsystem = NULL; InitOnceExecuteOnce(&subsystems\_once, h264\_register\_subsystems, NULL, NULL);
 for (i = 0; i < MAX\_SUBSYSTEMS; i++) { const H264\_CONTEXT\_SUBSYSTEM\* subsystem = subSystems[i];
 if (!subsystem || !subsystem->Init) break;
 if (subsystem->Init(h264)) { h264->subsystem = subsystem; return TRUE; } }
 return FALSE;}
BOOL h264\_context\_reset(H264\_CONTEXT\* h264, UINT32 width, UINT32 height){ if (!h264) return FALSE;
 h264->width = width; h264->height = height; return yuv\_context\_reset(h264->yuv, width, height);}
H264\_CONTEXT\* h264\_context\_new(BOOL Compressor){ H264\_CONTEXT\* h264 = (H264\_CONTEXT\*)calloc(1, sizeof(H264\_CONTEXT)); if (!h264) return NULL;
 h264->Compressor = Compressor; if (Compressor)
 { /\* Default compressor settings, may be changed by caller \*/ h264->BitRate = 1000000; h264->FrameRate = 30; }
 if (!h264\_context\_init(h264)) goto fail;
 h264->yuv = yuv\_context\_new(Compressor, 0); if (!h264->yuv) goto fail;
 return h264;
fail: h264\_context\_free(h264); return NULL;}
void h264\_context\_free(H264\_CONTEXT\* h264){ if (h264) { size\_t x; if (h264->subsystem) h264->subsystem->Uninit(h264);
 for (x = 0; x < 3; x++) { if (h264->Compressor) { winpr\_aligned\_free(h264->pYUVData[x]); winpr\_aligned\_free(h264->pOldYUVData[x]); } winpr\_aligned\_free(h264->pYUV444Data[x]); winpr\_aligned\_free(h264->pOldYUV444Data[x]); } winpr\_aligned\_free(h264->lumaData);
 yuv\_context\_free(h264->yuv); free(h264); }}
void free\_h264\_metablock(RDPGFX\_H264\_METABLOCK\* meta){ RDPGFX\_H264\_METABLOCK m = { 0 }; if (!meta) return; free(meta->quantQualityVals); free(meta->regionRects); \*meta = m;}
BOOL h264\_context\_set\_option(H264\_CONTEXT\* h264, H264\_CONTEXT\_OPTION option, UINT32 value){ WINPR\_ASSERT(h264); switch (option) { case H264\_CONTEXT\_OPTION\_BITRATE: h264->BitRate = value; return TRUE; case H264\_CONTEXT\_OPTION\_FRAMERATE: h264->FrameRate = value; return TRUE; case H264\_CONTEXT\_OPTION\_RATECONTROL: h264->RateControlMode = value; return TRUE; case H264\_CONTEXT\_OPTION\_QP: h264->QP = value; return TRUE; default: WLog\_Print(h264->log, WLOG\_WARN, "Unknown H264\_CONTEXT\_OPTION[0x%08" PRIx32 "]", option); return FALSE; }}
UINT32 h264\_context\_get\_option(H264\_CONTEXT\* h264, H264\_CONTEXT\_OPTION option){ WINPR\_ASSERT(h264); switch (option) { case H264\_CONTEXT\_OPTION\_BITRATE: return h264->BitRate; case H264\_CONTEXT\_OPTION\_FRAMERATE: return h264->FrameRate; case H264\_CONTEXT\_OPTION\_RATECONTROL: return h264->RateControlMode; case H264\_CONTEXT\_OPTION\_QP: return h264->QP; default: WLog\_Print(h264->log, WLOG\_WARN, "Unknown H264\_CONTEXT\_OPTION[0x%08" PRIx32 "]", option); return 0; }}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


