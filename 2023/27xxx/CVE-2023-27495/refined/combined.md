=== Content from github.com_6f71e79b_20250114_230304.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffastify%2Fcsrf-protection%2Fsecurity%2Fadvisories%2FGHSA-qrgf-9gpc-vrxw)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffastify%2Fcsrf-protection%2Fsecurity%2Fadvisories%2FGHSA-qrgf-9gpc-vrxw)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=fastify%2Fcsrf-protection)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[fastify](/fastify)
/
**[csrf-protection](/fastify/csrf-protection)**
Public

* [Notifications](/login?return_to=%2Ffastify%2Fcsrf-protection) You must be signed in to change notification settings
* [Fork
  20](/login?return_to=%2Ffastify%2Fcsrf-protection)
* [Star
   154](/login?return_to=%2Ffastify%2Fcsrf-protection)

* [Code](/fastify/csrf-protection)
* [Issues
  4](/fastify/csrf-protection/issues)
* [Pull requests
  1](/fastify/csrf-protection/pulls)
* [Actions](/fastify/csrf-protection/actions)
* [Security](/fastify/csrf-protection/security)
* [Insights](/fastify/csrf-protection/pulse)

Additional navigation options

* [Code](/fastify/csrf-protection)
* [Issues](/fastify/csrf-protection/issues)
* [Pull requests](/fastify/csrf-protection/pulls)
* [Actions](/fastify/csrf-protection/actions)
* [Security](/fastify/csrf-protection/security)
* [Insights](/fastify/csrf-protection/pulse)

# Bypass of CSRF protection in the presence of predictable userInfo

Moderate

[mcollina](/mcollina)
published
GHSA-qrgf-9gpc-vrxw
Apr 20, 2023

## Package

npm

@fastify/csrf-protection
([npm](/advisories?query=ecosystem%3Anpm))

## Affected versions

<= 4.0.1 && 5.0.0 <= 6.2.0

## Patched versions

>= 4.1.0 < 5.0.0 && >= 6.3.0

## Description

## Description

The [CSRF](https://owasp.org/www-community/attacks/csrf) protection enforced by the `@fastify/csrf-protection` library in combination with `@fastify/cookie` can be bypassed from network and same-site attackers under certain conditions.

`@fastify/csrf-protection` supports an optional `userInfo` parameter that binds the CSRF token to the user. This parameter has been introduced to prevent cookie-tossing attacks as a fix for [CVE-2021-29624](https://www.cvedetails.com/cve/CVE-2021-29624). Whenever `userInfo` parameter is missing, or its value can be predicted for the target user account, network and [same-site](https://canitakeyoursubdomain.name/) attackers can 1. fixate a `_csrf` cookie in the victim's browser, and 2. forge CSRF tokens that are valid for the victim's session. This allows attackers to bypass the CSRF protection mechanism.

As a fix, `@fastify/csrf-protection` starting from version 6.3.0 (and v4.1.0) includes a server-defined secret `hmacKey` that cryptographically binds the CSRF token to the value of the `_csrf` cookie and the `userInfo` parameter, making tokens non-spoofable by attackers. This protection is effective as long as the `userInfo` parameter is unique for each user.

### Patches

This is patched in version 6.3.0 and v4.1.0.

### Workarounds

As a workaround, developers can use a random, non-predictable `userInfo` parameter for each user.

## Credits

* Pedro Adão ([@pedromigueladao](https://github.com/pedromigueladao)), [Instituto Superior Técnico, University of Lisbon](https://tecnico.ulisboa.pt/)
* Marco Squarcina ([@lavish](https://github.com/lavish)), [Security & Privacy Research Unit, TU Wien](https://secpriv.wien/)

### Severity

Moderate

5.3

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
None

User interaction
Required

Scope
Unchanged

Confidentiality
None

Integrity
High

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:U/C:N/I:H/A:N

### CVE ID

CVE-2023-27495

### Weaknesses

[CWE-352](/advisories?query=cwe%3A352)

### Credits

* [![@pedromigueladao](https://avatars.githubusercontent.com/u/15143244?s=40&v=4)](/pedromigueladao)
  [pedromigueladao](/pedromigueladao)
  Reporter
* [![@lavish](https://avatars.githubusercontent.com/u/446674?s=40&v=4)](/lavish)
  [lavish](/lavish)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.cvedetails.com_ab63a905_20250114_230305.html ===

[Documentation](/documentation/ "User guide and product documentation")

[Documentation](/documentation/ "User guide and product documentation")

* [Log in](/sign-in "Login")

[![](/img/ssc-logo.svg "SecurityScorecard")
CVEdetails.com](/ "Go to cvedetails.com homepage")
[powered by SecurityScorecard](https://securityscorecard.com?utm_source=cvedetails)

Vulnerabilities

[By Date](/browse-by-date.php "Browse security vulnerabilities by date")
[By Type](/vulnerabilities-by-types.php "Vulnerability distribution by type")
[Known Exploited](/cisa-known-exploited-vulnerabilities/kev-1.html "Vulnerabilities in the CISA Known Exploited Vulnerabilities (KEV) catalog")
[Assigners](/cve-assigners-cnas/1.html "CVE sources, assigners")
[CVSS Scores](/cvss-score-charts.php "CVSS score distribution report")
[EPSS Scores](/epss/epss-score-history.html?delta=110 "EPSS score change history")
[Search](/vulnerability-search.php "Vulnerability search")

Vulnerable Software

[Vendors](/vendor.php "Browse software and hardware vendors")
[Products](/product-list.php "Browse software and hardware products")
[Version Search](/version-search.php "Search for product versions")

Vulnerability Intel.

[Newsfeed](/data/list "Newsfeed, things you need to know, most recent first")
[Open Source Vulns](/osv/ecosystem/list "Vulnerabilities in open source projects and ecosystems")
[Emerging CVEs](/data/emerging-CVEs "CVEs discovered in other sources but not yet published")
[Feeds](/feed-aggregator/feed-list "RSS feed aggregator")
[Exploits](/exploit/list "Exploits from exploit-db, packetstorm and metasploit")
[Advisories](/advisory/list "Security advisories from vendors and other sources like github")
[Code Repositories](/code/repositories "Monitored open source repositories")
[Code Changes](/code/changes "Source code changes related to security issues and CVEs")

Attack Surface

[My Attack Surface](/asi/my-attack-surface "External attack surface summary for my organization")
[Digital Footprint](/asi/my-digital-footprint "Digital footprint of my organization")
[Discovered Products](/asi/discovered-products "Products discovered on my attack surface by scanners")
[Detected Vulns](/asi/detected-vulns "Vulnerabilities detected on my attack surface by scanners")
[IP Search](/asi/ip-details "Search for an IP address")

Other

[Metasploit Modules](/metasploit-modules/1.html "Metasploit modules and related CVEs")
[CWE Definitions](/cwe-definitions/ "CWE definitions")
[CAPEC Definitions](/capec-definitions/ "CAPEC definitions")
[Articles](https://securityscorecard.com/research/?utm_source=cvedetails "Featured research articles from SecurityScorecard")
[Blog](https://securityscorecard.com/blog/?utm_source=cvedetails "SecurityScorecard blog")

# Vulnerability Details : [CVE-2021-29624](/cve/CVE-2021-29624/ "CVE-2021-29624 security vulnerability details")

fastify-csrf is an open-source plugin helps developers protect their Fastify server against CSRF attacks. Versions of fastify-csrf prior to 3.1.0 have a "double submit" mechanism using cookies with an application deployed across multiple subdomains, e.g. "heroku"-style platform as a service. Version 3.1.0 of the fastify-csrf fixes it. the vulnerability. The user of the module would need to supply a `userInfo` when generating the CSRF token to fully implement the protection on their end. This is needed only for applications hosted on different subdomains.

Published
2021-05-19 22:15:08
Updated
2022-10-25 20:56:25
Source
[GitHub, Inc.](/vulnerability-list/assigner-96/GitHub-Inc..html "CVEs created by GitHub, Inc.")

View at

[NVD](https://nvd.nist.gov/vuln/detail/CVE-2021-29624 "Vulnerability details at NVD"),

[CVE.org](https://www.cve.org/CVERecord?id=CVE-2021-29624 "Vulnerability details at CVE project")

Vulnerability category: Cross-site request forgery (CSRF)

## Products affected by CVE-2021-29624

* [Fastify](/vendor/20791/Fastify.html "Details for Fastify") » [Fastify-csrf](/version-list/20791/90789/1/Fastify-Fastify-csrf.html "Fastify Fastify-csrf versions list") » For Node.js  Versions before (<) 3.1.0cpe:2.3:a:fastify:fastify-csrf:\*:\*:\*:\*:\*:node.js:\*:\* [Matching versions](/version-search.php?cpeMatchCriteriaId=0f5a2aff-5df3-40ed-b043-5d581fc7e05e "Matching product versions")

## Exploit prediction scoring system (EPSS) score for CVE-2021-29624

[EPSS FAQ](/epss/faq.html "Exploit Prediction Scoring System (EPSS) FAQ")

0.14%
Probability of exploitation activity in the next 30 days
[EPSS Score History](/epss/CVE-2021-29624/epss-score-history.html "Exploit Prediction Scoring System (EPSS) score history for CVE-2021-29624")

~ 49 %

Percentile, the proportion of vulnerabilities that are scored at or less

## CVSS scores for CVE-2021-29624

| Base Score | Base Severity | CVSS Vector | Exploitability Score | Impact Score | Score Source | First Seen |
| --- | --- | --- | --- | --- | --- | --- |
| 4.3 | MEDIUM | AV:N/AC:M/Au:N/C:N/I:P/A:N | 8.6 | 2.9 | NIST |  |
| Access Vector: NetworkAccess Complexity: MediumAuthentication: NoneConfidentiality Impact: NoneIntegrity Impact: PartialAvailability Impact: None | | | | | | |
| 6.5 | MEDIUM | CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N | 2.8 | 3.6 | NIST |  |
| Attack Vector: NetworkAttack Complexity: LowPrivileges Required: NoneUser Interaction: RequiredScope: UnchangedConfidentiality: NoneIntegrity: HighAvailability: None | | | | | | |
| 6.5 | MEDIUM | CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N | 2.8 | 3.6 | GitHub, Inc. |  |
| Attack Vector: NetworkAttack Complexity: LowPrivileges Required: NoneUser Interaction: RequiredScope: UnchangedConfidentiality: NoneIntegrity: HighAvailability: None | | | | | | |

## CWE ids for CVE-2021-29624

* [CWE-352 Cross-Site Request Forgery (CSRF)](/cwe-details/352/Cross-Site-Request-Forgery-CSRF-.html "CWE-352 - CWE definition")

  The web application does not, or can not, sufficiently verify whether a well-formed, valid, consistent request was intentionally provided by the user who submitted the request.
  Assigned by:
  nvd@nist.gov (Primary)
* [CWE-565 Reliance on Cookies without Validation and Integrity Checking](/cwe-details/565/Reliance-on-Cookies-without-Validation-and-Integrity-Checkin.html "CWE-565 - CWE definition")

  The product relies on the existence or values of cookies when performing security-critical operations, but it does not properly ensure that the setting is valid for the associated user.
  Assigned by:
  security-advisories@github.com (Secondary)

## References for CVE-2021-29624

* [https://github.com/fastify/fastify-csrf/security/advisories/GHSA-rc4q-9m69-gqp8](https://github.com/fastify/fastify-csrf/security/advisories/GHSA-rc4q-9m69-gqp8 "Open reference url in new window - External link")
  Lack of protection against cookie tossing attacks in fastify-csrf · Advisory · fastify/fastify-csrf · GitHub Patch;Third Party Advisory
* [https://github.com/fastify/fastify-csrf/pull/51](https://github.com/fastify/fastify-csrf/pull/51 "Open reference url in new window - External link")
  Support userInfo by mcollina · Pull Request #51 · fastify/fastify-csrf · GitHub Patch;Third Party Advisory
* [https://owasp.org/www-pdf-archive/David\_Johansson-Double\_Defeat\_of\_Double-Submit\_Cookie.pdf](https://owasp.org/www-pdf-archive/David_Johansson-Double_Defeat_of_Double-Submit_Cookie.pdf "Open reference url in new window - External link")
  Third Party Advisory
* [https://github.com/fastify/csrf/pull/2](https://github.com/fastify/csrf/pull/2 "Open reference url in new window - External link")
  Add utilities to prevent cookie tossing and replay attacks by mcollina · Pull Request #2 · fastify/csrf · GitHub Patch;Third Party Advisory
* [https://github.com/fastify/fastify-csrf/releases/tag/v3.1.0](https://github.com/fastify/fastify-csrf/releases/tag/v3.1.0 "Open reference url in new window - External link")
  Release v3.1.0 · fastify/fastify-csrf · GitHub Third Party Advisory
* [https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site\_Request\_Forgery\_Prevention\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html "Open reference url in new window - External link")
  Cross-Site Request Forgery Prevention - OWASP Cheat Sheet Series Third Party Advisory
  [CVEs referencing this url](/reference-url-info/wO7FuOJ3ZjUBNvrvfP0mM4Dw7sA.html "CVEs referencing this url")

Jump to
CVE Summary
Affected Products
EPSS Score
CVSS Scores
CWEs
References

[About](/about-contact.php "About cvedetails.com")
[Terms of Use](/terms-and-conditions.php)
[Privacy Policy](/privacy.php)
[CVE Help](/cve-help.php "Help topics and more information about CVE")
[FAQ](/faq.php "Frequently asked questions")
[How it works](/how-does-it-work.php "Known limitations & technical details")

![](/img/ssc-logo.svg "SecurityScorecard")

SecurityScorecard

1140 Avenue of the Americas

19th Floor

New York, NY 10036

info@securityscorecard.io

United States: (800) 682-1707

International: +1(646) 809-2166

[Products](https://securityscorecard.com/product/?utm_source=cvedetails "SecurityScorecard products. Security ratings, automated assessments, and guidance")

[Solutions](https://securityscorecard.com/solutions?utm_source=cvedetails "SecurityScorecard Cybersecurity Risk Rating & Third-Party Risk Management Solutions")

[Customers](https://securityscorecard.com/customers/?utm_source=cvedetails "SecurityScorecard customers")

[Marketplace](https://platform.securityscorecard.io/#/marketplace?utm_source=cvedetails "SecurityScorecard Marketplace. Apps integrations and partners")

[Partners](https://securityscorecard.com/partners/?utm_source=cvedetails "SecurityScorecard partners")

[Resources](https://securityscorecard.com/resources/?utm_source=cvedetails "SecurityScorecard case studies, reports, ebooks and more resources")

[Company](https://securityscorecard.com/company/?utm_source=cvedetails "SecurityScorecard company and organization")

[Trust Portal](https://securityscorecard.com/trust/?utm_source=cvedetails "SecurityScorecard trust portal. Transparency into ratings methodology, insights into how it aligns with industry standards")

[Security Ratings](https://securityscorecard.com/security-rating?utm_source=cvedetails "SecurityScorecard security ratings")

[Login](https://platform.securityscorecard.io/#/start?utm_source=cvedetails "SecurityScorecard platform login")

[Blog](https://securityscorecard.com/blog/?utm_source=cvedetails "SecurityScorecard blog")

[Contact](https://securityscorecard.com/company/contact-us/?utm_source=cvedetails "Contact SecurityScorecard")

[Careers](https://securityscorecard.com/company/careers/?utm_source=cvedetails "SecurityScorecard careers")

[Feedback](https://support.securityscorecard.com?utm_source=cvedetails "Feedback")

This product uses data from the NVD API but is not endorsed or certified by the NVD.
See [NVD website](http://nvd.nist.gov "National vulnerability database web site - External link ") for more information.
CVE is a registred trademark of the MITRE Corporation and the authoritative source of CVE content is
[MITRE's CVE web site](http://cve.mitre.org/).
CWE is a registred trademark of the MITRE Corporation and the authoritative source of CWE content is
[MITRE's CWE web site](http://cwe.mitre.org/).
OVAL is a registered trademark of The MITRE Corporation and the authoritative source of OVAL content is
[MITRE's OVAL web site](http://oval.mitre.org).

This web site uses cookies for managing your session, storing preferences, website analytics and additional purposes
described in our [privacy policy](/privacy.php).

By using this web site you are agreeing to CVEdetails.com
[terms of use](/terms-and-conditions.php)!

Accept
Close



=== Content from github.com_45a7940a_20250114_230303.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffastify%2Fcsrf-protection%2Fcommit%2Fbe3e5761f37aa05c7c1ac8ed44499c51ecec8058)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffastify%2Fcsrf-protection%2Fcommit%2Fbe3e5761f37aa05c7c1ac8ed44499c51ecec8058)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=fastify%2Fcsrf-protection)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[fastify](/fastify)
/
**[csrf-protection](/fastify/csrf-protection)**
Public

* [Notifications](/login?return_to=%2Ffastify%2Fcsrf-protection) You must be signed in to change notification settings
* [Fork
  20](/login?return_to=%2Ffastify%2Fcsrf-protection)
* [Star
   154](/login?return_to=%2Ffastify%2Fcsrf-protection)

* [Code](/fastify/csrf-protection)
* [Issues
  4](/fastify/csrf-protection/issues)
* [Pull requests
  1](/fastify/csrf-protection/pulls)
* [Actions](/fastify/csrf-protection/actions)
* [Security](/fastify/csrf-protection/security)
* [Insights](/fastify/csrf-protection/pulse)

Additional navigation options

* [Code](/fastify/csrf-protection)
* [Issues](/fastify/csrf-protection/issues)
* [Pull requests](/fastify/csrf-protection/pulls)
* [Actions](/fastify/csrf-protection/actions)
* [Security](/fastify/csrf-protection/security)
* [Insights](/fastify/csrf-protection/pulse)

## Commit

[Permalink](/fastify/csrf-protection/commit/be3e5761f37aa05c7c1ac8ed44499c51ecec8058)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-qrgf-9gpc-vrxw](https://github.com/advisories/GHSA-qrgf-9gpc-vrxw "GHSA-qrgf-9gpc-vrxw")

[Browse files](/fastify/csrf-protection/tree/be3e5761f37aa05c7c1ac8ed44499c51ecec8058)
Browse the repository at this point in the history

```
* fix: enforce hmac key

* fix: check only if fastify/cookie is enabled

* fix: restored working testts

* fix: update README.md

Co-authored-by: Uzlopak <aras.abbasi@googlemail.com>

* Update index.d.ts

* Update index.test-d.ts

* Update index.d.ts

* Update index.test-d.ts

* fix unit tests

---------

Co-authored-by: Uzlopak <aras.abbasi@googlemail.com>
```

* Loading branch information

[![@marco-ippolito](https://avatars.githubusercontent.com/u/36735501?s=40&v=4)](/marco-ippolito) [![@Uzlopak](https://avatars.githubusercontent.com/u/5059100?s=40&v=4)](/Uzlopak)

[marco-ippolito](/fastify/csrf-protection/commits?author=marco-ippolito "View all commits by marco-ippolito")
and
[Uzlopak](/fastify/csrf-protection/commits?author=Uzlopak "View all commits by Uzlopak")
authored
Apr 20, 2023

1 parent
[f60148c](/fastify/csrf-protection/commit/f60148c948e974c9459599d15c25c9e942db964b)

commit be3e576

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**136 additions**
and
**8 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* README.md
  [README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5)
* index.js
  [index.js](#diff-e727e4bdf3657fd1d798edcd6b099d6e092f8573cba266154583a746bba0f346)
* test

  + test/user-info.test.js
    [user-info.test.js](#diff-991e8b4ab8fe877b29b91b6c4a8e8ef8d8b49351aa543584eef03b97dfd837b0)
* types

  + types/index.d.ts
    [index.d.ts](#diff-093ad82a25aee498b11febf1cdcb6546e4d223ffcb49ed69cc275ac27ce0ccce)
  + types/index.test-d.ts
    [index.test-d.ts](#diff-72016aeffe80c3b259bbbf7e92a664cd2bcf49c2b79597740b4dcd8e430107bd)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5 "README.md")

Show comments

[View file](/fastify/csrf-protection/blob/be3e5761f37aa05c7c1ac8ed44499c51ecec8058/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -161,6 +161,7 @@ You can also pass the [cookie serialization](https://github.com/fastify/fastify- |
|  |  | The option `userInfo` is required if `getUserInfo` has been specified in the module option. |
|  |  | The provided `userInfo` is hashed inside the csrf token and it is not directly exposed. |
|  |  | This option is needed to protect against cookie tossing. |
|  |  | The option `csrfOpts.hmacKey` is required if `getUserInfo` has been specified in the module option in combination with using [@fastify/cookie](https://github.com/fastify/fastify-cookie) as sessionPlugin |
|  |  |  |
|  |  | ### `fastify.csrfProtection(request, reply, next)` |
|  |  |  |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[index.js](#diff-e727e4bdf3657fd1d798edcd6b099d6e092f8573cba266154583a746bba0f346 "index.js")

Show comments

[View file](/fastify/csrf-protection/blob/be3e5761f37aa05c7c1ac8ed44499c51ecec8058/index.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -42,6 +42,11 @@ async function fastifyCsrfProtection (fastify, opts) { |
|  |  | if (opts.getUserInfo) { |
|  |  | csrfOpts.userInfo = true |
|  |  | } |
|  |  |  |
|  |  | if (sessionPlugin === '@fastify/cookie' && csrfOpts.userInfo) { |
|  |  | assert(csrfOpts.hmacKey, 'csrfOpts.hmacKey is required') |
|  |  | } |
|  |  |  |
|  |  | const tokens = new CSRF(csrfOpts) |
|  |  |  |
|  |  | const isCookieSigned = cookieOpts && cookieOpts.signed |
| Expand Down | |  |

88 changes: 88 additions & 0 deletions

88
[test/user-info.test.js](#diff-991e8b4ab8fe877b29b91b6c4a8e8ef8d8b49351aa543584eef03b97dfd837b0 "test/user-info.test.js")

Show comments

[View file](/fastify/csrf-protection/blob/be3e5761f37aa05c7c1ac8ed44499c51ecec8058/test/user-info.test.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,6 +17,9 @@ test('Cookies with User-Info', async t => { |
|  |  | await fastify.register(fastifyCsrf, { |
|  |  | getUserInfo (req) { |
|  |  | return userInfoDB[req.body.username] |
|  |  | }, |
|  |  | csrfOpts: { |
|  |  | hmacKey: 'foo' |
|  |  | } |
|  |  | }) |
|  |  |  |
| Expand Down  Expand Up | | @@ -73,6 +76,9 @@ test('Session with User-Info', async t => { |
|  |  | sessionPlugin: '@fastify/session', |
|  |  | getUserInfo (req) { |
|  |  | return req.session.username |
|  |  | }, |
|  |  | csrfOpts: { |
|  |  | hmacKey: 'foo' |
|  |  | } |
|  |  | }) |
|  |  |  |
| Expand Down  Expand Up | | @@ -122,6 +128,9 @@ test('SecureSession with User-Info', async t => { |
|  |  | sessionPlugin: '@fastify/secure-session', |
|  |  | getUserInfo (req) { |
|  |  | return req.session.get('username') |
|  |  | }, |
|  |  | csrfOpts: { |
|  |  | hmacKey: 'foo' |
|  |  | } |
|  |  | }) |
|  |  |  |
| Expand Down  Expand Up | | @@ -163,3 +172,82 @@ test('SecureSession with User-Info', async t => { |
|  |  |  |
|  |  | t.equal(response2.statusCode, 200) |
|  |  | }) |
|  |  |  |
|  |  | test('Validate presence of hmac key with User-Info /1', async (t) => { |
|  |  | const fastify = Fastify() |
|  |  | await fastify.register(fastifyCookie) |
|  |  |  |
|  |  | await t.rejects(fastify.register(fastifyCsrf, { |
|  |  | getUserInfo (req) { |
|  |  | return req.session.get('username') |
|  |  | } |
|  |  | }), Error('csrfOpts.hmacKey is required')) |
|  |  | }) |
|  |  |  |
|  |  | test('Validate presence of hmac key with User-Info /2', async (t) => { |
|  |  | const fastify = Fastify() |
|  |  | await fastify.register(fastifyCookie) |
|  |  |  |
|  |  | await t.rejects(fastify.register(fastifyCsrf, { |
|  |  | getUserInfo (req) { |
|  |  | return req.session.get('username') |
|  |  | }, |
|  |  | sessionPlugin: '@fastify/cookie' |
|  |  | }), Error('csrfOpts.hmacKey is required')) |
|  |  | }) |
|  |  |  |
|  |  | test('Validate presence of hmac key with User-Info /3', async (t) => { |
|  |  | const fastify = Fastify() |
|  |  | await fastify.register(fastifyCookie) |
|  |  |  |
|  |  | await t.rejects(fastify.register(fastifyCsrf, { |
|  |  | getUserInfo (req) { |
|  |  | return req.session.get('username') |
|  |  | }, |
|  |  | csrfOpts: { |
|  |  | hmacKey: undefined |
|  |  | } |
|  |  | }), Error('csrfOpts.hmacKey is required')) |
|  |  | }) |
|  |  |  |
|  |  | test('Validate presence of hmac key with User-Info /4', async (t) => { |
|  |  | const fastify = Fastify() |
|  |  | await fastify.register(fastifyCookie) |
|  |  |  |
|  |  | await t.rejects(fastify.register(fastifyCsrf, { |
|  |  | getUserInfo (req) { |
|  |  | return req.session.get('username') |
|  |  | }, |
|  |  | sessionPlugin: '@fastify/cookie', |
|  |  | csrfOpts: { |
|  |  | hmacKey: undefined |
|  |  | } |
|  |  | }), Error('csrfOpts.hmacKey is required')) |
|  |  | }) |
|  |  |  |
|  |  | test('Validate presence of hmac key with User-Info /5', async (t) => { |
|  |  | const fastify = Fastify() |
|  |  | await fastify.register(fastifySecureSession, { key, cookie: { path: '/', secure: false } }) |
|  |  |  |
|  |  | await t.resolves(fastify.register(fastifyCsrf, { |
|  |  | getUserInfo (req) { |
|  |  | return req.session.get('username') |
|  |  | }, |
|  |  | sessionPlugin: '@fastify/secure-session' |
|  |  | })) |
|  |  | }) |
|  |  |  |
|  |  | test('Validate presence of hmac key with User-Info /6', async (t) => { |
|  |  | const fastify = Fastify() |
|  |  | await fastify.register(fastifySecureSession, { key, cookie: { path: '/', secure: false } }) |
|  |  |  |
|  |  | await t.resolves(fastify.register(fastifyCsrf, { |
|  |  | getUserInfo (req) { |
|  |  | return req.session.get('username') |
|  |  | }, |
|  |  | sessionPlugin: '@fastify/secure-session', |
|  |  | csrfOpts: { |
|  |  | hmacKey: 'foo' |
|  |  | } |
|  |  | })) |
|  |  | }) |

27 changes: 23 additions & 4 deletions

27
[types/index.d.ts](#diff-093ad82a25aee498b11febf1cdcb6546e4d223ffcb49ed69cc275ac27ce0ccce "types/index.d.ts")

Show comments

[View file](/fastify/csrf-protection/blob/be3e5761f37aa05c7c1ac8ed44499c51ecec8058/types/index.d.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,17 +26,36 @@ declare namespace fastifyCsrfProtection { |
|  |  | export type CookieSerializeOptions = FastifyCookieSerializeOptions |
|  |  |  |
|  |  | export type GetTokenFn = (req: FastifyRequest) => string | void; |
|  |  |  |
|  |  | export interface FastifyCsrfProtectionOptions { |
|  |  | csrfOpts?: CSRFOptions; |
|  |  |  |
|  |  | interface FastifyCsrfProtectionOptionsBase { |
|  |  | cookieKey?: string; |
|  |  | cookieOpts?: CookieSerializeOptions; |
|  |  | sessionKey?: string; |
|  |  | getUserInfo?: (req: FastifyRequest) => string; |
|  |  | getToken?: GetTokenFn; |
|  |  | sessionPlugin?: '@fastify/cookie' | '@fastify/session' | '@fastify/secure-session'; |
|  |  | } |
|  |  |  |
|  |  | interface FastifyCsrfProtectionOptionsFastifyCookie { |
|  |  | sessionPlugin?: '@fastify/cookie'; |
|  |  | csrfOpts: Omit<CSRFOptions, 'hmacKey'> & Required<Pick<CSRFOptions, 'hmacKey'>>; |
|  |  | } |
|  |  |  |
|  |  | interface FastifyCsrfProtectionOptionsFastifySession { |
|  |  | sessionPlugin: '@fastify/session'; |
|  |  | csrfOpts?: CSRFOptions; |
|  |  | } |
|  |  |  |
|  |  | interface FastifyCsrfProtectionOptionsFastifySecureSession { |
|  |  | sessionPlugin: '@fastify/secure-session'; |
|  |  | csrfOpts?: CSRFOptions; |
|  |  | } |
|  |  |  |
|  |  | export type FastifyCsrfProtectionOptions = FastifyCsrfProtectionOptionsBase & ( |
|  |  | FastifyCsrfProtectionOptionsFastifyCookie | |
|  |  | FastifyCsrfProtectionOptionsFastifySession | |
|  |  | FastifyCsrfProtectionOptionsFastifySecureSession |
|  |  | ) |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @deprecated Use FastifyCsrfProtectionOptions instead |
|  |  | \*/ |
| Expand Down | |  |

23 changes: 19 additions & 4 deletions

23
[types/index.test-d.ts](#diff-72016aeffe80c3b259bbbf7e92a664cd2bcf49c2b79597740b4dcd8e430107bd "types/index.test-d.ts")

Show comments

[View file](/fastify/csrf-protection/blob/be3e5761f37aa05c7c1ac8ed44499c51ecec8058/types/index.test-d.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,13 +31,28 @@ async function run() { |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | fastify.register(FastifyCsrfProtection, { csrfOpts: { algorithm: 'sha1' } }) |
|  |  | fastify.register(FastifyCsrfProtection, { csrfOpts: { algorithm: 'sha1', hmacKey: 'hmac' } }) |
|  |  | expectError(fastify.register(FastifyCsrfProtection, { csrfOpts: { algorithm: 1 } })) |
|  |  |  |
|  |  | fastify.register(FastifySession) |
|  |  | fastify.register(FastifyCsrfProtection, { getUserInfo(req) { |
|  |  | return req.session.get('username') |
|  |  | }}) |
|  |  | fastify.register(FastifyCsrfProtection, { |
|  |  | csrfOpts: { |
|  |  | hmacKey: '123' |
|  |  | }, |
|  |  | getUserInfo(req) { |
|  |  | return req.session.get('username') |
|  |  | } |
|  |  | }) |
|  |  | expectError(fastify.register(FastifyCsrfProtection, { getUserInfo: 'invalid' })) |
|  |  |  |
|  |  | fastify.register(FastifyCsrfProtection, { csrfOpts: { hmacKey: 'hmac' }, sessionPlugin: '@fastify/cookie' }) |
|  |  | fastify.register(FastifyCsrfProtection, { csrfOpts: { hmacKey: 'hmac' } }) |
|  |  | expectError(fastify.register(FastifyCsrfProtection, { })) |
|  |  | expectError(fastify.register(FastifyCsrfProtection, { csrfOpts: { }})) |
|  |  | expectError(fastify.register(FastifyCsrfProtection, { sessionPlugin: '@fastify/cookie', csrfOpts: { }})) |
|  |  | fastify.register(FastifyCsrfProtection, { csrfOpts: { }, sessionPlugin: '@fastify/session' }) |
|  |  | fastify.register(FastifyCsrfProtection, { csrfOpts: { }, sessionPlugin: '@fastify/secure-session' }) |
|  |  | fastify.register(FastifyCsrfProtection, { sessionPlugin: '@fastify/session' }) |
|  |  | fastify.register(FastifyCsrfProtection, { sessionPlugin: '@fastify/secure-session' }) |
|  |  |  |
|  |  | expectDeprecated({} as FastifyCsrfOptions) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `be3e576`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ffastify%2Fcsrf-protection%2Fcommit%2Fbe3e5761f37aa05c7c1ac8ed44499c51ecec8058) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


