=== Content from blog.ircmaxell.com_edb2cae0_20250114_195007.html ===

[ircmaxell's Blog](/)

* [Home](/)
* [GitHub](https://github.com/ircmaxell)
* [Resume](https://github.com/ircmaxell/resume)

Word of Forks

[Home](/)
[GitHub](https://github.com/ircmaxell)
[Resume](https://github.com/ircmaxell/resume)

## [Security Issue: Combining Bcrypt With Other Hash Functions](/2015/03/security-issue-combining-bcrypt-with.html)

Mar 12, 2015

[Security](/categories/Security/)

Table Of Contents

1. [1. crypt.c](#crypt-c)
2. [2. The Major Problem](#The-Major-Problem)
3. [3. Detecting Problematic Hashes](#Detecting-Problematic-Hashes)
4. [4. But I use CRYPT\_SHA256!](#But-I-use-CRYPT-SHA256)
5. [5. The Fix](#The-Fix)
6. [6. The Underlying Problem](#The-Underlying-Problem)

The other day, I was directed at an interesting [question on StackOverflow](http://stackoverflow.com/q/28951359/338665) asking if `password_verify()` was safe against DoS attacks using extremely long passwords. Many hashing algorithms depend on the amount of data fed into them, which affects their runtime. This can lead to a DoS attack where an attacker can provide an exceedingly long password and tie up computer resources. Itâs a really good question to ask of Bcrypt (and `password_hash`). As you may know, Bcrypt is limited to 72 character passwords. So on the surface it looks like it shouldnât be vulnerable. But I chose to dig in further to be sure. What I found surprised me.

## crypt.c

To start off, I looked at PHPâs implementation of [`crypt()`](http://lxr.php.net/xref/PHP_TRUNK/ext/standard/crypt.c#154). The function weâre interested in is called `php_crypt()`, and has the following signature:

```
PHPAPI zend_string *php_crypt(const char *password, const int pass_len, const char *salt, int salt_len)

```

Now, check out the branch that does bcrypt:

```
} else if (
        salt[0] == '$' &&
        salt[1] == '2' &&
        salt[3] == '$') {
    char output[PHP_MAX_SALT_LEN + 1];

    memset(output, 0, PHP_MAX_SALT_LEN + 1);

    crypt_res = php_crypt_blowfish_rn(password, salt, output, sizeof(output));
    if (!crypt_res) {
        ZEND_SECURE_ZERO(output, PHP_MAX_SALT_LEN + 1);
        return NULL;
    } else {
        result = zend_string_init(output, strlen(output), 0);
        ZEND_SECURE_ZERO(output, PHP_MAX_SALT_LEN + 1);
        return result;
    }
}

```

Notice anything? The `password` variable is a `char\*`. So `php_crypt_blowfish_rn()` doesnât know the length of the input password. Interesting. So I wonder how it knows the length? Well, at this point I have an idea, but Iâm also scared by itâ¦

So digging through `php_crypt_blowfish_rn()`, I notice that the only place the passsword (now called `key`) is sent is the function [`BF_set_key()`](http://lxr.php.net/xref/PHP_TRUNK/ext/standard/crypt_blowfish.c#BF_set_key). Thereâs a bunch of comments about sign safety and mode switches, but the bulk of it boils down to this pair of nested loops (comments stripped out):

```
const char *ptr = key;
/* ...snip... */
for (i = 0; i < BF_N + 2; i++) {
    tmp[0] = tmp[1] = 0;
    for (j = 0; j < 4; j++) {
        tmp[0] <<= 8;
        tmp[0] |= (unsigned char)*ptr; /* correct */
        tmp[1] <<= 8;
        tmp[1] |= (BF_word_signed)(signed char)*ptr; /* bug */
        if (j)
            sign |= tmp[1] & 0x80;
        if (!*ptr)
            ptr = key;
        else
            ptr++;
    }
    diff |= tmp[0] ^ tmp[1]; /* Non-zero on any differences */

    expanded[i] = tmp[bug];
    initial[i] = BF_init_state.P[i] ^ tmp[bug];
}

```

If youâre not familiar with C, `\*` dereferences a pointer (returns the value it points to). So if we define `char \*abc = "abc"`, then `\*abc` would be `'a'` (well, technically, the numeric value of the codepoint of `'a'`). So then you can increment the pointer `abc++` and then `\*abc` would equal `'b`â. This is the standard way that âstringsâ work in C.

The loops basically iterate 72 times (`BF_N` is 16) and âeatsâ one byte of the string each iteration.

The key point here is the following line of code:

```
if (!*ptr)
    ptr = key;
else
    ptr++;

```

Basically, if `\*ptr` is ever `0`, then reset it to the start of the string. This is how strings shorter than 72 characters are represented (since a âc-stringâ always ends with a null byte).

Think about that for a second. That means that `"test\0abc"` would be treated as `"test\0test\0test\0test\0test\0test\0test\0test\0test\0test\0test\0test\0test\0test\0te"`. In fact, every string that starts with `"test\0"` will be treated the same.

Basically, it ignores everything after the first null byte.

See the problem?

Nobody really uses null bytes in passwords anyway. So this isnât a problem. Right?

No, in fact, this is by-design. And itâs not an issue because nobody uses passwords with null bytes.

So if you use `password_hash()` or `crypt()` directly, youâre 100% safe.

But what if youâre not using them directly? What if youâre âpre-hashingâ? Well, then you have a MAJOR problemâ¦

## The Major Problem

Some people think bcrypt isnât enough, and instead choose to âpre-hashâ passwords. This allows users to use passwords longer than 72 characters. Something like:

```
password_hash(hash('sha256', $password, true), PASSWORD_DEFAULT)

```

Additionally, some people want to use a âpepperâ, so they pre-hash using a HMAC with a private key:

```
password_hash(hash_hmac('sha256', $password, $key, true), PASSWORD_DEFAULT)

```

The problem here is the last argument to the two hash functions: `true`. They force raw output. This is normally how cryptographic functions are combined (using raw output rather than encoded output). And given that you can lose entropy from a sha512 by truncating it from 128 characters to 72, using raw output preserves some entropy.

But this means that the output can contain null bytes. In fact, it means that on average 1 out of every 256 passwords (or `0.39%`) will have a leading null byte. So we only need to try approximately 177 passwords to get a 50% chance of finding a hash with a leading null byte. And we only need to try approximately 177 users to get a 50% chance of finding a user with a leading null byte. So trying 31329 permutations of users and passwords gives us a 25% chance of finding one that will work. Thatâs in the realm of possibility for online attacks (via distributed means).

This is **bad**. This is **really bad**.

Letâs show an example of how we can find these collisions:

```
$key = "algjhsdiouahwergoiuawhgiouaehnrgzdfgb23523";
$hash_function = "sha256";
$i = 0;
$found = [];

while (count($found) < 2) {
    $pw = base64_encode(str_repeat($i, 5));
    $hash = hash_hmac($hash_function, $pw, $key, true);
    if ($hash[0] === "\0") {
        $found[] = $pw;
    }
    $i++;
}

var_dump($i, $found);

```

I picked a random key. Then I made a ârandomâ looking password (encoding the iteration count). Then I let it run. This is a stupid simple generator to generate these collisions (not even efficient). When I ran it, I got the following output:

```
int(523)
array(2) {
  [0]=>
  string(16) "MzEzMTMxMzEzMQ=="
  [1]=>
  string(20) "NTIyNTIyNTIyNTIyNTIy"
}

```

Which means for that key, we found 2 colliding passwords in 523 attempts. The attempt number will change with different keys.

So letâs try that out:

```
$hash = password_hash(hash_hmac("sha256", $found[0], $key, true), PASSWORD_BCRYPT);

var_dump(password_verify(hash_hmac("sha256", $found[1], $key, true), $hash));

```

And we get:

```
bool(true)

```

Amazing. Different passwords validate to the same hash.

## Detecting Problematic Hashes

Offline, thereâs a simple check to see if a given hash was created with a leading null byte:

```
password_verify("\0", $hash)

```

Testing our hash from above:

> $2y$10$2ECy/U3F/NSvAjMcuBeI6uMDmJlI8t8ux0pXOAoajpv2hSH0veOMi

Gives us `bool(true)`. Which tells us it was created with a null byte as the first character.

So in an offline mode, itâs trivial to detect these hashes.

But even if none of the hashes were created with leading null bytes, it doesnât mean youâre safe (assuming you are using raw hashes). The reason is the same thing happens if the 2nd character was null:

```
a\0bc
a\0cd
a\0ef

```

Will all collide as well. So you have a `0.39%` chance of colliding at the second character for each given first character. So of all the hashes that start with `a`, a given hash has a `0.39%` chance of having a null byte as the second character. Meaning that thereâs significantly less work to find this collision than to find a full-hash collision.

The problem goes all the way down the line.

## But I use CRYPT\_SHA256!

Well, looking at [`php_crypt()`](http://lxr.php.net/xref/PHP_TRUNK/ext/standard/crypt.c#154), we can see that all of the `crypt()` options exibt this behavior. Itâs not really centralized around bcrypt (nor is it centralized around PHP, the `crypt(3)` c library itself has this same issue).

I talked about bcrypt in this post mainly because thatâs what `password_hash()` uses, and itâs the current recommended algorithm in PHP.

Note that if you use `hash_pbkdf2()`, itâs not susceptible to this issue. And if you use [scrypt](https://github.com/DomBlack/php-scrypt) youâre fine as well.

## The Fix

The problem here isnât with bcrypt itself. Itâs with the combination of bcrypt and other crypto in an unsafe manner. It turns out that not all combinations are unsafe. In fact, [Mozillaâs system](https://blog.mozilla.org/webdev/2012/06/08/lets-talk-about-password-storage/), which is basically `password_hash(base64_encode(hash_hmac("sha512", $password, $key, true)), PASSWORD_BCRYPT)`, is safe because it base64 encodes the raw salt. Additionally, youâre safe if you use hex output of the hash/hmac (the final parameter `false`, which is the default).

You are 100% safe if you do one of the following:

* Use straight `bcrypt` (donât pre-hash)
* Use hex output from the pre-hash
* Base64 encode the raw output of a pre-hash

If you are using raw output, encode it first, and youâre safe.

## The Underlying Problem

The underlying problem is that combining cryptographic operators that werenât designed to be combined can be disastrous. Is it possible to do so safely? Yes. Is it a good idea to do it? No. This particular case is just one example where combining operations can be exceedingly dangerous.

Instead, just use algorithms as they were designed to be used. If you want additional protection beyond bcrypt, encrypt the output: `encrypt(password_hash(...), $key)`. Itâs using algorithms as they were designed to be used.

But the bottom line: **never** roll your own crypto. It can have fatal consequences.

[PHP](/tags/PHP/)
[Best Practice](/tags/Best-Practice/)
[Security](/tags/Security/)
[Password-Hashing](/tags/Password-Hashing/)
[Cryptography](/tags/Cryptography/)
[BCrypt](/tags/BCrypt/)

prevï¼[Dimensional Analysis](/2015/03/dimensional-analysis.html "Dimensional Analysis")
nextï¼[Scalar Types and PHP](/2015/02/scalar-types-and-php.html "Scalar Types and PHP")

![](/images/anthony_avatar.jpg)
Anthony Ferrara
Technologist, leader and purveyor of rants. All opinions my own.

Emailblog@ircmaxell.com
Resume[On GitHub](https://www.github.com/ircmaxell/resume)
GitHub[ircmaxell](https://www.github.com/ircmaxell)
Twitter[@ircmaxell](https://www.twitter.com/ircmaxell)
YouTube[ircmaxell](https://www.youtube.com/user/ircmaxell)
LinkedIn[ircmaxell](https://www.linkedin.com/in/ircmaxell)

If you're using an adblocker, please consider supporting this site via [Patreon](https://www.patreon.com/ircmaxell) or [PayPal](https://paypal.me/ircmaxell)

If you're using an adblocker, please consider supporting this site via [Patreon](https://www.patreon.com/ircmaxell) or [PayPal](https://paypal.me/ircmaxell)

Categories

* [Architecture14](/categories/Architecture/)
* [Community1](/categories/Community/)
* [Hobby2](/categories/Hobby/)
* [Home Networking1](/categories/Home-Networking/)
* [Meta20](/categories/Meta/)
* [Open Source5](/categories/Open-Source/)
* [Other3](/categories/Other/)
* [PHP13](/categories/PHP/)
* [Performance1](/categories/Performance/)
* [Process1](/categories/Process/)
* [Programming23](/categories/Programming/)
* [Rant14](/categories/Rant/)
* [Security25](/categories/Security/)
* [Slides15](/categories/Slides/)
* [Testing2](/categories/Testing/)
* [Video12](/categories/Video/)

Tags
[8-bit Computer](/tags/8-bit-Computer/) [API](/tags/API/) [Agile](/tags/Agile/) [Analysis](/tags/Analysis/) [Anatomy of an Attack](/tags/Anatomy-of-an-Attack/) [Answers](/tags/Answers/) [Anti-Paradigm](/tags/Anti-Paradigm/) [Anti-Pattern](/tags/Anti-Pattern/) [Architecture](/tags/Architecture/) [Arduino](/tags/Arduino/) [Autoloading](/tags/Autoloading/) [BCrypt](/tags/BCrypt/) [Best Practice](/tags/Best-Practice/) [Beyond](/tags/Beyond/) [Books](/tags/Books/) [Build](/tags/Build/) [CSRF](/tags/CSRF/) [Career](/tags/Career/) [Change](/tags/Change/) [Closures](/tags/Closures/) [Code Review](/tags/Code-Review/) [Comments](/tags/Comments/) [Community](/tags/Community/) [Compiler](/tags/Compiler/) [Composition](/tags/Composition/) [Computer](/tags/Computer/) [Conference](/tags/Conference/) [CryptLib](/tags/CryptLib/) [Cryptography](/tags/Cryptography/) [Data Structures](/tags/Data-Structures/) [Database](/tags/Database/) [Dependency Injection](/tags/Dependency-Injection/) [Design](/tags/Design/) [Design Patterns](/tags/Design-Patterns/) [Disclosure](/tags/Disclosure/) [Drupal](/tags/Drupal/) [Economics](/tags/Economics/) [Education](/tags/Education/) [Email Response](/tags/Email-Response/) [Engineering](/tags/Engineering/) [Events](/tags/Events/) [Exceptions](/tags/Exceptions/) [External-Post](/tags/External-Post/) [Forward Compatibility](/tags/Forward-Compatibility/) [Framework](/tags/Framework/) [Functional Programming](/tags/Functional-Programming/) [Generators](/tags/Generators/) [Global Variables](/tags/Global-Variables/) [Good Enough](/tags/Good-Enough/) [Google Glass](/tags/Google-Glass/) [HHVM](/tags/HHVM/) [Hardware](/tags/Hardware/) [Hobby](/tags/Hobby/) [Home](/tags/Home/) [IT](/tags/IT/) [Inconsistencies](/tags/Inconsistencies/) [Internet](/tags/Internet/) [Interviews](/tags/Interviews/) [Iterators](/tags/Iterators/) [Javascript](/tags/Javascript/) [Jenkins](/tags/Jenkins/) [JitFu](/tags/JitFu/) [Language Agnostic](/tags/Language-Agnostic/) [Language-Design](/tags/Language-Design/) [Large Scale Applications](/tags/Large-Scale-Applications/) [Learning](/tags/Learning/) [Lexer](/tags/Lexer/) [Library](/tags/Library/) [Logic](/tags/Logic/) [Logic Gates](/tags/Logic-Gates/) [MVC](/tags/MVC/) [Mathematics](/tags/Mathematics/) [Meta](/tags/Meta/) [Micro Framework](/tags/Micro-Framework/) [Middleware](/tags/Middleware/) [Monads](/tags/Monads/) [Networking](/tags/Networking/) [Object Oriented Programming](/tags/Object-Oriented-Programming/) [Open Source](/tags/Open-Source/) [Open Standards](/tags/Open-Standards/) [Optimization](/tags/Optimization/) [PHP](/tags/PHP/) [PHP Source Code For PHP Developers Series](/tags/PHP-Source-Code-For-PHP-Developers-Series/) [PHP-FIG](/tags/PHP-FIG/) [PHP-Internals](/tags/PHP-Internals/) [PHP-Versions](/tags/PHP-Versions/) [Parser](/tags/Parser/) [Passion](/tags/Passion/) [Password-Hashing](/tags/Password-Hashing/) [PasswordLib](/tags/PasswordLib/) [Performance](/tags/Performance/) [Philosophy](/tags/Philosophy/) [Presentation](/tags/Presentation/) [Procedural Programming](/tags/Procedural-Programming/) [Programming](/tags/Programming/) [Programming With Anthony](/tags/Programming-With-Anthony/) [Promise](/tags/Promise/) [Radix Tree](/tags/Radix-Tree/) [Rainbow Table](/tags/Rainbow-Table/) [Random](/tags/Random/) [Rant](/tags/Rant/) [Recki-CT](/tags/Recki-CT/) [Response](/tags/Response/) [Responsive Design](/tags/Responsive-Design/) [Review](/tags/Review/) [Routing](/tags/Routing/) [Ruby](/tags/Ruby/) [Ruby-On-Rails](/tags/Ruby-On-Rails/) [SQL Injection](/tags/SQL-Injection/) [Scalar](/tags/Scalar/) [Scrum](/tags/Scrum/) [Security](/tags/Security/) [Sexism](/tags/Sexism/) [Silly](/tags/Silly/) [Slides](/tags/Slides/) [StackOverflow](/tags/StackOverflow/) [Templates](/tags/Templates/) [Thoughts](/tags/Thoughts/) [Timing-Attack](/tags/Timing-Attack/) [Traits](/tags/Traits/) [Trie](/tags/Trie/) [Trolls](/tags/Trolls/) [Trust](/tags/Trust/) [Types](/tags/Types/) [Unit Testing](/tags/Unit-Testing/) [Video](/tags/Video/) [WTF](/tags/WTF/) [Web Application Security Series](/tags/Web-Application-Security-Series/) [Web Design](/tags/Web-Design/) [Weird Behavior](/tags/Weird-Behavior/) [Wiring](/tags/Wiring/) [WordPress](/tags/WordPress/) [Work](/tags/Work/) [XSS](/tags/XSS/) [Year In Review](/tags/Year-In-Review/) [libgccjit](/tags/libgccjit/) [libjit](/tags/libjit/) [llvm](/tags/llvm/)

Copyright Â©2011-2023 Anthony Ferrara, all rights reserved.



=== Content from www.scottbrady91.com_ef628bb3_20250114_195025.html ===

[![Scott Brady](https://www.scottbrady.io/cdn-cgi/image/f=auto,sharpen=0.5,w=32/img/scott_brady1901-square.jpeg)

Scott Brady](/)

* [Home](/)
* [Articles](/articles)
* [Tools](/tools)
* [Consultancy](/consultancy)
* [Speaking](/speaking)
* [About](/about)

[Subscribe](/newsletter)
Open main menu

* [Home](/)
* [Articles](/articles)
* [Tools](/tools)
* [Consultancy](/consultancy)
* [Speaking](/speaking)
* [About](/about)

![Scott Brady](https://www.scottbrady.io/cdn-cgi/image/f=auto,sharpen=0.5,w=300/img/general/2021/william.jpg)
## Scott Brady

I help developers learn OAuth and web security.

Director of Engineering at [ClearBank](https://clear.bank/ "ClearBank"),
[Pluralsight Author](https://app.pluralsight.com/profile/author/scott-brady "Scott Brady - Pluralsight"), &
[Speaker](/speaking "Speaking Engagements").

[Sign up to my newsletter](/newsletter "Subscribe to the newsletter")

[Request consultancy](/consultancy "Request consultancy")

# Beware of Password Shucking

[![Scott Brady](https://www.scottbrady.io/cdn-cgi/image/f=auto,sharpen=0.5,w=56/img/scott_brady1901-square.jpeg)](/about)
[Scott Brady](/about)
13 April 2021
・
[Authentication](/authentication)

Password shucking is a method of stripping layers off an updated password hash, removing the benefits of its new password hashing algorithm and reverting it to its weaker algorithm.
Password shucking can be used by an attacker against old rehashed passwords or pre-hash passwords, enabling them to strip away or “shuck” off the strong outer password hashing algorithm.

In this article, I’m going to walk through the theory of password shucking.
I initially struggled with understanding password shucking, so this is my take in explaining it.
If you prefer a different style, I recommend checking out the DEFCON talk from [Sam Croley](https://twitter.com/Chick3nman512) (aka Chick3nman), which is embedded at the end of this article.

## Combining password hashing algorithms: pre-hashing and rehashing

First, let’s take a look at why you might pre-hash or rehash a password.

### Rehashing passwords

When migrating password hashing algorithms, a common technique is to rehash all your existing password hashes using your new password hashing algorithm.
This gives your users the protection of the new password hashing algorithm, without the need to reset everybody’s password or wait for them to re-authenticate, like with a rolling migration.

Rehashing old PBKDF2 hashes with Argon2id would mean that your password hashing algorithm would become the following:

```
argon2(pbkdf2($password, $legacySalt))
```

This means that you have multiple layers to your password hashing algorithms: an outer layer of Argon2id (your new algorithm) and an inner layer of the weaker PBKDF2 (your old algorithm).

### Pre-hashing passwords

Pre-hashing is a technique used in some bcrypt implementations to bypass bcrypt’s [max input limit](https://security.stackexchange.com/q/39849/96261) of 72-bytes.
This involves pre-hashing the plaintext password with something like SHA-384 before you pass it to bcrypt, ensuring that all passwords fall under the 72-byte limit.

```
bcrypt(sha384($password))
```

This means that you have multiple layers to your password hashing algorithms: an outer layer of bcrypt (your password hashing algorithm) and an inner layer of the SHA-384 (your pre-hashing algorithm).

The idea behind bcrypt pre-hashing is that you can allow users to take advantage of very long passwords, rather than setting a max-size limit or truncating their password.
In some bcrypt developer libraries, you’ll see pre-hashing listed as “Enhanced Entropy”.

## The danger of password shucking

The problem with pre-hashing and rehashing is that **if your inner hash does not use a salt and uses a fast hashing algorithm** (e.g. MD5, SHA-1, SHA-256, etc.), **then you are now vulnerable to a technique called password shucking**.

Let’s say you are in the unfortunate position of having old, unsalted, SHA-1 password hashes, and you want to move to bcrypt.
You rehash your existing hashes and now have a password hashing algorithm of:

```
bcrypt(sha1($password))
```

Great, you’ve now protected those old passwords, and you’ve got some breathing room in the event of a breach.

However, using password shucking, an attacker can effectively strip (shuck) the use of bcrypt.

### Password shucking

To shuck a password, the attacker relies upon two things:

1. The target user appears in existing breaches that used your old password hashing algorithm
2. The target user has re-used passwords across websites.

Using our example of bcrypt and SHA-1, the attacker will search old database breaches that contain unsalted, SHA-1 password hashes, looking for their target user.

With some SHA-1 hashes in hand, they can run that hash directly against the bcrypt hash:

```
bcrypt($breachedHash)
```

If one of these hashes validate against the bcrypt hash, then the attacker no longer has to be concerned with bcrypt.
They know the inner SHA-1 hash, so now they only need to crack that, which will be significantly faster than cracking a bcrypt hash.
They have effectively stripped the outer layer (bcrypt).
This is password shucking.

In his 2020 DEFCON talk, Sam Croley uses the example of bcrypt and MD5.
Attacking the bcrypt layer directly with hashcat would only allow you around 2,000 guesses per second.
Attacking the known MD5 hash, discovered using password shucking, would enable you 64,000,000,000 guesses per second.

The attacker even has the option to skip cracking the password themselves, as it may be a hash with a known plaintext (it is unsalted after all).

## Should you pre-hash passwords or rehash?

**Password shucking shouldn’t stop you from rehashing when migrating from an old password hashing algorithm**.
If you are using something like MD5 or SHA-256 (salted or not), you need to migrate to something better, and the threat of password shucking should not stop you.

Don’t forget that password shucking requires a user to re-use a password across websites (unfortunately, this is highly likely) and for an attacker to target individual users.
As a herd immunity, I think rehashing alone will still help.

As with any rehashing approach, **you should still only support the old or rehashed password hashes for a short amount of time**.
As each user successfully authenticates into your system, update their password hash to the new algorithm without the inner, legacy hash.
Support rehashing for a limited amount of time (let’s say 3 months) and then delete any old style password hashes from your database.
Those users who did not use your system in the rehashing window will instead have to reset their password.

To further improve things, you could [include a pepper](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#peppering) when you rehash the old password hashes.
Just remember that the pepper must be kept secret, ideally stored away from your database and app in a key vault or HSM.

### Should you pre-hash passwords?

No, not if you are pre-hashing with an unsalted, fast hashing algorithm.
**If you pre-hash, then your password hashing algorithm’s security is drastically reduced due to the risk of password shucking**.

## Recording: What the Shuck? Layered Hash Shucking

If you want to learn more about password shucking, check out Sam Croley’s (aka Chick3nman) original DEFCON talk: “What the Shuck? Layered Hash Shucking”.

A big thank you to [Sam Croley](https://twitter.com/Chick3nman512) for the technical review of this blog post.

![Scott Brady](https://www.scottbrady.io/cdn-cgi/image/f=auto,sharpen=0.5,w=190/img/scott_brady1901.jpeg)

Scott Brady

I help developers learn OAuth and web security.

I’m a director of engineering and software developer specializing in OAuth, FIDO2, web security, and ASP.NET Core.

* [About](/about)
* [Newsletter](/newsletter)
* [Consultancy](/consultancy)
* [Pluralsight Courses](https://app.pluralsight.com/profile/author/scott-brady)

 Content is [licensed under CC BY 4.0](/privacy). Remember, don't copy and paste code written by strangers on the internet.

Please enable JavaScript to view the comments section.

* [LinkedIn](https://www.linkedin.com/in/scottbrady91 "LinkedIn")
* [Mastodon](https://hachyderm.io/%40scottbrady "Mastodon")
* [Twitter](https://twitter.com/intent/user?screen_name=scottbrady91 "Twitter")
* [GitHub](https://github.com/scottbrady91 "GitHub")
* [Newsletter](/newsletter "Newsletter")
* [RSS](/rss.xml "RSS")

© 2015 - 2025 Scott Brady |
[Privacy & Licensing](/privacy)



=== Content from github.com_b204494e_20250114_195021.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fsecurity%2Fadvisories%2FGHSA-c5vj-f36q-p9vg)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fsecurity%2Fadvisories%2FGHSA-c5vj-f36q-p9vg)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=codeigniter4%2Fshield)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[codeigniter4](/codeigniter4)
/
**[shield](/codeigniter4/shield)**
Public

* [Notifications](/login?return_to=%2Fcodeigniter4%2Fshield) You must be signed in to change notification settings
* [Fork
  132](/login?return_to=%2Fcodeigniter4%2Fshield)
* [Star
   372](/login?return_to=%2Fcodeigniter4%2Fshield)

* [Code](/codeigniter4/shield)
* [Issues
  5](/codeigniter4/shield/issues)
* [Pull requests
  12](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects
  0](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

Additional navigation options

* [Code](/codeigniter4/shield)
* [Issues](/codeigniter4/shield/issues)
* [Pull requests](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

# Password Shucking Vulnerability

Moderate

[lonnieezell](/lonnieezell)
published
GHSA-c5vj-f36q-p9vg
Mar 11, 2023

## Package

composer

codeigniter4/shield
([Composer](/advisories?query=ecosystem%3Acomposer))

## Affected versions

< 1.0.0-beta.4

## Patched versions

1.0.0-beta.4

## Description

### Impact

An improper implementation was found in the password storage process.

All hashed passwords stored in Shield v1.0.0-beta.3 or earlier are easier to crack than expected due to the vulnerability. Therefore, they should be removed as soon as possible.

If an attacker gets (1) the user's hashed password by Shield, and (2) the hashed password (SHA-384 hash without salt) from somewhere, the attacker may easily crack the user's password.

### Patches

Upgrade to Shield v1.0.0-beta.4 or later.

After upgrading, all users’ hashed passwords should be updated (saved to the database).

See <https://github.com/codeigniter4/shield/blob/develop/UPGRADING.md> for details.

### Workarounds

None.

### References

* <https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#pre-hashing-passwords>
* <https://blog.ircmaxell.com/2015/03/security-issue-combining-bcrypt-with.html>
* <https://www.scottbrady91.com/authentication/beware-of-password-shucking>

### For more information

If you have any questions or comments about this advisory:

* Open an issue or discussion in [codeigniter4/shield](https://github.com/codeigniter4/shield)
* Email us at security@codeigniter.com

### Severity

Moderate

### CVE ID

CVE-2023-27580

### Weaknesses

[CWE-916](/advisories?query=cwe%3A916)

### Credits

* [![@jreklund](https://avatars.githubusercontent.com/u/3641536?s=40&v=4)](/jreklund)
  [jreklund](/jreklund)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_bd3db7a4_20250114_195010.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fblob%2Fdevelop%2FUPGRADING.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fblob%2Fdevelop%2FUPGRADING.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=codeigniter4%2Fshield)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[codeigniter4](/codeigniter4)
/
**[shield](/codeigniter4/shield)**
Public

* [Notifications](/login?return_to=%2Fcodeigniter4%2Fshield) You must be signed in to change notification settings
* [Fork
  132](/login?return_to=%2Fcodeigniter4%2Fshield)
* [Star
   372](/login?return_to=%2Fcodeigniter4%2Fshield)

* [Code](/codeigniter4/shield)
* [Issues
  5](/codeigniter4/shield/issues)
* [Pull requests
  12](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects
  0](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

Additional navigation options

* [Code](/codeigniter4/shield)
* [Issues](/codeigniter4/shield/issues)
* [Pull requests](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from cheatsheetseries.owasp.org_72b035b9_20250114_195009.html ===


[Skip to content](#password-storage-cheat-sheet)

[![logo](../assets/OWASP_Logo.svg)](../index.html "OWASP Cheat Sheet Series")

OWASP Cheat Sheet Series

Password Storage

Initializing search

[OWASP/CheatSheetSeries](https://github.com/OWASP/CheatSheetSeries "Go to repository")

[![logo](../assets/OWASP_Logo.svg)](../index.html "OWASP Cheat Sheet Series")
OWASP Cheat Sheet Series

[OWASP/CheatSheetSeries](https://github.com/OWASP/CheatSheetSeries "Go to repository")

* [Introduction](../index.html)
* [Index Alphabetical](../Glossary.html)
* [Index ASVS](../IndexASVS.html)
* [Index MASVS](../IndexMASVS.html)
* [Index Proactive Controls](../IndexProactiveControls.html)
* [Index Top 10](../IndexTopTen.html)
* Cheatsheets

  Cheatsheets
  + [AJAX Security](AJAX_Security_Cheat_Sheet.html)
  + [Abuse Case](Abuse_Case_Cheat_Sheet.html)
  + [Access Control](Access_Control_Cheat_Sheet.html)
  + [Attack Surface Analysis](Attack_Surface_Analysis_Cheat_Sheet.html)
  + [Authentication](Authentication_Cheat_Sheet.html)
  + [Authorization](Authorization_Cheat_Sheet.html)
  + [Authorization Testing Automation](Authorization_Testing_Automation_Cheat_Sheet.html)
  + [Bean Validation](Bean_Validation_Cheat_Sheet.html)
  + [Browser Extension Vulnerabilities](Browser_Extension_Vulnerabilities_Cheat_Sheet.html)
  + [C-Based Toolchain Hardening](C-Based_Toolchain_Hardening_Cheat_Sheet.html)
  + [CI CD Security](CI_CD_Security_Cheat_Sheet.html)
  + [Choosing and Using Security Questions](Choosing_and_Using_Security_Questions_Cheat_Sheet.html)
  + [Clickjacking Defense](Clickjacking_Defense_Cheat_Sheet.html)
  + [Content Security Policy](Content_Security_Policy_Cheat_Sheet.html)
  + [Credential Stuffing Prevention](Credential_Stuffing_Prevention_Cheat_Sheet.html)
  + [Cross-Site Request Forgery Prevention](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
  + [Cross Site Scripting Prevention](Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
  + [Cryptographic Storage](Cryptographic_Storage_Cheat_Sheet.html)
  + [DOM Clobbering Prevention](DOM_Clobbering_Prevention_Cheat_Sheet.html)
  + [DOM based XSS Prevention](DOM_based_XSS_Prevention_Cheat_Sheet.html)
  + [Database Security](Database_Security_Cheat_Sheet.html)
  + [Denial of Service](Denial_of_Service_Cheat_Sheet.html)
  + [Deserialization](Deserialization_Cheat_Sheet.html)
  + [Django REST Framework](Django_REST_Framework_Cheat_Sheet.html)
  + [Django Security](Django_Security_Cheat_Sheet.html)
  + [Docker Security](Docker_Security_Cheat_Sheet.html)
  + [DotNet Security](DotNet_Security_Cheat_Sheet.html)
  + [Error Handling](Error_Handling_Cheat_Sheet.html)
  + [File Upload](File_Upload_Cheat_Sheet.html)
  + [Forgot Password](Forgot_Password_Cheat_Sheet.html)
  + [GraphQL](GraphQL_Cheat_Sheet.html)
  + [HTML5 Security](HTML5_Security_Cheat_Sheet.html)
  + [HTTP Headers](HTTP_Headers_Cheat_Sheet.html)
  + [HTTP Strict Transport Security](HTTP_Strict_Transport_Security_Cheat_Sheet.html)
  + [Infrastructure as Code Security](Infrastructure_as_Code_Security_Cheat_Sheet.html)
  + [Injection Prevention](Injection_Prevention_Cheat_Sheet.html)
  + [Injection Prevention in Java](Injection_Prevention_in_Java_Cheat_Sheet.html)
  + [Input Validation](Input_Validation_Cheat_Sheet.html)
  + [Insecure Direct Object Reference Prevention](Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.html)
  + [JAAS](JAAS_Cheat_Sheet.html)
  + [JSON Web Token for Java](JSON_Web_Token_for_Java_Cheat_Sheet.html)
  + [Java Security](Java_Security_Cheat_Sheet.html)
  + [Key Management](Key_Management_Cheat_Sheet.html)
  + [Kubernetes Security](Kubernetes_Security_Cheat_Sheet.html)
  + [LDAP Injection Prevention](LDAP_Injection_Prevention_Cheat_Sheet.html)
  + [Laravel](Laravel_Cheat_Sheet.html)
  + [Legacy Application Management](Legacy_Application_Management_Cheat_Sheet.html)
  + [Logging](Logging_Cheat_Sheet.html)
  + [Logging Vocabulary](Logging_Vocabulary_Cheat_Sheet.html)
  + [Mass Assignment](Mass_Assignment_Cheat_Sheet.html)
  + [Microservices Security](Microservices_Security_Cheat_Sheet.html)
  + [Microservices based Security Arch Doc](Microservices_based_Security_Arch_Doc_Cheat_Sheet.html)
  + [Mobile Application Security](Mobile_Application_Security_Cheat_Sheet.html)
  + [Multifactor Authentication](Multifactor_Authentication_Cheat_Sheet.html)
  + [NPM Security](NPM_Security_Cheat_Sheet.html)
  + [Network Segmentation](Network_Segmentation_Cheat_Sheet.html)
  + [NodeJS Docker](NodeJS_Docker_Cheat_Sheet.html)
  + [Nodejs Security](Nodejs_Security_Cheat_Sheet.html)
  + [OAuth2](OAuth2_Cheat_Sheet.html)
  + [OS Command Injection Defense](OS_Command_Injection_Defense_Cheat_Sheet.html)
  + [PHP Configuration](PHP_Configuration_Cheat_Sheet.html)
  + Password Storage

    [Password Storage](Password_Storage_Cheat_Sheet.html)

    Table of contents
    - [Introduction](#introduction)
    - [Background](#background)
      * [Hashing vs Encryption](#hashing-vs-encryption)
      * [When Password Hashes Can Be Cracked](#when-password-hashes-can-be-cracked)
    - [Methods for Enhancing Password Storage](#methods-for-enhancing-password-storage)
      * [Salting](#salting)
      * [Peppering](#peppering)
      * [Using Work Factors](#using-work-factors)
        + [Upgrading the Work Factor](#upgrading-the-work-factor)
    - [Password Hashing Algorithms](#password-hashing-algorithms)
      * [Argon2id](#argon2id)
      * [scrypt](#scrypt)
      * [bcrypt](#bcrypt)
        + [Input Limits of bcrypt](#input-limits-of-bcrypt)
        + [Pre-Hashing Passwords with bcrypt](#pre-hashing-passwords-with-bcrypt)
      * [PBKDF2](#pbkdf2)
      * [Parallel PBKDF2](#parallel-pbkdf2)
        + [PBKDF2 Pre-Hashing](#pbkdf2-pre-hashing)
    - [Upgrading Legacy Hashes](#upgrading-legacy-hashes)
      * [International Characters](#international-characters)
  + [Pinning](Pinning_Cheat_Sheet.html)
  + [Prototype Pollution Prevention](Prototype_Pollution_Prevention_Cheat_Sheet.html)
  + [Query Parameterization](Query_Parameterization_Cheat_Sheet.html)
  + [REST Assessment](REST_Assessment_Cheat_Sheet.html)
  + [REST Security](REST_Security_Cheat_Sheet.html)
  + [Ruby on Rails](Ruby_on_Rails_Cheat_Sheet.html)
  + [SAML Security](SAML_Security_Cheat_Sheet.html)
  + [SQL Injection Prevention](SQL_Injection_Prevention_Cheat_Sheet.html)
  + [Secrets Management](Secrets_Management_Cheat_Sheet.html)
  + [Secure Cloud Architecture](Secure_Cloud_Architecture_Cheat_Sheet.html)
  + [Secure Product Design](Secure_Product_Design_Cheat_Sheet.html)
  + [Securing Cascading Style Sheets](Securing_Cascading_Style_Sheets_Cheat_Sheet.html)
  + [Server Side Request Forgery Prevention](Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
  + [Session Management](Session_Management_Cheat_Sheet.html)
  + [Software Supply Chain Security](Software_Supply_Chain_Security_Cheat_Sheet.html)
  + [Symfony](Symfony_Cheat_Sheet.html)
  + [TLS Cipher String](TLS_Cipher_String_Cheat_Sheet.html)
  + [Third Party Javascript Management](Third_Party_Javascript_Management_Cheat_Sheet.html)
  + [Threat Modeling](Threat_Modeling_Cheat_Sheet.html)
  + [Transaction Authorization](Transaction_Authorization_Cheat_Sheet.html)
  + [Transport Layer Protection](Transport_Layer_Protection_Cheat_Sheet.html)
  + [Transport Layer Security](Transport_Layer_Security_Cheat_Sheet.html)
  + [Unvalidated Redirects and Forwards](Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html)
  + [User Privacy Protection](User_Privacy_Protection_Cheat_Sheet.html)
  + [Virtual Patching](Virtual_Patching_Cheat_Sheet.html)
  + [Vulnerability Disclosure](Vulnerability_Disclosure_Cheat_Sheet.html)
  + [Vulnerable Dependency Management](Vulnerable_Dependency_Management_Cheat_Sheet.html)
  + [Web Service Security](Web_Service_Security_Cheat_Sheet.html)
  + [XML External Entity Prevention](XML_External_Entity_Prevention_Cheat_Sheet.html)
  + [XML Security](XML_Security_Cheat_Sheet.html)
  + [XSS Filter Evasion](XSS_Filter_Evasion_Cheat_Sheet.html)
  + [XS Leaks](XS_Leaks_Cheat_Sheet.html)

Table of contents

* [Introduction](#introduction)
* [Background](#background)
  + [Hashing vs Encryption](#hashing-vs-encryption)
  + [When Password Hashes Can Be Cracked](#when-password-hashes-can-be-cracked)
* [Methods for Enhancing Password Storage](#methods-for-enhancing-password-storage)
  + [Salting](#salting)
  + [Peppering](#peppering)
  + [Using Work Factors](#using-work-factors)
    - [Upgrading the Work Factor](#upgrading-the-work-factor)
* [Password Hashing Algorithms](#password-hashing-algorithms)
  + [Argon2id](#argon2id)
  + [scrypt](#scrypt)
  + [bcrypt](#bcrypt)
    - [Input Limits of bcrypt](#input-limits-of-bcrypt)
    - [Pre-Hashing Passwords with bcrypt](#pre-hashing-passwords-with-bcrypt)
  + [PBKDF2](#pbkdf2)
  + [Parallel PBKDF2](#parallel-pbkdf2)
    - [PBKDF2 Pre-Hashing](#pbkdf2-pre-hashing)
* [Upgrading Legacy Hashes](#upgrading-legacy-hashes)
  + [International Characters](#international-characters)

# Password Storage Cheat Sheet[¶](#password-storage-cheat-sheet "Permanent link")

## Introduction[¶](#introduction "Permanent link")

This cheat sheet advises you on the proper methods for storing passwords for authentication. When passwords are stored, they must be protected from an attacker even if the application or database is compromised. Fortunately, a majority of modern languages and frameworks provide built-in functionality to help store passwords safely.

However, once an attacker has acquired stored password hashes, they are always able to brute force hashes offline. Defenders can slow down offline attacks by selecting hash algorithms that are as resource intensive as possible.

To sum up our recommendations:

* **Use [Argon2id](#argon2id) with a minimum configuration of 19 MiB of memory, an iteration count of 2, and 1 degree of parallelism.**
* **If [Argon2id](#argon2id) is not available, use [scrypt](#scrypt) with a minimum CPU/memory cost parameter of (2^17), a minimum block size of 8 (1024 bytes), and a parallelization parameter of 1.**
* **For legacy systems using [bcrypt](#bcrypt), use a work factor of 10 or more and with a password limit of 72 bytes.**
* **If FIPS-140 compliance is required, use [PBKDF2](#pbkdf2) with a work factor of 600,000 or more and set with an internal hash function of HMAC-SHA-256.**
* **Consider using a [pepper](#peppering) to provide additional defense in depth (though alone, it provides no additional secure characteristics).**

## Background[¶](#background "Permanent link")

### Hashing vs Encryption[¶](#hashing-vs-encryption "Permanent link")

Hashing and encryption can keep sensitive data safe, but in almost all circumstances, **passwords should be hashed, NOT encrypted.**

Because **hashing is a one-way function** (i.e., it is impossible to "decrypt" a hash and obtain the original plaintext value), it is the most appropriate approach for password validation. Even if an attacker obtains the hashed password, they cannot use it to log in as the victim.

Since **encryption is a two-way function**, attackers can retrieve the original plaintext from the encrypted data. It can be used to store data such as a user's address since this data is displayed in plaintext on the user's profile. Hashing their address would result in a garbled mess.

The only time encryption should be used in passwords is in edge cases where it is necessary to obtain the original plaintext password. This might be necessary if the application needs to use the password to authenticate with another system that does not support a modern way to programmatically grant access, such as OpenID Connect (OIDC). Wherever possible, an alternative architecture should be used to avoid the need to store passwords in an encrypted form.

For further guidance on encryption, see the [Cryptographic Storage Cheat Sheet](Cryptographic_Storage_Cheat_Sheet.html).

### When Password Hashes Can Be Cracked[¶](#when-password-hashes-can-be-cracked "Permanent link")

**Strong passwords stored with modern hashing algorithms and using hashing best practices should be effectively impossible for an attacker to crack.** It is your responsibility as an application owner to select a modern hashing algorithm.

However, there are some situations where an attacker can "crack" the hashes in some circumstances by doing the following:

* Selecting a password you think the victim has chosen (e.g.`password1!`)
* Calculating the hash
* Comparing the hash you calculated to the hash of the victim. If they match, you have correctly "cracked" the hash and now know the plaintext value of their password.

Usually, the attacker will repeat this process with a list of large number of potential candidate passwords, such as:

* Lists of passwords obtained from other compromised sites
* Brute force (trying every possible candidate)
* Dictionaries or wordlists of common passwords

While the number of permutations can be enormous, with high speed hardware (such as GPUs) and cloud services with many servers for rent, the cost to an attacker is relatively small to do successful password cracking, especially when best practices for hashing are not followed.

## Methods for Enhancing Password Storage[¶](#methods-for-enhancing-password-storage "Permanent link")

### Salting[¶](#salting "Permanent link")

A salt is a unique, randomly generated string that is added to each password as part of the hashing process. As the salt is unique for every user, an attacker has to crack hashes one at a time using the respective salt rather than calculating a hash once and comparing it against every stored hash. This makes cracking large numbers of hashes significantly harder, as the time required grows in direct proportion to the number of hashes.

Salting also protects against an attacker's pre-computing hashes using rainbow tables or database-based lookups. Finally, salting means that it is impossible to determine whether two users have the same password without cracking the hashes, as the different salts will result in different hashes even if the passwords are the same.

[Modern hashing algorithms](#password-hashing-algorithms) such as Argon2id, bcrypt, and PBKDF2 automatically salt the passwords, so no additional steps are required when using them.

### Peppering[¶](#peppering "Permanent link")

A [pepper](https://datatracker.ietf.org/doc/html/draft-ietf-kitten-password-storage-07#section-4.2) can be used in addition to salting to provide an additional layer of protection. It prevents an attacker from being able to crack any of the hashes if they only have access to the database, for example, if they have exploited a SQL injection vulnerability or obtained a backup of the database. Peppering strategies do not affect the password hashing function in any way.

For example, one peppering strategy is hashing the passwords as usual (using a password hashing algorithm) and then using an HMAC (e.g., HMAC-SHA256, HMAC-SHA512, depending on the desired output length) on the original password hash before storing the password hash in the database, with the pepper acting as the HMAC key.

* The pepper is **shared between stored passwords**, rather than being *unique* like a salt.
* Unlike a password salt, the pepper **should not be stored in the database**.
* Peppers are secrets and should be stored in "secrets vaults" or HSMs (Hardware Security Modules). See the [Secrets Management Cheat Sheet](Secrets_Management_Cheat_Sheet.html) for more information on securely storing secrets.
* Like any other cryptographic key, a pepper rotation strategy should be considered.

### Using Work Factors[¶](#using-work-factors "Permanent link")

The work factor is the number of iterations of the hashing algorithm that are performed for each password (usually, it's actually `2^work` iterations). The work factor is typically stored in the hash output. It makes calculating the hash more computationally expensive, which in turn reduces the speed and/or increases the cost for which an attacker can attempt to crack the password hash.

When you choose a work factor, strike a balance between security and performance. Though higher work factors make hashes more difficult for an attacker to crack, they will slow down the process of verifying a login attempt. If the work factor is too high, the performance of the application may be degraded, which could used by an attacker to carry out a denial of service attack by exhausting the server's CPU with a large number of login attempts.

There is no golden rule for the ideal work factor - it will depend on the performance of the server and the number of users on the application. Determining the optimal work factor will require experimentation on the specific server(s) used by the application. As a general rule, calculating a hash should take less than one second.

#### Upgrading the Work Factor[¶](#upgrading-the-work-factor "Permanent link")

One key advantage of having a work factor is that it can be increased over time as hardware becomes more powerful and cheaper.

The most common approach to upgrading the work factor is to wait until the user next authenticates, then re-hash their password with the new work factor. The different hashes will have different work factors and hashes may never be upgraded if the user doesn't log back into the application. Depending on the application, it may be appropriate to remove the older password hashes and require users to reset their passwords next time they need to login in order to avoid storing older and less secure hashes.

## Password Hashing Algorithms[¶](#password-hashing-algorithms "Permanent link")

Some modern hashing algorithms have been specifically designed to securely store passwords. This means that they should be slow (unlike algorithms such as MD5 and SHA-1, which were designed to be fast), and you can change how slow they are by changing the work factor.

You do not need to hide which password hashing algorithm is used by an application. If you utilize a modern password hashing algorithm with proper configuration parameters, it should be safe to state in public which password hashing algorithms are in use and be listed [here](https://pulse.michalspacek.cz/passwords/storages).

Three hashing algorithms that should be considered:

### Argon2id[¶](#argon2id "Permanent link")

[Argon2](https://en.wikipedia.org/wiki/Argon2) was the winner of the 2015 [Password Hashing Competition](https://en.wikipedia.org/wiki/Password_Hashing_Competition). Out of the three Argon2 versions, use the Argon2id variant since it provides a balanced approach to resisting both side-channel and GPU-based attacks.

Rather than a simple work factor like other algorithms, Argon2id has three different parameters that can be configured: the base minimum of the minimum memory size (m), the minimum number of iterations (t), and the degree of parallelism (p). We recommend the following configuration settings:

* m=47104 (46 MiB), t=1, p=1 (Do not use with Argon2i)
* m=19456 (19 MiB), t=2, p=1 (Do not use with Argon2i)
* m=12288 (12 MiB), t=3, p=1
* m=9216 (9 MiB), t=4, p=1
* m=7168 (7 MiB), t=5, p=1

These configuration settings provide an equal level of defense, and the only difference is a trade off between CPU and RAM usage.

### scrypt[¶](#scrypt "Permanent link")

[scrypt](http://www.tarsnap.com/scrypt/scrypt.pdf) is a password-based key derivation function created by [Colin Percival](https://twitter.com/cperciva). While [Argon2id](#argon2id) should be the best choice for password hashing, [scrypt](#scrypt) should be used when the former is not available.

Like [Argon2id](#argon2id), scrypt has three different parameters that can be configured: the minimum CPU/memory cost parameter (N), the blocksize (r) and the degree of parallelism (p). Use one of the following settings:

* N=2^17 (128 MiB), r=8 (1024 bytes), p=1
* N=2^16 (64 MiB), r=8 (1024 bytes), p=2
* N=2^15 (32 MiB), r=8 (1024 bytes), p=3
* N=2^14 (16 MiB), r=8 (1024 bytes), p=5
* N=2^13 (8 MiB), r=8 (1024 bytes), p=10

These configuration settings provide an equal level of defense. The only difference is a trade off between CPU and RAM usage.

### bcrypt[¶](#bcrypt "Permanent link")

The [bcrypt](https://en.wikipedia.org/wiki/bcrypt) password hashing function **should only** be used for password storage in legacy systems where Argon2 and scrypt are not available.

The work factor should be as large as verification server performance will allow, with a minimum of 10.

#### Input Limits of bcrypt[¶](#input-limits-of-bcrypt "Permanent link")

bcrypt has a maximum length input length of 72 bytes [for most implementations](https://security.stackexchange.com/questions/39849/does-bcrypt-have-a-maximum-password-length), so you should enforce a maximum password length of 72 bytes (or less if the bcrypt implementation in use has smaller limits).

#### Pre-Hashing Passwords with bcrypt[¶](#pre-hashing-passwords-with-bcrypt "Permanent link")

An alternative approach is to pre-hash the user-supplied password with a fast algorithm such as SHA-2, HMAC, or BLAKE3 and then to hash the resulting hash value with bcrypt (i.e., `bcrypt(H($password)), $salt, $cost)`)..
This can be **dangerous** because of null bytes in the hash output value and because of [password shucking](https://www.youtube.com/watch?v=OQD3qDYMyYQ).

The original bcrypt expects a null terminated password string, this means that the hash value will only be used to the first null byte in the hash value. (`bcrypt(H($password)), $salt, $cost) == bcrypt("", $salt, $cost)` if `H($password)[0] == 0`)
This increases the chance of finding a collision when [combining bcrypt with other hash functions](https://blog.ircmaxell.com/2015/03/security-issue-combining-bcrypt-with.html) and can be avoided by encoding the hash value to printable string with something like base64.
base64 can increases the length of the hash value above 72 characters and so there is a bit of truncation for large hash values from hashes like SHA-512, this is [negligible](https://soatok.blog/2024/11/27/beyond-bcrypt/).

Password shucking uses the fact, that it is easy to check if `bcrypt(base64(H($password))), $salt, $cost) == bcrypt(base64($leaked_hash), $salt, $cost)`.
If the inner hash function `H` is used with the same password somewhere else and known to an attacker cracking the password can be reduced to breaking the hash function `H`.
Just using pure SHA-512, ( i.e. `bcrypt(base64(sha512($password))), $salt, $cost)`) is a **dangerous practice** and is as secure as just using pure SHA-512.
Password shucking only works if a leaked hash is known to the attacker, either through a breach database or rainbow tables.
To mitigate password shucking a [pepper](#peppering) can be used.

To summarize if bcrypt has to be used and the password should to be pre-hashed you should do `bcrypt(base64(hmac-sha384(data:$password, key:$pepper)), $salt, $cost)` and store the pepper not in the database.

### PBKDF2[¶](#pbkdf2 "Permanent link")

Since [PBKDF2](https://en.wikipedia.org/wiki/PBKDF2) is recommended by [NIST](https://pages.nist.gov/800-63-3/sp800-63b.html#memsecretver) and has FIPS-140 validated implementations, so it should be the preferred algorithm when these are required.

The PBKDF2 algorithm requires that you select an internal hashing algorithm such as an HMAC or a variety of other hashing algorithms. HMAC-SHA-256 is widely supported and is recommended by NIST.

The work factor for PBKDF2 is implemented through an iteration count, which should set differently based on the internal hashing algorithm used.

* PBKDF2-HMAC-SHA1: 1,300,000 iterations
* PBKDF2-HMAC-SHA256: 600,000 iterations
* PBKDF2-HMAC-SHA512: 210,000 iterations

### Parallel PBKDF2[¶](#parallel-pbkdf2 "Permanent link")

* PPBKDF2-SHA512: cost 2
* PPBKDF2-SHA256: cost 5
* PPBKDF2-SHA1: cost 10

These configuration settings are equivalent in the defense they provide. ([Number as of december 2022, based on testing of RTX 4000 GPUs](https://tobtu.com/minimum-password-settings/))

#### PBKDF2 Pre-Hashing[¶](#pbkdf2-pre-hashing "Permanent link")

When PBKDF2 is used with an HMAC, and the password is longer than the hash function's block size (64 bytes for SHA-256), the password will be automatically pre-hashed. For example, the password "This is a password longer than 512 bits which is the block size of SHA-256" is converted to the hash value (in hex): `fa91498c139805af73f7ba275cca071e78d78675027000c99a9925e2ec92eedd`.

Good implementations of PBKDF2 perform pre-hashing before the expensive iterated hashing phase. However, some implementations perform the conversion on each iteration, which can make hashing long passwords significantly more expensive than hashing short passwords. When users supply very long passwords, a potential denial of service vulnerability could occur, such as the one published in [Django](https://www.djangoproject.com/weblog/2013/sep/15/security/) during 2013. Manual pre-hashing can reduce this risk but requires adding a [salt](#salting) to the pre-hash step.

## Upgrading Legacy Hashes[¶](#upgrading-legacy-hashes "Permanent link")

Older applications that use less secure hashing algorithms, such as MD5 or SHA-1, can be upgraded to modern password hashing algorithms as described above. When the users enter their password (usually by authenticating on the application), that input should be re-hashed using the new algorithm. Defenders should expire the users' current password and require them to enter a new one, so that any older (less secure) hashes of their password are no longer useful to an attacker.

However, this means that old (less secure) password hashes will be stored in the database until the user logs in. You can take one of two approaches to avoid this dilemma.

Upgrade Method One: Expire and delete the password hashes of users who have been inactive for an extended period and require them to reset their passwords to login again. Although secure, this approach is not particularly user-friendly. Expiring the passwords of many users may cause issues for support staff or may be interpreted by users as an indication of a breach.

Upgrade Method Two: Use the existing password hashes as inputs for a more secure algorithm. For example, if the application originally stored passwords as `md5($password)`, this could be easily upgraded to `bcrypt(md5($password))`. Layering the hashes avoids the need to know the original password; however, it can make the hashes easier to crack. These hashes should be replaced with direct hashes of the users' passwords next time the user logs in.

Remember that once your password hashing method is selected, it will have to be upgraded in the future, so ensure that upgrading your hashing algorithm is as easy as possible. During the transition period, allow for a mix of old and new hashing algorithms. Using a mix of hashing algorithms is easier if the password hashing algorithm and work factor are stored with the password using a standard format, for example, the [modular PHC string format](https://github.com/P-H-C/phc-string-format/blob/master/phc-sf-spec.md).

### International Characters[¶](#international-characters "Permanent link")

Your hashing library must be able to accept a wide range of characters and should be compatible with all Unicode codepoints, so users can use the full range of characters available on modern devices - especially mobile keyboards. They should be able to select passwords from various languages and include pictograms. Prior to hashing the entropy of the user's entry should not be reduced, and password hashing libraries need to be able to use input that may contain a NULL byte.

©Copyright  - Cheat Sheets Series Team - This work is licensed under [Creative Commons Attribution-ShareAlike 4.0 International](https://creativecommons.org/licenses/by-sa/4.0/).

Made with
[Material for MkDocs](https://squidfunk.github.io/mkdocs-material/)



=== Content from github.com_c39a0c53_20250114_195017.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fcommit%2Fea9688dd01d100193d834117dbfc2cfabcf9ea0b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fcommit%2Fea9688dd01d100193d834117dbfc2cfabcf9ea0b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=codeigniter4%2Fshield)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[codeigniter4](/codeigniter4)
/
**[shield](/codeigniter4/shield)**
Public

* [Notifications](/login?return_to=%2Fcodeigniter4%2Fshield) You must be signed in to change notification settings
* [Fork
  132](/login?return_to=%2Fcodeigniter4%2Fshield)
* [Star
   372](/login?return_to=%2Fcodeigniter4%2Fshield)

* [Code](/codeigniter4/shield)
* [Issues
  5](/codeigniter4/shield/issues)
* [Pull requests
  12](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects
  0](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

Additional navigation options

* [Code](/codeigniter4/shield)
* [Issues](/codeigniter4/shield/issues)
* [Pull requests](/codeigniter4/shield/pulls)
* [Discussions](/codeigniter4/shield/discussions)
* [Actions](/codeigniter4/shield/actions)
* [Projects](/codeigniter4/shield/projects)
* [Security](/codeigniter4/shield/security)
* [Insights](/codeigniter4/shield/pulse)

## Commit

[Permalink](/codeigniter4/shield/commit/ea9688dd01d100193d834117dbfc2cfabcf9ea0b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-c5vj-f36q-p9vg](https://github.com/advisories/GHSA-c5vj-f36q-p9vg "GHSA-c5vj-f36q-p9vg")

[Browse files](/codeigniter4/shield/tree/ea9688dd01d100193d834117dbfc2cfabcf9ea0b)
Browse the repository at this point in the history

```
* feat: copy the current methods as depreacted

* fix: password shucking

* feat: support old dangerous passwords

* docs: add Upgrade Guide

* refactor: fix variable name typo

Co-authored-by: MGatner <mgatner@icloud.com>

* refactor: fix variable name typo

* fix: $options is missing for password_needs_rehash()

* docs: add OWASP Cheat Sheet in README

* docs: add explanation in UPGRADING.md

* docs: replace Config/Auth.php with app/Config/Auth.php

* docs: add How to Strengthen the Password

* docs: UPGRADING.md

* docs: add note in "Minimum Password Length"

* docs: $supportOldDangerousPassword will be removed in v1.0.0

* feat: add validation rule for max password length

PASSWORD_BCRYPT -> 72 bytes
Others -> 255 characters

* docs: update docs

* feat: add new lang item to new lang files

* feat: add errorPasswordTooLongBytes to Language/pt-BR

* refactor: ChangeIfElseValueAssignToEarlyReturnRector

---------

Co-authored-by: MGatner <mgatner@icloud.com>
```

* Loading branch information

[![@kenjis](https://avatars.githubusercontent.com/u/87955?s=40&v=4)](/kenjis) [![@MGatner](https://avatars.githubusercontent.com/u/17572847?s=40&v=4)](/MGatner)

[kenjis](/codeigniter4/shield/commits?author=kenjis "View all commits by kenjis")
and
[MGatner](/codeigniter4/shield/commits?author=MGatner "View all commits by MGatner")
authored
Mar 11, 2023

1 parent
[247c53f](/codeigniter4/shield/commit/247c53f62e6096267ea941c5cfbb47aedf003927)

commit ea9688d

 Show file tree

 Hide file tree

Showing
**26 changed files**
with
**435 additions**
and
**17 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* README.md
  [README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5)
* UPGRADING.md
  [UPGRADING.md](#diff-f411a5009131db5a6c7242b49ca78488f2d274ef9e5e5f4de9262a42108a5386)
* docs

  + guides

    - docs/guides/strengthen\_password.md
      [strengthen\_password.md](#diff-3ce9830a7bd67788896cff359af401b67c7bb86cc01935dd08511a00775fe06a)
  + docs/index.md
    [index.md](#diff-b4d68dc855d0f9476d3f2ee343853bd21bf82ea9960d0cf06661baa244439dd6)
* mkdocs.yml
  [mkdocs.yml](#diff-98d0f806abc9af24e6a7c545d3d77e8f9ad57643e27211d7a7b896113e420ed2)
* src

  + Authentication

    - Authenticators

      * src/Authentication/Authenticators/Session.php
        [Session.php](#diff-0a9fe3001b6be0108fb817ad7cc1ff736d7e9f6be2df379ed5e1b4e4a892e536)
    - src/Authentication/Passwords.php
      [Passwords.php](#diff-6afd348e489c3ec834bb53684d83b0539dd1fb88c13ddb254b87cc14f30b4037)
    - Passwords

      * src/Authentication/Passwords/ValidationRules.php
        [ValidationRules.php](#diff-d0495d246982de14cb2329639948c0926d305633088b23f3f064b13b06a5c2c0)
  + Config

    - src/Config/Auth.php
      [Auth.php](#diff-c48af47762f5a9ba44e0e0b95dd538d48276cf1bc59a8c157bdcddc812184d54)
  + Controllers

    - src/Controllers/LoginController.php
      [LoginController.php](#diff-45e8260851b030d02dc4cfa31551801add09770d306c9a98f4afddf7c5db2539)
    - src/Controllers/RegisterController.php
      [RegisterController.php](#diff-9e2889797f10c1aecf305385c88332cdd3898288b232e470b5b10662ead58383)
  + Language

    - de

      * src/Language/de/Auth.php
        [Auth.php](#diff-2b85118f8a629f90163570fda562d9379b8ee25dafc16e8748e7eb892884ddd2)
    - en

      * src/Language/en/Auth.php
        [Auth.php](#diff-35aaa2328660db48366a6596c60ebbc2b6c58c4c189d036c93ee2114d870e9eb)
    - es

      * src/Language/es/Auth.php
        [Auth.php](#diff-7247c83083f227068fd7d2f2d162cfd9b0b9c53fe05e88e8e7a6907c133d3691)
    - fa

      * src/Language/fa/Auth.php
        [Auth.php](#diff-8229647b35346c9b8bad7f78b331b1c097a5e3c54eab852172e9ad3a96f7e899)
    - fr

      * src/Language/fr/Auth.php
        [Auth.php](#diff-2752760d782080876ddc7d322316eab9ecd25c0d22f3ff73c02c96a416ec2705)
    - id

      * src/Language/id/Auth.php
        [Auth.php](#diff-3a21a12248f4d76243ec99fd41cbdf9753ca99e9ddfe58a2ec25eb46f14bd575)
    - it

      * src/Language/it/Auth.php
        [Auth.php](#diff-cf6cdc80aff8c5454156e865a4cd35df2c603bfebc5450bfdde6c91791945398)
    - ja

      * src/Language/ja/Auth.php
        [Auth.php](#diff-e70a14c4a9394990ae09a9c11e499dff1d07315f7daf4c6a12293fce7330c8a8)
    - pt-BR

      * src/Language/pt-BR/Auth.php
        [Auth.php](#diff-8c26125094c60df5cc95301f8c0891d7acec9adfc47d148a410f619b8b53fe9e)
    - sk

      * src/Language/sk/Auth.php
        [Auth.php](#diff-da68a83b543c3f9c1d085738b1f93d7f257be4c997cd9dc3688e52e1aa7d8a29)
    - tr

      * src/Language/tr/Auth.php
        [Auth.php](#diff-b3c953f785d688a379e72180533e52730418ad7c06160a9a302bbc0de2d29671)
* tests

  + Authentication/Authenticators

    - tests/Authentication/Authenticators/SessionAuthenticatorTest.php
      [SessionAuthenticatorTest.php](#diff-72d57325d612cc25a56eec53a2f8c721d8ef92fd14b20e2f83446f226972f715)
  + Controllers

    - tests/Controllers/LoginTest.php
      [LoginTest.php](#diff-4ee2439849688f735f904d77d2c14d5bf4270481b2ddf24005f9330ed2a5c32e)
    - tests/Controllers/RegisterTest.php
      [RegisterTest.php](#diff-85cfd432fe4c8f37a15ed23df64269f73ff7c0a400a65ac0821233ad821ac42d)
  + Unit

    - tests/Unit/PasswordsTest.php
      [PasswordsTest.php](#diff-7b90a458912c8f5cf233dfd19561778977d42906e77e7d457e9311f6f7190f58)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5 "README.md")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -86,3 +86,4 @@ within this library, in no particular order: |
|  |  | - [Google Cloud: 13 best practices for user account, authentication, and password management, 2021 edition](https://cloud.google.com/blog/products/identity-security/account-authentication-and-password-management-best-practices) |
|  |  | - [NIST Digital Identity Guidelines](https://pages.nist.gov/800-63-3/sp800-63b.html) |
|  |  | - [Implementing Secure User Authentication in PHP Applications with Long-Term Persistence (Login with "Remember Me" Cookies) ](https://paragonie.com/blog/2015/04/secure-authentication-php-with-long-term-persistence) |
|  |  | - [Password Storage - OWASP Cheat Sheet Series](https://cheatsheetseries.owasp.org/cheatsheets/Password\_Storage\_Cheat\_Sheet.html) |

51 changes: 51 additions & 0 deletions

51
[UPGRADING.md](#diff-f411a5009131db5a6c7242b49ca78488f2d274ef9e5e5f4de9262a42108a5386 "UPGRADING.md")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/UPGRADING.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,51 @@ |
|  |  | # Upgrade Guide |
|  |  |  |
|  |  | ## Version 1.0.0-beta.3 to 1.0.0-beta.4 |
|  |  |  |
|  |  | ### Important Password Changes |
|  |  |  |
|  |  | #### Password Incompatibility |
|  |  |  |
|  |  | Shield 1.0.0-beta.4 fixes a [vulnerability related to password storage](https://github.com/codeigniter4/shield/security/advisories/GHSA-c5vj-f36q-p9vg). |
|  |  | As a result, hashed passwords already stored in the database are no longer compatible |
|  |  | and cannot be used by default. |
|  |  |  |
|  |  | All hashed passwords stored in Shield v1.0.0-beta.3 or earlier are easier to |
|  |  | crack than expected due to the above vulnerability. Therefore, they should be |
|  |  | removed as soon as possible. |
|  |  |  |
|  |  | Existing users will no longer be able to log in with their passwords and will |
|  |  | need to log in with the magic link and then set their passwords again. |
|  |  |  |
|  |  | #### If You Want to Allow Login with Existing Passwords |
|  |  |  |
|  |  | If you want to use passwords saved in Shield v1.0.0-beta.3 or earlier, |
|  |  | you must add the following property in `app/Config/Auth.php`: |
|  |  |  |
|  |  | ```php |
|  |  | public bool $supportOldDangerousPassword = true; |
|  |  | ``` |
|  |  |  |
|  |  | After upgrading, with the above setting, once a user logs in with the password, |
|  |  | the hashed password is updated and stored in the database. |
|  |  |  |
|  |  | In this case, the existing hashed passwords are still easier to crack than expected. |
|  |  | Therefore, this setting should not be used for an extended period of time. |
|  |  | So you should change the setting to `false` as soon as possible, and remove old |
|  |  | hashed password. |
|  |  |  |
|  |  | > \*\*Note\*\* |
|  |  | > |
|  |  | > This setting is deprecated. It will be removed in v1.0.0 official release. |
|  |  |  |
|  |  | #### Limitations for the Default Password Handling |
|  |  |  |
|  |  | By default, Shield uses the hashing algorithm `PASSWORD\_DEFAULT` (see `app/Config/Auth.php`), |
|  |  | that is, `PASSWORD\_BCRYPT` at the time of writing. |
|  |  |  |
|  |  | Now there are two limitations when you use `PASSWORD\_BCRYPT`. |
|  |  |  |
|  |  | 1. the password will be truncated to a maximum length of 72 bytes. |
|  |  | 2. the password will be truncated at the first NULL byte (`\0`). |
|  |  |  |
|  |  | If these behaviors are unacceptable, see [How to Strengthen the Password](https://github.com/codeigniter4/shield/blob/develop/docs/guides/strengthen\_password.md). |

122 changes: 122 additions & 0 deletions

122
[docs/guides/strengthen\_password.md](#diff-3ce9830a7bd67788896cff359af401b67c7bb86cc01935dd08511a00775fe06a "docs/guides/strengthen_password.md")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/docs/guides/strengthen_password.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,122 @@ |
|  |  | # How to Strengthen the Password |
|  |  |  |
|  |  | Shield allows you to customize password-related settings to make your passwords more secure. |
|  |  |  |
|  |  | ## Minimum Password Length |
|  |  |  |
|  |  | The most important factor when it comes to passwords is the number of characters in the password. |
|  |  | You can check password strength with [Password Strength Testing Tool](https://bitwarden.com/password-strength/). |
|  |  | Short passwords may be cracked in less than one day. |
|  |  |  |
|  |  | In Shield, you can set the users' minimum password length. The setting is |
|  |  | `$minimumPasswordLength` in `app/Config/Auth.php`. The default value is 8 characters. |
|  |  | It is the recommended minimum value by NIST. However, some organizations recommend |
|  |  | 12 to 14 characters. |
|  |  |  |
|  |  | The longer the password, the stronger it is. Consider increasing the value. |
|  |  |  |
|  |  | > \*\*Note\*\* |
|  |  | > |
|  |  | > This checking works when you validate passwords with the `strong\_password` |
|  |  | > validation rule. |
|  |  | > |
|  |  | > If you disable `CompositionValidator` (enabled by default) in `$passwordValidators`, |
|  |  | > this checking will not work. |
|  |  |  |
|  |  | ## Password Hashing Algorithm |
|  |  |  |
|  |  | You can change the password hashing algorithm by `$hashAlgorithm` in `app/Config/Auth.php`. |
|  |  | The default value is `PASSWORD\_DEFAULT` that is `PASSWORD\_BCRYPT` at the time of writing. |
|  |  |  |
|  |  | `PASSWORD\_BCRYPT` means to create new password hashes using the bcrypt algorithm. |
|  |  |  |
|  |  | You can use `PASSWORD\_ARGON2ID` if your PHP has been compiled with Argon2 support. |
|  |  |  |
|  |  | ### PASSWORD\_BCRYPT |
|  |  |  |
|  |  | `PASSWORD\_BCRYPT` has one configuration `$hashCost`. The bigger the cost, hashed passwords will be the stronger. |
|  |  |  |
|  |  | You can find your appropriate cost with the following code: |
|  |  |  |
|  |  | ```php |
|  |  | <?php |
|  |  | /\*\* |
|  |  | \* This code will benchmark your server to determine how high of a cost you can |
|  |  | \* afford. You want to set the highest cost that you can without slowing down |
|  |  | \* you server too much. 8-10 is a good baseline, and more is good if your servers |
|  |  | \* are fast enough. The code below aims for ≤ 50 milliseconds stretching time, |
|  |  | \* which is a good baseline for systems handling interactive logins. |
|  |  | \* |
|  |  | \* From: https://www.php.net/manual/en/function.password-hash.php#refsect1-function.password-hash-examples |
|  |  | \*/ |
|  |  | $timeTarget = 0.05; // 50 milliseconds |
|  |  |  |
|  |  | $cost = 8; |
|  |  | do { |
|  |  | $cost++; |
|  |  | $start = microtime(true); |
|  |  | password\_hash("test", PASSWORD\_BCRYPT, ["cost" => $cost]); |
|  |  | $end = microtime(true); |
|  |  | } while (($end - $start) < $timeTarget); |
|  |  |  |
|  |  | echo "Appropriate Cost Found: " . $cost; |
|  |  | ``` |
|  |  |  |
|  |  | #### Limitations |
|  |  |  |
|  |  | There are two limitations when you use `PASSWORD\_BCRYPT`: |
|  |  |  |
|  |  | 1. the password will be truncated to a maximum length of 72 bytes. |
|  |  | 2. the password will be truncated at the first NULL byte (`\0`). |
|  |  |  |
|  |  | ##### 72 byte issue |
|  |  |  |
|  |  | If a user submits a password longer than 72 bytes, the validation error will occur. |
|  |  | If this behavior is unacceptable, consider: |
|  |  |  |
|  |  | 1. change the hashing algorithm to `PASSWORD\_ARGON2ID`. It does not have such a limitation. |
|  |  |  |
|  |  | ##### NULL byte issue |
|  |  |  |
|  |  | This is because `PASSWORD\_BCRYPT` is not binary-safe. Normal users cannot |
|  |  | send NULL bytes in a password string, so this is not a problem in most cases. |
|  |  |  |
|  |  | But if this behavior is unacceptable, consider: |
|  |  |  |
|  |  | 1. adding a validation rule to prohibit NULL bytes or control codes. |
|  |  | 2. or change the hashing algorithm to `PASSWORD\_ARGON2ID`. It is binary-safe. |
|  |  |  |
|  |  | ### PASSWORD\_ARGON2ID |
|  |  |  |
|  |  | `PASSWORD\_ARGON2ID` has three configuration `$hashMemoryCost`, `$hashTimeCost`, |
|  |  | and `$hashThreads`. |
|  |  |  |
|  |  | If you use `PASSWORD\_ARGON2ID`, you should use PHP's constants: |
|  |  |  |
|  |  | ```php |
|  |  | public int $hashMemoryCost = PASSWORD\_ARGON2\_DEFAULT\_MEMORY\_COST; |
|  |  |  |
|  |  | public int $hashTimeCost = PASSWORD\_ARGON2\_DEFAULT\_TIME\_COST; |
|  |  | public int $hashThreads = PASSWORD\_ARGON2\_DEFAULT\_THREADS; |
|  |  | ``` |
|  |  |  |
|  |  | ## Maximum Password Length |
|  |  |  |
|  |  | By default, Shield has the validation rules for maximum password length. |
|  |  |  |
|  |  | - 72 bytes for PASSWORD\_BCRYPT |
|  |  | - 255 characters for others |
|  |  |  |
|  |  | You can customize the validation rule. See [Customizing Shield](../customization.md). |
|  |  |  |
|  |  | ## $supportOldDangerousPassword |
|  |  |  |
|  |  | In `app/Config/Auth.php` there is `$supportOldDangerousPassword`, which is a |
|  |  | setting for using passwords stored in older versions of Shield that were [vulnerable](https://github.com/codeigniter4/shield/security/advisories/GHSA-c5vj-f36q-p9vg). |
|  |  |  |
|  |  | This setting is deprecated. If you have this setting set to `true`, you should change |
|  |  | it to `false` as soon as possible, and remove old hashed password in your database. |
|  |  |  |
|  |  | > \*\*Note\*\* |
|  |  | > |
|  |  | > This setting will be removed in v1.0.0 official release. |

1 change: 1 addition & 0 deletions

1
[docs/index.md](#diff-b4d68dc855d0f9476d3f2ee343853bd21bf82ea9960d0cf06661baa244439dd6 "docs/index.md")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/docs/index.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -14,3 +14,4 @@ |
|  |  | ## Guides |
|  |  | \* [Protecting an API with Access Tokens](guides/api\_tokens.md) |
|  |  | \* [Mobile Authentication with Access Tokens](guides/mobile\_apps.md) |
|  |  | \* [How to Strengthen the Password](guides/strengthen\_password.md) |

1 change: 1 addition & 0 deletions

1
[mkdocs.yml](#diff-98d0f806abc9af24e6a7c545d3d77e8f9ad57643e27211d7a7b896113e420ed2 "mkdocs.yml")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/mkdocs.yml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -51,3 +51,4 @@ nav: |
|  |  | - Guides: |
|  |  | - guides/api\_tokens.md |
|  |  | - guides/mobile\_apps.md |
|  |  | - guides/strengthen\_password.md |

21 changes: 16 additions & 5 deletions

21
[src/Authentication/Authenticators/Session.php](#diff-0a9fe3001b6be0108fb817ad7cc1ff736d7e9f6be2df379ed5e1b4e4a892e536 "src/Authentication/Authenticators/Session.php")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/src/Authentication/Authenticators/Session.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -336,19 +336,30 @@ public function check(array $credentials): Result |
|  |  | /\*\* @var Passwords $passwords \*/ |
|  |  | $passwords = service('passwords'); |
|  |  |  |
|  |  | // This is only for supportOldDangerousPassword. |
|  |  | $needsRehash = false; |
|  |  |  |
|  |  | // Now, try matching the passwords. |
|  |  | if (! $passwords->verify($givenPassword, $user->password\_hash)) { |
|  |  | return new Result([ |
|  |  | 'success' => false, |
|  |  | 'reason' => lang('Auth.invalidPassword'), |
|  |  | ]); |
|  |  | if ( |
|  |  | ! setting('Auth.supportOldDangerousPassword') |
|  |  | || ! $passwords->verifyDanger($givenPassword, $user->password\_hash) // @phpstan-ignore-line |
|  |  | ) { |
|  |  | return new Result([ |
|  |  | 'success' => false, |
|  |  | 'reason' => lang('Auth.invalidPassword'), |
|  |  | ]); |
|  |  | } |
|  |  |  |
|  |  | // Passed with old dangerous password. |
|  |  | $needsRehash = true; |
|  |  | } |
|  |  |  |
|  |  | // Check to see if the password needs to be rehashed. |
|  |  | // This would be due to the hash algorithm or hash |
|  |  | // cost changing since the last time that a user |
|  |  | // logged in. |
|  |  | if ($passwords->needsRehash($user->password\_hash)) { |
|  |  | if ($passwords->needsRehash($user->password\_hash) || $needsRehash) { |
|  |  | $user->password\_hash = $passwords->hash($givenPassword); |
|  |  | $this->provider->save($user); |
|  |  | } |
| Expand Down | |  |

57 changes: 49 additions & 8 deletions

57
[src/Authentication/Passwords.php](#diff-6afd348e489c3ec834bb53684d83b0539dd1fb88c13ddb254b87cc14f30b4037 "src/Authentication/Passwords.php")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/src/Authentication/Passwords.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,26 +31,42 @@ public function \_\_construct(Auth $config) |
|  |  | \*/ |
|  |  | public function hash(string $password) |
|  |  | { |
|  |  | if ((defined('PASSWORD\_ARGON2I') && $this->config->hashAlgorithm === PASSWORD\_ARGON2I) |
|  |  | return password\_hash($password, $this->config->hashAlgorithm, $this->getHashOptions()); |
|  |  | } |
|  |  |  |
|  |  | private function getHashOptions(): array |
|  |  | { |
|  |  | if ( |
|  |  | (defined('PASSWORD\_ARGON2I') && $this->config->hashAlgorithm === PASSWORD\_ARGON2I) |
|  |  | || (defined('PASSWORD\_ARGON2ID') && $this->config->hashAlgorithm === PASSWORD\_ARGON2ID) |
|  |  | ) { |
|  |  | $hashOptions = [ |
|  |  | return [ |
|  |  | 'memory\_cost' => $this->config->hashMemoryCost, |
|  |  | 'time\_cost' => $this->config->hashTimeCost, |
|  |  | 'threads' => $this->config->hashThreads, |
|  |  | ]; |
|  |  | } else { |
|  |  | $hashOptions = [ |
|  |  | 'cost' => $this->config->hashCost, |
|  |  | ]; |
|  |  | } |
|  |  |  |
|  |  | return [ |
|  |  | 'cost' => $this->config->hashCost, |
|  |  | ]; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Hash a password. |
|  |  | \* |
|  |  | \* @return false|string|null |
|  |  | \* |
|  |  | \* @deprecated This is only for backward compatibility. |
|  |  | \*/ |
|  |  | public function hashDanger(string $password) |
|  |  | { |
|  |  | return password\_hash( |
|  |  | base64\_encode( |
|  |  | hash('sha384', $password, true) |
|  |  | ), |
|  |  | $this->config->hashAlgorithm, |
|  |  | $hashOptions |
|  |  | $this->getHashOptions() |
|  |  | ); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -61,6 +77,19 @@ public function hash(string $password) |
|  |  | \* @param string $hash The previously hashed password |
|  |  | \*/ |
|  |  | public function verify(string $password, string $hash): bool |
|  |  | { |
|  |  | return password\_verify($password, $hash); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Verifies a password against a previously hashed password. |
|  |  | \* |
|  |  | \* @param string $password The password we're checking |
|  |  | \* @param string $hash The previously hashed password |
|  |  | \* |
|  |  | \* @deprecated This is only for backward compatibility. |
|  |  | \*/ |
|  |  | public function verifyDanger(string $password, string $hash): bool |
|  |  | { |
|  |  | return password\_verify(base64\_encode( |
|  |  | hash('sha384', $password, true) |
| Expand All | | @@ -72,7 +101,7 @@ public function verify(string $password, string $hash): bool |
|  |  | \*/ |
|  |  | public function needsRehash(string $hashedPassword): bool |
|  |  | { |
|  |  | return password\_needs\_rehash($hashedPassword, $this->config->hashAlgorithm); |
|  |  | return password\_needs\_rehash($hashedPassword, $this->config->hashAlgorithm, $this->getHashOptions()); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down  Expand Up | | @@ -110,4 +139,16 @@ public function check(string $password, ?User $user = null): Result |
|  |  | 'success' => true, |
|  |  | ]); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns the validation rule for max length. |
|  |  | \*/ |
|  |  | public static function getMaxLenghtRule(): string |
|  |  | { |
|  |  | if (config('Auth')->hashAlgorithm === PASSWORD\_BCRYPT) { |
|  |  | return 'max\_byte[72]'; |
|  |  | } |
|  |  |  |
|  |  | return 'max\_length[255]'; |
|  |  | } |
|  |  | } |

8 changes: 8 additions & 0 deletions

8
[src/Authentication/Passwords/ValidationRules.php](#diff-d0495d246982de14cb2329639948c0926d305633088b23f3f064b13b06a5c2c0 "src/Authentication/Passwords/ValidationRules.php")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/src/Authentication/Passwords/ValidationRules.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -55,6 +55,14 @@ public function strong\_password(string $value, ?string &$error1 = null, array $d |
|  |  | return $result->isOk(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Returns true if $str is $val or fewer bytes in length. |
|  |  | \*/ |
|  |  | public function max\_byte(?string $str, string $val): bool |
|  |  | { |
|  |  | return is\_numeric($val) && $val >= strlen($str ?? ''); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Builds a new user instance from the global request. |
|  |  | \*/ |
| Expand Down | |  |

10 changes: 10 additions & 0 deletions

10
[src/Config/Auth.php](#diff-c48af47762f5a9ba44e0e0b95dd538d48276cf1bc59a8c157bdcddc812184d54 "src/Config/Auth.php")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/src/Config/Auth.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -360,6 +360,16 @@ class Auth extends BaseConfig |
|  |  | \*/ |
|  |  | public int $hashCost = 10; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* If you need to support passwords saved in versions prior to Shield v1.0.0-beta.4. |
|  |  | \* set this to true. |
|  |  | \* |
|  |  | \* See https://github.com/codeigniter4/shield/security/advisories/GHSA-c5vj-f36q-p9vg |
|  |  | \* |
|  |  | \* @deprecated This is only for backward compatibility. |
|  |  | \*/ |
|  |  | public bool $supportOldDangerousPassword = false; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* //////////////////////////////////////////////////////////////////// |
|  |  | \* OTHER SETTINGS |
| Expand Down | |  |

8 changes: 6 additions & 2 deletions

8
[src/Controllers/LoginController.php](#diff-45e8260851b030d02dc4cfa31551801add09770d306c9a98f4afddf7c5db2539 "src/Controllers/LoginController.php")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/src/Controllers/LoginController.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,6 +7,7 @@ |
|  |  | use App\Controllers\BaseController; |
|  |  | use CodeIgniter\HTTP\RedirectResponse; |
|  |  | use CodeIgniter\Shield\Authentication\Authenticators\Session; |
|  |  | use CodeIgniter\Shield\Authentication\Passwords; |
|  |  | use CodeIgniter\Shield\Traits\Viewable; |
|  |  |  |
|  |  | class LoginController extends BaseController |
| Expand Down  Expand Up | | @@ -90,8 +91,11 @@ protected function getValidationRules(): array |
|  |  | 'rules' => config('AuthSession')->emailValidationRules, |
|  |  | ], |
|  |  | 'password' => [ |
|  |  | 'label' => 'Auth.password', |
|  |  | 'rules' => 'required', |
|  |  | 'label' => 'Auth.password', |
|  |  | 'rules' => 'required|' . Passwords::getMaxLenghtRule(), |
|  |  | 'errors' => [ |
|  |  | 'max\_byte' => 'Auth.errorPasswordTooLongBytes', |
|  |  | ], |
|  |  | ], |
|  |  | ]; |
|  |  | } |
| Expand Down | |  |

8 changes: 6 additions & 2 deletions

8
[src/Controllers/RegisterController.php](#diff-9e2889797f10c1aecf305385c88332cdd3898288b232e470b5b10662ead58383 "src/Controllers/RegisterController.php")

Show comments

[View file](/codeigniter4/shield/blob/ea9688dd01d100193d834117dbfc2cfabcf9ea0b/src/Controllers/RegisterController.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,6 +10,7 @@ |
|  |  | use CodeIgniter\HTTP\RequestInterface; |
|  |  | use CodeIgniter\HTTP\ResponseInterface; |
|  |  | use CodeIgniter\Shield\Authentication\Authenticators\Session; |
|  |  | use CodeIgniter\Shield\Authentication\Passwords; |
|  |  | use CodeIgniter\Shield\Config\Auth; |
|  |  | use CodeIgniter\Shield\Entities\User; |
|  |  | use CodeIgniter\Shield\Exceptions\ValidationException; |
| Expand Down  Expand Up | | @@ -195,8 +196,11 @@ protected function getValidationRules(): array |
|  |  | 'rules' => $registrationEmailRules, |
|  |  | ], |
|  |  | 'password' => [ |
|  |  | 'label' => 'Auth.password', |
|  |  | 'rules' => 'required|strong\_password', |
|  |  | 'label' => 'Auth.password', |
|  |  | 'rules' => 'required|' . Passwords::getMaxLenghtRule() . '|strong\_password', |
|  |  | 'errors' => [ |
|  |  | 'max\_byte' => 'Auth.errorPasswordTooLongBytes', |
|  |  | ], |
|  |  | ], |
|  |  | 'password\_confirm' => [ |
|  |  | 'label' => 'Auth.passwordConfirm', |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ea9688d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcodeigniter4%2Fshield%2Fcommit%2Fea9688dd01d100193d834117dbfc2cfabcf9ea0b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


