- **Root cause of vulnerability:** Envoy does not sanitize or escape request properties (specifically, downstream peer certificate Subject Alternative Name) when generating request headers, allowing characters illegal in header values to be sent to the upstream service.
- **Weaknesses/vulnerabilities present:** Improper input sanitization and lack of output escaping lead to HTTP request smuggling and bypass of security policies. Specifically, the vulnerability stems from the usage of `DOWNSTREAM_PEER_URI_SAN` without sanitization or escaping.
- **Impact of exploitation:** Allows attackers to inject illegal characters (like CR or LF) into headers, potentially causing upstream services to interpret the original request as two pipelined requests, bypassing Envoy's security policies. This can lead to request smuggling attacks and other unexpected behavior on the backend.
- **Attack vectors:** A specifically crafted HTTP request or mTLS connection with a malicious client certificate containing illegal characters in the Subject Alternative Name (SAN). The Envoy configuration must include an option to add request headers based on inputs from the request, such as the peer certificate SAN.
- **Required attacker capabilities/position:** The attacker needs to be able to craft an mTLS connection with a malicious client certificate. They do not need any special privileges on the Envoy instance itself. They must also be able to initiate requests that reach the vulnerable Envoy instance. The attacker requires the ability to create a malicious certificate with crafted SAN.