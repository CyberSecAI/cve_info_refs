=== Content from blog.inhq.net_3e8d1cc3_20250114_181909.html ===
![](https://mato.inhq.net/m?rec=1&bots=1&idsite=1)[invd blog](/)

[Archive](/archive/)[CVEs](/cve/)[Consulting](/consulting/)[About](/about/)

# KeepKey Memory Exfiltration Vulnerability (CVE-2023-27892)

Apr 17, 2023
â¢
Christian Reitter
ID:
CVE-2023-27892

Related articles:
[KeepKey Supervisor Vulnerabilities (CVE-2022-30330)](/posts/keepkey-CVE-2022-30330/)
â¢ [KeepKey Message State Handling Vulnerability (VULN-22003)](/posts/keepkey-VULN-22003/)
â¢ [Glitching over KeepKey Firmware Protections (VULN-21020)](/posts/keepkey-glitching-vuln-21020/)

The article describes a new vulnerability in the KeepKey hardware wallet.
Vulnerable code in the Ethereum transaction handling can leak memory from attacker-controlled address locations onto the display when processing a crafted EthereumSignTx message.
An attacker with physical access to an unlocked KeepKey device can extract the BIP39 seed or other confidential device secrets via this flaw without tampering with the device hardware or leaving permanent traces.

## Contents

* [The Vulnerability](#the-vulnerability)
  + [Attacker-Controlled Out-of-bounds Read (CVE-2023-27892)](#attacker-controlled-out-of-bounds-read-cve-2023-27892)
  + [Additional Attack Considerations](#additional-attack-considerations)
  + [POC](#poc)
* [Coordinated disclosure](#coordinated-disclosure)
  + [Relevant product](#relevant-product)
  + [A Note About Research Affiliation and Work Time](#a-note-about-research-affiliation-and-work-time)
  + [Detailed timeline](#detailed-timeline)
  + [Bug bounty](#bug-bounty)
## Consulting

*Iâm a freelance Security Consultant and currently available for new projects.
If you are looking for assistance to secure your projects or organization, [contact me](/consulting).*

## The Vulnerability

![Annotated photo of KeepKey with successful leak of BIP39 seed portion (details described in PoC section)](/assets/images/resized/600/keepkey_cve-2023-27892_poc_data_seed1_payload1_overlay1.jpg)

Annotated photo of KeepKey with successful leak of BIP39 seed portion (details described in PoC section)

### Attacker-Controlled Out-of-bounds Read (CVE-2023-27892)

This section outlines how Ethereum-related processing code introduced with firmware `v7.5.2` can be used as an arbitrary read gadget to display confidential device memory on the OLED screen, which violates security goals.

Once an attacker sends a special Ethereum signing request message, the following code path in `ethereum_signing_init()` can be triggered:

```
if (!ethereum_cFuncConfirmed(data_total, msg)) {
```

[ethereum.c L715](https://github.com/keepkey/keepkey-firmware/blob/f946abf7cb089564a6a0de649a9d310179215135/lib/firmware/ethereum.c#L715)

This calls the recently added `cf_confirmExecTx()` function via the short intermediary function `ethereum_cFuncConfirmed()`:

```
bool ethereum_cFuncConfirmed(uint32_t data_total, const EthereumSignTx *msg) {
   if (cf_isExecTx(msg)) {
     return cf_confirmExecTx(data_total, msg);
```

[ethereum\_contracts.c L38-L40](https://github.com/keepkey/keepkey-firmware/blob/32ec2f79ce70d3d2de7024db91ade7d3f054f31e/lib/firmware/ethereum_contracts.c#L38-L40)

The code vulnerability is located in `cf_confirmExecTx()`.

Before we dig deeper, first some context on this section of the firmware.

On an abstract level, the code for Ethereum transaction confirmation functionality is supposed to

* Parse the incoming attacker-controlled `EthereumSignTx *msg` request received via USB from the host computer.
* Show several important transaction details on the device screen for secure confirmation by the human operator independent of the untrusted host computer.

Subsequent code stages then perform the actual Ethereum transaction signing, but they are not relevant to understanding this issue.

The confirmation flow in question has multiple stages to display and approve the individual components of the transaction:

1. Call `confirm(ButtonRequestType_ButtonRequest_ConfirmOutput, ...)` on the decoded receiver *address*.
2. Repeat this action on the decoded transfer *amount*.
3. Display a dynamic amount of *raw data* in the parsed request message in hexadecimal encoding on the OLED display, with pagination if needed.

It is at the third step where things go bad. ð©

Here is the problematic code section:

```
// get data bytes
bn_from_bytes(msg->data_initial_chunk.bytes + 4 + 2*32, 32, &bnNum);        // data offset
offset = bn_write_uint32(&bnNum);
bn_from_bytes(msg->data_initial_chunk.bytes + 4 + offset, 32, &bnNum);      // data len
dlen = bn_write_uint32(&bnNum);
data = (uint8_t *)(msg->data_initial_chunk.bytes + 4 + 32 + offset);
```

[contractfuncs.c L68-L73](https://github.com/keepkey/keepkey-firmware/blob/32ec2f79ce70d3d2de7024db91ade7d3f054f31e/lib/firmware/ethereum_contracts/contractfuncs.c#L68-L73)

The goal of the listed code instructions is to prepare the `uint8_t* data` pointer and `uint32_t dlen` length variables of the data that should be printed. The display logic then uses them to show hexadecimal encoded text versions of the referenced data payload in the Ethereum transaction message to the user. Due to the limited screen size, the conversion and screen dialog operates on paginated chunks.

Display logic:

```
n = 1;
chunkSize = 39;
while (true) {
    chunk=chunkSize*(n-1);
    for (ctr=chunk; ctr<chunkSize+chunk && ctr<dlen; ctr++) {
        snprintf(&confStr[(ctr-chunk)*2], 3, "%02x", data[ctr]);
    }
    if (!confirm(ButtonRequestType_ButtonRequest_ConfirmOutput,
              title, "Data payload %d: %s", n, confStr)) {
        return false;
    }
    if (ctr >= dlen) {
        break;
    }
    n++;
}
```

[contractfuncs.c L75-L90](https://github.com/keepkey/keepkey-firmware/blob/32ec2f79ce70d3d2de7024db91ade7d3f054f31e/lib/firmware/ethereum_contracts/contractfuncs.c#L75-L90)

The crucial mistake in the message parsing logic is the **lack of range checks** for the variables. Both `uint32_t offset` and `uint32_t dlen` are assigned and used without ensuring that the referenced memory region is firmly within the `msg->data_initial_chunk.bytes` payload section. This leads to serious problems!

Letâs walk through one of the problematic assignments in more detail:

```
bn_from_bytes(msg->data_initial_chunk.bytes + 4 + 2*32, 32, &bnNum);        // data offset
offset = bn_write_uint32(&bnNum);
```

[contractfuncs.c L69-L70](https://github.com/keepkey/keepkey-firmware/blob/32ec2f79ce70d3d2de7024db91ade7d3f054f31e/lib/firmware/ethereum_contracts/contractfuncs.c#L69-L70)

In simplified terms, the combination of `void bn_from_bytes(const uint8_t *value, size_t value_len, bignum256 *val)` and `uint32_t bn_write_uint32(const bignum256 *in_number)` reads an `uint32_t` value from a particular memory location without imposing any additional range limitations on the resulting number. In the code snippet shown above, the number conversion first reads a 256 bit bignum number from a fixed byte offset within `msg->data_initial_chunk.bytes` and then assigns the least significant four bytes to `offset`, discarding the rest of the input.

A similar operation happens for the `dlen` read, but from a flexible offset location (more on this later).

Itâs important to remember that the Ethereum transfer request message comes from an untrusted source - the computer acting as the USB host could be compromised by malware, which is the reason behind showing the user confirmation steps on the hardware wallet display in the first place. In this particular code branch of Ethereum transaction signing, the format validation functions run before `cf_confirmExecTx()` impose no meaningful limitations on the `msg->data_initial_chunk.bytes` content.

To summarize, `msg->data_initial_chunk.bytes` passes over a trust boundary, isnât validated to any strict specification, and then used without sufficient length checks.

An attacker with control over the message content can exploit the unbounded conversion flaws in two general ways:

1. Set a large `uint32_t offset` value, use it to move the `data` pointer, and leak content from an arbitrary memory location.
2. Set a small `uint32_t offset` value, control `uint32_t dlen`, and run the memory printing function arbitrarily far beyond the packet buffer.

In both cases, the previously quoted display logic will trigger `confirm()` dialogs that leak raw memory from out-of-bounds regions via `snprintf()` to the KeepKey device OLED screen. Thatâs a pretty powerful attack gadget on a hardware wallet, which is supposed to avoid data leaks at all costs!

The following attack description will focus on direct `data` pointer control via large `offset` values (variant no. 1), which Iâve found to be more powerful and practical for manual attacks without physical automation. Itâs simpler to leak an interesting memory region directly on the screen in a few display pages, compared to setting an oversized `dlen` length and manually cycling through thousands of display pages before arriving there.

Digging deeper into the code behavior, we can see that the attacker can force arbitrary pointer addresses for `data`. Due to the unsigned integer overflow wrapping, the `msg->data_initial_chunk.bytes + 4 + 32 + offset` calculation can end up with any address in front of or behind `msg->data_initial_chunk.bytes`! To make matters worse for the defenders, `msg->data_initial_chunk.bytes` is at a static and well-known absolute address. The currently processed Ethereum message will always be located in a special decode buffer after it is converted from the protobuf wire format:

```
static void dispatch(const MessagesMap_t *entry, uint8_t *msg,
                     uint32_t msg_size) {
  static uint8_t decode_buffer[MAX_DECODE_SIZE] __attribute__((aligned(4)));
```

[messages.c L122-L124](https://github.com/keepkey/keepkey-firmware/blob/f946abf7cb089564a6a0de649a9d310179215135/lib/board/messages.c#L122-L124)

Since `decode_buffer[]` is a static global variable and the ARM Cortex-M3 platform has no address space layout randomization, the buffer and the `msg->data_initial_chunk.bytes` struct field will always be located at the same absolute memory location for a given firmware version. This allows attackers precise and reliable exploitation of this issue without the need for guesses or usage of other information leaks.

For attacks that intend to read out a specific, narrow memory region via crafted `offset` values, the last remaining obstacle is the limited attacker control over `dlen` when manipulating `data`.
By picking crafted `offset` values in the attack message which move `data` towards other microcontroller memory outside of the message buffer, the `dlen`-defining read operation moves there as well:

```
bn_from_bytes(msg->data_initial_chunk.bytes + 4 + offset, 32, &bnNum);      // data len
dlen = bn_write_uint32(&bnNum);
```

[contractfuncs.c L71-L72](https://github.com/keepkey/keepkey-firmware/blob/32ec2f79ce70d3d2de7024db91ade7d3f054f31e/lib/firmware/ethereum_contracts/contractfuncs.c#L71-L72)

Unfortunately for the defenders, this is drawback can be worked around since the bignum data read logic and display code is very forgiving and will treat basically any data as a meaningful length field.
The attackers can simply point to a memory region slightly in front of the targeted data that is known to have *some* non-null data bytes in the 4 byte window of `dlen`. As long as the converted `dlen` value is at least as large as the desired data readout section, the resulting memory readout will successful leaks all relevant data after some pagination.

For edge cases where `dlen` is unexpectedly small, the display code runs into another failure mode and leaks previously used *stack* memory via the unitialized `char confStr[131];` variable. However, compared to the arbitrary read gadget of specific memory address contents, this is not nearly as interesting or powerful.
Similarly, the attacker can set `offset` such that display reads will access forbidden memory regions and cause a crash. Given the requirements of this attack, this exploitation variant is also not of much interest, but technically part of the potential impact.

### Additional Attack Considerations

The problematic functionality can be triggered by local or remote attackers once the device is in an unlocked state (if a PIN is set on the target device) and the user physically confirms at least some steps of an Ethereum signing flow. The most limiting factor in the attack is that the secret information is only rendered on the physical KeepKey display as hexadecimal-encoded data and not leaked back towards the host computer.

The latter behavior is due to the `confirm()` handler at [confirm\_sm.c](https://github.com/keepkey/keepkey-firmware/blob/efc7e7239cf8c6c80a24cb49010ba884ded4825d/lib/board/confirm_sm.c#L309-L314) which does *not* make use of the `data` field in the `ButtonRequest` message and therefore does *not* send the displayed string towards the computer, where malware could read it after tricking the user to confirm a supposedly low-value Ethereum transaction.

```
message ButtonRequest {
  optional ButtonRequestType code = 1;
  optional string data = 2;
}
```

[messagemap.def L78](https://github.com/keepkey/keepkey-firmware/blob/d3047c43eb701536663c4a4da23c88db796518f8/lib/firmware/messagemap.def#L78)

As with other KeepKey USB related vulnerabilities, a malicious website with user-granted WebUSB permissions could trigger this issue. However, in this particular vulnerability there is no return channel for the leaked information, so additional physical capabilities by the attacker are needed. Under some edge conditions, social engineering may be used to trick the victim user of the KeepKey to *voluntarily* copy or photograph the leaked information from the device screen, but I see this as difficult to achieve reliably given the circumstances.

From a threat model perspective, I see this vulnerability as relevant despite the high attack requirements since it undermines both the implicit and explicit security guarantees of the hardware wallet with regards to the confidentiality of long-term cryptographic key material.

One of the affected mechanisms is an advanced wallet initialization mode of the KeepKey wallet which doesnât reveal the generated BIP39 mnemonic seed to the user at any point, see [lib/firmware/reset.c](https://github.com/keepkey/keepkey-firmware/blob/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870/lib/firmware/reset.c#L68-L84). Wallets initialized with this mode permanently have the `no_backup` flag set to true, and the communicated goal is to make a *recovery* of the key impossible. The demonstrated attack for CVE-2023-27892 clearly violates this goal, as the `no_backup` flag stays unchanged despite the revealed secret.

Similarly, wallet users may have the expectation that the effects of hands-on attacks against their wallet have to be immediate, i.e., the transfer of funds during the attack, or that attacks are only possible if the unlocked wallet already has significant funds available at the time of the attack. While this doesnât have to be correct 100% from the technical side, for example since attackers could delay the submission of their illegitimately obtained signed transactions to public networks, access to the underlying BIP39 seed by the attacker certainly allows for much more flexible and targeted theft months or years later across various coins, wallet accounts and addresses. In the case of wallets which were temporarily less protected - no PIN configured, accessible to other people, left connected to an unlocked and unsupervised computer for some minutes - this could make a significant difference in practical risk over the multi-year lifetime of a typical BIP39 seed.

Finally, thereâs also the consideration with regards to *BIP39 passphrases*, which are an additional and highly recommended safety layer on top of the BIP39 mnemonic words to prevent the theft of funds. CVE-2023-27892 opens the door for two particular attacks against passphrases. If a given hardware wallet is accessed/stolen by the attacker due to lack of PIN protection (or by using a known PIN), even a moderately complex passphrase could prevent an attacker from discovering and using the custom passphrase-based wallet that holds some additional funds. An online brute-force attack against possible passphrases using the built-in firmware mechanisms is significantly rate-limited due to slow APIs, limited microcontroller processor speed for derivations as well as physical confirmation steps, which results in very limited attack capabilities. Using CVE-2023-27892, an attacker can obtain the BIP39 seed and then scale offline brute-force attacks to an arbitrary number of powerful systems, making it much more feasible to determine the correct derivation with e.g., a dictionary-based attack.
In rare scenarios where the attacker temporarily gets access to a hardware wallet that is not just plugged in and unlocked, but also has a sensitive passphrase cached in-memory, the passphrase may also be revealed directly. This also applies to other volatile secrets in memory such as the PIN, but note that auto-locking and other functionality may interfere with this.

To summarize, CVE-2023-27892 does not benefit attackers who steal a PIN-protected KeepKey that is powered off, but significantly increases attacker capabilities for delayed theft, circumvention of `no_backup` mode guarantees, and enables BIP39 passphrase brute-forcing or direct retrieval as well as other attacks in case of temporarily unprotected and unsupervised devices.

Also noteworthy: this security issue may be beneficial to legitimate owners who have partially or completely forgotten/lost essential secrets of their configured devices. Under some conditions, it may be possible to recover secrets that are still in the device (see the previous paragraphs). Leveraging firmware up- and downgrade capability between vendor-signed official firmwares without the mandatory erasure of BIP39 seed secrets could help with this (*disclaimer: perform at your own risk*!). Iâm looking forward to [feedback](/about) from users in case this security research was helpful in particular recovery cases.

### POC

**WARNING: use the provided PoC code at your own risk. The instructions will PERMANENTLY overwrite the configuration of the hardware wallet. Only test with an expendable unit.**

1. Prepare the target KeepKey with a well-known BIP39 seed.
    In the following example, this is done via `keepkeyctl wipe_device` and `keepkeyctl load_device -l "poc_test" -m` **`"keep key program problem process input result memory display defense broken inform"`**, which is a custom seed with a valid checksum.
2. Ensure the target KeepKey has the firmware `v7.5.2`, which the PoC is prepared for.
3. Ensure a working Python3 environment with the `pyusb` module installed.
4. Re-connect and PIN-unlock the target KeepKey to simulate the targeted scenario.
5. Run the [BIP39 seed extraction PoC](/assets/artifacts/cve-2023-27892/PoC_CVE-2023-27892_seed_exfiltration1.py) with sufficient permissions for USB access.
6. Confirm the Ethereum transaction dialogs until data payload information is shown.
7. Transcribe the hex-encoded ASCII data to obtain the revealed seed information, and skip through additional pages to reveal additional parts of the seed data.
   In the example, the `Data payload #1` reveals **`ep key program problem process input`**  and the **`Data payload #2` page reveals `result memory display defense broken in`**, with additional data following on the third page.
8. The revealed information is sufficient to fully recover the configured BIP39 secret.
9. Also see the PoC code documentation for additional context.

## Coordinated disclosure

This disclosure was marked by significant delays and missing feedback when communicating with the vendor (KeepKey). Initially, they created a public patch for the issue on GitHub but did not respond to the confidential disclosure. After three weeks and two reminders, I got a direct response and technical confirmation, but then the contact broke off again and didnât resume after multiple followups. Despite releasing public security patches and issuing a firmware release, Iâm not aware of any public security notes or advisory by the vendor on this issue at the time of publishing of this blog post. This is a further regression of disclosure handling over the last disclosure process [CVE-2022-30330](/posts/keepkey-CVE-2022-30330/) with this vendor in 2022, and may be related to ownership and team changes of the KeepKey product.

In summary, the overall coordinated disclosure progress and publication handling was neither motivating on the researcher side nor overall adequate in my opinion.

In future disclosures, Iâll consider releasing my disclosure information sooner in cases where vendors silently fix security issues during the disclosure period, depending on the patch publication and software release circumstances.

### Relevant product

| Product | Source | Known Affected Version | Fixed Version | Patch | Vendor Publications | IDs |
| --- | --- | --- | --- | --- | --- | --- |
| KeepKey | [GitHub](https://github.com/keepkey/keepkey-firmware/) | firmware `v.7.5.2` to `v7.6.0` | `v7.7.0` | [PR337](https://github.com/keepkey/keepkey-firmware/pull/337) | none | [CVE-2023-27892](https://www.cve.org/CVERecord?id=CVE-2023-27892) |

### A Note About Research Affiliation and Work Time

I want to emphasize that this research was done on my own time and initiative.
In particular, it was not sponsored by SatoshiLabs, for whom I do some paid freelance security research on the related Trezor project.

### Detailed timeline

| Date | Information |
| --- | --- |
| 2023-01-17 | Confidential disclosure to KeepKey |
| 2023-01-26 | KeepKey publishes GitHub Pull Request no. 337 with security patch |
| 2023-01-29 | POC and additional analysis communicated to KeepKey |
| 2023-02-05 | Followup email to KeepKey requesting feedback |
| 2023-02-06 | Issue confirmation by KeepKey |
| 2023-02-22 | GitHub Pull Request no. 337 is merged |
| 2023-03-06 | MITRE assigns requested CVE |
| 2023-03-07 | Release of KeepKey firmware `v7.7.0` with security patch |
| 2023-04-17 | End of disclosure period |
| 2023-04-17 | Publication of this report |
| 2023-04-19 | Report: âAdditional Attack Considerationsâ section extended |

### Bug bounty

At the time of the report publication, KeepKey has not offered a bug bounty.

* **Christian Reitter**

Information security and other interests.



=== Content from github.com_82f2069c_20250115_112220.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2Fblob%2F930d6ada7a15b3fd00bfef78ec855ae6fa7cc870%2Flib%2Ffirmware%2Freset.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2Fblob%2F930d6ada7a15b3fd00bfef78ec855ae6fa7cc870%2Flib%2Ffirmware%2Freset.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=keepkey%2Fkeepkey-firmware)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[keepkey](/keepkey)
/
**[keepkey-firmware](/keepkey/keepkey-firmware)**
Public

* [Notifications](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware) You must be signed in to change notification settings
* [Fork
  103](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)
* [Star
   157](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)

* [Code](/keepkey/keepkey-firmware)
* [Issues
  14](/keepkey/keepkey-firmware/issues)
* [Pull requests
  0](/keepkey/keepkey-firmware/pulls)
* [Actions](/keepkey/keepkey-firmware/actions)
* [Security](/keepkey/keepkey-firmware/security)
* [Insights](/keepkey/keepkey-firmware/pulse)

Additional navigation options

* [Code](/keepkey/keepkey-firmware)
* [Issues](/keepkey/keepkey-firmware/issues)
* [Pull requests](/keepkey/keepkey-firmware/pulls)
* [Actions](/keepkey/keepkey-firmware/actions)
* [Security](/keepkey/keepkey-firmware/security)
* [Insights](/keepkey/keepkey-firmware/pulse)

## Files

 930d6ad
## Breadcrumbs

1. [keepkey-firmware](/keepkey/keepkey-firmware/tree/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870)
2. /[lib](/keepkey/keepkey-firmware/tree/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870/lib)
3. /[firmware](/keepkey/keepkey-firmware/tree/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870/lib/firmware)
/
# reset.c

Copy path Blame  Blame
## Latest commit

## History

[History](/keepkey/keepkey-firmware/commits/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870/lib/firmware/reset.c)274 lines (234 loc) · 9.14 KB 930d6ad
## Breadcrumbs

1. [keepkey-firmware](/keepkey/keepkey-firmware/tree/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870)
2. /[lib](/keepkey/keepkey-firmware/tree/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870/lib)
3. /[firmware](/keepkey/keepkey-firmware/tree/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870/lib/firmware)
/
# reset.c

Top
## File metadata and controls

* Code
* Blame

274 lines (234 loc) · 9.14 KB[Raw](https://github.com/keepkey/keepkey-firmware/raw/930d6ada7a15b3fd00bfef78ec855ae6fa7cc870/lib/firmware/reset.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274/\* \* This file is part of the TREZOR project. \* \* Copyright (C) 2014 Pavol Rusnak <stick@satoshilabs.com> \* \* This library is free software: you can redistribute it and/or modify \* it under the terms of the GNU Lesser General Public License as published by \* the Free Software Foundation, either version 3 of the License, or \* (at your option) any later version. \* \* This library is distributed in the hope that it will be useful, \* but WITHOUT ANY WARRANTY; without even the implied warranty of \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \* GNU Lesser General Public License for more details. \* \* You should have received a copy of the GNU Lesser General Public License \* along with this library. If not, see <http://www.gnu.org/licenses/>. \*/
#include "keepkey/board/confirm\_sm.h"#include "keepkey/board/keepkey\_board.h"#include "keepkey/board/messages.h"#include "keepkey/board/util.h"#include "keepkey/firmware/fsm.h"#include "keepkey/firmware/home\_sm.h"#include "keepkey/firmware/pin\_sm.h"#include "keepkey/firmware/reset.h"#include "keepkey/firmware/storage.h"#include "keepkey/rand/rng.h"#include "keepkey/transport/interface.h"#include "trezor/crypto/bip39.h"#include "trezor/crypto/memzero.h"#include "trezor/crypto/rand.h"#include "trezor/crypto/sha2.h"
#include <stdio.h>
#define \_(X) (X)
static uint32\_t strength;static uint8\_t CONFIDENTIAL int\_entropy[32];static bool awaiting\_entropy = false;static char CONFIDENTIAL current\_words[MNEMONIC\_BY\_SCREEN\_BUF];static bool no\_backup;
void reset\_init(bool display\_random, uint32\_t \_strength, bool passphrase\_protection, bool pin\_protection, const char \*language, const char \*label, bool \_no\_backup, uint32\_t \_auto\_lock\_delay\_ms, uint32\_t \_u2f\_counter) { if (\_strength != 128 && \_strength != 192 && \_strength != 256) { fsm\_sendFailure( FailureType\_Failure\_SyntaxError, \_("Invalid mnemonic strength (has to be 128, 192 or 256 bits)")); layoutHome(); return; }
 strength = \_strength; no\_backup = \_no\_backup;
 if (display\_random && no\_backup) { fsm\_sendFailure(FailureType\_Failure\_SyntaxError, \_("Can't show internal entropy when backup is skipped")); layoutHome(); return; }
 if (no\_backup) { // Double confirm, since this is a feature for advanced users only, and // there is risk of loss of funds if this mode is used incorrectly // (i.e. multisig is an absolute must with this scheme). if (!confirm(ButtonRequestType\_ButtonRequest\_Other, \_("WARNING"), \_("The 'No Backup' option was selected.\n" "Recovery sentence will \*NOT\* be shown,\n" "and recovery will be IMPOSSIBLE.\n")) || !confirm(ButtonRequestType\_ButtonRequest\_Other, \_("WARNING"), \_("The 'No Backup' option was selected.\n\n" "I understand, and accept the risks.\n"))) { fsm\_sendFailure(FailureType\_Failure\_ActionCancelled, \_("Reset cancelled")); layoutHome(); return; } }
 random\_buffer(int\_entropy, 32);
 if (display\_random) { static char CONFIDENTIAL ent\_str[4][17]; data2hex(int\_entropy, 8, ent\_str[0]); data2hex(int\_entropy + 8, 8, ent\_str[1]); data2hex(int\_entropy + 16, 8, ent\_str[2]); data2hex(int\_entropy + 24, 8, ent\_str[3]);
 if (!confirm(ButtonRequestType\_ButtonRequest\_ResetDevice, \_("Internal Entropy"), "%s %s %s %s", ent\_str[0], ent\_str[1], ent\_str[2], ent\_str[3])) { memzero(ent\_str, sizeof(ent\_str)); fsm\_sendFailure(FailureType\_Failure\_ActionCancelled, \_("Reset cancelled")); layoutHome(); return; } memzero(ent\_str, sizeof(ent\_str)); }
 if (pin\_protection) { if (!change\_pin()) { fsm\_sendFailure(FailureType\_Failure\_ActionCancelled, \_("PINs do not match")); layoutHome(); return; } } else { storage\_setPin(""); }
 storage\_setPassphraseProtected(passphrase\_protection); storage\_setLanguage(language); storage\_setLabel(label); storage\_setAutoLockDelayMs(\_auto\_lock\_delay\_ms); storage\_setU2FCounter(\_u2f\_counter);
 EntropyRequest resp; memset(&resp, 0, sizeof(EntropyRequest)); msg\_write(MessageType\_MessageType\_EntropyRequest, &resp); awaiting\_entropy = true;}
void reset\_entropy(const uint8\_t \*ext\_entropy, uint32\_t len){ if(!awaiting\_entropy) { fsm\_sendFailure(FailureType\_Failure\_UnexpectedMessage, \_("Not in Reset mode")); return; }
 SHA256\_CTX ctx; sha256\_Init(&ctx); sha256\_Update(&ctx, int\_entropy, 32); sha256\_Update(&ctx, ext\_entropy, len); sha256\_Final(&ctx, int\_entropy);
 const char \*temp\_mnemonic = mnemonic\_from\_data(int\_entropy, strength / 8);
 memzero(int\_entropy, sizeof(int\_entropy)); awaiting\_entropy = false;
 if (no\_backup) { storage\_setNoBackup(); storage\_setMnemonic(temp\_mnemonic); mnemonic\_clear(); storage\_commit(); fsm\_sendSuccess(\_("Device reset")); goto exit; } else { if (!confirm(ButtonRequestType\_ButtonRequest\_Other, \_("Recovery Seed Backup"), "This recovery seed will only be shown ONCE. " "Please write it down carefully,\n" "and DO NOT share it with anyone. ")) { fsm\_sendFailure(FailureType\_Failure\_ActionCancelled, \_("Reset cancelled")); storage\_reset(); layoutHome(); return; } }
 /\* \* Format mnemonic for user review \*/ uint32\_t word\_count = 0, page\_count = 0; static char CONFIDENTIAL tokened\_mnemonic[TOKENED\_MNEMONIC\_BUF]; static char CONFIDENTIAL mnemonic\_by\_screen[MAX\_PAGES][MNEMONIC\_BY\_SCREEN\_BUF]; static char CONFIDENTIAL formatted\_mnemonic[MAX\_PAGES][FORMATTED\_MNEMONIC\_BUF]; static char CONFIDENTIAL mnemonic\_display[FORMATTED\_MNEMONIC\_BUF]; static char CONFIDENTIAL formatted\_word[MAX\_WORD\_LEN + ADDITIONAL\_WORD\_PAD];
 strlcpy(tokened\_mnemonic, temp\_mnemonic, TOKENED\_MNEMONIC\_BUF);
 char \*tok = strtok(tokened\_mnemonic, " ");
 while(tok) { snprintf(formatted\_word, MAX\_WORD\_LEN + ADDITIONAL\_WORD\_PAD, (word\_count & 1) ? "%lu.%s\n" : "%lu.%s", (unsigned long)(word\_count + 1), tok);
 /\* Check that we have enough room on display to show word \*/ snprintf(mnemonic\_display, FORMATTED\_MNEMONIC\_BUF, "%s %s", formatted\_mnemonic[page\_count], formatted\_word);
 if(calc\_str\_line(get\_body\_font(), mnemonic\_display, BODY\_WIDTH) > 3) { page\_count++;
 if (MAX\_PAGES <= page\_count) { fsm\_sendFailure(FailureType\_Failure\_Other, \_("Too many pages of mnemonic words")); storage\_reset(); goto exit; }
 snprintf(mnemonic\_display, FORMATTED\_MNEMONIC\_BUF, "%s %s", formatted\_mnemonic[page\_count], formatted\_word); }
 strlcpy(formatted\_mnemonic[page\_count], mnemonic\_display, FORMATTED\_MNEMONIC\_BUF);
 /\* Save mnemonic for each screen \*/ if(strlen(mnemonic\_by\_screen[page\_count]) == 0) { strlcpy(mnemonic\_by\_screen[page\_count], tok, MNEMONIC\_BY\_SCREEN\_BUF); } else { strlcat(mnemonic\_by\_screen[page\_count], " ", MNEMONIC\_BY\_SCREEN\_BUF); strlcat(mnemonic\_by\_screen[page\_count], tok, MNEMONIC\_BY\_SCREEN\_BUF); }
 tok = strtok(NULL, " "); word\_count++; }
 // Switch from 0-indexing to 1-indexing page\_count++;
 display\_constant\_power(true);
 /\* Have user confirm mnemonic is sets of 12 words \*/ for(uint32\_t current\_page = 0; current\_page < page\_count; current\_page++) { char title[MEDIUM\_STR\_BUF] = \_("Backup");
 /\* make current screen mnemonic available via debuglink \*/ strlcpy(current\_words, mnemonic\_by\_screen[current\_page], MNEMONIC\_BY\_SCREEN\_BUF);
 if(page\_count > 1) { /\* snprintf: 20 + 10 (%d) + 1 (NULL) = 31 \*/ snprintf(title, MEDIUM\_STR\_BUF, \_("Backup %" PRIu32 "/%" PRIu32 ""), current\_page + 1, page\_count); }
 if(!confirm\_constant\_power(ButtonRequestType\_ButtonRequest\_ConfirmWord, title, "%s", formatted\_mnemonic[current\_page])) { fsm\_sendFailure(FailureType\_Failure\_ActionCancelled, \_("Reset cancelled")); storage\_reset(); goto exit; } }
 /\* Save mnemonic \*/ storage\_setMnemonic(temp\_mnemonic); mnemonic\_clear(); storage\_commit(); fsm\_sendSuccess(\_("Device reset"));
exit: memzero(&ctx, sizeof(ctx)); memzero(tokened\_mnemonic, sizeof(tokened\_mnemonic)); memzero(mnemonic\_by\_screen, sizeof(mnemonic\_by\_screen)); memzero(formatted\_mnemonic, sizeof(formatted\_mnemonic)); memzero(mnemonic\_display, sizeof(mnemonic\_display)); memzero(formatted\_word, sizeof(formatted\_word)); layoutHome();}
#if DEBUG\_LINKuint32\_t reset\_get\_int\_entropy(uint8\_t \*entropy) { memcpy(entropy, int\_entropy, 32); return 32;}
const char \*reset\_get\_word(void) { return current\_words; }#endif

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_aac5c3da_20250115_112218.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2Fpull%2F337)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2Fpull%2F337)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=keepkey%2Fkeepkey-firmware)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[keepkey](/keepkey)
/
**[keepkey-firmware](/keepkey/keepkey-firmware)**
Public

* [Notifications](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware) You must be signed in to change notification settings
* [Fork
  103](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)
* [Star
   157](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)

* [Code](/keepkey/keepkey-firmware)
* [Issues
  14](/keepkey/keepkey-firmware/issues)
* [Pull requests
  0](/keepkey/keepkey-firmware/pulls)
* [Actions](/keepkey/keepkey-firmware/actions)
* [Security](/keepkey/keepkey-firmware/security)
* [Insights](/keepkey/keepkey-firmware/pulse)

Additional navigation options

* [Code](/keepkey/keepkey-firmware)
* [Issues](/keepkey/keepkey-firmware/issues)
* [Pull requests](/keepkey/keepkey-firmware/pulls)
* [Actions](/keepkey/keepkey-firmware/actions)
* [Security](/keepkey/keepkey-firmware/security)
* [Insights](/keepkey/keepkey-firmware/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fkeepkey%2Fkeepkey-firmware%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# remove obsolete cfunc code #337

 Merged

[pastaghost](/pastaghost)
merged 1 commit into
[master](/keepkey/keepkey-firmware/tree/master "keepkey/keepkey-firmware:master")
from
[fix-remove-cfunc](/keepkey/keepkey-firmware/tree/fix-remove-cfunc "keepkey/keepkey-firmware:fix-remove-cfunc")

Feb 22, 2023

 Merged

# [remove obsolete cfunc code](#top) #337

[pastaghost](/pastaghost)
merged 1 commit into
[master](/keepkey/keepkey-firmware/tree/master "keepkey/keepkey-firmware:master")
from
[fix-remove-cfunc](/keepkey/keepkey-firmware/tree/fix-remove-cfunc "keepkey/keepkey-firmware:fix-remove-cfunc")

Feb 22, 2023

[Conversation
0](/keepkey/keepkey-firmware/pull/337)
[Commits
1](/keepkey/keepkey-firmware/pull/337/commits)
[Checks
0](/keepkey/keepkey-firmware/pull/337/checks)
[Files changed](/keepkey/keepkey-firmware/pull/337/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![markrypt0](https://avatars.githubusercontent.com/u/91701444?s=60&v=4)](/markrypt0)

Copy link

Collaborator

### @markrypt0 **[markrypt0](/markrypt0)** commented [Jan 26, 2023](#issue-1558501486)

 *No description provided.*

Sorry, something went wrong.

All reactions

[![@markrypt0](https://avatars.githubusercontent.com/u/91701444?s=40&v=4)](/markrypt0)

`[remove obsolete cfunc code](/keepkey/keepkey-firmware/pull/337/commits/eced04187074718c77d2a1085264b31093435535 "remove obsolete cfunc code")`

`[eced041](/keepkey/keepkey-firmware/pull/337/commits/eced04187074718c77d2a1085264b31093435535)`

 [![@markrypt0](https://avatars.githubusercontent.com/u/91701444?s=40&u=efed85290c3ae7e0863471bc3c8b465fefb02213&v=4)](/markrypt0)
[markrypt0](/markrypt0)
requested a review
from [pastaghost](/pastaghost)
as a [code owner](/keepkey/keepkey-firmware/blob/f1c6345598202166685bf5074530d34f41ebd794/.github/CODEOWNERS#L1)
[January 26, 2023 17:24](#event-8366251397)

[![pastaghost](https://avatars.githubusercontent.com/u/62026038?s=60&v=4)](/pastaghost)

**[pastaghost](/pastaghost)**
approved these changes
[Feb 22, 2023](#pullrequestreview-1308535562)

 [View reviewed changes](/keepkey/keepkey-firmware/pull/337/files/eced04187074718c77d2a1085264b31093435535)

[![@pastaghost](https://avatars.githubusercontent.com/u/62026038?s=40&u=bce9fe28a0ba97b19a1c0e396501ae7ca350a2b1&v=4)](/pastaghost)
[pastaghost](/pastaghost)
merged commit [`2d9f039`](/keepkey/keepkey-firmware/commit/2d9f039b017455131dd905e016dfb44ac5b5a83d)
into
master

[Feb 22, 2023](https://github.com/keepkey/keepkey-firmware/pull/337#event-8577189463)

 [![@pastaghost](https://avatars.githubusercontent.com/u/62026038?s=40&u=bce9fe28a0ba97b19a1c0e396501ae7ca350a2b1&v=4)](/pastaghost)
[pastaghost](/pastaghost)
deleted the
fix-remove-cfunc

branch
[February 22, 2023 05:12](#event-8577192680)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2Fpull%2F337)

Reviewers

[![@pastaghost](https://avatars.githubusercontent.com/u/62026038?s=40&v=4)](/pastaghost) [pastaghost](/pastaghost)

pastaghost approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@markrypt0](https://avatars.githubusercontent.com/u/91701444?s=52&v=4)](/markrypt0) [![@pastaghost](https://avatars.githubusercontent.com/u/62026038?s=52&v=4)](/pastaghost)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ee07d36e_20250115_112216.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2F)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2F)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=keepkey%2Fkeepkey-firmware)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[keepkey](/keepkey)
/
**[keepkey-firmware](/keepkey/keepkey-firmware)**
Public

* [Notifications](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware) You must be signed in to change notification settings
* [Fork
  103](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)
* [Star
   157](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)

KeepKey Device Firmware

### License

[LGPL-3.0 license](/keepkey/keepkey-firmware/blob/master/COPYING)

[157
stars](/keepkey/keepkey-firmware/stargazers) [103
forks](/keepkey/keepkey-firmware/forks) [Branches](/keepkey/keepkey-firmware/branches) [Tags](/keepkey/keepkey-firmware/tags) [Activity](/keepkey/keepkey-firmware/activity)
 [Star](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)

 [Notifications](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware) You must be signed in to change notification settings

* [Code](/keepkey/keepkey-firmware)
* [Issues
  14](/keepkey/keepkey-firmware/issues)
* [Pull requests
  0](/keepkey/keepkey-firmware/pulls)
* [Actions](/keepkey/keepkey-firmware/actions)
* [Security](/keepkey/keepkey-firmware/security)
* [Insights](/keepkey/keepkey-firmware/pulse)

Additional navigation options

* [Code](/keepkey/keepkey-firmware)
* [Issues](/keepkey/keepkey-firmware/issues)
* [Pull requests](/keepkey/keepkey-firmware/pulls)
* [Actions](/keepkey/keepkey-firmware/actions)
* [Security](/keepkey/keepkey-firmware/security)
* [Insights](/keepkey/keepkey-firmware/pulse)

# keepkey/keepkey-firmware

    master[Branches](/keepkey/keepkey-firmware/branches)[Tags](/keepkey/keepkey-firmware/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[4,444 Commits](/keepkey/keepkey-firmware/commits/master/) | | |
| [.circleci](/keepkey/keepkey-firmware/tree/master/.circleci ".circleci") | | [.circleci](/keepkey/keepkey-firmware/tree/master/.circleci ".circleci") |  |  |
| [.github](/keepkey/keepkey-firmware/tree/master/.github ".github") | | [.github](/keepkey/keepkey-firmware/tree/master/.github ".github") |  |  |
| [cmake](/keepkey/keepkey-firmware/tree/master/cmake "cmake") | | [cmake](/keepkey/keepkey-firmware/tree/master/cmake "cmake") |  |  |
| [code-signing-keys @ a6470bd](/keepkey/code-signing-keys/tree/a6470bd8598e5e9a7bfc38bf139a5e5a616f05ec "code-signing-keys") | | [code-signing-keys @ a6470bd](/keepkey/code-signing-keys/tree/a6470bd8598e5e9a7bfc38bf139a5e5a616f05ec "code-signing-keys") |  |  |
| [deps](/keepkey/keepkey-firmware/tree/master/deps "deps") | | [deps](/keepkey/keepkey-firmware/tree/master/deps "deps") |  |  |
| [docs](/keepkey/keepkey-firmware/tree/master/docs "docs") | | [docs](/keepkey/keepkey-firmware/tree/master/docs "docs") |  |  |
| [fuzzer](/keepkey/keepkey-firmware/tree/master/fuzzer "fuzzer") | | [fuzzer](/keepkey/keepkey-firmware/tree/master/fuzzer "fuzzer") |  |  |
| [include](/keepkey/keepkey-firmware/tree/master/include "include") | | [include](/keepkey/keepkey-firmware/tree/master/include "include") |  |  |
| [lib](/keepkey/keepkey-firmware/tree/master/lib "lib") | | [lib](/keepkey/keepkey-firmware/tree/master/lib "lib") |  |  |
| [scripts](/keepkey/keepkey-firmware/tree/master/scripts "scripts") | | [scripts](/keepkey/keepkey-firmware/tree/master/scripts "scripts") |  |  |
| [tools](/keepkey/keepkey-firmware/tree/master/tools "tools") | | [tools](/keepkey/keepkey-firmware/tree/master/tools "tools") |  |  |
| [unittests](/keepkey/keepkey-firmware/tree/master/unittests "unittests") | | [unittests](/keepkey/keepkey-firmware/tree/master/unittests "unittests") |  |  |
| [.clang-format](/keepkey/keepkey-firmware/blob/master/.clang-format ".clang-format") | | [.clang-format](/keepkey/keepkey-firmware/blob/master/.clang-format ".clang-format") |  |  |
| [.dockerignore](/keepkey/keepkey-firmware/blob/master/.dockerignore ".dockerignore") | | [.dockerignore](/keepkey/keepkey-firmware/blob/master/.dockerignore ".dockerignore") |  |  |
| [.gdbinit](/keepkey/keepkey-firmware/blob/master/.gdbinit ".gdbinit") | | [.gdbinit](/keepkey/keepkey-firmware/blob/master/.gdbinit ".gdbinit") |  |  |
| [.gitattributes](/keepkey/keepkey-firmware/blob/master/.gitattributes ".gitattributes") | | [.gitattributes](/keepkey/keepkey-firmware/blob/master/.gitattributes ".gitattributes") |  |  |
| [.gitignore](/keepkey/keepkey-firmware/blob/master/.gitignore ".gitignore") | | [.gitignore](/keepkey/keepkey-firmware/blob/master/.gitignore ".gitignore") |  |  |
| [.gitmodules](/keepkey/keepkey-firmware/blob/master/.gitmodules ".gitmodules") | | [.gitmodules](/keepkey/keepkey-firmware/blob/master/.gitmodules ".gitmodules") |  |  |
| [.gittrees](/keepkey/keepkey-firmware/blob/master/.gittrees ".gittrees") | | [.gittrees](/keepkey/keepkey-firmware/blob/master/.gittrees ".gittrees") |  |  |
| [CMakeLists.txt](/keepkey/keepkey-firmware/blob/master/CMakeLists.txt "CMakeLists.txt") | | [CMakeLists.txt](/keepkey/keepkey-firmware/blob/master/CMakeLists.txt "CMakeLists.txt") |  |  |
| [COPYING](/keepkey/keepkey-firmware/blob/master/COPYING "COPYING") | | [COPYING](/keepkey/keepkey-firmware/blob/master/COPYING "COPYING") |  |  |
| [Dockerfile](/keepkey/keepkey-firmware/blob/master/Dockerfile "Dockerfile") | | [Dockerfile](/keepkey/keepkey-firmware/blob/master/Dockerfile "Dockerfile") |  |  |
| [README.md](/keepkey/keepkey-firmware/blob/master/README.md "README.md") | | [README.md](/keepkey/keepkey-firmware/blob/master/README.md "README.md") |  |  |
| [SECURITY.md](/keepkey/keepkey-firmware/blob/master/SECURITY.md "SECURITY.md") | | [SECURITY.md](/keepkey/keepkey-firmware/blob/master/SECURITY.md "SECURITY.md") |  |  |
| View all files | | |

## Repository files navigation

* README
* LGPL-3.0 license
* Security

[![CircleCI](https://camo.githubusercontent.com/5cdb5a31732423685fa2e37ea9a1c1c63e2dbf658c247b428a5e86efccb3081c/68747470733a2f2f636972636c6563692e636f6d2f67682f6b6565706b65792f6b6565706b65792d6669726d776172652e7376673f7374796c653d737667)](https://circleci.com/gh/keepkey/keepkey-firmware)

## KeepKey Build Procedure

### Toolchain Installation

Install Docker Community Edition from: `https://www.docker.com/get-docker`

```
$ docker pull kktech/firmware:v5-beta

```

### Clone the Source

The sources can be obtained from github:

```
$ git clone git@github.com:keepkey/keepkey-firmware.git
$ git submodule update --init --recursive

```

### Build

To build the firmware using the docker container, use the provided script:

```
$ ./scripts/build/docker/device/release.sh

```

## Verifying Published Binaries

Compare the hash of a given tagged build:

```
$ git checkout v6.2.0
$ git submodule update --init --recursive
$ ./scripts/build/docker/device/release.sh
$ tail -c +257 ./bin/firmware.keepkey.bin | shasum -a 256

```

With that of the [signed v6.2.0 binary on github](https://github.com/keepkey/keepkey-firmware/releases/download/v6.2.0/firmware.keepkey.bin), ignoring signatures and firmware metadata:

```
$ tail -c +257 firmware.keepkey.bin | shasum -a 256

```

Then inspect the metadata itself by comparing against the structure described [here](https://github.com/keepkey/keepkey-firmware/blob/f20484804285decfacceb71519ae83bc18f2266f/include/keepkey/board/memory.h#L55):

```
$ head -c +256 signed_firmware.bin | xxd -

```

Caveats:

1. v6.2.2 and v6.3.0 had an issue with build reproducibility. See [#212](https://github.com/keepkey/keepkey-firmware/issues/212).
2. As of v6.1.0 and later, we started prepending empty slots for signatures as part of the build, and prior firmwares were emitted without that metadata section. See [87b9ebb84](https://github.com/keepkey/keepkey-firmware/commit/87b9ebb846b241e6357f296e37fd29808ddfa51a)

### Docs

Documentation can be found [here](/keepkey/keepkey-firmware/blob/master/docs/README.md).

## License

If license is not specified in the header of a file, it can be assumed that it is licensed under LGPLv3.

## About

KeepKey Device Firmware

### Resources

[Readme](#readme-ov-file)
### License

[LGPL-3.0 license](#LGPL-3.0-1-ov-file)
### Security policy

[Security policy](#security-ov-file)

[Activity](/keepkey/keepkey-firmware/activity)
[Custom properties](/keepkey/keepkey-firmware/custom-properties)
### Stars

[**157**
stars](/keepkey/keepkey-firmware/stargazers)
### Watchers

[**40**
watching](/keepkey/keepkey-firmware/watchers)
### Forks

[**103**
forks](/keepkey/keepkey-firmware/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware&report=keepkey+%28user%29)

## [Releases 64](/keepkey/keepkey-firmware/releases)

[Release v7.9.3
Latest

Mar 6, 2024](/keepkey/keepkey-firmware/releases/tag/v7.9.3)
[+ 63 releases](/keepkey/keepkey-firmware/releases)

## [Packages 0](/orgs/keepkey/packages?repo_name=keepkey-firmware)

No packages published

## [Contributors 90](/keepkey/keepkey-firmware/graphs/contributors)

[+ 76 contributors](/keepkey/keepkey-firmware/graphs/contributors)

## Languages

* [C
  91.7%](/keepkey/keepkey-firmware/search?l=c)
* [C++
  4.5%](/keepkey/keepkey-firmware/search?l=c%2B%2B)
* [CMake
  1.8%](/keepkey/keepkey-firmware/search?l=cmake)
* [Assembly
  1.4%](/keepkey/keepkey-firmware/search?l=assembly)
* [Shell
  0.4%](/keepkey/keepkey-firmware/search?l=shell)
* [Dockerfile
  0.1%](/keepkey/keepkey-firmware/search?l=dockerfile)
* Other
  0.1%

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


