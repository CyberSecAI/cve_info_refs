=== Content from plugins.trac.wordpress.org_974583c8_20250115_090305.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3012745%2Fbackup-backup)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3010013/backup-backup "Changeset 3010013 for backup-backup")
* [Next Change](/changeset/3017220/backup-backup "Changeset 3017220 for backup-backup") →

---

# Changeset [3012745](/changeset/3012745 "Show full changeset") for [backup-backup](/browser/backup-backup?rev=3012745 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
12/21/2023 06:24:03 AM
([13 months](/timeline?from=2023-12-21T06%3A24%3A03Z&precision=second "See timeline at 12/21/2023 06:24:03 AM") ago)

Author:
iclyde
Message:

Version 1.4.0

Location:
[backup-backup](/browser/backup-backup?rev=3012745)
Files:

395 added
1 edited

* [tags/1.4.0](/browser/backup-backup/tags/1.4.0?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin](/browser/backup-backup/tags/1.4.0/admin?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/css](/browser/backup-backup/tags/1.4.0/admin/css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/css/bmi-plugin-icon.min.css](/browser/backup-backup/tags/1.4.0/admin/css/bmi-plugin-icon.min.css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/css/bmi-plugin.min.css](/browser/backup-backup/tags/1.4.0/admin/css/bmi-plugin.min.css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images](/browser/backup-backup/tags/1.4.0/admin/images?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/002-monitor-white.svg](/browser/backup-backup/tags/1.4.0/admin/images/002-monitor-white.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/Amazon.svg](/browser/backup-backup/tags/1.4.0/admin/images/Amazon.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/alert\_error-min.png](/browser/backup-backup/tags/1.4.0/admin/images/alert_error-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/alert\_info-min.png](/browser/backup-backup/tags/1.4.0/admin/images/alert_info-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/alert\_success-min.png](/browser/backup-backup/tags/1.4.0/admin/images/alert_success-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/alert\_warning-min.png](/browser/backup-backup/tags/1.4.0/admin/images/alert_warning-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/arrow-min.png](/browser/backup-backup/tags/1.4.0/admin/images/arrow-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/backblaze.svg](/browser/backup-backup/tags/1.4.0/admin/images/backblaze.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/backup-min.svg](/browser/backup-backup/tags/1.4.0/admin/images/backup-min.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/big-thumb-up.svg](/browser/backup-backup/tags/1.4.0/admin/images/big-thumb-up.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/big\_bg\_clock\_green-min.png](/browser/backup-backup/tags/1.4.0/admin/images/big_bg_clock_green-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/big\_bg\_clock\_white-min.png](/browser/backup-backup/tags/1.4.0/admin/images/big_bg_clock_white-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/clock.svg](/browser/backup-backup/tags/1.4.0/admin/images/clock.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/clock2.svg](/browser/backup-backup/tags/1.4.0/admin/images/clock2.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/clocks-min.png](/browser/backup-backup/tags/1.4.0/admin/images/clocks-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/close-min.png](/browser/backup-backup/tags/1.4.0/admin/images/close-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/copy-icon.png](/browser/backup-backup/tags/1.4.0/admin/images/copy-icon.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/copy-url-stg.svg](/browser/backup-backup/tags/1.4.0/admin/images/copy-url-stg.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/crown-bg.png](/browser/backup-backup/tags/1.4.0/admin/images/crown-bg.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/download-min.png](/browser/backup-backup/tags/1.4.0/admin/images/download-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/dream-objects.svg](/browser/backup-backup/tags/1.4.0/admin/images/dream-objects.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/ftp.svg](/browser/backup-backup/tags/1.4.0/admin/images/ftp.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/google-cloud.svg](/browser/backup-backup/tags/1.4.0/admin/images/google-cloud.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/google-drive-mono.svg](/browser/backup-backup/tags/1.4.0/admin/images/google-drive-mono.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/google-drive.svg](/browser/backup-backup/tags/1.4.0/admin/images/google-drive.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/happy-smile.png](/browser/backup-backup/tags/1.4.0/admin/images/happy-smile.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/info-min.png](/browser/backup-backup/tags/1.4.0/admin/images/info-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/kitty-cat.svg](/browser/backup-backup/tags/1.4.0/admin/images/kitty-cat.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/link-min.png](/browser/backup-backup/tags/1.4.0/admin/images/link-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/list-ongoing.svg](/browser/backup-backup/tags/1.4.0/admin/images/list-ongoing.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/list-success.svg](/browser/backup-backup/tags/1.4.0/admin/images/list-success.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/list-waiting.svg](/browser/backup-backup/tags/1.4.0/admin/images/list-waiting.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/list-warning.svg](/browser/backup-backup/tags/1.4.0/admin/images/list-warning.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/local-server-2.svg](/browser/backup-backup/tags/1.4.0/admin/images/local-server-2.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/local-server.svg](/browser/backup-backup/tags/1.4.0/admin/images/local-server.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/lock-experimental.png](/browser/backup-backup/tags/1.4.0/admin/images/lock-experimental.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/lock-min.svg](/browser/backup-backup/tags/1.4.0/admin/images/lock-min.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/log-in.svg](/browser/backup-backup/tags/1.4.0/admin/images/log-in.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/log-min.svg](/browser/backup-backup/tags/1.4.0/admin/images/log-min.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/logo-min.png](/browser/backup-backup/tags/1.4.0/admin/images/logo-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/logo.png](/browser/backup-backup/tags/1.4.0/admin/images/logo.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/microsoft-azure.svg](/browser/backup-backup/tags/1.4.0/admin/images/microsoft-azure.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/minimize-min.png](/browser/backup-backup/tags/1.4.0/admin/images/minimize-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/next-icon-min.png](/browser/backup-backup/tags/1.4.0/admin/images/next-icon-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/nut-big.png](/browser/backup-backup/tags/1.4.0/admin/images/nut-big.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/nut-mid.png](/browser/backup-backup/tags/1.4.0/admin/images/nut-mid.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/nut-small.png](/browser/backup-backup/tags/1.4.0/admin/images/nut-small.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/onedrive.svg](/browser/backup-backup/tags/1.4.0/admin/images/onedrive.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/openstack-swift.svg](/browser/backup-backup/tags/1.4.0/admin/images/openstack-swift.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/pen-edit.svg](/browser/backup-backup/tags/1.4.0/admin/images/pen-edit.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/premium.png](/browser/backup-backup/tags/1.4.0/admin/images/premium.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/premium.svg](/browser/backup-backup/tags/1.4.0/admin/images/premium.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/rackspace.svg](/browser/backup-backup/tags/1.4.0/admin/images/rackspace.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/red-close-min.svg](/browser/backup-backup/tags/1.4.0/admin/images/red-close-min.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/red-cross.svg](/browser/backup-backup/tags/1.4.0/admin/images/red-cross.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/restore-icon-min.png](/browser/backup-backup/tags/1.4.0/admin/images/restore-icon-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/restore-min.svg](/browser/backup-backup/tags/1.4.0/admin/images/restore-min.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/search-min.png](/browser/backup-backup/tags/1.4.0/admin/images/search-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/sftp-scp.svg](/browser/backup-backup/tags/1.4.0/admin/images/sftp-scp.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/stars.gif](/browser/backup-backup/tags/1.4.0/admin/images/stars.gif?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/stg-bg.svg](/browser/backup-backup/tags/1.4.0/admin/images/stg-bg.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/stg-check.svg](/browser/backup-backup/tags/1.4.0/admin/images/stg-check.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/stg-creation-bg.jpg](/browser/backup-backup/tags/1.4.0/admin/images/stg-creation-bg.jpg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/stg-new.svg](/browser/backup-backup/tags/1.4.0/admin/images/stg-new.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/stg-restore-btn.svg](/browser/backup-backup/tags/1.4.0/admin/images/stg-restore-btn.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/success.png](/browser/backup-backup/tags/1.4.0/admin/images/success.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/support-1.svg](/browser/backup-backup/tags/1.4.0/admin/images/support-1.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/support-2.svg](/browser/backup-backup/tags/1.4.0/admin/images/support-2.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/support-3.svg](/browser/backup-backup/tags/1.4.0/admin/images/support-3.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/thumb.png](/browser/backup-backup/tags/1.4.0/admin/images/thumb.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/timemachine.svg](/browser/backup-backup/tags/1.4.0/admin/images/timemachine.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/tlogo.svg](/browser/backup-backup/tags/1.4.0/admin/images/tlogo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/trash.png](/browser/backup-backup/tags/1.4.0/admin/images/trash.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/unlocked-min.svg](/browser/backup-backup/tags/1.4.0/admin/images/unlocked-min.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/upload-min.png](/browser/backup-backup/tags/1.4.0/admin/images/upload-min.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/upload.svg](/browser/backup-backup/tags/1.4.0/admin/images/upload.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/warning-grey.png](/browser/backup-backup/tags/1.4.0/admin/images/warning-grey.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/warning-red.png](/browser/backup-backup/tags/1.4.0/admin/images/warning-red.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/images/x-face.png](/browser/backup-backup/tags/1.4.0/admin/images/x-face.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/js](/browser/backup-backup/tags/1.4.0/admin/js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/admin/js/backup-migration.min.js](/browser/backup-backup/tags/1.4.0/admin/js/backup-migration.min.js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst](/browser/backup-backup/tags/1.4.0/analyst?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets](/browser/backup-backup/tags/1.4.0/analyst/assets?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/css](/browser/backup-backup/tags/1.4.0/analyst/assets/css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/css/customize.css](/browser/backup-backup/tags/1.4.0/analyst/assets/css/customize.css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/img](/browser/backup-backup/tags/1.4.0/analyst/assets/img?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/img/pencil.png](/browser/backup-backup/tags/1.4.0/analyst/assets/img/pencil.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/img/shield\_question.png](/browser/backup-backup/tags/1.4.0/analyst/assets/img/shield_question.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/img/shield\_success.png](/browser/backup-backup/tags/1.4.0/analyst/assets/img/shield_success.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/img/smile.png](/browser/backup-backup/tags/1.4.0/analyst/assets/img/smile.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/index.php](/browser/backup-backup/tags/1.4.0/analyst/assets/index.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/js](/browser/backup-backup/tags/1.4.0/analyst/assets/js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/assets/js/customize.js](/browser/backup-backup/tags/1.4.0/analyst/assets/js/customize.js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/autoload.php](/browser/backup-backup/tags/1.4.0/analyst/autoload.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/index.php](/browser/backup-backup/tags/1.4.0/analyst/index.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/main.php](/browser/backup-backup/tags/1.4.0/analyst/main.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/sdk\_resolver.php](/browser/backup-backup/tags/1.4.0/analyst/sdk_resolver.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src](/browser/backup-backup/tags/1.4.0/analyst/src?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Account](/browser/backup-backup/tags/1.4.0/analyst/src/Account?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Account/Account.php](/browser/backup-backup/tags/1.4.0/analyst/src/Account/Account.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Account/AccountData.php](/browser/backup-backup/tags/1.4.0/analyst/src/Account/AccountData.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Account/AccountDataFactory.php](/browser/backup-backup/tags/1.4.0/analyst/src/Account/AccountDataFactory.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Analyst.php](/browser/backup-backup/tags/1.4.0/analyst/src/Analyst.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/ApiRequestor.php](/browser/backup-backup/tags/1.4.0/analyst/src/ApiRequestor.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/ApiResponse.php](/browser/backup-backup/tags/1.4.0/analyst/src/ApiResponse.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Cache](/browser/backup-backup/tags/1.4.0/analyst/src/Cache?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Cache/DatabaseCache.php](/browser/backup-backup/tags/1.4.0/analyst/src/Cache/DatabaseCache.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Collector.php](/browser/backup-backup/tags/1.4.0/analyst/src/Collector.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Contracts](/browser/backup-backup/tags/1.4.0/analyst/src/Contracts?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Contracts/AnalystContract.php](/browser/backup-backup/tags/1.4.0/analyst/src/Contracts/AnalystContract.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Contracts/CacheContract.php](/browser/backup-backup/tags/1.4.0/analyst/src/Contracts/CacheContract.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Contracts/HttpClientContract.php](/browser/backup-backup/tags/1.4.0/analyst/src/Contracts/HttpClientContract.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Contracts/RequestContract.php](/browser/backup-backup/tags/1.4.0/analyst/src/Contracts/RequestContract.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Contracts/RequestorContract.php](/browser/backup-backup/tags/1.4.0/analyst/src/Contracts/RequestorContract.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Contracts/TrackerContract.php](/browser/backup-backup/tags/1.4.0/analyst/src/Contracts/TrackerContract.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Core](/browser/backup-backup/tags/1.4.0/analyst/src/Core?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Core/AbstractFactory.php](/browser/backup-backup/tags/1.4.0/analyst/src/Core/AbstractFactory.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http](/browser/backup-backup/tags/1.4.0/analyst/src/Http?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/CurlHttpClient.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/CurlHttpClient.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/DummyHttpClient.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/DummyHttpClient.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/Requests](/browser/backup-backup/tags/1.4.0/analyst/src/Http/Requests?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/Requests/AbstractLoggerRequest.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/Requests/AbstractLoggerRequest.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/Requests/ActivateRequest.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/Requests/ActivateRequest.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/Requests/DeactivateRequest.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/Requests/DeactivateRequest.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/Requests/InstallRequest.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/Requests/InstallRequest.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/Requests/OptInRequest.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/Requests/OptInRequest.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/Requests/OptOutRequest.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/Requests/OptOutRequest.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/Requests/UninstallRequest.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/Requests/UninstallRequest.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Http/WordPressHttpClient.php](/browser/backup-backup/tags/1.4.0/analyst/src/Http/WordPressHttpClient.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Mutator.php](/browser/backup-backup/tags/1.4.0/analyst/src/Mutator.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Notices](/browser/backup-backup/tags/1.4.0/analyst/src/Notices?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Notices/Notice.php](/browser/backup-backup/tags/1.4.0/analyst/src/Notices/Notice.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/Notices/NoticeFactory.php](/browser/backup-backup/tags/1.4.0/analyst/src/Notices/NoticeFactory.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/src/helpers.php](/browser/backup-backup/tags/1.4.0/analyst/src/helpers.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/templates](/browser/backup-backup/tags/1.4.0/analyst/templates?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/templates/forms](/browser/backup-backup/tags/1.4.0/analyst/templates/forms?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/templates/forms/deactivate.php](/browser/backup-backup/tags/1.4.0/analyst/templates/forms/deactivate.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/templates/forms/install.php](/browser/backup-backup/tags/1.4.0/analyst/templates/forms/install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/templates/notice.php](/browser/backup-backup/tags/1.4.0/analyst/templates/notice.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/templates/optin.php](/browser/backup-backup/tags/1.4.0/analyst/templates/optin.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/templates/optout.php](/browser/backup-backup/tags/1.4.0/analyst/templates/optout.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/analyst/version.php](/browser/backup-backup/tags/1.4.0/analyst/version.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/backup-backup.php](/browser/backup-backup/tags/1.4.0/backup-backup.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes](/browser/backup-backup/tags/1.4.0/includes?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/.htaccess](/browser/backup-backup/tags/1.4.0/includes/.htaccess?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/activation.php](/browser/backup-backup/tags/1.4.0/includes/activation.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/ajax.php](/browser/backup-backup/tags/1.4.0/includes/ajax.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/analyst.php](/browser/backup-backup/tags/1.4.0/includes/analyst.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/backup-heart.php](/browser/backup-backup/tags/1.4.0/includes/backup-heart.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner](/browser/backup-backup/tags/1.4.0/includes/banner?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/assets](/browser/backup-backup/tags/1.4.0/includes/banner/assets?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/assets/index.min.js](/browser/backup-backup/tags/1.4.0/includes/banner/assets/index.min.js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/assets/style.min.css](/browser/backup-backup/tags/1.4.0/includes/banner/assets/style.min.css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/misc.php](/browser/backup-backup/tags/1.4.0/includes/banner/misc.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views](/browser/backup-backup/tags/1.4.0/includes/banner/views?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/index.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/index.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/imgs](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/imgs/background-images.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/imgs/background-images.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/imgs/background-texture-grey.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/imgs/background-texture-grey.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/imgs/big-colored-logo.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/imgs/big-colored-logo.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/imgs/colored-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/imgs/colored-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/imgs/white-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/imgs/white-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/install.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/installed.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/installed.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/bmi/upgrade.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/bmi/upgrade.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/imgs](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/imgs/background-texture-grey.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/imgs/background-texture-grey.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/imgs/big-colored-logo.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/imgs/big-colored-logo.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/imgs/colored-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/imgs/colored-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/imgs/main-background-image.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/imgs/main-background-image.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/imgs/secondary-background-image.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/imgs/secondary-background-image.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/imgs/white-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/imgs/white-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/install.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/installed.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/installed.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/cdp/upgrade.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/cdp/upgrade.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/background-bottom-left.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/background-bottom-left.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/background-bottom-right.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/background-bottom-right.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/background-top-left.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/background-top-left.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/background-top-right.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/background-top-right.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/big-colored-logo.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/big-colored-logo.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/colored-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/colored-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/face1.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/face1.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/face2.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/face2.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/face3.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/face3.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/face4.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/face4.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/imgs/white-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/imgs/white-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/fit/install.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/fit/install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/imgs](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/imgs/background-images.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/imgs/background-images.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/imgs/background-texture-green.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/imgs/background-texture-green.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/imgs/background-texture-grey.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/imgs/background-texture-grey.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/imgs/big-colored-logo.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/imgs/big-colored-logo.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/imgs/colored-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/imgs/colored-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/imgs/white-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/imgs/white-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/install.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/mpu/installed.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/mpu/installed.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red/imgs](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red/imgs/background-top-left.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red/imgs/background-top-left.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red/imgs/big-colored-logo-rr.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red/imgs/big-colored-logo-rr.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red/imgs/colored-logo-rr.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red/imgs/colored-logo-rr.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red/imgs/main-background-image.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red/imgs/main-background-image.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red/imgs/not-colored-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red/imgs/not-colored-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red/install.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red/install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/red/installed.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/red/installed.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp/imgs](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp/imgs/background-image-1.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp/imgs/background-image-1.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp/imgs/background-image-2.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp/imgs/background-image-2.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp/imgs/background-image-3.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp/imgs/background-image-3.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp/imgs/big-colored-logo.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp/imgs/big-colored-logo.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp/imgs/colored-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp/imgs/colored-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp/imgs/white-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp/imgs/white-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/twp/install.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/twp/install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs/background-icons.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs/background-icons.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs/background-image.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs/background-image.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs/big-colored-logo.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs/big-colored-logo.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs/colored-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs/colored-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs/play-icon.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs/play-icon.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs/ribbon-icon.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs/ribbon-icon.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs/video-background.png](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs/video-background.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/imgs/white-logo.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/imgs/white-logo.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/install.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/installed.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/installed.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/part-install.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/part-install.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/part-upgrade.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/part-upgrade.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/projects/usm/upgrade.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/projects/usm/upgrade.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/static](/browser/backup-backup/tags/1.4.0/includes/banner/views/static?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/static/imgs](/browser/backup-backup/tags/1.4.0/includes/banner/views/static/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/static/imgs/already-installed.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/static/imgs/already-installed.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/static/imgs/check-icon.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/static/imgs/check-icon.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/static/imgs/clock-icon.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/static/imgs/clock-icon.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/static/imgs/rating.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/static/imgs/rating.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/static/imgs/white-arrow-right.svg](/browser/backup-backup/tags/1.4.0/includes/banner/views/static/imgs/white-arrow-right.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/banner/views/static/tabs.php](/browser/backup-backup/tags/1.4.0/includes/banner/views/static/tabs.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/bypasser.php](/browser/backup-backup/tags/1.4.0/includes/bypasser.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/check](/browser/backup-backup/tags/1.4.0/includes/check?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/check/checker.php](/browser/backup-backup/tags/1.4.0/includes/check/checker.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/check/system\_info.php](/browser/backup-backup/tags/1.4.0/includes/check/system_info.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/cli](/browser/backup-backup/tags/1.4.0/includes/cli?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/cli-handler.php](/browser/backup-backup/tags/1.4.0/includes/cli-handler.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/cli/php\_cli\_finder.php](/browser/backup-backup/tags/1.4.0/includes/cli/php_cli_finder.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/cli/version\_check.php](/browser/backup-backup/tags/1.4.0/includes/cli/version_check.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/compatibility.php](/browser/backup-backup/tags/1.4.0/includes/compatibility.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/config.php](/browser/backup-backup/tags/1.4.0/includes/config.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/constants.php](/browser/backup-backup/tags/1.4.0/includes/constants.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/cron](/browser/backup-backup/tags/1.4.0/includes/cron?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/cron/handler.php](/browser/backup-backup/tags/1.4.0/includes/cron/handler.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard](/browser/backup-backup/tags/1.4.0/includes/dashboard?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter/AA-Template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter/AA-Template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter/other\_config.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter/other_config.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter/save-button.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter/save-button.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter/staging.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter/staging.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter/store\_config.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter/store_config.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter/troubleshooting.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter/troubleshooting.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter/what\_backed\_up.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter/what_backed_up.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/chapter/where\_config.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/chapter/where_config.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/AA-Modal-Template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/AA-Modal-Template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/after-logs-sent.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/after-logs-sent.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/backup-error-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/backup-error-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/backup-progress-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/backup-progress-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/backup-success-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/backup-success-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/bfs-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/bfs-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/delete-confirm-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/delete-confirm-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/freeze-loading.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/freeze-loading.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/logs-sharing-ask.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/logs-sharing-ask.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/pre-restore-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/pre-restore-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/prenotice-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/prenotice-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/reset-confirm-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/reset-confirm-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/restore-error-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/restore-error-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/restore-progress-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/restore-progress-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/restore-success-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/restore-success-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/staging-delete-confirm-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/staging-delete-confirm-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/staging-error-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/staging-error-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/staging-prenotice-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/staging-prenotice-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/staging-progress-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/staging-progress-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/staging-rename-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/staging-rename-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/staging-success-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/staging-success-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/upload-exist-file-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/upload-exist-file-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/upload-invalid-manifest-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/upload-invalid-manifest-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/upload-success-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/upload-success-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modals/upload-wrong-file-modal.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modals/upload-wrong-file-modal.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/backup-ongoing.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/backup-ongoing.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/backup\_controller.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/backup_controller.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/backups-table-header.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/backups-table-header.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/backups-under-table.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/backups-under-table.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/email-errors.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/email-errors.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/quota-errors.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/quota-errors.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/super-quick-migration.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/super-quick-migration.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/support-chat.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/support-chat.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/modules/upload-backup.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/modules/upload-backup.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/settings.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/settings.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates/AA-Template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates/AA-Template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates/backup-row-template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates/backup-row-template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates/dropdown-template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates/dropdown-template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates/exclusion-rule-template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates/exclusion-rule-template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates/option-template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates/option-template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates/premium-overlay.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates/premium-overlay.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates/staging-row-template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates/staging-row-template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/templates/stg-option-template.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/templates/stg-option-template.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/dashboard/translations.php](/browser/backup-backup/tags/1.4.0/includes/dashboard/translations.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database](/browser/backup-backup/tags/1.4.0/includes/database?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database/better-backup-v3.php](/browser/backup-backup/tags/1.4.0/includes/database/better-backup-v3.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database/better-backup.php](/browser/backup-backup/tags/1.4.0/includes/database/better-backup.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database/better-restore.php](/browser/backup-backup/tags/1.4.0/includes/database/better-restore.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database/even-better-restore-v3.php](/browser/backup-backup/tags/1.4.0/includes/database/even-better-restore-v3.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database/even-better-restore-v4.php](/browser/backup-backup/tags/1.4.0/includes/database/even-better-restore-v4.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database/manager.php](/browser/backup-backup/tags/1.4.0/includes/database/manager.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database/search-replace.php](/browser/backup-backup/tags/1.4.0/includes/database/search-replace.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/database/smart-sort.php](/browser/backup-backup/tags/1.4.0/includes/database/smart-sort.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/extracter](/browser/backup-backup/tags/1.4.0/includes/extracter?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/extracter/extract.php](/browser/backup-backup/tags/1.4.0/includes/extracter/extract.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:](/browser/backup-backup/tags/1.4.0/includes/file%3A?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:/Users](/browser/backup-backup/tags/1.4.0/includes/file%3A/Users?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:/Users/iclyde](/browser/backup-backup/tags/1.4.0/includes/file%3A/Users/iclyde?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:/Users/iclyde/Development](/browser/backup-backup/tags/1.4.0/includes/file%3A/Users/iclyde/Development?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:/Users/iclyde/Development/Web](/browser/backup-backup/tags/1.4.0/includes/file%3A/Users/iclyde/Development/Web?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:/Users/iclyde/Development/Web/wordpress](/browser/backup-backup/tags/1.4.0/includes/file%3A/Users/iclyde/Development/Web/wordpress?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:/Users/iclyde/Development/Web/wordpress/wp-content](/browser/backup-backup/tags/1.4.0/includes/file%3A/Users/iclyde/Development/Web/wordpress/wp-content?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:/Users/iclyde/Development/Web/wordpress/wp-content/backup-migration-XDXDXD](/browser/backup-backup/tags/1.4.0/includes/file%3A/Users/iclyde/Development/Web/wordpress/wp-content/backup-migration-XDXDXD?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/file:/Users/iclyde/Development/Web/wordpress/wp-content/backup-migration-XDXDXD/background-errors.log](/browser/backup-backup/tags/1.4.0/includes/file%3A/Users/iclyde/Development/Web/wordpress/wp-content/backup-migration-XDXDXD/background-errors.log?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/htaccess](/browser/backup-backup/tags/1.4.0/includes/htaccess?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/htaccess/.autologin.php](/browser/backup-backup/tags/1.4.0/includes/htaccess/.autologin.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/htaccess/.htaccess](/browser/backup-backup/tags/1.4.0/includes/htaccess/.htaccess?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/htaccess/.litespeed](/browser/backup-backup/tags/1.4.0/includes/htaccess/.litespeed?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/htaccess/default.json](/browser/backup-backup/tags/1.4.0/includes/htaccess/default.json?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/htaccess/index.html](/browser/backup-backup/tags/1.4.0/includes/htaccess/index.html?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/initializer.php](/browser/backup-backup/tags/1.4.0/includes/initializer.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/logger.php](/browser/backup-backup/tags/1.4.0/includes/logger.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/progress](/browser/backup-backup/tags/1.4.0/includes/progress?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/progress/logger-only.php](/browser/backup-backup/tags/1.4.0/includes/progress/logger-only.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/progress/migration.php](/browser/backup-backup/tags/1.4.0/includes/progress/migration.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/progress/staging.php](/browser/backup-backup/tags/1.4.0/includes/progress/staging.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/progress/zip.php](/browser/backup-backup/tags/1.4.0/includes/progress/zip.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/restore-batching.php](/browser/backup-backup/tags/1.4.0/includes/restore-batching.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/scanner](/browser/backup-backup/tags/1.4.0/includes/scanner?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/scanner/backups.php](/browser/backup-backup/tags/1.4.0/includes/scanner/backups.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/scanner/files.php](/browser/backup-backup/tags/1.4.0/includes/scanner/files.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/staging](/browser/backup-backup/tags/1.4.0/includes/staging?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/staging/controller.php](/browser/backup-backup/tags/1.4.0/includes/staging/controller.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/staging/local.php](/browser/backup-backup/tags/1.4.0/includes/staging/local.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/staging/tastewp.php](/browser/backup-backup/tags/1.4.0/includes/staging/tastewp.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/uploader](/browser/backup-backup/tags/1.4.0/includes/uploader?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/uploader/chunks.php](/browser/backup-backup/tags/1.4.0/includes/uploader/chunks.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/zipper](/browser/backup-backup/tags/1.4.0/includes/zipper?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/zipper/src](/browser/backup-backup/tags/1.4.0/includes/zipper/src?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/zipper/src/zip.php](/browser/backup-backup/tags/1.4.0/includes/zipper/src/zip.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/includes/zipper/zipping.php](/browser/backup-backup/tags/1.4.0/includes/zipper/zipping.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules](/browser/backup-backup/tags/1.4.0/modules?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/assets](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/assets?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/assets/css](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/assets/css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/assets/css/styles.css](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/assets/css/styles.css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/assets/imgs](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/assets/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/assets/imgs/decor.png](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/assets/imgs/decor.png?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/assets/js](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/assets/js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/assets/js/script.js](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/assets/js/script.js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/misc.php](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/misc.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/templates](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/templates?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/gdrivebanner/templates/banner.php](/browser/backup-backup/tags/1.4.0/modules/gdrivebanner/templates/banner.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review](/browser/backup-backup/tags/1.4.0/modules/review?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets](/browser/backup-backup/tags/1.4.0/modules/review/assets?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/css](/browser/backup-backup/tags/1.4.0/modules/review/assets/css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/css/style.css](/browser/backup-backup/tags/1.4.0/modules/review/assets/css/style.css?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/imgs](/browser/backup-backup/tags/1.4.0/modules/review/assets/imgs?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/imgs/BM-background.svg](/browser/backup-backup/tags/1.4.0/modules/review/assets/imgs/BM-background.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/imgs/background-pattern.svg](/browser/backup-backup/tags/1.4.0/modules/review/assets/imgs/background-pattern.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/imgs/main-image-part-2.svg](/browser/backup-backup/tags/1.4.0/modules/review/assets/imgs/main-image-part-2.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/imgs/main-image-part-4.svg](/browser/backup-backup/tags/1.4.0/modules/review/assets/imgs/main-image-part-4.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/imgs/main-image.svg](/browser/backup-backup/tags/1.4.0/modules/review/assets/imgs/main-image.svg?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/js](/browser/backup-backup/tags/1.4.0/modules/review/assets/js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/assets/js/script.js](/browser/backup-backup/tags/1.4.0/modules/review/assets/js/script.js?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/review.php](/browser/backup-backup/tags/1.4.0/modules/review/review.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/views](/browser/backup-backup/tags/1.4.0/modules/review/views?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/modules/review/views/banner.php](/browser/backup-backup/tags/1.4.0/modules/review/views/banner.php?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/readme.txt](/browser/backup-backup/tags/1.4.0/readme.txt?rev=3012745 "Show entry in browser")
  (added)
* [tags/1.4.0/uninstall.php](/browser/backup-backup/tags/1.4.0/uninstall.php?rev=3012745 "Show entry in browser")
  (added)
* [trunk/readme.txt](/browser/backup-backup/trunk/readme.txt?rev=3012745 "Show entry in browser")
  (modified)
  ([3 diffs](#file395 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [backup-backup/trunk/readme.txt](/changeset/3012745/backup-backup/trunk/readme.txt "Show the changeset 3012745 restricted to backup-backup/trunk/readme.txt")

  | [r3010013](/browser/backup-backup/trunk/readme.txt?rev=3010013#L4 "Show revision 3010013 of this file in browser") | [r3012745](/browser/backup-backup/trunk/readme.txt?rev=3012745#L4 "Show revision 3012745 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.6 |
  | 5 | 5 | Tested up to: 6.4.2 |
  | 6 |  | Stable tag: 1.~~3.9~~ |
  |  | 6 | Stable tag: 1.4.0 |
  | 7 | 7 | License: GPLv3 |
  | 8 | 8 | Requires PHP: 5.6 |
  | […](/browser/backup-backup/trunk/readme.txt?rev=3010013#L163) | […](/browser/backup-backup/trunk/readme.txt?rev=3012745#L163) |  |
  | 163 | 163 |  |
  | 164 | 164 | == Changelog == |
  |  | 165 |  |
  |  | 166 | = 1.4.0 = |
  |  | 167 | \* [PRO] Fixed issues with dead output of Google Drive backups |
  |  | 168 | \* [FIX] Improved plugin security (important upgrade – CVE-2023-6972, CVE-2023-6971, CVE-2023-7002) |
  | 165 | 169 |  |
  | 166 | 170 | = 1.3.9 = |
  | […](/browser/backup-backup/trunk/readme.txt?rev=3010013#L695) | […](/browser/backup-backup/trunk/readme.txt?rev=3012745#L699) |  |
  | 695 | 699 | == Upgrade Notice == |
  | 696 | 700 |  |
  | 697 |  | = 1.~~3.9~~ = |
  | 698 |  | What's new in 1.~~3.9~~? |
  | 699 |  | \* ~~[FIX] Fixed issue where user could not change storage path that contain "dot"~~ |
  | 700 |  | \* [~~FIX] Adjusted our hotfix patches to not prevent third party ajax calls without nonce~~s |
  | 701 |  | \* [~~NOTE] Tested with PHP 8.3 (+CLI cmds)~~ |
  |  | 701 | = 1.4.0 = |
  |  | 702 | What's new in 1.4.0? |
  |  | 703 | \* IMPORTANT SECURITY UPGRADE |
  |  | 704 | \* [PRO] Fixed issues with dead output of Google Drive backups |
  |  | 705 | \* [FIX] Improved plugin security (important upgrade – CVE-2023-6972, CVE-2023-6971, CVE-2023-7002) |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3012745)
* [Zip Archive](?format=zip&new=3012745)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_c06bf749_20250115_090238.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbackup-backup%2Ftags%2F1.3.9%2Fincludes%2Fajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/backup-backup/tags/1.3.9/includes/ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/backup-backup/tags/1.3.9/includes/ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [backup-backup](/browser/backup-backup?order=name "View backup-backup")/[tags](/browser/backup-backup/tags?order=name "View tags")/[1.3.9](/browser/backup-backup/tags/1.3.9?order=name "View 1.3.9")/[includes](/browser/backup-backup/tags/1.3.9/includes?order=name "View includes")/[ajax.php](/browser/backup-backup/tags/1.3.9/includes/ajax.php?order=name "View ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3010013/backup-backup/tags/1.3.9/includes/ajax.php "View differences") on this file was [3010013](/changeset/3010013/ "View changeset 3010013"), checked in by iclyde, [13 months ago](/timeline?from=2023-12-14T12%3A49%3A30Z&precision=second "See timeline at 12/14/2023 12:49:30 PM") |
| --- |
| Version 1.3.9 |
| **File size:** 137.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | // Namespace |
| [4](#L4) | namespace BMI\Plugin; |
| [5](#L5) |  |
| [6](#L6) | // Exit on direct access |
| [7](#L7) | if (!defined('ABSPATH')) exit; |
| [8](#L8) |  |
| [9](#L9) | // Uses |
| [10](#L10) | use BMI\Plugin\Backup\_Migration\_Plugin as BMP; |
| [11](#L11) | use BMI\Plugin\BMI\_Logger as Logger; |
| [12](#L12) | use BMI\Plugin\Checker\BMI\_Checker as Checker; |
| [13](#L13) | use BMI\Plugin\Checker\System\_Info as SI; |
| [14](#L14) | use BMI\Plugin\CRON\BMI\_Crons as Crons; |
| [15](#L15) | use BMI\Plugin\Dashboard as Dashboard; |
| [16](#L16) | use BMI\Plugin\Extracter\BMI\_Extracter as Extracter; |
| [17](#L17) | use BMI\Plugin\Progress\BMI\_MigrationProgress as MigrationProgress; |
| [18](#L18) | use BMI\Plugin\Progress\BMI\_ZipProgress as Progress; |
| [19](#L19) | use BMI\Plugin\Progress\BMI\_StagingProgress as StagingProgress; |
| [20](#L20) | use BMI\Plugin\Scanner\BMI\_BackupsScanner as Backups; |
| [21](#L21) | use BMI\Plugin\Scanner\BMI\_FileScanner as Scanner; |
| [22](#L22) | use BMI\Plugin\Zipper\BMI\_Zipper as Zipper; |
| [23](#L23) | use BMI\Plugin\PHPCLI\Checker as PHPCLICheck; |
| [24](#L24) | use BMI\Plugin\External\BMI\_External\_Storage as ExternalStorage; |
| [25](#L25) | use BMI\Plugin\Staging\BMI\_Staging\_TasteWP as StagingTasteWP; |
| [26](#L26) | use BMI\Plugin\Staging\BMI\_StagingLocal as StagingLocal; |
| [27](#L27) | use BMI\Plugin\Staging\BMI\_Staging as Staging; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Ajax Handler for BMI |
| [31](#L31) | \*/ |
| [32](#L32) | class BMI\_Ajax { |
| [33](#L33) |  |
| [34](#L34) | public $post; |
| [35](#L35) | public $zip\_progress; |
| [36](#L36) | public $migration\_progress; |
| [37](#L37) | public $lock\_cli; |
| [38](#L38) | public $lastCurlCode; |
| [39](#L39) |  |
| [40](#L40) | public $total\_size\_for\_backup = 0; |
| [41](#L41) | public $total\_size\_for\_backup\_in\_mb = 0; |
| [42](#L42) | public $total\_excluded\_size\_for\_backup = 0; |
| [43](#L43) |  |
| [44](#L44) | public function \_\_construct($initializedWithCLI = false) { |
| [45](#L45) |  |
| [46](#L46) | // Return if it's not post |
| [47](#L47) | if (empty($\_POST)) { |
| [48](#L48) | return; |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | // Sanitize User Input |
| [52](#L52) | $this->post = BMP::sanitize($\_POST); |
| [53](#L53) |  |
| [54](#L54) | // Check nonce |
| [55](#L55) | if (check\_ajax\_referer('backup-migration-ajax', 'nonce', false) === false && $initializedWithCLI === false) { |
| [56](#L56) | return wp\_send\_json\_error(['reason' => 'not authorized request']); |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | // Log Handler Call (Verbose) |
| [60](#L60) | Logger::debug(\_\_("Running POST Function: ", 'backup-backup') . $this->post['f']); |
| [61](#L61) |  |
| [62](#L62) | // Create backup folder |
| [63](#L63) | if (!file\_exists(BMI\_BACKUPS)) { |
| [64](#L64) | mkdir(BMI\_BACKUPS, 0755, true); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | // Create background logs file |
| [68](#L68) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [69](#L69) | if (!file\_exists($backgroundLogsPath)) { |
| [70](#L70) | @touch($backgroundLogsPath); |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | // Handle User Request If Known And Sanitize Response |
| [74](#L74) | if ($this->post['f'] == 'scan-directory') { |
| [75](#L75) | BMP::res($this->dirSize()); |
| [76](#L76) | } elseif ($this->post['f'] == 'create-backup') { |
| [77](#L77) | BMP::res($this->prepareAndMakeBackup()); |
| [78](#L78) | } elseif ($this->post['f'] == 'reset-latest') { |
| [79](#L79) | BMP::res($this->resetLatestLogs()); |
| [80](#L80) | } elseif ($this->post['f'] == 'get-current-backups') { |
| [81](#L81) | BMP::res($this->getBackupsList()); |
| [82](#L82) | } elseif ($this->post['f'] == 'restore-backup') { |
| [83](#L83) | BMP::res($this->restoreBackup()); |
| [84](#L84) | } elseif ($this->post['f'] == 'is-running-backup') { |
| [85](#L85) | BMP::res($this->isRunningBackup()); |
| [86](#L86) | } elseif ($this->post['f'] == 'stop-backup') { |
| [87](#L87) | BMP::res($this->stopBackup()); |
| [88](#L88) | } elseif ($this->post['f'] == 'download-backup') { |
| [89](#L89) | BMP::res($this->handleQuickMigration()); |
| [90](#L90) | } elseif ($this->post['f'] == 'migration-locked') { |
| [91](#L91) | BMP::res($this->isMigrationLocked()); |
| [92](#L92) | } elseif ($this->post['f'] == 'upload-backup') { |
| [93](#L93) | BMP::res($this->handleChunkUpload()); |
| [94](#L94) | } elseif ($this->post['f'] == 'delete-backup') { |
| [95](#L95) | BMP::res($this->removeBackupFile()); |
| [96](#L96) | } elseif ($this->post['f'] == 'save-storage') { |
| [97](#L97) | BMP::res($this->saveStorageConfig()); |
| [98](#L98) | } elseif ($this->post['f'] == 'save-file-config') { |
| [99](#L99) | BMP::res($this->saveFilesConfig()); |
| [100](#L100) | } elseif ($this->post['f'] == 'save-other-options') { |
| [101](#L101) | BMP::res($this->saveOtherOptions()); |
| [102](#L102) | } elseif ($this->post['f'] == 'store-config') { |
| [103](#L103) | BMP::res($this->saveStorageTypeConfig()); |
| [104](#L104) | } elseif ($this->post['f'] == 'unlock-backup') { |
| [105](#L105) | BMP::res($this->toggleBackupLock(true)); |
| [106](#L106) | } elseif ($this->post['f'] == 'lock-backup') { |
| [107](#L107) | BMP::res($this->toggleBackupLock(false)); |
| [108](#L108) | } elseif ($this->post['f'] == 'get-dynamic-names') { |
| [109](#L109) | BMP::res($this->getDynamicNames()); |
| [110](#L110) | } elseif ($this->post['f'] == 'reset-configuration') { |
| [111](#L111) | BMP::res($this->resetConfiguration()); |
| [112](#L112) | } elseif ($this->post['f'] == 'get-site-data') { |
| [113](#L113) | BMP::res($this->getSiteData()); |
| [114](#L114) | } elseif ($this->post['f'] == 'send-test-mail') { |
| [115](#L115) | BMP::res($this->sendTestMail()); |
| [116](#L116) | } elseif ($this->post['f'] == 'calculate-cron') { |
| [117](#L117) | BMP::res($this->calculateCron()); |
| [118](#L118) | } elseif ($this->post['f'] == 'dismiss-error-notice') { |
| [119](#L119) | BMP::res($this->dismissErrorNotice()); |
| [120](#L120) | } elseif ($this->post['f'] == 'fix\_uname\_issues') { |
| [121](#L121) | BMP::res($this->fixUnameFunction()); |
| [122](#L122) | } elseif ($this->post['f'] == 'revert\_uname\_issues') { |
| [123](#L123) | BMP::res($this->revertUnameProcess()); |
| [124](#L124) | } elseif ($this->post['f'] == 'continue\_restore\_process') { |
| [125](#L125) | BMP::res($this->continueRestoreProcess()); |
| [126](#L126) | } elseif ($this->post['f'] == 'htaccess-litespeed') { |
| [127](#L127) | BMP::res($this->fixLitespeed()); |
| [128](#L128) | } elseif ($this->post['f'] == 'force-backup-to-stop') { |
| [129](#L129) | BMP::res($this->forceBackupToStop()); |
| [130](#L130) | } elseif ($this->post['f'] == 'force-restore-to-stop') { |
| [131](#L131) | BMP::res($this->forceRestoreToStop()); |
| [132](#L132) | } elseif ($this->post['f'] == 'staging-local-name') { |
| [133](#L133) | BMP::res($this->checkStagingLocalName()); |
| [134](#L134) | } elseif ($this->post['f'] == 'staging-start-local-creation') { |
| [135](#L135) | BMP::res($this->startLocalStagingCreation()); |
| [136](#L136) | } elseif ($this->post['f'] == 'staging-local-creation-process') { |
| [137](#L137) | BMP::res($this->localStagingCreationProcess()); |
| [138](#L138) | } elseif ($this->post['f'] == 'staging-tastewp-creation-process') { |
| [139](#L139) | BMP::res($this->tastewpStagingCreation()); |
| [140](#L140) | } elseif ($this->post['f'] == 'staging-rename-display') { |
| [141](#L141) | BMP::res($this->stagingRename()); |
| [142](#L142) | } elseif ($this->post['f'] == 'staging-prepare-login') { |
| [143](#L143) | BMP::res($this->stagingPrepareLogin()); |
| [144](#L144) | } elseif ($this->post['f'] == 'staging-delete-permanently') { |
| [145](#L145) | BMP::res($this->stagingDelete()); |
| [146](#L146) | } elseif ($this->post['f'] == 'staging-get-updated-list') { |
| [147](#L147) | BMP::res($this->stagingSitesGetList()); |
| [148](#L148) | } elseif ($this->post['f'] == 'send-troubleshooting-logs') { |
| [149](#L149) | BMP::res($this->sendTroubleshootingDetails()); |
| [150](#L150) | } elseif ($this->post['f'] == 'log-sharing-details') { |
| [151](#L151) | BMP::res($this->logSharing()); |
| [152](#L152) | } elseif ($this->post['f'] == 'get-latest-backup') { |
| [153](#L153) | BMP::res($this->getLatestBackupFile()); |
| [154](#L154) | } elseif ($this->post['f'] == 'front-end-ajax-error') { |
| [155](#L155) | BMP::res($this->frontEndAjaxError()); |
| [156](#L156) | } elseif ($this->post['f'] == 'debugging') { |
| [157](#L157) | BMP::res($this->debugging()); |
| [158](#L158) | } elseif (has\_action('bmi\_premium\_ajax')) { |
| [159](#L159) | do\_action('bmi\_premium\_ajax', $this->post); |
| [160](#L160) | } elseif ($this->post['f'] == 'check-not-uploaded-backups') { |
| [161](#L161) | BMP::res(['status' => 'false']); |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | public function siteURL() { |
| [167](#L167) | $protocol = (!empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] !== 'off' || $\_SERVER['SERVER\_PORT'] == 443) ? "https://" : "http://"; |
| [168](#L168) | $domainName = $\_SERVER['HTTP\_HOST']; |
| [169](#L169) |  |
| [170](#L170) | return $protocol . $domainName; |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | public function checkIfPHPCliExist(&$logger) { |
| [174](#L174) |  |
| [175](#L175) | if (defined('BMI\_CLI\_ENABLED')) { |
| [176](#L176) | if (BMI\_CLI\_ENABLED === false) { |
| [177](#L177) | $logger->log(\_\_('PHP CLI is disabled manually, plugin will omit all PHP CLI steps.', 'backup-backup'), 'warn'); |
| [178](#L178) | return false; |
| [179](#L179) | } |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | $logger->log(\_\_('Looking for PHP CLI executable file.', 'backup-backup'), 'step'); |
| [183](#L183) | require\_once BMI\_INCLUDES . '/cli/php\_cli\_finder.php'; |
| [184](#L184) | $checker = new PHPCLICheck(); |
| [185](#L185) | $result = $checker->findPHP(); |
| [186](#L186) |  |
| [187](#L187) | if ($result === false) { |
| [188](#L188) |  |
| [189](#L189) | if (!defined('BMI\_CLI\_ENABLED')) define('BMI\_CLI\_ENABLED', false); |
| [190](#L190) | if (!defined('BMI\_CLI\_EXECUTABLE')) define('BMI\_CLI\_EXECUTABLE', false); |
| [191](#L191) | if ($checker->ini\_disabled === true) { |
| [192](#L192) | $logger->log(\_\_('PHP CLI is disabled in your php.ini file, the process may be unstable.', 'backup-backup'), 'warn'); |
| [193](#L193) | } else { |
| [194](#L194) | $logger->log(\_\_('Could not find proper PHP CLI executable, this process may be unstable.', 'backup-backup'), 'warn'); |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | return false; |
| [198](#L198) |  |
| [199](#L199) | } else { |
| [200](#L200) |  |
| [201](#L201) | if (!defined('BMI\_CLI\_ENABLED')) define('BMI\_CLI\_ENABLED', true); |
| [202](#L202) | if (!defined('BMI\_CLI\_EXECUTABLE')) define('BMI\_CLI\_EXECUTABLE', $result['executable']); |
| [203](#L203) |  |
| [204](#L204) | $logger->log(\_\_('PHP CLI Filename: ', 'backup-backup') . basename($result['executable']), 'info'); |
| [205](#L205) | $logger->log(\_\_('PHP CLI Version: ', 'backup-backup') . $result['version'] . ' ' . $result['brand'], 'info'); |
| [206](#L206) | $logger->log(\_\_('PHP CLI Memory limit: ', 'backup-backup') . $result['memory'], 'info'); |
| [207](#L207) | $logger->log(\_\_('PHP CLI Execution limit: ', 'backup-backup') . $result['max\_exec'], 'info'); |
| [208](#L208) | $logger->log(\_\_('We properly detected PHP CLI executable file.', 'backup-backup'), 'success'); |
| [209](#L209) |  |
| [210](#L210) | return $result; |
| [211](#L211) |  |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | public function getDatabaseSize() { |
| [217](#L217) |  |
| [218](#L218) | global $wpdb; |
| [219](#L219) | $prefix = $wpdb->prefix; |
| [220](#L220) |  |
| [221](#L221) | $sql = "SELECT SUM(DATA\_LENGTH + INDEX\_LENGTH) AS `bytes` FROM information\_schema.TABLES WHERE TABLE\_SCHEMA = %s;"; |
| [222](#L222) | $sql = $wpdb->prepare($sql, array(DB\_NAME)); |
| [223](#L223) |  |
| [224](#L224) | $result = $wpdb->get\_results($sql); |
| [225](#L225) | return intval($result[0]->bytes); |
| [226](#L226) |  |
| [227](#L227) | } |
| [228](#L228) |  |
| [229](#L229) | public function dirSize() { |
| [230](#L230) |  |
| [231](#L231) | // Folder |
| [232](#L232) | $f = $this->post['folder']; |
| [233](#L233) |  |
| [234](#L234) | // Bytes |
| [235](#L235) | $bytes = 0; |
| [236](#L236) | $excludedBytes = 0; |
| [237](#L237) |  |
| [238](#L238) | $emptyVar = [ 'this\_is\_empty\_array' ]; |
| [239](#L239) | $allowed = [ 'plugins', 'uploads', 'themes', 'contents\_others', 'wordpress' ]; |
| [240](#L240) |  |
| [241](#L241) | if (in\_array($f, $allowed)) { |
| [242](#L242) |  |
| [243](#L243) | // Get list of staging sites for exclusion rules |
| [244](#L244) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [245](#L245) | $staging = new Staging('..ajax..'); |
| [246](#L246) | $stagingSites = $staging->getStagingSites(true); |
| [247](#L247) |  |
| [248](#L248) | $files = $this->scanFilesForBackup($emptyVar, $stagingSites, $f); |
| [249](#L249) | $files = $this->parseFilesForBackup($files, $emptyVar, false, true); |
| [250](#L250) |  |
| [251](#L251) | $bytes = $this->total\_size\_for\_backup; |
| [252](#L252) | $excludedBytes = $this->total\_excluded\_size\_for\_backup; |
| [253](#L253) |  |
| [254](#L254) | } elseif ($f == 'database') { |
| [255](#L255) |  |
| [256](#L256) | $bytes = $this->getDatabaseSize(); |
| [257](#L257) |  |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | return [ 'bytes' => $bytes, 'excluded' => $excludedBytes, 'readable' => BMP::humanSize($bytes) ]; |
| [261](#L261) |  |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | public function backupErrorHandler() { |
| [265](#L265) | set\_error\_handler(function ($errno, $errstr, $errfile, $errline) { |
| [266](#L266) |  |
| [267](#L267) | if (BMI\_DEBUG) { |
| [268](#L268) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (ERROR HANDLER #1):'); |
| [269](#L269) | error\_log(print\_r($errno, true)); |
| [270](#L270) | error\_log(print\_r($errstr, true)); |
| [271](#L271) | error\_log(print\_r($errfile, true)); |
| [272](#L272) | error\_log(print\_r($errline, true)); |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) | if (strpos($errstr, 'deprecated') !== false) return; |
| [276](#L276) | if (strpos($errstr, 'php\_uname') !== false) return; |
| [277](#L277) | if ((strpos($errstr, 'backup-migration') !== false) && (strpos($errstr, 'backup-backup') !== false)) return; |
| [278](#L278) |  |
| [279](#L279) | if ($errno != E\_ERROR && $errno != E\_CORE\_ERROR && $errno != E\_COMPILE\_ERROR && $errno != E\_USER\_ERROR && $errno != E\_RECOVERABLE\_ERROR) { |
| [280](#L280) |  |
| [281](#L281) | if (strpos($errfile, 'backup-backup') === false && strpos($errfile, 'backup-migration') === false) return; |
| [282](#L282) | Logger::error(\_\_('There was an error before request shutdown (but it was not logged to restore log)', 'backup-backup')); |
| [283](#L283) | Logger::error(\_\_('Error message: ', 'backup-backup') . $errstr); |
| [284](#L284) | Logger::error(\_\_('Error file/line: ', 'backup-backup') . $errfile . '|' . $errline); |
| [285](#L285) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#01' . '|' . $errno); |
| [286](#L286) | return; |
| [287](#L287) |  |
| [288](#L288) | } |
| [289](#L289) | if (strpos($errfile, 'backup-backup') === false) { |
| [290](#L290) | Logger::error(\_\_("Restore process was not aborted because this error is not related to Backup Migration.", 'backup-backup')); |
| [291](#L291) | $this->zip\_progress->log(\_\_("There was an error not related to Backup Migration Plugin.", 'backup-backup'), 'warn'); |
| [292](#L292) | $this->zip\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'warn'); |
| [293](#L293) | $this->zip\_progress->log(\_\_("Backup will not be aborted because of this.", 'backup-backup'), 'warn'); |
| [294](#L294) | return; |
| [295](#L295) | } |
| [296](#L296) | if (strpos($errstr, 'unlink(') !== false) { |
| [297](#L297) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [298](#L298) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#02' . '|' . $errno); |
| [299](#L299) | Logger::error($errstr); |
| [300](#L300) | return; |
| [301](#L301) | } |
| [302](#L302) | if (strpos($errfile, 'pclzip') !== false) { |
| [303](#L303) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [304](#L304) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#03' . '|' . $errno); |
| [305](#L305) | Logger::error($errstr); |
| [306](#L306) | return; |
| [307](#L307) | } |
| [308](#L308) | if (strpos($errstr, 'rename(') !== false) { |
| [309](#L309) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [310](#L310) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#04' . '|' . $errno); |
| [311](#L311) | Logger::error($errstr); |
| [312](#L312) | $this->zip\_progress->log(\_\_("Cannot move: ", 'backup-backup') . $errstr, 'warn'); |
| [313](#L313) | return; |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | $this->zip\_progress->log(\_\_("There was an error during backup:", 'backup-backup'), 'error'); |
| [317](#L317) | $this->zip\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'error'); |
| [318](#L318) | $this->zip\_progress->log(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline, 'error'); |
| [319](#L319) | $this->zip\_progress->log(\_\_('Unfortunately we had to remove the backup (if partly created).', 'backup-backup'), 'error'); |
| [320](#L320) |  |
| [321](#L321) | $backup = $GLOBALS['bmi\_current\_backup\_name']; |
| [322](#L322) | $backup\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $backup; |
| [323](#L323) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [324](#L324) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'); |
| [325](#L325) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.abort')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.abort'); |
| [326](#L326) |  |
| [327](#L327) | $this->zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [328](#L328) | $this->zip\_progress->log(\_\_("#002", 'backup-backup'), 'end-code'); |
| [329](#L329) | $this->zip\_progress->end(); |
| [330](#L330) |  |
| [331](#L331) | $GLOBALS['bmi\_error\_handled'] = true; |
| [332](#L332) | BMP::res(['status' => 'error', 'error' => $errstr]); |
| [333](#L333) | exit; |
| [334](#L334) |  |
| [335](#L335) | }, E\_ALL); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | public function migrationErrorHandler() { |
| [339](#L339) | set\_exception\_handler(function ($exception) { |
| [340](#L340) | if (BMI\_DEBUG) { |
| [341](#L341) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (EXCEPTION HANDLER #1):'); |
| [342](#L342) | error\_log(print\_r($exception, true)); |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | $this->migration\_progress->log(\_\_("Restore exception: ", 'backup-backup') . $exception->getMessage(), 'warn'); |
| [346](#L346) | Logger::log(\_\_("Restore exception: ", 'backup-backup') . $exception->getMessage()); |
| [347](#L347) | }); |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | public function migrationExceptionHandler() { |
| [351](#L351) | set\_error\_handler(function ($errno, $errstr, $errfile, $errline) { |
| [352](#L352) |  |
| [353](#L353) | if (BMI\_DEBUG) { |
| [354](#L354) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (ERROR HANDLER #2):'); |
| [355](#L355) | error\_log(print\_r($errno, true)); |
| [356](#L356) | error\_log(print\_r($errstr, true)); |
| [357](#L357) | error\_log(print\_r($errfile, true)); |
| [358](#L358) | error\_log(print\_r($errline, true)); |
| [359](#L359) | } |
| [360](#L360) |  |
| [361](#L361) | if (strpos($errstr, 'deprecated') !== false) return; |
| [362](#L362) | if (strpos($errstr, 'php\_uname') !== false) return; |
| [363](#L363) | if ($errno == E\_NOTICE) return; |
| [364](#L364) | if ($errno != E\_ERROR && $errno != E\_CORE\_ERROR && $errno != E\_COMPILE\_ERROR && $errno != E\_USER\_ERROR && $errno != E\_RECOVERABLE\_ERROR) { |
| [365](#L365) | if (strpos($errfile, 'backup-backup') === false && strpos($errfile, 'backup-migration') === false) return; |
| [366](#L366) | Logger::error(\_\_('There was an error before request shutdown (but it was not logged to restore log)', 'backup-backup')); |
| [367](#L367) | Logger::error(\_\_('Error message: ', 'backup-backup') . $errstr); |
| [368](#L368) | Logger::error(\_\_('Error file/line: ', 'backup-backup') . $errfile . '|' . $errline); |
| [369](#L369) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#05' . '|' . $errno); |
| [370](#L370) | return; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | Logger::error(\_\_("There was an error/warning during restore process:", 'backup-backup')); |
| [374](#L374) | Logger::error(\_\_("Message: ", 'backup-backup') . $errstr); |
| [375](#L375) | Logger::error(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline); |
| [376](#L376) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#06' . '|' . $errno); |
| [377](#L377) |  |
| [378](#L378) | if (strpos($errfile, 'backup-backup') === false) { |
| [379](#L379) | Logger::error(\_\_("Restore process was not aborted because this error is not related to Backup Migration.", 'backup-backup')); |
| [380](#L380) | $this->migration\_progress->log(\_\_("There was an error not related to Backup Migration Plugin.", 'backup-backup'), 'warn'); |
| [381](#L381) | $this->migration\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'warn'); |
| [382](#L382) | $this->migration\_progress->log(\_\_("Backup will not be aborted because of this.", 'backup-backup'), 'warn'); |
| [383](#L383) | return; |
| [384](#L384) | } |
| [385](#L385) | if (strpos($errstr, 'unlink(') !== false) { |
| [386](#L386) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [387](#L387) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#07' . '|' . $errno); |
| [388](#L388) | Logger::error($errstr); |
| [389](#L389) | return; |
| [390](#L390) | } |
| [391](#L391) | if (strpos($errfile, 'pclzip') !== false) { |
| [392](#L392) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [393](#L393) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#08' . '|' . $errno); |
| [394](#L394) | Logger::error($errstr); |
| [395](#L395) | return; |
| [396](#L396) | } |
| [397](#L397) | if (strpos($errstr, 'rename(') !== false) { |
| [398](#L398) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [399](#L399) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#09' . '|' . $errno); |
| [400](#L400) | Logger::error($errstr); |
| [401](#L401) | $this->migration\_progress->log(\_\_("Cannot move: ", 'backup-backup') . $errstr, 'warn'); |
| [402](#L402) | return; |
| [403](#L403) | } |
| [404](#L404) |  |
| [405](#L405) | $this->migration\_progress->log(\_\_("There was an error during restore process:", 'backup-backup'), 'error'); |
| [406](#L406) | $this->migration\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'error'); |
| [407](#L407) | $this->migration\_progress->log(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline, 'error'); |
| [408](#L408) |  |
| [409](#L409) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock'); |
| [410](#L410) |  |
| [411](#L411) | $this->migration\_progress->log(\_\_("Aborting restore process...", 'backup-backup'), 'step'); |
| [412](#L412) |  |
| [413](#L413) | if (isset($GLOBALS['bmi\_current\_tmp\_restore']) && !empty($GLOBALS['bmi\_current\_tmp\_restore'])) { |
| [414](#L414) |  |
| [415](#L415) | $this->migration\_progress->log(\_\_("Cleaning up exported files...", 'backup-backup'), 'step'); |
| [416](#L416) |  |
| [417](#L417) | $tmp\_unique = $GLOBALS['bmi\_current\_tmp\_restore\_unique']; |
| [418](#L418) | $dir = $GLOBALS['bmi\_current\_tmp\_restore']; |
| [419](#L419) | $it = new \RecursiveDirectoryIterator($dir, \RecursiveDirectoryIterator::SKIP\_DOTS); |
| [420](#L420) | $files = new \RecursiveIteratorIterator($it, \RecursiveIteratorIterator::CHILD\_FIRST); |
| [421](#L421) |  |
| [422](#L422) | $this->migration\_progress->log(\_\_('Removing ', 'backup-backup') . iterator\_count($files) . \_\_(' files', 'backup-backup'), 'INFO'); |
| [423](#L423) | foreach ($files as $file) { |
| [424](#L424) | if ($file->isDir()) { |
| [425](#L425) | @rmdir($file->getRealPath()); |
| [426](#L426) | } else { |
| [427](#L427) | @unlink($file->getRealPath()); |
| [428](#L428) | } |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | @rmdir($dir); |
| [432](#L432) |  |
| [433](#L433) | $config\_file = untrailingslashit(ABSPATH) . DIRECTORY\_SEPARATOR . 'wp-config.' . $tmp\_unique . '.php'; |
| [434](#L434) | if (file\_exists($config\_file)) @unlink($config\_file); |
| [435](#L435) |  |
| [436](#L436) | } |
| [437](#L437) |  |
| [438](#L438) | $this->migration\_progress->log(\_\_("#002", 'backup-backup'), 'end-code'); |
| [439](#L439) | $this->migration\_progress->end(); |
| [440](#L440) |  |
| [441](#L441) | $GLOBALS['bmi\_error\_handled'] = true; |
| [442](#L442) | BMP::res(['status' => 'error', 'error' => $errstr]); |
| [443](#L443) | exit; |
| [444](#L444) |  |
| [445](#L445) | }, E\_ALL); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | public function backupExceptionHandler() { |
| [449](#L449) | set\_exception\_handler(function ($exception) { |
| [450](#L450) | if (BMI\_DEBUG) { |
| [451](#L451) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (EXCEPTION HANDLER #2):'); |
| [452](#L452) | error\_log(print\_r($exception, true)); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | $this->zip\_progress->log(\_\_("Exception: ", 'backup-backup') . $exception->getMessage(), 'warn'); |
| [456](#L456) | Logger::log(\_\_("Exception: ", 'backup-backup') . $exception->getMessage()); |
| [457](#L457) | }); |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | public function resetLatestLogs() { |
| [461](#L461) |  |
| [462](#L462) | // Restore htaccess |
| [463](#L463) | BMP::revertLitespeed(); |
| [464](#L464) | BMP::fixLitespeed(); |
| [465](#L465) |  |
| [466](#L466) | // Check time if not bugged |
| [467](#L467) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) > 65) { |
| [468](#L468) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [469](#L469) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | // Check if backup is not in progress |
| [473](#L473) | if (file\_exists(BMI\_BACKUPS . '/.running')) { |
| [474](#L474) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | // Remove too large logs |
| [478](#L478) | $completeLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'complete\_logs.log'; |
| [479](#L479) | if (file\_exists($completeLogsPath) && (filesize($completeLogsPath) / 1024 / 1024) >= 3) { |
| [480](#L480) | @unlink($completeLogsPath); |
| [481](#L481) | } |
| [482](#L482) |  |
| [483](#L483) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [484](#L484) | if (file\_exists($backgroundLogsPath) && (filesize($backgroundLogsPath) / 1024 / 1024) >= 3) { |
| [485](#L485) | @unlink($backgroundLogsPath); |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | @touch($completeLogsPath); |
| [489](#L489) | @touch($backgroundLogsPath); |
| [490](#L490) |  |
| [491](#L491) | // Require logs |
| [492](#L492) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [493](#L493) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [494](#L494) | require\_once BMI\_INCLUDES . '/progress/staging.php'; |
| [495](#L495) |  |
| [496](#L496) | // Write initial |
| [497](#L497) | $zip\_progress = new Progress('', 0); |
| [498](#L498) | $zip\_progress->start(); |
| [499](#L499) | $zip\_progress->log(\_\_("Initializing backup...", 'backup-backup'), 'step'); |
| [500](#L500) | $zip\_progress->progress('0/100'); |
| [501](#L501) | $zip\_progress->end(); |
| [502](#L502) |  |
| [503](#L503) | // Write initial |
| [504](#L504) | $migration = new MigrationProgress(false); |
| [505](#L505) | $migration->start(); |
| [506](#L506) | $migration->log(\_\_('Initializing restore process', 'backup-backup'), 'STEP'); |
| [507](#L507) | $migration->progress('0'); |
| [508](#L508) | $migration->end(); |
| [509](#L509) |  |
| [510](#L510) | // Write initial |
| [511](#L511) | $staging = new StagingProgress(false); |
| [512](#L512) | $staging->start(); |
| [513](#L513) | $staging->log(\_\_('Preparing creation of staging site...', 'backup-backup'), 'STEP'); |
| [514](#L514) | $staging->progress('0'); |
| [515](#L515) | $staging->end(); |
| [516](#L516) |  |
| [517](#L517) | // Return done |
| [518](#L518) | return ['status' => 'success']; |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | public function makeBackupName() { |
| [522](#L522) | $name = Dashboard\bmi\_get\_config('BACKUP:NAME'); |
| [523](#L523) |  |
| [524](#L524) | $urlparts = parse\_url(home\_url()); |
| [525](#L525) | $domain = str\_replace('.', '-', sanitize\_text\_field($urlparts['host'])); |
| [526](#L526) |  |
| [527](#L527) | $hash = BMP::randomString(16); |
| [528](#L528) | $name = str\_replace('%domain', $domain, $name); |
| [529](#L529) | $name = str\_replace('%hash', $hash, $name); |
| [530](#L530) | $name = str\_replace('%Y', date('Y'), $name); |
| [531](#L531) | $name = str\_replace('%M', date('M'), $name); |
| [532](#L532) | $name = str\_replace('%D', date('D'), $name); |
| [533](#L533) | $name = str\_replace('%d', date('d'), $name); |
| [534](#L534) | $name = str\_replace('%j', date('j'), $name); |
| [535](#L535) | $name = str\_replace('%m', date('m'), $name); |
| [536](#L536) | $name = str\_replace('%n', date('n'), $name); |
| [537](#L537) | $name = str\_replace('%Y', date('Y'), $name); |
| [538](#L538) | $name = str\_replace('%y', date('y'), $name); |
| [539](#L539) | $name = str\_replace('%a', date('a'), $name); |
| [540](#L540) | $name = str\_replace('%A', date('A'), $name); |
| [541](#L541) | $name = str\_replace('%B', date('B'), $name); |
| [542](#L542) | $name = str\_replace('%g', date('g'), $name); |
| [543](#L543) | $name = str\_replace('%G', date('G'), $name); |
| [544](#L544) | $name = str\_replace('%h', date('h'), $name); |
| [545](#L545) | $name = str\_replace('%H', date('H'), $name); |
| [546](#L546) | $name = str\_replace('%i', date('i'), $name); |
| [547](#L547) | $name = str\_replace('%s', date('s'), $name); |
| [548](#L548) | $name = str\_replace('%s', date('s'), $name); |
| [549](#L549) |  |
| [550](#L550) | $i = 2; |
| [551](#L551) | $tmpname = $name; |
| [552](#L552) |  |
| [553](#L553) | while (file\_exists($tmpname . '.zip')) { |
| [554](#L554) | $tmpname = $name . '\_' . $i; |
| [555](#L555) | $i++; |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | $name = $tmpname . '.zip'; |
| [559](#L559) |  |
| [560](#L560) | $GLOBALS['bmi\_current\_backup\_name'] = $name; |
| [561](#L561) | return $name; |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | public function fixUnameFunction() { |
| [565](#L565) | $file = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip.php'; |
| [566](#L566) | $backup = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip-backup.php'; |
| [567](#L567) |  |
| [568](#L568) | // Make backup |
| [569](#L569) | if (!file\_exists($backup)) { |
| [570](#L570) | @copy($file, $backup); |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | // Replace deprecated php\_uname function which is mostly disabled and cause errors |
| [574](#L574) | $replace = file\_get\_contents($file); |
| [575](#L575) | $replace = str\_replace('php\_uname()', '(DIRECTORY\_SEPARATOR === "/" ? "linux" : "windows")', $replace); |
| [576](#L576) | file\_put\_contents($file, $replace); |
| [577](#L577) | return ['status' => 'success']; |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | public function revertUnameProcess() { |
| [581](#L581) | $file = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip.php'; |
| [582](#L582) | $backup = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip-backup.php'; |
| [583](#L583) | if (file\_exists($backup)) { |
| [584](#L584) | if (file\_exists($file)) @unlink($file); |
| [585](#L585) | @copy($backup, $file); |
| [586](#L586) | } |
| [587](#L587) | return ['status' => 'success']; |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | public function prepareAndMakeBackup($cron = false) { |
| [591](#L591) |  |
| [592](#L592) | global $wp\_version; |
| [593](#L593) |  |
| [594](#L594) | // Require File Scanner |
| [595](#L595) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [596](#L596) | require\_once BMI\_INCLUDES . '/check/checker.php'; |
| [597](#L597) |  |
| [598](#L598) | // CLI Handler |
| [599](#L599) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [600](#L600) |  |
| [601](#L601) | // Backup name |
| [602](#L602) | if (defined('BMI\_CLI\_ARGUMENT') && !empty(BMI\_CLI\_ARGUMENT)) { |
| [603](#L603) | $name = BMI\_CLI\_ARGUMENT; |
| [604](#L604) | } else { |
| [605](#L605) | $name = $this->makeBackupName(); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | // Progress & Logs |
| [609](#L609) | $cliRunning = (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) ? true : false; |
| [610](#L610) | $shouldResetLogs = !$cliRunning; |
| [611](#L611) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP\_VIA\_CLI')) { |
| [612](#L612) | $cron = true; |
| [613](#L613) | $shouldResetLogs = true; |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | $clearEndCodes = false; |
| [617](#L617) | if (isset($this->post['preserveLogs']) && ($this->post['preserveLogs'] == 'true' || $this->post['preserveLogs'] === true)) { |
| [618](#L618) | $shouldResetLogs = false; |
| [619](#L619) | $clearEndCodes = true; |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | $zip\_progress = new Progress($name, 100, 0, $cron, $shouldResetLogs, $clearEndCodes); |
| [623](#L623) | $zip\_progress->start(); |
| [624](#L624) |  |
| [625](#L625) | // PHP CLI Check |
| [626](#L626) | $isCLI = false; |
| [627](#L627) | $cli\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli'; |
| [628](#L628) | $cli\_lock\_end = BMI\_BACKUPS . '/.backup\_lock\_cli\_end'; |
| [629](#L629) | $cli\_failed\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli\_failed'; |
| [630](#L630) |  |
| [631](#L631) | if (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) { |
| [632](#L632) |  |
| [633](#L633) | $cli\_result = $this->checkIfPHPCliExist($zip\_progress); |
| [634](#L634) | if ($cli\_result !== false && BMI\_FUNCTION\_NORMAL === true) { |
| [635](#L635) |  |
| [636](#L636) | $res = null; |
| [637](#L637) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP')) { |
| [638](#L638) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_backup\_cron ' . $name . ' > /dev/null &', $res); |
| [639](#L639) | } else { |
| [640](#L640) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_backup ' . $name . ' > /dev/null &', $res); |
| [641](#L641) | } |
| [642](#L642) | $res = implode("\n", $res); |
| [643](#L643) |  |
| [644](#L644) | sleep(3); |
| [645](#L645) |  |
| [646](#L646) | if (file\_exists($cli\_lock\_end) && (time() - filemtime($cli\_lock\_end)) < 10) { |
| [647](#L647) |  |
| [648](#L648) | if (file\_exists($cli\_lock\_end)) @unlink($cli\_lock\_end); |
| [649](#L649) | return ['status' => 'success', 'filename' => $name]; |
| [650](#L650) | exit; |
| [651](#L651) |  |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | if (!file\_exists($cli\_lock) || (time() - filemtime($cli\_lock)) > 10) { |
| [655](#L655) |  |
| [656](#L656) | if (!file\_exists(BMI\_BACKUPS . '/.abort') || (time() - filemtime(BMI\_BACKUPS . '/.abort')) > 10) { |
| [657](#L657) |  |
| [658](#L658) | $zip\_progress->log(\_\_("Something went wrong in PHP CLI process, backup will be continued with legacy methods.", 'backup-backup'), 'warn'); |
| [659](#L659) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [660](#L660) | define('BMI\_CLI\_FAILED', true); |
| [661](#L661) | touch($cli\_failed\_lock); |
| [662](#L662) |  |
| [663](#L663) | } else { |
| [664](#L664) |  |
| [665](#L665) | $zip\_progress->log(\_\_("Backup will not be continued due to manual abort by user.", 'backup-backup'), 'warn'); |
| [666](#L666) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [667](#L667) | return ['status' => 'msg', 'why' => \_\_('Backup process aborted.', 'backup-backup'), 'level' => 'info']; |
| [668](#L668) |  |
| [669](#L669) | } |
| [670](#L670) |  |
| [671](#L671) | } else { |
| [672](#L672) |  |
| [673](#L673) | return ['status' => 'background', 'filename' => $name]; |
| [674](#L674) |  |
| [675](#L675) | } |
| [676](#L676) |  |
| [677](#L677) | } else { |
| [678](#L678) |  |
| [679](#L679) | if (BMI\_FUNCTION\_NORMAL !== true) { |
| [680](#L680) | $zip\_progress->log(\_\_("PHP CLI will not run due to user settings in plugin other options.", 'backup-backup'), 'warn'); |
| [681](#L681) | } else { |
| [682](#L682) | $zip\_progress->log(\_\_("PHP CLI file cannot be executed due to unknown reason.", 'backup-backup'), 'warn'); |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | } else { |
| [688](#L688) |  |
| [689](#L689) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [690](#L690) |  |
| [691](#L691) | if (!file\_exists($cli\_failed\_lock) || (time() - filemtime($cli\_failed\_lock)) < 10) { |
| [692](#L692) | exit; |
| [693](#L693) | } |
| [694](#L694) |  |
| [695](#L695) | $isCLI = true; |
| [696](#L696) | $zip\_progress->log(\_\_("Backup via PHP CLI initialized successfully.", 'backup-backup'), 'success'); |
| [697](#L697) | touch($cli\_lock); |
| [698](#L698) |  |
| [699](#L699) | } |
| [700](#L700) |  |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | // Just in case (e.g. syntax error, we can close the file correctly) |
| [704](#L704) | $GLOBALS['bmi\_backup\_progress'] = $zip\_progress; |
| [705](#L705) |  |
| [706](#L706) | // Logs |
| [707](#L707) | $zip\_progress->log(\_\_("Initializing backup...", 'backup-backup'), 'step'); |
| [708](#L708) | $zip\_progress->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION), 'info'); |
| [709](#L709) | $zip\_progress->log(\_\_("Site which will be backed up: ", 'backup-backup') . site\_url(), 'info'); |
| [710](#L710) | $zip\_progress->log(\_\_("PHP Version: ", 'backup-backup') . PHP\_VERSION, 'info'); |
| [711](#L711) | $zip\_progress->log(\_\_("WP Version: ", 'backup-backup') . $wp\_version, 'info'); |
| [712](#L712) | $zip\_progress->log(\_\_("MySQL Version: ", 'backup-backup') . $GLOBALS['wpdb']->db\_version(), 'info'); |
| [713](#L713) | $zip\_progress->log(\_\_("MySQL Max Length: ", 'backup-backup') . $GLOBALS['wpdb']->get\_results("SHOW VARIABLES LIKE 'max\_allowed\_packet';")[0]->Value, 'info'); |
| [714](#L714) | if (isset($\_SERVER['SERVER\_SOFTWARE']) && !empty($\_SERVER['SERVER\_SOFTWARE'])) { |
| [715](#L715) | $zip\_progress->log(\_\_("Web server: ", 'backup-backup') . $\_SERVER['SERVER\_SOFTWARE'], 'info'); |
| [716](#L716) | } else { |
| [717](#L717) | $zip\_progress->log(\_\_("Web server: Not available", 'backup-backup'), 'info'); |
| [718](#L718) | } |
| [719](#L719) | $zip\_progress->log(\_\_("Max execution time (in seconds): ", 'backup-backup') . @ini\_get('max\_execution\_time'), 'info'); |
| [720](#L720) |  |
| [721](#L721) | $zip\_progress->log(\_\_("Memory limit (server): ", 'backup-backup') . @ini\_get('memory\_limit'), 'info'); |
| [722](#L722) | if (defined('WP\_MEMORY\_LIMIT')) { |
| [723](#L723) | $zip\_progress->log(\_\_("Memory limit (wp-config): ", 'backup-backup') . WP\_MEMORY\_LIMIT, 'info'); |
| [724](#L724) | } |
| [725](#L725) | if (defined('WP\_MAX\_MEMORY\_LIMIT')) { |
| [726](#L726) | $zip\_progress->log(\_\_("Memory limit (wp-config admin): ", 'backup-backup') . WP\_MAX\_MEMORY\_LIMIT, 'info'); |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | if (defined('BMI\_DB\_MAX\_ROWS\_PER\_QUERY')) { |
| [730](#L730) | $zip\_progress->log(\_\_('Max rows per query (this site): ', 'backup-backup') . BMI\_DB\_MAX\_ROWS\_PER\_QUERY, 'info'); |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | $zip\_progress->log(\_\_("Checking if backup dir is writable...", 'backup-backup'), 'info'); |
| [734](#L734) |  |
| [735](#L735) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP')) { |
| [736](#L736) | $zip\_progress->log(\_\_("This process was initialized due to scheduled backup configuration...", 'backup-backup'), 'info'); |
| [737](#L737) | $zip\_progress->log(\_\_("Backup will be unlocked by default as it is not manual backup...", 'backup-backup'), 'info'); |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | if (defined('BMI\_BACKUP\_PRO')) { |
| [741](#L741) | if (BMI\_BACKUP\_PRO == 1) { |
| [742](#L742) | $zip\_progress->log(\_\_("Premium plugin is enabled and activated", 'backup-backup'), 'info'); |
| [743](#L743) | } else { |
| [744](#L744) | $zip\_progress->log(\_\_("Premium version is enabled but not active, using free plugin.", 'backup-backup'), 'warn'); |
| [745](#L745) | } |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | // Error handler |
| [749](#L749) | $zip\_progress->log(\_\_("Initializing custom error handler", 'backup-backup'), 'info'); |
| [750](#L750) | $this->zip\_progress = &$zip\_progress; |
| [751](#L751) | $this->backupErrorHandler(); |
| [752](#L752) | $this->backupExceptionHandler(); |
| [753](#L753) |  |
| [754](#L754) | // Checker |
| [755](#L755) | $checker = new Checker($zip\_progress); |
| [756](#L756) |  |
| [757](#L757) | if (!is\_writable(dirname(BMI\_BACKUPS))) { |
| [758](#L758) |  |
| [759](#L759) | // Abort backup |
| [760](#L760) | $zip\_progress->log(\_\_("Backup directory is not writable...", 'backup-backup'), 'error'); |
| [761](#L761) | $zip\_progress->log(\_\_("Path: ", 'backup-backup') . BMI\_BACKUPS, 'error'); |
| [762](#L762) |  |
| [763](#L763) | // Close backup |
| [764](#L764) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [765](#L765) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [766](#L766) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [767](#L767) |  |
| [768](#L768) | // Log and close log |
| [769](#L769) | $zip\_progress->log('#002', 'END-CODE'); |
| [770](#L770) | $zip\_progress->end(); |
| [771](#L771) |  |
| [772](#L772) | if ($isCLI === true) touch($cli\_lock\_end); |
| [773](#L773) | $this->actionsAfterProcess(); |
| [774](#L774) |  |
| [775](#L775) | // Return error |
| [776](#L776) | if ($cron == true) return ['status' => 'success']; |
| [777](#L777) | else return ['status' => 'error']; |
| [778](#L778) | } else { |
| [779](#L779) | $zip\_progress->log(\_\_("Yup it is writable...", 'backup-backup'), 'success'); |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | if (!file\_exists(BMI\_BACKUPS)) @mkdir(BMI\_BACKUPS, true); |
| [783](#L783) |  |
| [784](#L784) | // Get list of staging sites for exclusion rules |
| [785](#L785) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [786](#L786) | $staging = new Staging('..ajax..'); |
| [787](#L787) | $stagingSites = $staging->getStagingSites(true); |
| [788](#L788) |  |
| [789](#L789) | // Get file names (huge list mostly) |
| [790](#L790) | if ($fgwp = Dashboard\bmi\_get\_config('BACKUP:FILES') == 'true') { |
| [791](#L791) | $zip\_progress->log(\_\_("Scanning files...", 'backup-backup'), 'step'); |
| [792](#L792) | $files = $this->scanFilesForBackup($zip\_progress, $stagingSites); |
| [793](#L793) | $files = $this->parseFilesForBackup($files, $zip\_progress, $cron); |
| [794](#L794) | } else { |
| [795](#L795) | $zip\_progress->log(\_\_("Omitting files (due to settings)...", 'backup-backup'), 'warn'); |
| [796](#L796) | $files = []; |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | $zip\_progress->log(str\_replace('%s', $this->total\_excluded\_size\_for\_backup, \_\_("Total size of excluded files: %s bytes", 'backup-backup')), 'info'); |
| [800](#L800) | $zip\_progress->log("Total size of excluded files (bytes): " . $this->total\_excluded\_size\_for\_backup, 'verbose'); |
| [801](#L801) |  |
| [802](#L802) | // Check if there is enough space |
| [803](#L803) | $bytes = intval($this->total\_size\_for\_backup \* 1.4); |
| [804](#L804) | $zip\_progress->log(\_\_("Checking free space, reserving...", 'backup-backup'), 'step'); |
| [805](#L805) | if ($this->total\_size\_for\_backup\_in\_mb >= BMI\_REV \* 1000 && add\_option('bmip\_last', false) != '1') { |
| [806](#L806) |  |
| [807](#L807) | // Abort backup |
| [808](#L808) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [809](#L809) | $zip\_progress->log(str\_replace('%s', BMI\_REV, \_\_("Site weights more than %s GB.", 'backup-backup')), 'error'); |
| [810](#L810) | $zip\_progress->log(print\_r($this->post, true), 'verbose'); |
| [811](#L811) |  |
| [812](#L812) | // Close backup |
| [813](#L813) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [814](#L814) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [815](#L815) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [816](#L816) |  |
| [817](#L817) | // Log and close log |
| [818](#L818) | $zip\_progress->log('#100', 'END-CODE'); |
| [819](#L819) | $zip\_progress->end(); |
| [820](#L820) |  |
| [821](#L821) | if ($isCLI === true) touch($cli\_lock\_end); |
| [822](#L822) | $this->actionsAfterProcess(); |
| [823](#L823) |  |
| [824](#L824) | // Return error |
| [825](#L825) | return ['status' => 'error', 'bfs' => true]; |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | $isSpaceCheckDisabled = Dashboard\bmi\_get\_config('OTHER:BACKUP:SPACE:CHECKING'); |
| [829](#L829) |  |
| [830](#L830) | if ($isSpaceCheckDisabled) { |
| [831](#L831) |  |
| [832](#L832) | $zip\_progress->log(\_\_("Free space checking is disabled by user in settings...", 'backup-backup'), 'warn'); |
| [833](#L833) | $zip\_progress->log(\_\_("Backup will continue, trusting there is enough space...", 'backup-backup'), 'warn'); |
| [834](#L834) |  |
| [835](#L835) | } else { |
| [836](#L836) |  |
| [837](#L837) | if (!$checker->check\_free\_space($bytes)) { |
| [838](#L838) |  |
| [839](#L839) | // Abort backup |
| [840](#L840) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [841](#L841) | $zip\_progress->log(\_\_("There is no space for that backup, checked: ", 'backup-backup') . ($bytes) . \_\_(" bytes", 'backup-backup'), 'error'); |
| [842](#L842) |  |
| [843](#L843) | // Close backup |
| [844](#L844) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [845](#L845) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [846](#L846) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [847](#L847) |  |
| [848](#L848) | // Log and close log |
| [849](#L849) | $zip\_progress->log('#002', 'END-CODE'); |
| [850](#L850) | $zip\_progress->end(); |
| [851](#L851) |  |
| [852](#L852) | if ($isCLI === true) touch($cli\_lock\_end); |
| [853](#L853) | $this->actionsAfterProcess(); |
| [854](#L854) |  |
| [855](#L855) | // Return error |
| [856](#L856) | if ($cron == true) return ['status' => 'success']; |
| [857](#L857) | else return ['status' => 'error']; |
| [858](#L858) | } else { |
| [859](#L859) | $zip\_progress->log(\_\_("Confirmed, there is more than enough space, checked: ", 'backup-backup') . ($bytes) . \_\_(" bytes", 'backup-backup'), 'success'); |
| [860](#L860) | $zip\_progress->bytes = $this->total\_size\_for\_backup; |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | if (Dashboard\bmi\_get\_config('BACKUP:DATABASE') != 'true') { |
| [866](#L866) |  |
| [867](#L867) | // $zip\_progress->log(\_\_("Database won't be backed-up due to user settings, omitting...", 'backup-backup'), 'info'); |
| [868](#L868) | // Commented as message will be shown in database backup module |
| [869](#L869) |  |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | // Log and set files length |
| [873](#L873) | $zip\_progress->log(\_\_("Scanning done - found ", 'backup-backup') . sizeof($files) . \_\_(" files...", 'backup-backup'), 'info'); |
| [874](#L874) | $zip\_progress->files = sizeof($files); |
| [875](#L875) |  |
| [876](#L876) | // Make Backup |
| [877](#L877) | $zip\_progress->log(\_\_("Backup initialized...", 'backup-backup'), 'success'); |
| [878](#L878) | $zip\_progress->log(\_\_("Initializing archiving system...", 'backup-backup'), 'step'); |
| [879](#L879) |  |
| [880](#L880) | $bckpres = $this->createBackup($files, ABSPATH, $name, $zip\_progress, $cron, $isCLI); |
| [881](#L881) | if ($cron == true) return ['status' => 'success']; |
| [882](#L882) | else return $bckpres; |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | public function fixLitespeed() { |
| [886](#L886) | BMP::fixLitespeed(); |
| [887](#L887) |  |
| [888](#L888) | return ['status' => 'success']; |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | public function revertLitespeed() { |
| [892](#L892) | BMP::revertLitespeed(); |
| [893](#L893) |  |
| [894](#L894) | return ['status' => 'success']; |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | public function createBackup($files, $base, $name, &$zip\_progress, $cron = false, $isCLI = false) { |
| [898](#L898) |  |
| [899](#L899) | // Require File Zipper |
| [900](#L900) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [901](#L901) |  |
| [902](#L902) | // CLI locks |
| [903](#L903) | $cli\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli'; |
| [904](#L904) | $cli\_lock\_end = BMI\_BACKUPS . '/.backup\_lock\_cli\_end'; |
| [905](#L905) | $cli\_failed\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli\_failed'; |
| [906](#L906) |  |
| [907](#L907) | // Backup name |
| [908](#L908) | $backup\_path = BMI\_BACKUPS . '/' . $name; |
| [909](#L909) |  |
| [910](#L910) | // Check time if not bugged |
| [911](#L911) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) > 65) { |
| [912](#L912) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [913](#L913) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [914](#L914) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [915](#L915) | if ($isCLI === true && file\_exists($cli\_lock\_end)) @unlink($cli\_lock\_end); |
| [916](#L916) | } |
| [917](#L917) |  |
| [918](#L918) | if ($isCLI === true) { |
| [919](#L919) | if (!file\_exists($cli\_failed\_lock) || (time() - filemtime($cli\_failed\_lock)) < 10) { |
| [920](#L920) | exit; |
| [921](#L921) | } |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | // Mark as in progress |
| [925](#L925) | if (!file\_exists(BMI\_BACKUPS . '/.running')) { |
| [926](#L926) | touch(BMI\_BACKUPS . '/.running'); |
| [927](#L927) | if ($isCLI === true) touch($cli\_lock); |
| [928](#L928) | } else { |
| [929](#L929) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | // Initialized |
| [933](#L933) | $zip\_progress->log(\_\_("Archive system initialized...", 'backup-backup'), 'success'); |
| [934](#L934) |  |
| [935](#L935) | // Make ZIP |
| [936](#L936) | $zipper = new Zipper(); |
| [937](#L937) | $zippy = $zipper->makeZIP($files, $backup\_path, $name, $zip\_progress, $cron); |
| [938](#L938) | if (!$zippy) { |
| [939](#L939) |  |
| [940](#L940) | // Make sure it's open |
| [941](#L941) | $zip\_progress->start(); |
| [942](#L942) |  |
| [943](#L943) | // Abort backup |
| [944](#L944) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [945](#L945) |  |
| [946](#L946) | // Close backup |
| [947](#L947) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [948](#L948) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [949](#L949) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [950](#L950) |  |
| [951](#L951) | // Log and close log |
| [952](#L952) | $zip\_progress->log('#002', 'END-CODE'); |
| [953](#L953) | $zip\_progress->end(); |
| [954](#L954) |  |
| [955](#L955) | if ($isCLI === true) touch($cli\_lock\_end); |
| [956](#L956) |  |
| [957](#L957) | // Return error |
| [958](#L958) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [959](#L959) |  |
| [960](#L960) | $this->actionsAfterProcess(); |
| [961](#L961) | return ['status' => 'error']; |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | // Backup aborted |
| [965](#L965) | if (file\_exists(BMI\_BACKUPS . '/.abort')) { |
| [966](#L966) |  |
| [967](#L967) | // Make sure it's open |
| [968](#L968) | $zip\_progress->start(); |
| [969](#L969) |  |
| [970](#L970) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [971](#L971) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [972](#L972) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [973](#L973) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [974](#L974) |  |
| [975](#L975) | // Log and close log |
| [976](#L976) | $zip\_progress->log(\_\_("Backup process aborted.", 'backup-backup'), 'warn'); |
| [977](#L977) | $zip\_progress->log('#002', 'END-CODE'); |
| [978](#L978) | $zip\_progress->end(); |
| [979](#L979) |  |
| [980](#L980) | if ($isCLI === true) touch($cli\_lock\_end); |
| [981](#L981) | Logger::log(\_\_("Backup process aborted.", 'backup-backup')); |
| [982](#L982) |  |
| [983](#L983) | $this->actionsAfterProcess(); |
| [984](#L984) | return ['status' => 'msg', 'why' => \_\_('Backup process aborted.', 'backup-backup'), 'level' => 'info']; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | if (!file\_exists($backup\_path) && !$cron) { |
| [988](#L988) |  |
| [989](#L989) | // Make sure it's open |
| [990](#L990) | $zip\_progress->start(); |
| [991](#L991) |  |
| [992](#L992) | // Abort backup |
| [993](#L993) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [994](#L994) | $zip\_progress->log(\_\_("There is no backup file...", 'backup-backup'), 'error'); |
| [995](#L995) | $zip\_progress->log(\_\_("We could not find backup file when it already should be here.", 'backup-backup'), 'error'); |
| [996](#L996) | $zip\_progress->log(\_\_("This error may be related to missing space. (filled during backup)", 'backup-backup'), 'error'); |
| [997](#L997) | $zip\_progress->log(\_\_("Path: ", 'backup-backup') . $backup\_path, 'error'); |
| [998](#L998) |  |
| [999](#L999) | // Close backup |
| [1000](#L1000) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [1001](#L1001) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [1002](#L1002) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1003](#L1003) |  |
| [1004](#L1004) | // Log and close log |
| [1005](#L1005) | $zip\_progress->log('#002', 'END-CODE'); |
| [1006](#L1006) | $zip\_progress->end(); |
| [1007](#L1007) |  |
| [1008](#L1008) | if ($isCLI === true) touch($cli\_lock\_end); |
| [1009](#L1009) | $this->actionsAfterProcess(); |
| [1010](#L1010) |  |
| [1011](#L1011) | // Return error |
| [1012](#L1012) | if ($cron == true) return ['status' => 'success']; |
| [1013](#L1013) | else return ['status' => 'error']; |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | // End zip log |
| [1017](#L1017) | $zip\_progress->log(\_\_("New backup created and its name is: ", 'backup-backup') . $name, 'success'); |
| [1018](#L1018) | $zip\_progress->log('#001', 'END-CODE'); |
| [1019](#L1019) | $zip\_progress->end(); |
| [1020](#L1020) |  |
| [1021](#L1021) | if ($isCLI === true) touch($cli\_lock\_end); |
| [1022](#L1022) |  |
| [1023](#L1023) | // Unlink progress |
| [1024](#L1024) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [1025](#L1025) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [1026](#L1026) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1027](#L1027) |  |
| [1028](#L1028) | // Return |
| [1029](#L1029) | Logger::log(\_\_("New backup created and its name is: ", 'backup-backup') . $name); |
| [1030](#L1030) |  |
| [1031](#L1031) | $GLOBALS['bmi\_error\_handled'] = true; |
| [1032](#L1032) |  |
| [1033](#L1033) | $this->actionsAfterProcess(true); |
| [1034](#L1034) | return ['status' => 'success', 'filename' => $name, 'root' => plugin\_dir\_url(BMI\_ROOT\_FILE)]; |
| [1035](#L1035) |  |
| [1036](#L1036) | } |
| [1037](#L1037) |  |
| [1038](#L1038) | public function continueRestoreProcess() { |
| [1039](#L1039) |  |
| [1040](#L1040) | // BMI\_RESTORE\_SECRET |
| [1041](#L1041) |  |
| [1042](#L1042) | } |
| [1043](#L1043) |  |
| [1044](#L1044) | public function getBackupsList() { |
| [1045](#L1045) |  |
| [1046](#L1046) | // Require File Scanner |
| [1047](#L1047) | require\_once BMI\_INCLUDES . '/scanner/backups.php'; |
| [1048](#L1048) |  |
| [1049](#L1049) | // Get backups |
| [1050](#L1050) | $backups = new Backups(); |
| [1051](#L1051) | $manifests = $backups->getAvailableBackups(); |
| [1052](#L1052) |  |
| [1053](#L1053) | // Return files |
| [1054](#L1054) | return ['status' => 'success', 'backups' => $manifests]; |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | public function sendTestMail() { |
| [1058](#L1058) |  |
| [1059](#L1059) | $email = Dashboard\bmi\_get\_config('OTHER:EMAIL') != false ? Dashboard\bmi\_get\_config('OTHER:EMAIL') : get\_bloginfo('admin\_email'); |
| [1060](#L1060) | $subject = \_\_('Backup Migration – Example email', 'backup-backup'); |
| [1061](#L1061) | $message = \_\_('This is a test email sent by the Backup Migration plugin via Troubleshooting options!', 'backup-backup'); |
| [1062](#L1062) |  |
| [1063](#L1063) | try { |
| [1064](#L1064) |  |
| [1065](#L1065) | if (wp\_mail($email, $subject, $message)) return [ 'status' => 'success' ]; |
| [1066](#L1066) | else return ['status' => 'error']; |
| [1067](#L1067) |  |
| [1068](#L1068) | } catch (\Exception $e) { |
| [1069](#L1069) |  |
| [1070](#L1070) | return ['status' => 'error']; |
| [1071](#L1071) |  |
| [1072](#L1072) | } catch (\Throwable $e) { |
| [1073](#L1073) |  |
| [1074](#L1074) | return ['status' => 'error']; |
| [1075](#L1075) |  |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | } |
| [1079](#L1079) |  |
| [1080](#L1080) | public function restoreBackup() { |
| [1081](#L1081) |  |
| [1082](#L1082) | global $wp\_version; |
| [1083](#L1083) |  |
| [1084](#L1084) | // Require File Scanner |
| [1085](#L1085) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [1086](#L1086) | require\_once BMI\_INCLUDES . '/extracter/extract.php'; |
| [1087](#L1087) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1088](#L1088) | require\_once BMI\_INCLUDES . '/check/checker.php'; |
| [1089](#L1089) |  |
| [1090](#L1090) | // Make AutoLogin possible |
| [1091](#L1091) | $ip = '127.0.0.1'; |
| [1092](#L1092) | if (isset($\_SERVER['HTTP\_CLIENT\_IP'])) { |
| [1093](#L1093) | $ip = $\_SERVER['HTTP\_CLIENT\_IP']; |
| [1094](#L1094) | } else { |
| [1095](#L1095) | if (isset($\_SERVER['HTTP\_X\_FORWARDED\_FOR'])) { |
| [1096](#L1096) | $ip = $\_SERVER['HTTP\_X\_FORWARDED\_FOR']; |
| [1097](#L1097) | } |
| [1098](#L1098) | if ($ip === false) { |
| [1099](#L1099) | if (isset($\_SERVER['REMOTE\_ADDR'])) $ip = $\_SERVER['REMOTE\_ADDR']; |
| [1100](#L1100) | } |
| [1101](#L1101) | } |
| [1102](#L1102) | $autoLoginMD = time() . '\_' . $ip . '\_' . '4u70L051n'; |
| [1103](#L1103) |  |
| [1104](#L1104) | // Progress & lock file |
| [1105](#L1105) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1106](#L1106) | $lock\_cli = BMI\_BACKUPS . '/.migration\_lock\_cli'; |
| [1107](#L1107) | $autologin\_file = BMI\_BACKUPS . '/.autologin'; |
| [1108](#L1108) | $lock\_cli\_end = BMI\_BACKUPS . '/.migration\_lock\_ended'; |
| [1109](#L1109) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1110](#L1110) | $cli\_last\_download = BMI\_BACKUPS . '/.cli\_download\_last'; |
| [1111](#L1111) |  |
| [1112](#L1112) | $ignoreRunCheck = ((isset($this->post['ignoreRunning']) && $this->post['ignoreRunning'] == 'true') ? true : false); |
| [1113](#L1113) | $isCLIRunning = (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) ? true : false; |
| [1114](#L1114) | if ($isCLIRunning) $ignoreRunCheck = false; |
| [1115](#L1115) |  |
| [1116](#L1116) | if (file\_exists($lock) && (time() - filemtime($lock)) < 65 && !$ignoreRunCheck) { |
| [1117](#L1117) | return ['status' => 'msg', 'why' => \_\_('The restore process is currently running, please wait till it end or once the lock file expire.', 'backup-backup'), 'level' => 'warning']; |
| [1118](#L1118) | } |
| [1119](#L1119) |  |
| [1120](#L1120) | // Check if download was via CLI |
| [1121](#L1121) | if ($this->post['file'] == '.cli\_download' && file\_exists($cli\_last\_download)) { |
| [1122](#L1122) | $this->post['file'] = file\_get\_contents($cli\_last\_download); |
| [1123](#L1123) | if (file\_exists($cli\_last\_download)) @unlink($cli\_last\_download); |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | // Logs |
| [1127](#L1127) | $migration = new MigrationProgress($this->post['remote']); |
| [1128](#L1128) | $migration->start(); |
| [1129](#L1129) |  |
| [1130](#L1130) | if ($ignoreRunCheck) { |
| [1131](#L1131) |  |
| [1132](#L1132) | $migration->mute(); |
| [1133](#L1133) |  |
| [1134](#L1134) | } |
| [1135](#L1135) |  |
| [1136](#L1136) | // Check PHP CLI |
| [1137](#L1137) | if ((!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) && (!defined('BMI\_CLI\_REQUEST') || BMI\_CLI\_REQUEST === false)) { |
| [1138](#L1138) |  |
| [1139](#L1139) | $cli\_result = $this->checkIfPHPCliExist($migration); |
| [1140](#L1140) |  |
| [1141](#L1141) | if ($cli\_result !== false) { |
| [1142](#L1142) |  |
| [1143](#L1143) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [1144](#L1144) | $backupName = sanitize\_text\_field($this->post['file']); |
| [1145](#L1145) | $remoteType = 'false'; |
| [1146](#L1146) | if ($this->post['remote'] == 'true' || $this->post['remote'] === true) $remoteType = 'true'; |
| [1147](#L1147) | if (file\_exists($lock\_cli\_end)) @unlink($lock\_cli\_end); |
| [1148](#L1148) |  |
| [1149](#L1149) | $res = null; |
| [1150](#L1150) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_restore ' . $backupName . ' ' . $remoteType . ' > /dev/null &', $res); |
| [1151](#L1151) | $res = implode("\n", $res); |
| [1152](#L1152) |  |
| [1153](#L1153) | sleep(3); |
| [1154](#L1154) |  |
| [1155](#L1155) | if (file\_exists($lock\_cli\_end) && (time() - filemtime($lock\_cli\_end)) < 10) { |
| [1156](#L1156) |  |
| [1157](#L1157) | // Put autologin |
| [1158](#L1158) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1159](#L1159) | touch($autologin\_file); |
| [1160](#L1160) |  |
| [1161](#L1161) | return ['status' => 'cli', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1162](#L1162) | exit; |
| [1163](#L1163) |  |
| [1164](#L1164) | } |
| [1165](#L1165) |  |
| [1166](#L1166) | if (!file\_exists($lock\_cli) || (time() - filemtime($lock\_cli)) > 10) { |
| [1167](#L1167) |  |
| [1168](#L1168) | $progressFile = null; |
| [1169](#L1169) | $migration->log(\_\_('No response from PHP CLI - plugin will try to recover the migration with traditional restore.', 'backup-backup'), 'warn'); |
| [1170](#L1170) | if (file\_exists($lock\_cli)) @unlink($lock\_cli); |
| [1171](#L1171) |  |
| [1172](#L1172) | } else { |
| [1173](#L1173) |  |
| [1174](#L1174) | $progressFile = null; |
| [1175](#L1175) |  |
| [1176](#L1176) | // $migration->log(\_\_('PHP CLI responded with correct code - we will continue via PHP CLI.', 'backup-backup'), 'info'); |
| [1177](#L1177) | // $migration->end(); |
| [1178](#L1178) |  |
| [1179](#L1179) | // Put autologin |
| [1180](#L1180) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1181](#L1181) | touch($autologin\_file); |
| [1182](#L1182) |  |
| [1183](#L1183) | return ['status' => 'cli', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1184](#L1184) | exit; |
| [1185](#L1185) |  |
| [1186](#L1186) | } |
| [1187](#L1187) |  |
| [1188](#L1188) | } else { |
| [1189](#L1189) |  |
| [1190](#L1190) | if (file\_exists($lock\_cli)) @unlink($lock\_cli); |
| [1191](#L1191) |  |
| [1192](#L1192) | } |
| [1193](#L1193) |  |
| [1194](#L1194) | } else { |
| [1195](#L1195) |  |
| [1196](#L1196) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [1197](#L1197) | $migration->log(\_\_('PHP CLI: Restore process initialized, restoring...', 'backup-backup'), 'success'); |
| [1198](#L1198) | touch($lock\_cli); |
| [1199](#L1199) | } else { |
| [1200](#L1200) | $migration->log(\_\_('Restore process initialized, restoring (non-cli mode)...', 'backup-backup'), 'success'); |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | } |
| [1204](#L1204) |  |
| [1205](#L1205) | // Just in case (e.g. syntax error, we can close the file correctly) |
| [1206](#L1206) | $GLOBALS['bmi\_migration\_progress'] = $migration; |
| [1207](#L1207) |  |
| [1208](#L1208) | // Checker |
| [1209](#L1209) | $checker = new Checker($migration); |
| [1210](#L1210) | $zipper = new Zipper(); |
| [1211](#L1211) |  |
| [1212](#L1212) | // Handle remote |
| [1213](#L1213) | if ($this->post['file']) { |
| [1214](#L1214) | $migration->log(\_\_('Restore process responded', 'backup-backup'), 'SUCCESS'); |
| [1215](#L1215) | } |
| [1216](#L1216) |  |
| [1217](#L1217) | // Make lock file |
| [1218](#L1218) | $migration->log(\_\_('Locking migration process', 'backup-backup'), 'SUCCESS'); |
| [1219](#L1219) | touch($lock); |
| [1220](#L1220) |  |
| [1221](#L1221) | // Initializing |
| [1222](#L1222) | $migration->log(\_\_('Initializing restore process', 'backup-backup'), 'STEP'); |
| [1223](#L1223) | $migration->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION), 'info'); |
| [1224](#L1224) |  |
| [1225](#L1225) | // Error handler |
| [1226](#L1226) | $migration->log(\_\_("Initializing custom error handler", 'backup-backup'), 'info'); |
| [1227](#L1227) |  |
| [1228](#L1228) | // Error handler |
| [1229](#L1229) | $this->migration\_progress = &$migration; |
| [1230](#L1230) | $this->migrationErrorHandler(); |
| [1231](#L1231) | $this->migrationExceptionHandler(); |
| [1232](#L1232) |  |
| [1233](#L1233) | $homeURL = site\_url(); |
| [1234](#L1234) | if (strlen($homeURL) <= 8) $homeURL = home\_url(); |
| [1235](#L1235) | if (defined('WP\_SITEURL') && strlen(WP\_SITEURL) > 8) $homeURL = WP\_SITEURL; |
| [1236](#L1236) |  |
| [1237](#L1237) | $migration->log(\_\_("Site which will be restored: ", 'backup-backup') . $homeURL, 'info'); |
| [1238](#L1238) | $migration->log(\_\_("PHP Version: ", 'backup-backup') . PHP\_VERSION, 'info'); |
| [1239](#L1239) | $migration->log(\_\_("WP Version: ", 'backup-backup') . $wp\_version, 'info'); |
| [1240](#L1240) | $migration->log(\_\_("MySQL Version: ", 'backup-backup') . $GLOBALS['wpdb']->db\_version(), 'info'); |
| [1241](#L1241) | $migration->log(\_\_("MySQL Max Length: ", 'backup-backup') . $GLOBALS['wpdb']->get\_results("SHOW VARIABLES LIKE 'max\_allowed\_packet';")[0]->Value, 'info'); |
| [1242](#L1242) | if (isset($\_SERVER['SERVER\_SOFTWARE']) && !defined('BMI\_USING\_CLI\_FUNCTIONALITY')) { |
| [1243](#L1243) | $migration->log(\_\_("Web server: ", 'backup-backup') . $\_SERVER['SERVER\_SOFTWARE'], 'info'); |
| [1244](#L1244) | } else { |
| [1245](#L1245) | $migration->log(\_\_("Web server: Not available", 'backup-backup'), 'info'); |
| [1246](#L1246) | } |
| [1247](#L1247) | $migration->log(\_\_("Max execution time (in seconds): ", 'backup-backup') . @ini\_get('max\_execution\_time'), 'info'); |
| [1248](#L1248) |  |
| [1249](#L1249) | $migration->log(\_\_("Memory limit (server): ", 'backup-backup') . @ini\_get('memory\_limit'), 'info'); |
| [1250](#L1250) | if (defined('WP\_MEMORY\_LIMIT')) { |
| [1251](#L1251) | $migration->log(\_\_("Memory limit (wp-config): ", 'backup-backup') . WP\_MEMORY\_LIMIT, 'info'); |
| [1252](#L1252) | } |
| [1253](#L1253) | if (defined('WP\_MAX\_MEMORY\_LIMIT')) { |
| [1254](#L1254) | $migration->log(\_\_("Memory limit (wp-config admin): ", 'backup-backup') . WP\_MAX\_MEMORY\_LIMIT, 'info'); |
| [1255](#L1255) | } |
| [1256](#L1256) |  |
| [1257](#L1257) | if (defined('BMI\_BACKUP\_PRO')) { |
| [1258](#L1258) | if (BMI\_BACKUP\_PRO == 1) { |
| [1259](#L1259) | $migration->log(\_\_("Premium plugin is enabled and activated", 'backup-backup'), 'info'); |
| [1260](#L1260) | } else { |
| [1261](#L1261) | $migration->log(\_\_("Premium version is enabled but not active, using free plugin.", 'backup-backup'), 'warn'); |
| [1262](#L1262) | } |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | $migration->log(\_\_("Restore process initialized successfully.", 'backup-backup'), 'success'); |
| [1266](#L1266) |  |
| [1267](#L1267) | // Check file size |
| [1268](#L1268) | $zippath = BMP::fixSlashes(BMI\_BACKUPS) . DIRECTORY\_SEPARATOR . $this->post['file']; |
| [1269](#L1269) | if (!$ignoreRunCheck) { |
| [1270](#L1270) |  |
| [1271](#L1271) | $manifest = $zipper->getZipFileContent($zippath, 'bmi\_backup\_manifest.json'); |
| [1272](#L1272) | $migration->log(\_\_('Free space checking...', 'backup-backup'), 'STEP'); |
| [1273](#L1273) | $migration->log(\_\_('Checking if there is enough amount of free space', 'backup-backup'), 'INFO'); |
| [1274](#L1274) | if ($manifest) { |
| [1275](#L1275) | if (isset($manifest->bytes) && $manifest->bytes) { |
| [1276](#L1276) | $bytes = intval($manifest->bytes \* 1.4); |
| [1277](#L1277) | if (!$checker->check\_free\_space($bytes)) { |
| [1278](#L1278) | $migration->log(\_\_('Cannot start migration process', 'backup-backup'), 'ERROR'); |
| [1279](#L1279) | $migration->log(\_\_('Error: There is not enough space on the server, checked: ' . ($bytes) . ' bytes.', 'backup-backup'), 'ERROR'); |
| [1280](#L1280) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1281](#L1281) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1282](#L1282) |  |
| [1283](#L1283) | if (file\_exists($lock)) @unlink($lock); |
| [1284](#L1284) | $migration->log('#004', 'END-CODE'); |
| [1285](#L1285) | $migration->end(); |
| [1286](#L1286) |  |
| [1287](#L1287) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1288](#L1288) | $this->actionsAfterProcess(false, 'migration'); |
| [1289](#L1289) |  |
| [1290](#L1290) | return ['status' => 'error']; |
| [1291](#L1291) | } else { |
| [1292](#L1292) | $migration->log(\_\_('Confirmed, there is enough space on the device, checked: ' . ($bytes) . ' bytes.', 'backup-backup'), 'SUCCESS'); |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) | } else { |
| [1296](#L1296) | $migration->log(\_\_('Cannot start migration process', 'backup-backup'), 'ERROR'); |
| [1297](#L1297) | $migration->log(\_\_('Error: File may not exist, check file name and if it still exist', 'backup-backup'), 'ERROR'); |
| [1298](#L1298) | $migration->log(\_\_('Error: Could not find manifest in backup, file may be broken', 'backup-backup'), 'ERROR'); |
| [1299](#L1299) | $migration->log(\_\_('Error: Btw. because of this I also cannot check free space', 'backup-backup'), 'ERROR'); |
| [1300](#L1300) | $migration->log(\_\_('Used path: ', 'backup-backup') . $zippath, 'ERROR'); |
| [1301](#L1301) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1302](#L1302) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1303](#L1303) |  |
| [1304](#L1304) | if (file\_exists($lock)) @unlink($lock); |
| [1305](#L1305) | $migration->log('#003', 'END-CODE'); |
| [1306](#L1306) | $migration->end(); |
| [1307](#L1307) |  |
| [1308](#L1308) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1309](#L1309) | $this->actionsAfterProcess(false, 'migration'); |
| [1310](#L1310) |  |
| [1311](#L1311) | return ['status' => 'error']; |
| [1312](#L1312) | } |
| [1313](#L1313) |  |
| [1314](#L1314) | } |
| [1315](#L1315) |  |
| [1316](#L1316) | if ($ignoreRunCheck) { |
| [1317](#L1317) |  |
| [1318](#L1318) | $migration->unmute(); |
| [1319](#L1319) |  |
| [1320](#L1320) | } |
| [1321](#L1321) |  |
| [1322](#L1322) | // New extracter |
| [1323](#L1323) | $theTmpName = ((isset($this->post['tmpname'])) ? $this->post['tmpname'] : false); |
| [1324](#L1324) | $options = ((isset($this->post['options'])) ? $this->post['options'] : []); |
| [1325](#L1325) | $extracter = new Extracter($this->post['file'], $migration, $theTmpName, $isCLIRunning, $options); |
| [1326](#L1326) |  |
| [1327](#L1327) | // Extract |
| [1328](#L1328) | $theSecret = ((isset($this->post['secret'])) ? $this->post['secret'] : null); |
| [1329](#L1329) | $isFine = $extracter->extractTo($theSecret); |
| [1330](#L1330) | if (!$isFine) { |
| [1331](#L1331) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1332](#L1332) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1333](#L1333) |  |
| [1334](#L1334) | if (file\_exists($lock)) @unlink($lock); |
| [1335](#L1335) | $migration->log('#002', 'END-CODE'); |
| [1336](#L1336) | $migration->end(); |
| [1337](#L1337) |  |
| [1338](#L1338) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1339](#L1339) | $this->actionsAfterProcess(false, 'migration'); |
| [1340](#L1340) |  |
| [1341](#L1341) | return ['status' => 'error']; |
| [1342](#L1342) | } |
| [1343](#L1343) |  |
| [1344](#L1344) | $migration->progress('100'); |
| [1345](#L1345) | $migration->log(\_\_('Restore process completed', 'backup-backup'), 'SUCCESS'); |
| [1346](#L1346) | $migration->log(\_\_('Finalizing restored files', 'backup-backup'), 'STEP'); |
| [1347](#L1347) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1348](#L1348) | if (file\_exists($lock)) @unlink($lock); |
| [1349](#L1349) |  |
| [1350](#L1350) | $migration->log('#001', 'END-CODE'); |
| [1351](#L1351) | $migration->end(); |
| [1352](#L1352) |  |
| [1353](#L1353) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1354](#L1354) |  |
| [1355](#L1355) | // Put autologin |
| [1356](#L1356) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1357](#L1357) | touch($autologin\_file); |
| [1358](#L1358) |  |
| [1359](#L1359) | $this->actionsAfterProcess(true, 'migration'); |
| [1360](#L1360) | return ['status' => 'success', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | public function isRunningBackup() { |
| [1364](#L1364) | $this->lock\_cli = BMI\_BACKUPS . '/.backup\_cli\_lock'; |
| [1365](#L1365) |  |
| [1366](#L1366) | // Ongoing processes |
| [1367](#L1367) | $ongoing = get\_option('bmip\_to\_be\_uploaded', [ |
| [1368](#L1368) | 'current\_upload' => [], |
| [1369](#L1369) | 'queue' => [], |
| [1370](#L1370) | 'failed' => [] |
| [1371](#L1371) | ]); |
| [1372](#L1372) |  |
| [1373](#L1373) | // Backup CLI running |
| [1374](#L1374) | if (file\_exists($this->lock\_cli) && (time() - filemtime($this->lock\_cli)) <= 3600) { |
| [1375](#L1375) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning', 'ongoing' => $ongoing]; |
| [1376](#L1376) | } |
| [1377](#L1377) |  |
| [1378](#L1378) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) <= 65) { |
| [1379](#L1379) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning', 'ongoing' => $ongoing]; |
| [1380](#L1380) | } else { |
| [1381](#L1381) | return ['status' => 'success', 'ongoing' => $ongoing]; |
| [1382](#L1382) | } |
| [1383](#L1383) | } |
| [1384](#L1384) |  |
| [1385](#L1385) | public function stopBackup() { |
| [1386](#L1386) | if (!file\_exists(BMI\_BACKUPS . '/.running')) { |
| [1387](#L1387) | return ['status' => 'msg', 'why' => \_\_('Backup process completed or is not running.', 'backup-backup'), 'level' => 'info']; |
| [1388](#L1388) | } else { |
| [1389](#L1389) | if (!file\_exists(BMI\_BACKUPS . '/.abort')) { |
| [1390](#L1390) | touch(BMI\_BACKUPS . '/.abort'); |
| [1391](#L1391) | } |
| [1392](#L1392) |  |
| [1393](#L1393) | return ['status' => 'success']; |
| [1394](#L1394) | } |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | public function isMigrationLocked() { |
| [1398](#L1398) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1399](#L1399) | $lock\_cli = BMI\_BACKUPS . '/.migration\_lock\_cli'; |
| [1400](#L1400) | $lock\_cli\_end = BMI\_BACKUPS . '/.migration\_lock\_ended'; |
| [1401](#L1401) |  |
| [1402](#L1402) | if ((file\_exists($lock) && (time() - filemtime($lock)) < 65) || (file\_exists($lock\_cli) && (time() - filemtime($lock\_cli)) < 7200)) { |
| [1403](#L1403) |  |
| [1404](#L1404) | return ['status' => 'msg', 'why' => \_\_('Restore process is currently running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [1405](#L1405) |  |
| [1406](#L1406) | } else { |
| [1407](#L1407) |  |
| [1408](#L1408) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1409](#L1409) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1410](#L1410) | $shouldClearLogs = true; |
| [1411](#L1411) |  |
| [1412](#L1412) | if (isset($this->post['clearLogs']) && $this->post['clearLogs'] == 'false') { |
| [1413](#L1413) | $shouldClearLogs = false; |
| [1414](#L1414) | } |
| [1415](#L1415) |  |
| [1416](#L1416) | if ($shouldClearLogs === true) { |
| [1417](#L1417) | if (file\_exists($lock\_cli\_end) && (time() - filemtime($lock\_cli\_end)) > 10) { |
| [1418](#L1418) |  |
| [1419](#L1419) | $migration = new MigrationProgress(); |
| [1420](#L1420) | $migration->start(); |
| [1421](#L1421) | $migration->log(\_\_('Initializing restore process...', 'backup-backup'), 'STEP'); |
| [1422](#L1422) | $migration->end(); |
| [1423](#L1423) |  |
| [1424](#L1424) | file\_put\_contents($progress, '0'); |
| [1425](#L1425) |  |
| [1426](#L1426) | } |
| [1427](#L1427) | } |
| [1428](#L1428) |  |
| [1429](#L1429) | return ['status' => 'success']; |
| [1430](#L1430) |  |
| [1431](#L1431) | } |
| [1432](#L1432) | } |
| [1433](#L1433) |  |
| [1434](#L1434) | public function downloadFile($url, $dest, $progress, $lock, &$logger) { |
| [1435](#L1435) | $current\_percentage = 0; |
| [1436](#L1436) | $previous\_logged = 0; |
| [1437](#L1437) | $fp = fopen($dest, 'w+'); |
| [1438](#L1438) |  |
| [1439](#L1439) | $progressfile = $progress; |
| [1440](#L1440) | $lockfile = $lock; |
| [1441](#L1441) |  |
| [1442](#L1442) | $ch = curl\_init(str\_replace(' ', '%20', $url)); |
| [1443](#L1443) | curl\_setopt($ch, CURLOPT\_TIMEOUT, 0); |
| [1444](#L1444) |  |
| [1445](#L1445) | curl\_setopt($ch, CURLOPT\_FILE, $fp); |
| [1446](#L1446) | curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, true); |
| [1447](#L1447) | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 0); |
| [1448](#L1448) | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, 0); |
| [1449](#L1449) |  |
| [1450](#L1450) | curl\_setopt($ch, CURLOPT\_NOPROGRESS, false); |
| [1451](#L1451) | curl\_setopt($ch, CURLOPT\_PROGRESSFUNCTION, function ($resource, $download\_size, $downloaded) use (&$current\_percentage, &$lockfile, &$progressfile, &$logger, &$previous\_logged) { |
| [1452](#L1452) | if ($download\_size > 0) { |
| [1453](#L1453) | $new\_percentage = intval(($downloaded / $download\_size) \* 100); |
| [1454](#L1454) |  |
| [1455](#L1455) | if (intval($current\_percentage) != intval($new\_percentage)) { |
| [1456](#L1456) | $logger->progress($new\_percentage); |
| [1457](#L1457) |  |
| [1458](#L1458) | if ($current\_percentage == 0 || ($new\_percentage % 5 == 0) || $new\_percentage > 99) { |
| [1459](#L1459) | $logger->log(sprintf(\_\_('Download progress: %s/%s MB (%s%%)', 'backup-backup'), round($downloaded / 1024 / 1024), round($download\_size / 1024 / 1024), $new\_percentage), 'INFO'); |
| [1460](#L1460) | $previous\_logged = $new\_percentage; |
| [1461](#L1461) | } |
| [1462](#L1462) |  |
| [1463](#L1463) | $current\_percentage = $new\_percentage; |
| [1464](#L1464) | } |
| [1465](#L1465) | } |
| [1466](#L1466) | }); |
| [1467](#L1467) |  |
| [1468](#L1468) | curl\_exec($ch); |
| [1469](#L1469) | $this->lastCurlCode = curl\_getinfo($ch, CURLINFO\_HTTP\_CODE); |
| [1470](#L1470) |  |
| [1471](#L1471) | $error\_msg = false; |
| [1472](#L1472) | if (curl\_errno($ch)) { |
| [1473](#L1473) | $error\_msg = curl\_error($ch); |
| [1474](#L1474) | } |
| [1475](#L1475) |  |
| [1476](#L1476) | curl\_close($ch); |
| [1477](#L1477) | fclose($fp); |
| [1478](#L1478) |  |
| [1479](#L1479) | if ($error\_msg) { |
| [1480](#L1480) | return $error\_msg; |
| [1481](#L1481) | } else { |
| [1482](#L1482) | return false; |
| [1483](#L1483) | } |
| [1484](#L1484) | } |
| [1485](#L1485) |  |
| [1486](#L1486) | public function handleQuickMigration() { |
| [1487](#L1487) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1488](#L1488) | if (file\_exists($lock) && (time() - filemtime($lock)) < 65) { |
| [1489](#L1489) | return ['status' => 'msg', 'why' => \_\_('Download process is currently running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [1490](#L1490) | } |
| [1491](#L1491) |  |
| [1492](#L1492) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1493](#L1493) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [1494](#L1494) |  |
| [1495](#L1495) | $migration = new MigrationProgress(true); |
| [1496](#L1496) | $migration->start(); |
| [1497](#L1497) |  |
| [1498](#L1498) | $tmp\_name = 'backup\_' . time() . '.zip'; |
| [1499](#L1499) |  |
| [1500](#L1500) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true && defined('BMI\_CLI\_ARGUMENT')) { |
| [1501](#L1501) | $url = BMI\_CLI\_ARGUMENT; |
| [1502](#L1502) | } else { |
| [1503](#L1503) | $url = $this->post['url']; |
| [1504](#L1504) | } |
| [1505](#L1505) |  |
| [1506](#L1506) | $dest = BMI\_BACKUPS . '/' . $tmp\_name; |
| [1507](#L1507) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1508](#L1508) | $cli\_lock = BMI\_BACKUPS . '/.cli\_download\_lock'; |
| [1509](#L1509) |  |
| [1510](#L1510) | if (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) { |
| [1511](#L1511) |  |
| [1512](#L1512) | $cli\_result = $this->checkIfPHPCliExist($migration); |
| [1513](#L1513) | if ($cli\_result !== false) { |
| [1514](#L1514) |  |
| [1515](#L1515) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [1516](#L1516) |  |
| [1517](#L1517) | $res = null; |
| [1518](#L1518) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_quick\_migration "' . $url . '" > /dev/null &', $res); |
| [1519](#L1519) | $res = implode("\n", $res); |
| [1520](#L1520) |  |
| [1521](#L1521) | sleep(2); |
| [1522](#L1522) | if (file\_exists($cli\_lock) && (time() - filemtime($cli\_lock)) < 10) { |
| [1523](#L1523) |  |
| [1524](#L1524) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1525](#L1525) | return [ 'status' => 'cli\_download' ]; |
| [1526](#L1526) | exit; |
| [1527](#L1527) |  |
| [1528](#L1528) | } |
| [1529](#L1529) |  |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | } else { |
| [1533](#L1533) |  |
| [1534](#L1534) | $migration->log(\_\_('Downloading via PHP CLI', 'backup-backup')); |
| [1535](#L1535) | touch($cli\_lock); |
| [1536](#L1536) |  |
| [1537](#L1537) | } |
| [1538](#L1538) |  |
| [1539](#L1539) | $migration->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION)); |
| [1540](#L1540) | $migration->log(\_\_('Creating lock file', 'backup-backup')); |
| [1541](#L1541) | file\_put\_contents($lock, ''); |
| [1542](#L1542) | $migration->log(\_\_('Initializing download process', 'backup-backup'), 'STEP'); |
| [1543](#L1543) | $downstart = microtime(true); |
| [1544](#L1544) | $migration->log(\_\_('Downloading initialized', 'backup-backup'), 'SUCCESS'); |
| [1545](#L1545) | $migration->log(\_\_('Downloading remote file...', 'backup-backup'), 'STEP'); |
| [1546](#L1546) | $migration->log(\_\_('Used URL: ', 'backup-backup') . sanitize\_text\_field($url), 'INFO'); |
| [1547](#L1547) | $fileError = $this->downloadFile($url, $dest, $progress, $lock, $migration); |
| [1548](#L1548) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1549](#L1549) | if (file\_exists($lock)) @unlink($lock); |
| [1550](#L1550) |  |
| [1551](#L1551) | if ($fileError) { |
| [1552](#L1552) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'INFO'); |
| [1553](#L1553) | if (file\_exists($dest)) @unlink($dest); |
| [1554](#L1554) | $migration->log(\_\_('Download error', 'backup-backup'), 'ERROR'); |
| [1555](#L1555) |  |
| [1556](#L1556) | if (strpos($fileError, 'Failed writing body') !== false) { |
| [1557](#L1557) | $migration->log(\_\_('Error: There is not enough space on the server', 'backup-backup'), 'ERROR'); |
| [1558](#L1558) | } else { |
| [1559](#L1559) | $migration->log(\_\_('Error', 'backup-backup') . ': ' . $fileError, 'ERROR'); |
| [1560](#L1560) | } |
| [1561](#L1561) |  |
| [1562](#L1562) | $migration->log('#002', 'END-CODE'); |
| [1563](#L1563) | return ['status' => 'error']; |
| [1564](#L1564) | } else { |
| [1565](#L1565) | $migration->log(\_\_('Download completed (took: ', 'backup-backup') . (microtime(true) - $downstart) . 's)', 'SUCCESS'); |
| [1566](#L1566) | $migration->log(\_\_('Looking for backup manifest', 'backup-backup'), 'STEP'); |
| [1567](#L1567) | $zipper = new Zipper(); |
| [1568](#L1568) | $content = $zipper->getZipFileContent($dest, 'bmi\_backup\_manifest.json'); |
| [1569](#L1569) | if ($content) { |
| [1570](#L1570) | try { |
| [1571](#L1571) | $i = 1; |
| [1572](#L1572) | $name = $content->name; |
| [1573](#L1573) | $prepared\_name = $name; |
| [1574](#L1574) | $migration->log(\_\_('Manifest found remote name: ', 'backup-backup') . $name, 'SUCCESS'); |
| [1575](#L1575) |  |
| [1576](#L1576) | while (file\_exists(BMI\_BACKUPS . '/' . $prepared\_name)) { |
| [1577](#L1577) | $prepared\_name = substr($name, 0, -4) . '\_' . $i . '.zip'; |
| [1578](#L1578) | $i++; |
| [1579](#L1579) | } |
| [1580](#L1580) |  |
| [1581](#L1581) | rename($dest, BMI\_BACKUPS . '/' . $prepared\_name); |
| [1582](#L1582) | $migration->log(\_\_('Requesting restore process', 'backup-backup'), 'STEP'); |
| [1583](#L1583) | $migration->progress(0); |
| [1584](#L1584) | file\_put\_contents(BMI\_BACKUPS . '/' . '.cli\_download\_last', $prepared\_name); |
| [1585](#L1585) | $migration->log('#205', 'END-CODE'); |
| [1586](#L1586) |  |
| [1587](#L1587) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY')) { |
| [1588](#L1588) | $this->post['file'] = '.cli\_download'; |
| [1589](#L1589) | $this->post['remote'] = true; |
| [1590](#L1590) | return $this->restoreBackup(); |
| [1591](#L1591) | } else { |
| [1592](#L1592) | return ['status' => 'success', 'name' => $prepared\_name]; |
| [1593](#L1593) | } |
| [1594](#L1594) | } catch (\Exception $e) { |
| [1595](#L1595) | $migration->log(\_\_('Error: ', 'backup-backup') . $e, 'ERROR'); |
| [1596](#L1596) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1597](#L1597) | if (file\_exists($dest)) @unlink($dest); |
| [1598](#L1598) |  |
| [1599](#L1599) | $migration->log('#002', 'END-CODE'); |
| [1600](#L1600) | return ['status' => 'error']; |
| [1601](#L1601) | } catch (\Throwable $e) { |
| [1602](#L1602) | $migration->log(\_\_('Error: ', 'backup-backup') . $e, 'ERROR'); |
| [1603](#L1603) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1604](#L1604) | if (file\_exists($dest)) @unlink($dest); |
| [1605](#L1605) |  |
| [1606](#L1606) | $migration->log('#002', 'END-CODE'); |
| [1607](#L1607) | return ['status' => 'error']; |
| [1608](#L1608) |  |
| [1609](#L1609) | } |
| [1610](#L1610) |  |
| [1611](#L1611) | } else { |
| [1612](#L1612) |  |
| [1613](#L1613) | // $migration->log(\_\_('Error during manifest check: ', 'backup-backup') . print\_r($content, true), 'ERROR'); |
| [1614](#L1614) | if ($this->lastCurlCode == '403') { |
| [1615](#L1615) | $migration->log(\_\_('Backup is not available to download (Error 403).', 'backup-backup'), 'ERROR'); |
| [1616](#L1616) | $migration->log(\_\_('It is restricted by remote server configuration.', 'backup-backup'), 'ERROR'); |
| [1617](#L1617) | } elseif ($this->lastCurlCode == '423') { |
| [1618](#L1618) | $migration->log(\_\_('Backup is locked on remote site, please unlock remote downloading.', 'backup-backup'), 'ERROR'); |
| [1619](#L1619) | $migration->log(\_\_('You can find the setting in "Where shall the backup(s) be stored?" section.', 'backup-backup'), 'ERROR'); |
| [1620](#L1620) | } elseif ($this->lastCurlCode == '200' || $this->lastCurlCode == '404') { |
| [1621](#L1621) | $migration->log(\_\_('Backup does not exist under provided URL.', 'backup-backup'), 'ERROR'); |
| [1622](#L1622) | $migration->log(\_\_('Please confirm that you can download the backup file via provided URL.', 'backup-backup'), 'ERROR'); |
| [1623](#L1623) | $migration->log(\_\_('...or the manifest file does not exist in the backup.', 'backup-backup'), 'ERROR'); |
| [1624](#L1624) | $migration->log(\_\_('Missing manifest means that the backup is probably invalid.', 'backup-backup'), 'ERROR'); |
| [1625](#L1625) | } else { |
| [1626](#L1626) | $migration->log(\_\_('Manifest file does not exist', 'backup-backup'), 'ERROR'); |
| [1627](#L1627) | $migration->log(\_\_('Downloaded backup may be incomplete (missing manifest)', 'backup-backup'), 'ERROR'); |
| [1628](#L1628) | $migration->log(\_\_('...or provided URL is not a direct download of ZIP file.', 'backup-backup'), 'ERROR'); |
| [1629](#L1629) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1630](#L1630) | } |
| [1631](#L1631) |  |
| [1632](#L1632) | if (file\_exists($dest)) @unlink($dest); |
| [1633](#L1633) |  |
| [1634](#L1634) | $migration->log('#002', 'END-CODE'); |
| [1635](#L1635) | return ['status' => 'error']; |
| [1636](#L1636) |  |
| [1637](#L1637) | } |
| [1638](#L1638) | } |
| [1639](#L1639) | } |
| [1640](#L1640) |  |
| [1641](#L1641) | public function handleChunkUpload() { |
| [1642](#L1642) | require\_once BMI\_INCLUDES . '/uploader/chunks.php'; |
| [1643](#L1643) | } |
| [1644](#L1644) |  |
| [1645](#L1645) | public function removeBackupFile() { |
| [1646](#L1646) | $files = $this->post['filenames']; |
| [1647](#L1647) | $deleteCloud = $this->post['deleteCloud'] === 'yes' ? true : false; |
| [1648](#L1648) | $cloudDetails = $this->post['cloudDetails']; |
| [1649](#L1649) |  |
| [1650](#L1650) | $md5\_file\_summary\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR. 'md5summary.php'; |
| [1651](#L1651) | $md5summary = []; |
| [1652](#L1652) |  |
| [1653](#L1653) | if (file\_exists($md5\_file\_summary\_path)) { |
| [1654](#L1654) | $md5summary = file\_get\_contents($md5\_file\_summary\_path); |
| [1655](#L1655) | $md5summary = substr($md5summary, 18, -2); |
| [1656](#L1656) | if (is\_serialized($md5summary)) { |
| [1657](#L1657) | $md5summary = maybe\_unserialize($md5summary); |
| [1658](#L1658) | } |
| [1659](#L1659) | } |
| [1660](#L1660) |  |
| [1661](#L1661) | if ($deleteCloud) { |
| [1662](#L1662) | if (defined('BMI\_BACKUP\_PRO') && defined('BMI\_PRO\_INC')) { |
| [1663](#L1663) | $proPath = BMI\_PRO\_INC . 'external/controller.php'; |
| [1664](#L1664) | if (file\_exists($proPath)) { |
| [1665](#L1665) | require\_once $proPath; |
| [1666](#L1666) | $externalStorage = new ExternalStorage(); |
| [1667](#L1667) | } |
| [1668](#L1668) | } |
| [1669](#L1669) | } |
| [1670](#L1670) |  |
| [1671](#L1671) | try { |
| [1672](#L1672) | if (is\_array($files)) { |
| [1673](#L1673) | for ($i = 0; $i < sizeof($files); $i++) { |
| [1674](#L1674) |  |
| [1675](#L1675) | $removeByMD5 = false; |
| [1676](#L1676) | $file = $files[$i]; |
| [1677](#L1677) | $file = preg\_replace('/\.\./', '', $file); |
| [1678](#L1678) |  |
| [1679](#L1679) | if (file\_exists(BMI\_BACKUPS . '/' . $file)) { |
| [1680](#L1680) |  |
| [1681](#L1681) | if ($deleteCloud) { |
| [1682](#L1682) | do\_action('bmi\_premium\_remove\_backup\_file', md5\_file(BMI\_BACKUPS . '/' . $file)); |
| [1683](#L1683) | } |
| [1684](#L1684) |  |
| [1685](#L1685) | unlink(BMI\_BACKUPS . '/' . $file); |
| [1686](#L1686) |  |
| [1687](#L1687) | } else if ($deleteCloud) $removeByMD5 = true; |
| [1688](#L1688) |  |
| [1689](#L1689) | if (isset($md5summary[$file])) { |
| [1690](#L1690) | $md5s = $md5summary[$file]; |
| [1691](#L1691) |  |
| [1692](#L1692) | for ($j = 0; $j < sizeof($md5s); ++$j) { |
| [1693](#L1693) | $md5\_file\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $md5s[$j] . '.json'; |
| [1694](#L1694) | if (file\_exists($md5\_file\_path)) { |
| [1695](#L1695) | if ($deleteCloud) { |
| [1696](#L1696) | do\_action('bmi\_premium\_remove\_backup\_json\_file', $md5s[$j] . '.json'); |
| [1697](#L1697) | } |
| [1698](#L1698) | unlink($md5\_file\_path); |
| [1699](#L1699) | } else if ($deleteCloud) $removeByMD5 = true; |
| [1700](#L1700) | } |
| [1701](#L1701) |  |
| [1702](#L1702) | unset($md5summary[$file]); |
| [1703](#L1703) | } |
| [1704](#L1704) |  |
| [1705](#L1705) | if ($deleteCloud && $removeByMD5) { |
| [1706](#L1706) | if (isset($cloudDetails[$file])) { |
| [1707](#L1707) | do\_action('bmi\_premium\_remove\_backup\_file', $cloudDetails[$file]['md5']); |
| [1708](#L1708) | do\_action('bmi\_premium\_remove\_backup\_json\_file', $cloudDetails[$file]['md5'] . '.json'); |
| [1709](#L1709) | } |
| [1710](#L1710) | } |
| [1711](#L1711) |  |
| [1712](#L1712) | } |
| [1713](#L1713) | } |
| [1714](#L1714) | } catch (\Exception $e) { |
| [1715](#L1715) | return ['status' => 'error', 'e' => $e]; |
| [1716](#L1716) | } catch (\Throwable $e) { |
| [1717](#L1717) | return ['status' => 'error', 'e' => $e]; |
| [1718](#L1718) | } |
| [1719](#L1719) |  |
| [1720](#L1720) | $cacheMd5String = "<?php exit; \$x = '" . serialize($md5summary) . "';"; |
| [1721](#L1721) | file\_put\_contents($md5\_file\_summary\_path, $cacheMd5String); |
| [1722](#L1722) |  |
| [1723](#L1723) | return ['status' => 'success']; |
| [1724](#L1724) | } |
| [1725](#L1725) |  |
| [1726](#L1726) | public function saveStorageConfig() { |
| [1727](#L1727) | $dir\_path = $this->post['directory']; // STORAGE::LOCAL::PATH |
| [1728](#L1728) | $accessible = $this->post['access']; // STORAGE::DIRECT::URL |
| [1729](#L1729) | $gdrivedirname = 'BACKUP\_MIGRATION\_BACKUPS'; // STORAGE::EXTERNAL::GDRIVE::DIRNAME // $this->post['gdrivedirname'] |
| [1730](#L1730) | $curr\_path = Dashboard\bmi\_get\_config('STORAGE::LOCAL::PATH'); |
| [1731](#L1731) |  |
| [1732](#L1732) | $error = 0; |
| [1733](#L1733) | $created = false; |
| [1734](#L1734) |  |
| [1735](#L1735) | if (!preg\_match("/^[a-zA-Z0-9\\_\-\/\.]+$/", $dir\_path)) { |
| [1736](#L1736) | return ['status' => 'msg', 'why' => \_\_('Entered directory/path name does not match allowed characters (Local Storage).', 'backup-backup'), 'level' => 'warning']; |
| [1737](#L1737) | } |
| [1738](#L1738) |  |
| [1739](#L1739) | if (!file\_exists($dir\_path)) { |
| [1740](#L1740) | $created = true; |
| [1741](#L1741) | @mkdir($dir\_path, 0755, true); |
| [1742](#L1742) | } |
| [1743](#L1743) |  |
| [1744](#L1744) | if (defined('BMI\_BACKUP\_PRO') && BMI\_BACKUP\_PRO === 1) { |
| [1745](#L1745) |  |
| [1746](#L1746) | if (isset($this->post['gdrivedirname'])) { |
| [1747](#L1747) | $gdrivedirname = $this->post['gdrivedirname']; |
| [1748](#L1748) |  |
| [1749](#L1749) | if (!preg\_match("/^[a-zA-Z0-9\\_\-\.]+$/", $gdrivedirname)) { |
| [1750](#L1750) | return ['status' => 'msg', 'why' => \_\_('Entered directory name does not match allowed characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1751](#L1751) | } |
| [1752](#L1752) |  |
| [1753](#L1753) | if (strlen(trim($gdrivedirname)) < 3) { |
| [1754](#L1754) | return ['status' => 'msg', 'why' => \_\_('Entered directory name is too short, min 3 characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1755](#L1755) | } |
| [1756](#L1756) |  |
| [1757](#L1757) | if (strlen(trim($gdrivedirname)) > 48) { |
| [1758](#L1758) | return ['status' => 'msg', 'why' => \_\_('Entered directory name is too long, max 48 characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1759](#L1759) | } |
| [1760](#L1760) |  |
| [1761](#L1761) | if (!Dashboard\bmi\_set\_config('STORAGE::EXTERNAL::GDRIVE::DIRNAME', $gdrivedirname)) { |
| [1762](#L1762) | $errors++; |
| [1763](#L1763) | } |
| [1764](#L1764) | } |
| [1765](#L1765) |  |
| [1766](#L1766) | if (isset($this->post['gdrive'])) { |
| [1767](#L1767) | $gdriveenabled = $this->post['gdrive']; |
| [1768](#L1768) | if (!Dashboard\bmi\_set\_config('STORAGE::EXTERNAL::GDRIVE', $gdriveenabled)) { |
| [1769](#L1769) | $errors++; |
| [1770](#L1770) | } |
| [1771](#L1771) | } |
| [1772](#L1772) |  |
| [1773](#L1773) | } |
| [1774](#L1774) |  |
| [1775](#L1775) | if (is\_writable($dir\_path)) { |
| [1776](#L1776) | if (!Dashboard\bmi\_set\_config('STORAGE::DIRECT::URL', $accessible)) { |
| [1777](#L1777) | $error++; |
| [1778](#L1778) | } |
| [1779](#L1779) | if (!Dashboard\bmi\_set\_config('STORAGE::LOCAL::PATH', esc\_attr($dir\_path))) { |
| [1780](#L1780) | $error++; |
| [1781](#L1781) | } else { |
| [1782](#L1782) | $cur\_dir = BMP::fixSlashes($curr\_path); |
| [1783](#L1783) | $new\_dir = BMP::fixSlashes($dir\_path); |
| [1784](#L1784) |  |
| [1785](#L1785) | $backups\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'backups'; |
| [1786](#L1786) | $backups\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'backups'; |
| [1787](#L1787) |  |
| [1788](#L1788) | $staging\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'staging'; |
| [1789](#L1789) | $staging\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'staging'; |
| [1790](#L1790) |  |
| [1791](#L1791) | $tmp\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'tmp'; |
| [1792](#L1792) | $tmp\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'tmp'; |
| [1793](#L1793) |  |
| [1794](#L1794) | update\_option('BMI::STORAGE::LOCAL::PATH', $new\_dir); |
| [1795](#L1795) |  |
| [1796](#L1796) | if ($cur\_dir != $new\_dir) { |
| [1797](#L1797) |  |
| [1798](#L1798) | if (!file\_exists($new\_dir)) @mkdir($new\_dir, 0755, true); |
| [1799](#L1799) | if (!file\_exists($backups\_new\_dir)) @mkdir($backups\_new\_dir, 0755, true); |
| [1800](#L1800) | if (!file\_exists($staging\_new\_dir)) @mkdir($staging\_new\_dir, 0755, true); |
| [1801](#L1801) | if (!file\_exists($tmp\_new\_dir)) @mkdir($tmp\_new\_dir, 0755, true); |
| [1802](#L1802) |  |
| [1803](#L1803) | $scanned\_directory\_staging = array\_diff(scandir($staging\_cur\_dir), ['..', '.']); |
| [1804](#L1804) | foreach ($scanned\_directory\_staging as $i => $file) { |
| [1805](#L1805) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1806](#L1806) | rename($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $staging\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1807](#L1807) | } |
| [1808](#L1808) | } |
| [1809](#L1809) |  |
| [1810](#L1810) | $scanned\_directory\_tmp = array\_diff(scandir($tmp\_cur\_dir), ['..', '.']); |
| [1811](#L1811) | foreach ($scanned\_directory\_tmp as $i => $file) { |
| [1812](#L1812) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1813](#L1813) | rename($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $tmp\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1814](#L1814) | } |
| [1815](#L1815) | } |
| [1816](#L1816) |  |
| [1817](#L1817) | $scanned\_directory\_backups = array\_diff(scandir($backups\_cur\_dir), ['..', '.']); |
| [1818](#L1818) | foreach ($scanned\_directory\_backups as $i => $file) { |
| [1819](#L1819) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1820](#L1820) | rename($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $backups\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1821](#L1821) | } |
| [1822](#L1822) | } |
| [1823](#L1823) |  |
| [1824](#L1824) | $scanned\_directory = array\_diff(scandir($cur\_dir), ['..', '.']); |
| [1825](#L1825) | foreach ($scanned\_directory as $i => $file) { |
| [1826](#L1826) | if (file\_exists($cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1827](#L1827) | rename($cur\_dir . DIRECTORY\_SEPARATOR . $file, $new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1828](#L1828) | } |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1832](#L1832) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1833](#L1833) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1834](#L1834) | if (file\_exists($backups\_cur\_dir)) @rmdir($backups\_cur\_dir); |
| [1835](#L1835) |  |
| [1836](#L1836) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1837](#L1837) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1838](#L1838) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1839](#L1839) | if (file\_exists($staging\_cur\_dir)) @rmdir($staging\_cur\_dir); |
| [1840](#L1840) |  |
| [1841](#L1841) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1842](#L1842) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1843](#L1843) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1844](#L1844) | if (file\_exists($tmp\_cur\_dir)) @rmdir($tmp\_cur\_dir); |
| [1845](#L1845) |  |
| [1846](#L1846) | if (file\_exists($cur\_dir . DIRECTORY\_SEPARATOR . 'complete\_logs.log')) @unlink($cur\_dir . DIRECTORY\_SEPARATOR . 'complete\_logs.log'); |
| [1847](#L1847) | if (file\_exists($cur\_dir)) @rmdir($cur\_dir); |
| [1848](#L1848) |  |
| [1849](#L1849) | if (is\_dir($cur\_dir) && file\_exists($cur\_dir)) { |
| [1850](#L1850) | $left\_files = array\_diff(scandir($cur\_dir), ['..', '.']); |
| [1851](#L1851) | if (sizeof($left\_files) == 0) { |
| [1852](#L1852) | if (file\_exists($cur\_dir)) { |
| [1853](#L1853) | @rmdir($cur\_dir); |
| [1854](#L1854) | } |
| [1855](#L1855) | } |
| [1856](#L1856) | } |
| [1857](#L1857) |  |
| [1858](#L1858) | } |
| [1859](#L1859) | } |
| [1860](#L1860) | } else { |
| [1861](#L1861) | if ($created === true) { |
| [1862](#L1862) | if (file\_exists($dir\_path)) @unlink($dir\_path); |
| [1863](#L1863) | } |
| [1864](#L1864) |  |
| [1865](#L1865) | return ['status' => 'msg', 'why' => \_\_('Entered path is not writable, cannot be used.', 'backup-backup'), 'level' => 'warning']; |
| [1866](#L1866) | } |
| [1867](#L1867) |  |
| [1868](#L1868) | return ['status' => 'success', 'errors' => $error]; |
| [1869](#L1869) | } |
| [1870](#L1870) |  |
| [1871](#L1871) | public function saveOtherOptions() { |
| [1872](#L1872) |  |
| [1873](#L1873) | // Errors |
| [1874](#L1874) | $invalid\_email = \_\_('Provided email addess is not valid.', 'backup-backup'); |
| [1875](#L1875) | $title\_long = \_\_('Your email title is too long, please change the title (max 64 chars).', 'backup-backup'); |
| [1876](#L1876) | $title\_short = \_\_('Your email title is too short, please use longer one (at least 3 chars).', 'backup-backup'); |
| [1877](#L1877) | $title\_empty = \_\_('Title field is required, please fill it.', 'backup-backup'); |
| [1878](#L1878) | $email\_empty = \_\_('Email field cannot be empty, please fill it.', 'backup-backup'); |
| [1879](#L1879) | $cli\_no\_exist = \_\_('Path to executable that you provided for PHP CLI does not exist.', 'backup-backup'); |
| [1880](#L1880) | $db\_query\_too\_low = \_\_('The value for query amount cannot be smaller than 15.', 'backup-backup'); |
| [1881](#L1881) | $db\_query\_too\_much = \_\_('The value for query amount cannot be larger than 15000.', 'backup-backup'); |
| [1882](#L1882) | $db\_sr\_max\_too\_low = \_\_('The value for search replace max page cannot be smaller than 10.', 'backup-backup'); |
| [1883](#L1883) | $db\_sr\_max\_too\_much = \_\_('The value for search replace max page cannot be larger than 30000.', 'backup-backup'); |
| [1884](#L1884) | $fl\_ex\_max\_too\_low = \_\_('The value for extraction limit cannot be smaller than 50.', 'backup-backup'); |
| [1885](#L1885) | $fl\_ex\_max\_too\_much = \_\_('The value for extraction limit cannot be larger than 20000.', 'backup-backup'); |
| [1886](#L1886) |  |
| [1887](#L1887) | $email = sanitize\_email(trim($this->post['email'])); // OTHER:EMAIL |
| [1888](#L1888) | $email\_title = sanitize\_text\_field(trim($this->post['email\_title'])); // OTHER:EMAIL:TITLE |
| [1889](#L1889) | $schedule\_issues = $this->post['schedule\_issues'] === 'true' ? true : false; // OTHER:EMAIL:NOTIS |
| [1890](#L1890) | $experiment\_timeout = $this->post['experiment\_timeout'] === 'true' ? true : false; // OTHER:EXPERIMENT:TIMEOUT |
| [1891](#L1891) | $experiment\_timeout\_hard = $this->post['experimental\_hard\_timeout'] === 'true' ? true : false; // OTHER:EXPERIMENT:TIMEOUT:HARD |
| [1892](#L1892) | $php\_cli\_manual\_path = isset($this->post['php\_cli\_manual\_path']) ? trim($this->post['php\_cli\_manual\_path']) : ''; // OTHER:CLI:PATH |
| [1893](#L1893) | $php\_cli\_disable\_others = $this->post['php\_cli\_disable\_others'] === 'true' ? true : false; // OTHER:CLI:DISABLE |
| [1894](#L1894) | $normal\_timeout = $this->post['normal\_timeout'] === 'true' ? true : false; // OTHER:USE:TIMEOUT:NORMAL |
| [1895](#L1895) | $insecure\_download = $this->post['download\_technique'] === 'true' ? true : false; // OTHER:DOWNLOAD:DIRECT |
| [1896](#L1896) | $db\_query\_size = isset($this->post['db\_queries\_amount']) ? trim($this->post['db\_queries\_amount']) : '2000'; // OTHER:DB:QUERIES |
| [1897](#L1897) | $db\_search\_replace\_max = isset($this->post['db\_search\_replace\_max']) ? trim($this->post['db\_search\_replace\_max']) : '300'; // OTHER:DB:SEARCHREPLACE:MAX |
| [1898](#L1898) | $file\_limit\_extraction\_max = isset($this->post['file\_limit\_extraction\_max']) ? trim($this->post['file\_limit\_extraction\_max']) : 'auto'; // OTHER:FILE:EXTRACT:MAX |
| [1899](#L1899) | $db\_restore\_splitting = $this->post['bmi-restore-splitting'] === 'true' ? true : false; // OTHER:RESTORE:SPLITTING |
| [1900](#L1900) | $db\_restore\_v3\_engine = $this->post['bmi-db-v3-restore-engine'] === 'true' ? true : false; // OTHER:RESTORE:DB:V3 |
| [1901](#L1901) |  |
| [1902](#L1902) | $no\_assets\_b4\_restore = $this->post['remove-assets-before-restore'] === 'true' ? true : false; // OTHER:RESTORE:BEFORE:CLEANUP |
| [1903](#L1903) | $single\_file\_db\_force = $this->post['bmi-db-single-file-backup'] === 'true' ? true : false; // OTHER:BACKUP:DB:SINGLE:FILE |
| [1904](#L1904) | $db\_batching\_backup = $this->post['bmi-db-batching-backup'] === 'true' ? true : false; // OTHER:BACKUP:DB:BATCHING |
| [1905](#L1905) |  |
| [1906](#L1906) | $bmi\_disable\_space\_check = $this->post['bmi-disable-space-check-function'] === 'true' ? true : false; // OTHER:BACKUP:SPACE:CHECKING |
| [1907](#L1907) |  |
| [1908](#L1908) | $uninstall\_config = $this->post['uninstall\_config'] === 'true' ? true : false; // OTHER:UNINSTALL:CONFIGS |
| [1909](#L1909) | $uninstall\_backups = $this->post['uninstall\_backups'] === 'true' ? true : false; // OTHER:UNINSTALL:BACKUPS |
| [1910](#L1910) |  |
| [1911](#L1911) | if ($experiment\_timeout\_hard === true) { |
| [1912](#L1912) | $experiment\_timeout = false; |
| [1913](#L1913) | } |
| [1914](#L1914) |  |
| [1915](#L1915) | if ($normal\_timeout === true) { |
| [1916](#L1916) | $experiment\_timeout = false; |
| [1917](#L1917) | $experiment\_timeout\_hard = false; |
| [1918](#L1918) | } |
| [1919](#L1919) |  |
| [1920](#L1920) | if (!is\_numeric($db\_query\_size) || empty($db\_query\_size)) { |
| [1921](#L1921) | $db\_query\_size = "2000"; |
| [1922](#L1922) | } |
| [1923](#L1923) |  |
| [1924](#L1924) | if (!is\_numeric($file\_limit\_extraction\_max) || empty($file\_limit\_extraction\_max)) { |
| [1925](#L1925) | $file\_limit\_extraction\_max = "auto"; |
| [1926](#L1926) | } |
| [1927](#L1927) |  |
| [1928](#L1928) | if (!is\_numeric($db\_search\_replace\_max) || empty($db\_search\_replace\_max)) { |
| [1929](#L1929) | $db\_search\_replace\_max = "300"; |
| [1930](#L1930) | } |
| [1931](#L1931) |  |
| [1932](#L1932) | if (strlen($email) <= 0) { |
| [1933](#L1933) | return ['status' => 'msg', 'why' => $email\_empty, 'level' => 'warning']; |
| [1934](#L1934) | } |
| [1935](#L1935) | if (strlen($email\_title) <= 0) { |
| [1936](#L1936) | return ['status' => 'msg', 'why' => $title\_empty, 'level' => 'warning']; |
| [1937](#L1937) | } |
| [1938](#L1938) | if (strlen($email\_title) > 64) { |
| [1939](#L1939) | return ['status' => 'msg', 'why' => $title\_long, 'level' => 'warning']; |
| [1940](#L1940) | } |
| [1941](#L1941) | if (strlen($email\_title) < 3) { |
| [1942](#L1942) | return ['status' => 'msg', 'why' => $title\_short, 'level' => 'warning']; |
| [1943](#L1943) | } |
| [1944](#L1944) | if (!filter\_var($email, FILTER\_VALIDATE\_EMAIL)) { |
| [1945](#L1945) | return ['status' => 'msg', 'why' => $invalid\_email, 'level' => 'warning']; |
| [1946](#L1946) | } |
| [1947](#L1947) | if ($php\_cli\_manual\_path != '' && !file\_exists($php\_cli\_manual\_path)) { |
| [1948](#L1948) | return ['status' => 'msg', 'why' => $cli\_no\_exist, 'level' => 'warning']; |
| [1949](#L1949) | } |
| [1950](#L1950) | if (intval($db\_query\_size) > 15000) { |
| [1951](#L1951) | return ['status' => 'msg', 'why' => $db\_query\_too\_much, 'level' => 'warning']; |
| [1952](#L1952) | } |
| [1953](#L1953) | if (intval($db\_query\_size) < 15) { |
| [1954](#L1954) | return ['status' => 'msg', 'why' => $db\_query\_too\_low, 'level' => 'warning']; |
| [1955](#L1955) | } |
| [1956](#L1956) | if (intval($db\_search\_replace\_max) > 30000) { |
| [1957](#L1957) | return ['status' => 'msg', 'why' => $db\_sr\_max\_too\_much, 'level' => 'warning']; |
| [1958](#L1958) | } |
| [1959](#L1959) | if (intval($db\_search\_replace\_max) < 10) { |
| [1960](#L1960) | return ['status' => 'msg', 'why' => $db\_sr\_max\_too\_low, 'level' => 'warning']; |
| [1961](#L1961) | } |
| [1962](#L1962) | if ($file\_limit\_extraction\_max != 'auto' && intval($file\_limit\_extraction\_max) > 20000) { |
| [1963](#L1963) | return ['status' => 'msg', 'why' => $fl\_ex\_max\_too\_much, 'level' => 'warning']; |
| [1964](#L1964) | } |
| [1965](#L1965) | if ($file\_limit\_extraction\_max != 'auto' && intval($file\_limit\_extraction\_max) < 50) { |
| [1966](#L1966) | return ['status' => 'msg', 'why' => $fl\_ex\_max\_too\_low, 'level' => 'warning']; |
| [1967](#L1967) | } |
| [1968](#L1968) |  |
| [1969](#L1969) | $error = 0; |
| [1970](#L1970) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL', $email)) { |
| [1971](#L1971) | $error++; |
| [1972](#L1972) | } |
| [1973](#L1973) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL:TITLE', $email\_title)) { |
| [1974](#L1974) | $error++; |
| [1975](#L1975) | } |
| [1976](#L1976) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL:NOTIS', $schedule\_issues)) { |
| [1977](#L1977) | $error++; |
| [1978](#L1978) | } |
| [1979](#L1979) | if (!Dashboard\bmi\_set\_config('OTHER:CLI:PATH', $php\_cli\_manual\_path)) { |
| [1980](#L1980) | $error++; |
| [1981](#L1981) | } |
| [1982](#L1982) | if (!Dashboard\bmi\_set\_config('OTHER:CLI:DISABLE', $php\_cli\_disable\_others)) { |
| [1983](#L1983) | $error++; |
| [1984](#L1984) | } |
| [1985](#L1985) | if (!Dashboard\bmi\_set\_config('OTHER:EXPERIMENT:TIMEOUT', $experiment\_timeout)) { |
| [1986](#L1986) | $error++; |
| [1987](#L1987) | } |
| [1988](#L1988) | if (!Dashboard\bmi\_set\_config('OTHER:EXPERIMENT:TIMEOUT:HARD', $experiment\_timeout\_hard)) { |
| [1989](#L1989) | $error++; |
| [1990](#L1990) | } |
| [1991](#L1991) | if (!Dashboard\bmi\_set\_config('OTHER:USE:TIMEOUT:NORMAL', $normal\_timeout)) { |
| [1992](#L1992) | $error++; |
| [1993](#L1993) | } |
| [1994](#L1994) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:DB:V3', $db\_restore\_v3\_engine)) { |
| [1995](#L1995) | $error++; |
| [1996](#L1996) | } |
| [1997](#L1997) | if (!Dashboard\bmi\_set\_config('OTHER:DB:QUERIES', $db\_query\_size)) { |
| [1998](#L1998) | $error++; |
| [1999](#L1999) | } |
| [2000](#L2000) | if (!Dashboard\bmi\_set\_config('OTHER:DB:SEARCHREPLACE:MAX', $db\_search\_replace\_max)) { |
| [2001](#L2001) | $error++; |
| [2002](#L2002) | } |
| [2003](#L2003) | if (!Dashboard\bmi\_set\_config('OTHER:FILE:EXTRACT:MAX', $file\_limit\_extraction\_max)) { |
| [2004](#L2004) | $error++; |
| [2005](#L2005) | } |
| [2006](#L2006) | if (!Dashboard\bmi\_set\_config('OTHER:DOWNLOAD:DIRECT', $insecure\_download)) { |
| [2007](#L2007) | $error++; |
| [2008](#L2008) | } |
| [2009](#L2009) | if (!Dashboard\bmi\_set\_config('OTHER:UNINSTALL:CONFIGS', $uninstall\_config)) { |
| [2010](#L2010) | $error++; |
| [2011](#L2011) | } |
| [2012](#L2012) | if (!Dashboard\bmi\_set\_config('OTHER:UNINSTALL:BACKUPS', $uninstall\_backups)) { |
| [2013](#L2013) | $error++; |
| [2014](#L2014) | } |
| [2015](#L2015) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:SPLITTING', $db\_restore\_splitting)) { |
| [2016](#L2016) | $error++; |
| [2017](#L2017) | } |
| [2018](#L2018) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:DB:SINGLE:FILE', $single\_file\_db\_force)) { |
| [2019](#L2019) | $error++; |
| [2020](#L2020) | } |
| [2021](#L2021) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:DB:BATCHING', $db\_batching\_backup)) { |
| [2022](#L2022) | $error++; |
| [2023](#L2023) | } |
| [2024](#L2024) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:SPACE:CHECKING', $bmi\_disable\_space\_check)) { |
| [2025](#L2025) | $error++; |
| [2026](#L2026) | } |
| [2027](#L2027) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:BEFORE:CLEANUP', $no\_assets\_b4\_restore)) { |
| [2028](#L2028) | $error++; |
| [2029](#L2029) | } |
| [2030](#L2030) |  |
| [2031](#L2031) | if (has\_action('bmi\_premium\_other\_options')) { |
| [2032](#L2032) | do\_action('bmi\_premium\_other\_options', $this->post); |
| [2033](#L2033) | } |
| [2034](#L2034) |  |
| [2035](#L2035) | return ['status' => 'success', 'errors' => $error]; |
| [2036](#L2036) | } |
| [2037](#L2037) |  |
| [2038](#L2038) | public function saveStorageTypeConfig() { |
| [2039](#L2039) |  |
| [2040](#L2040) | // Errors |
| [2041](#L2041) | $name\_empty = \_\_('Name is required, please fill the input.', 'backup-backup'); |
| [2042](#L2042) | $name\_long = \_\_('Your name is too long, please change the name.', 'backup-backup'); |
| [2043](#L2043) | $name\_short = \_\_('Your name is too short, please create longer one.', 'backup-backup'); |
| [2044](#L2044) | $name\_space = \_\_('Please, do not use spaces in file name.', 'backup-backup'); |
| [2045](#L2045) | $name\_forbidden = \_\_('Your name contains character(s) that are not allowed in file names: ', 'backup-backup'); |
| [2046](#L2046) |  |
| [2047](#L2047) | $forbidden\_chars = ['/', '\\', '<', '>', ':', '"', "'", '|', '?', '\*', '.', ';', '@', '!', '~', '`', ',', '#', '$', '&', '=', '+']; |
| [2048](#L2048) | $name = trim($this->post['name']); // BACKUP:NAME |
| [2049](#L2049) |  |
| [2050](#L2050) | if (strlen($name) == 0) { |
| [2051](#L2051) | return ['status' => 'msg', 'why' => $name\_empty, 'level' => 'warning']; |
| [2052](#L2052) | } |
| [2053](#L2053) | if (strlen($name) > 40) { |
| [2054](#L2054) | return ['status' => 'msg', 'why' => $name\_long, 'level' => 'warning']; |
| [2055](#L2055) | } |
| [2056](#L2056) | if (strlen($name) < 3) { |
| [2057](#L2057) | return ['status' => 'msg', 'why' => $name\_short, 'level' => 'warning']; |
| [2058](#L2058) | } |
| [2059](#L2059) | if (strpos($name, ' ') !== false) { |
| [2060](#L2060) | return ['status' => 'msg', 'why' => $name\_space, 'level' => 'warning']; |
| [2061](#L2061) | } |
| [2062](#L2062) |  |
| [2063](#L2063) | for ($i = 0; $i < sizeof($forbidden\_chars); ++$i) { |
| [2064](#L2064) | $char = $forbidden\_chars[$i]; |
| [2065](#L2065) | if (strpos($name, $char) !== false) { |
| [2066](#L2066) | return ['status' => 'msg', 'why' => $name\_forbidden . $char, 'level' => 'warning']; |
| [2067](#L2067) | } |
| [2068](#L2068) | } |
| [2069](#L2069) |  |
| [2070](#L2070) | $error = 0; |
| [2071](#L2071) | if (!Dashboard\bmi\_set\_config('BACKUP:NAME', $name)) { |
| [2072](#L2072) | $error++; |
| [2073](#L2073) | } |
| [2074](#L2074) |  |
| [2075](#L2075) | return ['status' => 'success', 'errors' => $error]; |
| [2076](#L2076) | } |
| [2077](#L2077) |  |
| [2078](#L2078) | public function saveFilesConfig() { |
| [2079](#L2079) | $db\_group = $this->post['database\_group']; // BACKUP:DATABASE |
| [2080](#L2080) | $files\_group = $this->post['files\_group']; // BACKUP:FILES |
| [2081](#L2081) |  |
| [2082](#L2082) | $fgp = $this->post['files-group-plugins']; // BACKUP:FILES::PLUGINS |
| [2083](#L2083) | $fgu = $this->post['files-group-uploads']; // BACKUP:FILES::UPLOADS |
| [2084](#L2084) | $fgt = $this->post['files-group-themes']; // BACKUP:FILES::THEMES |
| [2085](#L2085) | $fgoc = $this->post['files-group-other-contents']; // BACKUP:FILES::OTHERS |
| [2086](#L2086) | $fgwp = $this->post['files-group-wp-install']; // BACKUP:FILES::WP |
| [2087](#L2087) |  |
| [2088](#L2088) | $file\_filters = $this->post['files\_by\_filters']; // BACKUP:FILES::FILTER |
| [2089](#L2089) | $ffs = $this->post['ex\_b\_fs']; // BACKUP:FILES::FILTER:SIZE |
| [2090](#L2090) | $ffsizemax = $this->post['BFFSIN']; // BACKUP:FILES::FILTER:SIZE:IN |
| [2091](#L2091) | $ffn = $this->post['ex\_b\_names']; // BACKUP:FILES::FILTER:NAMES |
| [2092](#L2092) | $ffp = $this->post['ex\_b\_fpaths']; // BACKUP:FILES::FILTER:FPATHS |
| [2093](#L2093) | $ffd = $this->post['ex\_b\_dpaths']; // BACKUP:FILES::FILTER:DPATHS |
| [2094](#L2094) |  |
| [2095](#L2095) | $dbeg = $this->post['db-exclude-tables-group']; // BACKUP:DATABASE:EXCLUDE |
| [2096](#L2096) | $dbet = $this->post['db-excluded-tables']; // BACKUP:DATABASE:EXCLUDE:LIST |
| [2097](#L2097) |  |
| [2098](#L2098) | $existant = []; |
| [2099](#L2099) | $parsed = []; |
| [2100](#L2100) | $ffnames = $this->post['dynamic-names']; // BACKUP:FILES::FILTER:NAMES:IN |
| [2101](#L2101) | $ffpnames = array\_unique($this->post['dynamic-fpaths-names']); // BACKUP:FILES::FILTER:FPATHS:IN |
| [2102](#L2102) | $ffdnames = array\_unique($this->post['dynamic-dpaths-names']); // BACKUP:FILES::FILTER:DPATHS:IN |
| [2103](#L2103) |  |
| [2104](#L2104) | if (is\_array($dbet) || is\_object($dbet)) { |
| [2105](#L2105) | if (sizeof($dbet) == 1 && $dbet[0] == 'empty') { |
| [2106](#L2106) | $dbet = []; |
| [2107](#L2107) | } |
| [2108](#L2108) | } |
| [2109](#L2109) |  |
| [2110](#L2110) | if ($dbeg === 'true' || $dbeg === true) $dbeg = true; |
| [2111](#L2111) | else $dbeg = false; |
| [2112](#L2112) |  |
| [2113](#L2113) | $max = sizeof($ffpnames); |
| [2114](#L2114) | for ($i = 0; $i < $max; ++$i) { |
| [2115](#L2115) | if (!is\_string($ffpnames[$i]) || trim(strlen($ffpnames[$i])) <= 1) { |
| [2116](#L2116) | array\_splice($ffpnames, $i, 1); |
| [2117](#L2117) | $i--; |
| [2118](#L2118) | $max--; |
| [2119](#L2119) | } |
| [2120](#L2120) | } |
| [2121](#L2121) |  |
| [2122](#L2122) | $max = sizeof($ffdnames); |
| [2123](#L2123) | for ($i = 0; $i < $max; ++$i) { |
| [2124](#L2124) | if (!is\_string($ffdnames[$i]) || trim(strlen($ffdnames[$i])) <= 1) { |
| [2125](#L2125) | array\_splice($ffdnames, $i, 1); |
| [2126](#L2126) | $i--; |
| [2127](#L2127) | $max--; |
| [2128](#L2128) | } |
| [2129](#L2129) | } |
| [2130](#L2130) |  |
| [2131](#L2131) | for ($i = 0; $i < sizeof($ffnames); ++$i) { |
| [2132](#L2132) | $row = $ffnames[$i]; |
| [2133](#L2133) | $txt = array\_key\_exists('txt', $row) ? "" . $row['txt'] . "" : false; |
| [2134](#L2134) | $pos = array\_key\_exists('pos', $row) ? $row['pos'] : false; |
| [2135](#L2135) | $whr = array\_key\_exists('whr', $row) ? $row['whr'] : false; |
| [2136](#L2136) |  |
| [2137](#L2137) | if ($txt === false || $pos === false || $whr === false) { |
| [2138](#L2138) | continue; |
| [2139](#L2139) | } |
| [2140](#L2140) | if (trim(strlen($txt)) <= 0) { |
| [2141](#L2141) | continue; |
| [2142](#L2142) | } |
| [2143](#L2143) | if (!in\_array($pos, ["1", "2", "3"])) { |
| [2144](#L2144) | continue; |
| [2145](#L2145) | } |
| [2146](#L2146) | if (!in\_array($whr, ["1", "2"])) { |
| [2147](#L2147) | continue; |
| [2148](#L2148) | } |
| [2149](#L2149) | if (in\_array($txt . $pos . $whr, $existant)) { |
| [2150](#L2150) | continue; |
| [2151](#L2151) | } else { |
| [2152](#L2152) | $existant[] = $txt . $pos . $whr; |
| [2153](#L2153) | } |
| [2154](#L2154) |  |
| [2155](#L2155) | $parsed[] = ['txt' => $txt, 'pos' => $pos, 'whr' => $whr]; |
| [2156](#L2156) | } |
| [2157](#L2157) |  |
| [2158](#L2158) | if ($ffs == 'true' && !is\_numeric($ffsizemax)) { |
| [2159](#L2159) | return ['status' => 'msg', 'why' => \_\_('Entred file size limit, is not correct number.', 'backup-backup'), 'level' => 'warning']; |
| [2160](#L2160) | } |
| [2161](#L2161) |  |
| [2162](#L2162) | $error = 0; |
| [2163](#L2163) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE', $db\_group)) { |
| [2164](#L2164) | $error++; |
| [2165](#L2165) | } |
| [2166](#L2166) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES', $files\_group)) { |
| [2167](#L2167) | $error++; |
| [2168](#L2168) | } |
| [2169](#L2169) |  |
| [2170](#L2170) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::PLUGINS', $fgp)) { |
| [2171](#L2171) | $error++; |
| [2172](#L2172) | } |
| [2173](#L2173) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::UPLOADS', $fgu)) { |
| [2174](#L2174) | $error++; |
| [2175](#L2175) | } |
| [2176](#L2176) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::THEMES', $fgt)) { |
| [2177](#L2177) | $error++; |
| [2178](#L2178) | } |
| [2179](#L2179) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::OTHERS', $fgoc)) { |
| [2180](#L2180) | $error++; |
| [2181](#L2181) | } |
| [2182](#L2182) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::WP', $fgwp)) { |
| [2183](#L2183) | $error++; |
| [2184](#L2184) | } |
| [2185](#L2185) |  |
| [2186](#L2186) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER', $file\_filters)) { |
| [2187](#L2187) | $error++; |
| [2188](#L2188) | } |
| [2189](#L2189) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:SIZE', $ffs)) { |
| [2190](#L2190) | $error++; |
| [2191](#L2191) | } |
| [2192](#L2192) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:NAMES', $ffn)) { |
| [2193](#L2193) | $error++; |
| [2194](#L2194) | } |
| [2195](#L2195) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:FPATHS', $ffp)) { |
| [2196](#L2196) | $error++; |
| [2197](#L2197) | } |
| [2198](#L2198) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:DPATHS', $ffd)) { |
| [2199](#L2199) | $error++; |
| [2200](#L2200) | } |
| [2201](#L2201) |  |
| [2202](#L2202) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:SIZE:IN', $ffsizemax)) { |
| [2203](#L2203) | $error++; |
| [2204](#L2204) | } |
| [2205](#L2205) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:NAMES:IN', $parsed)) { |
| [2206](#L2206) | $error++; |
| [2207](#L2207) | } |
| [2208](#L2208) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:FPATHS:IN', $ffpnames)) { |
| [2209](#L2209) | $error++; |
| [2210](#L2210) | } |
| [2211](#L2211) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:DPATHS:IN', $ffdnames)) { |
| [2212](#L2212) | $error++; |
| [2213](#L2213) | } |
| [2214](#L2214) |  |
| [2215](#L2215) | if (defined('BMI\_BACKUP\_PRO') && BMI\_BACKUP\_PRO == 1) { |
| [2216](#L2216) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE:EXCLUDE', $dbeg)) { |
| [2217](#L2217) | $error++; |
| [2218](#L2218) | } |
| [2219](#L2219) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE:EXCLUDE:LIST', $dbet)) { |
| [2220](#L2220) | $error++; |
| [2221](#L2221) | } |
| [2222](#L2222) | } |
| [2223](#L2223) |  |
| [2224](#L2224) | // return array('status' => 'msg', 'why' => \_\_('Entred path is not writable or does not exist.', 'backup-backup'), 'level' => 'warning'); |
| [2225](#L2225) |  |
| [2226](#L2226) | return ['status' => 'success', 'errors' => $error]; |
| [2227](#L2227) | } |
| [2228](#L2228) |  |
| [2229](#L2229) | public function scanFilesForBackup(&$progress, $stgSites = [], $fileCalcType = false) { |
| [2230](#L2230) | require\_once BMI\_INCLUDES . '/scanner/files.php'; |
| [2231](#L2231) |  |
| [2232](#L2232) | $stagingSites = []; |
| [2233](#L2233) |  |
| [2234](#L2234) | // Get all directory names of staging sites |
| [2235](#L2235) | foreach ($stgSites as $index => $site) { |
| [2236](#L2236) |  |
| [2237](#L2237) | // Convert every directory to their location path |
| [2238](#L2238) | $stagingSites[] = '\*\*\*ABSPATH\*\*\*/' . $site['name']; |
| [2239](#L2239) |  |
| [2240](#L2240) | } |
| [2241](#L2241) |  |
| [2242](#L2242) | // Use filters? |
| [2243](#L2243) | $is = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER') === 'true' ? true : false; |
| [2244](#L2244) |  |
| [2245](#L2245) | // Get settings form config |
| [2246](#L2246) | $fgp = Dashboard\bmi\_get\_config('BACKUP:FILES::PLUGINS'); |
| [2247](#L2247) | $fgt = Dashboard\bmi\_get\_config('BACKUP:FILES::THEMES'); |
| [2248](#L2248) | $fgu = Dashboard\bmi\_get\_config('BACKUP:FILES::UPLOADS'); |
| [2249](#L2249) | $fgoc = Dashboard\bmi\_get\_config('BACKUP:FILES::OTHERS'); |
| [2250](#L2250) | $fgwp = Dashboard\bmi\_get\_config('BACKUP:FILES::WP'); |
| [2251](#L2251) | $dpathsis = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS') === 'true' ? true : false; |
| [2252](#L2252) | $dpaths = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS:IN'); |
| [2253](#L2253) | $dynamesis = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES') === 'true' ? true : false; |
| [2254](#L2254) | $dynames = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2255](#L2255) | $dynparsed = []; |
| [2256](#L2256) |  |
| [2257](#L2257) | if ($fileCalcType != false) { |
| [2258](#L2258) | $fgp = ($fileCalcType == 'plugins') ? true : false; |
| [2259](#L2259) | $fgt = ($fileCalcType == 'themes') ? true : false; |
| [2260](#L2260) | $fgu = ($fileCalcType == 'uploads') ? true : false; |
| [2261](#L2261) | $fgoc = ($fileCalcType == 'contents\_others') ? true : false; |
| [2262](#L2262) | $fgwp = ($fileCalcType == 'wordpress') ? true : false; |
| [2263](#L2263) | } |
| [2264](#L2264) |  |
| [2265](#L2265) | // Filter dynames to for smaller size |
| [2266](#L2266) | if ($is && $dynamesis) { |
| [2267](#L2267) | for ($i = 0; $i < sizeof($dynames); ++$i) { |
| [2268](#L2268) | $s = $dynames[$i]; |
| [2269](#L2269) | if ($s->whr == '2') { |
| [2270](#L2270) | $dynparsed[] = ['s' => $s->txt, 'w' => $s->pos, 'z' => strlen($s->txt)]; |
| [2271](#L2271) | } |
| [2272](#L2272) | } |
| [2273](#L2273) | } |
| [2274](#L2274) |  |
| [2275](#L2275) | // Set exclusion rules |
| [2276](#L2276) | $ignored\_folders\_default = []; |
| [2277](#L2277) | if ($is && $dynamesis) { |
| [2278](#L2278) | BMP::merge\_arrays($ignored\_folders\_default, $dynparsed); |
| [2279](#L2279) | } |
| [2280](#L2280) | $ignored\_folders = $ignored\_folders\_default; |
| [2281](#L2281) | $ignored\_paths\_default = [BMI\_CONFIG\_DIR, BMI\_BACKUPS, BMI\_ROOT\_DIR]; |
| [2282](#L2282) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/ai1wm-backups"; |
| [2283](#L2283) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/ai1wm-backups-old"; |
| [2284](#L2284) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/mwp-download"; |
| [2285](#L2285) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-clone"; |
| [2286](#L2286) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/updraft"; |
| [2287](#L2287) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backups-dup-pro"; |
| [2288](#L2288) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/wpvividbackups"; |
| [2289](#L2289) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backup-guard"; |
| [2290](#L2290) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backuply"; |
| [2291](#L2291) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backups-dup-lite"; |
| [2292](#L2292) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/backupbuddy\_backups"; |
| [2293](#L2293) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-file-manager-pro"; |
| [2294](#L2294) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-file-manager"; |
| [2295](#L2295) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/plugins/akeebabackupwp"; |
| [2296](#L2296) |  |
| [2297](#L2297) | // Exclude cache directory permanently as it's just cache |
| [2298](#L2298) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/cache"; |
| [2299](#L2299) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/cache\_bak"; |
| [2300](#L2300) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/cache"; |
| [2301](#L2301) |  |
| [2302](#L2302) | // Add staging sites to permanent exclusion rules |
| [2303](#L2303) | for ($i = 0; $i < sizeof($stagingSites); ++$i) { |
| [2304](#L2304) | $ignored\_paths\_default[] = $stagingSites[$i]; |
| [2305](#L2305) | } |
| [2306](#L2306) |  |
| [2307](#L2307) | if (defined('BMI\_PRO\_ROOT\_DIR')) $ignored\_paths\_default[] = BMI\_PRO\_ROOT\_DIR; |
| [2308](#L2308) | if ($is && $dpathsis) { |
| [2309](#L2309) | BMP::merge\_arrays($ignored\_paths\_default, $dpaths); |
| [2310](#L2310) | } |
| [2311](#L2311) | $ignored\_paths = $ignored\_paths\_default; |
| [2312](#L2312) |  |
| [2313](#L2313) | // Fix slashes for current system (directories) |
| [2314](#L2314) | for ($i = 0; $i < sizeof($ignored\_paths); ++$i) { |
| [2315](#L2315) | $ignored\_paths[$i] = str\_replace('\*\*\*ABSPATH\*\*\*', untrailingslashit(ABSPATH), $ignored\_paths[$i]); |
| [2316](#L2316) | $ignored\_paths[$i] = BMP::fixSlashes($ignored\_paths[$i]); |
| [2317](#L2317) | } |
| [2318](#L2318) |  |
| [2319](#L2319) | // WordPress Paths |
| [2320](#L2320) | $plugins\_path = BMP::fixSlashes(WP\_PLUGIN\_DIR); |
| [2321](#L2321) | $themes\_path = BMP::fixSlashes(dirname(get\_template\_directory())); |
| [2322](#L2322) | $uploads\_path = BMP::fixSlashes(wp\_upload\_dir()['basedir']); |
| [2323](#L2323) | $wp\_contents = BMP::fixSlashes(WP\_CONTENT\_DIR); |
| [2324](#L2324) | $wp\_install = BMP::fixSlashes(ABSPATH); |
| [2325](#L2325) |  |
| [2326](#L2326) | // Getting plugins |
| [2327](#L2327) | $sfgp = Scanner::equalFolderByPath($wp\_install, $plugins\_path, $ignored\_folders); |
| [2328](#L2328) | if ($fgp == 'true' && !$sfgp) { |
| [2329](#L2329) | $plugins\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($plugins\_path, $ignored\_folders, $ignored\_paths); |
| [2330](#L2330) | } |
| [2331](#L2331) |  |
| [2332](#L2332) | // Getting themes |
| [2333](#L2333) | $sfgt = Scanner::equalFolderByPath($wp\_install, $themes\_path, $ignored\_folders); |
| [2334](#L2334) | if ($fgt == 'true' && !$sfgt) { |
| [2335](#L2335) | $themes\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($themes\_path, $ignored\_folders, $ignored\_paths); |
| [2336](#L2336) | } |
| [2337](#L2337) |  |
| [2338](#L2338) | // Getting uploads |
| [2339](#L2339) | $sfgu = Scanner::equalFolderByPath($wp\_install, $uploads\_path, $ignored\_folders); |
| [2340](#L2340) | if ($fgu == 'true' && !$sfgu) { |
| [2341](#L2341) | $uploads\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($uploads\_path, $ignored\_folders, $ignored\_paths); |
| [2342](#L2342) | } |
| [2343](#L2343) |  |
| [2344](#L2344) | // Ignore above paths |
| [2345](#L2345) | $sfgoc = Scanner::equalFolderByPath($wp\_install, $wp\_contents, $ignored\_folders); |
| [2346](#L2346) | if ($fgoc == 'true' && !$sfgoc) { |
| [2347](#L2347) |  |
| [2348](#L2348) | // Ignore common folders (already scanned) |
| [2349](#L2349) | $content\_folders = [$plugins\_path, $themes\_path, $uploads\_path]; |
| [2350](#L2350) | BMP::merge\_arrays($content\_folders, $ignored\_paths); |
| [2351](#L2351) |  |
| [2352](#L2352) | // Getting other contents |
| [2353](#L2353) | $wp\_contents\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($wp\_contents, $ignored\_folders, $content\_folders); |
| [2354](#L2354) | } |
| [2355](#L2355) |  |
| [2356](#L2356) | // Ignore contents path |
| [2357](#L2357) | if ($fgwp == 'true') { |
| [2358](#L2358) |  |
| [2359](#L2359) | // Ignore contents file |
| [2360](#L2360) | $ignored\_paths[] = $wp\_contents; |
| [2361](#L2361) |  |
| [2362](#L2362) | // Getting WP Installation |
| [2363](#L2363) | $wp\_install\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($wp\_install, $ignored\_folders, $ignored\_paths); |
| [2364](#L2364) | } |
| [2365](#L2365) |  |
| [2366](#L2366) | // Concat all file paths |
| [2367](#L2367) | $all\_files = []; |
| [2368](#L2368) | if ($fgp == 'true' && !$sfgp) { |
| [2369](#L2369) | BMP::merge\_arrays($all\_files, $plugins\_path\_files); |
| [2370](#L2370) | unset($plugins\_path\_files); |
| [2371](#L2371) | } |
| [2372](#L2372) |  |
| [2373](#L2373) | if ($fgt == 'true' && !$sfgt) { |
| [2374](#L2374) | BMP::merge\_arrays($all\_files, $themes\_path\_files); |
| [2375](#L2375) | unset($themes\_path\_files); |
| [2376](#L2376) | } |
| [2377](#L2377) |  |
| [2378](#L2378) | if ($fgu == 'true' && !$sfgu) { |
| [2379](#L2379) | BMP::merge\_arrays($all\_files, $uploads\_path\_files); |
| [2380](#L2380) | unset($uploads\_path\_files); |
| [2381](#L2381) | } |
| [2382](#L2382) |  |
| [2383](#L2383) | if ($fgoc == 'true' && !$sfgoc) { |
| [2384](#L2384) | BMP::merge\_arrays($all\_files, $wp\_contents\_files); |
| [2385](#L2385) | unset($wp\_contents\_files); |
| [2386](#L2386) | } |
| [2387](#L2387) |  |
| [2388](#L2388) | if ($fgwp == 'true') { |
| [2389](#L2389) | BMP::merge\_arrays($all\_files, $wp\_install\_files); |
| [2390](#L2390) | unset($wp\_install\_files); |
| [2391](#L2391) | } |
| [2392](#L2392) |  |
| [2393](#L2393) | return $all\_files; |
| [2394](#L2394) | } |
| [2395](#L2395) |  |
| [2396](#L2396) | public function parseFilesForBackup(&$files, &$progress, $cron = false, $dirCalc = false) { |
| [2397](#L2397) |  |
| [2398](#L2398) | $is = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER') === 'true' ? true : false; |
| [2399](#L2399) | $acis = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS') === 'true' && $is) ? true : false; |
| [2400](#L2400) | $ac = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS:IN'); |
| [2401](#L2401) |  |
| [2402](#L2402) | $abis = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES') === 'true' && $is) ? true : false; |
| [2403](#L2403) | $ab = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2404](#L2404) | $abres = []; |
| [2405](#L2405) | $acres = new \stdClass(); |
| [2406](#L2406) |  |
| [2407](#L2407) | // Local list of permanently blocked files |
| [2408](#L2408) | if ($acis == false) { |
| [2409](#L2409) | $acis = true; |
| [2410](#L2410) | $ac = [ |
| [2411](#L2411) | '\*\*\*ABSPATH\*\*\*/wp-content/uploads/wpforms/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2412](#L2412) | '\*\*\*ABSPATH\*\*\*/wp-content/uploads/gravity\_forms/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2413](#L2413) | '\*\*\*ABSPATH\*\*\*/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2414](#L2414) | '\*\*\*ABSPATH\*\*\*/logs/traffic.html/.md5sums', // Binary broken file of wpforms |
| [2415](#L2415) | '\*\*\*ABSPATH\*\*\*/wp-config.php', // Exclude wp-config.php permanently |
| [2416](#L2416) | '\*\*\*ABSPATH\*\*\*/wp-content/backup-migration-config.php' // Exclude BMI CONFIG hardly |
| [2417](#L2417) | ]; |
| [2418](#L2418) | } else { |
| [2419](#L2419) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/uploads/wpforms/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2420](#L2420) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/uploads/gravity\_forms/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2421](#L2421) | $ac[] = '\*\*\*ABSPATH\*\*\*/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2422](#L2422) | $ac[] = '\*\*\*ABSPATH\*\*\*/logs/traffic.html/.md5sums'; // Binary broken file of wpforms |
| [2423](#L2423) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-config.php'; // Exclude wp-config.php permanently |
| [2424](#L2424) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/backup-migration-config.php'; // Exclude BMI CONFIG hardly |
| [2425](#L2425) | } |
| [2426](#L2426) |  |
| [2427](#L2427) | $temp\_is = false; |
| [2428](#L2428) | if ($is == false) { |
| [2429](#L2429) | $temp\_is = true; |
| [2430](#L2430) | } |
| [2431](#L2431) |  |
| [2432](#L2432) | if (($is && $acis) || $temp\_is) { |
| [2433](#L2433) | foreach ($ac as $key => $value) { |
| [2434](#L2434) | $value = str\_replace('\*\*\*ABSPATH\*\*\*', untrailingslashit(ABSPATH), $value); |
| [2435](#L2435) | $value = BMP::fixSlashes($value); |
| [2436](#L2436) | $acres->{$value} = 1; |
| [2437](#L2437) | } |
| [2438](#L2438) | } |
| [2439](#L2439) |  |
| [2440](#L2440) | if ($is && $abis) { |
| [2441](#L2441) | for ($i = 0; $i < sizeof($ab); ++$i) { |
| [2442](#L2442) | $s = $ab[$i]; |
| [2443](#L2443) | if ($s->whr == '1') { |
| [2444](#L2444) | $abres[] = ['s' => $s->txt, 'w' => $s->pos, 'z' => strlen($s->txt)]; |
| [2445](#L2445) | } |
| [2446](#L2446) | } |
| [2447](#L2447) | } |
| [2448](#L2448) |  |
| [2449](#L2449) | $limitcrl = 64; |
| [2450](#L2450) | if ($dirCalc && defined('BMI\_CLI\_ENABLED') && BMI\_CLI\_ENABLED === true && !defined('BMI\_CLI\_FAILED')) $limitcrl = 128; |
| [2451](#L2451) | $first\_big = false; |
| [2452](#L2452) | $sizemax = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:SIZE:IN'); |
| [2453](#L2453) | $usesize = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:SIZE') === 'true' && $is) ? true : false; |
| [2454](#L2454) | if (!is\_numeric($sizemax)) { |
| [2455](#L2455) | $usesize = false; |
| [2456](#L2456) | $sizemax = 99999; |
| [2457](#L2457) | } else { |
| [2458](#L2458) | $sizemax = intval($sizemax); |
| [2459](#L2459) | } |
| [2460](#L2460) |  |
| [2461](#L2461) | // If legacy === false it will use background process to bypass the timeout |
| [2462](#L2462) | if ($dirCalc) { |
| [2463](#L2463) | $legacy = true; |
| [2464](#L2464) | } else { |
| [2465](#L2465) | if (!defined('BMI\_LEGACY\_VERSION')) $legacy = true; |
| [2466](#L2466) | else $legacy = BMI\_LEGACY\_VERSION; |
| [2467](#L2467) | if ($legacy && defined('BMI\_LEGACY\_HARD\_VERSION') && !BMI\_LEGACY\_HARD\_VERSION) $legacy = BMI\_LEGACY\_HARD\_VERSION; |
| [2468](#L2468) | if (defined('BMI\_CLI\_ENABLED') && defined('BMI\_FUNCTION\_NORMAL') && BMI\_CLI\_ENABLED === true && BMI\_FUNCTION\_NORMAL === true && !defined('BMI\_CLI\_FAILED')) $legacy = false; |
| [2469](#L2469) | } |
| [2470](#L2470) |  |
| [2471](#L2471) | $total\_size = 0; |
| [2472](#L2472) | $excludedBytes = 0; |
| [2473](#L2473) | $max = $sizemax \* (1024 \* 1024); |
| [2474](#L2474) | $maxfor = sizeof($files); |
| [2475](#L2475) |  |
| [2476](#L2476) | // Non-legacy variables |
| [2477](#L2477) | if ($legacy === false) { |
| [2478](#L2478) | $Hx = trailingslashit(WP\_CONTENT\_DIR); |
| [2479](#L2479) | $Hz = trailingslashit(ABSPATH); |
| [2480](#L2480) | $Hxs = strlen($Hx); |
| [2481](#L2481) | $Hzs = strlen($Hz); |
| [2482](#L2482) | } |
| [2483](#L2483) |  |
| [2484](#L2484) | // Sort it by size |
| [2485](#L2485) | if ($legacy === false) { |
| [2486](#L2486) | usort($files, function ($a, $b) { |
| [2487](#L2487) | $a = explode(',', $a); |
| [2488](#L2488) | $last = sizeof($a) - 1; |
| [2489](#L2489) | $sizea = intval($a[$last]); |
| [2490](#L2490) |  |
| [2491](#L2491) | $b = explode(',', $b); |
| [2492](#L2492) | $last = sizeof($b) - 1; |
| [2493](#L2493) | $sizeb = intval($b[$last]); |
| [2494](#L2494) |  |
| [2495](#L2495) | if ($sizea == $sizeb) return 0; |
| [2496](#L2496) | if ($sizea < $sizeb) return -1; |
| [2497](#L2497) | else return 1; |
| [2498](#L2498) | }); |
| [2499](#L2499) | } |
| [2500](#L2500) |  |
| [2501](#L2501) | // Process due to rules |
| [2502](#L2502) | for ($i = 0; $i < $maxfor; ++$i) { |
| [2503](#L2503) |  |
| [2504](#L2504) | // Remove size from path and get the size |
| [2505](#L2505) | $files[$i] = explode(',', $files[$i]); |
| [2506](#L2506) | $last = sizeof($files[$i]) - 1; |
| [2507](#L2507) | $size = intval($files[$i][$last]); |
| [2508](#L2508) | unset($files[$i][$last]); |
| [2509](#L2509) | $files[$i] = implode(',', $files[$i]); |
| [2510](#L2510) |  |
| [2511](#L2511) | if ($usesize && Scanner::fileTooLarge($size, $max)) { |
| [2512](#L2512) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (too large) ", 'backup-backup') . $files[$i] . ' (' . number\_format(($size / 1024 / 1024), 2) . ' MB)', 'WARN'); |
| [2513](#L2513) | array\_splice($files, $i, 1); |
| [2514](#L2514) | $maxfor--; |
| [2515](#L2515) | $i--; |
| [2516](#L2516) |  |
| [2517](#L2517) | $excludedBytes += $size; |
| [2518](#L2518) | continue; |
| [2519](#L2519) | } |
| [2520](#L2520) |  |
| [2521](#L2521) | if ($abis && Scanner::equalFolder(basename($files[$i]), $abres)) { |
| [2522](#L2522) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (due to exclude rules): ", 'backup-backup') . $files[$i], 'WARN'); |
| [2523](#L2523) | array\_splice($files, $i, 1); |
| [2524](#L2524) | $maxfor--; |
| [2525](#L2525) | $i--; |
| [2526](#L2526) |  |
| [2527](#L2527) | $excludedBytes += $size; |
| [2528](#L2528) | continue; |
| [2529](#L2529) | } |
| [2530](#L2530) |  |
| [2531](#L2531) | if ($acis && property\_exists($acres, $files[$i])) { |
| [2532](#L2532) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (due to path rules): ", 'backup-backup') . $files[$i], 'WARN'); |
| [2533](#L2533) | array\_splice($files, $i, 1); |
| [2534](#L2534) | $maxfor--; |
| [2535](#L2535) | $i--; |
| [2536](#L2536) |  |
| [2537](#L2537) | $excludedBytes += $size; |
| [2538](#L2538) | continue; |
| [2539](#L2539) | } |
| [2540](#L2540) |  |
| [2541](#L2541) | if ($size === 0) { |
| [2542](#L2542) | array\_splice($files, $i, 1); |
| [2543](#L2543) | $maxfor--; |
| [2544](#L2544) | $i--; |
| [2545](#L2545) |  |
| [2546](#L2546) | $excludedBytes += $size; |
| [2547](#L2547) | continue; |
| [2548](#L2548) | } |
| [2549](#L2549) |  |
| [2550](#L2550) | if (strpos($files[$i], 'bmi-pclzip-') !== false) { |
| [2551](#L2551) | array\_splice($files, $i, 1); |
| [2552](#L2552) | $maxfor--; |
| [2553](#L2553) | $i--; |
| [2554](#L2554) |  |
| [2555](#L2555) | $excludedBytes += $size; |
| [2556](#L2556) | continue; |
| [2557](#L2557) | } |
| [2558](#L2558) |  |
| [2559](#L2559) | if ($size > ($limitcrl \* (1024 \* 1024))) { |
| [2560](#L2560) | if ($first\_big === false) $first\_big = $i; |
| [2561](#L2561) | if (!$dirCalc) $progress->log(\_\_("This file is quite big consider to exclude it, if backup fails: ", 'backup-backup') . $files[$i] . ' (' . BMP::humanSize($size) . ')', 'WARN'); |
| [2562](#L2562) | } |
| [2563](#L2563) |  |
| [2564](#L2564) | if (($legacy === false && (BMI\_FUNCTION\_NORMAL === false || (BMI\_FUNCTION\_NORMAL === true && BMI\_CLI\_ENABLED === true))) && (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false)) { |
| [2565](#L2565) | $fx = strpos($files[$i], $Hx); |
| [2566](#L2566) | $fz = strpos($files[$i], $Hz); |
| [2567](#L2567) |  |
| [2568](#L2568) | if ($fx !== false) $files[$i] = substr\_replace($files[$i], '@1@', $fx, $Hxs); |
| [2569](#L2569) | else if ($fz !== false) $files[$i] = substr\_replace($files[$i], '@2@', $fz, $Hzs); |
| [2570](#L2570) |  |
| [2571](#L2571) | $files[$i] .= ',' . $size; |
| [2572](#L2572) | } |
| [2573](#L2573) | $total\_size += $size; |
| [2574](#L2574) | } |
| [2575](#L2575) |  |
| [2576](#L2576) | if ($legacy === false && (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false)) { |
| [2577](#L2577) | $list\_file = BMI\_TMP . DIRECTORY\_SEPARATOR . 'files\_latest.list'; |
| [2578](#L2578) | if (file\_exists($list\_file)) @unlink($list\_file); |
| [2579](#L2579) | $files\_list = fopen($list\_file, 'a'); |
| [2580](#L2580) | if ($first\_big === false) fwrite($files\_list, sizeof($files) . "\_-1\r\n"); |
| [2581](#L2581) | else fwrite($files\_list, sizeof($files) . '\_' . $first\_big . "\r\n"); |
| [2582](#L2582) | for ($i = 0; $i < sizeof($files); ++$i) { |
| [2583](#L2583) | fwrite($files\_list, $files[$i] . "\r\n"); |
| [2584](#L2584) | } |
| [2585](#L2585) | fclose($files\_list); |
| [2586](#L2586) | $this->first\_big = $first\_big; |
| [2587](#L2587) | } |
| [2588](#L2588) |  |
| [2589](#L2589) | $total\_size += $this->getDatabaseSize(); |
| [2590](#L2590) | $this->total\_excluded\_size\_for\_backup = $excludedBytes; |
| [2591](#L2591) | $this->total\_size\_for\_backup = $total\_size; |
| [2592](#L2592) | $this->total\_size\_for\_backup\_in\_mb = ($total\_size / 1024 / 1024); |
| [2593](#L2593) |  |
| [2594](#L2594) | return $files; |
| [2595](#L2595) | } |
| [2596](#L2596) |  |
| [2597](#L2597) | public function toggleBackupLock($unlock = false) { |
| [2598](#L2598) |  |
| [2599](#L2599) | // Require lib |
| [2600](#L2600) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'zipper' . DIRECTORY\_SEPARATOR . 'zipping.php'; |
| [2601](#L2601) |  |
| [2602](#L2602) | // Backup name |
| [2603](#L2603) | $filename = $this->post['filename']; |
| [2604](#L2604) |  |
| [2605](#L2605) | // Init Zipper |
| [2606](#L2606) | $zipper = new Zipper(); |
| [2607](#L2607) |  |
| [2608](#L2608) | // Path to Backup |
| [2609](#L2609) | $path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $filename; |
| [2610](#L2610) | $path\_dir = BMP::fixSlashes(dirname($path)); |
| [2611](#L2611) |  |
| [2612](#L2612) | // Check if file exists |
| [2613](#L2613) | if (!file\_exists($path)) { |
| [2614](#L2614) | return ['status' => 'fail']; |
| [2615](#L2615) | } |
| [2616](#L2616) |  |
| [2617](#L2617) | // Check if directory is correct |
| [2618](#L2618) | if ($path\_dir != BMP::fixSlashes(BMI\_BACKUPS)) { |
| [2619](#L2619) | return ['status' => 'fail']; |
| [2620](#L2620) | } |
| [2621](#L2621) |  |
| [2622](#L2622) | // Toggle the lock |
| [2623](#L2623) | $status = $zipper->lock\_zip($path, $unlock); |
| [2624](#L2624) |  |
| [2625](#L2625) | // Return the status |
| [2626](#L2626) | return ['status' => ($status ? 'success' : 'fail')]; |
| [2627](#L2627) | } |
| [2628](#L2628) |  |
| [2629](#L2629) | public function getDynamicNames() { |
| [2630](#L2630) | $data = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2631](#L2631) | $fpdata = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS:IN'); |
| [2632](#L2632) | $fddata = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS:IN'); |
| [2633](#L2633) |  |
| [2634](#L2634) | for ($i = 0; $i < sizeof($fpdata); ++$i) { |
| [2635](#L2635) | $fpdata[$i] = BMP::fixSlashes($fpdata[$i]); |
| [2636](#L2636) | } |
| [2637](#L2637) |  |
| [2638](#L2638) | for ($i = 0; $i < sizeof($fddata); ++$i) { |
| [2639](#L2639) | $fddata[$i] = BMP::fixSlashes($fddata[$i]); |
| [2640](#L2640) | } |
| [2641](#L2641) |  |
| [2642](#L2642) | return [ |
| [2643](#L2643) | 'status' => 'success', |
| [2644](#L2644) | 'dynamic-fpaths-names' => $fpdata, |
| [2645](#L2645) | 'dynamic-dpaths-names' => $fddata, |
| [2646](#L2646) | 'data' => $data |
| [2647](#L2647) | ]; |
| [2648](#L2648) | } |
| [2649](#L2649) |  |
| [2650](#L2650) | public function resetConfiguration() { |
| [2651](#L2651) |  |
| [2652](#L2652) | if (file\_exists(BMI\_CONFIG\_PATH)) { |
| [2653](#L2653) | @unlink(BMI\_CONFIG\_PATH); |
| [2654](#L2654) | } |
| [2655](#L2655) |  |
| [2656](#L2656) | delete\_option('bmi\_hotfixes'); |
| [2657](#L2657) | delete\_option('bmip\_to\_be\_uploaded'); |
| [2658](#L2658) | delete\_option('bmi\_pro\_gd\_client\_id'); |
| [2659](#L2659) | delete\_option('bmi\_pro\_gd\_token'); |
| [2660](#L2660) | delete\_option('bmi\_pro\_cron\_domain\_done'); |
| [2661](#L2661) | delete\_option('BMI::STORAGE::LOCAL::PATH'); |
| [2662](#L2662) |  |
| [2663](#L2663) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'unknown'); |
| [2664](#L2664) |  |
| [2665](#L2665) | return ['status' => 'success']; |
| [2666](#L2666) |  |
| [2667](#L2667) | } |
| [2668](#L2668) |  |
| [2669](#L2669) | public function getSiteData() { |
| [2670](#L2670) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'check' . DIRECTORY\_SEPARATOR . 'system\_info.php'; |
| [2671](#L2671) | $bmi = new SI(); |
| [2672](#L2672) | $bmi = $bmi->to\_array(); |
| [2673](#L2673) |  |
| [2674](#L2674) | return ['status' => 'success', 'data' => $bmi]; |
| [2675](#L2675) | } |
| [2676](#L2676) |  |
| [2677](#L2677) | public function calculateCron() { |
| [2678](#L2678) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'cron' . DIRECTORY\_SEPARATOR . 'handler.php'; |
| [2679](#L2679) |  |
| [2680](#L2680) | $minutes = []; |
| [2681](#L2681) | $keeps = []; |
| [2682](#L2682) | $days = []; |
| [2683](#L2683) | $weeks = []; |
| [2684](#L2684) | $hours = []; |
| [2685](#L2685) |  |
| [2686](#L2686) | for ($i = 1; $i <= 28; ++$i) { |
| [2687](#L2687) | $days[] = substr('0' . $i, -2); |
| [2688](#L2688) | } |
| [2689](#L2689) | for ($i = 1; $i <= 7; ++$i) { |
| [2690](#L2690) | $weeks[] = $i . ''; |
| [2691](#L2691) | } |
| [2692](#L2692) | for ($i = 0; $i <= 23; ++$i) { |
| [2693](#L2693) | $hours[] = substr('0' . $i, -2); |
| [2694](#L2694) | } |
| [2695](#L2695) | for ($i = 0; $i <= 55; $i += 5) { |
| [2696](#L2696) | $minutes[] = substr('0' . $i, -2); |
| [2697](#L2697) | } |
| [2698](#L2698) | for ($i = 1; $i <= 20; ++$i) { |
| [2699](#L2699) | $keeps[] = $i . ''; |
| [2700](#L2700) | } |
| [2701](#L2701) |  |
| [2702](#L2702) | $errors = 0; |
| [2703](#L2703) | if (in\_array($this->post['type'], ['month', 'week', 'day'])) { |
| [2704](#L2704) | if (!Dashboard\bmi\_set\_config('CRON:TYPE', $this->post['type'])) { |
| [2705](#L2705) | $errors++; |
| [2706](#L2706) | } |
| [2707](#L2707) | } |
| [2708](#L2708) | if (in\_array($this->post['day'], $days)) { |
| [2709](#L2709) | if (!Dashboard\bmi\_set\_config('CRON:DAY', $this->post['day'])) { |
| [2710](#L2710) | $errors++; |
| [2711](#L2711) | } |
| [2712](#L2712) | } |
| [2713](#L2713) | if (in\_array($this->post['week'], $weeks)) { |
| [2714](#L2714) | if (!Dashboard\bmi\_set\_config('CRON:WEEK', $this->post['week'])) { |
| [2715](#L2715) | $errors++; |
| [2716](#L2716) | } |
| [2717](#L2717) | } |
| [2718](#L2718) | if (in\_array($this->post['hour'], $hours)) { |
| [2719](#L2719) | if (!Dashboard\bmi\_set\_config('CRON:HOUR', $this->post['hour'])) { |
| [2720](#L2720) | $errors++; |
| [2721](#L2721) | } |
| [2722](#L2722) | } |
| [2723](#L2723) | if (in\_array($this->post['minute'], $minutes)) { |
| [2724](#L2724) | if (!Dashboard\bmi\_set\_config('CRON:MINUTE', $this->post['minute'])) { |
| [2725](#L2725) | $errors++; |
| [2726](#L2726) | } |
| [2727](#L2727) | } |
| [2728](#L2728) | if (in\_array($this->post['keep'], $keeps)) { |
| [2729](#L2729) | if (!Dashboard\bmi\_set\_config('CRON:KEEP', $this->post['keep'])) { |
| [2730](#L2730) | $errors++; |
| [2731](#L2731) | } |
| [2732](#L2732) | } |
| [2733](#L2733) |  |
| [2734](#L2734) | if ($this->post['enabled'] === 'true') { |
| [2735](#L2735) | $this->post['enabled'] = true; |
| [2736](#L2736) | } else { |
| [2737](#L2737) | $this->post['enabled'] = false; |
| [2738](#L2738) | } |
| [2739](#L2739) |  |
| [2740](#L2740) | if (!Dashboard\bmi\_set\_config('CRON:ENABLED', $this->post['enabled'])) { |
| [2741](#L2741) | $errors++; |
| [2742](#L2742) | } |
| [2743](#L2743) |  |
| [2744](#L2744) | if ($errors === 0) { |
| [2745](#L2745) | $time = Crons::calculate\_date([ |
| [2746](#L2746) | 'type' => $this->post['type'], |
| [2747](#L2747) | 'week' => $this->post['week'], |
| [2748](#L2748) | 'day' => $this->post['day'], |
| [2749](#L2749) | 'hour' => $this->post['hour'], |
| [2750](#L2750) | 'minute' => $this->post['minute'] |
| [2751](#L2751) | ], time()); |
| [2752](#L2752) |  |
| [2753](#L2753) | $file = BMI\_TMP . DIRECTORY\_SEPARATOR . '.plan'; |
| [2754](#L2754) | if (file\_exists($file)) { |
| [2755](#L2755) | $earlier = intval(file\_get\_contents($file)); |
| [2756](#L2756) | } else { |
| [2757](#L2757) | $earlier = 0; |
| [2758](#L2758) | } |
| [2759](#L2759) |  |
| [2760](#L2760) | if (!wp\_next\_scheduled('bmi\_do\_backup\_right\_now') || $earlier === 0 || (abs($time - $earlier) >= 15)) { |
| [2761](#L2761) | wp\_clear\_scheduled\_hook('bmi\_do\_backup\_right\_now'); |
| [2762](#L2762) | if ($this->post['enabled'] === true) { |
| [2763](#L2763) | wp\_schedule\_single\_event($time, 'bmi\_do\_backup\_right\_now'); |
| [2764](#L2764) | file\_put\_contents($file, $time); |
| [2765](#L2765) | } |
| [2766](#L2766) | } |
| [2767](#L2767) |  |
| [2768](#L2768) | return [ |
| [2769](#L2769) | 'status' => 'success', |
| [2770](#L2770) | 'data' => date('Y-m-d H:i:s', $time), |
| [2771](#L2771) | 'currdata' => date('Y-m-d H:i:s') |
| [2772](#L2772) | ]; |
| [2773](#L2773) | } else { |
| [2774](#L2774) | return ['status' => 'error']; |
| [2775](#L2775) | } |
| [2776](#L2776) | } |
| [2777](#L2777) |  |
| [2778](#L2778) | public function dismissErrorNotice() { |
| [2779](#L2779) | delete\_option('bmi\_display\_email\_issues'); |
| [2780](#L2780) | } |
| [2781](#L2781) |  |
| [2782](#L2782) | // recursive removal |
| [2783](#L2783) | private function rrmdir($dir) { |
| [2784](#L2784) |  |
| [2785](#L2785) | if (is\_dir($dir)) { |
| [2786](#L2786) |  |
| [2787](#L2787) | $objects = scandir($dir); |
| [2788](#L2788) | foreach ($objects as $object) { |
| [2789](#L2789) |  |
| [2790](#L2790) | if ($object != "." && $object != "..") { |
| [2791](#L2791) |  |
| [2792](#L2792) | if (is\_dir($dir . DIRECTORY\_SEPARATOR . $object) && !is\_link($dir . DIRECTORY\_SEPARATOR . $object)) { |
| [2793](#L2793) |  |
| [2794](#L2794) | $this->rrmdir($dir . DIRECTORY\_SEPARATOR . $object); |
| [2795](#L2795) |  |
| [2796](#L2796) | } else { |
| [2797](#L2797) |  |
| [2798](#L2798) | @unlink($dir . DIRECTORY\_SEPARATOR . $object); |
| [2799](#L2799) |  |
| [2800](#L2800) | } |
| [2801](#L2801) |  |
| [2802](#L2802) | } |
| [2803](#L2803) |  |
| [2804](#L2804) | } |
| [2805](#L2805) |  |
| [2806](#L2806) | @rmdir($dir); |
| [2807](#L2807) |  |
| [2808](#L2808) | } else { |
| [2809](#L2809) |  |
| [2810](#L2810) | if (file\_exists($dir) && is\_file($dir)) { |
| [2811](#L2811) |  |
| [2812](#L2812) | @unlink($dir); |
| [2813](#L2813) |  |
| [2814](#L2814) | } |
| [2815](#L2815) |  |
| [2816](#L2816) | } |
| [2817](#L2817) |  |
| [2818](#L2818) | } |
| [2819](#L2819) |  |
| [2820](#L2820) | public function forceBackupToStop() { |
| [2821](#L2821) |  |
| [2822](#L2822) | $filesToBeRemoved = []; |
| [2823](#L2823) |  |
| [2824](#L2824) | $tmp\_dir = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp'; |
| [2825](#L2825) | if (!is\_dir($tmp\_dir)) @mkdir($tmp\_dir, 0755, true); |
| [2826](#L2826) |  |
| [2827](#L2827) | foreach (scandir($tmp\_dir) as $filename) { |
| [2828](#L2828) |  |
| [2829](#L2829) | if (in\_array($filename, ['.', '..'])) continue; |
| [2830](#L2830) | $path = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp' . DIRECTORY\_SEPARATOR . $filename; |
| [2831](#L2831) | $filesToBeRemoved[] = $path; |
| [2832](#L2832) |  |
| [2833](#L2833) | } |
| [2834](#L2834) |  |
| [2835](#L2835) | $allowedFiles = ['wp-config.php', '.htaccess', '.litespeed', '.default.json', 'driveKeys.php', '.autologin.php', '.migrationFinished']; |
| [2836](#L2836) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . '.\*') as $filename) { |
| [2837](#L2837) |  |
| [2838](#L2838) | $basename = basename($filename); |
| [2839](#L2839) |  |
| [2840](#L2840) | if (in\_array($basename, ['.', '..'])) continue; |
| [2841](#L2841) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2842](#L2842) | $filesToBeRemoved[] = $filename; |
| [2843](#L2843) | } |
| [2844](#L2844) |  |
| [2845](#L2845) | } |
| [2846](#L2846) |  |
| [2847](#L2847) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'BMI-\*', GLOB\_ONLYDIR) as $filename) { |
| [2848](#L2848) |  |
| [2849](#L2849) | $basename = basename($filename); |
| [2850](#L2850) |  |
| [2851](#L2851) | if (in\_array($basename, ['.', '..'])) continue; |
| [2852](#L2852) | if (is\_dir($filename) && !in\_array($filename, $allowedFiles)) { |
| [2853](#L2853) | $filesToBeRemoved[] = $filename; |
| [2854](#L2854) | } |
| [2855](#L2855) |  |
| [2856](#L2856) | } |
| [2857](#L2857) |  |
| [2858](#L2858) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'bg-BMI-\*', GLOB\_ONLYDIR) as $filename) { |
| [2859](#L2859) |  |
| [2860](#L2860) | $basename = basename($filename); |
| [2861](#L2861) |  |
| [2862](#L2862) | if (in\_array($basename, ['.', '..'])) continue; |
| [2863](#L2863) | if (is\_dir($filename) && !in\_array($filename, $allowedFiles)) { |
| [2864](#L2864) | $filesToBeRemoved[] = $filename; |
| [2865](#L2865) | } |
| [2866](#L2866) |  |
| [2867](#L2867) | } |
| [2868](#L2868) |  |
| [2869](#L2869) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock'; |
| [2870](#L2870) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock\_ended'; |
| [2871](#L2871) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock\_end'; |
| [2872](#L2872) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'; |
| [2873](#L2873) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'db\_tables'; |
| [2874](#L2874) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'bmi\_backup\_manifest.json'; |
| [2875](#L2875) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'files\_latest.list'; |
| [2876](#L2876) |  |
| [2877](#L2877) | if (is\_array($filesToBeRemoved) || is\_object($filesToBeRemoved)) { |
| [2878](#L2878) | foreach ((array) $filesToBeRemoved as $file) { |
| [2879](#L2879) | $this->rrmdir($file); |
| [2880](#L2880) | } |
| [2881](#L2881) | } |
| [2882](#L2882) |  |
| [2883](#L2883) | return ['status' => 'success']; |
| [2884](#L2884) |  |
| [2885](#L2885) | } |
| [2886](#L2886) |  |
| [2887](#L2887) | public function forceRestoreToStop() { |
| [2888](#L2888) |  |
| [2889](#L2889) | $filesToBeRemoved = []; |
| [2890](#L2890) |  |
| [2891](#L2891) | $themedir = get\_theme\_root(); |
| [2892](#L2892) | $tempTheme = $themedir . DIRECTORY\_SEPARATOR . 'backup\_migration\_restoration\_in\_progress'; |
| [2893](#L2893) | $filesToBeRemoved[] = $tempTheme; |
| [2894](#L2894) |  |
| [2895](#L2895) | $tmpDirectory = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp'; |
| [2896](#L2896) | if (!is\_dir($tmpDirectory)) @mkdir($tmpDirectory, 0755, true); |
| [2897](#L2897) |  |
| [2898](#L2898) | foreach (scandir($tmpDirectory) as $filename) { |
| [2899](#L2899) |  |
| [2900](#L2900) | if (in\_array($filename, ['.', '..'])) continue; |
| [2901](#L2901) | $path = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp' . DIRECTORY\_SEPARATOR . $filename; |
| [2902](#L2902) | $filesToBeRemoved[] = $path; |
| [2903](#L2903) |  |
| [2904](#L2904) | } |
| [2905](#L2905) |  |
| [2906](#L2906) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'backup-migration\_??????????') as $filename) { |
| [2907](#L2907) |  |
| [2908](#L2908) | $basename = basename($filename); |
| [2909](#L2909) |  |
| [2910](#L2910) | if (is\_dir($filename) && !in\_array($basename, ['.', '..'])) { |
| [2911](#L2911) | $filesToBeRemoved[] = $filename; |
| [2912](#L2912) | } |
| [2913](#L2913) |  |
| [2914](#L2914) | } |
| [2915](#L2915) |  |
| [2916](#L2916) | $allowedFiles = ['wp-config.php', '.htaccess', '.litespeed', '.default.json', 'driveKeys.php', '.autologin.php', '.migrationFinished']; |
| [2917](#L2917) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . '.\*') as $filename) { |
| [2918](#L2918) |  |
| [2919](#L2919) | $basename = basename($filename); |
| [2920](#L2920) |  |
| [2921](#L2921) | if (in\_array($basename, ['.', '..'])) continue; |
| [2922](#L2922) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2923](#L2923) | $filesToBeRemoved[] = $filename; |
| [2924](#L2924) | } |
| [2925](#L2925) |  |
| [2926](#L2926) | } |
| [2927](#L2927) |  |
| [2928](#L2928) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'restore\_scan\_\*') as $filename) { |
| [2929](#L2929) |  |
| [2930](#L2930) | $basename = basename($filename); |
| [2931](#L2931) |  |
| [2932](#L2932) | if (in\_array($basename, ['.', '..'])) continue; |
| [2933](#L2933) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2934](#L2934) | $filesToBeRemoved[] = $filename; |
| [2935](#L2935) | } |
| [2936](#L2936) |  |
| [2937](#L2937) | } |
| [2938](#L2938) |  |
| [2939](#L2939) | foreach (glob(untrailingslashit(ABSPATH) . DIRECTORY\_SEPARATOR . 'wp-config.??????????.php') as $filename) { |
| [2940](#L2940) |  |
| [2941](#L2941) | $basename = basename($filename); |
| [2942](#L2942) |  |
| [2943](#L2943) | if (in\_array($basename, ['.', '..'])) continue; |
| [2944](#L2944) | if (is\_file($filename) && !in\_array($filename, $allowedFiles)) { |
| [2945](#L2945) | $filesToBeRemoved[] = $filename; |
| [2946](#L2946) | } |
| [2947](#L2947) |  |
| [2948](#L2948) | } |
| [2949](#L2949) |  |
| [2950](#L2950) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock'; |
| [2951](#L2951) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_cli'; |
| [2952](#L2952) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_cli\_end'; |
| [2953](#L2953) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_ended'; |
| [2954](#L2954) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.cli\_download\_last'; |
| [2955](#L2955) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'; |
| [2956](#L2956) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . '.restore\_secret'; |
| [2957](#L2957) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . '.table\_map'; |
| [2958](#L2958) |  |
| [2959](#L2959) | if (is\_array($filesToBeRemoved) || is\_object($filesToBeRemoved)) { |
| [2960](#L2960) | foreach ((array) $filesToBeRemoved as $file) { |
| [2961](#L2961) | $this->rrmdir($file); |
| [2962](#L2962) | } |
| [2963](#L2963) | } |
| [2964](#L2964) |  |
| [2965](#L2965) | return ['status' => 'success']; |
| [2966](#L2966) |  |
| [2967](#L2967) | } |
| [2968](#L2968) |  |
| [2969](#L2969) | public function sendTroubleshootingDetails($send\_type = 'manual', $triggeredBy = false, $blocking = true) { |
| [2970](#L2970) |  |
| [2971](#L2971) | global $table\_prefix; |
| [2972](#L2972) |  |
| [2973](#L2973) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'check' . DIRECTORY\_SEPARATOR . 'system\_info.php'; |
| [2974](#L2974) | $bmiSiteData = new SI(); |
| [2975](#L2975) | $bmiSiteData = $bmiSiteData->to\_array(); |
| [2976](#L2976) | $bmiSiteData['database\_size'] = $this->getDatabaseSize(); |
| [2977](#L2977) | $bmiSiteData['database\_size\_mb'] = BMP::humanSize($bmiSiteData['database\_size']); |
| [2978](#L2978) | $bmiSiteData['xhria'] = get\_option('z\_\_bmi\_xhria', 'none'); |
| [2979](#L2979) | $bmiSiteData['current\_table\_prefix'] = $table\_prefix; |
| [2980](#L2980) |  |
| [2981](#L2981) | $wpconfigPath = ABSPATH . DIRECTORY\_SEPARATOR . 'wp-config.php'; |
| [2982](#L2982) | if (file\_exists($wpconfigPath)) { |
| [2983](#L2983) | $bmiSiteData['is\_wp\_config\_writable'] = is\_writable($wpconfigPath) ? "yes" : "no"; |
| [2984](#L2984) | } else { |
| [2985](#L2985) | $bmiSiteData['is\_wp\_config\_writable'] = "file\_does\_not\_exist?"; |
| [2986](#L2986) | } |
| [2987](#L2987) |  |
| [2988](#L2988) | $latestBackupLogs = 'does\_not\_exist'; |
| [2989](#L2989) | $latestBackupProgress = 'does\_not\_exist'; |
| [2990](#L2990) | $latestRestorationLogs = 'does\_not\_exist'; |
| [2991](#L2991) | $latestRestorationProgress = 'does\_not\_exist'; |
| [2992](#L2992) | $latestStagingLogs = 'does\_not\_exist'; |
| [2993](#L2993) | $latestStagingProgress = 'does\_not\_exist'; |
| [2994](#L2994) | $currentPluginConfig = 'does\_not\_exist'; |
| [2995](#L2995) | $pluginGlobalLogs = 'does\_not\_exist'; |
| [2996](#L2996) | $backgroundErrors = 'does\_not\_exist'; |
| [2997](#L2997) |  |
| [2998](#L2998) | if (file\_exists(BMI\_BACKUPS . '/latest.log')) { |
| [2999](#L2999) | $latestBackupLogs = file\_get\_contents(BMI\_BACKUPS . '/latest.log'); |
| [3000](#L3000) | } |
| [3001](#L3001) |  |
| [3002](#L3002) | if (file\_exists(BMI\_BACKUPS . '/latest\_progress.log')) { |
| [3003](#L3003) | $latestBackupProgress = file\_get\_contents(BMI\_BACKUPS . '/latest\_progress.log'); |
| [3004](#L3004) | } |
| [3005](#L3005) |  |
| [3006](#L3006) | if (file\_exists(BMI\_BACKUPS . '/latest\_migration.log')) { |
| [3007](#L3007) | $latestRestorationLogs = file\_get\_contents(BMI\_BACKUPS . '/latest\_migration.log'); |
| [3008](#L3008) | } |
| [3009](#L3009) |  |
| [3010](#L3010) | if (file\_exists(BMI\_BACKUPS . '/latest\_migration\_progress.log')) { |
| [3011](#L3011) | $latestRestorationProgress = file\_get\_contents(BMI\_BACKUPS . '/latest\_migration\_progress.log'); |
| [3012](#L3012) | } |
| [3013](#L3013) |  |
| [3014](#L3014) | if (file\_exists(BMI\_STAGING . '/latest\_staging.log')) { |
| [3015](#L3015) | $latestStagingLogs = file\_get\_contents(BMI\_STAGING . '/latest\_staging.log'); |
| [3016](#L3016) | } |
| [3017](#L3017) |  |
| [3018](#L3018) | if (file\_exists(BMI\_STAGING . '/latest\_staging\_progress.log')) { |
| [3019](#L3019) | $latestStagingProgress = file\_get\_contents(BMI\_STAGING . '/latest\_staging\_progress.log'); |
| [3020](#L3020) | } |
| [3021](#L3021) |  |
| [3022](#L3022) | if (file\_exists(BMI\_CONFIG\_PATH)) { |
| [3023](#L3023) | $currentPluginConfig = substr(file\_get\_contents(BMI\_CONFIG\_PATH), 8); |
| [3024](#L3024) | } |
| [3025](#L3025) |  |
| [3026](#L3026) | $completeLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'complete\_logs.log'; |
| [3027](#L3027) | if (file\_exists($completeLogsPath)) { |
| [3028](#L3028) | if ((filesize($completeLogsPath) / 1024 / 1024) <= 4) { |
| [3029](#L3029) | $pluginGlobalLogs = file\_get\_contents($completeLogsPath); |
| [3030](#L3030) | } else { |
| [3031](#L3031) | @unlink($completeLogsPath); |
| [3032](#L3032) | @touch($completeLogsPath); |
| [3033](#L3033) | $pluginGlobalLogs = 'file\_too\_large'; |
| [3034](#L3034) | } |
| [3035](#L3035) | } |
| [3036](#L3036) |  |
| [3037](#L3037) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [3038](#L3038) | if (file\_exists($backgroundLogsPath)) { |
| [3039](#L3039) | if ((filesize($backgroundLogsPath) / 1024 / 1024) <= 4) { |
| [3040](#L3040) | $backgroundErrors = file\_get\_contents($backgroundLogsPath); |
| [3041](#L3041) | } else { |
| [3042](#L3042) | @unlink($backgroundLogsPath); |
| [3043](#L3043) | @touch($backgroundLogsPath); |
| [3044](#L3044) | $backgroundErrors = 'file\_too\_large'; |
| [3045](#L3045) | } |
| [3046](#L3046) | } |
| [3047](#L3047) |  |
| [3048](#L3048) | $ifCLI = false; |
| [3049](#L3049) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [3050](#L3050) | $ifCLI = true; |
| [3051](#L3051) | } |
| [3052](#L3052) |  |
| [3053](#L3053) | $logsSourceFrontEnd = 'manual'; |
| [3054](#L3054) | if ($triggeredBy != false) { |
| [3055](#L3055) | $logsSourceFrontEnd = $triggeredBy; |
| [3056](#L3056) | } |
| [3057](#L3057) | if (isset($this->post['source']) && in\_array($this->post['source'], ['backup', 'migration', 'staging'])) { |
| [3058](#L3058) | $logsSourceFrontEnd = $this->post['source']; |
| [3059](#L3059) | } |
| [3060](#L3060) |  |
| [3061](#L3061) | $url = 'https://' . BMI\_API\_BACKUPBLISS\_PUSH . '/v1' . '/push'; |
| [3062](#L3062) | $data = array( |
| [3063](#L3063) | 'method' => 'POST', |
| [3064](#L3064) | 'timeout' => 15, |
| [3065](#L3065) | 'blocking' => $blocking, |
| [3066](#L3066) | 'sslverify' => false, |
| [3067](#L3067) | 'send\_type' => $send\_type, |
| [3068](#L3068) | 'body' => array( |
| [3069](#L3069) | 'admin\_url' => admin\_url(), |
| [3070](#L3070) | 'home\_url' => home\_url(), |
| [3071](#L3071) | 'site\_url' => get\_site\_url(), |
| [3072](#L3072) | 'is\_multisite' => is\_multisite() ? "yes" : "no", |
| [3073](#L3073) | 'is\_abspath\_writable' => is\_writable(ABSPATH) ? "yes" : "no", |
| [3074](#L3074) | 'site\_information' => $bmiSiteData, |
| [3075](#L3075) | 'latest\_backup\_logs' => $latestBackupLogs, |
| [3076](#L3076) | 'latest\_backup\_progress' => $latestBackupProgress, |
| [3077](#L3077) | 'latest\_restoration\_logs' => $latestRestorationLogs, |
| [3078](#L3078) | 'latest\_restoration\_progress' => $latestRestorationProgress, |
| [3079](#L3079) | 'latest\_staging\_logs' => $latestStagingLogs, |
| [3080](#L3080) | 'latest\_staging\_progress' => $latestStagingProgress, |
| [3081](#L3081) | 'current\_plugin\_config' => $currentPluginConfig, |
| [3082](#L3082) | 'plugin\_global\_logs' => $pluginGlobalLogs, |
| [3083](#L3083) | 'background\_errors' => $backgroundErrors, |
| [3084](#L3084) | 'triggered\_by' => $logsSourceFrontEnd, |
| [3085](#L3085) | 'is\_defined' => defined('BMI\_BACKUP\_PRO') ? 'yes' : 'no', |
| [3086](#L3086) | 'is\_cli' => $ifCLI |
| [3087](#L3087) | ) |
| [3088](#L3088) | ); |
| [3089](#L3089) |  |
| [3090](#L3090) | $disabled\_functions = explode(',', ini\_get('disable\_functions')); |
| [3091](#L3091) | $vA = !in\_array('curl\_exec', $disabled\_functions); |
| [3092](#L3092) | $vB = !in\_array('curl\_init', $disabled\_functions); |
| [3093](#L3093) | $vC = !in\_array('http\_build\_query', $disabled\_functions); |
| [3094](#L3094) | $vD = !in\_array('stream\_context\_create', $disabled\_functions); |
| [3095](#L3095) | $vE = !in\_array('file\_get\_contents', $disabled\_functions); |
| [3096](#L3096) | $vF = false; |
| [3097](#L3097) | $response = false; |
| [3098](#L3098) |  |
| [3099](#L3099) | if (function\_exists('curl\_version') && function\_exists('curl\_exec') && function\_exists('curl\_init') && $vA && $vB) { |
| [3100](#L3100) |  |
| [3101](#L3101) | $response = wp\_remote\_post($url, $data); |
| [3102](#L3102) |  |
| [3103](#L3103) | } else { |
| [3104](#L3104) |  |
| [3105](#L3105) | if (ini\_get('allow\_url\_fopen') == true && $vC && $vD && $vE) { |
| [3106](#L3106) |  |
| [3107](#L3107) | $vF = true; |
| [3108](#L3108) | $postdata = http\_build\_query($data['body']); |
| [3109](#L3109) |  |
| [3110](#L3110) | $opts = [ |
| [3111](#L3111) | 'ssl' => [ 'verify\_peer\_name' => false, 'verify\_peer' => false ], |
| [3112](#L3112) | 'http' => [ |
| [3113](#L3113) | 'method'  => 'POST', |
| [3114](#L3114) | 'header'  => 'Content-type: application/x-www-form-urlencoded', |
| [3115](#L3115) | 'content' => $postdata |
| [3116](#L3116) | ] |
| [3117](#L3117) | ]; |
| [3118](#L3118) |  |
| [3119](#L3119) | $context  = stream\_context\_create($opts); |
| [3120](#L3120) | $result = file\_get\_contents($url, false, $context); |
| [3121](#L3121) |  |
| [3122](#L3122) | $response = [ 'body' => $result ]; |
| [3123](#L3123) |  |
| [3124](#L3124) | } |
| [3125](#L3125) |  |
| [3126](#L3126) | } |
| [3127](#L3127) |  |
| [3128](#L3128) | if ($response === false || is\_wp\_error($response)) { |
| [3129](#L3129) | $error\_message = $response->get\_error\_message(); |
| [3130](#L3130) | Logger::error($error\_message, 'backup-backup'); |
| [3131](#L3131) | return ['status' => 'fail']; |
| [3132](#L3132) | } else { |
| [3133](#L3133) | try { |
| [3134](#L3134) | $body = json\_decode($response['body']); |
| [3135](#L3135) | if (isset($body->code)) { |
| [3136](#L3136) | return ['status' => 'success', 'code' => sanitize\_text\_field($body->code)]; |
| [3137](#L3137) | } else { |
| [3138](#L3138) | return ['status' => 'fail']; |
| [3139](#L3139) | } |
| [3140](#L3140) | } catch (\Exception $e) { |
| [3141](#L3141) | Logger::error(print\_r($e, true), 'backup-backup'); |
| [3142](#L3142) | return ['status' => 'fail']; |
| [3143](#L3143) | } catch (\Throwable $t) { |
| [3144](#L3144) | Logger::error(print\_r($t, true), 'backup-backup'); |
| [3145](#L3145) | return ['status' => 'fail']; |
| [3146](#L3146) | } |
| [3147](#L3147) | } |
| [3148](#L3148) |  |
| [3149](#L3149) | } |
| [3150](#L3150) |  |
| [3151](#L3151) | public function actionsAfterProcess($success = false, $triggeredBy = 'backup') { |
| [3152](#L3152) |  |
| [3153](#L3153) | $afterMigrationLock = BMI\_TMP . DIRECTORY\_SEPARATOR . '.migrationFinished'; |
| [3154](#L3154) |  |
| [3155](#L3155) | if ($success) { |
| [3156](#L3156) |  |
| [3157](#L3157) | file\_put\_contents($afterMigrationLock, ''); |
| [3158](#L3158) |  |
| [3159](#L3159) | } else { |
| [3160](#L3160) |  |
| [3161](#L3161) | if (file\_exists($afterMigrationLock)) @unlink($afterMigrationLock); |
| [3162](#L3162) |  |
| [3163](#L3163) | } |
| [3164](#L3164) |  |
| [3165](#L3165) | BMP::handle\_after\_cron(); |
| [3166](#L3166) |  |
| [3167](#L3167) | return null; |
| [3168](#L3168) |  |
| [3169](#L3169) | // REMOVED CODE: |
| [3170](#L3170) | // $canShare = BMP::canShareLogsOrShouldAsk(); |
| [3171](#L3171) | // if ($canShare === 'allowed') { |
| [3172](#L3172) | // |
| [3173](#L3173) | //   $send\_type = 'error'; |
| [3174](#L3174) | //   if ($success) $send\_type = 'success'; |
| [3175](#L3175) | //   $this->sendTroubleshootingDetails($send\_type, $triggeredBy, false); |
| [3176](#L3176) | // |
| [3177](#L3177) | // } |
| [3178](#L3178) |  |
| [3179](#L3179) | } |
| [3180](#L3180) |  |
| [3181](#L3181) | public function logSharing() { |
| [3182](#L3182) |  |
| [3183](#L3183) | $type = $this->post['question']; |
| [3184](#L3184) |  |
| [3185](#L3185) | if ($type == 'set\_yes') { |
| [3186](#L3186) |  |
| [3187](#L3187) | // $isOk = Dashboard\bmi\_set\_config('LOGS::SHARING', 'yes'); |
| [3188](#L3188) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'yes'); |
| [3189](#L3189) | return ['status' => 'success']; |
| [3190](#L3190) |  |
| [3191](#L3191) | } else if ($type == 'set\_no') { |
| [3192](#L3192) |  |
| [3193](#L3193) | // $isOk = Dashboard\bmi\_set\_config('LOGS::SHARING', 'no'); |
| [3194](#L3194) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'no'); |
| [3195](#L3195) | return ['status' => 'success']; |
| [3196](#L3196) |  |
| [3197](#L3197) | } else if ($type == 'is\_allowed') { |
| [3198](#L3198) |  |
| [3199](#L3199) | // $canShare = BMP::canShareLogsOrShouldAsk(); |
| [3200](#L3200) | // return ['status' => 'success', 'result' => $canShare]; |
| [3201](#L3201) | return ['status' => 'success', 'result' => 'not-allowed']; |
| [3202](#L3202) |  |
| [3203](#L3203) | } else { |
| [3204](#L3204) |  |
| [3205](#L3205) | return ['status' => 'fail']; |
| [3206](#L3206) |  |
| [3207](#L3207) | } |
| [3208](#L3208) |  |
| [3209](#L3209) | } |
| [3210](#L3210) |  |
| [3211](#L3211) | public function getLatestBackupFile() { |
| [3212](#L3212) |  |
| [3213](#L3213) | $dir = BMI\_BACKUPS; |
| [3214](#L3214) | $backupdir = array\_diff(scandir($dir), ['..', '.']); |
| [3215](#L3215) | $backups = []; |
| [3216](#L3216) | foreach ($backupdir as $index => $name) { |
| [3217](#L3217) |  |
| [3218](#L3218) | $ext = pathinfo($dir . DIRECTORY\_SEPARATOR . $name, PATHINFO\_EXTENSION); |
| [3219](#L3219) |  |
| [3220](#L3220) | if ($ext === 'zip') { |
| [3221](#L3221) | $backups[] = [ |
| [3222](#L3222) | 'cdate' => filemtime($dir . DIRECTORY\_SEPARATOR . $name), |
| [3223](#L3223) | 'name' => $name |
| [3224](#L3224) | ]; |
| [3225](#L3225) | } |
| [3226](#L3226) |  |
| [3227](#L3227) | } |
| [3228](#L3228) |  |
| [3229](#L3229) | usort($backups, function ($a, $b) { |
| [3230](#L3230) | if (intval($a['cdate']) < intval($b['cdate'])) return 1; |
| [3231](#L3231) | else return -1; |
| [3232](#L3232) | }); |
| [3233](#L3233) |  |
| [3234](#L3234) | $backups = array\_values($backups); |
| [3235](#L3235) |  |
| [3236](#L3236) | if (sizeof($backups) > 0) { |
| [3237](#L3237) | return $backups[0]['name']; |
| [3238](#L3238) | } else { |
| [3239](#L3239) | return '---'; |
| [3240](#L3240) | } |
| [3241](#L3241) |  |
| [3242](#L3242) | } |
| [3243](#L3243) |  |
| [3244](#L3244) | /\*\* |
| [3245](#L3245) | \* isStagingSiteCreationOngoing - Checks if the process is ongoing or not |
| [3246](#L3246) | \* |
| [3247](#L3247) | \* @return {bool} true if the process is running false if its not |
| [3248](#L3248) | \*/ |
| [3249](#L3249) | public function isStagingSiteCreationOngoing() { |
| [3250](#L3250) |  |
| [3251](#L3251) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3252](#L3252) | if (file\_exists($staging\_lock) && (time() - filemtime($staging\_lock)) <= 15) { |
| [3253](#L3253) | return true; |
| [3254](#L3254) | } else { |
| [3255](#L3255) | return false; |
| [3256](#L3256) | } |
| [3257](#L3257) |  |
| [3258](#L3258) | } |
| [3259](#L3259) |  |
| [3260](#L3260) | /\*\* |
| [3261](#L3261) | \* checkStagingLocalName - Verifies name of staging site and checks if it's not currently running |
| [3262](#L3262) | \* Can be called for verification pre start or during start on initial request |
| [3263](#L3263) | \* |
| [3264](#L3264) | \* @param  {string} $name = false name of staging site if called without ajax |
| [3265](#L3265) | \* @return {array} with status/fail/progress data |
| [3266](#L3266) | \*/ |
| [3267](#L3267) | public function checkStagingLocalName($name = false) { |
| [3268](#L3268) |  |
| [3269](#L3269) | if ($name == false && isset($this->post['name'])) { |
| [3270](#L3270) | $name = $this->post['name']; |
| [3271](#L3271) | } |
| [3272](#L3272) |  |
| [3273](#L3273) | $ongoing = \_\_('Staging site creation is already ongoing, please wait and try again.', 'backup-backup'); |
| [3274](#L3274) | $empty = \_\_('You have to provide some staging site name before process.', 'backup-backup'); |
| [3275](#L3275) | $toolong = \_\_('Staging site name cannot be longer than 24 characters.', 'backup-backup'); |
| [3276](#L3276) | $invalid = \_\_('Provided name contains prohibited characters.', 'backup-backup'); |
| [3277](#L3277) | $blacklisted = \_\_('This name is not allowed to be used, please pick different one.', 'backup-backup'); |
| [3278](#L3278) | $exist = \_\_('Seems like directory or staging site with that name already exist, pick different one.', 'backup-backup'); |
| [3279](#L3279) | $dashes = \_\_('Name cannot start or end with dash or underscore.', 'backup-backup'); |
| [3280](#L3280) |  |
| [3281](#L3281) | if ($this->isStagingSiteCreationOngoing()) { |
| [3282](#L3282) | return ['status' => 'fail', 'message' => $ongoing]; |
| [3283](#L3283) | } |
| [3284](#L3284) |  |
| [3285](#L3285) | if (strlen($name) <= 0) { |
| [3286](#L3286) | return ['status' => 'fail', 'message' => $empty]; |
| [3287](#L3287) | } |
| [3288](#L3288) |  |
| [3289](#L3289) | if (!preg\_match('/^[a-zA-Z0-9-\_]+$/', $name)) { |
| [3290](#L3290) | return ['status' => 'fail', 'message' => $invalid]; |
| [3291](#L3291) | } |
| [3292](#L3292) |  |
| [3293](#L3293) | if (strlen($name) >= 24) { |
| [3294](#L3294) | return ['status' => 'fail', 'message' => $toolong]; |
| [3295](#L3295) | } |
| [3296](#L3296) |  |
| [3297](#L3297) | if (in\_array($name[0], ['\_', '-']) || in\_array($name[strlen($name) - 1], ['\_', '-'])) { |
| [3298](#L3298) | return ['status' => 'fail', 'message' => $dashes]; |
| [3299](#L3299) | } |
| [3300](#L3300) |  |
| [3301](#L3301) | $bannedNames = [ |
| [3302](#L3302) | 'wp-content', |
| [3303](#L3303) | 'wp-admin', |
| [3304](#L3304) | 'wp-includes', |
| [3305](#L3305) | 'content', |
| [3306](#L3306) | 'admin', |
| [3307](#L3307) | 'includes', |
| [3308](#L3308) | 'tmp', |
| [3309](#L3309) | '.well-known', |
| [3310](#L3310) | 'download', |
| [3311](#L3311) | 'downloads', |
| [3312](#L3312) | 'google', |
| [3313](#L3313) | 'temporary' |
| [3314](#L3314) | ]; |
| [3315](#L3315) |  |
| [3316](#L3316) | if (strpos($name, '.') !== false) { |
| [3317](#L3317) | return ['status' => 'fail', 'message' => $blacklisted]; |
| [3318](#L3318) | } |
| [3319](#L3319) |  |
| [3320](#L3320) | if (in\_array($name, $bannedNames)) { |
| [3321](#L3321) | return ['status' => 'fail', 'message' => $blacklisted]; |
| [3322](#L3322) | } |
| [3323](#L3323) |  |
| [3324](#L3324) | $path = trailingslashit(ABSPATH) . $name; |
| [3325](#L3325) | if (file\_exists($path) || is\_dir($path)) { |
| [3326](#L3326) | return ['status' => 'fail', 'message' => $exist]; |
| [3327](#L3327) | } |
| [3328](#L3328) |  |
| [3329](#L3329) | return ['status' => 'success']; |
| [3330](#L3330) |  |
| [3331](#L3331) | } |
| [3332](#L3332) |  |
| [3333](#L3333) | /\*\* |
| [3334](#L3334) | \* startLocalStagingCreation - Initials creation of staging site process |
| [3335](#L3335) | \* |
| [3336](#L3336) | \* @return {array} with status/fail/progress data |
| [3337](#L3337) | \*/ |
| [3338](#L3338) | public function startLocalStagingCreation() { |
| [3339](#L3339) |  |
| [3340](#L3340) | // Verification of state |
| [3341](#L3341) | $name = $this->post['name']; |
| [3342](#L3342) | $verification = $this->checkStagingLocalName($name); |
| [3343](#L3343) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3344](#L3344) |  |
| [3345](#L3345) | // Fail in case of wrong data or state |
| [3346](#L3346) | if (isset($verification['status']) && $verification['status'] != 'success') { |
| [3347](#L3347) | return $verification; |
| [3348](#L3348) | } |
| [3349](#L3349) |  |
| [3350](#L3350) | // Update lock file to prevent double processes |
| [3351](#L3351) | touch($staging\_lock); |
| [3352](#L3352) |  |
| [3353](#L3353) | // Include local staging site controller |
| [3354](#L3354) | require\_once BMI\_INCLUDES . '/staging/local.php'; |
| [3355](#L3355) | $staging = new StagingLocal($name, true); |
| [3356](#L3356) |  |
| [3357](#L3357) | // Append the return if staging process requires more batches |
| [3358](#L3358) | if ($staging->continue == true) return $staging->continuationData; |
| [3359](#L3359) |  |
| [3360](#L3360) | return [ 'status' => 'continue', 'data' => [ 'name' => $name ] ]; |
| [3361](#L3361) |  |
| [3362](#L3362) | } |
| [3363](#L3363) |  |
| [3364](#L3364) | /\*\* |
| [3365](#L3365) | \* stagingSitesGetList - Returns staging sites list |
| [3366](#L3366) | \* |
| [3367](#L3367) | \* @return {array} with staging sites data |
| [3368](#L3368) | \*/ |
| [3369](#L3369) | public function stagingSitesGetList() { |
| [3370](#L3370) |  |
| [3371](#L3371) | // Include local staging site controller |
| [3372](#L3372) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3373](#L3373) | $staging = new Staging('..ajax..'); |
| [3374](#L3374) | $sites = $staging->getStagingSites(); |
| [3375](#L3375) |  |
| [3376](#L3376) | return [ 'status' => 'success', 'sites' => $sites ]; |
| [3377](#L3377) |  |
| [3378](#L3378) | } |
| [3379](#L3379) |  |
| [3380](#L3380) | /\*\* |
| [3381](#L3381) | \* stagingRename - Renames display name |
| [3382](#L3382) | \* |
| [3383](#L3383) | \* @return {array} status |
| [3384](#L3384) | \*/ |
| [3385](#L3385) | public function stagingRename() { |
| [3386](#L3386) |  |
| [3387](#L3387) | $name = $this->post['name']; |
| [3388](#L3388) | $newName = $this->post['new']; |
| [3389](#L3389) |  |
| [3390](#L3390) | // Include local staging site controller |
| [3391](#L3391) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3392](#L3392) | $staging = new Staging('..ajax..'); |
| [3393](#L3393) | return $staging->rename($name, $newName); |
| [3394](#L3394) |  |
| [3395](#L3395) | } |
| [3396](#L3396) |  |
| [3397](#L3397) | /\*\* |
| [3398](#L3398) | \* stagingPrepareLogin - Prepares login script |
| [3399](#L3399) | \* |
| [3400](#L3400) | \* @return {array} login credentials |
| [3401](#L3401) | \*/ |
| [3402](#L3402) | public function stagingPrepareLogin() { |
| [3403](#L3403) |  |
| [3404](#L3404) | $name = $this->post['name']; |
| [3405](#L3405) |  |
| [3406](#L3406) | // Include local staging site controller |
| [3407](#L3407) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3408](#L3408) | $staging = new Staging('..ajax..'); |
| [3409](#L3409) | return $staging->prepareLogin($name); |
| [3410](#L3410) |  |
| [3411](#L3411) | } |
| [3412](#L3412) |  |
| [3413](#L3413) | /\*\* |
| [3414](#L3414) | \* Handles ajax error on browser side, keep alive timeout etc. |
| [3415](#L3415) | \* |
| [3416](#L3416) | \* @return array static success |
| [3417](#L3417) | \*/ |
| [3418](#L3418) | public function frontEndAjaxError() { |
| [3419](#L3419) |  |
| [3420](#L3420) | if ($this->post['call'] == 'create-backup') { |
| [3421](#L3421) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [3422](#L3422) | $logger = new Progress('', 0, 0, false, false); |
| [3423](#L3423) | } else if (in\_array($this->post['call'], ['restore-backup', 'download-backup', 'continue\_restore\_process'])) { |
| [3424](#L3424) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [3425](#L3425) | $logger = new MigrationProgress(true); |
| [3426](#L3426) | } else if (in\_array($this->post['call'], ['staging-start-local-creation', 'staging-local-creation-process', 'staging-tastewp-creation-process'])) { |
| [3427](#L3427) | require\_once BMI\_INCLUDES . '/progress/staging.php'; |
| [3428](#L3428) | $logger = new StagingProgress(true); |
| [3429](#L3429) | } |
| [3430](#L3430) |  |
| [3431](#L3431) | if (isset($this->post['error'])) { |
| [3432](#L3432) |  |
| [3433](#L3433) | Logger::error('Front End Ajax Error START'); |
| [3434](#L3434) | if (isset($logger)) $logger->log('Front End Ajax Error START', 'verbose'); |
| [3435](#L3435) |  |
| [3436](#L3436) | if (is\_array($this->post['error'])) { |
| [3437](#L3437) |  |
| [3438](#L3438) | $errors = $this->post['error']; |
| [3439](#L3439) | foreach ($errors as $k => $val) { |
| [3440](#L3440) | $error = sanitize\_text\_field(print\_r($val, true)); |
| [3441](#L3441) | Logger::error($k . ' = ' . $error); |
| [3442](#L3442) | if (isset($logger)) $logger->log($k . ' = ' . $error, 'verbose'); |
| [3443](#L3443) | } |
| [3444](#L3444) |  |
| [3445](#L3445) | } else { |
| [3446](#L3446) |  |
| [3447](#L3447) | $theError = sanitize\_text\_field(print\_r($this->post->error, true)); |
| [3448](#L3448) | Logger::error('Front End Ajax Error: ' . $theError); |
| [3449](#L3449) | if (isset($logger)) $logger->log($theError, 'verbose'); |
| [3450](#L3450) |  |
| [3451](#L3451) | } |
| [3452](#L3452) |  |
| [3453](#L3453) | Logger::error('Front End Ajax Error END'); |
| [3454](#L3454) | if (isset($logger)) $logger->log('Front End Ajax Error END', 'verbose'); |
| [3455](#L3455) |  |
| [3456](#L3456) | } else { |
| [3457](#L3457) |  |
| [3458](#L3458) | Logger::error('Front End Ajax Error was called, but no error included.'); |
| [3459](#L3459) |  |
| [3460](#L3460) | } |
| [3461](#L3461) |  |
| [3462](#L3462) | if (isset($logger)) { |
| [3463](#L3463) | $logger->log(\_\_('Browser-side error detected, the process will try to restart with alternative methods, otherwise it will throw error window.', 'backup-backup'), 'error'); |
| [3464](#L3464) | $logger->log('Browser-side error detected, the process will try to restart with alternative methods, otherwise it will throw error window.', 'verbose'); |
| [3465](#L3465) | } |
| [3466](#L3466) |  |
| [3467](#L3467) | return [ 'status' => 'success' ]; |
| [3468](#L3468) |  |
| [3469](#L3469) | } |
| [3470](#L3470) |  |
| [3471](#L3471) | /\*\* |
| [3472](#L3472) | \* stagingDelete - Removes the staging site |
| [3473](#L3473) | \* |
| [3474](#L3474) | \* @return {array} status |
| [3475](#L3475) | \*/ |
| [3476](#L3476) | public function stagingDelete() { |
| [3477](#L3477) |  |
| [3478](#L3478) | $name = $this->post['name']; |
| [3479](#L3479) |  |
| [3480](#L3480) | // Include local staging site controller |
| [3481](#L3481) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3482](#L3482) | $staging = new Staging('..ajax..'); |
| [3483](#L3483) | return $staging->delete($name); |
| [3484](#L3484) |  |
| [3485](#L3485) | } |
| [3486](#L3486) |  |
| [3487](#L3487) | /\*\* |
| [3488](#L3488) | \* localStagingCreationProcess - Method that can continue batching of Staging process |
| [3489](#L3489) | \* |
| [3490](#L3490) | \* @return {array} data that should be send back to this function as POST |
| [3491](#L3491) | \*/ |
| [3492](#L3492) | public function localStagingCreationProcess() { |
| [3493](#L3493) |  |
| [3494](#L3494) | // Get $name and declare lock file |
| [3495](#L3495) | $name = $this->post['name']; |
| [3496](#L3496) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3497](#L3497) |  |
| [3498](#L3498) | // Update lock file to prevent double processes |
| [3499](#L3499) | touch($staging\_lock); |
| [3500](#L3500) |  |
| [3501](#L3501) | // Include local staging site controller |
| [3502](#L3502) | require\_once BMI\_INCLUDES . '/staging/local.php'; |
| [3503](#L3503) | $staging = new StagingLocal($name); |
| [3504](#L3504) |  |
| [3505](#L3505) | // Process handler |
| [3506](#L3506) | if (isset($this->post['delete'])) { |
| [3507](#L3507) | $staging->requestDelete(); |
| [3508](#L3508) | } else $staging->continue(); |
| [3509](#L3509) |  |
| [3510](#L3510) | // Append the return if staging process requires more batches |
| [3511](#L3511) | if ($staging->continue == true) return $staging->continuationData; |
| [3512](#L3512) |  |
| [3513](#L3513) | // Send success if nothing went wrong which finishes the process |
| [3514](#L3514) | if (file\_exists($staging\_lock)) @unlink($staging\_lock); |
| [3515](#L3515) | return ['status' => 'error']; |
| [3516](#L3516) |  |
| [3517](#L3517) | } |
| [3518](#L3518) |  |
| [3519](#L3519) | /\*\* |
| [3520](#L3520) | \* tastewpStagingCreation - Initializes and declares staging site will |
| [3521](#L3521) | \* |
| [3522](#L3522) | \* @return {array} batching status |
| [3523](#L3523) | \*/ |
| [3524](#L3524) | public function tastewpStagingCreation() { |
| [3525](#L3525) |  |
| [3526](#L3526) | // Get $name and declare lock file |
| [3527](#L3527) | $name = $this->post['name']; |
| [3528](#L3528) | $backupName = isset($this->post['backupName']) ? $this->post['backupName'] : false; |
| [3529](#L3529) | $initialize = isset($this->post['initialize']) ? $this->post['initialize'] : false; |
| [3530](#L3530) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3531](#L3531) |  |
| [3532](#L3532) | // Fix var type |
| [3533](#L3533) | if ($initialize === true || $initialize == 'true') $initialize = true; |
| [3534](#L3534) | else $initialize = false; |
| [3535](#L3535) |  |
| [3536](#L3536) | // Update lock file to prevent double processes |
| [3537](#L3537) | touch($staging\_lock); |
| [3538](#L3538) |  |
| [3539](#L3539) | // Include TasteWP staging site controller |
| [3540](#L3540) | require\_once BMI\_INCLUDES . '/staging/tastewp.php'; |
| [3541](#L3541) |  |
| [3542](#L3542) | // Process handler |
| [3543](#L3543) | if (isset($this->post['delete'])) { |
| [3544](#L3544) | $delete = true; |
| [3545](#L3545) | } else $delete = false; |
| [3546](#L3546) |  |
| [3547](#L3547) | // Make first handshake with TasteWP |
| [3548](#L3548) | $staging = new StagingTasteWP($name, $initialize, $backupName, $delete); |
| [3549](#L3549) |  |
| [3550](#L3550) | // Append the return if staging process requires more batches |
| [3551](#L3551) | if ($staging->continue == true) return $staging->continuationData; |
| [3552](#L3552) |  |
| [3553](#L3553) | // Send success if nothing went wrong which finishes the process |
| [3554](#L3554) | if (file\_exists($staging\_lock)) @unlink($staging\_lock); |
| [3555](#L3555) | return ['status' => 'error']; |
| [3556](#L3556) |  |
| [3557](#L3557) | } |
| [3558](#L3558) |  |
| [3559](#L3559) | public function debugging() { |
| [3560](#L3560) |  |
| [3561](#L3561) | } |
| [3562](#L3562) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/backup-backup/tags/1.3.9/includes/ajax.php?format=txt)
* [Original Format](/export/3222696/backup-backup/tags/1.3.9/includes/ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_fdf89d4b_20250115_090301.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbackup-backup%2Ftags%2F1.3.9%2Fincludes%2Fajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/backup-backup/tags/1.3.9/includes/ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/backup-backup/tags/1.3.9/includes/ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [backup-backup](/browser/backup-backup?order=name "View backup-backup")/[tags](/browser/backup-backup/tags?order=name "View tags")/[1.3.9](/browser/backup-backup/tags/1.3.9?order=name "View 1.3.9")/[includes](/browser/backup-backup/tags/1.3.9/includes?order=name "View includes")/[ajax.php](/browser/backup-backup/tags/1.3.9/includes/ajax.php?order=name "View ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3010013/backup-backup/tags/1.3.9/includes/ajax.php "View differences") on this file was [3010013](/changeset/3010013/ "View changeset 3010013"), checked in by iclyde, [13 months ago](/timeline?from=2023-12-14T12%3A49%3A30Z&precision=second "See timeline at 12/14/2023 12:49:30 PM") |
| --- |
| Version 1.3.9 |
| **File size:** 137.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | // Namespace |
| [4](#L4) | namespace BMI\Plugin; |
| [5](#L5) |  |
| [6](#L6) | // Exit on direct access |
| [7](#L7) | if (!defined('ABSPATH')) exit; |
| [8](#L8) |  |
| [9](#L9) | // Uses |
| [10](#L10) | use BMI\Plugin\Backup\_Migration\_Plugin as BMP; |
| [11](#L11) | use BMI\Plugin\BMI\_Logger as Logger; |
| [12](#L12) | use BMI\Plugin\Checker\BMI\_Checker as Checker; |
| [13](#L13) | use BMI\Plugin\Checker\System\_Info as SI; |
| [14](#L14) | use BMI\Plugin\CRON\BMI\_Crons as Crons; |
| [15](#L15) | use BMI\Plugin\Dashboard as Dashboard; |
| [16](#L16) | use BMI\Plugin\Extracter\BMI\_Extracter as Extracter; |
| [17](#L17) | use BMI\Plugin\Progress\BMI\_MigrationProgress as MigrationProgress; |
| [18](#L18) | use BMI\Plugin\Progress\BMI\_ZipProgress as Progress; |
| [19](#L19) | use BMI\Plugin\Progress\BMI\_StagingProgress as StagingProgress; |
| [20](#L20) | use BMI\Plugin\Scanner\BMI\_BackupsScanner as Backups; |
| [21](#L21) | use BMI\Plugin\Scanner\BMI\_FileScanner as Scanner; |
| [22](#L22) | use BMI\Plugin\Zipper\BMI\_Zipper as Zipper; |
| [23](#L23) | use BMI\Plugin\PHPCLI\Checker as PHPCLICheck; |
| [24](#L24) | use BMI\Plugin\External\BMI\_External\_Storage as ExternalStorage; |
| [25](#L25) | use BMI\Plugin\Staging\BMI\_Staging\_TasteWP as StagingTasteWP; |
| [26](#L26) | use BMI\Plugin\Staging\BMI\_StagingLocal as StagingLocal; |
| [27](#L27) | use BMI\Plugin\Staging\BMI\_Staging as Staging; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Ajax Handler for BMI |
| [31](#L31) | \*/ |
| [32](#L32) | class BMI\_Ajax { |
| [33](#L33) |  |
| [34](#L34) | public $post; |
| [35](#L35) | public $zip\_progress; |
| [36](#L36) | public $migration\_progress; |
| [37](#L37) | public $lock\_cli; |
| [38](#L38) | public $lastCurlCode; |
| [39](#L39) |  |
| [40](#L40) | public $total\_size\_for\_backup = 0; |
| [41](#L41) | public $total\_size\_for\_backup\_in\_mb = 0; |
| [42](#L42) | public $total\_excluded\_size\_for\_backup = 0; |
| [43](#L43) |  |
| [44](#L44) | public function \_\_construct($initializedWithCLI = false) { |
| [45](#L45) |  |
| [46](#L46) | // Return if it's not post |
| [47](#L47) | if (empty($\_POST)) { |
| [48](#L48) | return; |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | // Sanitize User Input |
| [52](#L52) | $this->post = BMP::sanitize($\_POST); |
| [53](#L53) |  |
| [54](#L54) | // Check nonce |
| [55](#L55) | if (check\_ajax\_referer('backup-migration-ajax', 'nonce', false) === false && $initializedWithCLI === false) { |
| [56](#L56) | return wp\_send\_json\_error(['reason' => 'not authorized request']); |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | // Log Handler Call (Verbose) |
| [60](#L60) | Logger::debug(\_\_("Running POST Function: ", 'backup-backup') . $this->post['f']); |
| [61](#L61) |  |
| [62](#L62) | // Create backup folder |
| [63](#L63) | if (!file\_exists(BMI\_BACKUPS)) { |
| [64](#L64) | mkdir(BMI\_BACKUPS, 0755, true); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | // Create background logs file |
| [68](#L68) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [69](#L69) | if (!file\_exists($backgroundLogsPath)) { |
| [70](#L70) | @touch($backgroundLogsPath); |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | // Handle User Request If Known And Sanitize Response |
| [74](#L74) | if ($this->post['f'] == 'scan-directory') { |
| [75](#L75) | BMP::res($this->dirSize()); |
| [76](#L76) | } elseif ($this->post['f'] == 'create-backup') { |
| [77](#L77) | BMP::res($this->prepareAndMakeBackup()); |
| [78](#L78) | } elseif ($this->post['f'] == 'reset-latest') { |
| [79](#L79) | BMP::res($this->resetLatestLogs()); |
| [80](#L80) | } elseif ($this->post['f'] == 'get-current-backups') { |
| [81](#L81) | BMP::res($this->getBackupsList()); |
| [82](#L82) | } elseif ($this->post['f'] == 'restore-backup') { |
| [83](#L83) | BMP::res($this->restoreBackup()); |
| [84](#L84) | } elseif ($this->post['f'] == 'is-running-backup') { |
| [85](#L85) | BMP::res($this->isRunningBackup()); |
| [86](#L86) | } elseif ($this->post['f'] == 'stop-backup') { |
| [87](#L87) | BMP::res($this->stopBackup()); |
| [88](#L88) | } elseif ($this->post['f'] == 'download-backup') { |
| [89](#L89) | BMP::res($this->handleQuickMigration()); |
| [90](#L90) | } elseif ($this->post['f'] == 'migration-locked') { |
| [91](#L91) | BMP::res($this->isMigrationLocked()); |
| [92](#L92) | } elseif ($this->post['f'] == 'upload-backup') { |
| [93](#L93) | BMP::res($this->handleChunkUpload()); |
| [94](#L94) | } elseif ($this->post['f'] == 'delete-backup') { |
| [95](#L95) | BMP::res($this->removeBackupFile()); |
| [96](#L96) | } elseif ($this->post['f'] == 'save-storage') { |
| [97](#L97) | BMP::res($this->saveStorageConfig()); |
| [98](#L98) | } elseif ($this->post['f'] == 'save-file-config') { |
| [99](#L99) | BMP::res($this->saveFilesConfig()); |
| [100](#L100) | } elseif ($this->post['f'] == 'save-other-options') { |
| [101](#L101) | BMP::res($this->saveOtherOptions()); |
| [102](#L102) | } elseif ($this->post['f'] == 'store-config') { |
| [103](#L103) | BMP::res($this->saveStorageTypeConfig()); |
| [104](#L104) | } elseif ($this->post['f'] == 'unlock-backup') { |
| [105](#L105) | BMP::res($this->toggleBackupLock(true)); |
| [106](#L106) | } elseif ($this->post['f'] == 'lock-backup') { |
| [107](#L107) | BMP::res($this->toggleBackupLock(false)); |
| [108](#L108) | } elseif ($this->post['f'] == 'get-dynamic-names') { |
| [109](#L109) | BMP::res($this->getDynamicNames()); |
| [110](#L110) | } elseif ($this->post['f'] == 'reset-configuration') { |
| [111](#L111) | BMP::res($this->resetConfiguration()); |
| [112](#L112) | } elseif ($this->post['f'] == 'get-site-data') { |
| [113](#L113) | BMP::res($this->getSiteData()); |
| [114](#L114) | } elseif ($this->post['f'] == 'send-test-mail') { |
| [115](#L115) | BMP::res($this->sendTestMail()); |
| [116](#L116) | } elseif ($this->post['f'] == 'calculate-cron') { |
| [117](#L117) | BMP::res($this->calculateCron()); |
| [118](#L118) | } elseif ($this->post['f'] == 'dismiss-error-notice') { |
| [119](#L119) | BMP::res($this->dismissErrorNotice()); |
| [120](#L120) | } elseif ($this->post['f'] == 'fix\_uname\_issues') { |
| [121](#L121) | BMP::res($this->fixUnameFunction()); |
| [122](#L122) | } elseif ($this->post['f'] == 'revert\_uname\_issues') { |
| [123](#L123) | BMP::res($this->revertUnameProcess()); |
| [124](#L124) | } elseif ($this->post['f'] == 'continue\_restore\_process') { |
| [125](#L125) | BMP::res($this->continueRestoreProcess()); |
| [126](#L126) | } elseif ($this->post['f'] == 'htaccess-litespeed') { |
| [127](#L127) | BMP::res($this->fixLitespeed()); |
| [128](#L128) | } elseif ($this->post['f'] == 'force-backup-to-stop') { |
| [129](#L129) | BMP::res($this->forceBackupToStop()); |
| [130](#L130) | } elseif ($this->post['f'] == 'force-restore-to-stop') { |
| [131](#L131) | BMP::res($this->forceRestoreToStop()); |
| [132](#L132) | } elseif ($this->post['f'] == 'staging-local-name') { |
| [133](#L133) | BMP::res($this->checkStagingLocalName()); |
| [134](#L134) | } elseif ($this->post['f'] == 'staging-start-local-creation') { |
| [135](#L135) | BMP::res($this->startLocalStagingCreation()); |
| [136](#L136) | } elseif ($this->post['f'] == 'staging-local-creation-process') { |
| [137](#L137) | BMP::res($this->localStagingCreationProcess()); |
| [138](#L138) | } elseif ($this->post['f'] == 'staging-tastewp-creation-process') { |
| [139](#L139) | BMP::res($this->tastewpStagingCreation()); |
| [140](#L140) | } elseif ($this->post['f'] == 'staging-rename-display') { |
| [141](#L141) | BMP::res($this->stagingRename()); |
| [142](#L142) | } elseif ($this->post['f'] == 'staging-prepare-login') { |
| [143](#L143) | BMP::res($this->stagingPrepareLogin()); |
| [144](#L144) | } elseif ($this->post['f'] == 'staging-delete-permanently') { |
| [145](#L145) | BMP::res($this->stagingDelete()); |
| [146](#L146) | } elseif ($this->post['f'] == 'staging-get-updated-list') { |
| [147](#L147) | BMP::res($this->stagingSitesGetList()); |
| [148](#L148) | } elseif ($this->post['f'] == 'send-troubleshooting-logs') { |
| [149](#L149) | BMP::res($this->sendTroubleshootingDetails()); |
| [150](#L150) | } elseif ($this->post['f'] == 'log-sharing-details') { |
| [151](#L151) | BMP::res($this->logSharing()); |
| [152](#L152) | } elseif ($this->post['f'] == 'get-latest-backup') { |
| [153](#L153) | BMP::res($this->getLatestBackupFile()); |
| [154](#L154) | } elseif ($this->post['f'] == 'front-end-ajax-error') { |
| [155](#L155) | BMP::res($this->frontEndAjaxError()); |
| [156](#L156) | } elseif ($this->post['f'] == 'debugging') { |
| [157](#L157) | BMP::res($this->debugging()); |
| [158](#L158) | } elseif (has\_action('bmi\_premium\_ajax')) { |
| [159](#L159) | do\_action('bmi\_premium\_ajax', $this->post); |
| [160](#L160) | } elseif ($this->post['f'] == 'check-not-uploaded-backups') { |
| [161](#L161) | BMP::res(['status' => 'false']); |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | public function siteURL() { |
| [167](#L167) | $protocol = (!empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] !== 'off' || $\_SERVER['SERVER\_PORT'] == 443) ? "https://" : "http://"; |
| [168](#L168) | $domainName = $\_SERVER['HTTP\_HOST']; |
| [169](#L169) |  |
| [170](#L170) | return $protocol . $domainName; |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | public function checkIfPHPCliExist(&$logger) { |
| [174](#L174) |  |
| [175](#L175) | if (defined('BMI\_CLI\_ENABLED')) { |
| [176](#L176) | if (BMI\_CLI\_ENABLED === false) { |
| [177](#L177) | $logger->log(\_\_('PHP CLI is disabled manually, plugin will omit all PHP CLI steps.', 'backup-backup'), 'warn'); |
| [178](#L178) | return false; |
| [179](#L179) | } |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | $logger->log(\_\_('Looking for PHP CLI executable file.', 'backup-backup'), 'step'); |
| [183](#L183) | require\_once BMI\_INCLUDES . '/cli/php\_cli\_finder.php'; |
| [184](#L184) | $checker = new PHPCLICheck(); |
| [185](#L185) | $result = $checker->findPHP(); |
| [186](#L186) |  |
| [187](#L187) | if ($result === false) { |
| [188](#L188) |  |
| [189](#L189) | if (!defined('BMI\_CLI\_ENABLED')) define('BMI\_CLI\_ENABLED', false); |
| [190](#L190) | if (!defined('BMI\_CLI\_EXECUTABLE')) define('BMI\_CLI\_EXECUTABLE', false); |
| [191](#L191) | if ($checker->ini\_disabled === true) { |
| [192](#L192) | $logger->log(\_\_('PHP CLI is disabled in your php.ini file, the process may be unstable.', 'backup-backup'), 'warn'); |
| [193](#L193) | } else { |
| [194](#L194) | $logger->log(\_\_('Could not find proper PHP CLI executable, this process may be unstable.', 'backup-backup'), 'warn'); |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | return false; |
| [198](#L198) |  |
| [199](#L199) | } else { |
| [200](#L200) |  |
| [201](#L201) | if (!defined('BMI\_CLI\_ENABLED')) define('BMI\_CLI\_ENABLED', true); |
| [202](#L202) | if (!defined('BMI\_CLI\_EXECUTABLE')) define('BMI\_CLI\_EXECUTABLE', $result['executable']); |
| [203](#L203) |  |
| [204](#L204) | $logger->log(\_\_('PHP CLI Filename: ', 'backup-backup') . basename($result['executable']), 'info'); |
| [205](#L205) | $logger->log(\_\_('PHP CLI Version: ', 'backup-backup') . $result['version'] . ' ' . $result['brand'], 'info'); |
| [206](#L206) | $logger->log(\_\_('PHP CLI Memory limit: ', 'backup-backup') . $result['memory'], 'info'); |
| [207](#L207) | $logger->log(\_\_('PHP CLI Execution limit: ', 'backup-backup') . $result['max\_exec'], 'info'); |
| [208](#L208) | $logger->log(\_\_('We properly detected PHP CLI executable file.', 'backup-backup'), 'success'); |
| [209](#L209) |  |
| [210](#L210) | return $result; |
| [211](#L211) |  |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | public function getDatabaseSize() { |
| [217](#L217) |  |
| [218](#L218) | global $wpdb; |
| [219](#L219) | $prefix = $wpdb->prefix; |
| [220](#L220) |  |
| [221](#L221) | $sql = "SELECT SUM(DATA\_LENGTH + INDEX\_LENGTH) AS `bytes` FROM information\_schema.TABLES WHERE TABLE\_SCHEMA = %s;"; |
| [222](#L222) | $sql = $wpdb->prepare($sql, array(DB\_NAME)); |
| [223](#L223) |  |
| [224](#L224) | $result = $wpdb->get\_results($sql); |
| [225](#L225) | return intval($result[0]->bytes); |
| [226](#L226) |  |
| [227](#L227) | } |
| [228](#L228) |  |
| [229](#L229) | public function dirSize() { |
| [230](#L230) |  |
| [231](#L231) | // Folder |
| [232](#L232) | $f = $this->post['folder']; |
| [233](#L233) |  |
| [234](#L234) | // Bytes |
| [235](#L235) | $bytes = 0; |
| [236](#L236) | $excludedBytes = 0; |
| [237](#L237) |  |
| [238](#L238) | $emptyVar = [ 'this\_is\_empty\_array' ]; |
| [239](#L239) | $allowed = [ 'plugins', 'uploads', 'themes', 'contents\_others', 'wordpress' ]; |
| [240](#L240) |  |
| [241](#L241) | if (in\_array($f, $allowed)) { |
| [242](#L242) |  |
| [243](#L243) | // Get list of staging sites for exclusion rules |
| [244](#L244) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [245](#L245) | $staging = new Staging('..ajax..'); |
| [246](#L246) | $stagingSites = $staging->getStagingSites(true); |
| [247](#L247) |  |
| [248](#L248) | $files = $this->scanFilesForBackup($emptyVar, $stagingSites, $f); |
| [249](#L249) | $files = $this->parseFilesForBackup($files, $emptyVar, false, true); |
| [250](#L250) |  |
| [251](#L251) | $bytes = $this->total\_size\_for\_backup; |
| [252](#L252) | $excludedBytes = $this->total\_excluded\_size\_for\_backup; |
| [253](#L253) |  |
| [254](#L254) | } elseif ($f == 'database') { |
| [255](#L255) |  |
| [256](#L256) | $bytes = $this->getDatabaseSize(); |
| [257](#L257) |  |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | return [ 'bytes' => $bytes, 'excluded' => $excludedBytes, 'readable' => BMP::humanSize($bytes) ]; |
| [261](#L261) |  |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | public function backupErrorHandler() { |
| [265](#L265) | set\_error\_handler(function ($errno, $errstr, $errfile, $errline) { |
| [266](#L266) |  |
| [267](#L267) | if (BMI\_DEBUG) { |
| [268](#L268) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (ERROR HANDLER #1):'); |
| [269](#L269) | error\_log(print\_r($errno, true)); |
| [270](#L270) | error\_log(print\_r($errstr, true)); |
| [271](#L271) | error\_log(print\_r($errfile, true)); |
| [272](#L272) | error\_log(print\_r($errline, true)); |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) | if (strpos($errstr, 'deprecated') !== false) return; |
| [276](#L276) | if (strpos($errstr, 'php\_uname') !== false) return; |
| [277](#L277) | if ((strpos($errstr, 'backup-migration') !== false) && (strpos($errstr, 'backup-backup') !== false)) return; |
| [278](#L278) |  |
| [279](#L279) | if ($errno != E\_ERROR && $errno != E\_CORE\_ERROR && $errno != E\_COMPILE\_ERROR && $errno != E\_USER\_ERROR && $errno != E\_RECOVERABLE\_ERROR) { |
| [280](#L280) |  |
| [281](#L281) | if (strpos($errfile, 'backup-backup') === false && strpos($errfile, 'backup-migration') === false) return; |
| [282](#L282) | Logger::error(\_\_('There was an error before request shutdown (but it was not logged to restore log)', 'backup-backup')); |
| [283](#L283) | Logger::error(\_\_('Error message: ', 'backup-backup') . $errstr); |
| [284](#L284) | Logger::error(\_\_('Error file/line: ', 'backup-backup') . $errfile . '|' . $errline); |
| [285](#L285) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#01' . '|' . $errno); |
| [286](#L286) | return; |
| [287](#L287) |  |
| [288](#L288) | } |
| [289](#L289) | if (strpos($errfile, 'backup-backup') === false) { |
| [290](#L290) | Logger::error(\_\_("Restore process was not aborted because this error is not related to Backup Migration.", 'backup-backup')); |
| [291](#L291) | $this->zip\_progress->log(\_\_("There was an error not related to Backup Migration Plugin.", 'backup-backup'), 'warn'); |
| [292](#L292) | $this->zip\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'warn'); |
| [293](#L293) | $this->zip\_progress->log(\_\_("Backup will not be aborted because of this.", 'backup-backup'), 'warn'); |
| [294](#L294) | return; |
| [295](#L295) | } |
| [296](#L296) | if (strpos($errstr, 'unlink(') !== false) { |
| [297](#L297) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [298](#L298) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#02' . '|' . $errno); |
| [299](#L299) | Logger::error($errstr); |
| [300](#L300) | return; |
| [301](#L301) | } |
| [302](#L302) | if (strpos($errfile, 'pclzip') !== false) { |
| [303](#L303) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [304](#L304) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#03' . '|' . $errno); |
| [305](#L305) | Logger::error($errstr); |
| [306](#L306) | return; |
| [307](#L307) | } |
| [308](#L308) | if (strpos($errstr, 'rename(') !== false) { |
| [309](#L309) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [310](#L310) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#04' . '|' . $errno); |
| [311](#L311) | Logger::error($errstr); |
| [312](#L312) | $this->zip\_progress->log(\_\_("Cannot move: ", 'backup-backup') . $errstr, 'warn'); |
| [313](#L313) | return; |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | $this->zip\_progress->log(\_\_("There was an error during backup:", 'backup-backup'), 'error'); |
| [317](#L317) | $this->zip\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'error'); |
| [318](#L318) | $this->zip\_progress->log(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline, 'error'); |
| [319](#L319) | $this->zip\_progress->log(\_\_('Unfortunately we had to remove the backup (if partly created).', 'backup-backup'), 'error'); |
| [320](#L320) |  |
| [321](#L321) | $backup = $GLOBALS['bmi\_current\_backup\_name']; |
| [322](#L322) | $backup\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $backup; |
| [323](#L323) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [324](#L324) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'); |
| [325](#L325) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.abort')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.abort'); |
| [326](#L326) |  |
| [327](#L327) | $this->zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [328](#L328) | $this->zip\_progress->log(\_\_("#002", 'backup-backup'), 'end-code'); |
| [329](#L329) | $this->zip\_progress->end(); |
| [330](#L330) |  |
| [331](#L331) | $GLOBALS['bmi\_error\_handled'] = true; |
| [332](#L332) | BMP::res(['status' => 'error', 'error' => $errstr]); |
| [333](#L333) | exit; |
| [334](#L334) |  |
| [335](#L335) | }, E\_ALL); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | public function migrationErrorHandler() { |
| [339](#L339) | set\_exception\_handler(function ($exception) { |
| [340](#L340) | if (BMI\_DEBUG) { |
| [341](#L341) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (EXCEPTION HANDLER #1):'); |
| [342](#L342) | error\_log(print\_r($exception, true)); |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | $this->migration\_progress->log(\_\_("Restore exception: ", 'backup-backup') . $exception->getMessage(), 'warn'); |
| [346](#L346) | Logger::log(\_\_("Restore exception: ", 'backup-backup') . $exception->getMessage()); |
| [347](#L347) | }); |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | public function migrationExceptionHandler() { |
| [351](#L351) | set\_error\_handler(function ($errno, $errstr, $errfile, $errline) { |
| [352](#L352) |  |
| [353](#L353) | if (BMI\_DEBUG) { |
| [354](#L354) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (ERROR HANDLER #2):'); |
| [355](#L355) | error\_log(print\_r($errno, true)); |
| [356](#L356) | error\_log(print\_r($errstr, true)); |
| [357](#L357) | error\_log(print\_r($errfile, true)); |
| [358](#L358) | error\_log(print\_r($errline, true)); |
| [359](#L359) | } |
| [360](#L360) |  |
| [361](#L361) | if (strpos($errstr, 'deprecated') !== false) return; |
| [362](#L362) | if (strpos($errstr, 'php\_uname') !== false) return; |
| [363](#L363) | if ($errno == E\_NOTICE) return; |
| [364](#L364) | if ($errno != E\_ERROR && $errno != E\_CORE\_ERROR && $errno != E\_COMPILE\_ERROR && $errno != E\_USER\_ERROR && $errno != E\_RECOVERABLE\_ERROR) { |
| [365](#L365) | if (strpos($errfile, 'backup-backup') === false && strpos($errfile, 'backup-migration') === false) return; |
| [366](#L366) | Logger::error(\_\_('There was an error before request shutdown (but it was not logged to restore log)', 'backup-backup')); |
| [367](#L367) | Logger::error(\_\_('Error message: ', 'backup-backup') . $errstr); |
| [368](#L368) | Logger::error(\_\_('Error file/line: ', 'backup-backup') . $errfile . '|' . $errline); |
| [369](#L369) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#05' . '|' . $errno); |
| [370](#L370) | return; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | Logger::error(\_\_("There was an error/warning during restore process:", 'backup-backup')); |
| [374](#L374) | Logger::error(\_\_("Message: ", 'backup-backup') . $errstr); |
| [375](#L375) | Logger::error(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline); |
| [376](#L376) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#06' . '|' . $errno); |
| [377](#L377) |  |
| [378](#L378) | if (strpos($errfile, 'backup-backup') === false) { |
| [379](#L379) | Logger::error(\_\_("Restore process was not aborted because this error is not related to Backup Migration.", 'backup-backup')); |
| [380](#L380) | $this->migration\_progress->log(\_\_("There was an error not related to Backup Migration Plugin.", 'backup-backup'), 'warn'); |
| [381](#L381) | $this->migration\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'warn'); |
| [382](#L382) | $this->migration\_progress->log(\_\_("Backup will not be aborted because of this.", 'backup-backup'), 'warn'); |
| [383](#L383) | return; |
| [384](#L384) | } |
| [385](#L385) | if (strpos($errstr, 'unlink(') !== false) { |
| [386](#L386) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [387](#L387) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#07' . '|' . $errno); |
| [388](#L388) | Logger::error($errstr); |
| [389](#L389) | return; |
| [390](#L390) | } |
| [391](#L391) | if (strpos($errfile, 'pclzip') !== false) { |
| [392](#L392) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [393](#L393) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#08' . '|' . $errno); |
| [394](#L394) | Logger::error($errstr); |
| [395](#L395) | return; |
| [396](#L396) | } |
| [397](#L397) | if (strpos($errstr, 'rename(') !== false) { |
| [398](#L398) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [399](#L399) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#09' . '|' . $errno); |
| [400](#L400) | Logger::error($errstr); |
| [401](#L401) | $this->migration\_progress->log(\_\_("Cannot move: ", 'backup-backup') . $errstr, 'warn'); |
| [402](#L402) | return; |
| [403](#L403) | } |
| [404](#L404) |  |
| [405](#L405) | $this->migration\_progress->log(\_\_("There was an error during restore process:", 'backup-backup'), 'error'); |
| [406](#L406) | $this->migration\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'error'); |
| [407](#L407) | $this->migration\_progress->log(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline, 'error'); |
| [408](#L408) |  |
| [409](#L409) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock'); |
| [410](#L410) |  |
| [411](#L411) | $this->migration\_progress->log(\_\_("Aborting restore process...", 'backup-backup'), 'step'); |
| [412](#L412) |  |
| [413](#L413) | if (isset($GLOBALS['bmi\_current\_tmp\_restore']) && !empty($GLOBALS['bmi\_current\_tmp\_restore'])) { |
| [414](#L414) |  |
| [415](#L415) | $this->migration\_progress->log(\_\_("Cleaning up exported files...", 'backup-backup'), 'step'); |
| [416](#L416) |  |
| [417](#L417) | $tmp\_unique = $GLOBALS['bmi\_current\_tmp\_restore\_unique']; |
| [418](#L418) | $dir = $GLOBALS['bmi\_current\_tmp\_restore']; |
| [419](#L419) | $it = new \RecursiveDirectoryIterator($dir, \RecursiveDirectoryIterator::SKIP\_DOTS); |
| [420](#L420) | $files = new \RecursiveIteratorIterator($it, \RecursiveIteratorIterator::CHILD\_FIRST); |
| [421](#L421) |  |
| [422](#L422) | $this->migration\_progress->log(\_\_('Removing ', 'backup-backup') . iterator\_count($files) . \_\_(' files', 'backup-backup'), 'INFO'); |
| [423](#L423) | foreach ($files as $file) { |
| [424](#L424) | if ($file->isDir()) { |
| [425](#L425) | @rmdir($file->getRealPath()); |
| [426](#L426) | } else { |
| [427](#L427) | @unlink($file->getRealPath()); |
| [428](#L428) | } |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | @rmdir($dir); |
| [432](#L432) |  |
| [433](#L433) | $config\_file = untrailingslashit(ABSPATH) . DIRECTORY\_SEPARATOR . 'wp-config.' . $tmp\_unique . '.php'; |
| [434](#L434) | if (file\_exists($config\_file)) @unlink($config\_file); |
| [435](#L435) |  |
| [436](#L436) | } |
| [437](#L437) |  |
| [438](#L438) | $this->migration\_progress->log(\_\_("#002", 'backup-backup'), 'end-code'); |
| [439](#L439) | $this->migration\_progress->end(); |
| [440](#L440) |  |
| [441](#L441) | $GLOBALS['bmi\_error\_handled'] = true; |
| [442](#L442) | BMP::res(['status' => 'error', 'error' => $errstr]); |
| [443](#L443) | exit; |
| [444](#L444) |  |
| [445](#L445) | }, E\_ALL); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | public function backupExceptionHandler() { |
| [449](#L449) | set\_exception\_handler(function ($exception) { |
| [450](#L450) | if (BMI\_DEBUG) { |
| [451](#L451) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (EXCEPTION HANDLER #2):'); |
| [452](#L452) | error\_log(print\_r($exception, true)); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | $this->zip\_progress->log(\_\_("Exception: ", 'backup-backup') . $exception->getMessage(), 'warn'); |
| [456](#L456) | Logger::log(\_\_("Exception: ", 'backup-backup') . $exception->getMessage()); |
| [457](#L457) | }); |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | public function resetLatestLogs() { |
| [461](#L461) |  |
| [462](#L462) | // Restore htaccess |
| [463](#L463) | BMP::revertLitespeed(); |
| [464](#L464) | BMP::fixLitespeed(); |
| [465](#L465) |  |
| [466](#L466) | // Check time if not bugged |
| [467](#L467) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) > 65) { |
| [468](#L468) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [469](#L469) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | // Check if backup is not in progress |
| [473](#L473) | if (file\_exists(BMI\_BACKUPS . '/.running')) { |
| [474](#L474) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | // Remove too large logs |
| [478](#L478) | $completeLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'complete\_logs.log'; |
| [479](#L479) | if (file\_exists($completeLogsPath) && (filesize($completeLogsPath) / 1024 / 1024) >= 3) { |
| [480](#L480) | @unlink($completeLogsPath); |
| [481](#L481) | } |
| [482](#L482) |  |
| [483](#L483) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [484](#L484) | if (file\_exists($backgroundLogsPath) && (filesize($backgroundLogsPath) / 1024 / 1024) >= 3) { |
| [485](#L485) | @unlink($backgroundLogsPath); |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | @touch($completeLogsPath); |
| [489](#L489) | @touch($backgroundLogsPath); |
| [490](#L490) |  |
| [491](#L491) | // Require logs |
| [492](#L492) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [493](#L493) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [494](#L494) | require\_once BMI\_INCLUDES . '/progress/staging.php'; |
| [495](#L495) |  |
| [496](#L496) | // Write initial |
| [497](#L497) | $zip\_progress = new Progress('', 0); |
| [498](#L498) | $zip\_progress->start(); |
| [499](#L499) | $zip\_progress->log(\_\_("Initializing backup...", 'backup-backup'), 'step'); |
| [500](#L500) | $zip\_progress->progress('0/100'); |
| [501](#L501) | $zip\_progress->end(); |
| [502](#L502) |  |
| [503](#L503) | // Write initial |
| [504](#L504) | $migration = new MigrationProgress(false); |
| [505](#L505) | $migration->start(); |
| [506](#L506) | $migration->log(\_\_('Initializing restore process', 'backup-backup'), 'STEP'); |
| [507](#L507) | $migration->progress('0'); |
| [508](#L508) | $migration->end(); |
| [509](#L509) |  |
| [510](#L510) | // Write initial |
| [511](#L511) | $staging = new StagingProgress(false); |
| [512](#L512) | $staging->start(); |
| [513](#L513) | $staging->log(\_\_('Preparing creation of staging site...', 'backup-backup'), 'STEP'); |
| [514](#L514) | $staging->progress('0'); |
| [515](#L515) | $staging->end(); |
| [516](#L516) |  |
| [517](#L517) | // Return done |
| [518](#L518) | return ['status' => 'success']; |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | public function makeBackupName() { |
| [522](#L522) | $name = Dashboard\bmi\_get\_config('BACKUP:NAME'); |
| [523](#L523) |  |
| [524](#L524) | $urlparts = parse\_url(home\_url()); |
| [525](#L525) | $domain = str\_replace('.', '-', sanitize\_text\_field($urlparts['host'])); |
| [526](#L526) |  |
| [527](#L527) | $hash = BMP::randomString(16); |
| [528](#L528) | $name = str\_replace('%domain', $domain, $name); |
| [529](#L529) | $name = str\_replace('%hash', $hash, $name); |
| [530](#L530) | $name = str\_replace('%Y', date('Y'), $name); |
| [531](#L531) | $name = str\_replace('%M', date('M'), $name); |
| [532](#L532) | $name = str\_replace('%D', date('D'), $name); |
| [533](#L533) | $name = str\_replace('%d', date('d'), $name); |
| [534](#L534) | $name = str\_replace('%j', date('j'), $name); |
| [535](#L535) | $name = str\_replace('%m', date('m'), $name); |
| [536](#L536) | $name = str\_replace('%n', date('n'), $name); |
| [537](#L537) | $name = str\_replace('%Y', date('Y'), $name); |
| [538](#L538) | $name = str\_replace('%y', date('y'), $name); |
| [539](#L539) | $name = str\_replace('%a', date('a'), $name); |
| [540](#L540) | $name = str\_replace('%A', date('A'), $name); |
| [541](#L541) | $name = str\_replace('%B', date('B'), $name); |
| [542](#L542) | $name = str\_replace('%g', date('g'), $name); |
| [543](#L543) | $name = str\_replace('%G', date('G'), $name); |
| [544](#L544) | $name = str\_replace('%h', date('h'), $name); |
| [545](#L545) | $name = str\_replace('%H', date('H'), $name); |
| [546](#L546) | $name = str\_replace('%i', date('i'), $name); |
| [547](#L547) | $name = str\_replace('%s', date('s'), $name); |
| [548](#L548) | $name = str\_replace('%s', date('s'), $name); |
| [549](#L549) |  |
| [550](#L550) | $i = 2; |
| [551](#L551) | $tmpname = $name; |
| [552](#L552) |  |
| [553](#L553) | while (file\_exists($tmpname . '.zip')) { |
| [554](#L554) | $tmpname = $name . '\_' . $i; |
| [555](#L555) | $i++; |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | $name = $tmpname . '.zip'; |
| [559](#L559) |  |
| [560](#L560) | $GLOBALS['bmi\_current\_backup\_name'] = $name; |
| [561](#L561) | return $name; |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | public function fixUnameFunction() { |
| [565](#L565) | $file = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip.php'; |
| [566](#L566) | $backup = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip-backup.php'; |
| [567](#L567) |  |
| [568](#L568) | // Make backup |
| [569](#L569) | if (!file\_exists($backup)) { |
| [570](#L570) | @copy($file, $backup); |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | // Replace deprecated php\_uname function which is mostly disabled and cause errors |
| [574](#L574) | $replace = file\_get\_contents($file); |
| [575](#L575) | $replace = str\_replace('php\_uname()', '(DIRECTORY\_SEPARATOR === "/" ? "linux" : "windows")', $replace); |
| [576](#L576) | file\_put\_contents($file, $replace); |
| [577](#L577) | return ['status' => 'success']; |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | public function revertUnameProcess() { |
| [581](#L581) | $file = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip.php'; |
| [582](#L582) | $backup = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip-backup.php'; |
| [583](#L583) | if (file\_exists($backup)) { |
| [584](#L584) | if (file\_exists($file)) @unlink($file); |
| [585](#L585) | @copy($backup, $file); |
| [586](#L586) | } |
| [587](#L587) | return ['status' => 'success']; |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | public function prepareAndMakeBackup($cron = false) { |
| [591](#L591) |  |
| [592](#L592) | global $wp\_version; |
| [593](#L593) |  |
| [594](#L594) | // Require File Scanner |
| [595](#L595) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [596](#L596) | require\_once BMI\_INCLUDES . '/check/checker.php'; |
| [597](#L597) |  |
| [598](#L598) | // CLI Handler |
| [599](#L599) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [600](#L600) |  |
| [601](#L601) | // Backup name |
| [602](#L602) | if (defined('BMI\_CLI\_ARGUMENT') && !empty(BMI\_CLI\_ARGUMENT)) { |
| [603](#L603) | $name = BMI\_CLI\_ARGUMENT; |
| [604](#L604) | } else { |
| [605](#L605) | $name = $this->makeBackupName(); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | // Progress & Logs |
| [609](#L609) | $cliRunning = (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) ? true : false; |
| [610](#L610) | $shouldResetLogs = !$cliRunning; |
| [611](#L611) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP\_VIA\_CLI')) { |
| [612](#L612) | $cron = true; |
| [613](#L613) | $shouldResetLogs = true; |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | $clearEndCodes = false; |
| [617](#L617) | if (isset($this->post['preserveLogs']) && ($this->post['preserveLogs'] == 'true' || $this->post['preserveLogs'] === true)) { |
| [618](#L618) | $shouldResetLogs = false; |
| [619](#L619) | $clearEndCodes = true; |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | $zip\_progress = new Progress($name, 100, 0, $cron, $shouldResetLogs, $clearEndCodes); |
| [623](#L623) | $zip\_progress->start(); |
| [624](#L624) |  |
| [625](#L625) | // PHP CLI Check |
| [626](#L626) | $isCLI = false; |
| [627](#L627) | $cli\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli'; |
| [628](#L628) | $cli\_lock\_end = BMI\_BACKUPS . '/.backup\_lock\_cli\_end'; |
| [629](#L629) | $cli\_failed\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli\_failed'; |
| [630](#L630) |  |
| [631](#L631) | if (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) { |
| [632](#L632) |  |
| [633](#L633) | $cli\_result = $this->checkIfPHPCliExist($zip\_progress); |
| [634](#L634) | if ($cli\_result !== false && BMI\_FUNCTION\_NORMAL === true) { |
| [635](#L635) |  |
| [636](#L636) | $res = null; |
| [637](#L637) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP')) { |
| [638](#L638) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_backup\_cron ' . $name . ' > /dev/null &', $res); |
| [639](#L639) | } else { |
| [640](#L640) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_backup ' . $name . ' > /dev/null &', $res); |
| [641](#L641) | } |
| [642](#L642) | $res = implode("\n", $res); |
| [643](#L643) |  |
| [644](#L644) | sleep(3); |
| [645](#L645) |  |
| [646](#L646) | if (file\_exists($cli\_lock\_end) && (time() - filemtime($cli\_lock\_end)) < 10) { |
| [647](#L647) |  |
| [648](#L648) | if (file\_exists($cli\_lock\_end)) @unlink($cli\_lock\_end); |
| [649](#L649) | return ['status' => 'success', 'filename' => $name]; |
| [650](#L650) | exit; |
| [651](#L651) |  |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | if (!file\_exists($cli\_lock) || (time() - filemtime($cli\_lock)) > 10) { |
| [655](#L655) |  |
| [656](#L656) | if (!file\_exists(BMI\_BACKUPS . '/.abort') || (time() - filemtime(BMI\_BACKUPS . '/.abort')) > 10) { |
| [657](#L657) |  |
| [658](#L658) | $zip\_progress->log(\_\_("Something went wrong in PHP CLI process, backup will be continued with legacy methods.", 'backup-backup'), 'warn'); |
| [659](#L659) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [660](#L660) | define('BMI\_CLI\_FAILED', true); |
| [661](#L661) | touch($cli\_failed\_lock); |
| [662](#L662) |  |
| [663](#L663) | } else { |
| [664](#L664) |  |
| [665](#L665) | $zip\_progress->log(\_\_("Backup will not be continued due to manual abort by user.", 'backup-backup'), 'warn'); |
| [666](#L666) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [667](#L667) | return ['status' => 'msg', 'why' => \_\_('Backup process aborted.', 'backup-backup'), 'level' => 'info']; |
| [668](#L668) |  |
| [669](#L669) | } |
| [670](#L670) |  |
| [671](#L671) | } else { |
| [672](#L672) |  |
| [673](#L673) | return ['status' => 'background', 'filename' => $name]; |
| [674](#L674) |  |
| [675](#L675) | } |
| [676](#L676) |  |
| [677](#L677) | } else { |
| [678](#L678) |  |
| [679](#L679) | if (BMI\_FUNCTION\_NORMAL !== true) { |
| [680](#L680) | $zip\_progress->log(\_\_("PHP CLI will not run due to user settings in plugin other options.", 'backup-backup'), 'warn'); |
| [681](#L681) | } else { |
| [682](#L682) | $zip\_progress->log(\_\_("PHP CLI file cannot be executed due to unknown reason.", 'backup-backup'), 'warn'); |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | } else { |
| [688](#L688) |  |
| [689](#L689) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [690](#L690) |  |
| [691](#L691) | if (!file\_exists($cli\_failed\_lock) || (time() - filemtime($cli\_failed\_lock)) < 10) { |
| [692](#L692) | exit; |
| [693](#L693) | } |
| [694](#L694) |  |
| [695](#L695) | $isCLI = true; |
| [696](#L696) | $zip\_progress->log(\_\_("Backup via PHP CLI initialized successfully.", 'backup-backup'), 'success'); |
| [697](#L697) | touch($cli\_lock); |
| [698](#L698) |  |
| [699](#L699) | } |
| [700](#L700) |  |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | // Just in case (e.g. syntax error, we can close the file correctly) |
| [704](#L704) | $GLOBALS['bmi\_backup\_progress'] = $zip\_progress; |
| [705](#L705) |  |
| [706](#L706) | // Logs |
| [707](#L707) | $zip\_progress->log(\_\_("Initializing backup...", 'backup-backup'), 'step'); |
| [708](#L708) | $zip\_progress->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION), 'info'); |
| [709](#L709) | $zip\_progress->log(\_\_("Site which will be backed up: ", 'backup-backup') . site\_url(), 'info'); |
| [710](#L710) | $zip\_progress->log(\_\_("PHP Version: ", 'backup-backup') . PHP\_VERSION, 'info'); |
| [711](#L711) | $zip\_progress->log(\_\_("WP Version: ", 'backup-backup') . $wp\_version, 'info'); |
| [712](#L712) | $zip\_progress->log(\_\_("MySQL Version: ", 'backup-backup') . $GLOBALS['wpdb']->db\_version(), 'info'); |
| [713](#L713) | $zip\_progress->log(\_\_("MySQL Max Length: ", 'backup-backup') . $GLOBALS['wpdb']->get\_results("SHOW VARIABLES LIKE 'max\_allowed\_packet';")[0]->Value, 'info'); |
| [714](#L714) | if (isset($\_SERVER['SERVER\_SOFTWARE']) && !empty($\_SERVER['SERVER\_SOFTWARE'])) { |
| [715](#L715) | $zip\_progress->log(\_\_("Web server: ", 'backup-backup') . $\_SERVER['SERVER\_SOFTWARE'], 'info'); |
| [716](#L716) | } else { |
| [717](#L717) | $zip\_progress->log(\_\_("Web server: Not available", 'backup-backup'), 'info'); |
| [718](#L718) | } |
| [719](#L719) | $zip\_progress->log(\_\_("Max execution time (in seconds): ", 'backup-backup') . @ini\_get('max\_execution\_time'), 'info'); |
| [720](#L720) |  |
| [721](#L721) | $zip\_progress->log(\_\_("Memory limit (server): ", 'backup-backup') . @ini\_get('memory\_limit'), 'info'); |
| [722](#L722) | if (defined('WP\_MEMORY\_LIMIT')) { |
| [723](#L723) | $zip\_progress->log(\_\_("Memory limit (wp-config): ", 'backup-backup') . WP\_MEMORY\_LIMIT, 'info'); |
| [724](#L724) | } |
| [725](#L725) | if (defined('WP\_MAX\_MEMORY\_LIMIT')) { |
| [726](#L726) | $zip\_progress->log(\_\_("Memory limit (wp-config admin): ", 'backup-backup') . WP\_MAX\_MEMORY\_LIMIT, 'info'); |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | if (defined('BMI\_DB\_MAX\_ROWS\_PER\_QUERY')) { |
| [730](#L730) | $zip\_progress->log(\_\_('Max rows per query (this site): ', 'backup-backup') . BMI\_DB\_MAX\_ROWS\_PER\_QUERY, 'info'); |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | $zip\_progress->log(\_\_("Checking if backup dir is writable...", 'backup-backup'), 'info'); |
| [734](#L734) |  |
| [735](#L735) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP')) { |
| [736](#L736) | $zip\_progress->log(\_\_("This process was initialized due to scheduled backup configuration...", 'backup-backup'), 'info'); |
| [737](#L737) | $zip\_progress->log(\_\_("Backup will be unlocked by default as it is not manual backup...", 'backup-backup'), 'info'); |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | if (defined('BMI\_BACKUP\_PRO')) { |
| [741](#L741) | if (BMI\_BACKUP\_PRO == 1) { |
| [742](#L742) | $zip\_progress->log(\_\_("Premium plugin is enabled and activated", 'backup-backup'), 'info'); |
| [743](#L743) | } else { |
| [744](#L744) | $zip\_progress->log(\_\_("Premium version is enabled but not active, using free plugin.", 'backup-backup'), 'warn'); |
| [745](#L745) | } |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | // Error handler |
| [749](#L749) | $zip\_progress->log(\_\_("Initializing custom error handler", 'backup-backup'), 'info'); |
| [750](#L750) | $this->zip\_progress = &$zip\_progress; |
| [751](#L751) | $this->backupErrorHandler(); |
| [752](#L752) | $this->backupExceptionHandler(); |
| [753](#L753) |  |
| [754](#L754) | // Checker |
| [755](#L755) | $checker = new Checker($zip\_progress); |
| [756](#L756) |  |
| [757](#L757) | if (!is\_writable(dirname(BMI\_BACKUPS))) { |
| [758](#L758) |  |
| [759](#L759) | // Abort backup |
| [760](#L760) | $zip\_progress->log(\_\_("Backup directory is not writable...", 'backup-backup'), 'error'); |
| [761](#L761) | $zip\_progress->log(\_\_("Path: ", 'backup-backup') . BMI\_BACKUPS, 'error'); |
| [762](#L762) |  |
| [763](#L763) | // Close backup |
| [764](#L764) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [765](#L765) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [766](#L766) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [767](#L767) |  |
| [768](#L768) | // Log and close log |
| [769](#L769) | $zip\_progress->log('#002', 'END-CODE'); |
| [770](#L770) | $zip\_progress->end(); |
| [771](#L771) |  |
| [772](#L772) | if ($isCLI === true) touch($cli\_lock\_end); |
| [773](#L773) | $this->actionsAfterProcess(); |
| [774](#L774) |  |
| [775](#L775) | // Return error |
| [776](#L776) | if ($cron == true) return ['status' => 'success']; |
| [777](#L777) | else return ['status' => 'error']; |
| [778](#L778) | } else { |
| [779](#L779) | $zip\_progress->log(\_\_("Yup it is writable...", 'backup-backup'), 'success'); |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | if (!file\_exists(BMI\_BACKUPS)) @mkdir(BMI\_BACKUPS, true); |
| [783](#L783) |  |
| [784](#L784) | // Get list of staging sites for exclusion rules |
| [785](#L785) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [786](#L786) | $staging = new Staging('..ajax..'); |
| [787](#L787) | $stagingSites = $staging->getStagingSites(true); |
| [788](#L788) |  |
| [789](#L789) | // Get file names (huge list mostly) |
| [790](#L790) | if ($fgwp = Dashboard\bmi\_get\_config('BACKUP:FILES') == 'true') { |
| [791](#L791) | $zip\_progress->log(\_\_("Scanning files...", 'backup-backup'), 'step'); |
| [792](#L792) | $files = $this->scanFilesForBackup($zip\_progress, $stagingSites); |
| [793](#L793) | $files = $this->parseFilesForBackup($files, $zip\_progress, $cron); |
| [794](#L794) | } else { |
| [795](#L795) | $zip\_progress->log(\_\_("Omitting files (due to settings)...", 'backup-backup'), 'warn'); |
| [796](#L796) | $files = []; |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | $zip\_progress->log(str\_replace('%s', $this->total\_excluded\_size\_for\_backup, \_\_("Total size of excluded files: %s bytes", 'backup-backup')), 'info'); |
| [800](#L800) | $zip\_progress->log("Total size of excluded files (bytes): " . $this->total\_excluded\_size\_for\_backup, 'verbose'); |
| [801](#L801) |  |
| [802](#L802) | // Check if there is enough space |
| [803](#L803) | $bytes = intval($this->total\_size\_for\_backup \* 1.4); |
| [804](#L804) | $zip\_progress->log(\_\_("Checking free space, reserving...", 'backup-backup'), 'step'); |
| [805](#L805) | if ($this->total\_size\_for\_backup\_in\_mb >= BMI\_REV \* 1000 && add\_option('bmip\_last', false) != '1') { |
| [806](#L806) |  |
| [807](#L807) | // Abort backup |
| [808](#L808) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [809](#L809) | $zip\_progress->log(str\_replace('%s', BMI\_REV, \_\_("Site weights more than %s GB.", 'backup-backup')), 'error'); |
| [810](#L810) | $zip\_progress->log(print\_r($this->post, true), 'verbose'); |
| [811](#L811) |  |
| [812](#L812) | // Close backup |
| [813](#L813) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [814](#L814) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [815](#L815) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [816](#L816) |  |
| [817](#L817) | // Log and close log |
| [818](#L818) | $zip\_progress->log('#100', 'END-CODE'); |
| [819](#L819) | $zip\_progress->end(); |
| [820](#L820) |  |
| [821](#L821) | if ($isCLI === true) touch($cli\_lock\_end); |
| [822](#L822) | $this->actionsAfterProcess(); |
| [823](#L823) |  |
| [824](#L824) | // Return error |
| [825](#L825) | return ['status' => 'error', 'bfs' => true]; |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | $isSpaceCheckDisabled = Dashboard\bmi\_get\_config('OTHER:BACKUP:SPACE:CHECKING'); |
| [829](#L829) |  |
| [830](#L830) | if ($isSpaceCheckDisabled) { |
| [831](#L831) |  |
| [832](#L832) | $zip\_progress->log(\_\_("Free space checking is disabled by user in settings...", 'backup-backup'), 'warn'); |
| [833](#L833) | $zip\_progress->log(\_\_("Backup will continue, trusting there is enough space...", 'backup-backup'), 'warn'); |
| [834](#L834) |  |
| [835](#L835) | } else { |
| [836](#L836) |  |
| [837](#L837) | if (!$checker->check\_free\_space($bytes)) { |
| [838](#L838) |  |
| [839](#L839) | // Abort backup |
| [840](#L840) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [841](#L841) | $zip\_progress->log(\_\_("There is no space for that backup, checked: ", 'backup-backup') . ($bytes) . \_\_(" bytes", 'backup-backup'), 'error'); |
| [842](#L842) |  |
| [843](#L843) | // Close backup |
| [844](#L844) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [845](#L845) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [846](#L846) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [847](#L847) |  |
| [848](#L848) | // Log and close log |
| [849](#L849) | $zip\_progress->log('#002', 'END-CODE'); |
| [850](#L850) | $zip\_progress->end(); |
| [851](#L851) |  |
| [852](#L852) | if ($isCLI === true) touch($cli\_lock\_end); |
| [853](#L853) | $this->actionsAfterProcess(); |
| [854](#L854) |  |
| [855](#L855) | // Return error |
| [856](#L856) | if ($cron == true) return ['status' => 'success']; |
| [857](#L857) | else return ['status' => 'error']; |
| [858](#L858) | } else { |
| [859](#L859) | $zip\_progress->log(\_\_("Confirmed, there is more than enough space, checked: ", 'backup-backup') . ($bytes) . \_\_(" bytes", 'backup-backup'), 'success'); |
| [860](#L860) | $zip\_progress->bytes = $this->total\_size\_for\_backup; |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | if (Dashboard\bmi\_get\_config('BACKUP:DATABASE') != 'true') { |
| [866](#L866) |  |
| [867](#L867) | // $zip\_progress->log(\_\_("Database won't be backed-up due to user settings, omitting...", 'backup-backup'), 'info'); |
| [868](#L868) | // Commented as message will be shown in database backup module |
| [869](#L869) |  |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | // Log and set files length |
| [873](#L873) | $zip\_progress->log(\_\_("Scanning done - found ", 'backup-backup') . sizeof($files) . \_\_(" files...", 'backup-backup'), 'info'); |
| [874](#L874) | $zip\_progress->files = sizeof($files); |
| [875](#L875) |  |
| [876](#L876) | // Make Backup |
| [877](#L877) | $zip\_progress->log(\_\_("Backup initialized...", 'backup-backup'), 'success'); |
| [878](#L878) | $zip\_progress->log(\_\_("Initializing archiving system...", 'backup-backup'), 'step'); |
| [879](#L879) |  |
| [880](#L880) | $bckpres = $this->createBackup($files, ABSPATH, $name, $zip\_progress, $cron, $isCLI); |
| [881](#L881) | if ($cron == true) return ['status' => 'success']; |
| [882](#L882) | else return $bckpres; |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | public function fixLitespeed() { |
| [886](#L886) | BMP::fixLitespeed(); |
| [887](#L887) |  |
| [888](#L888) | return ['status' => 'success']; |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | public function revertLitespeed() { |
| [892](#L892) | BMP::revertLitespeed(); |
| [893](#L893) |  |
| [894](#L894) | return ['status' => 'success']; |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | public function createBackup($files, $base, $name, &$zip\_progress, $cron = false, $isCLI = false) { |
| [898](#L898) |  |
| [899](#L899) | // Require File Zipper |
| [900](#L900) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [901](#L901) |  |
| [902](#L902) | // CLI locks |
| [903](#L903) | $cli\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli'; |
| [904](#L904) | $cli\_lock\_end = BMI\_BACKUPS . '/.backup\_lock\_cli\_end'; |
| [905](#L905) | $cli\_failed\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli\_failed'; |
| [906](#L906) |  |
| [907](#L907) | // Backup name |
| [908](#L908) | $backup\_path = BMI\_BACKUPS . '/' . $name; |
| [909](#L909) |  |
| [910](#L910) | // Check time if not bugged |
| [911](#L911) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) > 65) { |
| [912](#L912) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [913](#L913) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [914](#L914) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [915](#L915) | if ($isCLI === true && file\_exists($cli\_lock\_end)) @unlink($cli\_lock\_end); |
| [916](#L916) | } |
| [917](#L917) |  |
| [918](#L918) | if ($isCLI === true) { |
| [919](#L919) | if (!file\_exists($cli\_failed\_lock) || (time() - filemtime($cli\_failed\_lock)) < 10) { |
| [920](#L920) | exit; |
| [921](#L921) | } |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | // Mark as in progress |
| [925](#L925) | if (!file\_exists(BMI\_BACKUPS . '/.running')) { |
| [926](#L926) | touch(BMI\_BACKUPS . '/.running'); |
| [927](#L927) | if ($isCLI === true) touch($cli\_lock); |
| [928](#L928) | } else { |
| [929](#L929) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | // Initialized |
| [933](#L933) | $zip\_progress->log(\_\_("Archive system initialized...", 'backup-backup'), 'success'); |
| [934](#L934) |  |
| [935](#L935) | // Make ZIP |
| [936](#L936) | $zipper = new Zipper(); |
| [937](#L937) | $zippy = $zipper->makeZIP($files, $backup\_path, $name, $zip\_progress, $cron); |
| [938](#L938) | if (!$zippy) { |
| [939](#L939) |  |
| [940](#L940) | // Make sure it's open |
| [941](#L941) | $zip\_progress->start(); |
| [942](#L942) |  |
| [943](#L943) | // Abort backup |
| [944](#L944) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [945](#L945) |  |
| [946](#L946) | // Close backup |
| [947](#L947) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [948](#L948) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [949](#L949) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [950](#L950) |  |
| [951](#L951) | // Log and close log |
| [952](#L952) | $zip\_progress->log('#002', 'END-CODE'); |
| [953](#L953) | $zip\_progress->end(); |
| [954](#L954) |  |
| [955](#L955) | if ($isCLI === true) touch($cli\_lock\_end); |
| [956](#L956) |  |
| [957](#L957) | // Return error |
| [958](#L958) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [959](#L959) |  |
| [960](#L960) | $this->actionsAfterProcess(); |
| [961](#L961) | return ['status' => 'error']; |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | // Backup aborted |
| [965](#L965) | if (file\_exists(BMI\_BACKUPS . '/.abort')) { |
| [966](#L966) |  |
| [967](#L967) | // Make sure it's open |
| [968](#L968) | $zip\_progress->start(); |
| [969](#L969) |  |
| [970](#L970) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [971](#L971) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [972](#L972) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [973](#L973) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [974](#L974) |  |
| [975](#L975) | // Log and close log |
| [976](#L976) | $zip\_progress->log(\_\_("Backup process aborted.", 'backup-backup'), 'warn'); |
| [977](#L977) | $zip\_progress->log('#002', 'END-CODE'); |
| [978](#L978) | $zip\_progress->end(); |
| [979](#L979) |  |
| [980](#L980) | if ($isCLI === true) touch($cli\_lock\_end); |
| [981](#L981) | Logger::log(\_\_("Backup process aborted.", 'backup-backup')); |
| [982](#L982) |  |
| [983](#L983) | $this->actionsAfterProcess(); |
| [984](#L984) | return ['status' => 'msg', 'why' => \_\_('Backup process aborted.', 'backup-backup'), 'level' => 'info']; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | if (!file\_exists($backup\_path) && !$cron) { |
| [988](#L988) |  |
| [989](#L989) | // Make sure it's open |
| [990](#L990) | $zip\_progress->start(); |
| [991](#L991) |  |
| [992](#L992) | // Abort backup |
| [993](#L993) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [994](#L994) | $zip\_progress->log(\_\_("There is no backup file...", 'backup-backup'), 'error'); |
| [995](#L995) | $zip\_progress->log(\_\_("We could not find backup file when it already should be here.", 'backup-backup'), 'error'); |
| [996](#L996) | $zip\_progress->log(\_\_("This error may be related to missing space. (filled during backup)", 'backup-backup'), 'error'); |
| [997](#L997) | $zip\_progress->log(\_\_("Path: ", 'backup-backup') . $backup\_path, 'error'); |
| [998](#L998) |  |
| [999](#L999) | // Close backup |
| [1000](#L1000) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [1001](#L1001) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [1002](#L1002) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1003](#L1003) |  |
| [1004](#L1004) | // Log and close log |
| [1005](#L1005) | $zip\_progress->log('#002', 'END-CODE'); |
| [1006](#L1006) | $zip\_progress->end(); |
| [1007](#L1007) |  |
| [1008](#L1008) | if ($isCLI === true) touch($cli\_lock\_end); |
| [1009](#L1009) | $this->actionsAfterProcess(); |
| [1010](#L1010) |  |
| [1011](#L1011) | // Return error |
| [1012](#L1012) | if ($cron == true) return ['status' => 'success']; |
| [1013](#L1013) | else return ['status' => 'error']; |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | // End zip log |
| [1017](#L1017) | $zip\_progress->log(\_\_("New backup created and its name is: ", 'backup-backup') . $name, 'success'); |
| [1018](#L1018) | $zip\_progress->log('#001', 'END-CODE'); |
| [1019](#L1019) | $zip\_progress->end(); |
| [1020](#L1020) |  |
| [1021](#L1021) | if ($isCLI === true) touch($cli\_lock\_end); |
| [1022](#L1022) |  |
| [1023](#L1023) | // Unlink progress |
| [1024](#L1024) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [1025](#L1025) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [1026](#L1026) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1027](#L1027) |  |
| [1028](#L1028) | // Return |
| [1029](#L1029) | Logger::log(\_\_("New backup created and its name is: ", 'backup-backup') . $name); |
| [1030](#L1030) |  |
| [1031](#L1031) | $GLOBALS['bmi\_error\_handled'] = true; |
| [1032](#L1032) |  |
| [1033](#L1033) | $this->actionsAfterProcess(true); |
| [1034](#L1034) | return ['status' => 'success', 'filename' => $name, 'root' => plugin\_dir\_url(BMI\_ROOT\_FILE)]; |
| [1035](#L1035) |  |
| [1036](#L1036) | } |
| [1037](#L1037) |  |
| [1038](#L1038) | public function continueRestoreProcess() { |
| [1039](#L1039) |  |
| [1040](#L1040) | // BMI\_RESTORE\_SECRET |
| [1041](#L1041) |  |
| [1042](#L1042) | } |
| [1043](#L1043) |  |
| [1044](#L1044) | public function getBackupsList() { |
| [1045](#L1045) |  |
| [1046](#L1046) | // Require File Scanner |
| [1047](#L1047) | require\_once BMI\_INCLUDES . '/scanner/backups.php'; |
| [1048](#L1048) |  |
| [1049](#L1049) | // Get backups |
| [1050](#L1050) | $backups = new Backups(); |
| [1051](#L1051) | $manifests = $backups->getAvailableBackups(); |
| [1052](#L1052) |  |
| [1053](#L1053) | // Return files |
| [1054](#L1054) | return ['status' => 'success', 'backups' => $manifests]; |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | public function sendTestMail() { |
| [1058](#L1058) |  |
| [1059](#L1059) | $email = Dashboard\bmi\_get\_config('OTHER:EMAIL') != false ? Dashboard\bmi\_get\_config('OTHER:EMAIL') : get\_bloginfo('admin\_email'); |
| [1060](#L1060) | $subject = \_\_('Backup Migration – Example email', 'backup-backup'); |
| [1061](#L1061) | $message = \_\_('This is a test email sent by the Backup Migration plugin via Troubleshooting options!', 'backup-backup'); |
| [1062](#L1062) |  |
| [1063](#L1063) | try { |
| [1064](#L1064) |  |
| [1065](#L1065) | if (wp\_mail($email, $subject, $message)) return [ 'status' => 'success' ]; |
| [1066](#L1066) | else return ['status' => 'error']; |
| [1067](#L1067) |  |
| [1068](#L1068) | } catch (\Exception $e) { |
| [1069](#L1069) |  |
| [1070](#L1070) | return ['status' => 'error']; |
| [1071](#L1071) |  |
| [1072](#L1072) | } catch (\Throwable $e) { |
| [1073](#L1073) |  |
| [1074](#L1074) | return ['status' => 'error']; |
| [1075](#L1075) |  |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | } |
| [1079](#L1079) |  |
| [1080](#L1080) | public function restoreBackup() { |
| [1081](#L1081) |  |
| [1082](#L1082) | global $wp\_version; |
| [1083](#L1083) |  |
| [1084](#L1084) | // Require File Scanner |
| [1085](#L1085) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [1086](#L1086) | require\_once BMI\_INCLUDES . '/extracter/extract.php'; |
| [1087](#L1087) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1088](#L1088) | require\_once BMI\_INCLUDES . '/check/checker.php'; |
| [1089](#L1089) |  |
| [1090](#L1090) | // Make AutoLogin possible |
| [1091](#L1091) | $ip = '127.0.0.1'; |
| [1092](#L1092) | if (isset($\_SERVER['HTTP\_CLIENT\_IP'])) { |
| [1093](#L1093) | $ip = $\_SERVER['HTTP\_CLIENT\_IP']; |
| [1094](#L1094) | } else { |
| [1095](#L1095) | if (isset($\_SERVER['HTTP\_X\_FORWARDED\_FOR'])) { |
| [1096](#L1096) | $ip = $\_SERVER['HTTP\_X\_FORWARDED\_FOR']; |
| [1097](#L1097) | } |
| [1098](#L1098) | if ($ip === false) { |
| [1099](#L1099) | if (isset($\_SERVER['REMOTE\_ADDR'])) $ip = $\_SERVER['REMOTE\_ADDR']; |
| [1100](#L1100) | } |
| [1101](#L1101) | } |
| [1102](#L1102) | $autoLoginMD = time() . '\_' . $ip . '\_' . '4u70L051n'; |
| [1103](#L1103) |  |
| [1104](#L1104) | // Progress & lock file |
| [1105](#L1105) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1106](#L1106) | $lock\_cli = BMI\_BACKUPS . '/.migration\_lock\_cli'; |
| [1107](#L1107) | $autologin\_file = BMI\_BACKUPS . '/.autologin'; |
| [1108](#L1108) | $lock\_cli\_end = BMI\_BACKUPS . '/.migration\_lock\_ended'; |
| [1109](#L1109) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1110](#L1110) | $cli\_last\_download = BMI\_BACKUPS . '/.cli\_download\_last'; |
| [1111](#L1111) |  |
| [1112](#L1112) | $ignoreRunCheck = ((isset($this->post['ignoreRunning']) && $this->post['ignoreRunning'] == 'true') ? true : false); |
| [1113](#L1113) | $isCLIRunning = (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) ? true : false; |
| [1114](#L1114) | if ($isCLIRunning) $ignoreRunCheck = false; |
| [1115](#L1115) |  |
| [1116](#L1116) | if (file\_exists($lock) && (time() - filemtime($lock)) < 65 && !$ignoreRunCheck) { |
| [1117](#L1117) | return ['status' => 'msg', 'why' => \_\_('The restore process is currently running, please wait till it end or once the lock file expire.', 'backup-backup'), 'level' => 'warning']; |
| [1118](#L1118) | } |
| [1119](#L1119) |  |
| [1120](#L1120) | // Check if download was via CLI |
| [1121](#L1121) | if ($this->post['file'] == '.cli\_download' && file\_exists($cli\_last\_download)) { |
| [1122](#L1122) | $this->post['file'] = file\_get\_contents($cli\_last\_download); |
| [1123](#L1123) | if (file\_exists($cli\_last\_download)) @unlink($cli\_last\_download); |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | // Logs |
| [1127](#L1127) | $migration = new MigrationProgress($this->post['remote']); |
| [1128](#L1128) | $migration->start(); |
| [1129](#L1129) |  |
| [1130](#L1130) | if ($ignoreRunCheck) { |
| [1131](#L1131) |  |
| [1132](#L1132) | $migration->mute(); |
| [1133](#L1133) |  |
| [1134](#L1134) | } |
| [1135](#L1135) |  |
| [1136](#L1136) | // Check PHP CLI |
| [1137](#L1137) | if ((!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) && (!defined('BMI\_CLI\_REQUEST') || BMI\_CLI\_REQUEST === false)) { |
| [1138](#L1138) |  |
| [1139](#L1139) | $cli\_result = $this->checkIfPHPCliExist($migration); |
| [1140](#L1140) |  |
| [1141](#L1141) | if ($cli\_result !== false) { |
| [1142](#L1142) |  |
| [1143](#L1143) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [1144](#L1144) | $backupName = sanitize\_text\_field($this->post['file']); |
| [1145](#L1145) | $remoteType = 'false'; |
| [1146](#L1146) | if ($this->post['remote'] == 'true' || $this->post['remote'] === true) $remoteType = 'true'; |
| [1147](#L1147) | if (file\_exists($lock\_cli\_end)) @unlink($lock\_cli\_end); |
| [1148](#L1148) |  |
| [1149](#L1149) | $res = null; |
| [1150](#L1150) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_restore ' . $backupName . ' ' . $remoteType . ' > /dev/null &', $res); |
| [1151](#L1151) | $res = implode("\n", $res); |
| [1152](#L1152) |  |
| [1153](#L1153) | sleep(3); |
| [1154](#L1154) |  |
| [1155](#L1155) | if (file\_exists($lock\_cli\_end) && (time() - filemtime($lock\_cli\_end)) < 10) { |
| [1156](#L1156) |  |
| [1157](#L1157) | // Put autologin |
| [1158](#L1158) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1159](#L1159) | touch($autologin\_file); |
| [1160](#L1160) |  |
| [1161](#L1161) | return ['status' => 'cli', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1162](#L1162) | exit; |
| [1163](#L1163) |  |
| [1164](#L1164) | } |
| [1165](#L1165) |  |
| [1166](#L1166) | if (!file\_exists($lock\_cli) || (time() - filemtime($lock\_cli)) > 10) { |
| [1167](#L1167) |  |
| [1168](#L1168) | $progressFile = null; |
| [1169](#L1169) | $migration->log(\_\_('No response from PHP CLI - plugin will try to recover the migration with traditional restore.', 'backup-backup'), 'warn'); |
| [1170](#L1170) | if (file\_exists($lock\_cli)) @unlink($lock\_cli); |
| [1171](#L1171) |  |
| [1172](#L1172) | } else { |
| [1173](#L1173) |  |
| [1174](#L1174) | $progressFile = null; |
| [1175](#L1175) |  |
| [1176](#L1176) | // $migration->log(\_\_('PHP CLI responded with correct code - we will continue via PHP CLI.', 'backup-backup'), 'info'); |
| [1177](#L1177) | // $migration->end(); |
| [1178](#L1178) |  |
| [1179](#L1179) | // Put autologin |
| [1180](#L1180) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1181](#L1181) | touch($autologin\_file); |
| [1182](#L1182) |  |
| [1183](#L1183) | return ['status' => 'cli', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1184](#L1184) | exit; |
| [1185](#L1185) |  |
| [1186](#L1186) | } |
| [1187](#L1187) |  |
| [1188](#L1188) | } else { |
| [1189](#L1189) |  |
| [1190](#L1190) | if (file\_exists($lock\_cli)) @unlink($lock\_cli); |
| [1191](#L1191) |  |
| [1192](#L1192) | } |
| [1193](#L1193) |  |
| [1194](#L1194) | } else { |
| [1195](#L1195) |  |
| [1196](#L1196) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [1197](#L1197) | $migration->log(\_\_('PHP CLI: Restore process initialized, restoring...', 'backup-backup'), 'success'); |
| [1198](#L1198) | touch($lock\_cli); |
| [1199](#L1199) | } else { |
| [1200](#L1200) | $migration->log(\_\_('Restore process initialized, restoring (non-cli mode)...', 'backup-backup'), 'success'); |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | } |
| [1204](#L1204) |  |
| [1205](#L1205) | // Just in case (e.g. syntax error, we can close the file correctly) |
| [1206](#L1206) | $GLOBALS['bmi\_migration\_progress'] = $migration; |
| [1207](#L1207) |  |
| [1208](#L1208) | // Checker |
| [1209](#L1209) | $checker = new Checker($migration); |
| [1210](#L1210) | $zipper = new Zipper(); |
| [1211](#L1211) |  |
| [1212](#L1212) | // Handle remote |
| [1213](#L1213) | if ($this->post['file']) { |
| [1214](#L1214) | $migration->log(\_\_('Restore process responded', 'backup-backup'), 'SUCCESS'); |
| [1215](#L1215) | } |
| [1216](#L1216) |  |
| [1217](#L1217) | // Make lock file |
| [1218](#L1218) | $migration->log(\_\_('Locking migration process', 'backup-backup'), 'SUCCESS'); |
| [1219](#L1219) | touch($lock); |
| [1220](#L1220) |  |
| [1221](#L1221) | // Initializing |
| [1222](#L1222) | $migration->log(\_\_('Initializing restore process', 'backup-backup'), 'STEP'); |
| [1223](#L1223) | $migration->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION), 'info'); |
| [1224](#L1224) |  |
| [1225](#L1225) | // Error handler |
| [1226](#L1226) | $migration->log(\_\_("Initializing custom error handler", 'backup-backup'), 'info'); |
| [1227](#L1227) |  |
| [1228](#L1228) | // Error handler |
| [1229](#L1229) | $this->migration\_progress = &$migration; |
| [1230](#L1230) | $this->migrationErrorHandler(); |
| [1231](#L1231) | $this->migrationExceptionHandler(); |
| [1232](#L1232) |  |
| [1233](#L1233) | $homeURL = site\_url(); |
| [1234](#L1234) | if (strlen($homeURL) <= 8) $homeURL = home\_url(); |
| [1235](#L1235) | if (defined('WP\_SITEURL') && strlen(WP\_SITEURL) > 8) $homeURL = WP\_SITEURL; |
| [1236](#L1236) |  |
| [1237](#L1237) | $migration->log(\_\_("Site which will be restored: ", 'backup-backup') . $homeURL, 'info'); |
| [1238](#L1238) | $migration->log(\_\_("PHP Version: ", 'backup-backup') . PHP\_VERSION, 'info'); |
| [1239](#L1239) | $migration->log(\_\_("WP Version: ", 'backup-backup') . $wp\_version, 'info'); |
| [1240](#L1240) | $migration->log(\_\_("MySQL Version: ", 'backup-backup') . $GLOBALS['wpdb']->db\_version(), 'info'); |
| [1241](#L1241) | $migration->log(\_\_("MySQL Max Length: ", 'backup-backup') . $GLOBALS['wpdb']->get\_results("SHOW VARIABLES LIKE 'max\_allowed\_packet';")[0]->Value, 'info'); |
| [1242](#L1242) | if (isset($\_SERVER['SERVER\_SOFTWARE']) && !defined('BMI\_USING\_CLI\_FUNCTIONALITY')) { |
| [1243](#L1243) | $migration->log(\_\_("Web server: ", 'backup-backup') . $\_SERVER['SERVER\_SOFTWARE'], 'info'); |
| [1244](#L1244) | } else { |
| [1245](#L1245) | $migration->log(\_\_("Web server: Not available", 'backup-backup'), 'info'); |
| [1246](#L1246) | } |
| [1247](#L1247) | $migration->log(\_\_("Max execution time (in seconds): ", 'backup-backup') . @ini\_get('max\_execution\_time'), 'info'); |
| [1248](#L1248) |  |
| [1249](#L1249) | $migration->log(\_\_("Memory limit (server): ", 'backup-backup') . @ini\_get('memory\_limit'), 'info'); |
| [1250](#L1250) | if (defined('WP\_MEMORY\_LIMIT')) { |
| [1251](#L1251) | $migration->log(\_\_("Memory limit (wp-config): ", 'backup-backup') . WP\_MEMORY\_LIMIT, 'info'); |
| [1252](#L1252) | } |
| [1253](#L1253) | if (defined('WP\_MAX\_MEMORY\_LIMIT')) { |
| [1254](#L1254) | $migration->log(\_\_("Memory limit (wp-config admin): ", 'backup-backup') . WP\_MAX\_MEMORY\_LIMIT, 'info'); |
| [1255](#L1255) | } |
| [1256](#L1256) |  |
| [1257](#L1257) | if (defined('BMI\_BACKUP\_PRO')) { |
| [1258](#L1258) | if (BMI\_BACKUP\_PRO == 1) { |
| [1259](#L1259) | $migration->log(\_\_("Premium plugin is enabled and activated", 'backup-backup'), 'info'); |
| [1260](#L1260) | } else { |
| [1261](#L1261) | $migration->log(\_\_("Premium version is enabled but not active, using free plugin.", 'backup-backup'), 'warn'); |
| [1262](#L1262) | } |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | $migration->log(\_\_("Restore process initialized successfully.", 'backup-backup'), 'success'); |
| [1266](#L1266) |  |
| [1267](#L1267) | // Check file size |
| [1268](#L1268) | $zippath = BMP::fixSlashes(BMI\_BACKUPS) . DIRECTORY\_SEPARATOR . $this->post['file']; |
| [1269](#L1269) | if (!$ignoreRunCheck) { |
| [1270](#L1270) |  |
| [1271](#L1271) | $manifest = $zipper->getZipFileContent($zippath, 'bmi\_backup\_manifest.json'); |
| [1272](#L1272) | $migration->log(\_\_('Free space checking...', 'backup-backup'), 'STEP'); |
| [1273](#L1273) | $migration->log(\_\_('Checking if there is enough amount of free space', 'backup-backup'), 'INFO'); |
| [1274](#L1274) | if ($manifest) { |
| [1275](#L1275) | if (isset($manifest->bytes) && $manifest->bytes) { |
| [1276](#L1276) | $bytes = intval($manifest->bytes \* 1.4); |
| [1277](#L1277) | if (!$checker->check\_free\_space($bytes)) { |
| [1278](#L1278) | $migration->log(\_\_('Cannot start migration process', 'backup-backup'), 'ERROR'); |
| [1279](#L1279) | $migration->log(\_\_('Error: There is not enough space on the server, checked: ' . ($bytes) . ' bytes.', 'backup-backup'), 'ERROR'); |
| [1280](#L1280) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1281](#L1281) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1282](#L1282) |  |
| [1283](#L1283) | if (file\_exists($lock)) @unlink($lock); |
| [1284](#L1284) | $migration->log('#004', 'END-CODE'); |
| [1285](#L1285) | $migration->end(); |
| [1286](#L1286) |  |
| [1287](#L1287) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1288](#L1288) | $this->actionsAfterProcess(false, 'migration'); |
| [1289](#L1289) |  |
| [1290](#L1290) | return ['status' => 'error']; |
| [1291](#L1291) | } else { |
| [1292](#L1292) | $migration->log(\_\_('Confirmed, there is enough space on the device, checked: ' . ($bytes) . ' bytes.', 'backup-backup'), 'SUCCESS'); |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) | } else { |
| [1296](#L1296) | $migration->log(\_\_('Cannot start migration process', 'backup-backup'), 'ERROR'); |
| [1297](#L1297) | $migration->log(\_\_('Error: File may not exist, check file name and if it still exist', 'backup-backup'), 'ERROR'); |
| [1298](#L1298) | $migration->log(\_\_('Error: Could not find manifest in backup, file may be broken', 'backup-backup'), 'ERROR'); |
| [1299](#L1299) | $migration->log(\_\_('Error: Btw. because of this I also cannot check free space', 'backup-backup'), 'ERROR'); |
| [1300](#L1300) | $migration->log(\_\_('Used path: ', 'backup-backup') . $zippath, 'ERROR'); |
| [1301](#L1301) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1302](#L1302) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1303](#L1303) |  |
| [1304](#L1304) | if (file\_exists($lock)) @unlink($lock); |
| [1305](#L1305) | $migration->log('#003', 'END-CODE'); |
| [1306](#L1306) | $migration->end(); |
| [1307](#L1307) |  |
| [1308](#L1308) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1309](#L1309) | $this->actionsAfterProcess(false, 'migration'); |
| [1310](#L1310) |  |
| [1311](#L1311) | return ['status' => 'error']; |
| [1312](#L1312) | } |
| [1313](#L1313) |  |
| [1314](#L1314) | } |
| [1315](#L1315) |  |
| [1316](#L1316) | if ($ignoreRunCheck) { |
| [1317](#L1317) |  |
| [1318](#L1318) | $migration->unmute(); |
| [1319](#L1319) |  |
| [1320](#L1320) | } |
| [1321](#L1321) |  |
| [1322](#L1322) | // New extracter |
| [1323](#L1323) | $theTmpName = ((isset($this->post['tmpname'])) ? $this->post['tmpname'] : false); |
| [1324](#L1324) | $options = ((isset($this->post['options'])) ? $this->post['options'] : []); |
| [1325](#L1325) | $extracter = new Extracter($this->post['file'], $migration, $theTmpName, $isCLIRunning, $options); |
| [1326](#L1326) |  |
| [1327](#L1327) | // Extract |
| [1328](#L1328) | $theSecret = ((isset($this->post['secret'])) ? $this->post['secret'] : null); |
| [1329](#L1329) | $isFine = $extracter->extractTo($theSecret); |
| [1330](#L1330) | if (!$isFine) { |
| [1331](#L1331) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1332](#L1332) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1333](#L1333) |  |
| [1334](#L1334) | if (file\_exists($lock)) @unlink($lock); |
| [1335](#L1335) | $migration->log('#002', 'END-CODE'); |
| [1336](#L1336) | $migration->end(); |
| [1337](#L1337) |  |
| [1338](#L1338) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1339](#L1339) | $this->actionsAfterProcess(false, 'migration'); |
| [1340](#L1340) |  |
| [1341](#L1341) | return ['status' => 'error']; |
| [1342](#L1342) | } |
| [1343](#L1343) |  |
| [1344](#L1344) | $migration->progress('100'); |
| [1345](#L1345) | $migration->log(\_\_('Restore process completed', 'backup-backup'), 'SUCCESS'); |
| [1346](#L1346) | $migration->log(\_\_('Finalizing restored files', 'backup-backup'), 'STEP'); |
| [1347](#L1347) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1348](#L1348) | if (file\_exists($lock)) @unlink($lock); |
| [1349](#L1349) |  |
| [1350](#L1350) | $migration->log('#001', 'END-CODE'); |
| [1351](#L1351) | $migration->end(); |
| [1352](#L1352) |  |
| [1353](#L1353) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1354](#L1354) |  |
| [1355](#L1355) | // Put autologin |
| [1356](#L1356) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1357](#L1357) | touch($autologin\_file); |
| [1358](#L1358) |  |
| [1359](#L1359) | $this->actionsAfterProcess(true, 'migration'); |
| [1360](#L1360) | return ['status' => 'success', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | public function isRunningBackup() { |
| [1364](#L1364) | $this->lock\_cli = BMI\_BACKUPS . '/.backup\_cli\_lock'; |
| [1365](#L1365) |  |
| [1366](#L1366) | // Ongoing processes |
| [1367](#L1367) | $ongoing = get\_option('bmip\_to\_be\_uploaded', [ |
| [1368](#L1368) | 'current\_upload' => [], |
| [1369](#L1369) | 'queue' => [], |
| [1370](#L1370) | 'failed' => [] |
| [1371](#L1371) | ]); |
| [1372](#L1372) |  |
| [1373](#L1373) | // Backup CLI running |
| [1374](#L1374) | if (file\_exists($this->lock\_cli) && (time() - filemtime($this->lock\_cli)) <= 3600) { |
| [1375](#L1375) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning', 'ongoing' => $ongoing]; |
| [1376](#L1376) | } |
| [1377](#L1377) |  |
| [1378](#L1378) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) <= 65) { |
| [1379](#L1379) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning', 'ongoing' => $ongoing]; |
| [1380](#L1380) | } else { |
| [1381](#L1381) | return ['status' => 'success', 'ongoing' => $ongoing]; |
| [1382](#L1382) | } |
| [1383](#L1383) | } |
| [1384](#L1384) |  |
| [1385](#L1385) | public function stopBackup() { |
| [1386](#L1386) | if (!file\_exists(BMI\_BACKUPS . '/.running')) { |
| [1387](#L1387) | return ['status' => 'msg', 'why' => \_\_('Backup process completed or is not running.', 'backup-backup'), 'level' => 'info']; |
| [1388](#L1388) | } else { |
| [1389](#L1389) | if (!file\_exists(BMI\_BACKUPS . '/.abort')) { |
| [1390](#L1390) | touch(BMI\_BACKUPS . '/.abort'); |
| [1391](#L1391) | } |
| [1392](#L1392) |  |
| [1393](#L1393) | return ['status' => 'success']; |
| [1394](#L1394) | } |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | public function isMigrationLocked() { |
| [1398](#L1398) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1399](#L1399) | $lock\_cli = BMI\_BACKUPS . '/.migration\_lock\_cli'; |
| [1400](#L1400) | $lock\_cli\_end = BMI\_BACKUPS . '/.migration\_lock\_ended'; |
| [1401](#L1401) |  |
| [1402](#L1402) | if ((file\_exists($lock) && (time() - filemtime($lock)) < 65) || (file\_exists($lock\_cli) && (time() - filemtime($lock\_cli)) < 7200)) { |
| [1403](#L1403) |  |
| [1404](#L1404) | return ['status' => 'msg', 'why' => \_\_('Restore process is currently running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [1405](#L1405) |  |
| [1406](#L1406) | } else { |
| [1407](#L1407) |  |
| [1408](#L1408) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1409](#L1409) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1410](#L1410) | $shouldClearLogs = true; |
| [1411](#L1411) |  |
| [1412](#L1412) | if (isset($this->post['clearLogs']) && $this->post['clearLogs'] == 'false') { |
| [1413](#L1413) | $shouldClearLogs = false; |
| [1414](#L1414) | } |
| [1415](#L1415) |  |
| [1416](#L1416) | if ($shouldClearLogs === true) { |
| [1417](#L1417) | if (file\_exists($lock\_cli\_end) && (time() - filemtime($lock\_cli\_end)) > 10) { |
| [1418](#L1418) |  |
| [1419](#L1419) | $migration = new MigrationProgress(); |
| [1420](#L1420) | $migration->start(); |
| [1421](#L1421) | $migration->log(\_\_('Initializing restore process...', 'backup-backup'), 'STEP'); |
| [1422](#L1422) | $migration->end(); |
| [1423](#L1423) |  |
| [1424](#L1424) | file\_put\_contents($progress, '0'); |
| [1425](#L1425) |  |
| [1426](#L1426) | } |
| [1427](#L1427) | } |
| [1428](#L1428) |  |
| [1429](#L1429) | return ['status' => 'success']; |
| [1430](#L1430) |  |
| [1431](#L1431) | } |
| [1432](#L1432) | } |
| [1433](#L1433) |  |
| [1434](#L1434) | public function downloadFile($url, $dest, $progress, $lock, &$logger) { |
| [1435](#L1435) | $current\_percentage = 0; |
| [1436](#L1436) | $previous\_logged = 0; |
| [1437](#L1437) | $fp = fopen($dest, 'w+'); |
| [1438](#L1438) |  |
| [1439](#L1439) | $progressfile = $progress; |
| [1440](#L1440) | $lockfile = $lock; |
| [1441](#L1441) |  |
| [1442](#L1442) | $ch = curl\_init(str\_replace(' ', '%20', $url)); |
| [1443](#L1443) | curl\_setopt($ch, CURLOPT\_TIMEOUT, 0); |
| [1444](#L1444) |  |
| [1445](#L1445) | curl\_setopt($ch, CURLOPT\_FILE, $fp); |
| [1446](#L1446) | curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, true); |
| [1447](#L1447) | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 0); |
| [1448](#L1448) | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, 0); |
| [1449](#L1449) |  |
| [1450](#L1450) | curl\_setopt($ch, CURLOPT\_NOPROGRESS, false); |
| [1451](#L1451) | curl\_setopt($ch, CURLOPT\_PROGRESSFUNCTION, function ($resource, $download\_size, $downloaded) use (&$current\_percentage, &$lockfile, &$progressfile, &$logger, &$previous\_logged) { |
| [1452](#L1452) | if ($download\_size > 0) { |
| [1453](#L1453) | $new\_percentage = intval(($downloaded / $download\_size) \* 100); |
| [1454](#L1454) |  |
| [1455](#L1455) | if (intval($current\_percentage) != intval($new\_percentage)) { |
| [1456](#L1456) | $logger->progress($new\_percentage); |
| [1457](#L1457) |  |
| [1458](#L1458) | if ($current\_percentage == 0 || ($new\_percentage % 5 == 0) || $new\_percentage > 99) { |
| [1459](#L1459) | $logger->log(sprintf(\_\_('Download progress: %s/%s MB (%s%%)', 'backup-backup'), round($downloaded / 1024 / 1024), round($download\_size / 1024 / 1024), $new\_percentage), 'INFO'); |
| [1460](#L1460) | $previous\_logged = $new\_percentage; |
| [1461](#L1461) | } |
| [1462](#L1462) |  |
| [1463](#L1463) | $current\_percentage = $new\_percentage; |
| [1464](#L1464) | } |
| [1465](#L1465) | } |
| [1466](#L1466) | }); |
| [1467](#L1467) |  |
| [1468](#L1468) | curl\_exec($ch); |
| [1469](#L1469) | $this->lastCurlCode = curl\_getinfo($ch, CURLINFO\_HTTP\_CODE); |
| [1470](#L1470) |  |
| [1471](#L1471) | $error\_msg = false; |
| [1472](#L1472) | if (curl\_errno($ch)) { |
| [1473](#L1473) | $error\_msg = curl\_error($ch); |
| [1474](#L1474) | } |
| [1475](#L1475) |  |
| [1476](#L1476) | curl\_close($ch); |
| [1477](#L1477) | fclose($fp); |
| [1478](#L1478) |  |
| [1479](#L1479) | if ($error\_msg) { |
| [1480](#L1480) | return $error\_msg; |
| [1481](#L1481) | } else { |
| [1482](#L1482) | return false; |
| [1483](#L1483) | } |
| [1484](#L1484) | } |
| [1485](#L1485) |  |
| [1486](#L1486) | public function handleQuickMigration() { |
| [1487](#L1487) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1488](#L1488) | if (file\_exists($lock) && (time() - filemtime($lock)) < 65) { |
| [1489](#L1489) | return ['status' => 'msg', 'why' => \_\_('Download process is currently running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [1490](#L1490) | } |
| [1491](#L1491) |  |
| [1492](#L1492) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1493](#L1493) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [1494](#L1494) |  |
| [1495](#L1495) | $migration = new MigrationProgress(true); |
| [1496](#L1496) | $migration->start(); |
| [1497](#L1497) |  |
| [1498](#L1498) | $tmp\_name = 'backup\_' . time() . '.zip'; |
| [1499](#L1499) |  |
| [1500](#L1500) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true && defined('BMI\_CLI\_ARGUMENT')) { |
| [1501](#L1501) | $url = BMI\_CLI\_ARGUMENT; |
| [1502](#L1502) | } else { |
| [1503](#L1503) | $url = $this->post['url']; |
| [1504](#L1504) | } |
| [1505](#L1505) |  |
| [1506](#L1506) | $dest = BMI\_BACKUPS . '/' . $tmp\_name; |
| [1507](#L1507) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1508](#L1508) | $cli\_lock = BMI\_BACKUPS . '/.cli\_download\_lock'; |
| [1509](#L1509) |  |
| [1510](#L1510) | if (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) { |
| [1511](#L1511) |  |
| [1512](#L1512) | $cli\_result = $this->checkIfPHPCliExist($migration); |
| [1513](#L1513) | if ($cli\_result !== false) { |
| [1514](#L1514) |  |
| [1515](#L1515) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [1516](#L1516) |  |
| [1517](#L1517) | $res = null; |
| [1518](#L1518) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_quick\_migration "' . $url . '" > /dev/null &', $res); |
| [1519](#L1519) | $res = implode("\n", $res); |
| [1520](#L1520) |  |
| [1521](#L1521) | sleep(2); |
| [1522](#L1522) | if (file\_exists($cli\_lock) && (time() - filemtime($cli\_lock)) < 10) { |
| [1523](#L1523) |  |
| [1524](#L1524) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1525](#L1525) | return [ 'status' => 'cli\_download' ]; |
| [1526](#L1526) | exit; |
| [1527](#L1527) |  |
| [1528](#L1528) | } |
| [1529](#L1529) |  |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | } else { |
| [1533](#L1533) |  |
| [1534](#L1534) | $migration->log(\_\_('Downloading via PHP CLI', 'backup-backup')); |
| [1535](#L1535) | touch($cli\_lock); |
| [1536](#L1536) |  |
| [1537](#L1537) | } |
| [1538](#L1538) |  |
| [1539](#L1539) | $migration->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION)); |
| [1540](#L1540) | $migration->log(\_\_('Creating lock file', 'backup-backup')); |
| [1541](#L1541) | file\_put\_contents($lock, ''); |
| [1542](#L1542) | $migration->log(\_\_('Initializing download process', 'backup-backup'), 'STEP'); |
| [1543](#L1543) | $downstart = microtime(true); |
| [1544](#L1544) | $migration->log(\_\_('Downloading initialized', 'backup-backup'), 'SUCCESS'); |
| [1545](#L1545) | $migration->log(\_\_('Downloading remote file...', 'backup-backup'), 'STEP'); |
| [1546](#L1546) | $migration->log(\_\_('Used URL: ', 'backup-backup') . sanitize\_text\_field($url), 'INFO'); |
| [1547](#L1547) | $fileError = $this->downloadFile($url, $dest, $progress, $lock, $migration); |
| [1548](#L1548) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1549](#L1549) | if (file\_exists($lock)) @unlink($lock); |
| [1550](#L1550) |  |
| [1551](#L1551) | if ($fileError) { |
| [1552](#L1552) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'INFO'); |
| [1553](#L1553) | if (file\_exists($dest)) @unlink($dest); |
| [1554](#L1554) | $migration->log(\_\_('Download error', 'backup-backup'), 'ERROR'); |
| [1555](#L1555) |  |
| [1556](#L1556) | if (strpos($fileError, 'Failed writing body') !== false) { |
| [1557](#L1557) | $migration->log(\_\_('Error: There is not enough space on the server', 'backup-backup'), 'ERROR'); |
| [1558](#L1558) | } else { |
| [1559](#L1559) | $migration->log(\_\_('Error', 'backup-backup') . ': ' . $fileError, 'ERROR'); |
| [1560](#L1560) | } |
| [1561](#L1561) |  |
| [1562](#L1562) | $migration->log('#002', 'END-CODE'); |
| [1563](#L1563) | return ['status' => 'error']; |
| [1564](#L1564) | } else { |
| [1565](#L1565) | $migration->log(\_\_('Download completed (took: ', 'backup-backup') . (microtime(true) - $downstart) . 's)', 'SUCCESS'); |
| [1566](#L1566) | $migration->log(\_\_('Looking for backup manifest', 'backup-backup'), 'STEP'); |
| [1567](#L1567) | $zipper = new Zipper(); |
| [1568](#L1568) | $content = $zipper->getZipFileContent($dest, 'bmi\_backup\_manifest.json'); |
| [1569](#L1569) | if ($content) { |
| [1570](#L1570) | try { |
| [1571](#L1571) | $i = 1; |
| [1572](#L1572) | $name = $content->name; |
| [1573](#L1573) | $prepared\_name = $name; |
| [1574](#L1574) | $migration->log(\_\_('Manifest found remote name: ', 'backup-backup') . $name, 'SUCCESS'); |
| [1575](#L1575) |  |
| [1576](#L1576) | while (file\_exists(BMI\_BACKUPS . '/' . $prepared\_name)) { |
| [1577](#L1577) | $prepared\_name = substr($name, 0, -4) . '\_' . $i . '.zip'; |
| [1578](#L1578) | $i++; |
| [1579](#L1579) | } |
| [1580](#L1580) |  |
| [1581](#L1581) | rename($dest, BMI\_BACKUPS . '/' . $prepared\_name); |
| [1582](#L1582) | $migration->log(\_\_('Requesting restore process', 'backup-backup'), 'STEP'); |
| [1583](#L1583) | $migration->progress(0); |
| [1584](#L1584) | file\_put\_contents(BMI\_BACKUPS . '/' . '.cli\_download\_last', $prepared\_name); |
| [1585](#L1585) | $migration->log('#205', 'END-CODE'); |
| [1586](#L1586) |  |
| [1587](#L1587) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY')) { |
| [1588](#L1588) | $this->post['file'] = '.cli\_download'; |
| [1589](#L1589) | $this->post['remote'] = true; |
| [1590](#L1590) | return $this->restoreBackup(); |
| [1591](#L1591) | } else { |
| [1592](#L1592) | return ['status' => 'success', 'name' => $prepared\_name]; |
| [1593](#L1593) | } |
| [1594](#L1594) | } catch (\Exception $e) { |
| [1595](#L1595) | $migration->log(\_\_('Error: ', 'backup-backup') . $e, 'ERROR'); |
| [1596](#L1596) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1597](#L1597) | if (file\_exists($dest)) @unlink($dest); |
| [1598](#L1598) |  |
| [1599](#L1599) | $migration->log('#002', 'END-CODE'); |
| [1600](#L1600) | return ['status' => 'error']; |
| [1601](#L1601) | } catch (\Throwable $e) { |
| [1602](#L1602) | $migration->log(\_\_('Error: ', 'backup-backup') . $e, 'ERROR'); |
| [1603](#L1603) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1604](#L1604) | if (file\_exists($dest)) @unlink($dest); |
| [1605](#L1605) |  |
| [1606](#L1606) | $migration->log('#002', 'END-CODE'); |
| [1607](#L1607) | return ['status' => 'error']; |
| [1608](#L1608) |  |
| [1609](#L1609) | } |
| [1610](#L1610) |  |
| [1611](#L1611) | } else { |
| [1612](#L1612) |  |
| [1613](#L1613) | // $migration->log(\_\_('Error during manifest check: ', 'backup-backup') . print\_r($content, true), 'ERROR'); |
| [1614](#L1614) | if ($this->lastCurlCode == '403') { |
| [1615](#L1615) | $migration->log(\_\_('Backup is not available to download (Error 403).', 'backup-backup'), 'ERROR'); |
| [1616](#L1616) | $migration->log(\_\_('It is restricted by remote server configuration.', 'backup-backup'), 'ERROR'); |
| [1617](#L1617) | } elseif ($this->lastCurlCode == '423') { |
| [1618](#L1618) | $migration->log(\_\_('Backup is locked on remote site, please unlock remote downloading.', 'backup-backup'), 'ERROR'); |
| [1619](#L1619) | $migration->log(\_\_('You can find the setting in "Where shall the backup(s) be stored?" section.', 'backup-backup'), 'ERROR'); |
| [1620](#L1620) | } elseif ($this->lastCurlCode == '200' || $this->lastCurlCode == '404') { |
| [1621](#L1621) | $migration->log(\_\_('Backup does not exist under provided URL.', 'backup-backup'), 'ERROR'); |
| [1622](#L1622) | $migration->log(\_\_('Please confirm that you can download the backup file via provided URL.', 'backup-backup'), 'ERROR'); |
| [1623](#L1623) | $migration->log(\_\_('...or the manifest file does not exist in the backup.', 'backup-backup'), 'ERROR'); |
| [1624](#L1624) | $migration->log(\_\_('Missing manifest means that the backup is probably invalid.', 'backup-backup'), 'ERROR'); |
| [1625](#L1625) | } else { |
| [1626](#L1626) | $migration->log(\_\_('Manifest file does not exist', 'backup-backup'), 'ERROR'); |
| [1627](#L1627) | $migration->log(\_\_('Downloaded backup may be incomplete (missing manifest)', 'backup-backup'), 'ERROR'); |
| [1628](#L1628) | $migration->log(\_\_('...or provided URL is not a direct download of ZIP file.', 'backup-backup'), 'ERROR'); |
| [1629](#L1629) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1630](#L1630) | } |
| [1631](#L1631) |  |
| [1632](#L1632) | if (file\_exists($dest)) @unlink($dest); |
| [1633](#L1633) |  |
| [1634](#L1634) | $migration->log('#002', 'END-CODE'); |
| [1635](#L1635) | return ['status' => 'error']; |
| [1636](#L1636) |  |
| [1637](#L1637) | } |
| [1638](#L1638) | } |
| [1639](#L1639) | } |
| [1640](#L1640) |  |
| [1641](#L1641) | public function handleChunkUpload() { |
| [1642](#L1642) | require\_once BMI\_INCLUDES . '/uploader/chunks.php'; |
| [1643](#L1643) | } |
| [1644](#L1644) |  |
| [1645](#L1645) | public function removeBackupFile() { |
| [1646](#L1646) | $files = $this->post['filenames']; |
| [1647](#L1647) | $deleteCloud = $this->post['deleteCloud'] === 'yes' ? true : false; |
| [1648](#L1648) | $cloudDetails = $this->post['cloudDetails']; |
| [1649](#L1649) |  |
| [1650](#L1650) | $md5\_file\_summary\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR. 'md5summary.php'; |
| [1651](#L1651) | $md5summary = []; |
| [1652](#L1652) |  |
| [1653](#L1653) | if (file\_exists($md5\_file\_summary\_path)) { |
| [1654](#L1654) | $md5summary = file\_get\_contents($md5\_file\_summary\_path); |
| [1655](#L1655) | $md5summary = substr($md5summary, 18, -2); |
| [1656](#L1656) | if (is\_serialized($md5summary)) { |
| [1657](#L1657) | $md5summary = maybe\_unserialize($md5summary); |
| [1658](#L1658) | } |
| [1659](#L1659) | } |
| [1660](#L1660) |  |
| [1661](#L1661) | if ($deleteCloud) { |
| [1662](#L1662) | if (defined('BMI\_BACKUP\_PRO') && defined('BMI\_PRO\_INC')) { |
| [1663](#L1663) | $proPath = BMI\_PRO\_INC . 'external/controller.php'; |
| [1664](#L1664) | if (file\_exists($proPath)) { |
| [1665](#L1665) | require\_once $proPath; |
| [1666](#L1666) | $externalStorage = new ExternalStorage(); |
| [1667](#L1667) | } |
| [1668](#L1668) | } |
| [1669](#L1669) | } |
| [1670](#L1670) |  |
| [1671](#L1671) | try { |
| [1672](#L1672) | if (is\_array($files)) { |
| [1673](#L1673) | for ($i = 0; $i < sizeof($files); $i++) { |
| [1674](#L1674) |  |
| [1675](#L1675) | $removeByMD5 = false; |
| [1676](#L1676) | $file = $files[$i]; |
| [1677](#L1677) | $file = preg\_replace('/\.\./', '', $file); |
| [1678](#L1678) |  |
| [1679](#L1679) | if (file\_exists(BMI\_BACKUPS . '/' . $file)) { |
| [1680](#L1680) |  |
| [1681](#L1681) | if ($deleteCloud) { |
| [1682](#L1682) | do\_action('bmi\_premium\_remove\_backup\_file', md5\_file(BMI\_BACKUPS . '/' . $file)); |
| [1683](#L1683) | } |
| [1684](#L1684) |  |
| [1685](#L1685) | unlink(BMI\_BACKUPS . '/' . $file); |
| [1686](#L1686) |  |
| [1687](#L1687) | } else if ($deleteCloud) $removeByMD5 = true; |
| [1688](#L1688) |  |
| [1689](#L1689) | if (isset($md5summary[$file])) { |
| [1690](#L1690) | $md5s = $md5summary[$file]; |
| [1691](#L1691) |  |
| [1692](#L1692) | for ($j = 0; $j < sizeof($md5s); ++$j) { |
| [1693](#L1693) | $md5\_file\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $md5s[$j] . '.json'; |
| [1694](#L1694) | if (file\_exists($md5\_file\_path)) { |
| [1695](#L1695) | if ($deleteCloud) { |
| [1696](#L1696) | do\_action('bmi\_premium\_remove\_backup\_json\_file', $md5s[$j] . '.json'); |
| [1697](#L1697) | } |
| [1698](#L1698) | unlink($md5\_file\_path); |
| [1699](#L1699) | } else if ($deleteCloud) $removeByMD5 = true; |
| [1700](#L1700) | } |
| [1701](#L1701) |  |
| [1702](#L1702) | unset($md5summary[$file]); |
| [1703](#L1703) | } |
| [1704](#L1704) |  |
| [1705](#L1705) | if ($deleteCloud && $removeByMD5) { |
| [1706](#L1706) | if (isset($cloudDetails[$file])) { |
| [1707](#L1707) | do\_action('bmi\_premium\_remove\_backup\_file', $cloudDetails[$file]['md5']); |
| [1708](#L1708) | do\_action('bmi\_premium\_remove\_backup\_json\_file', $cloudDetails[$file]['md5'] . '.json'); |
| [1709](#L1709) | } |
| [1710](#L1710) | } |
| [1711](#L1711) |  |
| [1712](#L1712) | } |
| [1713](#L1713) | } |
| [1714](#L1714) | } catch (\Exception $e) { |
| [1715](#L1715) | return ['status' => 'error', 'e' => $e]; |
| [1716](#L1716) | } catch (\Throwable $e) { |
| [1717](#L1717) | return ['status' => 'error', 'e' => $e]; |
| [1718](#L1718) | } |
| [1719](#L1719) |  |
| [1720](#L1720) | $cacheMd5String = "<?php exit; \$x = '" . serialize($md5summary) . "';"; |
| [1721](#L1721) | file\_put\_contents($md5\_file\_summary\_path, $cacheMd5String); |
| [1722](#L1722) |  |
| [1723](#L1723) | return ['status' => 'success']; |
| [1724](#L1724) | } |
| [1725](#L1725) |  |
| [1726](#L1726) | public function saveStorageConfig() { |
| [1727](#L1727) | $dir\_path = $this->post['directory']; // STORAGE::LOCAL::PATH |
| [1728](#L1728) | $accessible = $this->post['access']; // STORAGE::DIRECT::URL |
| [1729](#L1729) | $gdrivedirname = 'BACKUP\_MIGRATION\_BACKUPS'; // STORAGE::EXTERNAL::GDRIVE::DIRNAME // $this->post['gdrivedirname'] |
| [1730](#L1730) | $curr\_path = Dashboard\bmi\_get\_config('STORAGE::LOCAL::PATH'); |
| [1731](#L1731) |  |
| [1732](#L1732) | $error = 0; |
| [1733](#L1733) | $created = false; |
| [1734](#L1734) |  |
| [1735](#L1735) | if (!preg\_match("/^[a-zA-Z0-9\\_\-\/\.]+$/", $dir\_path)) { |
| [1736](#L1736) | return ['status' => 'msg', 'why' => \_\_('Entered directory/path name does not match allowed characters (Local Storage).', 'backup-backup'), 'level' => 'warning']; |
| [1737](#L1737) | } |
| [1738](#L1738) |  |
| [1739](#L1739) | if (!file\_exists($dir\_path)) { |
| [1740](#L1740) | $created = true; |
| [1741](#L1741) | @mkdir($dir\_path, 0755, true); |
| [1742](#L1742) | } |
| [1743](#L1743) |  |
| [1744](#L1744) | if (defined('BMI\_BACKUP\_PRO') && BMI\_BACKUP\_PRO === 1) { |
| [1745](#L1745) |  |
| [1746](#L1746) | if (isset($this->post['gdrivedirname'])) { |
| [1747](#L1747) | $gdrivedirname = $this->post['gdrivedirname']; |
| [1748](#L1748) |  |
| [1749](#L1749) | if (!preg\_match("/^[a-zA-Z0-9\\_\-\.]+$/", $gdrivedirname)) { |
| [1750](#L1750) | return ['status' => 'msg', 'why' => \_\_('Entered directory name does not match allowed characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1751](#L1751) | } |
| [1752](#L1752) |  |
| [1753](#L1753) | if (strlen(trim($gdrivedirname)) < 3) { |
| [1754](#L1754) | return ['status' => 'msg', 'why' => \_\_('Entered directory name is too short, min 3 characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1755](#L1755) | } |
| [1756](#L1756) |  |
| [1757](#L1757) | if (strlen(trim($gdrivedirname)) > 48) { |
| [1758](#L1758) | return ['status' => 'msg', 'why' => \_\_('Entered directory name is too long, max 48 characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1759](#L1759) | } |
| [1760](#L1760) |  |
| [1761](#L1761) | if (!Dashboard\bmi\_set\_config('STORAGE::EXTERNAL::GDRIVE::DIRNAME', $gdrivedirname)) { |
| [1762](#L1762) | $errors++; |
| [1763](#L1763) | } |
| [1764](#L1764) | } |
| [1765](#L1765) |  |
| [1766](#L1766) | if (isset($this->post['gdrive'])) { |
| [1767](#L1767) | $gdriveenabled = $this->post['gdrive']; |
| [1768](#L1768) | if (!Dashboard\bmi\_set\_config('STORAGE::EXTERNAL::GDRIVE', $gdriveenabled)) { |
| [1769](#L1769) | $errors++; |
| [1770](#L1770) | } |
| [1771](#L1771) | } |
| [1772](#L1772) |  |
| [1773](#L1773) | } |
| [1774](#L1774) |  |
| [1775](#L1775) | if (is\_writable($dir\_path)) { |
| [1776](#L1776) | if (!Dashboard\bmi\_set\_config('STORAGE::DIRECT::URL', $accessible)) { |
| [1777](#L1777) | $error++; |
| [1778](#L1778) | } |
| [1779](#L1779) | if (!Dashboard\bmi\_set\_config('STORAGE::LOCAL::PATH', esc\_attr($dir\_path))) { |
| [1780](#L1780) | $error++; |
| [1781](#L1781) | } else { |
| [1782](#L1782) | $cur\_dir = BMP::fixSlashes($curr\_path); |
| [1783](#L1783) | $new\_dir = BMP::fixSlashes($dir\_path); |
| [1784](#L1784) |  |
| [1785](#L1785) | $backups\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'backups'; |
| [1786](#L1786) | $backups\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'backups'; |
| [1787](#L1787) |  |
| [1788](#L1788) | $staging\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'staging'; |
| [1789](#L1789) | $staging\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'staging'; |
| [1790](#L1790) |  |
| [1791](#L1791) | $tmp\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'tmp'; |
| [1792](#L1792) | $tmp\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'tmp'; |
| [1793](#L1793) |  |
| [1794](#L1794) | update\_option('BMI::STORAGE::LOCAL::PATH', $new\_dir); |
| [1795](#L1795) |  |
| [1796](#L1796) | if ($cur\_dir != $new\_dir) { |
| [1797](#L1797) |  |
| [1798](#L1798) | if (!file\_exists($new\_dir)) @mkdir($new\_dir, 0755, true); |
| [1799](#L1799) | if (!file\_exists($backups\_new\_dir)) @mkdir($backups\_new\_dir, 0755, true); |
| [1800](#L1800) | if (!file\_exists($staging\_new\_dir)) @mkdir($staging\_new\_dir, 0755, true); |
| [1801](#L1801) | if (!file\_exists($tmp\_new\_dir)) @mkdir($tmp\_new\_dir, 0755, true); |
| [1802](#L1802) |  |
| [1803](#L1803) | $scanned\_directory\_staging = array\_diff(scandir($staging\_cur\_dir), ['..', '.']); |
| [1804](#L1804) | foreach ($scanned\_directory\_staging as $i => $file) { |
| [1805](#L1805) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1806](#L1806) | rename($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $staging\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1807](#L1807) | } |
| [1808](#L1808) | } |
| [1809](#L1809) |  |
| [1810](#L1810) | $scanned\_directory\_tmp = array\_diff(scandir($tmp\_cur\_dir), ['..', '.']); |
| [1811](#L1811) | foreach ($scanned\_directory\_tmp as $i => $file) { |
| [1812](#L1812) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1813](#L1813) | rename($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $tmp\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1814](#L1814) | } |
| [1815](#L1815) | } |
| [1816](#L1816) |  |
| [1817](#L1817) | $scanned\_directory\_backups = array\_diff(scandir($backups\_cur\_dir), ['..', '.']); |
| [1818](#L1818) | foreach ($scanned\_directory\_backups as $i => $file) { |
| [1819](#L1819) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1820](#L1820) | rename($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $backups\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1821](#L1821) | } |
| [1822](#L1822) | } |
| [1823](#L1823) |  |
| [1824](#L1824) | $scanned\_directory = array\_diff(scandir($cur\_dir), ['..', '.']); |
| [1825](#L1825) | foreach ($scanned\_directory as $i => $file) { |
| [1826](#L1826) | if (file\_exists($cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1827](#L1827) | rename($cur\_dir . DIRECTORY\_SEPARATOR . $file, $new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1828](#L1828) | } |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1832](#L1832) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1833](#L1833) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1834](#L1834) | if (file\_exists($backups\_cur\_dir)) @rmdir($backups\_cur\_dir); |
| [1835](#L1835) |  |
| [1836](#L1836) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1837](#L1837) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1838](#L1838) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1839](#L1839) | if (file\_exists($staging\_cur\_dir)) @rmdir($staging\_cur\_dir); |
| [1840](#L1840) |  |
| [1841](#L1841) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1842](#L1842) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1843](#L1843) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1844](#L1844) | if (file\_exists($tmp\_cur\_dir)) @rmdir($tmp\_cur\_dir); |
| [1845](#L1845) |  |
| [1846](#L1846) | if (file\_exists($cur\_dir . DIRECTORY\_SEPARATOR . 'complete\_logs.log')) @unlink($cur\_dir . DIRECTORY\_SEPARATOR . 'complete\_logs.log'); |
| [1847](#L1847) | if (file\_exists($cur\_dir)) @rmdir($cur\_dir); |
| [1848](#L1848) |  |
| [1849](#L1849) | if (is\_dir($cur\_dir) && file\_exists($cur\_dir)) { |
| [1850](#L1850) | $left\_files = array\_diff(scandir($cur\_dir), ['..', '.']); |
| [1851](#L1851) | if (sizeof($left\_files) == 0) { |
| [1852](#L1852) | if (file\_exists($cur\_dir)) { |
| [1853](#L1853) | @rmdir($cur\_dir); |
| [1854](#L1854) | } |
| [1855](#L1855) | } |
| [1856](#L1856) | } |
| [1857](#L1857) |  |
| [1858](#L1858) | } |
| [1859](#L1859) | } |
| [1860](#L1860) | } else { |
| [1861](#L1861) | if ($created === true) { |
| [1862](#L1862) | if (file\_exists($dir\_path)) @unlink($dir\_path); |
| [1863](#L1863) | } |
| [1864](#L1864) |  |
| [1865](#L1865) | return ['status' => 'msg', 'why' => \_\_('Entered path is not writable, cannot be used.', 'backup-backup'), 'level' => 'warning']; |
| [1866](#L1866) | } |
| [1867](#L1867) |  |
| [1868](#L1868) | return ['status' => 'success', 'errors' => $error]; |
| [1869](#L1869) | } |
| [1870](#L1870) |  |
| [1871](#L1871) | public function saveOtherOptions() { |
| [1872](#L1872) |  |
| [1873](#L1873) | // Errors |
| [1874](#L1874) | $invalid\_email = \_\_('Provided email addess is not valid.', 'backup-backup'); |
| [1875](#L1875) | $title\_long = \_\_('Your email title is too long, please change the title (max 64 chars).', 'backup-backup'); |
| [1876](#L1876) | $title\_short = \_\_('Your email title is too short, please use longer one (at least 3 chars).', 'backup-backup'); |
| [1877](#L1877) | $title\_empty = \_\_('Title field is required, please fill it.', 'backup-backup'); |
| [1878](#L1878) | $email\_empty = \_\_('Email field cannot be empty, please fill it.', 'backup-backup'); |
| [1879](#L1879) | $cli\_no\_exist = \_\_('Path to executable that you provided for PHP CLI does not exist.', 'backup-backup'); |
| [1880](#L1880) | $db\_query\_too\_low = \_\_('The value for query amount cannot be smaller than 15.', 'backup-backup'); |
| [1881](#L1881) | $db\_query\_too\_much = \_\_('The value for query amount cannot be larger than 15000.', 'backup-backup'); |
| [1882](#L1882) | $db\_sr\_max\_too\_low = \_\_('The value for search replace max page cannot be smaller than 10.', 'backup-backup'); |
| [1883](#L1883) | $db\_sr\_max\_too\_much = \_\_('The value for search replace max page cannot be larger than 30000.', 'backup-backup'); |
| [1884](#L1884) | $fl\_ex\_max\_too\_low = \_\_('The value for extraction limit cannot be smaller than 50.', 'backup-backup'); |
| [1885](#L1885) | $fl\_ex\_max\_too\_much = \_\_('The value for extraction limit cannot be larger than 20000.', 'backup-backup'); |
| [1886](#L1886) |  |
| [1887](#L1887) | $email = sanitize\_email(trim($this->post['email'])); // OTHER:EMAIL |
| [1888](#L1888) | $email\_title = sanitize\_text\_field(trim($this->post['email\_title'])); // OTHER:EMAIL:TITLE |
| [1889](#L1889) | $schedule\_issues = $this->post['schedule\_issues'] === 'true' ? true : false; // OTHER:EMAIL:NOTIS |
| [1890](#L1890) | $experiment\_timeout = $this->post['experiment\_timeout'] === 'true' ? true : false; // OTHER:EXPERIMENT:TIMEOUT |
| [1891](#L1891) | $experiment\_timeout\_hard = $this->post['experimental\_hard\_timeout'] === 'true' ? true : false; // OTHER:EXPERIMENT:TIMEOUT:HARD |
| [1892](#L1892) | $php\_cli\_manual\_path = isset($this->post['php\_cli\_manual\_path']) ? trim($this->post['php\_cli\_manual\_path']) : ''; // OTHER:CLI:PATH |
| [1893](#L1893) | $php\_cli\_disable\_others = $this->post['php\_cli\_disable\_others'] === 'true' ? true : false; // OTHER:CLI:DISABLE |
| [1894](#L1894) | $normal\_timeout = $this->post['normal\_timeout'] === 'true' ? true : false; // OTHER:USE:TIMEOUT:NORMAL |
| [1895](#L1895) | $insecure\_download = $this->post['download\_technique'] === 'true' ? true : false; // OTHER:DOWNLOAD:DIRECT |
| [1896](#L1896) | $db\_query\_size = isset($this->post['db\_queries\_amount']) ? trim($this->post['db\_queries\_amount']) : '2000'; // OTHER:DB:QUERIES |
| [1897](#L1897) | $db\_search\_replace\_max = isset($this->post['db\_search\_replace\_max']) ? trim($this->post['db\_search\_replace\_max']) : '300'; // OTHER:DB:SEARCHREPLACE:MAX |
| [1898](#L1898) | $file\_limit\_extraction\_max = isset($this->post['file\_limit\_extraction\_max']) ? trim($this->post['file\_limit\_extraction\_max']) : 'auto'; // OTHER:FILE:EXTRACT:MAX |
| [1899](#L1899) | $db\_restore\_splitting = $this->post['bmi-restore-splitting'] === 'true' ? true : false; // OTHER:RESTORE:SPLITTING |
| [1900](#L1900) | $db\_restore\_v3\_engine = $this->post['bmi-db-v3-restore-engine'] === 'true' ? true : false; // OTHER:RESTORE:DB:V3 |
| [1901](#L1901) |  |
| [1902](#L1902) | $no\_assets\_b4\_restore = $this->post['remove-assets-before-restore'] === 'true' ? true : false; // OTHER:RESTORE:BEFORE:CLEANUP |
| [1903](#L1903) | $single\_file\_db\_force = $this->post['bmi-db-single-file-backup'] === 'true' ? true : false; // OTHER:BACKUP:DB:SINGLE:FILE |
| [1904](#L1904) | $db\_batching\_backup = $this->post['bmi-db-batching-backup'] === 'true' ? true : false; // OTHER:BACKUP:DB:BATCHING |
| [1905](#L1905) |  |
| [1906](#L1906) | $bmi\_disable\_space\_check = $this->post['bmi-disable-space-check-function'] === 'true' ? true : false; // OTHER:BACKUP:SPACE:CHECKING |
| [1907](#L1907) |  |
| [1908](#L1908) | $uninstall\_config = $this->post['uninstall\_config'] === 'true' ? true : false; // OTHER:UNINSTALL:CONFIGS |
| [1909](#L1909) | $uninstall\_backups = $this->post['uninstall\_backups'] === 'true' ? true : false; // OTHER:UNINSTALL:BACKUPS |
| [1910](#L1910) |  |
| [1911](#L1911) | if ($experiment\_timeout\_hard === true) { |
| [1912](#L1912) | $experiment\_timeout = false; |
| [1913](#L1913) | } |
| [1914](#L1914) |  |
| [1915](#L1915) | if ($normal\_timeout === true) { |
| [1916](#L1916) | $experiment\_timeout = false; |
| [1917](#L1917) | $experiment\_timeout\_hard = false; |
| [1918](#L1918) | } |
| [1919](#L1919) |  |
| [1920](#L1920) | if (!is\_numeric($db\_query\_size) || empty($db\_query\_size)) { |
| [1921](#L1921) | $db\_query\_size = "2000"; |
| [1922](#L1922) | } |
| [1923](#L1923) |  |
| [1924](#L1924) | if (!is\_numeric($file\_limit\_extraction\_max) || empty($file\_limit\_extraction\_max)) { |
| [1925](#L1925) | $file\_limit\_extraction\_max = "auto"; |
| [1926](#L1926) | } |
| [1927](#L1927) |  |
| [1928](#L1928) | if (!is\_numeric($db\_search\_replace\_max) || empty($db\_search\_replace\_max)) { |
| [1929](#L1929) | $db\_search\_replace\_max = "300"; |
| [1930](#L1930) | } |
| [1931](#L1931) |  |
| [1932](#L1932) | if (strlen($email) <= 0) { |
| [1933](#L1933) | return ['status' => 'msg', 'why' => $email\_empty, 'level' => 'warning']; |
| [1934](#L1934) | } |
| [1935](#L1935) | if (strlen($email\_title) <= 0) { |
| [1936](#L1936) | return ['status' => 'msg', 'why' => $title\_empty, 'level' => 'warning']; |
| [1937](#L1937) | } |
| [1938](#L1938) | if (strlen($email\_title) > 64) { |
| [1939](#L1939) | return ['status' => 'msg', 'why' => $title\_long, 'level' => 'warning']; |
| [1940](#L1940) | } |
| [1941](#L1941) | if (strlen($email\_title) < 3) { |
| [1942](#L1942) | return ['status' => 'msg', 'why' => $title\_short, 'level' => 'warning']; |
| [1943](#L1943) | } |
| [1944](#L1944) | if (!filter\_var($email, FILTER\_VALIDATE\_EMAIL)) { |
| [1945](#L1945) | return ['status' => 'msg', 'why' => $invalid\_email, 'level' => 'warning']; |
| [1946](#L1946) | } |
| [1947](#L1947) | if ($php\_cli\_manual\_path != '' && !file\_exists($php\_cli\_manual\_path)) { |
| [1948](#L1948) | return ['status' => 'msg', 'why' => $cli\_no\_exist, 'level' => 'warning']; |
| [1949](#L1949) | } |
| [1950](#L1950) | if (intval($db\_query\_size) > 15000) { |
| [1951](#L1951) | return ['status' => 'msg', 'why' => $db\_query\_too\_much, 'level' => 'warning']; |
| [1952](#L1952) | } |
| [1953](#L1953) | if (intval($db\_query\_size) < 15) { |
| [1954](#L1954) | return ['status' => 'msg', 'why' => $db\_query\_too\_low, 'level' => 'warning']; |
| [1955](#L1955) | } |
| [1956](#L1956) | if (intval($db\_search\_replace\_max) > 30000) { |
| [1957](#L1957) | return ['status' => 'msg', 'why' => $db\_sr\_max\_too\_much, 'level' => 'warning']; |
| [1958](#L1958) | } |
| [1959](#L1959) | if (intval($db\_search\_replace\_max) < 10) { |
| [1960](#L1960) | return ['status' => 'msg', 'why' => $db\_sr\_max\_too\_low, 'level' => 'warning']; |
| [1961](#L1961) | } |
| [1962](#L1962) | if ($file\_limit\_extraction\_max != 'auto' && intval($file\_limit\_extraction\_max) > 20000) { |
| [1963](#L1963) | return ['status' => 'msg', 'why' => $fl\_ex\_max\_too\_much, 'level' => 'warning']; |
| [1964](#L1964) | } |
| [1965](#L1965) | if ($file\_limit\_extraction\_max != 'auto' && intval($file\_limit\_extraction\_max) < 50) { |
| [1966](#L1966) | return ['status' => 'msg', 'why' => $fl\_ex\_max\_too\_low, 'level' => 'warning']; |
| [1967](#L1967) | } |
| [1968](#L1968) |  |
| [1969](#L1969) | $error = 0; |
| [1970](#L1970) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL', $email)) { |
| [1971](#L1971) | $error++; |
| [1972](#L1972) | } |
| [1973](#L1973) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL:TITLE', $email\_title)) { |
| [1974](#L1974) | $error++; |
| [1975](#L1975) | } |
| [1976](#L1976) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL:NOTIS', $schedule\_issues)) { |
| [1977](#L1977) | $error++; |
| [1978](#L1978) | } |
| [1979](#L1979) | if (!Dashboard\bmi\_set\_config('OTHER:CLI:PATH', $php\_cli\_manual\_path)) { |
| [1980](#L1980) | $error++; |
| [1981](#L1981) | } |
| [1982](#L1982) | if (!Dashboard\bmi\_set\_config('OTHER:CLI:DISABLE', $php\_cli\_disable\_others)) { |
| [1983](#L1983) | $error++; |
| [1984](#L1984) | } |
| [1985](#L1985) | if (!Dashboard\bmi\_set\_config('OTHER:EXPERIMENT:TIMEOUT', $experiment\_timeout)) { |
| [1986](#L1986) | $error++; |
| [1987](#L1987) | } |
| [1988](#L1988) | if (!Dashboard\bmi\_set\_config('OTHER:EXPERIMENT:TIMEOUT:HARD', $experiment\_timeout\_hard)) { |
| [1989](#L1989) | $error++; |
| [1990](#L1990) | } |
| [1991](#L1991) | if (!Dashboard\bmi\_set\_config('OTHER:USE:TIMEOUT:NORMAL', $normal\_timeout)) { |
| [1992](#L1992) | $error++; |
| [1993](#L1993) | } |
| [1994](#L1994) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:DB:V3', $db\_restore\_v3\_engine)) { |
| [1995](#L1995) | $error++; |
| [1996](#L1996) | } |
| [1997](#L1997) | if (!Dashboard\bmi\_set\_config('OTHER:DB:QUERIES', $db\_query\_size)) { |
| [1998](#L1998) | $error++; |
| [1999](#L1999) | } |
| [2000](#L2000) | if (!Dashboard\bmi\_set\_config('OTHER:DB:SEARCHREPLACE:MAX', $db\_search\_replace\_max)) { |
| [2001](#L2001) | $error++; |
| [2002](#L2002) | } |
| [2003](#L2003) | if (!Dashboard\bmi\_set\_config('OTHER:FILE:EXTRACT:MAX', $file\_limit\_extraction\_max)) { |
| [2004](#L2004) | $error++; |
| [2005](#L2005) | } |
| [2006](#L2006) | if (!Dashboard\bmi\_set\_config('OTHER:DOWNLOAD:DIRECT', $insecure\_download)) { |
| [2007](#L2007) | $error++; |
| [2008](#L2008) | } |
| [2009](#L2009) | if (!Dashboard\bmi\_set\_config('OTHER:UNINSTALL:CONFIGS', $uninstall\_config)) { |
| [2010](#L2010) | $error++; |
| [2011](#L2011) | } |
| [2012](#L2012) | if (!Dashboard\bmi\_set\_config('OTHER:UNINSTALL:BACKUPS', $uninstall\_backups)) { |
| [2013](#L2013) | $error++; |
| [2014](#L2014) | } |
| [2015](#L2015) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:SPLITTING', $db\_restore\_splitting)) { |
| [2016](#L2016) | $error++; |
| [2017](#L2017) | } |
| [2018](#L2018) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:DB:SINGLE:FILE', $single\_file\_db\_force)) { |
| [2019](#L2019) | $error++; |
| [2020](#L2020) | } |
| [2021](#L2021) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:DB:BATCHING', $db\_batching\_backup)) { |
| [2022](#L2022) | $error++; |
| [2023](#L2023) | } |
| [2024](#L2024) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:SPACE:CHECKING', $bmi\_disable\_space\_check)) { |
| [2025](#L2025) | $error++; |
| [2026](#L2026) | } |
| [2027](#L2027) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:BEFORE:CLEANUP', $no\_assets\_b4\_restore)) { |
| [2028](#L2028) | $error++; |
| [2029](#L2029) | } |
| [2030](#L2030) |  |
| [2031](#L2031) | if (has\_action('bmi\_premium\_other\_options')) { |
| [2032](#L2032) | do\_action('bmi\_premium\_other\_options', $this->post); |
| [2033](#L2033) | } |
| [2034](#L2034) |  |
| [2035](#L2035) | return ['status' => 'success', 'errors' => $error]; |
| [2036](#L2036) | } |
| [2037](#L2037) |  |
| [2038](#L2038) | public function saveStorageTypeConfig() { |
| [2039](#L2039) |  |
| [2040](#L2040) | // Errors |
| [2041](#L2041) | $name\_empty = \_\_('Name is required, please fill the input.', 'backup-backup'); |
| [2042](#L2042) | $name\_long = \_\_('Your name is too long, please change the name.', 'backup-backup'); |
| [2043](#L2043) | $name\_short = \_\_('Your name is too short, please create longer one.', 'backup-backup'); |
| [2044](#L2044) | $name\_space = \_\_('Please, do not use spaces in file name.', 'backup-backup'); |
| [2045](#L2045) | $name\_forbidden = \_\_('Your name contains character(s) that are not allowed in file names: ', 'backup-backup'); |
| [2046](#L2046) |  |
| [2047](#L2047) | $forbidden\_chars = ['/', '\\', '<', '>', ':', '"', "'", '|', '?', '\*', '.', ';', '@', '!', '~', '`', ',', '#', '$', '&', '=', '+']; |
| [2048](#L2048) | $name = trim($this->post['name']); // BACKUP:NAME |
| [2049](#L2049) |  |
| [2050](#L2050) | if (strlen($name) == 0) { |
| [2051](#L2051) | return ['status' => 'msg', 'why' => $name\_empty, 'level' => 'warning']; |
| [2052](#L2052) | } |
| [2053](#L2053) | if (strlen($name) > 40) { |
| [2054](#L2054) | return ['status' => 'msg', 'why' => $name\_long, 'level' => 'warning']; |
| [2055](#L2055) | } |
| [2056](#L2056) | if (strlen($name) < 3) { |
| [2057](#L2057) | return ['status' => 'msg', 'why' => $name\_short, 'level' => 'warning']; |
| [2058](#L2058) | } |
| [2059](#L2059) | if (strpos($name, ' ') !== false) { |
| [2060](#L2060) | return ['status' => 'msg', 'why' => $name\_space, 'level' => 'warning']; |
| [2061](#L2061) | } |
| [2062](#L2062) |  |
| [2063](#L2063) | for ($i = 0; $i < sizeof($forbidden\_chars); ++$i) { |
| [2064](#L2064) | $char = $forbidden\_chars[$i]; |
| [2065](#L2065) | if (strpos($name, $char) !== false) { |
| [2066](#L2066) | return ['status' => 'msg', 'why' => $name\_forbidden . $char, 'level' => 'warning']; |
| [2067](#L2067) | } |
| [2068](#L2068) | } |
| [2069](#L2069) |  |
| [2070](#L2070) | $error = 0; |
| [2071](#L2071) | if (!Dashboard\bmi\_set\_config('BACKUP:NAME', $name)) { |
| [2072](#L2072) | $error++; |
| [2073](#L2073) | } |
| [2074](#L2074) |  |
| [2075](#L2075) | return ['status' => 'success', 'errors' => $error]; |
| [2076](#L2076) | } |
| [2077](#L2077) |  |
| [2078](#L2078) | public function saveFilesConfig() { |
| [2079](#L2079) | $db\_group = $this->post['database\_group']; // BACKUP:DATABASE |
| [2080](#L2080) | $files\_group = $this->post['files\_group']; // BACKUP:FILES |
| [2081](#L2081) |  |
| [2082](#L2082) | $fgp = $this->post['files-group-plugins']; // BACKUP:FILES::PLUGINS |
| [2083](#L2083) | $fgu = $this->post['files-group-uploads']; // BACKUP:FILES::UPLOADS |
| [2084](#L2084) | $fgt = $this->post['files-group-themes']; // BACKUP:FILES::THEMES |
| [2085](#L2085) | $fgoc = $this->post['files-group-other-contents']; // BACKUP:FILES::OTHERS |
| [2086](#L2086) | $fgwp = $this->post['files-group-wp-install']; // BACKUP:FILES::WP |
| [2087](#L2087) |  |
| [2088](#L2088) | $file\_filters = $this->post['files\_by\_filters']; // BACKUP:FILES::FILTER |
| [2089](#L2089) | $ffs = $this->post['ex\_b\_fs']; // BACKUP:FILES::FILTER:SIZE |
| [2090](#L2090) | $ffsizemax = $this->post['BFFSIN']; // BACKUP:FILES::FILTER:SIZE:IN |
| [2091](#L2091) | $ffn = $this->post['ex\_b\_names']; // BACKUP:FILES::FILTER:NAMES |
| [2092](#L2092) | $ffp = $this->post['ex\_b\_fpaths']; // BACKUP:FILES::FILTER:FPATHS |
| [2093](#L2093) | $ffd = $this->post['ex\_b\_dpaths']; // BACKUP:FILES::FILTER:DPATHS |
| [2094](#L2094) |  |
| [2095](#L2095) | $dbeg = $this->post['db-exclude-tables-group']; // BACKUP:DATABASE:EXCLUDE |
| [2096](#L2096) | $dbet = $this->post['db-excluded-tables']; // BACKUP:DATABASE:EXCLUDE:LIST |
| [2097](#L2097) |  |
| [2098](#L2098) | $existant = []; |
| [2099](#L2099) | $parsed = []; |
| [2100](#L2100) | $ffnames = $this->post['dynamic-names']; // BACKUP:FILES::FILTER:NAMES:IN |
| [2101](#L2101) | $ffpnames = array\_unique($this->post['dynamic-fpaths-names']); // BACKUP:FILES::FILTER:FPATHS:IN |
| [2102](#L2102) | $ffdnames = array\_unique($this->post['dynamic-dpaths-names']); // BACKUP:FILES::FILTER:DPATHS:IN |
| [2103](#L2103) |  |
| [2104](#L2104) | if (is\_array($dbet) || is\_object($dbet)) { |
| [2105](#L2105) | if (sizeof($dbet) == 1 && $dbet[0] == 'empty') { |
| [2106](#L2106) | $dbet = []; |
| [2107](#L2107) | } |
| [2108](#L2108) | } |
| [2109](#L2109) |  |
| [2110](#L2110) | if ($dbeg === 'true' || $dbeg === true) $dbeg = true; |
| [2111](#L2111) | else $dbeg = false; |
| [2112](#L2112) |  |
| [2113](#L2113) | $max = sizeof($ffpnames); |
| [2114](#L2114) | for ($i = 0; $i < $max; ++$i) { |
| [2115](#L2115) | if (!is\_string($ffpnames[$i]) || trim(strlen($ffpnames[$i])) <= 1) { |
| [2116](#L2116) | array\_splice($ffpnames, $i, 1); |
| [2117](#L2117) | $i--; |
| [2118](#L2118) | $max--; |
| [2119](#L2119) | } |
| [2120](#L2120) | } |
| [2121](#L2121) |  |
| [2122](#L2122) | $max = sizeof($ffdnames); |
| [2123](#L2123) | for ($i = 0; $i < $max; ++$i) { |
| [2124](#L2124) | if (!is\_string($ffdnames[$i]) || trim(strlen($ffdnames[$i])) <= 1) { |
| [2125](#L2125) | array\_splice($ffdnames, $i, 1); |
| [2126](#L2126) | $i--; |
| [2127](#L2127) | $max--; |
| [2128](#L2128) | } |
| [2129](#L2129) | } |
| [2130](#L2130) |  |
| [2131](#L2131) | for ($i = 0; $i < sizeof($ffnames); ++$i) { |
| [2132](#L2132) | $row = $ffnames[$i]; |
| [2133](#L2133) | $txt = array\_key\_exists('txt', $row) ? "" . $row['txt'] . "" : false; |
| [2134](#L2134) | $pos = array\_key\_exists('pos', $row) ? $row['pos'] : false; |
| [2135](#L2135) | $whr = array\_key\_exists('whr', $row) ? $row['whr'] : false; |
| [2136](#L2136) |  |
| [2137](#L2137) | if ($txt === false || $pos === false || $whr === false) { |
| [2138](#L2138) | continue; |
| [2139](#L2139) | } |
| [2140](#L2140) | if (trim(strlen($txt)) <= 0) { |
| [2141](#L2141) | continue; |
| [2142](#L2142) | } |
| [2143](#L2143) | if (!in\_array($pos, ["1", "2", "3"])) { |
| [2144](#L2144) | continue; |
| [2145](#L2145) | } |
| [2146](#L2146) | if (!in\_array($whr, ["1", "2"])) { |
| [2147](#L2147) | continue; |
| [2148](#L2148) | } |
| [2149](#L2149) | if (in\_array($txt . $pos . $whr, $existant)) { |
| [2150](#L2150) | continue; |
| [2151](#L2151) | } else { |
| [2152](#L2152) | $existant[] = $txt . $pos . $whr; |
| [2153](#L2153) | } |
| [2154](#L2154) |  |
| [2155](#L2155) | $parsed[] = ['txt' => $txt, 'pos' => $pos, 'whr' => $whr]; |
| [2156](#L2156) | } |
| [2157](#L2157) |  |
| [2158](#L2158) | if ($ffs == 'true' && !is\_numeric($ffsizemax)) { |
| [2159](#L2159) | return ['status' => 'msg', 'why' => \_\_('Entred file size limit, is not correct number.', 'backup-backup'), 'level' => 'warning']; |
| [2160](#L2160) | } |
| [2161](#L2161) |  |
| [2162](#L2162) | $error = 0; |
| [2163](#L2163) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE', $db\_group)) { |
| [2164](#L2164) | $error++; |
| [2165](#L2165) | } |
| [2166](#L2166) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES', $files\_group)) { |
| [2167](#L2167) | $error++; |
| [2168](#L2168) | } |
| [2169](#L2169) |  |
| [2170](#L2170) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::PLUGINS', $fgp)) { |
| [2171](#L2171) | $error++; |
| [2172](#L2172) | } |
| [2173](#L2173) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::UPLOADS', $fgu)) { |
| [2174](#L2174) | $error++; |
| [2175](#L2175) | } |
| [2176](#L2176) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::THEMES', $fgt)) { |
| [2177](#L2177) | $error++; |
| [2178](#L2178) | } |
| [2179](#L2179) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::OTHERS', $fgoc)) { |
| [2180](#L2180) | $error++; |
| [2181](#L2181) | } |
| [2182](#L2182) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::WP', $fgwp)) { |
| [2183](#L2183) | $error++; |
| [2184](#L2184) | } |
| [2185](#L2185) |  |
| [2186](#L2186) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER', $file\_filters)) { |
| [2187](#L2187) | $error++; |
| [2188](#L2188) | } |
| [2189](#L2189) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:SIZE', $ffs)) { |
| [2190](#L2190) | $error++; |
| [2191](#L2191) | } |
| [2192](#L2192) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:NAMES', $ffn)) { |
| [2193](#L2193) | $error++; |
| [2194](#L2194) | } |
| [2195](#L2195) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:FPATHS', $ffp)) { |
| [2196](#L2196) | $error++; |
| [2197](#L2197) | } |
| [2198](#L2198) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:DPATHS', $ffd)) { |
| [2199](#L2199) | $error++; |
| [2200](#L2200) | } |
| [2201](#L2201) |  |
| [2202](#L2202) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:SIZE:IN', $ffsizemax)) { |
| [2203](#L2203) | $error++; |
| [2204](#L2204) | } |
| [2205](#L2205) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:NAMES:IN', $parsed)) { |
| [2206](#L2206) | $error++; |
| [2207](#L2207) | } |
| [2208](#L2208) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:FPATHS:IN', $ffpnames)) { |
| [2209](#L2209) | $error++; |
| [2210](#L2210) | } |
| [2211](#L2211) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:DPATHS:IN', $ffdnames)) { |
| [2212](#L2212) | $error++; |
| [2213](#L2213) | } |
| [2214](#L2214) |  |
| [2215](#L2215) | if (defined('BMI\_BACKUP\_PRO') && BMI\_BACKUP\_PRO == 1) { |
| [2216](#L2216) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE:EXCLUDE', $dbeg)) { |
| [2217](#L2217) | $error++; |
| [2218](#L2218) | } |
| [2219](#L2219) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE:EXCLUDE:LIST', $dbet)) { |
| [2220](#L2220) | $error++; |
| [2221](#L2221) | } |
| [2222](#L2222) | } |
| [2223](#L2223) |  |
| [2224](#L2224) | // return array('status' => 'msg', 'why' => \_\_('Entred path is not writable or does not exist.', 'backup-backup'), 'level' => 'warning'); |
| [2225](#L2225) |  |
| [2226](#L2226) | return ['status' => 'success', 'errors' => $error]; |
| [2227](#L2227) | } |
| [2228](#L2228) |  |
| [2229](#L2229) | public function scanFilesForBackup(&$progress, $stgSites = [], $fileCalcType = false) { |
| [2230](#L2230) | require\_once BMI\_INCLUDES . '/scanner/files.php'; |
| [2231](#L2231) |  |
| [2232](#L2232) | $stagingSites = []; |
| [2233](#L2233) |  |
| [2234](#L2234) | // Get all directory names of staging sites |
| [2235](#L2235) | foreach ($stgSites as $index => $site) { |
| [2236](#L2236) |  |
| [2237](#L2237) | // Convert every directory to their location path |
| [2238](#L2238) | $stagingSites[] = '\*\*\*ABSPATH\*\*\*/' . $site['name']; |
| [2239](#L2239) |  |
| [2240](#L2240) | } |
| [2241](#L2241) |  |
| [2242](#L2242) | // Use filters? |
| [2243](#L2243) | $is = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER') === 'true' ? true : false; |
| [2244](#L2244) |  |
| [2245](#L2245) | // Get settings form config |
| [2246](#L2246) | $fgp = Dashboard\bmi\_get\_config('BACKUP:FILES::PLUGINS'); |
| [2247](#L2247) | $fgt = Dashboard\bmi\_get\_config('BACKUP:FILES::THEMES'); |
| [2248](#L2248) | $fgu = Dashboard\bmi\_get\_config('BACKUP:FILES::UPLOADS'); |
| [2249](#L2249) | $fgoc = Dashboard\bmi\_get\_config('BACKUP:FILES::OTHERS'); |
| [2250](#L2250) | $fgwp = Dashboard\bmi\_get\_config('BACKUP:FILES::WP'); |
| [2251](#L2251) | $dpathsis = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS') === 'true' ? true : false; |
| [2252](#L2252) | $dpaths = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS:IN'); |
| [2253](#L2253) | $dynamesis = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES') === 'true' ? true : false; |
| [2254](#L2254) | $dynames = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2255](#L2255) | $dynparsed = []; |
| [2256](#L2256) |  |
| [2257](#L2257) | if ($fileCalcType != false) { |
| [2258](#L2258) | $fgp = ($fileCalcType == 'plugins') ? true : false; |
| [2259](#L2259) | $fgt = ($fileCalcType == 'themes') ? true : false; |
| [2260](#L2260) | $fgu = ($fileCalcType == 'uploads') ? true : false; |
| [2261](#L2261) | $fgoc = ($fileCalcType == 'contents\_others') ? true : false; |
| [2262](#L2262) | $fgwp = ($fileCalcType == 'wordpress') ? true : false; |
| [2263](#L2263) | } |
| [2264](#L2264) |  |
| [2265](#L2265) | // Filter dynames to for smaller size |
| [2266](#L2266) | if ($is && $dynamesis) { |
| [2267](#L2267) | for ($i = 0; $i < sizeof($dynames); ++$i) { |
| [2268](#L2268) | $s = $dynames[$i]; |
| [2269](#L2269) | if ($s->whr == '2') { |
| [2270](#L2270) | $dynparsed[] = ['s' => $s->txt, 'w' => $s->pos, 'z' => strlen($s->txt)]; |
| [2271](#L2271) | } |
| [2272](#L2272) | } |
| [2273](#L2273) | } |
| [2274](#L2274) |  |
| [2275](#L2275) | // Set exclusion rules |
| [2276](#L2276) | $ignored\_folders\_default = []; |
| [2277](#L2277) | if ($is && $dynamesis) { |
| [2278](#L2278) | BMP::merge\_arrays($ignored\_folders\_default, $dynparsed); |
| [2279](#L2279) | } |
| [2280](#L2280) | $ignored\_folders = $ignored\_folders\_default; |
| [2281](#L2281) | $ignored\_paths\_default = [BMI\_CONFIG\_DIR, BMI\_BACKUPS, BMI\_ROOT\_DIR]; |
| [2282](#L2282) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/ai1wm-backups"; |
| [2283](#L2283) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/ai1wm-backups-old"; |
| [2284](#L2284) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/mwp-download"; |
| [2285](#L2285) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-clone"; |
| [2286](#L2286) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/updraft"; |
| [2287](#L2287) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backups-dup-pro"; |
| [2288](#L2288) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/wpvividbackups"; |
| [2289](#L2289) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backup-guard"; |
| [2290](#L2290) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backuply"; |
| [2291](#L2291) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backups-dup-lite"; |
| [2292](#L2292) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/backupbuddy\_backups"; |
| [2293](#L2293) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-file-manager-pro"; |
| [2294](#L2294) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-file-manager"; |
| [2295](#L2295) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/plugins/akeebabackupwp"; |
| [2296](#L2296) |  |
| [2297](#L2297) | // Exclude cache directory permanently as it's just cache |
| [2298](#L2298) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/cache"; |
| [2299](#L2299) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/cache\_bak"; |
| [2300](#L2300) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/cache"; |
| [2301](#L2301) |  |
| [2302](#L2302) | // Add staging sites to permanent exclusion rules |
| [2303](#L2303) | for ($i = 0; $i < sizeof($stagingSites); ++$i) { |
| [2304](#L2304) | $ignored\_paths\_default[] = $stagingSites[$i]; |
| [2305](#L2305) | } |
| [2306](#L2306) |  |
| [2307](#L2307) | if (defined('BMI\_PRO\_ROOT\_DIR')) $ignored\_paths\_default[] = BMI\_PRO\_ROOT\_DIR; |
| [2308](#L2308) | if ($is && $dpathsis) { |
| [2309](#L2309) | BMP::merge\_arrays($ignored\_paths\_default, $dpaths); |
| [2310](#L2310) | } |
| [2311](#L2311) | $ignored\_paths = $ignored\_paths\_default; |
| [2312](#L2312) |  |
| [2313](#L2313) | // Fix slashes for current system (directories) |
| [2314](#L2314) | for ($i = 0; $i < sizeof($ignored\_paths); ++$i) { |
| [2315](#L2315) | $ignored\_paths[$i] = str\_replace('\*\*\*ABSPATH\*\*\*', untrailingslashit(ABSPATH), $ignored\_paths[$i]); |
| [2316](#L2316) | $ignored\_paths[$i] = BMP::fixSlashes($ignored\_paths[$i]); |
| [2317](#L2317) | } |
| [2318](#L2318) |  |
| [2319](#L2319) | // WordPress Paths |
| [2320](#L2320) | $plugins\_path = BMP::fixSlashes(WP\_PLUGIN\_DIR); |
| [2321](#L2321) | $themes\_path = BMP::fixSlashes(dirname(get\_template\_directory())); |
| [2322](#L2322) | $uploads\_path = BMP::fixSlashes(wp\_upload\_dir()['basedir']); |
| [2323](#L2323) | $wp\_contents = BMP::fixSlashes(WP\_CONTENT\_DIR); |
| [2324](#L2324) | $wp\_install = BMP::fixSlashes(ABSPATH); |
| [2325](#L2325) |  |
| [2326](#L2326) | // Getting plugins |
| [2327](#L2327) | $sfgp = Scanner::equalFolderByPath($wp\_install, $plugins\_path, $ignored\_folders); |
| [2328](#L2328) | if ($fgp == 'true' && !$sfgp) { |
| [2329](#L2329) | $plugins\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($plugins\_path, $ignored\_folders, $ignored\_paths); |
| [2330](#L2330) | } |
| [2331](#L2331) |  |
| [2332](#L2332) | // Getting themes |
| [2333](#L2333) | $sfgt = Scanner::equalFolderByPath($wp\_install, $themes\_path, $ignored\_folders); |
| [2334](#L2334) | if ($fgt == 'true' && !$sfgt) { |
| [2335](#L2335) | $themes\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($themes\_path, $ignored\_folders, $ignored\_paths); |
| [2336](#L2336) | } |
| [2337](#L2337) |  |
| [2338](#L2338) | // Getting uploads |
| [2339](#L2339) | $sfgu = Scanner::equalFolderByPath($wp\_install, $uploads\_path, $ignored\_folders); |
| [2340](#L2340) | if ($fgu == 'true' && !$sfgu) { |
| [2341](#L2341) | $uploads\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($uploads\_path, $ignored\_folders, $ignored\_paths); |
| [2342](#L2342) | } |
| [2343](#L2343) |  |
| [2344](#L2344) | // Ignore above paths |
| [2345](#L2345) | $sfgoc = Scanner::equalFolderByPath($wp\_install, $wp\_contents, $ignored\_folders); |
| [2346](#L2346) | if ($fgoc == 'true' && !$sfgoc) { |
| [2347](#L2347) |  |
| [2348](#L2348) | // Ignore common folders (already scanned) |
| [2349](#L2349) | $content\_folders = [$plugins\_path, $themes\_path, $uploads\_path]; |
| [2350](#L2350) | BMP::merge\_arrays($content\_folders, $ignored\_paths); |
| [2351](#L2351) |  |
| [2352](#L2352) | // Getting other contents |
| [2353](#L2353) | $wp\_contents\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($wp\_contents, $ignored\_folders, $content\_folders); |
| [2354](#L2354) | } |
| [2355](#L2355) |  |
| [2356](#L2356) | // Ignore contents path |
| [2357](#L2357) | if ($fgwp == 'true') { |
| [2358](#L2358) |  |
| [2359](#L2359) | // Ignore contents file |
| [2360](#L2360) | $ignored\_paths[] = $wp\_contents; |
| [2361](#L2361) |  |
| [2362](#L2362) | // Getting WP Installation |
| [2363](#L2363) | $wp\_install\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($wp\_install, $ignored\_folders, $ignored\_paths); |
| [2364](#L2364) | } |
| [2365](#L2365) |  |
| [2366](#L2366) | // Concat all file paths |
| [2367](#L2367) | $all\_files = []; |
| [2368](#L2368) | if ($fgp == 'true' && !$sfgp) { |
| [2369](#L2369) | BMP::merge\_arrays($all\_files, $plugins\_path\_files); |
| [2370](#L2370) | unset($plugins\_path\_files); |
| [2371](#L2371) | } |
| [2372](#L2372) |  |
| [2373](#L2373) | if ($fgt == 'true' && !$sfgt) { |
| [2374](#L2374) | BMP::merge\_arrays($all\_files, $themes\_path\_files); |
| [2375](#L2375) | unset($themes\_path\_files); |
| [2376](#L2376) | } |
| [2377](#L2377) |  |
| [2378](#L2378) | if ($fgu == 'true' && !$sfgu) { |
| [2379](#L2379) | BMP::merge\_arrays($all\_files, $uploads\_path\_files); |
| [2380](#L2380) | unset($uploads\_path\_files); |
| [2381](#L2381) | } |
| [2382](#L2382) |  |
| [2383](#L2383) | if ($fgoc == 'true' && !$sfgoc) { |
| [2384](#L2384) | BMP::merge\_arrays($all\_files, $wp\_contents\_files); |
| [2385](#L2385) | unset($wp\_contents\_files); |
| [2386](#L2386) | } |
| [2387](#L2387) |  |
| [2388](#L2388) | if ($fgwp == 'true') { |
| [2389](#L2389) | BMP::merge\_arrays($all\_files, $wp\_install\_files); |
| [2390](#L2390) | unset($wp\_install\_files); |
| [2391](#L2391) | } |
| [2392](#L2392) |  |
| [2393](#L2393) | return $all\_files; |
| [2394](#L2394) | } |
| [2395](#L2395) |  |
| [2396](#L2396) | public function parseFilesForBackup(&$files, &$progress, $cron = false, $dirCalc = false) { |
| [2397](#L2397) |  |
| [2398](#L2398) | $is = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER') === 'true' ? true : false; |
| [2399](#L2399) | $acis = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS') === 'true' && $is) ? true : false; |
| [2400](#L2400) | $ac = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS:IN'); |
| [2401](#L2401) |  |
| [2402](#L2402) | $abis = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES') === 'true' && $is) ? true : false; |
| [2403](#L2403) | $ab = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2404](#L2404) | $abres = []; |
| [2405](#L2405) | $acres = new \stdClass(); |
| [2406](#L2406) |  |
| [2407](#L2407) | // Local list of permanently blocked files |
| [2408](#L2408) | if ($acis == false) { |
| [2409](#L2409) | $acis = true; |
| [2410](#L2410) | $ac = [ |
| [2411](#L2411) | '\*\*\*ABSPATH\*\*\*/wp-content/uploads/wpforms/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2412](#L2412) | '\*\*\*ABSPATH\*\*\*/wp-content/uploads/gravity\_forms/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2413](#L2413) | '\*\*\*ABSPATH\*\*\*/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2414](#L2414) | '\*\*\*ABSPATH\*\*\*/logs/traffic.html/.md5sums', // Binary broken file of wpforms |
| [2415](#L2415) | '\*\*\*ABSPATH\*\*\*/wp-config.php', // Exclude wp-config.php permanently |
| [2416](#L2416) | '\*\*\*ABSPATH\*\*\*/wp-content/backup-migration-config.php' // Exclude BMI CONFIG hardly |
| [2417](#L2417) | ]; |
| [2418](#L2418) | } else { |
| [2419](#L2419) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/uploads/wpforms/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2420](#L2420) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/uploads/gravity\_forms/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2421](#L2421) | $ac[] = '\*\*\*ABSPATH\*\*\*/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2422](#L2422) | $ac[] = '\*\*\*ABSPATH\*\*\*/logs/traffic.html/.md5sums'; // Binary broken file of wpforms |
| [2423](#L2423) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-config.php'; // Exclude wp-config.php permanently |
| [2424](#L2424) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/backup-migration-config.php'; // Exclude BMI CONFIG hardly |
| [2425](#L2425) | } |
| [2426](#L2426) |  |
| [2427](#L2427) | $temp\_is = false; |
| [2428](#L2428) | if ($is == false) { |
| [2429](#L2429) | $temp\_is = true; |
| [2430](#L2430) | } |
| [2431](#L2431) |  |
| [2432](#L2432) | if (($is && $acis) || $temp\_is) { |
| [2433](#L2433) | foreach ($ac as $key => $value) { |
| [2434](#L2434) | $value = str\_replace('\*\*\*ABSPATH\*\*\*', untrailingslashit(ABSPATH), $value); |
| [2435](#L2435) | $value = BMP::fixSlashes($value); |
| [2436](#L2436) | $acres->{$value} = 1; |
| [2437](#L2437) | } |
| [2438](#L2438) | } |
| [2439](#L2439) |  |
| [2440](#L2440) | if ($is && $abis) { |
| [2441](#L2441) | for ($i = 0; $i < sizeof($ab); ++$i) { |
| [2442](#L2442) | $s = $ab[$i]; |
| [2443](#L2443) | if ($s->whr == '1') { |
| [2444](#L2444) | $abres[] = ['s' => $s->txt, 'w' => $s->pos, 'z' => strlen($s->txt)]; |
| [2445](#L2445) | } |
| [2446](#L2446) | } |
| [2447](#L2447) | } |
| [2448](#L2448) |  |
| [2449](#L2449) | $limitcrl = 64; |
| [2450](#L2450) | if ($dirCalc && defined('BMI\_CLI\_ENABLED') && BMI\_CLI\_ENABLED === true && !defined('BMI\_CLI\_FAILED')) $limitcrl = 128; |
| [2451](#L2451) | $first\_big = false; |
| [2452](#L2452) | $sizemax = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:SIZE:IN'); |
| [2453](#L2453) | $usesize = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:SIZE') === 'true' && $is) ? true : false; |
| [2454](#L2454) | if (!is\_numeric($sizemax)) { |
| [2455](#L2455) | $usesize = false; |
| [2456](#L2456) | $sizemax = 99999; |
| [2457](#L2457) | } else { |
| [2458](#L2458) | $sizemax = intval($sizemax); |
| [2459](#L2459) | } |
| [2460](#L2460) |  |
| [2461](#L2461) | // If legacy === false it will use background process to bypass the timeout |
| [2462](#L2462) | if ($dirCalc) { |
| [2463](#L2463) | $legacy = true; |
| [2464](#L2464) | } else { |
| [2465](#L2465) | if (!defined('BMI\_LEGACY\_VERSION')) $legacy = true; |
| [2466](#L2466) | else $legacy = BMI\_LEGACY\_VERSION; |
| [2467](#L2467) | if ($legacy && defined('BMI\_LEGACY\_HARD\_VERSION') && !BMI\_LEGACY\_HARD\_VERSION) $legacy = BMI\_LEGACY\_HARD\_VERSION; |
| [2468](#L2468) | if (defined('BMI\_CLI\_ENABLED') && defined('BMI\_FUNCTION\_NORMAL') && BMI\_CLI\_ENABLED === true && BMI\_FUNCTION\_NORMAL === true && !defined('BMI\_CLI\_FAILED')) $legacy = false; |
| [2469](#L2469) | } |
| [2470](#L2470) |  |
| [2471](#L2471) | $total\_size = 0; |
| [2472](#L2472) | $excludedBytes = 0; |
| [2473](#L2473) | $max = $sizemax \* (1024 \* 1024); |
| [2474](#L2474) | $maxfor = sizeof($files); |
| [2475](#L2475) |  |
| [2476](#L2476) | // Non-legacy variables |
| [2477](#L2477) | if ($legacy === false) { |
| [2478](#L2478) | $Hx = trailingslashit(WP\_CONTENT\_DIR); |
| [2479](#L2479) | $Hz = trailingslashit(ABSPATH); |
| [2480](#L2480) | $Hxs = strlen($Hx); |
| [2481](#L2481) | $Hzs = strlen($Hz); |
| [2482](#L2482) | } |
| [2483](#L2483) |  |
| [2484](#L2484) | // Sort it by size |
| [2485](#L2485) | if ($legacy === false) { |
| [2486](#L2486) | usort($files, function ($a, $b) { |
| [2487](#L2487) | $a = explode(',', $a); |
| [2488](#L2488) | $last = sizeof($a) - 1; |
| [2489](#L2489) | $sizea = intval($a[$last]); |
| [2490](#L2490) |  |
| [2491](#L2491) | $b = explode(',', $b); |
| [2492](#L2492) | $last = sizeof($b) - 1; |
| [2493](#L2493) | $sizeb = intval($b[$last]); |
| [2494](#L2494) |  |
| [2495](#L2495) | if ($sizea == $sizeb) return 0; |
| [2496](#L2496) | if ($sizea < $sizeb) return -1; |
| [2497](#L2497) | else return 1; |
| [2498](#L2498) | }); |
| [2499](#L2499) | } |
| [2500](#L2500) |  |
| [2501](#L2501) | // Process due to rules |
| [2502](#L2502) | for ($i = 0; $i < $maxfor; ++$i) { |
| [2503](#L2503) |  |
| [2504](#L2504) | // Remove size from path and get the size |
| [2505](#L2505) | $files[$i] = explode(',', $files[$i]); |
| [2506](#L2506) | $last = sizeof($files[$i]) - 1; |
| [2507](#L2507) | $size = intval($files[$i][$last]); |
| [2508](#L2508) | unset($files[$i][$last]); |
| [2509](#L2509) | $files[$i] = implode(',', $files[$i]); |
| [2510](#L2510) |  |
| [2511](#L2511) | if ($usesize && Scanner::fileTooLarge($size, $max)) { |
| [2512](#L2512) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (too large) ", 'backup-backup') . $files[$i] . ' (' . number\_format(($size / 1024 / 1024), 2) . ' MB)', 'WARN'); |
| [2513](#L2513) | array\_splice($files, $i, 1); |
| [2514](#L2514) | $maxfor--; |
| [2515](#L2515) | $i--; |
| [2516](#L2516) |  |
| [2517](#L2517) | $excludedBytes += $size; |
| [2518](#L2518) | continue; |
| [2519](#L2519) | } |
| [2520](#L2520) |  |
| [2521](#L2521) | if ($abis && Scanner::equalFolder(basename($files[$i]), $abres)) { |
| [2522](#L2522) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (due to exclude rules): ", 'backup-backup') . $files[$i], 'WARN'); |
| [2523](#L2523) | array\_splice($files, $i, 1); |
| [2524](#L2524) | $maxfor--; |
| [2525](#L2525) | $i--; |
| [2526](#L2526) |  |
| [2527](#L2527) | $excludedBytes += $size; |
| [2528](#L2528) | continue; |
| [2529](#L2529) | } |
| [2530](#L2530) |  |
| [2531](#L2531) | if ($acis && property\_exists($acres, $files[$i])) { |
| [2532](#L2532) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (due to path rules): ", 'backup-backup') . $files[$i], 'WARN'); |
| [2533](#L2533) | array\_splice($files, $i, 1); |
| [2534](#L2534) | $maxfor--; |
| [2535](#L2535) | $i--; |
| [2536](#L2536) |  |
| [2537](#L2537) | $excludedBytes += $size; |
| [2538](#L2538) | continue; |
| [2539](#L2539) | } |
| [2540](#L2540) |  |
| [2541](#L2541) | if ($size === 0) { |
| [2542](#L2542) | array\_splice($files, $i, 1); |
| [2543](#L2543) | $maxfor--; |
| [2544](#L2544) | $i--; |
| [2545](#L2545) |  |
| [2546](#L2546) | $excludedBytes += $size; |
| [2547](#L2547) | continue; |
| [2548](#L2548) | } |
| [2549](#L2549) |  |
| [2550](#L2550) | if (strpos($files[$i], 'bmi-pclzip-') !== false) { |
| [2551](#L2551) | array\_splice($files, $i, 1); |
| [2552](#L2552) | $maxfor--; |
| [2553](#L2553) | $i--; |
| [2554](#L2554) |  |
| [2555](#L2555) | $excludedBytes += $size; |
| [2556](#L2556) | continue; |
| [2557](#L2557) | } |
| [2558](#L2558) |  |
| [2559](#L2559) | if ($size > ($limitcrl \* (1024 \* 1024))) { |
| [2560](#L2560) | if ($first\_big === false) $first\_big = $i; |
| [2561](#L2561) | if (!$dirCalc) $progress->log(\_\_("This file is quite big consider to exclude it, if backup fails: ", 'backup-backup') . $files[$i] . ' (' . BMP::humanSize($size) . ')', 'WARN'); |
| [2562](#L2562) | } |
| [2563](#L2563) |  |
| [2564](#L2564) | if (($legacy === false && (BMI\_FUNCTION\_NORMAL === false || (BMI\_FUNCTION\_NORMAL === true && BMI\_CLI\_ENABLED === true))) && (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false)) { |
| [2565](#L2565) | $fx = strpos($files[$i], $Hx); |
| [2566](#L2566) | $fz = strpos($files[$i], $Hz); |
| [2567](#L2567) |  |
| [2568](#L2568) | if ($fx !== false) $files[$i] = substr\_replace($files[$i], '@1@', $fx, $Hxs); |
| [2569](#L2569) | else if ($fz !== false) $files[$i] = substr\_replace($files[$i], '@2@', $fz, $Hzs); |
| [2570](#L2570) |  |
| [2571](#L2571) | $files[$i] .= ',' . $size; |
| [2572](#L2572) | } |
| [2573](#L2573) | $total\_size += $size; |
| [2574](#L2574) | } |
| [2575](#L2575) |  |
| [2576](#L2576) | if ($legacy === false && (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false)) { |
| [2577](#L2577) | $list\_file = BMI\_TMP . DIRECTORY\_SEPARATOR . 'files\_latest.list'; |
| [2578](#L2578) | if (file\_exists($list\_file)) @unlink($list\_file); |
| [2579](#L2579) | $files\_list = fopen($list\_file, 'a'); |
| [2580](#L2580) | if ($first\_big === false) fwrite($files\_list, sizeof($files) . "\_-1\r\n"); |
| [2581](#L2581) | else fwrite($files\_list, sizeof($files) . '\_' . $first\_big . "\r\n"); |
| [2582](#L2582) | for ($i = 0; $i < sizeof($files); ++$i) { |
| [2583](#L2583) | fwrite($files\_list, $files[$i] . "\r\n"); |
| [2584](#L2584) | } |
| [2585](#L2585) | fclose($files\_list); |
| [2586](#L2586) | $this->first\_big = $first\_big; |
| [2587](#L2587) | } |
| [2588](#L2588) |  |
| [2589](#L2589) | $total\_size += $this->getDatabaseSize(); |
| [2590](#L2590) | $this->total\_excluded\_size\_for\_backup = $excludedBytes; |
| [2591](#L2591) | $this->total\_size\_for\_backup = $total\_size; |
| [2592](#L2592) | $this->total\_size\_for\_backup\_in\_mb = ($total\_size / 1024 / 1024); |
| [2593](#L2593) |  |
| [2594](#L2594) | return $files; |
| [2595](#L2595) | } |
| [2596](#L2596) |  |
| [2597](#L2597) | public function toggleBackupLock($unlock = false) { |
| [2598](#L2598) |  |
| [2599](#L2599) | // Require lib |
| [2600](#L2600) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'zipper' . DIRECTORY\_SEPARATOR . 'zipping.php'; |
| [2601](#L2601) |  |
| [2602](#L2602) | // Backup name |
| [2603](#L2603) | $filename = $this->post['filename']; |
| [2604](#L2604) |  |
| [2605](#L2605) | // Init Zipper |
| [2606](#L2606) | $zipper = new Zipper(); |
| [2607](#L2607) |  |
| [2608](#L2608) | // Path to Backup |
| [2609](#L2609) | $path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $filename; |
| [2610](#L2610) | $path\_dir = BMP::fixSlashes(dirname($path)); |
| [2611](#L2611) |  |
| [2612](#L2612) | // Check if file exists |
| [2613](#L2613) | if (!file\_exists($path)) { |
| [2614](#L2614) | return ['status' => 'fail']; |
| [2615](#L2615) | } |
| [2616](#L2616) |  |
| [2617](#L2617) | // Check if directory is correct |
| [2618](#L2618) | if ($path\_dir != BMP::fixSlashes(BMI\_BACKUPS)) { |
| [2619](#L2619) | return ['status' => 'fail']; |
| [2620](#L2620) | } |
| [2621](#L2621) |  |
| [2622](#L2622) | // Toggle the lock |
| [2623](#L2623) | $status = $zipper->lock\_zip($path, $unlock); |
| [2624](#L2624) |  |
| [2625](#L2625) | // Return the status |
| [2626](#L2626) | return ['status' => ($status ? 'success' : 'fail')]; |
| [2627](#L2627) | } |
| [2628](#L2628) |  |
| [2629](#L2629) | public function getDynamicNames() { |
| [2630](#L2630) | $data = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2631](#L2631) | $fpdata = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS:IN'); |
| [2632](#L2632) | $fddata = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS:IN'); |
| [2633](#L2633) |  |
| [2634](#L2634) | for ($i = 0; $i < sizeof($fpdata); ++$i) { |
| [2635](#L2635) | $fpdata[$i] = BMP::fixSlashes($fpdata[$i]); |
| [2636](#L2636) | } |
| [2637](#L2637) |  |
| [2638](#L2638) | for ($i = 0; $i < sizeof($fddata); ++$i) { |
| [2639](#L2639) | $fddata[$i] = BMP::fixSlashes($fddata[$i]); |
| [2640](#L2640) | } |
| [2641](#L2641) |  |
| [2642](#L2642) | return [ |
| [2643](#L2643) | 'status' => 'success', |
| [2644](#L2644) | 'dynamic-fpaths-names' => $fpdata, |
| [2645](#L2645) | 'dynamic-dpaths-names' => $fddata, |
| [2646](#L2646) | 'data' => $data |
| [2647](#L2647) | ]; |
| [2648](#L2648) | } |
| [2649](#L2649) |  |
| [2650](#L2650) | public function resetConfiguration() { |
| [2651](#L2651) |  |
| [2652](#L2652) | if (file\_exists(BMI\_CONFIG\_PATH)) { |
| [2653](#L2653) | @unlink(BMI\_CONFIG\_PATH); |
| [2654](#L2654) | } |
| [2655](#L2655) |  |
| [2656](#L2656) | delete\_option('bmi\_hotfixes'); |
| [2657](#L2657) | delete\_option('bmip\_to\_be\_uploaded'); |
| [2658](#L2658) | delete\_option('bmi\_pro\_gd\_client\_id'); |
| [2659](#L2659) | delete\_option('bmi\_pro\_gd\_token'); |
| [2660](#L2660) | delete\_option('bmi\_pro\_cron\_domain\_done'); |
| [2661](#L2661) | delete\_option('BMI::STORAGE::LOCAL::PATH'); |
| [2662](#L2662) |  |
| [2663](#L2663) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'unknown'); |
| [2664](#L2664) |  |
| [2665](#L2665) | return ['status' => 'success']; |
| [2666](#L2666) |  |
| [2667](#L2667) | } |
| [2668](#L2668) |  |
| [2669](#L2669) | public function getSiteData() { |
| [2670](#L2670) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'check' . DIRECTORY\_SEPARATOR . 'system\_info.php'; |
| [2671](#L2671) | $bmi = new SI(); |
| [2672](#L2672) | $bmi = $bmi->to\_array(); |
| [2673](#L2673) |  |
| [2674](#L2674) | return ['status' => 'success', 'data' => $bmi]; |
| [2675](#L2675) | } |
| [2676](#L2676) |  |
| [2677](#L2677) | public function calculateCron() { |
| [2678](#L2678) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'cron' . DIRECTORY\_SEPARATOR . 'handler.php'; |
| [2679](#L2679) |  |
| [2680](#L2680) | $minutes = []; |
| [2681](#L2681) | $keeps = []; |
| [2682](#L2682) | $days = []; |
| [2683](#L2683) | $weeks = []; |
| [2684](#L2684) | $hours = []; |
| [2685](#L2685) |  |
| [2686](#L2686) | for ($i = 1; $i <= 28; ++$i) { |
| [2687](#L2687) | $days[] = substr('0' . $i, -2); |
| [2688](#L2688) | } |
| [2689](#L2689) | for ($i = 1; $i <= 7; ++$i) { |
| [2690](#L2690) | $weeks[] = $i . ''; |
| [2691](#L2691) | } |
| [2692](#L2692) | for ($i = 0; $i <= 23; ++$i) { |
| [2693](#L2693) | $hours[] = substr('0' . $i, -2); |
| [2694](#L2694) | } |
| [2695](#L2695) | for ($i = 0; $i <= 55; $i += 5) { |
| [2696](#L2696) | $minutes[] = substr('0' . $i, -2); |
| [2697](#L2697) | } |
| [2698](#L2698) | for ($i = 1; $i <= 20; ++$i) { |
| [2699](#L2699) | $keeps[] = $i . ''; |
| [2700](#L2700) | } |
| [2701](#L2701) |  |
| [2702](#L2702) | $errors = 0; |
| [2703](#L2703) | if (in\_array($this->post['type'], ['month', 'week', 'day'])) { |
| [2704](#L2704) | if (!Dashboard\bmi\_set\_config('CRON:TYPE', $this->post['type'])) { |
| [2705](#L2705) | $errors++; |
| [2706](#L2706) | } |
| [2707](#L2707) | } |
| [2708](#L2708) | if (in\_array($this->post['day'], $days)) { |
| [2709](#L2709) | if (!Dashboard\bmi\_set\_config('CRON:DAY', $this->post['day'])) { |
| [2710](#L2710) | $errors++; |
| [2711](#L2711) | } |
| [2712](#L2712) | } |
| [2713](#L2713) | if (in\_array($this->post['week'], $weeks)) { |
| [2714](#L2714) | if (!Dashboard\bmi\_set\_config('CRON:WEEK', $this->post['week'])) { |
| [2715](#L2715) | $errors++; |
| [2716](#L2716) | } |
| [2717](#L2717) | } |
| [2718](#L2718) | if (in\_array($this->post['hour'], $hours)) { |
| [2719](#L2719) | if (!Dashboard\bmi\_set\_config('CRON:HOUR', $this->post['hour'])) { |
| [2720](#L2720) | $errors++; |
| [2721](#L2721) | } |
| [2722](#L2722) | } |
| [2723](#L2723) | if (in\_array($this->post['minute'], $minutes)) { |
| [2724](#L2724) | if (!Dashboard\bmi\_set\_config('CRON:MINUTE', $this->post['minute'])) { |
| [2725](#L2725) | $errors++; |
| [2726](#L2726) | } |
| [2727](#L2727) | } |
| [2728](#L2728) | if (in\_array($this->post['keep'], $keeps)) { |
| [2729](#L2729) | if (!Dashboard\bmi\_set\_config('CRON:KEEP', $this->post['keep'])) { |
| [2730](#L2730) | $errors++; |
| [2731](#L2731) | } |
| [2732](#L2732) | } |
| [2733](#L2733) |  |
| [2734](#L2734) | if ($this->post['enabled'] === 'true') { |
| [2735](#L2735) | $this->post['enabled'] = true; |
| [2736](#L2736) | } else { |
| [2737](#L2737) | $this->post['enabled'] = false; |
| [2738](#L2738) | } |
| [2739](#L2739) |  |
| [2740](#L2740) | if (!Dashboard\bmi\_set\_config('CRON:ENABLED', $this->post['enabled'])) { |
| [2741](#L2741) | $errors++; |
| [2742](#L2742) | } |
| [2743](#L2743) |  |
| [2744](#L2744) | if ($errors === 0) { |
| [2745](#L2745) | $time = Crons::calculate\_date([ |
| [2746](#L2746) | 'type' => $this->post['type'], |
| [2747](#L2747) | 'week' => $this->post['week'], |
| [2748](#L2748) | 'day' => $this->post['day'], |
| [2749](#L2749) | 'hour' => $this->post['hour'], |
| [2750](#L2750) | 'minute' => $this->post['minute'] |
| [2751](#L2751) | ], time()); |
| [2752](#L2752) |  |
| [2753](#L2753) | $file = BMI\_TMP . DIRECTORY\_SEPARATOR . '.plan'; |
| [2754](#L2754) | if (file\_exists($file)) { |
| [2755](#L2755) | $earlier = intval(file\_get\_contents($file)); |
| [2756](#L2756) | } else { |
| [2757](#L2757) | $earlier = 0; |
| [2758](#L2758) | } |
| [2759](#L2759) |  |
| [2760](#L2760) | if (!wp\_next\_scheduled('bmi\_do\_backup\_right\_now') || $earlier === 0 || (abs($time - $earlier) >= 15)) { |
| [2761](#L2761) | wp\_clear\_scheduled\_hook('bmi\_do\_backup\_right\_now'); |
| [2762](#L2762) | if ($this->post['enabled'] === true) { |
| [2763](#L2763) | wp\_schedule\_single\_event($time, 'bmi\_do\_backup\_right\_now'); |
| [2764](#L2764) | file\_put\_contents($file, $time); |
| [2765](#L2765) | } |
| [2766](#L2766) | } |
| [2767](#L2767) |  |
| [2768](#L2768) | return [ |
| [2769](#L2769) | 'status' => 'success', |
| [2770](#L2770) | 'data' => date('Y-m-d H:i:s', $time), |
| [2771](#L2771) | 'currdata' => date('Y-m-d H:i:s') |
| [2772](#L2772) | ]; |
| [2773](#L2773) | } else { |
| [2774](#L2774) | return ['status' => 'error']; |
| [2775](#L2775) | } |
| [2776](#L2776) | } |
| [2777](#L2777) |  |
| [2778](#L2778) | public function dismissErrorNotice() { |
| [2779](#L2779) | delete\_option('bmi\_display\_email\_issues'); |
| [2780](#L2780) | } |
| [2781](#L2781) |  |
| [2782](#L2782) | // recursive removal |
| [2783](#L2783) | private function rrmdir($dir) { |
| [2784](#L2784) |  |
| [2785](#L2785) | if (is\_dir($dir)) { |
| [2786](#L2786) |  |
| [2787](#L2787) | $objects = scandir($dir); |
| [2788](#L2788) | foreach ($objects as $object) { |
| [2789](#L2789) |  |
| [2790](#L2790) | if ($object != "." && $object != "..") { |
| [2791](#L2791) |  |
| [2792](#L2792) | if (is\_dir($dir . DIRECTORY\_SEPARATOR . $object) && !is\_link($dir . DIRECTORY\_SEPARATOR . $object)) { |
| [2793](#L2793) |  |
| [2794](#L2794) | $this->rrmdir($dir . DIRECTORY\_SEPARATOR . $object); |
| [2795](#L2795) |  |
| [2796](#L2796) | } else { |
| [2797](#L2797) |  |
| [2798](#L2798) | @unlink($dir . DIRECTORY\_SEPARATOR . $object); |
| [2799](#L2799) |  |
| [2800](#L2800) | } |
| [2801](#L2801) |  |
| [2802](#L2802) | } |
| [2803](#L2803) |  |
| [2804](#L2804) | } |
| [2805](#L2805) |  |
| [2806](#L2806) | @rmdir($dir); |
| [2807](#L2807) |  |
| [2808](#L2808) | } else { |
| [2809](#L2809) |  |
| [2810](#L2810) | if (file\_exists($dir) && is\_file($dir)) { |
| [2811](#L2811) |  |
| [2812](#L2812) | @unlink($dir); |
| [2813](#L2813) |  |
| [2814](#L2814) | } |
| [2815](#L2815) |  |
| [2816](#L2816) | } |
| [2817](#L2817) |  |
| [2818](#L2818) | } |
| [2819](#L2819) |  |
| [2820](#L2820) | public function forceBackupToStop() { |
| [2821](#L2821) |  |
| [2822](#L2822) | $filesToBeRemoved = []; |
| [2823](#L2823) |  |
| [2824](#L2824) | $tmp\_dir = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp'; |
| [2825](#L2825) | if (!is\_dir($tmp\_dir)) @mkdir($tmp\_dir, 0755, true); |
| [2826](#L2826) |  |
| [2827](#L2827) | foreach (scandir($tmp\_dir) as $filename) { |
| [2828](#L2828) |  |
| [2829](#L2829) | if (in\_array($filename, ['.', '..'])) continue; |
| [2830](#L2830) | $path = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp' . DIRECTORY\_SEPARATOR . $filename; |
| [2831](#L2831) | $filesToBeRemoved[] = $path; |
| [2832](#L2832) |  |
| [2833](#L2833) | } |
| [2834](#L2834) |  |
| [2835](#L2835) | $allowedFiles = ['wp-config.php', '.htaccess', '.litespeed', '.default.json', 'driveKeys.php', '.autologin.php', '.migrationFinished']; |
| [2836](#L2836) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . '.\*') as $filename) { |
| [2837](#L2837) |  |
| [2838](#L2838) | $basename = basename($filename); |
| [2839](#L2839) |  |
| [2840](#L2840) | if (in\_array($basename, ['.', '..'])) continue; |
| [2841](#L2841) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2842](#L2842) | $filesToBeRemoved[] = $filename; |
| [2843](#L2843) | } |
| [2844](#L2844) |  |
| [2845](#L2845) | } |
| [2846](#L2846) |  |
| [2847](#L2847) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'BMI-\*', GLOB\_ONLYDIR) as $filename) { |
| [2848](#L2848) |  |
| [2849](#L2849) | $basename = basename($filename); |
| [2850](#L2850) |  |
| [2851](#L2851) | if (in\_array($basename, ['.', '..'])) continue; |
| [2852](#L2852) | if (is\_dir($filename) && !in\_array($filename, $allowedFiles)) { |
| [2853](#L2853) | $filesToBeRemoved[] = $filename; |
| [2854](#L2854) | } |
| [2855](#L2855) |  |
| [2856](#L2856) | } |
| [2857](#L2857) |  |
| [2858](#L2858) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'bg-BMI-\*', GLOB\_ONLYDIR) as $filename) { |
| [2859](#L2859) |  |
| [2860](#L2860) | $basename = basename($filename); |
| [2861](#L2861) |  |
| [2862](#L2862) | if (in\_array($basename, ['.', '..'])) continue; |
| [2863](#L2863) | if (is\_dir($filename) && !in\_array($filename, $allowedFiles)) { |
| [2864](#L2864) | $filesToBeRemoved[] = $filename; |
| [2865](#L2865) | } |
| [2866](#L2866) |  |
| [2867](#L2867) | } |
| [2868](#L2868) |  |
| [2869](#L2869) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock'; |
| [2870](#L2870) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock\_ended'; |
| [2871](#L2871) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock\_end'; |
| [2872](#L2872) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'; |
| [2873](#L2873) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'db\_tables'; |
| [2874](#L2874) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'bmi\_backup\_manifest.json'; |
| [2875](#L2875) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'files\_latest.list'; |
| [2876](#L2876) |  |
| [2877](#L2877) | if (is\_array($filesToBeRemoved) || is\_object($filesToBeRemoved)) { |
| [2878](#L2878) | foreach ((array) $filesToBeRemoved as $file) { |
| [2879](#L2879) | $this->rrmdir($file); |
| [2880](#L2880) | } |
| [2881](#L2881) | } |
| [2882](#L2882) |  |
| [2883](#L2883) | return ['status' => 'success']; |
| [2884](#L2884) |  |
| [2885](#L2885) | } |
| [2886](#L2886) |  |
| [2887](#L2887) | public function forceRestoreToStop() { |
| [2888](#L2888) |  |
| [2889](#L2889) | $filesToBeRemoved = []; |
| [2890](#L2890) |  |
| [2891](#L2891) | $themedir = get\_theme\_root(); |
| [2892](#L2892) | $tempTheme = $themedir . DIRECTORY\_SEPARATOR . 'backup\_migration\_restoration\_in\_progress'; |
| [2893](#L2893) | $filesToBeRemoved[] = $tempTheme; |
| [2894](#L2894) |  |
| [2895](#L2895) | $tmpDirectory = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp'; |
| [2896](#L2896) | if (!is\_dir($tmpDirectory)) @mkdir($tmpDirectory, 0755, true); |
| [2897](#L2897) |  |
| [2898](#L2898) | foreach (scandir($tmpDirectory) as $filename) { |
| [2899](#L2899) |  |
| [2900](#L2900) | if (in\_array($filename, ['.', '..'])) continue; |
| [2901](#L2901) | $path = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp' . DIRECTORY\_SEPARATOR . $filename; |
| [2902](#L2902) | $filesToBeRemoved[] = $path; |
| [2903](#L2903) |  |
| [2904](#L2904) | } |
| [2905](#L2905) |  |
| [2906](#L2906) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'backup-migration\_??????????') as $filename) { |
| [2907](#L2907) |  |
| [2908](#L2908) | $basename = basename($filename); |
| [2909](#L2909) |  |
| [2910](#L2910) | if (is\_dir($filename) && !in\_array($basename, ['.', '..'])) { |
| [2911](#L2911) | $filesToBeRemoved[] = $filename; |
| [2912](#L2912) | } |
| [2913](#L2913) |  |
| [2914](#L2914) | } |
| [2915](#L2915) |  |
| [2916](#L2916) | $allowedFiles = ['wp-config.php', '.htaccess', '.litespeed', '.default.json', 'driveKeys.php', '.autologin.php', '.migrationFinished']; |
| [2917](#L2917) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . '.\*') as $filename) { |
| [2918](#L2918) |  |
| [2919](#L2919) | $basename = basename($filename); |
| [2920](#L2920) |  |
| [2921](#L2921) | if (in\_array($basename, ['.', '..'])) continue; |
| [2922](#L2922) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2923](#L2923) | $filesToBeRemoved[] = $filename; |
| [2924](#L2924) | } |
| [2925](#L2925) |  |
| [2926](#L2926) | } |
| [2927](#L2927) |  |
| [2928](#L2928) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'restore\_scan\_\*') as $filename) { |
| [2929](#L2929) |  |
| [2930](#L2930) | $basename = basename($filename); |
| [2931](#L2931) |  |
| [2932](#L2932) | if (in\_array($basename, ['.', '..'])) continue; |
| [2933](#L2933) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2934](#L2934) | $filesToBeRemoved[] = $filename; |
| [2935](#L2935) | } |
| [2936](#L2936) |  |
| [2937](#L2937) | } |
| [2938](#L2938) |  |
| [2939](#L2939) | foreach (glob(untrailingslashit(ABSPATH) . DIRECTORY\_SEPARATOR . 'wp-config.??????????.php') as $filename) { |
| [2940](#L2940) |  |
| [2941](#L2941) | $basename = basename($filename); |
| [2942](#L2942) |  |
| [2943](#L2943) | if (in\_array($basename, ['.', '..'])) continue; |
| [2944](#L2944) | if (is\_file($filename) && !in\_array($filename, $allowedFiles)) { |
| [2945](#L2945) | $filesToBeRemoved[] = $filename; |
| [2946](#L2946) | } |
| [2947](#L2947) |  |
| [2948](#L2948) | } |
| [2949](#L2949) |  |
| [2950](#L2950) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock'; |
| [2951](#L2951) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_cli'; |
| [2952](#L2952) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_cli\_end'; |
| [2953](#L2953) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_ended'; |
| [2954](#L2954) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.cli\_download\_last'; |
| [2955](#L2955) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'; |
| [2956](#L2956) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . '.restore\_secret'; |
| [2957](#L2957) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . '.table\_map'; |
| [2958](#L2958) |  |
| [2959](#L2959) | if (is\_array($filesToBeRemoved) || is\_object($filesToBeRemoved)) { |
| [2960](#L2960) | foreach ((array) $filesToBeRemoved as $file) { |
| [2961](#L2961) | $this->rrmdir($file); |
| [2962](#L2962) | } |
| [2963](#L2963) | } |
| [2964](#L2964) |  |
| [2965](#L2965) | return ['status' => 'success']; |
| [2966](#L2966) |  |
| [2967](#L2967) | } |
| [2968](#L2968) |  |
| [2969](#L2969) | public function sendTroubleshootingDetails($send\_type = 'manual', $triggeredBy = false, $blocking = true) { |
| [2970](#L2970) |  |
| [2971](#L2971) | global $table\_prefix; |
| [2972](#L2972) |  |
| [2973](#L2973) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'check' . DIRECTORY\_SEPARATOR . 'system\_info.php'; |
| [2974](#L2974) | $bmiSiteData = new SI(); |
| [2975](#L2975) | $bmiSiteData = $bmiSiteData->to\_array(); |
| [2976](#L2976) | $bmiSiteData['database\_size'] = $this->getDatabaseSize(); |
| [2977](#L2977) | $bmiSiteData['database\_size\_mb'] = BMP::humanSize($bmiSiteData['database\_size']); |
| [2978](#L2978) | $bmiSiteData['xhria'] = get\_option('z\_\_bmi\_xhria', 'none'); |
| [2979](#L2979) | $bmiSiteData['current\_table\_prefix'] = $table\_prefix; |
| [2980](#L2980) |  |
| [2981](#L2981) | $wpconfigPath = ABSPATH . DIRECTORY\_SEPARATOR . 'wp-config.php'; |
| [2982](#L2982) | if (file\_exists($wpconfigPath)) { |
| [2983](#L2983) | $bmiSiteData['is\_wp\_config\_writable'] = is\_writable($wpconfigPath) ? "yes" : "no"; |
| [2984](#L2984) | } else { |
| [2985](#L2985) | $bmiSiteData['is\_wp\_config\_writable'] = "file\_does\_not\_exist?"; |
| [2986](#L2986) | } |
| [2987](#L2987) |  |
| [2988](#L2988) | $latestBackupLogs = 'does\_not\_exist'; |
| [2989](#L2989) | $latestBackupProgress = 'does\_not\_exist'; |
| [2990](#L2990) | $latestRestorationLogs = 'does\_not\_exist'; |
| [2991](#L2991) | $latestRestorationProgress = 'does\_not\_exist'; |
| [2992](#L2992) | $latestStagingLogs = 'does\_not\_exist'; |
| [2993](#L2993) | $latestStagingProgress = 'does\_not\_exist'; |
| [2994](#L2994) | $currentPluginConfig = 'does\_not\_exist'; |
| [2995](#L2995) | $pluginGlobalLogs = 'does\_not\_exist'; |
| [2996](#L2996) | $backgroundErrors = 'does\_not\_exist'; |
| [2997](#L2997) |  |
| [2998](#L2998) | if (file\_exists(BMI\_BACKUPS . '/latest.log')) { |
| [2999](#L2999) | $latestBackupLogs = file\_get\_contents(BMI\_BACKUPS . '/latest.log'); |
| [3000](#L3000) | } |
| [3001](#L3001) |  |
| [3002](#L3002) | if (file\_exists(BMI\_BACKUPS . '/latest\_progress.log')) { |
| [3003](#L3003) | $latestBackupProgress = file\_get\_contents(BMI\_BACKUPS . '/latest\_progress.log'); |
| [3004](#L3004) | } |
| [3005](#L3005) |  |
| [3006](#L3006) | if (file\_exists(BMI\_BACKUPS . '/latest\_migration.log')) { |
| [3007](#L3007) | $latestRestorationLogs = file\_get\_contents(BMI\_BACKUPS . '/latest\_migration.log'); |
| [3008](#L3008) | } |
| [3009](#L3009) |  |
| [3010](#L3010) | if (file\_exists(BMI\_BACKUPS . '/latest\_migration\_progress.log')) { |
| [3011](#L3011) | $latestRestorationProgress = file\_get\_contents(BMI\_BACKUPS . '/latest\_migration\_progress.log'); |
| [3012](#L3012) | } |
| [3013](#L3013) |  |
| [3014](#L3014) | if (file\_exists(BMI\_STAGING . '/latest\_staging.log')) { |
| [3015](#L3015) | $latestStagingLogs = file\_get\_contents(BMI\_STAGING . '/latest\_staging.log'); |
| [3016](#L3016) | } |
| [3017](#L3017) |  |
| [3018](#L3018) | if (file\_exists(BMI\_STAGING . '/latest\_staging\_progress.log')) { |
| [3019](#L3019) | $latestStagingProgress = file\_get\_contents(BMI\_STAGING . '/latest\_staging\_progress.log'); |
| [3020](#L3020) | } |
| [3021](#L3021) |  |
| [3022](#L3022) | if (file\_exists(BMI\_CONFIG\_PATH)) { |
| [3023](#L3023) | $currentPluginConfig = substr(file\_get\_contents(BMI\_CONFIG\_PATH), 8); |
| [3024](#L3024) | } |
| [3025](#L3025) |  |
| [3026](#L3026) | $completeLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'complete\_logs.log'; |
| [3027](#L3027) | if (file\_exists($completeLogsPath)) { |
| [3028](#L3028) | if ((filesize($completeLogsPath) / 1024 / 1024) <= 4) { |
| [3029](#L3029) | $pluginGlobalLogs = file\_get\_contents($completeLogsPath); |
| [3030](#L3030) | } else { |
| [3031](#L3031) | @unlink($completeLogsPath); |
| [3032](#L3032) | @touch($completeLogsPath); |
| [3033](#L3033) | $pluginGlobalLogs = 'file\_too\_large'; |
| [3034](#L3034) | } |
| [3035](#L3035) | } |
| [3036](#L3036) |  |
| [3037](#L3037) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [3038](#L3038) | if (file\_exists($backgroundLogsPath)) { |
| [3039](#L3039) | if ((filesize($backgroundLogsPath) / 1024 / 1024) <= 4) { |
| [3040](#L3040) | $backgroundErrors = file\_get\_contents($backgroundLogsPath); |
| [3041](#L3041) | } else { |
| [3042](#L3042) | @unlink($backgroundLogsPath); |
| [3043](#L3043) | @touch($backgroundLogsPath); |
| [3044](#L3044) | $backgroundErrors = 'file\_too\_large'; |
| [3045](#L3045) | } |
| [3046](#L3046) | } |
| [3047](#L3047) |  |
| [3048](#L3048) | $ifCLI = false; |
| [3049](#L3049) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [3050](#L3050) | $ifCLI = true; |
| [3051](#L3051) | } |
| [3052](#L3052) |  |
| [3053](#L3053) | $logsSourceFrontEnd = 'manual'; |
| [3054](#L3054) | if ($triggeredBy != false) { |
| [3055](#L3055) | $logsSourceFrontEnd = $triggeredBy; |
| [3056](#L3056) | } |
| [3057](#L3057) | if (isset($this->post['source']) && in\_array($this->post['source'], ['backup', 'migration', 'staging'])) { |
| [3058](#L3058) | $logsSourceFrontEnd = $this->post['source']; |
| [3059](#L3059) | } |
| [3060](#L3060) |  |
| [3061](#L3061) | $url = 'https://' . BMI\_API\_BACKUPBLISS\_PUSH . '/v1' . '/push'; |
| [3062](#L3062) | $data = array( |
| [3063](#L3063) | 'method' => 'POST', |
| [3064](#L3064) | 'timeout' => 15, |
| [3065](#L3065) | 'blocking' => $blocking, |
| [3066](#L3066) | 'sslverify' => false, |
| [3067](#L3067) | 'send\_type' => $send\_type, |
| [3068](#L3068) | 'body' => array( |
| [3069](#L3069) | 'admin\_url' => admin\_url(), |
| [3070](#L3070) | 'home\_url' => home\_url(), |
| [3071](#L3071) | 'site\_url' => get\_site\_url(), |
| [3072](#L3072) | 'is\_multisite' => is\_multisite() ? "yes" : "no", |
| [3073](#L3073) | 'is\_abspath\_writable' => is\_writable(ABSPATH) ? "yes" : "no", |
| [3074](#L3074) | 'site\_information' => $bmiSiteData, |
| [3075](#L3075) | 'latest\_backup\_logs' => $latestBackupLogs, |
| [3076](#L3076) | 'latest\_backup\_progress' => $latestBackupProgress, |
| [3077](#L3077) | 'latest\_restoration\_logs' => $latestRestorationLogs, |
| [3078](#L3078) | 'latest\_restoration\_progress' => $latestRestorationProgress, |
| [3079](#L3079) | 'latest\_staging\_logs' => $latestStagingLogs, |
| [3080](#L3080) | 'latest\_staging\_progress' => $latestStagingProgress, |
| [3081](#L3081) | 'current\_plugin\_config' => $currentPluginConfig, |
| [3082](#L3082) | 'plugin\_global\_logs' => $pluginGlobalLogs, |
| [3083](#L3083) | 'background\_errors' => $backgroundErrors, |
| [3084](#L3084) | 'triggered\_by' => $logsSourceFrontEnd, |
| [3085](#L3085) | 'is\_defined' => defined('BMI\_BACKUP\_PRO') ? 'yes' : 'no', |
| [3086](#L3086) | 'is\_cli' => $ifCLI |
| [3087](#L3087) | ) |
| [3088](#L3088) | ); |
| [3089](#L3089) |  |
| [3090](#L3090) | $disabled\_functions = explode(',', ini\_get('disable\_functions')); |
| [3091](#L3091) | $vA = !in\_array('curl\_exec', $disabled\_functions); |
| [3092](#L3092) | $vB = !in\_array('curl\_init', $disabled\_functions); |
| [3093](#L3093) | $vC = !in\_array('http\_build\_query', $disabled\_functions); |
| [3094](#L3094) | $vD = !in\_array('stream\_context\_create', $disabled\_functions); |
| [3095](#L3095) | $vE = !in\_array('file\_get\_contents', $disabled\_functions); |
| [3096](#L3096) | $vF = false; |
| [3097](#L3097) | $response = false; |
| [3098](#L3098) |  |
| [3099](#L3099) | if (function\_exists('curl\_version') && function\_exists('curl\_exec') && function\_exists('curl\_init') && $vA && $vB) { |
| [3100](#L3100) |  |
| [3101](#L3101) | $response = wp\_remote\_post($url, $data); |
| [3102](#L3102) |  |
| [3103](#L3103) | } else { |
| [3104](#L3104) |  |
| [3105](#L3105) | if (ini\_get('allow\_url\_fopen') == true && $vC && $vD && $vE) { |
| [3106](#L3106) |  |
| [3107](#L3107) | $vF = true; |
| [3108](#L3108) | $postdata = http\_build\_query($data['body']); |
| [3109](#L3109) |  |
| [3110](#L3110) | $opts = [ |
| [3111](#L3111) | 'ssl' => [ 'verify\_peer\_name' => false, 'verify\_peer' => false ], |
| [3112](#L3112) | 'http' => [ |
| [3113](#L3113) | 'method'  => 'POST', |
| [3114](#L3114) | 'header'  => 'Content-type: application/x-www-form-urlencoded', |
| [3115](#L3115) | 'content' => $postdata |
| [3116](#L3116) | ] |
| [3117](#L3117) | ]; |
| [3118](#L3118) |  |
| [3119](#L3119) | $context  = stream\_context\_create($opts); |
| [3120](#L3120) | $result = file\_get\_contents($url, false, $context); |
| [3121](#L3121) |  |
| [3122](#L3122) | $response = [ 'body' => $result ]; |
| [3123](#L3123) |  |
| [3124](#L3124) | } |
| [3125](#L3125) |  |
| [3126](#L3126) | } |
| [3127](#L3127) |  |
| [3128](#L3128) | if ($response === false || is\_wp\_error($response)) { |
| [3129](#L3129) | $error\_message = $response->get\_error\_message(); |
| [3130](#L3130) | Logger::error($error\_message, 'backup-backup'); |
| [3131](#L3131) | return ['status' => 'fail']; |
| [3132](#L3132) | } else { |
| [3133](#L3133) | try { |
| [3134](#L3134) | $body = json\_decode($response['body']); |
| [3135](#L3135) | if (isset($body->code)) { |
| [3136](#L3136) | return ['status' => 'success', 'code' => sanitize\_text\_field($body->code)]; |
| [3137](#L3137) | } else { |
| [3138](#L3138) | return ['status' => 'fail']; |
| [3139](#L3139) | } |
| [3140](#L3140) | } catch (\Exception $e) { |
| [3141](#L3141) | Logger::error(print\_r($e, true), 'backup-backup'); |
| [3142](#L3142) | return ['status' => 'fail']; |
| [3143](#L3143) | } catch (\Throwable $t) { |
| [3144](#L3144) | Logger::error(print\_r($t, true), 'backup-backup'); |
| [3145](#L3145) | return ['status' => 'fail']; |
| [3146](#L3146) | } |
| [3147](#L3147) | } |
| [3148](#L3148) |  |
| [3149](#L3149) | } |
| [3150](#L3150) |  |
| [3151](#L3151) | public function actionsAfterProcess($success = false, $triggeredBy = 'backup') { |
| [3152](#L3152) |  |
| [3153](#L3153) | $afterMigrationLock = BMI\_TMP . DIRECTORY\_SEPARATOR . '.migrationFinished'; |
| [3154](#L3154) |  |
| [3155](#L3155) | if ($success) { |
| [3156](#L3156) |  |
| [3157](#L3157) | file\_put\_contents($afterMigrationLock, ''); |
| [3158](#L3158) |  |
| [3159](#L3159) | } else { |
| [3160](#L3160) |  |
| [3161](#L3161) | if (file\_exists($afterMigrationLock)) @unlink($afterMigrationLock); |
| [3162](#L3162) |  |
| [3163](#L3163) | } |
| [3164](#L3164) |  |
| [3165](#L3165) | BMP::handle\_after\_cron(); |
| [3166](#L3166) |  |
| [3167](#L3167) | return null; |
| [3168](#L3168) |  |
| [3169](#L3169) | // REMOVED CODE: |
| [3170](#L3170) | // $canShare = BMP::canShareLogsOrShouldAsk(); |
| [3171](#L3171) | // if ($canShare === 'allowed') { |
| [3172](#L3172) | // |
| [3173](#L3173) | //   $send\_type = 'error'; |
| [3174](#L3174) | //   if ($success) $send\_type = 'success'; |
| [3175](#L3175) | //   $this->sendTroubleshootingDetails($send\_type, $triggeredBy, false); |
| [3176](#L3176) | // |
| [3177](#L3177) | // } |
| [3178](#L3178) |  |
| [3179](#L3179) | } |
| [3180](#L3180) |  |
| [3181](#L3181) | public function logSharing() { |
| [3182](#L3182) |  |
| [3183](#L3183) | $type = $this->post['question']; |
| [3184](#L3184) |  |
| [3185](#L3185) | if ($type == 'set\_yes') { |
| [3186](#L3186) |  |
| [3187](#L3187) | // $isOk = Dashboard\bmi\_set\_config('LOGS::SHARING', 'yes'); |
| [3188](#L3188) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'yes'); |
| [3189](#L3189) | return ['status' => 'success']; |
| [3190](#L3190) |  |
| [3191](#L3191) | } else if ($type == 'set\_no') { |
| [3192](#L3192) |  |
| [3193](#L3193) | // $isOk = Dashboard\bmi\_set\_config('LOGS::SHARING', 'no'); |
| [3194](#L3194) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'no'); |
| [3195](#L3195) | return ['status' => 'success']; |
| [3196](#L3196) |  |
| [3197](#L3197) | } else if ($type == 'is\_allowed') { |
| [3198](#L3198) |  |
| [3199](#L3199) | // $canShare = BMP::canShareLogsOrShouldAsk(); |
| [3200](#L3200) | // return ['status' => 'success', 'result' => $canShare]; |
| [3201](#L3201) | return ['status' => 'success', 'result' => 'not-allowed']; |
| [3202](#L3202) |  |
| [3203](#L3203) | } else { |
| [3204](#L3204) |  |
| [3205](#L3205) | return ['status' => 'fail']; |
| [3206](#L3206) |  |
| [3207](#L3207) | } |
| [3208](#L3208) |  |
| [3209](#L3209) | } |
| [3210](#L3210) |  |
| [3211](#L3211) | public function getLatestBackupFile() { |
| [3212](#L3212) |  |
| [3213](#L3213) | $dir = BMI\_BACKUPS; |
| [3214](#L3214) | $backupdir = array\_diff(scandir($dir), ['..', '.']); |
| [3215](#L3215) | $backups = []; |
| [3216](#L3216) | foreach ($backupdir as $index => $name) { |
| [3217](#L3217) |  |
| [3218](#L3218) | $ext = pathinfo($dir . DIRECTORY\_SEPARATOR . $name, PATHINFO\_EXTENSION); |
| [3219](#L3219) |  |
| [3220](#L3220) | if ($ext === 'zip') { |
| [3221](#L3221) | $backups[] = [ |
| [3222](#L3222) | 'cdate' => filemtime($dir . DIRECTORY\_SEPARATOR . $name), |
| [3223](#L3223) | 'name' => $name |
| [3224](#L3224) | ]; |
| [3225](#L3225) | } |
| [3226](#L3226) |  |
| [3227](#L3227) | } |
| [3228](#L3228) |  |
| [3229](#L3229) | usort($backups, function ($a, $b) { |
| [3230](#L3230) | if (intval($a['cdate']) < intval($b['cdate'])) return 1; |
| [3231](#L3231) | else return -1; |
| [3232](#L3232) | }); |
| [3233](#L3233) |  |
| [3234](#L3234) | $backups = array\_values($backups); |
| [3235](#L3235) |  |
| [3236](#L3236) | if (sizeof($backups) > 0) { |
| [3237](#L3237) | return $backups[0]['name']; |
| [3238](#L3238) | } else { |
| [3239](#L3239) | return '---'; |
| [3240](#L3240) | } |
| [3241](#L3241) |  |
| [3242](#L3242) | } |
| [3243](#L3243) |  |
| [3244](#L3244) | /\*\* |
| [3245](#L3245) | \* isStagingSiteCreationOngoing - Checks if the process is ongoing or not |
| [3246](#L3246) | \* |
| [3247](#L3247) | \* @return {bool} true if the process is running false if its not |
| [3248](#L3248) | \*/ |
| [3249](#L3249) | public function isStagingSiteCreationOngoing() { |
| [3250](#L3250) |  |
| [3251](#L3251) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3252](#L3252) | if (file\_exists($staging\_lock) && (time() - filemtime($staging\_lock)) <= 15) { |
| [3253](#L3253) | return true; |
| [3254](#L3254) | } else { |
| [3255](#L3255) | return false; |
| [3256](#L3256) | } |
| [3257](#L3257) |  |
| [3258](#L3258) | } |
| [3259](#L3259) |  |
| [3260](#L3260) | /\*\* |
| [3261](#L3261) | \* checkStagingLocalName - Verifies name of staging site and checks if it's not currently running |
| [3262](#L3262) | \* Can be called for verification pre start or during start on initial request |
| [3263](#L3263) | \* |
| [3264](#L3264) | \* @param  {string} $name = false name of staging site if called without ajax |
| [3265](#L3265) | \* @return {array} with status/fail/progress data |
| [3266](#L3266) | \*/ |
| [3267](#L3267) | public function checkStagingLocalName($name = false) { |
| [3268](#L3268) |  |
| [3269](#L3269) | if ($name == false && isset($this->post['name'])) { |
| [3270](#L3270) | $name = $this->post['name']; |
| [3271](#L3271) | } |
| [3272](#L3272) |  |
| [3273](#L3273) | $ongoing = \_\_('Staging site creation is already ongoing, please wait and try again.', 'backup-backup'); |
| [3274](#L3274) | $empty = \_\_('You have to provide some staging site name before process.', 'backup-backup'); |
| [3275](#L3275) | $toolong = \_\_('Staging site name cannot be longer than 24 characters.', 'backup-backup'); |
| [3276](#L3276) | $invalid = \_\_('Provided name contains prohibited characters.', 'backup-backup'); |
| [3277](#L3277) | $blacklisted = \_\_('This name is not allowed to be used, please pick different one.', 'backup-backup'); |
| [3278](#L3278) | $exist = \_\_('Seems like directory or staging site with that name already exist, pick different one.', 'backup-backup'); |
| [3279](#L3279) | $dashes = \_\_('Name cannot start or end with dash or underscore.', 'backup-backup'); |
| [3280](#L3280) |  |
| [3281](#L3281) | if ($this->isStagingSiteCreationOngoing()) { |
| [3282](#L3282) | return ['status' => 'fail', 'message' => $ongoing]; |
| [3283](#L3283) | } |
| [3284](#L3284) |  |
| [3285](#L3285) | if (strlen($name) <= 0) { |
| [3286](#L3286) | return ['status' => 'fail', 'message' => $empty]; |
| [3287](#L3287) | } |
| [3288](#L3288) |  |
| [3289](#L3289) | if (!preg\_match('/^[a-zA-Z0-9-\_]+$/', $name)) { |
| [3290](#L3290) | return ['status' => 'fail', 'message' => $invalid]; |
| [3291](#L3291) | } |
| [3292](#L3292) |  |
| [3293](#L3293) | if (strlen($name) >= 24) { |
| [3294](#L3294) | return ['status' => 'fail', 'message' => $toolong]; |
| [3295](#L3295) | } |
| [3296](#L3296) |  |
| [3297](#L3297) | if (in\_array($name[0], ['\_', '-']) || in\_array($name[strlen($name) - 1], ['\_', '-'])) { |
| [3298](#L3298) | return ['status' => 'fail', 'message' => $dashes]; |
| [3299](#L3299) | } |
| [3300](#L3300) |  |
| [3301](#L3301) | $bannedNames = [ |
| [3302](#L3302) | 'wp-content', |
| [3303](#L3303) | 'wp-admin', |
| [3304](#L3304) | 'wp-includes', |
| [3305](#L3305) | 'content', |
| [3306](#L3306) | 'admin', |
| [3307](#L3307) | 'includes', |
| [3308](#L3308) | 'tmp', |
| [3309](#L3309) | '.well-known', |
| [3310](#L3310) | 'download', |
| [3311](#L3311) | 'downloads', |
| [3312](#L3312) | 'google', |
| [3313](#L3313) | 'temporary' |
| [3314](#L3314) | ]; |
| [3315](#L3315) |  |
| [3316](#L3316) | if (strpos($name, '.') !== false) { |
| [3317](#L3317) | return ['status' => 'fail', 'message' => $blacklisted]; |
| [3318](#L3318) | } |
| [3319](#L3319) |  |
| [3320](#L3320) | if (in\_array($name, $bannedNames)) { |
| [3321](#L3321) | return ['status' => 'fail', 'message' => $blacklisted]; |
| [3322](#L3322) | } |
| [3323](#L3323) |  |
| [3324](#L3324) | $path = trailingslashit(ABSPATH) . $name; |
| [3325](#L3325) | if (file\_exists($path) || is\_dir($path)) { |
| [3326](#L3326) | return ['status' => 'fail', 'message' => $exist]; |
| [3327](#L3327) | } |
| [3328](#L3328) |  |
| [3329](#L3329) | return ['status' => 'success']; |
| [3330](#L3330) |  |
| [3331](#L3331) | } |
| [3332](#L3332) |  |
| [3333](#L3333) | /\*\* |
| [3334](#L3334) | \* startLocalStagingCreation - Initials creation of staging site process |
| [3335](#L3335) | \* |
| [3336](#L3336) | \* @return {array} with status/fail/progress data |
| [3337](#L3337) | \*/ |
| [3338](#L3338) | public function startLocalStagingCreation() { |
| [3339](#L3339) |  |
| [3340](#L3340) | // Verification of state |
| [3341](#L3341) | $name = $this->post['name']; |
| [3342](#L3342) | $verification = $this->checkStagingLocalName($name); |
| [3343](#L3343) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3344](#L3344) |  |
| [3345](#L3345) | // Fail in case of wrong data or state |
| [3346](#L3346) | if (isset($verification['status']) && $verification['status'] != 'success') { |
| [3347](#L3347) | return $verification; |
| [3348](#L3348) | } |
| [3349](#L3349) |  |
| [3350](#L3350) | // Update lock file to prevent double processes |
| [3351](#L3351) | touch($staging\_lock); |
| [3352](#L3352) |  |
| [3353](#L3353) | // Include local staging site controller |
| [3354](#L3354) | require\_once BMI\_INCLUDES . '/staging/local.php'; |
| [3355](#L3355) | $staging = new StagingLocal($name, true); |
| [3356](#L3356) |  |
| [3357](#L3357) | // Append the return if staging process requires more batches |
| [3358](#L3358) | if ($staging->continue == true) return $staging->continuationData; |
| [3359](#L3359) |  |
| [3360](#L3360) | return [ 'status' => 'continue', 'data' => [ 'name' => $name ] ]; |
| [3361](#L3361) |  |
| [3362](#L3362) | } |
| [3363](#L3363) |  |
| [3364](#L3364) | /\*\* |
| [3365](#L3365) | \* stagingSitesGetList - Returns staging sites list |
| [3366](#L3366) | \* |
| [3367](#L3367) | \* @return {array} with staging sites data |
| [3368](#L3368) | \*/ |
| [3369](#L3369) | public function stagingSitesGetList() { |
| [3370](#L3370) |  |
| [3371](#L3371) | // Include local staging site controller |
| [3372](#L3372) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3373](#L3373) | $staging = new Staging('..ajax..'); |
| [3374](#L3374) | $sites = $staging->getStagingSites(); |
| [3375](#L3375) |  |
| [3376](#L3376) | return [ 'status' => 'success', 'sites' => $sites ]; |
| [3377](#L3377) |  |
| [3378](#L3378) | } |
| [3379](#L3379) |  |
| [3380](#L3380) | /\*\* |
| [3381](#L3381) | \* stagingRename - Renames display name |
| [3382](#L3382) | \* |
| [3383](#L3383) | \* @return {array} status |
| [3384](#L3384) | \*/ |
| [3385](#L3385) | public function stagingRename() { |
| [3386](#L3386) |  |
| [3387](#L3387) | $name = $this->post['name']; |
| [3388](#L3388) | $newName = $this->post['new']; |
| [3389](#L3389) |  |
| [3390](#L3390) | // Include local staging site controller |
| [3391](#L3391) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3392](#L3392) | $staging = new Staging('..ajax..'); |
| [3393](#L3393) | return $staging->rename($name, $newName); |
| [3394](#L3394) |  |
| [3395](#L3395) | } |
| [3396](#L3396) |  |
| [3397](#L3397) | /\*\* |
| [3398](#L3398) | \* stagingPrepareLogin - Prepares login script |
| [3399](#L3399) | \* |
| [3400](#L3400) | \* @return {array} login credentials |
| [3401](#L3401) | \*/ |
| [3402](#L3402) | public function stagingPrepareLogin() { |
| [3403](#L3403) |  |
| [3404](#L3404) | $name = $this->post['name']; |
| [3405](#L3405) |  |
| [3406](#L3406) | // Include local staging site controller |
| [3407](#L3407) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3408](#L3408) | $staging = new Staging('..ajax..'); |
| [3409](#L3409) | return $staging->prepareLogin($name); |
| [3410](#L3410) |  |
| [3411](#L3411) | } |
| [3412](#L3412) |  |
| [3413](#L3413) | /\*\* |
| [3414](#L3414) | \* Handles ajax error on browser side, keep alive timeout etc. |
| [3415](#L3415) | \* |
| [3416](#L3416) | \* @return array static success |
| [3417](#L3417) | \*/ |
| [3418](#L3418) | public function frontEndAjaxError() { |
| [3419](#L3419) |  |
| [3420](#L3420) | if ($this->post['call'] == 'create-backup') { |
| [3421](#L3421) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [3422](#L3422) | $logger = new Progress('', 0, 0, false, false); |
| [3423](#L3423) | } else if (in\_array($this->post['call'], ['restore-backup', 'download-backup', 'continue\_restore\_process'])) { |
| [3424](#L3424) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [3425](#L3425) | $logger = new MigrationProgress(true); |
| [3426](#L3426) | } else if (in\_array($this->post['call'], ['staging-start-local-creation', 'staging-local-creation-process', 'staging-tastewp-creation-process'])) { |
| [3427](#L3427) | require\_once BMI\_INCLUDES . '/progress/staging.php'; |
| [3428](#L3428) | $logger = new StagingProgress(true); |
| [3429](#L3429) | } |
| [3430](#L3430) |  |
| [3431](#L3431) | if (isset($this->post['error'])) { |
| [3432](#L3432) |  |
| [3433](#L3433) | Logger::error('Front End Ajax Error START'); |
| [3434](#L3434) | if (isset($logger)) $logger->log('Front End Ajax Error START', 'verbose'); |
| [3435](#L3435) |  |
| [3436](#L3436) | if (is\_array($this->post['error'])) { |
| [3437](#L3437) |  |
| [3438](#L3438) | $errors = $this->post['error']; |
| [3439](#L3439) | foreach ($errors as $k => $val) { |
| [3440](#L3440) | $error = sanitize\_text\_field(print\_r($val, true)); |
| [3441](#L3441) | Logger::error($k . ' = ' . $error); |
| [3442](#L3442) | if (isset($logger)) $logger->log($k . ' = ' . $error, 'verbose'); |
| [3443](#L3443) | } |
| [3444](#L3444) |  |
| [3445](#L3445) | } else { |
| [3446](#L3446) |  |
| [3447](#L3447) | $theError = sanitize\_text\_field(print\_r($this->post->error, true)); |
| [3448](#L3448) | Logger::error('Front End Ajax Error: ' . $theError); |
| [3449](#L3449) | if (isset($logger)) $logger->log($theError, 'verbose'); |
| [3450](#L3450) |  |
| [3451](#L3451) | } |
| [3452](#L3452) |  |
| [3453](#L3453) | Logger::error('Front End Ajax Error END'); |
| [3454](#L3454) | if (isset($logger)) $logger->log('Front End Ajax Error END', 'verbose'); |
| [3455](#L3455) |  |
| [3456](#L3456) | } else { |
| [3457](#L3457) |  |
| [3458](#L3458) | Logger::error('Front End Ajax Error was called, but no error included.'); |
| [3459](#L3459) |  |
| [3460](#L3460) | } |
| [3461](#L3461) |  |
| [3462](#L3462) | if (isset($logger)) { |
| [3463](#L3463) | $logger->log(\_\_('Browser-side error detected, the process will try to restart with alternative methods, otherwise it will throw error window.', 'backup-backup'), 'error'); |
| [3464](#L3464) | $logger->log('Browser-side error detected, the process will try to restart with alternative methods, otherwise it will throw error window.', 'verbose'); |
| [3465](#L3465) | } |
| [3466](#L3466) |  |
| [3467](#L3467) | return [ 'status' => 'success' ]; |
| [3468](#L3468) |  |
| [3469](#L3469) | } |
| [3470](#L3470) |  |
| [3471](#L3471) | /\*\* |
| [3472](#L3472) | \* stagingDelete - Removes the staging site |
| [3473](#L3473) | \* |
| [3474](#L3474) | \* @return {array} status |
| [3475](#L3475) | \*/ |
| [3476](#L3476) | public function stagingDelete() { |
| [3477](#L3477) |  |
| [3478](#L3478) | $name = $this->post['name']; |
| [3479](#L3479) |  |
| [3480](#L3480) | // Include local staging site controller |
| [3481](#L3481) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3482](#L3482) | $staging = new Staging('..ajax..'); |
| [3483](#L3483) | return $staging->delete($name); |
| [3484](#L3484) |  |
| [3485](#L3485) | } |
| [3486](#L3486) |  |
| [3487](#L3487) | /\*\* |
| [3488](#L3488) | \* localStagingCreationProcess - Method that can continue batching of Staging process |
| [3489](#L3489) | \* |
| [3490](#L3490) | \* @return {array} data that should be send back to this function as POST |
| [3491](#L3491) | \*/ |
| [3492](#L3492) | public function localStagingCreationProcess() { |
| [3493](#L3493) |  |
| [3494](#L3494) | // Get $name and declare lock file |
| [3495](#L3495) | $name = $this->post['name']; |
| [3496](#L3496) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3497](#L3497) |  |
| [3498](#L3498) | // Update lock file to prevent double processes |
| [3499](#L3499) | touch($staging\_lock); |
| [3500](#L3500) |  |
| [3501](#L3501) | // Include local staging site controller |
| [3502](#L3502) | require\_once BMI\_INCLUDES . '/staging/local.php'; |
| [3503](#L3503) | $staging = new StagingLocal($name); |
| [3504](#L3504) |  |
| [3505](#L3505) | // Process handler |
| [3506](#L3506) | if (isset($this->post['delete'])) { |
| [3507](#L3507) | $staging->requestDelete(); |
| [3508](#L3508) | } else $staging->continue(); |
| [3509](#L3509) |  |
| [3510](#L3510) | // Append the return if staging process requires more batches |
| [3511](#L3511) | if ($staging->continue == true) return $staging->continuationData; |
| [3512](#L3512) |  |
| [3513](#L3513) | // Send success if nothing went wrong which finishes the process |
| [3514](#L3514) | if (file\_exists($staging\_lock)) @unlink($staging\_lock); |
| [3515](#L3515) | return ['status' => 'error']; |
| [3516](#L3516) |  |
| [3517](#L3517) | } |
| [3518](#L3518) |  |
| [3519](#L3519) | /\*\* |
| [3520](#L3520) | \* tastewpStagingCreation - Initializes and declares staging site will |
| [3521](#L3521) | \* |
| [3522](#L3522) | \* @return {array} batching status |
| [3523](#L3523) | \*/ |
| [3524](#L3524) | public function tastewpStagingCreation() { |
| [3525](#L3525) |  |
| [3526](#L3526) | // Get $name and declare lock file |
| [3527](#L3527) | $name = $this->post['name']; |
| [3528](#L3528) | $backupName = isset($this->post['backupName']) ? $this->post['backupName'] : false; |
| [3529](#L3529) | $initialize = isset($this->post['initialize']) ? $this->post['initialize'] : false; |
| [3530](#L3530) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3531](#L3531) |  |
| [3532](#L3532) | // Fix var type |
| [3533](#L3533) | if ($initialize === true || $initialize == 'true') $initialize = true; |
| [3534](#L3534) | else $initialize = false; |
| [3535](#L3535) |  |
| [3536](#L3536) | // Update lock file to prevent double processes |
| [3537](#L3537) | touch($staging\_lock); |
| [3538](#L3538) |  |
| [3539](#L3539) | // Include TasteWP staging site controller |
| [3540](#L3540) | require\_once BMI\_INCLUDES . '/staging/tastewp.php'; |
| [3541](#L3541) |  |
| [3542](#L3542) | // Process handler |
| [3543](#L3543) | if (isset($this->post['delete'])) { |
| [3544](#L3544) | $delete = true; |
| [3545](#L3545) | } else $delete = false; |
| [3546](#L3546) |  |
| [3547](#L3547) | // Make first handshake with TasteWP |
| [3548](#L3548) | $staging = new StagingTasteWP($name, $initialize, $backupName, $delete); |
| [3549](#L3549) |  |
| [3550](#L3550) | // Append the return if staging process requires more batches |
| [3551](#L3551) | if ($staging->continue == true) return $staging->continuationData; |
| [3552](#L3552) |  |
| [3553](#L3553) | // Send success if nothing went wrong which finishes the process |
| [3554](#L3554) | if (file\_exists($staging\_lock)) @unlink($staging\_lock); |
| [3555](#L3555) | return ['status' => 'error']; |
| [3556](#L3556) |  |
| [3557](#L3557) | } |
| [3558](#L3558) |  |
| [3559](#L3559) | public function debugging() { |
| [3560](#L3560) |  |
| [3561](#L3561) | } |
| [3562](#L3562) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/backup-backup/tags/1.3.9/includes/ajax.php?format=txt)
* [Original Format](/export/3222696/backup-backup/tags/1.3.9/includes/ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_0f094016_20250115_090308.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Backup Migration <= 1.3.9 - Authenticated (Admin+) OS Command Injection via url

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Backup Migration <= 1.3.9 - Authenticated (Admin+) OS Command Injection via url

7.2

**Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-7002](https://www.cve.org/CVERecord?id=CVE-2023-7002) |
| --- | --- |
| CVSS | 7.2 (High) |
| Publicly Published | December 22, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Françoa Taffarel](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/francoataffarel) |

### Description

The Backup Migration plugin for WordPress is vulnerable to OS Command Injection in all versions up to, and including, 1.3.9 via the 'url' parameter. This vulnerability allows authenticated attackers, with administrator-level permissions and above, to execute arbitrary commands on the host operating system.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/backup-backup/tags/1.3.9/includes/ajax.php#L88)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/backup-backup/tags/1.3.9/includes/ajax.php#L1518)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/backup-backup/tags/1.3.9/includes/ajax.php#L1503)
* [www.linuxquestions.org](https://www.linuxquestions.org/questions/linux-security-4/php-function-exec-enabled-how-big-issue-4175508082/)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3012745/backup-backup)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbackup-backup%2Fbackup-migration-139-authenticated-admin-os-command-injection-via-url&t=Backup%20Migration%20%3C%3D%201.3.9%20-%20Authenticated%20%28Admin%2B%29%20OS%20Command%20Injection%20via%20url "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbackup-backup%2Fbackup-migration-139-authenticated-admin-os-command-injection-via-url&text=Backup%20Migration%20%3C%3D%201.3.9%20-%20Authenticated%20%28Admin%2B%29%20OS%20Command%20Injection%20via%20url "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fbackup-backup%2Fbackup-migration-139-authenticated-admin-os-command-injection-via-url "LinkedIn")
Email

## Vulnerability Details for Backup Migration

#### [Backup Migration](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/backup-backup)

| Software Type | Plugin |
| --- | --- |
| Software Slug | backup-backup [(view on wordpress.org)](https://wordpress.org/plugins/backup-backup) |
| Patched? | Yes |
| Remediation | Update to version 1.4.0, or a newer patched version |
| Affected Version | * <= 1.3.9 |
| Patched Version | * 1.4.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_601974df_20250115_090250.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbackup-backup%2Ftags%2F1.3.9%2Fincludes%2Fajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/backup-backup/tags/1.3.9/includes/ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/backup-backup/tags/1.3.9/includes/ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [backup-backup](/browser/backup-backup?order=name "View backup-backup")/[tags](/browser/backup-backup/tags?order=name "View tags")/[1.3.9](/browser/backup-backup/tags/1.3.9?order=name "View 1.3.9")/[includes](/browser/backup-backup/tags/1.3.9/includes?order=name "View includes")/[ajax.php](/browser/backup-backup/tags/1.3.9/includes/ajax.php?order=name "View ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3010013/backup-backup/tags/1.3.9/includes/ajax.php "View differences") on this file was [3010013](/changeset/3010013/ "View changeset 3010013"), checked in by iclyde, [13 months ago](/timeline?from=2023-12-14T12%3A49%3A30Z&precision=second "See timeline at 12/14/2023 12:49:30 PM") |
| --- |
| Version 1.3.9 |
| **File size:** 137.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | // Namespace |
| [4](#L4) | namespace BMI\Plugin; |
| [5](#L5) |  |
| [6](#L6) | // Exit on direct access |
| [7](#L7) | if (!defined('ABSPATH')) exit; |
| [8](#L8) |  |
| [9](#L9) | // Uses |
| [10](#L10) | use BMI\Plugin\Backup\_Migration\_Plugin as BMP; |
| [11](#L11) | use BMI\Plugin\BMI\_Logger as Logger; |
| [12](#L12) | use BMI\Plugin\Checker\BMI\_Checker as Checker; |
| [13](#L13) | use BMI\Plugin\Checker\System\_Info as SI; |
| [14](#L14) | use BMI\Plugin\CRON\BMI\_Crons as Crons; |
| [15](#L15) | use BMI\Plugin\Dashboard as Dashboard; |
| [16](#L16) | use BMI\Plugin\Extracter\BMI\_Extracter as Extracter; |
| [17](#L17) | use BMI\Plugin\Progress\BMI\_MigrationProgress as MigrationProgress; |
| [18](#L18) | use BMI\Plugin\Progress\BMI\_ZipProgress as Progress; |
| [19](#L19) | use BMI\Plugin\Progress\BMI\_StagingProgress as StagingProgress; |
| [20](#L20) | use BMI\Plugin\Scanner\BMI\_BackupsScanner as Backups; |
| [21](#L21) | use BMI\Plugin\Scanner\BMI\_FileScanner as Scanner; |
| [22](#L22) | use BMI\Plugin\Zipper\BMI\_Zipper as Zipper; |
| [23](#L23) | use BMI\Plugin\PHPCLI\Checker as PHPCLICheck; |
| [24](#L24) | use BMI\Plugin\External\BMI\_External\_Storage as ExternalStorage; |
| [25](#L25) | use BMI\Plugin\Staging\BMI\_Staging\_TasteWP as StagingTasteWP; |
| [26](#L26) | use BMI\Plugin\Staging\BMI\_StagingLocal as StagingLocal; |
| [27](#L27) | use BMI\Plugin\Staging\BMI\_Staging as Staging; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Ajax Handler for BMI |
| [31](#L31) | \*/ |
| [32](#L32) | class BMI\_Ajax { |
| [33](#L33) |  |
| [34](#L34) | public $post; |
| [35](#L35) | public $zip\_progress; |
| [36](#L36) | public $migration\_progress; |
| [37](#L37) | public $lock\_cli; |
| [38](#L38) | public $lastCurlCode; |
| [39](#L39) |  |
| [40](#L40) | public $total\_size\_for\_backup = 0; |
| [41](#L41) | public $total\_size\_for\_backup\_in\_mb = 0; |
| [42](#L42) | public $total\_excluded\_size\_for\_backup = 0; |
| [43](#L43) |  |
| [44](#L44) | public function \_\_construct($initializedWithCLI = false) { |
| [45](#L45) |  |
| [46](#L46) | // Return if it's not post |
| [47](#L47) | if (empty($\_POST)) { |
| [48](#L48) | return; |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | // Sanitize User Input |
| [52](#L52) | $this->post = BMP::sanitize($\_POST); |
| [53](#L53) |  |
| [54](#L54) | // Check nonce |
| [55](#L55) | if (check\_ajax\_referer('backup-migration-ajax', 'nonce', false) === false && $initializedWithCLI === false) { |
| [56](#L56) | return wp\_send\_json\_error(['reason' => 'not authorized request']); |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | // Log Handler Call (Verbose) |
| [60](#L60) | Logger::debug(\_\_("Running POST Function: ", 'backup-backup') . $this->post['f']); |
| [61](#L61) |  |
| [62](#L62) | // Create backup folder |
| [63](#L63) | if (!file\_exists(BMI\_BACKUPS)) { |
| [64](#L64) | mkdir(BMI\_BACKUPS, 0755, true); |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | // Create background logs file |
| [68](#L68) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [69](#L69) | if (!file\_exists($backgroundLogsPath)) { |
| [70](#L70) | @touch($backgroundLogsPath); |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | // Handle User Request If Known And Sanitize Response |
| [74](#L74) | if ($this->post['f'] == 'scan-directory') { |
| [75](#L75) | BMP::res($this->dirSize()); |
| [76](#L76) | } elseif ($this->post['f'] == 'create-backup') { |
| [77](#L77) | BMP::res($this->prepareAndMakeBackup()); |
| [78](#L78) | } elseif ($this->post['f'] == 'reset-latest') { |
| [79](#L79) | BMP::res($this->resetLatestLogs()); |
| [80](#L80) | } elseif ($this->post['f'] == 'get-current-backups') { |
| [81](#L81) | BMP::res($this->getBackupsList()); |
| [82](#L82) | } elseif ($this->post['f'] == 'restore-backup') { |
| [83](#L83) | BMP::res($this->restoreBackup()); |
| [84](#L84) | } elseif ($this->post['f'] == 'is-running-backup') { |
| [85](#L85) | BMP::res($this->isRunningBackup()); |
| [86](#L86) | } elseif ($this->post['f'] == 'stop-backup') { |
| [87](#L87) | BMP::res($this->stopBackup()); |
| [88](#L88) | } elseif ($this->post['f'] == 'download-backup') { |
| [89](#L89) | BMP::res($this->handleQuickMigration()); |
| [90](#L90) | } elseif ($this->post['f'] == 'migration-locked') { |
| [91](#L91) | BMP::res($this->isMigrationLocked()); |
| [92](#L92) | } elseif ($this->post['f'] == 'upload-backup') { |
| [93](#L93) | BMP::res($this->handleChunkUpload()); |
| [94](#L94) | } elseif ($this->post['f'] == 'delete-backup') { |
| [95](#L95) | BMP::res($this->removeBackupFile()); |
| [96](#L96) | } elseif ($this->post['f'] == 'save-storage') { |
| [97](#L97) | BMP::res($this->saveStorageConfig()); |
| [98](#L98) | } elseif ($this->post['f'] == 'save-file-config') { |
| [99](#L99) | BMP::res($this->saveFilesConfig()); |
| [100](#L100) | } elseif ($this->post['f'] == 'save-other-options') { |
| [101](#L101) | BMP::res($this->saveOtherOptions()); |
| [102](#L102) | } elseif ($this->post['f'] == 'store-config') { |
| [103](#L103) | BMP::res($this->saveStorageTypeConfig()); |
| [104](#L104) | } elseif ($this->post['f'] == 'unlock-backup') { |
| [105](#L105) | BMP::res($this->toggleBackupLock(true)); |
| [106](#L106) | } elseif ($this->post['f'] == 'lock-backup') { |
| [107](#L107) | BMP::res($this->toggleBackupLock(false)); |
| [108](#L108) | } elseif ($this->post['f'] == 'get-dynamic-names') { |
| [109](#L109) | BMP::res($this->getDynamicNames()); |
| [110](#L110) | } elseif ($this->post['f'] == 'reset-configuration') { |
| [111](#L111) | BMP::res($this->resetConfiguration()); |
| [112](#L112) | } elseif ($this->post['f'] == 'get-site-data') { |
| [113](#L113) | BMP::res($this->getSiteData()); |
| [114](#L114) | } elseif ($this->post['f'] == 'send-test-mail') { |
| [115](#L115) | BMP::res($this->sendTestMail()); |
| [116](#L116) | } elseif ($this->post['f'] == 'calculate-cron') { |
| [117](#L117) | BMP::res($this->calculateCron()); |
| [118](#L118) | } elseif ($this->post['f'] == 'dismiss-error-notice') { |
| [119](#L119) | BMP::res($this->dismissErrorNotice()); |
| [120](#L120) | } elseif ($this->post['f'] == 'fix\_uname\_issues') { |
| [121](#L121) | BMP::res($this->fixUnameFunction()); |
| [122](#L122) | } elseif ($this->post['f'] == 'revert\_uname\_issues') { |
| [123](#L123) | BMP::res($this->revertUnameProcess()); |
| [124](#L124) | } elseif ($this->post['f'] == 'continue\_restore\_process') { |
| [125](#L125) | BMP::res($this->continueRestoreProcess()); |
| [126](#L126) | } elseif ($this->post['f'] == 'htaccess-litespeed') { |
| [127](#L127) | BMP::res($this->fixLitespeed()); |
| [128](#L128) | } elseif ($this->post['f'] == 'force-backup-to-stop') { |
| [129](#L129) | BMP::res($this->forceBackupToStop()); |
| [130](#L130) | } elseif ($this->post['f'] == 'force-restore-to-stop') { |
| [131](#L131) | BMP::res($this->forceRestoreToStop()); |
| [132](#L132) | } elseif ($this->post['f'] == 'staging-local-name') { |
| [133](#L133) | BMP::res($this->checkStagingLocalName()); |
| [134](#L134) | } elseif ($this->post['f'] == 'staging-start-local-creation') { |
| [135](#L135) | BMP::res($this->startLocalStagingCreation()); |
| [136](#L136) | } elseif ($this->post['f'] == 'staging-local-creation-process') { |
| [137](#L137) | BMP::res($this->localStagingCreationProcess()); |
| [138](#L138) | } elseif ($this->post['f'] == 'staging-tastewp-creation-process') { |
| [139](#L139) | BMP::res($this->tastewpStagingCreation()); |
| [140](#L140) | } elseif ($this->post['f'] == 'staging-rename-display') { |
| [141](#L141) | BMP::res($this->stagingRename()); |
| [142](#L142) | } elseif ($this->post['f'] == 'staging-prepare-login') { |
| [143](#L143) | BMP::res($this->stagingPrepareLogin()); |
| [144](#L144) | } elseif ($this->post['f'] == 'staging-delete-permanently') { |
| [145](#L145) | BMP::res($this->stagingDelete()); |
| [146](#L146) | } elseif ($this->post['f'] == 'staging-get-updated-list') { |
| [147](#L147) | BMP::res($this->stagingSitesGetList()); |
| [148](#L148) | } elseif ($this->post['f'] == 'send-troubleshooting-logs') { |
| [149](#L149) | BMP::res($this->sendTroubleshootingDetails()); |
| [150](#L150) | } elseif ($this->post['f'] == 'log-sharing-details') { |
| [151](#L151) | BMP::res($this->logSharing()); |
| [152](#L152) | } elseif ($this->post['f'] == 'get-latest-backup') { |
| [153](#L153) | BMP::res($this->getLatestBackupFile()); |
| [154](#L154) | } elseif ($this->post['f'] == 'front-end-ajax-error') { |
| [155](#L155) | BMP::res($this->frontEndAjaxError()); |
| [156](#L156) | } elseif ($this->post['f'] == 'debugging') { |
| [157](#L157) | BMP::res($this->debugging()); |
| [158](#L158) | } elseif (has\_action('bmi\_premium\_ajax')) { |
| [159](#L159) | do\_action('bmi\_premium\_ajax', $this->post); |
| [160](#L160) | } elseif ($this->post['f'] == 'check-not-uploaded-backups') { |
| [161](#L161) | BMP::res(['status' => 'false']); |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | } |
| [165](#L165) |  |
| [166](#L166) | public function siteURL() { |
| [167](#L167) | $protocol = (!empty($\_SERVER['HTTPS']) && $\_SERVER['HTTPS'] !== 'off' || $\_SERVER['SERVER\_PORT'] == 443) ? "https://" : "http://"; |
| [168](#L168) | $domainName = $\_SERVER['HTTP\_HOST']; |
| [169](#L169) |  |
| [170](#L170) | return $protocol . $domainName; |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | public function checkIfPHPCliExist(&$logger) { |
| [174](#L174) |  |
| [175](#L175) | if (defined('BMI\_CLI\_ENABLED')) { |
| [176](#L176) | if (BMI\_CLI\_ENABLED === false) { |
| [177](#L177) | $logger->log(\_\_('PHP CLI is disabled manually, plugin will omit all PHP CLI steps.', 'backup-backup'), 'warn'); |
| [178](#L178) | return false; |
| [179](#L179) | } |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | $logger->log(\_\_('Looking for PHP CLI executable file.', 'backup-backup'), 'step'); |
| [183](#L183) | require\_once BMI\_INCLUDES . '/cli/php\_cli\_finder.php'; |
| [184](#L184) | $checker = new PHPCLICheck(); |
| [185](#L185) | $result = $checker->findPHP(); |
| [186](#L186) |  |
| [187](#L187) | if ($result === false) { |
| [188](#L188) |  |
| [189](#L189) | if (!defined('BMI\_CLI\_ENABLED')) define('BMI\_CLI\_ENABLED', false); |
| [190](#L190) | if (!defined('BMI\_CLI\_EXECUTABLE')) define('BMI\_CLI\_EXECUTABLE', false); |
| [191](#L191) | if ($checker->ini\_disabled === true) { |
| [192](#L192) | $logger->log(\_\_('PHP CLI is disabled in your php.ini file, the process may be unstable.', 'backup-backup'), 'warn'); |
| [193](#L193) | } else { |
| [194](#L194) | $logger->log(\_\_('Could not find proper PHP CLI executable, this process may be unstable.', 'backup-backup'), 'warn'); |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | return false; |
| [198](#L198) |  |
| [199](#L199) | } else { |
| [200](#L200) |  |
| [201](#L201) | if (!defined('BMI\_CLI\_ENABLED')) define('BMI\_CLI\_ENABLED', true); |
| [202](#L202) | if (!defined('BMI\_CLI\_EXECUTABLE')) define('BMI\_CLI\_EXECUTABLE', $result['executable']); |
| [203](#L203) |  |
| [204](#L204) | $logger->log(\_\_('PHP CLI Filename: ', 'backup-backup') . basename($result['executable']), 'info'); |
| [205](#L205) | $logger->log(\_\_('PHP CLI Version: ', 'backup-backup') . $result['version'] . ' ' . $result['brand'], 'info'); |
| [206](#L206) | $logger->log(\_\_('PHP CLI Memory limit: ', 'backup-backup') . $result['memory'], 'info'); |
| [207](#L207) | $logger->log(\_\_('PHP CLI Execution limit: ', 'backup-backup') . $result['max\_exec'], 'info'); |
| [208](#L208) | $logger->log(\_\_('We properly detected PHP CLI executable file.', 'backup-backup'), 'success'); |
| [209](#L209) |  |
| [210](#L210) | return $result; |
| [211](#L211) |  |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | public function getDatabaseSize() { |
| [217](#L217) |  |
| [218](#L218) | global $wpdb; |
| [219](#L219) | $prefix = $wpdb->prefix; |
| [220](#L220) |  |
| [221](#L221) | $sql = "SELECT SUM(DATA\_LENGTH + INDEX\_LENGTH) AS `bytes` FROM information\_schema.TABLES WHERE TABLE\_SCHEMA = %s;"; |
| [222](#L222) | $sql = $wpdb->prepare($sql, array(DB\_NAME)); |
| [223](#L223) |  |
| [224](#L224) | $result = $wpdb->get\_results($sql); |
| [225](#L225) | return intval($result[0]->bytes); |
| [226](#L226) |  |
| [227](#L227) | } |
| [228](#L228) |  |
| [229](#L229) | public function dirSize() { |
| [230](#L230) |  |
| [231](#L231) | // Folder |
| [232](#L232) | $f = $this->post['folder']; |
| [233](#L233) |  |
| [234](#L234) | // Bytes |
| [235](#L235) | $bytes = 0; |
| [236](#L236) | $excludedBytes = 0; |
| [237](#L237) |  |
| [238](#L238) | $emptyVar = [ 'this\_is\_empty\_array' ]; |
| [239](#L239) | $allowed = [ 'plugins', 'uploads', 'themes', 'contents\_others', 'wordpress' ]; |
| [240](#L240) |  |
| [241](#L241) | if (in\_array($f, $allowed)) { |
| [242](#L242) |  |
| [243](#L243) | // Get list of staging sites for exclusion rules |
| [244](#L244) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [245](#L245) | $staging = new Staging('..ajax..'); |
| [246](#L246) | $stagingSites = $staging->getStagingSites(true); |
| [247](#L247) |  |
| [248](#L248) | $files = $this->scanFilesForBackup($emptyVar, $stagingSites, $f); |
| [249](#L249) | $files = $this->parseFilesForBackup($files, $emptyVar, false, true); |
| [250](#L250) |  |
| [251](#L251) | $bytes = $this->total\_size\_for\_backup; |
| [252](#L252) | $excludedBytes = $this->total\_excluded\_size\_for\_backup; |
| [253](#L253) |  |
| [254](#L254) | } elseif ($f == 'database') { |
| [255](#L255) |  |
| [256](#L256) | $bytes = $this->getDatabaseSize(); |
| [257](#L257) |  |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | return [ 'bytes' => $bytes, 'excluded' => $excludedBytes, 'readable' => BMP::humanSize($bytes) ]; |
| [261](#L261) |  |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | public function backupErrorHandler() { |
| [265](#L265) | set\_error\_handler(function ($errno, $errstr, $errfile, $errline) { |
| [266](#L266) |  |
| [267](#L267) | if (BMI\_DEBUG) { |
| [268](#L268) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (ERROR HANDLER #1):'); |
| [269](#L269) | error\_log(print\_r($errno, true)); |
| [270](#L270) | error\_log(print\_r($errstr, true)); |
| [271](#L271) | error\_log(print\_r($errfile, true)); |
| [272](#L272) | error\_log(print\_r($errline, true)); |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) | if (strpos($errstr, 'deprecated') !== false) return; |
| [276](#L276) | if (strpos($errstr, 'php\_uname') !== false) return; |
| [277](#L277) | if ((strpos($errstr, 'backup-migration') !== false) && (strpos($errstr, 'backup-backup') !== false)) return; |
| [278](#L278) |  |
| [279](#L279) | if ($errno != E\_ERROR && $errno != E\_CORE\_ERROR && $errno != E\_COMPILE\_ERROR && $errno != E\_USER\_ERROR && $errno != E\_RECOVERABLE\_ERROR) { |
| [280](#L280) |  |
| [281](#L281) | if (strpos($errfile, 'backup-backup') === false && strpos($errfile, 'backup-migration') === false) return; |
| [282](#L282) | Logger::error(\_\_('There was an error before request shutdown (but it was not logged to restore log)', 'backup-backup')); |
| [283](#L283) | Logger::error(\_\_('Error message: ', 'backup-backup') . $errstr); |
| [284](#L284) | Logger::error(\_\_('Error file/line: ', 'backup-backup') . $errfile . '|' . $errline); |
| [285](#L285) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#01' . '|' . $errno); |
| [286](#L286) | return; |
| [287](#L287) |  |
| [288](#L288) | } |
| [289](#L289) | if (strpos($errfile, 'backup-backup') === false) { |
| [290](#L290) | Logger::error(\_\_("Restore process was not aborted because this error is not related to Backup Migration.", 'backup-backup')); |
| [291](#L291) | $this->zip\_progress->log(\_\_("There was an error not related to Backup Migration Plugin.", 'backup-backup'), 'warn'); |
| [292](#L292) | $this->zip\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'warn'); |
| [293](#L293) | $this->zip\_progress->log(\_\_("Backup will not be aborted because of this.", 'backup-backup'), 'warn'); |
| [294](#L294) | return; |
| [295](#L295) | } |
| [296](#L296) | if (strpos($errstr, 'unlink(') !== false) { |
| [297](#L297) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [298](#L298) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#02' . '|' . $errno); |
| [299](#L299) | Logger::error($errstr); |
| [300](#L300) | return; |
| [301](#L301) | } |
| [302](#L302) | if (strpos($errfile, 'pclzip') !== false) { |
| [303](#L303) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [304](#L304) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#03' . '|' . $errno); |
| [305](#L305) | Logger::error($errstr); |
| [306](#L306) | return; |
| [307](#L307) | } |
| [308](#L308) | if (strpos($errstr, 'rename(') !== false) { |
| [309](#L309) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [310](#L310) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#04' . '|' . $errno); |
| [311](#L311) | Logger::error($errstr); |
| [312](#L312) | $this->zip\_progress->log(\_\_("Cannot move: ", 'backup-backup') . $errstr, 'warn'); |
| [313](#L313) | return; |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) | $this->zip\_progress->log(\_\_("There was an error during backup:", 'backup-backup'), 'error'); |
| [317](#L317) | $this->zip\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'error'); |
| [318](#L318) | $this->zip\_progress->log(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline, 'error'); |
| [319](#L319) | $this->zip\_progress->log(\_\_('Unfortunately we had to remove the backup (if partly created).', 'backup-backup'), 'error'); |
| [320](#L320) |  |
| [321](#L321) | $backup = $GLOBALS['bmi\_current\_backup\_name']; |
| [322](#L322) | $backup\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $backup; |
| [323](#L323) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [324](#L324) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'); |
| [325](#L325) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.abort')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.abort'); |
| [326](#L326) |  |
| [327](#L327) | $this->zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [328](#L328) | $this->zip\_progress->log(\_\_("#002", 'backup-backup'), 'end-code'); |
| [329](#L329) | $this->zip\_progress->end(); |
| [330](#L330) |  |
| [331](#L331) | $GLOBALS['bmi\_error\_handled'] = true; |
| [332](#L332) | BMP::res(['status' => 'error', 'error' => $errstr]); |
| [333](#L333) | exit; |
| [334](#L334) |  |
| [335](#L335) | }, E\_ALL); |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | public function migrationErrorHandler() { |
| [339](#L339) | set\_exception\_handler(function ($exception) { |
| [340](#L340) | if (BMI\_DEBUG) { |
| [341](#L341) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (EXCEPTION HANDLER #1):'); |
| [342](#L342) | error\_log(print\_r($exception, true)); |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | $this->migration\_progress->log(\_\_("Restore exception: ", 'backup-backup') . $exception->getMessage(), 'warn'); |
| [346](#L346) | Logger::log(\_\_("Restore exception: ", 'backup-backup') . $exception->getMessage()); |
| [347](#L347) | }); |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | public function migrationExceptionHandler() { |
| [351](#L351) | set\_error\_handler(function ($errno, $errstr, $errfile, $errline) { |
| [352](#L352) |  |
| [353](#L353) | if (BMI\_DEBUG) { |
| [354](#L354) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (ERROR HANDLER #2):'); |
| [355](#L355) | error\_log(print\_r($errno, true)); |
| [356](#L356) | error\_log(print\_r($errstr, true)); |
| [357](#L357) | error\_log(print\_r($errfile, true)); |
| [358](#L358) | error\_log(print\_r($errline, true)); |
| [359](#L359) | } |
| [360](#L360) |  |
| [361](#L361) | if (strpos($errstr, 'deprecated') !== false) return; |
| [362](#L362) | if (strpos($errstr, 'php\_uname') !== false) return; |
| [363](#L363) | if ($errno == E\_NOTICE) return; |
| [364](#L364) | if ($errno != E\_ERROR && $errno != E\_CORE\_ERROR && $errno != E\_COMPILE\_ERROR && $errno != E\_USER\_ERROR && $errno != E\_RECOVERABLE\_ERROR) { |
| [365](#L365) | if (strpos($errfile, 'backup-backup') === false && strpos($errfile, 'backup-migration') === false) return; |
| [366](#L366) | Logger::error(\_\_('There was an error before request shutdown (but it was not logged to restore log)', 'backup-backup')); |
| [367](#L367) | Logger::error(\_\_('Error message: ', 'backup-backup') . $errstr); |
| [368](#L368) | Logger::error(\_\_('Error file/line: ', 'backup-backup') . $errfile . '|' . $errline); |
| [369](#L369) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#05' . '|' . $errno); |
| [370](#L370) | return; |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | Logger::error(\_\_("There was an error/warning during restore process:", 'backup-backup')); |
| [374](#L374) | Logger::error(\_\_("Message: ", 'backup-backup') . $errstr); |
| [375](#L375) | Logger::error(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline); |
| [376](#L376) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#06' . '|' . $errno); |
| [377](#L377) |  |
| [378](#L378) | if (strpos($errfile, 'backup-backup') === false) { |
| [379](#L379) | Logger::error(\_\_("Restore process was not aborted because this error is not related to Backup Migration.", 'backup-backup')); |
| [380](#L380) | $this->migration\_progress->log(\_\_("There was an error not related to Backup Migration Plugin.", 'backup-backup'), 'warn'); |
| [381](#L381) | $this->migration\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'warn'); |
| [382](#L382) | $this->migration\_progress->log(\_\_("Backup will not be aborted because of this.", 'backup-backup'), 'warn'); |
| [383](#L383) | return; |
| [384](#L384) | } |
| [385](#L385) | if (strpos($errstr, 'unlink(') !== false) { |
| [386](#L386) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [387](#L387) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#07' . '|' . $errno); |
| [388](#L388) | Logger::error($errstr); |
| [389](#L389) | return; |
| [390](#L390) | } |
| [391](#L391) | if (strpos($errfile, 'pclzip') !== false) { |
| [392](#L392) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [393](#L393) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#08' . '|' . $errno); |
| [394](#L394) | Logger::error($errstr); |
| [395](#L395) | return; |
| [396](#L396) | } |
| [397](#L397) | if (strpos($errstr, 'rename(') !== false) { |
| [398](#L398) | Logger::error(\_\_("Restore process was not aborted due to this error.", 'backup-backup')); |
| [399](#L399) | Logger::error(\_\_('Error handler: ', 'backup-backup') . 'ajax#09' . '|' . $errno); |
| [400](#L400) | Logger::error($errstr); |
| [401](#L401) | $this->migration\_progress->log(\_\_("Cannot move: ", 'backup-backup') . $errstr, 'warn'); |
| [402](#L402) | return; |
| [403](#L403) | } |
| [404](#L404) |  |
| [405](#L405) | $this->migration\_progress->log(\_\_("There was an error during restore process:", 'backup-backup'), 'error'); |
| [406](#L406) | $this->migration\_progress->log(\_\_("Message: ", 'backup-backup') . $errstr, 'error'); |
| [407](#L407) | $this->migration\_progress->log(\_\_("File/line: ", 'backup-backup') . $errfile . '|' . $errline, 'error'); |
| [408](#L408) |  |
| [409](#L409) | if (file\_exists(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock')) @unlink(BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock'); |
| [410](#L410) |  |
| [411](#L411) | $this->migration\_progress->log(\_\_("Aborting restore process...", 'backup-backup'), 'step'); |
| [412](#L412) |  |
| [413](#L413) | if (isset($GLOBALS['bmi\_current\_tmp\_restore']) && !empty($GLOBALS['bmi\_current\_tmp\_restore'])) { |
| [414](#L414) |  |
| [415](#L415) | $this->migration\_progress->log(\_\_("Cleaning up exported files...", 'backup-backup'), 'step'); |
| [416](#L416) |  |
| [417](#L417) | $tmp\_unique = $GLOBALS['bmi\_current\_tmp\_restore\_unique']; |
| [418](#L418) | $dir = $GLOBALS['bmi\_current\_tmp\_restore']; |
| [419](#L419) | $it = new \RecursiveDirectoryIterator($dir, \RecursiveDirectoryIterator::SKIP\_DOTS); |
| [420](#L420) | $files = new \RecursiveIteratorIterator($it, \RecursiveIteratorIterator::CHILD\_FIRST); |
| [421](#L421) |  |
| [422](#L422) | $this->migration\_progress->log(\_\_('Removing ', 'backup-backup') . iterator\_count($files) . \_\_(' files', 'backup-backup'), 'INFO'); |
| [423](#L423) | foreach ($files as $file) { |
| [424](#L424) | if ($file->isDir()) { |
| [425](#L425) | @rmdir($file->getRealPath()); |
| [426](#L426) | } else { |
| [427](#L427) | @unlink($file->getRealPath()); |
| [428](#L428) | } |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | @rmdir($dir); |
| [432](#L432) |  |
| [433](#L433) | $config\_file = untrailingslashit(ABSPATH) . DIRECTORY\_SEPARATOR . 'wp-config.' . $tmp\_unique . '.php'; |
| [434](#L434) | if (file\_exists($config\_file)) @unlink($config\_file); |
| [435](#L435) |  |
| [436](#L436) | } |
| [437](#L437) |  |
| [438](#L438) | $this->migration\_progress->log(\_\_("#002", 'backup-backup'), 'end-code'); |
| [439](#L439) | $this->migration\_progress->end(); |
| [440](#L440) |  |
| [441](#L441) | $GLOBALS['bmi\_error\_handled'] = true; |
| [442](#L442) | BMP::res(['status' => 'error', 'error' => $errstr]); |
| [443](#L443) | exit; |
| [444](#L444) |  |
| [445](#L445) | }, E\_ALL); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | public function backupExceptionHandler() { |
| [449](#L449) | set\_exception\_handler(function ($exception) { |
| [450](#L450) | if (BMI\_DEBUG) { |
| [451](#L451) | error\_log('BMI DEBUG ENABLED, HERE IS THE COMPLETE REPORT (EXCEPTION HANDLER #2):'); |
| [452](#L452) | error\_log(print\_r($exception, true)); |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | $this->zip\_progress->log(\_\_("Exception: ", 'backup-backup') . $exception->getMessage(), 'warn'); |
| [456](#L456) | Logger::log(\_\_("Exception: ", 'backup-backup') . $exception->getMessage()); |
| [457](#L457) | }); |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | public function resetLatestLogs() { |
| [461](#L461) |  |
| [462](#L462) | // Restore htaccess |
| [463](#L463) | BMP::revertLitespeed(); |
| [464](#L464) | BMP::fixLitespeed(); |
| [465](#L465) |  |
| [466](#L466) | // Check time if not bugged |
| [467](#L467) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) > 65) { |
| [468](#L468) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [469](#L469) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | // Check if backup is not in progress |
| [473](#L473) | if (file\_exists(BMI\_BACKUPS . '/.running')) { |
| [474](#L474) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | // Remove too large logs |
| [478](#L478) | $completeLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'complete\_logs.log'; |
| [479](#L479) | if (file\_exists($completeLogsPath) && (filesize($completeLogsPath) / 1024 / 1024) >= 3) { |
| [480](#L480) | @unlink($completeLogsPath); |
| [481](#L481) | } |
| [482](#L482) |  |
| [483](#L483) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [484](#L484) | if (file\_exists($backgroundLogsPath) && (filesize($backgroundLogsPath) / 1024 / 1024) >= 3) { |
| [485](#L485) | @unlink($backgroundLogsPath); |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | @touch($completeLogsPath); |
| [489](#L489) | @touch($backgroundLogsPath); |
| [490](#L490) |  |
| [491](#L491) | // Require logs |
| [492](#L492) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [493](#L493) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [494](#L494) | require\_once BMI\_INCLUDES . '/progress/staging.php'; |
| [495](#L495) |  |
| [496](#L496) | // Write initial |
| [497](#L497) | $zip\_progress = new Progress('', 0); |
| [498](#L498) | $zip\_progress->start(); |
| [499](#L499) | $zip\_progress->log(\_\_("Initializing backup...", 'backup-backup'), 'step'); |
| [500](#L500) | $zip\_progress->progress('0/100'); |
| [501](#L501) | $zip\_progress->end(); |
| [502](#L502) |  |
| [503](#L503) | // Write initial |
| [504](#L504) | $migration = new MigrationProgress(false); |
| [505](#L505) | $migration->start(); |
| [506](#L506) | $migration->log(\_\_('Initializing restore process', 'backup-backup'), 'STEP'); |
| [507](#L507) | $migration->progress('0'); |
| [508](#L508) | $migration->end(); |
| [509](#L509) |  |
| [510](#L510) | // Write initial |
| [511](#L511) | $staging = new StagingProgress(false); |
| [512](#L512) | $staging->start(); |
| [513](#L513) | $staging->log(\_\_('Preparing creation of staging site...', 'backup-backup'), 'STEP'); |
| [514](#L514) | $staging->progress('0'); |
| [515](#L515) | $staging->end(); |
| [516](#L516) |  |
| [517](#L517) | // Return done |
| [518](#L518) | return ['status' => 'success']; |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | public function makeBackupName() { |
| [522](#L522) | $name = Dashboard\bmi\_get\_config('BACKUP:NAME'); |
| [523](#L523) |  |
| [524](#L524) | $urlparts = parse\_url(home\_url()); |
| [525](#L525) | $domain = str\_replace('.', '-', sanitize\_text\_field($urlparts['host'])); |
| [526](#L526) |  |
| [527](#L527) | $hash = BMP::randomString(16); |
| [528](#L528) | $name = str\_replace('%domain', $domain, $name); |
| [529](#L529) | $name = str\_replace('%hash', $hash, $name); |
| [530](#L530) | $name = str\_replace('%Y', date('Y'), $name); |
| [531](#L531) | $name = str\_replace('%M', date('M'), $name); |
| [532](#L532) | $name = str\_replace('%D', date('D'), $name); |
| [533](#L533) | $name = str\_replace('%d', date('d'), $name); |
| [534](#L534) | $name = str\_replace('%j', date('j'), $name); |
| [535](#L535) | $name = str\_replace('%m', date('m'), $name); |
| [536](#L536) | $name = str\_replace('%n', date('n'), $name); |
| [537](#L537) | $name = str\_replace('%Y', date('Y'), $name); |
| [538](#L538) | $name = str\_replace('%y', date('y'), $name); |
| [539](#L539) | $name = str\_replace('%a', date('a'), $name); |
| [540](#L540) | $name = str\_replace('%A', date('A'), $name); |
| [541](#L541) | $name = str\_replace('%B', date('B'), $name); |
| [542](#L542) | $name = str\_replace('%g', date('g'), $name); |
| [543](#L543) | $name = str\_replace('%G', date('G'), $name); |
| [544](#L544) | $name = str\_replace('%h', date('h'), $name); |
| [545](#L545) | $name = str\_replace('%H', date('H'), $name); |
| [546](#L546) | $name = str\_replace('%i', date('i'), $name); |
| [547](#L547) | $name = str\_replace('%s', date('s'), $name); |
| [548](#L548) | $name = str\_replace('%s', date('s'), $name); |
| [549](#L549) |  |
| [550](#L550) | $i = 2; |
| [551](#L551) | $tmpname = $name; |
| [552](#L552) |  |
| [553](#L553) | while (file\_exists($tmpname . '.zip')) { |
| [554](#L554) | $tmpname = $name . '\_' . $i; |
| [555](#L555) | $i++; |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | $name = $tmpname . '.zip'; |
| [559](#L559) |  |
| [560](#L560) | $GLOBALS['bmi\_current\_backup\_name'] = $name; |
| [561](#L561) | return $name; |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | public function fixUnameFunction() { |
| [565](#L565) | $file = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip.php'; |
| [566](#L566) | $backup = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip-backup.php'; |
| [567](#L567) |  |
| [568](#L568) | // Make backup |
| [569](#L569) | if (!file\_exists($backup)) { |
| [570](#L570) | @copy($file, $backup); |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | // Replace deprecated php\_uname function which is mostly disabled and cause errors |
| [574](#L574) | $replace = file\_get\_contents($file); |
| [575](#L575) | $replace = str\_replace('php\_uname()', '(DIRECTORY\_SEPARATOR === "/" ? "linux" : "windows")', $replace); |
| [576](#L576) | file\_put\_contents($file, $replace); |
| [577](#L577) | return ['status' => 'success']; |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | public function revertUnameProcess() { |
| [581](#L581) | $file = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip.php'; |
| [582](#L582) | $backup = trailingslashit(ABSPATH) . 'wp-admin/includes/class-pclzip-backup.php'; |
| [583](#L583) | if (file\_exists($backup)) { |
| [584](#L584) | if (file\_exists($file)) @unlink($file); |
| [585](#L585) | @copy($backup, $file); |
| [586](#L586) | } |
| [587](#L587) | return ['status' => 'success']; |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | public function prepareAndMakeBackup($cron = false) { |
| [591](#L591) |  |
| [592](#L592) | global $wp\_version; |
| [593](#L593) |  |
| [594](#L594) | // Require File Scanner |
| [595](#L595) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [596](#L596) | require\_once BMI\_INCLUDES . '/check/checker.php'; |
| [597](#L597) |  |
| [598](#L598) | // CLI Handler |
| [599](#L599) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [600](#L600) |  |
| [601](#L601) | // Backup name |
| [602](#L602) | if (defined('BMI\_CLI\_ARGUMENT') && !empty(BMI\_CLI\_ARGUMENT)) { |
| [603](#L603) | $name = BMI\_CLI\_ARGUMENT; |
| [604](#L604) | } else { |
| [605](#L605) | $name = $this->makeBackupName(); |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | // Progress & Logs |
| [609](#L609) | $cliRunning = (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) ? true : false; |
| [610](#L610) | $shouldResetLogs = !$cliRunning; |
| [611](#L611) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP\_VIA\_CLI')) { |
| [612](#L612) | $cron = true; |
| [613](#L613) | $shouldResetLogs = true; |
| [614](#L614) | } |
| [615](#L615) |  |
| [616](#L616) | $clearEndCodes = false; |
| [617](#L617) | if (isset($this->post['preserveLogs']) && ($this->post['preserveLogs'] == 'true' || $this->post['preserveLogs'] === true)) { |
| [618](#L618) | $shouldResetLogs = false; |
| [619](#L619) | $clearEndCodes = true; |
| [620](#L620) | } |
| [621](#L621) |  |
| [622](#L622) | $zip\_progress = new Progress($name, 100, 0, $cron, $shouldResetLogs, $clearEndCodes); |
| [623](#L623) | $zip\_progress->start(); |
| [624](#L624) |  |
| [625](#L625) | // PHP CLI Check |
| [626](#L626) | $isCLI = false; |
| [627](#L627) | $cli\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli'; |
| [628](#L628) | $cli\_lock\_end = BMI\_BACKUPS . '/.backup\_lock\_cli\_end'; |
| [629](#L629) | $cli\_failed\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli\_failed'; |
| [630](#L630) |  |
| [631](#L631) | if (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) { |
| [632](#L632) |  |
| [633](#L633) | $cli\_result = $this->checkIfPHPCliExist($zip\_progress); |
| [634](#L634) | if ($cli\_result !== false && BMI\_FUNCTION\_NORMAL === true) { |
| [635](#L635) |  |
| [636](#L636) | $res = null; |
| [637](#L637) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP')) { |
| [638](#L638) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_backup\_cron ' . $name . ' > /dev/null &', $res); |
| [639](#L639) | } else { |
| [640](#L640) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_backup ' . $name . ' > /dev/null &', $res); |
| [641](#L641) | } |
| [642](#L642) | $res = implode("\n", $res); |
| [643](#L643) |  |
| [644](#L644) | sleep(3); |
| [645](#L645) |  |
| [646](#L646) | if (file\_exists($cli\_lock\_end) && (time() - filemtime($cli\_lock\_end)) < 10) { |
| [647](#L647) |  |
| [648](#L648) | if (file\_exists($cli\_lock\_end)) @unlink($cli\_lock\_end); |
| [649](#L649) | return ['status' => 'success', 'filename' => $name]; |
| [650](#L650) | exit; |
| [651](#L651) |  |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | if (!file\_exists($cli\_lock) || (time() - filemtime($cli\_lock)) > 10) { |
| [655](#L655) |  |
| [656](#L656) | if (!file\_exists(BMI\_BACKUPS . '/.abort') || (time() - filemtime(BMI\_BACKUPS . '/.abort')) > 10) { |
| [657](#L657) |  |
| [658](#L658) | $zip\_progress->log(\_\_("Something went wrong in PHP CLI process, backup will be continued with legacy methods.", 'backup-backup'), 'warn'); |
| [659](#L659) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [660](#L660) | define('BMI\_CLI\_FAILED', true); |
| [661](#L661) | touch($cli\_failed\_lock); |
| [662](#L662) |  |
| [663](#L663) | } else { |
| [664](#L664) |  |
| [665](#L665) | $zip\_progress->log(\_\_("Backup will not be continued due to manual abort by user.", 'backup-backup'), 'warn'); |
| [666](#L666) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [667](#L667) | return ['status' => 'msg', 'why' => \_\_('Backup process aborted.', 'backup-backup'), 'level' => 'info']; |
| [668](#L668) |  |
| [669](#L669) | } |
| [670](#L670) |  |
| [671](#L671) | } else { |
| [672](#L672) |  |
| [673](#L673) | return ['status' => 'background', 'filename' => $name]; |
| [674](#L674) |  |
| [675](#L675) | } |
| [676](#L676) |  |
| [677](#L677) | } else { |
| [678](#L678) |  |
| [679](#L679) | if (BMI\_FUNCTION\_NORMAL !== true) { |
| [680](#L680) | $zip\_progress->log(\_\_("PHP CLI will not run due to user settings in plugin other options.", 'backup-backup'), 'warn'); |
| [681](#L681) | } else { |
| [682](#L682) | $zip\_progress->log(\_\_("PHP CLI file cannot be executed due to unknown reason.", 'backup-backup'), 'warn'); |
| [683](#L683) | } |
| [684](#L684) |  |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | } else { |
| [688](#L688) |  |
| [689](#L689) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [690](#L690) |  |
| [691](#L691) | if (!file\_exists($cli\_failed\_lock) || (time() - filemtime($cli\_failed\_lock)) < 10) { |
| [692](#L692) | exit; |
| [693](#L693) | } |
| [694](#L694) |  |
| [695](#L695) | $isCLI = true; |
| [696](#L696) | $zip\_progress->log(\_\_("Backup via PHP CLI initialized successfully.", 'backup-backup'), 'success'); |
| [697](#L697) | touch($cli\_lock); |
| [698](#L698) |  |
| [699](#L699) | } |
| [700](#L700) |  |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | // Just in case (e.g. syntax error, we can close the file correctly) |
| [704](#L704) | $GLOBALS['bmi\_backup\_progress'] = $zip\_progress; |
| [705](#L705) |  |
| [706](#L706) | // Logs |
| [707](#L707) | $zip\_progress->log(\_\_("Initializing backup...", 'backup-backup'), 'step'); |
| [708](#L708) | $zip\_progress->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION), 'info'); |
| [709](#L709) | $zip\_progress->log(\_\_("Site which will be backed up: ", 'backup-backup') . site\_url(), 'info'); |
| [710](#L710) | $zip\_progress->log(\_\_("PHP Version: ", 'backup-backup') . PHP\_VERSION, 'info'); |
| [711](#L711) | $zip\_progress->log(\_\_("WP Version: ", 'backup-backup') . $wp\_version, 'info'); |
| [712](#L712) | $zip\_progress->log(\_\_("MySQL Version: ", 'backup-backup') . $GLOBALS['wpdb']->db\_version(), 'info'); |
| [713](#L713) | $zip\_progress->log(\_\_("MySQL Max Length: ", 'backup-backup') . $GLOBALS['wpdb']->get\_results("SHOW VARIABLES LIKE 'max\_allowed\_packet';")[0]->Value, 'info'); |
| [714](#L714) | if (isset($\_SERVER['SERVER\_SOFTWARE']) && !empty($\_SERVER['SERVER\_SOFTWARE'])) { |
| [715](#L715) | $zip\_progress->log(\_\_("Web server: ", 'backup-backup') . $\_SERVER['SERVER\_SOFTWARE'], 'info'); |
| [716](#L716) | } else { |
| [717](#L717) | $zip\_progress->log(\_\_("Web server: Not available", 'backup-backup'), 'info'); |
| [718](#L718) | } |
| [719](#L719) | $zip\_progress->log(\_\_("Max execution time (in seconds): ", 'backup-backup') . @ini\_get('max\_execution\_time'), 'info'); |
| [720](#L720) |  |
| [721](#L721) | $zip\_progress->log(\_\_("Memory limit (server): ", 'backup-backup') . @ini\_get('memory\_limit'), 'info'); |
| [722](#L722) | if (defined('WP\_MEMORY\_LIMIT')) { |
| [723](#L723) | $zip\_progress->log(\_\_("Memory limit (wp-config): ", 'backup-backup') . WP\_MEMORY\_LIMIT, 'info'); |
| [724](#L724) | } |
| [725](#L725) | if (defined('WP\_MAX\_MEMORY\_LIMIT')) { |
| [726](#L726) | $zip\_progress->log(\_\_("Memory limit (wp-config admin): ", 'backup-backup') . WP\_MAX\_MEMORY\_LIMIT, 'info'); |
| [727](#L727) | } |
| [728](#L728) |  |
| [729](#L729) | if (defined('BMI\_DB\_MAX\_ROWS\_PER\_QUERY')) { |
| [730](#L730) | $zip\_progress->log(\_\_('Max rows per query (this site): ', 'backup-backup') . BMI\_DB\_MAX\_ROWS\_PER\_QUERY, 'info'); |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | $zip\_progress->log(\_\_("Checking if backup dir is writable...", 'backup-backup'), 'info'); |
| [734](#L734) |  |
| [735](#L735) | if (defined('BMI\_DOING\_SCHEDULED\_BACKUP')) { |
| [736](#L736) | $zip\_progress->log(\_\_("This process was initialized due to scheduled backup configuration...", 'backup-backup'), 'info'); |
| [737](#L737) | $zip\_progress->log(\_\_("Backup will be unlocked by default as it is not manual backup...", 'backup-backup'), 'info'); |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | if (defined('BMI\_BACKUP\_PRO')) { |
| [741](#L741) | if (BMI\_BACKUP\_PRO == 1) { |
| [742](#L742) | $zip\_progress->log(\_\_("Premium plugin is enabled and activated", 'backup-backup'), 'info'); |
| [743](#L743) | } else { |
| [744](#L744) | $zip\_progress->log(\_\_("Premium version is enabled but not active, using free plugin.", 'backup-backup'), 'warn'); |
| [745](#L745) | } |
| [746](#L746) | } |
| [747](#L747) |  |
| [748](#L748) | // Error handler |
| [749](#L749) | $zip\_progress->log(\_\_("Initializing custom error handler", 'backup-backup'), 'info'); |
| [750](#L750) | $this->zip\_progress = &$zip\_progress; |
| [751](#L751) | $this->backupErrorHandler(); |
| [752](#L752) | $this->backupExceptionHandler(); |
| [753](#L753) |  |
| [754](#L754) | // Checker |
| [755](#L755) | $checker = new Checker($zip\_progress); |
| [756](#L756) |  |
| [757](#L757) | if (!is\_writable(dirname(BMI\_BACKUPS))) { |
| [758](#L758) |  |
| [759](#L759) | // Abort backup |
| [760](#L760) | $zip\_progress->log(\_\_("Backup directory is not writable...", 'backup-backup'), 'error'); |
| [761](#L761) | $zip\_progress->log(\_\_("Path: ", 'backup-backup') . BMI\_BACKUPS, 'error'); |
| [762](#L762) |  |
| [763](#L763) | // Close backup |
| [764](#L764) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [765](#L765) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [766](#L766) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [767](#L767) |  |
| [768](#L768) | // Log and close log |
| [769](#L769) | $zip\_progress->log('#002', 'END-CODE'); |
| [770](#L770) | $zip\_progress->end(); |
| [771](#L771) |  |
| [772](#L772) | if ($isCLI === true) touch($cli\_lock\_end); |
| [773](#L773) | $this->actionsAfterProcess(); |
| [774](#L774) |  |
| [775](#L775) | // Return error |
| [776](#L776) | if ($cron == true) return ['status' => 'success']; |
| [777](#L777) | else return ['status' => 'error']; |
| [778](#L778) | } else { |
| [779](#L779) | $zip\_progress->log(\_\_("Yup it is writable...", 'backup-backup'), 'success'); |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | if (!file\_exists(BMI\_BACKUPS)) @mkdir(BMI\_BACKUPS, true); |
| [783](#L783) |  |
| [784](#L784) | // Get list of staging sites for exclusion rules |
| [785](#L785) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [786](#L786) | $staging = new Staging('..ajax..'); |
| [787](#L787) | $stagingSites = $staging->getStagingSites(true); |
| [788](#L788) |  |
| [789](#L789) | // Get file names (huge list mostly) |
| [790](#L790) | if ($fgwp = Dashboard\bmi\_get\_config('BACKUP:FILES') == 'true') { |
| [791](#L791) | $zip\_progress->log(\_\_("Scanning files...", 'backup-backup'), 'step'); |
| [792](#L792) | $files = $this->scanFilesForBackup($zip\_progress, $stagingSites); |
| [793](#L793) | $files = $this->parseFilesForBackup($files, $zip\_progress, $cron); |
| [794](#L794) | } else { |
| [795](#L795) | $zip\_progress->log(\_\_("Omitting files (due to settings)...", 'backup-backup'), 'warn'); |
| [796](#L796) | $files = []; |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | $zip\_progress->log(str\_replace('%s', $this->total\_excluded\_size\_for\_backup, \_\_("Total size of excluded files: %s bytes", 'backup-backup')), 'info'); |
| [800](#L800) | $zip\_progress->log("Total size of excluded files (bytes): " . $this->total\_excluded\_size\_for\_backup, 'verbose'); |
| [801](#L801) |  |
| [802](#L802) | // Check if there is enough space |
| [803](#L803) | $bytes = intval($this->total\_size\_for\_backup \* 1.4); |
| [804](#L804) | $zip\_progress->log(\_\_("Checking free space, reserving...", 'backup-backup'), 'step'); |
| [805](#L805) | if ($this->total\_size\_for\_backup\_in\_mb >= BMI\_REV \* 1000 && add\_option('bmip\_last', false) != '1') { |
| [806](#L806) |  |
| [807](#L807) | // Abort backup |
| [808](#L808) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [809](#L809) | $zip\_progress->log(str\_replace('%s', BMI\_REV, \_\_("Site weights more than %s GB.", 'backup-backup')), 'error'); |
| [810](#L810) | $zip\_progress->log(print\_r($this->post, true), 'verbose'); |
| [811](#L811) |  |
| [812](#L812) | // Close backup |
| [813](#L813) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [814](#L814) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [815](#L815) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [816](#L816) |  |
| [817](#L817) | // Log and close log |
| [818](#L818) | $zip\_progress->log('#100', 'END-CODE'); |
| [819](#L819) | $zip\_progress->end(); |
| [820](#L820) |  |
| [821](#L821) | if ($isCLI === true) touch($cli\_lock\_end); |
| [822](#L822) | $this->actionsAfterProcess(); |
| [823](#L823) |  |
| [824](#L824) | // Return error |
| [825](#L825) | return ['status' => 'error', 'bfs' => true]; |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | $isSpaceCheckDisabled = Dashboard\bmi\_get\_config('OTHER:BACKUP:SPACE:CHECKING'); |
| [829](#L829) |  |
| [830](#L830) | if ($isSpaceCheckDisabled) { |
| [831](#L831) |  |
| [832](#L832) | $zip\_progress->log(\_\_("Free space checking is disabled by user in settings...", 'backup-backup'), 'warn'); |
| [833](#L833) | $zip\_progress->log(\_\_("Backup will continue, trusting there is enough space...", 'backup-backup'), 'warn'); |
| [834](#L834) |  |
| [835](#L835) | } else { |
| [836](#L836) |  |
| [837](#L837) | if (!$checker->check\_free\_space($bytes)) { |
| [838](#L838) |  |
| [839](#L839) | // Abort backup |
| [840](#L840) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [841](#L841) | $zip\_progress->log(\_\_("There is no space for that backup, checked: ", 'backup-backup') . ($bytes) . \_\_(" bytes", 'backup-backup'), 'error'); |
| [842](#L842) |  |
| [843](#L843) | // Close backup |
| [844](#L844) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [845](#L845) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [846](#L846) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [847](#L847) |  |
| [848](#L848) | // Log and close log |
| [849](#L849) | $zip\_progress->log('#002', 'END-CODE'); |
| [850](#L850) | $zip\_progress->end(); |
| [851](#L851) |  |
| [852](#L852) | if ($isCLI === true) touch($cli\_lock\_end); |
| [853](#L853) | $this->actionsAfterProcess(); |
| [854](#L854) |  |
| [855](#L855) | // Return error |
| [856](#L856) | if ($cron == true) return ['status' => 'success']; |
| [857](#L857) | else return ['status' => 'error']; |
| [858](#L858) | } else { |
| [859](#L859) | $zip\_progress->log(\_\_("Confirmed, there is more than enough space, checked: ", 'backup-backup') . ($bytes) . \_\_(" bytes", 'backup-backup'), 'success'); |
| [860](#L860) | $zip\_progress->bytes = $this->total\_size\_for\_backup; |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | if (Dashboard\bmi\_get\_config('BACKUP:DATABASE') != 'true') { |
| [866](#L866) |  |
| [867](#L867) | // $zip\_progress->log(\_\_("Database won't be backed-up due to user settings, omitting...", 'backup-backup'), 'info'); |
| [868](#L868) | // Commented as message will be shown in database backup module |
| [869](#L869) |  |
| [870](#L870) | } |
| [871](#L871) |  |
| [872](#L872) | // Log and set files length |
| [873](#L873) | $zip\_progress->log(\_\_("Scanning done - found ", 'backup-backup') . sizeof($files) . \_\_(" files...", 'backup-backup'), 'info'); |
| [874](#L874) | $zip\_progress->files = sizeof($files); |
| [875](#L875) |  |
| [876](#L876) | // Make Backup |
| [877](#L877) | $zip\_progress->log(\_\_("Backup initialized...", 'backup-backup'), 'success'); |
| [878](#L878) | $zip\_progress->log(\_\_("Initializing archiving system...", 'backup-backup'), 'step'); |
| [879](#L879) |  |
| [880](#L880) | $bckpres = $this->createBackup($files, ABSPATH, $name, $zip\_progress, $cron, $isCLI); |
| [881](#L881) | if ($cron == true) return ['status' => 'success']; |
| [882](#L882) | else return $bckpres; |
| [883](#L883) | } |
| [884](#L884) |  |
| [885](#L885) | public function fixLitespeed() { |
| [886](#L886) | BMP::fixLitespeed(); |
| [887](#L887) |  |
| [888](#L888) | return ['status' => 'success']; |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | public function revertLitespeed() { |
| [892](#L892) | BMP::revertLitespeed(); |
| [893](#L893) |  |
| [894](#L894) | return ['status' => 'success']; |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | public function createBackup($files, $base, $name, &$zip\_progress, $cron = false, $isCLI = false) { |
| [898](#L898) |  |
| [899](#L899) | // Require File Zipper |
| [900](#L900) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [901](#L901) |  |
| [902](#L902) | // CLI locks |
| [903](#L903) | $cli\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli'; |
| [904](#L904) | $cli\_lock\_end = BMI\_BACKUPS . '/.backup\_lock\_cli\_end'; |
| [905](#L905) | $cli\_failed\_lock = BMI\_BACKUPS . '/.backup\_lock\_cli\_failed'; |
| [906](#L906) |  |
| [907](#L907) | // Backup name |
| [908](#L908) | $backup\_path = BMI\_BACKUPS . '/' . $name; |
| [909](#L909) |  |
| [910](#L910) | // Check time if not bugged |
| [911](#L911) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) > 65) { |
| [912](#L912) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [913](#L913) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [914](#L914) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [915](#L915) | if ($isCLI === true && file\_exists($cli\_lock\_end)) @unlink($cli\_lock\_end); |
| [916](#L916) | } |
| [917](#L917) |  |
| [918](#L918) | if ($isCLI === true) { |
| [919](#L919) | if (!file\_exists($cli\_failed\_lock) || (time() - filemtime($cli\_failed\_lock)) < 10) { |
| [920](#L920) | exit; |
| [921](#L921) | } |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | // Mark as in progress |
| [925](#L925) | if (!file\_exists(BMI\_BACKUPS . '/.running')) { |
| [926](#L926) | touch(BMI\_BACKUPS . '/.running'); |
| [927](#L927) | if ($isCLI === true) touch($cli\_lock); |
| [928](#L928) | } else { |
| [929](#L929) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [930](#L930) | } |
| [931](#L931) |  |
| [932](#L932) | // Initialized |
| [933](#L933) | $zip\_progress->log(\_\_("Archive system initialized...", 'backup-backup'), 'success'); |
| [934](#L934) |  |
| [935](#L935) | // Make ZIP |
| [936](#L936) | $zipper = new Zipper(); |
| [937](#L937) | $zippy = $zipper->makeZIP($files, $backup\_path, $name, $zip\_progress, $cron); |
| [938](#L938) | if (!$zippy) { |
| [939](#L939) |  |
| [940](#L940) | // Make sure it's open |
| [941](#L941) | $zip\_progress->start(); |
| [942](#L942) |  |
| [943](#L943) | // Abort backup |
| [944](#L944) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [945](#L945) |  |
| [946](#L946) | // Close backup |
| [947](#L947) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [948](#L948) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [949](#L949) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [950](#L950) |  |
| [951](#L951) | // Log and close log |
| [952](#L952) | $zip\_progress->log('#002', 'END-CODE'); |
| [953](#L953) | $zip\_progress->end(); |
| [954](#L954) |  |
| [955](#L955) | if ($isCLI === true) touch($cli\_lock\_end); |
| [956](#L956) |  |
| [957](#L957) | // Return error |
| [958](#L958) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [959](#L959) |  |
| [960](#L960) | $this->actionsAfterProcess(); |
| [961](#L961) | return ['status' => 'error']; |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | // Backup aborted |
| [965](#L965) | if (file\_exists(BMI\_BACKUPS . '/.abort')) { |
| [966](#L966) |  |
| [967](#L967) | // Make sure it's open |
| [968](#L968) | $zip\_progress->start(); |
| [969](#L969) |  |
| [970](#L970) | if (file\_exists($backup\_path)) @unlink($backup\_path); |
| [971](#L971) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [972](#L972) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [973](#L973) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [974](#L974) |  |
| [975](#L975) | // Log and close log |
| [976](#L976) | $zip\_progress->log(\_\_("Backup process aborted.", 'backup-backup'), 'warn'); |
| [977](#L977) | $zip\_progress->log('#002', 'END-CODE'); |
| [978](#L978) | $zip\_progress->end(); |
| [979](#L979) |  |
| [980](#L980) | if ($isCLI === true) touch($cli\_lock\_end); |
| [981](#L981) | Logger::log(\_\_("Backup process aborted.", 'backup-backup')); |
| [982](#L982) |  |
| [983](#L983) | $this->actionsAfterProcess(); |
| [984](#L984) | return ['status' => 'msg', 'why' => \_\_('Backup process aborted.', 'backup-backup'), 'level' => 'info']; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | if (!file\_exists($backup\_path) && !$cron) { |
| [988](#L988) |  |
| [989](#L989) | // Make sure it's open |
| [990](#L990) | $zip\_progress->start(); |
| [991](#L991) |  |
| [992](#L992) | // Abort backup |
| [993](#L993) | $zip\_progress->log(\_\_("Aborting backup...", 'backup-backup'), 'step'); |
| [994](#L994) | $zip\_progress->log(\_\_("There is no backup file...", 'backup-backup'), 'error'); |
| [995](#L995) | $zip\_progress->log(\_\_("We could not find backup file when it already should be here.", 'backup-backup'), 'error'); |
| [996](#L996) | $zip\_progress->log(\_\_("This error may be related to missing space. (filled during backup)", 'backup-backup'), 'error'); |
| [997](#L997) | $zip\_progress->log(\_\_("Path: ", 'backup-backup') . $backup\_path, 'error'); |
| [998](#L998) |  |
| [999](#L999) | // Close backup |
| [1000](#L1000) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [1001](#L1001) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [1002](#L1002) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1003](#L1003) |  |
| [1004](#L1004) | // Log and close log |
| [1005](#L1005) | $zip\_progress->log('#002', 'END-CODE'); |
| [1006](#L1006) | $zip\_progress->end(); |
| [1007](#L1007) |  |
| [1008](#L1008) | if ($isCLI === true) touch($cli\_lock\_end); |
| [1009](#L1009) | $this->actionsAfterProcess(); |
| [1010](#L1010) |  |
| [1011](#L1011) | // Return error |
| [1012](#L1012) | if ($cron == true) return ['status' => 'success']; |
| [1013](#L1013) | else return ['status' => 'error']; |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | // End zip log |
| [1017](#L1017) | $zip\_progress->log(\_\_("New backup created and its name is: ", 'backup-backup') . $name, 'success'); |
| [1018](#L1018) | $zip\_progress->log('#001', 'END-CODE'); |
| [1019](#L1019) | $zip\_progress->end(); |
| [1020](#L1020) |  |
| [1021](#L1021) | if ($isCLI === true) touch($cli\_lock\_end); |
| [1022](#L1022) |  |
| [1023](#L1023) | // Unlink progress |
| [1024](#L1024) | if (file\_exists(BMI\_BACKUPS . '/.running')) @unlink(BMI\_BACKUPS . '/.running'); |
| [1025](#L1025) | if (file\_exists(BMI\_BACKUPS . '/.abort')) @unlink(BMI\_BACKUPS . '/.abort'); |
| [1026](#L1026) | if ($isCLI === true && file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1027](#L1027) |  |
| [1028](#L1028) | // Return |
| [1029](#L1029) | Logger::log(\_\_("New backup created and its name is: ", 'backup-backup') . $name); |
| [1030](#L1030) |  |
| [1031](#L1031) | $GLOBALS['bmi\_error\_handled'] = true; |
| [1032](#L1032) |  |
| [1033](#L1033) | $this->actionsAfterProcess(true); |
| [1034](#L1034) | return ['status' => 'success', 'filename' => $name, 'root' => plugin\_dir\_url(BMI\_ROOT\_FILE)]; |
| [1035](#L1035) |  |
| [1036](#L1036) | } |
| [1037](#L1037) |  |
| [1038](#L1038) | public function continueRestoreProcess() { |
| [1039](#L1039) |  |
| [1040](#L1040) | // BMI\_RESTORE\_SECRET |
| [1041](#L1041) |  |
| [1042](#L1042) | } |
| [1043](#L1043) |  |
| [1044](#L1044) | public function getBackupsList() { |
| [1045](#L1045) |  |
| [1046](#L1046) | // Require File Scanner |
| [1047](#L1047) | require\_once BMI\_INCLUDES . '/scanner/backups.php'; |
| [1048](#L1048) |  |
| [1049](#L1049) | // Get backups |
| [1050](#L1050) | $backups = new Backups(); |
| [1051](#L1051) | $manifests = $backups->getAvailableBackups(); |
| [1052](#L1052) |  |
| [1053](#L1053) | // Return files |
| [1054](#L1054) | return ['status' => 'success', 'backups' => $manifests]; |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | public function sendTestMail() { |
| [1058](#L1058) |  |
| [1059](#L1059) | $email = Dashboard\bmi\_get\_config('OTHER:EMAIL') != false ? Dashboard\bmi\_get\_config('OTHER:EMAIL') : get\_bloginfo('admin\_email'); |
| [1060](#L1060) | $subject = \_\_('Backup Migration – Example email', 'backup-backup'); |
| [1061](#L1061) | $message = \_\_('This is a test email sent by the Backup Migration plugin via Troubleshooting options!', 'backup-backup'); |
| [1062](#L1062) |  |
| [1063](#L1063) | try { |
| [1064](#L1064) |  |
| [1065](#L1065) | if (wp\_mail($email, $subject, $message)) return [ 'status' => 'success' ]; |
| [1066](#L1066) | else return ['status' => 'error']; |
| [1067](#L1067) |  |
| [1068](#L1068) | } catch (\Exception $e) { |
| [1069](#L1069) |  |
| [1070](#L1070) | return ['status' => 'error']; |
| [1071](#L1071) |  |
| [1072](#L1072) | } catch (\Throwable $e) { |
| [1073](#L1073) |  |
| [1074](#L1074) | return ['status' => 'error']; |
| [1075](#L1075) |  |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | } |
| [1079](#L1079) |  |
| [1080](#L1080) | public function restoreBackup() { |
| [1081](#L1081) |  |
| [1082](#L1082) | global $wp\_version; |
| [1083](#L1083) |  |
| [1084](#L1084) | // Require File Scanner |
| [1085](#L1085) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [1086](#L1086) | require\_once BMI\_INCLUDES . '/extracter/extract.php'; |
| [1087](#L1087) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1088](#L1088) | require\_once BMI\_INCLUDES . '/check/checker.php'; |
| [1089](#L1089) |  |
| [1090](#L1090) | // Make AutoLogin possible |
| [1091](#L1091) | $ip = '127.0.0.1'; |
| [1092](#L1092) | if (isset($\_SERVER['HTTP\_CLIENT\_IP'])) { |
| [1093](#L1093) | $ip = $\_SERVER['HTTP\_CLIENT\_IP']; |
| [1094](#L1094) | } else { |
| [1095](#L1095) | if (isset($\_SERVER['HTTP\_X\_FORWARDED\_FOR'])) { |
| [1096](#L1096) | $ip = $\_SERVER['HTTP\_X\_FORWARDED\_FOR']; |
| [1097](#L1097) | } |
| [1098](#L1098) | if ($ip === false) { |
| [1099](#L1099) | if (isset($\_SERVER['REMOTE\_ADDR'])) $ip = $\_SERVER['REMOTE\_ADDR']; |
| [1100](#L1100) | } |
| [1101](#L1101) | } |
| [1102](#L1102) | $autoLoginMD = time() . '\_' . $ip . '\_' . '4u70L051n'; |
| [1103](#L1103) |  |
| [1104](#L1104) | // Progress & lock file |
| [1105](#L1105) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1106](#L1106) | $lock\_cli = BMI\_BACKUPS . '/.migration\_lock\_cli'; |
| [1107](#L1107) | $autologin\_file = BMI\_BACKUPS . '/.autologin'; |
| [1108](#L1108) | $lock\_cli\_end = BMI\_BACKUPS . '/.migration\_lock\_ended'; |
| [1109](#L1109) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1110](#L1110) | $cli\_last\_download = BMI\_BACKUPS . '/.cli\_download\_last'; |
| [1111](#L1111) |  |
| [1112](#L1112) | $ignoreRunCheck = ((isset($this->post['ignoreRunning']) && $this->post['ignoreRunning'] == 'true') ? true : false); |
| [1113](#L1113) | $isCLIRunning = (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) ? true : false; |
| [1114](#L1114) | if ($isCLIRunning) $ignoreRunCheck = false; |
| [1115](#L1115) |  |
| [1116](#L1116) | if (file\_exists($lock) && (time() - filemtime($lock)) < 65 && !$ignoreRunCheck) { |
| [1117](#L1117) | return ['status' => 'msg', 'why' => \_\_('The restore process is currently running, please wait till it end or once the lock file expire.', 'backup-backup'), 'level' => 'warning']; |
| [1118](#L1118) | } |
| [1119](#L1119) |  |
| [1120](#L1120) | // Check if download was via CLI |
| [1121](#L1121) | if ($this->post['file'] == '.cli\_download' && file\_exists($cli\_last\_download)) { |
| [1122](#L1122) | $this->post['file'] = file\_get\_contents($cli\_last\_download); |
| [1123](#L1123) | if (file\_exists($cli\_last\_download)) @unlink($cli\_last\_download); |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | // Logs |
| [1127](#L1127) | $migration = new MigrationProgress($this->post['remote']); |
| [1128](#L1128) | $migration->start(); |
| [1129](#L1129) |  |
| [1130](#L1130) | if ($ignoreRunCheck) { |
| [1131](#L1131) |  |
| [1132](#L1132) | $migration->mute(); |
| [1133](#L1133) |  |
| [1134](#L1134) | } |
| [1135](#L1135) |  |
| [1136](#L1136) | // Check PHP CLI |
| [1137](#L1137) | if ((!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) && (!defined('BMI\_CLI\_REQUEST') || BMI\_CLI\_REQUEST === false)) { |
| [1138](#L1138) |  |
| [1139](#L1139) | $cli\_result = $this->checkIfPHPCliExist($migration); |
| [1140](#L1140) |  |
| [1141](#L1141) | if ($cli\_result !== false) { |
| [1142](#L1142) |  |
| [1143](#L1143) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [1144](#L1144) | $backupName = sanitize\_text\_field($this->post['file']); |
| [1145](#L1145) | $remoteType = 'false'; |
| [1146](#L1146) | if ($this->post['remote'] == 'true' || $this->post['remote'] === true) $remoteType = 'true'; |
| [1147](#L1147) | if (file\_exists($lock\_cli\_end)) @unlink($lock\_cli\_end); |
| [1148](#L1148) |  |
| [1149](#L1149) | $res = null; |
| [1150](#L1150) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_restore ' . $backupName . ' ' . $remoteType . ' > /dev/null &', $res); |
| [1151](#L1151) | $res = implode("\n", $res); |
| [1152](#L1152) |  |
| [1153](#L1153) | sleep(3); |
| [1154](#L1154) |  |
| [1155](#L1155) | if (file\_exists($lock\_cli\_end) && (time() - filemtime($lock\_cli\_end)) < 10) { |
| [1156](#L1156) |  |
| [1157](#L1157) | // Put autologin |
| [1158](#L1158) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1159](#L1159) | touch($autologin\_file); |
| [1160](#L1160) |  |
| [1161](#L1161) | return ['status' => 'cli', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1162](#L1162) | exit; |
| [1163](#L1163) |  |
| [1164](#L1164) | } |
| [1165](#L1165) |  |
| [1166](#L1166) | if (!file\_exists($lock\_cli) || (time() - filemtime($lock\_cli)) > 10) { |
| [1167](#L1167) |  |
| [1168](#L1168) | $progressFile = null; |
| [1169](#L1169) | $migration->log(\_\_('No response from PHP CLI - plugin will try to recover the migration with traditional restore.', 'backup-backup'), 'warn'); |
| [1170](#L1170) | if (file\_exists($lock\_cli)) @unlink($lock\_cli); |
| [1171](#L1171) |  |
| [1172](#L1172) | } else { |
| [1173](#L1173) |  |
| [1174](#L1174) | $progressFile = null; |
| [1175](#L1175) |  |
| [1176](#L1176) | // $migration->log(\_\_('PHP CLI responded with correct code - we will continue via PHP CLI.', 'backup-backup'), 'info'); |
| [1177](#L1177) | // $migration->end(); |
| [1178](#L1178) |  |
| [1179](#L1179) | // Put autologin |
| [1180](#L1180) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1181](#L1181) | touch($autologin\_file); |
| [1182](#L1182) |  |
| [1183](#L1183) | return ['status' => 'cli', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1184](#L1184) | exit; |
| [1185](#L1185) |  |
| [1186](#L1186) | } |
| [1187](#L1187) |  |
| [1188](#L1188) | } else { |
| [1189](#L1189) |  |
| [1190](#L1190) | if (file\_exists($lock\_cli)) @unlink($lock\_cli); |
| [1191](#L1191) |  |
| [1192](#L1192) | } |
| [1193](#L1193) |  |
| [1194](#L1194) | } else { |
| [1195](#L1195) |  |
| [1196](#L1196) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [1197](#L1197) | $migration->log(\_\_('PHP CLI: Restore process initialized, restoring...', 'backup-backup'), 'success'); |
| [1198](#L1198) | touch($lock\_cli); |
| [1199](#L1199) | } else { |
| [1200](#L1200) | $migration->log(\_\_('Restore process initialized, restoring (non-cli mode)...', 'backup-backup'), 'success'); |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | } |
| [1204](#L1204) |  |
| [1205](#L1205) | // Just in case (e.g. syntax error, we can close the file correctly) |
| [1206](#L1206) | $GLOBALS['bmi\_migration\_progress'] = $migration; |
| [1207](#L1207) |  |
| [1208](#L1208) | // Checker |
| [1209](#L1209) | $checker = new Checker($migration); |
| [1210](#L1210) | $zipper = new Zipper(); |
| [1211](#L1211) |  |
| [1212](#L1212) | // Handle remote |
| [1213](#L1213) | if ($this->post['file']) { |
| [1214](#L1214) | $migration->log(\_\_('Restore process responded', 'backup-backup'), 'SUCCESS'); |
| [1215](#L1215) | } |
| [1216](#L1216) |  |
| [1217](#L1217) | // Make lock file |
| [1218](#L1218) | $migration->log(\_\_('Locking migration process', 'backup-backup'), 'SUCCESS'); |
| [1219](#L1219) | touch($lock); |
| [1220](#L1220) |  |
| [1221](#L1221) | // Initializing |
| [1222](#L1222) | $migration->log(\_\_('Initializing restore process', 'backup-backup'), 'STEP'); |
| [1223](#L1223) | $migration->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION), 'info'); |
| [1224](#L1224) |  |
| [1225](#L1225) | // Error handler |
| [1226](#L1226) | $migration->log(\_\_("Initializing custom error handler", 'backup-backup'), 'info'); |
| [1227](#L1227) |  |
| [1228](#L1228) | // Error handler |
| [1229](#L1229) | $this->migration\_progress = &$migration; |
| [1230](#L1230) | $this->migrationErrorHandler(); |
| [1231](#L1231) | $this->migrationExceptionHandler(); |
| [1232](#L1232) |  |
| [1233](#L1233) | $homeURL = site\_url(); |
| [1234](#L1234) | if (strlen($homeURL) <= 8) $homeURL = home\_url(); |
| [1235](#L1235) | if (defined('WP\_SITEURL') && strlen(WP\_SITEURL) > 8) $homeURL = WP\_SITEURL; |
| [1236](#L1236) |  |
| [1237](#L1237) | $migration->log(\_\_("Site which will be restored: ", 'backup-backup') . $homeURL, 'info'); |
| [1238](#L1238) | $migration->log(\_\_("PHP Version: ", 'backup-backup') . PHP\_VERSION, 'info'); |
| [1239](#L1239) | $migration->log(\_\_("WP Version: ", 'backup-backup') . $wp\_version, 'info'); |
| [1240](#L1240) | $migration->log(\_\_("MySQL Version: ", 'backup-backup') . $GLOBALS['wpdb']->db\_version(), 'info'); |
| [1241](#L1241) | $migration->log(\_\_("MySQL Max Length: ", 'backup-backup') . $GLOBALS['wpdb']->get\_results("SHOW VARIABLES LIKE 'max\_allowed\_packet';")[0]->Value, 'info'); |
| [1242](#L1242) | if (isset($\_SERVER['SERVER\_SOFTWARE']) && !defined('BMI\_USING\_CLI\_FUNCTIONALITY')) { |
| [1243](#L1243) | $migration->log(\_\_("Web server: ", 'backup-backup') . $\_SERVER['SERVER\_SOFTWARE'], 'info'); |
| [1244](#L1244) | } else { |
| [1245](#L1245) | $migration->log(\_\_("Web server: Not available", 'backup-backup'), 'info'); |
| [1246](#L1246) | } |
| [1247](#L1247) | $migration->log(\_\_("Max execution time (in seconds): ", 'backup-backup') . @ini\_get('max\_execution\_time'), 'info'); |
| [1248](#L1248) |  |
| [1249](#L1249) | $migration->log(\_\_("Memory limit (server): ", 'backup-backup') . @ini\_get('memory\_limit'), 'info'); |
| [1250](#L1250) | if (defined('WP\_MEMORY\_LIMIT')) { |
| [1251](#L1251) | $migration->log(\_\_("Memory limit (wp-config): ", 'backup-backup') . WP\_MEMORY\_LIMIT, 'info'); |
| [1252](#L1252) | } |
| [1253](#L1253) | if (defined('WP\_MAX\_MEMORY\_LIMIT')) { |
| [1254](#L1254) | $migration->log(\_\_("Memory limit (wp-config admin): ", 'backup-backup') . WP\_MAX\_MEMORY\_LIMIT, 'info'); |
| [1255](#L1255) | } |
| [1256](#L1256) |  |
| [1257](#L1257) | if (defined('BMI\_BACKUP\_PRO')) { |
| [1258](#L1258) | if (BMI\_BACKUP\_PRO == 1) { |
| [1259](#L1259) | $migration->log(\_\_("Premium plugin is enabled and activated", 'backup-backup'), 'info'); |
| [1260](#L1260) | } else { |
| [1261](#L1261) | $migration->log(\_\_("Premium version is enabled but not active, using free plugin.", 'backup-backup'), 'warn'); |
| [1262](#L1262) | } |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | $migration->log(\_\_("Restore process initialized successfully.", 'backup-backup'), 'success'); |
| [1266](#L1266) |  |
| [1267](#L1267) | // Check file size |
| [1268](#L1268) | $zippath = BMP::fixSlashes(BMI\_BACKUPS) . DIRECTORY\_SEPARATOR . $this->post['file']; |
| [1269](#L1269) | if (!$ignoreRunCheck) { |
| [1270](#L1270) |  |
| [1271](#L1271) | $manifest = $zipper->getZipFileContent($zippath, 'bmi\_backup\_manifest.json'); |
| [1272](#L1272) | $migration->log(\_\_('Free space checking...', 'backup-backup'), 'STEP'); |
| [1273](#L1273) | $migration->log(\_\_('Checking if there is enough amount of free space', 'backup-backup'), 'INFO'); |
| [1274](#L1274) | if ($manifest) { |
| [1275](#L1275) | if (isset($manifest->bytes) && $manifest->bytes) { |
| [1276](#L1276) | $bytes = intval($manifest->bytes \* 1.4); |
| [1277](#L1277) | if (!$checker->check\_free\_space($bytes)) { |
| [1278](#L1278) | $migration->log(\_\_('Cannot start migration process', 'backup-backup'), 'ERROR'); |
| [1279](#L1279) | $migration->log(\_\_('Error: There is not enough space on the server, checked: ' . ($bytes) . ' bytes.', 'backup-backup'), 'ERROR'); |
| [1280](#L1280) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1281](#L1281) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1282](#L1282) |  |
| [1283](#L1283) | if (file\_exists($lock)) @unlink($lock); |
| [1284](#L1284) | $migration->log('#004', 'END-CODE'); |
| [1285](#L1285) | $migration->end(); |
| [1286](#L1286) |  |
| [1287](#L1287) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1288](#L1288) | $this->actionsAfterProcess(false, 'migration'); |
| [1289](#L1289) |  |
| [1290](#L1290) | return ['status' => 'error']; |
| [1291](#L1291) | } else { |
| [1292](#L1292) | $migration->log(\_\_('Confirmed, there is enough space on the device, checked: ' . ($bytes) . ' bytes.', 'backup-backup'), 'SUCCESS'); |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) | } else { |
| [1296](#L1296) | $migration->log(\_\_('Cannot start migration process', 'backup-backup'), 'ERROR'); |
| [1297](#L1297) | $migration->log(\_\_('Error: File may not exist, check file name and if it still exist', 'backup-backup'), 'ERROR'); |
| [1298](#L1298) | $migration->log(\_\_('Error: Could not find manifest in backup, file may be broken', 'backup-backup'), 'ERROR'); |
| [1299](#L1299) | $migration->log(\_\_('Error: Btw. because of this I also cannot check free space', 'backup-backup'), 'ERROR'); |
| [1300](#L1300) | $migration->log(\_\_('Used path: ', 'backup-backup') . $zippath, 'ERROR'); |
| [1301](#L1301) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1302](#L1302) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1303](#L1303) |  |
| [1304](#L1304) | if (file\_exists($lock)) @unlink($lock); |
| [1305](#L1305) | $migration->log('#003', 'END-CODE'); |
| [1306](#L1306) | $migration->end(); |
| [1307](#L1307) |  |
| [1308](#L1308) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1309](#L1309) | $this->actionsAfterProcess(false, 'migration'); |
| [1310](#L1310) |  |
| [1311](#L1311) | return ['status' => 'error']; |
| [1312](#L1312) | } |
| [1313](#L1313) |  |
| [1314](#L1314) | } |
| [1315](#L1315) |  |
| [1316](#L1316) | if ($ignoreRunCheck) { |
| [1317](#L1317) |  |
| [1318](#L1318) | $migration->unmute(); |
| [1319](#L1319) |  |
| [1320](#L1320) | } |
| [1321](#L1321) |  |
| [1322](#L1322) | // New extracter |
| [1323](#L1323) | $theTmpName = ((isset($this->post['tmpname'])) ? $this->post['tmpname'] : false); |
| [1324](#L1324) | $options = ((isset($this->post['options'])) ? $this->post['options'] : []); |
| [1325](#L1325) | $extracter = new Extracter($this->post['file'], $migration, $theTmpName, $isCLIRunning, $options); |
| [1326](#L1326) |  |
| [1327](#L1327) | // Extract |
| [1328](#L1328) | $theSecret = ((isset($this->post['secret'])) ? $this->post['secret'] : null); |
| [1329](#L1329) | $isFine = $extracter->extractTo($theSecret); |
| [1330](#L1330) | if (!$isFine) { |
| [1331](#L1331) | $migration->log(\_\_('Aborting...', 'backup-backup'), 'ERROR'); |
| [1332](#L1332) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1333](#L1333) |  |
| [1334](#L1334) | if (file\_exists($lock)) @unlink($lock); |
| [1335](#L1335) | $migration->log('#002', 'END-CODE'); |
| [1336](#L1336) | $migration->end(); |
| [1337](#L1337) |  |
| [1338](#L1338) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1339](#L1339) | $this->actionsAfterProcess(false, 'migration'); |
| [1340](#L1340) |  |
| [1341](#L1341) | return ['status' => 'error']; |
| [1342](#L1342) | } |
| [1343](#L1343) |  |
| [1344](#L1344) | $migration->progress('100'); |
| [1345](#L1345) | $migration->log(\_\_('Restore process completed', 'backup-backup'), 'SUCCESS'); |
| [1346](#L1346) | $migration->log(\_\_('Finalizing restored files', 'backup-backup'), 'STEP'); |
| [1347](#L1347) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1348](#L1348) | if (file\_exists($lock)) @unlink($lock); |
| [1349](#L1349) |  |
| [1350](#L1350) | $migration->log('#001', 'END-CODE'); |
| [1351](#L1351) | $migration->end(); |
| [1352](#L1352) |  |
| [1353](#L1353) | if ($isCLIRunning == true) touch($lock\_cli\_end); |
| [1354](#L1354) |  |
| [1355](#L1355) | // Put autologin |
| [1356](#L1356) | file\_put\_contents($autologin\_file, $autoLoginMD); |
| [1357](#L1357) | touch($autologin\_file); |
| [1358](#L1358) |  |
| [1359](#L1359) | $this->actionsAfterProcess(true, 'migration'); |
| [1360](#L1360) | return ['status' => 'success', 'login' => explode('\_', $autoLoginMD)[0], 'url' => site\_url()]; |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | public function isRunningBackup() { |
| [1364](#L1364) | $this->lock\_cli = BMI\_BACKUPS . '/.backup\_cli\_lock'; |
| [1365](#L1365) |  |
| [1366](#L1366) | // Ongoing processes |
| [1367](#L1367) | $ongoing = get\_option('bmip\_to\_be\_uploaded', [ |
| [1368](#L1368) | 'current\_upload' => [], |
| [1369](#L1369) | 'queue' => [], |
| [1370](#L1370) | 'failed' => [] |
| [1371](#L1371) | ]); |
| [1372](#L1372) |  |
| [1373](#L1373) | // Backup CLI running |
| [1374](#L1374) | if (file\_exists($this->lock\_cli) && (time() - filemtime($this->lock\_cli)) <= 3600) { |
| [1375](#L1375) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning', 'ongoing' => $ongoing]; |
| [1376](#L1376) | } |
| [1377](#L1377) |  |
| [1378](#L1378) | if (file\_exists(BMI\_BACKUPS . '/.running') && (time() - filemtime(BMI\_BACKUPS . '/.running')) <= 65) { |
| [1379](#L1379) | return ['status' => 'msg', 'why' => \_\_('Backup process already running, please wait till it complete.', 'backup-backup'), 'level' => 'warning', 'ongoing' => $ongoing]; |
| [1380](#L1380) | } else { |
| [1381](#L1381) | return ['status' => 'success', 'ongoing' => $ongoing]; |
| [1382](#L1382) | } |
| [1383](#L1383) | } |
| [1384](#L1384) |  |
| [1385](#L1385) | public function stopBackup() { |
| [1386](#L1386) | if (!file\_exists(BMI\_BACKUPS . '/.running')) { |
| [1387](#L1387) | return ['status' => 'msg', 'why' => \_\_('Backup process completed or is not running.', 'backup-backup'), 'level' => 'info']; |
| [1388](#L1388) | } else { |
| [1389](#L1389) | if (!file\_exists(BMI\_BACKUPS . '/.abort')) { |
| [1390](#L1390) | touch(BMI\_BACKUPS . '/.abort'); |
| [1391](#L1391) | } |
| [1392](#L1392) |  |
| [1393](#L1393) | return ['status' => 'success']; |
| [1394](#L1394) | } |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | public function isMigrationLocked() { |
| [1398](#L1398) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1399](#L1399) | $lock\_cli = BMI\_BACKUPS . '/.migration\_lock\_cli'; |
| [1400](#L1400) | $lock\_cli\_end = BMI\_BACKUPS . '/.migration\_lock\_ended'; |
| [1401](#L1401) |  |
| [1402](#L1402) | if ((file\_exists($lock) && (time() - filemtime($lock)) < 65) || (file\_exists($lock\_cli) && (time() - filemtime($lock\_cli)) < 7200)) { |
| [1403](#L1403) |  |
| [1404](#L1404) | return ['status' => 'msg', 'why' => \_\_('Restore process is currently running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [1405](#L1405) |  |
| [1406](#L1406) | } else { |
| [1407](#L1407) |  |
| [1408](#L1408) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1409](#L1409) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1410](#L1410) | $shouldClearLogs = true; |
| [1411](#L1411) |  |
| [1412](#L1412) | if (isset($this->post['clearLogs']) && $this->post['clearLogs'] == 'false') { |
| [1413](#L1413) | $shouldClearLogs = false; |
| [1414](#L1414) | } |
| [1415](#L1415) |  |
| [1416](#L1416) | if ($shouldClearLogs === true) { |
| [1417](#L1417) | if (file\_exists($lock\_cli\_end) && (time() - filemtime($lock\_cli\_end)) > 10) { |
| [1418](#L1418) |  |
| [1419](#L1419) | $migration = new MigrationProgress(); |
| [1420](#L1420) | $migration->start(); |
| [1421](#L1421) | $migration->log(\_\_('Initializing restore process...', 'backup-backup'), 'STEP'); |
| [1422](#L1422) | $migration->end(); |
| [1423](#L1423) |  |
| [1424](#L1424) | file\_put\_contents($progress, '0'); |
| [1425](#L1425) |  |
| [1426](#L1426) | } |
| [1427](#L1427) | } |
| [1428](#L1428) |  |
| [1429](#L1429) | return ['status' => 'success']; |
| [1430](#L1430) |  |
| [1431](#L1431) | } |
| [1432](#L1432) | } |
| [1433](#L1433) |  |
| [1434](#L1434) | public function downloadFile($url, $dest, $progress, $lock, &$logger) { |
| [1435](#L1435) | $current\_percentage = 0; |
| [1436](#L1436) | $previous\_logged = 0; |
| [1437](#L1437) | $fp = fopen($dest, 'w+'); |
| [1438](#L1438) |  |
| [1439](#L1439) | $progressfile = $progress; |
| [1440](#L1440) | $lockfile = $lock; |
| [1441](#L1441) |  |
| [1442](#L1442) | $ch = curl\_init(str\_replace(' ', '%20', $url)); |
| [1443](#L1443) | curl\_setopt($ch, CURLOPT\_TIMEOUT, 0); |
| [1444](#L1444) |  |
| [1445](#L1445) | curl\_setopt($ch, CURLOPT\_FILE, $fp); |
| [1446](#L1446) | curl\_setopt($ch, CURLOPT\_FOLLOWLOCATION, true); |
| [1447](#L1447) | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYHOST, 0); |
| [1448](#L1448) | curl\_setopt($ch, CURLOPT\_SSL\_VERIFYPEER, 0); |
| [1449](#L1449) |  |
| [1450](#L1450) | curl\_setopt($ch, CURLOPT\_NOPROGRESS, false); |
| [1451](#L1451) | curl\_setopt($ch, CURLOPT\_PROGRESSFUNCTION, function ($resource, $download\_size, $downloaded) use (&$current\_percentage, &$lockfile, &$progressfile, &$logger, &$previous\_logged) { |
| [1452](#L1452) | if ($download\_size > 0) { |
| [1453](#L1453) | $new\_percentage = intval(($downloaded / $download\_size) \* 100); |
| [1454](#L1454) |  |
| [1455](#L1455) | if (intval($current\_percentage) != intval($new\_percentage)) { |
| [1456](#L1456) | $logger->progress($new\_percentage); |
| [1457](#L1457) |  |
| [1458](#L1458) | if ($current\_percentage == 0 || ($new\_percentage % 5 == 0) || $new\_percentage > 99) { |
| [1459](#L1459) | $logger->log(sprintf(\_\_('Download progress: %s/%s MB (%s%%)', 'backup-backup'), round($downloaded / 1024 / 1024), round($download\_size / 1024 / 1024), $new\_percentage), 'INFO'); |
| [1460](#L1460) | $previous\_logged = $new\_percentage; |
| [1461](#L1461) | } |
| [1462](#L1462) |  |
| [1463](#L1463) | $current\_percentage = $new\_percentage; |
| [1464](#L1464) | } |
| [1465](#L1465) | } |
| [1466](#L1466) | }); |
| [1467](#L1467) |  |
| [1468](#L1468) | curl\_exec($ch); |
| [1469](#L1469) | $this->lastCurlCode = curl\_getinfo($ch, CURLINFO\_HTTP\_CODE); |
| [1470](#L1470) |  |
| [1471](#L1471) | $error\_msg = false; |
| [1472](#L1472) | if (curl\_errno($ch)) { |
| [1473](#L1473) | $error\_msg = curl\_error($ch); |
| [1474](#L1474) | } |
| [1475](#L1475) |  |
| [1476](#L1476) | curl\_close($ch); |
| [1477](#L1477) | fclose($fp); |
| [1478](#L1478) |  |
| [1479](#L1479) | if ($error\_msg) { |
| [1480](#L1480) | return $error\_msg; |
| [1481](#L1481) | } else { |
| [1482](#L1482) | return false; |
| [1483](#L1483) | } |
| [1484](#L1484) | } |
| [1485](#L1485) |  |
| [1486](#L1486) | public function handleQuickMigration() { |
| [1487](#L1487) | $lock = BMI\_BACKUPS . '/.migration\_lock'; |
| [1488](#L1488) | if (file\_exists($lock) && (time() - filemtime($lock)) < 65) { |
| [1489](#L1489) | return ['status' => 'msg', 'why' => \_\_('Download process is currently running, please wait till it complete.', 'backup-backup'), 'level' => 'warning']; |
| [1490](#L1490) | } |
| [1491](#L1491) |  |
| [1492](#L1492) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [1493](#L1493) | require\_once BMI\_INCLUDES . '/zipper/zipping.php'; |
| [1494](#L1494) |  |
| [1495](#L1495) | $migration = new MigrationProgress(true); |
| [1496](#L1496) | $migration->start(); |
| [1497](#L1497) |  |
| [1498](#L1498) | $tmp\_name = 'backup\_' . time() . '.zip'; |
| [1499](#L1499) |  |
| [1500](#L1500) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true && defined('BMI\_CLI\_ARGUMENT')) { |
| [1501](#L1501) | $url = BMI\_CLI\_ARGUMENT; |
| [1502](#L1502) | } else { |
| [1503](#L1503) | $url = $this->post['url']; |
| [1504](#L1504) | } |
| [1505](#L1505) |  |
| [1506](#L1506) | $dest = BMI\_BACKUPS . '/' . $tmp\_name; |
| [1507](#L1507) | $progress = BMI\_BACKUPS . '/latest\_migration\_progress.log'; |
| [1508](#L1508) | $cli\_lock = BMI\_BACKUPS . '/.cli\_download\_lock'; |
| [1509](#L1509) |  |
| [1510](#L1510) | if (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false) { |
| [1511](#L1511) |  |
| [1512](#L1512) | $cli\_result = $this->checkIfPHPCliExist($migration); |
| [1513](#L1513) | if ($cli\_result !== false) { |
| [1514](#L1514) |  |
| [1515](#L1515) | $cliHandler = trailingslashit(sanitize\_text\_field(BMI\_INCLUDES)) . 'cli-handler.php'; |
| [1516](#L1516) |  |
| [1517](#L1517) | $res = null; |
| [1518](#L1518) | @exec(BMI\_CLI\_EXECUTABLE . ' -f "' . $cliHandler . '" bmi\_quick\_migration "' . $url . '" > /dev/null &', $res); |
| [1519](#L1519) | $res = implode("\n", $res); |
| [1520](#L1520) |  |
| [1521](#L1521) | sleep(2); |
| [1522](#L1522) | if (file\_exists($cli\_lock) && (time() - filemtime($cli\_lock)) < 10) { |
| [1523](#L1523) |  |
| [1524](#L1524) | if (file\_exists($cli\_lock)) @unlink($cli\_lock); |
| [1525](#L1525) | return [ 'status' => 'cli\_download' ]; |
| [1526](#L1526) | exit; |
| [1527](#L1527) |  |
| [1528](#L1528) | } |
| [1529](#L1529) |  |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | } else { |
| [1533](#L1533) |  |
| [1534](#L1534) | $migration->log(\_\_('Downloading via PHP CLI', 'backup-backup')); |
| [1535](#L1535) | touch($cli\_lock); |
| [1536](#L1536) |  |
| [1537](#L1537) | } |
| [1538](#L1538) |  |
| [1539](#L1539) | $migration->log((\_\_("Backup & Migration version: ", 'backup-backup') . BMI\_VERSION)); |
| [1540](#L1540) | $migration->log(\_\_('Creating lock file', 'backup-backup')); |
| [1541](#L1541) | file\_put\_contents($lock, ''); |
| [1542](#L1542) | $migration->log(\_\_('Initializing download process', 'backup-backup'), 'STEP'); |
| [1543](#L1543) | $downstart = microtime(true); |
| [1544](#L1544) | $migration->log(\_\_('Downloading initialized', 'backup-backup'), 'SUCCESS'); |
| [1545](#L1545) | $migration->log(\_\_('Downloading remote file...', 'backup-backup'), 'STEP'); |
| [1546](#L1546) | $migration->log(\_\_('Used URL: ', 'backup-backup') . sanitize\_text\_field($url), 'INFO'); |
| [1547](#L1547) | $fileError = $this->downloadFile($url, $dest, $progress, $lock, $migration); |
| [1548](#L1548) | $migration->log(\_\_('Unlocking migration', 'backup-backup'), 'INFO'); |
| [1549](#L1549) | if (file\_exists($lock)) @unlink($lock); |
| [1550](#L1550) |  |
| [1551](#L1551) | if ($fileError) { |
| [1552](#L1552) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'INFO'); |
| [1553](#L1553) | if (file\_exists($dest)) @unlink($dest); |
| [1554](#L1554) | $migration->log(\_\_('Download error', 'backup-backup'), 'ERROR'); |
| [1555](#L1555) |  |
| [1556](#L1556) | if (strpos($fileError, 'Failed writing body') !== false) { |
| [1557](#L1557) | $migration->log(\_\_('Error: There is not enough space on the server', 'backup-backup'), 'ERROR'); |
| [1558](#L1558) | } else { |
| [1559](#L1559) | $migration->log(\_\_('Error', 'backup-backup') . ': ' . $fileError, 'ERROR'); |
| [1560](#L1560) | } |
| [1561](#L1561) |  |
| [1562](#L1562) | $migration->log('#002', 'END-CODE'); |
| [1563](#L1563) | return ['status' => 'error']; |
| [1564](#L1564) | } else { |
| [1565](#L1565) | $migration->log(\_\_('Download completed (took: ', 'backup-backup') . (microtime(true) - $downstart) . 's)', 'SUCCESS'); |
| [1566](#L1566) | $migration->log(\_\_('Looking for backup manifest', 'backup-backup'), 'STEP'); |
| [1567](#L1567) | $zipper = new Zipper(); |
| [1568](#L1568) | $content = $zipper->getZipFileContent($dest, 'bmi\_backup\_manifest.json'); |
| [1569](#L1569) | if ($content) { |
| [1570](#L1570) | try { |
| [1571](#L1571) | $i = 1; |
| [1572](#L1572) | $name = $content->name; |
| [1573](#L1573) | $prepared\_name = $name; |
| [1574](#L1574) | $migration->log(\_\_('Manifest found remote name: ', 'backup-backup') . $name, 'SUCCESS'); |
| [1575](#L1575) |  |
| [1576](#L1576) | while (file\_exists(BMI\_BACKUPS . '/' . $prepared\_name)) { |
| [1577](#L1577) | $prepared\_name = substr($name, 0, -4) . '\_' . $i . '.zip'; |
| [1578](#L1578) | $i++; |
| [1579](#L1579) | } |
| [1580](#L1580) |  |
| [1581](#L1581) | rename($dest, BMI\_BACKUPS . '/' . $prepared\_name); |
| [1582](#L1582) | $migration->log(\_\_('Requesting restore process', 'backup-backup'), 'STEP'); |
| [1583](#L1583) | $migration->progress(0); |
| [1584](#L1584) | file\_put\_contents(BMI\_BACKUPS . '/' . '.cli\_download\_last', $prepared\_name); |
| [1585](#L1585) | $migration->log('#205', 'END-CODE'); |
| [1586](#L1586) |  |
| [1587](#L1587) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY')) { |
| [1588](#L1588) | $this->post['file'] = '.cli\_download'; |
| [1589](#L1589) | $this->post['remote'] = true; |
| [1590](#L1590) | return $this->restoreBackup(); |
| [1591](#L1591) | } else { |
| [1592](#L1592) | return ['status' => 'success', 'name' => $prepared\_name]; |
| [1593](#L1593) | } |
| [1594](#L1594) | } catch (\Exception $e) { |
| [1595](#L1595) | $migration->log(\_\_('Error: ', 'backup-backup') . $e, 'ERROR'); |
| [1596](#L1596) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1597](#L1597) | if (file\_exists($dest)) @unlink($dest); |
| [1598](#L1598) |  |
| [1599](#L1599) | $migration->log('#002', 'END-CODE'); |
| [1600](#L1600) | return ['status' => 'error']; |
| [1601](#L1601) | } catch (\Throwable $e) { |
| [1602](#L1602) | $migration->log(\_\_('Error: ', 'backup-backup') . $e, 'ERROR'); |
| [1603](#L1603) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1604](#L1604) | if (file\_exists($dest)) @unlink($dest); |
| [1605](#L1605) |  |
| [1606](#L1606) | $migration->log('#002', 'END-CODE'); |
| [1607](#L1607) | return ['status' => 'error']; |
| [1608](#L1608) |  |
| [1609](#L1609) | } |
| [1610](#L1610) |  |
| [1611](#L1611) | } else { |
| [1612](#L1612) |  |
| [1613](#L1613) | // $migration->log(\_\_('Error during manifest check: ', 'backup-backup') . print\_r($content, true), 'ERROR'); |
| [1614](#L1614) | if ($this->lastCurlCode == '403') { |
| [1615](#L1615) | $migration->log(\_\_('Backup is not available to download (Error 403).', 'backup-backup'), 'ERROR'); |
| [1616](#L1616) | $migration->log(\_\_('It is restricted by remote server configuration.', 'backup-backup'), 'ERROR'); |
| [1617](#L1617) | } elseif ($this->lastCurlCode == '423') { |
| [1618](#L1618) | $migration->log(\_\_('Backup is locked on remote site, please unlock remote downloading.', 'backup-backup'), 'ERROR'); |
| [1619](#L1619) | $migration->log(\_\_('You can find the setting in "Where shall the backup(s) be stored?" section.', 'backup-backup'), 'ERROR'); |
| [1620](#L1620) | } elseif ($this->lastCurlCode == '200' || $this->lastCurlCode == '404') { |
| [1621](#L1621) | $migration->log(\_\_('Backup does not exist under provided URL.', 'backup-backup'), 'ERROR'); |
| [1622](#L1622) | $migration->log(\_\_('Please confirm that you can download the backup file via provided URL.', 'backup-backup'), 'ERROR'); |
| [1623](#L1623) | $migration->log(\_\_('...or the manifest file does not exist in the backup.', 'backup-backup'), 'ERROR'); |
| [1624](#L1624) | $migration->log(\_\_('Missing manifest means that the backup is probably invalid.', 'backup-backup'), 'ERROR'); |
| [1625](#L1625) | } else { |
| [1626](#L1626) | $migration->log(\_\_('Manifest file does not exist', 'backup-backup'), 'ERROR'); |
| [1627](#L1627) | $migration->log(\_\_('Downloaded backup may be incomplete (missing manifest)', 'backup-backup'), 'ERROR'); |
| [1628](#L1628) | $migration->log(\_\_('...or provided URL is not a direct download of ZIP file.', 'backup-backup'), 'ERROR'); |
| [1629](#L1629) | $migration->log(\_\_('Removing downloaded file', 'backup-backup'), 'ERROR'); |
| [1630](#L1630) | } |
| [1631](#L1631) |  |
| [1632](#L1632) | if (file\_exists($dest)) @unlink($dest); |
| [1633](#L1633) |  |
| [1634](#L1634) | $migration->log('#002', 'END-CODE'); |
| [1635](#L1635) | return ['status' => 'error']; |
| [1636](#L1636) |  |
| [1637](#L1637) | } |
| [1638](#L1638) | } |
| [1639](#L1639) | } |
| [1640](#L1640) |  |
| [1641](#L1641) | public function handleChunkUpload() { |
| [1642](#L1642) | require\_once BMI\_INCLUDES . '/uploader/chunks.php'; |
| [1643](#L1643) | } |
| [1644](#L1644) |  |
| [1645](#L1645) | public function removeBackupFile() { |
| [1646](#L1646) | $files = $this->post['filenames']; |
| [1647](#L1647) | $deleteCloud = $this->post['deleteCloud'] === 'yes' ? true : false; |
| [1648](#L1648) | $cloudDetails = $this->post['cloudDetails']; |
| [1649](#L1649) |  |
| [1650](#L1650) | $md5\_file\_summary\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR. 'md5summary.php'; |
| [1651](#L1651) | $md5summary = []; |
| [1652](#L1652) |  |
| [1653](#L1653) | if (file\_exists($md5\_file\_summary\_path)) { |
| [1654](#L1654) | $md5summary = file\_get\_contents($md5\_file\_summary\_path); |
| [1655](#L1655) | $md5summary = substr($md5summary, 18, -2); |
| [1656](#L1656) | if (is\_serialized($md5summary)) { |
| [1657](#L1657) | $md5summary = maybe\_unserialize($md5summary); |
| [1658](#L1658) | } |
| [1659](#L1659) | } |
| [1660](#L1660) |  |
| [1661](#L1661) | if ($deleteCloud) { |
| [1662](#L1662) | if (defined('BMI\_BACKUP\_PRO') && defined('BMI\_PRO\_INC')) { |
| [1663](#L1663) | $proPath = BMI\_PRO\_INC . 'external/controller.php'; |
| [1664](#L1664) | if (file\_exists($proPath)) { |
| [1665](#L1665) | require\_once $proPath; |
| [1666](#L1666) | $externalStorage = new ExternalStorage(); |
| [1667](#L1667) | } |
| [1668](#L1668) | } |
| [1669](#L1669) | } |
| [1670](#L1670) |  |
| [1671](#L1671) | try { |
| [1672](#L1672) | if (is\_array($files)) { |
| [1673](#L1673) | for ($i = 0; $i < sizeof($files); $i++) { |
| [1674](#L1674) |  |
| [1675](#L1675) | $removeByMD5 = false; |
| [1676](#L1676) | $file = $files[$i]; |
| [1677](#L1677) | $file = preg\_replace('/\.\./', '', $file); |
| [1678](#L1678) |  |
| [1679](#L1679) | if (file\_exists(BMI\_BACKUPS . '/' . $file)) { |
| [1680](#L1680) |  |
| [1681](#L1681) | if ($deleteCloud) { |
| [1682](#L1682) | do\_action('bmi\_premium\_remove\_backup\_file', md5\_file(BMI\_BACKUPS . '/' . $file)); |
| [1683](#L1683) | } |
| [1684](#L1684) |  |
| [1685](#L1685) | unlink(BMI\_BACKUPS . '/' . $file); |
| [1686](#L1686) |  |
| [1687](#L1687) | } else if ($deleteCloud) $removeByMD5 = true; |
| [1688](#L1688) |  |
| [1689](#L1689) | if (isset($md5summary[$file])) { |
| [1690](#L1690) | $md5s = $md5summary[$file]; |
| [1691](#L1691) |  |
| [1692](#L1692) | for ($j = 0; $j < sizeof($md5s); ++$j) { |
| [1693](#L1693) | $md5\_file\_path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $md5s[$j] . '.json'; |
| [1694](#L1694) | if (file\_exists($md5\_file\_path)) { |
| [1695](#L1695) | if ($deleteCloud) { |
| [1696](#L1696) | do\_action('bmi\_premium\_remove\_backup\_json\_file', $md5s[$j] . '.json'); |
| [1697](#L1697) | } |
| [1698](#L1698) | unlink($md5\_file\_path); |
| [1699](#L1699) | } else if ($deleteCloud) $removeByMD5 = true; |
| [1700](#L1700) | } |
| [1701](#L1701) |  |
| [1702](#L1702) | unset($md5summary[$file]); |
| [1703](#L1703) | } |
| [1704](#L1704) |  |
| [1705](#L1705) | if ($deleteCloud && $removeByMD5) { |
| [1706](#L1706) | if (isset($cloudDetails[$file])) { |
| [1707](#L1707) | do\_action('bmi\_premium\_remove\_backup\_file', $cloudDetails[$file]['md5']); |
| [1708](#L1708) | do\_action('bmi\_premium\_remove\_backup\_json\_file', $cloudDetails[$file]['md5'] . '.json'); |
| [1709](#L1709) | } |
| [1710](#L1710) | } |
| [1711](#L1711) |  |
| [1712](#L1712) | } |
| [1713](#L1713) | } |
| [1714](#L1714) | } catch (\Exception $e) { |
| [1715](#L1715) | return ['status' => 'error', 'e' => $e]; |
| [1716](#L1716) | } catch (\Throwable $e) { |
| [1717](#L1717) | return ['status' => 'error', 'e' => $e]; |
| [1718](#L1718) | } |
| [1719](#L1719) |  |
| [1720](#L1720) | $cacheMd5String = "<?php exit; \$x = '" . serialize($md5summary) . "';"; |
| [1721](#L1721) | file\_put\_contents($md5\_file\_summary\_path, $cacheMd5String); |
| [1722](#L1722) |  |
| [1723](#L1723) | return ['status' => 'success']; |
| [1724](#L1724) | } |
| [1725](#L1725) |  |
| [1726](#L1726) | public function saveStorageConfig() { |
| [1727](#L1727) | $dir\_path = $this->post['directory']; // STORAGE::LOCAL::PATH |
| [1728](#L1728) | $accessible = $this->post['access']; // STORAGE::DIRECT::URL |
| [1729](#L1729) | $gdrivedirname = 'BACKUP\_MIGRATION\_BACKUPS'; // STORAGE::EXTERNAL::GDRIVE::DIRNAME // $this->post['gdrivedirname'] |
| [1730](#L1730) | $curr\_path = Dashboard\bmi\_get\_config('STORAGE::LOCAL::PATH'); |
| [1731](#L1731) |  |
| [1732](#L1732) | $error = 0; |
| [1733](#L1733) | $created = false; |
| [1734](#L1734) |  |
| [1735](#L1735) | if (!preg\_match("/^[a-zA-Z0-9\\_\-\/\.]+$/", $dir\_path)) { |
| [1736](#L1736) | return ['status' => 'msg', 'why' => \_\_('Entered directory/path name does not match allowed characters (Local Storage).', 'backup-backup'), 'level' => 'warning']; |
| [1737](#L1737) | } |
| [1738](#L1738) |  |
| [1739](#L1739) | if (!file\_exists($dir\_path)) { |
| [1740](#L1740) | $created = true; |
| [1741](#L1741) | @mkdir($dir\_path, 0755, true); |
| [1742](#L1742) | } |
| [1743](#L1743) |  |
| [1744](#L1744) | if (defined('BMI\_BACKUP\_PRO') && BMI\_BACKUP\_PRO === 1) { |
| [1745](#L1745) |  |
| [1746](#L1746) | if (isset($this->post['gdrivedirname'])) { |
| [1747](#L1747) | $gdrivedirname = $this->post['gdrivedirname']; |
| [1748](#L1748) |  |
| [1749](#L1749) | if (!preg\_match("/^[a-zA-Z0-9\\_\-\.]+$/", $gdrivedirname)) { |
| [1750](#L1750) | return ['status' => 'msg', 'why' => \_\_('Entered directory name does not match allowed characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1751](#L1751) | } |
| [1752](#L1752) |  |
| [1753](#L1753) | if (strlen(trim($gdrivedirname)) < 3) { |
| [1754](#L1754) | return ['status' => 'msg', 'why' => \_\_('Entered directory name is too short, min 3 characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1755](#L1755) | } |
| [1756](#L1756) |  |
| [1757](#L1757) | if (strlen(trim($gdrivedirname)) > 48) { |
| [1758](#L1758) | return ['status' => 'msg', 'why' => \_\_('Entered directory name is too long, max 48 characters (Google Drive).', 'backup-backup'), 'level' => 'warning']; |
| [1759](#L1759) | } |
| [1760](#L1760) |  |
| [1761](#L1761) | if (!Dashboard\bmi\_set\_config('STORAGE::EXTERNAL::GDRIVE::DIRNAME', $gdrivedirname)) { |
| [1762](#L1762) | $errors++; |
| [1763](#L1763) | } |
| [1764](#L1764) | } |
| [1765](#L1765) |  |
| [1766](#L1766) | if (isset($this->post['gdrive'])) { |
| [1767](#L1767) | $gdriveenabled = $this->post['gdrive']; |
| [1768](#L1768) | if (!Dashboard\bmi\_set\_config('STORAGE::EXTERNAL::GDRIVE', $gdriveenabled)) { |
| [1769](#L1769) | $errors++; |
| [1770](#L1770) | } |
| [1771](#L1771) | } |
| [1772](#L1772) |  |
| [1773](#L1773) | } |
| [1774](#L1774) |  |
| [1775](#L1775) | if (is\_writable($dir\_path)) { |
| [1776](#L1776) | if (!Dashboard\bmi\_set\_config('STORAGE::DIRECT::URL', $accessible)) { |
| [1777](#L1777) | $error++; |
| [1778](#L1778) | } |
| [1779](#L1779) | if (!Dashboard\bmi\_set\_config('STORAGE::LOCAL::PATH', esc\_attr($dir\_path))) { |
| [1780](#L1780) | $error++; |
| [1781](#L1781) | } else { |
| [1782](#L1782) | $cur\_dir = BMP::fixSlashes($curr\_path); |
| [1783](#L1783) | $new\_dir = BMP::fixSlashes($dir\_path); |
| [1784](#L1784) |  |
| [1785](#L1785) | $backups\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'backups'; |
| [1786](#L1786) | $backups\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'backups'; |
| [1787](#L1787) |  |
| [1788](#L1788) | $staging\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'staging'; |
| [1789](#L1789) | $staging\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'staging'; |
| [1790](#L1790) |  |
| [1791](#L1791) | $tmp\_cur\_dir = BMP::fixSlashes($curr\_path) . DIRECTORY\_SEPARATOR . 'tmp'; |
| [1792](#L1792) | $tmp\_new\_dir = BMP::fixSlashes($dir\_path) . DIRECTORY\_SEPARATOR . 'tmp'; |
| [1793](#L1793) |  |
| [1794](#L1794) | update\_option('BMI::STORAGE::LOCAL::PATH', $new\_dir); |
| [1795](#L1795) |  |
| [1796](#L1796) | if ($cur\_dir != $new\_dir) { |
| [1797](#L1797) |  |
| [1798](#L1798) | if (!file\_exists($new\_dir)) @mkdir($new\_dir, 0755, true); |
| [1799](#L1799) | if (!file\_exists($backups\_new\_dir)) @mkdir($backups\_new\_dir, 0755, true); |
| [1800](#L1800) | if (!file\_exists($staging\_new\_dir)) @mkdir($staging\_new\_dir, 0755, true); |
| [1801](#L1801) | if (!file\_exists($tmp\_new\_dir)) @mkdir($tmp\_new\_dir, 0755, true); |
| [1802](#L1802) |  |
| [1803](#L1803) | $scanned\_directory\_staging = array\_diff(scandir($staging\_cur\_dir), ['..', '.']); |
| [1804](#L1804) | foreach ($scanned\_directory\_staging as $i => $file) { |
| [1805](#L1805) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1806](#L1806) | rename($staging\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $staging\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1807](#L1807) | } |
| [1808](#L1808) | } |
| [1809](#L1809) |  |
| [1810](#L1810) | $scanned\_directory\_tmp = array\_diff(scandir($tmp\_cur\_dir), ['..', '.']); |
| [1811](#L1811) | foreach ($scanned\_directory\_tmp as $i => $file) { |
| [1812](#L1812) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1813](#L1813) | rename($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $tmp\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1814](#L1814) | } |
| [1815](#L1815) | } |
| [1816](#L1816) |  |
| [1817](#L1817) | $scanned\_directory\_backups = array\_diff(scandir($backups\_cur\_dir), ['..', '.']); |
| [1818](#L1818) | foreach ($scanned\_directory\_backups as $i => $file) { |
| [1819](#L1819) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1820](#L1820) | rename($backups\_cur\_dir . DIRECTORY\_SEPARATOR . $file, $backups\_new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1821](#L1821) | } |
| [1822](#L1822) | } |
| [1823](#L1823) |  |
| [1824](#L1824) | $scanned\_directory = array\_diff(scandir($cur\_dir), ['..', '.']); |
| [1825](#L1825) | foreach ($scanned\_directory as $i => $file) { |
| [1826](#L1826) | if (file\_exists($cur\_dir . DIRECTORY\_SEPARATOR . $file) && !is\_dir($cur\_dir . DIRECTORY\_SEPARATOR . $file)) { |
| [1827](#L1827) | rename($cur\_dir . DIRECTORY\_SEPARATOR . $file, $new\_dir . DIRECTORY\_SEPARATOR . $file); |
| [1828](#L1828) | } |
| [1829](#L1829) | } |
| [1830](#L1830) |  |
| [1831](#L1831) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1832](#L1832) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1833](#L1833) | if (file\_exists($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($backups\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1834](#L1834) | if (file\_exists($backups\_cur\_dir)) @rmdir($backups\_cur\_dir); |
| [1835](#L1835) |  |
| [1836](#L1836) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1837](#L1837) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1838](#L1838) | if (file\_exists($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($staging\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1839](#L1839) | if (file\_exists($staging\_cur\_dir)) @rmdir($staging\_cur\_dir); |
| [1840](#L1840) |  |
| [1841](#L1841) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . '.htaccess'); |
| [1842](#L1842) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.php'); |
| [1843](#L1843) | if (file\_exists($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html')) @unlink($tmp\_cur\_dir . DIRECTORY\_SEPARATOR . 'index.html'); |
| [1844](#L1844) | if (file\_exists($tmp\_cur\_dir)) @rmdir($tmp\_cur\_dir); |
| [1845](#L1845) |  |
| [1846](#L1846) | if (file\_exists($cur\_dir . DIRECTORY\_SEPARATOR . 'complete\_logs.log')) @unlink($cur\_dir . DIRECTORY\_SEPARATOR . 'complete\_logs.log'); |
| [1847](#L1847) | if (file\_exists($cur\_dir)) @rmdir($cur\_dir); |
| [1848](#L1848) |  |
| [1849](#L1849) | if (is\_dir($cur\_dir) && file\_exists($cur\_dir)) { |
| [1850](#L1850) | $left\_files = array\_diff(scandir($cur\_dir), ['..', '.']); |
| [1851](#L1851) | if (sizeof($left\_files) == 0) { |
| [1852](#L1852) | if (file\_exists($cur\_dir)) { |
| [1853](#L1853) | @rmdir($cur\_dir); |
| [1854](#L1854) | } |
| [1855](#L1855) | } |
| [1856](#L1856) | } |
| [1857](#L1857) |  |
| [1858](#L1858) | } |
| [1859](#L1859) | } |
| [1860](#L1860) | } else { |
| [1861](#L1861) | if ($created === true) { |
| [1862](#L1862) | if (file\_exists($dir\_path)) @unlink($dir\_path); |
| [1863](#L1863) | } |
| [1864](#L1864) |  |
| [1865](#L1865) | return ['status' => 'msg', 'why' => \_\_('Entered path is not writable, cannot be used.', 'backup-backup'), 'level' => 'warning']; |
| [1866](#L1866) | } |
| [1867](#L1867) |  |
| [1868](#L1868) | return ['status' => 'success', 'errors' => $error]; |
| [1869](#L1869) | } |
| [1870](#L1870) |  |
| [1871](#L1871) | public function saveOtherOptions() { |
| [1872](#L1872) |  |
| [1873](#L1873) | // Errors |
| [1874](#L1874) | $invalid\_email = \_\_('Provided email addess is not valid.', 'backup-backup'); |
| [1875](#L1875) | $title\_long = \_\_('Your email title is too long, please change the title (max 64 chars).', 'backup-backup'); |
| [1876](#L1876) | $title\_short = \_\_('Your email title is too short, please use longer one (at least 3 chars).', 'backup-backup'); |
| [1877](#L1877) | $title\_empty = \_\_('Title field is required, please fill it.', 'backup-backup'); |
| [1878](#L1878) | $email\_empty = \_\_('Email field cannot be empty, please fill it.', 'backup-backup'); |
| [1879](#L1879) | $cli\_no\_exist = \_\_('Path to executable that you provided for PHP CLI does not exist.', 'backup-backup'); |
| [1880](#L1880) | $db\_query\_too\_low = \_\_('The value for query amount cannot be smaller than 15.', 'backup-backup'); |
| [1881](#L1881) | $db\_query\_too\_much = \_\_('The value for query amount cannot be larger than 15000.', 'backup-backup'); |
| [1882](#L1882) | $db\_sr\_max\_too\_low = \_\_('The value for search replace max page cannot be smaller than 10.', 'backup-backup'); |
| [1883](#L1883) | $db\_sr\_max\_too\_much = \_\_('The value for search replace max page cannot be larger than 30000.', 'backup-backup'); |
| [1884](#L1884) | $fl\_ex\_max\_too\_low = \_\_('The value for extraction limit cannot be smaller than 50.', 'backup-backup'); |
| [1885](#L1885) | $fl\_ex\_max\_too\_much = \_\_('The value for extraction limit cannot be larger than 20000.', 'backup-backup'); |
| [1886](#L1886) |  |
| [1887](#L1887) | $email = sanitize\_email(trim($this->post['email'])); // OTHER:EMAIL |
| [1888](#L1888) | $email\_title = sanitize\_text\_field(trim($this->post['email\_title'])); // OTHER:EMAIL:TITLE |
| [1889](#L1889) | $schedule\_issues = $this->post['schedule\_issues'] === 'true' ? true : false; // OTHER:EMAIL:NOTIS |
| [1890](#L1890) | $experiment\_timeout = $this->post['experiment\_timeout'] === 'true' ? true : false; // OTHER:EXPERIMENT:TIMEOUT |
| [1891](#L1891) | $experiment\_timeout\_hard = $this->post['experimental\_hard\_timeout'] === 'true' ? true : false; // OTHER:EXPERIMENT:TIMEOUT:HARD |
| [1892](#L1892) | $php\_cli\_manual\_path = isset($this->post['php\_cli\_manual\_path']) ? trim($this->post['php\_cli\_manual\_path']) : ''; // OTHER:CLI:PATH |
| [1893](#L1893) | $php\_cli\_disable\_others = $this->post['php\_cli\_disable\_others'] === 'true' ? true : false; // OTHER:CLI:DISABLE |
| [1894](#L1894) | $normal\_timeout = $this->post['normal\_timeout'] === 'true' ? true : false; // OTHER:USE:TIMEOUT:NORMAL |
| [1895](#L1895) | $insecure\_download = $this->post['download\_technique'] === 'true' ? true : false; // OTHER:DOWNLOAD:DIRECT |
| [1896](#L1896) | $db\_query\_size = isset($this->post['db\_queries\_amount']) ? trim($this->post['db\_queries\_amount']) : '2000'; // OTHER:DB:QUERIES |
| [1897](#L1897) | $db\_search\_replace\_max = isset($this->post['db\_search\_replace\_max']) ? trim($this->post['db\_search\_replace\_max']) : '300'; // OTHER:DB:SEARCHREPLACE:MAX |
| [1898](#L1898) | $file\_limit\_extraction\_max = isset($this->post['file\_limit\_extraction\_max']) ? trim($this->post['file\_limit\_extraction\_max']) : 'auto'; // OTHER:FILE:EXTRACT:MAX |
| [1899](#L1899) | $db\_restore\_splitting = $this->post['bmi-restore-splitting'] === 'true' ? true : false; // OTHER:RESTORE:SPLITTING |
| [1900](#L1900) | $db\_restore\_v3\_engine = $this->post['bmi-db-v3-restore-engine'] === 'true' ? true : false; // OTHER:RESTORE:DB:V3 |
| [1901](#L1901) |  |
| [1902](#L1902) | $no\_assets\_b4\_restore = $this->post['remove-assets-before-restore'] === 'true' ? true : false; // OTHER:RESTORE:BEFORE:CLEANUP |
| [1903](#L1903) | $single\_file\_db\_force = $this->post['bmi-db-single-file-backup'] === 'true' ? true : false; // OTHER:BACKUP:DB:SINGLE:FILE |
| [1904](#L1904) | $db\_batching\_backup = $this->post['bmi-db-batching-backup'] === 'true' ? true : false; // OTHER:BACKUP:DB:BATCHING |
| [1905](#L1905) |  |
| [1906](#L1906) | $bmi\_disable\_space\_check = $this->post['bmi-disable-space-check-function'] === 'true' ? true : false; // OTHER:BACKUP:SPACE:CHECKING |
| [1907](#L1907) |  |
| [1908](#L1908) | $uninstall\_config = $this->post['uninstall\_config'] === 'true' ? true : false; // OTHER:UNINSTALL:CONFIGS |
| [1909](#L1909) | $uninstall\_backups = $this->post['uninstall\_backups'] === 'true' ? true : false; // OTHER:UNINSTALL:BACKUPS |
| [1910](#L1910) |  |
| [1911](#L1911) | if ($experiment\_timeout\_hard === true) { |
| [1912](#L1912) | $experiment\_timeout = false; |
| [1913](#L1913) | } |
| [1914](#L1914) |  |
| [1915](#L1915) | if ($normal\_timeout === true) { |
| [1916](#L1916) | $experiment\_timeout = false; |
| [1917](#L1917) | $experiment\_timeout\_hard = false; |
| [1918](#L1918) | } |
| [1919](#L1919) |  |
| [1920](#L1920) | if (!is\_numeric($db\_query\_size) || empty($db\_query\_size)) { |
| [1921](#L1921) | $db\_query\_size = "2000"; |
| [1922](#L1922) | } |
| [1923](#L1923) |  |
| [1924](#L1924) | if (!is\_numeric($file\_limit\_extraction\_max) || empty($file\_limit\_extraction\_max)) { |
| [1925](#L1925) | $file\_limit\_extraction\_max = "auto"; |
| [1926](#L1926) | } |
| [1927](#L1927) |  |
| [1928](#L1928) | if (!is\_numeric($db\_search\_replace\_max) || empty($db\_search\_replace\_max)) { |
| [1929](#L1929) | $db\_search\_replace\_max = "300"; |
| [1930](#L1930) | } |
| [1931](#L1931) |  |
| [1932](#L1932) | if (strlen($email) <= 0) { |
| [1933](#L1933) | return ['status' => 'msg', 'why' => $email\_empty, 'level' => 'warning']; |
| [1934](#L1934) | } |
| [1935](#L1935) | if (strlen($email\_title) <= 0) { |
| [1936](#L1936) | return ['status' => 'msg', 'why' => $title\_empty, 'level' => 'warning']; |
| [1937](#L1937) | } |
| [1938](#L1938) | if (strlen($email\_title) > 64) { |
| [1939](#L1939) | return ['status' => 'msg', 'why' => $title\_long, 'level' => 'warning']; |
| [1940](#L1940) | } |
| [1941](#L1941) | if (strlen($email\_title) < 3) { |
| [1942](#L1942) | return ['status' => 'msg', 'why' => $title\_short, 'level' => 'warning']; |
| [1943](#L1943) | } |
| [1944](#L1944) | if (!filter\_var($email, FILTER\_VALIDATE\_EMAIL)) { |
| [1945](#L1945) | return ['status' => 'msg', 'why' => $invalid\_email, 'level' => 'warning']; |
| [1946](#L1946) | } |
| [1947](#L1947) | if ($php\_cli\_manual\_path != '' && !file\_exists($php\_cli\_manual\_path)) { |
| [1948](#L1948) | return ['status' => 'msg', 'why' => $cli\_no\_exist, 'level' => 'warning']; |
| [1949](#L1949) | } |
| [1950](#L1950) | if (intval($db\_query\_size) > 15000) { |
| [1951](#L1951) | return ['status' => 'msg', 'why' => $db\_query\_too\_much, 'level' => 'warning']; |
| [1952](#L1952) | } |
| [1953](#L1953) | if (intval($db\_query\_size) < 15) { |
| [1954](#L1954) | return ['status' => 'msg', 'why' => $db\_query\_too\_low, 'level' => 'warning']; |
| [1955](#L1955) | } |
| [1956](#L1956) | if (intval($db\_search\_replace\_max) > 30000) { |
| [1957](#L1957) | return ['status' => 'msg', 'why' => $db\_sr\_max\_too\_much, 'level' => 'warning']; |
| [1958](#L1958) | } |
| [1959](#L1959) | if (intval($db\_search\_replace\_max) < 10) { |
| [1960](#L1960) | return ['status' => 'msg', 'why' => $db\_sr\_max\_too\_low, 'level' => 'warning']; |
| [1961](#L1961) | } |
| [1962](#L1962) | if ($file\_limit\_extraction\_max != 'auto' && intval($file\_limit\_extraction\_max) > 20000) { |
| [1963](#L1963) | return ['status' => 'msg', 'why' => $fl\_ex\_max\_too\_much, 'level' => 'warning']; |
| [1964](#L1964) | } |
| [1965](#L1965) | if ($file\_limit\_extraction\_max != 'auto' && intval($file\_limit\_extraction\_max) < 50) { |
| [1966](#L1966) | return ['status' => 'msg', 'why' => $fl\_ex\_max\_too\_low, 'level' => 'warning']; |
| [1967](#L1967) | } |
| [1968](#L1968) |  |
| [1969](#L1969) | $error = 0; |
| [1970](#L1970) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL', $email)) { |
| [1971](#L1971) | $error++; |
| [1972](#L1972) | } |
| [1973](#L1973) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL:TITLE', $email\_title)) { |
| [1974](#L1974) | $error++; |
| [1975](#L1975) | } |
| [1976](#L1976) | if (!Dashboard\bmi\_set\_config('OTHER:EMAIL:NOTIS', $schedule\_issues)) { |
| [1977](#L1977) | $error++; |
| [1978](#L1978) | } |
| [1979](#L1979) | if (!Dashboard\bmi\_set\_config('OTHER:CLI:PATH', $php\_cli\_manual\_path)) { |
| [1980](#L1980) | $error++; |
| [1981](#L1981) | } |
| [1982](#L1982) | if (!Dashboard\bmi\_set\_config('OTHER:CLI:DISABLE', $php\_cli\_disable\_others)) { |
| [1983](#L1983) | $error++; |
| [1984](#L1984) | } |
| [1985](#L1985) | if (!Dashboard\bmi\_set\_config('OTHER:EXPERIMENT:TIMEOUT', $experiment\_timeout)) { |
| [1986](#L1986) | $error++; |
| [1987](#L1987) | } |
| [1988](#L1988) | if (!Dashboard\bmi\_set\_config('OTHER:EXPERIMENT:TIMEOUT:HARD', $experiment\_timeout\_hard)) { |
| [1989](#L1989) | $error++; |
| [1990](#L1990) | } |
| [1991](#L1991) | if (!Dashboard\bmi\_set\_config('OTHER:USE:TIMEOUT:NORMAL', $normal\_timeout)) { |
| [1992](#L1992) | $error++; |
| [1993](#L1993) | } |
| [1994](#L1994) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:DB:V3', $db\_restore\_v3\_engine)) { |
| [1995](#L1995) | $error++; |
| [1996](#L1996) | } |
| [1997](#L1997) | if (!Dashboard\bmi\_set\_config('OTHER:DB:QUERIES', $db\_query\_size)) { |
| [1998](#L1998) | $error++; |
| [1999](#L1999) | } |
| [2000](#L2000) | if (!Dashboard\bmi\_set\_config('OTHER:DB:SEARCHREPLACE:MAX', $db\_search\_replace\_max)) { |
| [2001](#L2001) | $error++; |
| [2002](#L2002) | } |
| [2003](#L2003) | if (!Dashboard\bmi\_set\_config('OTHER:FILE:EXTRACT:MAX', $file\_limit\_extraction\_max)) { |
| [2004](#L2004) | $error++; |
| [2005](#L2005) | } |
| [2006](#L2006) | if (!Dashboard\bmi\_set\_config('OTHER:DOWNLOAD:DIRECT', $insecure\_download)) { |
| [2007](#L2007) | $error++; |
| [2008](#L2008) | } |
| [2009](#L2009) | if (!Dashboard\bmi\_set\_config('OTHER:UNINSTALL:CONFIGS', $uninstall\_config)) { |
| [2010](#L2010) | $error++; |
| [2011](#L2011) | } |
| [2012](#L2012) | if (!Dashboard\bmi\_set\_config('OTHER:UNINSTALL:BACKUPS', $uninstall\_backups)) { |
| [2013](#L2013) | $error++; |
| [2014](#L2014) | } |
| [2015](#L2015) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:SPLITTING', $db\_restore\_splitting)) { |
| [2016](#L2016) | $error++; |
| [2017](#L2017) | } |
| [2018](#L2018) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:DB:SINGLE:FILE', $single\_file\_db\_force)) { |
| [2019](#L2019) | $error++; |
| [2020](#L2020) | } |
| [2021](#L2021) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:DB:BATCHING', $db\_batching\_backup)) { |
| [2022](#L2022) | $error++; |
| [2023](#L2023) | } |
| [2024](#L2024) | if (!Dashboard\bmi\_set\_config('OTHER:BACKUP:SPACE:CHECKING', $bmi\_disable\_space\_check)) { |
| [2025](#L2025) | $error++; |
| [2026](#L2026) | } |
| [2027](#L2027) | if (!Dashboard\bmi\_set\_config('OTHER:RESTORE:BEFORE:CLEANUP', $no\_assets\_b4\_restore)) { |
| [2028](#L2028) | $error++; |
| [2029](#L2029) | } |
| [2030](#L2030) |  |
| [2031](#L2031) | if (has\_action('bmi\_premium\_other\_options')) { |
| [2032](#L2032) | do\_action('bmi\_premium\_other\_options', $this->post); |
| [2033](#L2033) | } |
| [2034](#L2034) |  |
| [2035](#L2035) | return ['status' => 'success', 'errors' => $error]; |
| [2036](#L2036) | } |
| [2037](#L2037) |  |
| [2038](#L2038) | public function saveStorageTypeConfig() { |
| [2039](#L2039) |  |
| [2040](#L2040) | // Errors |
| [2041](#L2041) | $name\_empty = \_\_('Name is required, please fill the input.', 'backup-backup'); |
| [2042](#L2042) | $name\_long = \_\_('Your name is too long, please change the name.', 'backup-backup'); |
| [2043](#L2043) | $name\_short = \_\_('Your name is too short, please create longer one.', 'backup-backup'); |
| [2044](#L2044) | $name\_space = \_\_('Please, do not use spaces in file name.', 'backup-backup'); |
| [2045](#L2045) | $name\_forbidden = \_\_('Your name contains character(s) that are not allowed in file names: ', 'backup-backup'); |
| [2046](#L2046) |  |
| [2047](#L2047) | $forbidden\_chars = ['/', '\\', '<', '>', ':', '"', "'", '|', '?', '\*', '.', ';', '@', '!', '~', '`', ',', '#', '$', '&', '=', '+']; |
| [2048](#L2048) | $name = trim($this->post['name']); // BACKUP:NAME |
| [2049](#L2049) |  |
| [2050](#L2050) | if (strlen($name) == 0) { |
| [2051](#L2051) | return ['status' => 'msg', 'why' => $name\_empty, 'level' => 'warning']; |
| [2052](#L2052) | } |
| [2053](#L2053) | if (strlen($name) > 40) { |
| [2054](#L2054) | return ['status' => 'msg', 'why' => $name\_long, 'level' => 'warning']; |
| [2055](#L2055) | } |
| [2056](#L2056) | if (strlen($name) < 3) { |
| [2057](#L2057) | return ['status' => 'msg', 'why' => $name\_short, 'level' => 'warning']; |
| [2058](#L2058) | } |
| [2059](#L2059) | if (strpos($name, ' ') !== false) { |
| [2060](#L2060) | return ['status' => 'msg', 'why' => $name\_space, 'level' => 'warning']; |
| [2061](#L2061) | } |
| [2062](#L2062) |  |
| [2063](#L2063) | for ($i = 0; $i < sizeof($forbidden\_chars); ++$i) { |
| [2064](#L2064) | $char = $forbidden\_chars[$i]; |
| [2065](#L2065) | if (strpos($name, $char) !== false) { |
| [2066](#L2066) | return ['status' => 'msg', 'why' => $name\_forbidden . $char, 'level' => 'warning']; |
| [2067](#L2067) | } |
| [2068](#L2068) | } |
| [2069](#L2069) |  |
| [2070](#L2070) | $error = 0; |
| [2071](#L2071) | if (!Dashboard\bmi\_set\_config('BACKUP:NAME', $name)) { |
| [2072](#L2072) | $error++; |
| [2073](#L2073) | } |
| [2074](#L2074) |  |
| [2075](#L2075) | return ['status' => 'success', 'errors' => $error]; |
| [2076](#L2076) | } |
| [2077](#L2077) |  |
| [2078](#L2078) | public function saveFilesConfig() { |
| [2079](#L2079) | $db\_group = $this->post['database\_group']; // BACKUP:DATABASE |
| [2080](#L2080) | $files\_group = $this->post['files\_group']; // BACKUP:FILES |
| [2081](#L2081) |  |
| [2082](#L2082) | $fgp = $this->post['files-group-plugins']; // BACKUP:FILES::PLUGINS |
| [2083](#L2083) | $fgu = $this->post['files-group-uploads']; // BACKUP:FILES::UPLOADS |
| [2084](#L2084) | $fgt = $this->post['files-group-themes']; // BACKUP:FILES::THEMES |
| [2085](#L2085) | $fgoc = $this->post['files-group-other-contents']; // BACKUP:FILES::OTHERS |
| [2086](#L2086) | $fgwp = $this->post['files-group-wp-install']; // BACKUP:FILES::WP |
| [2087](#L2087) |  |
| [2088](#L2088) | $file\_filters = $this->post['files\_by\_filters']; // BACKUP:FILES::FILTER |
| [2089](#L2089) | $ffs = $this->post['ex\_b\_fs']; // BACKUP:FILES::FILTER:SIZE |
| [2090](#L2090) | $ffsizemax = $this->post['BFFSIN']; // BACKUP:FILES::FILTER:SIZE:IN |
| [2091](#L2091) | $ffn = $this->post['ex\_b\_names']; // BACKUP:FILES::FILTER:NAMES |
| [2092](#L2092) | $ffp = $this->post['ex\_b\_fpaths']; // BACKUP:FILES::FILTER:FPATHS |
| [2093](#L2093) | $ffd = $this->post['ex\_b\_dpaths']; // BACKUP:FILES::FILTER:DPATHS |
| [2094](#L2094) |  |
| [2095](#L2095) | $dbeg = $this->post['db-exclude-tables-group']; // BACKUP:DATABASE:EXCLUDE |
| [2096](#L2096) | $dbet = $this->post['db-excluded-tables']; // BACKUP:DATABASE:EXCLUDE:LIST |
| [2097](#L2097) |  |
| [2098](#L2098) | $existant = []; |
| [2099](#L2099) | $parsed = []; |
| [2100](#L2100) | $ffnames = $this->post['dynamic-names']; // BACKUP:FILES::FILTER:NAMES:IN |
| [2101](#L2101) | $ffpnames = array\_unique($this->post['dynamic-fpaths-names']); // BACKUP:FILES::FILTER:FPATHS:IN |
| [2102](#L2102) | $ffdnames = array\_unique($this->post['dynamic-dpaths-names']); // BACKUP:FILES::FILTER:DPATHS:IN |
| [2103](#L2103) |  |
| [2104](#L2104) | if (is\_array($dbet) || is\_object($dbet)) { |
| [2105](#L2105) | if (sizeof($dbet) == 1 && $dbet[0] == 'empty') { |
| [2106](#L2106) | $dbet = []; |
| [2107](#L2107) | } |
| [2108](#L2108) | } |
| [2109](#L2109) |  |
| [2110](#L2110) | if ($dbeg === 'true' || $dbeg === true) $dbeg = true; |
| [2111](#L2111) | else $dbeg = false; |
| [2112](#L2112) |  |
| [2113](#L2113) | $max = sizeof($ffpnames); |
| [2114](#L2114) | for ($i = 0; $i < $max; ++$i) { |
| [2115](#L2115) | if (!is\_string($ffpnames[$i]) || trim(strlen($ffpnames[$i])) <= 1) { |
| [2116](#L2116) | array\_splice($ffpnames, $i, 1); |
| [2117](#L2117) | $i--; |
| [2118](#L2118) | $max--; |
| [2119](#L2119) | } |
| [2120](#L2120) | } |
| [2121](#L2121) |  |
| [2122](#L2122) | $max = sizeof($ffdnames); |
| [2123](#L2123) | for ($i = 0; $i < $max; ++$i) { |
| [2124](#L2124) | if (!is\_string($ffdnames[$i]) || trim(strlen($ffdnames[$i])) <= 1) { |
| [2125](#L2125) | array\_splice($ffdnames, $i, 1); |
| [2126](#L2126) | $i--; |
| [2127](#L2127) | $max--; |
| [2128](#L2128) | } |
| [2129](#L2129) | } |
| [2130](#L2130) |  |
| [2131](#L2131) | for ($i = 0; $i < sizeof($ffnames); ++$i) { |
| [2132](#L2132) | $row = $ffnames[$i]; |
| [2133](#L2133) | $txt = array\_key\_exists('txt', $row) ? "" . $row['txt'] . "" : false; |
| [2134](#L2134) | $pos = array\_key\_exists('pos', $row) ? $row['pos'] : false; |
| [2135](#L2135) | $whr = array\_key\_exists('whr', $row) ? $row['whr'] : false; |
| [2136](#L2136) |  |
| [2137](#L2137) | if ($txt === false || $pos === false || $whr === false) { |
| [2138](#L2138) | continue; |
| [2139](#L2139) | } |
| [2140](#L2140) | if (trim(strlen($txt)) <= 0) { |
| [2141](#L2141) | continue; |
| [2142](#L2142) | } |
| [2143](#L2143) | if (!in\_array($pos, ["1", "2", "3"])) { |
| [2144](#L2144) | continue; |
| [2145](#L2145) | } |
| [2146](#L2146) | if (!in\_array($whr, ["1", "2"])) { |
| [2147](#L2147) | continue; |
| [2148](#L2148) | } |
| [2149](#L2149) | if (in\_array($txt . $pos . $whr, $existant)) { |
| [2150](#L2150) | continue; |
| [2151](#L2151) | } else { |
| [2152](#L2152) | $existant[] = $txt . $pos . $whr; |
| [2153](#L2153) | } |
| [2154](#L2154) |  |
| [2155](#L2155) | $parsed[] = ['txt' => $txt, 'pos' => $pos, 'whr' => $whr]; |
| [2156](#L2156) | } |
| [2157](#L2157) |  |
| [2158](#L2158) | if ($ffs == 'true' && !is\_numeric($ffsizemax)) { |
| [2159](#L2159) | return ['status' => 'msg', 'why' => \_\_('Entred file size limit, is not correct number.', 'backup-backup'), 'level' => 'warning']; |
| [2160](#L2160) | } |
| [2161](#L2161) |  |
| [2162](#L2162) | $error = 0; |
| [2163](#L2163) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE', $db\_group)) { |
| [2164](#L2164) | $error++; |
| [2165](#L2165) | } |
| [2166](#L2166) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES', $files\_group)) { |
| [2167](#L2167) | $error++; |
| [2168](#L2168) | } |
| [2169](#L2169) |  |
| [2170](#L2170) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::PLUGINS', $fgp)) { |
| [2171](#L2171) | $error++; |
| [2172](#L2172) | } |
| [2173](#L2173) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::UPLOADS', $fgu)) { |
| [2174](#L2174) | $error++; |
| [2175](#L2175) | } |
| [2176](#L2176) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::THEMES', $fgt)) { |
| [2177](#L2177) | $error++; |
| [2178](#L2178) | } |
| [2179](#L2179) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::OTHERS', $fgoc)) { |
| [2180](#L2180) | $error++; |
| [2181](#L2181) | } |
| [2182](#L2182) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::WP', $fgwp)) { |
| [2183](#L2183) | $error++; |
| [2184](#L2184) | } |
| [2185](#L2185) |  |
| [2186](#L2186) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER', $file\_filters)) { |
| [2187](#L2187) | $error++; |
| [2188](#L2188) | } |
| [2189](#L2189) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:SIZE', $ffs)) { |
| [2190](#L2190) | $error++; |
| [2191](#L2191) | } |
| [2192](#L2192) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:NAMES', $ffn)) { |
| [2193](#L2193) | $error++; |
| [2194](#L2194) | } |
| [2195](#L2195) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:FPATHS', $ffp)) { |
| [2196](#L2196) | $error++; |
| [2197](#L2197) | } |
| [2198](#L2198) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:DPATHS', $ffd)) { |
| [2199](#L2199) | $error++; |
| [2200](#L2200) | } |
| [2201](#L2201) |  |
| [2202](#L2202) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:SIZE:IN', $ffsizemax)) { |
| [2203](#L2203) | $error++; |
| [2204](#L2204) | } |
| [2205](#L2205) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:NAMES:IN', $parsed)) { |
| [2206](#L2206) | $error++; |
| [2207](#L2207) | } |
| [2208](#L2208) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:FPATHS:IN', $ffpnames)) { |
| [2209](#L2209) | $error++; |
| [2210](#L2210) | } |
| [2211](#L2211) | if (!Dashboard\bmi\_set\_config('BACKUP:FILES::FILTER:DPATHS:IN', $ffdnames)) { |
| [2212](#L2212) | $error++; |
| [2213](#L2213) | } |
| [2214](#L2214) |  |
| [2215](#L2215) | if (defined('BMI\_BACKUP\_PRO') && BMI\_BACKUP\_PRO == 1) { |
| [2216](#L2216) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE:EXCLUDE', $dbeg)) { |
| [2217](#L2217) | $error++; |
| [2218](#L2218) | } |
| [2219](#L2219) | if (!Dashboard\bmi\_set\_config('BACKUP:DATABASE:EXCLUDE:LIST', $dbet)) { |
| [2220](#L2220) | $error++; |
| [2221](#L2221) | } |
| [2222](#L2222) | } |
| [2223](#L2223) |  |
| [2224](#L2224) | // return array('status' => 'msg', 'why' => \_\_('Entred path is not writable or does not exist.', 'backup-backup'), 'level' => 'warning'); |
| [2225](#L2225) |  |
| [2226](#L2226) | return ['status' => 'success', 'errors' => $error]; |
| [2227](#L2227) | } |
| [2228](#L2228) |  |
| [2229](#L2229) | public function scanFilesForBackup(&$progress, $stgSites = [], $fileCalcType = false) { |
| [2230](#L2230) | require\_once BMI\_INCLUDES . '/scanner/files.php'; |
| [2231](#L2231) |  |
| [2232](#L2232) | $stagingSites = []; |
| [2233](#L2233) |  |
| [2234](#L2234) | // Get all directory names of staging sites |
| [2235](#L2235) | foreach ($stgSites as $index => $site) { |
| [2236](#L2236) |  |
| [2237](#L2237) | // Convert every directory to their location path |
| [2238](#L2238) | $stagingSites[] = '\*\*\*ABSPATH\*\*\*/' . $site['name']; |
| [2239](#L2239) |  |
| [2240](#L2240) | } |
| [2241](#L2241) |  |
| [2242](#L2242) | // Use filters? |
| [2243](#L2243) | $is = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER') === 'true' ? true : false; |
| [2244](#L2244) |  |
| [2245](#L2245) | // Get settings form config |
| [2246](#L2246) | $fgp = Dashboard\bmi\_get\_config('BACKUP:FILES::PLUGINS'); |
| [2247](#L2247) | $fgt = Dashboard\bmi\_get\_config('BACKUP:FILES::THEMES'); |
| [2248](#L2248) | $fgu = Dashboard\bmi\_get\_config('BACKUP:FILES::UPLOADS'); |
| [2249](#L2249) | $fgoc = Dashboard\bmi\_get\_config('BACKUP:FILES::OTHERS'); |
| [2250](#L2250) | $fgwp = Dashboard\bmi\_get\_config('BACKUP:FILES::WP'); |
| [2251](#L2251) | $dpathsis = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS') === 'true' ? true : false; |
| [2252](#L2252) | $dpaths = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS:IN'); |
| [2253](#L2253) | $dynamesis = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES') === 'true' ? true : false; |
| [2254](#L2254) | $dynames = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2255](#L2255) | $dynparsed = []; |
| [2256](#L2256) |  |
| [2257](#L2257) | if ($fileCalcType != false) { |
| [2258](#L2258) | $fgp = ($fileCalcType == 'plugins') ? true : false; |
| [2259](#L2259) | $fgt = ($fileCalcType == 'themes') ? true : false; |
| [2260](#L2260) | $fgu = ($fileCalcType == 'uploads') ? true : false; |
| [2261](#L2261) | $fgoc = ($fileCalcType == 'contents\_others') ? true : false; |
| [2262](#L2262) | $fgwp = ($fileCalcType == 'wordpress') ? true : false; |
| [2263](#L2263) | } |
| [2264](#L2264) |  |
| [2265](#L2265) | // Filter dynames to for smaller size |
| [2266](#L2266) | if ($is && $dynamesis) { |
| [2267](#L2267) | for ($i = 0; $i < sizeof($dynames); ++$i) { |
| [2268](#L2268) | $s = $dynames[$i]; |
| [2269](#L2269) | if ($s->whr == '2') { |
| [2270](#L2270) | $dynparsed[] = ['s' => $s->txt, 'w' => $s->pos, 'z' => strlen($s->txt)]; |
| [2271](#L2271) | } |
| [2272](#L2272) | } |
| [2273](#L2273) | } |
| [2274](#L2274) |  |
| [2275](#L2275) | // Set exclusion rules |
| [2276](#L2276) | $ignored\_folders\_default = []; |
| [2277](#L2277) | if ($is && $dynamesis) { |
| [2278](#L2278) | BMP::merge\_arrays($ignored\_folders\_default, $dynparsed); |
| [2279](#L2279) | } |
| [2280](#L2280) | $ignored\_folders = $ignored\_folders\_default; |
| [2281](#L2281) | $ignored\_paths\_default = [BMI\_CONFIG\_DIR, BMI\_BACKUPS, BMI\_ROOT\_DIR]; |
| [2282](#L2282) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/ai1wm-backups"; |
| [2283](#L2283) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/ai1wm-backups-old"; |
| [2284](#L2284) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/mwp-download"; |
| [2285](#L2285) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-clone"; |
| [2286](#L2286) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/updraft"; |
| [2287](#L2287) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backups-dup-pro"; |
| [2288](#L2288) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/wpvividbackups"; |
| [2289](#L2289) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backup-guard"; |
| [2290](#L2290) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backuply"; |
| [2291](#L2291) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/backups-dup-lite"; |
| [2292](#L2292) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/backupbuddy\_backups"; |
| [2293](#L2293) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-file-manager-pro"; |
| [2294](#L2294) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/wp-file-manager"; |
| [2295](#L2295) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/plugins/akeebabackupwp"; |
| [2296](#L2296) |  |
| [2297](#L2297) | // Exclude cache directory permanently as it's just cache |
| [2298](#L2298) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/cache"; |
| [2299](#L2299) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/cache\_bak"; |
| [2300](#L2300) | $ignored\_paths\_default[] = "\*\*\*ABSPATH\*\*\*/wp-content/uploads/cache"; |
| [2301](#L2301) |  |
| [2302](#L2302) | // Add staging sites to permanent exclusion rules |
| [2303](#L2303) | for ($i = 0; $i < sizeof($stagingSites); ++$i) { |
| [2304](#L2304) | $ignored\_paths\_default[] = $stagingSites[$i]; |
| [2305](#L2305) | } |
| [2306](#L2306) |  |
| [2307](#L2307) | if (defined('BMI\_PRO\_ROOT\_DIR')) $ignored\_paths\_default[] = BMI\_PRO\_ROOT\_DIR; |
| [2308](#L2308) | if ($is && $dpathsis) { |
| [2309](#L2309) | BMP::merge\_arrays($ignored\_paths\_default, $dpaths); |
| [2310](#L2310) | } |
| [2311](#L2311) | $ignored\_paths = $ignored\_paths\_default; |
| [2312](#L2312) |  |
| [2313](#L2313) | // Fix slashes for current system (directories) |
| [2314](#L2314) | for ($i = 0; $i < sizeof($ignored\_paths); ++$i) { |
| [2315](#L2315) | $ignored\_paths[$i] = str\_replace('\*\*\*ABSPATH\*\*\*', untrailingslashit(ABSPATH), $ignored\_paths[$i]); |
| [2316](#L2316) | $ignored\_paths[$i] = BMP::fixSlashes($ignored\_paths[$i]); |
| [2317](#L2317) | } |
| [2318](#L2318) |  |
| [2319](#L2319) | // WordPress Paths |
| [2320](#L2320) | $plugins\_path = BMP::fixSlashes(WP\_PLUGIN\_DIR); |
| [2321](#L2321) | $themes\_path = BMP::fixSlashes(dirname(get\_template\_directory())); |
| [2322](#L2322) | $uploads\_path = BMP::fixSlashes(wp\_upload\_dir()['basedir']); |
| [2323](#L2323) | $wp\_contents = BMP::fixSlashes(WP\_CONTENT\_DIR); |
| [2324](#L2324) | $wp\_install = BMP::fixSlashes(ABSPATH); |
| [2325](#L2325) |  |
| [2326](#L2326) | // Getting plugins |
| [2327](#L2327) | $sfgp = Scanner::equalFolderByPath($wp\_install, $plugins\_path, $ignored\_folders); |
| [2328](#L2328) | if ($fgp == 'true' && !$sfgp) { |
| [2329](#L2329) | $plugins\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($plugins\_path, $ignored\_folders, $ignored\_paths); |
| [2330](#L2330) | } |
| [2331](#L2331) |  |
| [2332](#L2332) | // Getting themes |
| [2333](#L2333) | $sfgt = Scanner::equalFolderByPath($wp\_install, $themes\_path, $ignored\_folders); |
| [2334](#L2334) | if ($fgt == 'true' && !$sfgt) { |
| [2335](#L2335) | $themes\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($themes\_path, $ignored\_folders, $ignored\_paths); |
| [2336](#L2336) | } |
| [2337](#L2337) |  |
| [2338](#L2338) | // Getting uploads |
| [2339](#L2339) | $sfgu = Scanner::equalFolderByPath($wp\_install, $uploads\_path, $ignored\_folders); |
| [2340](#L2340) | if ($fgu == 'true' && !$sfgu) { |
| [2341](#L2341) | $uploads\_path\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($uploads\_path, $ignored\_folders, $ignored\_paths); |
| [2342](#L2342) | } |
| [2343](#L2343) |  |
| [2344](#L2344) | // Ignore above paths |
| [2345](#L2345) | $sfgoc = Scanner::equalFolderByPath($wp\_install, $wp\_contents, $ignored\_folders); |
| [2346](#L2346) | if ($fgoc == 'true' && !$sfgoc) { |
| [2347](#L2347) |  |
| [2348](#L2348) | // Ignore common folders (already scanned) |
| [2349](#L2349) | $content\_folders = [$plugins\_path, $themes\_path, $uploads\_path]; |
| [2350](#L2350) | BMP::merge\_arrays($content\_folders, $ignored\_paths); |
| [2351](#L2351) |  |
| [2352](#L2352) | // Getting other contents |
| [2353](#L2353) | $wp\_contents\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($wp\_contents, $ignored\_folders, $content\_folders); |
| [2354](#L2354) | } |
| [2355](#L2355) |  |
| [2356](#L2356) | // Ignore contents path |
| [2357](#L2357) | if ($fgwp == 'true') { |
| [2358](#L2358) |  |
| [2359](#L2359) | // Ignore contents file |
| [2360](#L2360) | $ignored\_paths[] = $wp\_contents; |
| [2361](#L2361) |  |
| [2362](#L2362) | // Getting WP Installation |
| [2363](#L2363) | $wp\_install\_files = Scanner::scanFilesGetNamesWithIgnoreFBC($wp\_install, $ignored\_folders, $ignored\_paths); |
| [2364](#L2364) | } |
| [2365](#L2365) |  |
| [2366](#L2366) | // Concat all file paths |
| [2367](#L2367) | $all\_files = []; |
| [2368](#L2368) | if ($fgp == 'true' && !$sfgp) { |
| [2369](#L2369) | BMP::merge\_arrays($all\_files, $plugins\_path\_files); |
| [2370](#L2370) | unset($plugins\_path\_files); |
| [2371](#L2371) | } |
| [2372](#L2372) |  |
| [2373](#L2373) | if ($fgt == 'true' && !$sfgt) { |
| [2374](#L2374) | BMP::merge\_arrays($all\_files, $themes\_path\_files); |
| [2375](#L2375) | unset($themes\_path\_files); |
| [2376](#L2376) | } |
| [2377](#L2377) |  |
| [2378](#L2378) | if ($fgu == 'true' && !$sfgu) { |
| [2379](#L2379) | BMP::merge\_arrays($all\_files, $uploads\_path\_files); |
| [2380](#L2380) | unset($uploads\_path\_files); |
| [2381](#L2381) | } |
| [2382](#L2382) |  |
| [2383](#L2383) | if ($fgoc == 'true' && !$sfgoc) { |
| [2384](#L2384) | BMP::merge\_arrays($all\_files, $wp\_contents\_files); |
| [2385](#L2385) | unset($wp\_contents\_files); |
| [2386](#L2386) | } |
| [2387](#L2387) |  |
| [2388](#L2388) | if ($fgwp == 'true') { |
| [2389](#L2389) | BMP::merge\_arrays($all\_files, $wp\_install\_files); |
| [2390](#L2390) | unset($wp\_install\_files); |
| [2391](#L2391) | } |
| [2392](#L2392) |  |
| [2393](#L2393) | return $all\_files; |
| [2394](#L2394) | } |
| [2395](#L2395) |  |
| [2396](#L2396) | public function parseFilesForBackup(&$files, &$progress, $cron = false, $dirCalc = false) { |
| [2397](#L2397) |  |
| [2398](#L2398) | $is = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER') === 'true' ? true : false; |
| [2399](#L2399) | $acis = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS') === 'true' && $is) ? true : false; |
| [2400](#L2400) | $ac = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS:IN'); |
| [2401](#L2401) |  |
| [2402](#L2402) | $abis = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES') === 'true' && $is) ? true : false; |
| [2403](#L2403) | $ab = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2404](#L2404) | $abres = []; |
| [2405](#L2405) | $acres = new \stdClass(); |
| [2406](#L2406) |  |
| [2407](#L2407) | // Local list of permanently blocked files |
| [2408](#L2408) | if ($acis == false) { |
| [2409](#L2409) | $acis = true; |
| [2410](#L2410) | $ac = [ |
| [2411](#L2411) | '\*\*\*ABSPATH\*\*\*/wp-content/uploads/wpforms/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2412](#L2412) | '\*\*\*ABSPATH\*\*\*/wp-content/uploads/gravity\_forms/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2413](#L2413) | '\*\*\*ABSPATH\*\*\*/.htaccess.cpmh3129', // Binary broken file of wpforms |
| [2414](#L2414) | '\*\*\*ABSPATH\*\*\*/logs/traffic.html/.md5sums', // Binary broken file of wpforms |
| [2415](#L2415) | '\*\*\*ABSPATH\*\*\*/wp-config.php', // Exclude wp-config.php permanently |
| [2416](#L2416) | '\*\*\*ABSPATH\*\*\*/wp-content/backup-migration-config.php' // Exclude BMI CONFIG hardly |
| [2417](#L2417) | ]; |
| [2418](#L2418) | } else { |
| [2419](#L2419) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/uploads/wpforms/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2420](#L2420) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/uploads/gravity\_forms/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2421](#L2421) | $ac[] = '\*\*\*ABSPATH\*\*\*/.htaccess.cpmh3129'; // Binary broken file of wpforms |
| [2422](#L2422) | $ac[] = '\*\*\*ABSPATH\*\*\*/logs/traffic.html/.md5sums'; // Binary broken file of wpforms |
| [2423](#L2423) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-config.php'; // Exclude wp-config.php permanently |
| [2424](#L2424) | $ac[] = '\*\*\*ABSPATH\*\*\*/wp-content/backup-migration-config.php'; // Exclude BMI CONFIG hardly |
| [2425](#L2425) | } |
| [2426](#L2426) |  |
| [2427](#L2427) | $temp\_is = false; |
| [2428](#L2428) | if ($is == false) { |
| [2429](#L2429) | $temp\_is = true; |
| [2430](#L2430) | } |
| [2431](#L2431) |  |
| [2432](#L2432) | if (($is && $acis) || $temp\_is) { |
| [2433](#L2433) | foreach ($ac as $key => $value) { |
| [2434](#L2434) | $value = str\_replace('\*\*\*ABSPATH\*\*\*', untrailingslashit(ABSPATH), $value); |
| [2435](#L2435) | $value = BMP::fixSlashes($value); |
| [2436](#L2436) | $acres->{$value} = 1; |
| [2437](#L2437) | } |
| [2438](#L2438) | } |
| [2439](#L2439) |  |
| [2440](#L2440) | if ($is && $abis) { |
| [2441](#L2441) | for ($i = 0; $i < sizeof($ab); ++$i) { |
| [2442](#L2442) | $s = $ab[$i]; |
| [2443](#L2443) | if ($s->whr == '1') { |
| [2444](#L2444) | $abres[] = ['s' => $s->txt, 'w' => $s->pos, 'z' => strlen($s->txt)]; |
| [2445](#L2445) | } |
| [2446](#L2446) | } |
| [2447](#L2447) | } |
| [2448](#L2448) |  |
| [2449](#L2449) | $limitcrl = 64; |
| [2450](#L2450) | if ($dirCalc && defined('BMI\_CLI\_ENABLED') && BMI\_CLI\_ENABLED === true && !defined('BMI\_CLI\_FAILED')) $limitcrl = 128; |
| [2451](#L2451) | $first\_big = false; |
| [2452](#L2452) | $sizemax = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:SIZE:IN'); |
| [2453](#L2453) | $usesize = (Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:SIZE') === 'true' && $is) ? true : false; |
| [2454](#L2454) | if (!is\_numeric($sizemax)) { |
| [2455](#L2455) | $usesize = false; |
| [2456](#L2456) | $sizemax = 99999; |
| [2457](#L2457) | } else { |
| [2458](#L2458) | $sizemax = intval($sizemax); |
| [2459](#L2459) | } |
| [2460](#L2460) |  |
| [2461](#L2461) | // If legacy === false it will use background process to bypass the timeout |
| [2462](#L2462) | if ($dirCalc) { |
| [2463](#L2463) | $legacy = true; |
| [2464](#L2464) | } else { |
| [2465](#L2465) | if (!defined('BMI\_LEGACY\_VERSION')) $legacy = true; |
| [2466](#L2466) | else $legacy = BMI\_LEGACY\_VERSION; |
| [2467](#L2467) | if ($legacy && defined('BMI\_LEGACY\_HARD\_VERSION') && !BMI\_LEGACY\_HARD\_VERSION) $legacy = BMI\_LEGACY\_HARD\_VERSION; |
| [2468](#L2468) | if (defined('BMI\_CLI\_ENABLED') && defined('BMI\_FUNCTION\_NORMAL') && BMI\_CLI\_ENABLED === true && BMI\_FUNCTION\_NORMAL === true && !defined('BMI\_CLI\_FAILED')) $legacy = false; |
| [2469](#L2469) | } |
| [2470](#L2470) |  |
| [2471](#L2471) | $total\_size = 0; |
| [2472](#L2472) | $excludedBytes = 0; |
| [2473](#L2473) | $max = $sizemax \* (1024 \* 1024); |
| [2474](#L2474) | $maxfor = sizeof($files); |
| [2475](#L2475) |  |
| [2476](#L2476) | // Non-legacy variables |
| [2477](#L2477) | if ($legacy === false) { |
| [2478](#L2478) | $Hx = trailingslashit(WP\_CONTENT\_DIR); |
| [2479](#L2479) | $Hz = trailingslashit(ABSPATH); |
| [2480](#L2480) | $Hxs = strlen($Hx); |
| [2481](#L2481) | $Hzs = strlen($Hz); |
| [2482](#L2482) | } |
| [2483](#L2483) |  |
| [2484](#L2484) | // Sort it by size |
| [2485](#L2485) | if ($legacy === false) { |
| [2486](#L2486) | usort($files, function ($a, $b) { |
| [2487](#L2487) | $a = explode(',', $a); |
| [2488](#L2488) | $last = sizeof($a) - 1; |
| [2489](#L2489) | $sizea = intval($a[$last]); |
| [2490](#L2490) |  |
| [2491](#L2491) | $b = explode(',', $b); |
| [2492](#L2492) | $last = sizeof($b) - 1; |
| [2493](#L2493) | $sizeb = intval($b[$last]); |
| [2494](#L2494) |  |
| [2495](#L2495) | if ($sizea == $sizeb) return 0; |
| [2496](#L2496) | if ($sizea < $sizeb) return -1; |
| [2497](#L2497) | else return 1; |
| [2498](#L2498) | }); |
| [2499](#L2499) | } |
| [2500](#L2500) |  |
| [2501](#L2501) | // Process due to rules |
| [2502](#L2502) | for ($i = 0; $i < $maxfor; ++$i) { |
| [2503](#L2503) |  |
| [2504](#L2504) | // Remove size from path and get the size |
| [2505](#L2505) | $files[$i] = explode(',', $files[$i]); |
| [2506](#L2506) | $last = sizeof($files[$i]) - 1; |
| [2507](#L2507) | $size = intval($files[$i][$last]); |
| [2508](#L2508) | unset($files[$i][$last]); |
| [2509](#L2509) | $files[$i] = implode(',', $files[$i]); |
| [2510](#L2510) |  |
| [2511](#L2511) | if ($usesize && Scanner::fileTooLarge($size, $max)) { |
| [2512](#L2512) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (too large) ", 'backup-backup') . $files[$i] . ' (' . number\_format(($size / 1024 / 1024), 2) . ' MB)', 'WARN'); |
| [2513](#L2513) | array\_splice($files, $i, 1); |
| [2514](#L2514) | $maxfor--; |
| [2515](#L2515) | $i--; |
| [2516](#L2516) |  |
| [2517](#L2517) | $excludedBytes += $size; |
| [2518](#L2518) | continue; |
| [2519](#L2519) | } |
| [2520](#L2520) |  |
| [2521](#L2521) | if ($abis && Scanner::equalFolder(basename($files[$i]), $abres)) { |
| [2522](#L2522) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (due to exclude rules): ", 'backup-backup') . $files[$i], 'WARN'); |
| [2523](#L2523) | array\_splice($files, $i, 1); |
| [2524](#L2524) | $maxfor--; |
| [2525](#L2525) | $i--; |
| [2526](#L2526) |  |
| [2527](#L2527) | $excludedBytes += $size; |
| [2528](#L2528) | continue; |
| [2529](#L2529) | } |
| [2530](#L2530) |  |
| [2531](#L2531) | if ($acis && property\_exists($acres, $files[$i])) { |
| [2532](#L2532) | if (!$dirCalc) $progress->log(\_\_("Removing file from backup (due to path rules): ", 'backup-backup') . $files[$i], 'WARN'); |
| [2533](#L2533) | array\_splice($files, $i, 1); |
| [2534](#L2534) | $maxfor--; |
| [2535](#L2535) | $i--; |
| [2536](#L2536) |  |
| [2537](#L2537) | $excludedBytes += $size; |
| [2538](#L2538) | continue; |
| [2539](#L2539) | } |
| [2540](#L2540) |  |
| [2541](#L2541) | if ($size === 0) { |
| [2542](#L2542) | array\_splice($files, $i, 1); |
| [2543](#L2543) | $maxfor--; |
| [2544](#L2544) | $i--; |
| [2545](#L2545) |  |
| [2546](#L2546) | $excludedBytes += $size; |
| [2547](#L2547) | continue; |
| [2548](#L2548) | } |
| [2549](#L2549) |  |
| [2550](#L2550) | if (strpos($files[$i], 'bmi-pclzip-') !== false) { |
| [2551](#L2551) | array\_splice($files, $i, 1); |
| [2552](#L2552) | $maxfor--; |
| [2553](#L2553) | $i--; |
| [2554](#L2554) |  |
| [2555](#L2555) | $excludedBytes += $size; |
| [2556](#L2556) | continue; |
| [2557](#L2557) | } |
| [2558](#L2558) |  |
| [2559](#L2559) | if ($size > ($limitcrl \* (1024 \* 1024))) { |
| [2560](#L2560) | if ($first\_big === false) $first\_big = $i; |
| [2561](#L2561) | if (!$dirCalc) $progress->log(\_\_("This file is quite big consider to exclude it, if backup fails: ", 'backup-backup') . $files[$i] . ' (' . BMP::humanSize($size) . ')', 'WARN'); |
| [2562](#L2562) | } |
| [2563](#L2563) |  |
| [2564](#L2564) | if (($legacy === false && (BMI\_FUNCTION\_NORMAL === false || (BMI\_FUNCTION\_NORMAL === true && BMI\_CLI\_ENABLED === true))) && (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false)) { |
| [2565](#L2565) | $fx = strpos($files[$i], $Hx); |
| [2566](#L2566) | $fz = strpos($files[$i], $Hz); |
| [2567](#L2567) |  |
| [2568](#L2568) | if ($fx !== false) $files[$i] = substr\_replace($files[$i], '@1@', $fx, $Hxs); |
| [2569](#L2569) | else if ($fz !== false) $files[$i] = substr\_replace($files[$i], '@2@', $fz, $Hzs); |
| [2570](#L2570) |  |
| [2571](#L2571) | $files[$i] .= ',' . $size; |
| [2572](#L2572) | } |
| [2573](#L2573) | $total\_size += $size; |
| [2574](#L2574) | } |
| [2575](#L2575) |  |
| [2576](#L2576) | if ($legacy === false && (!defined('BMI\_USING\_CLI\_FUNCTIONALITY') || BMI\_USING\_CLI\_FUNCTIONALITY === false)) { |
| [2577](#L2577) | $list\_file = BMI\_TMP . DIRECTORY\_SEPARATOR . 'files\_latest.list'; |
| [2578](#L2578) | if (file\_exists($list\_file)) @unlink($list\_file); |
| [2579](#L2579) | $files\_list = fopen($list\_file, 'a'); |
| [2580](#L2580) | if ($first\_big === false) fwrite($files\_list, sizeof($files) . "\_-1\r\n"); |
| [2581](#L2581) | else fwrite($files\_list, sizeof($files) . '\_' . $first\_big . "\r\n"); |
| [2582](#L2582) | for ($i = 0; $i < sizeof($files); ++$i) { |
| [2583](#L2583) | fwrite($files\_list, $files[$i] . "\r\n"); |
| [2584](#L2584) | } |
| [2585](#L2585) | fclose($files\_list); |
| [2586](#L2586) | $this->first\_big = $first\_big; |
| [2587](#L2587) | } |
| [2588](#L2588) |  |
| [2589](#L2589) | $total\_size += $this->getDatabaseSize(); |
| [2590](#L2590) | $this->total\_excluded\_size\_for\_backup = $excludedBytes; |
| [2591](#L2591) | $this->total\_size\_for\_backup = $total\_size; |
| [2592](#L2592) | $this->total\_size\_for\_backup\_in\_mb = ($total\_size / 1024 / 1024); |
| [2593](#L2593) |  |
| [2594](#L2594) | return $files; |
| [2595](#L2595) | } |
| [2596](#L2596) |  |
| [2597](#L2597) | public function toggleBackupLock($unlock = false) { |
| [2598](#L2598) |  |
| [2599](#L2599) | // Require lib |
| [2600](#L2600) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'zipper' . DIRECTORY\_SEPARATOR . 'zipping.php'; |
| [2601](#L2601) |  |
| [2602](#L2602) | // Backup name |
| [2603](#L2603) | $filename = $this->post['filename']; |
| [2604](#L2604) |  |
| [2605](#L2605) | // Init Zipper |
| [2606](#L2606) | $zipper = new Zipper(); |
| [2607](#L2607) |  |
| [2608](#L2608) | // Path to Backup |
| [2609](#L2609) | $path = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . $filename; |
| [2610](#L2610) | $path\_dir = BMP::fixSlashes(dirname($path)); |
| [2611](#L2611) |  |
| [2612](#L2612) | // Check if file exists |
| [2613](#L2613) | if (!file\_exists($path)) { |
| [2614](#L2614) | return ['status' => 'fail']; |
| [2615](#L2615) | } |
| [2616](#L2616) |  |
| [2617](#L2617) | // Check if directory is correct |
| [2618](#L2618) | if ($path\_dir != BMP::fixSlashes(BMI\_BACKUPS)) { |
| [2619](#L2619) | return ['status' => 'fail']; |
| [2620](#L2620) | } |
| [2621](#L2621) |  |
| [2622](#L2622) | // Toggle the lock |
| [2623](#L2623) | $status = $zipper->lock\_zip($path, $unlock); |
| [2624](#L2624) |  |
| [2625](#L2625) | // Return the status |
| [2626](#L2626) | return ['status' => ($status ? 'success' : 'fail')]; |
| [2627](#L2627) | } |
| [2628](#L2628) |  |
| [2629](#L2629) | public function getDynamicNames() { |
| [2630](#L2630) | $data = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:NAMES:IN'); |
| [2631](#L2631) | $fpdata = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:FPATHS:IN'); |
| [2632](#L2632) | $fddata = Dashboard\bmi\_get\_config('BACKUP:FILES::FILTER:DPATHS:IN'); |
| [2633](#L2633) |  |
| [2634](#L2634) | for ($i = 0; $i < sizeof($fpdata); ++$i) { |
| [2635](#L2635) | $fpdata[$i] = BMP::fixSlashes($fpdata[$i]); |
| [2636](#L2636) | } |
| [2637](#L2637) |  |
| [2638](#L2638) | for ($i = 0; $i < sizeof($fddata); ++$i) { |
| [2639](#L2639) | $fddata[$i] = BMP::fixSlashes($fddata[$i]); |
| [2640](#L2640) | } |
| [2641](#L2641) |  |
| [2642](#L2642) | return [ |
| [2643](#L2643) | 'status' => 'success', |
| [2644](#L2644) | 'dynamic-fpaths-names' => $fpdata, |
| [2645](#L2645) | 'dynamic-dpaths-names' => $fddata, |
| [2646](#L2646) | 'data' => $data |
| [2647](#L2647) | ]; |
| [2648](#L2648) | } |
| [2649](#L2649) |  |
| [2650](#L2650) | public function resetConfiguration() { |
| [2651](#L2651) |  |
| [2652](#L2652) | if (file\_exists(BMI\_CONFIG\_PATH)) { |
| [2653](#L2653) | @unlink(BMI\_CONFIG\_PATH); |
| [2654](#L2654) | } |
| [2655](#L2655) |  |
| [2656](#L2656) | delete\_option('bmi\_hotfixes'); |
| [2657](#L2657) | delete\_option('bmip\_to\_be\_uploaded'); |
| [2658](#L2658) | delete\_option('bmi\_pro\_gd\_client\_id'); |
| [2659](#L2659) | delete\_option('bmi\_pro\_gd\_token'); |
| [2660](#L2660) | delete\_option('bmi\_pro\_cron\_domain\_done'); |
| [2661](#L2661) | delete\_option('BMI::STORAGE::LOCAL::PATH'); |
| [2662](#L2662) |  |
| [2663](#L2663) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'unknown'); |
| [2664](#L2664) |  |
| [2665](#L2665) | return ['status' => 'success']; |
| [2666](#L2666) |  |
| [2667](#L2667) | } |
| [2668](#L2668) |  |
| [2669](#L2669) | public function getSiteData() { |
| [2670](#L2670) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'check' . DIRECTORY\_SEPARATOR . 'system\_info.php'; |
| [2671](#L2671) | $bmi = new SI(); |
| [2672](#L2672) | $bmi = $bmi->to\_array(); |
| [2673](#L2673) |  |
| [2674](#L2674) | return ['status' => 'success', 'data' => $bmi]; |
| [2675](#L2675) | } |
| [2676](#L2676) |  |
| [2677](#L2677) | public function calculateCron() { |
| [2678](#L2678) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'cron' . DIRECTORY\_SEPARATOR . 'handler.php'; |
| [2679](#L2679) |  |
| [2680](#L2680) | $minutes = []; |
| [2681](#L2681) | $keeps = []; |
| [2682](#L2682) | $days = []; |
| [2683](#L2683) | $weeks = []; |
| [2684](#L2684) | $hours = []; |
| [2685](#L2685) |  |
| [2686](#L2686) | for ($i = 1; $i <= 28; ++$i) { |
| [2687](#L2687) | $days[] = substr('0' . $i, -2); |
| [2688](#L2688) | } |
| [2689](#L2689) | for ($i = 1; $i <= 7; ++$i) { |
| [2690](#L2690) | $weeks[] = $i . ''; |
| [2691](#L2691) | } |
| [2692](#L2692) | for ($i = 0; $i <= 23; ++$i) { |
| [2693](#L2693) | $hours[] = substr('0' . $i, -2); |
| [2694](#L2694) | } |
| [2695](#L2695) | for ($i = 0; $i <= 55; $i += 5) { |
| [2696](#L2696) | $minutes[] = substr('0' . $i, -2); |
| [2697](#L2697) | } |
| [2698](#L2698) | for ($i = 1; $i <= 20; ++$i) { |
| [2699](#L2699) | $keeps[] = $i . ''; |
| [2700](#L2700) | } |
| [2701](#L2701) |  |
| [2702](#L2702) | $errors = 0; |
| [2703](#L2703) | if (in\_array($this->post['type'], ['month', 'week', 'day'])) { |
| [2704](#L2704) | if (!Dashboard\bmi\_set\_config('CRON:TYPE', $this->post['type'])) { |
| [2705](#L2705) | $errors++; |
| [2706](#L2706) | } |
| [2707](#L2707) | } |
| [2708](#L2708) | if (in\_array($this->post['day'], $days)) { |
| [2709](#L2709) | if (!Dashboard\bmi\_set\_config('CRON:DAY', $this->post['day'])) { |
| [2710](#L2710) | $errors++; |
| [2711](#L2711) | } |
| [2712](#L2712) | } |
| [2713](#L2713) | if (in\_array($this->post['week'], $weeks)) { |
| [2714](#L2714) | if (!Dashboard\bmi\_set\_config('CRON:WEEK', $this->post['week'])) { |
| [2715](#L2715) | $errors++; |
| [2716](#L2716) | } |
| [2717](#L2717) | } |
| [2718](#L2718) | if (in\_array($this->post['hour'], $hours)) { |
| [2719](#L2719) | if (!Dashboard\bmi\_set\_config('CRON:HOUR', $this->post['hour'])) { |
| [2720](#L2720) | $errors++; |
| [2721](#L2721) | } |
| [2722](#L2722) | } |
| [2723](#L2723) | if (in\_array($this->post['minute'], $minutes)) { |
| [2724](#L2724) | if (!Dashboard\bmi\_set\_config('CRON:MINUTE', $this->post['minute'])) { |
| [2725](#L2725) | $errors++; |
| [2726](#L2726) | } |
| [2727](#L2727) | } |
| [2728](#L2728) | if (in\_array($this->post['keep'], $keeps)) { |
| [2729](#L2729) | if (!Dashboard\bmi\_set\_config('CRON:KEEP', $this->post['keep'])) { |
| [2730](#L2730) | $errors++; |
| [2731](#L2731) | } |
| [2732](#L2732) | } |
| [2733](#L2733) |  |
| [2734](#L2734) | if ($this->post['enabled'] === 'true') { |
| [2735](#L2735) | $this->post['enabled'] = true; |
| [2736](#L2736) | } else { |
| [2737](#L2737) | $this->post['enabled'] = false; |
| [2738](#L2738) | } |
| [2739](#L2739) |  |
| [2740](#L2740) | if (!Dashboard\bmi\_set\_config('CRON:ENABLED', $this->post['enabled'])) { |
| [2741](#L2741) | $errors++; |
| [2742](#L2742) | } |
| [2743](#L2743) |  |
| [2744](#L2744) | if ($errors === 0) { |
| [2745](#L2745) | $time = Crons::calculate\_date([ |
| [2746](#L2746) | 'type' => $this->post['type'], |
| [2747](#L2747) | 'week' => $this->post['week'], |
| [2748](#L2748) | 'day' => $this->post['day'], |
| [2749](#L2749) | 'hour' => $this->post['hour'], |
| [2750](#L2750) | 'minute' => $this->post['minute'] |
| [2751](#L2751) | ], time()); |
| [2752](#L2752) |  |
| [2753](#L2753) | $file = BMI\_TMP . DIRECTORY\_SEPARATOR . '.plan'; |
| [2754](#L2754) | if (file\_exists($file)) { |
| [2755](#L2755) | $earlier = intval(file\_get\_contents($file)); |
| [2756](#L2756) | } else { |
| [2757](#L2757) | $earlier = 0; |
| [2758](#L2758) | } |
| [2759](#L2759) |  |
| [2760](#L2760) | if (!wp\_next\_scheduled('bmi\_do\_backup\_right\_now') || $earlier === 0 || (abs($time - $earlier) >= 15)) { |
| [2761](#L2761) | wp\_clear\_scheduled\_hook('bmi\_do\_backup\_right\_now'); |
| [2762](#L2762) | if ($this->post['enabled'] === true) { |
| [2763](#L2763) | wp\_schedule\_single\_event($time, 'bmi\_do\_backup\_right\_now'); |
| [2764](#L2764) | file\_put\_contents($file, $time); |
| [2765](#L2765) | } |
| [2766](#L2766) | } |
| [2767](#L2767) |  |
| [2768](#L2768) | return [ |
| [2769](#L2769) | 'status' => 'success', |
| [2770](#L2770) | 'data' => date('Y-m-d H:i:s', $time), |
| [2771](#L2771) | 'currdata' => date('Y-m-d H:i:s') |
| [2772](#L2772) | ]; |
| [2773](#L2773) | } else { |
| [2774](#L2774) | return ['status' => 'error']; |
| [2775](#L2775) | } |
| [2776](#L2776) | } |
| [2777](#L2777) |  |
| [2778](#L2778) | public function dismissErrorNotice() { |
| [2779](#L2779) | delete\_option('bmi\_display\_email\_issues'); |
| [2780](#L2780) | } |
| [2781](#L2781) |  |
| [2782](#L2782) | // recursive removal |
| [2783](#L2783) | private function rrmdir($dir) { |
| [2784](#L2784) |  |
| [2785](#L2785) | if (is\_dir($dir)) { |
| [2786](#L2786) |  |
| [2787](#L2787) | $objects = scandir($dir); |
| [2788](#L2788) | foreach ($objects as $object) { |
| [2789](#L2789) |  |
| [2790](#L2790) | if ($object != "." && $object != "..") { |
| [2791](#L2791) |  |
| [2792](#L2792) | if (is\_dir($dir . DIRECTORY\_SEPARATOR . $object) && !is\_link($dir . DIRECTORY\_SEPARATOR . $object)) { |
| [2793](#L2793) |  |
| [2794](#L2794) | $this->rrmdir($dir . DIRECTORY\_SEPARATOR . $object); |
| [2795](#L2795) |  |
| [2796](#L2796) | } else { |
| [2797](#L2797) |  |
| [2798](#L2798) | @unlink($dir . DIRECTORY\_SEPARATOR . $object); |
| [2799](#L2799) |  |
| [2800](#L2800) | } |
| [2801](#L2801) |  |
| [2802](#L2802) | } |
| [2803](#L2803) |  |
| [2804](#L2804) | } |
| [2805](#L2805) |  |
| [2806](#L2806) | @rmdir($dir); |
| [2807](#L2807) |  |
| [2808](#L2808) | } else { |
| [2809](#L2809) |  |
| [2810](#L2810) | if (file\_exists($dir) && is\_file($dir)) { |
| [2811](#L2811) |  |
| [2812](#L2812) | @unlink($dir); |
| [2813](#L2813) |  |
| [2814](#L2814) | } |
| [2815](#L2815) |  |
| [2816](#L2816) | } |
| [2817](#L2817) |  |
| [2818](#L2818) | } |
| [2819](#L2819) |  |
| [2820](#L2820) | public function forceBackupToStop() { |
| [2821](#L2821) |  |
| [2822](#L2822) | $filesToBeRemoved = []; |
| [2823](#L2823) |  |
| [2824](#L2824) | $tmp\_dir = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp'; |
| [2825](#L2825) | if (!is\_dir($tmp\_dir)) @mkdir($tmp\_dir, 0755, true); |
| [2826](#L2826) |  |
| [2827](#L2827) | foreach (scandir($tmp\_dir) as $filename) { |
| [2828](#L2828) |  |
| [2829](#L2829) | if (in\_array($filename, ['.', '..'])) continue; |
| [2830](#L2830) | $path = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp' . DIRECTORY\_SEPARATOR . $filename; |
| [2831](#L2831) | $filesToBeRemoved[] = $path; |
| [2832](#L2832) |  |
| [2833](#L2833) | } |
| [2834](#L2834) |  |
| [2835](#L2835) | $allowedFiles = ['wp-config.php', '.htaccess', '.litespeed', '.default.json', 'driveKeys.php', '.autologin.php', '.migrationFinished']; |
| [2836](#L2836) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . '.\*') as $filename) { |
| [2837](#L2837) |  |
| [2838](#L2838) | $basename = basename($filename); |
| [2839](#L2839) |  |
| [2840](#L2840) | if (in\_array($basename, ['.', '..'])) continue; |
| [2841](#L2841) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2842](#L2842) | $filesToBeRemoved[] = $filename; |
| [2843](#L2843) | } |
| [2844](#L2844) |  |
| [2845](#L2845) | } |
| [2846](#L2846) |  |
| [2847](#L2847) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'BMI-\*', GLOB\_ONLYDIR) as $filename) { |
| [2848](#L2848) |  |
| [2849](#L2849) | $basename = basename($filename); |
| [2850](#L2850) |  |
| [2851](#L2851) | if (in\_array($basename, ['.', '..'])) continue; |
| [2852](#L2852) | if (is\_dir($filename) && !in\_array($filename, $allowedFiles)) { |
| [2853](#L2853) | $filesToBeRemoved[] = $filename; |
| [2854](#L2854) | } |
| [2855](#L2855) |  |
| [2856](#L2856) | } |
| [2857](#L2857) |  |
| [2858](#L2858) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'bg-BMI-\*', GLOB\_ONLYDIR) as $filename) { |
| [2859](#L2859) |  |
| [2860](#L2860) | $basename = basename($filename); |
| [2861](#L2861) |  |
| [2862](#L2862) | if (in\_array($basename, ['.', '..'])) continue; |
| [2863](#L2863) | if (is\_dir($filename) && !in\_array($filename, $allowedFiles)) { |
| [2864](#L2864) | $filesToBeRemoved[] = $filename; |
| [2865](#L2865) | } |
| [2866](#L2866) |  |
| [2867](#L2867) | } |
| [2868](#L2868) |  |
| [2869](#L2869) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock'; |
| [2870](#L2870) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock\_ended'; |
| [2871](#L2871) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.backup\_cli\_lock\_end'; |
| [2872](#L2872) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'; |
| [2873](#L2873) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'db\_tables'; |
| [2874](#L2874) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'bmi\_backup\_manifest.json'; |
| [2875](#L2875) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . 'files\_latest.list'; |
| [2876](#L2876) |  |
| [2877](#L2877) | if (is\_array($filesToBeRemoved) || is\_object($filesToBeRemoved)) { |
| [2878](#L2878) | foreach ((array) $filesToBeRemoved as $file) { |
| [2879](#L2879) | $this->rrmdir($file); |
| [2880](#L2880) | } |
| [2881](#L2881) | } |
| [2882](#L2882) |  |
| [2883](#L2883) | return ['status' => 'success']; |
| [2884](#L2884) |  |
| [2885](#L2885) | } |
| [2886](#L2886) |  |
| [2887](#L2887) | public function forceRestoreToStop() { |
| [2888](#L2888) |  |
| [2889](#L2889) | $filesToBeRemoved = []; |
| [2890](#L2890) |  |
| [2891](#L2891) | $themedir = get\_theme\_root(); |
| [2892](#L2892) | $tempTheme = $themedir . DIRECTORY\_SEPARATOR . 'backup\_migration\_restoration\_in\_progress'; |
| [2893](#L2893) | $filesToBeRemoved[] = $tempTheme; |
| [2894](#L2894) |  |
| [2895](#L2895) | $tmpDirectory = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp'; |
| [2896](#L2896) | if (!is\_dir($tmpDirectory)) @mkdir($tmpDirectory, 0755, true); |
| [2897](#L2897) |  |
| [2898](#L2898) | foreach (scandir($tmpDirectory) as $filename) { |
| [2899](#L2899) |  |
| [2900](#L2900) | if (in\_array($filename, ['.', '..'])) continue; |
| [2901](#L2901) | $path = BMI\_ROOT\_DIR . DIRECTORY\_SEPARATOR . 'tmp' . DIRECTORY\_SEPARATOR . $filename; |
| [2902](#L2902) | $filesToBeRemoved[] = $path; |
| [2903](#L2903) |  |
| [2904](#L2904) | } |
| [2905](#L2905) |  |
| [2906](#L2906) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'backup-migration\_??????????') as $filename) { |
| [2907](#L2907) |  |
| [2908](#L2908) | $basename = basename($filename); |
| [2909](#L2909) |  |
| [2910](#L2910) | if (is\_dir($filename) && !in\_array($basename, ['.', '..'])) { |
| [2911](#L2911) | $filesToBeRemoved[] = $filename; |
| [2912](#L2912) | } |
| [2913](#L2913) |  |
| [2914](#L2914) | } |
| [2915](#L2915) |  |
| [2916](#L2916) | $allowedFiles = ['wp-config.php', '.htaccess', '.litespeed', '.default.json', 'driveKeys.php', '.autologin.php', '.migrationFinished']; |
| [2917](#L2917) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . '.\*') as $filename) { |
| [2918](#L2918) |  |
| [2919](#L2919) | $basename = basename($filename); |
| [2920](#L2920) |  |
| [2921](#L2921) | if (in\_array($basename, ['.', '..'])) continue; |
| [2922](#L2922) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2923](#L2923) | $filesToBeRemoved[] = $filename; |
| [2924](#L2924) | } |
| [2925](#L2925) |  |
| [2926](#L2926) | } |
| [2927](#L2927) |  |
| [2928](#L2928) | foreach (glob(BMI\_TMP . DIRECTORY\_SEPARATOR . 'restore\_scan\_\*') as $filename) { |
| [2929](#L2929) |  |
| [2930](#L2930) | $basename = basename($filename); |
| [2931](#L2931) |  |
| [2932](#L2932) | if (in\_array($basename, ['.', '..'])) continue; |
| [2933](#L2933) | if (is\_file($filename) && !in\_array($basename, $allowedFiles)) { |
| [2934](#L2934) | $filesToBeRemoved[] = $filename; |
| [2935](#L2935) | } |
| [2936](#L2936) |  |
| [2937](#L2937) | } |
| [2938](#L2938) |  |
| [2939](#L2939) | foreach (glob(untrailingslashit(ABSPATH) . DIRECTORY\_SEPARATOR . 'wp-config.??????????.php') as $filename) { |
| [2940](#L2940) |  |
| [2941](#L2941) | $basename = basename($filename); |
| [2942](#L2942) |  |
| [2943](#L2943) | if (in\_array($basename, ['.', '..'])) continue; |
| [2944](#L2944) | if (is\_file($filename) && !in\_array($filename, $allowedFiles)) { |
| [2945](#L2945) | $filesToBeRemoved[] = $filename; |
| [2946](#L2946) | } |
| [2947](#L2947) |  |
| [2948](#L2948) | } |
| [2949](#L2949) |  |
| [2950](#L2950) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock'; |
| [2951](#L2951) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_cli'; |
| [2952](#L2952) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_cli\_end'; |
| [2953](#L2953) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.migration\_lock\_ended'; |
| [2954](#L2954) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.cli\_download\_last'; |
| [2955](#L2955) | $filesToBeRemoved[] = BMI\_BACKUPS . DIRECTORY\_SEPARATOR . '.running'; |
| [2956](#L2956) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . '.restore\_secret'; |
| [2957](#L2957) | $filesToBeRemoved[] = BMI\_TMP . DIRECTORY\_SEPARATOR . '.table\_map'; |
| [2958](#L2958) |  |
| [2959](#L2959) | if (is\_array($filesToBeRemoved) || is\_object($filesToBeRemoved)) { |
| [2960](#L2960) | foreach ((array) $filesToBeRemoved as $file) { |
| [2961](#L2961) | $this->rrmdir($file); |
| [2962](#L2962) | } |
| [2963](#L2963) | } |
| [2964](#L2964) |  |
| [2965](#L2965) | return ['status' => 'success']; |
| [2966](#L2966) |  |
| [2967](#L2967) | } |
| [2968](#L2968) |  |
| [2969](#L2969) | public function sendTroubleshootingDetails($send\_type = 'manual', $triggeredBy = false, $blocking = true) { |
| [2970](#L2970) |  |
| [2971](#L2971) | global $table\_prefix; |
| [2972](#L2972) |  |
| [2973](#L2973) | require\_once BMI\_INCLUDES . DIRECTORY\_SEPARATOR . 'check' . DIRECTORY\_SEPARATOR . 'system\_info.php'; |
| [2974](#L2974) | $bmiSiteData = new SI(); |
| [2975](#L2975) | $bmiSiteData = $bmiSiteData->to\_array(); |
| [2976](#L2976) | $bmiSiteData['database\_size'] = $this->getDatabaseSize(); |
| [2977](#L2977) | $bmiSiteData['database\_size\_mb'] = BMP::humanSize($bmiSiteData['database\_size']); |
| [2978](#L2978) | $bmiSiteData['xhria'] = get\_option('z\_\_bmi\_xhria', 'none'); |
| [2979](#L2979) | $bmiSiteData['current\_table\_prefix'] = $table\_prefix; |
| [2980](#L2980) |  |
| [2981](#L2981) | $wpconfigPath = ABSPATH . DIRECTORY\_SEPARATOR . 'wp-config.php'; |
| [2982](#L2982) | if (file\_exists($wpconfigPath)) { |
| [2983](#L2983) | $bmiSiteData['is\_wp\_config\_writable'] = is\_writable($wpconfigPath) ? "yes" : "no"; |
| [2984](#L2984) | } else { |
| [2985](#L2985) | $bmiSiteData['is\_wp\_config\_writable'] = "file\_does\_not\_exist?"; |
| [2986](#L2986) | } |
| [2987](#L2987) |  |
| [2988](#L2988) | $latestBackupLogs = 'does\_not\_exist'; |
| [2989](#L2989) | $latestBackupProgress = 'does\_not\_exist'; |
| [2990](#L2990) | $latestRestorationLogs = 'does\_not\_exist'; |
| [2991](#L2991) | $latestRestorationProgress = 'does\_not\_exist'; |
| [2992](#L2992) | $latestStagingLogs = 'does\_not\_exist'; |
| [2993](#L2993) | $latestStagingProgress = 'does\_not\_exist'; |
| [2994](#L2994) | $currentPluginConfig = 'does\_not\_exist'; |
| [2995](#L2995) | $pluginGlobalLogs = 'does\_not\_exist'; |
| [2996](#L2996) | $backgroundErrors = 'does\_not\_exist'; |
| [2997](#L2997) |  |
| [2998](#L2998) | if (file\_exists(BMI\_BACKUPS . '/latest.log')) { |
| [2999](#L2999) | $latestBackupLogs = file\_get\_contents(BMI\_BACKUPS . '/latest.log'); |
| [3000](#L3000) | } |
| [3001](#L3001) |  |
| [3002](#L3002) | if (file\_exists(BMI\_BACKUPS . '/latest\_progress.log')) { |
| [3003](#L3003) | $latestBackupProgress = file\_get\_contents(BMI\_BACKUPS . '/latest\_progress.log'); |
| [3004](#L3004) | } |
| [3005](#L3005) |  |
| [3006](#L3006) | if (file\_exists(BMI\_BACKUPS . '/latest\_migration.log')) { |
| [3007](#L3007) | $latestRestorationLogs = file\_get\_contents(BMI\_BACKUPS . '/latest\_migration.log'); |
| [3008](#L3008) | } |
| [3009](#L3009) |  |
| [3010](#L3010) | if (file\_exists(BMI\_BACKUPS . '/latest\_migration\_progress.log')) { |
| [3011](#L3011) | $latestRestorationProgress = file\_get\_contents(BMI\_BACKUPS . '/latest\_migration\_progress.log'); |
| [3012](#L3012) | } |
| [3013](#L3013) |  |
| [3014](#L3014) | if (file\_exists(BMI\_STAGING . '/latest\_staging.log')) { |
| [3015](#L3015) | $latestStagingLogs = file\_get\_contents(BMI\_STAGING . '/latest\_staging.log'); |
| [3016](#L3016) | } |
| [3017](#L3017) |  |
| [3018](#L3018) | if (file\_exists(BMI\_STAGING . '/latest\_staging\_progress.log')) { |
| [3019](#L3019) | $latestStagingProgress = file\_get\_contents(BMI\_STAGING . '/latest\_staging\_progress.log'); |
| [3020](#L3020) | } |
| [3021](#L3021) |  |
| [3022](#L3022) | if (file\_exists(BMI\_CONFIG\_PATH)) { |
| [3023](#L3023) | $currentPluginConfig = substr(file\_get\_contents(BMI\_CONFIG\_PATH), 8); |
| [3024](#L3024) | } |
| [3025](#L3025) |  |
| [3026](#L3026) | $completeLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'complete\_logs.log'; |
| [3027](#L3027) | if (file\_exists($completeLogsPath)) { |
| [3028](#L3028) | if ((filesize($completeLogsPath) / 1024 / 1024) <= 4) { |
| [3029](#L3029) | $pluginGlobalLogs = file\_get\_contents($completeLogsPath); |
| [3030](#L3030) | } else { |
| [3031](#L3031) | @unlink($completeLogsPath); |
| [3032](#L3032) | @touch($completeLogsPath); |
| [3033](#L3033) | $pluginGlobalLogs = 'file\_too\_large'; |
| [3034](#L3034) | } |
| [3035](#L3035) | } |
| [3036](#L3036) |  |
| [3037](#L3037) | $backgroundLogsPath = BMI\_CONFIG\_DIR . DIRECTORY\_SEPARATOR . 'background-errors.log'; |
| [3038](#L3038) | if (file\_exists($backgroundLogsPath)) { |
| [3039](#L3039) | if ((filesize($backgroundLogsPath) / 1024 / 1024) <= 4) { |
| [3040](#L3040) | $backgroundErrors = file\_get\_contents($backgroundLogsPath); |
| [3041](#L3041) | } else { |
| [3042](#L3042) | @unlink($backgroundLogsPath); |
| [3043](#L3043) | @touch($backgroundLogsPath); |
| [3044](#L3044) | $backgroundErrors = 'file\_too\_large'; |
| [3045](#L3045) | } |
| [3046](#L3046) | } |
| [3047](#L3047) |  |
| [3048](#L3048) | $ifCLI = false; |
| [3049](#L3049) | if (defined('BMI\_USING\_CLI\_FUNCTIONALITY') && BMI\_USING\_CLI\_FUNCTIONALITY === true) { |
| [3050](#L3050) | $ifCLI = true; |
| [3051](#L3051) | } |
| [3052](#L3052) |  |
| [3053](#L3053) | $logsSourceFrontEnd = 'manual'; |
| [3054](#L3054) | if ($triggeredBy != false) { |
| [3055](#L3055) | $logsSourceFrontEnd = $triggeredBy; |
| [3056](#L3056) | } |
| [3057](#L3057) | if (isset($this->post['source']) && in\_array($this->post['source'], ['backup', 'migration', 'staging'])) { |
| [3058](#L3058) | $logsSourceFrontEnd = $this->post['source']; |
| [3059](#L3059) | } |
| [3060](#L3060) |  |
| [3061](#L3061) | $url = 'https://' . BMI\_API\_BACKUPBLISS\_PUSH . '/v1' . '/push'; |
| [3062](#L3062) | $data = array( |
| [3063](#L3063) | 'method' => 'POST', |
| [3064](#L3064) | 'timeout' => 15, |
| [3065](#L3065) | 'blocking' => $blocking, |
| [3066](#L3066) | 'sslverify' => false, |
| [3067](#L3067) | 'send\_type' => $send\_type, |
| [3068](#L3068) | 'body' => array( |
| [3069](#L3069) | 'admin\_url' => admin\_url(), |
| [3070](#L3070) | 'home\_url' => home\_url(), |
| [3071](#L3071) | 'site\_url' => get\_site\_url(), |
| [3072](#L3072) | 'is\_multisite' => is\_multisite() ? "yes" : "no", |
| [3073](#L3073) | 'is\_abspath\_writable' => is\_writable(ABSPATH) ? "yes" : "no", |
| [3074](#L3074) | 'site\_information' => $bmiSiteData, |
| [3075](#L3075) | 'latest\_backup\_logs' => $latestBackupLogs, |
| [3076](#L3076) | 'latest\_backup\_progress' => $latestBackupProgress, |
| [3077](#L3077) | 'latest\_restoration\_logs' => $latestRestorationLogs, |
| [3078](#L3078) | 'latest\_restoration\_progress' => $latestRestorationProgress, |
| [3079](#L3079) | 'latest\_staging\_logs' => $latestStagingLogs, |
| [3080](#L3080) | 'latest\_staging\_progress' => $latestStagingProgress, |
| [3081](#L3081) | 'current\_plugin\_config' => $currentPluginConfig, |
| [3082](#L3082) | 'plugin\_global\_logs' => $pluginGlobalLogs, |
| [3083](#L3083) | 'background\_errors' => $backgroundErrors, |
| [3084](#L3084) | 'triggered\_by' => $logsSourceFrontEnd, |
| [3085](#L3085) | 'is\_defined' => defined('BMI\_BACKUP\_PRO') ? 'yes' : 'no', |
| [3086](#L3086) | 'is\_cli' => $ifCLI |
| [3087](#L3087) | ) |
| [3088](#L3088) | ); |
| [3089](#L3089) |  |
| [3090](#L3090) | $disabled\_functions = explode(',', ini\_get('disable\_functions')); |
| [3091](#L3091) | $vA = !in\_array('curl\_exec', $disabled\_functions); |
| [3092](#L3092) | $vB = !in\_array('curl\_init', $disabled\_functions); |
| [3093](#L3093) | $vC = !in\_array('http\_build\_query', $disabled\_functions); |
| [3094](#L3094) | $vD = !in\_array('stream\_context\_create', $disabled\_functions); |
| [3095](#L3095) | $vE = !in\_array('file\_get\_contents', $disabled\_functions); |
| [3096](#L3096) | $vF = false; |
| [3097](#L3097) | $response = false; |
| [3098](#L3098) |  |
| [3099](#L3099) | if (function\_exists('curl\_version') && function\_exists('curl\_exec') && function\_exists('curl\_init') && $vA && $vB) { |
| [3100](#L3100) |  |
| [3101](#L3101) | $response = wp\_remote\_post($url, $data); |
| [3102](#L3102) |  |
| [3103](#L3103) | } else { |
| [3104](#L3104) |  |
| [3105](#L3105) | if (ini\_get('allow\_url\_fopen') == true && $vC && $vD && $vE) { |
| [3106](#L3106) |  |
| [3107](#L3107) | $vF = true; |
| [3108](#L3108) | $postdata = http\_build\_query($data['body']); |
| [3109](#L3109) |  |
| [3110](#L3110) | $opts = [ |
| [3111](#L3111) | 'ssl' => [ 'verify\_peer\_name' => false, 'verify\_peer' => false ], |
| [3112](#L3112) | 'http' => [ |
| [3113](#L3113) | 'method'  => 'POST', |
| [3114](#L3114) | 'header'  => 'Content-type: application/x-www-form-urlencoded', |
| [3115](#L3115) | 'content' => $postdata |
| [3116](#L3116) | ] |
| [3117](#L3117) | ]; |
| [3118](#L3118) |  |
| [3119](#L3119) | $context  = stream\_context\_create($opts); |
| [3120](#L3120) | $result = file\_get\_contents($url, false, $context); |
| [3121](#L3121) |  |
| [3122](#L3122) | $response = [ 'body' => $result ]; |
| [3123](#L3123) |  |
| [3124](#L3124) | } |
| [3125](#L3125) |  |
| [3126](#L3126) | } |
| [3127](#L3127) |  |
| [3128](#L3128) | if ($response === false || is\_wp\_error($response)) { |
| [3129](#L3129) | $error\_message = $response->get\_error\_message(); |
| [3130](#L3130) | Logger::error($error\_message, 'backup-backup'); |
| [3131](#L3131) | return ['status' => 'fail']; |
| [3132](#L3132) | } else { |
| [3133](#L3133) | try { |
| [3134](#L3134) | $body = json\_decode($response['body']); |
| [3135](#L3135) | if (isset($body->code)) { |
| [3136](#L3136) | return ['status' => 'success', 'code' => sanitize\_text\_field($body->code)]; |
| [3137](#L3137) | } else { |
| [3138](#L3138) | return ['status' => 'fail']; |
| [3139](#L3139) | } |
| [3140](#L3140) | } catch (\Exception $e) { |
| [3141](#L3141) | Logger::error(print\_r($e, true), 'backup-backup'); |
| [3142](#L3142) | return ['status' => 'fail']; |
| [3143](#L3143) | } catch (\Throwable $t) { |
| [3144](#L3144) | Logger::error(print\_r($t, true), 'backup-backup'); |
| [3145](#L3145) | return ['status' => 'fail']; |
| [3146](#L3146) | } |
| [3147](#L3147) | } |
| [3148](#L3148) |  |
| [3149](#L3149) | } |
| [3150](#L3150) |  |
| [3151](#L3151) | public function actionsAfterProcess($success = false, $triggeredBy = 'backup') { |
| [3152](#L3152) |  |
| [3153](#L3153) | $afterMigrationLock = BMI\_TMP . DIRECTORY\_SEPARATOR . '.migrationFinished'; |
| [3154](#L3154) |  |
| [3155](#L3155) | if ($success) { |
| [3156](#L3156) |  |
| [3157](#L3157) | file\_put\_contents($afterMigrationLock, ''); |
| [3158](#L3158) |  |
| [3159](#L3159) | } else { |
| [3160](#L3160) |  |
| [3161](#L3161) | if (file\_exists($afterMigrationLock)) @unlink($afterMigrationLock); |
| [3162](#L3162) |  |
| [3163](#L3163) | } |
| [3164](#L3164) |  |
| [3165](#L3165) | BMP::handle\_after\_cron(); |
| [3166](#L3166) |  |
| [3167](#L3167) | return null; |
| [3168](#L3168) |  |
| [3169](#L3169) | // REMOVED CODE: |
| [3170](#L3170) | // $canShare = BMP::canShareLogsOrShouldAsk(); |
| [3171](#L3171) | // if ($canShare === 'allowed') { |
| [3172](#L3172) | // |
| [3173](#L3173) | //   $send\_type = 'error'; |
| [3174](#L3174) | //   if ($success) $send\_type = 'success'; |
| [3175](#L3175) | //   $this->sendTroubleshootingDetails($send\_type, $triggeredBy, false); |
| [3176](#L3176) | // |
| [3177](#L3177) | // } |
| [3178](#L3178) |  |
| [3179](#L3179) | } |
| [3180](#L3180) |  |
| [3181](#L3181) | public function logSharing() { |
| [3182](#L3182) |  |
| [3183](#L3183) | $type = $this->post['question']; |
| [3184](#L3184) |  |
| [3185](#L3185) | if ($type == 'set\_yes') { |
| [3186](#L3186) |  |
| [3187](#L3187) | // $isOk = Dashboard\bmi\_set\_config('LOGS::SHARING', 'yes'); |
| [3188](#L3188) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'yes'); |
| [3189](#L3189) | return ['status' => 'success']; |
| [3190](#L3190) |  |
| [3191](#L3191) | } else if ($type == 'set\_no') { |
| [3192](#L3192) |  |
| [3193](#L3193) | // $isOk = Dashboard\bmi\_set\_config('LOGS::SHARING', 'no'); |
| [3194](#L3194) | // update\_option('BMI\_LOGS\_SHARING\_IS\_ALLOWED', 'no'); |
| [3195](#L3195) | return ['status' => 'success']; |
| [3196](#L3196) |  |
| [3197](#L3197) | } else if ($type == 'is\_allowed') { |
| [3198](#L3198) |  |
| [3199](#L3199) | // $canShare = BMP::canShareLogsOrShouldAsk(); |
| [3200](#L3200) | // return ['status' => 'success', 'result' => $canShare]; |
| [3201](#L3201) | return ['status' => 'success', 'result' => 'not-allowed']; |
| [3202](#L3202) |  |
| [3203](#L3203) | } else { |
| [3204](#L3204) |  |
| [3205](#L3205) | return ['status' => 'fail']; |
| [3206](#L3206) |  |
| [3207](#L3207) | } |
| [3208](#L3208) |  |
| [3209](#L3209) | } |
| [3210](#L3210) |  |
| [3211](#L3211) | public function getLatestBackupFile() { |
| [3212](#L3212) |  |
| [3213](#L3213) | $dir = BMI\_BACKUPS; |
| [3214](#L3214) | $backupdir = array\_diff(scandir($dir), ['..', '.']); |
| [3215](#L3215) | $backups = []; |
| [3216](#L3216) | foreach ($backupdir as $index => $name) { |
| [3217](#L3217) |  |
| [3218](#L3218) | $ext = pathinfo($dir . DIRECTORY\_SEPARATOR . $name, PATHINFO\_EXTENSION); |
| [3219](#L3219) |  |
| [3220](#L3220) | if ($ext === 'zip') { |
| [3221](#L3221) | $backups[] = [ |
| [3222](#L3222) | 'cdate' => filemtime($dir . DIRECTORY\_SEPARATOR . $name), |
| [3223](#L3223) | 'name' => $name |
| [3224](#L3224) | ]; |
| [3225](#L3225) | } |
| [3226](#L3226) |  |
| [3227](#L3227) | } |
| [3228](#L3228) |  |
| [3229](#L3229) | usort($backups, function ($a, $b) { |
| [3230](#L3230) | if (intval($a['cdate']) < intval($b['cdate'])) return 1; |
| [3231](#L3231) | else return -1; |
| [3232](#L3232) | }); |
| [3233](#L3233) |  |
| [3234](#L3234) | $backups = array\_values($backups); |
| [3235](#L3235) |  |
| [3236](#L3236) | if (sizeof($backups) > 0) { |
| [3237](#L3237) | return $backups[0]['name']; |
| [3238](#L3238) | } else { |
| [3239](#L3239) | return '---'; |
| [3240](#L3240) | } |
| [3241](#L3241) |  |
| [3242](#L3242) | } |
| [3243](#L3243) |  |
| [3244](#L3244) | /\*\* |
| [3245](#L3245) | \* isStagingSiteCreationOngoing - Checks if the process is ongoing or not |
| [3246](#L3246) | \* |
| [3247](#L3247) | \* @return {bool} true if the process is running false if its not |
| [3248](#L3248) | \*/ |
| [3249](#L3249) | public function isStagingSiteCreationOngoing() { |
| [3250](#L3250) |  |
| [3251](#L3251) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3252](#L3252) | if (file\_exists($staging\_lock) && (time() - filemtime($staging\_lock)) <= 15) { |
| [3253](#L3253) | return true; |
| [3254](#L3254) | } else { |
| [3255](#L3255) | return false; |
| [3256](#L3256) | } |
| [3257](#L3257) |  |
| [3258](#L3258) | } |
| [3259](#L3259) |  |
| [3260](#L3260) | /\*\* |
| [3261](#L3261) | \* checkStagingLocalName - Verifies name of staging site and checks if it's not currently running |
| [3262](#L3262) | \* Can be called for verification pre start or during start on initial request |
| [3263](#L3263) | \* |
| [3264](#L3264) | \* @param  {string} $name = false name of staging site if called without ajax |
| [3265](#L3265) | \* @return {array} with status/fail/progress data |
| [3266](#L3266) | \*/ |
| [3267](#L3267) | public function checkStagingLocalName($name = false) { |
| [3268](#L3268) |  |
| [3269](#L3269) | if ($name == false && isset($this->post['name'])) { |
| [3270](#L3270) | $name = $this->post['name']; |
| [3271](#L3271) | } |
| [3272](#L3272) |  |
| [3273](#L3273) | $ongoing = \_\_('Staging site creation is already ongoing, please wait and try again.', 'backup-backup'); |
| [3274](#L3274) | $empty = \_\_('You have to provide some staging site name before process.', 'backup-backup'); |
| [3275](#L3275) | $toolong = \_\_('Staging site name cannot be longer than 24 characters.', 'backup-backup'); |
| [3276](#L3276) | $invalid = \_\_('Provided name contains prohibited characters.', 'backup-backup'); |
| [3277](#L3277) | $blacklisted = \_\_('This name is not allowed to be used, please pick different one.', 'backup-backup'); |
| [3278](#L3278) | $exist = \_\_('Seems like directory or staging site with that name already exist, pick different one.', 'backup-backup'); |
| [3279](#L3279) | $dashes = \_\_('Name cannot start or end with dash or underscore.', 'backup-backup'); |
| [3280](#L3280) |  |
| [3281](#L3281) | if ($this->isStagingSiteCreationOngoing()) { |
| [3282](#L3282) | return ['status' => 'fail', 'message' => $ongoing]; |
| [3283](#L3283) | } |
| [3284](#L3284) |  |
| [3285](#L3285) | if (strlen($name) <= 0) { |
| [3286](#L3286) | return ['status' => 'fail', 'message' => $empty]; |
| [3287](#L3287) | } |
| [3288](#L3288) |  |
| [3289](#L3289) | if (!preg\_match('/^[a-zA-Z0-9-\_]+$/', $name)) { |
| [3290](#L3290) | return ['status' => 'fail', 'message' => $invalid]; |
| [3291](#L3291) | } |
| [3292](#L3292) |  |
| [3293](#L3293) | if (strlen($name) >= 24) { |
| [3294](#L3294) | return ['status' => 'fail', 'message' => $toolong]; |
| [3295](#L3295) | } |
| [3296](#L3296) |  |
| [3297](#L3297) | if (in\_array($name[0], ['\_', '-']) || in\_array($name[strlen($name) - 1], ['\_', '-'])) { |
| [3298](#L3298) | return ['status' => 'fail', 'message' => $dashes]; |
| [3299](#L3299) | } |
| [3300](#L3300) |  |
| [3301](#L3301) | $bannedNames = [ |
| [3302](#L3302) | 'wp-content', |
| [3303](#L3303) | 'wp-admin', |
| [3304](#L3304) | 'wp-includes', |
| [3305](#L3305) | 'content', |
| [3306](#L3306) | 'admin', |
| [3307](#L3307) | 'includes', |
| [3308](#L3308) | 'tmp', |
| [3309](#L3309) | '.well-known', |
| [3310](#L3310) | 'download', |
| [3311](#L3311) | 'downloads', |
| [3312](#L3312) | 'google', |
| [3313](#L3313) | 'temporary' |
| [3314](#L3314) | ]; |
| [3315](#L3315) |  |
| [3316](#L3316) | if (strpos($name, '.') !== false) { |
| [3317](#L3317) | return ['status' => 'fail', 'message' => $blacklisted]; |
| [3318](#L3318) | } |
| [3319](#L3319) |  |
| [3320](#L3320) | if (in\_array($name, $bannedNames)) { |
| [3321](#L3321) | return ['status' => 'fail', 'message' => $blacklisted]; |
| [3322](#L3322) | } |
| [3323](#L3323) |  |
| [3324](#L3324) | $path = trailingslashit(ABSPATH) . $name; |
| [3325](#L3325) | if (file\_exists($path) || is\_dir($path)) { |
| [3326](#L3326) | return ['status' => 'fail', 'message' => $exist]; |
| [3327](#L3327) | } |
| [3328](#L3328) |  |
| [3329](#L3329) | return ['status' => 'success']; |
| [3330](#L3330) |  |
| [3331](#L3331) | } |
| [3332](#L3332) |  |
| [3333](#L3333) | /\*\* |
| [3334](#L3334) | \* startLocalStagingCreation - Initials creation of staging site process |
| [3335](#L3335) | \* |
| [3336](#L3336) | \* @return {array} with status/fail/progress data |
| [3337](#L3337) | \*/ |
| [3338](#L3338) | public function startLocalStagingCreation() { |
| [3339](#L3339) |  |
| [3340](#L3340) | // Verification of state |
| [3341](#L3341) | $name = $this->post['name']; |
| [3342](#L3342) | $verification = $this->checkStagingLocalName($name); |
| [3343](#L3343) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3344](#L3344) |  |
| [3345](#L3345) | // Fail in case of wrong data or state |
| [3346](#L3346) | if (isset($verification['status']) && $verification['status'] != 'success') { |
| [3347](#L3347) | return $verification; |
| [3348](#L3348) | } |
| [3349](#L3349) |  |
| [3350](#L3350) | // Update lock file to prevent double processes |
| [3351](#L3351) | touch($staging\_lock); |
| [3352](#L3352) |  |
| [3353](#L3353) | // Include local staging site controller |
| [3354](#L3354) | require\_once BMI\_INCLUDES . '/staging/local.php'; |
| [3355](#L3355) | $staging = new StagingLocal($name, true); |
| [3356](#L3356) |  |
| [3357](#L3357) | // Append the return if staging process requires more batches |
| [3358](#L3358) | if ($staging->continue == true) return $staging->continuationData; |
| [3359](#L3359) |  |
| [3360](#L3360) | return [ 'status' => 'continue', 'data' => [ 'name' => $name ] ]; |
| [3361](#L3361) |  |
| [3362](#L3362) | } |
| [3363](#L3363) |  |
| [3364](#L3364) | /\*\* |
| [3365](#L3365) | \* stagingSitesGetList - Returns staging sites list |
| [3366](#L3366) | \* |
| [3367](#L3367) | \* @return {array} with staging sites data |
| [3368](#L3368) | \*/ |
| [3369](#L3369) | public function stagingSitesGetList() { |
| [3370](#L3370) |  |
| [3371](#L3371) | // Include local staging site controller |
| [3372](#L3372) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3373](#L3373) | $staging = new Staging('..ajax..'); |
| [3374](#L3374) | $sites = $staging->getStagingSites(); |
| [3375](#L3375) |  |
| [3376](#L3376) | return [ 'status' => 'success', 'sites' => $sites ]; |
| [3377](#L3377) |  |
| [3378](#L3378) | } |
| [3379](#L3379) |  |
| [3380](#L3380) | /\*\* |
| [3381](#L3381) | \* stagingRename - Renames display name |
| [3382](#L3382) | \* |
| [3383](#L3383) | \* @return {array} status |
| [3384](#L3384) | \*/ |
| [3385](#L3385) | public function stagingRename() { |
| [3386](#L3386) |  |
| [3387](#L3387) | $name = $this->post['name']; |
| [3388](#L3388) | $newName = $this->post['new']; |
| [3389](#L3389) |  |
| [3390](#L3390) | // Include local staging site controller |
| [3391](#L3391) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3392](#L3392) | $staging = new Staging('..ajax..'); |
| [3393](#L3393) | return $staging->rename($name, $newName); |
| [3394](#L3394) |  |
| [3395](#L3395) | } |
| [3396](#L3396) |  |
| [3397](#L3397) | /\*\* |
| [3398](#L3398) | \* stagingPrepareLogin - Prepares login script |
| [3399](#L3399) | \* |
| [3400](#L3400) | \* @return {array} login credentials |
| [3401](#L3401) | \*/ |
| [3402](#L3402) | public function stagingPrepareLogin() { |
| [3403](#L3403) |  |
| [3404](#L3404) | $name = $this->post['name']; |
| [3405](#L3405) |  |
| [3406](#L3406) | // Include local staging site controller |
| [3407](#L3407) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3408](#L3408) | $staging = new Staging('..ajax..'); |
| [3409](#L3409) | return $staging->prepareLogin($name); |
| [3410](#L3410) |  |
| [3411](#L3411) | } |
| [3412](#L3412) |  |
| [3413](#L3413) | /\*\* |
| [3414](#L3414) | \* Handles ajax error on browser side, keep alive timeout etc. |
| [3415](#L3415) | \* |
| [3416](#L3416) | \* @return array static success |
| [3417](#L3417) | \*/ |
| [3418](#L3418) | public function frontEndAjaxError() { |
| [3419](#L3419) |  |
| [3420](#L3420) | if ($this->post['call'] == 'create-backup') { |
| [3421](#L3421) | require\_once BMI\_INCLUDES . '/progress/zip.php'; |
| [3422](#L3422) | $logger = new Progress('', 0, 0, false, false); |
| [3423](#L3423) | } else if (in\_array($this->post['call'], ['restore-backup', 'download-backup', 'continue\_restore\_process'])) { |
| [3424](#L3424) | require\_once BMI\_INCLUDES . '/progress/migration.php'; |
| [3425](#L3425) | $logger = new MigrationProgress(true); |
| [3426](#L3426) | } else if (in\_array($this->post['call'], ['staging-start-local-creation', 'staging-local-creation-process', 'staging-tastewp-creation-process'])) { |
| [3427](#L3427) | require\_once BMI\_INCLUDES . '/progress/staging.php'; |
| [3428](#L3428) | $logger = new StagingProgress(true); |
| [3429](#L3429) | } |
| [3430](#L3430) |  |
| [3431](#L3431) | if (isset($this->post['error'])) { |
| [3432](#L3432) |  |
| [3433](#L3433) | Logger::error('Front End Ajax Error START'); |
| [3434](#L3434) | if (isset($logger)) $logger->log('Front End Ajax Error START', 'verbose'); |
| [3435](#L3435) |  |
| [3436](#L3436) | if (is\_array($this->post['error'])) { |
| [3437](#L3437) |  |
| [3438](#L3438) | $errors = $this->post['error']; |
| [3439](#L3439) | foreach ($errors as $k => $val) { |
| [3440](#L3440) | $error = sanitize\_text\_field(print\_r($val, true)); |
| [3441](#L3441) | Logger::error($k . ' = ' . $error); |
| [3442](#L3442) | if (isset($logger)) $logger->log($k . ' = ' . $error, 'verbose'); |
| [3443](#L3443) | } |
| [3444](#L3444) |  |
| [3445](#L3445) | } else { |
| [3446](#L3446) |  |
| [3447](#L3447) | $theError = sanitize\_text\_field(print\_r($this->post->error, true)); |
| [3448](#L3448) | Logger::error('Front End Ajax Error: ' . $theError); |
| [3449](#L3449) | if (isset($logger)) $logger->log($theError, 'verbose'); |
| [3450](#L3450) |  |
| [3451](#L3451) | } |
| [3452](#L3452) |  |
| [3453](#L3453) | Logger::error('Front End Ajax Error END'); |
| [3454](#L3454) | if (isset($logger)) $logger->log('Front End Ajax Error END', 'verbose'); |
| [3455](#L3455) |  |
| [3456](#L3456) | } else { |
| [3457](#L3457) |  |
| [3458](#L3458) | Logger::error('Front End Ajax Error was called, but no error included.'); |
| [3459](#L3459) |  |
| [3460](#L3460) | } |
| [3461](#L3461) |  |
| [3462](#L3462) | if (isset($logger)) { |
| [3463](#L3463) | $logger->log(\_\_('Browser-side error detected, the process will try to restart with alternative methods, otherwise it will throw error window.', 'backup-backup'), 'error'); |
| [3464](#L3464) | $logger->log('Browser-side error detected, the process will try to restart with alternative methods, otherwise it will throw error window.', 'verbose'); |
| [3465](#L3465) | } |
| [3466](#L3466) |  |
| [3467](#L3467) | return [ 'status' => 'success' ]; |
| [3468](#L3468) |  |
| [3469](#L3469) | } |
| [3470](#L3470) |  |
| [3471](#L3471) | /\*\* |
| [3472](#L3472) | \* stagingDelete - Removes the staging site |
| [3473](#L3473) | \* |
| [3474](#L3474) | \* @return {array} status |
| [3475](#L3475) | \*/ |
| [3476](#L3476) | public function stagingDelete() { |
| [3477](#L3477) |  |
| [3478](#L3478) | $name = $this->post['name']; |
| [3479](#L3479) |  |
| [3480](#L3480) | // Include local staging site controller |
| [3481](#L3481) | require\_once BMI\_INCLUDES . '/staging/controller.php'; |
| [3482](#L3482) | $staging = new Staging('..ajax..'); |
| [3483](#L3483) | return $staging->delete($name); |
| [3484](#L3484) |  |
| [3485](#L3485) | } |
| [3486](#L3486) |  |
| [3487](#L3487) | /\*\* |
| [3488](#L3488) | \* localStagingCreationProcess - Method that can continue batching of Staging process |
| [3489](#L3489) | \* |
| [3490](#L3490) | \* @return {array} data that should be send back to this function as POST |
| [3491](#L3491) | \*/ |
| [3492](#L3492) | public function localStagingCreationProcess() { |
| [3493](#L3493) |  |
| [3494](#L3494) | // Get $name and declare lock file |
| [3495](#L3495) | $name = $this->post['name']; |
| [3496](#L3496) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3497](#L3497) |  |
| [3498](#L3498) | // Update lock file to prevent double processes |
| [3499](#L3499) | touch($staging\_lock); |
| [3500](#L3500) |  |
| [3501](#L3501) | // Include local staging site controller |
| [3502](#L3502) | require\_once BMI\_INCLUDES . '/staging/local.php'; |
| [3503](#L3503) | $staging = new StagingLocal($name); |
| [3504](#L3504) |  |
| [3505](#L3505) | // Process handler |
| [3506](#L3506) | if (isset($this->post['delete'])) { |
| [3507](#L3507) | $staging->requestDelete(); |
| [3508](#L3508) | } else $staging->continue(); |
| [3509](#L3509) |  |
| [3510](#L3510) | // Append the return if staging process requires more batches |
| [3511](#L3511) | if ($staging->continue == true) return $staging->continuationData; |
| [3512](#L3512) |  |
| [3513](#L3513) | // Send success if nothing went wrong which finishes the process |
| [3514](#L3514) | if (file\_exists($staging\_lock)) @unlink($staging\_lock); |
| [3515](#L3515) | return ['status' => 'error']; |
| [3516](#L3516) |  |
| [3517](#L3517) | } |
| [3518](#L3518) |  |
| [3519](#L3519) | /\*\* |
| [3520](#L3520) | \* tastewpStagingCreation - Initializes and declares staging site will |
| [3521](#L3521) | \* |
| [3522](#L3522) | \* @return {array} batching status |
| [3523](#L3523) | \*/ |
| [3524](#L3524) | public function tastewpStagingCreation() { |
| [3525](#L3525) |  |
| [3526](#L3526) | // Get $name and declare lock file |
| [3527](#L3527) | $name = $this->post['name']; |
| [3528](#L3528) | $backupName = isset($this->post['backupName']) ? $this->post['backupName'] : false; |
| [3529](#L3529) | $initialize = isset($this->post['initialize']) ? $this->post['initialize'] : false; |
| [3530](#L3530) | $staging\_lock = BMI\_STAGING . '/.staging\_lock'; |
| [3531](#L3531) |  |
| [3532](#L3532) | // Fix var type |
| [3533](#L3533) | if ($initialize === true || $initialize == 'true') $initialize = true; |
| [3534](#L3534) | else $initialize = false; |
| [3535](#L3535) |  |
| [3536](#L3536) | // Update lock file to prevent double processes |
| [3537](#L3537) | touch($staging\_lock); |
| [3538](#L3538) |  |
| [3539](#L3539) | // Include TasteWP staging site controller |
| [3540](#L3540) | require\_once BMI\_INCLUDES . '/staging/tastewp.php'; |
| [3541](#L3541) |  |
| [3542](#L3542) | // Process handler |
| [3543](#L3543) | if (isset($this->post['delete'])) { |
| [3544](#L3544) | $delete = true; |
| [3545](#L3545) | } else $delete = false; |
| [3546](#L3546) |  |
| [3547](#L3547) | // Make first handshake with TasteWP |
| [3548](#L3548) | $staging = new StagingTasteWP($name, $initialize, $backupName, $delete); |
| [3549](#L3549) |  |
| [3550](#L3550) | // Append the return if staging process requires more batches |
| [3551](#L3551) | if ($staging->continue == true) return $staging->continuationData; |
| [3552](#L3552) |  |
| [3553](#L3553) | // Send success if nothing went wrong which finishes the process |
| [3554](#L3554) | if (file\_exists($staging\_lock)) @unlink($staging\_lock); |
| [3555](#L3555) | return ['status' => 'error']; |
| [3556](#L3556) |  |
| [3557](#L3557) | } |
| [3558](#L3558) |  |
| [3559](#L3559) | public function debugging() { |
| [3560](#L3560) |  |
| [3561](#L3561) | } |
| [3562](#L3562) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/backup-backup/tags/1.3.9/includes/ajax.php?format=txt)
* [Original Format](/export/3222696/backup-backup/tags/1.3.9/includes/ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


