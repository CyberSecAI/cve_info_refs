=== Content from plugins.trac.wordpress.org_ecfbcdaf_20250114_232317.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3013229%2Fwp-maintenance-mode%2Ftrunk%2Fincludes%2Fclasses%2Fwp-maintenance-mode-admin.php%3Fcontextall%3D1%26old%3D2922691%26old_path%3D%252Fwp-maintenance-mode%252Ftrunk%252Fincludes%252Fclasses%252Fwp-maintenance-mode-admin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2922691/wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php?old=3013229&old_path=%2Fwp-maintenance-mode%2Ftrunk%2Fincludes%2Fclasses%2Fwp-maintenance-mode-admin.php)

---

# Changes in [wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php](/browser/wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php?rev=3013229 "Show entry in browser") [[2922691:3013229]](/log/wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php?rev=3013229&stop_rev=2922691 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php](/browser/wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php?rev=3013229 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php](/changeset/3013229/wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php?old=2922691&old_path=wp-maintenance-mode%2Ftrunk%2Fincludes%2Fclasses%2Fwp-maintenance-mode-admin.php "Show the [2922691:3013229] differences restricted to wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php")

  | [r2922691](/browser/wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php?rev=2922691#L1 "Show revision 2922691 of this file in browser") | [r3013229](/browser/wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php?rev=3013229#L1 "Show revision 3013229 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | defined( 'ABSPATH' ) || exit; |
  | 4 | 4 |  |
  | 5 | 5 | use ThemeIsle\GutenbergBlocks\CSS\CSS\_Handler; |
  | 6 | 6 |  |
  | 7 | 7 | if ( ! class\_exists( 'WP\_Maintenance\_Mode\_Admin' ) ) { |
  | 8 | 8 |  |
  | 9 | 9 | class WP\_Maintenance\_Mode\_Admin { |
  | 10 | 10 |  |
  | 11 | 11 | const SUBSCRIBE\_ROUTE = 'https://api.themeisle.com/tracking/subscribe'; |
  | 12 | 12 |  |
  | 13 | 13 | protected static $instance = null; |
  | 14 | 14 | protected $plugin\_slug; |
  | 15 | 15 | protected $plugin\_settings; |
  | 16 | 16 | protected $plugin\_network\_settings; |
  | 17 | 17 | protected $plugin\_default\_settings; |
  | 18 | 18 | protected $plugin\_basename; |
  | 19 | 19 | protected $plugin\_screen\_hook\_suffix = null; |
  | 20 | 20 | private $dismissed\_notices\_key       = 'wpmm\_dismissed\_notices'; |
  | 21 | 21 |  |
  | 22 | 22 | /\*\* |
  | 23 | 23 | \* 3, 2, 1... Start! |
  | 24 | 24 | \*/ |
  | 25 | 25 | private function \_\_construct() { |
  | 26 | 26 | $plugin                        = WP\_Maintenance\_Mode::get\_instance(); |
  | 27 | 27 | $this->plugin\_slug             = $plugin->get\_plugin\_slug(); |
  | 28 | 28 | $this->plugin\_settings         = $plugin->get\_plugin\_settings(); |
  | 29 | 29 | $this->plugin\_network\_settings = $plugin->get\_plugin\_network\_settings(); |
  | 30 | 30 | $this->plugin\_default\_settings = $plugin->default\_settings(); |
  | 31 | 31 | $this->plugin\_basename         = plugin\_basename( WPMM\_PATH . $this->plugin\_slug . '.php' ); |
  | 32 | 32 |  |
  | 33 | 33 | // Load admin style sheet and JavaScript. |
  | 34 | 34 | add\_action( 'admin\_enqueue\_scripts', array( $this, 'enqueue\_admin\_styles' ) ); |
  | 35 | 35 | add\_action( 'admin\_enqueue\_scripts', array( $this, 'enqueue\_admin\_scripts' ) ); |
  | 36 | 36 |  |
  | 37 | 37 | // Add the options page and menu item. |
  | 38 | 38 | add\_action( 'admin\_menu', array( $this, 'add\_plugin\_menu' ) ); |
  | 39 | 39 | add\_action( 'admin\_head', array( $this, 'add\_inline\_global\_style' ) ); |
  | 40 | 40 | add\_action( 'network\_admin\_menu', array( $this, 'add\_plugin\_menu' ) ); |
  | 41 | 41 |  |
  | 42 | 42 | add\_action( 'admin\_init', array( $this, 'maybe\_redirect' ) ); |
  | 43 | 43 |  |
  | 44 | 44 | // Add an action link pointing to the options page |
  | 45 | 45 | if ( is\_multisite() && is\_plugin\_active\_for\_network( $this->plugin\_basename ) ) { |
  | 46 | 46 | // settings link will point to admin\_url of the main blog, not to network\_admin\_url |
  | 47 | 47 | add\_filter( 'network\_admin\_plugin\_action\_links\_' . $this->plugin\_basename, array( $this, 'add\_settings\_link' ) ); |
  | 48 | 48 | } else { |
  | 49 | 49 | add\_filter( 'plugin\_action\_links\_' . $this->plugin\_basename, array( $this, 'add\_settings\_link' ) ); |
  | 50 | 50 | } |
  | 51 | 51 |  |
  | 52 | 52 | // Add admin notices |
  | 53 | 53 | add\_action( 'admin\_notices', array( $this, 'add\_notices' ) ); |
  | 54 | 54 |  |
  | 55 | 55 | // Add network admin notices. |
  | 56 | 56 | add\_action( 'network\_admin\_notices', array( $this, 'add\_notices' ) ); |
  | 57 | 57 | add\_action( 'network\_admin\_notices', array( $this, 'save\_plugin\_settings\_notice' ) ); |
  | 58 | 58 |  |
  | 59 | 59 | // Add ajax methods |
  | 60 | 60 | add\_action( 'wp\_ajax\_wpmm\_subscribers\_export', array( $this, 'subscribers\_export' ) ); |
  | 61 | 61 | add\_action( 'wp\_ajax\_wpmm\_subscribers\_empty\_list', array( $this, 'subscribers\_empty\_list' ) ); |
  | 62 | 62 | add\_action( 'wp\_ajax\_wpmm\_dismiss\_notices', array( $this, 'dismiss\_notices' ) ); |
  | 63 | 63 | add\_action( 'wp\_ajax\_wpmm\_reset\_settings', array( $this, 'reset\_plugin\_settings' ) ); |
  | 64 | 64 | add\_action( 'wp\_ajax\_wpmm\_select\_page', array( $this, 'select\_page' ) ); |
  | 65 | 65 | add\_action( 'wp\_ajax\_wpmm\_insert\_template', array( $this, 'insert\_template' ) ); |
  | 66 | 66 | add\_action( 'wp\_ajax\_wpmm\_skip\_wizard', array( $this, 'skip\_wizard' ) ); |
  | 67 | 67 | add\_action( 'wp\_ajax\_wpmm\_subscribe', array( $this, 'subscribe\_newsletter' ) ); |
  | 68 | 68 | add\_action( 'wp\_ajax\_wpmm\_change\_template\_category', array( $this, 'change\_template\_category' ) ); |
  | 69 | 69 | add\_action( 'wp\_ajax\_wpmm\_toggle\_gutenberg', array( $this, 'toggle\_gutenberg' ) ); |
  | 70 | 70 | add\_action( 'wp\_ajax\_wpmm\_update\_sdk\_options', array( $this, 'wpmm\_update\_sdk\_options' ) ); |
  | 71 | 71 |  |
  | 72 | 72 | // Add admin\_post\_$action |
  | 73 | 73 | add\_action( 'admin\_post\_wpmm\_save\_settings', array( $this, 'save\_plugin\_settings' ) ); |
  | 74 | 74 |  |
  | 75 | 75 | // Add text to footer |
  | 76 | 76 | add\_filter( 'admin\_footer\_text', array( $this, 'admin\_footer\_text' ), 5 ); |
  | 77 | 77 |  |
  | 78 | 78 | // Wizard screen setup |
  | 79 | 79 | add\_filter( 'admin\_body\_class', array( $this, 'add\_wizard\_classes' ) ); |
  | 80 | 80 |  |
  | 81 | 81 | // Display custom page state |
  | 82 | 82 | add\_filter( 'display\_post\_states', array( $this, 'add\_display\_post\_states' ), 10, 2 ); |
  | 83 | 83 | } |
  | 84 | 84 |  |
  | 85 | 85 | /\*\* |
  | 86 | 86 | \* Singleton |
  | 87 | 87 | \* |
  | 88 | 88 | \* @return object |
  | 89 | 89 | \*/ |
  | 90 | 90 | public static function get\_instance() { |
  | 91 | 91 | if ( null === self::$instance ) { |
  | 92 | 92 | self::$instance = new self(); |
  | 93 | 93 | } |
  | 94 | 94 |  |
  | 95 | 95 | return self::$instance; |
  | 96 | 96 | } |
  | 97 | 97 |  |
  | 98 | 98 | /\*\* |
  | 99 | 99 | \* Load CSS files |
  | 100 | 100 | \* |
  | 101 | 101 | \* @since 2.0.0 |
  | 102 | 102 | \* @return void |
  | 103 | 103 | \*/ |
  | 104 | 104 | public function enqueue\_admin\_styles() { |
  | 105 | 105 | if ( ! isset( $this->plugin\_screen\_hook\_suffix ) ) { |
  | 106 | 106 | return; |
  | 107 | 107 | } |
  | 108 | 108 |  |
  | 109 | 109 | $screen = get\_current\_screen(); |
  | 110 | 110 | if ( $this->plugin\_screen\_hook\_suffix === $screen->id ) { |
  | 111 | 111 | $wp\_scripts       = wp\_scripts(); |
  | 112 | 112 | $ui               = $wp\_scripts->query( 'jquery-ui-core' ); |
  | 113 | 113 | $allowed\_versions = array( |
  | 114 | 114 | '1.11.4' => true, |
  | 115 | 115 | '1.12.1' => true, |
  | 116 | 116 | '1.13.0' => true, |
  | 117 | 117 | '1.13.1' => true, |
  | 118 | 118 | ); |
  | 119 | 119 | wp\_enqueue\_style( $this->plugin\_slug . '-admin-jquery-ui-styles', WPMM\_CSS\_URL . 'jquery-ui-styles/' . ( ! empty( $ui->ver ) ? ( isset( $allowed\_versions[ $ui->ver ] ) ? $ui->ver : '1.13.1' ) : '1.11.4' ) . '/jquery-ui' . WPMM\_ASSETS\_SUFFIX . '.css', array(), WP\_Maintenance\_Mode::VERSION ); |
  | 120 | 120 | wp\_enqueue\_style( $this->plugin\_slug . '-admin-chosen', WPMM\_CSS\_URL . 'chosen' . WPMM\_ASSETS\_SUFFIX . '.css', array(), WP\_Maintenance\_Mode::VERSION ); |
  | 121 | 121 | wp\_enqueue\_style( $this->plugin\_slug . '-admin-timepicker-addon-script', WPMM\_CSS\_URL . 'jquery-ui-timepicker-addon' . WPMM\_ASSETS\_SUFFIX . '.css', array(), WP\_Maintenance\_Mode::VERSION ); |
  | 122 | 122 | wp\_enqueue\_style( $this->plugin\_slug . '-admin-styles', WPMM\_CSS\_URL . 'style-admin' . WPMM\_ASSETS\_SUFFIX . '.css', array( 'wp-color-picker' ), WP\_Maintenance\_Mode::VERSION ); |
  | 123 | 123 |  |
  | 124 | 124 | // wizard stylesheet |
  | 125 | 125 | if ( get\_option( 'wpmm\_fresh\_install', false ) ) { |
  | 126 | 126 | wp\_enqueue\_style( $this->plugin\_slug . '-wizard-styles', WPMM\_CSS\_URL . 'style-wizard' . WPMM\_ASSETS\_SUFFIX . '.css', array( 'wp-components' ), WP\_Maintenance\_Mode::VERSION ); |
  | 127 | 127 | } |
  | 128 | 128 | } |
  | 129 | 129 | } |
  | 130 | 130 |  |
  | 131 | 131 | /\*\* |
  | 132 | 132 | \* Load JS files and their dependencies |
  | 133 | 133 | \* |
  | 134 | 134 | \* @since 2.0.0 |
  | 135 | 135 | \*/ |
  | 136 | 136 | public function enqueue\_admin\_scripts() { |
  | 137 | 137 | if ( ! isset( $this->plugin\_screen\_hook\_suffix ) ) { |
  | 138 | 138 | return; |
  | 139 | 139 | } |
  | 140 | 140 |  |
  | 141 | 141 | $screen = get\_current\_screen(); |
  | 142 | 142 | if ( $this->plugin\_screen\_hook\_suffix === $screen->id ) { |
  | 143 | 143 | wp\_enqueue\_media(); |
  | 144 | 144 | wp\_enqueue\_script( $this->plugin\_slug . '-admin-timepicker-addon-script', WPMM\_JS\_URL . 'jquery-ui-timepicker-addon' . WPMM\_ASSETS\_SUFFIX . '.js', array( 'jquery', 'jquery-ui-datepicker' ), WP\_Maintenance\_Mode::VERSION, true ); |
  | 145 | 145 | wp\_enqueue\_script( $this->plugin\_slug . '-admin-script', WPMM\_JS\_URL . 'scripts-admin' . WPMM\_ASSETS\_SUFFIX . '.js', array( 'jquery', 'wp-color-picker' ), WP\_Maintenance\_Mode::VERSION, true ); |
  | 146 | 146 | wp\_enqueue\_script( $this->plugin\_slug . '-admin-chosen', WPMM\_JS\_URL . 'chosen.jquery' . WPMM\_ASSETS\_SUFFIX . '.js', array(), WP\_Maintenance\_Mode::VERSION, true ); |
  | 147 | 147 | wp\_localize\_script( |
  | 148 | 148 | $this->plugin\_slug . '-admin-script', |
  | 149 | 149 | 'wpmmVars', |
  | 150 | 150 | array( |
  | 151 | 151 | 'ajaxURL'                => admin\_url( 'admin-ajax.php' ), |
  | 152 | 152 | 'pluginURL'              => add\_query\_arg( array( 'page' => $this->plugin\_slug ), admin\_url( 'admin.php' ) ), |
  | 153 | 153 | 'ajaxNonce'              => wp\_create\_nonce( 'ajax' ), |
  | 154 | 154 | 'wizardNonce'            => wp\_create\_nonce( 'wizard' ), |
  | 155 | 155 | 'pluginInstallNonce'     => wp\_create\_nonce( 'updates' ), |
  | 156 | 156 | 'isOtterInstalled'       => file\_exists( ABSPATH . 'wp-content/plugins/otter-blocks/otter-blocks.php' ), |
  | 157 | 157 | 'isOtterActive'          => is\_plugin\_active( 'otter-blocks/otter-blocks.php' ), |
  | 158 | 158 | 'isOptimoleInstalled'    => file\_exists( ABSPATH . 'wp-content/plugins/optimole-wp/optimole-wp.php' ), |
  | 159 | 159 | 'isOptimoleActive'       => is\_plugin\_active( 'optimole-wp/optimole-wp.php' ), |
  | 160 | 160 | 'errorString'            => \_\_( 'Something went wrong, please try again.', 'wp-maintenance-mode' ), |
  | 161 | 161 | 'loadingString'          => \_\_( 'Doing some magic...', 'wp-maintenance-mode' ), |
  | 162 | 162 | 'importingText'          => \_\_( 'Importing', 'wp-maintenance-mode' ), |
  | 163 | 163 | 'importDone'             => \_\_( 'Done', 'wp-maintenance-mode' ), |
  | 164 | 164 | 'invalidEmailString'     => \_\_( 'Invalid email, please try again.', 'wp-maintenance-mode' ), |
  | 165 | 165 | 'finishWizardStrings'    => array( |
  | 166 | 166 | 'maintenance' => \_\_( 'Your maintenance page is ready!', 'wp-maintenance-mode' ), |
  | 167 | 167 | 'coming-soon' => \_\_( 'Your coming soon page is ready!', 'wp-maintenance-mode' ), |
  | 168 | 168 | ), |
  | 169 | 169 | 'adminURL'               => get\_admin\_url(), |
  | 170 | 170 | 'otterActivationLink'    => add\_query\_arg( |
  | 171 | 171 | array( |
  | 172 | 172 | 'action'        => 'activate', |
  | 173 | 173 | 'plugin'        => rawurlencode( 'otter-blocks/otter-blocks.php' ), |
  | 174 | 174 | 'plugin\_status' => 'all', |
  | 175 | 175 | 'paged'         => '1', |
  | 176 | 176 | '\_wpnonce'      => wp\_create\_nonce( 'activate-plugin\_otter-blocks/otter-blocks.php' ), |
  | 177 | 177 | ), |
  | 178 | 178 | esc\_url( network\_admin\_url( 'plugins.php' ) ) |
  | 179 | 179 | ), |
  | 180 | 180 | 'optimoleActivationLink' => add\_query\_arg( |
  | 181 | 181 | array( |
  | 182 | 182 | 'action'        => 'activate', |
  | 183 | 183 | 'plugin'        => rawurlencode( 'optimole-wp/optimole-wp.php' ), |
  | 184 | 184 | 'plugin\_status' => 'all', |
  | 185 | 185 | 'paged'         => '1', |
  | 186 | 186 | '\_wpnonce'      => wp\_create\_nonce( 'activate-plugin\_optimole-wp/optimole-wp.php' ), |
  | 187 | 187 | ), |
  | 188 | 188 | esc\_url( network\_admin\_url( 'plugins.php' ) ) |
  | 189 | 189 | ), |
  | 190 | 190 | 'modalTexts'             => array( |
  | 191 | 191 | 'title'          => \_\_( 'The template has been imported!', 'wp-maintenance-mode' ), |
  | 192 | 192 | 'description'    => \_\_( 'The template has been imported to a new draft page. You can take a look and enable it from plugin settings.', 'wp-maintenance-mode' ), |
  | 193 | 193 | 'buttonPage'     => \_\_( 'Go to page', 'wp-maintenance-mode' ), |
  | 194 | 194 | 'buttonSettings' => \_\_( 'Go to Settings', 'wp-maintenance-mode' ), |
  | 195 | 195 | ), |
  | 196 | 196 | 'confirmModalTexts'      => array( |
  | 197 | 197 | 'title'          => \_\_( 'Import this template?', 'wp-maintenance-mode' ), |
  | 198 | 198 | 'description'    => \_\_( 'By importing this template, the existing content on your Maintenance Page will be replaced. Do you wish to continue?', 'wp-maintenance-mode' ), |
  | 199 | 199 | 'buttonContinue' => \_\_( 'Continue', 'wp-maintenance-mode' ), |
  | 200 | 200 | 'buttonGoBack'   => \_\_( 'Go back', 'wp-maintenance-mode' ), |
  | 201 | 201 | ), |
  | 202 | 202 | 'imageUploaderDefaults'  => array( |
  | 203 | 203 | 'title'      => \_x( 'Upload Image', 'image\_uploader default title', 'wp-maintenance-mode' ), |
  | 204 | 204 | 'buttonText' => \_x( 'Choose Image', 'image\_uploader default button\_text', 'wp-maintenance-mode' ), |
  | 205 | 205 | ), |
  | 206 | 206 | 'skipImportStrings'      => array( |
  | 207 | 207 | 'maintenance'  => \_\_( 'I don’t want to use a Maintenance Template', 'wp-maintenance-mode' ), |
  | 208 | 208 | 'coming-soon'  => \_\_( 'I don’t want to use a Coming Soon Template', 'wp-maintenance-mode' ), |
  | 209 | 209 | 'landing-page' => \_\_( 'I don’t want to use a Landing Page Template', 'wp-maintenance-mode' ), |
  | 210 | 210 | ), |
  | 211 | 211 | 'skipImportDefault'      => \_\_( 'I don’t want to use a template', 'wp-maintenance-mode' ), |
  | 212 | 212 | ) |
  | 213 | 213 | ); |
  | 214 | 214 |  |
  | 215 | 215 | // add code editor (Code Mirror) to the `other\_custom\_css` textarea |
  | 216 | 216 | if ( ! get\_option( 'wpmm\_new\_look' ) && isset( $GLOBALS['wp\_version'] ) && version\_compare( $GLOBALS['wp\_version'], '4.9.0', '>=' ) && function\_exists( 'wp\_enqueue\_code\_editor' ) ) { |
  | 217 | 217 | $settings = wp\_enqueue\_code\_editor( |
  | 218 | 218 | array( |
  | 219 | 219 | 'type'       => 'text/css', |
  | 220 | 220 | 'codemirror' => array( |
  | 221 | 221 | 'indentUnit'  => 2, |
  | 222 | 222 | 'tabSize'     => 2, |
  | 223 | 223 | 'lineNumbers' => true, |
  | 224 | 224 | ), |
  | 225 | 225 | ) |
  | 226 | 226 | ); |
  | 227 | 227 |  |
  | 228 | 228 | wp\_add\_inline\_script( 'code-editor', sprintf( 'jQuery(function ($) { var custom\_css\_editor = wp.codeEditor.initialize("other\_custom\_css", %s); $("body").on("show\_design\_tab\_content", function () { custom\_css\_editor.codemirror.refresh(); }); });', wp\_json\_encode( $settings ) ) ); |
  | 229 | 229 | } |
  | 230 | 230 | } |
  | 231 | 231 |  |
  | 232 | 232 | // For global actions like dismiss notices |
  | 233 | 233 | wp\_enqueue\_script( $this->plugin\_slug . '-admin-global', WPMM\_JS\_URL . 'scripts-admin-global' . WPMM\_ASSETS\_SUFFIX . '.js', array( 'jquery' ), WP\_Maintenance\_Mode::VERSION, true ); |
  | 234 | 234 | } |
  | 235 | 235 |  |
  | 236 | 236 | /\*\* |
  | 237 | 237 | \* Export subscribers list in CSV format (refactor @ 2.0.4) |
  | 238 | 238 | \* |
  | 239 | 239 | \* @since 2.0.0 |
  | 240 | 240 | \* @global object $wpdb |
  | 241 | 241 | \* @throws Exception |
  | 242 | 242 | \*/ |
  | 243 | 243 | public function subscribers\_export() { |
  | 244 | 244 | global $wpdb; |
  | 245 | 245 |  |
  | 246 | 246 | try { |
  | 247 | 247 | // check capabilities |
  | 248 | 248 | if ( ! current\_user\_can( wpmm\_get\_capability( 'subscribers' ) ) ) { |
  | 249 | 249 | throw new Exception( \_\_( 'You do not have access to this resource.', 'wp-maintenance-mode' ) ); |
  | 250 | 250 | } |
  | 251 | 251 | // check nonce existence |
  | 252 | 252 | if ( empty( $\_GET['\_wpnonce'] ) ) { |
  | 253 | 253 | throw new Exception( \_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 254 | 254 | } |
  | 255 | 255 |  |
  | 256 | 256 | // check nonce validation |
  | 257 | 257 | if ( ! wp\_verify\_nonce( $\_GET['\_wpnonce'], 'tab-modules' ) ) { |
  | 258 | 258 | throw new Exception( \_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 259 | 259 | } |
  | 260 | 260 | // get subscribers and export |
  | 261 | 261 | $results = $wpdb->get\_results( "SELECT email, insert\_date FROM {$wpdb->prefix}wpmm\_subscribers ORDER BY id\_subscriber DESC", ARRAY\_A ); |
  | 262 | 262 | if ( ! empty( $results ) ) { |
  | 263 | 263 | $filename = 'subscribers-list-' . date( 'Y-m-d' ) . '.csv'; |
  | 264 | 264 |  |
  | 265 | 265 | header( 'Content-Type: text/csv' ); |
  | 266 | 266 | header( 'Content-Disposition: attachment;filename=' . $filename ); |
  | 267 | 267 |  |
  | 268 | 268 | $fp = fopen( 'php://output', 'w' ); |
  | 269 | 269 |  |
  | 270 | 270 | fputcsv( $fp, array( 'email', 'insert\_date' ) ); |
  | 271 | 271 | foreach ( $results as $item ) { |
  | 272 | 272 | fputcsv( $fp, $item ); |
  | 273 | 273 | } |
  | 274 | 274 |  |
  | 275 | 275 | fclose( $fp ); // phpcs:ignore WordPress.WP.AlternativeFunctions.file\_system\_read\_fclose |
  | 276 | 276 | } |
  | 277 | 277 | die(); |
  | 278 | 278 | } catch ( Exception $ex ) { |
  | 279 | 279 | wp\_send\_json\_error( $ex->getMessage() ); |
  | 280 | 280 | } |
  | 281 | 281 | } |
  | 282 | 282 |  |
  | 283 | 283 | /\*\* |
  | 284 | 284 | \* Empty subscribers list |
  | 285 | 285 | \* |
  | 286 | 286 | \* @since 2.0.4 |
  | 287 | 287 | \* @global object $wpdb |
  | 288 | 288 | \* @throws Exception |
  | 289 | 289 | \*/ |
  | 290 | 290 | public function subscribers\_empty\_list() { |
  | 291 | 291 | global $wpdb; |
  | 292 | 292 |  |
  | 293 | 293 | try { |
  | 294 | 294 | // check capabilities |
  | 295 | 295 | if ( ! current\_user\_can( wpmm\_get\_capability( 'subscribers' ) ) ) { |
  | 296 | 296 | throw new Exception( \_\_( 'You do not have access to this resource.', 'wp-maintenance-mode' ) ); |
  | 297 | 297 | } |
  | 298 | 298 | // check nonce existence |
  | 299 | 299 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 300 | 300 | throw new Exception( \_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 301 | 301 | } |
  | 302 | 302 |  |
  | 303 | 303 | // check nonce validation |
  | 304 | 304 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'tab-modules' ) ) { |
  | 305 | 305 | throw new Exception( \_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 306 | 306 | } |
  | 307 | 307 | // delete all subscribers |
  | 308 | 308 | $wpdb->query( "DELETE FROM {$wpdb->prefix}wpmm\_subscribers" ); |
  | 309 | 309 |  |
  | 310 | 310 | /\* translators: number of subscribers \*/ |
  | 311 | 311 | $message = esc\_html( sprintf( \_nx( 'You have %d subscriber', 'You have %d subscribers', 0, 'ajax response', 'wp-maintenance-mode' ), 0 ) ); |
  | 312 | 312 |  |
  | 313 | 313 | wp\_send\_json\_success( $message ); |
  | 314 | 314 | } catch ( Exception $ex ) { |
  | 315 | 315 | wp\_send\_json\_error( $ex->getMessage() ); |
  | 316 | 316 | } |
  | 317 | 317 | } |
  | 318 | 318 |  |
  | 319 | 319 | /\*\* |
  | 320 | 320 | \* Add plugin in Settings menu |
  | 321 | 321 | \* |
  | 322 | 322 | \* @since 2.0.0 |
  | 323 | 323 | \*/ |
  | 324 | 324 | public function add\_plugin\_menu() { |
  | 325 | 325 | $network\_menu\_hook\_suffix = ''; |
  | 326 | 326 | if ( is\_multisite() && is\_network\_admin() ) { |
  | 327 | 327 | $network\_menu\_hook\_suffix = '-network'; |
  | 328 | 328 | } |
  | 329 | 329 | $this->plugin\_screen\_hook\_suffix = add\_menu\_page( |
  | 330 | 330 | \_\_( 'LightStart', 'wp-maintenance-mode' ), |
  | 331 | 331 | \_\_( 'LightStart', 'wp-maintenance-mode' ), |
  | 332 | 332 | wpmm\_get\_capability( 'settings' ), |
  | 333 | 333 | $this->plugin\_slug, |
  | 334 | 334 | array( $this, 'display\_plugin\_settings' ), |
  | 335 | 335 | esc\_url( WPMM\_IMAGES\_URL . 'icon.svg' ), |
  | 336 | 336 | 99 |
  | 337 | 337 | ); |
  | 338 | 338 | $this->plugin\_screen\_hook\_suffix = $this->plugin\_screen\_hook\_suffix . $network\_menu\_hook\_suffix; |
  | 339 | 339 | } |
  | 340 | 340 |  |
  | 341 | 341 | public function maybe\_redirect() { |
  | 342 | 342 | if ( ! get\_option( 'wpmm\_fresh\_install', false ) || ! get\_option( 'wpmm\_settings\_redirect', '1' ) ) { |
  | 343 | 343 | return; |
  | 344 | 344 | } |
  | 345 | 345 |  |
  | 346 | 346 | if ( defined( 'DOING\_AJAX' ) && DOING\_AJAX ) { |
  | 347 | 347 | return; |
  | 348 | 348 | } |
  | 349 | 349 |  |
  | 350 | 350 | if ( is\_network\_admin() || isset( $\_GET['activate-multi'] ) ) { |
  | 351 | 351 | return; |
  | 352 | 352 | } |
  | 353 | 353 |  |
  | 354 | 354 | update\_option( 'wpmm\_settings\_redirect', '0' ); |
  | 355 | 355 | wp\_safe\_redirect( admin\_url( 'admin.php?page=wp-maintenance-mode' ) ); |
  | 356 | 356 | exit; |
  | 357 | 357 | } |
  | 358 | 358 |  |
  | 359 | 359 | /\*\* |
  | 360 | 360 | \* Settings page |
  | 361 | 361 | \* |
  | 362 | 362 | \* @since 2.0.0 |
  | 363 | 363 | \*/ |
  | 364 | 364 | public function display\_plugin\_settings() { |
  | 365 | 365 | if ( is\_multisite() && is\_network\_admin() ) { |
  | 366 | 366 | include\_once wpmm\_get\_template\_path( 'network-settings.php' ); |
  | 367 | 367 | } else { |
  | 368 | 368 | include\_once wpmm\_get\_template\_path( 'settings.php' ); |
  | 369 | 369 | } |
  | 370 | 370 | } |
  | 371 | 371 |  |
  | 372 | 372 | /\*\* |
  | 373 | 373 | \* Save settings |
  | 374 | 374 | \* |
  | 375 | 375 | \* @since 2.0.0 |
  | 376 | 376 | \*/ |
  | 377 | 377 | public function save\_plugin\_settings() { |
  | 378 | 378 | // check capabilities |
  | 379 | 379 | if ( ! current\_user\_can( wpmm\_get\_capability( 'settings' ) ) ) { |
  | 380 | 380 | die( esc\_html\_\_( 'You do not have access to this resource.', 'wp-maintenance-mode' ) ); |
  | 381 | 381 | } |
  | 382 | 382 |  |
  | 383 | 383 | // check nonce existence |
  | 384 | 384 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 385 | 385 | die( esc\_html\_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 386 | 386 | } |
  | 387 | 387 |  |
  | 388 | 388 | // check tab existence |
  | 389 | 389 | if ( empty( $\_POST['tab'] ) ) { |
  | 390 | 390 | die( esc\_html\_\_( 'The tab slug must not be empty.', 'wp-maintenance-mode' ) ); |
  | 391 | 391 | } |
  | 392 | 392 |  |
  | 393 | 393 | // check nonce validation |
  | 394 | 394 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'tab-' . $\_POST['tab'] ) ) { |
  | 395 | 395 | die( esc\_html\_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 396 | 396 | } |
  | 397 | 397 |  |
  | 398 | 398 | // check existence in plugin default settings |
  | 399 | 399 | $tab = sanitize\_key( $\_POST['tab'] ); |
  | 400 | 400 | if ( empty( $this->plugin\_default\_settings[ $tab ] ) ) { |
  | 401 | 401 | die( esc\_html\_\_( 'The tab slug must exist.', 'wp-maintenance-mode' ) ); |
  | 402 | 402 | } |
  | 403 | 403 |  |
  | 404 | 404 | // Do some sanitizations |
  | 405 | 405 | switch ( $tab ) { |
  | 406 | 406 | case 'general': |
  | 407 | 407 | $\_POST['options']['general']['status'] = (int) $\_POST['options']['general']['status']; |
  | 408 | 408 | if ( ! empty( $\_POST['options']['general']['status'] ) && $\_POST['options']['general']['status'] === 1 ) { |
  | 409 | 409 | $\_POST['options']['general']['status\_date'] = date( 'Y-m-d H:i:s' ); |
  | 410 | 410 | } |
  | 411 | 411 | if ( isset( $\_POST['options']['general']['bypass\_bots'] ) ) { |
  | 412 | 412 | $\_POST['options']['general']['bypass\_bots'] = (int) $\_POST['options']['general']['bypass\_bots']; |
  | 413 | 413 | } |
  | 414 | 414 |  |
  | 415 | 415 | $\_POST['options']['general']['backend\_role']  = ! empty( $\_POST['options']['general']['backend\_role'] ) ? array\_map( 'sanitize\_text\_field', $\_POST['options']['general']['backend\_role'] ) : array(); |
  | 416 | 416 | $\_POST['options']['general']['frontend\_role'] = ! empty( $\_POST['options']['general']['frontend\_role'] ) ? array\_map( 'sanitize\_text\_field', $\_POST['options']['general']['frontend\_role'] ) : array(); |
  | 417 | 417 | if ( isset( $\_POST['options']['general']['meta\_robots'] ) ) { |
  | 418 | 418 | $\_POST['options']['general']['meta\_robots'] = (int) $\_POST['options']['general']['meta\_robots']; |
  | 419 | 419 | } |
  | 420 | 420 | if ( isset( $\_POST['options']['general']['redirection'] ) ) { |
  | 421 | 421 | $\_POST['options']['general']['redirection'] = esc\_url\_raw( $\_POST['options']['general']['redirection'] ); |
  | 422 | 422 | } |
  | 423 | 423 | if ( ! empty( $\_POST['options']['general']['exclude'] ) ) { |
  | 424 | 424 | $exclude\_array = explode( "\n", $\_POST['options']['general']['exclude'] ); |
  | 425 | 425 | // we need to be sure that empty lines will not be saved |
  | 426 | 426 | $\_POST['options']['general']['exclude'] = array\_filter( array\_map( 'trim', $exclude\_array ) ); |
  | 427 | 427 | $\_POST['options']['general']['exclude'] = array\_map( 'sanitize\_textarea\_field', $\_POST['options']['general']['exclude'] ); |
  | 428 | 428 | } else { |
  | 429 | 429 | $\_POST['options']['general']['exclude'] = array(); |
  | 430 | 430 | } |
  | 431 | 431 | if ( isset( $\_POST['options']['general']['notice'] ) ) { |
  | 432 | 432 | $\_POST['options']['general']['notice'] = (int) $\_POST['options']['general']['notice']; |
  | 433 | 433 | } |
  | 434 | 434 |  |
  | 435 | 435 | if ( ! empty( $\_POST['options']['general']['admin\_link'] ) ) { |
  | 436 | 436 | $\_POST['options']['general']['admin\_link'] = (int) $\_POST['options']['general']['admin\_link']; |
  | 437 | 437 | } |
  | 438 | 438 |  |
  | 439 | 439 | // delete cache when is already activated, when is activated and when is deactivated |
  | 440 | 440 | if ( |
  | 441 | 441 | isset( $this->plugin\_settings['general']['status'] ) && isset( $\_POST['options']['general']['status'] ) && |
  | 442 | 442 | ( |
  | 443 | 443 | ( $this->plugin\_settings['general']['status'] === 1 && in\_array( $\_POST['options']['general']['status'], array( 0, 1 ), true ) ) || |
  | 444 | 444 | ( $this->plugin\_settings['general']['status'] === 0 && $\_POST['options']['general']['status'] === 1 ) |
  | 445 | 445 | ) |
  | 446 | 446 | ) { |
  | 447 | 447 | wpmm\_delete\_cache(); |
  | 448 | 448 | } |
  | 449 | 449 | if ( isset( $\_POST['options']['general']['network\_mode'] ) ) { |
  | 450 | 450 | $\_POST['options']['general']['network\_mode'] = (int) $\_POST['options']['general']['network\_mode']; |
  | 451 | 451 | } |
  | 452 | 452 | break; |
  | 453 | 453 | case 'design': |
  | 454 | 454 | // Content |
  | 455 | 455 | $\_POST['options']['design']['title']         = sanitize\_text\_field( $\_POST['options']['design']['title'] ); |
  | 456 | 456 | $\_POST['options']['design']['heading']       = sanitize\_text\_field( $\_POST['options']['design']['heading'] ); |
  | 457 | 457 | $\_POST['options']['design']['heading\_color'] = sanitize\_hex\_color( $\_POST['options']['design']['heading\_color'] ); |
  | 458 | 458 |  |
  | 459 | 459 | add\_filter( 'safe\_style\_css', array( $this, 'add\_safe\_style\_css' ) ); // add before we save |
  | 460 | 460 | $\_POST['options']['design']['text']       = wp\_kses\_post( $\_POST['options']['design']['text'] ); |
  | 461 | 461 | $\_POST['options']['design']['text\_color'] = sanitize\_hex\_color( $\_POST['options']['design']['text\_color'] ); |
  | 462 | 462 | remove\_filter( 'safe\_style\_css', array( $this, 'add\_safe\_style\_css' ) ); // remove after we save |
  | 463 | 463 |  |
  | 464 | 464 | $\_POST['options']['design']['footer\_links\_color'] = sanitize\_hex\_color( $\_POST['options']['design']['footer\_links\_color'] ); |
  | 465 | 465 |  |
  | 466 | 466 | // Background |
  | 467 | 467 | $\_POST['options']['design']['bg\_type']       = sanitize\_text\_field( $\_POST['options']['design']['bg\_type'] ); |
  | 468 | 468 | $\_POST['options']['design']['bg\_color']      = sanitize\_hex\_color( $\_POST['options']['design']['bg\_color'] ); |
  | 469 | 469 | $\_POST['options']['design']['bg\_custom']     = esc\_url\_raw( $\_POST['options']['design']['bg\_custom'] ); |
  | 470 | 470 | $\_POST['options']['design']['bg\_predefined'] = sanitize\_text\_field( $\_POST['options']['design']['bg\_predefined'] ); |
  | 471 | 471 |  |
  | 472 | 472 | // Other |
  | 473 | 473 | $\_POST['options']['design']['other\_custom\_css'] = sanitize\_textarea\_field( $\_POST['options']['design']['other\_custom\_css'] ); |
  | 474 | 474 |  |
  | 475 | 475 | // Delete cache when is activated |
  | 476 | 476 | if ( ! empty( $this->plugin\_settings['general']['status'] ) && $this->plugin\_settings['general']['status'] === 1 ) { |
  | 477 | 477 | wpmm\_delete\_cache(); |
  | 478 | 478 | } |
  | 479 | 479 | break; |
  | 480 | 480 | case 'modules': |
  | 481 | 481 | if ( ! get\_option( 'wpmm\_new\_look' ) ) { |
  | 482 | 482 | // Countdown |
  | 483 | 483 | $\_POST['options']['modules']['countdown\_status']  = (int) $\_POST['options']['modules']['countdown\_status']; |
  | 484 | 484 | $\_POST['options']['modules']['countdown\_start']   = sanitize\_text\_field( $\_POST['options']['modules']['countdown\_start'] ); |
  | 485 | 485 | $\_POST['options']['modules']['countdown\_details'] = array\_map( 'trim', $\_POST['options']['modules']['countdown\_details'] ); |
  | 486 | 486 | $\_POST['options']['modules']['countdown\_details'] = array( |
  | 487 | 487 | 'days'    => isset( $\_POST['options']['modules']['countdown\_details']['days'] ) && is\_numeric( $\_POST['options']['modules']['countdown\_details']['days'] ) ? sanitize\_text\_field( $\_POST['options']['modules']['countdown\_details']['days'] ) : 0, |
  | 488 | 488 | 'hours'   => isset( $\_POST['options']['modules']['countdown\_details']['hours'] ) && is\_numeric( $\_POST['options']['modules']['countdown\_details']['hours'] ) ? sanitize\_text\_field( $\_POST['options']['modules']['countdown\_details']['hours'] ) : 1, |
  | 489 | 489 | 'minutes' => isset( $\_POST['options']['modules']['countdown\_details']['minutes'] ) && is\_numeric( $\_POST['options']['modules']['countdown\_details']['minutes'] ) ? sanitize\_text\_field( $\_POST['options']['modules']['countdown\_details']['minutes'] ) : 0, |
  | 490 | 490 | ); |
  | 491 | 491 |  |
  | 492 | 492 | $\_POST['options']['modules']['countdown\_color'] = sanitize\_hex\_color( $\_POST['options']['modules']['countdown\_color'] ); |
  | 493 | 493 |  |
  | 494 | 494 | // Subscribe |
  | 495 | 495 | $\_POST['options']['modules']['subscribe\_status']     = (int) $\_POST['options']['modules']['subscribe\_status']; |
  | 496 | 496 | $\_POST['options']['modules']['subscribe\_text']       = sanitize\_text\_field( $\_POST['options']['modules']['subscribe\_text'] ); |
  | 497 | 497 | $\_POST['options']['modules']['subscribe\_text\_color'] = sanitize\_hex\_color( $\_POST['options']['modules']['subscribe\_text\_color'] ); |
  | 498 | 498 |  |
  | 499 | 499 | // Social networks |
  | 500 | 500 | $\_POST['options']['modules']['social\_status']    = (int) $\_POST['options']['modules']['social\_status']; |
  | 501 | 501 | $\_POST['options']['modules']['social\_target']    = (int) $\_POST['options']['modules']['social\_target']; |
  | 502 | 502 | $\_POST['options']['modules']['social\_github']    = sanitize\_text\_field( $\_POST['options']['modules']['social\_github'] ); |
  | 503 | 503 | $\_POST['options']['modules']['social\_dribbble']  = sanitize\_text\_field( $\_POST['options']['modules']['social\_dribbble'] ); |
  | 504 | 504 | $\_POST['options']['modules']['social\_twitter']   = sanitize\_text\_field( $\_POST['options']['modules']['social\_twitter'] ); |
  | 505 | 505 | $\_POST['options']['modules']['social\_facebook']  = sanitize\_text\_field( $\_POST['options']['modules']['social\_facebook'] ); |
  | 506 | 506 | $\_POST['options']['modules']['social\_instagram'] = sanitize\_text\_field( $\_POST['options']['modules']['social\_instagram'] ); |
  | 507 | 507 | $\_POST['options']['modules']['social\_pinterest'] = sanitize\_text\_field( $\_POST['options']['modules']['social\_pinterest'] ); |
  | 508 | 508 | $\_POST['options']['modules']['social\_google+']   = sanitize\_text\_field( $\_POST['options']['modules']['social\_google+'] ); |
  | 509 | 509 | $\_POST['options']['modules']['social\_linkedin']  = sanitize\_text\_field( $\_POST['options']['modules']['social\_linkedin'] ); |
  | 510 | 510 |  |
  | 511 | 511 | // Contact |
  | 512 | 512 | $\_POST['options']['modules']['contact\_status']  = (int) $\_POST['options']['modules']['contact\_status']; |
  | 513 | 513 | $\_POST['options']['modules']['contact\_email']   = sanitize\_text\_field( $\_POST['options']['modules']['contact\_email'] ); |
  | 514 | 514 | $\_POST['options']['modules']['contact\_effects'] = sanitize\_text\_field( $\_POST['options']['modules']['contact\_effects'] ); |
  | 515 | 515 | } |
  | 516 | 516 |  |
  | 517 | 517 | // Google Analytics |
  | 518 | 518 | $\_POST['options']['modules']['ga\_status']       = (int) $\_POST['options']['modules']['ga\_status']; |
  | 519 | 519 | $\_POST['options']['modules']['ga\_anonymize\_ip'] = (int) $\_POST['options']['modules']['ga\_anonymize\_ip']; |
  | 520 | 520 | $\_POST['options']['modules']['ga\_code']         = wpmm\_sanitize\_ga\_code( $\_POST['options']['modules']['ga\_code'] ); |
  | 521 | 521 |  |
  | 522 | 522 | // Delete cache when is activated |
  | 523 | 523 | if ( ! empty( $this->plugin\_settings['general']['status'] ) && $this->plugin\_settings['general']['status'] === 1 ) { |
  | 524 | 524 | wpmm\_delete\_cache(); |
  | 525 | 525 | } |
  | 526 | 526 | break; |
  | 527 | 527 | case 'bot': |
  | 528 | 528 | $\_POST['options']['bot']['status'] = (int) $\_POST['options']['bot']['status']; |
  | 529 | 529 | $\_POST['options']['bot']['name']   = sanitize\_text\_field( $\_POST['options']['bot']['name'] ); |
  | 530 | 530 | $\_POST['options']['bot']['avatar'] = esc\_url\_raw( $\_POST['options']['bot']['avatar'] ); |
  | 531 | 531 |  |
  | 532 | 532 | $\_POST['options']['bot']['messages']['01']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['01'] ); |
  | 533 | 533 | $\_POST['options']['bot']['messages']['02']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['02'] ); |
  | 534 | 534 | $\_POST['options']['bot']['messages']['03']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['03'] ); |
  | 535 | 535 | $\_POST['options']['bot']['messages']['04']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['04'] ); |
  | 536 | 536 | $\_POST['options']['bot']['messages']['05']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['05'] ); |
  | 537 | 537 | $\_POST['options']['bot']['messages']['06']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['06'] ); |
  | 538 | 538 | $\_POST['options']['bot']['messages']['07']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['07'] ); |
  | 539 | 539 | $\_POST['options']['bot']['messages']['08\_1'] = sanitize\_text\_field( $\_POST['options']['bot']['messages']['08\_1'] ); |
  | 540 | 540 | $\_POST['options']['bot']['messages']['08\_2'] = sanitize\_text\_field( $\_POST['options']['bot']['messages']['08\_2'] ); |
  | 541 | 541 | $\_POST['options']['bot']['messages']['09']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['09'] ); |
  | 542 | 542 | $\_POST['options']['bot']['messages']['10']   = sanitize\_text\_field( $\_POST['options']['bot']['messages']['10'] ); |
  | 543 | 543 |  |
  | 544 | 544 | $\_POST['options']['bot']['responses']['01']   = sanitize\_text\_field( $\_POST['options']['bot']['responses']['01'] ); |
  | 545 | 545 | $\_POST['options']['bot']['responses']['02\_1'] = sanitize\_text\_field( $\_POST['options']['bot']['responses']['02\_1'] ); |
  | 546 | 546 | $\_POST['options']['bot']['responses']['02\_2'] = sanitize\_text\_field( $\_POST['options']['bot']['responses']['02\_2'] ); |
  | 547 | 547 | $\_POST['options']['bot']['responses']['03']   = sanitize\_text\_field( $\_POST['options']['bot']['responses']['03'] ); |
  | 548 | 548 |  |
  | 549 | 549 | // Write out JS file on saved |
  | 550 | 550 | $this->set\_datajs\_file( $\_POST['options']['bot'] ); |
  | 551 | 551 |  |
  | 552 | 552 | // Delete cache when is activated |
  | 553 | 553 | if ( ! empty( $this->plugin\_settings['general']['status'] ) && $this->plugin\_settings['general']['status'] === 1 ) { |
  | 554 | 554 | wpmm\_delete\_cache(); |
  | 555 | 555 | } |
  | 556 | 556 | break; |
  | 557 | 557 | case 'gdpr': |
  | 558 | 558 | $\_POST['options']['gdpr']['status']              = (int) $\_POST['options']['gdpr']['status']; |
  | 559 | 559 | $\_POST['options']['gdpr']['policy\_page\_label']   = sanitize\_text\_field( $\_POST['options']['gdpr']['policy\_page\_label'] ); |
  | 560 | 560 | $\_POST['options']['gdpr']['policy\_page\_link']    = esc\_url\_raw( $\_POST['options']['gdpr']['policy\_page\_link'] ); |
  | 561 | 561 | $\_POST['options']['gdpr']['policy\_page\_target']  = (int) $\_POST['options']['gdpr']['policy\_page\_target']; |
  | 562 | 562 | $\_POST['options']['gdpr']['contact\_form\_tail']   = wp\_kses( $\_POST['options']['gdpr']['contact\_form\_tail'], wpmm\_gdpr\_textarea\_allowed\_html() ); |
  | 563 | 563 | $\_POST['options']['gdpr']['subscribe\_form\_tail'] = wp\_kses( $\_POST['options']['gdpr']['subscribe\_form\_tail'], wpmm\_gdpr\_textarea\_allowed\_html() ); |
  | 564 | 564 |  |
  | 565 | 565 | // Delete cache when is activated |
  | 566 | 566 | if ( ! empty( $this->plugin\_settings['general']['status'] ) && $this->plugin\_settings['general']['status'] === 1 ) { |
  | 567 | 567 | wpmm\_delete\_cache(); |
  | 568 | 568 | } |
  | 569 | 569 | break; |
  | 570 | 570 | } |
  | 571 | 571 |  |
  | 572 | 572 | // save settings |
  | 573 | 573 | $this->plugin\_settings[ $tab ] = $\_POST['options'][ $tab ]; |
  | 574 | 574 |  |
  | 575 | 575 | $redirect\_to = wpmm\_option\_page\_url(); |
  | 576 | 576 | if ( ! empty( $\_POST['options']['is\_network\_site'] ) ) { |
  | 577 | 577 | $redirect\_to           = network\_admin\_url( 'settings.php' ); |
  | 578 | 578 | $option\_name           = 'wpmm\_settings\_network'; |
  | 579 | 579 | $this->plugin\_settings = array( |
  | 580 | 580 | 'general' => array( |
  | 581 | 581 | 'status'       => $this->plugin\_settings['general']['status'], |
  | 582 | 582 | 'network\_mode' => $this->plugin\_settings['general']['network\_mode'], |
  | 583 | 583 | ), |
  | 584 | 584 | ); |
  | 585 | 585 | update\_network\_option( get\_current\_network\_id(), 'wpmm\_settings\_network', $this->plugin\_settings ); |
  | 586 | 586 | } else { |
  | 587 | 587 | update\_option( 'wpmm\_settings', $this->plugin\_settings ); |
  | 588 | 588 | } |
  | 589 | 589 |  |
  | 590 | 590 | // redirect back |
  | 591 | 591 | wp\_safe\_redirect( |
  | 592 | 592 | add\_query\_arg( |
  | 593 | 593 | array( |
  | 594 | 594 | 'page'    => $this->plugin\_slug, |
  | 595 | 595 | 'updated' => true, |
  | 596 | 596 | ), |
  | 597 | 597 | $redirect\_to |
  | 598 | 598 | ) . '#' . $tab |
  | 599 | 599 | ); |
  | 600 | 600 | exit; |
  | 601 | 601 | } |
  | 602 | 602 |  |
  | 603 | 603 | /\*\* |
  | 604 | 604 | \* Reset settings (refactor @ 2.0.4) |
  | 605 | 605 | \* |
  | 606 | 606 | \* @since 2.0.0 |
  | 607 | 607 | \* @throws Exception |
  | 608 | 608 | \*/ |
  | 609 | 609 | public function reset\_plugin\_settings() { |
  | 610 | 610 | try { |
  | 611 | 611 | // check capabilities |
  | 612 | 612 | if ( ! current\_user\_can( wpmm\_get\_capability( 'settings' ) ) ) { |
  | 613 | 613 | throw new Exception( \_\_( 'You do not have access to this resource.', 'wp-maintenance-mode' ) ); |
  | 614 | 614 | } |
  | 615 | 615 |  |
  | 616 | 616 | // check nonce existence |
  | 617 | 617 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 618 | 618 | throw new Exception( \_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 619 | 619 | } |
  | 620 | 620 |  |
  | 621 | 621 | // check tab existence |
  | 622 | 622 | if ( empty( $\_POST['tab'] ) ) { |
  | 623 | 623 | throw new Exception( \_\_( 'The tab slug must not be empty.', 'wp-maintenance-mode' ) ); |
  | 624 | 624 | } |
  | 625 | 625 |  |
  | 626 | 626 | // check nonce validation |
  | 627 | 627 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'tab-' . $\_POST['tab'] ) ) { |
  | 628 | 628 | throw new Exception( \_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 629 | 629 | } |
  | 630 | 630 |  |
  | 631 | 631 | // check existence in plugin default settings |
  | 632 | 632 | $tab = sanitize\_key( $\_POST['tab'] ); |
  | 633 | 633 | if ( empty( $this->plugin\_default\_settings[ $tab ] ) ) { |
  | 634 | 634 | throw new Exception( \_\_( 'The tab slug must exist.', 'wp-maintenance-mode' ) ); |
  | 635 | 635 | } |
  | 636 | 636 |  |
  | 637 | 637 | // update options using the default values |
  | 638 | 638 | $this->plugin\_settings[ $tab ] = $this->plugin\_default\_settings[ $tab ]; |
  | 639 | 639 | update\_option( 'wpmm\_settings', $this->plugin\_settings ); |
  | 640 | 640 |  |
  | 641 | 641 | wp\_send\_json\_success(); |
  | 642 | 642 | } catch ( Exception $ex ) { |
  | 643 | 643 | wp\_send\_json\_error( $ex->getMessage() ); |
  | 644 | 644 | } |
  | 645 | 645 | } |
  | 646 | 646 |  |
  | 647 | 647 | /\*\* |
  | 648 | 648 | \* Select a page as Maintenance Page |
  | 649 | 649 | \* |
  | 650 | 650 | \* @return void |
  | 651 | 651 | \*/ |
  | 652 | 652 | public function select\_page() { |
  | 653 | 653 | // check nonce existence |
  | 654 | 654 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 655 | 655 | die( esc\_html\_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 656 | 656 | } |
  | 657 | 657 |  |
  | 658 | 658 | // check nonce validation |
  | 659 | 659 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'tab-design' ) ) { |
  | 660 | 660 | die( esc\_html\_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 661 | 661 | } |
  | 662 | 662 |  |
  | 663 | 663 | $this->plugin\_settings['design']['page\_id'] = $\_POST['page\_id']; |
  | 664 | 664 | wp\_update\_post( |
  | 665 | 665 | array( |
  | 666 | 666 | 'ID'            => $this->plugin\_settings['design']['page\_id'], |
  | 667 | 667 | 'page\_template' => 'templates/wpmm-page-template.php', |
  | 668 | 668 | ) |
  | 669 | 669 | ); |
  | 670 | 670 |  |
  | 671 | 671 | update\_option( 'wpmm\_settings', $this->plugin\_settings ); |
  | 672 | 672 |  |
  | 673 | 673 | wp\_send\_json\_success(); |
  | 674 | 674 | } |
  | 675 | 675 |  |
  | 676 | 676 | /\*\* |
  | 677 | 677 | \* Insert the content from the template to the Maintenance Page |
  | 678 | 678 | \* If no Maintenance Page exists, create one. |
  | 679 | 679 | \* |
  | 680 | 680 | \* @return void |
  | 681 | 681 | \*/ |
  | 682 | 682 | public function insert\_template() { |
  | 683 | 683 | if ( ! is\_plugin\_active( 'otter-blocks/otter-blocks.php' ) ) { |
  | 684 | 684 | wp\_send\_json\_error( array( 'error' => 'Otter Blocks is not activated' ) ); |
  | 685 | 685 | } |
  | 686 | 686 |  |
  | 687 | 687 | // check nonce existence |
  | 688 | 688 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 689 | 689 | die( esc\_html\_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 690 | 690 | } |
  | 691 | 691 |  |
  |  | 692 | // sanitize source only allow specific sources for further nonce verification. |
  |  | 693 | $source = isset( $\_POST['source'] ) && in\_array( $\_POST['source'], array( 'wizard', 'tab-design' ), true ) ? $\_POST['source'] : ''; |
  |  | 694 | if ( empty( $source ) ) { |
  |  | 695 | die( esc\_html\_\_( 'The source must not be empty.', 'wp-maintenance-mode' ) ); |
  |  | 696 | } |
  | 692 | 697 | // check nonce validation |
  | 693 |  | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], $~~\_POST['source']~~ ) ) { |
  |  | 698 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], $source ) ) { |
  | 694 | 699 | die( esc\_html\_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 695 | 700 | } |
  | 696 | 701 |  |
  | 697 | 702 | $template\_slug = $\_POST['template\_slug']; |
  | 698 | 703 | $category      = $\_POST['category']; |
  | 699 | 704 | $template      = json\_decode( file\_get\_contents( WPMM\_TEMPLATES\_PATH . $category . '/' . $template\_slug . '/blocks-export.json' ) ); |
  | 700 | 705 |  |
  | 701 | 706 | $blocks = str\_replace( '\n', '', $template->content ); |
  | 702 | 707 |  |
  | 703 | 708 | $post\_arr = array( |
  | 704 | 709 | 'post\_type'     => 'page', |
  | 705 | 710 | 'post\_status'   => 'private', |
  | 706 | 711 | 'post\_content'  => $blocks, |
  | 707 | 712 | 'page\_template' => 'templates/wpmm-page-template.php', |
  | 708 | 713 | ); |
  | 709 | 714 |  |
  | 710 | 715 | if ( isset( $this->plugin\_settings['design']['page\_id'] ) && get\_post\_status( $this->plugin\_settings['design']['page\_id'] ) && get\_post\_status( $this->plugin\_settings['design']['page\_id'] ) !== 'trash' ) { |
  | 711 | 716 | $post\_arr['ID'] = $this->plugin\_settings['design']['page\_id']; |
  | 712 | 717 | $page\_id        = wp\_update\_post( $post\_arr ); |
  | 713 | 718 | } else { |
  | 714 | 719 | $post\_arr['post\_title'] = \_\_( 'Maintenance Page', 'wp-maintenance-mode' ); |
  | 715 | 720 | $page\_id                = wp\_insert\_post( $post\_arr ); |
  | 716 | 721 | } |
  | 717 | 722 |  |
  | 718 | 723 | if ( $page\_id === 0 || $page\_id instanceof WP\_Error ) { |
  | 719 | 724 | wp\_send\_json\_error( array( 'error' => 'Could not get the page' ) ); |
  | 720 | 725 | } |
  | 721 | 726 |  |
  | 722 | 727 | $this->plugin\_settings['design']['page\_id'] = $page\_id; |
  | 723 | 728 | CSS\_Handler::generate\_css\_file( $page\_id ); |
  | 724 | 729 |  |
  | 725 | 730 | if ( 'wizard' === $\_POST['source'] ) { |
  | 726 | 731 | $this->plugin\_settings['general']['status'] = 1; |
  | 727 | 732 | update\_option( 'wpmm\_fresh\_install', false ); |
  | 728 | 733 | } |
  | 729 | 734 |  |
  | 730 | 735 | update\_option( 'wpmm\_page\_category', $category ); |
  | 731 | 736 | update\_option( 'wpmm\_settings', $this->plugin\_settings ); |
  | 732 | 737 | wp\_send\_json\_success( array( 'pageEditURL' => get\_edit\_post\_link( $page\_id ) ) ); |
  | 733 | 738 | } |
  | 734 | 739 |  |
  | 735 | 740 | /\*\* |
  | 736 | 741 | \* Skip importing a template (and installing Otter) from the wizard |
  | 737 | 742 | \* |
  | 738 | 743 | \* @return void |
  | 739 | 744 | \*/ |
  | 740 | 745 | public function skip\_wizard() { |
  | 741 | 746 | // check nonce existence |
  | 742 | 747 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 743 | 748 | die( esc\_html\_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 744 | 749 | } |
  | 745 | 750 |  |
  | 746 | 751 | // check nonce validation |
  | 747 | 752 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'wizard' ) ) { |
  | 748 | 753 | die( esc\_html\_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 749 | 754 | } |
  | 750 | 755 |  |
  | 751 | 756 | update\_option( 'wpmm\_fresh\_install', false ); |
  | 752 | 757 | wp\_send\_json\_success(); |
  | 753 | 758 | } |
  | 754 | 759 |  |
  | 755 | 760 | /\*\* |
  | 756 | 761 | \* Subscribe user to plugin newsletter |
  | 757 | 762 | \* |
  | 758 | 763 | \* @return void |
  | 759 | 764 | \*/ |
  | 760 | 765 | public function subscribe\_newsletter() { |
  | 761 | 766 | // check nonce existence |
  | 762 | 767 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 763 | 768 | die( esc\_html\_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 764 | 769 | } |
  | 765 | 770 |  |
  | 766 | 771 | // check nonce validation |
  | 767 | 772 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'wizard' ) ) { |
  | 768 | 773 | die( esc\_html\_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 769 | 774 | } |
  | 770 | 775 |  |
  | 771 | 776 | if ( ! isset( $\_POST['email'] ) ) { |
  | 772 | 777 | die( esc\_html\_\_( 'Empty field: email', 'wp-maintenance-mode' ) ); |
  | 773 | 778 | } |
  | 774 | 779 |  |
  | 775 | 780 | $response = wp\_remote\_post( |
  | 776 | 781 | self::SUBSCRIBE\_ROUTE, |
  | 777 | 782 | array( |
  | 778 | 783 | 'headers' => array( |
  | 779 | 784 | 'Content-Type' => 'application/json', |
  | 780 | 785 | ), |
  | 781 | 786 | 'body'    => wp\_json\_encode( |
  | 782 | 787 | array( |
  | 783 | 788 | 'slug'  => 'wp-maintenance-mode', |
  | 784 | 789 | 'site'  => get\_site\_url(), |
  | 785 | 790 | 'email' => $\_POST['email'], |
  | 786 | 791 | 'data'  => array( |
  | 787 | 792 | 'category' => get\_option( 'wpmm\_page\_category' ), |
  | 788 | 793 | ), |
  | 789 | 794 | ) |
  | 790 | 795 | ), |
  | 791 | 796 | ) |
  | 792 | 797 | ); |
  | 793 | 798 |  |
  | 794 | 799 | if ( is\_wp\_error( $response ) ) { |
  | 795 | 800 | wp\_send\_json\_error( $response->get\_error\_message() ); |
  | 796 | 801 | } |
  | 797 | 802 |  |
  | 798 | 803 | wp\_send\_json\_success( $response ); |
  | 799 | 804 | } |
  | 800 | 805 |  |
  | 801 | 806 | /\*\* |
  | 802 | 807 | \* Change the category of templates to display |
  | 803 | 808 | \* |
  | 804 | 809 | \* @return void |
  | 805 | 810 | \*/ |
  | 806 | 811 | public function change\_template\_category() { |
  | 807 | 812 | // check nonce existence |
  | 808 | 813 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 809 | 814 | die( esc\_html\_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 810 | 815 | } |
  | 811 | 816 |  |
  | 812 | 817 | // check nonce validation |
  | 813 | 818 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'tab-design' ) ) { |
  | 814 | 819 | die( esc\_html\_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 815 | 820 | } |
  | 816 | 821 |  |
  | 817 | 822 | if ( empty( $\_POST['category'] ) ) { |
  | 818 | 823 | die( esc\_html\_\_( 'Empty field: category.', 'wp-maintenance-mode' ) ); |
  | 819 | 824 | } |
  | 820 | 825 |  |
  | 821 | 826 | $this->plugin\_settings['design']['template\_category'] = $\_POST['category']; |
  | 822 | 827 | update\_option( 'wpmm\_settings', $this->plugin\_settings ); |
  | 823 | 828 |  |
  | 824 | 829 | wp\_send\_json\_success(); |
  | 825 | 830 | } |
  | 826 | 831 |  |
  | 827 | 832 | /\*\* |
  | 828 | 833 | \* Migrate to the new method of building the maintenance page or downgrade to the old one. |
  | 829 | 834 | \* Used from the migration notice. |
  | 830 | 835 | \* |
  | 831 | 836 | \* @return void |
  | 832 | 837 | \*/ |
  | 833 | 838 | public function toggle\_gutenberg() { |
  | 834 | 839 | if ( empty( $\_POST['source'] ) ) { |
  | 835 | 840 | die( esc\_html\_\_( 'The source filed must not be empty.', 'wp-maintenance-mode' ) ); |
  | 836 | 841 | } |
  | 837 | 842 |  |
  | 838 | 843 | // check nonce existence |
  | 839 | 844 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 840 | 845 | die( esc\_html\_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 841 | 846 | } |
  | 842 | 847 |  |
  | 843 | 848 | // check nonce validation |
  | 844 | 849 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'notice\_nonce\_' . $\_POST['source'] ) ) { |
  | 845 | 850 | die( esc\_html\_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 846 | 851 | } |
  | 847 | 852 |  |
  | 848 | 853 | $current\_option = get\_option( 'wpmm\_new\_look', false ); |
  | 849 | 854 | update\_option( 'wpmm\_new\_look', ! $current\_option ); |
  | 850 | 855 |  |
  | 851 | 856 | if ( ! $current\_option && ! get\_option( 'wpmm\_migration\_time' ) ) { |
  | 852 | 857 | update\_option( 'wpmm\_migration\_time', time() ); |
  | 853 | 858 | } |
  | 854 | 859 |  |
  | 855 | 860 | wp\_send\_json\_success(); |
  | 856 | 861 | } |
  | 857 | 862 |  |
  | 858 | 863 | /\*\* |
  | 859 | 864 | \* Updates options to track Otter traffic |
  | 860 | 865 | \* |
  | 861 | 866 | \* @return void |
  | 862 | 867 | \*/ |
  | 863 | 868 | function wpmm\_update\_sdk\_options() { |
  | 864 | 869 | // check nonce existence |
  | 865 | 870 | if ( empty( $\_POST['\_wpnonce'] ) ) { |
  | 866 | 871 | die( esc\_html\_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 867 | 872 | } |
  | 868 | 873 |  |
  | 869 | 874 | // check nonce validation |
  | 870 | 875 | if ( ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'ajax' ) ) { |
  | 871 | 876 | die( esc\_html\_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 872 | 877 | } |
  | 873 | 878 |  |
  | 874 | 879 | update\_option( 'themeisle\_sdk\_promotions\_otter\_installed', true ); |
  | 875 | 880 | update\_option( 'otter\_reference\_key', 'wp-maintenance-mode' ); |
  | 876 | 881 |  |
  | 877 | 882 | wp\_send\_json\_success(); |
  | 878 | 883 | } |
  | 879 | 884 |  |
  | 880 | 885 | /\*\* |
  | 881 | 886 | \* Add new safe inline style css (use by wp\_kses\_attr in wp\_kses\_post) |
  | 882 | 887 | \* - bug discovered by cokemorgan: https://github.com/andrianvaleanu/WP-Maintenance-Mode/issues/56 |
  | 883 | 888 | \* |
  | 884 | 889 | \* @since 2.0.3 |
  | 885 | 890 | \* @param array $properties |
  | 886 | 891 | \* @return array |
  | 887 | 892 | \*/ |
  | 888 | 893 | public function add\_safe\_style\_css( $properties ) { |
  | 889 | 894 | $new\_properties = array( |
  | 890 | 895 | 'min-height', |
  | 891 | 896 | 'max-height', |
  | 892 | 897 | 'min-width', |
  | 893 | 898 | 'max-width', |
  | 894 | 899 | ); |
  | 895 | 900 |  |
  | 896 | 901 | return array\_merge( $new\_properties, $properties ); |
  | 897 | 902 | } |
  | 898 | 903 |  |
  | 899 | 904 | /\*\* |
  | 900 | 905 | \* Builds the data.js file and writes it into uploads |
  | 901 | 906 | \* This file is mandatory for the bot to work correctly. |
  | 902 | 907 | \* |
  | 903 | 908 | \* @todo rewrite bot functionality. instead of saving the settings to a file, we should add them to the maintenance mode page using `wpmm\_before\_scripts` action |
  | 904 | 909 | \* @param array $messages |
  | 905 | 910 | \* @throws Exception |
  | 906 | 911 | \*/ |
  | 907 | 912 | public function set\_datajs\_file( $messages = array() ) { |
  | 908 | 913 | $data  = "var botName = \"{$messages['name']}\",\n" |
  | 909 | 914 | . "botAvatar = \"{$messages['avatar']}\",\n" |
  | 910 | 915 | . "conversationData = {\"homepage\": {1: { \"statement\": [ \n"; |
  | 911 | 916 | $data .= ( ! empty( $messages['messages']['01'] ) ) ? "\"{$messages['messages']['01']}\", \n" : ''; |
  | 912 | 917 | $data .= ( ! empty( $messages['messages']['02'] ) ) ? "\"{$messages['messages']['02']}\", \n" : ''; |
  | 913 | 918 | $data .= ( ! empty( $messages['messages']['03'] ) ) ? "\"{$messages['messages']['03']}\", \n" : ''; |
  | 914 | 919 | $data .= "], \"input\": {\"name\": \"name\", \"consequence\": 1.2}},1.2:{\"statement\": function(context) {return [ \n"; |
  | 915 | 920 | $data .= ( ! empty( $messages['messages']['04'] ) ) ? "\"{$messages['messages']['04']}\", \n" : ''; |
  | 916 | 921 | $data .= ( ! empty( $messages['messages']['05'] ) ) ? "\"{$messages['messages']['05']}\", \n" : ''; |
  | 917 | 922 | $data .= ( ! empty( $messages['messages']['06'] ) ) ? "\"{$messages['messages']['06']}\", \n" : ''; |
  | 918 | 923 | $data .= ( ! empty( $messages['messages']['07'] ) ) ? "\"{$messages['messages']['07']}\", \n" : ''; |
  | 919 | 924 | $data .= "];},\"options\": [{ \"choice\": \"{$messages['responses']['02\_1']}\",\"consequence\": 1.4},{ \n" |
  | 920 | 925 | . "\"choice\": \"{$messages['responses']['02\_2']}\",\"consequence\": 1.5}]},1.4: { \"statement\": function(context) {return [ \n"; |
  | 921 | 926 | $data .= ( ! empty( $messages['messages']['08\_1'] ) ) ? "\"{$messages['messages']['08\_1']}\", \n" : ''; |
  | 922 | 927 | $data .= "];}, \"email\": {\"email\": \"email\", \"consequence\": 1.6}},1.5: {\"statement\": function(context) {return [ \n"; |
  | 923 | 928 | $data .= ( ! empty( $messages['messages']['08\_2'] ) ) ? "\"{$messages['messages']['08\_2']}\", \n" : ''; |
  | 924 | 929 | $data .= "];}},1.6: { \"statement\": function(context) {return [ \n"; |
  | 925 | 930 | $data .= ( ! empty( $messages['messages']['09'] ) ) ? "\"{$messages['messages']['09']}\", \n" : ''; |
  | 926 | 931 | $data .= ( ! empty( $messages['messages']['10'] ) ) ? "\"{$messages['messages']['10']}\", \n" : ''; |
  | 927 | 932 | $data .= '];}}}};'; |
  | 928 | 933 |  |
  | 929 | 934 | // Replace placeholders |
  | 930 | 935 | $placeholders = array( |
  | 931 | 936 | '{visitor\_name}' => '" + ( ( typeof context === \'object\' && context !== null && context.hasOwnProperty(\'name\') ) ? context.name : \'\' )  + "', |
  | 932 | 937 | '{bot\_name}'     => $messages['name'], |
  | 933 | 938 | ); |
  | 934 | 939 |  |
  | 935 | 940 | $data = str\_replace( array\_keys( $placeholders ), $placeholders, $data ); |
  | 936 | 941 |  |
  | 937 | 942 | // Try to write data.js file |
  | 938 | 943 | try { |
  | 939 | 944 | $upload\_dir = wp\_upload\_dir(); |
  | 940 | 945 | if ( file\_put\_contents( trailingslashit( $upload\_dir['basedir'] ) . 'data.js', $data ) === false ) { // phpcs:ignore WordPress.WP.AlternativeFunctions.file\_system\_read\_file\_put\_contents |
  | 941 | 946 | throw new Exception( \_\_( 'WPMM: The file data.js could not be written, the bot will not work correctly.', 'wp-maintenance-mode' ) ); |
  | 942 | 947 | } |
  | 943 | 948 | } catch ( Exception $ex ) { |
  | 944 | 949 | // remove error\_log when rewrite bot feature |
  | 945 | 950 | error\_log( $ex->getMessage() ); // phpcs:ignore WordPress.PHP.DevelopmentFunctions.error\_log\_error\_log |
  | 946 | 951 | } |
  | 947 | 952 | } |
  | 948 | 953 |  |
  | 949 | 954 | /\*\* |
  | 950 | 955 | \* Delete object cache & page cache (if the cache plugin is supported) |
  | 951 | 956 | \* |
  | 952 | 957 | \* ! the method is deprecated, but we keep it for backward compatibility ! |
  | 953 | 958 | \* |
  | 954 | 959 | \* @since 2.0.1 |
  | 955 | 960 | \*/ |
  | 956 | 961 | public function delete\_cache() { |
  | 957 | 962 | if ( function\_exists( '\_deprecated\_function' ) ) { |
  | 958 | 963 | \_deprecated\_function( \_\_METHOD\_\_, '2.4.0', 'wpmm\_delete\_cache()' ); |
  | 959 | 964 | } |
  | 960 | 965 |  |
  | 961 | 966 | wpmm\_delete\_cache(); |
  | 962 | 967 | } |
  | 963 | 968 |  |
  | 964 | 969 | /\*\* |
  | 965 | 970 | \* Add settings link |
  | 966 | 971 | \* |
  | 967 | 972 | \* @since 2.0.0 |
  | 968 | 973 | \* @param array $links |
  | 969 | 974 | \* @return array |
  | 970 | 975 | \*/ |
  | 971 | 976 | public function add\_settings\_link( $links ) { |
  | 972 | 977 | return array\_merge( |
  | 973 | 978 | array( |
  | 974 | 979 | 'wpmm\_settings' => sprintf( '<a href="%s">%s</a>', add\_query\_arg( array( 'page' => $this->plugin\_slug ), admin\_url( 'admin.php' ) ), esc\_html\_\_( 'Settings', 'wp-maintenance-mode' ) ), |
  | 975 | 980 | ), |
  | 976 | 981 | $links |
  | 977 | 982 | ); |
  | 978 | 983 | } |
  | 979 | 984 |  |
  | 980 | 985 | /\*\* |
  | 981 | 986 | \* Add notices - will be displayed on dashboard |
  | 982 | 987 | \* |
  | 983 | 988 | \* @since 2.0.0 |
  | 984 | 989 | \*/ |
  | 985 | 990 | public function add\_notices() { |
  | 986 | 991 | $screen  = get\_current\_screen(); |
  | 987 | 992 | $notices = array(); |
  | 988 | 993 |  |
  | 989 | 994 | // show this notice if user had the plugin installed on the moment of rebranding |
  | 990 | 995 | if ( ThemeisleSDK\Product::get( WPMM\_FILE )->get\_install\_time() < strtotime( '2022-11-02' ) ) { |
  | 991 | 996 | $notices['rebrand'] = array( |
  | 992 | 997 | 'class' => 'notice wpmm\_notices notice-success is-dismissible', |
  | 993 | 998 | 'msg'   => \_\_( 'WP Maintenance Mode is now LightStart. Enjoy the same features, more templates and new landing pages building compatibility.', 'wp-maintenance-mode' ), |
  | 994 | 999 | ); |
  | 995 | 1000 | } |
  | 996 | 1001 |  |
  | 997 | 1002 | if ( $this->plugin\_screen\_hook\_suffix !== $screen->id ) { |
  | 998 | 1003 | // notice if plugin is activated |
  | 999 | 1004 | if ( |
  | 1000 | 1005 | ! empty( $this->plugin\_settings['general'] ) && is\_array( $this->plugin\_settings['general'] ) && |
  | 1001 | 1006 | $this->plugin\_settings['general']['status'] === 1 && |
  | 1002 | 1007 | $this->plugin\_settings['general']['notice'] === 1 |
  | 1003 | 1008 | ) { |
  | 1004 | 1009 | $notices['is\_activated'] = array( |
  | 1005 | 1010 | 'class' => 'error', |
  | 1006 | 1011 | 'msg'   => sprintf( |
  | 1007 | 1012 | /\* translators: plugin settings url \*/ |
  | 1008 | 1013 | \_\_( 'The Maintenance Mode is <strong>active</strong>. Please don\'t forget to <a href="%s">deactivate</a> as soon as you are done.', 'wp-maintenance-mode' ), |
  | 1009 | 1014 | add\_query\_arg( array( 'page' => $this->plugin\_slug ), admin\_url( 'admin.php' ) ) |
  | 1010 | 1015 | ), |
  | 1011 | 1016 | ); |
  | 1012 | 1017 | } |
  | 1013 | 1018 |  |
  | 1014 | 1019 | if ( ! get\_option( 'wpmm\_fresh\_install' ) && get\_option( 'wpmm\_new\_look' ) && $this->plugin\_settings['general']['status'] === 1 ) { |
  | 1015 | 1020 | if ( isset( $this->plugin\_settings['design']['page\_id'] ) ) { |
  | 1016 | 1021 | $maintenance\_page = get\_post( $this->plugin\_settings['design']['page\_id'] ); |
  | 1017 | 1022 |  |
  | 1018 | 1023 | if ( ( $maintenance\_page instanceof WP\_Post ) && $maintenance\_page->post\_status !== 'publish' && $maintenance\_page->post\_status !== 'private' ) { |
  | 1019 | 1024 | $notices['maintenance\_page\_deleted'] = array( |
  | 1020 | 1025 | 'class' => 'error', |
  | 1021 | 1026 | 'msg'   => $maintenance\_page->post\_status === 'draft' ? |
  | 1022 | 1027 | sprintf( \_\_( '<strong>Action required</strong>: your Maintenance page is drafted. Visit the page to <a href="%s">publish</a> it.', 'wp-maintenance-mode' ), get\_edit\_post\_link( $maintenance\_page ) ) : |
  | 1023 | 1028 | sprintf( \_\_( '<strong>Action required</strong>: your Maintenance page has been deleted. Visit <a href="%s">settings page</a> to address this issue.', 'wp-maintenance-mode' ), get\_admin\_url() . 'admin.php?page=wp-maintenance-mode#design' ), |
  | 1024 | 1029 | ); |
  | 1025 | 1030 | } |
  | 1026 | 1031 | } |
  | 1027 | 1032 |  |
  | 1028 | 1033 | // check if the maintenance.php template is overridden |
  | 1029 | 1034 | $overrideable\_template = wpmm\_get\_template\_path( 'maintenance.php', true ); |
  | 1030 | 1035 | if ( WPMM\_VIEWS\_PATH . 'maintenance.php' === $overrideable\_template ) { |
  | 1031 | 1036 | if ( ! isset( $this->plugin\_settings['design']['page\_id'] ) || ! get\_post( $this->plugin\_settings['design']['page\_id'] ) ) { |
  | 1032 | 1037 | $notices['maintenance\_page\_not\_found'] = array( |
  | 1033 | 1038 | 'class' => 'error', |
  | 1034 | 1039 | 'msg'   => sprintf( \_\_( '<strong>Action required</strong>: you don\'t have a page as Maintenance page. Visit <a href="%s">settings page</a> to select one.', 'wp-maintenance-mode' ), get\_admin\_url() . 'admin.php?page=wp-maintenance-mode#design' ), |
  | 1035 | 1040 | ); |
  | 1036 | 1041 | } |
  | 1037 | 1042 | } |
  | 1038 | 1043 | } |
  | 1039 | 1044 |  |
  | 1040 | 1045 | // show notice if plugin has a notice saved |
  | 1041 | 1046 | $wpmm\_notice = get\_option( 'wpmm\_notice' ); |
  | 1042 | 1047 | if ( ! empty( $wpmm\_notice ) && is\_array( $wpmm\_notice ) ) { |
  | 1043 | 1048 | $notices['other'] = $wpmm\_notice; |
  | 1044 | 1049 | } |
  | 1045 | 1050 | } else { |
  | 1046 | 1051 | if ( get\_option( 'wpmm\_show\_migration', true ) ) { |
  | 1047 | 1052 | if ( ! get\_option( 'wpmm\_new\_look' ) ) { |
  | 1048 | 1053 | $notices['migration'] = array( |
  | 1049 | 1054 | 'class' => 'notice notice-success', |
  | 1050 | 1055 | 'msg'   => \_\_( 'We upgraded the way maintenance pages are build. Migrate to use Gutenberg for your page!&emsp;<button id="wpmm-migrate" class="button button-primary">Migrate</button>', 'wp-maintenance-mode' ), |
  | 1051 | 1056 | ); |
  | 1052 | 1057 | } else { |
  | 1053 | 1058 | $notices['rollback'] = array( |
  | 1054 | 1059 | 'class' => 'notice wpmm\_notices notice-info is-dismissible', |
  | 1055 | 1060 | 'msg'   => \_\_( 'You migrated to use Gutenberg for building the Maintenance page.&emsp;<button id="wpmm-rollback" class="button button-link button-link-delete">Rollback</button>', 'wp-maintenance-mode' ), |
  | 1056 | 1061 | ); |
  | 1057 | 1062 | } |
  | 1058 | 1063 | } |
  | 1059 | 1064 |  |
  | 1060 | 1065 | // delete wpmm\_notice |
  | 1061 | 1066 | delete\_option( 'wpmm\_notice' ); |
  | 1062 | 1067 | } |
  | 1063 | 1068 |  |
  | 1064 | 1069 | // get dismissed notices |
  | 1065 | 1070 | $dismissed\_notices = $this->get\_dismissed\_notices( get\_current\_user\_id() ); |
  | 1066 | 1071 |  |
  | 1067 | 1072 | // template |
  | 1068 | 1073 | include\_once wpmm\_get\_template\_path( 'notices.php' ); |
  | 1069 | 1074 | } |
  | 1070 | 1075 |  |
  | 1071 | 1076 | /\*\* |
  | 1072 | 1077 | \* Dismiss plugin notices via AJAX |
  | 1073 | 1078 | \* |
  | 1074 | 1079 | \* @throws Exception |
  | 1075 | 1080 | \*/ |
  | 1076 | 1081 | public function dismiss\_notices() { |
  | 1077 | 1082 | try { |
  | 1078 | 1083 | $notice\_key = isset( $\_POST['notice\_key'] ) ? sanitize\_key( $\_POST['notice\_key'] ) : ''; // phpcs:ignore WordPress.Security.NonceVerification.Missing |
  | 1079 | 1084 |  |
  | 1080 | 1085 | if ( empty( $notice\_key ) ) { |
  | 1081 | 1086 | throw new Exception( \_\_( 'Notice key cannot be empty.', 'wp-maintenance-mode' ) ); |
  | 1082 | 1087 | } |
  | 1083 | 1088 | if ( empty( $\_POST['\_nonce'] ) ) { |
  | 1084 | 1089 | throw new Exception( \_\_( 'The nonce field must not be empty.', 'wp-maintenance-mode' ) ); |
  | 1085 | 1090 | } |
  | 1086 | 1091 |  |
  | 1087 | 1092 | // check nonce validation |
  | 1088 | 1093 | if ( ! wp\_verify\_nonce( $\_POST['\_nonce'], 'notice\_nonce\_' . $notice\_key ) ) { |
  | 1089 | 1094 | throw new Exception( \_\_( 'Security check.', 'wp-maintenance-mode' ) ); |
  | 1090 | 1095 | } |
  | 1091 | 1096 |  |
  | 1092 | 1097 | $this->save\_dismissed\_notices( get\_current\_user\_id(), $notice\_key ); |
  | 1093 | 1098 |  |
  | 1094 | 1099 | wp\_send\_json\_success(); |
  | 1095 | 1100 | } catch ( Exception $ex ) { |
  | 1096 | 1101 | wp\_send\_json\_error( $ex->getMessage() ); |
  | 1097 | 1102 | } |
  | 1098 | 1103 | } |
  | 1099 | 1104 |  |
  | 1100 | 1105 | /\*\* |
  | 1101 | 1106 | \* Get dismissed notices |
  | 1102 | 1107 | \* |
  | 1103 | 1108 | \* @param int $user\_id |
  | 1104 | 1109 | \* @return array |
  | 1105 | 1110 | \*/ |
  | 1106 | 1111 | public function get\_dismissed\_notices( $user\_id ) { |
  | 1107 | 1112 | $dismissed\_notices = get\_user\_meta( $user\_id, $this->dismissed\_notices\_key, true ); |
  | 1108 | 1113 |  |
  | 1109 | 1114 | return array\_filter( explode( ',', $dismissed\_notices ), 'trim' ); |
  | 1110 | 1115 | } |
  | 1111 | 1116 |  |
  | 1112 | 1117 | /\*\* |
  | 1113 | 1118 | \* Save dismissed notices |
  | 1114 | 1119 | \* - save as string because of http://wordpress.stackexchange.com/questions/13353/problem-storing-arrays-with-update-user-meta |
  | 1115 | 1120 | \* |
  | 1116 | 1121 | \* @param int    $user\_id |
  | 1117 | 1122 | \* @param string $notice\_key |
  | 1118 | 1123 | \*/ |
  | 1119 | 1124 | public function save\_dismissed\_notices( $user\_id, $notice\_key ) { |
  | 1120 | 1125 | $dismissed\_notices   = $this->get\_dismissed\_notices( $user\_id ); |
  | 1121 | 1126 | $dismissed\_notices[] = $notice\_key; |
  | 1122 | 1127 |  |
  | 1123 | 1128 | update\_user\_meta( $user\_id, $this->dismissed\_notices\_key, implode( ',', $dismissed\_notices ) ); |
  | 1124 | 1129 | } |
  | 1125 | 1130 |  |
  | 1126 | 1131 | /\*\* |
  | 1127 | 1132 | \* Display custom text on plugin settings page |
  | 1128 | 1133 | \* |
  | 1129 | 1134 | \* @param string $text |
  | 1130 | 1135 | \*/ |
  | 1131 | 1136 | public function admin\_footer\_text( $text ) { |
  | 1132 | 1137 | $screen = get\_current\_screen(); |
  | 1133 | 1138 |  |
  | 1134 | 1139 | if ( $this->plugin\_screen\_hook\_suffix === $screen->id ) { |
  | 1135 | 1140 | $text = sprintf( |
  | 1136 | 1141 | /\* translators: link to plugin reviews page on wp.org \*/ |
  | 1137 | 1142 | \_\_( 'If you like <strong>Lightstart</strong> please leave us a %s rating. A huge thank you from WP Maintenance Mode makers in advance!', 'wp-maintenance-mode' ), |
  | 1138 | 1143 | '<a href="https://wordpress.org/support/view/plugin-reviews/wp-maintenance-mode?filter=5#new-post" class="wpmm\_rating" target="\_blank">&#9733;&#9733;&#9733;&#9733;&#9733;</a>' |
  | 1139 | 1144 | ); |
  | 1140 | 1145 | } |
  | 1141 | 1146 |  |
  | 1142 | 1147 | return $text; |
  | 1143 | 1148 | } |
  | 1144 | 1149 |  |
  | 1145 | 1150 | /\*\* |
  | 1146 | 1151 | \* Add custom state to the maintenance page |
  | 1147 | 1152 | \* |
  | 1148 | 1153 | \* @param array $post\_states Post states. |
  | 1149 | 1154 | \* @param WP\_Post $post Current post. |
  | 1150 | 1155 | \* @return array |
  | 1151 | 1156 | \*/ |
  | 1152 | 1157 | public function add\_display\_post\_states( $post\_states, $post ) { |
  | 1153 | 1158 | if ( isset( $this->plugin\_settings['design']['page\_id'] ) && $this->plugin\_settings['design']['page\_id'] == $post->ID ) { |
  | 1154 | 1159 | $post\_states['wpmm\_for\_maintenance'] = WP\_Maintenance\_Mode::get\_page\_status\_by\_category( get\_option( 'wpmm\_page\_category', 'maintenance' ) ); |
  | 1155 | 1160 | } |
  | 1156 | 1161 |  |
  | 1157 | 1162 | return $post\_states; |
  | 1158 | 1163 | } |
  | 1159 | 1164 |  |
  | 1160 | 1165 | /\*\* |
  | 1161 | 1166 | \* Add classes to make the wizard full screen |
  | 1162 | 1167 | \* |
  | 1163 | 1168 | \* @param string $classes Body classes. |
  | 1164 | 1169 | \* @return string |
  | 1165 | 1170 | \*/ |
  | 1166 | 1171 | public function add\_wizard\_classes( $classes ) { |
  | 1167 | 1172 | if ( get\_option( 'wpmm\_fresh\_install', false ) ) { |
  | 1168 | 1173 | $classes .= 'wpmm-wizard-fullscreen'; |
  | 1169 | 1174 | } |
  | 1170 | 1175 |  |
  | 1171 | 1176 | return $classes; |
  | 1172 | 1177 | } |
  | 1173 | 1178 |  |
  | 1174 | 1179 | /\*\* |
  | 1175 | 1180 | \* Return if policy is available. Useful for older WordPress versions. |
  | 1176 | 1181 | \* |
  | 1177 | 1182 | \* @return boolean |
  | 1178 | 1183 | \*/ |
  | 1179 | 1184 | public function get\_is\_policy\_available() { |
  | 1180 | 1185 | return function\_exists( 'get\_privacy\_policy\_url' ); |
  | 1181 | 1186 | } |
  | 1182 | 1187 |  |
  | 1183 | 1188 | /\*\* |
  | 1184 | 1189 | \* Return privacy policy link |
  | 1185 | 1190 | \* |
  | 1186 | 1191 | \* @return string |
  | 1187 | 1192 | \*/ |
  | 1188 | 1193 | public function get\_policy\_link() { |
  | 1189 | 1194 | // Check feature is available |
  | 1190 | 1195 | if ( $this->get\_is\_policy\_available() ) { |
  | 1191 | 1196 | return get\_privacy\_policy\_url(); |
  | 1192 | 1197 | } |
  | 1193 | 1198 | } |
  | 1194 | 1199 |  |
  | 1195 | 1200 | /\*\* |
  | 1196 | 1201 | \* Return message about privacy policy link |
  | 1197 | 1202 | \* |
  | 1198 | 1203 | \* @return string |
  | 1199 | 1204 | \*/ |
  | 1200 | 1205 | public function get\_policy\_link\_message() { |
  | 1201 | 1206 | $url = $this->get\_policy\_link(); |
  | 1202 | 1207 |  |
  | 1203 | 1208 | if ( $this->get\_is\_policy\_available() && $this->plugin\_settings['gdpr']['policy\_page\_link'] === '' ) { |
  | 1204 | 1209 | if ( $url === '' ) { // No value and feature available |
  | 1205 | 1210 | return \_\_( 'Your WordPress version supports Privacy settings but you haven\'t set any privacy policy page yet. Go to Settings ➡ Privacy to set one.', 'wp-maintenance-mode' ); |
  | 1206 | 1211 | } else { // Value and feature available |
  | 1207 | 1212 | return sprintf( |
  | 1208 | 1213 | /\* translators: privacy policy url \*/ |
  | 1209 | 1214 | \_\_( 'The plugin detected this Privacy page: %s – <button>Use this url</button>', 'wp-maintenance-mode' ), |
  | 1210 | 1215 | $url |
  | 1211 | 1216 | ); |
  | 1212 | 1217 | } |
  | 1213 | 1218 | } elseif ( $this->get\_is\_policy\_available() && $this->plugin\_settings['gdpr']['policy\_page\_link'] !== '' ) { // Feature available and value set |
  | 1214 | 1219 | if ( $url !== $this->plugin\_settings['gdpr']['policy\_page\_link'] ) { // Current wp privacy page differs from set value |
  | 1215 | 1220 | return \_\_( 'Your Privacy page is pointing to a different URL in WordPress settings. If that\'s correct ignore this message, otherwise UPDATE VALUE TO NEW URL', 'wp-maintenance-mode' ); |
  | 1216 | 1221 | } |
  | 1217 | 1222 | } elseif ( ! $this->get\_is\_policy\_available() ) { // No privacy feature available |
  | 1218 | 1223 | return \_\_( 'No privacy features detected for your WordPress version. Update WordPress to get this field automatically filled in or type in the URL that points to your privacy policy page.', 'wp-maintenance-mode' ); |
  | 1219 | 1224 | } |
  | 1220 | 1225 |  |
  | 1221 | 1226 | return ''; |
  | 1222 | 1227 | } |
  | 1223 | 1228 |  |
  | 1224 | 1229 | /\*\* |
  | 1225 | 1230 | \* Return external link icon |
  | 1226 | 1231 | \* |
  | 1227 | 1232 | \* @return string |
  | 1228 | 1233 | \*/ |
  | 1229 | 1234 | public function get\_external\_link\_icon() { |
  | 1230 | 1235 | return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="wpmm-external\_link\_icon" aria-hidden="true" focusable="false"><path d="M18.2 17c0 .7-.6 1.2-1.2 1.2H7c-.7 0-1.2-.6-1.2-1.2V7c0-.7.6-1.2 1.2-1.2h3.2V4.2H7C5.5 4.2 4.2 5.5 4.2 7v10c0 1.5 1.2 2.8 2.8 2.8h10c1.5 0 2.8-1.2 2.8-2.8v-3.6h-1.5V17zM14.9 3v1.5h3.7l-6.4 6.4 1.1 1.1 6.4-6.4v3.7h1.5V3h-6.3z"></path></svg>'; |
  | 1231 | 1236 | } |
  | 1232 | 1237 |  |
  | 1233 | 1238 | /\*\* |
  | 1234 | 1239 | \* Returns the HTML of the Otter notice |
  | 1235 | 1240 | \* |
  | 1236 | 1241 | \* @return string |
  | 1237 | 1242 | \*/ |
  | 1238 | 1243 | public function get\_otter\_notice( $location = null ) { |
  | 1239 | 1244 | return sprintf( |
  | 1240 | 1245 | '<div class="wpmm\_otter-notice"> |
  | 1241 | 1246 | <div class="wpmm\_otter-notice\_\_logo"> |
  | 1242 | 1247 | <img src="%s"/> |
  | 1243 | 1248 | </div> |
  | 1244 | 1249 | <div class="wpmm\_otter-notice\_\_text">%s&nbsp;<a href="%s" target="\_blank">%s</a></div> |
  | 1245 | 1250 | </div>', |
  | 1246 | 1251 | esc\_url( WPMM\_URL . 'assets/images/otter-logo.svg' ), |
  | 1247 | 1252 | /\* translators: %1$s %2$s bold text tags \*/ |
  | 1248 | 1253 | sprintf( \_\_( 'These templates make use of %1$s Otter Blocks %2$s powerful features, which will be installed and activated.', 'wp-maintenance-mode' ), '<b>', '</b>' ), |
  | 1249 | 1254 | tsdk\_utmify( 'https://themeisle.com/plugins/otter-blocks/', $this->plugin\_slug, $location ), |
  | 1250 | 1255 | \_\_( 'Learn more about Otter.', 'wp-maintenance-mode' ) . $this->get\_external\_link\_icon() |
  | 1251 | 1256 | ); |
  | 1252 | 1257 | } |
  | 1253 | 1258 |  |
  | 1254 | 1259 | /\*\* |
  | 1255 | 1260 | \* Display save plugin settings notice. |
  | 1256 | 1261 | \*/ |
  | 1257 | 1262 | public function save\_plugin\_settings\_notice() { |
  | 1258 | 1263 | $screen  = get\_current\_screen(); |
  | 1259 | 1264 | $notices = array(); |
  | 1260 | 1265 |  |
  | 1261 | 1266 | // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
  | 1262 | 1267 | if ( ! empty( $\_GET['updated'] ) && $this->plugin\_screen\_hook\_suffix === $screen->id ) { ?> |
  | 1263 | 1268 | <div id="message" class="updated notice is-dismissible"><p><strong><?php esc\_html\_e( 'Settings saved.', 'wp-maintenance-mode' ); ?></strong></p></div> |
  | 1264 | 1269 | <?php |
  | 1265 | 1270 | } |
  | 1266 | 1271 | } |
  | 1267 | 1272 |  |
  | 1268 | 1273 | /\*\* |
  | 1269 | 1274 | \* Add inline global style. |
  | 1270 | 1275 | \*/ |
  | 1271 | 1276 | public function add\_inline\_global\_style() { |
  | 1272 | 1277 | ?> |
  | 1273 | 1278 | <style type="text/css"> |
  | 1274 | 1279 | #toplevel\_page\_wp-maintenance-mode .wp-menu-image img { |
  | 1275 | 1280 | padding: 7px 0 0 0; |
  | 1276 | 1281 | opacity: 1; |
  | 1277 | 1282 | max-width: 20px; |
  | 1278 | 1283 | } |
  | 1279 | 1284 | </style> |
  | 1280 | 1285 | <?php |
  | 1281 | 1286 | } |
  | 1282 | 1287 | } |
  | 1283 | 1288 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3013229&old=2922691&new_path=%2Fwp-maintenance-mode%2Ftrunk%2Fincludes%2Fclasses%2Fwp-maintenance-mode-admin.php&old_path=%2Fwp-maintenance-mode%2Ftrunk%2Fincludes%2Fclasses%2Fwp-maintenance-mode-admin.php)
* [Zip Archive](?format=zip&new=3013229&old=2922691&new_path=%2Fwp-maintenance-mode%2Ftrunk%2Fincludes%2Fclasses%2Fwp-maintenance-mode-admin.php&old_path=%2Fwp-maintenance-mode%2Ftrunk%2Fincludes%2Fclasses%2Fwp-maintenance-mode-admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_18711f7c_20250114_232318.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# LightStart – Maintenance Mode, Coming Soon and Landing Page Builder <= 2.6.8 - Missing Authorization

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   LightStart – Maintenance Mode, Coming Soon and Landing Page Builder <= 2.6.8 - Missing Authorization

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2023-7019](https://www.cve.org/CVERecord?id=CVE-2023-7019) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | January 5, 2024 |
| Last Updated | January 11, 2024 |
| Researcher | [Lucio Sá](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lucio-sa) |

### Description

The LightStart – Maintenance Mode, Coming Soon and Landing Page Builder plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on the insert\_template function in all versions up to, and including, 2.6.8. This makes it possible for authenticated attackers, with subscriber-level access and above, to change page designs.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3013229/wp-maintenance-mode/trunk/includes/classes/wp-maintenance-mode-admin.php?contextall=1&old=2922691&old_path=%2Fwp-maintenance-mode%2Ftrunk%2Fincludes%2Fclasses%2Fwp-maintenance-mode-admin.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-maintenance-mode%2Flightstart-maintenance-mode-coming-soon-and-landing-page-builder-268-missing-authorization&t=LightStart%20%E2%80%93%20Maintenance%20Mode%2C%20Coming%20Soon%20and%20Landing%20Page%20Builder%20%3C%3D%202.6.8%20-%20Missing%20Authorization "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-maintenance-mode%2Flightstart-maintenance-mode-coming-soon-and-landing-page-builder-268-missing-authorization&text=LightStart%20%E2%80%93%20Maintenance%20Mode%2C%20Coming%20Soon%20and%20Landing%20Page%20Builder%20%3C%3D%202.6.8%20-%20Missing%20Authorization "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-maintenance-mode%2Flightstart-maintenance-mode-coming-soon-and-landing-page-builder-268-missing-authorization "LinkedIn")
Email

## Vulnerability Details for LightStart – Maintenance Mode, Coming Soon and Landing Page Builder

#### [LightStart – Maintenance Mode, Coming Soon and Landing Page Builder](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-maintenance-mode)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-maintenance-mode [(view on wordpress.org)](https://wordpress.org/plugins/wp-maintenance-mode) |
| Patched? | Yes |
| Remediation | Update to version 2.6.9, or a newer patched version |
| Affected Version | * <= 2.6.8 |
| Patched Version | * 2.6.9 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


