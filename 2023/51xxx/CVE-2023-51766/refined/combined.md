=== Content from access.redhat.com_fe987e26_20250115_114620.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from www.openwall.com_56a99a57_20250114_193100.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](../../../2023/12/23/5) [[next>]](2) [[<thread-prev]](../../../2023/12/23/2) [[thread-next>]](../../../2023/12/25/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20231224093335.GM14101@suse.de>
Date: Sun, 24 Dec 2023 10:33:37 +0100
From: Marcus Meissner <meissner@...e.de>
To: oss-security@...ts.openwall.com
Subject: Re: Re: New SMTP smuggling attack

On Sat, Dec 23, 2023 at 02:29:34PM +0200, Valtteri Vuorikoski wrote:
> On Fri, Dec 22, 2023 at 11:46:48AM +0100, Marcus Meissner wrote:
> > Hi,
> >
> > FWIW as no CVEs were to be found yet, I filed a CVE request for Postfix now.
> >
> > Not sure if we need it for others like sendmail too, as that is also
> > referenced by the security researchers.
>
> Looks like exim opened a bug on this yesterday too, no sign of CVE yet:
> <<https://bugs.exim.org/show_bug.cgi?id=3063>>

CVEs are assigned now for:

- CVE-2023-51764 postfix
- CVE-2023-51765 sendmail
- CVE-2023-51766 exim

Ciao, Marcus

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_b4ddcd13_20250114_193103.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](1) [[thread-next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <ZZMMi8DQbVuIvZPH@itl-email>
Date: Mon, 1 Jan 2024 14:03:35 -0500
From: Demi Marie Obenour <demi@...isiblethingslab.com>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2023-51766: Exim: SMTP smuggling

On Mon, Jan 01, 2024 at 04:10:46PM +0000, halfdog wrote:
> Solar Designer writes:
> > Hi,
> >
> > Exim was also susceptible to SMTP smuggling, and version 4.97.1 is now
> > released to address this.  Included below is doc/doc-txt/cve-2023-51766
> > from the exim-4.97.1 branch (with erroneous Date: line omitted).
> >
> > Alexander
> >
> > ---
> > CVE ID:     CVE-2023-51766
> > Credits:    <https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mai>
> > ls-worldwide/
> > Version(s): all up to 4.97 inclusive
> > Issue:      Given a buggy relay, Exim can be induced to accept a second messa
> > ge embedded
> >             as part of the body of a first message
> >
> > Conditions
> > ==========
> >
> > If *all* the following conditions are met
> >
> >     Runtime options
> >     ---------------
> >
> >     * Exim offers PIPELINING on incoming connections
> >
> >     * Exim offers CHUNKING on incoming connections
> >
> >     Operation
> >     ---------
> >
> >     * DATA (as opposed to BDAT) is used for a message reception
> >
> >     * The relay host sends to the Exim MTA message data including
> >       one of "LF . LF" or "CR LF . LF" or "LF . CR LF".
>
> Interesting, that also LF . LF is causing the effect. As there
> might be some aggressive mail server testing for that issue in
> near future anyway, could it be, that this was exactly the issue
> affecting Debian mailing lists at least 2018-2023? If not so,
> and there is a second bug, the increased testing and also public
> bug report from below will give them some interesting times ahead
> anyway.
>
> But if so, any automated mailing list forwarding might be quite
> likely (due to trigger probabilities) to have left truncated
> and non-truncated messages online, so that finding those pairs
> automatically, e.g.  using more unique text parts from list A
> messages to search for messages on any other list B and check,
> if one of them seems truncated.
>
> Here are some message examples from 2018 showing the trunction:
>
> <https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=849754#60>
> <https://lists.debian.org/debian-mentors/2018/01/msg00331.html>
>
> Then there was also a public bug report on those
>
> <https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=922652>
>
> or the ones from below.
>
> Kind regards,
> hd

I think the only reasonable thing for an SMTP server to do is to reject
all LFs and CRs in DATA that are not part of a proper CRLF outright.
--
Sincerely,
Demi Marie Obenour (she/her/hers)
Invisible Things Lab

Download attachment "[signature.asc](2/1)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_3ee09dd1_20250114_193103.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2023/12/30/4) [[next>]](2) [[<thread-prev]](../../../2023/12/29/2) [[thread-next>]](2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <2537-1704125446.658888@yYwZ.TdlG.pmeQ>
Date: Mon, 01 Jan 2024 16:10:46 +0000
From: halfdog <me@...fdog.net>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2023-51766: Exim: SMTP smuggling

Solar Designer writes:
> Hi,
>
> Exim was also susceptible to SMTP smuggling, and version 4.97.1 is now
> released to address this.  Included below is doc/doc-txt/cve-2023-51766
> from the exim-4.97.1 branch (with erroneous Date: line omitted).
>
> Alexander
>
> ---
> CVE ID:     CVE-2023-51766
> Credits:    <https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mai>
> ls-worldwide/
> Version(s): all up to 4.97 inclusive
> Issue:      Given a buggy relay, Exim can be induced to accept a second messa
> ge embedded
>             as part of the body of a first message
>
> Conditions
> ==========
>
> If *all* the following conditions are met
>
>     Runtime options
>     ---------------
>
>     * Exim offers PIPELINING on incoming connections
>
>     * Exim offers CHUNKING on incoming connections
>
>     Operation
>     ---------
>
>     * DATA (as opposed to BDAT) is used for a message reception
>
>     * The relay host sends to the Exim MTA message data including
>       one of "LF . LF" or "CR LF . LF" or "LF . CR LF".

Interesting, that also LF . LF is causing the effect. As there
might be some aggressive mail server testing for that issue in
near future anyway, could it be, that this was exactly the issue
affecting Debian mailing lists at least 2018-2023? If not so,
and there is a second bug, the increased testing and also public
bug report from below will give them some interesting times ahead
anyway.

But if so, any automated mailing list forwarding might be quite
likely (due to trigger probabilities) to have left truncated
and non-truncated messages online, so that finding those pairs
automatically, e.g.  using more unique text parts from list A
messages to search for messages on any other list B and check,
if one of them seems truncated.

Here are some message examples from 2018 showing the trunction:

<https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=849754#60>
<https://lists.debian.org/debian-mentors/2018/01/msg00331.html>

Then there was also a public bug report on those

<https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=922652>

or the ones from below.

Kind regards,
hd

To: security@...ian.org
Subject: Data corruption due to SMTP-command injection around bugs.debian.org
Date: Sat, 21 Jan 2023 10:09:44 +0000

Hello Debian Security,

It seems that somewhere at the connection point between bugs.debian.org
and at least the Debian mailing list system (debian-mentors) the
user supplied bug content is not escaped properly when submitting
bugs via SMTP. This is causing a line with a lone dot (period)
to the mails sent out by debian-mentors prematurely interpreting
the dot as an end-messages SMTP command. Maybe with a crafted
mail containing other SMTP commands after that line, these would
be executed by the SMTP server too turning this into a way to
use Debian bugs services for spamming or impersonating senders
for the domains the SMTP server is permitted to send.

The bug itself seems to occur only when sending a message with
"Content-Transfer-Encoding: quoted-printable" with a line wrapped
due to line length and "quoted-printable" causing only the dot
ending in the next line.

The result can be seen comparing the two messages

<https://lists.debian.org/debian-mentors/2023/01/msg00147.html>
<https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=993996>

Something similar was already observed once, but only in retrospect.
Therefore it was harder to reproduce. The issue was reported back
then to owner@...s.debian.org and a test bug (922652) was created.

The reason reporting to security this time is that today's event
is quite obvious in from mailing list message, that someone stumbling
over it may feel like giving it a try. Apart from that the log
messages of your involved systems are quite likely still fullly
available to track down the fault.

Kind regards,
hd

PS: The message about the same problem from 2019:

From: halfdog <me@...fdog.net>
To: owner@...s.debian.org
Subject: Strange bug tracker error
Date: Fri, 25 Jan 2019 13:31:04 +0000

Hello owner,

While running a data deduplication tool on all my sent and received
messages, I noticed an anomaly regarding a message from bugs.debian.org
There seems to be a bug somewhere on between the bugtracker inbox
processing to my mailbox, most likely in the bugtracker message
sending functionality. The result seems to be data corruption
(truncated messages) and maybe SMTP command injection when SMTP
pipelining is enabled.

Most likely cause deduced from that single anomalous message
is that a line containing a lone "." was not escaped properly,
thus ending a messages.

As the detected anomaly dates back to 2018-01-22, is there a
test bug to send a message to for testing and am I allowed to
perform the test?

hd

>     * Exim interprets the sequence as signalling the end of data for
>       the SMTP DATA command, and hence a first message.
>
>     * Exim interprets further input which the relay had as message body
>       data, as SMTP commands and data. This could include a MAIL, RCPT,
>       BDAT (etc) sequence, resulting in a further message acceptance.
>
> Impact
> ======
>
> One or more messages can be accepted by Exim that have not been
> properly validated by the buggy relay.
>
> Fix
> ===
>
> Install a fixed Exim version:
>
>     4.98 (once available)
>     4.97.1
>
> If you can't install one of the above versions, ask your package
> maintainer for a version containing the backported fix. On request and
> depending on our resources we will support you in backporting the fix.
> (Please note, that Exim project officially doesn't support versions
> prior the current stable version.)
>
>
> Workaround
> ==========
>
>   Disable CHUNKING advertisement for incoming connections.
>
>   An attempt to "smuggle" a DATA command will trip a syncronisation
>   check.
>
> *or*
>
>   Disable PIPELINING advertisement for incoming connections.
>
>   The "smuggled" MAIL FROM command will then trip a syncronisation
>   check.

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from sec-consult.com_4dd94eef_20250115_114618.html ===

Toggle Navbar

* [Career](/career/)
* [About us](/about-us/)
* [Contact](/contact/)

* EN
  + [DE](/de/blog/detail/smtp-smuggling-ein-neue-methode-zur-absenderfaelschung-in-e-mails/ "German")
Search

* Compliance & Regulations
  + [NIS2](/compliance-regulations/nis2/)
  + [Digital Operational Resilience Act (DORA)](/compliance-regulations/dora/)
* Security Testing
  + [Web Application Security](/security-testing/web-application-security/)
  + [Penetration Testing](/security-testing/penetration-testing/)
  + [Mobile Security](/security-testing/mobile-security/)
  + [Cloud Security](/security-testing/cloud-security/)
  + [IT Infrastructure Security](/security-testing/it-infrastructure-security/)
  + [Security for SAP Services](/security-testing/security-for-sap-services/)
  + [IoT and Embedded Systems Security](/security-testing/iot-and-embedded-systems-security/)
  + [Red Teaming](/security-testing/red-teaming/)
* Processes & Organisation
  + [Information Security Management (ISM)](/processes-organisation/information-security-management-ism/)
  + [OT Security](/processes-organisation/ot-security/)
  + [Secure Software Development Consulting](/processes-organisation/secure-software-development/)
  + [Red Teaming](/security-testing/red-teaming/)
  + [SEC Trainings](/processes-organisation/sec-trainings/)
  + [Project- und Program Management](/processes-organisation/project-und-program-management/)
* Incident Response
  + [SEC Defence](/incident-response/sec-defence/)
* [Vulnerability Lab](/vulnerability-lab/)
* [Blog](/blog/)
 [Incident?
Breached?
Report an incident](/incident-response/sec-defence/)

1. [Home](/)
2. [Blog](/blog/)
3. SMTP Smuggling - Spoofing E-Mails Worldwide
# SMTP Smuggling - Spoofing E-Mails Worldwide

18.12.2023

Introducing a novel technique for e-mail spoofing

![Overview SMTP Smuggling](/fileadmin/_processed_/a/8/csm_SMTP_Smuggling-Overview_Header_1ec709623c.png)

*In the course of a research project in collaboration with the SEC Consult Vulnerability Lab, Timo Longin ([@timolongin](https://twitter.com/timolongin)) - known for his [DNS protocol attacks](https://sec-consult.com/blog/detail/taking-over-a-country-kaminsky-style/) - discovered a novel exploitation technique for yet another Internet protocol - SMTP ([Simple Mail Transfer Protocol](https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol)). Threat actors could abuse vulnerable SMTP servers worldwide to send malicious e-mails from arbitrary e-mail addresses, allowing targeted phishing attacks. Due to the nature of the exploit itself, this type of vulnerability was dubbed **SMTP smuggling**. Multiple 0-days were discovered, and various vendors were notified during our responsible disclosure in 2023.*

## Update on SMTP smuggling and responsible disclosure

Update 2024-02-19: The SMTP smuggling research scored 3rd place in the Portswigger Top 10 web hacking techniques of 2023, check it out here: [portswigger.net/research/top-10-web-hacking-techniques-of-2023](https://portswigger.net/research/top-10-web-hacking-techniques-of-2023)

Update 2024: We have created a new website which gives a short summary about the identified vulnerability, available tools and mitigations of various vendors: [smtpsmuggling.com](https://smtpsmuggling.com/)

Update, 2023-12-22: We were made aware of public discussions about the SMTP smuggling research on various platforms and we wanted to add some input regarding responsible disclosure as well as previous and further communication with the vendors.

We strictly adhere to our responsible disclosure processes (<https://sec-consult.com/vulnerability-lab/responsible-disclosure-policy/>) and always contact affected vendors before any publication. But in this case a lack of clarity in the communication and different interpretations of the impact of the vulnerability led to assumptions from all parties involved on who is affected, what the real impact could be and who has to be notified before publication.

As documented in the timeline of the blog post, the vulnerabilities were initially identified in June 2023 and after further internal research we contacted the specific, affected vendors (Microsoft, Cisco, GMX/Ionos). GMX and Microsoft fixed the issues promptly. But after receiving some feedback from Cisco, that our identified vulnerability is just a feature of the software and not a bug/vulnerability, we contacted CERT/CC on 17th August to get some help for further discussion with Cisco and involve other potentially affected vendors (such as sendmail) through the [VINCE communication platform](https://kb.cert.org/vince/).

There, we submitted all our research details and explained the case to the vendors involved. We received feedback from Cisco that our identified research is not a vulnerability, but a feature and that they will not change the default configuration nor inform their customers. Other vendors did not respond in VINCE but were contacted by CERT/CC.

Based on this feedback and as multiple other vendors were included in this discussion through the CERT/CC VINCE platform without objecting, we wrongly assessed the broader impact of the SMTP smuggling research. Because of this assumption, we asked CERT/CC end of November regarding publication of the details and received confirmation to proceed.

As our research was accepted at this year's 37C3 conference (info received on 3rd December) and we still thought that Cisco users should be warned about the vulnerable default configuration, we decided to publish our research before the conference and holidays in order to provide administrators time to re-configure their Cisco configuration. Hence, we also contacted CERT-Bund (BSI Germany) and CERT.at on 5th December via encrypted email and informed them about the planned release date of the blog post for 18th December and included the full blog post details and further call for action to warn Cisco users.

 Furthermore, we continue discussing SMTP smuggling with CERT/CC and affected vendors through the VINCE platform to address future remediation and measures.

 Our learnings from this case are that we will put even more thought into potential broader impact when sharing details with affected vendors and to strengthen the collaboration and communication with all parties involved.

## Postfix remediation and workaround

Postfix developers Wietse Venema and Viktor Dukhovni have promptly responded to the SMTP smuggling threat and released short-term workarounds on how the vulnerability can be fixed:

<https://www.postfix.org/smtp-smuggling.html>

###

### Official tools to test for SMTP smuggling issues are now available on [GitHub](https://github.com/The-Login/SMTP-Smuggling-Tools)

[![Example SMTP session between sender.example and receiver.example ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_full__02_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_full__02_.png)

Figure 1: Example SMTP session between sender.example and receiver.example

Novel attacks in SMTP? Yes, you read that right - **SMTP!**

Even though SMTP, the Simple Mail Transfer Protocol, is used for sending e-mails across the globe since the beginning of the Internet, it is still possible to find new ways of exploiting it even in 2023! So, **fasten your seat belts**, as we embark on an expedition beyond the known limits of SMTP, and venture into the uncharted territories of **SMTP smuggling**!

## TL;DR

By exploiting interpretation differences of the SMTP protocol, it is possible to smuggle/send spoofed e-mails - hence SMTP smuggling - while still passing SPF alignment checks. During this research, two types of SMTP smuggling, **outbound** and **inbound**, were discovered. These allowed sending spoofed e-mails **from millions** of domains (e.g., admin@outlook.com) to millions of receiving SMTP servers (e.g., Amazon, PayPal, eBay). Identified vulnerabilities in Microsoft and GMX were quickly fixed, however, **SEC Consult urges** companies using the also affected [Cisco Secure Email](https://www.cisco.com/site/in/en/products/security/secure-email/index.html) product to manually update their vulnerable default configuration (see Responsible Disclosure section below)!

##

## SMTP Basics

Before getting into the juicy bits and details of SMTP smuggling, we must first have a basic understanding of the SMTP protocol, SMTP terminology and e-mailing in general. Let's learn by example!

Here, in figure 1, we have an SMTP session between sender.example and receiver.example.

[![SMTP session transferring a mail object, including mail envelope and mail content/data, with SMTP commands, line breaks and data separated by color. ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_only_sender__03_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_only_sender__03_.png)

Figure 2: SMTP session transferring a mail object, including mail envelope and mail content/data, with SMTP commands, line breaks and data separated by color.

So, what's exactly going on here?

1. Initially, the receiving SMTP server **mx.receiver.example** sends a greeting, indicating that it is ready to accept incoming SMTP commands.
2. The "client"/sender **sender.example** initiates the SMTP session by sending the EHLO (extended hello) **SMTP command** to the server, specifying its domain name. Note that all SMTP commands will be highlighted in red.
3. **mx.receiver.example** responds with a 250 status code, indicating that the requested command (EHLO) was successful. It also provides supported **SMTP capabilities**.
4. Then, **sender.example** specifies the sender e-mail address as well as the receiver e-mail address via "mail FROM" and "rcpt TO" in the mail **envelope**. **mx.receiver.example** confirms both of these **SMTP commands** with a 250 status code.
5. Now, **sender.example** transmits the "data" command to signal its intention to start sending the message data/content.
6. After receiving a "go ahead" response, **sender.example** sends **message****headers** "Subject"/"From"/"To", a **message body** "lorem ipsum" and an **end-of-data sequence****"<CR><LF>.<CR><LF>"** (Carriage-Return / Line-Feed, and a single dot in a line). Note that all message data will be highlighted in blue.
7. **mx.receiver.example** reads the end-of-data sequence and responds with a 250 status code, implying that the message data was accepted.
8. Lastly, **sender.example** closes the connection via the "quit" command.

As you can see, there is a lot of back and forth in this SMTP session. To keep it simple and concise, SMTP sessions in this blog post **only** include the data transmitted by the sender as shown in figure 2.

[![Overview of a simplified e-mailing process via SMTP from left to right ](/fileadmin/_processed_/5/d/csm_SMTP_Smuggling-Sending_e-mails_overview__3__04__803988674e.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Sending_e-mails_overview__3__04_.png)

Figure 3: Overview of a simplified e-mailing process via SMTP from left to right

With this much knowledge about the SMTP protocol, we can put the training wheels aside and look at how SMTP is used to transfer e-mails across the Internet. For example, by sending an e-mail from user(at)outlook.com to user(at)receiver.example!

When sending an e-mail via [outlook.com](https://outlook.com/), we generally have two options:

1. Outlook's web interface
2. Using SMTP

Since this blog post is about SMTP smuggling and doesn't have to do anything with web applications (like [SMTP header injection](https://portswigger.net/kb/issues/00200800_smtp-header-injection)), we're opting for number two - SMTP! How this works is described in figure 3.

So, starting from the left side of the overview, the **mail user agent** (**MUA**: Thunderbird, Outlook, Windows Mail, etc.) connects to Outlook's **mail transfer agent** (**MTA**) on the message submission port TCP/587. MTAs that are dedicated to sending **outbound e-mails** are further addressed as **outbound SMTP servers**. The MUA then sends a series of SMTP commands and message data. Since we haven't described the STARTTLS and AUTH LOGIN commands before, here is a short description:

* **STARTTLS** is used to upgrade to an encrypted TLS session. Since SMTP is generally unencrypted, credentials would otherwise be exposed to listening attackers.
* The AUTH LOGIN SMTP command is used for authenticating the user. In this case, this is done via username and password.

After evaluating if the authenticated user is allowed to send an e-mail for the provided e-mail address in the "mail FROM" and "From" fields, the Outlook SMTP server sends an **inbound e-mail** to the **inbound SMTP server** of **receiver.example** over port TCP/25. This SMTP data looks very similar to the SMTP data submitted to the **outbound SMTP** server, but doesn't include the AUTH LOGIN command and, in this case, doesn't use STARTTLS.

This concludes the e-mail transfer. But how does the receiving inbound SMTP server make sure that the outbound SMTP server is indeed allowed to send e-mails for outlook.com? Or, why can't just anyone send e-mails for the outlook.com domain?

## SPF, DKIM and DMARC

Before an inbound SMTP server accepts an e-mail, it checks the sender's authenticity via e-mail authentication mechanisms such as [SPF](https://en.wikipedia.org/wiki/Sender_Policy_Framework), [DKIM](https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail) and [DMARC](https://en.wikipedia.org/wiki/DMARC). This is important, since otherwise attackers could just send e-mails from arbitrary domains. For example, sending an e-mail as admin(at)outlook.com from an attacker server would be entirely possible. The most prevalent e-mail authentication mechanism, **SPF**, works by permitting sender IP addresses in special SPF/TXT DNS records. The SPF record of [outlook.com](http://outlook.com/) permits the following IP ranges for e-mail transfer:

v=spf1 include:spf-a.outlook.com include:spf-b.outlook.com ip4:157.55.9.128/25 include:spf.protection.outlook.com include:spf-a.hotmail.com include:\_spf-ssg-b.microsoft.com include:\_spf-ssg-c.microsoft.com ~all

[![Passing SPF checks with attacker.example domain, while sending as user@sender.example ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_only_sender_SPF_spoofing__05_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_only_sender_SPF_spoofing__05_.png)

Figure 4: Passing SPF checks with attacker.example domain, while sending as user@sender.example

If you are not sending from one of these IP ranges, the SPF check would fail and your e-mail most likely won't be forwarded or will be marked as spam. But which domain is actually getting checked? The problem with SPF by itself is that only the MAIL FROM domain from the mail envelope is checked. The From header in the message data, which is further displayed in the received e-mail, can have an arbitrary value, as shown in figure 4 (blue text).

[![Passing SPF and DKIM checks, by sending from an attacker server with an attacker-controlled DKIM key ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_only_sender_SPF_and_DKIM_spoofing__06_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_only_sender_SPF_and_DKIM_spoofing__06_.png)

Figure 5: Passing SPF and DKIM checks, by sending from an attacker server with an attacker-controlled DKIM key

The same goes for **DKIM** (DomainKeys Identified Mail) as well. DKIM allows signing the message data, including the From header. This signature can then be verified by the receiver with a public key that resides in the DNS. However, it is not enforced, which domain holds the public key (see figure 5).

In this case, the message from "user@sender.example" may be signed, but the verification key is located at "dkim.\_domainkey.attacker.example". This location is derived from concatenating the selector (s=) "dkim", the static value "\_domainkey" and the domain (d=) "attacker.example". So, even though an e-mail may have a valid SPF record and a valid DKIM signature, there is no mechanism for telling if the e-mail comes from a malicious sender or not.

Fortunately, there is **DMARC**, which stands for "Domain-based Message Authentication, Reporting and Conformance". DMARC introduces so-called "identifier alignment" for SPF and DKIM and allows senders to specify alignment policies for both methods. It verifies if the email's "From" domain aligns with SPF checks and/or DKIM signatures. Thus, the DMARC check fails if there is a mismatch between the MAIL FROM and the From domain where otherwise the SPF check would pass. An example for a DMARC policy, which is always located in a TXT record at \_dmarc.[domain], can be seen here:

v=DMARC1; p=reject; sp=none; fo=0; adkim=r; aspf=r; pct=100; rf=afrf

The policy (p=) tells the receiving server to reject 100 percent (pct=) of the messages that fail the DMARC check. Therefore, the message will get accepted (only) if a valid SPF record and/or DKIM signature is provided.

However, what happens if there is no DMARC record? In general, e-mail authenticity handling heavily depends on the inbound SMTP server's configuration and software. As a rule of thumb, if there is SPF or DKIM alignment, there is a good chance of the e-mail being accepted!

Now, with the groundwork done, let's get into **SMTP smuggling**!

[![Simple example of HTTP request smuggling by PortSwigger ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-HTTP_request_smuggling__07_.png "Figure 6: Simple example of HTTP request smuggling by PortSwigger ")](https://portswigger.net/web-security/request-smuggling "Figure 6: Simple example of HTTP request smuggling by PortSwigger")

Figure 6: Simple example of HTTP request smuggling by PortSwigger

## SMTP Smuggling?

The initial goal of this research was to test the SMTP protocol against some common and exotic attacks that work on other protocols, such as HTTP. Thanks to the contribution of many brilliant minds, there is a variety of **HTTP** attacks to choose from. However, in the context of SMTP, one of them just fit the bill. **HTTP request smuggling**!

If you want an in-depth explanation of HTTP request smuggling and all its facets, James Kettle (aka [@albinowax](https://twitter.com/albinowax)) did a [wonderful job](https://jameskettle.com/) on that. However, for now, we only need to understand the essentials!

With HTTP request smuggling, we're basically trying to exploit different interpretations of the same thing. For example, with discrepancies in the interpretation and processing of the "Content-Length" and "Transfer-Encoding" HTTP headers, an arbitrary HTTP request can be smuggled to an otherwise unreachable back-end server like in figure 6.

[![SMTP session with SMTP commands and message data separated by colour. ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_only_sender__08_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_example_only_sender__08_.png)

Figure 7: SMTP session with SMTP commands and message data separated by colour.

In this example, the vulnerable front-end server only sees one HTTP POST request, while the back-end server sees a POST request **and** a GET request to /**admin**!

With SMTP, we also have a setup with two servers, being **outbound and inbound SMTP servers**. So, let's take a look at an SMTP session again in figure 7.

[![SMTP smuggling in theory ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png)

Figure 8: SMTP smuggling in theory

Now tell me, **what happens if outbound and inbound SMTP servers interpret the end-of-data sequence (<CR><LF>.<CR><LF>) differently?**

Exactly, S**MTP smuggling!**

If SMTP servers have a different understanding of where the message data ends, an attacker can potentially break out of the message data. Even worse, this may allow to specify arbitrary SMTP commands and even to send separate e-mails (see figure 8)!

[![SMTP analysis setup for analyzing outbound SMTP servers ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_analysis_test_setup__3__10_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_analysis_test_setup__3__10_.png)

Figure 9: SMTP analysis setup for analyzing outbound SMTP servers

So, that's the basic idea of SMTP smuggling! But does it actually work?

## <CR><LF>.<CR><LF> is a lie?

To get a good understanding of how different kinds of SMTP software work, we can start our analysis as shown in figure 9:

[![Using \n.\n as end-of-data sequence #1 ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_CRLF_smuggling___11_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_CRLF_smuggling___11_.png)

Figure 10: Using \n.\n as end-of-data sequence #1

First, we register e-mail accounts at various public e-mail providers that support mail submissions via SMTP (unlike Tutanota and ProtonMail). We used the following providers for this research project:

* outlook.com
* gmail.com
* gmx.net
* icloud.com
* zoho.com
* fastmail.com
* runbox.com
* startmail.com
* mailbox.org
* aol.com
* yahoo.com
* web.de

Then, by sending e-mails through the **outbound** SMTP servers of these providers and receiving them on an **inbound SMTP analysis server**, we can see first differences in the implementation of the SMTP protocol in these SMTP servers.

When looking at the **SMTP analysis client** it becomes apparent straight away that some SMTP products do things "differently" than others. For example, here are some responses received from e-mail providers after sending the **DATA** SMTP command:

- 250 End data with <CR><LF>.<CR><LF>
 - 250 Start mail input; end with <CRLF>.<CRLF>
 - 250 Send data ending with <CRLF>.<CRLF>

This doesn't look good for our plans to smuggle SMTP commands, since we're looking for different interpretations of SMTP, and not the same text written differently. Right? But, we're not going to back off just because of some text, are we?

After further analysis, some SMTP servers returned the following responses, which looked a bit more promising:

- Enter message, ending with "." on a line by itself
 - Enter mail, end with "." on a line by itself

Why would that be more promising, though? Well, different operating systems have a different understanding of "**a line by itself**". A "." on a line by itself on Windows would be separated via two carriage return line feeds (**<CR><LF>.<CR><LF>** or **\r\n.\r\n**), while a "." on a line by itself on Linux would be separated with two line feeds (<LF>.<LF> or \n.\n).

So, why don't we try to end the message data of an e-mail with **<LF>.<LF>?** This would therefore look like in figure 10.

[![Using \n.\n as end-of-data sequence #2 ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_CRLF_smuggling__12_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_CRLF_smuggling__12_.png)

Figure 11: Using \n.\n as end-of-data sequence #2

Now, if an SMTP server doesn't consider <LF>.<LF> as the end-of-data sequence, the connection will be left hanging, since it's waiting for the actual <CR><LF>.<CR><LF>. Therefore, as shown in figure 11, we add the following.

[![Outbound e-mail provider delivering an e-mail with <LF>.<LF> sequence (not vulnerable) ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-12-4_19-57-58__13_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-12-4_19-57-58__13_.png)

Figure 12: Outbound e-mail provider delivering an e-mail with <LF>.<LF> sequence (not vulnerable)

With this, whenever <LF>.<LF> is supported as end-of-data sequence by the inbound SMTP server, only "lorem ipsum" will be part of the message data, otherwise the message also includes "This server is ignoring line feeds as end-of-data sequence!".

But, what can we actually achieve with this? Well, let's see how a message transfer could look like if <LF>.<LF> doesn't end the data section, like in figure 12.

[![Outbound e-mail provider delivering an e-mail with <LF>.<LF> sequence (vulnerable) ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-CRLF_Smuggling_2__3__14_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-CRLF_Smuggling_2__3__14_.png)

Figure 13: Outbound e-mail provider delivering an e-mail with <LF>.<LF> sequence (vulnerable)

Depending on the receiving inbound SMTP server this may be completely harmless. However, what if the inbound SMTP server interprets <LF>.<LF> as end-of-data sequence? (see figure 13)

[![Potential end-of-data sequence between START and END going through GMX's outbound SMTP server unchanged ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-GMX_Smuggling__3__15_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-GMX_Smuggling__3__15_.png)

Figure 14: Potential end-of-data sequence between START and END going through GMX's outbound SMTP server unchanged

In this case, the "harmless" <LF>.<LF> breaks out of the message data and "This server is ignoring line feeds as end-of-data sequence!" may now be interpreted as an **SMTP command**! Note that this requires the inbound server to accept multiple SMTP commands in a batch, or so-called SMTP pipelining. Luckily for us, most servers support this nowadays.

However, **outbound SMTP servers** commonly handle such "troublesome" <LF>.<LF> sequences via different means:

* Dot-stuffing (Escaping the single dot with another dot):  <LF>..<LF>
* Replacing it with a <CR><LF>
* Encoding it (e.g., via quoted-printable): =0A.=0A
* Removing the entire sequence
* Not sending the message

But sometimes, **they do nothing at all**!

So, essentially, we're looking for specific characteristics in outbound and inbound SMTP servers in terms of end-of-data sequence handling. More precisely, we're searching for what outbound SMTP servers ignore (e.g., <LF>.<LF>) and what inbound SMTP servers interpret (e.g., <LF>.<LF> as end-of-data). If we can find a correct combination, we can smuggle!

## First Blood

As previously mentioned, we've created e-mail accounts at various e-mail providers. Shortly after sending potential end-of-data sequences (e.g., <LF>.<LF>) from outbound provider SMTP servers to the SMTP analysis server, a **promising candidate emerged**!

**GMX**, established in 1997, is one of the old-school e-mail providers in the DACH region with roughly 20 million users. When sending an **<LF>.<CR><LF>** sequence to the outbound GMX SMTP server, it is passed unfiltered to the inbound SMTP server, as shown in figure 14!

[![SMTP smuggling from admin@gmx.net to user@provider.example ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_smuggling_GMX__16_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_smuggling_GMX__16_.png)

Figure 15: SMTP smuggling from admin@gmx.net to user@provider.example

Therefore, we can now break out of the message data at the inbound SMTP server, if <LF>.<CR><LF> is interpreted as an end-of-data sequence. So, how do we find such servers?

We simply send an e-mail with the following message data (see figure 15) to all the e-mail addresses we've registered.

[![Failed attempt of SMTP smuggling against Gmail ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/GMX_to_GMAIL_smuggling_failed__17_.PNG)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/GMX_to_GMAIL_smuggling_failed__17_.PNG)

Figure 16: Failed attempt of SMTP smuggling against Gmail

For a lot of them, we receive a very suspicious looking e-mail like in figure 16, since <LF>.<CR><LF> did not end the message data.

[![Successful SMTP smuggling from GMX to Fastmail. "Look at me! I am the admin now!" ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/GMX_to_FASTMAIL_smuggling_success__18_.PNG)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/GMX_to_FASTMAIL_smuggling_success__18_.PNG)

Figure 17: Successful SMTP smuggling from GMX to Fastmail. "Look at me! I am the admin now!"

But for some of them, we hit the jackpot!

[![Cross-domain SMTP smuggling to different recipients ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_smuggling_WEB.DE_19_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_smuggling_WEB.DE_19_.png)

Figure 18: Cross-domain SMTP smuggling to different recipients

This proof of concept (figure 17) was the first sign that SMTP smuggling actually works!

By inspecting the message headers, we can see that the SPF check passes with domain alignment for gmx.net! This is because the smuggled message actually came from the legitimate GMX SMTP server.

Received-SPF: pass

    (gmx.net: 212.227.15.15 is authorized to use 'admin@gmx.net' in 'mfrom' identity (mechanism 'ip4:212.227.15.0/25' matched))

    receiver=mx4.messagingengine.com;

    identity=mailfrom;

    envelope-from="admin@gmx.net";

    helo=mout.gmx.net;

    client-ip=212.227.15.15

Since we've achieved domain alignment for gmx.net, this e-mail will most likely pass spam filters, even with strict DMARC policies! **But wait**, if other domains also use the outbound SMTP server of GMX to send e-mails, can't we spoof them as well? Let's see! By analyzing the SPF record of **web.de**, we can see that the outbound SMTP IP address of GMX **212.227.15.15** is included as well!

v=spf1 ip4:212.227.126.128/25 ip4:212.227.15.0/25 ip4:212.227.17.0/27 ip4:217.72.192.248/29 ip4:82.165.159.0/26 ip4:217.72.207.0/27 ip4:217.72.192.64/26 ip4:82.165.229.130 ip4:82.165.230.22 ~all

Now, we can change the SMTP smuggling message data accordingly, like in figure 18.

[![Successful cross-domain SMTP smuggling from GMX to Fastmail using web.de as sender domain ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/WEB.DE_to_FASTMAIL_smuggling_success__20_.PNG)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/WEB.DE_to_FASTMAIL_smuggling_success__20_.PNG)

Figure 19: Successful cross-domain SMTP smuggling from GMX to Fastmail using web.de as sender domain

To simulate a real-life scenario, we specify a different receiver e-mail address for the first message and only send the smuggled message (figure 19) to the target.

[![Censored (real) profile picture associated with admin@web.de ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-12-4_21-4-41__21_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-12-4_21-4-41__21_.png)

Figure 20: Censored (real) profile picture associated with admin@web.de

In this case, our target would even see the associated profile picture (in this case of the real 'admin@web.de' user), like in figure 20!

[![Sending message data via BDAT](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-BDAT__22_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-BDAT__22_.png)

Figure 21: Sending message data via BDAT

And again, the SPF verification checks out!

Received-SPF: pass

    (web.de: 212.227.17.22 is authorized to use 'admin@web.de' in 'mfrom' identity (mechanism 'ip4:212.227.17.0/27' matched))

    receiver=mx4.messagingengine.com;

    identity=mailfrom;

    envelope-from="admin@web.de";

    helo=mout.gmx.net;

    client-ip=212.227.17.22

Now, you might think that this was already cool, **but we're just getting started**!

Even though we initially only analyzed GMX, the problem is far worse than it seemed at first. Like many big e-mail providers, GMX is using a custom SMTP server called **Nemesis****SMTPd**. Since GMX is part of **Ionos**, e-mailing services provided by Ionos are also using Nemesis SMTPd. By putting 1 and 1 together, we register an e-mail domain at Ionos and check if SMTP smuggling works. And it does! However, smuggling via a custom e-mail domain doesn't even seem to be necessary. The SPF record for the registered e-mail domain includes "\_spf-eu.ionos.com" and the SPF record for gmx.net includes "\_spf.gmx.net". Looking at the permitted IP ranges reveals "some" collisions:

$ dig \_spf-eu.ionos.com TXT
 "v=spf1 ip4:212.227.126.128/25 ip4:212.227.15.0/25 ip4:212.227.17.0/27 ip4:82.165.159.0/26 ip4:217.72.192.64/26 ?all"

 $ dig \_spf.gmx.net TXT
 "v=spf1 ip4:212.227.126.128/25 ip4:212.227.15.0/25 ip4:212.227.17.0/27 ip4:82.165.159.0/24 ip4:74.208.4.192/26  ip4:217.72.207.0/27 ip4:82.165.229.31 ip4:82.165.230.21 ip4:213.165.64.0/23 ip4:74.208.5.64/26 ~all"

So, either way, this allowed **spoofing** not only **gmx.net** and **web.de**, but also around a **million** other domains hosted at **Ionos**! But more on the details later!

## Smuggling via Microsoft Exchange Online

After a deeper analysis of outbound SMTP servers, a peculiarity in **Microsoft Outlook's** ([outlook.com](https://outlook.com/)) SMTP server was observed. When trying to send an **<LF>.<LF>** sequence, the message does not get transmitted, and the following error message is returned:

Remote server returned '550 5.6.11 SMTPSEND.BareLinefeedsAreIllegal; message contains bare linefeeds, which cannot be sent via DATA and receiving system does not support BDAT'

However, same as with GMX, **Outlook doesn't filter <LF>.<CR><LF>** sequences.

Still, it wasn't possible to smuggle to the same receivers (e.g., Fastmail) as with GMX. Reason for this is Outlook's usage of the optional **BDAT** SMTP command. BDAT is an alternative to the **DATA** command to transfer the message data. It works by specifying the message length with the BDAT command, instead of relying on an end-of-data sequence. For example, to transfer 72 bytes of message data, we can do it like in figure 21.

[![Sending a phishing e-mail from admin@outlook.com via SMTP smuggling](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_smuggling_Outlook__23_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_smuggling_Outlook__23_.png)

Figure 22: Sending a phishing e-mail from admin@outlook.com via SMTP smuggling

Even though that stops us from smuggling to some inbound SMTP servers, the BDAT command can only be used by Outlook, if the inbound SMTP server supports it. If the inbound SMTP server doesn't indicate BDAT support by returning the **CHUNKING** capability, DATA is used as fallback.

Therefore, we're looking for an inbound SMTP server that interprets <LF>.<CR><LF> as an end-of-data sequence and doesn't support BDAT.

Funnily enough, the [sec-consult.com](https://sec-consult.com/) SMTP server supports just that! Note that **LOTS** of servers on the Internet support this, but since we've got to make sure that our own systems are secure anyways, we'll be using sec-consult.com. So, what's the first thing to do with our newly gained power? **Sending spoofed e-mails to co-workers to make sure it actually works!** (see figure 22)

[![Typical Austrian reaction after receiving a spoofed e-mail ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/teams_conversation_OIDA__24_.PNG)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/teams_conversation_OIDA__24_.PNG)

Figure 23: Typical Austrian reaction after receiving a spoofed e-mail

Based on their reaction (figure 23), the message from admin(at)outlook.com definitely got delivered and didn't end up in spam.

[![Receiving a spoofed e-mail from admin@outlook.com aka Timo Lo(n)gin ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-7-5_15-26-20__24_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-7-5_15-26-20__24_.png)

Figure 24: Receiving a spoofed e-mail from admin@outlook.com aka Timo Lo(n)gin

The actual e-mail is shown in figure 24:

[![Using HTML with SMTP smuggling to create a convincing phishing e-mail ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-7-10_22-55-21__25_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-7-10_22-55-21__25_.png)

Figure 25: Using HTML with SMTP smuggling to create a convincing phishing e-mail

We can once more confirm SPF alignment by looking at the message headers:

Received-SPF: Pass ([mx3.atos.net](http://mx3.atos.net/): domain of admin(at)outlook.com designates 40.92.75.68 as permitted sender)
   identity=mailfrom; client-ip=40.92.75.68;
   receiver=[mx3.atos.net](http://mx3.atos.net/); envelope-from="admin@[outlook.com](http://outlook.com/)";
   x-sender="admin@[outlook.com](http://outlook.com/)"; x-conformance=spf\_only;
   x-record-type="v=spf1"; x-record-text="v=spf1
   ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14
   ip4:104.47.0.0/17 ip6:2a01:111:f400::/48
   ip6:2a01:111:f403::/49 ip6:2a01:111:f403:8000::/50
   ip6:2a01:111:f403:c000::/51 ip6:2a01:111:f403:f000::/52 -all"

Since the previous examples were only text-based, attackers could also use HTML, for some more convincing phishing e-mails (figure 25).

[![Receiving a spoofed e-mail on hr@sec-consult.com from ceo@sec-consult.com ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-7-5_15-53-16__26_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-7-5_15-53-16__26_.png)

Figure 26: Receiving a spoofed e-mail on hr@sec-consult.com from ceo@sec-consult.com

However, to keep it simple, we'll stick to just text.

So, this is cool, but again, **that's not everything**! Since the outbound Outlook SMTP server is not only used for e-mails by [outlook.com](https://outlook.com/), but for **the entirety of Exchange Online**, we can now send e-mails from **every domain which uses Exchange Online to send e-mails**!

Since this affects **LOTS** of companies (as later discussed in SMTP Smuggling Impact section), we can choose our sender domain freely. We can even use [sec-consult.com](https://sec-consult.com/) itself! (see figure 26)

[![Example message data with exotic end-of-data sequence using a null byte ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_exotic__27_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_session_exotic__27_.png)

Figure 27: Example message data with exotic end-of-data sequence using a null byte

As before, the SPF check succeeds with domain alignment, since sec-consult.com is using Exchange Online and the SPF record includes the respective Exchange Online SPF domain **spf.protection.outlook.com**.

Received-SPF: Pass ([mx4.atos.net](http://mx4.atos.net/): domain of ceo(at)sec-consult.com
   designates 40.92.48.103 as permitted sender)
   identity=mailfrom; client-ip=40.92.48.103;
   receiver=[mx4.atos.net](http://mx4.atos.net/); envelope-from="ceo@[sec-consult.com](http://sec-consult.com/)";
   x-sender="ceo@[sec-consult.com](http://sec-consult.com/)"; x-conformance=spf\_only;
   x-record-type="v=spf1"; x-record-text="v=spf1
   ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14
   ip4:104.47.0.0/17 ip6:2a01:111:f400::/48
   ip6:2a01:111:f403::/49 ip6:2a01:111:f403:8000::/50
   ip6:2a01:111:f403:c000::/51 ip6:2a01:111:f403:f000::/52 -all"

With GMX and Exchange Online out of the way, we're now approaching our last target!

## Smuggling to Amazon, PayPal, eBay, ..., on the road to Cisco

GMX and Exchange Online allow SMTP smuggling due to insufficient sanitization at their outbound SMTP servers, **but what about insecure inbound SMTP servers**? What if there are inbound SMTP servers that allow such non-restrictive end-of-data sequences that even the most restrictive outbound SMTP servers would let such sequences through?

To get to the bottom of this, we can use a scanner that sends e-mails to inbound SMTP servers, but uses exotic end-of-data sequences. If the connection to the inbound SMTP server times out, the exotic end-of-data sequence was ignored. Otherwise, we most likely found something interesting!

So, what exactly is "exotic"? Exotic end-of-data sequences could for example be:

* Interrupted end-of-data sequences:
  + <CR><LF>\x00.<CR><LF>
  + <CR><LF>.\x00<CR><LF>
* End-of-data sequences using incomplete CRLFs:
  + <LF>.<LF>
  + <CR><LF>.<CR>
  + <CR>.<LF>
* End-of-data sequences in the message header

The message data of such an "exotic" e-mail could look like in figure 27.

[![SMTP smuggling exploiting exotic end-of-data sequence <CR>.<CR> ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_smuggling_iCloud__28_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-SMTP_smuggling_iCloud__28_.png)

Figure 28: SMTP smuggling exploiting exotic end-of-data sequence <CR>.<CR>

Now, by scanning the former Alexa Top 1000, various inbound SMTP servers accepting such sequences were identified! However, only one of those sequences seems to be working for lots of SMTP servers: **<CR>.<CR>**

This sequence gets accepted by the inbound e-mail servers of some really high-value targets:

* Amazon
* PayPal
* eBay
* Cisco
* The IRS

The one thing that they all have in common is that they're using [Cisco Secure Email](https://www.cisco.com/site/in/en/products/security/secure-email/index.html), with on-prem **Cisco Secure Email Gateway** or cloud-based Cisco's Secure Email Cloud Gateway. And again, for some odd reason, sec-consult.com is using Cisco Secure Email Gateway as well!

As a proof of concept (figure 28), we can now send an e-mail from admin(at)icloud.com to our target at sec-consult.com, since, like with many other outbound SMTP servers (further discussed in SMTP Smuggling Impact), **<CR>.<CR> doesn't get filtered:**

[![Sending spoofed e-mails as admin@icloud.com ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-7-5_18-13-25__29_.png)](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-7-5_18-13-25__29_.png)

Figure 29: Sending spoofed e-mails as admin@icloud.com

Like before, the e-mail goes through unscathed, as shown in figure 29.

[![Getting domains using Ionos e-mail services via SecurityTrails ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/ionos_domains__30_.PNG)](https://securitytrails.com/domain/mx01.ionos.de/dns?__cf_chl_tk=.TKYmeShS.FZRsY6AAhEHSwz4V.4vi5xyMUN0i6TvkY-1702368252-0-gaNycGzNFWU)

Figure 30: Getting domains using Ionos e-mail services via SecurityTrails

SPF checks pass with domain alignment and without any issues.

Received-SPF: Pass ([mx4.atos.net](http://mx4.atos.net/): domain of admin(at)icloud.com
   designates 17.57.155.23 as permitted sender)
   identity=mailfrom; client-ip=17.57.155.23;
   receiver=[mx4.atos.net](http://mx4.atos.net/); envelope-from="admin@[icloud.com](http://icloud.com/)";
   x-sender="admin@[icloud.com](http://icloud.com/)"; x-conformance=spf\_only;
   x-record-type="v=spf1"; x-record-text="v=spf1
   ip4:17.58.0.0/16 ip4:17.57.155.0/24 ip4:17.57.156.0/24
   ip4:144.178.36.0/24 ip4:144.178.38.0/24 ip4:112.19.199.64/29
   ip4:112.19.242.64/29 ip4:222.73.195.64/29 ip4:157.255.1.64/29
   ip4:106.39.212.64/29 ip4:123.126.78.64/29
   ip4:183.240.219.64/29 ip4:39.156.163.64/29 ~all"

Hence, DMARC passes as well:

Authentication-Results-Original: [mx4.atos.net](http://mx4.atos.net/); dkim=none (message not signed)
  header.i=none; spf=Pass smtp.mailfrom=admin@[icloud.com](http://icloud.com/); spf=None
  smtp.helo=postmaster@[qs51p00im-qukt01080502.me.com](http://qs51p00im-qukt01080502.me.com/); dmarc=pass (p=quarantine
  dis=none) d=[icloud.com](http://icloud.com/)

With Cisco's Secure Email covered, we can now go on and take a look at the global impact!

## SMTP Smuggling Impact

At this point we've covered lots of **outbound and inbound SMTP smuggling**. But, speaking globally, how bad is it?

### GMX and Ionos

SMTP smuggling via GMX and Ionos e-mail services allowed SMTP smuggling from roughly **1.35 million different domains**, as indicated by the domains pointing their MX record to Ionos (figure 30).

[![Used SMTP software on the Internet (Shodan)(results may vary) ](/fileadmin/_processed_/e/d/csm_shodan_email_software__31__30e6c2e871.png)](https://www.shodan.io/search/facet?query=port%3A25&facet=product)

Figure 31: Used SMTP software on the Internet (Shodan)(results may vary)

Checking the SPF record of these domains confirms that they are most likely all permitting **\_spf-eu.ionos.com** for sending e-mails.

However, as already mentioned, SMTP smuggling doesn't work for every receiving inbound SMTP server and, in this case, requires inbound SMTP servers to accept **<LF>.<CR><LF>** as end-of-data sequence. So, who's affected?

Only few of the bigger e-mail providers that were tested are affected. These include:

* Fastmail
* Runbox

This might not seem bad at first, but looking at affected SMTP software on the Internet is a different story. After testing some popular e-mail software in their default configuration, it turned out that **Postfix** and **Sendmail** fulfil the requirements, are **affected** and can be smuggled to. Speaking globally, this is a lot (figure 31)!

Aside from Postfix and Sendmail, other SMTP implementations are most likely affected as well, including Cisco Secure Email (Cloud) Gateway, to which we'll get in a second.

### Microsoft Exchange Online

Same as GMX and Ionos, Exchange Online allowed smuggling via a **<LF>.<CR><LF>** end-of-data sequence as well, which makes it possible to smuggle from every domain pointing their SPF record to Exchange Online. This amounts to [millions of domains](https://enlyft.com/tech/products/exchange-online) all across the globe, including some very high-value targets owned by Microsoft like **microsoft.com, msn.com, github.com, outlook.com, office365.com, openai.com** and many more, and also domains of their customers (e.g., **tesla.com, mastercard.com, nike.com**, etc.).

However, as previously mentioned, smuggling from Exchange Online is even more restricted than from GMX/Ionos, since the receiving inbound SMTP server must support BDAT. This is the case for Fastmail and - still - hundreds of thousands of [postfix](https://www.shodan.io/search?query=postfix+port%3A25+-CHUNKING) and [sendmail](https://www.shodan.io/search?query=sendmail+port%3A25+-CHUNKING) servers.

| Software | Without BDAT/CHUNKING | Total | Percentage | Shodan query |
| --- | --- | --- | --- | --- |
| Postfix | 716884 | 1475616 | ~50% | postfix port:25 -CHUNKING |
| Sendmail | 168823 | 169030 | ~99% | sendmail port:25 -CHUNKING |

[![Relevant configuration settings of Cisco Secure Email ](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/image-2023-12-4_20-56-43__32_.png)](https://www.cisco.com/c/en/us/td/docs/security/esa/esa15-0/user_guide/b_ESA_Admin_Guide_15-0/b_ESA_Admin_Guide_12_1_chapter_0100.html?bookSearch=true#task_1254814__table_985308C400C84CE3BC190BC8A3A95D86)

Figure 32: Relevant configuration settings of Cisco Secure Email

These numbers from Shodan might not paint the whole picture though, as many servers maybe running postfix, but are hiding their identification banner. Also, other smaller SMTP servers are affected as well, again including Cisco Secure Email (Cloud) Gateway.

We did not analyze all SMTP software out there, hence it might be possible that other vulnerable servers exist as well.

### Cisco Secure Email (Cloud) Gateway

The Cisco Secure Email Gateway and its cloud counterpart, the Cisco Secure Email Cloud Gateway, are both "vulnerable" to **inbound** SMTP smuggling. The quotes are necessary in this case, since, according to lengthy discussions with Cisco, this is not a bug, but a feature (see Responsible Disclosure section)!

**By default**, Cisco Secure Email (Cloud) Gateway accepts **<CR>.<CR>** as end-of-data sequence, which does not get filtered by the following SMTP servers when sending outbound:

* Outlook/Exchange Online
* Icloud
* On-premise exchange server
* Postfix
* Sendmail
* Startmail
* Fastmail
* Zohomail

This would allow inbound SMTP smuggling to around 40k domains using Cisco's Secure Email **Cloud** Gateway, if they're using the **default configuration** (like we did). These domains can be determined by checking a passive DNS database like SecurityTrails for [iphmx.com subdomains](https://securitytrails.com/list/apex_domain/iphmx.com). Identifying on-premise Cisco Secure Email Gateways on the other hand is a difficult task, since lots of Internet-wide scanners (e.g., Shodan) seem to get blocked when conducting service scans. However, to get a better feeling for the usage of this product, we scanned the former Alexa Top 1000, and discovered at least the following 32 domains.

* [amazon.com](http://amazon.com/)
* [amazon.co.jp](http://amazon.co.jp/)
* [amazon.co.uk](http://amazon.co.uk/)
* [amazon.it](http://amazon.it/)
* [amazon.fr](http://amazon.fr/)
* [marriott.com](http://marriott.com/)
* [cisco.com](http://cisco.com/)
* [amazon.in](http://amazon.in/)
* [paypal.com](http://paypal.com/)
* [amazon.ca](http://amazon.ca/)
* [goodreads.com](http://goodreads.com/)
* [webex.com](http://webex.com/)
* [custhelp.com](http://custhelp.com/)
* [imdb.com](http://imdb.com/)
* [intuit.com](http://intuit.com/)
* [ndtv.com](http://ndtv.com/)
* [amazon.cn](http://amazon.cn/)
* [makemytrip.com](http://makemytrip.com/)
* [amazon.com.au](http://amazon.com.au/)
* [amazonaws.com](http://amazonaws.com/)
* [primevideo.com](http://primevideo.com/)
* [amazon.es](http://amazon.es/)
* [irs.gov](http://irs.gov/)
* [amazon.com.br](http://amazon.com.br/)
* [aastocks.com](http://aastocks.com/)
* [ebay.com](http://ebay.com/)
* [amazon.de](http://amazon.de/)
* [ebay.de](http://ebay.de/)
* [ebay.co.uk](http://ebay.co.uk/)
* [ebay.com.au](http://ebay.com.au/)
* [mayoclinic.org](http://mayoclinic.org/)
* [audible.com](http://audible.com/)

Note that this doesn't take into account servers that don't have an MX record let alone an SMTP server.

## Further vulnerabilities

During the research we've also discovered some exotic inbound SMTP servers that interpret end-of-data sequences like **<CR><LF>\x00.<CR><LF>**, with "\x00" representing a null byte. With proprietary SMTP components and lots of different e-mail services intertwined it's hard to tell what is possible until an e-mail reaches its final destination.

Even though SMTP smuggling might still be hiding in some places, we hopefully eliminated some big targets.

## Responsible Disclosure

How do we report a vulnerability that is based on protocol interpretation? Who is right, who is wrong? Let's take a look at some RFCs!

In general, [RFC 5321](https://www.rfc-editor.org/rfc/rfc5321) from 2008 states the following:

***"The custom of accepting lines ending only in <LF>, as a concession to non-conforming behavior on the part of some UNIX systems, has proven to cause more interoperability problems than it solves, and SMTP server systems MUST NOT do this, even in the name of improved robustness.  In particular, the sequence "<LF>.<LF>" (bare line feeds, without carriage returns) MUST NOT be treated as equivalent to <CRLF>.<CRLF> as the end of mail data indication."***

So, it's the inbound SMTP server's fault! But wait, [RFC 5322](https://www.rfc-editor.org/rfc/rfc5322), also from 2008, says the following about the body of a message:

***"CR and LF MUST only occur together as CRLF; they MUST NOT appear independently in the body."***

This essentially means that **both sides (outbound and inbound)** are at fault! Also, this shows us that inconsistent interpretation of the end-of-data sequence is not a novel issue. Now, what do the affected parties think about this? We have thus initiated our responsible disclosure process around **end of July 2023** (see Timeline further below).

### GMX

The responsible disclosure process with GMX was pure bliss. After immediately receiving a response, the issue was fixed in roughly ten days. Aside from paying a bounty, they even added Timo to their [bug bounty hall of fame](https://bugbounty.gmx.net/halloffame-index.html). All-in-all a great experience! Huge props to GMX for such a professional and quick reaction.

### Microsoft

The outbound SMTP smuggling vulnerability was submitted via the [Microsoft Security Response Center (MSRC)](https://www.microsoft.com/en-us/msrc). Roughly a month later, Microsoft replied:

***"Thank you again for submitting this issue to Microsoft. Currently, MSRC prioritizes vulnerabilities that are assessed as “Important” or “Critical'’ severities for immediate servicing. After careful investigation, this case has been assessed as moderate severity and does not meet MSRC’s bar for immediate servicing since the attack only works if the mail server of the recipient treats a non-standard EOD sequence as EOD . However, we have shared the report with the team responsible for maintaining the product or service. They will take appropriate action as needed to help keep customers protected"***

Fair enough, they got bigger fish to fry! After retesting the issue every now and then, they seem to have fixed it roughly in the middle of October 2023.

### Cisco

As previously mentioned, the "vulnerability" in Cisco Secure Email (Cloud) Gateway is not a bug, but a feature. And, unlike in most cases, this is actually somewhat true.

Cisco Secure Email (Cloud) Gateway can be configured to handle carriage returns and line feeds in a special manner, as seen [here](https://www.cisco.com/c/en/us/td/docs/security/esa/esa15-0/user_guide/b_ESA_Admin_Guide_15-0/b_ESA_Admin_Guide_12_1_chapter_0100.html?bookSearch=true#task_1254814__table_985308C400C84CE3BC190BC8A3A95D86).

However, **by default**, Cisco Secure Email (Cloud) Gateway "Allows the message, but converts bare CR and LF characters to CRLF characters" (the vulnerable "Clean" setting), which basically **enables inbound SMTP smuggling** via **<CR>.<CR>** end-of-data sequences. We have communicated this issue to Cisco and CERT/CC and went back and forth quite a bit. But at the end of the day, it's not a bug, it's a feature.

Since this feature allowed us to send spoofed e-mails from arbitrary Exchange Online domains straight into our inboxes, we decided to **change** the configuration to "**Allow**".

This passes e-mails with bare carriage returns or line feeds on to our actual e-mail server (Cisco Secure Email Gateway is just a gateway), which only interprets <CR><LF>.<CR><LF> as end-of-data sequence. If you don't want to receive spoofed e-mails with valid DMARC checks as well, we highly recommend changing your configuration!

## Conclusion

We've shown a novel SMTP spoofing technique with this research that allowed to spoof e-mails from millions of domains.

Even though Microsoft and GMX have patched this issue promptly, inbound SMTP smuggling to Cisco Secure Email instances (cloud and on-premise) is still possible with **default** configurations. We highly encourage to change these default configurations, as described in the Responsible Disclosure chapter.

Also, this blog post hopefully sparked further interest in SMTP research, since there is still so much to explore. Even with SMTP smuggling alone, there are many things to look at:

* Other smuggling techniques
* Bounce smuggling
* Smuggling via BDAT
* Smuggling dangerous/exotic SMTP commands
* Internet-wide scans
* Other SMTP software
* etc.

So, this is probably not the last time you've heard of SMTP smuggling!

## Timeline

| 2023-06-07: | First outbound SMTP smuggling proof of concept (GMX) |
| --- | --- |
| 2023-06-08: | Discovery of outbound SMTP smuggling in Exchange Online |
| 2023-06-20: | Discovery of Cisco Secure Email (Cloud) Gateway inbound SMTP smuggling |
| 2023-06/2023-07: | Developing tools, analyzing test cases, further research |
| 2023-07-26: | Contacting MSRC |
| 2023-07-27: | Contacting Cisco |
| 2023-07-29: | Contacting GMX. |
| 2023-08-10: | GMX fixed the issue |
| 2023-08-17: | Contacting CERT Coordination Center (CERT/CC) for further discussion with Cisco |
| 2023-08-23: | Microsoft responds and rates the vulnerability with moderate risk |
| 2023-09-13: | CERT/CC accepts the case |
| 2023-10-16: | SMTP smuggling in Exchange Online is fixed |
| 2023-11-29: | CERT/CC allows public release of SMTP smuggling, since no software vulnerabilities were identified ("it's not a bug, it's a feature") |
| 2023-12-05: | Informing CERT.at and CERT-Bund about planned release, providing blog post draft, warning about Cisco configuration |
| 2023-12-18: | Release date of blog post |

*This research was done by Timo Longin and published on behalf of the [SEC Consult Vulnerability Lab](/vulnerability-lab/#c1699).*

## FAQ

How do I know if I am affected?

If you are a user of a big e-mail provider (Outlook, Gmail, etc.), you are most likely going to be fine (for now at least). Since SMTP smuggling is a fairly new topic and still has things to explore, we cannot be certain though. However, if you're using Cisco Secure Email (cloud or on-premise), you should definitely check your configuration (see Responsible Disclosure)! But, as always, don't blindly trust anything that lands in your e-mail inbox!

Update from 10/01/2024: Official tools to test for SMTP smuggling issues are now available on [GitHub](https://github.com/The-Login/SMTP-Smuggling-Tools)!

Is there a tool available to verify whether I am vulnerable?

Update from 10/01/2024: Official tools to test for SMTP smuggling issues are now available on [GitHub](https://github.com/The-Login/SMTP-Smuggling-Tools)!

We have developed an analysis tool internally but decided to publish it at a later date (maybe already at the [37C3 conference](https://events.ccc.de/congress/2023/hub/en/fahrplan) end of December 2023 where this research will be presented), as currently many Cisco Secure Mail installations are affected by the issue.

Do smuggled e-mails always get past spam filters?

The short answer is no, not always! Even though the smuggled e-mail might come from a legitimate sender and passes e-mail authentication due to SPF alignment, the e-mail might still get blocked, depending on the e-mail contents and other factors. Also, if more than SPF alignment is required for the e-mail to go through, we're out of luck with SMTP smuggling.

How would someone even get the idea of looking at a protocol like SMTP?

There are two major reasons:

1. SMTP is a very old protocol that is somewhat flying under the radar of a lot of security researchers (kind of like [DNS](https://sec-consult.com/blog/detail/taking-over-a-country-kaminsky-style/)). Since there wasn't any related research that indicated similar attacks, the chances were good for finding something new!
2. Phishing is one of the best ways for threat actors or our red teamers to gain initial access to an organization. Therefore, looking for vulnerabilities in the underlying e-mail protocol - SMTP - seemed natural.
Is this a novel attack technique?

Most likely! Again, for two major reasons:

1. Microsoft's SMTP infrastructure including Exchange Online was vulnerable. This would have most likely been found and fixed by prior researchers.
2. We haven't found any research stating otherwise.
Are there other interesting SMTP and e-mailing attacks?

Yes, lots of them! For example, ["Weak Links in Authentication Chains: A Large-scale - Analysis of Email Sender Spoofing Attacks"](https://www.usenix.org/conference/usenixsecurity21/presentation/shen-kaiwen) shows a range of interesting attacks that even worked with Gmail!

Can confusions of <CR><LF> and <LF> and alike cause security issues in other protocols as well?

Yes, of course! In general, implementations of (sometimes) vague specifications can cause all kinds of security issues.

Have you scanned the whole Internet and tested ALL e-mailing services?

As already mentioned, scanning e-mail services for used software and versions may yield inaccurate results and will most likely get you on some kind of blacklist. The same goes for more specific end-of-data sequence checks, where basically a whole e-mail is sent. Therefore, we could roughly only analyze the top 10k of Alexa domains during this research.

### Are you interested in working at SEC Consult?

SEC Consult is always searching for talented security professionals to work in our team.
[More Information](/career/#c2854)
#### About the author

![Portrait of Timo Longin SEC Consult](/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/Authors/a-TLO.png)Timo Longin
[Back](/blog/)

* [Legal Notice](/legalnotice/)
* [Privacy Statement](/privacy-statement/)
* [Jobs](/career/)

SEC Consult is one of the leading consultancies in the field of cyber and [application security](/security-testing/web-application-security/ "Web Application Security"). The company specializes in [information security management](/processes-organisation/information-security-management-ism/ "Information Security Management (ISM)"), NIS security audits, [penetration testing](/security-testing/penetration-testing/ "Pentesting (Pentest)"), ISO 27001 certification support, [Cyber Defence](/incident-response/sec-defence/ "Cyber Defence") and [secure software certification](/processes-organisation/secure-software-development/ "Secure Software Development Consulting"). SEC Consult is part of [Eviden](https://eviden.com/ "Link to Eviden website").

[![bsi ISO/IEC 27001 Information Security Management CERTIFIED](/typo3temp/assets/_processed_/c/2/csm_bsi_9a24e74563.png)](/about-us/ "About us")[![ISO 27001 CREST certified](/typo3temp/assets/_processed_/0/6/csm_crest_0eb9c5864d.png)](/about-us/ "About us")[![Great Place To Work AT certified](/typo3temp/assets/_processed_/0/3/csm_great-place-to-work-at_773b265aa6.png)](/about-us/ "About us")[![Great Place To Work DE certified](/typo3temp/assets/_processed_/d/6/csm_great-place-to-work-de_2fcb537270.png)](/about-us/ "About us")

## We use Cookies

We use cookies to offer you a perfect visit experience. These include cookies that are necessary for the operation of the site and for the control of our commercial corporate goals, as well as those that are only used for anonymous statistical purposes, for convenience settings or to display personalized content. Decide for yourself which categories you want to allow. Please note that based on your settings, not all functions of the site may be available.

**[Legal Notice](/legalnotice/)** •  **[Privacy Statement](/privacy-statement/)**

### Technically required

(
0
Service
)

no

Technically required (
0
Service
)

yes

### Analysis / statistics

(
1
Service
)

Anonymous evaluation for troubleshooting and further development

no

Analysis / statistics (
1
Service
)

yes

#### Matomo

no

Matomo

yes

Matomo.org
Show details

Hide details

**Purpose**: Error analysis, statistical evaluation of our website accesses, campaign analysis, conversion tracking.
 **Processing operations**: collection of access data, data from your browser and data about the content accessed; execution of analysis software and storage of data on your terminal device, anonymization of the data collected; evaluation of the anonymous data in the form of statistics.
 **Storage period**: 1 year.
 **Joint controller**: LimeSoda Interactive Marketing GmbH.
 **Legal basis for data processing**: Art. 6 para. 1 lit. f of the DSGVO.
 **Consequences of non-consent**: This basic tracking is absolutely necessary for the operation of our website.
 **Data transfer**: The data collected with Matomo is stored on our own servers. It is not passed on to third parties.

Accept selected

Reject all

Accept all



=== Content from git.exim.org_d7cdf303_20250114_193108.html ===

This website requires JavaScript.
[![Logo](/assets/img/logo.svg)](/)

[Explore](/explore/repos)
[Help](https://forgejo.org/docs/latest/)

[Sign in](/user/login?redirect_to=%2fexim%2fexim)

[exim](/exim)/[exim](/exim/exim)

Watch

[4](/exim/exim/watchers)

Star

[0](/exim/exim/stars)

Fork
You've already forked exim

[0](/exim/exim/forks)

[Code](/exim/exim)
[Issues](https://bugs.exim.org/)
[Pull requests](/exim/exim/pulls)
[Projects](/exim/exim/projects)
[Releases](/exim/exim/releases)
[Packages](/exim/exim/packages)
[Wiki](/exim/exim/wiki)
[Activity](/exim/exim/activity)
[Actions](/exim/exim/actions)

Master Exim source repository

[**6507** commits](/exim/exim/commits/branch/master)
[**60** branches](/exim/exim/branches)
[**176** tags](/exim/exim/tags)
 **86** MiB

C

92.3%

Perl

4.4%

Shell

1.9%

Elixir

0.4%

Makefile

0.3%

Other

0.5%

**master**

[Find a file](/exim/exim/find/branch/master)

HTTPS

Open with VS Code
Open with VSCodium
Open with Intellij IDEA

Cite this repository

BibTeX

Cancel

|  | | 2025-01-14 18:08:43 +00:00 |
| --- | --- | --- |
| [.github](/exim/exim/src/branch/master/.github ".github") | [fix the list URL](/exim/exim/commit/138860785cc96f077f052043d46f697abbf87947) | 2023-05-09 16:49:30 +02:00 |
| [configs](/exim/exim/src/branch/master/configs "configs") | [fix: typo](/exim/exim/commit/67072519f5db4f3b3df763fda9de20f280d31394) | 2023-10-20 21:34:12 +02:00 |
| [doc](/exim/exim/src/branch/master/doc "doc") | [Testsuite: de-hardcode port used for identd testing](/exim/exim/commit/d1a8024238be1e7fc6a7ed9c21747817b019e326) | 2025-01-12 13:00:01 +00:00 |
| [release-process](/exim/exim/src/branch/master/release-process "release-process") | [Release process: script for cleaning changebars from .xfpt files](/exim/exim/commit/d4d0b596c0dfd5501b8d552606eb158b3a972b8c) | 2024-06-07 15:38:07 +01:00 |
| [src](/exim/exim/src/branch/master/src "src") | [Build: Solaris, yet another go](/exim/exim/commit/f859ae4524c038a6c8e15ef89393606447cc37fe) | 2025-01-14 18:08:43 +00:00 |
| [test](/exim/exim/src/branch/master/test "test") | [Testsuite: shift base for munged ephemeral port numbers](/exim/exim/commit/1d800d5183b9b009b6a1ecb4290b2b48f47cf420) | 2025-01-12 23:50:24 +00:00 |
| [.editorconfig](/exim/exim/src/branch/master/.editorconfig ".editorconfig") | [Testsuite: Use .editorconfig for test/runtest](/exim/exim/commit/1ef2730eb3d31c57a088b0491dfb5096f65b289a) | 2016-10-20 00:48:29 +02:00 |
| [.exim-project-root](/exim/exim/src/branch/master/.exim-project-root ".exim-project-root") | [mk\_exim\_release: rework for dotted release scheme](/exim/exim/commit/525c441c8defd07ec9c1c235eb8ac4da304d70be) | 2018-12-13 23:11:36 +01:00 |
| [.gitattributes](/exim/exim/src/branch/master/.gitattributes ".gitattributes") | [meta: git controls for text changelogs; github controls](/exim/exim/commit/b988b06146c5d16e0ca0ea86ffcf2d83938088ed) | 2018-02-25 02:51:22 -05:00 |
| [.gitignore](/exim/exim/src/branch/master/.gitignore ".gitignore") | [Add systemd units (examples)](/exim/exim/commit/bb6a0f57e5c1a04c9c191af6a37184970003b1c2) | 2023-10-19 09:56:29 +02:00 |
| [.mailmap](/exim/exim/src/branch/master/.mailmap ".mailmap") | [mailmap: real name for bes-internal](/exim/exim/commit/faad4a0eab268f7a52b6d6e6102a41e31399de38) | 2023-10-04 00:18:16 +02:00 |
| [Readme.pod](/exim/exim/src/branch/master/Readme.pod "Readme.pod") | [fix the list URL](/exim/exim/commit/138860785cc96f077f052043d46f697abbf87947) | 2023-05-09 16:49:30 +02:00 |
| [SECURITY.md](/exim/exim/src/branch/master/SECURITY.md "SECURITY.md") | [Microfix in SECURITY.md: exim-VERSION+fixes](/exim/exim/commit/275dd1deb9b22da56d0d20cec505387a5b9d2070) | 2019-07-06 23:34:06 +02:00 |

#### **[Readme.pod](#readme)**

```
=head1 Exim Development Repository

This is the Exim (Mail Transport Agent) Development Repository. Please
read the following information if you wish to use or contribute to the
Exim development process - this is to prevent your or our time being
unnecessarily wasted.

If you just want to use, build or get information on Exim then have a
look at the pointers further down this file at L<General Exim Information>.

=head2 General Development Information

The general Exim development process and resources are documented in
the wiki page at L<http://wiki.exim.org/EximDevelopment> - although
the wiki is likely to be moved and rehashed in the near future.

The sections below this duplicate much of the information form the
wiki document.

=head2 Development Repositories

Exim development is kept within a  git (L<https://git-scm.com/>)
repository. The master repository is at L<git://git.exim.org/exim.git>
with a web interface giving change and source visibility at
L<https://git.exim.org/exim.git>

There is a secondary repository on github at
L<https://github.com/Exim/exim> managed by the Exim Organisation
- however this may currently fall out of synchronisation with the
main one.

=head2 Bug Tracking

Currently this is all done using Bugzilla at L<https://bugs.exim.org/>
- please do not use github issue tracking.

=head2 Mailing List

Development issues are normally discussed on the exim-dev mailing list
- see L<https://www.exim.org/maillist.html>

=head2 Exim Release Process

Some documentation on the release process can be found at
L<http://wiki.exim.org/EximRelease>.

=head2 General Exim Information

The best place to get general information is on the website at
L<https://www.exim.org/>.

You can find Download locations L<https://www.exim.org/mirrors.html>,
Mailing list info L<https://www.exim.org/maillist.html> and Full
Documentation L<https://www.exim.org/docs.html> on that website.

If you are using a Linux or other freely available Unix like operating
system it is very likely that your system will have Exim packaged for
it already. In this case it is probably prudent to use these packages
unless you have specialised requirements.

In any case you can always ask on the
Exim Users mailing list L<https://lists.exim.org/mailman3/postorius/lists/exim-users.lists.exim.org/>
for further information.

[End]

```

[Powered by Forgejo](https://forgejo.org)
Version:
9.0.3+gitea-1.22.0
Page: **34ms**
Template: **6ms**

 English
Bahasa Indonesia
Deutsch
English
Español
Esperanto
Filipino
Français
Italiano
Latviešu
Magyar nyelv
Nederlands
Polski
Português de Portugal
Português do Brasil
Slovenščina
Suomi
Svenska
Türkçe
Čeština
Ελληνικά
Български
Русский
Українська
فارسی
日本語
简体中文
繁體中文（台灣）
繁體中文（香港）
한국어

[Licenses](/assets/licenses.txt)
[API](/api/swagger)



=== Content from lists.fedoraproject.org_3312c2db_20250114_193118.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB.mbox.gz?message=ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB/#ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB)

# [SECURITY] Fedora 38 Update: exim-4.97.1-1.fc38

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

12 Jan
2024

12 Jan
'24

1 a.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2024-e0841c83bb
2024-01-12 00:59:08.473015
--------------------------------------------------------------------------------

Name : exim
Product : Fedora 38
Version : 4.97.1
Release : 1.fc38
URL : <https://www.exim.org/>
Summary : The exim mail transfer agent
Description :
Exim is a message transfer agent (MTA) developed at the University of
Cambridge for use on Unix systems connected to the Internet. It is
freely available under the terms of the GNU General Public Licence. In
style it is similar to Smail 3, but its facilities are more
general. There is a great deal of flexibility in the way mail can be
routed, and there are extensive facilities for checking incoming
mail. Exim can be installed in place of sendmail, although the
configuration of exim is quite different to that of sendmail.

--------------------------------------------------------------------------------
Update Information:

Security fix for CVE-2023-51766.
--------------------------------------------------------------------------------
ChangeLog:

\* Wed Jan 3 2024 Jaroslav ��karvada jskarvad@redhat.com - 4.97.1-1
- New version
Resolves: rhbz#2256145
- Fixed SMTP smuggling vulnerability
Resolves: CVE-2023-51766
\* Mon Nov 6 2023 Jaroslav ��karvada jskarvad@redhat.com - 4.97-1
- New version
Resolves: rhbz#2247920
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2255852 - CVE-2023-51766 exim: SMTP smuggling vulnerability
<https://bugzilla.redhat.com/show_bug.cgi?id=2255852>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2024-e0841c83bb' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB/#ORN7OKEQPPBKUHYRQ6LR5PSNBQVDHAWB)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from security-tracker.debian.org_8631903d_20250115_114621.html ===

# CVE-2023-51766

| **Name** | CVE-2023-51766 |
| --- | --- |
| **Description** | Exim before 4.97.1 allows SMTP smuggling in certain PIPELINING/CHUNKING configurations. Remote attackers can use a published exploitation technique to inject e-mail messages with a spoofed MAIL FROM address, allowing bypass of an SPF protection mechanism. This occurs because Exim supports <LF>.<CR><LF> but some other popular e-mail servers do not. |
| **Source** | [CVE](https://www.cve.org/CVERecord?id=CVE-2023-51766) (at [NVD](https://nvd.nist.gov/vuln/detail/CVE-2023-51766); [CERT](https://www.kb.cert.org/vuls/byid?searchview=&query=CVE-2023-51766), [LWN](https://lwn.net/Search/DoSearch?words=CVE-2023-51766), [oss-sec](https://marc.info/?l=oss-security&s=CVE-2023-51766), [fulldisc](https://marc.info/?l=full-disclosure&s=CVE-2023-51766), [Red Hat](https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2023-51766), [Ubuntu](https://people.canonical.com/~ubuntu-security/cve/CVE-2023-51766), [Gentoo](https://bugs.gentoo.org/show_bug.cgi?id=CVE-2023-51766), SUSE [bugzilla](https://bugzilla.suse.com/show_bug.cgi?id=CVE-2023-51766)/[CVE](https://www.suse.com/security/cve/CVE-2023-51766/), GitHub [advisories](https://github.com/advisories?query=CVE-2023-51766)/[code](https://github.com/search?type=Code&q=%22CVE-2023-51766%22)/[issues](https://github.com/search?type=Issues&q=%22CVE-2023-51766%22), [web search](https://duckduckgo.com/html?q=%22CVE-2023-51766%22), [more](https://oss-security.openwall.org/wiki/vendors)) |
| **References** | [DLA-3708-1](/tracker/DLA-3708-1), [DSA-5597-1](/tracker/DSA-5597-1) |
| **Debian Bugs** | [1059387](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1059387) |

## Vulnerable and fixed packages

The table below lists information on source packages.

| Source Package | Release | Version | Status |
| --- | --- | --- | --- |
| [exim4](/tracker/source-package/exim4) ([PTS](https://tracker.debian.org/pkg/exim4)) | bullseye | 4.94.2-7+deb11u3 | fixed |
|  | bullseye (security) | 4.94.2-7+deb11u4 | fixed |
|  | bookworm | 4.96-15+deb12u6 | fixed |
|  | bookworm (security) | 4.96-15+deb12u5 | fixed |
|  | sid, trixie | 4.98-3 | fixed |

The information below is based on the following data on fixed versions.

| Package | Type | Release | Fixed Version | Urgency | Origin | Debian Bugs |
| --- | --- | --- | --- | --- | --- | --- |
| [exim4](/tracker/source-package/exim4) | source | buster | 4.92-8+deb10u9 |  | [DLA-3708-1](/tracker/DLA-3708-1) |  |
| [exim4](/tracker/source-package/exim4) | source | bullseye | 4.94.2-7+deb11u2 |  | [DSA-5597-1](/tracker/DSA-5597-1) |  |
| [exim4](/tracker/source-package/exim4) | source | bookworm | 4.96-15+deb12u4 |  | [DSA-5597-1](/tracker/DSA-5597-1) |  |
| [exim4](/tracker/source-package/exim4) | source | (unstable) | 4.97-3 |  |  | [1059387](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1059387) |

## Notes

```
<https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/>
<https://www.openwall.com/lists/oss-security/2023/12/21/6>
<https://bugs.exim.org/show_bug.cgi?id=3063>
<https://exim.org/static/doc/security/CVE-2023-51766.txt>
<https://git.exim.org/exim.git/commit/cf1376206284f2a4f11e32d931d4aade34c206c5> (exim-4.98-RC0)
<https://git.exim.org/exim.git/commit/4596719398f6f2365bed563aafd757a6433ce7b4> (exim-4.98-RC0)
<https://git.exim.org/exim.git/commit/5bb786d5ad568a88d50d15452aacc8404047e5ca> (exim-4.98-RC0)

```

---

Search for package or bug name:  [Reporting problems](/tracker/data/report)

[Home](/tracker/) - [Debian Security](https://www.debian.org/security/) - [Source](https://salsa.debian.org/security-tracker-team/security-tracker/blob/master/bin/tracker_service.py) [(Git)](https://salsa.debian.org/security-tracker-team/security-tracker)



=== Content from www.openwall.com_991cb442_20250114_193103.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](../../../2024/01/03/1) [[<thread-prev]](2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <CAH8yC8kAsB9Kp-14iNPaft5H6XGDpM0hN7rE5y=5qZrmSoeDSQ@mail.gmail.com>
Date: Mon, 1 Jan 2024 18:00:11 -0500
From: Jeffrey Walton <noloader@...il.com>
To: oss-security@...ts.openwall.com
Subject: Re: CVE-2023-51766: Exim: SMTP smuggling

On Mon, Jan 1, 2024 at 2:06 PM Demi Marie Obenour
<demi@...isiblethingslab.com> wrote:
>
> On Mon, Jan 01, 2024 at 04:10:46PM +0000, halfdog wrote:
> > Solar Designer writes:
> > > Hi,
> > >
> > > Exim was also susceptible to SMTP smuggling, and version 4.97.1 is now
> > > released to address this.  Included below is doc/doc-txt/cve-2023-51766
> > > from the exim-4.97.1 branch (with erroneous Date: line omitted).
> > > ---
> > > CVE ID:     CVE-2023-51766
> > > Credits:    <https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mai>
> > > ls-worldwide/
> > > Version(s): all up to 4.97 inclusive
> > > Issue:      Given a buggy relay, Exim can be induced to accept a second messa
> > > ge embedded
> > >             as part of the body of a first message
> > >
> > > Conditions
> > > ==========
> > >
> > > If *all* the following conditions are met
> > >
> > >     Runtime options
> > >     ---------------
> > >
> > >     * Exim offers PIPELINING on incoming connections
> > >
> > >     * Exim offers CHUNKING on incoming connections
> > >
> > >     Operation
> > >     ---------
> > >
> > >     * DATA (as opposed to BDAT) is used for a message reception
> > >
> > >     * The relay host sends to the Exim MTA message data including
> > >       one of "LF . LF" or "CR LF . LF" or "LF . CR LF".
> >
> > Interesting, that also LF . LF is causing the effect. As there
> > might be some aggressive mail server testing for that issue in
> > near future anyway, could it be, that this was exactly the issue
> > affecting Debian mailing lists at least 2018-2023? If not so,
> > and there is a second bug, the increased testing and also public
> > bug report from below will give them some interesting times ahead
> > anyway.
> >
> > But if so, any automated mailing list forwarding might be quite
> > likely (due to trigger probabilities) to have left truncated
> > and non-truncated messages online, so that finding those pairs
> > automatically, e.g.  using more unique text parts from list A
> > messages to search for messages on any other list B and check,
> > if one of them seems truncated.
> >
> > Here are some message examples from 2018 showing the trunction:
> >
> > <https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=849754#60>
> > <https://lists.debian.org/debian-mentors/2018/01/msg00331.html>
> >
> > Then there was also a public bug report on those
> >
> > <https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=922652>
> >
> > or the ones from below.
>
> I think the only reasonable thing for an SMTP server to do is to reject
> all LFs and CRs in DATA that are not part of a proper CRLF outright.

+1.

Postel's Law strikes again.

Jeff

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from lwn.net_0e153a6e_20250114_193127.html ===


[![LWN.net Logo](https://static.lwn.net/images/logo/barepenguin-70.png)
LWN
.net
News from the source](/)
[![LWN](https://static.lwn.net/images/lcorner-ss.png)](/)

* [**Content**](#t)
  + [Weekly Edition](/current/)
  + [Archives](/Archives/)
  + [Search](/Search/)
  + [Kernel](/Kernel/)
  + [Security](/Security/)
  + [Events calendar](/Calendar/)
  + [Unread comments](/Comments/unread)
  + ---
  + [LWN FAQ](/op/FAQ.lwn)
  + [Write for us](/op/AuthorGuide.lwn)
* [**Edition**](#t)
  + [Return to the Front page](/Articles/955922/)

**User:**
**Password:**    |

 |

[**Subscribe**](/subscribe/) /
[**Log in**](/Login/) /
[**New account**](/Login/newaccount)

# Smuggling email inside of email

> **Benefits for LWN subscribers**
>
> The primary benefit from [subscribing to LWN](/Promo/nst-nag5/subscribe)
> is helping to keep us publishing, but, beyond that, subscribers get
> immediate access to all site content and access to a number of extra
> site features. Please sign up today!

By **Jake Edge**
January 3, 2024

Normally, when a new vulnerability is discovered and releases are
coordinated with those affected, the announcement is done at
a convenient time—not generally right before the end-of-year holidays, for
example. The [SMTP
Smuggling vulnerability](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) has taken a different path, however, with its
announcement landing on December 18. That may well have been
unpleasant for some administrators that had not yet updated, but it was
particularly problematic for
some projects that had not been made aware of the vulnerability at
*all*—though it was known to affect several open-source mailers.

#### Discovery and disclosure

The vulnerability was discovered by Timo Longin of [SEC Consult](https://sec-consult.com/) back in June; the company
contacted three affected vendors, GMX, Microsoft, and Cisco in July. GMX
fixed the issue in August, and Microsoft did so in October, but Cisco
responded that the "identified vulnerability is just a feature of the
software and not a bug/vulnerability". That led SEC Consult to contact
the [CERT Coordination Center](https://www.kb.cert.org/vuls/)
(CERT/CC) for further assistance, using the [Vulnerability Information and
Coordination Environment](https://kb.cert.org/vince/) (VINCE) tool:

> There, we submitted all our research details and explained the case to the
> vendors involved. We received feedback from Cisco that our identified
> research is not a vulnerability, but a feature and that they will not
> change the default configuration nor inform their customers. Other vendors
> did not respond in VINCE but were contacted by CERT/CC.
>
> Based on this feedback and as multiple other vendors were included in this
> discussion through the CERT/CC VINCE platform without objecting, we wrongly
> assessed the broader impact of the SMTP smuggling research. Because of this
> assumption, we asked CERT/CC end of November regarding publication of the
> details and received confirmation to proceed.

A [talk
about the vulnerability](https://events.ccc.de/congress/2023/hub/en/event/smtp_smuggling_spoofing_e-mails_worldwide/) was accepted for the [37th Chaos
Communication Congress](https://events.ccc.de/congress/2023/hub/en/index) (37C3), which was held at the end of December.
So the vulnerability needed to be announced before that happened. The talk
acceptance occurred on December 3 and the announcement came out
roughly two weeks later—just before the holidays.
The "wrongly assessed" wording in the quote above seems to indicate
that SEC Consult recognizes that it made a mistake here. In addition, the
talk is [said](https://chaos.social/%40Foxboron/111621156200642472)
to have contained "a decent apology".

One of the other "vendors" mentioned in the (admirably
detailed) blog post is Sendmail, but Postfix is mentioned elsewhere as well.
It is clear that SEC Consult was fully aware that those two mailers were
vulnerable, but the company apparently relied on CERT/CC to involve
additional affected projects, which just as clearly did not happen. For
example, Postfix creator and maintainer Wietse Venema [called](https://www.mail-archive.com/postfix-users%40postfix.org/msg100901.html)
the vulnerability announcement "part of a non-responsible disclosure
process"; he softened that stance somewhat in a Postfix [SMTP Smuggling page](https://www.postfix.org/smtp-smuggling.html),
but still
noted that "[critical] information provided by the researcher was not
passed on to Postfix maintainers before publication of the attack".
The result was "a presumably unintended zero-day attack", he said.

#### Vulnerability

The [Simple
Mail Transfer Protocol](https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol) (SMTP), which is described in [RFC 5321](https://datatracker.ietf.org/doc/html/rfc5321),
provides a text-based protocol for submitting and exchanging email on the
net.
At some level, this flaw is another indication that the "[robustness
principle](https://en.wikipedia.org/wiki/Robustness_principle)" (also known as "Postel's law") was not actually all that
sound from a security standpoint; being liberal in what is accepted
over-the-wire has often led to problems. In this case, the handling of
line endings in conjunction with the SMTP end-of-data indication can lead
to situations where email can be successfully spoofed—leading to rogue
email that passes
various checks for authenticity.

The SMTP DATA command is used for the actual text that will appear in an
email, including headers and the like; the so-called "envelope", which
describes the sender and receiver, is another
set of SMTP commands (EHLO, MAIL FROM, RCPT TO) that precede the DATA. The
blog post announcing the vulnerability has lots of diagrams and explanations
for those who want all the gory details. The DATA command is ended with
a line that is blank except for a single period ("."); the line endings for
SMTP are defined to be carriage-return (CR or "\r") followed by
line-feed (LF or "\n"), so end-of-data should be signaled with
"\r\n.\r\n".

It turns out that some mailers will accept just a line-feed as the line
terminator, but others will not; there is a difference
in interpretation of "\n.\n" that can be used to smuggle an
email message inside another:
```

    EHLO ...
    MAIL FROM: ...
    RCPT TO: ...
    DATA
    From: ...
    To: ...
    Subject: ...

    innocuous email text
    \n.\n
    MAIL FROM: <admin@...>
    RCPT TO: <victim@...>
    DATA
    From: Administrator <admin@...>
    To: J. Random Victim <victim@...>
    Subject: Beware of phishing scams

    Like this one
    \r\n.\r\n

```
The second set of commands is in the text of the email, if the
SMTP server receiving it does not consider
"\n.\n" as the termination of the
DATA command. That email will be sent to another SMTP server, however,
which may see things rather differently. If the SMTP server for the
destination sees that line as terminating the data, it may start
processing what comes next as entirely new email. It is a
vulnerability that
is analogous to [HTTP request
smuggling](https://en.wikipedia.org/wiki/HTTP_request_smuggling), which is where the name comes from.

There are also variations on the line endings (e.g. "\n.\r\n")
that can
be used to fool various
mailers. The core of the idea is to have the outbound mail server
ignore the "extra stuff" as part of the initial email message
and send the mail on to a server that sees the
single message as more than one—and acts accordingly. [SPF](https://en.wikipedia.org/wiki/Sender_Policy_Framework)
checks can be made to pass and even [DKIM](https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail) can be spoofed by using an
attacker-controlled DKIM key in the smuggled headers. [DMARC](https://en.wikipedia.org/wiki/DMARC) can be used to thwart
the smuggling, but common configurations of it are still vulnerable.
In addition, because
mail servers, especially those of the larger
email providers, often handle multiple domains, there is an opportunity to
smuggle email that purports to
come from different
domains inside innocuous-seeming messages to users of those services.

The blog post mostly concentrates on the three vendors identified, but
clearly notes that "Postfix and Sendmail [fulfill] the requirements, are
affected and can be smuggled to". It provides several lists of domains
that can be spoofed via GMX, Microsoft Exchange Online, or Cisco Secure
Email Cloud Gateway. In fact, SEC Consult uses the Cisco product itself,
so the company has changed its settings away from the default to avoid the
problem, which Cisco does not acknowledge as any kind of bug.

#### Postfix and beyond

Meanwhile, over in open-source land, folks seemed rather astonished that
the vulnerability dropped with no warning. Marcus Meissner [posted](/ml/oss-security/20231221143630.GD14101%40suse.de/) about the vulnerability
to the oss-security mailing list: "As if we did not have sufficient
protocol vulnerability work short[ly] before
Christmas break this year, here is one more". He is likely referring
to the [Terrapin
vulnerability in the SSH protocol](/ml/oss-security/a8637927-82b1-4f95-a7e8-7aa6cbaca455%40rub.de/), which was [announced](https://terrapin-attack.com/) on December 18—well after
coordinating with many different SSH implementation projects. The SMTP
Smuggling vulnerability followed a rather different path, as Stuart
Henderson [pointed
out](/ml/oss-security/ZYVufT0sq16Z-M43%40symphytum.spacehopper.org/):
> I'm a little confused by sec-consult's process here. They identify a
> problem affecting various pieces of software including some very widely
> deployed open source software, go to the trouble of doing a coordinated
> disclosure, but only do that with...looking at their timeline... gmx,
> microsoft and cisco?

Meissner [noted](/ml/oss-security/20231222121134.GI14101%40suse.de/) that SUSE
was not alerted to the problem via VINCE and that the Postfix timeline (in
Venema's post) only started after the announcement. Erik Auerswald [speculated](/ml/oss-security/20231222150438.GA13989%40unix-ag.uni-kl.de/)
that SEC Consult expected CERT/CC to alert other affected projects; instead
it would seem that CERT/CC gave the go-ahead to release the findings.
After Rodrigo Freire [wondered](/ml/oss-security/CAHjsZGbiZYGug2L04iZ%2BVEmMg-pdfKyKOGdcSeCLnsZYd0Vm2Q%40mail.gmail.com/)
why the problem was considered a vulnerability, Auerswald [explained](/ml/oss-security/20231222175221.GA7191%40unix-ag.uni-kl.de/):
> Any user of an affected outbound server can spoof email from any user of
> the same outbound server despite SPF and DKIM (DMARC+DKIM can prevent this
> in some cases, also more senders can be spoofed in specific cases, for
> details see the blog post). But for this to work, the inbound server
> must act as a confused deputy. Both outbound and inbound servers need to
> be differently vulnerable to enable the attack. This specific attack can
> be prevented unilaterally on either the outbound or the inbound server.
>
> [...] For email server open source projects, relevant for the oss-security
> list, the primary vulnerability is to act as a confused deputy inbound
> server, because users of such email servers usually have a much smaller
> number of accounts than the big freemail providers. But, in general,
> they could also possibly act as a vulnerable outbound server, e.g.,
> after a [legitimate] user account has been compromised.

CVEs for Sendmail, Postfix, and Exim have [been assigned](/ml/oss-security/20231224093335.GM14101%40suse.de/).
Postfix has released updates with a new [smtpd\_forbid\_bare\_newline](https://www.postfix.org/postconf.5.html#smtpd_forbid_bare_newline)
option (that defaults to off, but will default to on in the upcoming
Postfix 3.9 release); those who do not want to upgrade can work around
most of the problems using existing options. Exim has [an
advisory](/ml/oss-security/20231229130718.GA6740%40openwall.com/), [bug
report](https://bugs.exim.org/show_bug.cgi?id=3063), and bug-fix release (4.97.1) for the problem. Sendmail has a [snapshot
release (8.18.0.2)](/ml/oss-security/20231221144656.GA40693%40veps.esmtp.org/) with a new option to address the flaw as well.
However, other than Postfix updates from [SUSE](/Articles/956688/) and [Slackware](/Articles/956148/),
most distributions have not yet issued updates for this problem,
which leaves a lot of Linux users vulnerable.

So the major open-source mailer projects scrambled to fix the
vulnerability over the holidays, but the process has obviously failed
here. We have not (yet?) heard from CERT/CC for its side of the story, but
either it or SEC Consult should definitely have contacted those projects in
the multiple months that have gone by since the discovery.
Given that SEC Consult knew about Sendmail and Postfix, though, it is a
little hard to understand how a simple heads-up message to the security
contacts for those projects was not sent.

It seems likely
that there are smaller mailers and other tools that are still affected by
the flaw—though they may only have just heard of it—a month or two of
advance notice,
especially for small projects, could have made a lot of difference. One
can only hope that lessons are being learned here and that any coordination
will be better ... coordinated (and communicated) down the road.

| Index entries for this article | |
| --- | --- |
| [Security](/Security/Index/) | [Vulnerabilities/SMTP smuggling](/Security/Index/#Vulnerabilities-SMTP_smuggling) |

---

 to post comments

### Smuggling email inside of email

Posted Jan 4, 2024 2:06 UTC (Thu)
by **iabervon** (subscriber, #722)
[[Link](/Articles/956778/)]

The image at the beginning of the blog post has a useful bit of information that didn't make it to the example in the article: the first/outer email is from attacker@sender, while the second/embedded email is purportedly from admin@sender, such that receiver is not surprised by sender delivering the second email. More generally, it can be attacker@cohost1 and admin@cohost2, where the two sites are different but expected to be cohosted.

The purported sender's mailer has to consider the ambiguous sequence to be valid inside of an email, while the receiver's mailer has to consider the ambiguous sequence to be a valid terminator of an email. There are sequences mentioned for which various open-source mailers are vulnerable as receivers and big hosting providers and also mailers used by big companies are vulnerable as senders.

It looks to me like the researchers considered the sender side to be doing things particularly wrong, and also that the vulnerability was that messages purportedly from users at the sender site could be forged by other users with the sender site's participation adding credibility, and didn't think of it (also) as receivers failing to block detectably inauthentic messages. They contacted everyone who would need to implement what they thought of as the correct fix, but not other people who could have mitigated the problem differently.

### Smuggling email inside of email

Posted Jan 4, 2024 2:59 UTC (Thu)
by **akp@akp.dk** (subscriber, #73019)
[[Link](/Articles/956782/)]

Debian released fixed versions of Postfix too via their updates repositories, but apparently it wasn’t considered a security issue - only a bug: <https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1059230>

### The confused Deputy

Posted Jan 4, 2024 9:55 UTC (Thu)
by **Wol** (subscriber, #4433)
[[Link](/Articles/956804/)] (1 responses)

Surely an early disclosure that certain projects are vulnerable as confused deputies if they misinterpret /r/n./r/n could/should have been made months ago?

"The RFC standard says you \*MUST\*, some projects don't, and this has been identified as a security vulnerability".

That's leaking bugger-all information to an attacker - how do they use it etc etc, and giving all recipients the opportunity to protect themselves, very quickly.

Cheers,

Wol

### The confused Deputy

Posted Jan 5, 2024 3:05 UTC (Fri)
by **kentonv** (**✭ supporter ✭**, #92073)
[[Link](/Articles/956952/)]

Ehh... I think for anyone who has spent time dealing with smuggling vulnerabilities before (e.g. in HTTP, where they abound), that would have been a big enough hint for them to figure out the problem.

### Smuggling email inside of email

Posted Jan 4, 2024 10:06 UTC (Thu)
by **roc** (subscriber, #30627)
[[Link](/Articles/956805/)] (37 responses)

Postel's Law was a blunder and we've spent decades fighting the damage caused by people following it.

Computing is hard, but well-intentioned yet clearly mistaken principles such as Postel's Law are self-inflicted wounds that have made things a lot harder than they could have been.

### Smuggling email inside of email

Posted Jan 4, 2024 10:35 UTC (Thu)
by **MarcB** (subscriber, #101804)
[[Link](/Articles/956809/)] (2 responses)

The irony is that the principle is not followed in its original scope of middle-boxes in low level network protocols - where it actually makes a lot of sense. This has led to the ossification of IP protocols.

Instead it was foolishly extended to endpoints and completely different scenarios. There it is invariably causing damage. It makes things less secure, less stable and so much more complex.

### Smuggling email inside of email

Posted Jan 4, 2024 18:13 UTC (Thu)
by **nim-nim** (subscriber, #34454)
[[Link](/Articles/956904/)] (1 responses)

> The irony is that the principle is not followed in its original scope of middle-boxes in low level network protocols - where it actually makes a lot of sense.

No it never made any sense. All those middle boxes were deployed because the fuzziness was breaking things right and left, they are designed to limit the spread of badly formatted traffic.

Of course some of this tightening went too far and led to ossification but it did not happen by mistake or because people wanted to prevent new protocol extensions, it happened because fuzziness was breaking endpoints.

And none of the war on middleboxes actually fixed things for the end user all it achieved is concentrating decision power MAGMA-side. Today Google and Amazon and Microsoft and Apple can decide whatever breakage they want there is nothing between their cloud and their browser with the browser acting as an hostile enclave of their cloud on the user terminal.

### Smuggling email inside of email

Posted Jan 4, 2024 21:56 UTC (Thu)
by **Wol** (subscriber, #4433)
[[Link](/Articles/956933/)]

> No it never made any sense. All those middle boxes were deployed because the fuzziness was breaking things right and left, they are designed to limit the spread of badly formatted traffic.

The problem is they are also designed to prevent the spread of correctly fornatted traffic, which is why port 80 is such a mess ...

Cheers,

Wol

### Smuggling email inside of email

Posted Jan 4, 2024 13:17 UTC (Thu)
by **smitty\_one\_each** (subscriber, #28989)
[[Link](/Articles/956822/)] (10 responses)

If one is too fussy, that can also become a bugaboo.

Maybe: s/liberal/skeptically moderate/ ?

### Smuggling email inside of email

Posted Jan 4, 2024 14:40 UTC (Thu)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956828/)] (5 responses)

It's not fussiness per-se that's a problem; it's going beyond the protocol specification in ways that make life harder that's a problem. For example, if the protocol says that the size field is encoded as hexadecimal digits in UTF-8, and that an implementation must accept at least 8 digits, insisting that the other side uses a multiple of 8 digits is "too fussy" - I should be able to send 1a2 as a size given that definition, and I should be able to send 1abcdef23, but if you require 000001a2 and 00000001abcdef23, we've got a problem.

And this problem becomes insoluble if a different implementation rejects leading zeroes; you now have two implementations being "fussy" in opposite directions, both of which can be justified against the protocol spec (which doesn't talk about leading zeroes at all). The "correct" fix is to tighten up the protocol specification so that one or both implementations are wrong, but that gets into social coordination problems about what the specification "should" be, and is especially problematic if both implementations are the way they are because that makes it easier to build on existing libraries.

### Smuggling email inside of email

Posted Jan 4, 2024 22:31 UTC (Thu)
by **Wol** (subscriber, #4433)
[[Link](/Articles/956937/)] (4 responses)

> The "correct" fix is to tighten up the protocol specification so that one or both implementations are wrong,

No. The correct fix is to implement the specification correctly. In your own example, the spec places no requirements on the sender. Therefore the receiver should place no requirements on the sender. Your example of the reciever demanding a multiple of 8 is a clear "gilding of the lily", overly strict, and breach of the specification. Okay, if the spec does not tell the receiver how it knows how many digits it has received - ie the spec does not contain sufficient information to implement itself correctly - then the specification needs to be corrected.

In this particular case, I'd be inclined to \*clarify\* the spec by saying "the sender can send as many or as few characters as it likes". That doesn't affect any implementation enforcing the current letter of the spec. Yes it breaks your receiver, but only because it's enforcing "restrictions not in the spec".-

I've actually been badly bitten (by a PHB) because of this sort of problem back when email switched from ASCII to 8-bit. Of course, it was MS that contradicted the letter of the spec, but because it was \*our\* Microsoft Mail that was at fault, the PHB blamed the ISP and demanded \*they\* fixed the problem.

The SMTP spec says that invalid commands must be rejected with a 200 error, and the receiver \*must\* then wait for a new command. So the 8-bit RFC revision said "if you want to start an 8-bit transmission, use EHLO rather than HELO to tell the recipient to expect an 8-bit transmission". So what does MS Mail do? "550 Invalid command connection terminated".

I think the ISP ended up creating a config option telling sendmail not to use EHLO for certain (like us) customers.

Cheers,

Wol

### Smuggling email inside of email

Posted Jan 4, 2024 22:34 UTC (Thu)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956940/)]

The specification does not say whether zero-padding is allowed or not - and yet one of the my examples is a receiver that insists on no zero-padding because it's "obviously" not needed, while another insists on zero-padding because it's "obviously" needed to indicate length.

And the spec is currently silent on zero-padding; changing the spec to say "no zero padding allowed" is one option. Changing it to say "zero or more leading zeroes are permitted" is another.

### Smuggling email inside of email

Posted Jan 5, 2024 10:49 UTC (Fri)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956964/)] (2 responses)

And, as an aside, this comment is exactly why the robustness principle leads to a mess; I showed two receivers that insisted on different things that aren't in the letter of the specification (one insisting on zero padding, the other insisting that it's not allowed).

You've focused on the one that's visibly weird (the one that insists on padding), and ignored the other one that's outside the specification; and yet both are problematic if you're trying to deal with arbitrary clients. It would be simple to fix the specification to declare what degree of zero padding is allowed, but that's currently out of scope - the spec as given permits me to sent petabytes of 0 digits followed by the real number.

And your anecdote is unrelated; you have a case where your local mail server does not obey the letter of RFC 821 (which states that you must remain "in the same state" as before the command was received if you receive an invalid command while waiting for a HELO); in RFC 821 SMTP, you're only supposed to close the transmission channel if you're shutting down service, or in response to a successful QUIT command. This is different to a case where both implementations are obeying the letter of the specification, but imposing additional requirements not contained in the spec, and both implementers believe that they're obeying the spec (after all, they accept numbers formatted as hex digits).

### Smuggling email inside of email

Posted Jan 5, 2024 13:58 UTC (Fri)
by **Wol** (subscriber, #4433)
[[Link](/Articles/956974/)] (1 responses)

I know my example was actually an explicit breach of the spec, but your example is also a breach of the spec. BOTH your receivers are refusing to accept a transmission that complies with the spec.

So imho no the spec does not need to be changed at all. At most it should be clarified as "the spec tells the sender to send a hex-formatted number, therefore the receiver must accept any valid hex-formatted number."

As I see it, my SMTP example yes it's easy to say MS Mail ignored the spec. But your example is to me exactly the same. The sender sent a valid (as per the spec) message. The receiver refused to accept and process it correctly. Sendmail sent us a validly formatted EHLO. MS Mail refused to accept and process it correctly. I would have thought "if the other party is behaving as per spec, then you are at fault unless the spec is contradictory" was just plain obvious!

Cheers,

Wol

### Smuggling email inside of email

Posted Jan 5, 2024 14:26 UTC (Fri)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956978/)]

But that's just my point - one of the two examples is a plausible interpretation of the specification, because leading zeroes aren't discussed either way. The other is less plausible, but could come up if you're using a library that insists on having padded input.

And by your reasoning, the spec intends that implementations are capable of consuming petabytes of leading zeroes as part of accepting a hex-formatted number less than 10, otherwise they're in breach of the specification - but this is clearly absurd, and unlikely to be what the spec author intended. This is *why* you should fix the specification, not the implementations, since we've got behaviour that's not discussed but should be.

The reason your SMTP example is different is that the specification for SMTP explicitly says that a server keeps the connection open after a bad command - we're not talking about something that's omitted from the spec (are leading zeroes part of a valid hex-formatted number or not?), but about something that's in the spec but where your server deviated from the specification.

### Smuggling email inside of email

Posted Jan 4, 2024 19:54 UTC (Thu)
by **Cyberax** (**✭ supporter ✭**, #52523)
[[Link](/Articles/956913/)] (3 responses)

I remember reading about the new robustness law: "Be as strict as possible in what you accept, and be slightly evil in what you send".

For example, if you provide a list of allowed encodings during the negotiation, then randomize the order, and maybe stuff a couple of non-existing encodings.

### Smuggling email inside of email

Posted Jan 5, 2024 10:52 UTC (Fri)
by **smitty\_one\_each** (subscriber, #28989)
[[Link](/Articles/956966/)] (1 responses)

"...and here's a little WTF-8 for my homies..."

### Smuggling email inside of email

Posted Jan 5, 2024 21:09 UTC (Fri)
by **Cyberax** (**✭ supporter ✭**, #52523)
[[Link](/Articles/957040/)]

That's not "slightly", that's just evil.

### Smuggling email inside of email

Posted Jan 5, 2024 11:04 UTC (Fri)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956967/)]

Your "non-existing encodings" bit reminded me of [Raymond Chen on a driver compatibility issue in DirectX](https://devblogs.microsoft.com/oldnewthing/20040211-00/?p=40663); the OS would ask the driver "do you support this optional feature, GUID xxx?" and the driver in question always said "yes", causing issues when you used that feature.

The solution was to come up with a way to generate "impossible" features at runtime, and if your driver claimed to support such a feature, it was known to be lying about optional feature support and could be ignored.

### Smuggling email inside of email

Posted Jan 4, 2024 14:42 UTC (Thu)
by **rrolls** (subscriber, #151126)
[[Link](/Articles/956838/)] (20 responses)

Postel's Law is great for processing that is started directly by the intended user (and usually, a human being) and then completed as soon as possible (with that intended user being notified about it). I suspect it was originally written with that in mind, but because of the era, the condition was never stipulated.

For the "liberal in what you accept": if I'm trying to retrieve some value from some old file that only partially complies with a standard that's many years younger than the file, I want the program to do its utmost to retrieve that value; if the deviations from the standard are enough to prevent this from being possible, it's generally pretty obvious from the output.

Similarly, for the "conservative in what you do": if I'm collecting a whole bunch of data into one file to be sent off elsewhere, I'd want that file to be as simple and compliant as possible (in terms of its syntax/encoding), so that it's useful as input to the widest possible range of other programs.

Where Postel's Law is terrible is the case of processing that is started by some unattended, always-available server receiving something - indeed, like an email server. "Liberal in what you accept" is useful when the user is the intended user; but if the user is a malicious user instead, it's going to be just as useful to them. There's even an argument for not being "conservative in what you do" - this is the argument for "security by obscurity". (Whether this is a good argument or not is a different matter entirely.)

### Smuggling email inside of email

Posted Jan 4, 2024 14:54 UTC (Thu)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956860/)]

I've found a useful summary to be "Postel's Law applies only when one side of the conversation is intended to be a human". For machine-to-machine communications (as SMTP, IMAP and others are now), Postel's Law is outright hazardous.

This also plays into other things people do; for example, the problem with binary protocols and file formats is that you can't use tools intended to show text to a human to decode them. But if the intent is to use tools intended to handle that protocol or file format exclusively, you can do just as well with an unambiguous and well-designed binary format.

### Smuggling email inside of email

Posted Jan 4, 2024 15:32 UTC (Thu)
by **adobriyan** (subscriber, #30858)
[[Link](/Articles/956861/)] (17 responses)

> Postel's Law is great

No, it's just terrible. One key distinction between computers and humans is that computers are extremely precise and humans are extremely imprecise (especially in comparison). It very easy to lower computers to human level (just ship whatever buggy code at the moment), but it is \_impossible\_ to uplift humans to computer levels of precision.

Consequently, making computer second guess the human doesn't work. The best example is probably Excel guessing dates vs non-dates. It went as far as scientists renaming genes.

I was unfortunate to use a spreadsheet few years ago and naturally used some Linux clone. All I did is to paste like 10 floats into cells and it guessed format of the data on the \_first\_ try \_wrong. The very first interaction with a program is a bug. Of course it was done for user-friendliness and Excel compatibility and whatever reasons but bug is a bug is a bug. Encountering a bug immediately while doing nothing unusual suggests very high rate of this problem across all users.

It is bad that programmers misinterpret specs and write spec violations, it's ten times bad when managers force programmers to do so.

In a perfect world interacting with Excel will be like this:

\* user pasted data (or opens csv),

\* all new data are marked with red meaning "computer have no idea what the data mean",

\* user marks the data as "integer", "date", "real number" etc making them green in bulk or individually,

\* no processing takes place until data are made green.

Of course this is not happening, because asking user to explain to the computer what he means is somewhere around ethnic cleansing levels of human rights violations.

AI/ML companies show the problem very well now, where single digit percent failures are celebrated because humans sometimes perform even worse.

This particular SMTP bug is more of a confusion by 2 common newline types and "streaming" property of SMTP where there is no LEN command unambiguously identifying length of the message (to this day! [citation needed]).

The better Postel's law example is probably browser interpreting broken closing tags and reordering them internally.

This is perfect "we can't break popular website with in new update, can you fix it by Friday?" moment.

### Smuggling email inside of email

Posted Jan 4, 2024 15:58 UTC (Thu)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956865/)] (14 responses)

Some computer behaviour is simply annoying, though. For example, a JSON list is technically incorrect if there's a comma after the last element of the list but before the ], even though there's only one possible way to fix the input to be valid JSON. A good system will take that input data, recognise that there's only one possible edit that makes it sensible, and ask the user if that's really what they meant - then, if it is, make that edit for them.

And that's the gap between good applications of Postel's Law and bad ones; in a good application of it, the computer is interacting with the user to get confirmation that its "liberalness" in what it's accepting is indeed correct. In a bad application, the computer makes assumptions about what was meant, and doesn't give the originator a way to correct its errors.

### Smuggling email inside of email

Posted Jan 4, 2024 18:03 UTC (Thu)
by **NYKevin** (subscriber, #129325)
[[Link](/Articles/956899/)] (7 responses)

Is there an advantage to prohibiting the trailing comma in the first place? Python allows it, and doesn't seem to suffer any problems as a result of that specific design decision.\* SQL also bans trailing commas in the SELECT clause (and a couple of other places), and I have no idea why.\*\* What software malfunction could be triggered or exacerbated by allowing a trailing comma?

\* Python has been mentioned, so the thread will now be derailed with people complaining about random other features of Python that are totally irrelevant to this conversation, but at least I \*tried\* to steer it towards Postel's law and JSON.

\*\* In the case of SQL, this is an anti-feature, because any code that wants to generate SQL has to go to the trouble of ensuring that every column name is followed by a comma, except for the last column.

### Smuggling email inside of email

Posted Jan 4, 2024 19:22 UTC (Thu)
by **excors** (subscriber, #95769)
[[Link](/Articles/956911/)]

I think the reason is that JSON was designed to be a subset of ECMAScript 3, so that it could be parsed in web browsers with eval(), and ES3 doesn't allow trailing commas in object literals (though ES5 does).

(Later it was realised that eval is a terrible way to parse potentially-untrusted input, and doesn't even work in general for trusted input, but the original recommendation was literally just `eval("window.val="+json\_string)`: [http://web.archive.org/web/20030205013518/http://crockfor...](http://web.archive.org/web/20030205013518/http%3A//crockford.com/JSON/js.html))

ES3 does allow trailing commas in array literals, but that's part of the weird 'elision' syntax where `[,].length == 1`, `[,,1,,].length == 4`, etc, and I suspect it was omitted from JSON because Douglas Crockford didn't like it, plus it would be confusingly inconsistent with the object literals. (Crockford's "JavaScript: The Good Parts" says "[JSLint] does not expect to see elided elements in array literals. Extra commas should not be used. A comma should not appear after the last element of an array literal or object literal because it can be misinterpreted by some browsers.")

And once the first version of JSON had been published, it was too late to make any syntax changes without causing major interoperability problems.

### Smuggling email inside of email

Posted Jan 4, 2024 20:12 UTC (Thu)
by **khim** (subscriber, #9252)
[[Link](/Articles/956917/)] (5 responses)

Is there an advantage to prohibiting the trailing comma in the first place?

The problem is not in trailing comma. The problem is in different programs treating the same input differently (precisely what we are discussion in the article, isn't it?)

It doesn't even matter about **how exactly** you interpret broken data. The key is that **different apps would interpret them differently**.

If you want to have auto-fixer for the JSON then **decouple it from JSON parser and make sure user may use it with all apps that s/he want's or needs to use it**.

### Smuggling email inside of email

Posted Jan 4, 2024 21:45 UTC (Thu)
by **NYKevin** (subscriber, #129325)
[[Link](/Articles/956931/)] (4 responses)

My argument, unreasonable though it may be, is essentially that Crockford should have used his magical crystal ball to predict that prohibiting trailing commas would inevitably become a nuisance. I'm not suggesting that anyone in 2023 should be going around emitting JSON that actually contains trailing commas - that way lies madness. If you want to have trailing commas and don't care about JSON compatibility, then switch to TOML (which explicitly specifies a trailing comma as legal in arrays, and otherwise does not use commas much), or some other format with the same property.

### Smuggling email inside of email

Posted Jan 7, 2024 6:53 UTC (Sun)
by **ssmith32** (subscriber, #72404)
[[Link](/Articles/957077/)] (3 responses)

I have worked with lots and lots of JSON, in a variety of environments, and have never once found this to be any kind of problem, nuisance or otherwise.

Do tell how this is a nuisance..?

I mean, if someone continually trips up and fails to skip appending a delimiter to the last item of a list... I certainly wouldn't want them anywhere near my serde code.. it's sort of a bog-standard thing.

### Smuggling email inside of email

Posted Jan 7, 2024 8:12 UTC (Sun)
by **mjg59** (subscriber, #23239)
[[Link](/Articles/957081/)]

When reordering elements, or moving elements between different lists, it's much easier if you can just cut and paste without then needing to edit. Requiring that the final element in a list be special makes that harder. Given that there's zero ambiguity here it's something that maybe makes life easier for people implementing a parser but makes life harder for everyone producing things consumed by that parser, and overall that feels like a poor tradeoff.

### Smuggling email inside of email

Posted Jan 7, 2024 10:28 UTC (Sun)
by **mbunkus** (subscriber, #87248)
[[Link](/Articles/957084/)]

Programs can easily create valid JSON files; that isn't the issue. The issue is that JSON is human-readable and is therefore used in many places where humans must edit/write it manually, too, e.g. for config files. However, it wasn't designed for that use case. Not allowing the list separator in the last place is one of the drawbacks, not having comments the most obvious other one. Us humans want to be able to easily edit things, switch lines around, copy-paste stuff & append it, ideally without having to worry about these minutiae.

JSON is pretty much the worst of both worlds. It can be used for human-editable scenarios, but isn't good at it. It can be used for data interchange, but it isn't good at that either (parsing requires much more time & memory than necessary; real problems with big integers in various implementations etc.). It's the typical case of being just good enough & easy enough to implement to be ubiquitous. And us developers find it easy to use 'cause it makes debugging data flow so easy. Meh…

### Smuggling email inside of email

Posted Jan 7, 2024 11:00 UTC (Sun)
by **ianmcc** (subscriber, #88379)
[[Link](/Articles/957089/)]

I have some python code that I used to use to collate grades. Depending on the course, different fields of some python dictionary would be relevant for the final grade, so it would be a few messy lines with some commented out, some new ones added, etc. It is convenient in python that you can have a leading comma on every line. If that wasn't the case and you commented out the last entry (or added a new one at the end) then you'd need to fix up the commas. Admittedly not a huge burden, but also a rather pointless. And definitely it would be a nuisance.

### Smuggling email inside of email

Posted Jan 4, 2024 20:06 UTC (Thu)
by **khim** (subscriber, #9252)
[[Link](/Articles/956914/)] (5 responses)

A good system will take that input data, recognise that there's only one possible edit that makes it sensible, and ask the user if that's really what they meant - then, if it is, make that edit for them.

No. Good user system accepts what is specified and rejects what is not specified.

Some computer behaviour is simply annoying, though. For example, a JSON list is technically incorrect if there's a comma after the last element of the list but before the ], even though there's only one possible way to fix the input to be valid JSON.

No. It may be spurious command or forgotten `0` easily. Or just lost large chunk of data.

Now, it may be good idea to **demand** trailing comma, instead.

This format may even be better that today's one, but that would be **different** format.

And yes, I'm saying that as someone who very much edits JSON files by hand.

As annoying as getting message “you JSON is invalid” is I **much** prefer it to the fuzzy formats which couldn't be parsed reliably at all. Just look on [vk.xml](https://raw.githubusercontent.com/KhronosGroup/Vulkan-Docs/main/xml/vk.xml) and try to imagine what kind of parser may give you answer to the simple question: what size if `CAMetalLayer` (or if it even have a type).

A good system will take that input data, recognise that there's only one possible edit that makes it sensible, and ask the user if that's really what they meant - then, if it is, make that edit for them.

Please don't. If you do that people would invariably submit garbage, “apply edit” without looking and then **complain that program doesn't work even if they did everything correctly.**

If you want then add something like this to your **text editor**. Don't duplicate that code and cause vulnerabilties that we are discussing here.

It's **perfect** example of what is happening if you apply such “niceties”.

### Smuggling email inside of email

Posted Jan 4, 2024 20:14 UTC (Thu)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956916/)] (4 responses)

You're contradicting yourself within your comment: do you want my system, of which my text editor is one component, to be able to work with me to correct entry errors, or is that bad, because my text editor, a component of my system, should be able to work with me to correct entry errors?

And my entire point is that when there's only one correction to be made, the system as a whole should work with me to recognise where my error is, not just apply that correction blindly - chances are good that in the JSON block [1,2,3,], I meant [1,2,3], but it's also possible that I didn't mean that, and I meant [1,2,3,4,5,6], but forgot three numbers. Actually asking me if I meant [1,2,3] instead of [1,2,3,] gives me a chance to say "um, no, that's not what I meant" and fix it manually if the correction is wrong.

### Smuggling email inside of email

Posted Jan 4, 2024 20:56 UTC (Thu)
by **khim** (subscriber, #9252)
[[Link](/Articles/956921/)] (3 responses)

You're contradicting yourself within your comment: do you want my system, of which my text editor is one component, to be able to work with me to correct entry errors, or is that bad, because my text editor, a component of my system, should be able to work with me to correct entry errors?

Text editor either should work with **any** JSON consumer than I may want to use (including, but not limited, various Google APIs, phone apps and raw python scripts) or it shouldn't be used.

I would much prefer it as entirely separate tool not attached to anything else at all, but as long as integration with “your system” is optional I may stomach it.

What I don't want is to **ever** be in a situation when someone uses your system and then assumes that **my** system have to provide such facilities, too.

Because that's where the slippery slope starts: different programs shouldn't treat the same file differently.

And my entire point is that when there's only one correction to be made, the system as a whole should work with me to recognise where my error is, not just apply that correction blindly - chances are good that in the JSON block [1,2,3,], I meant [1,2,3], but it's also possible that I didn't mean that, and I meant [1,2,3,4,5,6], but forgot three numbers. Actually asking me if I meant [1,2,3] instead of [1,2,3,] gives me a chance to say "um, no, that's not what I meant" and fix it manually if the correction is wrong.

I don't even care about what exactly “your system” does. I **do** care about the fact that as long as you attach that ability to “your system” I have to attach it to “my system”, too. And then we and up these insane piles of buggy code which implements the same improvements in 10 different ways and end up with crazy security vulnerabilities.

And **please** stop playing that card about how you may reject fixes. It was plausible 20 years ago. **Today we know it just doesn't work**. [Dancing pigs](https://en.wikipedia.org/wiki/Dancing_pigs) would ensure that after “your system” would be adopted by masses it would work as if that question about what to do with fixes doesn't even exist.

The only way to achieve something even remotely resembling security is to ensure that all these “fixes” are **not offered automatically** and user **explicitly** and **consciously** opts in into them.

### Smuggling email inside of email

Posted Jan 4, 2024 21:05 UTC (Thu)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956924/)] (2 responses)

My "system" is a computer running software. Since you're being abundantly clear that your system is not a computer running software, what is it, and how does it interact with my system?

I'm going back to where Postel's Law comes from - it's a bad UX when the computer clearly knows what is wrong with your input, but does nothing to help you - [this bit of humour about systems that work that way](https://www.gnu.org/fun/jokes/ed-msg.en.html) is very funny, BTW - but it's also a bad UX in the long run if the computer blindly autocorrects for you.

And taking you at face value, you seem to be claiming that compilers giving me suggestions in the output, which I can then apply if I believe the computer is correct is "Today we know it just doesn't work." - and yet clang, rustc and GCC all do exactly that, telling me what they think I intended given what I've written. I can then accept or reject that change as I see fit.

### Smuggling email inside of email

Posted Jan 4, 2024 21:26 UTC (Thu)
by **khim** (subscriber, #9252)
[[Link](/Articles/956925/)] (1 responses)

My "system" is a computer running software.

You never told me what “your system” even is. What kind of software does it include, how does it process things, etc.

And taking you at face value, you seem to be claiming that compilers giving me suggestions in the output, which I can then apply if I believe the computer is correct is "Today we know it just doesn't work." - and yet clang, rustc and GCC all do exactly that, telling me what they think I intended given what I've written.

Yes, they are slowly but surely are nearing that threshold that separates helpful suggessions from madness.

Which may not even matter because we have a tool that crosses it easily: Bard/ChatGPT/etc. **These** may give you plenty of suggestions which may ruin everything your do so thoroughly you would be forced to go back to old backups and redo everything from scratch.

If you even have these backups.

I can then accept or reject that change as I see fit.

No. You have to **read it and think about it**. And even these, pretty limited, suggestions are already causing plenty of damage: I have seen plenty of “programmers” who arrive on forums and complain that after applying these fixes their program still doesn't work because they are going in circles.

They don't even stop to think for a minute and then realise that it's their responsibility to produce sensible code, not compiler's. No, they just assume that they may create something by randomly changing code and then following the compiler advice.

And these are “developers”! Trained ones! Who passed few interviews and got good marks!

What happens when “normal people” when they are operating our IT systems is hard to even imagine.

### Smuggling email inside of email

Posted Jan 4, 2024 21:41 UTC (Thu)
by **farnz** (subscriber, #17727)
[[Link](/Articles/956930/)]

No, but you made false assumptions about my system, and then, having made those false assumptions, chose to be rude and obnoxious about how I was wrong because you made bad assumptions.

And "as I see fit" includes "reading and thinking about it" - that is one part of forming my opinion. Sure, there's no shortage of idiots out there, but those people would do something stupid whether the computer's error message is ?, or On line 52, column 96, there is a , followed by a ] ending a list. This comma is syntatically invalid; you need to either remove the comma or add another data item.

This is, after all, where Postel's Law comes from; if the only output is either ? or correct results, you're being strict in what you accept, but it's very hard to debug the resulting system. If your error tells you what the computer dislikes about its input, you're being weakly liberal in what you accept, and that makes it easier to debug; Postel's error was generalising this to the case where there's no intelligence in the loop at all.

### Smuggling email inside of email

Posted Jan 4, 2024 18:56 UTC (Thu)
by **wahern** (subscriber, #37304)
[[Link](/Articles/956909/)] (1 responses)

> This particular SMTP bug is more of a confusion by 2 common newline types and "streaming" property of SMTP where there is no LEN command unambiguously identifying length of the message (to this day! [citation needed]).

A BDAT command for SMTP was first specified in 1995: <https://www.rfc-editor.org/rfc/rfc1830.txt> Or 2020, depending on your criteria: <https://datatracker.ietf.org/doc/html/rfc3030>

Microsoft Exchange uses BDAT, IIRC, but otherwise it's mostly gone unused. Ironically, BDAT would make smuggling exploits even easier unless and until the old DATA command was completely retired.

### Smuggling email inside of email

Posted Jan 5, 2024 0:32 UTC (Fri)
by **auerswal** (subscriber, #119876)
[[Link](/Articles/956948/)]

According to the SEC Consult blog post, use of BDAT by Microsoft Exchange Online prevented their SMTP Smuggling attempts when the inbound server supported it.

### Smuggling email inside of email

Posted Jan 4, 2024 17:44 UTC (Thu)
by **pallas** (guest, #128204)
[[Link](/Articles/956898/)]

> Postel's Law is great for processing that is started directly by the intended user (and usually, a human being) and then completed as soon as possible (with that intended user being notified about it). I suspect it was originally written with that in mind, but because of the era, the condition was never stipulated.

It appears in RFC 761, a TCP spec from 1980.

### Smuggling email inside of email

Posted Jan 4, 2024 21:02 UTC (Thu)
by **gouttegd** (guest, #106484)
[[Link](/Articles/956923/)] (1 responses)

I believe that the robustness principle has been misunderstood all along.

While Postel’s initial formulation in RFC 761 [<https://datatracker.ietf.org/doc/html/rfc761>] was very short and could indeed be interpreted as a recommendation to accept ill-formed input, the extended formulation from RFC 1112 [<https://datatracker.ietf.org/doc/html/rfc1122#section-1.2.2>] (where it gains its name of “robustness principle”) doesn’t quite say that:

> Software should be written to deal with every conceivable error, no matter how unlikely; sooner or later a packet will come in with that particular combination of errors and attributes, and unless the software is prepared, chaos can ensue. In general, it is best to assume that the network is filled with malevolent entities that will send in packets designed to have the worst possible effect. This assumption will lead to suitable protective design

A robust program is \_not\_ a program that accepts any ill-formed input as long as the meaning is clear. It’s a program that is \_ready to receive\_ any ill-formed input and deal with it gracefully (instead of, say, erring into undefined behaviour territory or segfaulting, as a non-robust program would do). Whether it \_accepts\_ the ill-formed input once it has recognised it for what it was is another question entirely.

### Smuggling email inside of email

Posted Jan 4, 2024 22:14 UTC (Thu)
by **NYKevin** (subscriber, #129325)
[[Link](/Articles/956938/)]

The reason that nobody is willing to call that the "robustness principle" is that, by modern standards, it's completely obvious. Of \*course\* you can't just crash when somebody sends you an ugly packet (for whatever definition of "ugly" is appropriate). If you write software in 2024 that crashes or misbehaves on invalid network traffic, somebody will find it and get it labeled with a CVE number in (hopefully) short order.

### Smuggling email inside of email

Posted Jan 4, 2024 13:48 UTC (Thu)
by **james** (subscriber, #1325)
[[Link](/Articles/956823/)]

I note that for Exim, "disable chunking" by setting
chunking\_advertise\_hosts =

was also recommended as a workaround for CVE-2017-16943. I must admit that I never came up with a change control justification to turn it back on again.

Now I'm tempted to call that policy. Exim has had its security problems over the years, and turning off optional extras reduces the attack surface.

Copyright © 2024, Eklektix, Inc.

This article may be redistributed under the terms of the
[Creative
Commons CC BY-SA 4.0](http://creativecommons.org/licenses/by-sa/4.0/) license

Comments and public postings are copyrighted by their creators.

Linux is a registered trademark of Linus Torvalds



=== Content from lists.debian.org_0dea4150_20250114_193110.html ===


---

[[Date Prev](msg00001.html)][[Date Next](msg00003.html)]
[[Thread Prev](msg00001.html)][[Thread Next](msg00003.html)]
[[Date Index](maillist.html#00002)]
[[Thread Index](threads.html#00002)]

# [SECURITY] [DLA 3708-1] exim4 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3708-1] exim4 security update
* *From*: Markus Koschany <apo@debian.org>
* *Date*: Fri, 05 Jan 2024 23:08:00 +0100
* *Message-id*: <[[🔎]](/msgid-search/7630e50de4062627e18bbbd5137b001fde043a71.camel%40debian.org) [7630e50de4062627e18bbbd5137b001fde043a71.camel@debian.org](msg00002.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-3708-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                      Markus Koschany
January 05, 2024                              <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : exim4
Version        : 4.92-8+deb10u9
CVE ID         : CVE-2023-51766
Debian Bug     : 1059387

It was discovered that Exim, a mail transport agent, can be induced to accept a
second message embedded as part of the body of a first message in certain
configurations where PIPELINING or CHUNKING on incoming connections is offered.

For Debian 10 buster, this problem has been fixed in version
4.92-8+deb10u9.

We recommend that you upgrade your exim4 packages.

For the detailed security status of exim4 please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/exim4>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpPfN7sO7uBO.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from lists.fedoraproject.org_5d4e4df6_20250114_193124.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ.mbox.gz?message=QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ/#QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ)

# [SECURITY] Fedora 39 Update: exim-4.97.1-1.fc39

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

11 Jan
2024

11 Jan
'24

7:12 p.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2024-1ef6197a49
2024-01-12 01:10:53.039983
--------------------------------------------------------------------------------

Name : exim
Product : Fedora 39
Version : 4.97.1
Release : 1.fc39
URL : <https://www.exim.org/>
Summary : The exim mail transfer agent
Description :
Exim is a message transfer agent (MTA) developed at the University of
Cambridge for use on Unix systems connected to the Internet. It is
freely available under the terms of the GNU General Public Licence. In
style it is similar to Smail 3, but its facilities are more
general. There is a great deal of flexibility in the way mail can be
routed, and there are extensive facilities for checking incoming
mail. Exim can be installed in place of sendmail, although the
configuration of exim is quite different to that of sendmail.

--------------------------------------------------------------------------------
Update Information:

=Security fix for CVE-2023-51766.
--------------------------------------------------------------------------------
ChangeLog:

\* Wed Jan 3 2024 Jaroslav ��karvada jskarvad@redhat.com - 4.97.1-1
- New version
Resolves: rhbz#2256145
- Fixed SMTP smuggling vulnerability
Resolves: CVE-2023-51766
\* Mon Nov 6 2023 Jaroslav ��karvada jskarvad@redhat.com - 4.97-1
- New version
Resolves: rhbz#2247920
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2255852 - CVE-2023-51766 exim: SMTP smuggling vulnerability
<https://bugzilla.redhat.com/show_bug.cgi?id=2255852>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2024-1ef6197a49' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ/#QPDWHJPABVJCXDSNELSSVTIVAJU2MDUQ)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from bugs.exim.org_f876863c_20250115_114620.html ===


| Bugzilla – Bug 3063 | "SMTP Smuggling" attack | Last modified: 2024-02-02 08:09:56 UTC |
| --- | --- | --- |

|  |
| --- |

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](docs/html/bug_page.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=3063&GoAheadAndLogIn=1)

  Remember

  [x]
* |
  [Forgot Password](show_bug.cgi?id=3063&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

*First*
*Last*
*Prev*
*Next*

*This bug is not in your last
search results.*

[**Bug 3063**](show_bug.cgi?id=3063) -
"SMTP Smuggling" attack

|  | |
| --- | --- |
| [Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.") | "SMTP Smuggling" attack |

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Exim | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Exim "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Mail Receipt | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 4.93 | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All All | |  | | | [Importance](page.cgi?id=fields.html#importance): | medium security | | [Target Milestone](page.cgi?id=fields.html#target_milestone): | Exim 4.98 | | [Assigned To](page.cgi?id=fields.html#assigned_to): | Jeremy Harris | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords](describekeywords.cgi): |  | | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | Show dependency [tree](showdependencytree.cgi?id=3063&hide_resolved=1) / [graph](showdependencygraph.cgi?id=3063) | | |  | | Reported: | 2023-12-22 10:53 UTC by Simon Arlott | | --- | --- | | Modified: | 2024-02-02 08:09 UTC ([History](show_activity.cgi?id=3063)) | | CC List: | 5 users (show)  exim-dev nobrowser pcernko unki viktor1dane | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [Add an attachment](attachment.cgi?bugid=3063&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=3063&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=3063#c0)  Simon Arlott    2023-12-22 10:53:57 UTC  ``` Exim is partially vulnerable to <https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/>  Exim incorrectly allows <LF>.<LF> to end a message: "However, for the case when a dot on a line by itself terminates a message, the only recognized terminating sequences before and after the dot are LF and CRLF"  <https://www.rfc-editor.org/rfc/rfc5321>: "In particular, the sequence <LF>.<LF> (bare line feeds, without carriage returns) MUST NOT be treated as equivalent to <CRLF>.<CRLF> as the end of mail data indication."  With pipelining disabled, Exim is accepting one command after the end of a message. (I don't think it should do this.)  With pipelining enabled, Exim will accept commands up to DATA but no further. It's not possible to send a message like this but a precisely arranged set of packets and network congestion at exactly the right time would make it possible. ``` [Comment 1](show_bug.cgi?id=3063#c1)  Viktor Dukhovni    2023-12-22 20:57:30 UTC  ``` Does Exim enforce pipelining conformance by default?  That is, what is the default behaviour of Exim when an SMTP client expedites some data before receiving a reply to a command (e.g. *DATA*) that should be the *last* in a pipeline group?  Also, I should note that (as specified in RFC1830) BDAT is NOT the last command in a pipeline group, and so Exim will accept two messages via a transaction of the form:     MAIL FROM:<sender>    RCPT TO:<nobody>    DATA    From: Some Sender <sender>    To: Discarded Rcpt <nobody>    Subject: ...     <Some Message>    <LF>.<LF>    MAIL FROM:<forged-sender>    RCPT TO:<real-rcpt>    BDAT <length> LAST    From: Forged Sender <forged-sender>    To: Real Rcpt <real-rcpt>    Subject: Wire all your assets to me     <Phishing attack>    QUIT  It is sadly legal to pipeline any number of messages without any pauses with BDAT.  So provided the upstream system does not support CHUNKING, and treats non-standard line endings (<LF>.<LF> or <LF>.<CR><LF>) as normal message content to be sent verbatim, the SMTP smuggling scenario will work with that system as the sending and Exim as the receiving MTA. ``` [Comment 2](show_bug.cgi?id=3063#c2)  Jeremy Harris    2023-12-22 21:57:29 UTC  ``` (In reply to Viktor Dukhovni from [comment #1](show_bug.cgi?id=3063#c1)) > Does Exim enforce pipelining conformance by default?  In general yes, but specifically for the 354 "DATA go-ahead", not by default.  It's possible to induce one.  I could see some value in a change to always enforce.  > That is, what is the default behaviour of Exim when an SMTP client expedites  > Also, I should note that (as specified in RFC1830) BDAT is NOT the last > command in a pipeline group, and so Exim will accept two messages via a > transaction of the form: >  >    MAIL FROM:<sender> >    RCPT TO:<nobody> >    DATA  Um, that was DATA and not BDAT.  >    From: Some Sender <sender> >    To: Discarded Rcpt <nobody> >    Subject: ... >  >    <Some Message> >    <LF>.<LF>  and IF that gets treated as the dot closing off data, such that the following are taken as commands for a further message:  >    MAIL FROM:<forged-sender> >    RCPT TO:<real-rcpt> >    BDAT <length> LAST >    From: Forged Sender <forged-sender> >    To: Real Rcpt <real-rcpt> >    Subject: Wire all your assets to me >  >    <Phishing attack> >    QUIT  ... that "phishing attack" could just as easily have been sent as a sole message.  It will still be subject to all the same Access Control List operations, either way. ``` [Comment 3](show_bug.cgi?id=3063#c3)  Viktor Dukhovni    2023-12-22 22:06:42 UTC  ```  (In reply to Jeremy Harris from [comment #2](show_bug.cgi?id=3063#c2)) > (In reply to Viktor Dukhovni from [comment #1](show_bug.cgi?id=3063#c1)) > > Does Exim enforce pipelining conformance by default? >  > In general yes, but specifically for the 354 "DATA go-ahead", not > by default.  It's possible to induce one. >  > I could see some value in a change to always enforce.  That would likely be prudent.   > > Also, I should note that (as specified in RFC1830) BDAT is NOT the last > > command in a pipeline group, and so Exim will accept two messages via a > > transaction of the form: > >  > >    MAIL FROM:<sender> > >    RCPT TO:<nobody> > >    DATA >  > Um, that was DATA and not BDAT.  That's DELIBERATE.  The BDAT in question is in the BODY of the upstream message (below), preceded by <LF>.<LF>.  We need DATA from the upstream system to make some variant of <CRLF>.<CRLF> be end-of-message, but then its SMTP smuggling payload can use BDAT to bypass any pipelining enforcement.  >  > >    From: Some Sender <sender> > >    To: Discarded Rcpt <nobody> > >    Subject: ... > >  > >    <Some Message> > >    <LF>.<LF> >  > and IF that gets treated as the dot closing off data, such that the > following are taken as commands for a further message: >  > >    MAIL FROM:<forged-sender> > >    RCPT TO:<real-rcpt> > >    BDAT <length> LAST > >    From: Forged Sender <forged-sender> > >    To: Real Rcpt <real-rcpt> > >    Subject: Wire all your assets to me > >  > >    <Phishing attack> > >    QUIT >  > ... that "phishing attack" could just as easily have been sent > as a sole message.  It will still be subject to all the same > Access Control List operations, either way.  But the scenario in question assumes that the victim of forgery has DMARC, and that the sending system would normally restrict the alleged "From:" address (as is the typical case for submission via public email providers, hosting many customer domains, including perhaps their own).  In this attack scenario, the sending system is unaware that there's a second message in the body of the first, and the alignment of "From:" with the sender credentials is not enforced, but SPF-based DMARC checks still pass... ``` [Comment 4](show_bug.cgi?id=3063#c4)  Jeremy Harris    2023-12-24 19:32:41 UTC  ``` <https://nvd.nist.gov/vuln/detail/CVE-2023-51766>  git master: cf1376206284 & 5bb786d5ad56 address this. 5bb7 has a dependency on 4596719398f6 (which is only coding-style changes; not strictly part of the fixes).  Interested parties capable of building from git are invited to do so; these commits are not in a release package from the Exim project at this time. ``` [Comment 5](show_bug.cgi?id=3063#c5)  Jeremy Harris    2023-12-25 16:19:41 UTC  ``` I was was wrong about the lack of synch check for DATA.  There has always been one, so the one added in cf1376 is not needed (but will do no harm). ``` [Comment 6](show_bug.cgi?id=3063#c6)  Jeremy Harris    2023-12-29 12:51:08 UTC  ``` Security release 4.97.1 includes the relevant changes. ``` [Comment 7](show_bug.cgi?id=3063#c7)  Simon Arlott    2024-01-02 12:14:04 UTC  ``` > Dec 2023: getting a site to send a body including an "LF . LF" sequence > followed by SMTP commands is a possible "smtp smuggling" attack.  If > the first (header) line for the message has a proper CRLF then enforce > that for the body: convert bare LF to a space.  This still doesn't comply with RFC5321 because it allows <LF>.<LF> to end the message if the first header line ends with <LF>.  I expect that converting <LF> to a space is going to lead to further security or interoperability problems because it will mean Exim will merge two lines in a <CRLF>-based message if there's an <LF> in the middle of them, potentially changing the meaning of the message by merging two or more header lines together or merging the body with the headers.  Can't it just accept the message as-is, using dot duplication if the entire line is "."? ``` [Comment 8](show_bug.cgi?id=3063#c8)  Jeremy Harris    2024-01-02 12:19:27 UTC  ``` (In reply to Simon Arlott from [comment #7](show_bug.cgi?id=3063#c7)) > This still doesn't comply with RFC5321 because it allows <LF>.<LF> to end > the message if the first header line ends with <LF>.  That is deliberate, as there are use-cases that require it. ``` [Comment 9](show_bug.cgi?id=3063#c9)  Simon Arlott    2024-01-02 12:25:32 UTC  ``` You've not answered my other query on why Exim is replacing LF with a space. ``` [Comment 10](show_bug.cgi?id=3063#c10)  Ian    2024-01-02 17:42:53 UTC  ``` (In reply to Jeremy Harris from [comment #6](show_bug.cgi?id=3063#c6)) > Security release 4.97.1 includes the relevant changes.  Do any of these changes affect the octets which a transport filter sees? I have some suspect occurrences after upgrading (but not pointing a finger yet). ``` [Comment 11](show_bug.cgi?id=3063#c11)  Ian    2024-01-02 17:45:29 UTC  ``` (In reply to Jeremy Harris from [comment #8](show_bug.cgi?id=3063#c8)) > (In reply to Simon Arlott from [comment #7](show_bug.cgi?id=3063#c7)) > > This still doesn't comply with RFC5321 because it allows <LF>.<LF> to end > > the message if the first header line ends with <LF>. >  > That is deliberate, as there are use-cases that require it.  Can we have a configuration knob to disable it? Maybe even disable the LF ending headers.  I am up for coding it. ``` [Comment 12](show_bug.cgi?id=3063#c12)  Jeremy Harris    2024-01-02 18:04:03 UTC  ``` (In reply to Ian from [comment #10](show_bug.cgi?id=3063#c10)) > (In reply to Jeremy Harris from [comment #6](show_bug.cgi?id=3063#c6)) > > Security release 4.97.1 includes the relevant changes. >  > Do any of these changes affect the octets which a transport filter sees? I > have some suspect occurrences after upgrading (but not pointing a finger > yet).  Not directly, but if Exim is sending messages that it has previously received, the changes that are in the receive path would affect those messages - so if you are using a transport filter...  (In reply to Ian from [comment #10](show_bug.cgi?id=3063#c10)) > Can we have a configuration knob to disable it?  > I am up for coding it.  It doesn't seem technically infeasible.  I trust you have read around the relevant comments in the code regarding the support, and are willing to keep both pieces when it breaks - and include testcases for the testsuite, and maintain the new code for the forseeable future.  Please open a separate wishlist item for tracking this. ``` [Comment 13](show_bug.cgi?id=3063#c13)  Simon Arlott    2024-01-02 18:42:33 UTC  ``` (In reply to Simon Arlott from [comment #7](show_bug.cgi?id=3063#c7)) > > Dec 2023: getting a site to send a body including an "LF . LF" sequence > > followed by SMTP commands is a possible "smtp smuggling" attack.  If > > the first (header) line for the message has a proper CRLF then enforce > > that for the body: convert bare LF to a space. >  > I expect that converting <LF> to a space is going to lead to further > security or interoperability problems because it will mean Exim will merge > two lines in a <CRLF>-based message if there's an <LF> in the middle of > them, potentially changing the meaning of the message by merging two or more > header lines together or merging the body with the headers. >  > Can't it just accept the message as-is, using dot duplication if the entire > line is "."?  Jeremy, you've still not explained why Exim is now changing message content like this. Postfix and Sendmail don't do it. ``` [Comment 14](show_bug.cgi?id=3063#c14)  Viktor Dukhovni    2024-01-02 19:02:15 UTC  ``` (In reply to Simon Arlott from [comment #13](show_bug.cgi?id=3063#c13)) >  > Jeremy, you've still not explained why Exim is now changing message content > like this. Postfix and Sendmail don't do it.  Well, Postfix does in fact change message content when, for example, folding overly long headers or body lines, in order to ensure RFC-compliant SMTP output. In this case a line-break + space is inserted, and even without attempting to find a semantically appropriate context, garbage-in, garbage-out.  So it wouldn't be entirely unprecedented to replace non-conformant input with a plausible best-effort approximation.  That said, Postfix stores message content lines as "records", they have neither "LF" nor "CRLF" endings, they're either "Normal" records (complete lines to be <CRLF> terminated on output) or "Continued" records (line fragments, to which the next record is appended on output).  As a result, while both <LF> and <CRLF> were accepted as line endings on input (leading to a "Normal" queue file record), the output is <CRLF> terminated either way.  So it would perhaps be more natural to canonicalise <LF>.<LF> to <CRLF>.<CRLF> (but without treating it as end-of-message!).  The result would then be subject to dot-stuffing (SMTP transparency) on output.  One might accept <LF>.<LF> as message end only from clients whose "EHLO" and all subsequent SMTP commands up to and including "DATA" are <LF> terminated.  This allows some legacy unix-native SMTP clients to continue to work, while requiring RFC-conformant line-endings from all others. ``` [Comment 15](show_bug.cgi?id=3063#c15)  Ian    2024-01-08 06:21:52 UTC  ``` (In reply to Jeremy Harris from [comment #12](show_bug.cgi?id=3063#c12)) > (In reply to Ian from [comment #10](show_bug.cgi?id=3063#c10)) > > (In reply to Jeremy Harris from [comment #6](show_bug.cgi?id=3063#c6)) > > > Security release 4.97.1 includes the relevant changes. > >  > > Do any of these changes affect the octets which a transport filter sees? I > > have some suspect occurrences after upgrading (but not pointing a finger > > yet). >  > Not directly, but if Exim is sending messages that it has previously > received, the changes that are in the receive path would affect those > messages - so if you are using a transport filter... >  > (In reply to Ian from [comment #10](show_bug.cgi?id=3063#c10)) > > Can we have a configuration knob to disable it? >  > > I am up for coding it. >  > It doesn't seem technically infeasible.  I trust you have read around the > relevant comments in the code regarding the support, and are willing to > keep both pieces when it breaks - and include testcases for the testsuite, > and maintain the new code for the forseeable future. >  > Please open a separate wishlist item for tracking this.  Reading the code in receive.c, I'm having some ... second thoughts :-P  But maybe, and yes I understand that testcases are required. ``` [Comment 16](show_bug.cgi?id=3063#c16)  Simon Arlott    2024-01-08 08:06:47 UTC  ``` (In reply to Viktor Dukhovni from [comment #14](show_bug.cgi?id=3063#c14)) > (In reply to Simon Arlott from [comment #13](show_bug.cgi?id=3063#c13)) > >  > > Jeremy, you've still not explained why Exim is now changing message content > > like this. Postfix and Sendmail don't do it. >  > Well, Postfix does in fact change message content when, for example, folding > overly long headers or body lines, in order to ensure RFC-compliant SMTP > output. > In this case a line-break + space is inserted, and even without attempting > to find a semantically appropriate context, garbage-in, garbage-out. >  > So it wouldn't be entirely unprecedented to replace non-conformant input > with a plausible best-effort approximation.  You could say the same thing about <LF>.<LF>, which is the cause of this problem to begin with. It could allow new attacks based on adding and removing headers.  Incoming message with a second subject header hidden in what looks like the message body:  ``` Received: ...<CRLF> X-Placeholder1: A<LF> Subject: A<CRLF> <LF> X-Placeholder2: B<CRLF> Subject: B<CRLF> <CRLF> Message body<CRLF> .<CRLF> ```  Spooled message with alternative subject header exposed:  ``` Received: ... Received: ... X-Placeholder1: A Subject: A  X-Placeholder2: B Subject: B  Message body ```  > As a result, while both <LF> and <CRLF> were accepted as line endings on > input (leading to a "Normal" queue file record), the output is <CRLF> > terminated either way.  So it would perhaps be more natural to canonicalise > <LF>.<LF> to <CRLF>.<CRLF> (but without treating it as end-of-message!).  > The result would then be subject to dot-stuffing (SMTP transparency) on > output.  I think this is the approach that should be taken.  > One might accept <LF>.<LF> as message end only from clients whose "EHLO" and > all subsequent SMTP commands up to and including "DATA" are <LF> terminated. > This allows some legacy unix-native SMTP clients to continue to work, while > requiring RFC-conformant line-endings from all others.  This could be implemented by checking that no <CR> character has been received anywhere in the plaintext of the connection (without needing to specifically check line endings on every command).  A host list or expanded configuration variable would allow it to be accepted only from specific clients.  (It could exclude checking the message content itself because a message with CRLF line endings could be sent through an SMTP client that only uses LF line endings, but that allows a form of SMTP smuggling.) ``` [Comment 17](show_bug.cgi?id=3063#c17)  Simon Arlott    2024-02-02 08:09:56 UTC  ``` This is already creating interoperability problems in conjunction with the default strict line length limits, because a message body containing bare LFs which get converted to spaces can make the lines longer:  "< znx> after a recent upgrade .. we have noted that newlines seem to be getting stripped from a message body. still testing to determine exactly what is going on. but the message is accepted (passing a linelength check) and then rejected when it tries to router (failing a linelength check). messages which don't fail the linelength check .. get through but have their newlines stripped    and replaced by spaces. content is HTML. < jgh> I bet you're feeding bare CR's in < znx> possibly, I think it is from Oracle directly, not sure how it handles < znx> the newlines are in the message body"  This unexplained change should be reverted. As long as Exim understands the message correctly it can normalise the line endings when storing it. ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=3063)
* - [XML](show_bug.cgi?ctype=xml&id=3063)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=3063)
* - Top of page

*First*
*Last*
*Prev*
*Next*

*This bug is not in your last
search results.*

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](docs/html/bug_page.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=3063&GoAheadAndLogIn=1)

    Remember

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=3063&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



=== Content from fahrplan.events.ccc.de_c5aa1a3a_20250114_193107.html ===


# Schedule 37th Chaos Communication Congress

* [Overview](/congress/2023/fahrplan/index.html)
* [Wednesday
  -
  2023-12-27](/congress/2023/fahrplan/schedule/1.html)
* [Thursday
  -
  2023-12-28](/congress/2023/fahrplan/schedule/2.html)
* [Friday
  -
  2023-12-29](/congress/2023/fahrplan/schedule/3.html)
* [Saturday
  -
  2023-12-30](/congress/2023/fahrplan/schedule/4.html)
* [Speakers](/congress/2023/fahrplan/speakers.html)
* [Events](/congress/2023/fahrplan/events.html)
* [timeline](/congress/2023/fahrplan/timeline.html)
* [book](/congress/2023/fahrplan/booklet.html)
* [QR-Code](/congress/2023/fahrplan/qrcode.html)

Version Nichts ist wahr. Alles ist erlaubt.

## Lecture: SMTP Smuggling â Spoofing E-Mails Worldwide

###

![](/congress/2023/fahrplan/system/events/logos/000/011/782/large/SMTP_Smuggling-37C3_Logo.png)

Introducing a novel technique for e-mail spoofing.

SMTP, the Simple Mail Transfer Protocol, allows e-mailing since 1982. This easily makes it one of the oldest technologies amongst the Internet. However, even though it seems to have stood the test of time, there was still a trivial but novel exploitation technique just waiting to be discovered â SMTP smuggling!

In this talk, weâll explore how SMTP smuggling breaks the interpretation of the SMTP protocol in vulnerable server constellations worldwide, allowing some more than unwanted behavior. Sending e-mails as admin@microsoft.com to fortune 500 companies â while still passing SPF checks â will be the least of our problems!

From identifying this novel technique to exploiting it in one of the most used e-mail services on the Internet, weâll dive into all the little details this attack has to offer. Therefore, in this talk, weâll embark on an expedition beyond the known limits of SMTP, and venture into the uncharted territories of SMTP smuggling!

### Info

**Day:**
[2023-12-27](/congress/2023/fahrplan/schedule/1.html)

**Start time:**
22:05

**Duration:**
00:40

**Room:**
Saal Zuse

**Track:**
[Security](/congress/2023/fahrplan/events.html#security)

**Language:**
en

### Links:

* [iCalendar](/congress/2023/fahrplan/events/11782.ics)

### Feedback

[Click here to let us know how you liked this event.](https://frab.cccv.de/en/37c3/public/events/11782/feedback/new)

### Concurrent Events

### Speakers

|  | [Timo Longin](/congress/2023/fahrplan/speakers/19110.html) |
| --- | --- |

This schedule was generated with [frab](http://frab.github.io/frab/).

Archived page - [Impressum/Datenschutz](https://legal.cccv.de/)

=== Content from bugzilla.redhat.com_8beb4e1b_20250114_193106.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D2255852)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D2255852)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D2255852)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 2255852

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 2255852**](show_bug.cgi?id=2255852)
(CVE-2023-51766)
- [CVE-2023-51766](https://access.redhat.com/security/cve/CVE-2023-51766) exim: SMTP smuggling vulnerability

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2023-51766 exim: SMTP smuggling vulnerability

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | NEW | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2023-51766 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [2255853](show_bug.cgi?id=2255853 "CLOSED ERRATA - TRIAGE CVE-2023-51766 exim: SMTP smuggling vulnerability [fedora-all]") [2255854](show_bug.cgi?id=2255854 "CLOSED ERRATA - TRIAGE CVE-2023-51766 exim: SMTP smuggling vulnerability [epel-all]") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [2255562](show_bug.cgi?id=2255562) | | TreeView+ | [depends on](buglist.cgi?bug_id=2255852&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=2255852&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2023-12-25 20:01 UTC by Robb Gatica | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2024-01-24 08:41 UTC ([History](show_activity.cgi?id=2255852)) | | [CC List:](page.cgi?id=fields.html#cclist) | 0 users | | Fixed In Version: |  | | | Doc Type: | --- | | | Doc Text: | A flaw was discovered in exim that allows a remote attacker to exploit a weakness in some SMTP server configurations. This makes it possible to break out of the email message data to "smuggle" SMTP commands and send spoofed emails which pass SPF checks. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: |  | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=2255852#c0)  Robb Gatica    2023-12-25 20:01:38 UTC  ``` Source: exim4 Version: 4.97-2 Severity: important Tags: security upstream Forwarded: <https://bugs.exim.org/show_bug.cgi?id=3063> X-Debbugs-Cc: carnil, Debian Security Team <team.org>  Hi,  The following vulnerability was published for exim4.  [CVE-2023-51766](https://access.redhat.com/security/cve/CVE-2023-51766)[0]: | Exim through 4.97 allows SMTP smuggling in certain configurations. | Remote attackers can use a published exploitation technique to | inject e-mail messages that appear to originate from the Exim | server, allowing bypass of an SPF protection mechanism. This occurs | because Exim supports <LF>.<CR><LF> but some other popular e-mail | servers do not.   If you fix the vulnerability please also make sure to include the CVE (Common Vulnerabilities & Exposures) id in your changelog entry.  For further information see:  [0] <https://security-tracker.debian.org/tracker/CVE-2023-51766>     <https://www.cve.org/CVERecord?id=CVE-2023-51766> [1] <https://bugs.exim.org/show_bug.cgi?id=3063>   ```  [Comment 1](show_bug.cgi?id=2255852#c1)  Robb Gatica    2023-12-25 20:01:52 UTC  ``` Created exim tracking bugs for this issue:  Affects: epel-all [[bug 2255854](show_bug.cgi?id=2255854 "CLOSED ERRATA - TRIAGE CVE-2023-51766 exim: SMTP smuggling vulnerability [epel-all]")] Affects: fedora-all [[bug 2255853](show_bug.cgi?id=2255853 "CLOSED ERRATA - TRIAGE CVE-2023-51766 exim: SMTP smuggling vulnerability [fedora-all]")]   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=2255852&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from git.exim.org_7a356c10_20250114_193107.html ===

This website requires JavaScript.
[![Logo](/assets/img/logo.svg)](/)

[Explore](/explore/repos)
[Help](https://forgejo.org/docs/latest/)

[Sign in](/user/login?redirect_to=%2fexim%2fexim)

[exim](/exim)/[exim](/exim/exim)

Watch

[4](/exim/exim/watchers)

Star

[0](/exim/exim/stars)

Fork
You've already forked exim

[0](/exim/exim/forks)

[Code](/exim/exim)
[Issues](https://bugs.exim.org/)
[Pull requests](/exim/exim/pulls)
[Projects](/exim/exim/projects)
[Releases](/exim/exim/releases)
[Packages](/exim/exim/packages)
[Wiki](/exim/exim/wiki)
[Activity](/exim/exim/activity)
[Actions](/exim/exim/actions)

Master Exim source repository

[**6507** commits](/exim/exim/commits/branch/master)
[**60** branches](/exim/exim/branches)
[**176** tags](/exim/exim/tags)
 **86** MiB

C

92.3%

Perl

4.4%

Shell

1.9%

Elixir

0.4%

Makefile

0.3%

Other

0.5%

**master**

[Find a file](/exim/exim/find/branch/master)

HTTPS

Open with VS Code
Open with VSCodium
Open with Intellij IDEA

Cite this repository

BibTeX

Cancel

|  | | 2025-01-14 18:08:43 +00:00 |
| --- | --- | --- |
| [.github](/exim/exim/src/branch/master/.github ".github") | [fix the list URL](/exim/exim/commit/138860785cc96f077f052043d46f697abbf87947) | 2023-05-09 16:49:30 +02:00 |
| [configs](/exim/exim/src/branch/master/configs "configs") | [fix: typo](/exim/exim/commit/67072519f5db4f3b3df763fda9de20f280d31394) | 2023-10-20 21:34:12 +02:00 |
| [doc](/exim/exim/src/branch/master/doc "doc") | [Testsuite: de-hardcode port used for identd testing](/exim/exim/commit/d1a8024238be1e7fc6a7ed9c21747817b019e326) | 2025-01-12 13:00:01 +00:00 |
| [release-process](/exim/exim/src/branch/master/release-process "release-process") | [Release process: script for cleaning changebars from .xfpt files](/exim/exim/commit/d4d0b596c0dfd5501b8d552606eb158b3a972b8c) | 2024-06-07 15:38:07 +01:00 |
| [src](/exim/exim/src/branch/master/src "src") | [Build: Solaris, yet another go](/exim/exim/commit/f859ae4524c038a6c8e15ef89393606447cc37fe) | 2025-01-14 18:08:43 +00:00 |
| [test](/exim/exim/src/branch/master/test "test") | [Testsuite: shift base for munged ephemeral port numbers](/exim/exim/commit/1d800d5183b9b009b6a1ecb4290b2b48f47cf420) | 2025-01-12 23:50:24 +00:00 |
| [.editorconfig](/exim/exim/src/branch/master/.editorconfig ".editorconfig") | [Testsuite: Use .editorconfig for test/runtest](/exim/exim/commit/1ef2730eb3d31c57a088b0491dfb5096f65b289a) | 2016-10-20 00:48:29 +02:00 |
| [.exim-project-root](/exim/exim/src/branch/master/.exim-project-root ".exim-project-root") | [mk\_exim\_release: rework for dotted release scheme](/exim/exim/commit/525c441c8defd07ec9c1c235eb8ac4da304d70be) | 2018-12-13 23:11:36 +01:00 |
| [.gitattributes](/exim/exim/src/branch/master/.gitattributes ".gitattributes") | [meta: git controls for text changelogs; github controls](/exim/exim/commit/b988b06146c5d16e0ca0ea86ffcf2d83938088ed) | 2018-02-25 02:51:22 -05:00 |
| [.gitignore](/exim/exim/src/branch/master/.gitignore ".gitignore") | [Add systemd units (examples)](/exim/exim/commit/bb6a0f57e5c1a04c9c191af6a37184970003b1c2) | 2023-10-19 09:56:29 +02:00 |
| [.mailmap](/exim/exim/src/branch/master/.mailmap ".mailmap") | [mailmap: real name for bes-internal](/exim/exim/commit/faad4a0eab268f7a52b6d6e6102a41e31399de38) | 2023-10-04 00:18:16 +02:00 |
| [Readme.pod](/exim/exim/src/branch/master/Readme.pod "Readme.pod") | [fix the list URL](/exim/exim/commit/138860785cc96f077f052043d46f697abbf87947) | 2023-05-09 16:49:30 +02:00 |
| [SECURITY.md](/exim/exim/src/branch/master/SECURITY.md "SECURITY.md") | [Microfix in SECURITY.md: exim-VERSION+fixes](/exim/exim/commit/275dd1deb9b22da56d0d20cec505387a5b9d2070) | 2019-07-06 23:34:06 +02:00 |

#### **[Readme.pod](#readme)**

```
=head1 Exim Development Repository

This is the Exim (Mail Transport Agent) Development Repository. Please
read the following information if you wish to use or contribute to the
Exim development process - this is to prevent your or our time being
unnecessarily wasted.

If you just want to use, build or get information on Exim then have a
look at the pointers further down this file at L<General Exim Information>.

=head2 General Development Information

The general Exim development process and resources are documented in
the wiki page at L<http://wiki.exim.org/EximDevelopment> - although
the wiki is likely to be moved and rehashed in the near future.

The sections below this duplicate much of the information form the
wiki document.

=head2 Development Repositories

Exim development is kept within a  git (L<https://git-scm.com/>)
repository. The master repository is at L<git://git.exim.org/exim.git>
with a web interface giving change and source visibility at
L<https://git.exim.org/exim.git>

There is a secondary repository on github at
L<https://github.com/Exim/exim> managed by the Exim Organisation
- however this may currently fall out of synchronisation with the
main one.

=head2 Bug Tracking

Currently this is all done using Bugzilla at L<https://bugs.exim.org/>
- please do not use github issue tracking.

=head2 Mailing List

Development issues are normally discussed on the exim-dev mailing list
- see L<https://www.exim.org/maillist.html>

=head2 Exim Release Process

Some documentation on the release process can be found at
L<http://wiki.exim.org/EximRelease>.

=head2 General Exim Information

The best place to get general information is on the website at
L<https://www.exim.org/>.

You can find Download locations L<https://www.exim.org/mirrors.html>,
Mailing list info L<https://www.exim.org/maillist.html> and Full
Documentation L<https://www.exim.org/docs.html> on that website.

If you are using a Linux or other freely available Unix like operating
system it is very likely that your system will have Exim packaged for
it already. In this case it is probably prudent to use these packages
unless you have specialised requirements.

In any case you can always ask on the
Exim Users mailing list L<https://lists.exim.org/mailman3/postorius/lists/exim-users.lists.exim.org/>
for further information.

[End]

```

[Powered by Forgejo](https://forgejo.org)
Version:
9.0.3+gitea-1.22.0
Page: **41ms**
Template: **7ms**

 English
Bahasa Indonesia
Deutsch
English
Español
Esperanto
Filipino
Français
Italiano
Latviešu
Magyar nyelv
Nederlands
Polski
Português de Portugal
Português do Brasil
Slovenščina
Suomi
Svenska
Türkçe
Čeština
Ελληνικά
Български
Русский
Українська
فارسی
日本語
简体中文
繁體中文（台灣）
繁體中文（香港）
한국어

[Licenses](/assets/licenses.txt)
[API](/api/swagger)



=== Content from www.openwall.com_878de5d9_20250114_193100.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2023/12/24/2) [[next>]](2) [[<thread-prev]](../../../2023/12/24/1) [[thread-next>]](../../../2023/12/26/5) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <32345105-4692-465c-9a1d-e668c23df18d@hostland.ru>
Date: Mon, 25 Dec 2023 21:27:37 +0300
From: kai <kai@...tland.ru>
To: oss-security@...ts.openwall.com
Subject: Re: Re: New SMTP smuggling attack

Happy christmas list!

If anyone needs patch for postfix's 3.3.0-1ubuntu0.4
smtpd_forbid_bare_newline feature it has been attached to this message

On 24/12/2023 12.33, Marcus Meissner wrote:
> On Sat, Dec 23, 2023 at 02:29:34PM +0200, Valtteri Vuorikoski wrote:
>> On Fri, Dec 22, 2023 at 11:46:48AM +0100, Marcus Meissner wrote:
>>> Hi,
>>>
>>> FWIW as no CVEs were to be found yet, I filed a CVE request for Postfix now.
>>>
>>> Not sure if we need it for others like sendmail too, as that is also
>>> referenced by the security researchers.
>> Looks like exim opened a bug on this yesterday too, no sign of CVE yet:
>> <<https://bugs.exim.org/show_bug.cgi?id=3063>>
> CVEs are assigned now for:
>
> - CVE-2023-51764 postfix
> - CVE-2023-51765 sendmail
> - CVE-2023-51766 exim
>
> Ciao, Marcus
View attachment "[smtp-smuggling33.patch](1/1)" of type "text/x-patch" (6395 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.youtube.com_6c0f97f0_20250114_193133.html ===
[00:00] [Music]
[00:14] okay so the next talk is going to be by
[00:18] Teo longin also known as teimo login
[00:22] he's a security consultant and a
[00:23] researcher he will be talking about a
[00:25] new technique called SMTP smuggling for
[00:29] spoofing emails and exploit one of the
[00:31] most widely used services on the
[00:32] internet thank you give it up for
[00:35] [Applause]
[00:41] Timo thank you thank you for the
[00:43] introduction so first of all a big fat
[00:47] sorry for me personally and from Sault
[00:50] for this absolute dumpster fire of a
[00:53] vulnerability disclosure so specifically
[00:56] sorry to Vita and Victor for having to
[00:59] well fix post fix and to all the CIS
[01:03] admins Worldwide having to apply these
[01:05] fixes during Christmas
[01:07] holidays and also
[01:10] however yeah also however big thanks to
[01:15] V and Victor for their commitment and
[01:18] also big thanks to the community for
[01:21] pushing this issue for releasing tools
[01:24] and so on and for
[01:28] okay
[01:31] [Applause]
[01:35] and for everyone that has no idea what
[01:37] is going on let me catch you up to speed
[01:40] so about a year ago I was just finish
[01:43] finishing up some DNS research and I was
[01:45] looking for a new research Target when I
[01:49] probably found the easiest way to hack a
[01:52] company and all that just with one
[01:55] simple Google
[01:58] search
[02:00] and it might sound stupid but this led
[02:03] me into the direction of something that
[02:05] I already knew but I never really
[02:07] realized and that is that fishing is
[02:10] still the number one initial axis Vector
[02:13] into a company and then it hit me like
[02:16] why don't I look at SMTP the simple mail
[02:19] transfer protocol which is used to send
[02:21] like billions of emails each day across
[02:24] the globe for like the past 40 years so
[02:27] my journey went on from DNS to MTP and
[02:30] today I'm introducing SMTP smuggling a
[02:33] novel technique for spoing
[02:35] emails who am I my name is Timo longin I
[02:39] work as a security consultant at second
[02:41] SE consult and a day I do penetration
[02:44] tests and at night I do vulnerability
[02:46] research and for like the past 3 years
[02:49] I've been looking at lots of DNS
[02:51] vulnerabilities and I've published lots
[02:53] of blog posts and
[02:55] tools and yeah I had to move on and the
[02:59] last time time someone from Sault had a
[03:01] talk at the
[03:03] CCC it was about
[03:08] dildos and I know that I have to
[03:10] disappoint at least some of you but this
[03:13] talk is not about penetrating the human
[03:15] life
[03:16] form however it is about penetrating
[03:19] SMTP protocol barriers so to see how
[03:24] this works well we must first understand
[03:26] how sending emails in general works so
[03:29] here we have a pretty simple email
[03:31] infrastructure we have a mail user agent
[03:34] for example Thunderbird and Thunderbird
[03:36] like wants to send an email via user
[03:39] outlook.com for example so now if we
[03:42] want to send an email that way we must
[03:44] first authenticate against the Outlook
[03:47] mail transfer agent or outbound SMTP
[03:52] server and once we've authenticated
[03:54] we're now allowed to send an email as
[03:56] user
[03:58] outlook.com and and only as user
[04:01] outlook.com and this email then gets
[04:03] transferred over to the receiver inbound
[04:06] SMTP server and this inbound SMTP server
[04:09] is now checking the email for
[04:11] authenticity and the most popular way of
[04:14] doing this is via SPF so the receiver
[04:18] inbound server is basically getting the
[04:20] SPF record via DNS for outlook.com and
[04:24] then it sees okay these IP addresses and
[04:26] IP ranges are allowed to send emails for
[04:30] outlook.com and since in this case the
[04:32] legitimate Outlook SMTP server or
[04:35] outbound SMTP server sent the email well
[04:38] the inbound receiver accepts it and now
[04:42] of course there is well a very
[04:44] interesting question and the question is
[04:47] well is is it possible for an attacker
[04:50] to send an email for example from admin
[04:53] at outlook.com or from a spoofed email
[04:56] address and this is what we're going to
[04:58] look at today and that's more more or
[04:59] less the goal of This
[05:01] research and I don't know if you've
[05:03] realized but the colors of these servers
[05:06] and I cannot unced but they really
[05:08] remind me of SpongeBob and
[05:11] Patrick and therefore we're going to
[05:13] refer to them as
[05:15] such so the general goal of This
[05:18] research and the premise of this re
[05:20] research was like finding a way to spoof
[05:23] emails and I was like okay why not take
[05:26] vulnerabilities from other text based
[05:29] product protols like
[05:31] HTTP and put them into
[05:34] SMTP and there was just one HTTP
[05:37] vulnerability that really fit the bill
[05:40] and that is HTTP request
[05:43] smuggling and the thing is we again see
[05:46] we have SpongeBob and Patrick but in
[05:48] this case in the HTTP world so what
[05:51] happens here is SpongBob is getting a
[05:54] request a post request over the
[05:57] internet and the interesting thing about
[06:00] this post request is that it has two
[06:03] headers
[06:05] specifying how to handle the post
[06:07] requist data it has a Content length
[06:09] header specifying 43 bytes and it also
[06:12] has a transfer encoding header and now
[06:15] SpongeBob has to decide okay well how do
[06:17] I handle the post data now and SpongeBob
[06:20] decides to use the content length and
[06:23] since the content length is 43 bytes
[06:26] well all the red highlighted data is
[06:28] forwarded to p Patrick and Patrick is
[06:30] not like okay I have no idea what to do
[06:33] so am I interpreting the content length
[06:35] or the transfer en coding but now
[06:36] Patrick is interpreting the transfer
[06:38] encoding and now we have an
[06:40] interpretation
[06:41] difference SpongeBob uses the content
[06:44] length Patrick is using the transfer
[06:47] encoding and since the transfer encoding
[06:49] specifies chunked and the first chunk is
[06:51] zero well the rest of the data that
[06:54] SpongeBob transferred is now interpreted
[06:56] as a second request which which now
[06:59] basically means that SpongeBob sees one
[07:01] request and Patrick sees two requests
[07:04] and the second request can have like or
[07:06] can Target an arbitrary path like for
[07:09] example admin which in this example is
[07:11] only accessible
[07:13] internally which is of course a problem
[07:16] and I was like okay why not take these
[07:18] interpretation differences and put them
[07:20] into SMTP and to understand or to get
[07:24] close to understanding how this works at
[07:26] least we must first look at the SMTP
[07:30] protocol itself so SMTP basically looks
[07:33] like this we have two main components we
[07:35] have in red SMTP commands and we have in
[07:38] blue the message data and to send a
[07:42] message now we must first send the SMTP
[07:46] commands so we must first introduce
[07:48] ourselves we must specify a sender
[07:50] address one or more recipient addresses
[07:53] and then we send a data command to tell
[07:57] the receiving SMTP server to essentially
[08:01] yeah now receive the message data and
[08:04] then we send message data we specify a
[08:07] from address again we specify a two
[08:09] address we specify a subject and then
[08:12] comes the message body and at some point
[08:14] when we now want to stop transferring
[08:16] the message data we must send something
[08:19] that is called an end of data sequence
[08:22] which is a carage return line feed.
[08:25] carriage return line
[08:27] feed and now was like well maybe we can
[08:30] use that to somehow confuse SMTP server
[08:36] implementations and the idea was
[08:38] basically that we have SpongeBob again
[08:41] and we submit an email to
[08:44] SpongeBob and this email contains
[08:47] something very weird it is something
[08:49] that looks like an end of data sequence
[08:51] but it's not an end of data sequence
[08:54] because it's not RFC conform but like
[08:56] someone could mistake it for an end of
[08:59] data sequence so SpongeBob looks at this
[09:01] and it's like okay this is not the thing
[09:03] from the RFC I'm not going to interpret
[09:05] this as n of data sequence so the the
[09:08] next or the message data that follows to
[09:10] this is still like message data until
[09:12] the actual end of data sequence comes
[09:16] and now SpongeBob sends this over to
[09:18] Patrick and now Patrick is like uh yeah
[09:20] I don't really care about rfc's so what
[09:23] I do is well I interpret this fake end
[09:26] of data sequence as an actual end of
[09:28] data sequence
[09:29] and the problem here is that everything
[09:31] following this end of data sequence is
[09:33] now interpreted as SMTP
[09:36] commands and what we can do now as an
[09:39] attacker is we can specify SMTP commands
[09:42] that send another email so even though
[09:45] SpongeBob only saw one big email Patrick
[09:48] is now seeing two smaller emails and the
[09:51] problem is that the second email can
[09:54] have like arbitrary SMTP commands
[09:56] meaning it could come from admin at
[09:58] Outlook look.com or
[10:00] whatever so yeah that's the theory at
[10:04] least and to see if this really
[10:07] works I first of all checked out some
[10:10] SMTP server implementations by simply
[10:12] connecting to some servers via tnet or
[10:15] via
[10:16] netcat and when I did that and I sent
[10:19] the data command first of all it looked
[10:21] like very RFC conform so basically when
[10:25] you send the data command the server
[10:26] asks you to stop this data stream via
[10:29] carryer turn line feed. carer turn Line
[10:32] Feed but then I also found some servers
[10:34] that just say well just send me a DOT on
[10:37] Al line by itself and the thing with
[10:39] this do on Al line by itself is that
[10:41] it's very much dependent on the
[10:43] operating system that you're on meaning
[10:46] on Windows this could be a carriage
[10:48] return line feed. carriage return line
[10:50] feed on Linux this could be a line feed
[10:53] doline
[10:54] feed and at that point I I thought I was
[10:57] on to something so
[11:00] I checked something out and the first
[11:02] thing I tried is like using these kinds
[11:05] of line feeds Carriage returns dots and
[11:08] trying to like stuff them through
[11:10] SpongeBob so I wrote an SMTP analysis
[11:13] client which basically sends emails
[11:16] containing fake end of data sequences
[11:18] for example line feed. linefeed and I
[11:21] sent them through various kinds of SMTP
[11:23] software this includes email services
[11:25] like Gmail like Outlook like GMX but Al
[11:29] email software like send mail like
[11:31] postfix XM Microsoft uh Exchange Server
[11:34] and so on and now on the inbound side on
[11:38] the inbound receiver side I checked
[11:41] which fake sequences actually go through
[11:44] so can I send a line feed. line feed
[11:48] through an outbound server and in most
[11:51] cases it doesn't work like a line feed.
[11:54] line feed very often just gets filtered
[11:56] or removed from the initial email
[12:00] but in some
[12:01] cases it just goes through without a
[12:04] change and this was the case for GMX so
[12:08] basically I send an email from GMX to my
[12:11] analysis server and the line feed.
[12:13] carriage return line feed sequence did
[12:15] not get filtered whatsoever so now what
[12:17] I did is I created a proof of concept
[12:21] here where first of all we s an email
[12:23] then we have this fake end of data
[12:25] sequence and then we have SMTP commands
[12:28] and data for a second email so now if
[12:31] this proof of concept works we should
[12:33] receive two emails on our receiver end
[12:37] and I sent all of this to Gmail and
[12:39] Gmail was like yeah this is not an end
[12:42] of data sequence and you can see that
[12:45] because everything after this end of
[12:47] data sequence is still interpreted as
[12:48] message
[12:49] data but in some cases it actually works
[12:54] and this was the first case of
[12:56] successful SMTP smuggling so from GMX to
[13:00] FastMail and we can see that it works
[13:03] because well we have two emails we have
[13:04] first of all user at gmx.net and
[13:07] secondly an email from admin gmx.net
[13:10] that passes SPF and Demar checks as well
[13:13] because it comes from the actual server
[13:16] from
[13:19] [Applause]
[13:27] GMX and I was like okay this is super
[13:32] sick but I was thinking so we have this
[13:35] second email and everything can be in
[13:37] there like the sender address can be
[13:39] anything so why not try other domains
[13:43] that point to the server of
[13:46] GMX and then I analyzed the SPF record
[13:49] and I realized well there we have the
[13:52] GMX SPF record but this is very similar
[13:56] to the web de SP PF record which is also
[14:00] very similar to the one of
[14:02] yonos and the thing is that we can now
[14:05] spoof like 1.35 million domains with
[14:08] this so if you don't know yonos they're
[14:11] like a super big hosting provider and
[14:13] they also provide emailing services and
[14:15] yeah they have like all these 1.35
[14:17] million domains pointing here so yeah I
[14:22] had of course had to try this so here's
[14:24] an email from admin at
[14:27] webd and now of course there's a
[14:29] question of does this work everywhere
[14:32] because as I said this only works with
[14:35] servers that interpret well non RFC
[14:38] conform end of data sequences like line
[14:40] feed. carry to return
[14:41] linefeed so we can smuggle or spoof
[14:44] these 1.35 million domains to well some
[14:49] servers so essentially we have 1.4
[14:52] million postfix instances and like 150k
[14:55] sand mail instances and this works well
[14:58] because they interpret car interpret
[15:01] Line feed. Car linefeed confusing myself
[15:03] here as n of data
[15:06] sequence and I was like okay this is
[15:08] pretty severe but there is more so I
[15:12] looked at outlook.com as well and
[15:15] Outlook gave me a very weird uh error
[15:18] message because they were like bare line
[15:20] feeds are illegal and I was like oh damn
[15:23] they they know what I'm doing
[15:27] here
[15:29] and therefore I analyzed it like okay
[15:32] you're not going to scare me with that
[15:33] one so then I found out well line feed.
[15:36] carriage Line Feed is also possible
[15:48] here yeah so let's have some
[15:50] fun the thing is however at that point I
[15:52] wasn't really sure if I'm going insane
[15:54] or if this actually works so I needed
[15:56] some kind of Sanity check and
[15:59] therefore I sent an email from
[16:00] admin@outlook.com to some
[16:03] co-workers and the idea behind this is
[16:06] if they react to this it works otherwise
[16:09] I'm insane
[16:11] so
[16:16] yeah and maybe now for a more
[16:19] International example because this is
[16:21] very Austrian I guess I don't know so
[16:27] yeah
[16:30] I guess you also understand this if you
[16:32] don't speak
[16:33] German and now you might be like okay we
[16:36] can send text based spoofed emails but
[16:39] you're not going to like fool anyone
[16:41] with this but thing is like we can
[16:43] smuggle basically anything HTML included
[16:47] so here I sent an email a fishing email
[16:51] an an unusual signin activity email from
[16:54] no reply at outlook.com from the actual
[16:57] outlook.com server was to myself and it
[17:00] just went
[17:02] through yeah but again what's what's
[17:07] possible with this and I was wondering
[17:10] so we can spoof outlook.com but what
[17:13] what else can we do with this so I
[17:16] looked at the SPF record and it was well
[17:20] weird in terms of weirdly familiar
[17:23] because this is not only the SPF record
[17:25] of outlook.com but also the SPF record
[17:28] of like millions of other
[17:31] domains because this is actually like
[17:35] the SPF record from exchange online
[17:39] because outlook.com sends its emails
[17:41] well Across The Exchange online
[17:43] infrastructure so yeah now we can
[17:46] basically spoof them all so I again had
[17:49] to test this
[17:57] one
[18:06] but the thing is here this only worked
[18:08] on a technical level so I didn't get the
[18:12] race so what's the impact essentially we
[18:15] can spoof from millions of domains but
[18:18] who accepts these emails again post fix
[18:21] and send mail however only postfix and
[18:24] sand mail instances they do not support
[18:26] the bat command and the bat command is
[18:29] like an alternative to the data command
[18:31] and if that is supported it doesn't
[18:34] work so that was outbound SMTP smuggling
[18:38] so that is like one part of it but then
[18:40] there is also inbound SMTP smuggling and
[18:44] with outbound SMTP smuggling the issue
[18:46] was basically at the outbound server
[18:48] because the outbound server basically
[18:51] failed to filter or insufficiently
[18:53] filtered like fake end of data sequences
[18:56] like line feed. Carri feed so now with
[19:00] Microsoft and GMX and then there's also
[19:03] inbound SMTP smuggling and this happens
[19:06] when there is just an inbound server
[19:09] that interprets such a wild end of data
[19:12] sequence that the outbound server would
[19:15] never even get the idea of filtering
[19:17] that and I found exactly that with Cisco
[19:20] secure of course
[19:22] email Cloud
[19:25] Gateway so because what they do is they
[19:28] clean the message and every bare Line
[19:31] Feed and every bare Carri turn character
[19:34] now gets replaced with a carriage return
[19:36] line feed so essentially a carriage
[19:39] return. carriage return gets interpreted
[19:42] as end of data
[19:46] [Applause]
[19:53] sequence and the issue of course is now
[19:57] that this Carri return. carar return
[19:59] does not get filtered at all basically
[20:02] so there are of course some service that
[20:04] filter this but we have again exchange
[20:06] online iCloud sent mail postfix and so
[20:09] many others that just let this through
[20:11] and I guess it kind of makes sense to
[20:13] let this through because I wouldn't get
[20:14] the idea of filtering that
[20:16] either so I had to test this out
[20:20] again and unfortunately or well
[20:24] technically it worked again but I did
[20:25] not receive any Apple devices not that I
[20:28] wanted that anyways but
[20:33] yeah what's the impact here so
[20:35] essentially we can spoof from even more
[20:38] domains as before like we have exchange
[20:40] online we have iCloud we have all post
[20:43] fix and
[20:44] sendmail and we can spoof to companies
[20:48] that can actually afford this stuff so
[20:50] like pretty big companies here this also
[20:54] includes like 40 other uh 40K other
[20:57] domains and that that's only the ones
[20:59] that are hosted in a cloud so they're
[21:01] also on Prime but I wasn't able to
[21:03] enumerate
[21:05] them yeah and now to the part that's
[21:08] probably interesting to you or to the
[21:11] most at least so the responsible
[21:14] disclosure so essentially on a purely
[21:17] technical level regarding inbound and
[21:20] outbound servers who's at fault here so
[21:22] essentially we have inbound servers that
[21:24] are never supposed or not supposed to
[21:26] interpret anything else as end of data
[21:28] sequence then a carriage return line
[21:30] feed. carriage return line feed at least
[21:32] by the RFC and then there are outbound
[21:35] SMTP servers that are not supposed to
[21:37] send Carriage returns and line feeds
[21:40] independent of each other so yeah
[21:42] basically everyone's at fault so we sent
[21:44] that to GMX and they were like super
[21:47] thankful and they were like okay we're
[21:49] going to fix this right away 10 days
[21:51] later they fixed this they said okay can
[21:54] we recheck this we recheck this they
[21:56] actually fixed this they paid us a small
[21:59] Bounty they even put us in their back
[22:02] Bounty Hall of Fame and all all on like
[22:05] that was a 10 out of 10
[22:07] [Applause]
[22:14] experience I'm going to send them this
[22:16] clip of you clapping thank you and yeah
[22:20] it really felt like we should have paid
[22:22] them the back bound you because yeah but
[22:25] the thing is from here it just goes
[22:27] downhill
[22:29] so we have Microsoft and Microsoft was
[22:32] like yeah this is like a moderate risk
[22:35] vulnerability
[22:37] because I don't know I guess they have
[22:39] bigger fish to fry but yeah
[22:43] anyways so we sent it to them and like 3
[22:47] months later they closed the case and
[22:49] said yeah all right it's fixed no bnie
[22:52] whatsoever so okay but the thing is at
[22:55] that point well I already got what I
[22:57] want wanted and that's an email from
[23:00] admin
[23:04] microsoft.com and now to Cisco well
[23:07] Cisco was like okay this is not a
[23:09] vulnerability this is a documented and
[23:12] configurable
[23:23] [Applause]
[23:25] feature and we were like okay that's a
[23:27] weird feature because
[23:30] like we can spoof some emails with that
[23:34] so yeah we said okay at least like tell
[23:37] your customers about this feature that
[23:39] it's maybe not the best default feature
[23:42] but yeah
[23:44] anyways yeah they said
[23:47] no
[23:49] yeah so then we were like okay we got
[23:52] this whole big SMTP smuggling issue
[23:54] Cisco doesn't want to fix anything
[23:56] Microsoft at that point was was
[23:58] vulnerable and we take this case to C CC
[24:02] and C CC for all of you that don't know
[24:04] that is the C coordination Center and
[24:07] they basically handle all these big
[24:08] vulnerabilities so that could have a
[24:10] worldwide impact and we sent this to
[24:12] them and they actually accepted the case
[24:15] and now you're like in this Vince portal
[24:18] this which is basically a big glorified
[24:20] chat room with 14 vendors we have like
[24:23] sent mail Microsoft Cisco uh Google in
[24:26] there and yeah so now you can start
[24:29] talking about the vulnerability and the
[24:31] first conversation was basically with
[24:33] Cisco still saying that they're not
[24:35] vulnerable you know yeah it's not a bug
[24:38] it's a feature and yeah essentially they
[24:42] were still like it's not a vulnerability
[24:44] and then sis uh CC was like yeah this is
[24:47] not a vulnerability for some reason okay
[24:50] so what about the general SMTP smuggling
[24:53] problem so what about postfix and sent
[24:56] mail interpreting non RFC conform and of
[24:58] data
[25:00] sequences so first of all sent mail was
[25:02] in this Vince portal to begin with so
[25:05] from the start they got all the puc's
[25:07] all the messages all yeah everything and
[25:11] they were like they didn't say anything
[25:14] and then what about postfix because
[25:17] they're 10 times larger essentially C CC
[25:20] was like first of all I don't know why
[25:22] they didn't add them to the case
[25:24] directly but they sent them an email or
[25:27] contacted them VI email but forgot to
[25:29] mention SMTP smuggling so now we're here
[25:33] thinking that they told po so we thought
[25:35] that they told postfix sent mail
[25:37] apparently didn't care C CC sides with
[25:41] Cisco regarding this feature so now
[25:44] we're like okay CIS uh Cisco yeah is
[25:47] definitely vulnerable we've confirmed
[25:49] that so we would like to publish this
[25:51] any blog post and that's where all the
[25:53] problem
[25:54] starts so we said okay okay we would
[25:58] like to publish this any blog post and
[26:00] we would warn Cisco customers about the
[26:02] feature and CC is like go ahead so just
[26:08] send us the link to the blog post once
[26:10] this is
[26:11] published and we were like yeah we go
[26:15] ahead with that and now basically we
[26:17] opened Pandora's Box because now 1.6
[26:21] million post M uh post fix and send mail
[26:24] instances on the internet are vulnerable
[26:26] meaning now if there is another case of
[26:29] outbound SMTP smuggling you can smuggle
[26:32] to post fix and send mail
[26:35] still does that mean second consult is
[26:37] not at fault at all of course sa consult
[26:39] is at fault because we published this
[26:41] blog post thinking that the impact of
[26:44] all of this is way lower than it
[26:46] actually is based on our great
[26:49] conversation with CTC and Vince in
[26:51] general and also if we would have just
[26:54] double checked that with postfix that
[26:56] this is really not not an issue none of
[26:58] this would have happened because postfix
[27:00] is very adamant about the fact that this
[27:02] is actually an
[27:03] issue so yeah in conclusion what does
[27:07] this mean please fix your postfix
[27:09] service you can find more information
[27:11] about that on the postfix website also
[27:14] please fix your Cisco service you can
[27:16] find more information about that on the
[27:18] second consult blog
[27:26] post
[27:30] [Applause]
[27:31] in the end however there is some kind of
[27:34] Sil Silver Lining at least because now
[27:36] postfix is directly in the Vince case
[27:39] and they've already made some great
[27:41] contributions so we're not putting our
[27:43] head in the sand and we're actively
[27:44] somehow trying to close Pandora's Box
[27:47] again and what does that mean
[27:49] essentially more research on like SMTP
[27:53] smuggling I mean asked straty before to
[27:55] like look at this more but yeah this
[27:58] didn't really end well and more blog
[28:01] posts more research first first and
[28:03] foremost um more vendors in the Vince
[28:06] case so we're trying to get everything
[28:08] fixed right now and again we are very
[28:10] sorry that this happened in the first
[28:13] place and
[28:16] finally something that probably all of
[28:18] you know anyways do not trust emails
[28:22] blindly especially not
[28:26] now thank you
[28:38] [Applause]
[28:45] nice thank you let's go with the Q&A um
[28:48] please go ahead hello I one small
[28:52] question the C CC stuff was this
[28:55] communicated via email and could you not
[28:59] have sent the mail at Cisco
[29:02] CD um yeah I mean we could have done
[29:06] that and created some kind of love
[29:07] triangle between Bill Gates Elon Musk
[29:10] and someone else I guess
[29:13] but yeah no we didn't see this email
[29:16] unfortunately like we saw it after that
[29:19] yeah but then it was kind of too late
[29:24] unfortunately uh hi thank you appreciate
[29:27] the work um can you maybe tell us a
[29:30] little bit about the timeline like when
[29:33] did you first discover this like how
[29:35] fresh this was first discovered so I
[29:38] started the research in June this year
[29:41] so basically we I had a research project
[29:43] at Sault for like 10 days and I was like
[29:46] okay these 10 days they're not going to
[29:47] be enough so I started 10 days earlier
[29:50] and then I like found SMTP smuggling on
[29:54] day six and yeah then it just goes on
[29:57] from telling this GMX Outlook or
[30:01] Microsoft and Cisco because they had
[30:04] these severe cases of SMTP smuggling
[30:06] meaning outbound and inbound and then we
[30:08] went ahead and told this to cery because
[30:10] there seems to be a general issue with
[30:13] SMTP smuggling worldwide and timeline
[30:16] wise I don't have it here right now but
[30:18] it is in the second Sal blog post and
[30:22] yeah but is is there a specific date
[30:25] that you want to know no no just I'll
[30:27] check the blog post
[30:29] thanks
[30:31] one hello um thank you for the good talk
[30:37] here um I wanted to ask is there any
[30:39] evidence or any suggestions that this
[30:42] has been used already um because this
[30:46] seems like a well pretty easy exploit to
[30:50] use so I might imagine it has been used
[30:53] already yeah I've mean I mean I received
[30:56] some comments on on my Reddit post and
[30:58] it was like yeah this is super old but
[31:01] thing
[31:02] is medium severity yeah probably no I I
[31:07] don't know I don't know really I I
[31:09] looked at lots of research but nothing
[31:11] really said otherwise so that's why I
[31:13] called it the novel vulnerability so I
[31:15] don't
[31:26] know
[31:27] [Music]
[31:38] la

=== Content from www.openwall.com_3923fad0_20250114_193101.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[thread-next>]](../../../2024/01/01/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20231229130718.GA6740@openwall.com>
Date: Fri, 29 Dec 2023 14:07:18 +0100
From: Solar Designer <solar@...nwall.com>
To: oss-security@...ts.openwall.com
Subject: CVE-2023-51766: Exim: SMTP smuggling

Hi,

Exim was also susceptible to SMTP smuggling, and version 4.97.1 is now
released to address this.  Included below is doc/doc-txt/cve-2023-51766
from the exim-4.97.1 branch (with erroneous Date: line omitted).

Alexander

---
CVE ID:     CVE-2023-51766
Credits:    <https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/>
Version(s): all up to 4.97 inclusive
Issue:      Given a buggy relay, Exim can be induced to accept a second message embedded
            as part of the body of a first message

Conditions
==========

If *all* the following conditions are met

    Runtime options
    ---------------

    * Exim offers PIPELINING on incoming connections

    * Exim offers CHUNKING on incoming connections

    Operation
    ---------

    * DATA (as opposed to BDAT) is used for a message reception

    * The relay host sends to the Exim MTA message data including
      one of "LF . LF" or "CR LF . LF" or "LF . CR LF".

    * Exim interprets the sequence as signalling the end of data for
      the SMTP DATA command, and hence a first message.

    * Exim interprets further input which the relay had as message body
      data, as SMTP commands and data. This could include a MAIL, RCPT,
      BDAT (etc) sequence, resulting in a further message acceptance.

Impact
======

One or more messages can be accepted by Exim that have not been
properly validated by the buggy relay.

Fix
===

Install a fixed Exim version:

    4.98 (once available)
    4.97.1

If you can't install one of the above versions, ask your package
maintainer for a version containing the backported fix. On request and
depending on our resources we will support you in backporting the fix.
(Please note, that Exim project officially doesn't support versions
prior the current stable version.)

Workaround
==========

  Disable CHUNKING advertisement for incoming connections.

  An attempt to "smuggle" a DATA command will trip a syncronisation
  check.

*or*

  Disable PIPELINING advertisement for incoming connections.

  The "smuggled" MAIL FROM command will then trip a syncronisation
  check.

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_aed37d0a_20250114_193109.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FExim%2Fexim%2Fblob%2Fmaster%2Fdoc%2Fdoc-txt%2Fcve-2023-51766)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FExim%2Fexim%2Fblob%2Fmaster%2Fdoc%2Fdoc-txt%2Fcve-2023-51766)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=Exim%2Fexim)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Exim](/Exim)
/
**[exim](/Exim/exim)**
Public

* [Notifications](/login?return_to=%2FExim%2Fexim) You must be signed in to change notification settings
* [Fork
  179](/login?return_to=%2FExim%2Fexim)
* [Star
   745](/login?return_to=%2FExim%2Fexim)

* [Code](/Exim/exim)
* [Pull requests
  23](/Exim/exim/pulls)
* [Actions](/Exim/exim/actions)
* [Projects
  0](/Exim/exim/projects)
* [Wiki](/Exim/exim/wiki)
* [Security](/Exim/exim/security)
* [Insights](/Exim/exim/pulse)

Additional navigation options

* [Code](/Exim/exim)
* [Pull requests](/Exim/exim/pulls)
* [Actions](/Exim/exim/actions)
* [Projects](/Exim/exim/projects)
* [Wiki](/Exim/exim/wiki)
* [Security](/Exim/exim/security)
* [Insights](/Exim/exim/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_ce509f34_20250114_193130.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](1) [[thread-next>]](../../../2023/12/24/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <croalohbjdjf2cb6e5ol2l7rsdoxd6mr4mw55lyzzf7ljkkx5a@czm7be4dpjj4>
Date: Sat, 23 Dec 2023 14:29:34 +0200
From: Valtteri Vuorikoski <vuori@...com.org>
To: oss-security@...ts.openwall.com
Subject: Re: Re: New SMTP smuggling attack

On Fri, Dec 22, 2023 at 11:46:48AM +0100, Marcus Meissner wrote:
> Hi,
>
> FWIW as no CVEs were to be found yet, I filed a CVE request for Postfix now.
>
> Not sure if we need it for others like sendmail too, as that is also
> referenced by the security researchers.

Looks like exim opened a bug on this yesterday too, no sign of CVE yet:
<<https://bugs.exim.org/show_bug.cgi?id=3063>>

 -Valtteri

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.rfc-editor.org_68446fbf_20250115_114619.html ===

[[RFC Home](https://www.rfc-editor.org "RFC Editor")] [[TEXT](/rfc/rfc5321.txt)|[PDF](/rfc/pdfrfc/rfc5321.txt.pdf)|[HTML](/rfc/rfc5321.html)] [[Tracker](https://datatracker.ietf.org/doc/rfc5321 "IETF Datatracker information for this document")] [[IPR](https://datatracker.ietf.org/ipr/search/?rfc=5321&submit=rfc "IPR disclosures related to this document")] [[Errata](/errata/rfc5321)] [[Info page](https://www.rfc-editor.org/info/rfc5321 "Info page")]

 DRAFT STANDARD
Updated by: [7504](/rfc/rfc7504) Errata Exist
```
Network Working Group                                         J. Klensin
Request for Comments: 5321                                  October 2008
Obsoletes: [2821](./rfc2821)
Updates: [1123](./rfc1123)
Category: Standards Track

                     Simple Mail Transfer Protocol

Status of This Memo

   This document specifies an Internet standards track protocol for the
   Internet community, and requests discussion and suggestions for
   improvements.  Please refer to the current edition of the "Internet
   Official Protocol Standards" (STD 1) for the standardization state
   and status of this protocol.  Distribution of this memo is unlimited.

Abstract

   This document is a specification of the basic protocol for Internet
   electronic mail transport.  It consolidates, updates, and clarifies
   several previous documents, making all or parts of most of them
   obsolete.  It covers the SMTP extension mechanisms and best practices
   for the contemporary Internet, but does not provide details about
   particular extensions.  Although SMTP was designed as a mail
   transport and delivery protocol, this specification also contains
   information that is important to its use as a "mail submission"
   protocol for "split-UA" (User Agent) mail reading systems and mobile
   environments.

Klensin                     Standards Track                     [Page 1]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

Table of Contents

   [1](#section-1).  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  [5](#page-5)
     [1.1](#section-1.1).  Transport of Electronic Mail . . . . . . . . . . . . . . .  [5](#page-5)
     [1.2](#section-1.2).  History and Context for This Document  . . . . . . . . . .  [5](#page-5)
     [1.3](#section-1.3).  Document Conventions . . . . . . . . . . . . . . . . . . .  [6](#page-6)
   [2](#section-2).  The SMTP Model . . . . . . . . . . . . . . . . . . . . . . . .  [7](#page-7)
     [2.1](#section-2.1).  Basic Structure  . . . . . . . . . . . . . . . . . . . . .  [7](#page-7)
     [2.2](#section-2.2).  The Extension Model  . . . . . . . . . . . . . . . . . . .  [9](#page-9)
       [2.2.1](#section-2.2.1).  Background . . . . . . . . . . . . . . . . . . . . . .  [9](#page-9)
       [2.2.2](#section-2.2.2).  Definition and Registration of Extensions  . . . . . . [10](#page-10)
       [2.2.3](#section-2.2.3).  Special Issues with Extensions . . . . . . . . . . . . [11](#page-11)
     [2.3](#section-2.3).  SMTP Terminology . . . . . . . . . . . . . . . . . . . . . [11](#page-11)
       [2.3.1](#section-2.3.1).  Mail Objects . . . . . . . . . . . . . . . . . . . . . [11](#page-11)
       [2.3.2](#section-2.3.2).  Senders and Receivers  . . . . . . . . . . . . . . . . [12](#page-12)
       [2.3.3](#section-2.3.3).  Mail Agents and Message Stores . . . . . . . . . . . . [12](#page-12)
       [2.3.4](#section-2.3.4).  Host . . . . . . . . . . . . . . . . . . . . . . . . . [13](#page-13)
       [2.3.5](#section-2.3.5).  Domain Names . . . . . . . . . . . . . . . . . . . . . [13](#page-13)
       [2.3.6](#section-2.3.6).  Buffer and State Table . . . . . . . . . . . . . . . . [14](#page-14)
       [2.3.7](#section-2.3.7).  Commands and Replies . . . . . . . . . . . . . . . . . [14](#page-14)
       [2.3.8](#section-2.3.8).  Lines  . . . . . . . . . . . . . . . . . . . . . . . . [14](#page-14)
       [2.3.9](#section-2.3.9).  Message Content and Mail Data  . . . . . . . . . . . . [15](#page-15)
       [2.3.10](#section-2.3.10). Originator, Delivery, Relay, and Gateway Systems . . . [15](#page-15)
       [2.3.11](#section-2.3.11). Mailbox and Address  . . . . . . . . . . . . . . . . . [15](#page-15)
     [2.4](#section-2.4).  General Syntax Principles and Transaction Model  . . . . . [16](#page-16)
   [3](#section-3).  The SMTP Procedures: An Overview . . . . . . . . . . . . . . . [17](#page-17)
     [3.1](#section-3.1).  Session Initiation . . . . . . . . . . . . . . . . . . . . [18](#page-18)
     [3.2](#section-3.2).  Client Initiation  . . . . . . . . . . . . . . . . . . . . [18](#page-18)
     [3.3](#section-3.3).  Mail Transactions  . . . . . . . . . . . . . . . . . . . . [19](#page-19)
     [3.4](#section-3.4).  Forwarding for Address Correction or Updating  . . . . . . [21](#page-21)
     [3.5](#section-3.5).  Commands for Debugging Addresses . . . . . . . . . . . . . [22](#page-22)
       [3.5.1](#section-3.5.1).  Overview . . . . . . . . . . . . . . . . . . . . . . . [22](#page-22)
       [3.5.2](#section-3.5.2).  VRFY Normal Response . . . . . . . . . . . . . . . . . [24](#page-24)
       [3.5.3](#section-3.5.3).  Meaning of VRFY or EXPN Success Response . . . . . . . [25](#page-25)
       [3.5.4](#section-3.5.4).  Semantics and Applications of EXPN . . . . . . . . . . [26](#page-26)
     [3.6](#section-3.6).  Relaying and Mail Routing  . . . . . . . . . . . . . . . . [26](#page-26)
       [3.6.1](#section-3.6.1).  Source Routes and Relaying . . . . . . . . . . . . . . [26](#page-26)
       [3.6.2](#section-3.6.2).  Mail eXchange Records and Relaying . . . . . . . . . . [26](#page-26)
       [3.6.3](#section-3.6.3).  Message Submission Servers as Relays . . . . . . . . . [27](#page-27)
     [3.7](#section-3.7).  Mail Gatewaying  . . . . . . . . . . . . . . . . . . . . . [28](#page-28)
       [3.7.1](#section-3.7.1).  Header Fields in Gatewaying  . . . . . . . . . . . . . [28](#page-28)
       [3.7.2](#section-3.7.2).  Received Lines in Gatewaying . . . . . . . . . . . . . [29](#page-29)
       [3.7.3](#section-3.7.3).  Addresses in Gatewaying  . . . . . . . . . . . . . . . [29](#page-29)
       [3.7.4](#section-3.7.4).  Other Header Fields in Gatewaying  . . . . . . . . . . [29](#page-29)
       [3.7.5](#section-3.7.5).  Envelopes in Gatewaying  . . . . . . . . . . . . . . . [30](#page-30)
     [3.8](#section-3.8).  Terminating Sessions and Connections . . . . . . . . . . . [30](#page-30)
     [3.9](#section-3.9).  Mailing Lists and Aliases  . . . . . . . . . . . . . . . . [31](#page-31)
       [3.9.1](#section-3.9.1).  Alias  . . . . . . . . . . . . . . . . . . . . . . . . [31](#page-31)

Klensin                     Standards Track                     [Page 2]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

       [3.9.2](#section-3.9.2).  List . . . . . . . . . . . . . . . . . . . . . . . . . [31](#page-31)
   [4](#section-4).  The SMTP Specifications  . . . . . . . . . . . . . . . . . . . [32](#page-32)
     [4.1](#section-4.1).  SMTP Commands  . . . . . . . . . . . . . . . . . . . . . . [32](#page-32)
       [4.1.1](#section-4.1.1).  Command Semantics and Syntax . . . . . . . . . . . . . [32](#page-32)
       [4.1.2](#section-4.1.2).  Command Argument Syntax  . . . . . . . . . . . . . . . [41](#page-41)
       [4.1.3](#section-4.1.3).  Address Literals . . . . . . . . . . . . . . . . . . . [43](#page-43)
       [4.1.4](#section-4.1.4).  Order of Commands  . . . . . . . . . . . . . . . . . . [44](#page-44)
       [4.1.5](#section-4.1.5).  Private-Use Commands . . . . . . . . . . . . . . . . . [46](#page-46)
     [4.2](#section-4.2).  SMTP Replies . . . . . . . . . . . . . . . . . . . . . . . [46](#page-46)
       [4.2.1](#section-4.2.1).  Reply Code Severities and Theory . . . . . . . . . . . [48](#page-48)
       [4.2.2](#section-4.2.2).  Reply Codes by Function Groups . . . . . . . . . . . . [50](#page-50)
       [4.2.3](#section-4.2.3).  Reply Codes in Numeric Order . . . . . . . . . . . . . [52](#page-52)
       [4.2.4](#section-4.2.4).  Reply Code 502 . . . . . . . . . . . . . . . . . . . . [53](#page-53)
       4.2.5.  Reply Codes after DATA and the Subsequent
               <CRLF>.<CRLF>  . . . . . . . . . . . . . . . . . . . . [53](#page-53)
     [4.3](#section-4.3).  Sequencing of Commands and Replies . . . . . . . . . . . . [54](#page-54)
       [4.3.1](#section-4.3.1).  Sequencing Overview  . . . . . . . . . . . . . . . . . [54](#page-54)
       [4.3.2](#section-4.3.2).  Command-Reply Sequences  . . . . . . . . . . . . . . . [55](#page-55)
     [4.4](#section-4.4).  Trace Information  . . . . . . . . . . . . . . . . . . . . [57](#page-57)
     [4.5](#section-4.5).  Additional Implementation Issues . . . . . . . . . . . . . [61](#page-61)
       [4.5.1](#section-4.5.1).  Minimum Implementation . . . . . . . . . . . . . . . . [61](#page-61)
       [4.5.2](#section-4.5.2).  Transparency . . . . . . . . . . . . . . . . . . . . . [62](#page-62)
       [4.5.3](#section-4.5.3).  Sizes and Timeouts . . . . . . . . . . . . . . . . . . [62](#page-62)
         [4.5.3.1](#section-4.5.3.1).  Size Limits and Minimums . . . . . . . . . . . . . [62](#page-62)
           [4.5.3.1.1](#section-4.5.3.1.1).  Local-part . . . . . . . . . . . . . . . . . . [63](#page-63)
           [4.5.3.1.2](#section-4.5.3.1.2).  Domain . . . . . . . . . . . . . . . . . . . . [63](#page-63)
           [4.5.3.1.3](#section-4.5.3.1.3).  Path . . . . . . . . . . . . . . . . . . . . . [63](#page-63)
           [4.5.3.1.4](#section-4.5.3.1.4).  Command Line . . . . . . . . . . . . . . . . . [63](#page-63)
           [4.5.3.1.5](#section-4.5.3.1.5).  Reply Line . . . . . . . . . . . . . . . . . . [63](#page-63)
           [4.5.3.1.6](#section-4.5.3.1.6).  Text Line  . . . . . . . . . . . . . . . . . . [63](#page-63)
           [4.5.3.1.7](#section-4.5.3.1.7).  Message Content  . . . . . . . . . . . . . . . [63](#page-63)
           [4.5.3.1.8](#section-4.5.3.1.8).  Recipients Buffer  . . . . . . . . . . . . . . [64](#page-64)
           [4.5.3.1.9](#section-4.5.3.1.9).  Treatment When Limits Exceeded . . . . . . . . [64](#page-64)
           [4.5.3.1.10](#section-4.5.3.1.10). Too Many Recipients Code . . . . . . . . . . . [64](#page-64)
         [4.5.3.2](#section-4.5.3.2).  Timeouts . . . . . . . . . . . . . . . . . . . . . [65](#page-65)
           [4.5.3.2.1](#section-4.5.3.2.1).  Initial 220 Message: 5 Minutes . . . . . . . . [65](#page-65)
           [4.5.3.2.2](#section-4.5.3.2.2).  MAIL Command: 5 Minutes  . . . . . . . . . . . [65](#page-65)
           [4.5.3.2.3](#section-4.5.3.2.3).  RCPT Command: 5 Minutes  . . . . . . . . . . . [65](#page-65)
           [4.5.3.2.4](#section-4.5.3.2.4).  DATA Initiation: 2 Minutes . . . . . . . . . . [66](#page-66)
           [4.5.3.2.5](#section-4.5.3.2.5).  Data Block: 3 Minutes  . . . . . . . . . . . . [66](#page-66)
           4.5.3.2.6.  DATA Termination: 10 Minutes.  . . . . . . . . [66](#page-66)
           [4.5.3.2.7](#section-4.5.3.2.7).  Server Timeout: 5 Minutes. . . . . . . . . . . [66](#page-66)
       [4.5.4](#section-4.5.4).  Retry Strategies . . . . . . . . . . . . . . . . . . . [66](#page-66)
       [4.5.5](#section-4.5.5).  Messages with a Null Reverse-Path  . . . . . . . . . . [68](#page-68)
   [5](#section-5).  Address Resolution and Mail Handling . . . . . . . . . . . . . [69](#page-69)
     [5.1](#section-5.1).  Locating the Target Host . . . . . . . . . . . . . . . . . [69](#page-69)
     [5.2](#section-5.2).  IPv6 and MX Records  . . . . . . . . . . . . . . . . . . . [71](#page-71)
   [6](#section-6).  Problem Detection and Handling . . . . . . . . . . . . . . . . [71](#page-71)

Klensin                     Standards Track                     [Page 3]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

     [6.1](#section-6.1).  Reliable Delivery and Replies by Email . . . . . . . . . . [71](#page-71)
     [6.2](#section-6.2).  Unwanted, Unsolicited, and "Attack" Messages . . . . . . . [72](#page-72)
     [6.3](#section-6.3).  Loop Detection . . . . . . . . . . . . . . . . . . . . . . [73](#page-73)
     [6.4](#section-6.4).  Compensating for Irregularities  . . . . . . . . . . . . . [73](#page-73)
   [7](#section-7).  Security Considerations  . . . . . . . . . . . . . . . . . . . [75](#page-75)
     [7.1](#section-7.1).  Mail Security and Spoofing . . . . . . . . . . . . . . . . [75](#page-75)
     [7.2](#section-7.2).  "Blind" Copies . . . . . . . . . . . . . . . . . . . . . . [76](#page-76)
     [7.3](#section-7.3).  VRFY, EXPN, and Security . . . . . . . . . . . . . . . . . [76](#page-76)
     [7.4](#section-7.4).  Mail Rerouting Based on the 251 and 551 Response Codes . . [77](#page-77)
     [7.5](#section-7.5).  Information Disclosure in Announcements  . . . . . . . . . [77](#page-77)
     [7.6](#section-7.6).  Information Disclosure in Trace Fields . . . . . . . . . . [78](#page-78)
     [7.7](#section-7.7).  Information Disclosure in Message Forwarding . . . . . . . [78](#page-78)
     [7.8](#section-7.8).  Resistance to Attacks  . . . . . . . . . . . . . . . . . . [78](#page-78)
     [7.9](#section-7.9).  Scope of Operation of SMTP Servers . . . . . . . . . . . . [78](#page-78)
   [8](#section-8).  IANA Considerations  . . . . . . . . . . . . . . . . . . . . . [79](#page-79)
   [9](#section-9).  Acknowledgments  . . . . . . . . . . . . . . . . . . . . . . . [80](#page-80)
   [10](#section-10). References . . . . . . . . . . . . . . . . . . . . . . . . . . [81](#page-81)
     [10.1](#section-10.1). Normative References . . . . . . . . . . . . . . . . . . . [81](#page-81)
     [10.2](#section-10.2). Informative References . . . . . . . . . . . . . . . . . . [82](#page-82)
   [Appendix A](#appendix-A).  TCP Transport Service . . . . . . . . . . . . . . . . [85](#page-85)
   [Appendix B](#appendix-B).  Generating SMTP Commands from [RFC 822](./rfc822) Header
                Fields  . . . . . . . . . . . . . . . . . . . . . . . [85](#page-85)
   [Appendix C](#appendix-C).  Source Routes . . . . . . . . . . . . . . . . . . . . [86](#page-86)
   [Appendix D](#appendix-D).  Scenarios . . . . . . . . . . . . . . . . . . . . . . [87](#page-87)
     [D.1](#appendix-D.1).  A Typical SMTP Transaction Scenario  . . . . . . . . . . . [88](#page-88)
     [D.2](#appendix-D.2).  Aborted SMTP Transaction Scenario  . . . . . . . . . . . . [89](#page-89)
     [D.3](#appendix-D.3).  Relayed Mail Scenario  . . . . . . . . . . . . . . . . . . [90](#page-90)
     [D.4](#appendix-D.4).  Verifying and Sending Scenario . . . . . . . . . . . . . . [92](#page-92)
   [Appendix E](#appendix-E).  Other Gateway Issues  . . . . . . . . . . . . . . . . [92](#page-92)
   [Appendix F](#appendix-F).  Deprecated Features of [RFC 821](./rfc821)  . . . . . . . . . . . [93](#page-93)
     [F.1](#appendix-F.1).  TURN . . . . . . . . . . . . . . . . . . . . . . . . . . . [93](#page-93)
     [F.2](#appendix-F.2).  Source Routing . . . . . . . . . . . . . . . . . . . . . . [93](#page-93)
     [F.3](#appendix-F.3).  HELO . . . . . . . . . . . . . . . . . . . . . . . . . . . [93](#page-93)
     [F.4](#appendix-F.4).  #-literals . . . . . . . . . . . . . . . . . . . . . . . . [94](#page-94)
     [F.5](#appendix-F.5).  Dates and Years  . . . . . . . . . . . . . . . . . . . . . [94](#page-94)
     [F.6](#appendix-F.6).  Sending versus Mailing . . . . . . . . . . . . . . . . . . [94](#page-94)

Klensin                     Standards Track                     [Page 4]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[1](#section-1).  Introduction

[1.1](#section-1.1).  Transport of Electronic Mail

   The objective of the Simple Mail Transfer Protocol (SMTP) is to
   transfer mail reliably and efficiently.

   SMTP is independent of the particular transmission subsystem and
   requires only a reliable ordered data stream channel.  While this
   document specifically discusses transport over TCP, other transports
   are possible.  Appendices to [RFC 821](./rfc821) [[1](#ref-1 "\"Simple Mail Transfer Protocol\"")] describe some of them.

   An important feature of SMTP is its capability to transport mail
   across multiple networks, usually referred to as "SMTP mail relaying"
   (see [Section 3.6](#section-3.6)).  A network consists of the mutually-TCP-accessible
   hosts on the public Internet, the mutually-TCP-accessible hosts on a
   firewall-isolated TCP/IP Intranet, or hosts in some other LAN or WAN
   environment utilizing a non-TCP transport-level protocol.  Using
   SMTP, a process can transfer mail to another process on the same
   network or to some other network via a relay or gateway process
   accessible to both networks.

   In this way, a mail message may pass through a number of intermediate
   relay or gateway hosts on its path from sender to ultimate recipient.
   The Mail eXchanger mechanisms of the domain name system ([RFC 1035](./rfc1035)
   [[2](#ref-2 "\"Domain names - implementation and specification\"")], [RFC 974](./rfc974) [[12](#ref-12 "\"Mail routing and the domain system\"")], and [Section 5](#section-5) of this document) are used to
   identify the appropriate next-hop destination for a message being
   transported.

[1.2](#section-1.2).  History and Context for This Document

   This document is a specification of the basic protocol for the
   Internet electronic mail transport.  It consolidates, updates and
   clarifies, but does not add new or change existing functionality of
   the following:

   o  the original SMTP (Simple Mail Transfer Protocol) specification of
      [RFC 821](./rfc821) [[1](#ref-1 "\"Simple Mail Transfer Protocol\"")],

   o  domain name system requirements and implications for mail
      transport from [RFC 1035](./rfc1035) [[2](#ref-2 "\"Domain names - implementation and specification\"")] and [RFC 974](./rfc974) [[12](#ref-12 "\"Mail routing and the domain system\"")],

   o  the clarifications and applicability statements in [RFC 1123](./rfc1123) [[3](#ref-3 "\"Requirements for Internet Hosts - Application and Support\"")],
      and

   o  material drawn from the SMTP Extension mechanisms in [RFC 1869](./rfc1869)
      [[13](#ref-13 "\"SMTP Service Extensions\"")].

Klensin                     Standards Track                     [Page 5]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   o  Editorial and clarification changes to [RFC 2821](./rfc2821) [[14](#ref-14 "\"Simple Mail Transfer Protocol\"")] to bring that
      specification to Draft Standard.

   It obsoletes [RFC 821](./rfc821), [RFC 974](./rfc974), [RFC 1869](./rfc1869), and [RFC 2821](./rfc2821) and updates [RFC](./rfc1123)
   [1123](./rfc1123) (replacing the mail transport materials of [RFC 1123](./rfc1123)).  However,
   [RFC 821](./rfc821) specifies some features that were not in significant use in
   the Internet by the mid-1990s and (in appendices) some additional
   transport models.  Those sections are omitted here in the interest of
   clarity and brevity; readers needing them should refer to [RFC 821](./rfc821).

   It also includes some additional material from [RFC 1123](./rfc1123) that required
   amplification.  This material has been identified in multiple ways,
   mostly by tracking flaming on various lists and newsgroups and
   problems of unusual readings or interpretations that have appeared as
   the SMTP extensions have been deployed.  Where this specification
   moves beyond consolidation and actually differs from earlier
   documents, it supersedes them technically as well as textually.

   Although SMTP was designed as a mail transport and delivery protocol,
   this specification also contains information that is important to its
   use as a "mail submission" protocol, as recommended for Post Office
   Protocol (POP) ([RFC 937](./rfc937) [[15](#ref-15 "\"Post Office Protocol: Version 2\"")], [RFC 1939](./rfc1939) [[16](#ref-16 "\"Post Office Protocol - Version 3\"")]) and IMAP ([RFC 3501](./rfc3501)
   [[17](#ref-17 "\"INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1\"")]).  In general, the separate mail submission protocol specified
   in [RFC 4409](./rfc4409) [[18](#ref-18 "\"Message Submission for Mail\"")] is now preferred to direct use of SMTP; more
   discussion of that subject appears in that document.

   [Section 2.3](#section-2.3) provides definitions of terms specific to this document.
   Except when the historical terminology is necessary for clarity, this
   document uses the current 'client' and 'server' terminology to
   identify the sending and receiving SMTP processes, respectively.

   A companion document, [RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")], discusses message header sections
   and bodies and specifies formats and structures for them.

[1.3](#section-1.3).  Document Conventions

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [RFC 2119](./rfc2119) [[5](#ref-5 "\"Key words for use in RFCs to Indicate Requirement Levels\"")].  As each
   of these terms was intentionally and carefully chosen to improve the
   interoperability of email, each use of these terms is to be treated
   as a conformance requirement.

   Because this document has a long history and to avoid the risk of
   various errors and of confusing readers and documents that point to
   this one, most examples and the domain names they contain are
   preserved from [RFC 2821](./rfc2821).  Readers are cautioned that these are

Klensin                     Standards Track                     [Page 6]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   illustrative examples that should not actually be used in either code
   or configuration files.

[2](#section-2).  The SMTP Model

[2.1](#section-2.1).  Basic Structure

   The SMTP design can be pictured as:

                  +----------+                +----------+
      +------+    |          |                |          |
      | User |<-->|          |      SMTP      |          |
      +------+    |  Client- |Commands/Replies| Server-  |
      +------+    |   SMTP   |<-------------->|    SMTP  |    +------+
      | File |<-->|          |    and Mail    |          |<-->| File |
      |System|    |          |                |          |    |System|
      +------+    +----------+                +----------+    +------+
                   SMTP client                SMTP server

   When an SMTP client has a message to transmit, it establishes a two-
   way transmission channel to an SMTP server.  The responsibility of an
   SMTP client is to transfer mail messages to one or more SMTP servers,
   or report its failure to do so.

   The means by which a mail message is presented to an SMTP client, and
   how that client determines the identifier(s) ("names") of the
   domain(s) to which mail messages are to be transferred, is a local
   matter, and is not addressed by this document.  In some cases, the
   designated domain(s), or those determined by an SMTP client, will
   identify the final destination(s) of the mail message.  In other
   cases, common with SMTP clients associated with implementations of
   the POP ([RFC 937](./rfc937) [[15](#ref-15 "\"Post Office Protocol: Version 2\"")], [RFC 1939](./rfc1939) [[16](#ref-16 "\"Post Office Protocol - Version 3\"")]) or IMAP ([RFC 3501](./rfc3501) [[17](#ref-17 "\"INTERNET MESSAGE ACCESS PROTOCOL - VERSION 4rev1\"")])
   protocols, or when the SMTP client is inside an isolated transport
   service environment, the domain determined will identify an
   intermediate destination through which all mail messages are to be
   relayed.  SMTP clients that transfer all traffic regardless of the
   target domains associated with the individual messages, or that do
   not maintain queues for retrying message transmissions that initially
   cannot be completed, may otherwise conform to this specification but
   are not considered fully-capable.  Fully-capable SMTP
   implementations, including the relays used by these less capable
   ones, and their destinations, are expected to support all of the
   queuing, retrying, and alternate address functions discussed in this
   specification.  In many situations and configurations, the less-
   capable clients discussed above SHOULD be using the message
   submission protocol ([RFC 4409](./rfc4409) [[18](#ref-18 "\"Message Submission for Mail\"")]) rather than SMTP.

Klensin                     Standards Track                     [Page 7]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   The means by which an SMTP client, once it has determined a target
   domain, determines the identity of an SMTP server to which a copy of
   a message is to be transferred, and then performs that transfer, is
   covered by this document.  To effect a mail transfer to an SMTP
   server, an SMTP client establishes a two-way transmission channel to
   that SMTP server.  An SMTP client determines the address of an
   appropriate host running an SMTP server by resolving a destination
   domain name to either an intermediate Mail eXchanger host or a final
   target host.

   An SMTP server may be either the ultimate destination or an
   intermediate "relay" (that is, it may assume the role of an SMTP
   client after receiving the message) or "gateway" (that is, it may
   transport the message further using some protocol other than SMTP).
   SMTP commands are generated by the SMTP client and sent to the SMTP
   server.  SMTP replies are sent from the SMTP server to the SMTP
   client in response to the commands.

   In other words, message transfer can occur in a single connection
   between the original SMTP-sender and the final SMTP-recipient, or can
   occur in a series of hops through intermediary systems.  In either
   case, once the server has issued a success response at the end of the
   mail data, a formal handoff of responsibility for the message occurs:
   the protocol requires that a server MUST accept responsibility for
   either delivering the message or properly reporting the failure to do
   so (see Sections [6.1](#section-6.1), [6.2](#section-6.2), and [7.8](#section-7.8), below).

   Once the transmission channel is established and initial handshaking
   is completed, the SMTP client normally initiates a mail transaction.
   Such a transaction consists of a series of commands to specify the
   originator and destination of the mail and transmission of the
   message content (including any lines in the header section or other
   structure) itself.  When the same message is sent to multiple
   recipients, this protocol encourages the transmission of only one
   copy of the data for all recipients at the same destination (or
   intermediate relay) host.

   The server responds to each command with a reply; replies may
   indicate that the command was accepted, that additional commands are
   expected, or that a temporary or permanent error condition exists.
   Commands specifying the sender or recipients may include server-
   permitted SMTP service extension requests, as discussed in
   [Section 2.2](#section-2.2).  The dialog is purposely lock-step, one-at-a-time,
   although this can be modified by mutually agreed upon extension
   requests such as command pipelining ([RFC 2920](./rfc2920) [[19](#ref-19 "\"SMTP Service Extension for Command Pipelining\"")]).

   Once a given mail message has been transmitted, the client may either
   request that the connection be shut down or may initiate other mail

Klensin                     Standards Track                     [Page 8]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   transactions.  In addition, an SMTP client may use a connection to an
   SMTP server for ancillary services such as verification of email
   addresses or retrieval of mailing list subscriber addresses.

   As suggested above, this protocol provides mechanisms for the
   transmission of mail.  Historically, this transmission normally
   occurred directly from the sending user's host to the receiving
   user's host when the two hosts are connected to the same transport
   service.  When they are not connected to the same transport service,
   transmission occurs via one or more relay SMTP servers.  A very
   common case in the Internet today involves submission of the original
   message to an intermediate, "message submission" server, which is
   similar to a relay but has some additional properties; such servers
   are discussed in [Section 2.3.10](#section-2.3.10) and at some length in [RFC 4409](./rfc4409) [[18](#ref-18 "\"Message Submission for Mail\"")].
   An intermediate host that acts as either an SMTP relay or as a
   gateway into some other transmission environment is usually selected
   through the use of the domain name service (DNS) Mail eXchanger
   mechanism.

   Usually, intermediate hosts are determined via the DNS MX record, not
   by explicit "source" routing (see [Section 5](#section-5) and [Appendix C](#appendix-C) and
   [Appendix F.2](#appendix-F.2)).

[2.2](#section-2.2).  The Extension Model

[2.2.1](#section-2.2.1).  Background

   In an effort that started in 1990, approximately a decade after [RFC](./rfc821)
   [821](./rfc821) was completed, the protocol was modified with a "service
   extensions" model that permits the client and server to agree to
   utilize shared functionality beyond the original SMTP requirements.
   The SMTP extension mechanism defines a means whereby an extended SMTP
   client and server may recognize each other, and the server can inform
   the client as to the service extensions that it supports.

   Contemporary SMTP implementations MUST support the basic extension
   mechanisms.  For instance, servers MUST support the EHLO command even
   if they do not implement any specific extensions and clients SHOULD
   preferentially utilize EHLO rather than HELO.  (However, for
   compatibility with older conforming implementations, SMTP clients and
   servers MUST support the original HELO mechanisms as a fallback.)
   Unless the different characteristics of HELO must be identified for
   interoperability purposes, this document discusses only EHLO.

   SMTP is widely deployed and high-quality implementations have proven
   to be very robust.  However, the Internet community now considers
   some services to be important that were not anticipated when the
   protocol was first designed.  If support for those services is to be

Klensin                     Standards Track                     [Page 9]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   added, it must be done in a way that permits older implementations to
   continue working acceptably.  The extension framework consists of:

   o  The SMTP command EHLO, superseding the earlier HELO,

   o  a registry of SMTP service extensions,

   o  additional parameters to the SMTP MAIL and RCPT commands, and

   o  optional replacements for commands defined in this protocol, such
      as for DATA in non-ASCII transmissions ([RFC 3030](./rfc3030) [[20](#ref-20 "\"SMTP Service Extensions for Transmission of Large and Binary MIME Messages\"")]).

   SMTP's strength comes primarily from its simplicity.  Experience with
   many protocols has shown that protocols with few options tend towards
   ubiquity, whereas protocols with many options tend towards obscurity.

   Each and every extension, regardless of its benefits, must be
   carefully scrutinized with respect to its implementation, deployment,
   and interoperability costs.  In many cases, the cost of extending the
   SMTP service will likely outweigh the benefit.

[2.2.2](#section-2.2.2).  Definition and Registration of Extensions

   The IANA maintains a registry of SMTP service extensions.  A
   corresponding EHLO keyword value is associated with each extension.
   Each service extension registered with the IANA must be defined in a
   formal Standards-Track or IESG-approved Experimental protocol
   document.  The definition must include:

   o  the textual name of the SMTP service extension;

   o  the EHLO keyword value associated with the extension;

   o  the syntax and possible values of parameters associated with the
      EHLO keyword value;

   o  any additional SMTP verbs associated with the extension
      (additional verbs will usually be, but are not required to be, the
      same as the EHLO keyword value);

   o  any new parameters the extension associates with the MAIL or RCPT
      verbs;

   o  a description of how support for the extension affects the
      behavior of a server and client SMTP; and

Klensin                     Standards Track                    [Page 10]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   o  the increment by which the extension is increasing the maximum
      length of the commands MAIL and/or RCPT, over that specified in
      this Standard.

   In addition, any EHLO keyword value starting with an upper or lower
   case "X" refers to a local SMTP service extension used exclusively
   through bilateral agreement.  Keywords beginning with "X" MUST NOT be
   used in a registered service extension.  Conversely, keyword values
   presented in the EHLO response that do not begin with "X" MUST
   correspond to a Standard, Standards-Track, or IESG-approved
   Experimental SMTP service extension registered with IANA.  A
   conforming server MUST NOT offer non-"X"-prefixed keyword values that
   are not described in a registered extension.

   Additional verbs and parameter names are bound by the same rules as
   EHLO keywords; specifically, verbs beginning with "X" are local
   extensions that may not be registered or standardized.  Conversely,
   verbs not beginning with "X" must always be registered.

[2.2.3](#section-2.2.3).  Special Issues with Extensions

   Extensions that change fairly basic properties of SMTP operation are
   permitted.  The text in other sections of this document must be
   understood in that context.  In particular, extensions can change the
   minimum limits specified in [Section 4.5.3](#section-4.5.3), can change the ASCII
   character set requirement as mentioned above, or can introduce some
   optional modes of message handling.

   In particular, if an extension implies that the delivery path
   normally supports special features of that extension, and an
   intermediate SMTP system finds a next hop that does not support the
   required extension, it MAY choose, based on the specific extension
   and circumstances, to requeue the message and try later and/or try an
   alternate MX host.  If this strategy is employed, the timeout to fall
   back to an unextended format (if one is available) SHOULD be less
   than the normal timeout for bouncing as undeliverable (e.g., if
   normal timeout is three days, the requeue timeout before attempting
   to transmit the mail without the extension might be one day).

[2.3](#section-2.3).  SMTP Terminology

[2.3.1](#section-2.3.1).  Mail Objects

   SMTP transports a mail object.  A mail object contains an envelope
   and content.

   The SMTP envelope is sent as a series of SMTP protocol units
   (described in [Section 3](#section-3)).  It consists of an originator address (to

Klensin                     Standards Track                    [Page 11]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   which error reports should be directed), one or more recipient
   addresses, and optional protocol extension material.  Historically,
   variations on the reverse-path (originator) address specification
   command (MAIL) could be used to specify alternate delivery modes,
   such as immediate display; those variations have now been deprecated
   (see [Appendix F](#appendix-F) and [Appendix F.6](#appendix-F.6)).

   The SMTP content is sent in the SMTP DATA protocol unit and has two
   parts: the header section and the body.  If the content conforms to
   other contemporary standards, the header section consists of a
   collection of header fields, each consisting of a header name, a
   colon, and data, structured as in the message format specification
   ([RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")]); the body, if structured, is defined according to MIME
   ([RFC 2045](./rfc2045) [[21](#ref-21 "\"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies\"")]).  The content is textual in nature, expressed using
   the US-ASCII repertoire [[6](#ref-6 "\"USA Code for Information Interchange\"")].  Although SMTP extensions (such as
   "8BITMIME", [RFC 1652](./rfc1652) [[22](#ref-22 "\"SMTP Service Extension for 8bit-MIMEtransport\"")]) may relax this restriction for the content
   body, the content header fields are always encoded using the US-ASCII
   repertoire.  Two MIME extensions ([RFC 2047](./rfc2047) [[23](#ref-23 "\"MIME (Multipurpose Internet Mail Extensions) Part Three: Message Header Extensions for Non-ASCII Text\"")] and [RFC 2231](./rfc2231) [[24](#ref-24 "\"MIME Parameter Value and Encoded Word Extensions: Character Sets, Languages, and Continuations\"")])
   define an algorithm for representing header values outside the US-
   ASCII repertoire, while still encoding them using the US-ASCII
   repertoire.

[2.3.2](#section-2.3.2).  Senders and Receivers

   In [RFC 821](./rfc821), the two hosts participating in an SMTP transaction were
   described as the "SMTP-sender" and "SMTP-receiver".  This document
   has been changed to reflect current industry terminology and hence
   refers to them as the "SMTP client" (or sometimes just "the client")
   and "SMTP server" (or just "the server"), respectively.  Since a
   given host may act both as server and client in a relay situation,
   "receiver" and "sender" terminology is still used where needed for
   clarity.

[2.3.3](#section-2.3.3).  Mail Agents and Message Stores

   Additional mail system terminology became common after [RFC 821](./rfc821) was
   published and, where convenient, is used in this specification.  In
   particular, SMTP servers and clients provide a mail transport service
   and therefore act as "Mail Transfer Agents" (MTAs).  "Mail User
   Agents" (MUAs or UAs) are normally thought of as the sources and
   targets of mail.  At the source, an MUA might collect mail to be
   transmitted from a user and hand it off to an MTA; the final
   ("delivery") MTA would be thought of as handing the mail off to an
   MUA (or at least transferring responsibility to it, e.g., by
   depositing the message in a "message store").  However, while these
   terms are used with at least the appearance of great precision in
   other environments, the implied boundaries between MUAs and MTAs
   often do not accurately match common, and conforming, practices with

Klensin                     Standards Track                    [Page 12]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Internet mail.  Hence, the reader should be cautious about inferring
   the strong relationships and responsibilities that might be implied
   if these terms were used elsewhere.

[2.3.4](#section-2.3.4).  Host

   For the purposes of this specification, a host is a computer system
   attached to the Internet (or, in some cases, to a private TCP/IP
   network) and supporting the SMTP protocol.  Hosts are known by names
   (see the next section); they SHOULD NOT be identified by numerical
   addresses, i.e., by address literals as described in [Section 4.1.2](#section-4.1.2).

[2.3.5](#section-2.3.5).  Domain Names

   A domain name (or often just a "domain") consists of one or more
   components, separated by dots if more than one appears.  In the case
   of a top-level domain used by itself in an email address, a single
   string is used without any dots.  This makes the requirement,
   described in more detail below, that only fully-qualified domain
   names appear in SMTP transactions on the public Internet,
   particularly important where top-level domains are involved.  These
   components ("labels" in DNS terminology, [RFC 1035](./rfc1035) [[2](#ref-2 "\"Domain names - implementation and specification\"")]) are restricted
   for SMTP purposes to consist of a sequence of letters, digits, and
   hyphens drawn from the ASCII character set [[6](#ref-6 "\"USA Code for Information Interchange\"")].  Domain names are
   used as names of hosts and of other entities in the domain name
   hierarchy.  For example, a domain may refer to an alias (label of a
   CNAME RR) or the label of Mail eXchanger records to be used to
   deliver mail instead of representing a host name.  See [RFC 1035](./rfc1035) [[2](#ref-2 "\"Domain names - implementation and specification\"")]
   and [Section 5](#section-5) of this specification.

   The domain name, as described in this document and in [RFC 1035](./rfc1035) [[2](#ref-2 "\"Domain names - implementation and specification\"")],
   is the entire, fully-qualified name (often referred to as an "FQDN").
   A domain name that is not in FQDN form is no more than a local alias.
   Local aliases MUST NOT appear in any SMTP transaction.

   Only resolvable, fully-qualified domain names (FQDNs) are permitted
   when domain names are used in SMTP.  In other words, names that can
   be resolved to MX RRs or address (i.e., A or AAAA) RRs (as discussed
   in [Section 5](#section-5)) are permitted, as are CNAME RRs whose targets can be
   resolved, in turn, to MX or address RRs.  Local nicknames or
   unqualified names MUST NOT be used.  There are two exceptions to the
   rule requiring FQDNs:

   o  The domain name given in the EHLO command MUST be either a primary
      host name (a domain name that resolves to an address RR) or, if
      the host has no name, an address literal, as described in
      [Section 4.1.3](#section-4.1.3) and discussed further in the EHLO discussion of
      [Section 4.1.4](#section-4.1.4).

Klensin                     Standards Track                    [Page 13]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   o  The reserved mailbox name "postmaster" may be used in a RCPT
      command without domain qualification (see [Section 4.1.1.3](#section-4.1.1.3)) and
      MUST be accepted if so used.

[2.3.6](#section-2.3.6).  Buffer and State Table

   SMTP sessions are stateful, with both parties carefully maintaining a
   common view of the current state.  In this document, we model this
   state by a virtual "buffer" and a "state table" on the server that
   may be used by the client to, for example, "clear the buffer" or
   "reset the state table", causing the information in the buffer to be
   discarded and the state to be returned to some previous state.

[2.3.7](#section-2.3.7).  Commands and Replies

   SMTP commands and, unless altered by a service extension, message
   data, are transmitted from the sender to the receiver via the
   transmission channel in "lines".

   An SMTP reply is an acknowledgment (positive or negative) sent in
   "lines" from receiver to sender via the transmission channel in
   response to a command.  The general form of a reply is a numeric
   completion code (indicating failure or success) usually followed by a
   text string.  The codes are for use by programs and the text is
   usually intended for human users.  [RFC 3463](./rfc3463) [[25](#ref-25 "\"Enhanced Mail System Status Codes\"")], specifies further
   structuring of the reply strings, including the use of supplemental
   and more specific completion codes (see also [RFC 5248](./rfc5248) [[26](#ref-26 "\"A Registry for SMTP Enhanced Mail System Status Codes\"")]).

[2.3.8](#section-2.3.8).  Lines

   Lines consist of zero or more data characters terminated by the
   sequence ASCII character "CR" (hex value 0D) followed immediately by
   ASCII character "LF" (hex value 0A).  This termination sequence is
   denoted as <CRLF> in this document.  Conforming implementations MUST
   NOT recognize or generate any other character or character sequence
   as a line terminator.  Limits MAY be imposed on line lengths by
   servers (see [Section 4](#section-4)).

   In addition, the appearance of "bare" "CR" or "LF" characters in text
   (i.e., either without the other) has a long history of causing
   problems in mail implementations and applications that use the mail
   system as a tool.  SMTP client implementations MUST NOT transmit
   these characters except when they are intended as line terminators
   and then MUST, as indicated above, transmit them only as a <CRLF>
   sequence.

Klensin                     Standards Track                    [Page 14]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[2.3.9](#section-2.3.9).  Message Content and Mail Data

   The terms "message content" and "mail data" are used interchangeably
   in this document to describe the material transmitted after the DATA
   command is accepted and before the end of data indication is
   transmitted.  Message content includes the message header section and
   the possibly structured message body.  The MIME specification ([RFC](./rfc2045)
   [2045](./rfc2045) [[21](#ref-21 "\"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies\"")]) provides the standard mechanisms for structured message
   bodies.

[2.3.10](#section-2.3.10).  Originator, Delivery, Relay, and Gateway Systems

   This specification makes a distinction among four types of SMTP
   systems, based on the role those systems play in transmitting
   electronic mail.  An "originating" system (sometimes called an SMTP
   originator) introduces mail into the Internet or, more generally,
   into a transport service environment.  A "delivery" SMTP system is
   one that receives mail from a transport service environment and
   passes it to a mail user agent or deposits it in a message store that
   a mail user agent is expected to subsequently access.  A "relay" SMTP
   system (usually referred to just as a "relay") receives mail from an
   SMTP client and transmits it, without modification to the message
   data other than adding trace information, to another SMTP server for
   further relaying or for delivery.

   A "gateway" SMTP system (usually referred to just as a "gateway")
   receives mail from a client system in one transport environment and
   transmits it to a server system in another transport environment.
   Differences in protocols or message semantics between the transport
   environments on either side of a gateway may require that the gateway
   system perform transformations to the message that are not permitted
   to SMTP relay systems.  For the purposes of this specification,
   firewalls that rewrite addresses should be considered as gateways,
   even if SMTP is used on both sides of them (see [RFC 2979](./rfc2979) [[27](#ref-27 "\"Behavior of and Requirements for Internet Firewalls\"")]).

[2.3.11](#section-2.3.11).  Mailbox and Address

   As used in this specification, an "address" is a character string
   that identifies a user to whom mail will be sent or a location into
   which mail will be deposited.  The term "mailbox" refers to that
   depository.  The two terms are typically used interchangeably unless
   the distinction between the location in which mail is placed (the
   mailbox) and a reference to it (the address) is important.  An
   address normally consists of user and domain specifications.  The
   standard mailbox naming convention is defined to be
   "local-part@domain"; contemporary usage permits a much broader set of
   applications than simple "user names".  Consequently, and due to a
   long history of problems when intermediate hosts have attempted to

Klensin                     Standards Track                    [Page 15]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   optimize transport by modifying them, the local-part MUST be
   interpreted and assigned semantics only by the host specified in the
   domain part of the address.

[2.4](#section-2.4).  General Syntax Principles and Transaction Model

   SMTP commands and replies have a rigid syntax.  All commands begin
   with a command verb.  All replies begin with a three digit numeric
   code.  In some commands and replies, arguments are required following
   the verb or reply code.  Some commands do not accept arguments (after
   the verb), and some reply codes are followed, sometimes optionally,
   by free form text.  In both cases, where text appears, it is
   separated from the verb or reply code by a space character.  Complete
   definitions of commands and replies appear in [Section 4](#section-4).

   Verbs and argument values (e.g., "TO:" or "to:" in the RCPT command
   and extension name keywords) are not case sensitive, with the sole
   exception in this specification of a mailbox local-part (SMTP
   Extensions may explicitly specify case-sensitive elements).  That is,
   a command verb, an argument value other than a mailbox local-part,
   and free form text MAY be encoded in upper case, lower case, or any
   mixture of upper and lower case with no impact on its meaning.  The
   local-part of a mailbox MUST BE treated as case sensitive.
   Therefore, SMTP implementations MUST take care to preserve the case
   of mailbox local-parts.  In particular, for some hosts, the user
   "smith" is different from the user "Smith".  However, exploiting the
   case sensitivity of mailbox local-parts impedes interoperability and
   is discouraged.  Mailbox domains follow normal DNS rules and are
   hence not case sensitive.

   A few SMTP servers, in violation of this specification (and [RFC 821](./rfc821))
   require that command verbs be encoded by clients in upper case.
   Implementations MAY wish to employ this encoding to accommodate those
   servers.

   The argument clause consists of a variable-length character string
   ending with the end of the line, i.e., with the character sequence
   <CRLF>.  The receiver will take no action until this sequence is
   received.

   The syntax for each command is shown with the discussion of that
   command.  Common elements and parameters are shown in [Section 4.1.2](#section-4.1.2).

   Commands and replies are composed of characters from the ASCII
   character set [[6](#ref-6 "\"USA Code for Information Interchange\"")].  When the transport service provides an 8-bit byte
   (octet) transmission channel, each 7-bit character is transmitted,
   right justified, in an octet with the high-order bit cleared to zero.
   More specifically, the unextended SMTP service provides 7-bit

Klensin                     Standards Track                    [Page 16]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   transport only.  An originating SMTP client that has not successfully
   negotiated an appropriate extension with a particular server (see the
   next paragraph) MUST NOT transmit messages with information in the
   high-order bit of octets.  If such messages are transmitted in
   violation of this rule, receiving SMTP servers MAY clear the high-
   order bit or reject the message as invalid.  In general, a relay SMTP
   SHOULD assume that the message content it has received is valid and,
   assuming that the envelope permits doing so, relay it without
   inspecting that content.  Of course, if the content is mislabeled and
   the data path cannot accept the actual content, this may result in
   the ultimate delivery of a severely garbled message to the recipient.
   Delivery SMTP systems MAY reject such messages, or return them as
   undeliverable, rather than deliver them.  In the absence of a server-
   offered extension explicitly permitting it, a sending SMTP system is
   not permitted to send envelope commands in any character set other
   than US-ASCII.  Receiving systems SHOULD reject such commands,
   normally using "500 syntax error - invalid character" replies.

   8-bit message content transmission MAY be requested of the server by
   a client using extended SMTP facilities, notably the "8BITMIME"
   extension, [RFC 1652](./rfc1652) [[22](#ref-22 "\"SMTP Service Extension for 8bit-MIMEtransport\"")]. 8BITMIME SHOULD be supported by SMTP
   servers.  However, it MUST NOT be construed as authorization to
   transmit unrestricted 8-bit material, nor does 8BITMIME authorize
   transmission of any envelope material in other than ASCII. 8BITMIME
   MUST NOT be requested by senders for material with the high bit on
   that is not in MIME format with an appropriate content-transfer
   encoding; servers MAY reject such messages.

   The metalinguistic notation used in this document corresponds to the
   "Augmented BNF" used in other Internet mail system documents.  The
   reader who is not familiar with that syntax should consult the ABNF
   specification in [RFC 5234](./rfc5234) [[7](#ref-7 "\"Augmented BNF for Syntax Specifications: ABNF\"")].  Metalanguage terms used in running
   text are surrounded by pointed brackets (e.g., <CRLF>) for clarity.
   The reader is cautioned that the grammar expressed in the
   metalanguage is not comprehensive.  There are many instances in which
   provisions in the text constrain or otherwise modify the syntax or
   semantics implied by the grammar.

[3](#section-3).  The SMTP Procedures: An Overview

   This section contains descriptions of the procedures used in SMTP:
   session initiation, mail transaction, forwarding mail, verifying
   mailbox names and expanding mailing lists, and opening and closing
   exchanges.  Comments on relaying, a note on mail domains, and a
   discussion of changing roles are included at the end of this section.
   Several complete scenarios are presented in [Appendix D](#appendix-D).

Klensin                     Standards Track                    [Page 17]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[3.1](#section-3.1).  Session Initiation

   An SMTP session is initiated when a client opens a connection to a
   server and the server responds with an opening message.

   SMTP server implementations MAY include identification of their
   software and version information in the connection greeting reply
   after the 220 code, a practice that permits more efficient isolation
   and repair of any problems.  Implementations MAY make provision for
   SMTP servers to disable the software and version announcement where
   it causes security concerns.  While some systems also identify their
   contact point for mail problems, this is not a substitute for
   maintaining the required "postmaster" address (see [Section 4](#section-4)).

   The SMTP protocol allows a server to formally reject a mail session
   while still allowing the initial connection as follows: a 554
   response MAY be given in the initial connection opening message
   instead of the 220.  A server taking this approach MUST still wait
   for the client to send a QUIT (see [Section 4.1.1.10](#section-4.1.1.10)) before closing
   the connection and SHOULD respond to any intervening commands with
   "503 bad sequence of commands".  Since an attempt to make an SMTP
   connection to such a system is probably in error, a server returning
   a 554 response on connection opening SHOULD provide enough
   information in the reply text to facilitate debugging of the sending
   system.

[3.2](#section-3.2).  Client Initiation

   Once the server has sent the greeting (welcoming) message and the
   client has received it, the client normally sends the EHLO command to
   the server, indicating the client's identity.  In addition to opening
   the session, use of EHLO indicates that the client is able to process
   service extensions and requests that the server provide a list of the
   extensions it supports.  Older SMTP systems that are unable to
   support service extensions, and contemporary clients that do not
   require service extensions in the mail session being initiated, MAY
   use HELO instead of EHLO.  Servers MUST NOT return the extended EHLO-
   style response to a HELO command.  For a particular connection
   attempt, if the server returns a "command not recognized" response to
   EHLO, the client SHOULD be able to fall back and send HELO.

   In the EHLO command, the host sending the command identifies itself;
   the command may be interpreted as saying "Hello, I am <domain>" (and,
   in the case of EHLO, "and I support service extension requests").

Klensin                     Standards Track                    [Page 18]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[3.3](#section-3.3).  Mail Transactions

   There are three steps to SMTP mail transactions.  The transaction
   starts with a MAIL command that gives the sender identification.  (In
   general, the MAIL command may be sent only when no mail transaction
   is in progress; see [Section 4.1.4](#section-4.1.4).)  A series of one or more RCPT
   commands follows, giving the receiver information.  Then, a DATA
   command initiates transfer of the mail data and is terminated by the
   "end of mail" data indicator, which also confirms the transaction.

   The first step in the procedure is the MAIL command.

      MAIL FROM:<reverse-path> [SP <mail-parameters> ] <CRLF>

   This command tells the SMTP-receiver that a new mail transaction is
   starting and to reset all its state tables and buffers, including any
   recipients or mail data.  The <reverse-path> portion of the first or
   only argument contains the source mailbox (between "<" and ">"
   brackets), which can be used to report errors (see [Section 4.2](#section-4.2) for a
   discussion of error reporting).  If accepted, the SMTP server returns
   a "250 OK" reply.  If the mailbox specification is not acceptable for
   some reason, the server MUST return a reply indicating whether the
   failure is permanent (i.e., will occur again if the client tries to
   send the same address again) or temporary (i.e., the address might be
   accepted if the client tries again later).  Despite the apparent
   scope of this requirement, there are circumstances in which the
   acceptability of the reverse-path may not be determined until one or
   more forward-paths (in RCPT commands) can be examined.  In those
   cases, the server MAY reasonably accept the reverse-path (with a 250
   reply) and then report problems after the forward-paths are received
   and examined.  Normally, failures produce 550 or 553 replies.

   Historically, the <reverse-path> was permitted to contain more than
   just a mailbox; however, contemporary systems SHOULD NOT use source
   routing (see [Appendix C](#appendix-C)).

   The optional <mail-parameters> are associated with negotiated SMTP
   service extensions (see [Section 2.2](#section-2.2)).

   The second step in the procedure is the RCPT command.  This step of
   the procedure can be repeated any number of times.

      RCPT TO:<forward-path> [ SP <rcpt-parameters> ] <CRLF>

   The first or only argument to this command includes a forward-path
   (normally a mailbox and domain, always surrounded by "<" and ">"
   brackets) identifying one recipient.  If accepted, the SMTP server
   returns a "250 OK" reply and stores the forward-path.  If the

Klensin                     Standards Track                    [Page 19]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   recipient is known not to be a deliverable address, the SMTP server
   returns a 550 reply, typically with a string such as "no such user -
   " and the mailbox name (other circumstances and reply codes are
   possible).

   The <forward-path> can contain more than just a mailbox.
   Historically, the <forward-path> was permitted to contain a source
   routing list of hosts and the destination mailbox; however,
   contemporary SMTP clients SHOULD NOT utilize source routes (see
   [Appendix C](#appendix-C)).  Servers MUST be prepared to encounter a list of source
   routes in the forward-path, but they SHOULD ignore the routes or MAY
   decline to support the relaying they imply.  Similarly, servers MAY
   decline to accept mail that is destined for other hosts or systems.
   These restrictions make a server useless as a relay for clients that
   do not support full SMTP functionality.  Consequently, restricted-
   capability clients MUST NOT assume that any SMTP server on the
   Internet can be used as their mail processing (relaying) site.  If a
   RCPT command appears without a previous MAIL command, the server MUST
   return a 503 "Bad sequence of commands" response.  The optional
   <rcpt-parameters> are associated with negotiated SMTP service
   extensions (see [Section 2.2](#section-2.2)).

   Since it has been a common source of errors, it is worth noting that
   spaces are not permitted on either side of the colon following FROM
   in the MAIL command or TO in the RCPT command.  The syntax is exactly
   as given above.

   The third step in the procedure is the DATA command (or some
   alternative specified in a service extension).

      DATA <CRLF>

   If accepted, the SMTP server returns a 354 Intermediate reply and
   considers all succeeding lines up to but not including the end of
   mail data indicator to be the message text.  When the end of text is
   successfully received and stored, the SMTP-receiver sends a "250 OK"
   reply.

   Since the mail data is sent on the transmission channel, the end of
   mail data must be indicated so that the command and reply dialog can
   be resumed.  SMTP indicates the end of the mail data by sending a
   line containing only a "." (period or full stop).  A transparency
   procedure is used to prevent this from interfering with the user's
   text (see [Section 4.5.2](#section-4.5.2)).

   The end of mail data indicator also confirms the mail transaction and
   tells the SMTP server to now process the stored recipients and mail

Klensin                     Standards Track                    [Page 20]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   data.  If accepted, the SMTP server returns a "250 OK" reply.  The
   DATA command can fail at only two points in the protocol exchange:

   If there was no MAIL, or no RCPT, command, or all such commands were
   rejected, the server MAY return a "command out of sequence" (503) or
   "no valid recipients" (554) reply in response to the DATA command.
   If one of those replies (or any other 5yz reply) is received, the
   client MUST NOT send the message data; more generally, message data
   MUST NOT be sent unless a 354 reply is received.

   If the verb is initially accepted and the 354 reply issued, the DATA
   command should fail only if the mail transaction was incomplete (for
   example, no recipients), if resources were unavailable (including, of
   course, the server unexpectedly becoming unavailable), or if the
   server determines that the message should be rejected for policy or
   other reasons.

   However, in practice, some servers do not perform recipient
   verification until after the message text is received.  These servers
   SHOULD treat a failure for one or more recipients as a "subsequent
   failure" and return a mail message as discussed in [Section 6](#section-6) and, in
   particular, in [Section 6.1](#section-6.1).  Using a "550 mailbox not found" (or
   equivalent) reply code after the data are accepted makes it difficult
   or impossible for the client to determine which recipients failed.

   When the [RFC 822](./rfc822) format ([[28](#ref-28 "\"Standard for the format of ARPA Internet text messages\"")], [[4](#ref-4 "\"Internet Message Format\"")]) is being used, the mail data
   include the header fields such as those named Date, Subject, To, Cc,
   and From.  Server SMTP systems SHOULD NOT reject messages based on
   perceived defects in the [RFC 822](./rfc822) or MIME ([RFC 2045](./rfc2045) [[21](#ref-21 "\"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies\"")]) message
   header section or message body.  In particular, they MUST NOT reject
   messages in which the numbers of Resent-header fields do not match or
   Resent-to appears without Resent-from and/or Resent-date.

   Mail transaction commands MUST be used in the order discussed above.

[3.4](#section-3.4).  Forwarding for Address Correction or Updating

   Forwarding support is most often required to consolidate and simplify
   addresses within, or relative to, some enterprise and less frequently
   to establish addresses to link a person's prior address with a
   current one.  Silent forwarding of messages (without server
   notification to the sender), for security or non-disclosure purposes,
   is common in the contemporary Internet.

   In both the enterprise and the "new address" cases, information
   hiding (and sometimes security) considerations argue against exposure
   of the "final" address through the SMTP protocol as a side effect of
   the forwarding activity.  This may be especially important when the

Klensin                     Standards Track                    [Page 21]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   final address may not even be reachable by the sender.  Consequently,
   the "forwarding" mechanisms described in [Section 3.2 of RFC 821](./rfc821#section-3.2), and
   especially the 251 (corrected destination) and 551 reply codes from
   RCPT must be evaluated carefully by implementers and, when they are
   available, by those configuring systems (see also [Section 7.4](#section-7.4)).

   In particular:

   o  Servers MAY forward messages when they are aware of an address
      change.  When they do so, they MAY either provide address-updating
      information with a 251 code, or may forward "silently" and return
      a 250 code.  However, if a 251 code is used, they MUST NOT assume
      that the client will actually update address information or even
      return that information to the user.

   Alternately,

   o  Servers MAY reject messages or return them as non-deliverable when
      they cannot be delivered precisely as addressed.  When they do so,
      they MAY either provide address-updating information with a 551
      code, or may reject the message as undeliverable with a 550 code
      and no address-specific information.  However, if a 551 code is
      used, they MUST NOT assume that the client will actually update
      address information or even return that information to the user.

   SMTP server implementations that support the 251 and/or 551 reply
   codes SHOULD provide configuration mechanisms so that sites that
   conclude that they would undesirably disclose information can disable
   or restrict their use.

[3.5](#section-3.5).  Commands for Debugging Addresses

[3.5.1](#section-3.5.1).  Overview

   SMTP provides commands to verify a user name or obtain the content of
   a mailing list.  This is done with the VRFY and EXPN commands, which
   have character string arguments.  Implementations SHOULD support VRFY
   and EXPN (however, see [Section 3.5.2](#section-3.5.2) and [Section 7.3](#section-7.3)).

   For the VRFY command, the string is a user name or a user name and
   domain (see below).  If a normal (i.e., 250) response is returned,
   the response MAY include the full name of the user and MUST include
   the mailbox of the user.  It MUST be in either of the following
   forms:

      User Name <local-part@domain>
      local-part@domain

Klensin                     Standards Track                    [Page 22]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   When a name that is the argument to VRFY could identify more than one
   mailbox, the server MAY either note the ambiguity or identify the
   alternatives.  In other words, any of the following are legitimate
   responses to VRFY:

      553 User ambiguous

   or

      553- Ambiguous; Possibilities are
      553-Joe Smith <jsmith@foo.com>
      553-Harry Smith <hsmith@foo.com>
      553 Melvin Smith <dweep@foo.com>

   or

      553-Ambiguous; Possibilities
      553- <jsmith@foo.com>
      553- <hsmith@foo.com>
      553 <dweep@foo.com>

   Under normal circumstances, a client receiving a 553 reply would be
   expected to expose the result to the user.  Use of exactly the forms
   given, and the "user ambiguous" or "ambiguous" keywords, possibly
   supplemented by extended reply codes, such as those described in [RFC](./rfc3463)
   [3463](./rfc3463) [[25](#ref-25 "\"Enhanced Mail System Status Codes\"")], will facilitate automated translation into other languages
   as needed.  Of course, a client that was highly automated or that was
   operating in another language than English might choose to try to
   translate the response to return some other indication to the user
   than the literal text of the reply, or to take some automated action
   such as consulting a directory service for additional information
   before reporting to the user.

   For the EXPN command, the string identifies a mailing list, and the
   successful (i.e., 250) multiline response MAY include the full name
   of the users and MUST give the mailboxes on the mailing list.

   In some hosts, the distinction between a mailing list and an alias
   for a single mailbox is a bit fuzzy, since a common data structure
   may hold both types of entries, and it is possible to have mailing
   lists containing only one mailbox.  If a request is made to apply
   VRFY to a mailing list, a positive response MAY be given if a message
   so addressed would be delivered to everyone on the list, otherwise an
   error SHOULD be reported (e.g., "550 That is a mailing list, not a
   user" or "252 Unable to verify members of mailing list").  If a
   request is made to expand a user name, the server MAY return a

Klensin                     Standards Track                    [Page 23]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   positive response consisting of a list containing one name, or an
   error MAY be reported (e.g., "550 That is a user name, not a mailing
   list").

   In the case of a successful multiline reply (normal for EXPN),
   exactly one mailbox is to be specified on each line of the reply.
   The case of an ambiguous request is discussed above.

   "User name" is a fuzzy term and has been used deliberately.  An
   implementation of the VRFY or EXPN commands MUST include at least
   recognition of local mailboxes as "user names".  However, since
   current Internet practice often results in a single host handling
   mail for multiple domains, hosts, especially hosts that provide this
   functionality, SHOULD accept the "local-part@domain" form as a "user
   name"; hosts MAY also choose to recognize other strings as "user
   names".

   The case of expanding a mailbox list requires a multiline reply, such
   as:

      C: EXPN Example-People
      S: 250-Jon Postel <Postel@isi.edu>
      S: 250-Fred Fonebone <Fonebone@physics.foo-u.edu>
      S: 250 Sam Q. Smith <SQSmith@specific.generic.com>

   or

      C: EXPN Executive-Washroom-List
      S: 550 Access Denied to You.

   The character string arguments of the VRFY and EXPN commands cannot
   be further restricted due to the variety of implementations of the
   user name and mailbox list concepts.  On some systems, it may be
   appropriate for the argument of the EXPN command to be a file name
   for a file containing a mailing list, but again there are a variety
   of file naming conventions in the Internet.  Similarly, historical
   variations in what is returned by these commands are such that the
   response SHOULD be interpreted very carefully, if at all, and SHOULD
   generally only be used for diagnostic purposes.

[3.5.2](#section-3.5.2).  VRFY Normal Response

   When normal (2yz or 551) responses are returned from a VRFY or EXPN
   request, the reply MUST include the <Mailbox> name using a
   "<local-part@domain>" construction, where "domain" is a fully-
   qualified domain name.  In circumstances exceptional enough to
   justify violating the intent of this specification, free-form text
   MAY be returned.  In order to facilitate parsing by both computers

Klensin                     Standards Track                    [Page 24]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   and people, addresses SHOULD appear in pointed brackets.  When
   addresses, rather than free-form debugging information, are returned,
   EXPN and VRFY MUST return only valid domain addresses that are usable
   in SMTP RCPT commands.  Consequently, if an address implies delivery
   to a program or other system, the mailbox name used to reach that
   target MUST be given.  Paths (explicit source routes) MUST NOT be
   returned by VRFY or EXPN.

   Server implementations SHOULD support both VRFY and EXPN.  For
   security reasons, implementations MAY provide local installations a
   way to disable either or both of these commands through configuration
   options or the equivalent (see [Section 7.3](#section-7.3)).  When these commands are
   supported, they are not required to work across relays when relaying
   is supported.  Since they were both optional in [RFC 821](./rfc821), but VRFY was
   made mandatory in [RFC 1123](./rfc1123) [[3](#ref-3 "\"Requirements for Internet Hosts - Application and Support\"")], if EXPN is supported, it MUST be
   listed as a service extension in an EHLO response.  VRFY MAY be
   listed as a convenience but, since support for it is required, SMTP
   clients are not required to check for its presence on the extension
   list before using it.

[3.5.3](#section-3.5.3).  Meaning of VRFY or EXPN Success Response

   A server MUST NOT return a 250 code in response to a VRFY or EXPN
   command unless it has actually verified the address.  In particular,
   a server MUST NOT return 250 if all it has done is to verify that the
   syntax given is valid.  In that case, 502 (Command not implemented)
   or 500 (Syntax error, command unrecognized) SHOULD be returned.  As
   stated elsewhere, implementation (in the sense of actually validating
   addresses and returning information) of VRFY and EXPN are strongly
   recommended.  Hence, implementations that return 500 or 502 for VRFY
   are not in full compliance with this specification.

   There may be circumstances where an address appears to be valid but
   cannot reasonably be verified in real time, particularly when a
   server is acting as a mail exchanger for another server or domain.
   "Apparent validity", in this case, would normally involve at least
   syntax checking and might involve verification that any domains
   specified were ones to which the host expected to be able to relay
   mail.  In these situations, reply code 252 SHOULD be returned.  These
   cases parallel the discussion of RCPT verification in [Section 2.1](#section-2.1).
   Similarly, the discussion in [Section 3.4](#section-3.4) applies to the use of reply
   codes 251 and 551 with VRFY (and EXPN) to indicate addresses that are
   recognized but that would be forwarded or rejected were mail received
   for them.  Implementations generally SHOULD be more aggressive about
   address verification in the case of VRFY than in the case of RCPT,
   even if it takes a little longer to do so.

Klensin                     Standards Track                    [Page 25]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[3.5.4](#section-3.5.4).  Semantics and Applications of EXPN

   EXPN is often very useful in debugging and understanding problems
   with mailing lists and multiple-target-address aliases.  Some systems
   have attempted to use source expansion of mailing lists as a means of
   eliminating duplicates.  The propagation of aliasing systems with
   mail on the Internet for hosts (typically with MX and CNAME DNS
   records), for mailboxes (various types of local host aliases), and in
   various proxying arrangements has made it nearly impossible for these
   strategies to work consistently, and mail systems SHOULD NOT attempt
   them.

[3.6](#section-3.6).  Relaying and Mail Routing

[3.6.1](#section-3.6.1).  Source Routes and Relaying

   In general, the availability of Mail eXchanger records in the domain
   name system ([RFC 1035](./rfc1035) [[2](#ref-2 "\"Domain names - implementation and specification\"")], [RFC 974](./rfc974) [[12](#ref-12 "\"Mail routing and the domain system\"")]) makes the use of explicit
   source routes in the Internet mail system unnecessary.  Many
   historical problems with the interpretation of explicit source routes
   have made their use undesirable.  SMTP clients SHOULD NOT generate
   explicit source routes except under unusual circumstances.  SMTP
   servers MAY decline to act as mail relays or to accept addresses that
   specify source routes.  When route information is encountered, SMTP
   servers MAY ignore the route information and simply send to the final
   destination specified as the last element in the route and SHOULD do
   so.  There has been an invalid practice of using names that do not
   appear in the DNS as destination names, with the senders counting on
   the intermediate hosts specified in source routing to resolve any
   problems.  If source routes are stripped, this practice will cause
   failures.  This is one of several reasons why SMTP clients MUST NOT
   generate invalid source routes or depend on serial resolution of
   names.

   When source routes are not used, the process described in [RFC 821](./rfc821) for
   constructing a reverse-path from the forward-path is not applicable
   and the reverse-path at the time of delivery will simply be the
   address that appeared in the MAIL command.

[3.6.2](#section-3.6.2).  Mail eXchange Records and Relaying

   A relay SMTP server is usually the target of a DNS MX record that
   designates it, rather than the final delivery system.  The relay
   server may accept or reject the task of relaying the mail in the same
   way it accepts or rejects mail for a local user.  If it accepts the
   task, it then becomes an SMTP client, establishes a transmission
   channel to the next SMTP server specified in the DNS (according to
   the rules in [Section 5](#section-5)), and sends it the mail.  If it declines to

Klensin                     Standards Track                    [Page 26]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   relay mail to a particular address for policy reasons, a 550 response
   SHOULD be returned.

   This specification does not deal with the verification of return
   paths for use in delivery notifications.  Recent work, such as that
   on SPF [[29](#ref-29 "\"Sender Policy Framework (SPF) for Authorizing Use of Domains in E-Mail, Version 1\"")] and DKIM [[30](#ref-30 "\"Analysis of Threats Motivating DomainKeys Identified Mail (DKIM)\"")] [[31](#ref-31 "\"DomainKeys Identified Mail (DKIM) Signatures\"")], has been done to provide ways to
   ascertain that an address is valid or belongs to the person who
   actually sent the message.  A server MAY attempt to verify the return
   path before using its address for delivery notifications, but methods
   of doing so are not defined here nor is any particular method
   recommended at this time.

[3.6.3](#section-3.6.3).  Message Submission Servers as Relays

   Many mail-sending clients exist, especially in conjunction with
   facilities that receive mail via POP3 or IMAP, that have limited
   capability to support some of the requirements of this specification,
   such as the ability to queue messages for subsequent delivery
   attempts.  For these clients, it is common practice to make private
   arrangements to send all messages to a single server for processing
   and subsequent distribution.  SMTP, as specified here, is not ideally
   suited for this role.  A standardized mail submission protocol has
   been developed that is gradually superseding practices based on SMTP
   (see [RFC 4409](./rfc4409) [[18](#ref-18 "\"Message Submission for Mail\"")]).  In any event, because these arrangements are
   private and fall outside the scope of this specification, they are
   not described here.

   It is important to note that MX records can point to SMTP servers
   that act as gateways into other environments, not just SMTP relays
   and final delivery systems; see Sections [3.7](#section-3.7) and [5](#section-5).

   If an SMTP server has accepted the task of relaying the mail and
   later finds that the destination is incorrect or that the mail cannot
   be delivered for some other reason, then it MUST construct an
   "undeliverable mail" notification message and send it to the
   originator of the undeliverable mail (as indicated by the reverse-
   path).  Formats specified for non-delivery reports by other standards
   (see, for example, [RFC 3461](./rfc3461) [[32](#ref-32 "\"Simple Mail Transfer Protocol (SMTP) Service Extension for Delivery Status Notifications (DSNs)\"")] and [RFC 3464](./rfc3464) [[33](#ref-33 "\"An Extensible Message Format for Delivery Status Notifications\"")]) SHOULD be used if
   possible.

   This notification message must be from the SMTP server at the relay
   host or the host that first determines that delivery cannot be
   accomplished.  Of course, SMTP servers MUST NOT send notification
   messages about problems transporting notification messages.  One way
   to prevent loops in error reporting is to specify a null reverse-path
   in the MAIL command of a notification message.  When such a message
   is transmitted, the reverse-path MUST be set to null (see

Klensin                     Standards Track                    [Page 27]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   [Section 4.5.5](#section-4.5.5) for additional discussion).  A MAIL command with a null
   reverse-path appears as follows:

      MAIL FROM:<>

   As discussed in [Section 6.4](#section-6.4), a relay SMTP has no need to inspect or
   act upon the header section or body of the message data and MUST NOT
   do so except to add its own "Received:" header field ([Section 4.4](#section-4.4))
   and, optionally, to attempt to detect looping in the mail system (see
   [Section 6.3](#section-6.3)).  Of course, this prohibition also applies to any
   modifications of these header fields or text (see also [Section 7.9](#section-7.9)).

[3.7](#section-3.7).  Mail Gatewaying

   While the relay function discussed above operates within the Internet
   SMTP transport service environment, MX records or various forms of
   explicit routing may require that an intermediate SMTP server perform
   a translation function between one transport service and another.  As
   discussed in [Section 2.3.10](#section-2.3.10), when such a system is at the boundary
   between two transport service environments, we refer to it as a
   "gateway" or "gateway SMTP".

   Gatewaying mail between different mail environments, such as
   different mail formats and protocols, is complex and does not easily
   yield to standardization.  However, some general requirements may be
   given for a gateway between the Internet and another mail
   environment.

[3.7.1](#section-3.7.1).  Header Fields in Gatewaying

   Header fields MAY be rewritten when necessary as messages are
   gatewayed across mail environment boundaries.  This may involve
   inspecting the message body or interpreting the local-part of the
   destination address in spite of the prohibitions in [Section 6.4](#section-6.4).

   Other mail systems gatewayed to the Internet often use a subset of
   the [RFC 822](./rfc822) header section or provide similar functionality with a
   different syntax, but some of these mail systems do not have an
   equivalent to the SMTP envelope.  Therefore, when a message leaves
   the Internet environment, it may be necessary to fold the SMTP
   envelope information into the message header section.  A possible
   solution would be to create new header fields to carry the envelope
   information (e.g., "X-SMTP-MAIL:" and "X-SMTP-RCPT:"); however, this
   would require changes in mail programs in foreign environments and
   might risk disclosure of private information (see [Section 7.2](#section-7.2)).

Klensin                     Standards Track                    [Page 28]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[3.7.2](#section-3.7.2).  Received Lines in Gatewaying

   When forwarding a message into or out of the Internet environment, a
   gateway MUST prepend a Received: line, but it MUST NOT alter in any
   way a Received: line that is already in the header section.

   "Received:" header fields of messages originating from other
   environments may not conform exactly to this specification.  However,
   the most important use of Received: lines is for debugging mail
   faults, and this debugging can be severely hampered by well-meaning
   gateways that try to "fix" a Received: line.  As another consequence
   of trace header fields arising in non-SMTP environments, receiving
   systems MUST NOT reject mail based on the format of a trace header
   field and SHOULD be extremely robust in the light of unexpected
   information or formats in those header fields.

   The gateway SHOULD indicate the environment and protocol in the "via"
   clauses of Received header field(s) that it supplies.

[3.7.3](#section-3.7.3).  Addresses in Gatewaying

   From the Internet side, the gateway SHOULD accept all valid address
   formats in SMTP commands and in the [RFC 822](./rfc822) header section, and all
   valid [RFC 822](./rfc822) messages.  Addresses and header fields generated by
   gateways MUST conform to applicable standards (including this one and
   [RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")]).  Gateways are, of course, subject to the same rules
   for handling source routes as those described for other SMTP systems
   in [Section 3.3](#section-3.3).

[3.7.4](#section-3.7.4).  Other Header Fields in Gatewaying

   The gateway MUST ensure that all header fields of a message that it
   forwards into the Internet mail environment meet the requirements for
   Internet mail.  In particular, all addresses in "From:", "To:",
   "Cc:", etc., header fields MUST be transformed (if necessary) to
   satisfy the standard header syntax of [RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")], MUST reference
   only fully-qualified domain names, and MUST be effective and useful
   for sending replies.  The translation algorithm used to convert mail
   from the Internet protocols to another environment's protocol SHOULD
   ensure that error messages from the foreign mail environment are
   delivered to the reverse-path from the SMTP envelope, not to an
   address in the "From:", "Sender:", or similar header fields of the
   message.

Klensin                     Standards Track                    [Page 29]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[3.7.5](#section-3.7.5).  Envelopes in Gatewaying

   Similarly, when forwarding a message from another environment into
   the Internet, the gateway SHOULD set the envelope return path in
   accordance with an error message return address, if supplied by the
   foreign environment.  If the foreign environment has no equivalent
   concept, the gateway must select and use a best approximation, with
   the message originator's address as the default of last resort.

[3.8](#section-3.8).  Terminating Sessions and Connections

   An SMTP connection is terminated when the client sends a QUIT
   command.  The server responds with a positive reply code, after which
   it closes the connection.

   An SMTP server MUST NOT intentionally close the connection under
   normal operational circumstances (see [Section 7.8](#section-7.8)) except:

   o  After receiving a QUIT command and responding with a 221 reply.

   o  After detecting the need to shut down the SMTP service and
      returning a 421 response code.  This response code can be issued
      after the server receives any command or, if necessary,
      asynchronously from command receipt (on the assumption that the
      client will receive it after the next command is issued).

   o  After a timeout, as specified in [Section 4.5.3.2](#section-4.5.3.2), occurs waiting
      for the client to send a command or data.

   In particular, a server that closes connections in response to
   commands that are not understood is in violation of this
   specification.  Servers are expected to be tolerant of unknown
   commands, issuing a 500 reply and awaiting further instructions from
   the client.

   An SMTP server that is forcibly shut down via external means SHOULD
   attempt to send a line containing a 421 response code to the SMTP
   client before exiting.  The SMTP client will normally read the 421
   response code after sending its next command.

   SMTP clients that experience a connection close, reset, or other
   communications failure due to circumstances not under their control
   (in violation of the intent of this specification but sometimes
   unavoidable) SHOULD, to maintain the robustness of the mail system,
   treat the mail transaction as if a 451 response had been received and
   act accordingly.

Klensin                     Standards Track                    [Page 30]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[3.9](#section-3.9).  Mailing Lists and Aliases

   An SMTP-capable host SHOULD support both the alias and the list
   models of address expansion for multiple delivery.  When a message is
   delivered or forwarded to each address of an expanded list form, the
   return address in the envelope ("MAIL FROM:") MUST be changed to be
   the address of a person or other entity who administers the list.
   However, in this case, the message header section ([RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")]) MUST
   be left unchanged; in particular, the "From" field of the header
   section is unaffected.

   An important mail facility is a mechanism for multi-destination
   delivery of a single message, by transforming (or "expanding" or
   "exploding") a pseudo-mailbox address into a list of destination
   mailbox addresses.  When a message is sent to such a pseudo-mailbox
   (sometimes called an "exploder"), copies are forwarded or
   redistributed to each mailbox in the expanded list.  Servers SHOULD
   simply utilize the addresses on the list; application of heuristics
   or other matching rules to eliminate some addresses, such as that of
   the originator, is strongly discouraged.  We classify such a pseudo-
   mailbox as an "alias" or a "list", depending upon the expansion
   rules.

[3.9.1](#section-3.9.1).  Alias

   To expand an alias, the recipient mailer simply replaces the pseudo-
   mailbox address in the envelope with each of the expanded addresses
   in turn; the rest of the envelope and the message body are left
   unchanged.  The message is then delivered or forwarded to each
   expanded address.

[3.9.2](#section-3.9.2).  List

   A mailing list may be said to operate by "redistribution" rather than
   by "forwarding".  To expand a list, the recipient mailer replaces the
   pseudo-mailbox address in the envelope with each of the expanded
   addresses in turn.  The return (backward-pointing) address in the
   envelope is changed so that all error messages generated by the final
   deliveries will be returned to a list administrator, not to the
   message originator, who generally has no control over the contents of
   the list and will typically find error messages annoying.  Note that
   the key difference between handling aliases ([Section 3.9.1](#section-3.9.1)) and
   forwarding (this subsection) is the change to the backward-pointing
   address in this case.  When a list constrains its processing to the
   very limited set of modifications and actions described here, it is
   attempting to emulate an MTA; such lists can be treated as a
   continuation in email transit.

Klensin                     Standards Track                    [Page 31]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   There exist mailing lists that perform additional, sometimes
   extensive, modifications to a message and its envelope.  Such mailing
   lists need to be viewed as full MUAs, which accept a delivery and
   post a new message.

[4](#section-4).  The SMTP Specifications

[4.1](#section-4.1).  SMTP Commands

[4.1.1](#section-4.1.1).  Command Semantics and Syntax

   The SMTP commands define the mail transfer or the mail system
   function requested by the user.  SMTP commands are character strings
   terminated by <CRLF>.  The commands themselves are alphabetic
   characters terminated by <SP> if parameters follow and <CRLF>
   otherwise.  (In the interest of improved interoperability, SMTP
   receivers SHOULD tolerate trailing white space before the terminating
   <CRLF>.)  The syntax of the local part of a mailbox MUST conform to
   receiver site conventions and the syntax specified in [Section 4.1.2](#section-4.1.2).
   The SMTP commands are discussed below.  The SMTP replies are
   discussed in [Section 4.2](#section-4.2).

   A mail transaction involves several data objects that are
   communicated as arguments to different commands.  The reverse-path is
   the argument of the MAIL command, the forward-path is the argument of
   the RCPT command, and the mail data is the argument of the DATA
   command.  These arguments or data objects must be transmitted and
   held, pending the confirmation communicated by the end of mail data
   indication that finalizes the transaction.  The model for this is
   that distinct buffers are provided to hold the types of data objects;
   that is, there is a reverse-path buffer, a forward-path buffer, and a
   mail data buffer.  Specific commands cause information to be appended
   to a specific buffer, or cause one or more buffers to be cleared.

   Several commands (RSET, DATA, QUIT) are specified as not permitting
   parameters.  In the absence of specific extensions offered by the
   server and accepted by the client, clients MUST NOT send such
   parameters and servers SHOULD reject commands containing them as
   having invalid syntax.

[4.1.1.1](#section-4.1.1.1).  Extended HELLO (EHLO) or HELLO (HELO)

   These commands are used to identify the SMTP client to the SMTP
   server.  The argument clause contains the fully-qualified domain name
   of the SMTP client, if one is available.  In situations in which the
   SMTP client system does not have a meaningful domain name (e.g., when
   its address is dynamically allocated and no reverse mapping record is

Klensin                     Standards Track                    [Page 32]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   available), the client SHOULD send an address literal (see
   [Section 4.1.3](#section-4.1.3)).

   [RFC 2821](./rfc2821), and some earlier informal practices, encouraged following
   the literal by information that would help to identify the client
   system.  That convention was not widely supported, and many SMTP
   servers considered it an error.  In the interest of interoperability,
   it is probably wise for servers to be prepared for this string to
   occur, but SMTP clients SHOULD NOT send it.

   The SMTP server identifies itself to the SMTP client in the
   connection greeting reply and in the response to this command.

   A client SMTP SHOULD start an SMTP session by issuing the EHLO
   command.  If the SMTP server supports the SMTP service extensions, it
   will give a successful response, a failure response, or an error
   response.  If the SMTP server, in violation of this specification,
   does not support any SMTP service extensions, it will generate an
   error response.  Older client SMTP systems MAY, as discussed above,
   use HELO (as specified in [RFC 821](./rfc821)) instead of EHLO, and servers MUST
   support the HELO command and reply properly to it.  In any event, a
   client MUST issue HELO or EHLO before starting a mail transaction.

   These commands, and a "250 OK" reply to one of them, confirm that
   both the SMTP client and the SMTP server are in the initial state,
   that is, there is no transaction in progress and all state tables and
   buffers are cleared.

   Syntax:

   ehlo           = "EHLO" SP ( Domain / address-literal ) CRLF

   helo           = "HELO" SP Domain CRLF

   Normally, the response to EHLO will be a multiline reply.  Each line
   of the response contains a keyword and, optionally, one or more
   parameters.  Following the normal syntax for multiline replies, these
   keywords follow the code (250) and a hyphen for all but the last
   line, and the code and a space for the last line.  The syntax for a
   positive response, using the ABNF notation and terminal symbols of
   [RFC 5234](./rfc5234) [[7](#ref-7 "\"Augmented BNF for Syntax Specifications: ABNF\"")], is:

   ehlo-ok-rsp    = ( "250" SP Domain [ SP ehlo-greet ] CRLF )
                    / ( "250-" Domain [ SP ehlo-greet ] CRLF
                    *( "250-" ehlo-line CRLF )
                    "250" SP ehlo-line CRLF )

Klensin                     Standards Track                    [Page 33]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   ehlo-greet     = 1*(%d0-9 / %d11-12 / %d14-127)
                    ; string of any characters other than CR or LF

   ehlo-line      = ehlo-keyword *( SP ehlo-param )

   ehlo-keyword   = (ALPHA / DIGIT) *(ALPHA / DIGIT / "-")
                    ; additional syntax of ehlo-params depends on
                    ; ehlo-keyword

   ehlo-param     = 1*(%d33-126)
                    ; any CHAR excluding <SP> and all
                    ; control characters (US-ASCII 0-31 and 127
                    ; inclusive)

   Although EHLO keywords may be specified in upper, lower, or mixed
   case, they MUST always be recognized and processed in a case-
   insensitive manner.  This is simply an extension of practices
   specified in [RFC 821](./rfc821) and [Section 2.4](#section-2.4).

   The EHLO response MUST contain keywords (and associated parameters if
   required) for all commands not listed as "required" in [Section 4.5.1](#section-4.5.1)
   excepting only private-use commands as described in [Section 4.1.5](#section-4.1.5).
   Private-use commands MAY be listed.

[4.1.1.2](#section-4.1.1.2).  MAIL (MAIL)

   This command is used to initiate a mail transaction in which the mail
   data is delivered to an SMTP server that may, in turn, deliver it to
   one or more mailboxes or pass it on to another system (possibly using
   SMTP).  The argument clause contains a reverse-path and may contain
   optional parameters.  In general, the MAIL command may be sent only
   when no mail transaction is in progress, see [Section 4.1.4](#section-4.1.4).

   The reverse-path consists of the sender mailbox.  Historically, that
   mailbox might optionally have been preceded by a list of hosts, but
   that behavior is now deprecated (see [Appendix C](#appendix-C)).  In some types of
   reporting messages for which a reply is likely to cause a mail loop
   (for example, mail delivery and non-delivery notifications), the
   reverse-path may be null (see [Section 3.6](#section-3.6)).

   This command clears the reverse-path buffer, the forward-path buffer,
   and the mail data buffer, and it inserts the reverse-path information
   from its argument clause into the reverse-path buffer.

   If service extensions were negotiated, the MAIL command may also
   carry parameters associated with a particular service extension.

Klensin                     Standards Track                    [Page 34]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Syntax:

   mail = "MAIL FROM:" Reverse-path
                                       [SP Mail-parameters] CRLF

[4.1.1.3](#section-4.1.1.3).  RECIPIENT (RCPT)

   This command is used to identify an individual recipient of the mail
   data; multiple recipients are specified by multiple uses of this
   command.  The argument clause contains a forward-path and may contain
   optional parameters.

   The forward-path normally consists of the required destination
   mailbox.  Sending systems SHOULD NOT generate the optional list of
   hosts known as a source route.  Receiving systems MUST recognize
   source route syntax but SHOULD strip off the source route
   specification and utilize the domain name associated with the mailbox
   as if the source route had not been provided.

   Similarly, relay hosts SHOULD strip or ignore source routes, and
   names MUST NOT be copied into the reverse-path.  When mail reaches
   its ultimate destination (the forward-path contains only a
   destination mailbox), the SMTP server inserts it into the destination
   mailbox in accordance with its host mail conventions.

   This command appends its forward-path argument to the forward-path
   buffer; it does not change the reverse-path buffer nor the mail data
   buffer.

   For example, mail received at relay host xyz.com with envelope
   commands

      MAIL FROM:<userx@y.foo.org>
      RCPT TO:<@hosta.int,@jkl.org:userc@d.bar.org>

   will normally be sent directly on to host d.bar.org with envelope
   commands

      MAIL FROM:<userx@y.foo.org>
      RCPT TO:<userc@d.bar.org>

   As provided in [Appendix C](#appendix-C), xyz.com MAY also choose to relay the
   message to hosta.int, using the envelope commands

      MAIL FROM:<userx@y.foo.org>
      RCPT TO:<@hosta.int,@jkl.org:userc@d.bar.org>

Klensin                     Standards Track                    [Page 35]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   or to jkl.org, using the envelope commands

      MAIL FROM:<userx@y.foo.org>
      RCPT TO:<@jkl.org:userc@d.bar.org>

   Attempting to use relaying this way is now strongly discouraged.
   Since hosts are not required to relay mail at all, xyz.com MAY also
   reject the message entirely when the RCPT command is received, using
   a 550 code (since this is a "policy reason").

   If service extensions were negotiated, the RCPT command may also
   carry parameters associated with a particular service extension
   offered by the server.  The client MUST NOT transmit parameters other
   than those associated with a service extension offered by the server
   in its EHLO response.

   Syntax:

      rcpt = "RCPT TO:" ( "<Postmaster@" Domain ">" / "<Postmaster>" /
                  Forward-path ) [SP Rcpt-parameters] CRLF

                  Note that, in a departure from the usual rules for
                  local-parts, the "Postmaster" string shown above is
                  treated as case-insensitive.

[4.1.1.4](#section-4.1.1.4).  DATA (DATA)

   The receiver normally sends a 354 response to DATA, and then treats
   the lines (strings ending in <CRLF> sequences, as described in
   [Section 2.3.7](#section-2.3.7)) following the command as mail data from the sender.
   This command causes the mail data to be appended to the mail data
   buffer.  The mail data may contain any of the 128 ASCII character
   codes, although experience has indicated that use of control
   characters other than SP, HT, CR, and LF may cause problems and
   SHOULD be avoided when possible.

   The mail data are terminated by a line containing only a period, that
   is, the character sequence "<CRLF>.<CRLF>", where the first <CRLF> is
   actually the terminator of the previous line (see [Section 4.5.2](#section-4.5.2)).
   This is the end of mail data indication.  The first <CRLF> of this
   terminating sequence is also the <CRLF> that ends the final line of
   the data (message text) or, if there was no mail data, ends the DATA
   command itself (the "no mail data" case does not conform to this
   specification since it would require that neither the trace header
   fields required by this specification nor the message header section
   required by [RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")] be transmitted).  An extra <CRLF> MUST NOT
   be added, as that would cause an empty line to be added to the
   message.  The only exception to this rule would arise if the message

Klensin                     Standards Track                    [Page 36]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   body were passed to the originating SMTP-sender with a final "line"
   that did not end in <CRLF>; in that case, the originating SMTP system
   MUST either reject the message as invalid or add <CRLF> in order to
   have the receiving SMTP server recognize the "end of data" condition.

   The custom of accepting lines ending only in <LF>, as a concession to
   non-conforming behavior on the part of some UNIX systems, has proven
   to cause more interoperability problems than it solves, and SMTP
   server systems MUST NOT do this, even in the name of improved
   robustness.  In particular, the sequence "<LF>.<LF>" (bare line
   feeds, without carriage returns) MUST NOT be treated as equivalent to
   <CRLF>.<CRLF> as the end of mail data indication.

   Receipt of the end of mail data indication requires the server to
   process the stored mail transaction information.  This processing
   consumes the information in the reverse-path buffer, the forward-path
   buffer, and the mail data buffer, and on the completion of this
   command these buffers are cleared.  If the processing is successful,
   the receiver MUST send an OK reply.  If the processing fails, the
   receiver MUST send a failure reply.  The SMTP model does not allow
   for partial failures at this point: either the message is accepted by
   the server for delivery and a positive response is returned or it is
   not accepted and a failure reply is returned.  In sending a positive
   "250 OK" completion reply to the end of data indication, the receiver
   takes full responsibility for the message (see [Section 6.1](#section-6.1)).  Errors
   that are diagnosed subsequently MUST be reported in a mail message,
   as discussed in [Section 4.4](#section-4.4).

   When the SMTP server accepts a message either for relaying or for
   final delivery, it inserts a trace record (also referred to
   interchangeably as a "time stamp line" or "Received" line) at the top
   of the mail data.  This trace record indicates the identity of the
   host that sent the message, the identity of the host that received
   the message (and is inserting this time stamp), and the date and time
   the message was received.  Relayed messages will have multiple time
   stamp lines.  Details for formation of these lines, including their
   syntax, is specified in [Section 4.4](#section-4.4).

   Additional discussion about the operation of the DATA command appears
   in [Section 3.3](#section-3.3).

   Syntax:

      data = "DATA" CRLF

Klensin                     Standards Track                    [Page 37]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[4.1.1.5](#section-4.1.1.5).  RESET (RSET)

   This command specifies that the current mail transaction will be
   aborted.  Any stored sender, recipients, and mail data MUST be
   discarded, and all buffers and state tables cleared.  The receiver
   MUST send a "250 OK" reply to a RSET command with no arguments.  A
   reset command may be issued by the client at any time.  It is
   effectively equivalent to a NOOP (i.e., it has no effect) if issued
   immediately after EHLO, before EHLO is issued in the session, after
   an end of data indicator has been sent and acknowledged, or
   immediately before a QUIT.  An SMTP server MUST NOT close the
   connection as the result of receiving a RSET; that action is reserved
   for QUIT (see [Section 4.1.1.10](#section-4.1.1.10)).

   Since EHLO implies some additional processing and response by the
   server, RSET will normally be more efficient than reissuing that
   command, even though the formal semantics are the same.

   There are circumstances, contrary to the intent of this
   specification, in which an SMTP server may receive an indication that
   the underlying TCP connection has been closed or reset.  To preserve
   the robustness of the mail system, SMTP servers SHOULD be prepared
   for this condition and SHOULD treat it as if a QUIT had been received
   before the connection disappeared.

   Syntax:

      rset = "RSET" CRLF

[4.1.1.6](#section-4.1.1.6).  VERIFY (VRFY)

   This command asks the receiver to confirm that the argument
   identifies a user or mailbox.  If it is a user name, information is
   returned as specified in [Section 3.5](#section-3.5).

   This command has no effect on the reverse-path buffer, the forward-
   path buffer, or the mail data buffer.

   Syntax:

      vrfy = "VRFY" SP String CRLF

Klensin                     Standards Track                    [Page 38]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[4.1.1.7](#section-4.1.1.7).  EXPAND (EXPN)

   This command asks the receiver to confirm that the argument
   identifies a mailing list, and if so, to return the membership of
   that list.  If the command is successful, a reply is returned
   containing information as described in [Section 3.5](#section-3.5).  This reply will
   have multiple lines except in the trivial case of a one-member list.

   This command has no effect on the reverse-path buffer, the forward-
   path buffer, or the mail data buffer, and it may be issued at any
   time.

   Syntax:

      expn = "EXPN" SP String CRLF

[4.1.1.8](#section-4.1.1.8).  HELP (HELP)

   This command causes the server to send helpful information to the
   client.  The command MAY take an argument (e.g., any command name)
   and return more specific information as a response.

   This command has no effect on the reverse-path buffer, the forward-
   path buffer, or the mail data buffer, and it may be issued at any
   time.

   SMTP servers SHOULD support HELP without arguments and MAY support it
   with arguments.

   Syntax:

      help = "HELP" [ SP String ] CRLF

Klensin                     Standards Track                    [Page 39]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[4.1.1.9](#section-4.1.1.9).  NOOP (NOOP)

   This command does not affect any parameters or previously entered
   commands.  It specifies no action other than that the receiver send a
   "250 OK" reply.

   This command has no effect on the reverse-path buffer, the forward-
   path buffer, or the mail data buffer, and it may be issued at any
   time.  If a parameter string is specified, servers SHOULD ignore it.

   Syntax:

      noop = "NOOP" [ SP String ] CRLF

[4.1.1.10](#section-4.1.1.10).  QUIT (QUIT)

   This command specifies that the receiver MUST send a "221 OK" reply,
   and then close the transmission channel.

   The receiver MUST NOT intentionally close the transmission channel
   until it receives and replies to a QUIT command (even if there was an
   error).  The sender MUST NOT intentionally close the transmission
   channel until it sends a QUIT command, and it SHOULD wait until it
   receives the reply (even if there was an error response to a previous
   command).  If the connection is closed prematurely due to violations
   of the above or system or network failure, the server MUST cancel any
   pending transaction, but not undo any previously completed
   transaction, and generally MUST act as if the command or transaction
   in progress had received a temporary error (i.e., a 4yz response).

   The QUIT command may be issued at any time.  Any current uncompleted
   mail transaction will be aborted.

   Syntax:

      quit = "QUIT" CRLF

[4.1.1.11](#section-4.1.1.11).  Mail-Parameter and Rcpt-Parameter Error Responses

   If the server SMTP does not recognize or cannot implement one or more
   of the parameters associated with a particular MAIL FROM or RCPT TO
   command, it will return code 555.

   If, for some reason, the server is temporarily unable to accommodate
   one or more of the parameters associated with a MAIL FROM or RCPT TO
   command, and if the definition of the specific parameter does not
   mandate the use of another code, it should return code 455.

Klensin                     Standards Track                    [Page 40]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Errors specific to particular parameters and their values will be
   specified in the parameter's defining RFC.

[4.1.2](#section-4.1.2).  Command Argument Syntax

   The syntax of the argument clauses of the above commands (using the
   syntax specified in [RFC 5234](./rfc5234) [[7](#ref-7 "\"Augmented BNF for Syntax Specifications: ABNF\"")] where applicable) is given below.
   Some of the productions given below are used only in conjunction with
   source routes as described in [Appendix C](#appendix-C).  Terminals not defined in
   this document, such as ALPHA, DIGIT, SP, CR, LF, CRLF, are as defined
   in the "core" syntax in [Section 6 of RFC 5234](./rfc5234#section-6) [[7](#ref-7 "\"Augmented BNF for Syntax Specifications: ABNF\"")] or in the message
   format syntax in [RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")].

   Reverse-path   = Path / "<>"

   Forward-path   = Path

   Path           = "<" [ A-d-l ":" ] Mailbox ">"

   A-d-l          = At-domain *( "," At-domain )
                  ; Note that this form, the so-called "source
                  ; route", MUST BE accepted, SHOULD NOT be
                  ; generated, and SHOULD be ignored.

   At-domain      = "@" Domain

   Mail-parameters  = esmtp-param *(SP esmtp-param)

   Rcpt-parameters  = esmtp-param *(SP esmtp-param)

   esmtp-param    = esmtp-keyword ["=" esmtp-value]

   esmtp-keyword  = (ALPHA / DIGIT) *(ALPHA / DIGIT / "-")

   esmtp-value    = 1*(%d33-60 / %d62-126)
                  ; any CHAR excluding "=", SP, and control
                  ; characters.  If this string is an email address,
                  ; i.e., a Mailbox, then the "xtext" syntax [[32](#ref-32 "\"Simple Mail Transfer Protocol (SMTP) Service Extension for Delivery Status Notifications (DSNs)\"")]
                  ; SHOULD be used.

   Keyword        = Ldh-str

   Argument       = Atom

   Domain         = sub-domain *("." sub-domain)

Klensin                     Standards Track                    [Page 41]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   sub-domain     = Let-dig [Ldh-str]

   Let-dig        = ALPHA / DIGIT

   Ldh-str        = *( ALPHA / DIGIT / "-" ) Let-dig

   address-literal  = "[" ( IPv4-address-literal /
                    IPv6-address-literal /
                    General-address-literal ) "]"
                    ; See [Section 4.1.3](#section-4.1.3)

   Mailbox        = Local-part "@" ( Domain / address-literal )

   Local-part     = Dot-string / Quoted-string
                  ; MAY be case-sensitive

   Dot-string     = Atom *("."  Atom)

   Atom           = 1*atext

   Quoted-string  = DQUOTE *QcontentSMTP DQUOTE

   QcontentSMTP   = qtextSMTP / quoted-pairSMTP

   quoted-pairSMTP  = %d92 %d32-126
                    ; i.e., backslash followed by any ASCII
                    ; graphic (including itself) or SPace

   qtextSMTP      = %d32-33 / %d35-91 / %d93-126
                  ; i.e., within a quoted string, any
                  ; ASCII graphic or space is permitted
                  ; without blackslash-quoting except
                  ; double-quote and the backslash itself.

   String         = Atom / Quoted-string

   While the above definition for Local-part is relatively permissive,
   for maximum interoperability, a host that expects to receive mail
   SHOULD avoid defining mailboxes where the Local-part requires (or
   uses) the Quoted-string form or where the Local-part is case-
   sensitive.  For any purposes that require generating or comparing
   Local-parts (e.g., to specific mailbox names), all quoted forms MUST
   be treated as equivalent, and the sending system SHOULD transmit the
   form that uses the minimum quoting possible.

   Systems MUST NOT define mailboxes in such a way as to require the use
   in SMTP of non-ASCII characters (octets with the high order bit set

Klensin                     Standards Track                    [Page 42]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   to one) or ASCII "control characters" (decimal value 0-31 and 127).
   These characters MUST NOT be used in MAIL or RCPT commands or other
   commands that require mailbox names.

   Note that the backslash, "\", is a quote character, which is used to
   indicate that the next character is to be used literally (instead of
   its normal interpretation).  For example, "Joe\,Smith" indicates a
   single nine-character user name string with the comma being the
   fourth character of that string.

   To promote interoperability and consistent with long-standing
   guidance about conservative use of the DNS in naming and applications
   (e.g., see [Section 2.3.1](#section-2.3.1) of the base DNS document, [RFC 1035](./rfc1035) [[2](#ref-2 "\"Domain names - implementation and specification\"")]),
   characters outside the set of alphabetic characters, digits, and
   hyphen MUST NOT appear in domain name labels for SMTP clients or
   servers.  In particular, the underscore character is not permitted.
   SMTP servers that receive a command in which invalid character codes
   have been employed, and for which there are no other reasons for
   rejection, MUST reject that command with a 501 response (this rule,
   like others, could be overridden by appropriate SMTP extensions).

[4.1.3](#section-4.1.3).  Address Literals

   Sometimes a host is not known to the domain name system and
   communication (and, in particular, communication to report and repair
   the error) is blocked.  To bypass this barrier, a special literal
   form of the address is allowed as an alternative to a domain name.
   For IPv4 addresses, this form uses four small decimal integers
   separated by dots and enclosed by brackets such as [123.255.37.2],
   which indicates an (IPv4) Internet Address in sequence-of-octets
   form.  For IPv6 and other forms of addressing that might eventually
   be standardized, the form consists of a standardized "tag" that
   identifies the address syntax, a colon, and the address itself, in a
   format specified as part of the relevant standards (i.e., [RFC 4291](./rfc4291)
   [[8](#ref-8 "\"IP Version 6 Addressing Architecture\"")] for IPv6).

   Specifically:

   IPv4-address-literal  = Snum 3("."  Snum)

   IPv6-address-literal  = "IPv6:" IPv6-addr

   General-address-literal  = Standardized-tag ":" 1*dcontent

   Standardized-tag  = Ldh-str
                     ; Standardized-tag MUST be specified in a
                     ; Standards-Track RFC and registered with IANA

Klensin                     Standards Track                    [Page 43]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   dcontent       = %d33-90 / ; Printable US-ASCII
                  %d94-126 ; excl. "[", "\", "]"

   Snum           = 1*3DIGIT
                  ; representing a decimal integer
                  ; value in the range 0 through 255

   IPv6-addr      = IPv6-full / IPv6-comp / IPv6v4-full / IPv6v4-comp

   IPv6-hex       = 1*4HEXDIG

   IPv6-full      = IPv6-hex 7(":" IPv6-hex)

   IPv6-comp      = [IPv6-hex *5(":" IPv6-hex)] "::"
                  [IPv6-hex *5(":" IPv6-hex)]
                  ; The "::" represents at least 2 16-bit groups of
                  ; zeros.  No more than 6 groups in addition to the
                  ; "::" may be present.

   IPv6v4-full    = IPv6-hex 5(":" IPv6-hex) ":" IPv4-address-literal

   IPv6v4-comp    = [IPv6-hex *3(":" IPv6-hex)] "::"
                  [IPv6-hex *3(":" IPv6-hex) ":"]
                  IPv4-address-literal
                  ; The "::" represents at least 2 16-bit groups of
                  ; zeros.  No more than 4 groups in addition to the
                  ; "::" and IPv4-address-literal may be present.

[4.1.4](#section-4.1.4).  Order of Commands

   There are restrictions on the order in which these commands may be
   used.

   A session that will contain mail transactions MUST first be
   initialized by the use of the EHLO command.  An SMTP server SHOULD
   accept commands for non-mail transactions (e.g., VRFY or EXPN)
   without this initialization.

   An EHLO command MAY be issued by a client later in the session.  If
   it is issued after the session begins and the EHLO command is
   acceptable to the SMTP server, the SMTP server MUST clear all buffers
   and reset the state exactly as if a RSET command had been issued.  In
   other words, the sequence of RSET followed immediately by EHLO is
   redundant, but not harmful other than in the performance cost of
   executing unnecessary commands.

   If the EHLO command is not acceptable to the SMTP server, 501, 500,
   502, or 550 failure replies MUST be returned as appropriate.  The

Klensin                     Standards Track                    [Page 44]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   SMTP server MUST stay in the same state after transmitting these
   replies that it was in before the EHLO was received.

   The SMTP client MUST, if possible, ensure that the domain parameter
   to the EHLO command is a primary host name as specified for this
   command in [Section 2.3.5](#section-2.3.5).  If this is not possible (e.g., when the
   client's address is dynamically assigned and the client does not have
   an obvious name), an address literal SHOULD be substituted for the
   domain name.

   An SMTP server MAY verify that the domain name argument in the EHLO
   command actually corresponds to the IP address of the client.
   However, if the verification fails, the server MUST NOT refuse to
   accept a message on that basis.  Information captured in the
   verification attempt is for logging and tracing purposes.  Note that
   this prohibition applies to the matching of the parameter to its IP
   address only; see [Section 7.9](#section-7.9) for a more extensive discussion of
   rejecting incoming connections or mail messages.

   The NOOP, HELP, EXPN, VRFY, and RSET commands can be used at any time
   during a session, or without previously initializing a session.  SMTP
   servers SHOULD process these normally (that is, not return a 503
   code) even if no EHLO command has yet been received; clients SHOULD
   open a session with EHLO before sending these commands.

   If these rules are followed, the example in [RFC 821](./rfc821) that shows "550
   access denied to you" in response to an EXPN command is incorrect
   unless an EHLO command precedes the EXPN or the denial of access is
   based on the client's IP address or other authentication or
   authorization-determining mechanisms.

   The MAIL command (or the obsolete SEND, SOML, or SAML commands)
   begins a mail transaction.  Once started, a mail transaction consists
   of a transaction beginning command, one or more RCPT commands, and a
   DATA command, in that order.  A mail transaction may be aborted by
   the RSET, a new EHLO, or the QUIT command.  There may be zero or more
   transactions in a session.  MAIL (or SEND, SOML, or SAML) MUST NOT be
   sent if a mail transaction is already open, i.e., it should be sent
   only if no mail transaction had been started in the session, or if
   the previous one successfully concluded with a successful DATA
   command, or if the previous one was aborted, e.g., with a RSET or new
   EHLO.

   If the transaction beginning command argument is not acceptable, a
   501 failure reply MUST be returned and the SMTP server MUST stay in
   the same state.  If the commands in a transaction are out of order to
   the degree that they cannot be processed by the server, a 503 failure

Klensin                     Standards Track                    [Page 45]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   reply MUST be returned and the SMTP server MUST stay in the same
   state.

   The last command in a session MUST be the QUIT command.  The QUIT
   command SHOULD be used by the client SMTP to request connection
   closure, even when no session opening command was sent and accepted.

[4.1.5](#section-4.1.5).  Private-Use Commands

   As specified in [Section 2.2.2](#section-2.2.2), commands starting in "X" may be used
   by bilateral agreement between the client (sending) and server
   (receiving) SMTP agents.  An SMTP server that does not recognize such
   a command is expected to reply with "500 Command not recognized".  An
   extended SMTP server MAY list the feature names associated with these
   private commands in the response to the EHLO command.

   Commands sent or accepted by SMTP systems that do not start with "X"
   MUST conform to the requirements of [Section 2.2.2](#section-2.2.2).

[4.2](#section-4.2).  SMTP Replies

   Replies to SMTP commands serve to ensure the synchronization of
   requests and actions in the process of mail transfer and to guarantee
   that the SMTP client always knows the state of the SMTP server.
   Every command MUST generate exactly one reply.

   The details of the command-reply sequence are described in
   [Section 4.3](#section-4.3).

   An SMTP reply consists of a three digit number (transmitted as three
   numeric characters) followed by some text unless specified otherwise
   in this document.  The number is for use by automata to determine
   what state to enter next; the text is for the human user.  The three
   digits contain enough encoded information that the SMTP client need
   not examine the text and may either discard it or pass it on to the
   user, as appropriate.  Exceptions are as noted elsewhere in this
   document.  In particular, the 220, 221, 251, 421, and 551 reply codes
   are associated with message text that must be parsed and interpreted
   by machines.  In the general case, the text may be receiver dependent
   and context dependent, so there are likely to be varying texts for
   each reply code.  A discussion of the theory of reply codes is given
   in [Section 4.2.1](#section-4.2.1).  Formally, a reply is defined to be the sequence: a
   three-digit code, <SP>, one line of text, and <CRLF>, or a multiline
   reply (as defined in the same section).  Since, in violation of this
   specification, the text is sometimes not sent, clients that do not
   receive it SHOULD be prepared to process the code alone (with or
   without a trailing space character).  Only the EHLO, EXPN, and HELP
   commands are expected to result in multiline replies in normal

Klensin                     Standards Track                    [Page 46]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   circumstances; however, multiline replies are allowed for any
   command.

   In ABNF, server responses are:

   Greeting       = ( "220 " (Domain / address-literal)
                  [ SP textstring ] CRLF ) /
                  ( "220-" (Domain / address-literal)
                  [ SP textstring ] CRLF
                  *( "220-" [ textstring ] CRLF )
                  "220" [ SP textstring ] CRLF )

   textstring     = 1*(%d09 / %d32-126) ; HT, SP, Printable US-ASCII

   Reply-line     = *( Reply-code "-" [ textstring ] CRLF )
                  Reply-code [ SP textstring ] CRLF

   Reply-code     = %x32-35 %x30-35 %x30-39

   where "Greeting" appears only in the 220 response that announces that
   the server is opening its part of the connection.  (Other possible
   server responses upon connection follow the syntax of Reply-line.)

   An SMTP server SHOULD send only the reply codes listed in this
   document.  An SMTP server SHOULD use the text shown in the examples
   whenever appropriate.

   An SMTP client MUST determine its actions only by the reply code, not
   by the text (except for the "change of address" 251 and 551 and, if
   necessary, 220, 221, and 421 replies); in the general case, any text,
   including no text at all (although senders SHOULD NOT send bare
   codes), MUST be acceptable.  The space (blank) following the reply
   code is considered part of the text.  Whenever possible, a receiver-
   SMTP SHOULD test the first digit (severity indication) of the reply
   code.

   The list of codes that appears below MUST NOT be construed as
   permanent.  While the addition of new codes should be a rare and
   significant activity, with supplemental information in the textual
   part of the response being preferred, new codes may be added as the
   result of new Standards or Standards-Track specifications.
   Consequently, a sender-SMTP MUST be prepared to handle codes not
   specified in this document and MUST do so by interpreting the first
   digit only.

   In the absence of extensions negotiated with the client, SMTP servers
   MUST NOT send reply codes whose first digits are other than 2, 3, 4,

Klensin                     Standards Track                    [Page 47]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   or 5.  Clients that receive such out-of-range codes SHOULD normally
   treat them as fatal errors and terminate the mail transaction.

[4.2.1](#section-4.2.1).  Reply Code Severities and Theory

   The three digits of the reply each have a special significance.  The
   first digit denotes whether the response is good, bad, or incomplete.
   An unsophisticated SMTP client, or one that receives an unexpected
   code, will be able to determine its next action (proceed as planned,
   redo, retrench, etc.) by examining this first digit.  An SMTP client
   that wants to know approximately what kind of error occurred (e.g.,
   mail system error, command syntax error) may examine the second
   digit.  The third digit and any supplemental information that may be
   present is reserved for the finest gradation of information.

   There are four values for the first digit of the reply code:

   2yz  Positive Completion reply
      The requested action has been successfully completed.  A new
      request may be initiated.

   3yz  Positive Intermediate reply
      The command has been accepted, but the requested action is being
      held in abeyance, pending receipt of further information.  The
      SMTP client should send another command specifying this
      information.  This reply is used in command sequence groups (i.e.,
      in DATA).

   4yz  Transient Negative Completion reply
      The command was not accepted, and the requested action did not
      occur.  However, the error condition is temporary, and the action
      may be requested again.  The sender should return to the beginning
      of the command sequence (if any).  It is difficult to assign a
      meaning to "transient" when two different sites (receiver- and
      sender-SMTP agents) must agree on the interpretation.  Each reply
      in this category might have a different time value, but the SMTP
      client SHOULD try again.  A rule of thumb to determine whether a
      reply fits into the 4yz or the 5yz category (see below) is that
      replies are 4yz if they can be successful if repeated without any
      change in command form or in properties of the sender or receiver
      (that is, the command is repeated identically and the receiver
      does not put up a new implementation).

   5yz  Permanent Negative Completion reply
      The command was not accepted and the requested action did not
      occur.  The SMTP client SHOULD NOT repeat the exact request (in
      the same sequence).  Even some "permanent" error conditions can be
      corrected, so the human user may want to direct the SMTP client to

Klensin                     Standards Track                    [Page 48]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

      reinitiate the command sequence by direct action at some point in
      the future (e.g., after the spelling has been changed, or the user
      has altered the account status).

   It is worth noting that the file transfer protocol (FTP) [[34](#ref-34 "\"File Transfer Protocol\"")] uses a
   very similar code architecture and that the SMTP codes are based on
   the FTP model.  However, SMTP uses a one-command, one-response model
   (while FTP is asynchronous) and FTP's 1yz codes are not part of the
   SMTP model.

   The second digit encodes responses in specific categories:

   x0z  Syntax: These replies refer to syntax errors, syntactically
      correct commands that do not fit any functional category, and
      unimplemented or superfluous commands.

   x1z  Information: These are replies to requests for information, such
      as status or help.

   x2z  Connections: These are replies referring to the transmission
      channel.

   x3z  Unspecified.

   x4z  Unspecified.

   x5z  Mail system: These replies indicate the status of the receiver
      mail system vis-a-vis the requested transfer or other mail system
      action.

   The third digit gives a finer gradation of meaning in each category
   specified by the second digit.  The list of replies illustrates this.
   Each reply text is recommended rather than mandatory, and may even
   change according to the command with which it is associated.  On the
   other hand, the reply codes must strictly follow the specifications
   in this section.  Receiver implementations should not invent new
   codes for slightly different situations from the ones described here,
   but rather adapt codes already defined.

   For example, a command such as NOOP, whose successful execution does
   not offer the SMTP client any new information, will return a 250
   reply.  The reply is 502 when the command requests an unimplemented
   non-site-specific action.  A refinement of that is the 504 reply for
   a command that is implemented, but that requests an unimplemented
   parameter.

Klensin                     Standards Track                    [Page 49]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   The reply text may be longer than a single line; in these cases the
   complete text must be marked so the SMTP client knows when it can
   stop reading the reply.  This requires a special format to indicate a
   multiple line reply.

   The format for multiline replies requires that every line, except the
   last, begin with the reply code, followed immediately by a hyphen,
   "-" (also known as minus), followed by text.  The last line will
   begin with the reply code, followed immediately by <SP>, optionally
   some text, and <CRLF>.  As noted above, servers SHOULD send the <SP>
   if subsequent text is not sent, but clients MUST be prepared for it
   to be omitted.

   For example:

      250-First line
      250-Second line
      250-234 Text beginning with numbers
      250 The last line

   In a multiline reply, the reply code on each of the lines MUST be the
   same.  It is reasonable for the client to rely on this, so it can
   make processing decisions based on the code in any line, assuming
   that all others will be the same.  In a few cases, there is important
   data for the client in the reply "text".  The client will be able to
   identify these cases from the current context.

[4.2.2](#section-4.2.2).  Reply Codes by Function Groups

   500  Syntax error, command unrecognized (This may include errors such
      as command line too long)

   501  Syntax error in parameters or arguments

   502  Command not implemented (see [Section 4.2.4](#section-4.2.4))

   503  Bad sequence of commands

   504  Command parameter not implemented

   211  System status, or system help reply

   214  Help message (Information on how to use the receiver or the
      meaning of a particular non-standard command; this reply is useful
      only to the human user)

Klensin                     Standards Track                    [Page 50]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   220  <domain> Service ready

   221  <domain> Service closing transmission channel

   421  <domain> Service not available, closing transmission channel
      (This may be a reply to any command if the service knows it must
      shut down)

   250  Requested mail action okay, completed

   251  User not local; will forward to <forward-path> (See [Section 3.4](#section-3.4))

   252  Cannot VRFY user, but will accept message and attempt delivery
      (See [Section 3.5.3](#section-3.5.3))

   455  Server unable to accommodate parameters

   555  MAIL FROM/RCPT TO parameters not recognized or not implemented

   450  Requested mail action not taken: mailbox unavailable (e.g.,
      mailbox busy or temporarily blocked for policy reasons)

   550  Requested action not taken: mailbox unavailable (e.g., mailbox
      not found, no access, or command rejected for policy reasons)

   451  Requested action aborted: error in processing

   551  User not local; please try <forward-path> (See [Section 3.4](#section-3.4))

   452  Requested action not taken: insufficient system storage

   552  Requested mail action aborted: exceeded storage allocation

   553  Requested action not taken: mailbox name not allowed (e.g.,
      mailbox syntax incorrect)

   354  Start mail input; end with <CRLF>.<CRLF>

   554  Transaction failed (Or, in the case of a connection-opening
      response, "No SMTP service here")

Klensin                     Standards Track                    [Page 51]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[4.2.3](#section-4.2.3).  Reply Codes in Numeric Order

   211  System status, or system help reply

   214  Help message (Information on how to use the receiver or the
      meaning of a particular non-standard command; this reply is useful
      only to the human user)

   220  <domain> Service ready

   221  <domain> Service closing transmission channel

   250  Requested mail action okay, completed

   251  User not local; will forward to <forward-path> (See [Section 3.4](#section-3.4))

   252  Cannot VRFY user, but will accept message and attempt delivery
      (See [Section 3.5.3](#section-3.5.3))

   354  Start mail input; end with <CRLF>.<CRLF>

   421  <domain> Service not available, closing transmission channel
      (This may be a reply to any command if the service knows it must
      shut down)

   450  Requested mail action not taken: mailbox unavailable (e.g.,
      mailbox busy or temporarily blocked for policy reasons)

   451  Requested action aborted: local error in processing

   452  Requested action not taken: insufficient system storage

   455  Server unable to accommodate parameters

   500  Syntax error, command unrecognized (This may include errors such
      as command line too long)

   501  Syntax error in parameters or arguments

   502  Command not implemented (see [Section 4.2.4](#section-4.2.4))

   503  Bad sequence of commands

   504  Command parameter not implemented

   550  Requested action not taken: mailbox unavailable (e.g., mailbox
      not found, no access, or command rejected for policy reasons)

Klensin                     Standards Track                    [Page 52]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   551  User not local; please try <forward-path> (See [Section 3.4](#section-3.4))

   552  Requested mail action aborted: exceeded storage allocation

   553  Requested action not taken: mailbox name not allowed (e.g.,
      mailbox syntax incorrect)

   554  Transaction failed (Or, in the case of a connection-opening
      response, "No SMTP service here")

   555  MAIL FROM/RCPT TO parameters not recognized or not implemented

[4.2.4](#section-4.2.4).  Reply Code 502

   Questions have been raised as to when reply code 502 (Command not
   implemented) SHOULD be returned in preference to other codes. 502
   SHOULD be used when the command is actually recognized by the SMTP
   server, but not implemented.  If the command is not recognized, code
   500 SHOULD be returned.  Extended SMTP systems MUST NOT list
   capabilities in response to EHLO for which they will return 502 (or
   500) replies.

[4.2.5](#section-4.2.5).  Reply Codes after DATA and the Subsequent <CRLF>.<CRLF>

   When an SMTP server returns a positive completion status (2yz code)
   after the DATA command is completed with <CRLF>.<CRLF>, it accepts
   responsibility for:

   o  delivering the message (if the recipient mailbox exists), or

   o  if attempts to deliver the message fail due to transient
      conditions, retrying delivery some reasonable number of times at
      intervals as specified in [Section 4.5.4](#section-4.5.4).

   o  if attempts to deliver the message fail due to permanent
      conditions, or if repeated attempts to deliver the message fail
      due to transient conditions, returning appropriate notification to
      the sender of the original message (using the address in the SMTP
      MAIL command).

   When an SMTP server returns a temporary error status (4yz) code after
   the DATA command is completed with <CRLF>.<CRLF>, it MUST NOT make a
   subsequent attempt to deliver that message.  The SMTP client retains
   responsibility for the delivery of that message and may either return
   it to the user or requeue it for a subsequent attempt (see
   [Section 4.5.4.1](#section-4.5.4.1)).

Klensin                     Standards Track                    [Page 53]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   The user who originated the message SHOULD be able to interpret the
   return of a transient failure status (by mail message or otherwise)
   as a non-delivery indication, just as a permanent failure would be
   interpreted.  If the client SMTP successfully handles these
   conditions, the user will not receive such a reply.

   When an SMTP server returns a permanent error status (5yz) code after
   the DATA command is completed with <CRLF>.<CRLF>, it MUST NOT make
   any subsequent attempt to deliver the message.  As with temporary
   error status codes, the SMTP client retains responsibility for the
   message, but SHOULD not again attempt delivery to the same server
   without user review of the message and response and appropriate
   intervention.

[4.3](#section-4.3).  Sequencing of Commands and Replies

[4.3.1](#section-4.3.1).  Sequencing Overview

   The communication between the sender and receiver is an alternating
   dialogue, controlled by the sender.  As such, the sender issues a
   command and the receiver responds with a reply.  Unless other
   arrangements are negotiated through service extensions, the sender
   MUST wait for this response before sending further commands.  One
   important reply is the connection greeting.  Normally, a receiver
   will send a 220 "Service ready" reply when the connection is
   completed.  The sender SHOULD wait for this greeting message before
   sending any commands.

   Note: all the greeting-type replies have the official name (the
   fully-qualified primary domain name) of the server host as the first
   word following the reply code.  Sometimes the host will have no
   meaningful name.  See [Section 4.1.3](#section-4.1.3) for a discussion of alternatives
   in these situations.

   For example,

      220 ISIF.USC.EDU Service ready

   or

      220 mail.example.com SuperSMTP v 6.1.2 Service ready

   or

      220 [10.0.0.1] Clueless host service ready

   The table below lists alternative success and failure replies for
   each command.  These SHOULD be strictly adhered to.  A receiver MAY

Klensin                     Standards Track                    [Page 54]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   substitute text in the replies, but the meanings and actions implied
   by the code numbers and by the specific command reply sequence MUST
   be preserved.

[4.3.2](#section-4.3.2).  Command-Reply Sequences

   Each command is listed with its usual possible replies.  The prefixes
   used before the possible replies are "I" for intermediate, "S" for
   success, and "E" for error.  Since some servers may generate other
   replies under special circumstances, and to allow for future
   extension, SMTP clients SHOULD, when possible, interpret only the
   first digit of the reply and MUST be prepared to deal with
   unrecognized reply codes by interpreting the first digit only.
   Unless extended using the mechanisms described in [Section 2.2](#section-2.2), SMTP
   servers MUST NOT transmit reply codes to an SMTP client that are
   other than three digits or that do not start in a digit between 2 and
   5 inclusive.

   These sequencing rules and, in principle, the codes themselves, can
   be extended or modified by SMTP extensions offered by the server and
   accepted (requested) by the client.  However, if the target is more
   precise granularity in the codes, rather than codes for completely
   new purposes, the system described in [RFC 3463](./rfc3463) [[25](#ref-25 "\"Enhanced Mail System Status Codes\"")] SHOULD be used in
   preference to the invention of new codes.

   In addition to the codes listed below, any SMTP command can return
   any of the following codes if the corresponding unusual circumstances
   are encountered:

   500  For the "command line too long" case or if the command name was
      not recognized.  Note that producing a "command not recognized"
      error in response to the required subset of these commands is a
      violation of this specification.  Similarly, producing a "command
      too long" message for a command line shorter than 512 characters
      would violate the provisions of [Section 4.5.3.1.4](#section-4.5.3.1.4).

   501  Syntax error in command or arguments.  In order to provide for
      future extensions, commands that are specified in this document as
      not accepting arguments (DATA, RSET, QUIT) SHOULD return a 501
      message if arguments are supplied in the absence of EHLO-
      advertised extensions.

   421  Service shutting down and closing transmission channel

Klensin                     Standards Track                    [Page 55]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Specific sequences are:

      CONNECTION ESTABLISHMENT

         S: 220
         E: 554

      EHLO or HELO

         S: 250
         E: 504 (a conforming implementation could return this code only
         in fairly obscure cases), 550, 502 (permitted only with an old-
         style server that does not support EHLO)

      MAIL

         S: 250
         E: 552, 451, 452, 550, 553, 503, 455, 555

      RCPT

         S: 250, 251 (but see [Section 3.4](#section-3.4) for discussion of 251 and 551)
         E: 550, 551, 552, 553, 450, 451, 452, 503, 455, 555

      DATA

         I: 354 -> data -> S: 250

                           E: 552, 554, 451, 452

                           E: 450, 550 (rejections for policy reasons)

         E: 503, 554

      RSET

         S: 250

      VRFY

         S: 250, 251, 252
         E: 550, 551, 553, 502, 504

      EXPN

         S: 250, 252
         E: 550, 500, 502, 504

Klensin                     Standards Track                    [Page 56]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

      HELP

         S: 211, 214
         E: 502, 504

      NOOP

         S: 250

      QUIT

         S: 221

[4.4](#section-4.4).  Trace Information

   When an SMTP server receives a message for delivery or further
   processing, it MUST insert trace ("time stamp" or "Received")
   information at the beginning of the message content, as discussed in
   [Section 4.1.1.4](#section-4.1.1.4).

   This line MUST be structured as follows:

   o  The FROM clause, which MUST be supplied in an SMTP environment,
      SHOULD contain both (1) the name of the source host as presented
      in the EHLO command and (2) an address literal containing the IP
      address of the source, determined from the TCP connection.

   o  The ID clause MAY contain an "@" as suggested in [RFC 822](./rfc822), but this
      is not required.

   o  If the FOR clause appears, it MUST contain exactly one <path>
      entry, even when multiple RCPT commands have been given.  Multiple
      <path>s raise some security issues and have been deprecated, see
      [Section 7.2](#section-7.2).

   An Internet mail program MUST NOT change or delete a Received: line
   that was previously added to the message header section.  SMTP
   servers MUST prepend Received lines to messages; they MUST NOT change
   the order of existing lines or insert Received lines in any other
   location.

   As the Internet grows, comparability of Received header fields is
   important for detecting problems, especially slow relays.  SMTP
   servers that create Received header fields SHOULD use explicit
   offsets in the dates (e.g., -0800), rather than time zone names of
   any type.  Local time (with an offset) SHOULD be used rather than UT
   when feasible.  This formulation allows slightly more information
   about local circumstances to be specified.  If UT is needed, the

Klensin                     Standards Track                    [Page 57]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   receiver need merely do some simple arithmetic to convert the values.
   Use of UT loses information about the time zone-location of the
   server.  If it is desired to supply a time zone name, it SHOULD be
   included in a comment.

   When the delivery SMTP server makes the "final delivery" of a
   message, it inserts a return-path line at the beginning of the mail
   data.  This use of return-path is required; mail systems MUST support
   it.  The return-path line preserves the information in the <reverse-
   path> from the MAIL command.  Here, final delivery means the message
   has left the SMTP environment.  Normally, this would mean it had been
   delivered to the destination user or an associated mail drop, but in
   some cases it may be further processed and transmitted by another
   mail system.

   It is possible for the mailbox in the return path to be different
   from the actual sender's mailbox, for example, if error responses are
   to be delivered to a special error handling mailbox rather than to
   the message sender.  When mailing lists are involved, this
   arrangement is common and useful as a means of directing errors to
   the list maintainer rather than the message originator.

   The text above implies that the final mail data will begin with a
   return path line, followed by one or more time stamp lines.  These
   lines will be followed by the rest of the mail data: first the
   balance of the mail header section and then the body ([RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")]).

   It is sometimes difficult for an SMTP server to determine whether or
   not it is making final delivery since forwarding or other operations
   may occur after the message is accepted for delivery.  Consequently,
   any further (forwarding, gateway, or relay) systems MAY remove the
   return path and rebuild the MAIL command as needed to ensure that
   exactly one such line appears in a delivered message.

   A message-originating SMTP system SHOULD NOT send a message that
   already contains a Return-path header field.  SMTP servers performing
   a relay function MUST NOT inspect the message data, and especially
   not to the extent needed to determine if Return-path header fields
   are present.  SMTP servers making final delivery MAY remove Return-
   path header fields before adding their own.

   The primary purpose of the Return-path is to designate the address to
   which messages indicating non-delivery or other mail system failures
   are to be sent.  For this to be unambiguous, exactly one return path
   SHOULD be present when the message is delivered.  Systems using [RFC](./rfc822)
   [822](./rfc822) syntax with non-SMTP transports SHOULD designate an unambiguous
   address, associated with the transport envelope, to which error
   reports (e.g., non-delivery messages) should be sent.

Klensin                     Standards Track                    [Page 58]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Historical note: Text in [RFC 822](./rfc822) that appears to contradict the use
   of the Return-path header field (or the envelope reverse-path address
   from the MAIL command) as the destination for error messages is not
   applicable on the Internet.  The reverse-path address (as copied into
   the Return-path) MUST be used as the target of any mail containing
   delivery error messages.

   In particular:
   o  a gateway from SMTP -> elsewhere SHOULD insert a return-path
      header field, unless it is known that the "elsewhere" transport
      also uses Internet domain addresses and maintains the envelope
      sender address separately.

   o  a gateway from elsewhere -> SMTP SHOULD delete any return-path
      header field present in the message, and either copy that
      information to the SMTP envelope or combine it with information
      present in the envelope of the other transport system to construct
      the reverse-path argument to the MAIL command in the SMTP
      envelope.

   The server must give special treatment to cases in which the
   processing following the end of mail data indication is only
   partially successful.  This could happen if, after accepting several
   recipients and the mail data, the SMTP server finds that the mail
   data could be successfully delivered to some, but not all, of the
   recipients.  In such cases, the response to the DATA command MUST be
   an OK reply.  However, the SMTP server MUST compose and send an
   "undeliverable mail" notification message to the originator of the
   message.

   A single notification listing all of the failed recipients or
   separate notification messages MUST be sent for each failed
   recipient.  For economy of processing by the sender, the former
   SHOULD be used when possible.  Note that the key difference between
   handling aliases ([Section 3.9.1](#section-3.9.1)) and forwarding (this subsection) is
   the change to the backward-pointing address in this case.  All
   notification messages about undeliverable mail MUST be sent using the
   MAIL command (even if they result from processing the obsolete SEND,
   SOML, or SAML commands) and MUST use a null return path as discussed
   in [Section 3.6](#section-3.6).

   The time stamp line and the return path line are formally defined as
   follows (the definitions for "FWS" and "CFWS" appear in [RFC 5322](./rfc5322)
   [[4](#ref-4 "\"Internet Message Format\"")]):

   Return-path-line  = "Return-Path:" FWS Reverse-path <CRLF>

   Time-stamp-line  = "Received:" FWS Stamp <CRLF>

Klensin                     Standards Track                    [Page 59]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Stamp          = From-domain By-domain Opt-info [CFWS] ";"
                  FWS date-time
                  ; where "date-time" is as defined in [RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")]
                  ; but the "obs-" forms, especially two-digit
                  ; years, are prohibited in SMTP and MUST NOT be used.

   From-domain    = "FROM" FWS Extended-Domain

   By-domain      = CFWS "BY" FWS Extended-Domain

   Extended-Domain  = Domain /
                    ( Domain FWS "(" TCP-info ")" ) /
                    ( address-literal FWS "(" TCP-info ")" )

   TCP-info       = address-literal / ( Domain FWS address-literal )
                  ; Information derived by server from TCP connection
                  ; not client EHLO.

   Opt-info       = [Via] [With] [ID] [For]
                  [Additional-Registered-Clauses]

   Via            = CFWS "VIA" FWS Link

   With           = CFWS "WITH" FWS Protocol

   ID             = CFWS "ID" FWS ( Atom / msg-id )
                  ; msg-id is defined in [RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")]

   For            = CFWS "FOR" FWS ( Path / Mailbox )

   Additional-Registered-Clauses  = CFWS Atom FWS String
                                  ; Additional standard clauses may be
                                  added in this
                                  ; location by future standards and
                                  registration with
                                  ; IANA.  SMTP servers SHOULD NOT use
                                  unregistered
                                  ; names.  See [Section 8](#section-8).

   Link           = "TCP" / Addtl-Link

   Addtl-Link     = Atom
                  ; Additional standard names for links are
                  ; registered with the Internet Assigned Numbers
                  ; Authority (IANA).  "Via" is primarily of value
                  ; with non-Internet transports.  SMTP servers
                  ; SHOULD NOT use unregistered names.

Klensin                     Standards Track                    [Page 60]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Protocol       = "ESMTP" / "SMTP" / Attdl-Protocol

   Attdl-Protocol = Atom
                  ; Additional standard names for protocols are
                  ; registered with the Internet Assigned Numbers
                  ; Authority (IANA) in the "mail parameters"
                  ; registry [[9](#ref-9 "\"ESMTP and LMTP Transmission Types Registration\"")].  SMTP servers SHOULD NOT
                  ; use unregistered names.

[4.5](#section-4.5).  Additional Implementation Issues

[4.5.1](#section-4.5.1).  Minimum Implementation

   In order to make SMTP workable, the following minimum implementation
   MUST be provided by all receivers.  The following commands MUST be
   supported to conform to this specification:

      EHLO
      HELO
      MAIL
      RCPT
      DATA
      RSET
      NOOP
      QUIT
      VRFY

   Any system that includes an SMTP server supporting mail relaying or
   delivery MUST support the reserved mailbox "postmaster" as a case-
   insensitive local name.  This postmaster address is not strictly
   necessary if the server always returns 554 on connection opening (as
   described in [Section 3.1](#section-3.1)).  The requirement to accept mail for
   postmaster implies that RCPT commands that specify a mailbox for
   postmaster at any of the domains for which the SMTP server provides
   mail service, as well as the special case of "RCPT TO:<Postmaster>"
   (with no domain specification), MUST be supported.

   SMTP systems are expected to make every reasonable effort to accept
   mail directed to Postmaster from any other system on the Internet.
   In extreme cases -- such as to contain a denial of service attack or
   other breach of security -- an SMTP server may block mail directed to
   Postmaster.  However, such arrangements SHOULD be narrowly tailored
   so as to avoid blocking messages that are not part of such attacks.

Klensin                     Standards Track                    [Page 61]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[4.5.2](#section-4.5.2).  Transparency

   Without some provision for data transparency, the character sequence
   "<CRLF>.<CRLF>" ends the mail text and cannot be sent by the user.
   In general, users are not aware of such "forbidden" sequences.  To
   allow all user composed text to be transmitted transparently, the
   following procedures are used:

   o  Before sending a line of mail text, the SMTP client checks the
      first character of the line.  If it is a period, one additional
      period is inserted at the beginning of the line.

   o  When a line of mail text is received by the SMTP server, it checks
      the line.  If the line is composed of a single period, it is
      treated as the end of mail indicator.  If the first character is a
      period and there are other characters on the line, the first
      character is deleted.

   The mail data may contain any of the 128 ASCII characters.  All
   characters are to be delivered to the recipient's mailbox, including
   spaces, vertical and horizontal tabs, and other control characters.
   If the transmission channel provides an 8-bit byte (octet) data
   stream, the 7-bit ASCII codes are transmitted, right justified, in
   the octets, with the high-order bits cleared to zero.  See
   [Section 3.6](#section-3.6) for special treatment of these conditions in SMTP systems
   serving a relay function.

   In some systems, it may be necessary to transform the data as it is
   received and stored.  This may be necessary for hosts that use a
   different character set than ASCII as their local character set, that
   store data in records rather than strings, or which use special
   character sequences as delimiters inside mailboxes.  If such
   transformations are necessary, they MUST be reversible, especially if
   they are applied to mail being relayed.

[4.5.3](#section-4.5.3).  Sizes and Timeouts

[4.5.3.1](#section-4.5.3.1).  Size Limits and Minimums

   There are several objects that have required minimum/maximum sizes.
   Every implementation MUST be able to receive objects of at least
   these sizes.  Objects larger than these sizes SHOULD be avoided when
   possible.  However, some Internet mail constructs such as encoded
   X.400 addresses ([RFC 2156](./rfc2156) [[35](#ref-35 "\"MIXER (Mime Internet X.400 Enhanced Relay): Mapping between X.400 and RFC 822/MIME\"")]) will often require larger objects.
   Clients MAY attempt to transmit these, but MUST be prepared for a
   server to reject them if they cannot be handled by it.  To the
   maximum extent possible, implementation techniques that impose no
   limits on the length of these objects should be used.

Klensin                     Standards Track                    [Page 62]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Extensions to SMTP may involve the use of characters that occupy more
   than a single octet each.  This section therefore specifies lengths
   in octets where absolute lengths, rather than character counts, are
   intended.

[4.5.3.1.1](#section-4.5.3.1.1).  Local-part

   The maximum total length of a user name or other local-part is 64
   octets.

[4.5.3.1.2](#section-4.5.3.1.2).  Domain

   The maximum total length of a domain name or number is 255 octets.

[4.5.3.1.3](#section-4.5.3.1.3).  Path

   The maximum total length of a reverse-path or forward-path is 256
   octets (including the punctuation and element separators).

[4.5.3.1.4](#section-4.5.3.1.4).  Command Line

   The maximum total length of a command line including the command word
   and the <CRLF> is 512 octets.  SMTP extensions may be used to
   increase this limit.

[4.5.3.1.5](#section-4.5.3.1.5).  Reply Line

   The maximum total length of a reply line including the reply code and
   the <CRLF> is 512 octets.  More information may be conveyed through
   multiple-line replies.

[4.5.3.1.6](#section-4.5.3.1.6).  Text Line

   The maximum total length of a text line including the <CRLF> is 1000
   octets (not counting the leading dot duplicated for transparency).
   This number may be increased by the use of SMTP Service Extensions.

[4.5.3.1.7](#section-4.5.3.1.7).  Message Content

   The maximum total length of a message content (including any message
   header section as well as the message body) MUST BE at least 64K
   octets.  Since the introduction of Internet Standards for multimedia
   mail ([RFC 2045](./rfc2045) [[21](#ref-21 "\"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies\"")]), message lengths on the Internet have grown
   dramatically, and message size restrictions should be avoided if at
   all possible.  SMTP server systems that must impose restrictions
   SHOULD implement the "SIZE" service extension of [RFC 1870](./rfc1870) [[10](#ref-10 "\"SMTP Service Extension for Message Size Declaration\"")], and
   SMTP client systems that will send large messages SHOULD utilize it
   when possible.

Klensin                     Standards Track                    [Page 63]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[4.5.3.1.8](#section-4.5.3.1.8).  Recipients Buffer

   The minimum total number of recipients that MUST be buffered is 100
   recipients.  Rejection of messages (for excessive recipients) with
   fewer than 100 RCPT commands is a violation of this specification.
   The general principle that relaying SMTP server MUST NOT, and
   delivery SMTP servers SHOULD NOT, perform validation tests on message
   header fields suggests that messages SHOULD NOT be rejected based on
   the total number of recipients shown in header fields.  A server that
   imposes a limit on the number of recipients MUST behave in an orderly
   fashion, such as rejecting additional addresses over its limit rather
   than silently discarding addresses previously accepted.  A client
   that needs to deliver a message containing over 100 RCPT commands
   SHOULD be prepared to transmit in 100-recipient "chunks" if the
   server declines to accept more than 100 recipients in a single
   message.

[4.5.3.1.9](#section-4.5.3.1.9).  Treatment When Limits Exceeded

   Errors due to exceeding these limits may be reported by using the
   reply codes.  Some examples of reply codes are:

      500 Line too long.

   or

      501 Path too long

   or

      452 Too many recipients (see below)

   or

      552 Too much mail data.

[4.5.3.1.10](#section-4.5.3.1.10).  Too Many Recipients Code

   [RFC 821](./rfc821) [[1](#ref-1 "\"Simple Mail Transfer Protocol\"")] incorrectly listed the error where an SMTP server
   exhausts its implementation limit on the number of RCPT commands
   ("too many recipients") as having reply code 552.  The correct reply
   code for this condition is 452.  Clients SHOULD treat a 552 code in
   this case as a temporary, rather than permanent, failure so the logic
   below works.

   When a conforming SMTP server encounters this condition, it has at
   least 100 successful RCPT commands in its recipients buffer.  If the
   server is able to accept the message, then at least these 100

Klensin                     Standards Track                    [Page 64]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   addresses will be removed from the SMTP client's queue.  When the
   client attempts retransmission of those addresses that received 452
   responses, at least 100 of these will be able to fit in the SMTP
   server's recipients buffer.  Each retransmission attempt that is able
   to deliver anything will be able to dispose of at least 100 of these
   recipients.

   If an SMTP server has an implementation limit on the number of RCPT
   commands and this limit is exhausted, it MUST use a response code of
   452 (but the client SHOULD also be prepared for a 552, as noted
   above).  If the server has a configured site-policy limitation on the
   number of RCPT commands, it MAY instead use a 5yz response code.  In
   particular, if the intent is to prohibit messages with more than a
   site-specified number of recipients, rather than merely limit the
   number of recipients in a given mail transaction, it would be
   reasonable to return a 503 response to any DATA command received
   subsequent to the 452 (or 552) code or to simply return the 503 after
   DATA without returning any previous negative response.

[4.5.3.2](#section-4.5.3.2).  Timeouts

   An SMTP client MUST provide a timeout mechanism.  It MUST use per-
   command timeouts rather than somehow trying to time the entire mail
   transaction.  Timeouts SHOULD be easily reconfigurable, preferably
   without recompiling the SMTP code.  To implement this, a timer is set
   for each SMTP command and for each buffer of the data transfer.  The
   latter means that the overall timeout is inherently proportional to
   the size of the message.

   Based on extensive experience with busy mail-relay hosts, the minimum
   per-command timeout values SHOULD be as follows:

[4.5.3.2.1](#section-4.5.3.2.1).  Initial 220 Message: 5 Minutes

   An SMTP client process needs to distinguish between a failed TCP
   connection and a delay in receiving the initial 220 greeting message.
   Many SMTP servers accept a TCP connection but delay delivery of the
   220 message until their system load permits more mail to be
   processed.

[4.5.3.2.2](#section-4.5.3.2.2).  MAIL Command: 5 Minutes

[4.5.3.2.3](#section-4.5.3.2.3).  RCPT Command: 5 Minutes

   A longer timeout is required if processing of mailing lists and
   aliases is not deferred until after the message was accepted.

Klensin                     Standards Track                    [Page 65]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[4.5.3.2.4](#section-4.5.3.2.4).  DATA Initiation: 2 Minutes

   This is while awaiting the "354 Start Input" reply to a DATA command.

[4.5.3.2.5](#section-4.5.3.2.5).  Data Block: 3 Minutes

   This is while awaiting the completion of each TCP SEND call
   transmitting a chunk of data.

[4.5.3.2.6](#section-4.5.3.2.6).  DATA Termination: 10 Minutes.

   This is while awaiting the "250 OK" reply.  When the receiver gets
   the final period terminating the message data, it typically performs
   processing to deliver the message to a user mailbox.  A spurious
   timeout at this point would be very wasteful and would typically
   result in delivery of multiple copies of the message, since it has
   been successfully sent and the server has accepted responsibility for
   delivery.  See [Section 6.1](#section-6.1) for additional discussion.

[4.5.3.2.7](#section-4.5.3.2.7).  Server Timeout: 5 Minutes.

   An SMTP server SHOULD have a timeout of at least 5 minutes while it
   is awaiting the next command from the sender.

[4.5.4](#section-4.5.4).  Retry Strategies

   The common structure of a host SMTP implementation includes user
   mailboxes, one or more areas for queuing messages in transit, and one
   or more daemon processes for sending and receiving mail.  The exact
   structure will vary depending on the needs of the users on the host
   and the number and size of mailing lists supported by the host.  We
   describe several optimizations that have proved helpful, particularly
   for mailers supporting high traffic levels.

   Any queuing strategy MUST include timeouts on all activities on a
   per-command basis.  A queuing strategy MUST NOT send error messages
   in response to error messages under any circumstances.

[4.5.4.1](#section-4.5.4.1).  Sending Strategy

   The general model for an SMTP client is one or more processes that
   periodically attempt to transmit outgoing mail.  In a typical system,
   the program that composes a message has some method for requesting
   immediate attention for a new piece of outgoing mail, while mail that
   cannot be transmitted immediately MUST be queued and periodically
   retried by the sender.  A mail queue entry will include not only the
   message itself but also the envelope information.

Klensin                     Standards Track                    [Page 66]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   The sender MUST delay retrying a particular destination after one
   attempt has failed.  In general, the retry interval SHOULD be at
   least 30 minutes; however, more sophisticated and variable strategies
   will be beneficial when the SMTP client can determine the reason for
   non-delivery.

   Retries continue until the message is transmitted or the sender gives
   up; the give-up time generally needs to be at least 4-5 days.  It MAY
   be appropriate to set a shorter maximum number of retries for non-
   delivery notifications and equivalent error messages than for
   standard messages.  The parameters to the retry algorithm MUST be
   configurable.

   A client SHOULD keep a list of hosts it cannot reach and
   corresponding connection timeouts, rather than just retrying queued
   mail items.

   Experience suggests that failures are typically transient (the target
   system or its connection has crashed), favoring a policy of two
   connection attempts in the first hour the message is in the queue,
   and then backing off to one every two or three hours.

   The SMTP client can shorten the queuing delay in cooperation with the
   SMTP server.  For example, if mail is received from a particular
   address, it is likely that mail queued for that host can now be sent.
   Application of this principle may, in many cases, eliminate the
   requirement for an explicit "send queues now" function such as ETRN,
   [RFC 1985](./rfc1985) [[36](#ref-36 "\"SMTP Service Extension for Remote Message Queue Starting\"")].

   The strategy may be further modified as a result of multiple
   addresses per host (see below) to optimize delivery time versus
   resource usage.

   An SMTP client may have a large queue of messages for each
   unavailable destination host.  If all of these messages were retried
   in every retry cycle, there would be excessive Internet overhead and
   the sending system would be blocked for a long period.  Note that an
   SMTP client can generally determine that a delivery attempt has
   failed only after a timeout of several minutes, and even a one-minute
   timeout per connection will result in a very large delay if retries
   are repeated for dozens, or even hundreds, of queued messages to the
   same host.

   At the same time, SMTP clients SHOULD use great care in caching
   negative responses from servers.  In an extreme case, if EHLO is
   issued multiple times during the same SMTP connection, different
   answers may be returned by the server.  More significantly, 5yz
   responses to the MAIL command MUST NOT be cached.

Klensin                     Standards Track                    [Page 67]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   When a mail message is to be delivered to multiple recipients, and
   the SMTP server to which a copy of the message is to be sent is the
   same for multiple recipients, then only one copy of the message
   SHOULD be transmitted.  That is, the SMTP client SHOULD use the
   command sequence: MAIL, RCPT, RCPT, ..., RCPT, DATA instead of the
   sequence: MAIL, RCPT, DATA, ..., MAIL, RCPT, DATA.  However, if there
   are very many addresses, a limit on the number of RCPT commands per
   MAIL command MAY be imposed.  This efficiency feature SHOULD be
   implemented.

   Similarly, to achieve timely delivery, the SMTP client MAY support
   multiple concurrent outgoing mail transactions.  However, some limit
   may be appropriate to protect the host from devoting all its
   resources to mail.

[4.5.4.2](#section-4.5.4.2).  Receiving Strategy

   The SMTP server SHOULD attempt to keep a pending listen on the SMTP
   port (specified by IANA as port 25) at all times.  This requires the
   support of multiple incoming TCP connections for SMTP.  Some limit
   MAY be imposed, but servers that cannot handle more than one SMTP
   transaction at a time are not in conformance with the intent of this
   specification.

   As discussed above, when the SMTP server receives mail from a
   particular host address, it could activate its own SMTP queuing
   mechanisms to retry any mail pending for that host address.

[4.5.5](#section-4.5.5).  Messages with a Null Reverse-Path

   There are several types of notification messages that are required by
   existing and proposed Standards to be sent with a null reverse-path,
   namely non-delivery notifications as discussed in [Section 3.7](#section-3.7), other
   kinds of Delivery Status Notifications (DSNs, [RFC 3461](./rfc3461) [[32](#ref-32 "\"Simple Mail Transfer Protocol (SMTP) Service Extension for Delivery Status Notifications (DSNs)\"")]), and
   Message Disposition Notifications (MDNs, [RFC 3798](./rfc3798) [[37](#ref-37 "\"Message Disposition Notification\"")]).  All of
   these kinds of messages are notifications about a previous message,
   and they are sent to the reverse-path of the previous mail message.
   (If the delivery of such a notification message fails, that usually
   indicates a problem with the mail system of the host to which the
   notification message is addressed.  For this reason, at some hosts
   the MTA is set up to forward such failed notification messages to
   someone who is able to fix problems with the mail system, e.g., via
   the postmaster alias.)

   All other types of messages (i.e., any message which is not required
   by a Standards-Track RFC to have a null reverse-path) SHOULD be sent
   with a valid, non-null reverse-path.

Klensin                     Standards Track                    [Page 68]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Implementers of automated email processors should be careful to make
   sure that the various kinds of messages with a null reverse-path are
   handled correctly.  In particular, such systems SHOULD NOT reply to
   messages with a null reverse-path, and they SHOULD NOT add a non-null
   reverse-path, or change a null reverse-path to a non-null one, to
   such messages when forwarding.

[5](#section-5).  Address Resolution and Mail Handling

[5.1](#section-5.1).  Locating the Target Host

   Once an SMTP client lexically identifies a domain to which mail will
   be delivered for processing (as described in Sections [2.3.5](#section-2.3.5) and [3.6](#section-3.6)),
   a DNS lookup MUST be performed to resolve the domain name ([RFC 1035](./rfc1035)
   [[2](#ref-2 "\"Domain names - implementation and specification\"")]).  The names are expected to be fully-qualified domain names
   (FQDNs): mechanisms for inferring FQDNs from partial names or local
   aliases are outside of this specification.  Due to a history of
   problems, SMTP servers used for initial submission of messages SHOULD
   NOT make such inferences (Message Submission Servers [[18](#ref-18 "\"Message Submission for Mail\"")] have
   somewhat more flexibility) and intermediate (relay) SMTP servers MUST
   NOT make them.

   The lookup first attempts to locate an MX record associated with the
   name.  If a CNAME record is found, the resulting name is processed as
   if it were the initial name.  If a non-existent domain error is
   returned, this situation MUST be reported as an error.  If a
   temporary error is returned, the message MUST be queued and retried
   later (see [Section 4.5.4.1](#section-4.5.4.1)).  If an empty list of MXs is returned,
   the address is treated as if it was associated with an implicit MX
   RR, with a preference of 0, pointing to that host.  If MX records are
   present, but none of them are usable, or the implicit MX is unusable,
   this situation MUST be reported as an error.

   If one or more MX RRs are found for a given name, SMTP systems MUST
   NOT utilize any address RRs associated with that name unless they are
   located using the MX RRs; the "implicit MX" rule above applies only
   if there are no MX records present.  If MX records are present, but
   none of them are usable, this situation MUST be reported as an error.

   When a domain name associated with an MX RR is looked up and the
   associated data field obtained, the data field of that response MUST
   contain a domain name.  That domain name, when queried, MUST return
   at least one address record (e.g., A or AAAA RR) that gives the IP
   address of the SMTP server to which the message should be directed.
   Any other response, specifically including a value that will return a
   CNAME record when queried, lies outside the scope of this Standard.
   The prohibition on labels in the data that resolve to CNAMEs is
   discussed in more detail in [RFC 2181, Section 10.3](./rfc2181#section-10.3) [[38](#ref-38 "\"Clarifications to the DNS Specification\"")].

Klensin                     Standards Track                    [Page 69]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   When the lookup succeeds, the mapping can result in a list of
   alternative delivery addresses rather than a single address, because
   of multiple MX records, multihoming, or both.  To provide reliable
   mail transmission, the SMTP client MUST be able to try (and retry)
   each of the relevant addresses in this list in order, until a
   delivery attempt succeeds.  However, there MAY also be a configurable
   limit on the number of alternate addresses that can be tried.  In any
   case, the SMTP client SHOULD try at least two addresses.

   Two types of information are used to rank the host addresses:
   multiple MX records, and multihomed hosts.

   MX records contain a preference indication that MUST be used in
   sorting if more than one such record appears (see below).  Lower
   numbers are more preferred than higher ones.  If there are multiple
   destinations with the same preference and there is no clear reason to
   favor one (e.g., by recognition of an easily reached address), then
   the sender-SMTP MUST randomize them to spread the load across
   multiple mail exchangers for a specific organization.

   The destination host (perhaps taken from the preferred MX record) may
   be multihomed, in which case the domain name resolver will return a
   list of alternative IP addresses.  It is the responsibility of the
   domain name resolver interface to have ordered this list by
   decreasing preference if necessary, and the SMTP sender MUST try them
   in the order presented.

   Although the capability to try multiple alternative addresses is
   required, specific installations may want to limit or disable the use
   of alternative addresses.  The question of whether a sender should
   attempt retries using the different addresses of a multihomed host
   has been controversial.  The main argument for using the multiple
   addresses is that it maximizes the probability of timely delivery,
   and indeed sometimes the probability of any delivery; the counter-
   argument is that it may result in unnecessary resource use.  Note
   that resource use is also strongly determined by the sending strategy
   discussed in [Section 4.5.4.1](#section-4.5.4.1).

   If an SMTP server receives a message with a destination for which it
   is a designated Mail eXchanger, it MAY relay the message (potentially
   after having rewritten the MAIL FROM and/or RCPT TO addresses), make
   final delivery of the message, or hand it off using some mechanism
   outside the SMTP-provided transport environment.  Of course, neither
   of the latter require that the list of MX records be examined
   further.

   If it determines that it should relay the message without rewriting
   the address, it MUST sort the MX records to determine candidates for

Klensin                     Standards Track                    [Page 70]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   delivery.  The records are first ordered by preference, with the
   lowest-numbered records being most preferred.  The relay host MUST
   then inspect the list for any of the names or addresses by which it
   might be known in mail transactions.  If a matching record is found,
   all records at that preference level and higher-numbered ones MUST be
   discarded from consideration.  If there are no records left at that
   point, it is an error condition, and the message MUST be returned as
   undeliverable.  If records do remain, they SHOULD be tried, best
   preference first, as described above.

[5.2](#section-5.2).  IPv6 and MX Records

   In the contemporary Internet, SMTP clients and servers may be hosted
   on IPv4 systems, IPv6 systems, or dual-stack systems that are
   compatible with either version of the Internet Protocol.  The host
   domains to which MX records point may, consequently, contain "A RR"s
   (IPv4), "AAAA RR"s (IPv6), or any combination of them.  While [RFC](./rfc3974)
   [3974](./rfc3974) [[39](#ref-39 "\"SMTP Operational Experience in Mixed IPv4/v6 Environments\"")] discusses some operational experience in mixed
   environments, it was not comprehensive enough to justify
   standardization, and some of its recommendations appear to be
   inconsistent with this specification.  The appropriate actions to be
   taken either will depend on local circumstances, such as performance
   of the relevant networks and any conversions that might be necessary,
   or will be obvious (e.g., an IPv6-only client need not attempt to
   look up A RRs or attempt to reach IPv4-only servers).  Designers of
   SMTP implementations that might run in IPv6 or dual-stack
   environments should study the procedures above, especially the
   comments about multihomed hosts, and, preferably, provide mechanisms
   to facilitate operational tuning and mail interoperability between
   IPv4 and IPv6 systems while considering local circumstances.

[6](#section-6).  Problem Detection and Handling

[6.1](#section-6.1).  Reliable Delivery and Replies by Email

   When the receiver-SMTP accepts a piece of mail (by sending a "250 OK"
   message in response to DATA), it is accepting responsibility for
   delivering or relaying the message.  It must take this responsibility
   seriously.  It MUST NOT lose the message for frivolous reasons, such
   as because the host later crashes or because of a predictable
   resource shortage.  Some reasons that are not considered frivolous
   are discussed in the next subsection and in [Section 7.8](#section-7.8).

   If there is a delivery failure after acceptance of a message, the
   receiver-SMTP MUST formulate and mail a notification message.  This
   notification MUST be sent using a null ("<>") reverse-path in the
   envelope.  The recipient of this notification MUST be the address
   from the envelope return path (or the Return-Path: line).  However,

Klensin                     Standards Track                    [Page 71]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   if this address is null ("<>"), the receiver-SMTP MUST NOT send a
   notification.  Obviously, nothing in this section can or should
   prohibit local decisions (i.e., as part of the same system
   environment as the receiver-SMTP) to log or otherwise transmit
   information about null address events locally if that is desired.  If
   the address is an explicit source route, it MUST be stripped down to
   its final hop.

   For example, suppose that an error notification must be sent for a
   message that arrived with:

      MAIL FROM:<@a,@b:user@d>

   The notification message MUST be sent using:

      RCPT TO:<user@d>

   Some delivery failures after the message is accepted by SMTP will be
   unavoidable.  For example, it may be impossible for the receiving
   SMTP server to validate all the delivery addresses in RCPT command(s)
   due to a "soft" domain system error, because the target is a mailing
   list (see earlier discussion of RCPT), or because the server is
   acting as a relay and has no immediate access to the delivering
   system.

   To avoid receiving duplicate messages as the result of timeouts, a
   receiver-SMTP MUST seek to minimize the time required to respond to
   the final <CRLF>.<CRLF> end of data indicator.  See [RFC 1047](./rfc1047) [[40](#ref-40 "\"Duplicate messages and SMTP\"")] for
   a discussion of this problem.

[6.2](#section-6.2).  Unwanted, Unsolicited, and "Attack" Messages

   Utility and predictability of the Internet mail system requires that
   messages that can be delivered should be delivered, regardless of any
   syntax or other faults associated with those messages and regardless
   of their content.  If they cannot be delivered, and cannot be
   rejected by the SMTP server during the SMTP transaction, they should
   be "bounced" (returned with non-delivery notification messages) as
   described above.  In today's world, in which many SMTP server
   operators have discovered that the quantity of undesirable bulk email
   vastly exceeds the quantity of desired mail and in which accepting a
   message may trigger additional undesirable traffic by providing
   verification of the address, those principles may not be practical.

   As discussed in [Section 7.8](#section-7.8) and [Section 7.9](#section-7.9) below, dropping mail
   without notification of the sender is permitted in practice.
   However, it is extremely dangerous and violates a long tradition and
   community expectations that mail is either delivered or returned.  If

Klensin                     Standards Track                    [Page 72]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   silent message-dropping is misused, it could easily undermine
   confidence in the reliability of the Internet's mail systems.  So
   silent dropping of messages should be considered only in those cases
   where there is very high confidence that the messages are seriously
   fraudulent or otherwise inappropriate.

   To stretch the principle of delivery if possible even further, it may
   be a rational policy to not deliver mail that has an invalid return
   address, although the history of the network is that users are
   typically better served by delivering any message that can be
   delivered.  Reliably determining that a return address is invalid can
   be a difficult and time-consuming process, especially if the putative
   sending system is not directly accessible or does not fully and
   accurately support VRFY and, even if a "drop messages with invalid
   return addresses" policy is adopted, it SHOULD be applied only when
   there is near-certainty that the return addresses are, in fact,
   invalid.

   Conversely, if a message is rejected because it is found to contain
   hostile content (a decision that is outside the scope of an SMTP
   server as defined in this document), rejection ("bounce") messages
   SHOULD NOT be sent unless the receiving site is confident that those
   messages will be usefully delivered.  The preference and default in
   these cases is to avoid sending non-delivery messages when the
   incoming message is determined to contain hostile content.

[6.3](#section-6.3).  Loop Detection

   Simple counting of the number of "Received:" header fields in a
   message has proven to be an effective, although rarely optimal,
   method of detecting loops in mail systems.  SMTP servers using this
   technique SHOULD use a large rejection threshold, normally at least
   100 Received entries.  Whatever mechanisms are used, servers MUST
   contain provisions for detecting and stopping trivial loops.

[6.4](#section-6.4).  Compensating for Irregularities

   Unfortunately, variations, creative interpretations, and outright
   violations of Internet mail protocols do occur; some would suggest
   that they occur quite frequently.  The debate as to whether a well-
   behaved SMTP receiver or relay should reject a malformed message,
   attempt to pass it on unchanged, or attempt to repair it to increase
   the odds of successful delivery (or subsequent reply) began almost
   with the dawn of structured network mail and shows no signs of
   abating.  Advocates of rejection claim that attempted repairs are
   rarely completely adequate and that rejection of bad messages is the
   only way to get the offending software repaired.  Advocates of
   "repair" or "deliver no matter what" argue that users prefer that

Klensin                     Standards Track                    [Page 73]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   mail go through it if at all possible and that there are significant
   market pressures in that direction.  In practice, these market
   pressures may be more important to particular vendors than strict
   conformance to the standards, regardless of the preference of the
   actual developers.

   The problems associated with ill-formed messages were exacerbated by
   the introduction of the split-UA mail reading protocols (Post Office
   Protocol (POP) version 2 [[15](#ref-15 "\"Post Office Protocol: Version 2\"")], Post Office Protocol (POP) version 3
   [[16](#ref-16 "\"Post Office Protocol - Version 3\"")], IMAP version 2 [[41](#ref-41 "\"Interactive Mail Access Protocol: Version 2\"")], and PCMAIL [[42](#ref-42 "\"PCMAIL: A distributed mail system for personal computers\"")]).  These protocols
   encouraged the use of SMTP as a posting (message submission)
   protocol, and SMTP servers as relay systems for these client hosts
   (which are often only intermittently connected to the Internet).
   Historically, many of those client machines lacked some of the
   mechanisms and information assumed by SMTP (and indeed, by the mail
   format protocol, [RFC 822](./rfc822) [[28](#ref-28 "\"Standard for the format of ARPA Internet text messages\"")]).  Some could not keep adequate track
   of time; others had no concept of time zones; still others could not
   identify their own names or addresses; and, of course, none could
   satisfy the assumptions that underlay [RFC 822](./rfc822)'s conception of
   authenticated addresses.

   In response to these weak SMTP clients, many SMTP systems now
   complete messages that are delivered to them in incomplete or
   incorrect form.  This strategy is generally considered appropriate
   when the server can identify or authenticate the client, and there
   are prior agreements between them.  By contrast, there is at best
   great concern about fixes applied by a relay or delivery SMTP server
   that has little or no knowledge of the user or client machine.  Many
   of these issues are addressed by using a separate protocol, such as
   that defined in [RFC 4409](./rfc4409) [[18](#ref-18 "\"Message Submission for Mail\"")], for message submission, rather than
   using originating SMTP servers for that purpose.

   The following changes to a message being processed MAY be applied
   when necessary by an originating SMTP server, or one used as the
   target of SMTP as an initial posting (message submission) protocol:

   o  Addition of a message-id field when none appears

   o  Addition of a date, time, or time zone when none appears

   o  Correction of addresses to proper FQDN format

   The less information the server has about the client, the less likely
   these changes are to be correct and the more caution and conservatism
   should be applied when considering whether or not to perform fixes
   and how.  These changes MUST NOT be applied by an SMTP server that
   provides an intermediate relay function.

Klensin                     Standards Track                    [Page 74]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   In all cases, properly operating clients supplying correct
   information are preferred to corrections by the SMTP server.  In all
   cases, documentation SHOULD be provided in trace header fields and/or
   header field comments for actions performed by the servers.

[7](#section-7).  Security Considerations

[7.1](#section-7.1).  Mail Security and Spoofing

   SMTP mail is inherently insecure in that it is feasible for even
   fairly casual users to negotiate directly with receiving and relaying
   SMTP servers and create messages that will trick a naive recipient
   into believing that they came from somewhere else.  Constructing such
   a message so that the "spoofed" behavior cannot be detected by an
   expert is somewhat more difficult, but not sufficiently so as to be a
   deterrent to someone who is determined and knowledgeable.
   Consequently, as knowledge of Internet mail increases, so does the
   knowledge that SMTP mail inherently cannot be authenticated, or
   integrity checks provided, at the transport level.  Real mail
   security lies only in end-to-end methods involving the message
   bodies, such as those that use digital signatures (see [RFC 1847](./rfc1847) [[43](#ref-43 "\"Security Multiparts for MIME: Multipart/Signed and Multipart/Encrypted\"")]
   and, e.g., Pretty Good Privacy (PGP) in [RFC 4880](./rfc4880) [[44](#ref-44 "\"OpenPGP Message Format\"")] or Secure/
   Multipurpose Internet Mail Extensions (S/MIME) in [RFC 3851](./rfc3851) [[45](#ref-45 "\"Secure/Multipurpose Internet Mail Extensions (S/MIME) Version 3.1 Message Specification\"")]).

   Various protocol extensions and configuration options that provide
   authentication at the transport level (e.g., from an SMTP client to
   an SMTP server) improve somewhat on the traditional situation
   described above.  However, in general, they only authenticate one
   server to another rather than a chain of relays and servers, much
   less authenticating users or user machines.  Consequently, unless
   they are accompanied by careful handoffs of responsibility in a
   carefully designed trust environment, they remain inherently weaker
   than end-to-end mechanisms that use digitally signed messages rather
   than depending on the integrity of the transport system.

   Efforts to make it more difficult for users to set envelope return
   path and header "From" fields to point to valid addresses other than
   their own are largely misguided: they frustrate legitimate
   applications in which mail is sent by one user on behalf of another,
   in which error (or normal) replies should be directed to a special
   address, or in which a single message is sent to multiple recipients
   on different hosts.  (Systems that provide convenient ways for users
   to alter these header fields on a per-message basis should attempt to
   establish a primary and permanent mailbox address for the user so
   that Sender header fields within the message data can be generated
   sensibly.)

Klensin                     Standards Track                    [Page 75]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   This specification does not further address the authentication issues
   associated with SMTP other than to advocate that useful functionality
   not be disabled in the hope of providing some small margin of
   protection against a user who is trying to fake mail.

[7.2](#section-7.2).  "Blind" Copies

   Addresses that do not appear in the message header section may appear
   in the RCPT commands to an SMTP server for a number of reasons.  The
   two most common involve the use of a mailing address as a "list
   exploder" (a single address that resolves into multiple addresses)
   and the appearance of "blind copies".  Especially when more than one
   RCPT command is present, and in order to avoid defeating some of the
   purpose of these mechanisms, SMTP clients and servers SHOULD NOT copy
   the full set of RCPT command arguments into the header section,
   either as part of trace header fields or as informational or private-
   extension header fields.  Since this rule is often violated in
   practice, and cannot be enforced, sending SMTP systems that are aware
   of "bcc" use MAY find it helpful to send each blind copy as a
   separate message transaction containing only a single RCPT command.

   There is no inherent relationship between either "reverse" (from
   MAIL, SAML, etc., commands) or "forward" (RCPT) addresses in the SMTP
   transaction ("envelope") and the addresses in the header section.
   Receiving systems SHOULD NOT attempt to deduce such relationships and
   use them to alter the header section of the message for delivery.
   The popular "Apparently-to" header field is a violation of this
   principle as well as a common source of unintended information
   disclosure and SHOULD NOT be used.

[7.3](#section-7.3).  VRFY, EXPN, and Security

   As discussed in [Section 3.5](#section-3.5), individual sites may want to disable
   either or both of VRFY or EXPN for security reasons (see below).  As
   a corollary to the above, implementations that permit this MUST NOT
   appear to have verified addresses that are not, in fact, verified.
   If a site disables these commands for security reasons, the SMTP
   server MUST return a 252 response, rather than a code that could be
   confused with successful or unsuccessful verification.

   Returning a 250 reply code with the address listed in the VRFY
   command after having checked it only for syntax violates this rule.
   Of course, an implementation that "supports" VRFY by always returning
   550 whether or not the address is valid is equally not in
   conformance.

   On the public Internet, the contents of mailing lists have become
   popular as an address information source for so-called "spammers."

Klensin                     Standards Track                    [Page 76]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   The use of EXPN to "harvest" addresses has increased as list
   administrators have installed protections against inappropriate uses
   of the lists themselves.  However, VRFY and EXPN are still useful for
   authenticated users and within an administrative domain.  For
   example, VRFY and EXPN are useful for performing internal audits of
   how email gets routed to check and to make sure no one is
   automatically forwarding sensitive mail outside the organization.
   Sites implementing SMTP authentication may choose to make VRFY and
   EXPN available only to authenticated requestors.  Implementations
   SHOULD still provide support for EXPN, but sites SHOULD carefully
   evaluate the tradeoffs.

   Whether disabling VRFY provides any real marginal security depends on
   a series of other conditions.  In many cases, RCPT commands can be
   used to obtain the same information about address validity.  On the
   other hand, especially in situations where determination of address
   validity for RCPT commands is deferred until after the DATA command
   is received, RCPT may return no information at all, while VRFY is
   expected to make a serious attempt to determine validity before
   generating a response code (see discussion above).

[7.4](#section-7.4).  Mail Rerouting Based on the 251 and 551 Response Codes

   Before a client uses the 251 or 551 reply codes from a RCPT command
   to automatically update its future behavior (e.g., updating the
   user's address book), it should be certain of the server's
   authenticity.  If it does not, it may be subject to a man in the
   middle attack.

[7.5](#section-7.5).  Information Disclosure in Announcements

   There has been an ongoing debate about the tradeoffs between the
   debugging advantages of announcing server type and version (and,
   sometimes, even server domain name) in the greeting response or in
   response to the HELP command and the disadvantages of exposing
   information that might be useful in a potential hostile attack.  The
   utility of the debugging information is beyond doubt.  Those who
   argue for making it available point out that it is far better to
   actually secure an SMTP server rather than hope that trying to
   conceal known vulnerabilities by hiding the server's precise identity
   will provide more protection.  Sites are encouraged to evaluate the
   tradeoff with that issue in mind; implementations SHOULD minimally
   provide for making type and version information available in some way
   to other network hosts.

Klensin                     Standards Track                    [Page 77]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[7.6](#section-7.6).  Information Disclosure in Trace Fields

   In some circumstances, such as when mail originates from within a LAN
   whose hosts are not directly on the public Internet, trace
   ("Received") header fields produced in conformance with this
   specification may disclose host names and similar information that
   would not normally be available.  This ordinarily does not pose a
   problem, but sites with special concerns about name disclosure should
   be aware of it.  Also, the optional FOR clause should be supplied
   with caution or not at all when multiple recipients are involved lest
   it inadvertently disclose the identities of "blind copy" recipients
   to others.

[7.7](#section-7.7).  Information Disclosure in Message Forwarding

   As discussed in [Section 3.4](#section-3.4), use of the 251 or 551 reply codes to
   identify the replacement address associated with a mailbox may
   inadvertently disclose sensitive information.  Sites that are
   concerned about those issues should ensure that they select and
   configure servers appropriately.

[7.8](#section-7.8).  Resistance to Attacks

   In recent years, there has been an increase of attacks on SMTP
   servers, either in conjunction with attempts to discover addresses
   for sending unsolicited messages or simply to make the servers
   inaccessible to others (i.e., as an application-level denial of
   service attack).  While the means of doing so are beyond the scope of
   this Standard, rational operational behavior requires that servers be
   permitted to detect such attacks and take action to defend
   themselves.  For example, if a server determines that a large number
   of RCPT TO commands are being sent, most or all with invalid
   addresses, as part of such an attack, it would be reasonable for the
   server to close the connection after generating an appropriate number
   of 5yz (normally 550) replies.

[7.9](#section-7.9).  Scope of Operation of SMTP Servers

   It is a well-established principle that an SMTP server may refuse to
   accept mail for any operational or technical reason that makes sense
   to the site providing the server.  However, cooperation among sites
   and installations makes the Internet possible.  If sites take
   excessive advantage of the right to reject traffic, the ubiquity of
   email availability (one of the strengths of the Internet) will be
   threatened; considerable care should be taken and balance maintained
   if a site decides to be selective about the traffic it will accept
   and process.

Klensin                     Standards Track                    [Page 78]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   In recent years, use of the relay function through arbitrary sites
   has been used as part of hostile efforts to hide the actual origins
   of mail.  Some sites have decided to limit the use of the relay
   function to known or identifiable sources, and implementations SHOULD
   provide the capability to perform this type of filtering.  When mail
   is rejected for these or other policy reasons, a 550 code SHOULD be
   used in response to EHLO (or HELO), MAIL, or RCPT as appropriate.

[8](#section-8).  IANA Considerations

   IANA maintains three registries in support of this specification, all
   of which were created for [RFC 2821](./rfc2821) or earlier.  This document expands
   the third one as specified below.  The registry references listed are
   as of the time of publication; IANA does not guarantee the locations
   associated with the URLs.  The registries are as follows:

   o  The first, "Simple Mail Transfer Protocol (SMTP) Service
      Extensions" [[46](#ref-46 "\"IANA Mail Parameters\"")], consists of SMTP service extensions with the
      associated keywords, and, as needed, parameters and verbs.  As
      specified in [Section 2.2.2](#section-2.2.2), no entry may be made in this registry
      that starts in an "X".  Entries may be made only for service
      extensions (and associated keywords, parameters, or verbs) that
      are defined in Standards-Track or Experimental RFCs specifically
      approved by the IESG for this purpose.

   o  The second registry, "Address Literal Tags" [[47](#ref-47 "\"Address Literal Tags\"")], consists of
      "tags" that identify forms of domain literals other than those for
      IPv4 addresses (specified in [RFC 821](./rfc821) and in this document).  The
      initial entry in that registry is for IPv6 addresses (specified in
      this document).  Additional literal types require standardization
      before being used; none are anticipated at this time.

   o  The third, "Mail Transmission Types" [[46](#ref-46 "\"IANA Mail Parameters\"")], established by [RFC 821](./rfc821)
      and renewed by this specification, is a registry of link and
      protocol identifiers to be used with the "via" and "with"
      subclauses of the time stamp ("Received:" header field) described
      in [Section 4.4](#section-4.4).  Link and protocol identifiers in addition to
      those specified in this document may be registered only by
      standardization or by way of an RFC-documented, IESG-approved,
      Experimental protocol extension.  This name space is for
      identification and not limited in size: the IESG is encouraged to
      approve on the basis of clear documentation and a distinct method
      rather than preferences about the properties of the method itself.

      An additional subsection has been added to the "VIA link types"
      and "WITH protocol types" subsections of this registry to contain
      registrations of "Additional-registered-clauses" as described
      above.  The registry will contain clause names, a description, a

Klensin                     Standards Track                    [Page 79]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

      summary of the syntax of the associated String, and a reference.
      As new clauses are defined, they may, in principle, specify
      creation of their own registries if the Strings consist of
      reserved terms or keywords rather than less restricted strings.
      As with link and protocol identifiers, additional clauses may be
      registered only by standardization or by way of an RFC-documented,
      IESG-approved, Experimental protocol extension.  The additional
      clause name space is for identification and is not limited in
      size: the IESG is encouraged to approve on the basis of clear
      documentation, actual use or strong signs that the clause will be
      used, and a distinct requirement rather than preferences about the
      properties of the clause itself.

   In addition, if additional trace header fields (i.e., in addition to
   Return-path and Received) are ever created, those trace fields MUST
   be added to the IANA registry established by [BCP 90](https://www.rfc-editor.org/bcp/bcp90) ([RFC 3864](./rfc3864)) [[11](#ref-11 "\"Registration Procedures for Message Header Fields\"")]
   for use with [RFC 5322](./rfc5322) [[4](#ref-4 "\"Internet Message Format\"")].

[9](#section-9).  Acknowledgments

   Many people contributed to the development of [RFC 2821](./rfc2821).  That
   document should be consulted for those acknowledgments.  For the
   present document, the editor and the community owe thanks to Dawn
   Mann and Tony Hansen who assisted in the very painful process of
   editing and converting the internal format of the document from one
   system to another.

   Neither this document nor [RFC 2821](./rfc2821) would have been possible without
   the many contribution and insights of the late Jon Postel.  Those
   contributions of course include the original specification of SMTP in
   [RFC 821](./rfc821).  A considerable quantity of text from [RFC 821](./rfc821) still appears
   in this document as do several of Jon's original examples that have
   been updated only as needed to reflect other changes in the
   specification.

   Many people made comments or suggestions on the mailing list or in
   notes to the author.  Important corrections or clarifications were
   suggested by several people, including Matti Aarnio, Glenn Anderson,
   Derek J. Balling, Alex van den Bogaerdt, Stephane Bortzmeyer, Vint
   Cerf, Jutta Degener, Steve Dorner, Lisa Dusseault, Frank Ellerman,
   Ned Freed, Randy Gellens, Sabahattin Gucukoglu, Philip Guenther, Arnt
   Gulbrandsen, Eric Hall, Richard O. Hammer, Tony Hansen, Peter J.
   Holzer, Kari Hurtta, Bryon Roche Kain, Valdis Kletnieks, Mathias
   Koerber, John Leslie, Bruce Lilly, Jeff Macdonald, Mark E. Mallett,
   Mark Martinec, S. Moonesamy, Lyndon Nerenberg, Chris Newman, Douglas
   Otis, Pete Resnick, Robert A. Rosenberg, Vince Sabio, Hector Santos,
   David F. Skoll, Paul Smith, and Brett Watson.

Klensin                     Standards Track                    [Page 80]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   The efforts of the Area Directors -- Lisa Dusseault, Ted Hardie, and
   Chris Newman -- to get this effort restarted and keep it moving, and
   of an ad hoc committee with the same purpose, are gratefully
   acknowledged.  The members of that committee were (in alphabetical
   order) Dave Crocker, Cyrus Daboo, Tony Finch, Ned Freed, Randall
   Gellens, Tony Hansen, the author, and Alexey Melnikov.  Tony Hansen
   also acted as ad hoc chair on the mailing list reviewing this
   document; without his efforts, sense of balance and fairness, and
   patience, it clearly would not have been possible.

[10](#section-10).  References

[10.1](#section-10.1).  Normative References

   [1]   Postel, J., "Simple Mail Transfer Protocol", STD 10, [RFC 821](./rfc821),
         August 1982.

   [2]   Mockapetris, P., "Domain names - implementation and
         specification", STD 13, [RFC 1035](./rfc1035), November 1987.

   [3]   Braden, R., "Requirements for Internet Hosts - Application and
         Support", STD 3, [RFC 1123](./rfc1123), October 1989.

   [4]   Resnick, P., "Internet Message Format", [RFC 5322](./rfc5322), October 2008.

   [5]   Bradner, S., "Key words for use in RFCs to Indicate Requirement
         Levels", [BCP 14](https://www.rfc-editor.org/bcp/bcp14), [RFC 2119](./rfc2119), March 1997.

   [6]   American National Standards Institute (formerly United States
         of America Standards Institute), "USA Code for Information
         Interchange", ANSI X3.4-1968, 1968.

         ANSI X3.4-1968 has been replaced by newer versions with slight
         modifications, but the 1968 version remains definitive for the
         Internet.

   [7]   Crocker, D. and P. Overell, "Augmented BNF for Syntax
         Specifications: ABNF", STD 68, [RFC 5234](./rfc5234), January 2008.

   [8]   Hinden, R. and S. Deering, "IP Version 6 Addressing
         Architecture", [RFC 4291](./rfc4291), February 2006.

   [9]   Newman, C., "ESMTP and LMTP Transmission Types Registration",
         [RFC 3848](./rfc3848), July 2004.

   [10]  Klensin, J., Freed, N., and K. Moore, "SMTP Service Extension
         for Message Size Declaration", STD 10, [RFC 1870](./rfc1870), November 1995.

Klensin                     Standards Track                    [Page 81]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   [11]  Klyne, G., Nottingham, M., and J. Mogul, "Registration
         Procedures for Message Header Fields", [BCP 90](https://www.rfc-editor.org/bcp/bcp90), [RFC 3864](./rfc3864),
         September 2004.

[10.2](#section-10.2).  Informative References

   [12]  Partridge, C., "Mail routing and the domain system", [RFC 974](./rfc974),
         January 1986.

   [13]  Klensin, J., Freed, N., Rose, M., Stefferud, E., and D.
         Crocker, "SMTP Service Extensions", STD 10, [RFC 1869](./rfc1869),
         November 1995.

   [14]  Klensin, J., "Simple Mail Transfer Protocol", [RFC 2821](./rfc2821),
         April 2001.

   [15]  Butler, M., Postel, J., Chase, D., Goldberger, J., and J.
         Reynolds, "Post Office Protocol: Version 2", [RFC 937](./rfc937),
         February 1985.

   [16]  Myers, J. and M. Rose, "Post Office Protocol - Version 3",
         STD 53, [RFC 1939](./rfc1939), May 1996.

   [17]  Crispin, M., "INTERNET MESSAGE ACCESS PROTOCOL - VERSION
         4rev1", [RFC 3501](./rfc3501), March 2003.

   [18]  Gellens, R. and J. Klensin, "Message Submission for Mail",
         [RFC 4409](./rfc4409), April 2006.

   [19]  Freed, N., "SMTP Service Extension for Command Pipelining",
         STD 60, [RFC 2920](./rfc2920), September 2000.

   [20]  Vaudreuil, G., "SMTP Service Extensions for Transmission of
         Large and Binary MIME Messages", [RFC 3030](./rfc3030), December 2000.

   [21]  Freed, N. and N. Borenstein, "Multipurpose Internet Mail
         Extensions (MIME) Part One: Format of Internet Message Bodies",
         [RFC 2045](./rfc2045), November 1996.

   [22]  Klensin, J., Freed, N., Rose, M., Stefferud, E., and D.
         Crocker, "SMTP Service Extension for 8bit-MIMEtransport",
         [RFC 1652](./rfc1652), July 1994.

   [23]  Moore, K., "MIME (Multipurpose Internet Mail Extensions) Part
         Three: Message Header Extensions for Non-ASCII Text", [RFC 2047](./rfc2047),
         November 1996.

Klensin                     Standards Track                    [Page 82]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   [24]  Freed, N. and K. Moore, "MIME Parameter Value and Encoded Word
         Extensions: Character Sets, Languages, and Continuations",
         [RFC 2231](./rfc2231), November 1997.

   [25]  Vaudreuil, G., "Enhanced Mail System Status Codes", [RFC 3463](./rfc3463),
         January 2003.

   [26]  Hansen, T. and J. Klensin, "A Registry for SMTP Enhanced Mail
         System Status Codes", [BCP 138](https://www.rfc-editor.org/bcp/bcp138), [RFC 5248](./rfc5248), June 2008.

   [27]  Freed, N., "Behavior of and Requirements for Internet
         Firewalls", [RFC 2979](./rfc2979), October 2000.

   [28]  Crocker, D., "Standard for the format of ARPA Internet text
         messages", STD 11, [RFC 822](./rfc822), August 1982.

   [29]  Wong, M. and W. Schlitt, "Sender Policy Framework (SPF) for
         Authorizing Use of Domains in E-Mail, Version 1", [RFC 4408](./rfc4408),
         April 2006.

   [30]  Fenton, J., "Analysis of Threats Motivating DomainKeys
         Identified Mail (DKIM)", [RFC 4686](./rfc4686), September 2006.

   [31]  Allman, E., Callas, J., Delany, M., Libbey, M., Fenton, J., and
         M. Thomas, "DomainKeys Identified Mail (DKIM) Signatures",
         [RFC 4871](./rfc4871), May 2007.

   [32]  Moore, K., "Simple Mail Transfer Protocol (SMTP) Service
         Extension for Delivery Status Notifications (DSNs)", [RFC 3461](./rfc3461),
         January 2003.

   [33]  Moore, K. and G. Vaudreuil, "An Extensible Message Format for
         Delivery Status Notifications", [RFC 3464](./rfc3464), January 2003.

   [34]  Postel, J. and J. Reynolds, "File Transfer Protocol", STD 9,
         [RFC 959](./rfc959), October 1985.

   [35]  Kille, S., "MIXER (Mime Internet X.400 Enhanced Relay): Mapping
         between X.400 and [RFC 822](./rfc822)/MIME", [RFC 2156](./rfc2156), January 1998.

   [36]  De Winter, J., "SMTP Service Extension for Remote Message Queue
         Starting", [RFC 1985](./rfc1985), August 1996.

   [37]  Hansen, T. and G. Vaudreuil, "Message Disposition
         Notification", [RFC 3798](./rfc3798), May 2004.

   [38]  Elz, R. and R. Bush, "Clarifications to the DNS Specification",
         [RFC 2181](./rfc2181), July 1997.

Klensin                     Standards Track                    [Page 83]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   [39]  Nakamura, M. and J. Hagino, "SMTP Operational Experience in
         Mixed IPv4/v6 Environments", [RFC 3974](./rfc3974), January 2005.

   [40]  Partridge, C., "Duplicate messages and SMTP", [RFC 1047](./rfc1047),
         February 1988.

   [41]  Crispin, M., "Interactive Mail Access Protocol: Version 2",
         [RFC 1176](./rfc1176), August 1990.

   [42]  Lambert, M., "PCMAIL: A distributed mail system for personal
         computers", [RFC 1056](./rfc1056), June 1988.

   [43]  Galvin, J., Murphy, S., Crocker, S., and N. Freed, "Security
         Multiparts for MIME: Multipart/Signed and Multipart/Encrypted",
         [RFC 1847](./rfc1847), October 1995.

   [44]  Callas, J., Donnerhacke, L., Finney, H., Shaw, D., and R.
         Thayer, "OpenPGP Message Format", [RFC 4880](./rfc4880), November 2007.

   [45]  Ramsdell, B., "Secure/Multipurpose Internet Mail Extensions
         (S/MIME) Version 3.1 Message Specification", [RFC 3851](./rfc3851),
         July 2004.

   [46]  Internet Assigned Number Authority (IANA), "IANA Mail
         Parameters", 2007,
         <<http://www.iana.org/assignments/mail-parameters>>.

   [47]  Internet Assigned Number Authority (IANA), "Address Literal
         Tags", 2007,
         <<http://www.iana.org/assignments/address-literal-tags>>.

Klensin                     Standards Track                    [Page 84]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[Appendix A](#appendix-A).  TCP Transport Service

   The TCP connection supports the transmission of 8-bit bytes.  The
   SMTP data is 7-bit ASCII characters.  Each character is transmitted
   as an 8-bit byte with the high-order bit cleared to zero.  Service
   extensions may modify this rule to permit transmission of full 8-bit
   data bytes as part of the message body, or, if specifically designed
   to do so, in SMTP commands or responses.

[Appendix B](#appendix-B).  Generating SMTP Commands from [RFC 822](./rfc822) Header Fields

   Some systems use an [RFC 822](./rfc822) header section (only) in a mail
   submission protocol, or otherwise generate SMTP commands from [RFC 822](./rfc822)
   header fields when such a message is handed to an MTA from a UA.
   While the MTA-UA protocol is a private matter, not covered by any
   Internet Standard, there are problems with this approach.  For
   example, there have been repeated problems with proper handling of
   "bcc" copies and redistribution lists when information that
   conceptually belongs to the mail envelope is not separated early in
   processing from header field information (and kept separate).

   It is recommended that the UA provide its initial ("submission
   client") MTA with an envelope separate from the message itself.
   However, if the envelope is not supplied, SMTP commands SHOULD be
   generated as follows:

   1.  Each recipient address from a TO, CC, or BCC header field SHOULD
       be copied to a RCPT command (generating multiple message copies
       if that is required for queuing or delivery).  This includes any
       addresses listed in a [RFC 822](./rfc822) "group".  Any BCC header fields
       SHOULD then be removed from the header section.  Once this
       process is completed, the remaining header fields SHOULD be
       checked to verify that at least one TO, CC, or BCC header field
       remains.  If none do, then a BCC header field with no additional
       information SHOULD be inserted as specified in [[4](#ref-4 "\"Internet Message Format\"")].

   2.  The return address in the MAIL command SHOULD, if possible, be
       derived from the system's identity for the submitting (local)
       user, and the "From:" header field otherwise.  If there is a
       system identity available, it SHOULD also be copied to the Sender
       header field if it is different from the address in the From
       header field.  (Any Sender header field that was already there
       SHOULD be removed.)  Systems may provide a way for submitters to
       override the envelope return address, but may want to restrict
       its use to privileged users.  This will not prevent mail forgery,
       but may lessen its incidence; see [Section 7.1](#section-7.1).

Klensin                     Standards Track                    [Page 85]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   When an MTA is being used in this way, it bears responsibility for
   ensuring that the message being transmitted is valid.  The mechanisms
   for checking that validity, and for handling (or returning) messages
   that are not valid at the time of arrival, are part of the MUA-MTA
   interface and not covered by this specification.

   A submission protocol based on Standard [RFC 822](./rfc822) information alone
   MUST NOT be used to gateway a message from a foreign (non-SMTP) mail
   system into an SMTP environment.  Additional information to construct
   an envelope must come from some source in the other environment,
   whether supplemental header fields or the foreign system's envelope.

   Attempts to gateway messages using only their header "To" and "Cc"
   fields have repeatedly caused mail loops and other behavior adverse
   to the proper functioning of the Internet mail environment.  These
   problems have been especially common when the message originates from
   an Internet mailing list and is distributed into the foreign
   environment using envelope information.  When these messages are then
   processed by a header-section-only remailer, loops back to the
   Internet environment (and the mailing list) are almost inevitable.

[Appendix C](#appendix-C).  Source Routes

   Historically, the <reverse-path> was a reverse source routing list of
   hosts and a source mailbox.  The first host in the <reverse-path> was
   historically the host sending the MAIL command; today, source routes
   SHOULD NOT appear in the reverse-path.  Similarly, the <forward-path>
   may be a source routing lists of hosts and a destination mailbox.
   However, in general, the <forward-path> SHOULD contain only a mailbox
   and domain name, relying on the domain name system to supply routing
   information if required.  The use of source routes is deprecated (see
   [Appendix F.2](#appendix-F.2)); while servers MUST be prepared to receive and handle
   them as discussed in [Section 3.3](#section-3.3) and [Appendix F.2](#appendix-F.2), clients SHOULD NOT
   transmit them and this section is included in the current
   specification only to provide context.  It has been modified somewhat
   from the material in [RFC 821](./rfc821) to prevent server actions that might
   confuse clients or subsequent servers that do not expect a full
   source route implementation.

   For relay purposes, the forward-path may be a source route of the
   form "@ONE,@TWO:JOE@THREE", where ONE, TWO, and THREE MUST be fully-
   qualified domain names.  This form is used to emphasize the
   distinction between an address and a route.  The mailbox (here, JOE@
   THREE) is an absolute address, and the route is information about how
   to get there.  The two concepts should not be confused.

   If source routes are used, [RFC 821](./rfc821) and the text below should be
   consulted for the mechanisms for constructing and updating the

Klensin                     Standards Track                    [Page 86]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   forward-path.  A server that is reached by means of a source route
   (e.g., its domain name appears first in the list in the forward-path)
   MUST remove its domain name from any forward-paths in which that
   domain name appears before forwarding the message and MAY remove all
   other source routing information.  The reverse-path SHOULD NOT be
   updated by servers conforming to this specification.

   Notice that the forward-path and reverse-path appear in the SMTP
   commands and replies, but not necessarily in the message.  That is,
   there is no need for these paths and especially this syntax to appear
   in the "To:" , "From:", "CC:", etc. fields of the message header
   section.  Conversely, SMTP servers MUST NOT derive final message
   routing information from message header fields.

   When the list of hosts is present despite the recommendations above,
   it is a "reverse" source route and indicates that the mail was
   relayed through each host on the list (the first host in the list was
   the most recent relay).  This list is used as a source route to
   return non-delivery notices to the sender.  If, contrary to the
   recommendations here, a relay host adds itself to the beginning of
   the list, it MUST use its name as known in the transport environment
   to which it is relaying the mail rather than that of the transport
   environment from which the mail came (if they are different).  Note
   that a situation could easily arise in which some relay hosts add
   their names to the reverse source route and others do not, generating
   discontinuities in the routing list.  This is another reason why
   servers needing to return a message SHOULD ignore the source route
   entirely and simply use the domain as specified in the Mailbox.

[Appendix D](#appendix-D).  Scenarios

   This section presents complete scenarios of several types of SMTP
   sessions.  In the examples, "C:" indicates what is said by the SMTP
   client, and "S:" indicates what is said by the SMTP server.

Klensin                     Standards Track                    [Page 87]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[D.1](#appendix-D.1).  A Typical SMTP Transaction Scenario

   This SMTP example shows mail sent by Smith at host bar.com, and to
   Jones, Green, and Brown at host foo.com.  Here we assume that host
   bar.com contacts host foo.com directly.  The mail is accepted for
   Jones and Brown.  Green does not have a mailbox at host foo.com.

      S: 220 foo.com Simple Mail Transfer Service Ready
      C: EHLO bar.com
      S: 250-foo.com greets bar.com
      S: 250-8BITMIME
      S: 250-SIZE
      S: 250-DSN
      S: 250 HELP
      C: MAIL FROM:<Smith@bar.com>
      S: 250 OK
      C: RCPT TO:<Jones@foo.com>
      S: 250 OK
      C: RCPT TO:<Green@foo.com>
      S: 550 No such user here
      C: RCPT TO:<Brown@foo.com>
      S: 250 OK
      C: DATA
      S: 354 Start mail input; end with <CRLF>.<CRLF>
      C: Blah blah blah...
      C: ...etc. etc. etc.
      C: .
      S: 250 OK
      C: QUIT
      S: 221 foo.com Service closing transmission channel

Klensin                     Standards Track                    [Page 88]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[D.2](#appendix-D.2).  Aborted SMTP Transaction Scenario

      S: 220 foo.com Simple Mail Transfer Service Ready
      C: EHLO bar.com
      S: 250-foo.com greets bar.com
      S: 250-8BITMIME
      S: 250-SIZE
      S: 250-DSN
      S: 250 HELP
      C: MAIL FROM:<Smith@bar.com>
      S: 250 OK
      C: RCPT TO:<Jones@foo.com>
      S: 250 OK
      C: RCPT TO:<Green@foo.com>
      S: 550 No such user here
      C: RSET
      S: 250 OK
      C: QUIT
      S: 221 foo.com Service closing transmission channel

Klensin                     Standards Track                    [Page 89]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[D.3](#appendix-D.3).  Relayed Mail Scenario

   Step 1 -- Source Host to Relay Host

   The source host performs a DNS lookup on XYZ.COM (the destination
   address) and finds DNS MX records specifying xyz.com as the best
   preference and foo.com as a lower preference.  It attempts to open a
   connection to xyz.com and fails.  It then opens a connection to
   foo.com, with the following dialogue:

      S: 220 foo.com Simple Mail Transfer Service Ready
      C: EHLO bar.com
      S: 250-foo.com greets bar.com
      S: 250-8BITMIME
      S: 250-SIZE
      S: 250-DSN
      S: 250 HELP
      C: MAIL FROM:<JQP@bar.com>
      S: 250 OK
      C: RCPT TO:<Jones@XYZ.COM>
      S: 250 OK
      C: DATA
      S: 354 Start mail input; end with <CRLF>.<CRLF>
      C: Date: Thu, 21 May 1998 05:33:29 -0700
      C: From: John Q. Public <JQP@bar.com>
      C: Subject: The Next Meeting of the Board
      C: To: Jones@xyz.com
      C:
      C: Bill:
      C: The next meeting of the board of directors will be
      C: on Tuesday.
      C: John.
      C: .
      S: 250 OK
      C: QUIT
      S: 221 foo.com Service closing transmission channel

Klensin                     Standards Track                    [Page 90]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

   Step 2 -- Relay Host to Destination Host

   foo.com, having received the message, now does a DNS lookup on
   xyz.com.  It finds the same set of MX records, but cannot use the one
   that points to itself (or to any other host as a worse preference).
   It tries to open a connection to xyz.com itself and succeeds.  Then
   we have:

           S: 220 xyz.com Simple Mail Transfer Service Ready
           C: EHLO foo.com
           S: 250 xyz.com is on the air
           C: MAIL FROM:<JQP@bar.com>
           S: 250 OK
           C: RCPT TO:<Jones@XYZ.COM>
           S: 250 OK
           C: DATA
           S: 354 Start mail input; end with <CRLF>.<CRLF>
           C: Received: from bar.com by foo.com ; Thu, 21 May 1998
           C:     05:33:29 -0700
           C: Date: Thu, 21 May 1998 05:33:22 -0700
           C: From: John Q. Public <JQP@bar.com>
           C: Subject:  The Next Meeting of the Board
           C: To: Jones@xyz.com
           C:
           C: Bill:
           C: The next meeting of the board of directors will be
           C: on Tuesday.
           C:                         John.
           C: .
           S: 250 OK
           C: QUIT
           S: 221 foo.com Service closing transmission channel

Klensin                     Standards Track                    [Page 91]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[D.4](#appendix-D.4).  Verifying and Sending Scenario

      S: 220 foo.com Simple Mail Transfer Service Ready
      C: EHLO bar.com
      S: 250-foo.com greets bar.com
      S: 250-8BITMIME
      S: 250-SIZE
      S: 250-DSN
      S: 250-VRFY
      S: 250 HELP
      C: VRFY Crispin
      S: 250 Mark Crispin <Admin.MRC@foo.com>
      C: MAIL FROM:<EAK@bar.com>
      S: 250 OK
      C: RCPT TO:<Admin.MRC@foo.com>
      S: 250 OK
      C: DATA
      S: 354 Start mail input; end with <CRLF>.<CRLF>
      C: Blah blah blah...
      C: ...etc. etc. etc.
      C: .
      S: 250 OK
      C: QUIT
      S: 221 foo.com Service closing transmission channel

[Appendix E](#appendix-E).  Other Gateway Issues

   In general, gateways between the Internet and other mail systems
   SHOULD attempt to preserve any layering semantics across the
   boundaries between the two mail systems involved.  Gateway-
   translation approaches that attempt to take shortcuts by mapping
   (such as mapping envelope information from one system to the message
   header section or body of another) have generally proven to be
   inadequate in important ways.  Systems translating between
   environments that do not support both envelopes and a header section
   and Internet mail must be written with the understanding that some
   information loss is almost inevitable.

Klensin                     Standards Track                    [Page 92]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[Appendix F](#appendix-F).  Deprecated Features of [RFC 821](./rfc821)

   A few features of [RFC 821](./rfc821) have proven to be problematic and SHOULD
   NOT be used in Internet mail.

[F.1](#appendix-F.1).  TURN

   This command, described in [RFC 821](./rfc821), raises important security issues
   since, in the absence of strong authentication of the host requesting
   that the client and server switch roles, it can easily be used to
   divert mail from its correct destination.  Its use is deprecated;
   SMTP systems SHOULD NOT use it unless the server can authenticate the
   client.

[F.2](#appendix-F.2).  Source Routing

   [RFC 821](./rfc821) utilized the concept of explicit source routing to get mail
   from one host to another via a series of relays.  The requirement to
   utilize source routes in regular mail traffic was eliminated by the
   introduction of the domain name system "MX" record and the last
   significant justification for them was eliminated by the
   introduction, in [RFC 1123](./rfc1123), of a clear requirement that addresses
   following an "@" must all be fully-qualified domain names.
   Consequently, the only remaining justifications for the use of source
   routes are support for very old SMTP clients or MUAs and in mail
   system debugging.  They can, however, still be useful in the latter
   circumstance and for routing mail around serious, but temporary,
   problems such as problems with the relevant DNS records.

   SMTP servers MUST continue to accept source route syntax as specified
   in the main body of this document and in [RFC 1123](./rfc1123).  They MAY, if
   necessary, ignore the routes and utilize only the target domain in
   the address.  If they do utilize the source route, the message MUST
   be sent to the first domain shown in the address.  In particular, a
   server MUST NOT guess at shortcuts within the source route.

   Clients SHOULD NOT utilize explicit source routing except under
   unusual circumstances, such as debugging or potentially relaying
   around firewall or mail system configuration errors.

[F.3](#appendix-F.3).  HELO

   As discussed in Sections [3.1](#section-3.1) and [4.1.1](#section-4.1.1), EHLO SHOULD be used rather
   than HELO when the server will accept the former.  Servers MUST
   continue to accept and process HELO in order to support older
   clients.

Klensin                     Standards Track                    [Page 93]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

[F.4](#appendix-F.4).  #-literals

   [RFC 821](./rfc821) provided for specifying an Internet address as a decimal
   integer host number prefixed by a pound sign, "#".  In practice, that
   form has been obsolete since the introduction of TCP/IP.  It is
   deprecated and MUST NOT be used.

[F.5](#appendix-F.5).  Dates and Years

   When dates are inserted into messages by SMTP clients or servers
   (e.g., in trace header fields), four-digit years MUST BE used.  Two-
   digit years are deprecated; three-digit years were never permitted in
   the Internet mail system.

[F.6](#appendix-F.6).  Sending versus Mailing

   In addition to specifying a mechanism for delivering messages to
   user's mailboxes, [RFC 821](./rfc821) provided additional, optional, commands to
   deliver messages directly to the user's terminal screen.  These
   commands (SEND, SAML, SOML) were rarely implemented, and changes in
   workstation technology and the introduction of other protocols may
   have rendered them obsolete even where they are implemented.

   Clients SHOULD NOT provide SEND, SAML, or SOML as services.  Servers
   MAY implement them.  If they are implemented by servers, the
   implementation model specified in [RFC 821](./rfc821) MUST be used and the
   command names MUST be published in the response to the EHLO command.

Author's Address

   John C. Klensin
   1770 Massachusetts Ave, Suite 322
   Cambridge, MA  02140
   USA

   EMail: john+smtp@jck.com

Klensin                     Standards Track                    [Page 94]
```

---

```

[RFC 5321](./rfc5321)                          SMTP                      October 2008

Full Copyright Statement

   Copyright (C) The IETF Trust (2008).

   This document is subject to the rights, licenses and restrictions
   contained in [BCP 78](https://www.rfc-editor.org/bcp/bcp78), and except as set forth therein, the authors
   retain all their rights.

   This document and the information contained herein are provided on an
   "AS IS" basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS
   OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST AND
   THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS
   OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF
   THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
   WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Intellectual Property

   The IETF takes no position regarding the validity or scope of any
   Intellectual Property Rights or other rights that might be claimed to
   pertain to the implementation or use of the technology described in
   this document or the extent to which any license under such rights
   might or might not be available; nor does it represent that it has
   made any independent effort to identify any such rights.  Information
   on the procedures with respect to rights in RFC documents can be
   found in [BCP 78](https://www.rfc-editor.org/bcp/bcp78) and [BCP 79](https://www.rfc-editor.org/bcp/bcp79).

   Copies of IPR disclosures made to the IETF Secretariat and any
   assurances of licenses to be made available, or the result of an
   attempt made to obtain a general license or permission for the use of
   such proprietary rights by implementers or users of this
   specification can be obtained from the IETF on-line IPR repository at
   <http://www.ietf.org/ipr>.

   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights that may cover technology that may be required to implement
   this standard.  Please address the information to the IETF at
   ietf-ipr@ietf.org.

Klensin                     Standards Track                    [Page 95]

```

