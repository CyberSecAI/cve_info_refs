=== Content from github.com_9e299ef1_20250115_092136.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fissues%2F14492)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fissues%2F14492)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

# Federation was broken between my homeserver and matrix.org (and I fixed it with this patch)Â #14492

[Jump to bottom](#comment-composer-heading)Copy link[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Federation was broken between my homeserver and matrix.org (and I fixed it with this patch)](#top)#14492Copy linkAssignees [![DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=64&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)Labels[A-Federation](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22A-Federation%22)[O-OccasionalAffects or can be seen by some users regularly or most users rarely](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22O-Occasional%22)Affects or can be seen by some users regularly or most users rarely[S-MajorMajor functionality / product severely impaired, no satisfactory workaround.](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22S-Major%22)Major functionality / product severely impaired, no satisfactory workaround.[T-DefectBugs, crashes, hangs, security vulnerabilities, or other reported issues.](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22T-Defect%22)Bugs, crashes, hangs, security vulnerabilities, or other reported issues.![@anonfloppa](https://avatars.githubusercontent.com/u/92233267?u=f8e1ad9c0a4d9d194df8afbe705d6a69ba4a4a89&v=4&size=80)
## Description

![@anonfloppa](https://avatars.githubusercontent.com/u/92233267?u=f8e1ad9c0a4d9d194df8afbe705d6a69ba4a4a89&v=4&size=48)[anonfloppa](https://github.com/anonfloppa)opened [on Nov 18, 2022](https://github.com/matrix-org/synapse/issues/14492#issue-1455762646)
### Description

federation between my homeserver and matrix.org was broken. My homeserver was able to send messages but messages sent from matrix.org were never received. I was not the only server affected by this issue and another homeserver admin found a solution in [#synapse-admins](https://matrix.to/#/#synapse:matrix.org):

```
--- synapse/app/_base.py.2022118        2022-11-09 10:52:11.000000000 +0100
+++ synapse/app/_base.py        2022-11-18 00:38:43.054743699 +0100
@@ -650,7 +650,9 @@
     #
     # in short, we somewhat arbitrarily limit requests to 200 * 64K (about 12.5M)
     #
-    max_request_size = 200 * MAX_PDU_SIZE
+    #max_request_size = 200 * MAX_PDU_SIZE
+    max_request_size = 2000 * MAX_PDU_SIZE

     # if we have a media repo enabled, we may need to allow larger uploads than that
     if config.media.can_load_media_repo:

```

This patch worked for the original author and I confirm it is working for me too. I also made sure the parameter `client_max_body_size` in my nginx reverse-proxy was high enough. Increasing the value in nginx was not enough to fix the issue, the patch above was needed. I was affected by this bug since last weekend and I did a lot of tests by changing many values in nginx by increasing timeouts and size but nothing worked. I also tried changing synapse cache values and configs but that didn't do the trick either.

### Steps to reproduce

I do not know how to reproduce the initial conditions that caused the bug but the patch fixed the federation between my server and matrix.org.

### Homeserver

matrix.org was the server unable to send messages

### Synapse Version

1.72.0rc1 for matrix and I run 1.71.0

### Installation Method

Docker (matrixdotorg/synapse)

### Platform

Ubuntu LTS and I use the Ansible playbook from <https://github.com/spantaleev/matrix-docker-ansible-deploy>

### Relevant log output

```
here is an example of logs that I was seeing on my side:

Nov 17 21:46:19 localhost matrix-nginx-proxy[2836800]: 2022/11/18 02:46:19 [error] 30#30: *13315398 recv() failed (104: Connection reset by peer) while reading response header from upstream, client: 172.18.0.19, server: matrix-nginx-proxy, request: "PUT /_matrix/federation/v1/send/1668680027792 HTTP/1.0", upstream: "http://172.18.0.21:18111/_matrix/federation/v1/send/1668680027792", host: "matrix.anontier.nl"

here is a log that was submitted to me by a matrix developer:

2022-11-16 08:19:04,015 - synapse.http.matrixfederationclient - 672 - INFO - federation_transaction_transmission_loop-1891708-- - {PUT-O-1387436} [anontier.nl] Request failed: PUT matrix://anontier.nl/_matrix/federation/v1/send/1668471702441: HttpResponseException('502: Bad Gateway')
2022-11-16 08:20:01,940 - synapse.http.matrixfederationclient - 629 - INFO - federation_transaction_transmission_loop-1891708-- - {PUT-O-1387436} [anontier.nl] Got response headers: 502 Bad Gateway
```
### Anything else that would be useful to know?

*No response*

ð2
## Metadata

### Assignees

* [![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=64&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)DMRobertson](/DMRobertson)
### Labels

[A-Federation](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22A-Federation%22)[O-OccasionalAffects or can be seen by some users regularly or most users rarely](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22O-Occasional%22)Affects or can be seen by some users regularly or most users rarely[S-MajorMajor functionality / product severely impaired, no satisfactory workaround.](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22S-Major%22)Major functionality / product severely impaired, no satisfactory workaround.[T-DefectBugs, crashes, hangs, security vulnerabilities, or other reported issues.](https://github.com/matrix-org/synapse/issues?q=state%3Aopen%20label%3A%22T-Defect%22)Bugs, crashes, hangs, security vulnerabilities, or other reported issues.
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canât perform that action at this time.



=== Content from github.com_2bec3aa1_20250115_092140.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fsecurity%2Fadvisories%2FGHSA-f3wc-3vxv-xmvr)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fsecurity%2Fadvisories%2FGHSA-f3wc-3vxv-xmvr)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

# Outgoing federation to specific hosts can be disabled by sending malicious invites

Moderate

[dkasak](/dkasak)
published
GHSA-f3wc-3vxv-xmvr
May 24, 2023

## Package

pip

matrix-synapse
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

<1.74.0

## Patched versions

1.74.0

## Description

### Impact

A malicious user on a Synapse homeserver X with permission to create certain state events can disable outbound federation from X to an arbitrary homeserver Y.

Synapse instances with federation disabled are not affected.

#### Details

The Matrix protocol allows homeservers to provide an `invite_room_state` field on a [room invite](https://spec.matrix.org/v1.5/client-server-api/#mroommember) containing a [summary of room state](https://spec.matrix.org/v1.5/client-server-api/#stripped-state). In versions of Synapse up to and including v1.73.0, Synapse did not limit the size of `invite_room_state`, meaning that it was possible to create an arbitrarily large invite event.

An attacker with an account on a vulnerable Synapse homeserver X could exploit this by having X create an over-sized invite event in a room with a user from another homeserver Y. Once acknowledged by the invitee's homeserver, the invite event would be sent in a batch of events to Y. If the malicious invite is so large that the entire batch is rejected as too large, X's outgoing traffic to Y would become "stuck", meaning that messages and state events created by X would remain unseen by Y.

### Patches

Synapse 1.74 refuses to create oversized `invite_room_state` fields. Server operators should upgrade to Synapse 1.74 or newer urgently.

### Workarounds

There are no robust workarounds.

This attack needs an account on Synapse homeserver X to deny federation from X to another homeserver Y. As a partial mitigation, Synapse operators can disable open registration to limit the ability of attackers to create new accounts on homeserver X.

If homeserver X has been attacked in this way, restarting it will resume outgoing federation by entering "catchup mode". For catchup mode to ignore the oversized invites, every attacked room must have a correctly-sized event sent by X which is newer than any oversized invite. This is difficult to arrange, and does not prevent the attacker from repeating their attack.

### References

* [#14492](https://github.com/matrix-org/synapse/issues/14492) was caused by this issue.
* [#14642](https://github.com/matrix-org/synapse/pull/14642) includes the patch described above.

### For more information

If you have any questions or comments about this advisory, e-mail us at security@matrix.org.

### Severity

Moderate

5.0

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
Low

User interaction
None

Scope
Changed

Confidentiality
None

Integrity
None

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:N/I:N/A:L

### CVE ID

CVE-2023-32323

### Weaknesses

[CWE-20](/advisories?query=cwe%3A20)

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canât perform that action at this time.



=== Content from github.com_83155e4a_20250115_092139.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F14642)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F14642)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

# Allow selecting "prejoin" events by state keys #14642

 Merged

[DMRobertson](/DMRobertson)
merged 15 commits into
[develop](/matrix-org/synapse/tree/develop "matrix-org/synapse:develop")
from
[dmr/more-specific-prejoin-state](/matrix-org/synapse/tree/dmr/more-specific-prejoin-state "matrix-org/synapse:dmr/more-specific-prejoin-state")

Dec 13, 2022

 Merged

# [Allow selecting "prejoin" events by state keys](#top) #14642

[DMRobertson](/DMRobertson)
merged 15 commits into
[develop](/matrix-org/synapse/tree/develop "matrix-org/synapse:develop")
from
[dmr/more-specific-prejoin-state](/matrix-org/synapse/tree/dmr/more-specific-prejoin-state "matrix-org/synapse:dmr/more-specific-prejoin-state")

Dec 13, 2022

[Conversation
18](/matrix-org/synapse/pull/14642)
[Commits
15](/matrix-org/synapse/pull/14642/commits)
[Checks
0](/matrix-org/synapse/pull/14642/checks)
[Files changed](/matrix-org/synapse/pull/14642/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=60&v=4)](/DMRobertson)

Copy link

Contributor

### @DMRobertson **[DMRobertson](/DMRobertson)** commented [Dec 7, 2022](#issue-1482769935) â¢ edited Loading

Fixes [#14640](https://github.com/matrix-org/synapse/issues/14640).

Recommend commitwise review.

See <https://pr14642--synapse-docs-previews.netlify.app/usage/configuration/config_documentation.html#room_prejoin_state> for docs

Sorry, something went wrong.

All reactions

 David Robertson
added 6 commits
[December 7, 2022 18:35](#commits-pushed-f03b305)

`[Declare new config](/matrix-org/synapse/pull/14642/commits/f03b3056292871250c1a57e060daecdf6a9311c4 "Declare new config")`

`[f03b305](/matrix-org/synapse/pull/14642/commits/f03b3056292871250c1a57e060daecdf6a9311c4)`

`[Parse new config](/matrix-org/synapse/pull/14642/commits/c801ce78cda15670d67bb6423ecd28e2653c9680 "Parse new config")`

`[c801ce7](/matrix-org/synapse/pull/14642/commits/c801ce78cda15670d67bb6423ecd28e2653c9680)`

`[Read new config](/matrix-org/synapse/pull/14642/commits/8ed2d936ac457db110f3c40b9f3e37dd0638f850 "Read new config")`

`[8ed2d93](/matrix-org/synapse/pull/14642/commits/8ed2d936ac457db110f3c40b9f3e37dd0638f850)`

`[Don't use trial/our TestCase where it's not needed](/matrix-org/synapse/pull/14642/commits/eb0bbbe1b5c0680435f52b93ac41f785cef73d1a "Don't use trial/our TestCase where it's not needed

Before:

```
$ time trial tests/events/test_utils.py > /dev/null

real	0m2.277s
user	0m2.186s
sys	0m0.083s
```

After:
```
$ time trial tests/events/test_utils.py > /dev/null

real	0m0.566s
user	0m0.508s
sys	0m0.056s
```")`
 â¦

`[eb0bbbe](/matrix-org/synapse/pull/14642/commits/eb0bbbe1b5c0680435f52b93ac41f785cef73d1a)`

```
Before:

```
$ time trial tests/events/test_utils.py > /dev/null

real	0m2.277s
user	0m2.186s
sys	0m0.083s
```

After:
```
$ time trial tests/events/test_utils.py > /dev/null

real	0m0.566s
user	0m0.508s
sys	0m0.056s
```
```

`[Helper to upsert to event fields](/matrix-org/synapse/pull/14642/commits/c6199a3f21b4139506b8594635256e54a532cccc "Helper to upsert to event fields

without exceeding size limits.")`
 â¦

`[c6199a3](/matrix-org/synapse/pull/14642/commits/c6199a3f21b4139506b8594635256e54a532cccc)`

```
without exceeding size limits.
```

`[Use helper when adding invite/knock state](/matrix-org/synapse/pull/14642/commits/ddc563c18e682cbea1d442e695e2babb37ae471c "Use helper when adding invite/knock state

Now that we allow admins to include events in prejoin room state with
arbitrary state keys, be a good Matrix citizen and ensure they don't
accidentally create an oversized event.")`
 â¦

`[ddc563c](/matrix-org/synapse/pull/14642/commits/ddc563c18e682cbea1d442e695e2babb37ae471c)`

```
Now that we allow admins to include events in prejoin room state with
arbitrary state keys, be a good Matrix citizen and ensure they don't
accidentally create an oversized event.
```

 [![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
[deployed](https://github.com/matrix-org/synapse/commit/60c3fea3271468dd1f9e9c5fae2d22dd9778293b/checks "Documentation preview")
to
[PR Documentation Preview](https://pr14642--synapse-docs-previews.netlify.app)
[December 7, 2022 20:29](#event-7981691399)
[View deployment](https://pr14642--synapse-docs-previews.netlify.app)

`[Changelog](/matrix-org/synapse/pull/14642/commits/33a559f80f416525d20e0ea9ff72f282848cceed "Changelog")`

`[33a559f](/matrix-org/synapse/pull/14642/commits/33a559f80f416525d20e0ea9ff72f282848cceed)`

 [![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
[deployed](https://github.com/matrix-org/synapse/commit/60c3fea3271468dd1f9e9c5fae2d22dd9778293b/checks "Documentation preview")
to
[PR Documentation Preview](https://pr14642--synapse-docs-previews.netlify.app)
[December 7, 2022 20:33](#event-7981731954)
[View deployment](https://pr14642--synapse-docs-previews.netlify.app)

[![clokep](https://avatars.githubusercontent.com/u/517124?s=60&v=4)](/clokep)

**[clokep](/clokep)**
reviewed
[Dec 7, 2022](#pullrequestreview-1209085068)

 [View reviewed changes](/matrix-org/synapse/pull/14642/files/33a559f80f416525d20e0ea9ff72f282848cceed)

[docs/usage/configuration/config\_documentation.md](/matrix-org/synapse/pull/14642/files/33a559f80f416525d20e0ea9ff72f282848cceed#diff-1865c1e8307bb29e7f82bbaae74af9e1e09936211f514e8a8006cfd0c2bdea9d)

Show resolved

Hide resolved

 [![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
marked this pull request as ready for review
[December 8, 2022 10:33](#event-7987513209)

 [![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
requested a review
from a team
as a [code owner](/matrix-org/synapse/blob/dfe8febe47bce48bb78bc5ea39d3c7f524d68177/.github/CODEOWNERS#L2)
[December 8, 2022 10:33](#event-7987513291)

[![DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=60&v=4)](/DMRobertson)

**[DMRobertson](/DMRobertson)**
commented
[Dec 8, 2022](#pullrequestreview-1209857007)

 [View reviewed changes](/matrix-org/synapse/pull/14642/files/33a559f80f416525d20e0ea9ff72f282848cceed)

[synapse/config/api.py](/matrix-org/synapse/pull/14642/files/33a559f80f416525d20e0ea9ff72f282848cceed#diff-4e871fc4f51b36e2971d906c447c3ab8fb8332e4136a0cb2ba8e6b2a1b21b024)
Outdated

Comment on lines
68
 to
79

|  |  | def \_build\_prejoin\_state(self, config: JsonDict) -> Dict[str, StateKeyFilter]: |
| --- | --- | --- |
|  |  | prejoin\_events = {} |
|  |  | for event\_type, state\_key in self.\_get\_prejoin\_state\_entries(config): |
|  |  | if event\_type not in prejoin\_events: |
|  |  | if state\_key is None: |
|  |  | filter = StateKeyFilter.any() |
|  |  | else: |
|  |  | filter = StateKeyFilter.only(state\_key) |
|  |  | prejoin\_events[event\_type] = filter |
|  |  | else: |
|  |  | prejoin\_events[event\_type].add(state\_key) |
|  |  | return prejoin\_events |

Copy link

Contributor

Author

### @DMRobertson **[DMRobertson](/DMRobertson)** [Dec 8, 2022](#discussion_r1043205043)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This wasn't particularly neat, but it gets the job done.

Sorry, something went wrong.

All reactions

`[Merge branch 'develop' into dmr/more-specific-prejoin-state](/matrix-org/synapse/pull/14642/commits/a5f6178bc46b5ce9ddeadf57fbcbc664a11b6ff8 "Merge branch 'develop' into dmr/more-specific-prejoin-state")`

`[a5f6178](/matrix-org/synapse/pull/14642/commits/a5f6178bc46b5ce9ddeadf57fbcbc664a11b6ff8)`

 [![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
[deployed](https://github.com/matrix-org/synapse/commit/4ea8745724ee5336c32443a1264abe7632e643df/checks "Documentation preview")
to
[PR Documentation Preview](https://pr14642--synapse-docs-previews.netlify.app)
[December 12, 2022 11:35](#event-8013246426)
[View deployment](https://pr14642--synapse-docs-previews.netlify.app)

 [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)
[reivilibre](/reivilibre)
self-requested a review
[December 12, 2022 11:37](#event-8013258106)

[![reivilibre](https://avatars.githubusercontent.com/u/38398653?s=60&v=4)](/reivilibre)

**[reivilibre](/reivilibre)**
previously approved these changes
[Dec 12, 2022](#pullrequestreview-1213363089)

 [View reviewed changes](/matrix-org/synapse/pull/14642/files/a5f6178bc46b5ce9ddeadf57fbcbc664a11b6ff8)

Copy link

Contributor

### @reivilibre **[reivilibre](/reivilibre)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

not sure about the need for a new type of `StateFilter` â note that the normal `StateFilter` is usable for querying only the required state from the database as well, but I trust you've considered it and have good reason

Sorry, something went wrong.

All reactions

[synapse/config/api.py](/matrix-org/synapse/pull/14642/files/f03b3056292871250c1a57e060daecdf6a9311c4..c801ce78cda15670d67bb6423ecd28e2653c9680#diff-4e871fc4f51b36e2971d906c447c3ab8fb8332e4136a0cb2ba8e6b2a1b21b024)
Outdated

|  |  | filter = StateKeyFilter.only(state\_key) |
| --- | --- | --- |
|  |  | prejoin\_events[event\_type] = filter |
|  |  | else: |
|  |  | prejoin\_events[event\_type].add(state\_key) |

Copy link

Contributor

### @reivilibre **[reivilibre](/reivilibre)** [Dec 12, 2022](#discussion_r1045718717)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

can `state_key` be `None` here? do we need to guard against that?

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @DMRobertson **[DMRobertson](/DMRobertson)** [Dec 12, 2022](#discussion_r1045761379)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

> can state\_key be None here?

Yes, if someone specifies an entry consisting only of an event type.

> do we need to guard against that?

No, it's a valid input that's explicitly handled by `.add(None)`, see

[synapse/synapse/config/api.py](https://github.com/matrix-org/synapse/blob/c801ce78cda15670d67bb6423ecd28e2653c9680/synapse/config/api.py#L50-L52)

Lines 50 to 52
in
[c801ce7](/matrix-org/synapse/commit/c801ce78cda15670d67bb6423ecd28e2653c9680)

|  | def add(self, state\_key: Optional[str]) -> None: |
| --- | --- |
|  | if state\_key is None: |
|  | self.options = set() |

Sorry, something went wrong.

All reactions

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=80&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)

Copy link

Contributor

Author

### **[DMRobertson](/DMRobertson)** commented [Dec 12, 2022](#issuecomment-1346383863)

| not sure about the need for a new type of StateFilter  FWIW I don't intend for this to get used outside the config class.  I trust you've considered it and have good reason  I admit it's somewhat ideological and bordering on overkill.  The thinking: for each configured event type `T`, we either have   * a nonempty set of accepted state key strings, or * a dummy value meaning "accept any state key".   It's tempting to represent the dummy value with the empty set. But that's a bit a footgun, because the semantics don't match. E.g.   * `set{} | {"hello"}` is `{"hello"}`, meaning only the "hello" state key is allowed, * but "no restriction on state key" union "state key `hello` is permitted" is "no restriction on state key".   so this wrapper was an attempt to avoid footgunning yourself.   ---   Happy to rework this to e.g. use a different representation or to make the type more obviously private, especially if you think it's unclear as is. WDYT? |
| --- |

All reactions

Sorry, something went wrong.

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=80&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)

Copy link

Contributor

### **[reivilibre](/reivilibre)** commented [Dec 12, 2022](#issuecomment-1346418172) â¢ edited Loading

| I think `StateFilter.from_types` does closely enough to what you want? â you give it `(type, state_key)` tuples (or `(type, None)` for all state keys of the given type).  I don't know if tests back this up, but to my eye it looks like giving it `[("type1", "sk1"), ("type1", None)]` will do the right thing regarding union behaviour and expand to `[("type1", None)]` â with None meaning 'ALL' or 'no restriction'...  I believe `StateFilter.filter_state` should also be useful to you in doing the filtering, rather than doing it yourself with `should_include`.  However it's very possible I haven't spotted something subtle which means I'm wrong |
| --- |

All reactions

Sorry, something went wrong.

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=80&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)

Copy link

Contributor

Author

### **[DMRobertson](/DMRobertson)** commented [Dec 12, 2022](#issuecomment-1346422210)

| Oh ISWYM. I think I thought StateFilter was a no-go for some reason... but I'm not sure I thought about it properly. I'll take a proper look |
| --- |

All reactions

Sorry, something went wrong.

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=80&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)

Copy link

Contributor

Author

### **[DMRobertson](/DMRobertson)** commented [Dec 12, 2022](#issuecomment-1346881740)

| Ahh, I think I've messed up merging in with [#14668](https://github.com/matrix-org/synapse/pull/14668). Might have to rebase this, sorry |
| --- |

All reactions

Sorry, something went wrong.

 David Robertson
added 4 commits
[December 12, 2022 17:04](#commits-pushed-d4b86c1)

`[Merge remote-tracking branch 'origin/develop' into dmr/more-specific-â¦](/matrix-org/synapse/pull/14642/commits/d4b86c1c56572e536f93dfec8dfe2af87e51613f "Merge remote-tracking branch 'origin/develop' into dmr/more-specific-prejoin-state")`
 â¦

`[d4b86c1](/matrix-org/synapse/pull/14642/commits/d4b86c1c56572e536f93dfec8dfe2af87e51613f)`

```
â¦prejoin-state
```

`[Move StateFilter tests](/matrix-org/synapse/pull/14642/commits/fe30c5d1a457e4e6ed10a513f3b99209ddf804f3 "Move StateFilter tests

should have done this in #14668")`
 â¦

`[fe30c5d](/matrix-org/synapse/pull/14642/commits/fe30c5d1a457e4e6ed10a513f3b99209ddf804f3)`

```
should have done this in [#14668](https://github.com/matrix-org/synapse/pull/14668)
```

`[Add extra methods to StateFilter](/matrix-org/synapse/pull/14642/commits/1bc0f13e7daea12348e147bf8a630d4872a04fc1 "Add extra methods to StateFilter")`

`[1bc0f13](/matrix-org/synapse/pull/14642/commits/1bc0f13e7daea12348e147bf8a630d4872a04fc1)`

`[Use StateFilter](/matrix-org/synapse/pull/14642/commits/11124ed8c5aeb45c7a782f3ed41a188d10261f6e "Use StateFilter")`

`[11124ed](/matrix-org/synapse/pull/14642/commits/11124ed8c5aeb45c7a782f3ed41a188d10261f6e)`

 [![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
[force-pushed](/matrix-org/synapse/compare/2d490c68bdf7c125539fb07296c2bcb4b3f6aaa6..11124ed8c5aeb45c7a782f3ed41a188d10261f6e)
the
dmr/more-specific-prejoin-state

branch
from
[`2d490c6`](/matrix-org/synapse/commit/2d490c68bdf7c125539fb07296c2bcb4b3f6aaa6) to
[`11124ed`](/matrix-org/synapse/commit/11124ed8c5aeb45c7a782f3ed41a188d10261f6e)  [Compare](/matrix-org/synapse/compare/2d490c68bdf7c125539fb07296c2bcb4b3f6aaa6..11124ed8c5aeb45c7a782f3ed41a188d10261f6e)
[December 12, 2022 17:05](#event-8016438920)

 [![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
[deployed](https://github.com/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2/checks "Documentation preview")
to
[PR Documentation Preview](https://pr14642--synapse-docs-previews.netlify.app)
[December 12, 2022 17:06](#event-8016450250)
[View deployment](https://pr14642--synapse-docs-previews.netlify.app)

`[Ensure test file enforces typed defs; alphabetise](/matrix-org/synapse/pull/14642/commits/af032d218f1264836e6b8f919b5219042b55f1e3 "Ensure test file enforces typed defs; alphabetise")`

`[af032d2](/matrix-org/synapse/pull/14642/commits/af032d218f1264836e6b8f919b5219042b55f1e3)`

 [![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
[deployed](https://github.com/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2/checks "Documentation preview")
to
[PR Documentation Preview](https://pr14642--synapse-docs-previews.netlify.app)
[December 12, 2022 17:10](#event-8016491940)
[View deployment](https://pr14642--synapse-docs-previews.netlify.app)

 [![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
requested a review
from [reivilibre](/reivilibre)
[December 12, 2022 17:24](#event-8016625085)

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
added
the
[X-Release-Blocker](/matrix-org/synapse/labels/X-Release-Blocker)
Must be resolved before making a release
label
[Dec 12, 2022](#event-8016626116)

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=80&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)

Copy link

Contributor

Author

### **[DMRobertson](/DMRobertson)** commented [Dec 12, 2022](#issuecomment-1346920457)

| Cheekily marking this as release-blocker because I'd like to get it in before I go on holiday. |
| --- |

All reactions

Sorry, something went wrong.

`[Workaround surprising get_current_state_ids](/matrix-org/synapse/pull/14642/commits/837f6c2ce9dd2bdcb6c8f65d8cd0a227bf40acd5 "Workaround surprising get_current_state_ids")`

`[837f6c2](/matrix-org/synapse/pull/14642/commits/837f6c2ce9dd2bdcb6c8f65d8cd0a227bf40acd5)`

 [![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
[deployed](https://github.com/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2/checks "Documentation preview")
to
[PR Documentation Preview](https://pr14642--synapse-docs-previews.netlify.app)
[December 12, 2022 18:11](#event-8017030194)
[View deployment](https://pr14642--synapse-docs-previews.netlify.app)

`[Whoops, fix mypy](/matrix-org/synapse/pull/14642/commits/23ca964eeec3c579aa572e9d9f291fd7617a0508 "Whoops, fix mypy")`

`[23ca964](/matrix-org/synapse/pull/14642/commits/23ca964eeec3c579aa572e9d9f291fd7617a0508)`

 [![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
[deployed](https://github.com/matrix-org/synapse/commit/7982891794e26cabe18448f4e0ec0d301f13d186/checks "Documentation preview")
to
[PR Documentation Preview](https://pr14642--synapse-docs-previews.netlify.app)
[December 12, 2022 18:19](#event-8017097916)
[View deployment](https://pr14642--synapse-docs-previews.netlify.app)

 [![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
dismissed
[reivilibre](/reivilibre)âs [stale review](#pullrequestreview-1213363089)
[December 12, 2022 18:41](#event-8017274003)

StateFilter changes

[![reivilibre](https://avatars.githubusercontent.com/u/38398653?s=60&v=4)](/reivilibre)

**[reivilibre](/reivilibre)**
reviewed
[Dec 12, 2022](#pullrequestreview-1214297275)

 [View reviewed changes](/matrix-org/synapse/pull/14642/files/23ca964eeec3c579aa572e9d9f291fd7617a0508)

Copy link

Contributor

### @reivilibre **[reivilibre](/reivilibre)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

LGTM, thanks for entertaining me on switching to `StateFilter`!

Sorry, something went wrong.

All reactions

[synapse/storage/databases/main/events\_worker.py](/matrix-org/synapse/pull/14642/files/23ca964eeec3c579aa572e9d9f291fd7617a0508#diff-28da6922f7ab91da0023fa1d9b4ba5d8fa3d5abe924e9160e0646c852b31f6fa)

Comment on lines
+919
 to
+920

|  |  | # Confusingly, get\_current\_state\_events may return events that are discarded by |
| --- | --- | --- |
|  |  | # the filter, if they're in context.\_state\_delta\_due\_to\_event. Strip these away. |

Copy link

Contributor

### @reivilibre **[reivilibre](/reivilibre)** [Dec 12, 2022](#discussion_r1046361311)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

hmph. Sounds footgunny. Might be worth looking to see if it's worth pushing `StateFilter.filter` down into `get_current_state_ids`?

Possibly it may not be (if not every caller does that for some reason).

(N.B. you don't have to â merely a suggestion if it's an easy improvement whilst in the area)

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @DMRobertson **[DMRobertson](/DMRobertson)** [Dec 12, 2022](#discussion_r1046388050)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I considered it, but I'm pretty scared of the StateFilter machinery. I'll have a quick look at the call sites tomorrow

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @DMRobertson **[DMRobertson](/DMRobertson)** [Dec 13, 2022](#discussion_r1046557892)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Quick search for call sites that provide a state filter:

[synapse/synapse/handlers/federation\_event.py](https://github.com/matrix-org/synapse/blob/b5b5f6608462a988b05502a3b70b6a57ca3846d2/synapse/handlers/federation_event.py#L1986-L1990)

Lines 1986 to 1990
in
[b5b5f66](/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2)

|  | current\_state\_ids = ( |
| --- | --- |
|  | await self.\_state\_storage\_controller.get\_current\_state\_ids( |
|  | event.room\_id, StateFilter.from\_types(auth\_types) |
|  | ) |
|  | ) |

[synapse/synapse/handlers/message.py](https://github.com/matrix-org/synapse/blob/b5b5f6608462a988b05502a3b70b6a57ca3846d2/synapse/handlers/message.py#L232-L235)

Lines 232 to 235
in
[b5b5f66](/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2)

|  | state\_ids = await self.\_state\_storage\_controller.get\_current\_state\_ids( |
| --- | --- |
|  | room\_id, state\_filter=state\_filter |
|  | ) |
|  | room\_state = await self.store.get\_events(state\_ids.values()) |

[synapse/synapse/handlers/register.py](https://github.com/matrix-org/synapse/blob/b5b5f6608462a988b05502a3b70b6a57ca3846d2/synapse/handlers/register.py#L541-L543)

Lines 541 to 543
in
[b5b5f66](/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2)

|  | state = await self.\_storage\_controllers.state.get\_current\_state\_ids( |
| --- | --- |
|  | room\_id, StateFilter.from\_types([(EventTypes.JoinRules, "")]) |
|  | ) |

[synapse/synapse/handlers/room.py](https://github.com/matrix-org/synapse/blob/b5b5f6608462a988b05502a3b70b6a57ca3846d2/synapse/handlers/room.py#L306)

Line 306
in
[b5b5f66](/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2)

|  | old\_room\_state = await tombstone\_context.get\_current\_state\_ids(state\_filter) |
| --- | --- |

[synapse/synapse/handlers/room.py](https://github.com/matrix-org/synapse/blob/b5b5f6608462a988b05502a3b70b6a57ca3846d2/synapse/handlers/room.py#L484-L490)

Lines 484 to 490
in
[b5b5f66](/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2)

|  | old\_room\_state\_ids = ( |
| --- | --- |
|  | await self.\_storage\_controllers.state.get\_current\_state\_ids( |
|  | old\_room\_id, StateFilter.from\_types(types\_to\_copy) |
|  | ) |
|  | ) |
|  | # map from event\_id to BaseEvent |
|  | old\_room\_state\_events = await self.store.get\_events(old\_room\_state\_ids.values()) |

[synapse/synapse/handlers/room.py](https://github.com/matrix-org/synapse/blob/b5b5f6608462a988b05502a3b70b6a57ca3846d2/synapse/handlers/room.py#L562-L567)

Lines 562 to 567
in
[b5b5f66](/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2)

|  | # Transfer membership events |
| --- | --- |
|  | old\_room\_member\_state\_ids = ( |
|  | await self.\_storage\_controllers.state.get\_current\_state\_ids( |
|  | old\_room\_id, StateFilter.from\_types([(EventTypes.Member, None)]) |
|  | ) |
|  | ) |

There are more. I couldn't see anywhere that does anything like this.

But I also noticed this comment:

[synapse/synapse/storage/controllers/state.py](https://github.com/matrix-org/synapse/blob/b5b5f6608462a988b05502a3b70b6a57ca3846d2/synapse/storage/controllers/state.py#L405-L417)

Lines 405 to 417
in
[b5b5f66](/matrix-org/synapse/commit/b5b5f6608462a988b05502a3b70b6a57ca3846d2)

|  | @cancellable |
| --- | --- |
|  | async def get\_current\_state\_ids( |
|  | self, |
|  | room\_id: str, |
|  | state\_filter: Optional[StateFilter] = None, |
|  | await\_full\_state: bool = True, |
|  | on\_invalidate: Optional[Callable[[], None]] = None, |
|  | ) -> StateMap[str]: |
|  | """Get the current state event ids for a room based on the |
|  | current\_state\_events table. |
|  |  |
|  | If a state filter is given (that is not `StateFilter.all()`) the query |
|  | result is \*not\* cached. |

so maybe using a StateFilter is counterproductive if it bypasses caching? (I guess it depends on how likely it is that the room's current state exists in memory, how much effort a filter saves when making the db query etc)

Anyway I think this is one to leave for a rainy day!

Sorry, something went wrong.

All reactions

[![reivilibre](https://avatars.githubusercontent.com/u/38398653?s=60&v=4)](/reivilibre)

**[reivilibre](/reivilibre)**
approved these changes
[Dec 12, 2022](#pullrequestreview-1214303512)

 [View reviewed changes](/matrix-org/synapse/pull/14642/files/23ca964eeec3c579aa572e9d9f291fd7617a0508)

Copy link

Contributor

### @reivilibre **[reivilibre](/reivilibre)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

(I pressed ctrl+enter rather than approve)

Sorry, something went wrong.

All reactions

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
merged commit [`e2a1adb`](/matrix-org/synapse/commit/e2a1adbf5d11288f2134ced1f84c6ffdd91a9357)
into
develop

[Dec 13, 2022](https://github.com/matrix-org/synapse/pull/14642#event-8020339842)

 [![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
deleted the
dmr/more-specific-prejoin-state

branch
[December 13, 2022 00:54](#event-8020339945)

[squahtx](/squahtx)
pushed a commit
that referenced
this pull request
[Dec 13, 2022](#ref-commit-5025dbf)

`[Merge tag 'v1.74.0rc1' into develop](/matrix-org/synapse/commit/5025dbf7a25a85d64513e7fb8cb7ab0bd465298d "Merge tag 'v1.74.0rc1' into develop

Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\#14464](https://github.com/matrix-org/synapse/issues/14464))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\#14490](https://github.com/matrix-org/synapse/issues/14490), [\#14525](https://github.com/matrix-org/synapse/issues/14525))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\#14551](https://github.com/matrix-org/synapse/issues/14551), [\#14619](https://github.com/matrix-org/synapse/issues/14619))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\#14576](https://github.com/matrix-org/synapse/issues/14576))
- Improve opentracing and logging for to-device message handling. ([\#14598](https://github.com/matrix-org/synapse/issues/14598))
- Allow selecting \"prejoin\" events by state keys in addition to event types. ([\#14642](https://github.com/matrix-org/synapse/issues/14642))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\#14435](https://github.com/matrix-org/synapse/issues/14435), [\#14592](https://github.com/matrix-org/synapse/issues/14592), [\#14604](https://github.com/matrix-org/synapse/issues/14604))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\#14600](https://github.com/matrix-org/synapse/issues/14600))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\#14620](https://github.com/matrix-org/synapse/issues/14620), [\#14621](https://github.com/matrix-org/synapse/issues/14621))
- Update html templates to load images over HTTPS. Contributed by @ashfame. ([\#14625](https://github.com/matrix-org/synapse/issues/14625))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\#14631](https://github.com/matrix-org/synapse/issues/14631))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper (@fizzadar). ([\#14632](https://github.com/matrix-org/synapse/issues/14632))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\#14637](https://github.com/matrix-org/synapse/issues/14637))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\#14639](https://github.com/matrix-org/synapse/issues/14639), [\#14643](https://github.com/matrix-org/synapse/issues/14643))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\#14650](https://github.com/matrix-org/synapse/issues/14650))
- Improve validation of field size limits in events. ([\#14664](https://github.com/matrix-org/synapse/issues/14664))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\#14670](https://github.com/matrix-org/synapse/issues/14670))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\#14493](https://github.com/matrix-org/synapse/issues/14493))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\#14517](https://github.com/matrix-org/synapse/issues/14517))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html). ([\#14590](https://github.com/matrix-org/synapse/issues/14590))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\#14594](https://github.com/matrix-org/synapse/issues/14594))
- Change `turn_allow_guests` example value to lowercase `true`. ([\#14634](https://github.com/matrix-org/synapse/issues/14634))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper (@fizzadar). ([\#14255](https://github.com/matrix-org/synapse/issues/14255))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\#14473](https://github.com/matrix-org/synapse/issues/14473), [\#14474](https://github.com/matrix-org/synapse/issues/14474))
- Share the `ClientRestResource` for both workers and the main process. ([\#14528](https://github.com/matrix-org/synapse/issues/14528))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\#14548](https://github.com/matrix-org/synapse/issues/14548))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\#14549](https://github.com/matrix-org/synapse/issues/14549))
- Modernize unit tests configuration related to workers. ([\#14568](https://github.com/matrix-org/synapse/issues/14568))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\#14591](https://github.com/matrix-org/synapse/issues/14591))
- Fix Rust lint CI. ([\#14602](https://github.com/matrix-org/synapse/issues/14602))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\#14607](https://github.com/matrix-org/synapse/issues/14607))
- Alter some unit test environment parameters to decrease time spent running tests. ([\#14610](https://github.com/matrix-org/synapse/issues/14610))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\#14611](https://github.com/matrix-org/synapse/issues/14611))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\#14612](https://github.com/matrix-org/synapse/issues/14612))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\#14613](https://github.com/matrix-org/synapse/issues/14613))
- Bump twine from 4.0.1 to 4.0.2. ([\#14614](https://github.com/matrix-org/synapse/issues/14614))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\#14615](https://github.com/matrix-org/synapse/issues/14615))
- Bump cryptography from 38.0.3 to 38.0.4. ([\#14616](https://github.com/matrix-org/synapse/issues/14616))
- Remove useless cargo install with apt from Dockerfile. ([\#14636](https://github.com/matrix-org/synapse/issues/14636))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\#14645](https://github.com/matrix-org/synapse/issues/14645))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\#14656](https://github.com/matrix-org/synapse/issues/14656))
- Bump packaging from 21.3 to 22.0. ([\#14657](https://github.com/matrix-org/synapse/issues/14657))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\#14658](https://github.com/matrix-org/synapse/issues/14658))
- Bump serde from 1.0.148 to 1.0.150. ([\#14659](https://github.com/matrix-org/synapse/issues/14659))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\#14660](https://github.com/matrix-org/synapse/issues/14660))
- Bump authlib from 1.1.0 to 1.2.0. ([\#14661](https://github.com/matrix-org/synapse/issues/14661))
- Move `StateFilter` to `synapse.types`. ([\#14668](https://github.com/matrix-org/synapse/issues/14668))
- Improve type hints. ([\#14597](https://github.com/matrix-org/synapse/issues/14597), [\#14646](https://github.com/matrix-org/synapse/issues/14646), [\#14671](https://github.com/matrix-org/synapse/issues/14671))")`
â¦

`[5025dbf](/matrix-org/synapse/commit/5025dbf7a25a85d64513e7fb8cb7ab0bd465298d)`

```
Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\[#14464](https://github.com/matrix-org/synapse/pull/14464)]([#14464](https://github.com/matrix-org/synapse/pull/14464)))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\[#14490](https://github.com/matrix-org/synapse/pull/14490)]([#14490](https://github.com/matrix-org/synapse/pull/14490)), [\[#14525](https://github.com/matrix-org/synapse/pull/14525)]([#14525](https://github.com/matrix-org/synapse/pull/14525)))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\[#14551](https://github.com/matrix-org/synapse/pull/14551)]([#14551](https://github.com/matrix-org/synapse/pull/14551)), [\[#14619](https://github.com/matrix-org/synapse/pull/14619)]([#14619](https://github.com/matrix-org/synapse/pull/14619)))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\[#14576](https://github.com/matrix-org/synapse/pull/14576)]([#14576](https://github.com/matrix-org/synapse/pull/14576)))
- Improve opentracing and logging for to-device message handling. ([\[#14598](https://github.com/matrix-org/synapse/pull/14598)]([#14598](https://github.com/matrix-org/synapse/pull/14598)))
- Allow selecting "prejoin" events by state keys in addition to event types. ([\[#14642](https://github.com/matrix-org/synapse/pull/14642)]([#14642](https://github.com/matrix-org/synapse/pull/14642)))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\[#14435](https://github.com/matrix-org/synapse/pull/14435)]([#14435](https://github.com/matrix-org/synapse/pull/14435)), [\[#14592](https://github.com/matrix-org/synapse/pull/14592)]([#14592](https://github.com/matrix-org/synapse/pull/14592)), [\[#14604](https://github.com/matrix-org/synapse/pull/14604)]([#14604](https://github.com/matrix-org/synapse/pull/14604)))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\[#14600](https://github.com/matrix-org/synapse/pull/14600)]([#14600](https://github.com/matrix-org/synapse/pull/14600)))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\[#14620](https://github.com/matrix-org/synapse/pull/14620)]([#14620](https://github.com/matrix-org/synapse/pull/14620)), [\[#14621](https://github.com/matrix-org/synapse/pull/14621)]([#14621](https://github.com/matrix-org/synapse/pull/14621)))
- Update html templates to load images over HTTPS. Contributed by [@ashfame](https://github.com/ashfame). ([\[#14625](https://github.com/matrix-org/synapse/pull/14625)]([#14625](https://github.com/matrix-org/synapse/pull/14625)))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\[#14631](https://github.com/matrix-org/synapse/pull/14631)]([#14631](https://github.com/matrix-org/synapse/pull/14631)))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[#14632](https://github.com/matrix-org/synapse/pull/14632)]([#14632](https://github.com/matrix-org/synapse/pull/14632)))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\[#14637](https://github.com/matrix-org/synapse/pull/14637)]([#14637](https://github.com/matrix-org/synapse/pull/14637)))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\[#14639](https://github.com/matrix-org/synapse/pull/14639)]([#14639](https://github.com/matrix-org/synapse/pull/14639)), [\[#14643](https://github.com/matrix-org/synapse/pull/14643)]([#14643](https://github.com/matrix-org/synapse/pull/14643)))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\[#14650](https://github.com/matrix-org/synapse/pull/14650)]([#14650](https://github.com/matrix-org/synapse/pull/14650)))
- Improve validation of field size limits in events. ([\[#14664](https://github.com/matrix-org/synapse/pull/14664)]([#14664](https://github.com/matrix-org/synapse/pull/14664)))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\[#14670](https://github.com/matrix-org/synapse/pull/14670)]([#14670](https://github.com/matrix-org/synapse/pull/14670)))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\[#14493](https://github.com/matrix-org/synapse/pull/14493)]([#14493](https://github.com/matrix-org/synapse/pull/14493)))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\[#14517](https://github.com/matrix-org/synapse/pull/14517)]([#14517](https://github.com/matrix-org/synapse/pull/14517)))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](<https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html>). ([\[#14590](https://github.com/matrix-org/synapse/pull/14590)]([#14590](https://github.com/matrix-org/synapse/pull/14590)))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\[#14594](https://github.com/matrix-org/synapse/pull/14594)]([#14594](https://github.com/matrix-org/synapse/pull/14594)))
- Change `turn_allow_guests` example value to lowercase `true`. ([\[#14634](https://github.com/matrix-org/synapse/pull/14634)]([#14634](https://github.com/matrix-org/synapse/pull/14634)))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[#14255](https://github.com/matrix-org/synapse/pull/14255)]([#14255](https://github.com/matrix-org/synapse/pull/14255)))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\[#14473](https://github.com/matrix-org/synapse/pull/14473)]([#14473](https://github.com/matrix-org/synapse/pull/14473)), [\[#14474](https://github.com/matrix-org/synapse/pull/14474)]([#14474](https://github.com/matrix-org/synapse/pull/14474)))
- Share the `ClientRestResource` for both workers and the main process. ([\[#14528](https://github.com/matrix-org/synapse/pull/14528)]([#14528](https://github.com/matrix-org/synapse/pull/14528)))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\[#14548](https://github.com/matrix-org/synapse/pull/14548)]([#14548](https://github.com/matrix-org/synapse/pull/14548)))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\[#14549](https://github.com/matrix-org/synapse/pull/14549)]([#14549](https://github.com/matrix-org/synapse/pull/14549)))
- Modernize unit tests configuration related to workers. ([\[#14568](https://github.com/matrix-org/synapse/pull/14568)]([#14568](https://github.com/matrix-org/synapse/pull/14568)))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\[#14591](https://github.com/matrix-org/synapse/pull/14591)]([#14591](https://github.com/matrix-org/synapse/pull/14591)))
- Fix Rust lint CI. ([\[#14602](https://github.com/matrix-org/synapse/pull/14602)]([#14602](https://github.com/matrix-org/synapse/pull/14602)))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\[#14607](https://github.com/matrix-org/synapse/pull/14607)]([#14607](https://github.com/matrix-org/synapse/pull/14607)))
- Alter some unit test environment parameters to decrease time spent running tests. ([\[#14610](https://github.com/matrix-org/synapse/pull/14610)]([#14610](https://github.com/matrix-org/synapse/pull/14610)))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\[#14611](https://github.com/matrix-org/synapse/pull/14611)]([#14611](https://github.com/matrix-org/synapse/pull/14611)))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\[#14612](https://github.com/matrix-org/synapse/pull/14612)]([#14612](https://github.com/matrix-org/synapse/pull/14612)))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\[#14613](https://github.com/matrix-org/synapse/pull/14613)]([#14613](https://github.com/matrix-org/synapse/pull/14613)))
- Bump twine from 4.0.1 to 4.0.2. ([\[#14614](https://github.com/matrix-org/synapse/pull/14614)]([#14614](https://github.com/matrix-org/synapse/pull/14614)))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\[#14615](https://github.com/matrix-org/synapse/pull/14615)]([#14615](https://github.com/matrix-org/synapse/pull/14615)))
- Bump cryptography from 38.0.3 to 38.0.4. ([\[#14616](https://github.com/matrix-org/synapse/pull/14616)]([#14616](https://github.com/matrix-org/synapse/pull/14616)))
- Remove useless cargo install with apt from Dockerfile. ([\[#14636](https://github.com/matrix-org/synapse/pull/14636)]([#14636](https://github.com/matrix-org/synapse/pull/14636)))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\[#14645](https://github.com/matrix-org/synapse/pull/14645)]([#14645](https://github.com/matrix-org/synapse/pull/14645)))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\[#14656](https://github.com/matrix-org/synapse/pull/14656)]([#14656](https://github.com/matrix-org/synapse/pull/14656)))
- Bump packaging from 21.3 to 22.0. ([\[#14657](https://github.com/matrix-org/synapse/pull/14657)]([#14657](https://github.com/matrix-org/synapse/pull/14657)))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\[#14658](https://github.com/matrix-org/synapse/pull/14658)]([#14658](https://github.com/matrix-org/synapse/pull/14658)))
- Bump serde from 1.0.148 to 1.0.150. ([\[#14659](https://github.com/matrix-org/synapse/pull/14659)]([#14659](https://github.com/matrix-org/synapse/pull/14659)))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\[#14660](https://github.com/matrix-org/synapse/pull/14660)]([#14660](https://github.com/matrix-org/synapse/pull/14660)))
- Bump authlib from 1.1.0 to 1.2.0. ([\[#14661](https://github.com/matrix-org/synapse/pull/14661)]([#14661](https://github.com/matrix-org/synapse/pull/14661)))
- Move `StateFilter` to `synapse.types`. ([\[#14668](https://github.com/matrix-org/synapse/pull/14668)]([#14668](https://github.com/matrix-org/synapse/pull/14668)))
- Improve type hints. ([\[#14597](https://github.com/matrix-org/synapse/pull/14597)]([#14597](https://github.com/matrix-org/synapse/pull/14597)), [\[#14646](https://github.com/matrix-org/synapse/pull/14646)]([#14646](https://github.com/matrix-org/synapse/pull/14646)), [\[#14671](https://github.com/matrix-org/synapse/pull/14671)]([#14671](https://github.com/matrix-org/synapse/pull/14671)))
```

[reivilibre](/reivilibre)
added a commit
that referenced
this pull request
[Dec 14, 2022](#ref-commit-bbd5923)
[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&u=2ce5847d4197ee2d6e6528b9ac656470606c05cd&v=4)](/reivilibre)

`[Merge tag 'v1.74.0rc1' into rei/uvloop](/matrix-org/synapse/commit/bbd59237fcaec9c3cc3a6d98d06012d19f26ef41 "Merge tag 'v1.74.0rc1' into rei/uvloop

Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\#14464](https://github.com/matrix-org/synapse/issues/14464))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\#14490](https://github.com/matrix-org/synapse/issues/14490), [\#14525](https://github.com/matrix-org/synapse/issues/14525))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\#14551](https://github.com/matrix-org/synapse/issues/14551), [\#14619](https://github.com/matrix-org/synapse/issues/14619))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\#14576](https://github.com/matrix-org/synapse/issues/14576))
- Improve opentracing and logging for to-device message handling. ([\#14598](https://github.com/matrix-org/synapse/issues/14598))
- Allow selecting \"prejoin\" events by state keys in addition to event types. ([\#14642](https://github.com/matrix-org/synapse/issues/14642))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\#14435](https://github.com/matrix-org/synapse/issues/14435), [\#14592](https://github.com/matrix-org/synapse/issues/14592), [\#14604](https://github.com/matrix-org/synapse/issues/14604))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\#14600](https://github.com/matrix-org/synapse/issues/14600))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\#14620](https://github.com/matrix-org/synapse/issues/14620), [\#14621](https://github.com/matrix-org/synapse/issues/14621))
- Update html templates to load images over HTTPS. Contributed by @ashfame. ([\#14625](https://github.com/matrix-org/synapse/issues/14625))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\#14631](https://github.com/matrix-org/synapse/issues/14631))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper (@fizzadar). ([\#14632](https://github.com/matrix-org/synapse/issues/14632))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\#14637](https://github.com/matrix-org/synapse/issues/14637))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\#14639](https://github.com/matrix-org/synapse/issues/14639), [\#14643](https://github.com/matrix-org/synapse/issues/14643))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\#14650](https://github.com/matrix-org/synapse/issues/14650))
- Improve validation of field size limits in events. ([\#14664](https://github.com/matrix-org/synapse/issues/14664))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\#14670](https://github.com/matrix-org/synapse/issues/14670))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\#14493](https://github.com/matrix-org/synapse/issues/14493))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\#14517](https://github.com/matrix-org/synapse/issues/14517))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html). ([\#14590](https://github.com/matrix-org/synapse/issues/14590))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\#14594](https://github.com/matrix-org/synapse/issues/14594))
- Change `turn_allow_guests` example value to lowercase `true`. ([\#14634](https://github.com/matrix-org/synapse/issues/14634))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper (@fizzadar). ([\#14255](https://github.com/matrix-org/synapse/issues/14255))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\#14473](https://github.com/matrix-org/synapse/issues/14473), [\#14474](https://github.com/matrix-org/synapse/issues/14474))
- Share the `ClientRestResource` for both workers and the main process. ([\#14528](https://github.com/matrix-org/synapse/issues/14528))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\#14548](https://github.com/matrix-org/synapse/issues/14548))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\#14549](https://github.com/matrix-org/synapse/issues/14549))
- Modernize unit tests configuration related to workers. ([\#14568](https://github.com/matrix-org/synapse/issues/14568))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\#14591](https://github.com/matrix-org/synapse/issues/14591))
- Fix Rust lint CI. ([\#14602](https://github.com/matrix-org/synapse/issues/14602))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\#14607](https://github.com/matrix-org/synapse/issues/14607))
- Alter some unit test environment parameters to decrease time spent running tests. ([\#14610](https://github.com/matrix-org/synapse/issues/14610))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\#14611](https://github.com/matrix-org/synapse/issues/14611))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\#14612](https://github.com/matrix-org/synapse/issues/14612))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\#14613](https://github.com/matrix-org/synapse/issues/14613))
- Bump twine from 4.0.1 to 4.0.2. ([\#14614](https://github.com/matrix-org/synapse/issues/14614))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\#14615](https://github.com/matrix-org/synapse/issues/14615))
- Bump cryptography from 38.0.3 to 38.0.4. ([\#14616](https://github.com/matrix-org/synapse/issues/14616))
- Remove useless cargo install with apt from Dockerfile. ([\#14636](https://github.com/matrix-org/synapse/issues/14636))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\#14645](https://github.com/matrix-org/synapse/issues/14645))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\#14656](https://github.com/matrix-org/synapse/issues/14656))
- Bump packaging from 21.3 to 22.0. ([\#14657](https://github.com/matrix-org/synapse/issues/14657))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\#14658](https://github.com/matrix-org/synapse/issues/14658))
- Bump serde from 1.0.148 to 1.0.150. ([\#14659](https://github.com/matrix-org/synapse/issues/14659))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\#14660](https://github.com/matrix-org/synapse/issues/14660))
- Bump authlib from 1.1.0 to 1.2.0. ([\#14661](https://github.com/matrix-org/synapse/issues/14661))
- Move `StateFilter` to `synapse.types`. ([\#14668](https://github.com/matrix-org/synapse/issues/14668))
- Improve type hints. ([\#14597](https://github.com/matrix-org/synapse/issues/14597), [\#14646](https://github.com/matrix-org/synapse/issues/14646), [\#14671](https://github.com/matrix-org/synapse/issues/14671))")`
â¦

`[bbd5923](/matrix-org/synapse/commit/bbd59237fcaec9c3cc3a6d98d06012d19f26ef41)`

```
Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\[#14464](https://github.com/matrix-org/synapse/pull/14464)]([#14464](https://github.com/matrix-org/synapse/pull/14464)))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\[#14490](https://github.com/matrix-org/synapse/pull/14490)]([#14490](https://github.com/matrix-org/synapse/pull/14490)), [\[#14525](https://github.com/matrix-org/synapse/pull/14525)]([#14525](https://github.com/matrix-org/synapse/pull/14525)))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\[#14551](https://github.com/matrix-org/synapse/pull/14551)]([#14551](https://github.com/matrix-org/synapse/pull/14551)), [\[#14619](https://github.com/matrix-org/synapse/pull/14619)]([#14619](https://github.com/matrix-org/synapse/pull/14619)))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\[#14576](https://github.com/matrix-org/synapse/pull/14576)]([#14576](https://github.com/matrix-org/synapse/pull/14576)))
- Improve opentracing and logging for to-device message handling. ([\[#14598](https://github.com/matrix-org/synapse/pull/14598)]([#14598](https://github.com/matrix-org/synapse/pull/14598)))
- Allow selecting "prejoin" events by state keys in addition to event types. ([\[#14642](https://github.com/matrix-org/synapse/pull/14642)]([#14642](https://github.com/matrix-org/synapse/pull/14642)))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\[#14435](https://github.com/matrix-org/synapse/pull/14435)]([#14435](https://github.com/matrix-org/synapse/pull/14435)), [\[#14592](https://github.com/matrix-org/synapse/pull/14592)]([#14592](https://github.com/matrix-org/synapse/pull/14592)), [\[#14604](https://github.com/matrix-org/synapse/pull/14604)]([#14604](https://github.com/matrix-org/synapse/pull/14604)))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\[#14600](https://github.com/matrix-org/synapse/pull/14600)]([#14600](https://github.com/matrix-org/synapse/pull/14600)))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\[#14620](https://github.com/matrix-org/synapse/pull/14620)]([#14620](https://github.com/matrix-org/synapse/pull/14620)), [\[#14621](https://github.com/matrix-org/synapse/pull/14621)]([#14621](https://github.com/matrix-org/synapse/pull/14621)))
- Update html templates to load images over HTTPS. Contributed by [@ashfame](https://github.com/ashfame). ([\[#14625](https://github.com/matrix-org/synapse/pull/14625)]([#14625](https://github.com/matrix-org/synapse/pull/14625)))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\[#14631](https://github.com/matrix-org/synapse/pull/14631)]([#14631](https://github.com/matrix-org/synapse/pull/14631)))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[#14632](https://github.com/matrix-org/synapse/pull/14632)]([#14632](https://github.com/matrix-org/synapse/pull/14632)))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\[#14637](https://github.com/matrix-org/synapse/pull/14637)]([#14637](https://github.com/matrix-org/synapse/pull/14637)))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\[#14639](https://github.com/matrix-org/synapse/pull/14639)]([#14639](https://github.com/matrix-org/synapse/pull/14639)), [\[#14643](https://github.com/matrix-org/synapse/pull/14643)]([#14643](https://github.com/matrix-org/synapse/pull/14643)))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\[#14650](https://github.com/matrix-org/synapse/pull/14650)]([#14650](https://github.com/matrix-org/synapse/pull/14650)))
- Improve validation of field size limits in events. ([\[#14664](https://github.com/matrix-org/synapse/pull/14664)]([#14664](https://github.com/matrix-org/synapse/pull/14664)))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\[#14670](https://github.com/matrix-org/synapse/pull/14670)]([#14670](https://github.com/matrix-org/synapse/pull/14670)))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\[#14493](https://github.com/matrix-org/synapse/pull/14493)]([#14493](https://github.com/matrix-org/synapse/pull/14493)))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\[#14517](https://github.com/matrix-org/synapse/pull/14517)]([#14517](https://github.com/matrix-org/synapse/pull/14517)))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](<https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html>). ([\[#14590](https://github.com/matrix-org/synapse/pull/14590)]([#14590](https://github.com/matrix-org/synapse/pull/14590)))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\[#14594](https://github.com/matrix-org/synapse/pull/14594)]([#14594](https://github.com/matrix-org/synapse/pull/14594)))
- Change `turn_allow_guests` example value to lowercase `true`. ([\[#14634](https://github.com/matrix-org/synapse/pull/14634)]([#14634](https://github.com/matrix-org/synapse/pull/14634)))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[#14255](https://github.com/matrix-org/synapse/pull/14255)]([#14255](https://github.com/matrix-org/synapse/pull/14255)))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\[#14473](https://github.com/matrix-org/synapse/pull/14473)]([#14473](https://github.com/matrix-org/synapse/pull/14473)), [\[#14474](https://github.com/matrix-org/synapse/pull/14474)]([#14474](https://github.com/matrix-org/synapse/pull/14474)))
- Share the `ClientRestResource` for both workers and the main process. ([\[#14528](https://github.com/matrix-org/synapse/pull/14528)]([#14528](https://github.com/matrix-org/synapse/pull/14528)))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\[#14548](https://github.com/matrix-org/synapse/pull/14548)]([#14548](https://github.com/matrix-org/synapse/pull/14548)))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\[#14549](https://github.com/matrix-org/synapse/pull/14549)]([#14549](https://github.com/matrix-org/synapse/pull/14549)))
- Modernize unit tests configuration related to workers. ([\[#14568](https://github.com/matrix-org/synapse/pull/14568)]([#14568](https://github.com/matrix-org/synapse/pull/14568)))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\[#14591](https://github.com/matrix-org/synapse/pull/14591)]([#14591](https://github.com/matrix-org/synapse/pull/14591)))
- Fix Rust lint CI. ([\[#14602](https://github.com/matrix-org/synapse/pull/14602)]([#14602](https://github.com/matrix-org/synapse/pull/14602)))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\[#14607](https://github.com/matrix-org/synapse/pull/14607)]([#14607](https://github.com/matrix-org/synapse/pull/14607)))
- Alter some unit test environment parameters to decrease time spent running tests. ([\[#14610](https://github.com/matrix-org/synapse/pull/14610)]([#14610](https://github.com/matrix-org/synapse/pull/14610)))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\[#14611](https://github.com/matrix-org/synapse/pull/14611)]([#14611](https://github.com/matrix-org/synapse/pull/14611)))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\[#14612](https://github.com/matrix-org/synapse/pull/14612)]([#14612](https://github.com/matrix-org/synapse/pull/14612)))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\[#14613](https://github.com/matrix-org/synapse/pull/14613)]([#14613](https://github.com/matrix-org/synapse/pull/14613)))
- Bump twine from 4.0.1 to 4.0.2. ([\[#14614](https://github.com/matrix-org/synapse/pull/14614)]([#14614](https://github.com/matrix-org/synapse/pull/14614)))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\[#14615](https://github.com/matrix-org/synapse/pull/14615)]([#14615](https://github.com/matrix-org/synapse/pull/14615)))
- Bump cryptography from 38.0.3 to 38.0.4. ([\[#14616](https://github.com/matrix-org/synapse/pull/14616)]([#14616](https://github.com/matrix-org/synapse/pull/14616)))
- Remove useless cargo install with apt from Dockerfile. ([\[#14636](https://github.com/matrix-org/synapse/pull/14636)]([#14636](https://github.com/matrix-org/synapse/pull/14636)))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\[#14645](https://github.com/matrix-org/synapse/pull/14645)]([#14645](https://github.com/matrix-org/synapse/pull/14645)))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\[#14656](https://github.com/matrix-org/synapse/pull/14656)]([#14656](https://github.com/matrix-org/synapse/pull/14656)))
- Bump packaging from 21.3 to 22.0. ([\[#14657](https://github.com/matrix-org/synapse/pull/14657)]([#14657](https://github.com/matrix-org/synapse/pull/14657)))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\[#14658](https://github.com/matrix-org/synapse/pull/14658)]([#14658](https://github.com/matrix-org/synapse/pull/14658)))
- Bump serde from 1.0.148 to 1.0.150. ([\[#14659](https://github.com/matrix-org/synapse/pull/14659)]([#14659](https://github.com/matrix-org/synapse/pull/14659)))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\[#14660](https://github.com/matrix-org/synapse/pull/14660)]([#14660](https://github.com/matrix-org/synapse/pull/14660)))
- Bump authlib from 1.1.0 to 1.2.0. ([\[#14661](https://github.com/matrix-org/synapse/pull/14661)]([#14661](https://github.com/matrix-org/synapse/pull/14661)))
- Move `StateFilter` to `synapse.types`. ([\[#14668](https://github.com/matrix-org/synapse/pull/14668)]([#14668](https://github.com/matrix-org/synapse/pull/14668)))
- Improve type hints. ([\[#14597](https://github.com/matrix-org/synapse/pull/14597)]([#14597](https://github.com/matrix-org/synapse/pull/14597)), [\[#14646](https://github.com/matrix-org/synapse/pull/14646)]([#14646](https://github.com/matrix-org/synapse/pull/14646)), [\[#14671](https://github.com/matrix-org/synapse/pull/14671)]([#14671](https://github.com/matrix-org/synapse/pull/14671)))
```

[realtyem](/realtyem)
added a commit
to realtyem/synapse-unraid
that referenced
this pull request
[Dec 22, 2022](#ref-commit-f12683e)
[![@realtyem](https://avatars.githubusercontent.com/u/1582365?s=40&v=4)](/realtyem)

`[Merge tag 'v1.74.0' into unraid_develop](/realtyem/synapse-unraid/commit/f12683e83c43dffedad6446b5d066edae51a7ad7 "Merge tag 'v1.74.0' into unraid_develop

Synapse 1.74.0 (2022-12-20)
===========================

Improved Documentation
----------------------

- Add release note and update documentation regarding optional ICU support in user search. ([\#14712](https://github.com/matrix-org/synapse/issues/14712))

Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\#14464](https://github.com/matrix-org/synapse/issues/14464))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\#14490](https://github.com/matrix-org/synapse/issues/14490), [\#14525](https://github.com/matrix-org/synapse/issues/14525))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\#14551](https://github.com/matrix-org/synapse/issues/14551), [\#14619](https://github.com/matrix-org/synapse/issues/14619))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\#14576](https://github.com/matrix-org/synapse/issues/14576))
- Improve opentracing and logging for to-device message handling. ([\#14598](https://github.com/matrix-org/synapse/issues/14598))
- Allow selecting \"prejoin\" events by state keys in addition to event types. ([\#14642](https://github.com/matrix-org/synapse/issues/14642))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\#14435](https://github.com/matrix-org/synapse/issues/14435), [\#14592](https://github.com/matrix-org/synapse/issues/14592), [\#14604](https://github.com/matrix-org/synapse/issues/14604))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\#14600](https://github.com/matrix-org/synapse/issues/14600))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\#14620](https://github.com/matrix-org/synapse/issues/14620), [\#14621](https://github.com/matrix-org/synapse/issues/14621))
- Update html templates to load images over HTTPS. Contributed by @ashfame. ([\#14625](https://github.com/matrix-org/synapse/issues/14625))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\#14631](https://github.com/matrix-org/synapse/issues/14631))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper (@fizzadar). ([\#14632](https://github.com/matrix-org/synapse/issues/14632))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\#14637](https://github.com/matrix-org/synapse/issues/14637))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\#14639](https://github.com/matrix-org/synapse/issues/14639), [\#14643](https://github.com/matrix-org/synapse/issues/14643))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\#14650](https://github.com/matrix-org/synapse/issues/14650))
- Improve validation of field size limits in events. ([\#14664](https://github.com/matrix-org/synapse/issues/14664))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\#14670](https://github.com/matrix-org/synapse/issues/14670))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\#14493](https://github.com/matrix-org/synapse/issues/14493))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\#14517](https://github.com/matrix-org/synapse/issues/14517))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html). ([\#14590](https://github.com/matrix-org/synapse/issues/14590))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\#14594](https://github.com/matrix-org/synapse/issues/14594))
- Change `turn_allow_guests` example value to lowercase `true`. ([\#14634](https://github.com/matrix-org/synapse/issues/14634))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper (@fizzadar). ([\#14255](https://github.com/matrix-org/synapse/issues/14255))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\#14473](https://github.com/matrix-org/synapse/issues/14473), [\#14474](https://github.com/matrix-org/synapse/issues/14474))
- Share the `ClientRestResource` for both workers and the main process. ([\#14528](https://github.com/matrix-org/synapse/issues/14528))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\#14548](https://github.com/matrix-org/synapse/issues/14548))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\#14549](https://github.com/matrix-org/synapse/issues/14549))
- Modernize unit tests configuration related to workers. ([\#14568](https://github.com/matrix-org/synapse/issues/14568))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\#14591](https://github.com/matrix-org/synapse/issues/14591))
- Fix Rust lint CI. ([\#14602](https://github.com/matrix-org/synapse/issues/14602))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\#14607](https://github.com/matrix-org/synapse/issues/14607))
- Alter some unit test environment parameters to decrease time spent running tests. ([\#14610](https://github.com/matrix-org/synapse/issues/14610))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\#14611](https://github.com/matrix-org/synapse/issues/14611))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\#14612](https://github.com/matrix-org/synapse/issues/14612))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\#14613](https://github.com/matrix-org/synapse/issues/14613))
- Bump twine from 4.0.1 to 4.0.2. ([\#14614](https://github.com/matrix-org/synapse/issues/14614))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\#14615](https://github.com/matrix-org/synapse/issues/14615))
- Bump cryptography from 38.0.3 to 38.0.4. ([\#14616](https://github.com/matrix-org/synapse/issues/14616))
- Remove useless cargo install with apt from Dockerfile. ([\#14636](https://github.com/matrix-org/synapse/issues/14636))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\#14645](https://github.com/matrix-org/synapse/issues/14645))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\#14656](https://github.com/matrix-org/synapse/issues/14656))
- Bump packaging from 21.3 to 22.0. ([\#14657](https://github.com/matrix-org/synapse/issues/14657))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\#14658](https://github.com/matrix-org/synapse/issues/14658))
- Bump serde from 1.0.148 to 1.0.150. ([\#14659](https://github.com/matrix-org/synapse/issues/14659))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\#14660](https://github.com/matrix-org/synapse/issues/14660))
- Bump authlib from 1.1.0 to 1.2.0. ([\#14661](https://github.com/matrix-org/synapse/issues/14661))
- Move `StateFilter` to `synapse.types`. ([\#14668](https://github.com/matrix-org/synapse/issues/14668))
- Improve type hints. ([\#14597](https://github.com/matrix-org/synapse/issues/14597), [\#14646](https://github.com/matrix-org/synapse/issues/14646), [\#14671](https://github.com/matrix-org/synapse/issues/14671))")`
â¦

`[f12683e](/realtyem/synapse-unraid/commit/f12683e83c43dffedad6446b5d066edae51a7ad7)`

```
Synapse 1.74.0 (2022-12-20)
===========================

Improved Documentation
----------------------

- Add release note and update documentation regarding optional ICU support in user search. ([\#14712]([matrix-org/synapse#14712](https://github.com/matrix-org/synapse/pull/14712)))

Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\#14464]([matrix-org/synapse#14464](https://github.com/matrix-org/synapse/pull/14464)))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\#14490]([matrix-org/synapse#14490](https://github.com/matrix-org/synapse/pull/14490)), [\#14525]([matrix-org/synapse#14525](https://github.com/matrix-org/synapse/pull/14525)))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\#14551]([matrix-org/synapse#14551](https://github.com/matrix-org/synapse/pull/14551)), [\#14619]([matrix-org/synapse#14619](https://github.com/matrix-org/synapse/pull/14619)))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\#14576]([matrix-org/synapse#14576](https://github.com/matrix-org/synapse/pull/14576)))
- Improve opentracing and logging for to-device message handling. ([\#14598]([matrix-org/synapse#14598](https://github.com/matrix-org/synapse/pull/14598)))
- Allow selecting "prejoin" events by state keys in addition to event types. ([\#14642]([matrix-org/synapse#14642](https://github.com/matrix-org/synapse/pull/14642)))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\#14435]([matrix-org/synapse#14435](https://github.com/matrix-org/synapse/pull/14435)), [\#14592]([matrix-org/synapse#14592](https://github.com/matrix-org/synapse/pull/14592)), [\#14604]([matrix-org/synapse#14604](https://github.com/matrix-org/synapse/pull/14604)))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\#14600]([matrix-org/synapse#14600](https://github.com/matrix-org/synapse/pull/14600)))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\#14620]([matrix-org/synapse#14620](https://github.com/matrix-org/synapse/pull/14620)), [\#14621]([matrix-org/synapse#14621](https://github.com/matrix-org/synapse/pull/14621)))
- Update html templates to load images over HTTPS. Contributed by [@ashfame](https://github.com/ashfame). ([\#14625]([matrix-org/synapse#14625](https://github.com/matrix-org/synapse/pull/14625)))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\#14631]([matrix-org/synapse#14631](https://github.com/matrix-org/synapse/pull/14631)))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\#14632]([matrix-org/synapse#14632](https://github.com/matrix-org/synapse/pull/14632)))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\#14637]([matrix-org/synapse#14637](https://github.com/matrix-org/synapse/pull/14637)))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\#14639]([matrix-org/synapse#14639](https://github.com/matrix-org/synapse/pull/14639)), [\#14643]([matrix-org/synapse#14643](https://github.com/matrix-org/synapse/pull/14643)))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\#14650]([matrix-org/synapse#14650](https://github.com/matrix-org/synapse/pull/14650)))
- Improve validation of field size limits in events. ([\#14664]([matrix-org/synapse#14664](https://github.com/matrix-org/synapse/pull/14664)))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\#14670]([matrix-org/synapse#14670](https://github.com/matrix-org/synapse/pull/14670)))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\#14493]([matrix-org/synapse#14493](https://github.com/matrix-org/synapse/pull/14493)))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\#14517]([matrix-org/synapse#14517](https://github.com/matrix-org/synapse/pull/14517)))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](<https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html>). ([\#14590]([matrix-org/synapse#14590](https://github.com/matrix-org/synapse/pull/14590)))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\#14594]([matrix-org/synapse#14594](https://github.com/matrix-org/synapse/pull/14594)))
- Change `turn_allow_guests` example value to lowercase `true`. ([\#14634]([matrix-org/synapse#14634](https://github.com/matrix-org/synapse/pull/14634)))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\#14255]([matrix-org/synapse#14255](https://github.com/matrix-org/synapse/pull/14255)))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\#14473]([matrix-org/synapse#14473](https://github.com/matrix-org/synapse/pull/14473)), [\#14474]([matrix-org/synapse#14474](https://github.com/matrix-org/synapse/pull/14474)))
- Share the `ClientRestResource` for both workers and the main process. ([\#14528]([matrix-org/synapse#14528](https://github.com/matrix-org/synapse/pull/14528)))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\#14548]([matrix-org/synapse#14548](https://github.com/matrix-org/synapse/pull/14548)))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\#14549]([matrix-org/synapse#14549](https://github.com/matrix-org/synapse/pull/14549)))
- Modernize unit tests configuration related to workers. ([\#14568]([matrix-org/synapse#14568](https://github.com/matrix-org/synapse/pull/14568)))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\#14591]([matrix-org/synapse#14591](https://github.com/matrix-org/synapse/pull/14591)))
- Fix Rust lint CI. ([\#14602]([matrix-org/synapse#14602](https://github.com/matrix-org/synapse/pull/14602)))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\#14607]([matrix-org/synapse#14607](https://github.com/matrix-org/synapse/pull/14607)))
- Alter some unit test environment parameters to decrease time spent running tests. ([\#14610]([matrix-org/synapse#14610](https://github.com/matrix-org/synapse/pull/14610)))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\#14611]([matrix-org/synapse#14611](https://github.com/matrix-org/synapse/pull/14611)))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\#14612]([matrix-org/synapse#14612](https://github.com/matrix-org/synapse/pull/14612)))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\#14613]([matrix-org/synapse#14613](https://github.com/matrix-org/synapse/pull/14613)))
- Bump twine from 4.0.1 to 4.0.2. ([\#14614]([matrix-org/synapse#14614](https://github.com/matrix-org/synapse/pull/14614)))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\#14615]([matrix-org/synapse#14615](https://github.com/matrix-org/synapse/pull/14615)))
- Bump cryptography from 38.0.3 to 38.0.4. ([\#14616]([matrix-org/synapse#14616](https://github.com/matrix-org/synapse/pull/14616)))
- Remove useless cargo install with apt from Dockerfile. ([\#14636]([matrix-org/synapse#14636](https://github.com/matrix-org/synapse/pull/14636)))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\#14645]([matrix-org/synapse#14645](https://github.com/matrix-org/synapse/pull/14645)))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\#14656]([matrix-org/synapse#14656](https://github.com/matrix-org/synapse/pull/14656)))
- Bump packaging from 21.3 to 22.0. ([\#14657]([matrix-org/synapse#14657](https://github.com/matrix-org/synapse/pull/14657)))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\#14658]([matrix-org/synapse#14658](https://github.com/matrix-org/synapse/pull/14658)))
- Bump serde from 1.0.148 to 1.0.150. ([\#14659]([matrix-org/synapse#14659](https://github.com/matrix-org/synapse/pull/14659)))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\#14660]([matrix-org/synapse#14660](https://github.com/matrix-org/synapse/pull/14660)))
- Bump authlib from 1.1.0 to 1.2.0. ([\#14661]([matrix-org/synapse#14661](https://github.com/matrix-org/synapse/pull/14661)))
- Move `StateFilter` to `synapse.types`. ([\#14668]([matrix-org/synapse#14668](https://github.com/matrix-org/synapse/pull/14668)))
- Improve type hints. ([\#14597]([matrix-org/synapse#14597](https://github.com/matrix-org/synapse/pull/14597)), [\#14646]([matrix-org/synapse#14646](https://github.com/matrix-org/synapse/pull/14646)), [\#14671]([matrix-org/synapse#14671](https://github.com/matrix-org/synapse/pull/14671)))
```

[Fizzadar](/Fizzadar)
added a commit
to beeper/synapse-legacy-fork
that referenced
this pull request
[Jan 4, 2023](#ref-commit-c71b7e3)
[![@Fizzadar](https://avatars.githubusercontent.com/u/1026154?s=40&u=cf88c4d140704f56347ca70c0812610b99a3365b&v=4)](/Fizzadar)

`[Merge tag 'v1.74.0' into merge-1.74](/beeper/synapse-legacy-fork/commit/c71b7e371babd620631733d2bda3e13cdbb7edf4 "Merge tag 'v1.74.0' into merge-1.74

Synapse 1.74.0 (2022-12-20)
===========================

Improved Documentation
----------------------

- Add release note and update documentation regarding optional ICU support in user search. ([\#14712](https://github.com/matrix-org/synapse/issues/14712))

Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\#14464](https://github.com/matrix-org/synapse/issues/14464))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\#14490](https://github.com/matrix-org/synapse/issues/14490), [\#14525](https://github.com/matrix-org/synapse/issues/14525))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\#14551](https://github.com/matrix-org/synapse/issues/14551), [\#14619](https://github.com/matrix-org/synapse/issues/14619))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\#14576](https://github.com/matrix-org/synapse/issues/14576))
- Improve opentracing and logging for to-device message handling. ([\#14598](https://github.com/matrix-org/synapse/issues/14598))
- Allow selecting \"prejoin\" events by state keys in addition to event types. ([\#14642](https://github.com/matrix-org/synapse/issues/14642))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\#14435](https://github.com/matrix-org/synapse/issues/14435), [\#14592](https://github.com/matrix-org/synapse/issues/14592), [\#14604](https://github.com/matrix-org/synapse/issues/14604))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\#14600](https://github.com/matrix-org/synapse/issues/14600))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\#14620](https://github.com/matrix-org/synapse/issues/14620), [\#14621](https://github.com/matrix-org/synapse/issues/14621))
- Update html templates to load images over HTTPS. Contributed by @ashfame. ([\#14625](https://github.com/matrix-org/synapse/issues/14625))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\#14631](https://github.com/matrix-org/synapse/issues/14631))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper (@fizzadar). ([\#14632](https://github.com/matrix-org/synapse/issues/14632))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\#14637](https://github.com/matrix-org/synapse/issues/14637))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\#14639](https://github.com/matrix-org/synapse/issues/14639), [\#14643](https://github.com/matrix-org/synapse/issues/14643))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\#14650](https://github.com/matrix-org/synapse/issues/14650))
- Improve validation of field size limits in events. ([\#14664](https://github.com/matrix-org/synapse/issues/14664))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\#14670](https://github.com/matrix-org/synapse/issues/14670))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\#14493](https://github.com/matrix-org/synapse/issues/14493))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\#14517](https://github.com/matrix-org/synapse/issues/14517))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html). ([\#14590](https://github.com/matrix-org/synapse/issues/14590))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\#14594](https://github.com/matrix-org/synapse/issues/14594))
- Change `turn_allow_guests` example value to lowercase `true`. ([\#14634](https://github.com/matrix-org/synapse/issues/14634))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper (@fizzadar). ([\#14255](https://github.com/matrix-org/synapse/issues/14255))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\#14473](https://github.com/matrix-org/synapse/issues/14473), [\#14474](https://github.com/matrix-org/synapse/issues/14474))
- Share the `ClientRestResource` for both workers and the main process. ([\#14528](https://github.com/matrix-org/synapse/issues/14528))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\#14548](https://github.com/matrix-org/synapse/issues/14548))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\#14549](https://github.com/matrix-org/synapse/issues/14549))
- Modernize unit tests configuration related to workers. ([\#14568](https://github.com/matrix-org/synapse/issues/14568))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\#14591](https://github.com/matrix-org/synapse/issues/14591))
- Fix Rust lint CI. ([\#14602](https://github.com/matrix-org/synapse/issues/14602))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\#14607](https://github.com/matrix-org/synapse/issues/14607))
- Alter some unit test environment parameters to decrease time spent running tests. ([\#14610](https://github.com/matrix-org/synapse/issues/14610))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\#14611](https://github.com/matrix-org/synapse/issues/14611))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\#14612](https://github.com/matrix-org/synapse/issues/14612))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\#14613](https://github.com/matrix-org/synapse/issues/14613))
- Bump twine from 4.0.1 to 4.0.2. ([\#14614](https://github.com/matrix-org/synapse/issues/14614))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\#14615](https://github.com/matrix-org/synapse/issues/14615))
- Bump cryptography from 38.0.3 to 38.0.4. ([\#14616](https://github.com/matrix-org/synapse/issues/14616))
- Remove useless cargo install with apt from Dockerfile. ([\#14636](https://github.com/matrix-org/synapse/issues/14636))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\#14645](https://github.com/matrix-org/synapse/issues/14645))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\#14656](https://github.com/matrix-org/synapse/issues/14656))
- Bump packaging from 21.3 to 22.0. ([\#14657](https://github.com/matrix-org/synapse/issues/14657))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\#14658](https://github.com/matrix-org/synapse/issues/14658))
- Bump serde from 1.0.148 to 1.0.150. ([\#14659](https://github.com/matrix-org/synapse/issues/14659))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\#14660](https://github.com/matrix-org/synapse/issues/14660))
- Bump authlib from 1.1.0 to 1.2.0. ([\#14661](https://github.com/matrix-org/synapse/issues/14661))
- Move `StateFilter` to `synapse.types`. ([\#14668](https://github.com/matrix-org/synapse/issues/14668))
- Improve type hints. ([\#14597](https://github.com/matrix-org/synapse/issues/14597), [\#14646](https://github.com/matrix-org/synapse/issues/14646), [\#14671](https://github.com/matrix-org/synapse/issues/14671))")`
â¦

`[c71b7e3](/beeper/synapse-legacy-fork/commit/c71b7e371babd620631733d2bda3e13cdbb7edf4)`

```
Synapse 1.74.0 (2022-12-20)
===========================

Improved Documentation
----------------------

- Add release note and update documentation regarding optional ICU support in user search. ([\[matrix-org#14712](https://github.com/matrix-org/synapse/pull/14712)]([matrix-org#14712](https://github.com/matrix-org/synapse/pull/14712)))

Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\[matrix-org#14464](https://github.com/matrix-org/synapse/pull/14464)]([matrix-org#14464](https://github.com/matrix-org/synapse/pull/14464)))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\[matrix-org#14490](https://github.com/matrix-org/synapse/pull/14490)]([matrix-org#14490](https://github.com/matrix-org/synapse/pull/14490)), [\[matrix-org#14525](https://github.com/matrix-org/synapse/pull/14525)]([matrix-org#14525](https://github.com/matrix-org/synapse/pull/14525)))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\[matrix-org#14551](https://github.com/matrix-org/synapse/pull/14551)]([matrix-org#14551](https://github.com/matrix-org/synapse/pull/14551)), [\[matrix-org#14619](https://github.com/matrix-org/synapse/pull/14619)]([matrix-org#14619](https://github.com/matrix-org/synapse/pull/14619)))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\[matrix-org#14576](https://github.com/matrix-org/synapse/pull/14576)]([matrix-org#14576](https://github.com/matrix-org/synapse/pull/14576)))
- Improve opentracing and logging for to-device message handling. ([\[matrix-org#14598](https://github.com/matrix-org/synapse/pull/14598)]([matrix-org#14598](https://github.com/matrix-org/synapse/pull/14598)))
- Allow selecting "prejoin" events by state keys in addition to event types. ([\[matrix-org#14642](https://github.com/matrix-org/synapse/pull/14642)]([matrix-org#14642](https://github.com/matrix-org/synapse/pull/14642)))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\[matrix-org#14435](https://github.com/matrix-org/synapse/pull/14435)]([matrix-org#14435](https://github.com/matrix-org/synapse/pull/14435)), [\[matrix-org#14592](https://github.com/matrix-org/synapse/pull/14592)]([matrix-org#14592](https://github.com/matrix-org/synapse/pull/14592)), [\[matrix-org#14604](https://github.com/matrix-org/synapse/pull/14604)]([matrix-org#14604](https://github.com/matrix-org/synapse/pull/14604)))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\[matrix-org#14600](https://github.com/matrix-org/synapse/pull/14600)]([matrix-org#14600](https://github.com/matrix-org/synapse/pull/14600)))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\[matrix-org#14620](https://github.com/matrix-org/synapse/pull/14620)]([matrix-org#14620](https://github.com/matrix-org/synapse/pull/14620)), [\[matrix-org#14621](https://github.com/matrix-org/synapse/pull/14621)]([matrix-org#14621](https://github.com/matrix-org/synapse/pull/14621)))
- Update html templates to load images over HTTPS. Contributed by [@ashfame](https://github.com/ashfame). ([\[matrix-org#14625](https://github.com/matrix-org/synapse/pull/14625)]([matrix-org#14625](https://github.com/matrix-org/synapse/pull/14625)))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\[matrix-org#14631](https://github.com/matrix-org/synapse/pull/14631)]([matrix-org#14631](https://github.com/matrix-org/synapse/pull/14631)))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[matrix-org#14632](https://github.com/matrix-org/synapse/pull/14632)]([matrix-org#14632](https://github.com/matrix-org/synapse/pull/14632)))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\[matrix-org#14637](https://github.com/matrix-org/synapse/pull/14637)]([matrix-org#14637](https://github.com/matrix-org/synapse/pull/14637)))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\[matrix-org#14639](https://github.com/matrix-org/synapse/pull/14639)]([matrix-org#14639](https://github.com/matrix-org/synapse/pull/14639)), [\[matrix-org#14643](https://github.com/matrix-org/synapse/pull/14643)]([matrix-org#14643](https://github.com/matrix-org/synapse/pull/14643)))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\[matrix-org#14650](https://github.com/matrix-org/synapse/pull/14650)]([matrix-org#14650](https://github.com/matrix-org/synapse/pull/14650)))
- Improve validation of field size limits in events. ([\[matrix-org#14664](https://github.com/matrix-org/synapse/pull/14664)]([matrix-org#14664](https://github.com/matrix-org/synapse/pull/14664)))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\[matrix-org#14670](https://github.com/matrix-org/synapse/pull/14670)]([matrix-org#14670](https://github.com/matrix-org/synapse/pull/14670)))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\[matrix-org#14493](https://github.com/matrix-org/synapse/pull/14493)]([matrix-org#14493](https://github.com/matrix-org/synapse/pull/14493)))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\[matrix-org#14517](https://github.com/matrix-org/synapse/pull/14517)]([matrix-org#14517](https://github.com/matrix-org/synapse/pull/14517)))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](<https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html>). ([\[matrix-org#14590](https://github.com/matrix-org/synapse/pull/14590)]([matrix-org#14590](https://github.com/matrix-org/synapse/pull/14590)))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\[matrix-org#14594](https://github.com/matrix-org/synapse/pull/14594)]([matrix-org#14594](https://github.com/matrix-org/synapse/pull/14594)))
- Change `turn_allow_guests` example value to lowercase `true`. ([\[matrix-org#14634](https://github.com/matrix-org/synapse/pull/14634)]([matrix-org#14634](https://github.com/matrix-org/synapse/pull/14634)))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\[matrix-org#14255](https://github.com/matrix-org/synapse/pull/14255)]([matrix-org#14255](https://github.com/matrix-org/synapse/pull/14255)))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\[matrix-org#14473](https://github.com/matrix-org/synapse/pull/14473)]([matrix-org#14473](https://github.com/matrix-org/synapse/pull/14473)), [\[matrix-org#14474](https://github.com/matrix-org/synapse/pull/14474)]([matrix-org#14474](https://github.com/matrix-org/synapse/pull/14474)))
- Share the `ClientRestResource` for both workers and the main process. ([\[matrix-org#14528](https://github.com/matrix-org/synapse/pull/14528)]([matrix-org#14528](https://github.com/matrix-org/synapse/pull/14528)))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\[matrix-org#14548](https://github.com/matrix-org/synapse/pull/14548)]([matrix-org#14548](https://github.com/matrix-org/synapse/pull/14548)))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\[matrix-org#14549](https://github.com/matrix-org/synapse/pull/14549)]([matrix-org#14549](https://github.com/matrix-org/synapse/pull/14549)))
- Modernize unit tests configuration related to workers. ([\[matrix-org#14568](https://github.com/matrix-org/synapse/pull/14568)]([matrix-org#14568](https://github.com/matrix-org/synapse/pull/14568)))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\[matrix-org#14591](https://github.com/matrix-org/synapse/pull/14591)]([matrix-org#14591](https://github.com/matrix-org/synapse/pull/14591)))
- Fix Rust lint CI. ([\[matrix-org#14602](https://github.com/matrix-org/synapse/pull/14602)]([matrix-org#14602](https://github.com/matrix-org/synapse/pull/14602)))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\[matrix-org#14607](https://github.com/matrix-org/synapse/pull/14607)]([matrix-org#14607](https://github.com/matrix-org/synapse/pull/14607)))
- Alter some unit test environment parameters to decrease time spent running tests. ([\[matrix-org#14610](https://github.com/matrix-org/synapse/pull/14610)]([matrix-org#14610](https://github.com/matrix-org/synapse/pull/14610)))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\[matrix-org#14611](https://github.com/matrix-org/synapse/pull/14611)]([matrix-org#14611](https://github.com/matrix-org/synapse/pull/14611)))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\[matrix-org#14612](https://github.com/matrix-org/synapse/pull/14612)]([matrix-org#14612](https://github.com/matrix-org/synapse/pull/14612)))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\[matrix-org#14613](https://github.com/matrix-org/synapse/pull/14613)]([matrix-org#14613](https://github.com/matrix-org/synapse/pull/14613)))
- Bump twine from 4.0.1 to 4.0.2. ([\[matrix-org#14614](https://github.com/matrix-org/synapse/pull/14614)]([matrix-org#14614](https://github.com/matrix-org/synapse/pull/14614)))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\[matrix-org#14615](https://github.com/matrix-org/synapse/pull/14615)]([matrix-org#14615](https://github.com/matrix-org/synapse/pull/14615)))
- Bump cryptography from 38.0.3 to 38.0.4. ([\[matrix-org#14616](https://github.com/matrix-org/synapse/pull/14616)]([matrix-org#14616](https://github.com/matrix-org/synapse/pull/14616)))
- Remove useless cargo install with apt from Dockerfile. ([\[matrix-org#14636](https://github.com/matrix-org/synapse/pull/14636)]([matrix-org#14636](https://github.com/matrix-org/synapse/pull/14636)))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\[matrix-org#14645](https://github.com/matrix-org/synapse/pull/14645)]([matrix-org#14645](https://github.com/matrix-org/synapse/pull/14645)))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\[matrix-org#14656](https://github.com/matrix-org/synapse/pull/14656)]([matrix-org#14656](https://github.com/matrix-org/synapse/pull/14656)))
- Bump packaging from 21.3 to 22.0. ([\[matrix-org#14657](https://github.com/matrix-org/synapse/pull/14657)]([matrix-org#14657](https://github.com/matrix-org/synapse/pull/14657)))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\[matrix-org#14658](https://github.com/matrix-org/synapse/pull/14658)]([matrix-org#14658](https://github.com/matrix-org/synapse/pull/14658)))
- Bump serde from 1.0.148 to 1.0.150. ([\[matrix-org#14659](https://github.com/matrix-org/synapse/pull/14659)]([matrix-org#14659](https://github.com/matrix-org/synapse/pull/14659)))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\[matrix-org#14660](https://github.com/matrix-org/synapse/pull/14660)]([matrix-org#14660](https://github.com/matrix-org/synapse/pull/14660)))
- Bump authlib from 1.1.0 to 1.2.0. ([\[matrix-org#14661](https://github.com/matrix-org/synapse/pull/14661)]([matrix-org#14661](https://github.com/matrix-org/synapse/pull/14661)))
- Move `StateFilter` to `synapse.types`. ([\[matrix-org#14668](https://github.com/matrix-org/synapse/pull/14668)]([matrix-org#14668](https://github.com/matrix-org/synapse/pull/14668)))
- Improve type hints. ([\[matrix-org#14597](https://github.com/matrix-org/synapse/pull/14597)]([matrix-org#14597](https://github.com/matrix-org/synapse/pull/14597)), [\[matrix-org#14646](https://github.com/matrix-org/synapse/pull/14646)]([matrix-org#14646](https://github.com/matrix-org/synapse/pull/14646)), [\[matrix-org#14671](https://github.com/matrix-org/synapse/pull/14671)]([matrix-org#14671](https://github.com/matrix-org/synapse/pull/14671)))
```

[netbsd-srcmastr](/netbsd-srcmastr)
pushed a commit
to NetBSD/pkgsrc
that referenced
this pull request
[Feb 6, 2023](#ref-commit-75d0625)
[![@Midar](https://avatars.githubusercontent.com/u/752237?s=40&u=81dfb9be718247c7664693c556bf3fdfb6715545&v=4)](/Midar)

`[Update chat/matrix-synapse to 1.76.0](/NetBSD/pkgsrc/commit/75d0625dd885c47e1426522441f72a142c52365e "Update chat/matrix-synapse to 1.76.0

Synapse 1.76.0 (2023-01-31)
===========================

The 1.76 release is the first to enable faster joins ([MSC3706](https://github.com/matrix-org/matrix-spec-proposals/pull/3706) and [MSC3902](https://github.com/matrix-org/matrix-spec-proposals/pull/3902)) by default. Admins can opt-out: see [the upgrade notes](https://github.com/matrix-org/synapse/blob/release-v1.76/docs/upgrade.md#faster-joins-are-enabled-by-default) for more details.

The upgrade from 1.75 to 1.76 changes the account data replication streams in a backwards-incompatible manner. Server operators running a multi-worker deployment should consult [the upgrade notes](https://github.com/matrix-org/synapse/blob/release-v1.76/docs/upgrade.md#changes-to-the-account-data-replication-streams).

Those who are `poetry install`ing from source using our lockfile should ensure their poetry version is 1.3.2 or higher; [see upgrade notes](https://github.com/matrix-org/synapse/blob/release-v1.76/docs/upgrade.md#minimum-version-of-poetry-is-now-132).

Notes on faster joins
---------------------

The faster joins project sees the most benefit when joining a room with a large number of members (joined or historical). We expect it to be particularly useful for joining large public rooms like the [Matrix HQ](https://matrix.to/#/#matrix:matrix.org) or [Synapse Admins](https://matrix.to/#/#synapse:matrix.org) rooms.

After a faster join, Synapse considers that room \"partially joined\". In this state, you should be able to

- read incoming messages;
- see incoming state changes, e.g. room topic changes; and
- send messages, if the room is unencrypted.

Synapse has to spend more effort to complete the join in the background. Once this finishes, you will be able to

- send messages, if the room is in encrypted;
- retrieve room history from before your join, if permitted by the room settings; and
- access the full list of room members.

Improved Documentation
----------------------

- Describe the ideas and the internal machinery behind faster joins. ([\#14677](https://github.com/matrix-org/synapse/issues/14677))

Synapse 1.76.0rc2 (2023-01-27)
==============================

Bugfixes
--------

- Faster joins: Fix a bug introduced in Synapse 1.69 where device list EDUs could fail to be handled after a restart when a faster join sync is in progress. ([\#14914](https://github.com/matrix-org/synapse/issues/14914))

Internal Changes
----------------

- Faster joins: Improve performance of looking up partial-state status of rooms. ([\#14917](https://github.com/matrix-org/synapse/issues/14917))

Synapse 1.76.0rc1 (2023-01-25)
==============================

Features
--------

- Update the default room version to [v10](https://spec.matrix.org/v1.5/rooms/v10/) ([MSC 3904](https://github.com/matrix-org/matrix-spec-proposals/pull/3904)). Contributed by @FSG-Cat. ([\#14111](https://github.com/matrix-org/synapse/issues/14111))
- Add a `set_displayname()` method to the module API for setting a user's display name. ([\#14629](https://github.com/matrix-org/synapse/issues/14629))
- Add a dedicated listener configuration for `health` endpoint. ([\#14747](https://github.com/matrix-org/synapse/issues/14747))
- Implement support for [MSC3890](https://github.com/matrix-org/matrix-spec-proposals/pull/3890): Remotely silence local notifications. ([\#14775](https://github.com/matrix-org/synapse/issues/14775))
- Implement experimental support for [MSC3930](https://github.com/matrix-org/matrix-spec-proposals/pull/3930): Push rules for ([MSC3381](https://github.com/matrix-org/matrix-spec-proposals/pull/3381)) Polls. ([\#14787](https://github.com/matrix-org/synapse/issues/14787))
- Per [MSC3925](https://github.com/matrix-org/matrix-spec-proposals/pull/3925), bundle the whole of the replacement with any edited events, and optionally inhibit server-side replacement. ([\#14811](https://github.com/matrix-org/synapse/issues/14811))
- Faster joins: always serve a partial join response to servers that request it with the stable query param. ([\#14839](https://github.com/matrix-org/synapse/issues/14839))
- Faster joins: allow non-lazy-loading (\"eager\") syncs to complete after a partial join by omitting partial state rooms until they become fully stated. ([\#14870](https://github.com/matrix-org/synapse/issues/14870))
- Faster joins: request partial joins by default. Admins can opt-out of this for the time being---see the upgrade notes. ([\#14905](https://github.com/matrix-org/synapse/issues/14905))

Bugfixes
--------

- Add index to improve performance of the `/timestamp_to_event` endpoint used for jumping to a specific date in the timeline of a room. ([\#14799](https://github.com/matrix-org/synapse/issues/14799))
- Fix a long-standing bug where Synapse would exhaust the stack when processing many federation requests where the remote homeserver has disconencted early. ([\#14812](https://github.com/matrix-org/synapse/issues/14812), [\#14842](https://github.com/matrix-org/synapse/issues/14842))
- Fix rare races when using workers. ([\#14820](https://github.com/matrix-org/synapse/issues/14820))
- Fix a bug introduced in Synapse 1.64.0 when using room version 10 with frozen events enabled. ([\#14864](https://github.com/matrix-org/synapse/issues/14864))
- Fix a long-standing bug where the `populate_room_stats` background job could fail on broken rooms. ([\#14873](https://github.com/matrix-org/synapse/issues/14873))
- Faster joins: Fix a bug in worker deployments where the room stats and user directory would not get updated when finishing a fast join until another event is sent or received. ([\#14874](https://github.com/matrix-org/synapse/issues/14874))
- Faster joins: Fix incompatibility with joins into restricted rooms where no local users have the ability to invite. ([\#14882](https://github.com/matrix-org/synapse/issues/14882))
- Fix a regression introduced in Synapse 1.69.0 which can result in database corruption when database migrations are interrupted on sqlite. ([\#14910](https://github.com/matrix-org/synapse/issues/14910))

Updates to the Docker image
---------------------------

- Bump default Python version in the Dockerfile from 3.9 to 3.11. ([\#14875](https://github.com/matrix-org/synapse/issues/14875))

Improved Documentation
----------------------

- Include `x_forwarded` entry in the HTTP listener example configs and remove the remaining `worker_main_http_uri` entries. ([\#14667](https://github.com/matrix-org/synapse/issues/14667))
- Remove duplicate commands from the Code Style documentation page; point to the Contributing Guide instead. ([\#14773](https://github.com/matrix-org/synapse/issues/14773))
- Add missing documentation for `tag` to `listeners` section. ([\#14803](https://github.com/matrix-org/synapse/issues/14803))
- Updated documentation in configuration manual for `user_directory.search_all_users`. ([\#14818](https://github.com/matrix-org/synapse/issues/14818))
- Add `worker_manhole` to configuration manual. ([\#14824](https://github.com/matrix-org/synapse/issues/14824))
- Fix the example config missing the `id` field in [application service documentation](https://matrix-org.github.io/synapse/latest/application_services.html). ([\#14845](https://github.com/matrix-org/synapse/issues/14845))
- Minor corrections to the logging configuration documentation. ([\#14868](https://github.com/matrix-org/synapse/issues/14868))
- Document the export user data command. Contributed by @thezaidbintariq. ([\#14883](https://github.com/matrix-org/synapse/issues/14883))

Deprecations and Removals
-------------------------

- Poetry 1.3.2 or higher is now required when `poetry install`ing from source. ([\#14860](https://github.com/matrix-org/synapse/issues/14860))

Internal Changes
----------------

- Faster remote room joins (worker mode): do not populate external hosts-in-room cache when sending events as this requires blocking for full state. ([\#14749](https://github.com/matrix-org/synapse/issues/14749))
- Enable Complement tests for Faster Remote Room Joins against worker-mode Synapse. ([\#14752](https://github.com/matrix-org/synapse/issues/14752))
- Add some clarifying comments and refactor a portion of the `Keyring` class for readability. ([\#14804](https://github.com/matrix-org/synapse/issues/14804))
- Add local poetry config files (`poetry.toml`) to `.gitignore`. ([\#14807](https://github.com/matrix-org/synapse/issues/14807))
- Add missing type hints. ([\#14816](https://github.com/matrix-org/synapse/issues/14816), [\#14885](https://github.com/matrix-org/synapse/issues/14885), [\#14889](https://github.com/matrix-org/synapse/issues/14889))
- Refactor push tests. ([\#14819](https://github.com/matrix-org/synapse/issues/14819))
- Re-enable some linting that was disabled when we switched to ruff. ([\#14821](https://github.com/matrix-org/synapse/issues/14821))
- Add `cargo fmt` and `cargo clippy` to the lint script. ([\#14822](https://github.com/matrix-org/synapse/issues/14822))
- Drop unused table `presence`. ([\#14825](https://github.com/matrix-org/synapse/issues/14825))
- Merge the two account data and the two device list replication streams. ([\#14826](https://github.com/matrix-org/synapse/issues/14826), [\#14833](https://github.com/matrix-org/synapse/issues/14833))
- Faster joins: use stable identifiers from [MSC3706](https://github.com/matrix-org/matrix-spec-proposals/pull/3706). ([\#14832](https://github.com/matrix-org/synapse/issues/14832), [\#14841](https://github.com/matrix-org/synapse/issues/14841))
- Add a parameter to control whether the federation client performs a partial state join. ([\#14843](https://github.com/matrix-org/synapse/issues/14843))
- Add check to avoid starting duplicate partial state syncs. ([\#14844](https://github.com/matrix-org/synapse/issues/14844))
- Add an early return when handling no-op presence updates. ([\#14855](https://github.com/matrix-org/synapse/issues/14855))
- Fix `wait_for_stream_position` to correctly wait for the right instance to advance its token. ([\#14856](https://github.com/matrix-org/synapse/issues/14856), [\#14872](https://github.com/matrix-org/synapse/issues/14872))
- Always notify replication when a stream advances automatically. ([\#14877](https://github.com/matrix-org/synapse/issues/14877))
- Reduce max time we wait for stream positions. ([\#14881](https://github.com/matrix-org/synapse/issues/14881))
- Faster joins: allow the resync process more time to fetch `/state` ids. ([\#14912](https://github.com/matrix-org/synapse/issues/14912))
- Bump regex from 1.7.0 to 1.7.1. ([\#14848](https://github.com/matrix-org/synapse/issues/14848))
- Bump peaceiris/actions-gh-pages from 3.9.1 to 3.9.2. ([\#14861](https://github.com/matrix-org/synapse/issues/14861))
- Bump ruff from 0.0.215 to 0.0.224. ([\#14862](https://github.com/matrix-org/synapse/issues/14862))
- Bump types-pillow from 9.4.0.0 to 9.4.0.3. ([\#14863](https://github.com/matrix-org/synapse/issues/14863))
- Bump types-opentracing from 2.4.10 to 2.4.10.1. ([\#14896](https://github.com/matrix-org/synapse/issues/14896))
- Bump ruff from 0.0.224 to 0.0.230. ([\#14897](https://github.com/matrix-org/synapse/issues/14897))
- Bump types-requests from 2.28.11.7 to 2.28.11.8. ([\#14899](https://github.com/matrix-org/synapse/issues/14899))
- Bump types-psycopg2 from 2.9.21.2 to 2.9.21.4. ([\#14900](https://github.com/matrix-org/synapse/issues/14900))
- Bump types-commonmark from 0.9.2 to 0.9.2.1. ([\#14901](https://github.com/matrix-org/synapse/issues/14901))

Synapse 1.75.0 (2023-01-17)
===========================

No significant changes since 1.75.0rc2.

Synapse 1.75.0rc2 (2023-01-12)
==============================

Bugfixes
--------

- Fix a bug introduced in Synapse 1.75.0rc1 where device lists could be miscalculated with some sync filters. ([\#14810](https://github.com/matrix-org/synapse/issues/14810))
- Fix race where calling `/members` or `/state` with an `at` parameter could fail for newly created rooms, when using multiple workers. ([\#14817](https://github.com/matrix-org/synapse/issues/14817))

Synapse 1.75.0rc1 (2023-01-10)
==============================

Features
--------

- Add a `cached` function to `synapse.module_api` that returns a decorator to cache return values of functions. ([\#14663](https://github.com/matrix-org/synapse/issues/14663))
- Add experimental support for [MSC3391](https://github.com/matrix-org/matrix-spec-proposals/pull/3391) (removing account data). ([\#14714](https://github.com/matrix-org/synapse/issues/14714))
- Support [RFC7636](https://datatracker.ietf.org/doc/html/rfc7636) Proof Key for Code Exchange for OAuth single sign-on. ([\#14750](https://github.com/matrix-org/synapse/issues/14750))
- Support non-OpenID compliant userinfo claims for subject and picture. ([\#14753](https://github.com/matrix-org/synapse/issues/14753))
- Improve performance of `/sync` when filtering all rooms, message types, or senders. ([\#14786](https://github.com/matrix-org/synapse/issues/14786))
- Improve performance of the `/hierarchy` endpoint. ([\#14263](https://github.com/matrix-org/synapse/issues/14263))

Bugfixes
--------

- Fix the *MAU Limits* section of the Grafana dashboard relying on a specific `job` name for the workers of a Synapse deployment. ([\#14644](https://github.com/matrix-org/synapse/issues/14644))
- Fix a bug introduced in Synapse 1.70.0 which could cause spurious `UNIQUE constraint failed` errors in the `rotate_notifs` background job. ([\#14669](https://github.com/matrix-org/synapse/issues/14669))
- Ensure stream IDs are always updated after caches get invalidated with workers. Contributed by Nick @ Beeper (@fizzadar). ([\#14723](https://github.com/matrix-org/synapse/issues/14723))
- Remove the unspecced `device` field from `/pushrules` responses. ([\#14727](https://github.com/matrix-org/synapse/issues/14727))
- Fix a bug introduced in Synapse 1.73.0 where the `picture_claim` configured under `oidc_providers` was unused (the default value of `\"picture\"` was used instead). ([\#14751](https://github.com/matrix-org/synapse/issues/14751))
- Unescape HTML entities in URL preview titles making use of oEmbed responses. ([\#14781](https://github.com/matrix-org/synapse/issues/14781))
- Disable sending confirmation email when 3pid is disabled. ([\#14725](https://github.com/matrix-org/synapse/issues/14725))

Improved Documentation
----------------------

- Declare support for Python 3.11. ([\#14673](https://github.com/matrix-org/synapse/issues/14673))
- Fix `target_memory_usage` being used in the description for the actual `cache_autotune` sub-option `target_cache_memory_usage`. ([\#14674](https://github.com/matrix-org/synapse/issues/14674))
- Move `email` to Server section in config file documentation. ([\#14730](https://github.com/matrix-org/synapse/issues/14730))
- Fix broken links in the Synapse documentation. ([\#14744](https://github.com/matrix-org/synapse/issues/14744))
- Add missing worker settings to shared configuration documentation. ([\#14748](https://github.com/matrix-org/synapse/issues/14748))
- Document using Twitter as a OAuth 2.0 authentication provider. ([\#14778](https://github.com/matrix-org/synapse/issues/14778))
- Fix Synapse 1.74 upgrade notes to correctly explain how to install pyICU when installing Synapse from PyPI. ([\#14797](https://github.com/matrix-org/synapse/issues/14797))
- Update link to towncrier in contribution guide. ([\#14801](https://github.com/matrix-org/synapse/issues/14801))
- Use `htmltest` to check links in the Synapse documentation. ([\#14743](https://github.com/matrix-org/synapse/issues/14743))

Internal Changes
----------------

- Faster remote room joins: stream the un-partial-stating of events over replication. ([\#14545](https://github.com/matrix-org/synapse/issues/14545), [\#14546](https://github.com/matrix-org/synapse/issues/14546))
- Use [ruff](https://github.com/charliermarsh/ruff/) instead of flake8. ([\#14633](https://github.com/matrix-org/synapse/issues/14633), [\#14741](https://github.com/matrix-org/synapse/issues/14741))
- Change `handle_new_client_event` signature so that a 429 does not reach clients on `PartialStateConflictError`, and internally retry when needed instead. ([\#14665](https://github.com/matrix-org/synapse/issues/14665))
- Remove dependency on jQuery on reCAPTCHA page. ([\#14672](https://github.com/matrix-org/synapse/issues/14672))
- Faster joins: make `compute_state_after_events` consistent with other state-fetching functions that take a `StateFilter`. ([\#14676](https://github.com/matrix-org/synapse/issues/14676))
- Add missing type hints. ([\#14680](https://github.com/matrix-org/synapse/issues/14680), [\#14681](https://github.com/matrix-org/synapse/issues/14681), [\#14687](https://github.com/matrix-org/synapse/issues/14687))
- Improve type annotations for the helper methods on a `CachedFunction`. ([\#14685](https://github.com/matrix-org/synapse/issues/14685))
- Check that the SQLite database file exists before porting to PostgreSQL. ([\#14692](https://github.com/matrix-org/synapse/issues/14692))
- Add `.direnv/` directory to .gitignore to prevent local state generated by the [direnv](https://direnv.net/) development tool from being committed. ([\#14707](https://github.com/matrix-org/synapse/issues/14707))
- Batch up replication requests to request the resyncing of remote users's devices. ([\#14716](https://github.com/matrix-org/synapse/issues/14716))
- If debug logging is enabled, log the `msgid`s of any to-device messages that are returned over `/sync`. ([\#14724](https://github.com/matrix-org/synapse/issues/14724))
- Change GHA CI job to follow best practices. ([\#14772](https://github.com/matrix-org/synapse/issues/14772))
- Switch to our fork of `dh-virtualenv` to work around an upstream Python 3.11 incompatibility. ([\#14774](https://github.com/matrix-org/synapse/issues/14774))
- Skip testing built wheels for PyPy 3.7 on Linux x86_64 as we lack new required dependencies in the build environment. ([\#14802](https://github.com/matrix-org/synapse/issues/14802))

### Dependabot updates

<details>

- Bump JasonEtco/create-an-issue from 2.8.1 to 2.8.2. ([\#14693](https://github.com/matrix-org/synapse/issues/14693))
- Bump anyhow from 1.0.66 to 1.0.68. ([\#14694](https://github.com/matrix-org/synapse/issues/14694))
- Bump blake2 from 0.10.5 to 0.10.6. ([\#14695](https://github.com/matrix-org/synapse/issues/14695))
- Bump serde_json from 1.0.89 to 1.0.91. ([\#14696](https://github.com/matrix-org/synapse/issues/14696))
- Bump serde from 1.0.150 to 1.0.151. ([\#14697](https://github.com/matrix-org/synapse/issues/14697))
- Bump lxml from 4.9.1 to 4.9.2. ([\#14698](https://github.com/matrix-org/synapse/issues/14698))
- Bump types-jsonschema from 4.17.0.1 to 4.17.0.2. ([\#14700](https://github.com/matrix-org/synapse/issues/14700))
- Bump sentry-sdk from 1.11.1 to 1.12.0. ([\#14701](https://github.com/matrix-org/synapse/issues/14701))
- Bump types-setuptools from 65.6.0.1 to 65.6.0.2. ([\#14702](https://github.com/matrix-org/synapse/issues/14702))
- Bump minimum PyYAML to 3.13. ([\#14720](https://github.com/matrix-org/synapse/issues/14720))
- Bump JasonEtco/create-an-issue from 2.8.2 to 2.9.1. ([\#14731](https://github.com/matrix-org/synapse/issues/14731))
- Bump towncrier from 22.8.0 to 22.12.0. ([\#14732](https://github.com/matrix-org/synapse/issues/14732))
- Bump isort from 5.10.1 to 5.11.4. ([\#14733](https://github.com/matrix-org/synapse/issues/14733))
- Bump attrs from 22.1.0 to 22.2.0. ([\#14734](https://github.com/matrix-org/synapse/issues/14734))
- Bump black from 22.10.0 to 22.12.0. ([\#14735](https://github.com/matrix-org/synapse/issues/14735))
- Bump sentry-sdk from 1.12.0 to 1.12.1. ([\#14736](https://github.com/matrix-org/synapse/issues/14736))
- Bump setuptools from 65.3.0 to 65.5.1. ([\#14738](https://github.com/matrix-org/synapse/issues/14738))
- Bump serde from 1.0.151 to 1.0.152. ([\#14758](https://github.com/matrix-org/synapse/issues/14758))
- Bump ruff from 0.0.189 to 0.0.206. ([\#14759](https://github.com/matrix-org/synapse/issues/14759))
- Bump pydantic from 1.10.2 to 1.10.4. ([\#14760](https://github.com/matrix-org/synapse/issues/14760))
- Bump gitpython from 3.1.29 to 3.1.30. ([\#14761](https://github.com/matrix-org/synapse/issues/14761))
- Bump pillow from 9.3.0 to 9.4.0. ([\#14762](https://github.com/matrix-org/synapse/issues/14762))
- Bump types-requests from 2.28.11.5 to 2.28.11.7. ([\#14763](https://github.com/matrix-org/synapse/issues/14763))
- Bump dawidd6/action-download-artifact from 2.24.2 to 2.24.3. ([\#14779](https://github.com/matrix-org/synapse/issues/14779))
- Bump peaceiris/actions-gh-pages from 3.9.0 to 3.9.1. ([\#14791](https://github.com/matrix-org/synapse/issues/14791))
- Bump types-pillow from 9.3.0.4 to 9.4.0.0. ([\#14792](https://github.com/matrix-org/synapse/issues/14792))
- Bump pyopenssl from 22.1.0 to 23.0.0. ([\#14793](https://github.com/matrix-org/synapse/issues/14793))
- Bump types-setuptools from 65.6.0.2 to 65.6.0.3. ([\#14794](https://github.com/matrix-org/synapse/issues/14794))
- Bump importlib-metadata from 4.2.0 to 6.0.0. ([\#14795](https://github.com/matrix-org/synapse/issues/14795))
- Bump ruff from 0.0.206 to 0.0.215. ([\#14796](https://github.com/matrix-org/synapse/issues/14796))
</details>

Synapse 1.74.0 (2022-12-20)
===========================

Improved Documentation
----------------------

- Add release note and update documentation regarding optional ICU support in user search. ([\#14712](https://github.com/matrix-org/synapse/issues/14712))

Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\#14464](https://github.com/matrix-org/synapse/issues/14464))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\#14490](https://github.com/matrix-org/synapse/issues/14490), [\#14525](https://github.com/matrix-org/synapse/issues/14525))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\#14551](https://github.com/matrix-org/synapse/issues/14551), [\#14619](https://github.com/matrix-org/synapse/issues/14619))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\#14576](https://github.com/matrix-org/synapse/issues/14576))
- Improve opentracing and logging for to-device message handling. ([\#14598](https://github.com/matrix-org/synapse/issues/14598))
- Allow selecting \"prejoin\" events by state keys in addition to event types. ([\#14642](https://github.com/matrix-org/synapse/issues/14642))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\#14435](https://github.com/matrix-org/synapse/issues/14435), [\#14592](https://github.com/matrix-org/synapse/issues/14592), [\#14604](https://github.com/matrix-org/synapse/issues/14604))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\#14600](https://github.com/matrix-org/synapse/issues/14600))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\#14620](https://github.com/matrix-org/synapse/issues/14620), [\#14621](https://github.com/matrix-org/synapse/issues/14621))
- Update html templates to load images over HTTPS. Contributed by @ashfame. ([\#14625](https://github.com/matrix-org/synapse/issues/14625))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\#14631](https://github.com/matrix-org/synapse/issues/14631))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper (@fizzadar). ([\#14632](https://github.com/matrix-org/synapse/issues/14632))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\#14637](https://github.com/matrix-org/synapse/issues/14637))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\#14639](https://github.com/matrix-org/synapse/issues/14639), [\#14643](https://github.com/matrix-org/synapse/issues/14643))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\#14650](https://github.com/matrix-org/synapse/issues/14650))
- Improve validation of field size limits in events. ([\#14664](https://github.com/matrix-org/synapse/issues/14664))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\#14670](https://github.com/matrix-org/synapse/issues/14670))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\#14493](https://github.com/matrix-org/synapse/issues/14493))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\#14517](https://github.com/matrix-org/synapse/issues/14517))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html). ([\#14590](https://github.com/matrix-org/synapse/issues/14590))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\#14594](https://github.com/matrix-org/synapse/issues/14594))
- Change `turn_allow_guests` example value to lowercase `true`. ([\#14634](https://github.com/matrix-org/synapse/issues/14634))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper (@fizzadar). ([\#14255](https://github.com/matrix-org/synapse/issues/14255))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\#14473](https://github.com/matrix-org/synapse/issues/14473), [\#14474](https://github.com/matrix-org/synapse/issues/14474))
- Share the `ClientRestResource` for both workers and the main process. ([\#14528](https://github.com/matrix-org/synapse/issues/14528))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\#14548](https://github.com/matrix-org/synapse/issues/14548))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\#14549](https://github.com/matrix-org/synapse/issues/14549))
- Modernize unit tests configuration related to workers. ([\#14568](https://github.com/matrix-org/synapse/issues/14568))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\#14591](https://github.com/matrix-org/synapse/issues/14591))
- Fix Rust lint CI. ([\#14602](https://github.com/matrix-org/synapse/issues/14602))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\#14607](https://github.com/matrix-org/synapse/issues/14607))
- Alter some unit test environment parameters to decrease time spent running tests. ([\#14610](https://github.com/matrix-org/synapse/issues/14610))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\#14611](https://github.com/matrix-org/synapse/issues/14611))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\#14612](https://github.com/matrix-org/synapse/issues/14612))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\#14613](https://github.com/matrix-org/synapse/issues/14613))
- Bump twine from 4.0.1 to 4.0.2. ([\#14614](https://github.com/matrix-org/synapse/issues/14614))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\#14615](https://github.com/matrix-org/synapse/issues/14615))
- Bump cryptography from 38.0.3 to 38.0.4. ([\#14616](https://github.com/matrix-org/synapse/issues/14616))
- Remove useless cargo install with apt from Dockerfile. ([\#14636](https://github.com/matrix-org/synapse/issues/14636))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\#14645](https://github.com/matrix-org/synapse/issues/14645))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\#14656](https://github.com/matrix-org/synapse/issues/14656))
- Bump packaging from 21.3 to 22.0. ([\#14657](https://github.com/matrix-org/synapse/issues/14657))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\#14658](https://github.com/matrix-org/synapse/issues/14658))
- Bump serde from 1.0.148 to 1.0.150. ([\#14659](https://github.com/matrix-org/synapse/issues/14659))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\#14660](https://github.com/matrix-org/synapse/issues/14660))
- Bump authlib from 1.1.0 to 1.2.0. ([\#14661](https://github.com/matrix-org/synapse/issues/14661))
- Move `StateFilter` to `synapse.types`. ([\#14668](https://github.com/matrix-org/synapse/issues/14668))
- Improve type hints. ([\#14597](https://github.com/matrix-org/synapse/issues/14597), [\#14646](https://github.com/matrix-org/synapse/issues/14646), [\#14671](https://github.com/matrix-org/synapse/issues/14671))")`
â¦

`[75d0625](/NetBSD/pkgsrc/commit/75d0625dd885c47e1426522441f72a142c52365e)`

```
Synapse 1.76.0 (2023-01-31)
===========================

The 1.76 release is the first to enable faster joins ([MSC3706]([matrix-org/matrix-spec-proposals#3706](https://github.com/matrix-org/matrix-spec-proposals/pull/3706)) and [MSC3902]([matrix-org/matrix-spec-proposals#3902](https://github.com/matrix-org/matrix-spec-proposals/pull/3902))) by default. Admins can opt-out: see [the upgrade notes](<https://github.com/matrix-org/synapse/blob/release-v1.76/docs/upgrade.md#faster-joins-are-enabled-by-default>) for more details.

The upgrade from 1.75 to 1.76 changes the account data replication streams in a backwards-incompatible manner. Server operators running a multi-worker deployment should consult [the upgrade notes](<https://github.com/matrix-org/synapse/blob/release-v1.76/docs/upgrade.md#changes-to-the-account-data-replication-streams>).

Those who are `poetry install`ing from source using our lockfile should ensure their poetry version is 1.3.2 or higher; [see upgrade notes](<https://github.com/matrix-org/synapse/blob/release-v1.76/docs/upgrade.md#minimum-version-of-poetry-is-now-132>).

Notes on faster joins
---------------------

The faster joins project sees the most benefit when joining a room with a large number of members (joined or historical). We expect it to be particularly useful for joining large public rooms like the [Matrix HQ](<https://matrix.to/#/#matrix:matrix.org>) or [Synapse Admins](<https://matrix.to/#/#synapse:matrix.org>) rooms.

After a faster join, Synapse considers that room "partially joined". In this state, you should be able to

- read incoming messages;
- see incoming state changes, e.g. room topic changes; and
- send messages, if the room is unencrypted.

Synapse has to spend more effort to complete the join in the background. Once this finishes, you will be able to

- send messages, if the room is in encrypted;
- retrieve room history from before your join, if permitted by the room settings; and
- access the full list of room members.

Improved Documentation
----------------------

- Describe the ideas and the internal machinery behind faster joins. ([\#14677]([matrix-org/synapse#14677](https://github.com/matrix-org/synapse/pull/14677)))

Synapse 1.76.0rc2 (2023-01-27)
==============================

Bugfixes
--------

- Faster joins: Fix a bug introduced in Synapse 1.69 where device list EDUs could fail to be handled after a restart when a faster join sync is in progress. ([\#14914]([matrix-org/synapse#14914](https://github.com/matrix-org/synapse/pull/14914)))

Internal Changes
----------------

- Faster joins: Improve performance of looking up partial-state status of rooms. ([\#14917]([matrix-org/synapse#14917](https://github.com/matrix-org/synapse/pull/14917)))

Synapse 1.76.0rc1 (2023-01-25)
==============================

Features
--------

- Update the default room version to [v10](<https://spec.matrix.org/v1.5/rooms/v10/>) ([MSC 3904]([matrix-org/matrix-spec-proposals#3904](https://github.com/matrix-org/matrix-spec-proposals/pull/3904))). Contributed by [@FSG-Cat](https://github.com/FSG-Cat). ([\#14111]([matrix-org/synapse#14111](https://github.com/matrix-org/synapse/pull/14111)))
- Add a `set_displayname()` method to the module API for setting a user's display name. ([\#14629]([matrix-org/synapse#14629](https://github.com/matrix-org/synapse/pull/14629)))
- Add a dedicated listener configuration for `health` endpoint. ([\#14747]([matrix-org/synapse#14747](https://github.com/matrix-org/synapse/pull/14747)))
- Implement support for [MSC3890]([matrix-org/matrix-spec-proposals#3890](https://github.com/matrix-org/matrix-spec-proposals/pull/3890)): Remotely silence local notifications. ([\#14775]([matrix-org/synapse#14775](https://github.com/matrix-org/synapse/pull/14775)))
- Implement experimental support for [MSC3930]([matrix-org/matrix-spec-proposals#3930](https://github.com/matrix-org/matrix-spec-proposals/pull/3930)): Push rules for ([MSC3381]([matrix-org/matrix-spec-proposals#3381](https://github.com/matrix-org/matrix-spec-proposals/pull/3381))) Polls. ([\#14787]([matrix-org/synapse#14787](https://github.com/matrix-org/synapse/pull/14787)))
- Per [MSC3925]([matrix-org/matrix-spec-proposals#3925](https://github.com/matrix-org/matrix-spec-proposals/pull/3925)), bundle the whole of the replacement with any edited events, and optionally inhibit server-side replacement. ([\#14811]([matrix-org/synapse#14811](https://github.com/matrix-org/synapse/pull/14811)))
- Faster joins: always serve a partial join response to servers that request it with the stable query param. ([\#14839]([matrix-org/synapse#14839](https://github.com/matrix-org/synapse/pull/14839)))
- Faster joins: allow non-lazy-loading ("eager") syncs to complete after a partial join by omitting partial state rooms until they become fully stated. ([\#14870]([matrix-org/synapse#14870](https://github.com/matrix-org/synapse/pull/14870)))
- Faster joins: request partial joins by default. Admins can opt-out of this for the time being---see the upgrade notes. ([\#14905]([matrix-org/synapse#14905](https://github.com/matrix-org/synapse/pull/14905)))

Bugfixes
--------

- Add index to improve performance of the `/timestamp_to_event` endpoint used for jumping to a specific date in the timeline of a room. ([\#14799]([matrix-org/synapse#14799](https://github.com/matrix-org/synapse/pull/14799)))
- Fix a long-standing bug where Synapse would exhaust the stack when processing many federation requests where the remote homeserver has disconencted early. ([\#14812]([matrix-org/synapse#14812](https://github.com/matrix-org/synapse/pull/14812)), [\#14842]([matrix-org/synapse#14842](https://github.com/matrix-org/synapse/pull/14842)))
- Fix rare races when using workers. ([\#14820]([matrix-org/synapse#14820](https://github.com/matrix-org/synapse/pull/14820)))
- Fix a bug introduced in Synapse 1.64.0 when using room version 10 with frozen events enabled. ([\#14864]([matrix-org/synapse#14864](https://github.com/matrix-org/synapse/pull/14864)))
- Fix a long-standing bug where the `populate_room_stats` background job could fail on broken rooms. ([\#14873]([matrix-org/synapse#14873](https://github.com/matrix-org/synapse/pull/14873)))
- Faster joins: Fix a bug in worker deployments where the room stats and user directory would not get updated when finishing a fast join until another event is sent or received. ([\#14874]([matrix-org/synapse#14874](https://github.com/matrix-org/synapse/pull/14874)))
- Faster joins: Fix incompatibility with joins into restricted rooms where no local users have the ability to invite. ([\#14882]([matrix-org/synapse#14882](https://github.com/matrix-org/synapse/pull/14882)))
- Fix a regression introduced in Synapse 1.69.0 which can result in database corruption when database migrations are interrupted on sqlite. ([\#14910]([matrix-org/synapse#14910](https://github.com/matrix-org/synapse/pull/14910)))

Updates to the Docker image
---------------------------

- Bump default Python version in the Dockerfile from 3.9 to 3.11. ([\#14875]([matrix-org/synapse#14875](https://github.com/matrix-org/synapse/pull/14875)))

Improved Documentation
----------------------

- Include `x_forwarded` entry in the HTTP listener example configs and remove the remaining `worker_main_http_uri` entries. ([\#14667]([matrix-org/synapse#14667](https://github.com/matrix-org/synapse/pull/14667)))
- Remove duplicate commands from the Code Style documentation page; point to the Contributing Guide instead. ([\#14773]([matrix-org/synapse#14773](https://github.com/matrix-org/synapse/pull/14773)))
- Add missing documentation for `tag` to `listeners` section. ([\#14803]([matrix-org/synapse#14803](https://github.com/matrix-org/synapse/pull/14803)))
- Updated documentation in configuration manual for `user_directory.search_all_users`. ([\#14818]([matrix-org/synapse#14818](https://github.com/matrix-org/synapse/pull/14818)))
- Add `worker_manhole` to configuration manual. ([\#14824]([matrix-org/synapse#14824](https://github.com/matrix-org/synapse/pull/14824)))
- Fix the example config missing the `id` field in [application service documentation](<https://matrix-org.github.io/synapse/latest/application_services.html>). ([\#14845]([matrix-org/synapse#14845](https://github.com/matrix-org/synapse/pull/14845)))
- Minor corrections to the logging configuration documentation. ([\#14868]([matrix-org/synapse#14868](https://github.com/matrix-org/synapse/pull/14868)))
- Document the export user data command. Contributed by [@thezaidbintariq](https://github.com/thezaidbintariq). ([\#14883]([matrix-org/synapse#14883](https://github.com/matrix-org/synapse/pull/14883)))

Deprecations and Removals
-------------------------

- Poetry 1.3.2 or higher is now required when `poetry install`ing from source. ([\#14860]([matrix-org/synapse#14860](https://github.com/matrix-org/synapse/pull/14860)))

Internal Changes
----------------

- Faster remote room joins (worker mode): do not populate external hosts-in-room cache when sending events as this requires blocking for full state. ([\#14749]([matrix-org/synapse#14749](https://github.com/matrix-org/synapse/pull/14749)))
- Enable Complement tests for Faster Remote Room Joins against worker-mode Synapse. ([\#14752]([matrix-org/synapse#14752](https://github.com/matrix-org/synapse/pull/14752)))
- Add some clarifying comments and refactor a portion of the `Keyring` class for readability. ([\#14804]([matrix-org/synapse#14804](https://github.com/matrix-org/synapse/pull/14804)))
- Add local poetry config files (`poetry.toml`) to `.gitignore`. ([\#14807]([matrix-org/synapse#14807](https://github.com/matrix-org/synapse/pull/14807)))
- Add missing type hints. ([\#14816]([matrix-org/synapse#14816](https://github.com/matrix-org/synapse/pull/14816)), [\#14885]([matrix-org/synapse#14885](https://github.com/matrix-org/synapse/pull/14885)), [\#14889]([matrix-org/synapse#14889](https://github.com/matrix-org/synapse/pull/14889)))
- Refactor push tests. ([\#14819]([matrix-org/synapse#14819](https://github.com/matrix-org/synapse/pull/14819)))
- Re-enable some linting that was disabled when we switched to ruff. ([\#14821]([matrix-org/synapse#14821](https://github.com/matrix-org/synapse/pull/14821)))
- Add `cargo fmt` and `cargo clippy` to the lint script. ([\#14822]([matrix-org/synapse#14822](https://github.com/matrix-org/synapse/pull/14822)))
- Drop unused table `presence`. ([\#14825]([matrix-org/synapse#14825](https://github.com/matrix-org/synapse/pull/14825)))
- Merge the two account data and the two device list replication streams. ([\#14826]([matrix-org/synapse#14826](https://github.com/matrix-org/synapse/pull/14826)), [\#14833]([matrix-org/synapse#14833](https://github.com/matrix-org/synapse/pull/14833)))
- Faster joins: use stable identifiers from [MSC3706]([matrix-org/matrix-spec-proposals#3706](https://github.com/matrix-org/matrix-spec-proposals/pull/3706)). ([\#14832]([matrix-org/synapse#14832](https://github.com/matrix-org/synapse/pull/14832)), [\#14841]([matrix-org/synapse#14841](https://github.com/matrix-org/synapse/pull/14841)))
- Add a parameter to control whether the federation client performs a partial state join. ([\#14843]([matrix-org/synapse#14843](https://github.com/matrix-org/synapse/pull/14843)))
- Add check to avoid starting duplicate partial state syncs. ([\#14844]([matrix-org/synapse#14844](https://github.com/matrix-org/synapse/pull/14844)))
- Add an early return when handling no-op presence updates. ([\#14855]([matrix-org/synapse#14855](https://github.com/matrix-org/synapse/pull/14855)))
- Fix `wait_for_stream_position` to correctly wait for the right instance to advance its token. ([\#14856]([matrix-org/synapse#14856](https://github.com/matrix-org/synapse/pull/14856)), [\#14872]([matrix-org/synapse#14872](https://github.com/matrix-org/synapse/pull/14872)))
- Always notify replication when a stream advances automatically. ([\#14877]([matrix-org/synapse#14877](https://github.com/matrix-org/synapse/pull/14877)))
- Reduce max time we wait for stream positions. ([\#14881]([matrix-org/synapse#14881](https://github.com/matrix-org/synapse/pull/14881)))
- Faster joins: allow the resync process more time to fetch `/state` ids. ([\#14912]([matrix-org/synapse#14912](https://github.com/matrix-org/synapse/pull/14912)))
- Bump regex from 1.7.0 to 1.7.1. ([\#14848]([matrix-org/synapse#14848](https://github.com/matrix-org/synapse/pull/14848)))
- Bump peaceiris/actions-gh-pages from 3.9.1 to 3.9.2. ([\#14861]([matrix-org/synapse#14861](https://github.com/matrix-org/synapse/pull/14861)))
- Bump ruff from 0.0.215 to 0.0.224. ([\#14862]([matrix-org/synapse#14862](https://github.com/matrix-org/synapse/pull/14862)))
- Bump types-pillow from 9.4.0.0 to 9.4.0.3. ([\#14863]([matrix-org/synapse#14863](https://github.com/matrix-org/synapse/pull/14863)))
- Bump types-opentracing from 2.4.10 to 2.4.10.1. ([\#14896]([matrix-org/synapse#14896](https://github.com/matrix-org/synapse/pull/14896)))
- Bump ruff from 0.0.224 to 0.0.230. ([\#14897]([matrix-org/synapse#14897](https://github.com/matrix-org/synapse/pull/14897)))
- Bump types-requests from 2.28.11.7 to 2.28.11.8. ([\#14899]([matrix-org/synapse#14899](https://github.com/matrix-org/synapse/pull/14899)))
- Bump types-psycopg2 from 2.9.21.2 to 2.9.21.4. ([\#14900]([matrix-org/synapse#14900](https://github.com/matrix-org/synapse/pull/14900)))
- Bump types-commonmark from 0.9.2 to 0.9.2.1. ([\#14901]([matrix-org/synapse#14901](https://github.com/matrix-org/synapse/pull/14901)))

Synapse 1.75.0 (2023-01-17)
===========================

No significant changes since 1.75.0rc2.

Synapse 1.75.0rc2 (2023-01-12)
==============================

Bugfixes
--------

- Fix a bug introduced in Synapse 1.75.0rc1 where device lists could be miscalculated with some sync filters. ([\#14810]([matrix-org/synapse#14810](https://github.com/matrix-org/synapse/pull/14810)))
- Fix race where calling `/members` or `/state` with an `at` parameter could fail for newly created rooms, when using multiple workers. ([\#14817]([matrix-org/synapse#14817](https://github.com/matrix-org/synapse/pull/14817)))

Synapse 1.75.0rc1 (2023-01-10)
==============================

Features
--------

- Add a `cached` function to `synapse.module_api` that returns a decorator to cache return values of functions. ([\#14663]([matrix-org/synapse#14663](https://github.com/matrix-org/synapse/pull/14663)))
- Add experimental support for [MSC3391]([matrix-org/matrix-spec-proposals#3391](https://github.com/matrix-org/matrix-spec-proposals/pull/3391)) (removing account data). ([\#14714]([matrix-org/synapse#14714](https://github.com/matrix-org/synapse/pull/14714)))
- Support [RFC7636](<https://datatracker.ietf.org/doc/html/rfc7636>) Proof Key for Code Exchange for OAuth single sign-on. ([\#14750]([matrix-org/synapse#14750](https://github.com/matrix-org/synapse/pull/14750)))
- Support non-OpenID compliant userinfo claims for subject and picture. ([\#14753]([matrix-org/synapse#14753](https://github.com/matrix-org/synapse/pull/14753)))
- Improve performance of `/sync` when filtering all rooms, message types, or senders. ([\#14786]([matrix-org/synapse#14786](https://github.com/matrix-org/synapse/pull/14786)))
- Improve performance of the `/hierarchy` endpoint. ([\#14263]([matrix-org/synapse#14263](https://github.com/matrix-org/synapse/pull/14263)))

Bugfixes
--------

- Fix the *MAU Limits* section of the Grafana dashboard relying on a specific `job` name for the workers of a Synapse deployment. ([\#14644]([matrix-org/synapse#14644](https://github.com/matrix-org/synapse/pull/14644)))
- Fix a bug introduced in Synapse 1.70.0 which could cause spurious `UNIQUE constraint failed` errors in the `rotate_notifs` background job. ([\#14669]([matrix-org/synapse#14669](https://github.com/matrix-org/synapse/pull/14669)))
- Ensure stream IDs are always updated after caches get invalidated with workers. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\#14723]([matrix-org/synapse#14723](https://github.com/matrix-org/synapse/pull/14723)))
- Remove the unspecced `device` field from `/pushrules` responses. ([\#14727]([matrix-org/synapse#14727](https://github.com/matrix-org/synapse/pull/14727)))
- Fix a bug introduced in Synapse 1.73.0 where the `picture_claim` configured under `oidc_providers` was unused (the default value of `"picture"` was used instead). ([\#14751]([matrix-org/synapse#14751](https://github.com/matrix-org/synapse/pull/14751)))
- Unescape HTML entities in URL preview titles making use of oEmbed responses. ([\#14781]([matrix-org/synapse#14781](https://github.com/matrix-org/synapse/pull/14781)))
- Disable sending confirmation email when 3pid is disabled. ([\#14725]([matrix-org/synapse#14725](https://github.com/matrix-org/synapse/pull/14725)))

Improved Documentation
----------------------

- Declare support for Python 3.11. ([\#14673]([matrix-org/synapse#14673](https://github.com/matrix-org/synapse/pull/14673)))
- Fix `target_memory_usage` being used in the description for the actual `cache_autotune` sub-option `target_cache_memory_usage`. ([\#14674]([matrix-org/synapse#14674](https://github.com/matrix-org/synapse/pull/14674)))
- Move `email` to Server section in config file documentation. ([\#14730]([matrix-org/synapse#14730](https://github.com/matrix-org/synapse/pull/14730)))
- Fix broken links in the Synapse documentation. ([\#14744]([matrix-org/synapse#14744](https://github.com/matrix-org/synapse/pull/14744)))
- Add missing worker settings to shared configuration documentation. ([\#14748]([matrix-org/synapse#14748](https://github.com/matrix-org/synapse/pull/14748)))
- Document using Twitter as a OAuth 2.0 authentication provider. ([\#14778]([matrix-org/synapse#14778](https://github.com/matrix-org/synapse/pull/14778)))
- Fix Synapse 1.74 upgrade notes to correctly explain how to install pyICU when installing Synapse from PyPI. ([\#14797]([matrix-org/synapse#14797](https://github.com/matrix-org/synapse/pull/14797)))
- Update link to towncrier in contribution guide. ([\#14801]([matrix-org/synapse#14801](https://github.com/matrix-org/synapse/pull/14801)))
- Use `htmltest` to check links in the Synapse documentation. ([\#14743]([matrix-org/synapse#14743](https://github.com/matrix-org/synapse/pull/14743)))

Internal Changes
----------------

- Faster remote room joins: stream the un-partial-stating of events over replication. ([\#14545]([matrix-org/synapse#14545](https://github.com/matrix-org/synapse/pull/14545)), [\#14546]([matrix-org/synapse#14546](https://github.com/matrix-org/synapse/pull/14546)))
- Use [ruff](<https://github.com/charliermarsh/ruff/>) instead of flake8. ([\#14633]([matrix-org/synapse#14633](https://github.com/matrix-org/synapse/pull/14633)), [\#14741]([matrix-org/synapse#14741](https://github.com/matrix-org/synapse/pull/14741)))
- Change `handle_new_client_event` signature so that a 429 does not reach clients on `PartialStateConflictError`, and internally retry when needed instead. ([\#14665]([matrix-org/synapse#14665](https://github.com/matrix-org/synapse/pull/14665)))
- Remove dependency on jQuery on reCAPTCHA page. ([\#14672]([matrix-org/synapse#14672](https://github.com/matrix-org/synapse/pull/14672)))
- Faster joins: make `compute_state_after_events` consistent with other state-fetching functions that take a `StateFilter`. ([\#14676]([matrix-org/synapse#14676](https://github.com/matrix-org/synapse/pull/14676)))
- Add missing type hints. ([\#14680]([matrix-org/synapse#14680](https://github.com/matrix-org/synapse/pull/14680)), [\#14681]([matrix-org/synapse#14681](https://github.com/matrix-org/synapse/pull/14681)), [\#14687]([matrix-org/synapse#14687](https://github.com/matrix-org/synapse/pull/14687)))
- Improve type annotations for the helper methods on a `CachedFunction`. ([\#14685]([matrix-org/synapse#14685](https://github.com/matrix-org/synapse/pull/14685)))
- Check that the SQLite database file exists before porting to PostgreSQL. ([\#14692]([matrix-org/synapse#14692](https://github.com/matrix-org/synapse/pull/14692)))
- Add `.direnv/` directory to .gitignore to prevent local state generated by the [direnv](<https://direnv.net/>) development tool from being committed. ([\#14707]([matrix-org/synapse#14707](https://github.com/matrix-org/synapse/pull/14707)))
- Batch up replication requests to request the resyncing of remote users's devices. ([\#14716]([matrix-org/synapse#14716](https://github.com/matrix-org/synapse/pull/14716)))
- If debug logging is enabled, log the `msgid`s of any to-device messages that are returned over `/sync`. ([\#14724]([matrix-org/synapse#14724](https://github.com/matrix-org/synapse/pull/14724)))
- Change GHA CI job to follow best practices. ([\#14772]([matrix-org/synapse#14772](https://github.com/matrix-org/synapse/pull/14772)))
- Switch to our fork of `dh-virtualenv` to work around an upstream Python 3.11 incompatibility. ([\#14774]([matrix-org/synapse#14774](https://github.com/matrix-org/synapse/pull/14774)))
- Skip testing built wheels for PyPy 3.7 on Linux x86_64 as we lack new required dependencies in the build environment. ([\#14802]([matrix-org/synapse#14802](https://github.com/matrix-org/synapse/pull/14802)))

### Dependabot updates

<details>

- Bump JasonEtco/create-an-issue from 2.8.1 to 2.8.2. ([\#14693]([matrix-org/synapse#14693](https://github.com/matrix-org/synapse/pull/14693)))
- Bump anyhow from 1.0.66 to 1.0.68. ([\#14694]([matrix-org/synapse#14694](https://github.com/matrix-org/synapse/pull/14694)))
- Bump blake2 from 0.10.5 to 0.10.6. ([\#14695]([matrix-org/synapse#14695](https://github.com/matrix-org/synapse/pull/14695)))
- Bump serde_json from 1.0.89 to 1.0.91. ([\#14696]([matrix-org/synapse#14696](https://github.com/matrix-org/synapse/pull/14696)))
- Bump serde from 1.0.150 to 1.0.151. ([\#14697]([matrix-org/synapse#14697](https://github.com/matrix-org/synapse/pull/14697)))
- Bump lxml from 4.9.1 to 4.9.2. ([\#14698]([matrix-org/synapse#14698](https://github.com/matrix-org/synapse/pull/14698)))
- Bump types-jsonschema from 4.17.0.1 to 4.17.0.2. ([\#14700]([matrix-org/synapse#14700](https://github.com/matrix-org/synapse/pull/14700)))
- Bump sentry-sdk from 1.11.1 to 1.12.0. ([\#14701]([matrix-org/synapse#14701](https://github.com/matrix-org/synapse/pull/14701)))
- Bump types-setuptools from 65.6.0.1 to 65.6.0.2. ([\#14702]([matrix-org/synapse#14702](https://github.com/matrix-org/synapse/pull/14702)))
- Bump minimum PyYAML to 3.13. ([\#14720]([matrix-org/synapse#14720](https://github.com/matrix-org/synapse/pull/14720)))
- Bump JasonEtco/create-an-issue from 2.8.2 to 2.9.1. ([\#14731]([matrix-org/synapse#14731](https://github.com/matrix-org/synapse/pull/14731)))
- Bump towncrier from 22.8.0 to 22.12.0. ([\#14732]([matrix-org/synapse#14732](https://github.com/matrix-org/synapse/pull/14732)))
- Bump isort from 5.10.1 to 5.11.4. ([\#14733]([matrix-org/synapse#14733](https://github.com/matrix-org/synapse/pull/14733)))
- Bump attrs from 22.1.0 to 22.2.0. ([\#14734]([matrix-org/synapse#14734](https://github.com/matrix-org/synapse/pull/14734)))
- Bump black from 22.10.0 to 22.12.0. ([\#14735]([matrix-org/synapse#14735](https://github.com/matrix-org/synapse/pull/14735)))
- Bump sentry-sdk from 1.12.0 to 1.12.1. ([\#14736]([matrix-org/synapse#14736](https://github.com/matrix-org/synapse/pull/14736)))
- Bump setuptools from 65.3.0 to 65.5.1. ([\#14738]([matrix-org/synapse#14738](https://github.com/matrix-org/synapse/pull/14738)))
- Bump serde from 1.0.151 to 1.0.152. ([\#14758]([matrix-org/synapse#14758](https://github.com/matrix-org/synapse/pull/14758)))
- Bump ruff from 0.0.189 to 0.0.206. ([\#14759]([matrix-org/synapse#14759](https://github.com/matrix-org/synapse/pull/14759)))
- Bump pydantic from 1.10.2 to 1.10.4. ([\#14760]([matrix-org/synapse#14760](https://github.com/matrix-org/synapse/pull/14760)))
- Bump gitpython from 3.1.29 to 3.1.30. ([\#14761]([matrix-org/synapse#14761](https://github.com/matrix-org/synapse/pull/14761)))
- Bump pillow from 9.3.0 to 9.4.0. ([\#14762]([matrix-org/synapse#14762](https://github.com/matrix-org/synapse/pull/14762)))
- Bump types-requests from 2.28.11.5 to 2.28.11.7. ([\#14763]([matrix-org/synapse#14763](https://github.com/matrix-org/synapse/pull/14763)))
- Bump dawidd6/action-download-artifact from 2.24.2 to 2.24.3. ([\#14779]([matrix-org/synapse#14779](https://github.com/matrix-org/synapse/pull/14779)))
- Bump peaceiris/actions-gh-pages from 3.9.0 to 3.9.1. ([\#14791]([matrix-org/synapse#14791](https://github.com/matrix-org/synapse/pull/14791)))
- Bump types-pillow from 9.3.0.4 to 9.4.0.0. ([\#14792]([matrix-org/synapse#14792](https://github.com/matrix-org/synapse/pull/14792)))
- Bump pyopenssl from 22.1.0 to 23.0.0. ([\#14793]([matrix-org/synapse#14793](https://github.com/matrix-org/synapse/pull/14793)))
- Bump types-setuptools from 65.6.0.2 to 65.6.0.3. ([\#14794]([matrix-org/synapse#14794](https://github.com/matrix-org/synapse/pull/14794)))
- Bump importlib-metadata from 4.2.0 to 6.0.0. ([\#14795]([matrix-org/synapse#14795](https://github.com/matrix-org/synapse/pull/14795)))
- Bump ruff from 0.0.206 to 0.0.215. ([\#14796]([matrix-org/synapse#14796](https://github.com/matrix-org/synapse/pull/14796)))
</details>

Synapse 1.74.0 (2022-12-20)
===========================

Improved Documentation
----------------------

- Add release note and update documentation regarding optional ICU support in user search. ([\#14712]([matrix-org/synapse#14712](https://github.com/matrix-org/synapse/pull/14712)))

Synapse 1.74.0rc1 (2022-12-13)
==============================

Features
--------

- Improve user search for international display names. ([\#14464]([matrix-org/synapse#14464](https://github.com/matrix-org/synapse/pull/14464)))
- Stop using deprecated `keyIds` parameter when calling `/_matrix/key/v2/server`. ([\#14490]([matrix-org/synapse#14490](https://github.com/matrix-org/synapse/pull/14490)), [\#14525]([matrix-org/synapse#14525](https://github.com/matrix-org/synapse/pull/14525)))
- Add new `push.enabled` config option to allow opting out of push notification calculation. ([\#14551]([matrix-org/synapse#14551](https://github.com/matrix-org/synapse/pull/14551)), [\#14619]([matrix-org/synapse#14619](https://github.com/matrix-org/synapse/pull/14619)))
- Advertise support for Matrix 1.5 on `/_matrix/client/versions`. ([\#14576]([matrix-org/synapse#14576](https://github.com/matrix-org/synapse/pull/14576)))
- Improve opentracing and logging for to-device message handling. ([\#14598]([matrix-org/synapse#14598](https://github.com/matrix-org/synapse/pull/14598)))
- Allow selecting "prejoin" events by state keys in addition to event types. ([\#14642]([matrix-org/synapse#14642](https://github.com/matrix-org/synapse/pull/14642)))

Bugfixes
--------

- Fix a long-standing bug where a device list update might not be sent to clients in certain circumstances. ([\#14435]([matrix-org/synapse#14435](https://github.com/matrix-org/synapse/pull/14435)), [\#14592]([matrix-org/synapse#14592](https://github.com/matrix-org/synapse/pull/14592)), [\#14604]([matrix-org/synapse#14604](https://github.com/matrix-org/synapse/pull/14604)))
- Suppress a spurious warning when `POST /rooms/<room_id>/<membership>/`, `POST /join/<room_id_or_alias`, or the unspecced `PUT /join/<room_id_or_alias>/<txn_id>` receive an empty HTTP request body. ([\#14600]([matrix-org/synapse#14600](https://github.com/matrix-org/synapse/pull/14600)))
- Return spec-compliant JSON errors when unknown endpoints are requested. ([\#14620]([matrix-org/synapse#14620](https://github.com/matrix-org/synapse/pull/14620)), [\#14621]([matrix-org/synapse#14621](https://github.com/matrix-org/synapse/pull/14621)))
- Update html templates to load images over HTTPS. Contributed by [@ashfame](https://github.com/ashfame). ([\#14625]([matrix-org/synapse#14625](https://github.com/matrix-org/synapse/pull/14625)))
- Fix a long-standing bug where the user directory would return 1 more row than requested. ([\#14631]([matrix-org/synapse#14631](https://github.com/matrix-org/synapse/pull/14631)))
- Reject invalid read receipt requests with empty room or event IDs. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\#14632]([matrix-org/synapse#14632](https://github.com/matrix-org/synapse/pull/14632)))
- Fix a bug introduced in Synapse 1.67.0 where not specifying a config file or a server URL would lead to the `register_new_matrix_user` script failing. ([\#14637]([matrix-org/synapse#14637](https://github.com/matrix-org/synapse/pull/14637)))
- Fix a long-standing bug where the user directory and room/user stats might be out of sync. ([\#14639]([matrix-org/synapse#14639](https://github.com/matrix-org/synapse/pull/14639)), [\#14643]([matrix-org/synapse#14643](https://github.com/matrix-org/synapse/pull/14643)))
- Fix a bug introduced in Synapse 1.72.0 where the background updates to add non-thread unique indexes on receipts would fail if they were previously interrupted. ([\#14650]([matrix-org/synapse#14650](https://github.com/matrix-org/synapse/pull/14650)))
- Improve validation of field size limits in events. ([\#14664]([matrix-org/synapse#14664](https://github.com/matrix-org/synapse/pull/14664)))
- Fix bugs introduced in Synapse 1.55.0 and 1.69.0 where application services would not be notified of events in the correct rooms, due to stale caches. ([\#14670]([matrix-org/synapse#14670](https://github.com/matrix-org/synapse/pull/14670)))

Improved Documentation
----------------------

- Update worker settings for `pusher` and `federation_sender` functionality. ([\#14493]([matrix-org/synapse#14493](https://github.com/matrix-org/synapse/pull/14493)))
- Add links to third party package repositories, and point to the bug which highlights Ubuntu's out-of-date packages. ([\#14517]([matrix-org/synapse#14517](https://github.com/matrix-org/synapse/pull/14517)))
- Remove old, incorrect minimum postgres version note and replace with a link to the [Dependency Deprecation Policy](<https://matrix-org.github.io/synapse/v1.73/deprecation_policy.html>). ([\#14590]([matrix-org/synapse#14590](https://github.com/matrix-org/synapse/pull/14590)))
- Add Single-Sign On setup instructions for Mastodon-based instances. ([\#14594]([matrix-org/synapse#14594](https://github.com/matrix-org/synapse/pull/14594)))
- Change `turn_allow_guests` example value to lowercase `true`. ([\#14634]([matrix-org/synapse#14634](https://github.com/matrix-org/synapse/pull/14634)))

Internal Changes
----------------

- Optimise push badge count calculations. Contributed by Nick @ Beeper ([@Fizzadar](https://github.com/Fizzadar)). ([\#14255]([matrix-org/synapse#14255](https://github.com/matrix-org/synapse/pull/14255)))
- Faster remote room joins: stream the un-partial-stating of rooms over replication. ([\#14473]([matrix-org/synapse#14473](https://github.com/matrix-org/synapse/pull/14473)), [\#14474]([matrix-org/synapse#14474](https://github.com/matrix-org/synapse/pull/14474)))
- Share the `ClientRestResource` for both workers and the main process. ([\#14528]([matrix-org/synapse#14528](https://github.com/matrix-org/synapse/pull/14528)))
- Add `--editable` flag to `complement.sh` which uses an editable install of Synapse for faster turn-around times whilst developing iteratively. ([\#14548]([matrix-org/synapse#14548](https://github.com/matrix-org/synapse/pull/14548)))
- Faster joins: use servers list approximation to send read receipts when in partial state instead of waiting for the full state of the room. ([\#14549]([matrix-org/synapse#14549](https://github.com/matrix-org/synapse/pull/14549)))
- Modernize unit tests configuration related to workers. ([\#14568]([matrix-org/synapse#14568](https://github.com/matrix-org/synapse/pull/14568)))
- Bump jsonschema from 4.17.0 to 4.17.3. ([\#14591]([matrix-org/synapse#14591](https://github.com/matrix-org/synapse/pull/14591)))
- Fix Rust lint CI. ([\#14602]([matrix-org/synapse#14602](https://github.com/matrix-org/synapse/pull/14602)))
- Bump JasonEtco/create-an-issue from 2.5.0 to 2.8.1. ([\#14607]([matrix-org/synapse#14607](https://github.com/matrix-org/synapse/pull/14607)))
- Alter some unit test environment parameters to decrease time spent running tests. ([\#14610]([matrix-org/synapse#14610](https://github.com/matrix-org/synapse/pull/14610)))
- Switch to Go recommended installation method for `gotestfmt` template in CI. ([\#14611]([matrix-org/synapse#14611](https://github.com/matrix-org/synapse/pull/14611)))
- Bump phonenumbers from 8.13.0 to 8.13.1. ([\#14612]([matrix-org/synapse#14612](https://github.com/matrix-org/synapse/pull/14612)))
- Bump types-setuptools from 65.5.0.3 to 65.6.0.1. ([\#14613]([matrix-org/synapse#14613](https://github.com/matrix-org/synapse/pull/14613)))
- Bump twine from 4.0.1 to 4.0.2. ([\#14614]([matrix-org/synapse#14614](https://github.com/matrix-org/synapse/pull/14614)))
- Bump types-requests from 2.28.11.2 to 2.28.11.5. ([\#14615]([matrix-org/synapse#14615](https://github.com/matrix-org/synapse/pull/14615)))
- Bump cryptography from 38.0.3 to 38.0.4. ([\#14616]([matrix-org/synapse#14616](https://github.com/matrix-org/synapse/pull/14616)))
- Remove useless cargo install with apt from Dockerfile. ([\#14636]([matrix-org/synapse#14636](https://github.com/matrix-org/synapse/pull/14636)))
- Bump certifi from 2021.10.8 to 2022.12.7. ([\#14645]([matrix-org/synapse#14645](https://github.com/matrix-org/synapse/pull/14645)))
- Bump flake8-bugbear from 22.10.27 to 22.12.6. ([\#14656]([matrix-org/synapse#14656](https://github.com/matrix-org/synapse/pull/14656)))
- Bump packaging from 21.3 to 22.0. ([\#14657]([matrix-org/synapse#14657](https://github.com/matrix-org/synapse/pull/14657)))
- Bump types-pillow from 9.3.0.1 to 9.3.0.4. ([\#14658]([matrix-org/synapse#14658](https://github.com/matrix-org/synapse/pull/14658)))
- Bump serde from 1.0.148 to 1.0.150. ([\#14659]([matrix-org/synapse#14659](https://github.com/matrix-org/synapse/pull/14659)))
- Bump phonenumbers from 8.13.1 to 8.13.2. ([\#14660]([matrix-org/synapse#14660](https://github.com/matrix-org/synapse/pull/14660)))
- Bump authlib from 1.1.0 to 1.2.0. ([\#14661]([matrix-org/synapse#14661](https://github.com/matrix-org/synapse/pull/14661)))
- Move `StateFilter` to `synapse.types`. ([\#14668]([matrix-org/synapse#14668](https://github.com/matrix-org/synapse/pull/14668)))
- Improve type hints. ([\#14597]([matrix-org/synapse#14597](https://github.com/matrix-org/synapse/pull/14597)), [\#14646]([matrix-org/synapse#14646](https://github.com/matrix-org/synapse/pull/14646)), [\#14671]([matrix-org/synapse#14671](https://github.com/matrix-org/synapse/pull/14671)))
```

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=40&u=e4bd95e56f87818fd00f434c2d66d12953e37023&v=4)](/DMRobertson)
[DMRobertson](/DMRobertson)
mentioned this pull request
[Sep 4, 2023](#ref-issue-1455762646)

[Federation was broken between my homeserver and matrix.org (and I fixed it with this patch)
#14492](/matrix-org/synapse/issues/14492)

Closed

[Sign up for free](/join?source=comment-repo)
**to subscribe to this conversation on GitHub**.
Already have an account?
[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fpull%2F14642).

Reviewers

[![@clokep](https://avatars.githubusercontent.com/u/517124?s=40&v=4)](/clokep) [clokep](/clokep)

clokep left review comments

[![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=40&v=4)](/reivilibre) [reivilibre](/reivilibre)

reivilibre approved these changes

Assignees

No one assigned

Labels

[X-Release-Blocker](/matrix-org/synapse/labels/X-Release-Blocker)
Must be resolved before making a release

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [Ability to select "prejoin" events by state keys](https://github.com/matrix-org/synapse/issues/14640)

3 participants

[![@DMRobertson](https://avatars.githubusercontent.com/u/8614563?s=52&v=4)](/DMRobertson) [![@reivilibre](https://avatars.githubusercontent.com/u/38398653?s=52&v=4)](/reivilibre) [![@clokep](https://avatars.githubusercontent.com/u/517124?s=52&v=4)](/clokep)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canât perform that action at this time.



=== Content from lists.fedoraproject.org_1f0187fc_20250115_092140.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

Ã
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD.mbox.gz?message=UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD/#UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD)

# [SECURITY] Fedora 37 Update: python-matrix-common-1.3.0-7.fc37

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updatesï¼ fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updatesï¼ fedoraproject.org")

17 Sep
2023

17 Sep
'23

9:37 p.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2023-c0696d7b53
2023-09-18 01:37:07.642300
--------------------------------------------------------------------------------

Name : python-matrix-common
Product : Fedora 37
Version : 1.3.0
Release : 7.fc37
URL : <https://github.com/matrix-org/matrix-python-common>
Summary : Common utilities for Synapse, Sydent and Sygnal
Description :
Common utilities for Synapse, Sydent and Sygnal.

--------------------------------------------------------------------------------
Update Information:

Update matrix-synapse to v1.80.0 to fix CVE-2022-39374, CVE-2023-32323
--------------------------------------------------------------------------------
ChangeLog:

\* Sun Aug 20 2023 Kai A. Hiller V02460@gmail.com - 1.3.0-7
- SPDX migration
\* Sun Aug 20 2023 Kai A. Hiller V02460@gmail.com - 1.3.0-6
- Inline %{srcname}
\* Fri Jul 21 2023 Fedora Release Engineering releng@fedoraproject.org - 1.3.0-4
- Rebuilt for <https://fedoraproject.org/wiki/Fedora_39_Mass_Rebuild>
\* Wed Jun 28 2023 Python Maint python-maint@redhat.com - 1.3.0-3
- Rebuilt for Python 3.12
\* Fri Jan 20 2023 Fedora Release Engineering releng@fedoraproject.org - 1.3.0-2
- Rebuilt for <https://fedoraproject.org/wiki/Fedora_38_Mass_Rebuild>
\* Mon Oct 10 2022 Kai A. Hiller V02460@gmail.com - 1.3.0-1
- Update to v1.3.0
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #2209956 - CVE-2022-39374 matrix-synapse: Synapse Denial of service due to incorrect application of event authorization rules during state resolution
<https://bugzilla.redhat.com/show_bug.cgi?id=2209956>
[ 2 ] Bug #2209958 - CVE-2023-32323 matrix-synapse: Synapse Outgoing federation to specific hosts can be disabled by sending malicious invites
<https://bugzilla.redhat.com/show_bug.cgi?id=2209958>
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2023-c0696d7b53' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD/#UJIJRP5ZH6B3KGFLHCAKR2IX2Y4Z25QD)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.


