=== Content from github.com_a2be029e_20250114_215308.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspotify%2Fluigi%2Fissues%2F3301)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspotify%2Fluigi%2Fissues%2F3301)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=spotify%2Fluigi)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[spotify](/spotify)
/
**[luigi](/spotify/luigi)**
Public

* [Notifications](/login?return_to=%2Fspotify%2Fluigi) You must be signed in to change notification settings
* [Fork
  2.4k](/login?return_to=%2Fspotify%2Fluigi)
* [Star
   18k](/login?return_to=%2Fspotify%2Fluigi)

* [Code](/spotify/luigi)
* [Issues
  108](/spotify/luigi/issues)
* [Pull requests
  29](/spotify/luigi/pulls)
* [Actions](/spotify/luigi/actions)
* [Projects
  0](/spotify/luigi/projects)
* [Security](/spotify/luigi/security)
* [Insights](/spotify/luigi/pulse)

Additional navigation options

* [Code](/spotify/luigi)
* [Issues](/spotify/luigi/issues)
* [Pull requests](/spotify/luigi/pulls)
* [Actions](/spotify/luigi/actions)
* [Projects](/spotify/luigi/projects)
* [Security](/spotify/luigi/security)
* [Insights](/spotify/luigi/pulse)

# Arbitrary file write during tarfile extraction in `luigi/contrib/sge_runner.py`¬†#3301

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Arbitrary file write during tarfile extraction in `luigi/contrib/sge_runner.py`](#top)#3301Copy link![@Ali-Razmjoo](https://avatars.githubusercontent.com/u/7676267?u=345e0b69bae7359ac98e46c642b9a1257b5b6cfc&v=4&size=80)
## Description

![@Ali-Razmjoo](https://avatars.githubusercontent.com/u/7676267?u=345e0b69bae7359ac98e46c642b9a1257b5b6cfc&v=4&size=48)[Ali-Razmjoo](https://github.com/Ali-Razmjoo)opened [on Aug 24, 2024](https://github.com/spotify/luigi/issues/3301#issue-2484512603)

Hi,

I am reporting a potential security issue with arbitrary file write during tarfile extraction in

<https://github.com/spotify/luigi/blob/master/luigi/contrib/sge_runner.py#L67-L70>

Extracting files from a malicious tar archive without validating that the destination file path is within the destination directory can cause files outside the destination directory to be overwritten, due to the possible presence of directory traversal elements (..) in archive paths.

* `..\malicious_file`
* `c:\malicious_file`
* `/etc/passwd`

## Recommendation

```
with tarfile.open(sys.argv[1]) as tar:
    for entry in tar:
        #GOOD: Check that entry is safe
        if os.path.isabs(entry.name) or ".." in entry.name:
            raise ValueError("Illegal tar archive entry")
        tar.extract(entry, "/tmp/unpack/")
```
## References

* Snyk: [Zip Slip Vulnerability](https://snyk.io/research/zip-slip-vulnerability)
* OWASP: [Path Traversal](https://owasp.org/www-community/attacks/Path_Traversal)
* Python Library Reference: [TarFile.extract](https://docs.python.org/3/library/tarfile.html#tarfile.TarFile.extract)
* Python Library Reference: [TarFile.extractall](https://docs.python.org/3/library/tarfile.html#tarfile.TarFile.extractall)
* Common Weakness Enumeration: [CWE-22](https://cwe.mitre.org/data/definitions/22.html)
## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_02487e90_20250114_215305.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspotify%2Fluigi%2Fcommit%2Fb5d1b965ead7d9f777a3216369b5baf23ec08999)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspotify%2Fluigi%2Fcommit%2Fb5d1b965ead7d9f777a3216369b5baf23ec08999)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=spotify%2Fluigi)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[spotify](/spotify)
/
**[luigi](/spotify/luigi)**
Public

* [Notifications](/login?return_to=%2Fspotify%2Fluigi) You must be signed in to change notification settings
* [Fork
  2.4k](/login?return_to=%2Fspotify%2Fluigi)
* [Star
   18k](/login?return_to=%2Fspotify%2Fluigi)

* [Code](/spotify/luigi)
* [Issues
  108](/spotify/luigi/issues)
* [Pull requests
  29](/spotify/luigi/pulls)
* [Actions](/spotify/luigi/actions)
* [Projects
  0](/spotify/luigi/projects)
* [Security](/spotify/luigi/security)
* [Insights](/spotify/luigi/pulse)

Additional navigation options

* [Code](/spotify/luigi)
* [Issues](/spotify/luigi/issues)
* [Pull requests](/spotify/luigi/pulls)
* [Actions](/spotify/luigi/actions)
* [Projects](/spotify/luigi/projects)
* [Security](/spotify/luigi/security)
* [Insights](/spotify/luigi/pulse)

## Commit

[Permalink](/spotify/luigi/commit/b5d1b965ead7d9f777a3216369b5baf23ec08999)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#3309](https://github.com/spotify/luigi/pull/3309) from Ali-Razmjoo/fix-tarfile-extraction

[Browse files](/spotify/luigi/tree/b5d1b965ead7d9f777a3216369b5baf23ec08999)
Browse the repository at this point in the history

```
Fix arbitrary file write during tarfile extraction in luigi/contrib/lsf_runner.py and luigi/contrib/sge_runner.py
```

* Loading branch information

[![@dlstadther](https://avatars.githubusercontent.com/u/7432199?s=40&v=4)](/dlstadther)

[dlstadther](/spotify/luigi/commits?author=dlstadther "View all commits by dlstadther")
authored
Sep 7, 2024

2 parents
[c9a0d20](/spotify/luigi/commit/c9a0d2074be5bc03008485aeeef90678f1567231)
+
[b012a00](/spotify/luigi/commit/b012a006a17ccec1c2ab5d19440a3955ecb269bb)

commit b5d1b96

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**228 additions**
and
**10 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* luigi

  + contrib

    - luigi/contrib/lsf\_runner.py
      [lsf\_runner.py](#diff-e5ef6c9d8f4fb5e1803f70eb9d6cb3e3730c685855f912db8af676822c4dc2a1)
    - luigi/contrib/sge\_runner.py
      [sge\_runner.py](#diff-28a14a43f58740fcb079da75257a7211791212a373bbffc51ff8a2701d5a8bf7)
  + luigi/safe\_extractor.py
    [safe\_extractor.py](#diff-3514a056843c45119d752414924be04eb1d65d0a6ecf92305a644d19b892d909)
* test

  + test/safe\_extractor\_test.py
    [safe\_extractor\_test.py](#diff-bff7318e074db6d3eab886bc44df8ff05b4ab952c7e354a23c336d902c9beb6a)

## There are no files selected for viewing

8 changes: 3 additions & 5 deletions

8
[luigi/contrib/lsf\_runner.py](#diff-e5ef6c9d8f4fb5e1803f70eb9d6cb3e3730c685855f912db8af676822c4dc2a1 "luigi/contrib/lsf_runner.py")

100755 ‚Üí 100644

Show comments

[View file](/spotify/luigi/blob/b5d1b965ead7d9f777a3216369b5baf23ec08999/luigi/contrib/lsf_runner.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,7 +28,7 @@ |
|  |  | except ImportError: |
|  |  | import pickle |
|  |  | import logging |
|  |  | import tarfile |
|  |  | from luigi.safe\_extractor import SafeExtractor |
|  |  |  |
|  |  |  |
|  |  | def do\_work\_on\_compute\_node(work\_dir): |
| Expand All | | @@ -52,10 +52,8 @@ def extract\_packages\_archive(work\_dir): |
|  |  | curdir = os.path.abspath(os.curdir) |
|  |  |  |
|  |  | os.chdir(work\_dir) |
|  |  | tar = tarfile.open(package\_file) |
|  |  | for tarinfo in tar: |
|  |  | tar.extract(tarinfo) |
|  |  | tar.close() |
|  |  | extractor = SafeExtractor(work\_dir) |
|  |  | extractor.safe\_extract(package\_file) |
|  |  | if '' not in sys.path: |
|  |  | sys.path.insert(0, '') |
|  |  |  |
| Expand Down | |  |

8 changes: 3 additions & 5 deletions

8
[luigi/contrib/sge\_runner.py](#diff-28a14a43f58740fcb079da75257a7211791212a373bbffc51ff8a2701d5a8bf7 "luigi/contrib/sge_runner.py")

Show comments

[View file](/spotify/luigi/blob/b5d1b965ead7d9f777a3216369b5baf23ec08999/luigi/contrib/sge_runner.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -36,7 +36,7 @@ |
|  |  | import sys |
|  |  | import pickle |
|  |  | import logging |
|  |  | import tarfile |
|  |  | from luigi.safe\_extractor import SafeExtractor |
|  |  |  |
|  |  |  |
|  |  | def \_do\_work\_on\_compute\_node(work\_dir, tarball=True): |
| Expand Down  Expand Up | | @@ -64,10 +64,8 @@ def \_extract\_packages\_archive(work\_dir): |
|  |  | curdir = os.path.abspath(os.curdir) |
|  |  |  |
|  |  | os.chdir(work\_dir) |
|  |  | tar = tarfile.open(package\_file) |
|  |  | for tarinfo in tar: |
|  |  | tar.extract(tarinfo) |
|  |  | tar.close() |
|  |  | extractor = SafeExtractor(work\_dir) |
|  |  | extractor.safe\_extract(package\_file) |
|  |  | if '' not in sys.path: |
|  |  | sys.path.insert(0, '') |
|  |  |  |
| Expand Down | |  |

97 changes: 97 additions & 0 deletions

97
[luigi/safe\_extractor.py](#diff-3514a056843c45119d752414924be04eb1d65d0a6ecf92305a644d19b892d909 "luigi/safe_extractor.py")

Show comments

[View file](/spotify/luigi/blob/b5d1b965ead7d9f777a3216369b5baf23ec08999/luigi/safe_extractor.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,97 @@ |
|  |  | # -\*- coding: utf-8 -\*- |
|  |  | # |
|  |  | # Copyright 2012-2015 Spotify AB |
|  |  | # |
|  |  | # Licensed under the Apache License, Version 2.0 (the "License"); |
|  |  | # you may not use this file except in compliance with the License. |
|  |  | # You may obtain a copy of the License at |
|  |  | # |
|  |  | # http://www.apache.org/licenses/LICENSE-2.0 |
|  |  | # |
|  |  | # Unless required by applicable law or agreed to in writing, software |
|  |  | # distributed under the License is distributed on an "AS IS" BASIS, |
|  |  | # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. |
|  |  | # See the License for the specific language governing permissions and |
|  |  | # limitations under the License. |
|  |  | # |
|  |  |  |
|  |  | """ |
|  |  | This module provides a class `SafeExtractor` that offers a secure way to extract tar files while |
|  |  | mitigating path traversal vulnerabilities, which can occur when files inside the archive are |
|  |  | crafted to escape the intended extraction directory. |
|  |  |  |
|  |  | The `SafeExtractor` ensures that the extracted file paths are validated before extraction to |
|  |  | prevent malicious archives from extracting files outside the intended directory. |
|  |  |  |
|  |  | Classes: |
|  |  | SafeExtractor: A class to securely extract tar files with protection against path traversal attacks. |
|  |  |  |
|  |  | Usage Example: |
|  |  | extractor = SafeExtractor("/desired/directory") |
|  |  | extractor.safe\_extract("archive.tar") |
|  |  | """ |
|  |  |  |
|  |  | import os |
|  |  | import tarfile |
|  |  |  |
|  |  |  |
|  |  | class SafeExtractor: |
|  |  | """ |
|  |  | A class to safely extract tar files, ensuring that no path traversal |
|  |  | vulnerabilities are exploited. |
|  |  |  |
|  |  | Attributes: |
|  |  | path (str): The directory to extract files into. |
|  |  |  |
|  |  | Methods: |
|  |  | \_is\_within\_directory(directory, target): |
|  |  | Checks if a target path is within a given directory. |
|  |  |  |
|  |  | safe\_extract(tar\_path, members=None, \\\*, numeric\_owner=False): |
|  |  | Safely extracts the contents of a tar file to the specified directory. |
|  |  | """ |
|  |  |  |
|  |  | def \_\_init\_\_(self, path="."): |
|  |  | """ |
|  |  | Initializes the SafeExtractor with the specified directory path. |
|  |  |  |
|  |  | Args: |
|  |  | path (str): The directory to extract files into. Defaults to the current directory. |
|  |  | """ |
|  |  | self.path = path |
|  |  |  |
|  |  | @staticmethod |
|  |  | def \_is\_within\_directory(directory, target): |
|  |  | """ |
|  |  | Checks if a target path is within a given directory. |
|  |  |  |
|  |  | Args: |
|  |  | directory (str): The directory to check against. |
|  |  | target (str): The target path to check. |
|  |  |  |
|  |  | Returns: |
|  |  | bool: True if the target path is within the directory, False otherwise. |
|  |  | """ |
|  |  | abs\_directory = os.path.abspath(directory) |
|  |  | abs\_target = os.path.abspath(target) |
|  |  | prefix = os.path.commonprefix([abs\_directory, abs\_target]) |
|  |  | return prefix == abs\_directory |
|  |  |  |
|  |  | def safe\_extract(self, tar\_path, members=None, \*, numeric\_owner=False): |
|  |  | """ |
|  |  | Safely extracts the contents of a tar file to the specified directory. |
|  |  |  |
|  |  | Args: |
|  |  | tar\_path (str): The path to the tar file to extract. |
|  |  | members (list, optional): A list of members to extract. Defaults to None. |
|  |  | numeric\_owner (bool, optional): If True, only the numeric owner will be used. Defaults to False. |
|  |  |  |
|  |  | Raises: |
|  |  | RuntimeError: If a path traversal attempt is detected. |
|  |  | """ |
|  |  | with tarfile.open(tar\_path, 'r') as tar: |
|  |  | for member in tar.getmembers(): |
|  |  | member\_path = os.path.join(self.path, member.name) |
|  |  | if not self.\_is\_within\_directory(self.path, member\_path): |
|  |  | raise RuntimeError("Attempted Path Traversal in Tar File") |
|  |  | tar.extractall(self.path, members, numeric\_owner=numeric\_owner) |

125 changes: 125 additions & 0 deletions

125
[test/safe\_extractor\_test.py](#diff-bff7318e074db6d3eab886bc44df8ff05b4ab952c7e354a23c336d902c9beb6a "test/safe_extractor_test.py")

Show comments

[View file](/spotify/luigi/blob/b5d1b965ead7d9f777a3216369b5baf23ec08999/test/safe_extractor_test.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,125 @@ |
|  |  | # -\*- coding: utf-8 -\*- |
|  |  | # |
|  |  | # Copyright 2012-2015 Spotify AB |
|  |  | # |
|  |  | # Licensed under the Apache License, Version 2.0 (the "License"); |
|  |  | # you may not use this file except in compliance with the License. |
|  |  | # You may obtain a copy of the License at |
|  |  | # |
|  |  | # http://www.apache.org/licenses/LICENSE-2.0 |
|  |  | # |
|  |  | # Unless required by applicable law or agreed to in writing, software |
|  |  | # distributed under the License is distributed on an "AS IS" BASIS, |
|  |  | # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. |
|  |  | # See the License for the specific language governing permissions and |
|  |  | # limitations under the License. |
|  |  | # |
|  |  |  |
|  |  | """ |
|  |  | Safe Extractor Test |
|  |  | ============= |
|  |  |  |
|  |  | Tests for the Safe Extractor class in luigi.safe\_extractor module. |
|  |  | """ |
|  |  |  |
|  |  | import os |
|  |  | import shutil |
|  |  | import tarfile |
|  |  | import tempfile |
|  |  | import unittest |
|  |  |  |
|  |  | from luigi.safe\_extractor import SafeExtractor |
|  |  |  |
|  |  |  |
|  |  | class TestSafeExtract(unittest.TestCase): |
|  |  | """ |
|  |  | Unit test class for testing the SafeExtractor module. |
|  |  | """ |
|  |  |  |
|  |  | def setUp(self): |
|  |  | """Set up a temporary directory for test files.""" |
|  |  | self.temp\_dir = tempfile.mkdtemp() |
|  |  | self.test\_file\_template = 'test\_file\_{}.txt' |
|  |  | self.tar\_file\_name = 'test.tar' |
|  |  | self.tar\_file\_name\_with\_traversal = f'traversal\_{self.tar\_file\_name}' |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | """Clean up the temporary directory after each test.""" |
|  |  | shutil.rmtree(self.temp\_dir) |
|  |  |  |
|  |  | def create\_test\_tar(self, tar\_path, file\_count=1, with\_traversal=False): |
|  |  | """ |
|  |  | Create a tar file containing test files. |
|  |  |  |
|  |  | Args: |
|  |  | tar\_path (str): Path where the tar file will be created. |
|  |  | file\_count (int): Number of test files to include. |
|  |  | with\_traversal (bool): If True, creates a tar file with path traversal vulnerability. |
|  |  | """ |
|  |  | # Default content for the test files |
|  |  | file\_contents = [f'This is {self.test\_file\_template.format(i)}' for i in range(file\_count)] |
|  |  |  |
|  |  | with tarfile.open(tar\_path, 'w') as tar: |
|  |  | for i in range(file\_count): |
|  |  | file\_name = self.test\_file\_template.format(i) |
|  |  | file\_path = os.path.join(self.temp\_dir, file\_name) |
|  |  |  |
|  |  | # Write content to each test file |
|  |  | with open(file\_path, 'w') as f: |
|  |  | f.write(file\_contents[i]) |
|  |  |  |
|  |  | # If path traversal is enabled, create malicious paths |
|  |  | archive\_name = f'../../{file\_name}' if with\_traversal else file\_name |
|  |  |  |
|  |  | # Add the file to the tar archive |
|  |  | tar.add(file\_path, arcname=archive\_name) |
|  |  |  |
|  |  | def verify\_extracted\_files(self, file\_count): |
|  |  | """ |
|  |  | Verify that the correct files were extracted and their contents match expectations. |
|  |  |  |
|  |  | Args: |
|  |  | file\_count (int): Number of files to verify. |
|  |  | """ |
|  |  | for i in range(file\_count): |
|  |  | file\_name = self.test\_file\_template.format(i) |
|  |  | file\_path = os.path.join(self.temp\_dir, file\_name) |
|  |  |  |
|  |  | # Check if the file exists |
|  |  | self.assertTrue(os.path.exists(file\_path), f"File {file\_name} does not exist.") |
|  |  |  |
|  |  | # Check if the file content is correct |
|  |  | with open(file\_path, 'r') as f: |
|  |  | content = f.read() |
|  |  | expected\_content = f'This is {file\_name}' |
|  |  | self.assertEqual(content, expected\_content, f"Content mismatch in {file\_name}.") |
|  |  |  |
|  |  | def test\_safe\_extract(self): |
|  |  | """Test normal safe extraction of tar files.""" |
|  |  | tar\_path = os.path.join(self.temp\_dir, self.tar\_file\_name) |
|  |  |  |
|  |  | # Create a tar file with 3 files |
|  |  | self.create\_test\_tar(tar\_path, file\_count=3) |
|  |  |  |
|  |  | # Initialize SafeExtractor and perform extraction |
|  |  | extractor = SafeExtractor(self.temp\_dir) |
|  |  | extractor.safe\_extract(tar\_path) |
|  |  |  |
|  |  | # Verify that all 3 files were extracted correctly |
|  |  | self.verify\_extracted\_files(3) |
|  |  |  |
|  |  | def test\_safe\_extract\_with\_traversal(self): |
|  |  | """Test safe extraction for tar files with path traversal (should raise an error).""" |
|  |  | tar\_path = os.path.join(self.temp\_dir, self.tar\_file\_name\_with\_traversal) |
|  |  |  |
|  |  | # Create a tar file with a path traversal file |
|  |  | self.create\_test\_tar(tar\_path, file\_count=1, with\_traversal=True) |
|  |  |  |
|  |  | # Initialize SafeExtractor and expect RuntimeError due to path traversal |
|  |  | extractor = SafeExtractor(self.temp\_dir) |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | extractor.safe\_extract(tar\_path) |
|  |  |  |
|  |  |  |
|  |  | if \_\_name\_\_ == '\_\_main\_\_': |
|  |  | unittest.main() |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b5d1b96`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspotify%2Fluigi%2Fcommit%2Fb5d1b965ead7d9f777a3216369b5baf23ec08999) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from security.snyk.io_09461041_20250114_215314.html ===
[![Homepage](/_nuxt/header-logo.Dk_X-iWD.svg)](/)

2. [Snyk Vulnerability Database](/vuln)
3. [pip](/vuln/pip)
4. luigi
# Arbitrary File Write via Archive Extraction (Zip Slip) Affecting [luigi](/package/pip/luigi) package, versions **[,3.6.0)**

---

### Severity

 Recommended 0.0high010

CVSS assessment made by Snyk's Security Team. [Learn more](/vuln/SNYK-PYTHON-LUIGI-7830489#cvss)

### Threat Intelligence

EPSS

The probability is the direct output of the EPSS model, and conveys an overall sense of the threat of
exploitation in the wild. The percentile measures the EPSS probability relative to all known EPSS scores.
Note: This data is updated daily, relying on the latest available EPSS model version.
Check out the EPSS
[documentation](https://www.first.org/epss/articles/prob_percentile_bins)
for more details.

**0.05% (18th percentile)**
### Do your applications use this vulnerable package?

In a few clicks we can analyze your entire application and see what components are vulnerable in your application, and suggest you quick fixes.

[Test your applications](https://app.snyk.io/login?cta=sign-up&loc=banner&page=vuln-vuln)

* Snyk ID**SNYK-PYTHON-LUIGI-7830489**
* published**9 Dec 2024**
* disclosed**24 Aug 2024**
* credit**Ali Razmjoo**

[Report a new vulnerability](https://snyk.io/vulnerability-disclosure/) [Found a mistake?](https://support.snyk.io/s/contactsupport)
#### Introduced: 24 Aug 2024

[CVE-2024-21542 ¬†(opens in a new tab)](https://www.cve.org/CVERecord?id=CVE-2024-21542) Common Vulnerabilities and Exposures (CVE) are common identifiers for publicly known security vulnerabilities[CWE-29 ¬†(opens in a new tab)](https://cwe.mitre.org/data/definitions/29.html) Common Weakness Enumeration (CWE) is a category system for software weaknesses First added by Snyk
## How to fix?

Upgrade `luigi` to version 3.6.0 or higher.

## Overview

[luigi](https://pypi.org/project/luigi/) is a package that helps you build complex pipelines of batch jobs. It handles dependency resolution, workflow management, visualization, handling failures, command line integration, and much more.

Affected versions of this package are vulnerable to Arbitrary File Write via Archive Extraction (Zip Slip) due to improper destination file path validation in the `_extract_packages_archive` function.

## Details

It is exploited using a specially crafted zip archive, that holds path traversal filenames. When exploited, a filename in a malicious archive is concatenated to the target extraction directory, which results in the final path ending up outside of the target folder. For instance, a zip may hold a file with a "../../file.exe" location and thus break out of the target folder. If an executable or a configuration file is overwritten with a file containing malicious code, the problem can turn into an arbitrary code execution issue quite easily.

The following is an example of a zip archive with one benign file and one malicious file. Extracting the malicous file will result in traversing out of the target folder, ending up in `/root/.ssh/` overwriting the `authorized_keys` file:

```

+2018-04-15 22:04:29 ..... 19 19 good.txt

+2018-04-15 22:04:42 ..... 20 20 ../../../../../../root/.ssh/authorized_keys

```
## References

* [GitHub Commit](https://github.com/spotify/luigi/commit/b5d1b965ead7d9f777a3216369b5baf23ec08999)
* [GitHub Issue](https://github.com/spotify/luigi/issues/3301)
* [GitHub Release Notes](https://github.com/spotify/luigi/releases/tag/v3.6.0)
### CVSS Scores

version 4.0version 3.1
### Snyk

 Recommended 7.7¬†high

* Attack Vector (AV)

  The attack can be performed over the network.

  **Network**
* Attack Complexity (AC)

  The attack does not require special conditions.

  **Low**
* Attack Requirements (AT)

  No special requirements for the attack.

  **None**
* Privileges Required (PR)

  No privileges are required.

  **None**
* User Interaction (UI)

  No user interaction is required.

  **None**

* Confidentiality (VC)

  No impact on confidentiality.

  **None**
* Integrity (VI)

  Limited impact on integrity.

  **Low**
* Availability (VA)

  No impact on availability.

  **None**

* Confidentiality (SC)

  No impact on confidentiality.

  **None**
* Integrity (SI)

  Significant impact on integrity.

  **High**
* Availability (SA)

  No impact on availability.

  **None**
### Product

* [Snyk Open Source](https://snyk.io/product/open-source-security-management/)
* [Snyk Code](https://snyk.io/product/snyk-code/)
* [Snyk Container](https://snyk.io/product/container-vulnerability-management/)
* [Snyk Infrastructure as Code](https://snyk.io/product/infrastructure-as-code-security/)
* [Snyk AppRisk](https://snyk.io/product/snyk-apprisk/)
### Resources

* [Vulnerability DB](https://security.snyk.io/)
* [Documentation](https://docs.snyk.io/)
* [Disclosed Vulnerabilities](/disclosed-vulnerabilities)
* [Blog](https://snyk.io/blog/)
* [FAQs](https://support.snyk.io/)
### Company

* [About](https://snyk.io/about)
* [Jobs](https://snyk.io/careers/)
* Contact
* [Policies](https://snyk.io/policies/terms-of-service/)
* [Do Not Sell My Personal Information](https://preferences.snyk.io/dont_sell)
### Contact Us

* Support
* [Report a new vuln](https://snyk.io/vulnerability-disclosure)
* [Events](https://snyk.io/events)
### Find us online

### Track our development

[![DevSecOps Community Podcast](data:image/svg+xml;base64...)](https://www.devseccon.com/the-secure-developer-podcast/)

¬© 2025 Snyk Limited

Registered in England and Wales. Company number: 09677925

Registered address: Highlands House, Basingstoke Road, Spencers Wood, Reading, Berkshire, RG7 1NT.



=== Content from github.com_53239cc9_20250114_215312.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspotify%2Fluigi%2Freleases%2Ftag%2Fv3.6.0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspotify%2Fluigi%2Freleases%2Ftag%2Fv3.6.0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=spotify%2Fluigi)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[spotify](/spotify)
/
**[luigi](/spotify/luigi)**
Public

* [Notifications](/login?return_to=%2Fspotify%2Fluigi) You must be signed in to change notification settings
* [Fork
  2.4k](/login?return_to=%2Fspotify%2Fluigi)
* [Star
   18k](/login?return_to=%2Fspotify%2Fluigi)

* [Code](/spotify/luigi/tree/v3.6.0)
* [Issues
  108](/spotify/luigi/issues)
* [Pull requests
  29](/spotify/luigi/pulls)
* [Actions](/spotify/luigi/actions)
* [Projects
  0](/spotify/luigi/projects)
* [Security](/spotify/luigi/security)
* [Insights](/spotify/luigi/pulse)

Additional navigation options

* [Code](/spotify/luigi/tree/v3.6.0)
* [Issues](/spotify/luigi/issues)
* [Pull requests](/spotify/luigi/pulls)
* [Actions](/spotify/luigi/actions)
* [Projects](/spotify/luigi/projects)
* [Security](/spotify/luigi/security)
* [Insights](/spotify/luigi/pulse)

1. [Releases](/spotify/luigi/releases)
2. [v3.6.0](/spotify/luigi/releases/tag/v3.6.0)

# 3.6.0

[Latest](/spotify/luigi/releases/latest)

[Latest](/spotify/luigi/releases/latest)

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/spotify/luigi/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v3.6.0)

 Loading

[View all tags](/spotify/luigi/tags)

![@dlstadther](https://avatars.githubusercontent.com/u/7432199?s=40&v=4)
[dlstadther](/dlstadther)
released this
06 Dec 00:53

¬∑
[4 commits](/spotify/luigi/compare/v3.6.0...master)
to master
since this release

[v3.6.0](/spotify/luigi/tree/v3.6.0)

[`3d76fa2`](/spotify/luigi/commit/3d76fa24a0a86f1612720b0502c524698e52d40d)

This commit was created on GitHub.com and signed with GitHub‚Äôs **verified signature**.

GPG key ID: B5690EEEBB952194

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

## What's Changed

* Fix logging of sensitive information in pai.py by [@Ali-Razmjoo](https://github.com/Ali-Razmjoo) in [#3310](https://github.com/spotify/luigi/pull/3310)
* Fix overly permissive file permissions in luigi/lock.py by [@Ali-Razmjoo](https://github.com/Ali-Razmjoo) in [#3308](https://github.com/spotify/luigi/pull/3308)
* Fix unsafe shell command in luigi/contrib/lsf.py by [@Ali-Razmjoo](https://github.com/Ali-Razmjoo) in [#3307](https://github.com/spotify/luigi/pull/3307)
* Fix arbitrary file write during tarfile extraction in luigi/contrib/lsf\_runner.py and luigi/contrib/sge\_runner.py by [@Ali-Razmjoo](https://github.com/Ali-Razmjoo) in [#3309](https://github.com/spotify/luigi/pull/3309)
* add ChoiceListParameter by [@kitagry](https://github.com/kitagry) in [#3305](https://github.com/spotify/luigi/pull/3305)
* Implement mypy plugin for `luigi.Task` by [@hiro-o918](https://github.com/hiro-o918) in [#3315](https://github.com/spotify/luigi/pull/3315)
* /history/by\_task\_id : a method to link each task's history uniquely to the SQL database by [@tashrifbillah](https://github.com/tashrifbillah) in [#3321](https://github.com/spotify/luigi/pull/3321)
* Replace os.rename with os.replace by [@yyyyuki](https://github.com/yyyyuki) in [#3322](https://github.com/spotify/luigi/pull/3322)
* Support Dropbox root\_namespace\_id for Team Spaces by [@smrohrer](https://github.com/smrohrer) in [#3316](https://github.com/spotify/luigi/pull/3316)
* Validate str type before tuple cast by [@ikyasam18](https://github.com/ikyasam18) in [#3323](https://github.com/spotify/luigi/pull/3323)
* fix(luigi/contrib/postgres.py): replace copy\_from with copy\_expert by [@delhomer](https://github.com/delhomer) in [#3324](https://github.com/spotify/luigi/pull/3324)
* Drop Support for Python 3.5 and 3.6 by [@dlstadther](https://github.com/dlstadther) in [#3325](https://github.com/spotify/luigi/pull/3325)
* Version 3.6.0 by [@dlstadther](https://github.com/dlstadther) in [#3328](https://github.com/spotify/luigi/pull/3328)

## New Contributors

* [@Ali-Razmjoo](https://github.com/Ali-Razmjoo) made their first contribution in [#3310](https://github.com/spotify/luigi/pull/3310)
* [@yyyyuki](https://github.com/yyyyuki) made their first contribution in [#3322](https://github.com/spotify/luigi/pull/3322)
* [@ikyasam18](https://github.com/ikyasam18) made their first contribution in [#3323](https://github.com/spotify/luigi/pull/3323)
* [@delhomer](https://github.com/delhomer) made their first contribution in [#3324](https://github.com/spotify/luigi/pull/3324)

**Full Changelog**: [v3.5.2...v3.6.0](https://github.com/spotify/luigi/compare/v3.5.2...v3.6.0)

### Contributors

* [![@smrohrer](https://avatars.githubusercontent.com/u/5375262?s=64&v=4)](https://github.com/smrohrer)
* [![@dlstadther](https://avatars.githubusercontent.com/u/7432199?s=64&v=4)](https://github.com/dlstadther)
* [![@Ali-Razmjoo](https://avatars.githubusercontent.com/u/7676267?s=64&v=4)](https://github.com/Ali-Razmjoo)
* [![@delhomer](https://avatars.githubusercontent.com/u/15051098?s=64&v=4)](https://github.com/delhomer)
* [![@hiro-o918](https://avatars.githubusercontent.com/u/16137578?s=64&v=4)](https://github.com/hiro-o918)
* [![@yyyyuki](https://avatars.githubusercontent.com/u/19373240?s=64&v=4)](https://github.com/yyyyuki)
* [![@ikyasam18](https://avatars.githubusercontent.com/u/19382501?s=64&v=4)](https://github.com/ikyasam18)
* [![@kitagry](https://avatars.githubusercontent.com/u/21323222?s=64&v=4)](https://github.com/kitagry)
* [![@tashrifbillah](https://avatars.githubusercontent.com/u/35086881?s=64&v=4)](https://github.com/tashrifbillah)

smrohrer, dlstadther, and 7 other contributors

 Assets
2

 Loading

 üëç
1
 yellowbean reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

 1 person reacted

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


