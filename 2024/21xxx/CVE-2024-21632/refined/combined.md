=== Content from github.com_476888f9_20250114_194524.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsynth%2Fomniauth-microsoft_graph%2Fcommit%2Ff132078389612b797c872b45bd0e0b47382414c1)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsynth%2Fomniauth-microsoft_graph%2Fcommit%2Ff132078389612b797c872b45bd0e0b47382414c1)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=synth%2Fomniauth-microsoft_graph)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[synth](/synth)
/
**[omniauth-microsoft\_graph](/synth/omniauth-microsoft_graph)**
Public

* [Notifications](/login?return_to=%2Fsynth%2Fomniauth-microsoft_graph) You must be signed in to change notification settings
* [Fork
  62](/login?return_to=%2Fsynth%2Fomniauth-microsoft_graph)
* [Star
   39](/login?return_to=%2Fsynth%2Fomniauth-microsoft_graph)

* [Code](/synth/omniauth-microsoft_graph)
* [Issues
  0](/synth/omniauth-microsoft_graph/issues)
* [Pull requests
  2](/synth/omniauth-microsoft_graph/pulls)
* [Discussions](/synth/omniauth-microsoft_graph/discussions)
* [Actions](/synth/omniauth-microsoft_graph/actions)
* [Projects
  0](/synth/omniauth-microsoft_graph/projects)
* [Security](/synth/omniauth-microsoft_graph/security)
* [Insights](/synth/omniauth-microsoft_graph/pulse)

Additional navigation options

* [Code](/synth/omniauth-microsoft_graph)
* [Issues](/synth/omniauth-microsoft_graph/issues)
* [Pull requests](/synth/omniauth-microsoft_graph/pulls)
* [Discussions](/synth/omniauth-microsoft_graph/discussions)
* [Actions](/synth/omniauth-microsoft_graph/actions)
* [Projects](/synth/omniauth-microsoft_graph/projects)
* [Security](/synth/omniauth-microsoft_graph/security)
* [Insights](/synth/omniauth-microsoft_graph/pulse)

## Commit

[Permalink](/synth/omniauth-microsoft_graph/commit/f132078389612b797c872b45bd0e0b47382414c1)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Add email domain verification

[Browse files](/synth/omniauth-microsoft_graph/tree/f132078389612b797c872b45bd0e0b47382414c1)
Browse the repository at this point in the history

* Loading branch information

[![@dzunk](https://avatars.githubusercontent.com/u/16783036?s=40&v=4)](/dzunk)

[dzunk](/synth/omniauth-microsoft_graph/commits?author=dzunk "View all commits by dzunk")
committed
Dec 20, 2023

1 parent
[748754c](/synth/omniauth-microsoft_graph/commit/748754c128666f6935f8bb33dcbeaea66aeb0152)

commit f132078

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**230 additions**
and
**5 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* README.md
  [README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5)
* lib/omniauth

  + lib/omniauth/microsoft\_graph.rb
    [microsoft\_graph.rb](#diff-53c6b026e6a14f576a0af63a040f4acfed3bb17addf384a03dbbeb555bd04f5f)
  + microsoft\_graph

    - lib/omniauth/microsoft\_graph/domain\_verifier.rb
      [domain\_verifier.rb](#diff-19c967ffae1543aed9f6cf5c2f9bd5cf2f6f3ef17353c14983a4f0cb75ef57ba)
  + strategies

    - lib/omniauth/strategies/microsoft\_graph.rb
      [microsoft\_graph.rb](#diff-3392141da4a41d970fc6dfd5f1fffafc6e11dd5cce237edcca3eaae49baa4137)
* omniauth-microsoft\_graph.gemspec
  [omniauth-microsoft\_graph.gemspec](#diff-84547a1571d98c30c01f84bc47790c913550e79ed595f7c8be6ef2f85816f115)
* spec/omniauth

  + microsoft\_graph

    - spec/omniauth/microsoft\_graph/domain\_verifier\_spec.rb
      [domain\_verifier\_spec.rb](#diff-d8e79d451321c1ec7ea0a2c172afa45767eb50739d65caf8d0207a8c80b0ac88)
  + strategies

    - spec/omniauth/strategies/microsoft\_graph\_oauth2\_spec.rb
      [microsoft\_graph\_oauth2\_spec.rb](#diff-6555c2f9705c4b42023ecc2148285d272784647fdb164b9b83cb1dd6dd293305)

## There are no files selected for viewing

35 changes: 34 additions & 1 deletion

35
[README.md](#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5 "README.md")

Show comments

[View file](/synth/omniauth-microsoft_graph/blob/f132078389612b797c872b45bd0e0b47382414c1/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -32,10 +32,43 @@ end |
|  |  | ``` |
|  |  |  |
|  |  | #### Login Hint |
|  |  | Just add {login\_hint: "email@example.com"} to your url generation to form: |
|  |  | Just add `{login\_hint: "email@example.com"}` to your url generation to form: |
|  |  | ```ruby |
|  |  | /auth/microsoft\_graph?login\_hint=email@example.com |
|  |  | ``` |
|  |  |  |
|  |  | #### Domain Verification |
|  |  | Because Microsoft allows users to set vanity emails on their accounts, the value of the user's "email" doesn't establish membership in that domain. Put another way, user malicious@hacker.biz can edit their email in Active Directory to ceo@yourcompany.com, and (depending on your auth implementation) may be able to log in automatically as that user. |
|  |  |  |
|  |  | To establish membership in the claimed email domain, we use two strategies: |
|  |  |  |
|  |  | \* `email` domain matches `userPrincipalName` domain (which by definition is a verified domain) |
|  |  | \* The user's `id\_token` includes the `xms\_edov` ("Email Domain Ownership Verified") claim, with a truthy value |
|  |  |  |
|  |  | The `xms\_edov` claim is [optional](https://github.com/MicrosoftDocs/azure-docs/issues/111425), and must be configured in the Azure console before it's available in the token. Refer to [Clerk's guide](https://clerk.com/docs/authentication/social-connections/microsoft#stay-secure-against-the-n-o-auth-vulnerability) for instructions on configuring the claim. |
|  |  |  |
|  |  | If you're not able or don't need to support domain verification, you can bypass for an individual domain: |
|  |  | ```ruby |
|  |  | Rails.application.config.middleware.use OmniAuth::Builder do |
|  |  | provider :microsoft\_graph, |
|  |  | ENV['AZURE\_APPLICATION\_CLIENT\_ID'], |
|  |  | ENV['AZURE\_APPLICATION\_CLIENT\_SECRET'], |
|  |  | skip\_domain\_verification: %w[contoso.com] |
|  |  | end |
|  |  | ``` |
|  |  |  |
|  |  | Or, you can disable domain verification entirely. We \*strongly recommend\* that you do \*not\* disable domain verification if at all possible. |
|  |  | ```ruby |
|  |  | Rails.application.config.middleware.use OmniAuth::Builder do |
|  |  | provider :microsoft\_graph, |
|  |  | ENV['AZURE\_APPLICATION\_CLIENT\_ID'], |
|  |  | ENV['AZURE\_APPLICATION\_CLIENT\_SECRET'], |
|  |  | skip\_domain\_verification: true |
|  |  | end |
|  |  | ``` |
|  |  |  |
|  |  | [nOAuth: How Microsoft OAuth Misconfiguration Can Lead to Full Account Takeover](https://www.descope.com/blog/post/noauth) from [Descope](https://www.descope.com/) |
|  |  |  |
|  |  | ### Upgrading to 1.0.0 |
|  |  | This version requires OmniAuth v2. If you are using Rails, you will need to include or upgrade `omniauth-rails\_csrf\_protection`. If you upgrade and get an error in your logs complaining about "authenticity error" or similiar, make sure to do `bundle update omniauth-rails\_csrf\_protection` |
|  |  |  |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[lib/omniauth/microsoft\_graph.rb](#diff-53c6b026e6a14f576a0af63a040f4acfed3bb17addf384a03dbbeb555bd04f5f "lib/omniauth/microsoft_graph.rb")

Show comments

[View file](/synth/omniauth-microsoft_graph/blob/f132078389612b797c872b45bd0e0b47382414c1/lib/omniauth/microsoft_graph.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,2 +1,3 @@ |
|  |  | require "omniauth/microsoft\_graph/domain\_verifier" |
|  |  | require "omniauth/microsoft\_graph/version" |
|  |  | require "omniauth/strategies/microsoft\_graph" |

86 changes: 86 additions & 0 deletions

86
[lib/omniauth/microsoft\_graph/domain\_verifier.rb](#diff-19c967ffae1543aed9f6cf5c2f9bd5cf2f6f3ef17353c14983a4f0cb75ef57ba "lib/omniauth/microsoft_graph/domain_verifier.rb")

Show comments

[View file](/synth/omniauth-microsoft_graph/blob/f132078389612b797c872b45bd0e0b47382414c1/lib/omniauth/microsoft_graph/domain_verifier.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,86 @@ |
|  |  | # frozen\_string\_literal: true |
|  |  | require 'jwt' # for token signature validation |
|  |  | require 'omniauth' # to inherit from OmniAuth::Error |
|  |  | require 'oauth2' # to rescue OAuth2::Error |
|  |  |  |
|  |  | module OmniAuth |
|  |  | module MicrosoftGraph |
|  |  | # Verify user email domains to mitigate the nOAuth vulnerability |
|  |  | # https://www.descope.com/blog/post/noauth |
|  |  | # https://clerk.com/docs/authentication/social-connections/microsoft#stay-secure-against-the-n-o-auth-vulnerability |
|  |  | OIDC\_CONFIG\_URL = 'https://login.microsoftonline.com/organizations/v2.0/.well-known/openid-configuration' |
|  |  |  |
|  |  | class DomainVerificationError < OmniAuth::Error; end |
|  |  |  |
|  |  | class DomainVerifier |
|  |  | def self.verify!(auth\_hash, access\_token, options) |
|  |  | new(auth\_hash, access\_token, options).verify! |
|  |  | end |
|  |  |  |
|  |  | def initialize(auth\_hash, access\_token, options) |
|  |  | @email\_domain = auth\_hash['info']['email']&.split('@')&.last |
|  |  | @upn\_domain = auth\_hash['extra']['raw\_info']['userPrincipalName']&.split('@')&.last |
|  |  | @access\_token = access\_token |
|  |  | @id\_token = access\_token.params['id\_token'] |
|  |  | @skip\_verification = options[:skip\_domain\_verification] |
|  |  | end |
|  |  |  |
|  |  | def verify! |
|  |  | # The userPrincipalName property is mutable, but must always contain a |
|  |  | # verified domain: |
|  |  | # |
|  |  | # "The general format is alias@domain, where domain must be present in |
|  |  | # the tenant's collection of verified domains." |
|  |  | # https://learn.microsoft.com/en-us/graph/api/resources/user?view=graph-rest-1.0 |
|  |  | # |
|  |  | # This means while it's not suitable for consistently identifying a user |
|  |  | # (the domain might change), it is suitable for verifying membership in |
|  |  | # a given domain. |
|  |  | return true if email\_domain == upn\_domain || |
|  |  | skip\_verification == true || |
|  |  | (skip\_verification.is\_a?(Array) && skip\_verification.include?(email\_domain)) || |
|  |  | domain\_verified\_jwt\_claim |
|  |  | raise DomainVerificationError, verification\_error\_message |
|  |  | end |
|  |  |  |
|  |  | private |
|  |  |  |
|  |  | attr\_reader :access\_token, |
|  |  | :email\_domain, |
|  |  | :id\_token, |
|  |  | :permitted\_domains, |
|  |  | :skip\_verification, |
|  |  | :upn\_domain |
|  |  |  |
|  |  | # https://learn.microsoft.com/en-us/entra/identity-platform/optional-claims-reference |
|  |  | # Microsoft offers an optional claim `xms\_edov` that will indicate whether the |
|  |  | # user's email domain is part of the organization's verified domains. This has to be |
|  |  | # explicitly configured in the app registration. |
|  |  | # |
|  |  | # To get to it, we need to decode the ID token with the key material from Microsoft's |
|  |  | # OIDC configuration endpoint, and inspect it for the claim in question. |
|  |  | def domain\_verified\_jwt\_claim |
|  |  | oidc\_config = access\_token.get(OIDC\_CONFIG\_URL).parsed |
|  |  | algorithms = oidc\_config['id\_token\_signing\_alg\_values\_supported'] |
|  |  | keys = JWT::JWK::Set.new(access\_token.get(oidc\_config['jwks\_uri']).parsed) |
|  |  | decoded\_token = JWT.decode(id\_token, nil, true, algorithms: algorithms, jwks: keys) |
|  |  | # https://github.com/MicrosoftDocs/azure-docs/issues/111425#issuecomment-1761043378 |
|  |  | # Comments seemed to indicate the value is not consistent |
|  |  | ['1', 1, 'true', true].include?(decoded\_token.first['xms\_edov']) |
|  |  | rescue JWT::VerificationError, ::OAuth2::Error |
|  |  | false |
|  |  | end |
|  |  |  |
|  |  | def verification\_error\_message |
|  |  | <<~MSG |
|  |  | The email domain '#{email\_domain}' is not a verified domain for this Azure AD account. |
|  |  | You can either: |
|  |  | \* Update the user's email to match the principal domain '#{upn\_domain}' |
|  |  | \* Skip verification on the '#{email\_domain}' domain (not recommended) |
|  |  | \* Disable verification with `skip\_domain\_verification: true` (NOT RECOMMENDED!) |
|  |  | Refer to the README for more details. |
|  |  | MSG |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  | end |

17 changes: 14 additions & 3 deletions

17
[lib/omniauth/strategies/microsoft\_graph.rb](#diff-3392141da4a41d970fc6dfd5f1fffafc6e11dd5cce237edcca3eaae49baa4137 "lib/omniauth/strategies/microsoft_graph.rb")

Show comments

[View file](/synth/omniauth-microsoft_graph/blob/f132078389612b797c872b45bd0e0b47382414c1/lib/omniauth/strategies/microsoft_graph.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -22,6 +22,7 @@ class MicrosoftGraph < OmniAuth::Strategies::OAuth2 |
|  |  |  |
|  |  | option :scope, DEFAULT\_SCOPE |
|  |  | option :authorized\_client\_ids, [] |
|  |  | option :skip\_domain\_verification, false |
|  |  |  |
|  |  | uid { raw\_info["id"] } |
|  |  |  |
| Expand All | | @@ -43,6 +44,12 @@ class MicrosoftGraph < OmniAuth::Strategies::OAuth2 |
|  |  | } |
|  |  | end |
|  |  |  |
|  |  | def auth\_hash |
|  |  | super.tap do |ah| |
|  |  | verify\_email(ah, access\_token) |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | def authorize\_params |
|  |  | super.tap do |params| |
|  |  | options[:authorize\_options].each do |k| |
| Expand All | | @@ -54,15 +61,15 @@ def authorize\_params |
|  |  |  |
|  |  | session['omniauth.state'] = params[:state] if params[:state] |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | def raw\_info |
|  |  | @raw\_info ||= access\_token.get('https://graph.microsoft.com/v1.0/me').parsed |
|  |  | end |
|  |  |  |
|  |  | def callback\_url |
|  |  | options[:callback\_url] || full\_host + script\_name + callback\_path |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | def custom\_build\_access\_token |
|  |  | access\_token = get\_access\_token(request) |
| Expand Down  Expand Up | | @@ -119,7 +126,11 @@ def verify\_token(access\_token) |
|  |  | raw\_response = client.request(:get, 'https://graph.microsoft.com/v1.0/me', |
|  |  | params: { access\_token: access\_token }).parsed |
|  |  | (raw\_response['aud'] == options.client\_id) || options.authorized\_client\_ids.include?(raw\_response['aud']) |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | def verify\_email(auth\_hash, access\_token) |
|  |  | OmniAuth::MicrosoftGraph::DomainVerifier.verify!(auth\_hash, access\_token, options) |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  | end |

1 change: 1 addition & 0 deletions

1
[omniauth-microsoft\_graph.gemspec](#diff-84547a1571d98c30c01f84bc47790c913550e79ed595f7c8be6ef2f85816f115 "omniauth-microsoft_graph.gemspec")

Show comments

[View file](/synth/omniauth-microsoft_graph/blob/f132078389612b797c872b45bd0e0b47382414c1/omniauth-microsoft_graph.gemspec)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,6 +18,7 @@ Gem::Specification.new do |spec| |
|  |  | spec.test\_files = spec.files.grep(%r{^(test|spec|features)/}) |
|  |  | spec.require\_paths = ["lib"] |
|  |  |  |
|  |  | spec.add\_runtime\_dependency 'jwt', '>= 2.0' |
|  |  | spec.add\_runtime\_dependency 'omniauth', '~> 2.0' |
|  |  | spec.add\_runtime\_dependency 'omniauth-oauth2', '~> 1.8.0' |
|  |  | spec.add\_development\_dependency "sinatra", '~> 0' |
| Expand Down | |  |

82 changes: 82 additions & 0 deletions

82
[spec/omniauth/microsoft\_graph/domain\_verifier\_spec.rb](#diff-d8e79d451321c1ec7ea0a2c172afa45767eb50739d65caf8d0207a8c80b0ac88 "spec/omniauth/microsoft_graph/domain_verifier_spec.rb")

Show comments

[View file](/synth/omniauth-microsoft_graph/blob/f132078389612b797c872b45bd0e0b47382414c1/spec/omniauth/microsoft_graph/domain_verifier_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,82 @@ |
|  |  | # frozen\_string\_literal: true |
|  |  |  |
|  |  | require 'spec\_helper' |
|  |  | require 'omniauth/microsoft\_graph/domain\_verifier' |
|  |  |  |
|  |  | RSpec.describe OmniAuth::MicrosoftGraph::DomainVerifier do |
|  |  | subject(:verifier) { described\_class.new(auth\_hash, access\_token, options) } |
|  |  |  |
|  |  | let(:auth\_hash) do |
|  |  | { |
|  |  | 'info' => { 'email' => email }, |
|  |  | 'extra' => { 'raw\_info' => { 'userPrincipalName' => upn } } |
|  |  | } |
|  |  | end |
|  |  | let(:email) { 'foo@example.com' } |
|  |  | let(:upn) { 'bar@hackerman.biz' } |
|  |  | let(:options) { { skip\_domain\_verification: false } } |
|  |  | let(:access\_token) { double('OAuth2::AccessToken', params: { 'id\_token' => id\_token }) } |
|  |  | let(:id\_token) { nil } |
|  |  |  |
|  |  | describe '#verify!' do |
|  |  | subject(:result) { verifier.verify! } |
|  |  |  |
|  |  | context 'when email domain and userPrincipalName domain match' do |
|  |  | let(:email) { 'foo@example.com' } |
|  |  | let(:upn) { 'bar@example.com' } |
|  |  |  |
|  |  | it { is\_expected.to be\_truthy } |
|  |  | end |
|  |  |  |
|  |  | context 'when domain validation is disabled' do |
|  |  | let(:options) { super().merge(skip\_domain\_verification: true) } |
|  |  |  |
|  |  | it { is\_expected.to be\_truthy } |
|  |  | end |
|  |  |  |
|  |  | context 'when the email domain is explicitly permitted' do |
|  |  | let(:options) { super().merge(skip\_domain\_verification: ['example.com']) } |
|  |  |  |
|  |  | it { is\_expected.to be\_truthy } |
|  |  | end |
|  |  |  |
|  |  | context 'when the ID token indicates domain verification' do |
|  |  | # Sign a fake ID token with our own local key |
|  |  | let(:mock\_key) do |
|  |  | optional\_parameters = { kid: 'mock-kid', use: 'sig', alg: 'RS256' } |
|  |  | JWT::JWK.new(OpenSSL::PKey::RSA.new(2048), optional\_parameters) |
|  |  | end |
|  |  | let(:id\_token) do |
|  |  | payload = { email: email, xms\_edov: true } |
|  |  | JWT.encode(payload, mock\_key.signing\_key, mock\_key[:alg], kid: mock\_key[:kid]) |
|  |  | end |
|  |  |  |
|  |  | # Mock the API responses to return the local key |
|  |  | before do |
|  |  | allow(access\_token).to receive(:get) |
|  |  | .with(OmniAuth::MicrosoftGraph::OIDC\_CONFIG\_URL) |
|  |  | .and\_return( |
|  |  | double('OAuth2::Response', parsed: { |
|  |  | 'id\_token\_signing\_alg\_values\_supported' => ['RS256'], |
|  |  | 'jwks\_uri' => 'https://example.com/jwks-keys' |
|  |  | }) |
|  |  | ) |
|  |  | allow(access\_token).to receive(:get) |
|  |  | .with('https://example.com/jwks-keys') |
|  |  | .and\_return( |
|  |  | double('OAuth2::Response', parsed: JWT::JWK::Set.new(mock\_key).export) |
|  |  | ) |
|  |  | end |
|  |  |  |
|  |  | it { is\_expected.to be\_truthy } |
|  |  | end |
|  |  |  |
|  |  | context 'when all verification strategies fail' do |
|  |  | before { allow(access\_token).to receive(:get).and\_raise(::OAuth2::Error.new('whoops')) } |
|  |  |  |
|  |  | it 'raises a DomainVerificationError' do |
|  |  | expect { result }.to raise\_error OmniAuth::MicrosoftGraph::DomainVerificationError |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  | end |

13 changes: 12 additions & 1 deletion

13
[spec/omniauth/strategies/microsoft\_graph\_oauth2\_spec.rb](#diff-6555c2f9705c4b42023ecc2148285d272784647fdb164b9b83cb1dd6dd293305 "spec/omniauth/strategies/microsoft_graph_oauth2_spec.rb")

Show comments

[View file](/synth/omniauth-microsoft_graph/blob/f132078389612b797c872b45bd0e0b47382414c1/spec/omniauth/strategies/microsoft_graph_oauth2_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -280,6 +280,18 @@ |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | context 'when email verification fails' do |
|  |  | let(:response\_hash) { { mail: 'something@domain.invalid' } } |
|  |  | let(:error) { OmniAuth::MicrosoftGraph::DomainVerificationError.new } |
|  |  |  |
|  |  | before do |
|  |  | allow(OmniAuth::MicrosoftGraph::DomainVerifier).to receive(:verify!).and\_raise(error) |
|  |  | end |
|  |  |  |
|  |  | it 'raises an error' do |
|  |  | expect { subject.auth\_hash }.to raise\_error error |
|  |  | end |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | describe '#extra' do |
| Expand Down  Expand Up | | @@ -445,5 +457,4 @@ |
|  |  | end.to raise\_error(OAuth2::Error) |
|  |  | end |
|  |  | end |
|  |  |  |
|  |  | end |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f132078`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsynth%2Fomniauth-microsoft_graph%2Fcommit%2Ff132078389612b797c872b45bd0e0b47382414c1) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.descope.com_f8620fb7_20250114_194528.html ===
[Skip to main contentArrow Right](#main-content)

Join our next monthly demo and see how to add auth to your app in 15 minutes. [Let's goArrow Right](https://hello.descope.com/live-demo)

[Log InUser Circle](https://app.descope.com)[![Descope Logo](/_next/static/media/logo.33442bc5.gif)](/)

* Product

  Caret Down
* Use Cases

  Caret Down
* Developers

  Caret Down
* [Customers](/customers)
* Resources

  Caret Down
* Company

  Caret Down
* Pricing

  Caret Down
[Sign upArrow Right](/sign-up)[Book a demoArrow Right](/demo)[![Descope Logo](/_next/static/media/logo.33442bc5.gif)](/)Menu[BlogArrow Left](/blog)
# nOAuth: How Microsoft OAuth Misconfiguration Can Lead to Full Account Takeover

[Company Updates](/blog/company-updates)June 20, 2023Copy linkHyperlink![Omer Cohen headshot](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fxqb1f63q68s1%2F3WzVqPxQCyi6rgzAlv3kwI%2Fe03df468cf49e8c29f98bab864dca79f%2FOmer_Cohen_headshot.jpg&w=3840&q=75)[Omer Cohen](/blog/author/omer-cohen)

Chief Security Officer

Share on:

Share on LinkedIn

LinkedIn

Share on X

X[Share on Blusky

Bluesky Social](https://bsky.app/intent/compose?text=)![](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fxqb1f63q68s1%2F2YzMj11yVeWjMvSzqjjeAL%2F2d549effce6ebf54d5d4e212b1b1526f%2FnOAuth_blog_thumbnail.jpg&w=3840&q=75)![](/_next/static/media/blog-post-hero.04309608.svg)

Table of Contents

* [Executive summary](#executive-summary)
* [Terms and concepts to know](#terms-and-concepts-to-know)
* [nOAuth attack flow](#noauth-attack-flow)
* [Reaching out to stakeholders](#reaching-out-to-stakeholders)
* [Suggested remediation steps](#suggested-remediation-steps)
* [Disclosure timelines](#disclosure-timelines)
* [Summary](#summary)
Magic Links

Identity and auth news.

Straight to your inbox.

Subscribe

This blog will cover how the Descope security team discovered a gray area in Microsoft Azure AD OAuth applications that could lead to full account takeover. We are naming this configuration issue “nOAuth” because even the bleakest of days has some room for wordplay.

[Reach out to our security team](https://www.descope.com/noauth) if you believe your app is vulnerable to nOAuth and need assistance. Read on to understand how this configuration issue arises, its impact, and suggested remediation steps.

## Executive summary

* nOAuth is an authentication implementation flaw that can affect Microsoft Azure AD multi-tenant OAuth applications.
* According to the OAuth specification, the user is uniquely identified by the “sub” (subject) claim. Most IdPs provide the common (yet non-standard) “email” claim. Using the email claim as the user identifier becomes an issue when this claim is mutable, which is why most IdPs advise against using email as an identifier. **In Microsoft Azure AD, the email claim is both mutable and unverified so it should never be trusted** **or used as an identifier**.
* A bad actor can change the Email attribute under “Contact Information” in the Azure AD account to control the “email” claim in the returned identity JWT.
* The combined effect of the points above allows an attacker that created their Azure AD tenant to use “Log in with Microsoft” with a vulnerable app and a specially crafted “victim” user, resulting in a complete account takeover.
* Previous Microsoft documentation on this matter recommended not to use the email address as the unique identifier. We informed Microsoft of the issue and they have since then refactored their documentation, providing stronger guidance and dedicated sections on claim verification.
* As part of Descope’s collaboration with Microsoft on addressing this issue, Microsoft is introducing two new claims to mitigate cases when nOAuth is used for cross-tenant spoofing. These features will enable apps to verify whether an email claim contains a domain-verified email address and redact email claims when the email domain is unverified.
* We informed several large applications that were vulnerable to this tactic, including a design app with millions of monthly users, a publicly traded customer experience company, and a leading multi-cloud consulting provider.
* We also informed two authentication platform providers that were merging user accounts when “Log in with Microsoft” was used on an existing user account. In this instance, merging the attacker account with a legitimate user account **would hand full control over the user account to the attacker**. As a result, all of their customers using “Log in with Microsoft” would have been vulnerable.
* To discover if your app is vulnerable to this issue (and how to fix it), refer to the “Suggested remediation steps” section of this blog.

## Terms and concepts to know

Familiarity with the terms below will help you better understand the nOAuth configuration issue.

### OAuth and OpenID Connect

[Open Authorization (OAuth)](https://www.descope.com/learn/post/oauth) is an open, token-based authorization framework that allows users to grant access to their private resources on one application to another application without giving away their identity details. For example, a Facebook user can authorize Medium to access their profile, read their posts, or post to their feed without having to give Medium their Facebook credentials.

Fig: OAuth in action

[OpenID Connect](https://www.descope.com/learn/post/oidc) (OIDC) is an identity layer built on top of OAuth 2.0 that allows applications to verify users' identities and obtain basic profile information. The protocol uses [JSON Web Tokens](https://www.descope.com/learn/post/jwt) (JWT) to securely transmit this information between parties.

In combination with OAuth, OIDC allows users to sign in to websites – using their Microsoft account, for example.

### Identity Provider (IdP)

An Identity Provider (IdP) is used as an external source of truth for user identities. Okta, Google, Twitter, and Azure AD are a few popular identity providers.

For the “Open” concept in OAuth and OIDC to work, the authentication is based on pre-established trust with the IdP. When the IdP cannot be trusted with the identity information they provide – or when an application bases the user’s identity on a claim that the IdP says is mutable – the whole system fails.

### Azure Active Directory (Azure AD)

Azure AD is a cloud-based identity and access management service. Azure AD manages user access to external resources, such as Microsoft 365, the Azure portal, and thousands of other SaaS applications using OAuth apps. Azure Active Directory also manages internal resources like apps on your corporate intranet and any cloud apps developed by your own organization by providing authentications via OAuth, OIDC, and other standard protocols.

### Merging user accounts

Let’s say an app’s login screen has email magic link, “Log in with Facebook”, and “Log in with Microsoft” as the available authentication methods. Let’s further assume a user signs up with a magic link, uses the service for a while, and then becomes inactive. If the user returns to the app, they might forget which authentication method they used to log in last time. In this case, they may accidentally choose “Log in with Microsoft” as the method.

In the above scenario, a user-friendly approach might be for the application (maybe through an authentication provider) to identify that the user choosing “Log in with Microsoft” has an existing account based on the email address provided by the Identity Provider, and merge the two accounts. Usually, this ensures the user identity is unified and they retain control over their account.

However, in the case of nOAuth, as the email address is not trusted or verified, merging user accounts results in full account takeover by the attacker.

## nOAuth attack flow

This section will share an example of nOAuth in action. No unauthorized accounts or data were compromised during this PoC.

* **Victim’s email address:** omer@descope[.]com
* **Attacker’s email address:** badguy@l33th4x0r.onmicrosoft.com

For an attacker to exploit nOAuth, they will broadly follow two steps:

Fig: nOAuth attack flow

### Preparation

* The attacker accesses their Azure AD account as admin.
* The attacker changes the “Email” attribute to the victim’s email address (omer@descope[.]com).
* Since Microsoft does not require the email change to be validated on Azure AD, this is all the preparation the attacker needs.

### Attack

* The attacker uses “Log in with Microsoft” on a website / app that’s vulnerable to nOAuth (i.e. one that uses the email address as a unique identifier).
* If the app merges user accounts without validation, the attacker now has full control over the victim’s account, even if the victim doesn’t have a Microsoft account.
* After successful login, the attacker has an open field depending on the nature of the app or site they have taken over. They can establish persistence, exfiltrate data, explore if lateral movement is possible, and so on.

The screenshot below shows two different OAuth logins to the same application. Note that all claim values are the same except the “email” claim.

The demo video below shows a to-do list app with “Sign in with Google” and “Sign in with Microsoft” as authentication options. By exploiting nOAuth, an attacker can use “Sign in with Microsoft” to take control of a legitimate user’s account and add malicious tasks to their to-do list.

## Reaching out to stakeholders

We reached out to three sets of stakeholders that could be affected by nOAuth: Microsoft, vulnerable applications, and authentication providers that merge accounts without validation.

### Microsoft

As we noted in the executive summary, Microsoft had existing documentation informing developers not to use the “email” claim as a unique identifier in the access token. The screenshot below has been taken from [this archive link](https://web.archive.org/web/20230402154923/https%3A//learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens#subject), since the documentation has now been updated.

Fig: Microsoft documentation (since updated) recommending not to use the email address as a unique identifier

We reached out to Microsoft and informed them about the nOAuth configuration issue on April 11, 2023. After a week, they stated that they’d issue guidance to customers for this issue.

A few days later, Microsoft [published](https://github.com/MicrosoftDocs/azure-docs/commit/d247bcf29e74da5071030fa24057aef71e0f5a12) a dedicated page on [Claims Validation](https://learn.microsoft.com/en-us/azure/active-directory/develop/claims-validation#validate-the-subject) with all the information a developer needs to consider when implementing authentication.

Since then, we have been in regular communication with Microsoft as they worked to deploy additional fixes to mitigate any cross-tenant spoofing. Developers can now use two new claims to help prevent nOAuth being used against their app:

* **xms\_edov [Email Domain Owner Verified]** is an optional claim that indicates whether an email claim contains a domain-verified email address.
* **RemoveUnverifiedEmailClaim** is an authentication behavior flag that can redact email claims when the domain for the email is unverified.

You can read more about these claims and how to implement them in [this Microsoft blog](https://msrc.microsoft.com/blog/2023/06/potential-risk-of-privilege-escalation-in-azure-ad-applications/).

### Vulnerable apps

Once we had an nOAuth proof-of-concept, we tested it with a white-hat attack on hundreds of websites and applications to check if any of them were vulnerable. We found that quite a few of them were. Vulnerable organizations included a design app with millions of monthly users, a publicly traded customer experience company, a leading multi-cloud consulting provider, as well as several SMBs and early-stage startups.

We shared our PoC with each affected organization and informed them of the vulnerability. While most of the affected apps were quick to respond and fix the issue, the number of apps we tested are a drop in the ocean of the Internet.

If your app uses “Log in with Microsoft”, we recommend immediately checking whether it is vulnerable to nOAuth and remediating accordingly.

### Other authentication providers

If an app uses a third-party authentication provider, there are two scenarios that can occur after a “Log in with Microsoft” attempt for a user that already has a previous Microsoft account linked to the app:

* The two accounts are merged.
* The two accounts are not merged.

We tested nOAuth on most major authentication providers and found that **two providers merged the accounts without further validation,** leading to full [account takeover](https://www.descope.com/learn/post/account-takeover). We informed both providers of this issue and they were quick to respond and fix the issue.

We will not be naming any other authentication providers in this blog, since we believe it’s not relevant to the matter at hand. We trust that the affected providers will responsibly inform any of their customers that use Microsoft OAuth in their authentication process.

## Suggested remediation steps

As Microsoft suggests in their [claims validation documentation](https://learn.microsoft.com/en-us/azure/active-directory/develop/claims-validation), “upn”, “email”, “preferred\_username” and other claims should not be used to make authentication or authorization decisions. **The claim that should be used as the unique identifier for the user is the “sub” (Subject) claim.**

If you’d like to continue merging user accounts, it’s important to validate the email address provided by Microsoft with a magic link or similar secure means to ensure this email is in control of the real account holder. Check out [this developer blog](https://www.descope.com/blog/post/descope-flows-securely-merging-oauth-identities) to learn how Descope securely merges accounts when “Log in with Microsoft” is used.

You can also use the [two new claims introduced by Microsoft](https://msrc.microsoft.com/blog/2023/06/potential-risk-of-privilege-escalation-in-azure-ad-applications/) to explicitly indicate whether an email claim is from a domain-verified email and redact the email claim if needed, allowing full flexibility for developers with relevant use cases.

[Reach out to our security team](https://www.descope.com/noauth) if you need help in identifying whether your app is vulnerable to nOAuth and / or implementing a fix.

## Disclosure timelines

* **April 11, 2023 –** Descope reported the nOAuth configuration issue to Microsoft.
* **April 12, 2023 –** Microsoft opened a ticket related to the issue.
* **April 18, 2023 –** Response from Microsoft stating that they would issue guidance to customers and work on a fix.
* **April 17-21, 2023 –** Descope informed vulnerable organizations.
* **April 18, 2023 –** Microsoft updated documentation regarding OAuth claims.
* **May 2, 2023 –** Descope informed authentication providers that were merging accounts without validation.
* **May 4, 2023 –** Both authentication providers responded and confirmed the issue.
* **May 6, 2023 –** Both authentication providers fixed the issue.
* **June 20, 2023 –** Microsoft issues fixes. Microsoft and Descope carry out joint public disclosure.

## Summary

The world of authentication and authorization is complicated and full of potential pitfalls and vulnerabilities. In this blog, we described an Azure AD OAuth misconfiguration that could lead to full account takeover. Our findings strengthen our opinion that implementing OAuth is not trivial and needs dedicated expertise. In general, we recommend that companies regularly conduct deep security reviews of their authentication implementations – one wrong claim can quickly cascade into catastrophe.

Over the past few months, we:

* Informed Microsoft of this implementation flaw so they can introduce new claims and provide stronger developer guidance.
* Helped fix several large applications used by millions of users that were vulnerable to nOAuth.
* Helped fellow SaaS authentication providers that were incorrectly handling the issue and potentially placing their customers at risk.
* Were awarded over $75,000 in bug bounties which we will be donating to auth-related open source initiatives.

We hope this disclosure raises awareness about the issue and results in app developers testing their products for exposure to nOAuth as soon as possible. You can [request remediation assistance](https://www.descope.com/noauth) for nOAuth or email security@descope[.]com with any questions or feedback about this blog.

## Liked what you saw?

Check out these posts next

[![](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fxqb1f63q68s1%2F7iwZjNsS7T9zkxzIIom4Ki%2Fbe9daa2cab875dcdedd07d763bc9ea8e%2FSAML_vs_OAuth_thumbnail.jpg&w=3840&q=75)Auth Thoughts | Apr 20, 2023
### SAML vs OAuth: What’s the Difference?

Read moreArrow Right](/blog/post/saml-vs-oauth)[![](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fxqb1f63q68s1%2FQZOIHyJ9z5H2PUoluWdpE%2Fd56a53ff317248dd98c85031e62b554c%2FAuthn_vs_Authz_thumbnail.jpg&w=3840&q=75)Auth Thoughts | Feb 29, 2024
### Authentication vs. Authorization: Differences & Relationship

Read moreArrow Right](/blog/post/authentication-vs-authorization)[![](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fxqb1f63q68s1%2FADyFey4QVP1BAcmaTSah7%2Fc8d176d7cf4fb6fa2b053cc334e5ad85%2FBenefits_of_Passwordless_Auth_Thumbnail.jpg&w=3840&q=75)Auth Thoughts | Mar 3, 2023
### 4 Benefits of Passwordless Authentication

Read moreArrow Right](/blog/post/4-benefits-of-passwordless-authentication)[Descope - Go to homepage](/)[Chat with Sales](https://start-chat.com/slack/descope/V5mA8i)

Anonymously - no Slack account required

![Users Love Us Badge](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fxqb1f63q68s1%2F2EInV5YltILRbo46Bnnjv7%2F86d73226b17d6a88a7bc4949137f4c11%2Flove_us.webp&w=1080&q=75)[Leave a Descope review](https://www.g2.com/products/descope/reviews)

Product

* [Platform Overview](/product)
* [Descope Flows](/flows)
* [Integrations](/integrations)
* [Changelog](https://docs.descope.com/changelog)
* [Descope vs Auth0](/descope-vs-auth0)
* [Descope vs Ping Identity](/descope-vs-ping)

App Use Cases

* [Passwordless](/use-cases/passwordless-authentication)
* [Identity Federation](/use-cases/identity-federation)
* [ATO Prevention](/use-cases/fraud-prevention)
* [Identity Orchestration](/use-cases/identity-orchestration)

Authentication Methods

* [Social Logins](/use-cases/oauth-social-logins)
* [Passkeys](/use-cases/passkeys)
* [MFA](/use-cases/mfa)
* [Biometrics / WebAuthn](/use-cases/biometrics)
* [Magic Links](/use-cases/magic-links)
* [SSO](/use-cases/sso)
* [OpenID Connect](/use-cases/oidc)
* [nOTP](/use-cases/notp)
* [One-Time Passwords](/use-cases/otp)
* [Authenticator Apps](/use-cases/totp-authenticator-apps)
* [Passwords](/use-cases/passwords)

Developers

* [Docs](https://docs.descope.com)
* [Tutorials](https://docs.descope.com/tutorials/)
* [Community](/community)
* [Open Source](/open-source)

Resources

* [Learning Center](/learn)
* [Blog](/blog)

Company

* [Our Story](/about)
* [Careers](https://descope.breezy.hr/)
* [Partners](/partners)
* [Newsroom](/newsroom)
* [Security & Compliance](/security-compliance)
* [Contact Us](/contact)

Legal

* [Privacy Policy](/privacy)
* [Terms of Use](/terms)

Copyright © Descope Inc. All rights reserved.

[All systems operational](https://descopestatus.com)[Github Icon Grey

![Github Icon Grey](https://images.ctfassets.net/xqb1f63q68s1/38EDaH0h3n6icUh9pVaWmK/ede2197e889712b167ff1f74620150a2/github-logo-grey.svg)](https://github.com/descope)[Linkedin Icon Grey

![Linkedin Icon Grey](https://images.ctfassets.net/xqb1f63q68s1/138nJ4hfyhdCYoOi4kPHKK/bbe644497f90fc02e5d047b7f18ab8f7/linkedin-icon-grey.svg)](https://www.linkedin.com/company/descope/)[X Grey Icon

![X Grey Icon](https://images.ctfassets.net/xqb1f63q68s1/6BBx4b59iu6VuN7KA90LpB/ebe40a377773978d9f3bb0c7ffb8dc3d/x-grey-icon.svg)](https://twitter.com/descopeinc)[Instagram Grey Logo

![Instagram Grey Logo](https://images.ctfassets.net/xqb1f63q68s1/2bbYuYDwqcoJgfzSfEgSlm/47682f9480c62d1fa9b7db26339db4b7/instagram-logo.svg)](https://www.instagram.com/descope.inc/)[Slack Grey Icon

![Slack Grey Icon](https://images.ctfassets.net/xqb1f63q68s1/4GLQKaTyCiD40QliZtucTD/9fcf12aef8fcd6ffcea361eadd055046/slack-logo.svg)](http://authtown.slack.com/)[Youtube Grey Icon

![Youtube Grey Icon](https://images.ctfassets.net/xqb1f63q68s1/3jstGU2pgP1hRDBsV3cx3/65d2a729b15e1101fcfaf893099f8ebf/youtube-logo.svg)](https://www.youtube.com/%40descope)[Bluesky Social

![Bluesky Social](https://images.ctfassets.net/xqb1f63q68s1/4LWZXtvgGTc3wlCdrrlxGG/a35299779e03a896ca53e55eb8601239/Bluesky_Logo.svg)](https://bsky.app/profile/descope.com)[Descope - Go to homepage](/)[Chat with Sales](https://start-chat.com/slack/descope/V5mA8i)

Anonymously - no Slack account required

* ProductCaret Down
* App Use CasesCaret Down
* Authentication MethodsCaret Down
* DevelopersCaret Down
* ResourcesCaret Down
* CompanyCaret Down
* LegalCaret Down

---

![Users Love Us Badge](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fxqb1f63q68s1%2F2EInV5YltILRbo46Bnnjv7%2F86d73226b17d6a88a7bc4949137f4c11%2Flove_us.webp&w=1080&q=75)[Leave a Descope review](https://www.g2.com/products/descope/reviews)

---

[Github Icon Grey

![Github Icon Grey](https://images.ctfassets.net/xqb1f63q68s1/38EDaH0h3n6icUh9pVaWmK/ede2197e889712b167ff1f74620150a2/github-logo-grey.svg)](https://github.com/descope)[Linkedin Icon Grey

![Linkedin Icon Grey](https://images.ctfassets.net/xqb1f63q68s1/138nJ4hfyhdCYoOi4kPHKK/bbe644497f90fc02e5d047b7f18ab8f7/linkedin-icon-grey.svg)](https://www.linkedin.com/company/descope/)[X Grey Icon

![X Grey Icon](https://images.ctfassets.net/xqb1f63q68s1/6BBx4b59iu6VuN7KA90LpB/ebe40a377773978d9f3bb0c7ffb8dc3d/x-grey-icon.svg)](https://twitter.com/descopeinc)[Instagram Grey Logo

![Instagram Grey Logo](https://images.ctfassets.net/xqb1f63q68s1/2bbYuYDwqcoJgfzSfEgSlm/47682f9480c62d1fa9b7db26339db4b7/instagram-logo.svg)](https://www.instagram.com/descope.inc/)[Slack Grey Icon

![Slack Grey Icon](https://images.ctfassets.net/xqb1f63q68s1/4GLQKaTyCiD40QliZtucTD/9fcf12aef8fcd6ffcea361eadd055046/slack-logo.svg)](http://authtown.slack.com/)[Youtube Grey Icon

![Youtube Grey Icon](https://images.ctfassets.net/xqb1f63q68s1/3jstGU2pgP1hRDBsV3cx3/65d2a729b15e1101fcfaf893099f8ebf/youtube-logo.svg)](https://www.youtube.com/%40descope)[Bluesky Social

![Bluesky Social](https://images.ctfassets.net/xqb1f63q68s1/4LWZXtvgGTc3wlCdrrlxGG/a35299779e03a896ca53e55eb8601239/Bluesky_Logo.svg)](https://bsky.app/profile/descope.com)

---

[All systems operational](https://descopestatus.com)

Copyright © Descope Inc. All rights reserved.



=== Content from github.com_08132376_20250114_194526.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsynth%2Fomniauth-microsoft_graph%2Fsecurity%2Fadvisories%2FGHSA-5g66-628f-7cvj)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsynth%2Fomniauth-microsoft_graph%2Fsecurity%2Fadvisories%2FGHSA-5g66-628f-7cvj)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=synth%2Fomniauth-microsoft_graph)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[synth](/synth)
/
**[omniauth-microsoft\_graph](/synth/omniauth-microsoft_graph)**
Public

* [Notifications](/login?return_to=%2Fsynth%2Fomniauth-microsoft_graph) You must be signed in to change notification settings
* [Fork
  62](/login?return_to=%2Fsynth%2Fomniauth-microsoft_graph)
* [Star
   39](/login?return_to=%2Fsynth%2Fomniauth-microsoft_graph)

* [Code](/synth/omniauth-microsoft_graph)
* [Issues
  0](/synth/omniauth-microsoft_graph/issues)
* [Pull requests
  2](/synth/omniauth-microsoft_graph/pulls)
* [Discussions](/synth/omniauth-microsoft_graph/discussions)
* [Actions](/synth/omniauth-microsoft_graph/actions)
* [Projects
  0](/synth/omniauth-microsoft_graph/projects)
* [Security](/synth/omniauth-microsoft_graph/security)
* [Insights](/synth/omniauth-microsoft_graph/pulse)

Additional navigation options

* [Code](/synth/omniauth-microsoft_graph)
* [Issues](/synth/omniauth-microsoft_graph/issues)
* [Pull requests](/synth/omniauth-microsoft_graph/pulls)
* [Discussions](/synth/omniauth-microsoft_graph/discussions)
* [Actions](/synth/omniauth-microsoft_graph/actions)
* [Projects](/synth/omniauth-microsoft_graph/projects)
* [Security](/synth/omniauth-microsoft_graph/security)
* [Insights](/synth/omniauth-microsoft_graph/pulse)

# Account takeover (nOAuth)

High

[synth](/synth)
published
GHSA-5g66-628f-7cvj
Jan 2, 2024

## Package

bundler

omniauth-microsoft\_graph
([RubyGems](/advisories?query=ecosystem%3Arubygems))

## Affected versions

< 2.0.0

## Patched versions

2.0.0

## Description

### Summary

The implementation did not validate the legitimacy of the `email` attribute of the user nor did it give/document an option to do so, making it susceptible to [nOAuth](https://www.descope.com/blog/post/noauth) misconfiguration in cases when the `email` is used as a trusted user identifier

### Severity

High

8.6

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
Low

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:L/A:L

### CVE ID

CVE-2024-21632

### Weaknesses

No CWEs

### Credits

* [![@makuga01](https://avatars.githubusercontent.com/u/20490978?s=40&v=4)](/makuga01)
  [makuga01](/makuga01)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


