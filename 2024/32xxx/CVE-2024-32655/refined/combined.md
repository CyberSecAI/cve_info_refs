=== Content from github.com_547a6bb6_20250115_175837.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Ff7e7ead0702d776a8f551f5786c4cac2d65c4bc6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Ff7e7ead0702d776a8f551f5786c4cac2d65c4bc6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6)
Browse the repository at this point in the history

* Loading branch information

[![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[12e5ec2](/npgsql/npgsql/commit/12e5ec24db566a4a0fe93d283f1007a30b4e31aa)

commit f7e7ead

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**272 additions**
and
**30 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Npgsql

  + Internal

    - src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b)
    - src/Npgsql/Internal/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
* test/Npgsql.Tests

  + test/Npgsql.Tests/CommandTests.cs
    [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
  + Support

    - test/Npgsql.Tests/Support/PgPostmasterMock.cs
      [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
    - test/Npgsql.Tests/Support/PgServerMock.cs
      [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)
  + test/Npgsql.Tests/WriteBufferTests.cs
    [WriteBufferTests.cs](#diff-b75e35eba1a49ae8fa5ec1030cc05440d7caa2a2b391bf9f42af26bbe06bd374)

## There are no files selected for viewing

56 changes: 38 additions & 18 deletions

56
[src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b "src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6/src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, byte[] asciiNam |
|  |  | (asciiName.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, asciiName, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -48,6 +49,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -79,6 +81,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -118,9 +121,6 @@ internal async Task WriteParse(string sql, byte[] asciiName, List<NpgsqlParamete |
|  |  | } |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | if (writeBuffer.WriteSpaceLeft < 1 + 4 + asciiName.Length + 1) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -130,9 +130,14 @@ internal async Task WriteParse(string sql, byte[] asciiName, List<NpgsqlParamete |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | writeBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | writeBuffer.WriteInt32(messageLength - 1); |
|  |  | writeBuffer.WriteNullTerminatedString(asciiName); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + asciiName.Length + 1) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(asciiName); |
|  |  |  |
|  |  | await writeBuffer.WriteString(sql, queryByteLen, async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand Down  Expand Up | | @@ -171,12 +176,6 @@ internal async Task WriteBind( |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | if (writeBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(writeBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | for (var paramIndex = 0; paramIndex < parameters.Count; paramIndex++) |
| Expand All | | @@ -197,8 +196,15 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | writeBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | writeBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
|  |  | writeBuffer.WriteByte(0); // Portal is always empty |
|  |  |  |
| Expand Down  Expand Up | | @@ -269,6 +275,7 @@ internal Task WriteClose(StatementOrPortal type, byte[] asciiName, bool async, C |
|  |  | asciiName.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, asciiName, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -296,14 +303,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken).ConfigureAwait(false); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -316,6 +326,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -331,6 +342,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -348,6 +360,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -362,6 +375,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -374,6 +388,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -394,6 +409,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | NpgsqlWriteBuffer.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -417,8 +433,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -441,6 +459,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -464,6 +483,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async, cancellationToken); |
|  |  |  |
| Expand Down | |  |

61 changes: 59 additions & 2 deletions

61
[src/Npgsql/Internal/NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c "src/Npgsql/Internal/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6/src/Npgsql/Internal/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,8 @@ sealed class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  | readonly MetricsReporter? \_metricsReporter; |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,6 +78,9 @@ internal PgWriter GetWriter(NpgsqlDatabaseInfo typeCatalog, FlushMode flushMode |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | bool \_disposed; |
|  |  | readonly PgWriter \_pgWriter; |
|  |  |  |
| Expand Down  Expand Up | | @@ -131,6 +136,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = async && Timeout > TimeSpan.Zero |
|  |  | ? \_timeoutCts.Start(cancellationToken) |
| Expand Down  Expand Up | | @@ -197,15 +204,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -228,15 +239,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -534,9 +549,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

11 changes: 1 addition & 10 deletions

11
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/f7e7ead0702d776a8f551f5786c4cac2d65c4bc6/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -212,16 +212,7 @@ public override void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name, async: false).GetAwaiter().GetResult(); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f7e7ead`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Ff7e7ead0702d776a8f551f5786c4cac2d65c4bc6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0cb44bba_20250115_175833.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F703d9af8fa48dfe8c0180e36edb8278f34342d7b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F703d9af8fa48dfe8c0180e36edb8278f34342d7b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/703d9af8fa48dfe8c0180e36edb8278f34342d7b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/703d9af8fa48dfe8c0180e36edb8278f34342d7b)
Browse the repository at this point in the history

```
(cherry picked from commit 4cce03ae2b0ab61f33d129a4e92620b5964edce5)

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[72610fa](/npgsql/npgsql/commit/72610fae3aee67a2eee8997972545e319a96c602)

commit 703d9af

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**196 additions**
and
**27 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Npgsql

  + Internal

    - src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b)
    - src/Npgsql/Internal/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
* test/Npgsql.Tests

  + test/Npgsql.Tests/CommandTests.cs
    [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
  + Support

    - test/Npgsql.Tests/Support/PgPostmasterMock.cs
      [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
    - test/Npgsql.Tests/Support/PgServerMock.cs
      [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)

## There are no files selected for viewing

47 changes: 33 additions & 14 deletions

47
[src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b "src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/703d9af8fa48dfe8c0180e36edb8278f34342d7b/src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, string name, bo |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | (name.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, name, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -47,6 +48,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,6 +78,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(byte) + // Null-terminated portal name (always empty for now) |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -113,9 +116,6 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | throw; |
|  |  | } |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -125,6 +125,10 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(statementName); |
| Expand Down  Expand Up | | @@ -164,12 +168,6 @@ internal async Task WriteBind( |
|  |  | statement.Length + sizeof(byte) + // Statement name plus null terminator |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | for (var paramIndex = 0; paramIndex < parameters.Count; paramIndex++) |
| Expand All | | @@ -190,6 +188,13 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
| Expand Down  Expand Up | | @@ -251,6 +256,7 @@ internal Task WriteClose(StatementOrPortal type, string name, bool async, Cancel |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | name.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, name, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -279,14 +285,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -301,6 +310,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -316,6 +326,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -333,6 +344,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -347,6 +359,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -359,6 +372,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -379,6 +393,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | PGUtil.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -402,8 +417,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -426,6 +443,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -449,6 +467,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -466,4 +485,4 @@ async Task FlushAndWrite(byte[] data, bool async, CancellationToken cancellation |
|  |  | internal void Flush() => WriteBuffer.Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
|  |  | internal Task Flush(bool async, CancellationToken cancellationToken = default) => WriteBuffer.Flush(async, cancellationToken); |
|  |  | } |
|  |  | } |

62 changes: 59 additions & 3 deletions

62
[src/Npgsql/Internal/NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c "src/Npgsql/Internal/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/703d9af8fa48dfe8c0180e36edb8278f34342d7b/src/Npgsql/Internal/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ public sealed partial class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  |  |
| Expand Down  Expand Up | | @@ -72,6 +73,9 @@ internal TimeSpan Timeout |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | ParameterStream? \_parameterStream; |
|  |  |  |
|  |  | bool \_disposed; |
| Expand Down  Expand Up | | @@ -126,6 +130,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = cancellationToken; |
|  |  | if (async && Timeout > TimeSpan.Zero) |
| Expand Down  Expand Up | | @@ -193,15 +199,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -224,15 +234,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -573,9 +587,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand All | | @@ -590,4 +646,4 @@ internal byte[] GetContents() |
|  |  | } |
|  |  |  |
|  |  | #endregion |
|  |  | } |
|  |  | } |

11 changes: 1 addition & 10 deletions

11
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/703d9af8fa48dfe8c0180e36edb8278f34342d7b/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -223,16 +223,7 @@ public void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `703d9af`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F703d9af8fa48dfe8c0180e36edb8278f34342d7b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_71b2b8aa_20250115_175841.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv7.0.7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv7.0.7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v7.0.7)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v7.0.7)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v7.0.7](/npgsql/npgsql/releases/tag/v7.0.7)

# v7.0.7

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v7.0.7)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:25

·
[509 commits](/npgsql/npgsql/compare/v7.0.7...main)
to main
since this release

[v7.0.7](/npgsql/npgsql/tree/v7.0.7)

[`8882a39`](/npgsql/npgsql/commit/8882a3983a3552c92ba9ba1ca171a664bba53b60)

This commit was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/4218809?s=64&v=4)](/NinoFloris)
[NinoFloris](/NinoFloris)
Nino Floris

GPG key ID: E369AF867692D088

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade. An additional number of bugs have been fixed, [here is the full list](https://github.com/npgsql/npgsql/milestone/107?closed=1).

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

 👍
4
 mhguelleh, firstDismay, sethyukna, and devfservant reacted with thumbs up emoji

All reactions

* 👍
  4 reactions

 4 people reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_88565f3b_20250115_181549.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpg)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpg)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

![@npg](https://avatars.githubusercontent.com/u/245044?s=64&v=4)

**npg**
[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpg)

[Overview](/npg)
[Repositories
1](/npg?tab=repositories)
[Projects
0](/npg?tab=projects)
[Packages
0](/npg?tab=packages)
[Stars
1](/npg?tab=stars)

More

* [Overview](/npg)
* [Repositories](/npg?tab=repositories)
* [Projects](/npg?tab=projects)
* [Packages](/npg?tab=packages)
* [Stars](/npg?tab=stars)

![@npg](https://avatars.githubusercontent.com/u/245044?s=64&v=4)

**npg**

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpg)

[![View npg's full-sized avatar](https://avatars.githubusercontent.com/u/245044?v=4)](https://avatars.githubusercontent.com/u/245044?v=4)

# Nikola Goranov npg

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpg)

[3
followers](https://github.com/npg?tab=followers) · [0
following](https://github.com/npg?tab=following)

* Sofia, Bulgaria

Block or Report

# Block or report npg

**Block user**

Prevent this user from interacting with your repositories and sending you notifications.
Learn more about [blocking users](https://docs.github.com/articles/blocking-a-user-from-your-personal-account).

You must be logged in to block users.

Add an optional note:

Please don't include any personal information such as legal names or email addresses. Maximum 100 characters, markdown supported. This note will be visible to only you.

Block user

**Report abuse**

Contact GitHub support about this user’s behavior.
Learn more about [reporting abuse](https://docs.github.com/articles/reporting-abuse-or-spam).

[Report abuse](/contact/report-abuse?report=npg+%28user%29)

[Overview](/npg)
[Repositories
1](/npg?tab=repositories)
[Projects
0](/npg?tab=projects)
[Packages
0](/npg?tab=packages)
[Stars
1](/npg?tab=stars)

More

* [Overview](/npg)
* [Repositories](/npg?tab=repositories)
* [Projects](/npg?tab=projects)
* [Packages](/npg?tab=packages)
* [Stars](/npg?tab=stars)

## Popular repositories Loading

1. [x264-high-depth](/npg/x264-high-depth) x264-high-depth
   Public

   x264 with support for 10+ bits per sample

   C

   [1](/npg/x264-high-depth/stargazers)

Something went wrong, please refresh the page to try again.

If the problem persists, check the [GitHub status page](https://www.githubstatus.com/)
or [contact support](/contact).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.co_86065a3c_20250115_181555.html ===

[Skip to content](#start-of-content)

GitHub Copilot is now available for free.
[Learn more](https://github.com/features/copilot/?utm_source=github&utm_medium=banner&utm_campaign=copilotfree-bannerheader)

## Navigation Menu

Toggle navigation

[Sign in](/login)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F&source=header-home)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

# Build and ship software on a single, collaborative platform

Join the world’s most widely adopted AI-powered developer platform.

Enter your emailSign up for GitHub[Try GitHub Copilot](/features/copilot)
## GitHub features

A demonstration animation of a code editor using GitHub Copilot Chat, where the user requests GitHub Copilot to refactor duplicated logic and extract it into a reusable function for a given code snippet.

CodePlanCollaborateAutomateSecure

Build code quickly and more securely with GitHub Copilot embedded throughout your workflows.

## GitHub is used by

![Shopify](https://github.githubassets.com/assets/shopify-3fed3011ac81.svg)![EY](https://github.githubassets.com/assets/ey-7434b194d68c.svg)![Figma](https://github.githubassets.com/assets/figma-04e0038c0fef.svg)![Duolingo](https://github.githubassets.com/assets/duolingo-ea3a0aa56fa5.svg)![New York Times](https://github.githubassets.com/assets/newyorktimes-9d76d7f338f5.svg)![Mercado Libre](https://github.githubassets.com/assets/mercado-libre-762f679589f2.svg)![American Airlines](https://github.githubassets.com/assets/american-airlines-a2b13c8fbe08.svg)![Ford](https://github.githubassets.com/assets/ford-2fb5195a4c7c.svg)![Mercedes Benz](https://github.githubassets.com/assets/mercedes-b9190458c80e.svg)![Société Générale](https://github.githubassets.com/assets/societe-generale-7a3414490494.svg)![Vodafone](https://github.githubassets.com/assets/vodafone-6e0f322de6cd.svg)![Philips](https://github.githubassets.com/assets/philips-8087a5f95f5c.svg)![SAP](https://github.githubassets.com/assets/sap-ea7dcd02e37d.svg)![Infosys](https://github.githubassets.com/assets/infosys-7587455de0bd.svg)![Spotify](https://github.githubassets.com/assets/spotify-591ecb426c1e.svg)![Shopify](https://github.githubassets.com/assets/shopify-3fed3011ac81.svg)![EY](https://github.githubassets.com/assets/ey-7434b194d68c.svg)![Figma](https://github.githubassets.com/assets/figma-04e0038c0fef.svg)![Duolingo](https://github.githubassets.com/assets/duolingo-ea3a0aa56fa5.svg)![New York Times](https://github.githubassets.com/assets/newyorktimes-9d76d7f338f5.svg)![Mercado Libre](https://github.githubassets.com/assets/mercado-libre-762f679589f2.svg)![American Airlines](https://github.githubassets.com/assets/american-airlines-a2b13c8fbe08.svg)![Ford](https://github.githubassets.com/assets/ford-2fb5195a4c7c.svg)![Mercedes Benz](https://github.githubassets.com/assets/mercedes-b9190458c80e.svg)![Société Générale](https://github.githubassets.com/assets/societe-generale-7a3414490494.svg)![Vodafone](https://github.githubassets.com/assets/vodafone-6e0f322de6cd.svg)![Philips](https://github.githubassets.com/assets/philips-8087a5f95f5c.svg)![SAP](https://github.githubassets.com/assets/sap-ea7dcd02e37d.svg)![Infosys](https://github.githubassets.com/assets/infosys-7587455de0bd.svg)![Spotify](https://github.githubassets.com/assets/spotify-591ecb426c1e.svg)
## Accelerate performance

With GitHub Copilot embedded throughout the platform, you can simplify your toolchain, automate tasks, and improve the developer experience.

![](https://github.githubassets.com/assets/particles-de1dd20f3008.png)A Copilot chat window with extensions enabled. The user inputs the @ symbol to reveal a list of five Copilot Extensions. @Sentry is selected from the list, which shifts the window to a chat directly with that extension. There are three sample prompts at the bottom of the chat window, allowing the user to Get incident information, Edit status on incident, or List the latest issues. The last one is activated to send the prompt: @Sentry List the latest issues. The extension then lists several new issues and their metadata.
### Work 55% faster.1 Increase productivity with AI-powered coding assistance, including code completion, chat, and more.

1[Survey: The AI wave continues to grow on software development teams, 2024.](https://github.blog/news-insights/research/survey-ai-wave-grows/)

[Explore GitHub Copilot](/features/copilot)![Duolingo](https://github.githubassets.com/assets/logo-duolingo-14477f9e54a6.svg)

Duolingo boosts developer speed by 25% with GitHub Copilot

[Read customer story](/customer-stories/duolingo)![Gartner](https://github.githubassets.com/assets/logo-gartner-aa8c2e452b64.svg)

2024 Gartner® Magic Quadrant™ for AI Code Assistants

[Read report](https://www.gartner.com/doc/reprints?id=1-2IKO4MPE&ct=240819&st=sb)![](https://github.githubassets.com/assets/accordion-1-ce487d44c0bf.webp)![](https://github.githubassets.com/assets/accordion-2-730955545f07.webp)![](https://github.githubassets.com/assets/accordion-3-52ca331d22ea.webp)![](https://github.githubassets.com/assets/accordion-4-a26744b70ff7.webp)
### Automate any workflow

Optimize your process with simple and secured CI/CD.

A list of workflows displays a heading ‘45,167 workflow runs’ at the top. Below are five rows of completed workflows accompanied by their completion time and their duration formatted in minutes and seconds.[Discover GitHub Actions](/features/actions)
### Get up and running in seconds

Start building instantly with a comprehensive dev environment in the cloud.

A GitHub Codespaces setup for the landing page of a game called OctoInvaders. On the left is a code editor with some HTML and Javascript files open. On the right is a live render of the page. In front of this split editor window is a screenshot of two active GitHub Codespaces environments with their branch names and a button to ‘Create codespace on main.’[Check out GitHub Codespaces](/features/codespaces)
### Build on the go

Manage projects and chat with GitHub Copilot from anywhere.

Two smartphone screens side by side. The left screen shows a Notification inbox, listing issues and pull requests from different repositories like TensorFlow and GitHub’s OctoArcade octoinvaders. The right screen shows a new conversation in GitHub Copilot chat.[Download GitHub Mobile](/mobile)
### Integrate the tools you love

Sync with 17,000+ integrations and a growing library of Copilot Extensions.

A grid of fifty app tiles displays logos for integrations and extensions for companies like Stripe, Slack, and Docker. The tiles extend beyond the bounds of the image to indicate a wide array of apps. [Visit GitHub Marketplace](/marketplace)
## Built-in application security where found means fixed

Use AI to find and fix vulnerabilities—freeing your teams to ship more secure software faster.

![](https://github.githubassets.com/assets/particles-de1dd20f3008.png)
### Apply fixes in seconds. Spend less time fixing vulnerabilities and more time building features with Copilot Autofix.

[Explore GitHub Advanced Security](/enterprise/advanced-security)![Copilot Autofix identifies vulnerable code and provides an explanation, together with a secure code suggestion to remediate the vulnerability.](https://github.githubassets.com/assets/hero-64ecd484397f.webp)

Solve security debt. Leverage AI-assisted security campaigns to reduce application vulnerabilities and zero-day attacks.

[Discover security campaigns](/enterprise/advanced-security)![A security campaign screen displays the campaign’s progress bar with 97% completed of 701 alerts. A total of 23 alerts are left with 13 in progress, and the campaign started 20 days ago. The status below shows that there are 7 days left in the campaign with a due date of November 15, 2024.](https://github.githubassets.com/assets/pillar-1-dd667a921f55.webp)

Dependencies you can depend on. Update vulnerable dependencies with supported fixes for breaking changes.

[Learn about Dependabot](/features/security/software-supply-chain)![List of dependencies defined in a requirements .txt file.](https://github.githubassets.com/assets/pillar-2-ff69e872920a.webp)

Your secrets, your business: protected.  Detect, prevent, and remediate leaked secrets across your organization.

[Read about secret scanning](/features/security/code)![GitHub push protection confirms and displays an active secret, and blocks the push.](https://github.githubassets.com/assets/pillar-3-0a063e2daae2.webp)
### 7x fastervulnerability fixes with GitHub2

2This 7X times factor is based on data from the industry’s longest running analysis of fix rates Veracode State of Software Security 2023, which cites the average time to fix 50% of flaws as 198 days vs. GitHub’s fix rates of 72% of flaws with in 28 days which is at a minimum of 7X faster when compared.

### 90% coverage[of alert types in all supported languages with Copilot Autofix](https://docs.github.com/en/code-security/code-scanning/managing-your-code-scanning-configuration/codeql-query-suites)

## Work together, achieve more

Collaborate with your teams, use management tools that sync with your projects, and code from anywhere—all on a single, integrated platform.

![](https://github.githubassets.com/assets/particles-de1dd20f3008.png)![A project management dashboard showing tasks for the ‘OctoArcade Invaders’ project, with tasks grouped under project phase categories like ‘Prototype,’ ‘Beta,’ and ‘Launch’ in a table layout. One of the columns displays sub-issue progress bars with percentages for each issue.](https://github.githubassets.com/assets/hero-961322485af6.webp)
### Your workflows, your way. Plan effectively with an adaptable spreadsheet that syncs with your work.

[Jump into GitHub Projects](/features/issues)“
> It helps us onboard new software engineers and get them productive right away. We have all our source code, issues, and pull requests in one place... GitHub is a complete platform that frees us from menial tasks and enables us to do our best work.

Fabian FaulhaberApplication manager at Mercedes-Benz

![](https://github.githubassets.com/assets/accordion-1-38ad6b6d1b20.webp)![](https://github.githubassets.com/assets/accordion-2-c0a62cfc31a1.webp)![](https://github.githubassets.com/assets/accordion-3-5d5d222f1830.webp)![](https://github.githubassets.com/assets/accordion-4-7abff9233556.webp)
### Keep track of your tasks

Create issues and manage projects with tools that adapt to your code.

Display of task tracking within an issue, showing the status of related sub-issues and their connection to the main issue.[Explore GitHub Issues](/features/issues)
### Share ideas and ask questions

Create space for open-ended conversations alongside your project.

A GitHub Discussions thread where a GitHub user suggests a power-up idea involving Hubot revealing a path and protecting Mona. The post has received 5 upvotes and several reactions. Below, three other users add to the discussion, suggesting Hubot could provide different power-ups depending on levels and appreciating the collaboration idea.[Discover GitHub Discussions](/features/discussions)
### Review code changes together

Create review processes that improve code quality and fit neatly into your workflow.

Two code review approvals by helios-ackmore and amanda-knox, which are followed by three successful checks for ‘Build,’ ‘Test,’ and ‘Publish.’[Learn about code review](/features/code-review)
### Fund open source projects

Become an open source partner and support the tools and libraries that power your work.

A GitHub Sponsors popup displays ‘$15,000 a month’ with a progress bar showing 87% towards a $15,000 goal.[Dive into GitHub Sponsors](/sponsors)
## From startups to enterprises, GitHub scales with teams of any size in any industry.

By industryBy sizeBy use case

---

[![](https://github.githubassets.com/assets/figma-62d390a52419.webp)![Figma](https://github.githubassets.com/assets/figma-9b0c642e96b8.svg)Technology

Figma streamlines development and strengthens security

Read customer story](https://github.com/customer-stories/figma)[![](https://github.githubassets.com/assets/mercedes-benz-d8f89b041561.webp)![Mercedes-Benz](https://github.githubassets.com/assets/mercedes-benz-60ddd54043e7.svg)Automotive

Mercedes-Benz standardizes source code and automates onboarding

Read customer story](https://github.com/customer-stories/mercedes-benz)[![](https://github.githubassets.com/assets/mercado-libre-579cb5447302.webp)![Mercado Libre](https://github.githubassets.com/assets/mercado-libre-2d6d610fa873.svg)Financial services

Mercado Libre cuts coding time by 50%

Read customer story](https://github.com/customer-stories/mercado-libre)[Explore customer stories](/customer-stories)

---

[View all solutions](/solutions)
## Millions of developers and businesses call GitHub home

Whether you’re scaling your development process or just learning how to code, GitHub is where you belong. Join the world’s most widely adopted AI-powered developer platform to build the technologies that redefine what’s possible.

Enter your emailSign up for GitHub[Try GitHub Copilot](/features/copilot)

## Site-wide Links

### Subscribe to our developer newsletter

Get tips, technical guides, and best practices. Twice a month. Right in your inbox.

[Subscribe](https://resources.github.com/newsletter/)

### Product

* [Features](/features)
* [Enterprise](/enterprise)
* [Copilot](/features/copilot)
* [Security](/security)
* [Pricing](/pricing)
* [Team](/team)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare)

### Platform

* [Developer API](https://docs.github.com/get-started/exploring-integrations/about-building-integrations)
* [Partners](https://partner.github.com)
* [Education](https://github.com/edu)
* [GitHub CLI](https://cli.github.com)
* [GitHub Desktop](https://desktop.github.com)
* [GitHub Mobile](https://github.com/mobile)

### Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com)
* [Premium Support](/enterprise/premium-support)
* [Skills](https://skills.github.com)
* [Status](https://www.githubstatus.com)
* [Contact GitHub](https://support.github.com?tags=dotcom-footer)

### Company

* [About](https://github.com/about)
* [Customer stories](/customer-stories?type=enterprise)
* [Blog](https://github.blog)
* [The ReadME Project](/readme)
* [Careers](https://github.careers)
* [Newsroom](/newsroom)
* [Inclusion](/about/diversity)
* [Social Impact](https://socialimpact.github.com)
* [Shop](https://shop.github.com)

* © 2025 GitHub, Inc.
* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
  ([Updated 02/2024](https://github.com/github/site-policy/pull/582))
* [Sitemap](/sitemap)
* [What is Git?](/git-guides)
* Manage cookies
* Do not share my personal information

* [GitHub on LinkedIn](https://www.linkedin.com/company/github)
* [Instagram
  GitHub on Instagram](https://www.instagram.com/github)
* [GitHub on YouTube](https://www.youtube.com/github)
* [GitHub on X](https://x.com/github)
* [TikTok
  GitHub on TikTok](https://www.tiktok.com/%40github)
* [Twitch
  GitHub on Twitch](https://www.twitch.tv/github)
* [GitHub’s organization on GitHub](https://github.com/github)

You can’t perform that action at this time.



=== Content from github.com_2bcee695_20250115_175839.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv5.0.18)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv5.0.18)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v5.0.18)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v5.0.18)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v5.0.18](/npgsql/npgsql/releases/tag/v5.0.18)

# v5.0.18

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v5.0.18)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:23

·
[1136 commits](/npgsql/npgsql/compare/v5.0.18...main)
to main
since this release

[v5.0.18](/npgsql/npgsql/tree/v5.0.18)

[`6342a44`](/npgsql/npgsql/commit/6342a44414e1c861bebb173796e1c1ebf5713d1a)

This commit was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/4218809?s=64&v=4)](/NinoFloris)
[NinoFloris](/NinoFloris)
Nino Floris

GPG key ID: E369AF867692D088

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_7e5a2cdd_20250115_175834.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fa22a42d8141d7a3528f43c02c095a409507cf1af)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fa22a42d8141d7a3528f43c02c095a409507cf1af)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/a22a42d8141d7a3528f43c02c095a409507cf1af)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/a22a42d8141d7a3528f43c02c095a409507cf1af)
Browse the repository at this point in the history

* Loading branch information

[![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[6cc5224](/npgsql/npgsql/commit/6cc52241d2b481daaa39cb0d454dba3429000fdd)

commit a22a42d

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**187 additions**
and
**28 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Npgsql

  + Internal

    - src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b)
    - src/Npgsql/Internal/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
* test/Npgsql.Tests

  + test/Npgsql.Tests/CommandTests.cs
    [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
  + Support

    - test/Npgsql.Tests/Support/PgPostmasterMock.cs
      [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
    - test/Npgsql.Tests/Support/PgServerMock.cs
      [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)

## There are no files selected for viewing

47 changes: 33 additions & 14 deletions

47
[src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b "src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/a22a42d8141d7a3528f43c02c095a409507cf1af/src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, string name, bo |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | (name.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, name, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -47,6 +48,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,6 +78,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(byte) + // Null-terminated portal name (always empty for now) |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -113,9 +116,6 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | throw; |
|  |  | } |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -125,6 +125,10 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(statementName); |
| Expand Down  Expand Up | | @@ -164,12 +168,6 @@ internal async Task WriteBind( |
|  |  | statement.Length + sizeof(byte) + // Statement name plus null terminator |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | for (var paramIndex = 0; paramIndex < parameters.Count; paramIndex++) |
| Expand All | | @@ -190,6 +188,13 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
| Expand Down  Expand Up | | @@ -251,6 +256,7 @@ internal Task WriteClose(StatementOrPortal type, string name, bool async, Cancel |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | name.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, name, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -279,14 +285,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -301,6 +310,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -316,6 +326,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -333,6 +344,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -347,6 +359,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -359,6 +372,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -379,6 +393,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | PGUtil.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -402,8 +417,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -426,6 +443,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -449,6 +467,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -466,4 +485,4 @@ async Task FlushAndWrite(byte[] data, bool async, CancellationToken cancellation |
|  |  | internal void Flush() => WriteBuffer.Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
|  |  | internal Task Flush(bool async, CancellationToken cancellationToken = default) => WriteBuffer.Flush(async, cancellationToken); |
|  |  | } |
|  |  | } |

64 changes: 60 additions & 4 deletions

64
[src/Npgsql/Internal/NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c "src/Npgsql/Internal/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/a22a42d8141d7a3528f43c02c095a409507cf1af/src/Npgsql/Internal/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ public sealed partial class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  |  |
| Expand Down  Expand Up | | @@ -72,6 +73,9 @@ internal TimeSpan Timeout |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | ParameterStream? \_parameterStream; |
|  |  |  |
|  |  | bool \_disposed; |
| Expand Down  Expand Up | | @@ -126,6 +130,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = async && Timeout > TimeSpan.Zero |
|  |  | ? \_timeoutCts.Start(cancellationToken) |
| Expand All | | @@ -137,7 +143,7 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | { |
|  |  | await Underlying.WriteAsync(Buffer, 0, WritePosition, finalCt); |
|  |  | await Underlying.FlushAsync(finalCt); |
|  |  | if (Timeout > TimeSpan.Zero) |
|  |  | if (Timeout > TimeSpan.Zero) |
|  |  | \_timeoutCts.Stop(); |
|  |  | } |
|  |  | else |
| Expand Down  Expand Up | | @@ -194,15 +200,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -225,15 +235,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -606,9 +620,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand All | | @@ -623,4 +679,4 @@ internal byte[] GetContents() |
|  |  | } |
|  |  |  |
|  |  | #endregion |
|  |  | } |
|  |  | } |

11 changes: 1 addition & 10 deletions

11
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/a22a42d8141d7a3528f43c02c095a409507cf1af/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -230,16 +230,7 @@ public void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a22a42d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fa22a42d8141d7a3528f43c02c095a409507cf1af) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0d50db18_20250115_181601.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpaul-gerste-sonarsource)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpaul-gerste-sonarsource)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)

**paul-gerste-sonarsource**
[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fpaul-gerste-sonarsource)

[Overview](/paul-gerste-sonarsource)
[Repositories
12](/paul-gerste-sonarsource?tab=repositories)
[Projects
0](/paul-gerste-sonarsource?tab=projects)
[Packages
0](/paul-gerste-sonarsource?tab=packages)
[Stars
9](/paul-gerste-sonarsource?tab=stars)

More

* [Overview](/paul-gerste-sonarsource)
* [Repositories](/paul-gerste-sonarsource?tab=repositories)
* [Projects](/paul-gerste-sonarsource?tab=projects)
* [Packages](/paul-gerste-sonarsource?tab=packages)
* [Stars](/paul-gerste-sonarsource?tab=stars)

![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)

**paul-gerste-sonarsource**

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fpaul-gerste-sonarsource)

[![View paul-gerste-sonarsource's full-sized avatar](https://avatars.githubusercontent.com/u/79814126?v=4)](https://avatars.githubusercontent.com/u/79814126?v=4)
🥷

'>"><img/src/onerror=alert(1)>

# Paul Gerste paul-gerste-sonarsource

🥷

'>"><img/src/onerror=alert(1)>

[Follow](/login?return_to=https%3A%2F%2Fgithub.com%2Fpaul-gerste-sonarsource)

[14
followers](https://github.com/paul-gerste-sonarsource?tab=followers) · [0
following](https://github.com/paul-gerste-sonarsource?tab=following)

* [@SonarSource](https://github.com/SonarSource)
* Bochum, Germany

## [Achievements](/paul-gerste-sonarsource?tab=achievements)

[![Achievement: Pair Extraordinaire](https://github.githubassets.com/assets/pair-extraordinaire-default-579438a20e01.png)](/paul-gerste-sonarsource?achievement=pair-extraordinaire&tab=achievements)[![Achievement: Quickdraw](https://github.githubassets.com/assets/quickdraw-default-39c6aec8ff89.png)](/paul-gerste-sonarsource?achievement=quickdraw&tab=achievements)[![Achievement: Pull Shark](https://github.githubassets.com/assets/pull-shark-default-498c279a747d.png)](/paul-gerste-sonarsource?achievement=pull-shark&tab=achievements)
## [Achievements](/paul-gerste-sonarsource?tab=achievements)

[![Achievement: Pair Extraordinaire](https://github.githubassets.com/assets/pair-extraordinaire-default-579438a20e01.png)](/paul-gerste-sonarsource?achievement=pair-extraordinaire&tab=achievements)[![Achievement: Quickdraw](https://github.githubassets.com/assets/quickdraw-default-39c6aec8ff89.png)](/paul-gerste-sonarsource?achievement=quickdraw&tab=achievements)[![Achievement: Pull Shark](https://github.githubassets.com/assets/pull-shark-default-498c279a747d.png)](/paul-gerste-sonarsource?achievement=pull-shark&tab=achievements)
## Highlights

* [13

  security advisory credits](/advisories?query=credit%3Apaul-gerste-sonarsource)

Block or Report

# Block or report paul-gerste-sonarsource

**Block user**

Prevent this user from interacting with your repositories and sending you notifications.
Learn more about [blocking users](https://docs.github.com/articles/blocking-a-user-from-your-personal-account).

You must be logged in to block users.

Add an optional note:

Please don't include any personal information such as legal names or email addresses. Maximum 100 characters, markdown supported. This note will be visible to only you.

Block user

**Report abuse**

Contact GitHub support about this user’s behavior.
Learn more about [reporting abuse](https://docs.github.com/articles/reporting-abuse-or-spam).

[Report abuse](/contact/report-abuse?report=paul-gerste-sonarsource+%28user%29)

[Overview](/paul-gerste-sonarsource)
[Repositories
12](/paul-gerste-sonarsource?tab=repositories)
[Projects
0](/paul-gerste-sonarsource?tab=projects)
[Packages
0](/paul-gerste-sonarsource?tab=packages)
[Stars
9](/paul-gerste-sonarsource?tab=stars)

More

* [Overview](/paul-gerste-sonarsource)
* [Repositories](/paul-gerste-sonarsource?tab=repositories)
* [Projects](/paul-gerste-sonarsource?tab=projects)
* [Packages](/paul-gerste-sonarsource?tab=packages)
* [Stars](/paul-gerste-sonarsource?tab=stars)

## Popular repositories Loading

1. [empty](/paul-gerste-sonarsource/empty) empty
   Public

   Pretty self-explanatory.
2. [maven-code-exec](/paul-gerste-sonarsource/maven-code-exec) maven-code-exec
   Public
3. [smol](/paul-gerste-sonarsource/smol) smol
   Public

   A small repo.
4. [sc-test](/paul-gerste-sonarsource/sc-test) sc-test
   Public

   HTML
5. [dotnet-samples](/paul-gerste-sonarsource/dotnet-samples) dotnet-samples
   Public

   Forked from [VenkeyK/dotnet-samples](/VenkeyK/dotnet-samples)

   Sample .NET test projects

   C#
6. [pages-action-test](/paul-gerste-sonarsource/pages-action-test) pages-action-test
   Public

Something went wrong, please refresh the page to try again.

If the problem persists, check the [GitHub status page](https://www.githubstatus.com/)
or [contact support](/contact).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_bb412fbd_20250115_175830.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F3183efb2bdcca159c8c2e22af57e18ea8f853cf0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F3183efb2bdcca159c8c2e22af57e18ea8f853cf0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/3183efb2bdcca159c8c2e22af57e18ea8f853cf0)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/3183efb2bdcca159c8c2e22af57e18ea8f853cf0)
Browse the repository at this point in the history

```
* Changes to make project compile

* Add message length validation to flush and direct write

(cherry picked from commit be0c32912ea6783cb4da86f45ae6e5e121d0cdc9)

---------

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[42d5384](/npgsql/npgsql/commit/42d53849b52f9e5c99b9736732c02f433155893b)

commit 3183efb

 Show file tree

 Hide file tree

Showing
**12 changed files**
with
**203 additions**
and
**35 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Directory.Build.targets
  [Directory.Build.targets](#diff-50e91c82311ea26f2a73202525dfdf2b0a89c178ee666b2bf3ad4c84ac4c06dc)
* src

  + Npgsql.Json.NET

    - src/Npgsql.Json.NET/JsonHandler.cs
      [JsonHandler.cs](#diff-625cd94978aed3383b5e34dceb7f9971412755356c73315fdfeeb44bd8e88184)
    - src/Npgsql.Json.NET/JsonbHandler.cs
      [JsonbHandler.cs](#diff-9c4af43fd72978d4b1aeb14218adf4163412484c55a57bbe458f184d77b53ca3)
  + Npgsql

    - src/Npgsql/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-c30f6b27a9eff111937042ab38f91ae685284db87f5e2346d30bb769a2449d4e)
    - src/Npgsql/NpgsqlTransaction.cs
      [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
    - src/Npgsql/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2)
    - TypeHandlers

      * CompositeHandlers

        + src/Npgsql/TypeHandlers/CompositeHandlers/CompositeHandler.cs
          [CompositeHandler.cs](#diff-00ed7942d4e2c28e9c7c3ba351966b51ab7cec4305ca0d6b1d136059c4d3db88)
      * src/Npgsql/TypeHandlers/HstoreHandler.cs
        [HstoreHandler.cs](#diff-6e1ae7af74bf9b5b9ca622dd12aa4e1c79895522bd4aed5e50b1eca781667f4c)
* test

  + Npgsql.PluginTests

    - test/Npgsql.PluginTests/JsonNetTests.cs
      [JsonNetTests.cs](#diff-e3ab8dd4ca94d928249246e8b7986463da0dd3daa998cf68c2cd90b25b8618d9)
  + Npgsql.Tests

    - test/Npgsql.Tests/CommandTests.cs
      [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
    - Support

      * test/Npgsql.Tests/Support/PgPostmasterMock.cs
        [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
      * test/Npgsql.Tests/Support/PgServerMock.cs
        [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)

## There are no files selected for viewing

6 changes: 3 additions & 3 deletions

6
[Directory.Build.targets](#diff-50e91c82311ea26f2a73202525dfdf2b0a89c178ee666b2bf3ad4c84ac4c06dc "Directory.Build.targets")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/Directory.Build.targets)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,14 +9,14 @@ |
|  |  | <PackageReference Update="NetTopologySuite.IO.PostGIS" Version="2.1.0" /> |
|  |  | <PackageReference Update="NodaTime" Version="3.0.1" /> |
|  |  | <PackageReference Update="GeoJSON.Net" Version="1.1.73" /> |
|  |  | <PackageReference Update="Newtonsoft.Json" Version="12.0.2" /> |
|  |  | <PackageReference Update="Newtonsoft.Json" Version="13.0.3" /> |
|  |  |  |
|  |  | <!-- Tests --> |
|  |  | <PackageReference Update="NUnit" Version="3.13.0" /> |
|  |  | <PackageReference Update="NLog" Version="4.6.7" /> |
|  |  | <PackageReference Update="Microsoft.CSharp" Version="4.6.0" /> |
|  |  | <PackageReference Update="Microsoft.NET.Test.Sdk" Version="16.5.0" /> |
|  |  | <PackageReference Update="NUnit3TestAdapter" Version="3.17.0" /> |
|  |  | <PackageReference Update="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Update="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | <PackageReference Update="xunit" Version="2.4.1" /> |
|  |  | <PackageReference Update="xunit.runner.visualstudio" Version="2.4.1" /> |
|  |  | <PackageReference Update="GitHubActionsTestLogger" Version="1.1.0" /> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql.Json.NET/JsonHandler.cs](#diff-625cd94978aed3383b5e34dceb7f9971412755356c73315fdfeeb44bd8e88184 "src/Npgsql.Json.NET/JsonHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql.Json.NET/JsonHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -39,7 +39,7 @@ protected override async ValueTask<T> Read<T>(NpgsqlReadBuffer buf, int len, boo |
|  |  | return await base.Read<T>(buf, len, async, fieldDescription); |
|  |  | } |
|  |  |  |
|  |  | return JsonConvert.DeserializeObject<T>(await base.Read<string>(buf, len, async, fieldDescription), \_settings); |
|  |  | return JsonConvert.DeserializeObject<T>(await base.Read<string>(buf, len, async, fieldDescription), \_settings)!; |
|  |  | } |
|  |  |  |
|  |  | protected override int ValidateAndGetLength<T2>(T2 value, ref NpgsqlLengthCache? lengthCache, NpgsqlParameter? parameter) |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql.Json.NET/JsonbHandler.cs](#diff-9c4af43fd72978d4b1aeb14218adf4163412484c55a57bbe458f184d77b53ca3 "src/Npgsql.Json.NET/JsonbHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql.Json.NET/JsonbHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -39,7 +39,7 @@ protected override async ValueTask<T> Read<T>(NpgsqlReadBuffer buf, int len, boo |
|  |  | return await base.Read<T>(buf, len, async, fieldDescription); |
|  |  | } |
|  |  |  |
|  |  | return JsonConvert.DeserializeObject<T>(await base.Read<string>(buf, len, async, fieldDescription), \_settings); |
|  |  | return JsonConvert.DeserializeObject<T>(await base.Read<string>(buf, len, async, fieldDescription), \_settings)!; |
|  |  | } |
|  |  |  |
|  |  | protected override int ValidateAndGetLength<T2>(T2 value, ref NpgsqlLengthCache? lengthCache, NpgsqlParameter? parameter) |
| Expand Down | |  |

45 changes: 32 additions & 13 deletions

45
[src/Npgsql/NpgsqlConnector.FrontendMessages.cs](#diff-c30f6b27a9eff111937042ab38f91ae685284db87f5e2346d30bb769a2449d4e "src/Npgsql/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, string name, bo |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | (name.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, name, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -47,6 +48,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,6 +78,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(byte) + // Null-terminated portal name (always empty for now) |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -113,9 +116,6 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | throw; |
|  |  | } |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -125,6 +125,10 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(statementName); |
| Expand Down  Expand Up | | @@ -164,12 +168,6 @@ internal async Task WriteBind( |
|  |  | statement.Length + sizeof(byte) + // Statement name plus null terminator |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | foreach (var p in inputParameters) |
| Expand All | | @@ -189,6 +187,13 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
| Expand Down  Expand Up | | @@ -249,6 +254,7 @@ internal Task WriteClose(StatementOrPortal type, string name, bool async, Cancel |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | name.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, name, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -277,14 +283,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -299,6 +308,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -314,6 +324,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -331,6 +342,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -345,6 +357,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -357,6 +370,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -377,6 +391,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | PGUtil.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -400,8 +415,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -424,6 +441,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken); |
|  |  |  |
| Expand All | | @@ -447,6 +465,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async); |
|  |  |  |
| Expand Down | |  |

13 changes: 2 additions & 11 deletions

13
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -220,16 +220,7 @@ public void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down  Expand Up | | @@ -414,7 +405,7 @@ async ValueTask DisposeAsyncInternal() |
|  |  | Debug.Assert(\_connector.IsBroken); |
|  |  | Log.Error("Exception while disposing a transaction", ex, \_connector.Id); |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | IsDisposed = true; |
|  |  | \_connector?.Connection?.EndBindingScope(ConnectorBindingScope.Transaction); |
|  |  | } |
| Expand Down | |  |

60 changes: 58 additions & 2 deletions

60
[src/Npgsql/NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2 "src/Npgsql/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ public sealed partial class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  |  |
| Expand Down  Expand Up | | @@ -72,6 +73,9 @@ internal TimeSpan Timeout |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | ParameterStream? \_parameterStream; |
|  |  |  |
|  |  | bool \_disposed; |
| Expand Down  Expand Up | | @@ -120,6 +124,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = cancellationToken; |
|  |  | if (async && Timeout > TimeSpan.Zero) |
| Expand Down  Expand Up | | @@ -187,15 +193,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -218,15 +228,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -569,9 +583,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql/TypeHandlers/CompositeHandlers/CompositeHandler.cs](#diff-00ed7942d4e2c28e9c7c3ba351966b51ab7cec4305ca0d6b1d136059c4d3db88 "src/Npgsql/TypeHandlers/CompositeHandlers/CompositeHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/TypeHandlers/CompositeHandlers/CompositeHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -98,7 +98,7 @@ public override int ValidateAndGetLength(T value, ref NpgsqlLengthCache? lengthC |
|  |  | foreach (var member in \_memberHandlers) |
|  |  | length += member.ValidateAndGetLength(value, ref lengthCache); |
|  |  |  |
|  |  | return lengthCache.Lengths[position] = length; |
|  |  | return lengthCache!.Lengths[position] = length; |
|  |  | } |
|  |  |  |
|  |  | [MethodImpl(MethodImplOptions.AggressiveInlining)] |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql/TypeHandlers/HstoreHandler.cs](#diff-6e1ae7af74bf9b5b9ca622dd12aa4e1c79895522bd4aed5e50b1eca781667f4c "src/Npgsql/TypeHandlers/HstoreHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/src/Npgsql/TypeHandlers/HstoreHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -93,7 +93,7 @@ public int ValidateAndGetLength(IDictionary<string, string?> value, ref NpgsqlLe |
|  |  | totalLen += \_textHandler.ValidateAndGetLength(kv.Value!, ref lengthCache, null); |
|  |  | } |
|  |  |  |
|  |  | return lengthCache.Lengths[pos] = totalLen; |
|  |  | return lengthCache!.Lengths[pos] = totalLen; |
|  |  | } |
|  |  |  |
|  |  | /// <inheritdoc /> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[test/Npgsql.PluginTests/JsonNetTests.cs](#diff-e3ab8dd4ca94d928249246e8b7986463da0dd3daa998cf68c2cd90b25b8618d9 "test/Npgsql.PluginTests/JsonNetTests.cs")

Show comments

[View file](/npgsql/npgsql/blob/3183efb2bdcca159c8c2e22af57e18ea8f853cf0/test/Npgsql.PluginTests/JsonNetTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -121,7 +121,7 @@ public void RoundtripJObject() |
|  |  | { |
|  |  | reader.Read(); |
|  |  | var actual = reader.GetFieldValue<JObject>(0); |
|  |  | Assert.That((int)actual["Bar"], Is.EqualTo(8)); |
|  |  | Assert.That((int)actual["Bar"]!, Is.EqualTo(8)); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3183efb`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F3183efb2bdcca159c8c2e22af57e18ea8f853cf0) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from avatars.githubusercontent.com_01d86c9d_20250115_181548.html ===
�PNG

   
IHDR   (   (   �/:   EIDATx��W]s���\_iW�dK��%v㄄Lh��N�gf��p��n�Á;`�0�����EK���ޔc�I���7ٲe�k�L� ��<��f�������E���s\���Kkf"�M�C�0O�W���5��8�k��Կ��w:���S�0�DEQUUEAb�X�{jP����S(�� t]���O?�d�6Ք��766t]�z��� ���ʢ��,��X5M���m��KKK �f��i������͓��J���e��6��� �V�}�����ضM��rkkk{{{��=~�Bh��`0���\\\�y�uݿ�2���5�l��\_}���i�H��0������Ad2�����p(��m۝N�^�\_�~���٠�e�&̵����n�F#�#�L�'��fs���(cAX��,k0ܿ��7��f��Y���ճ�}���!�ضm�a���իW���S�T"��f��("�A��c�=z���U,�z0�y�eaLy����<��W\*����b��N�eY�8c� &�\|�Ƿ���������w�j��
�
�>�;k��x�����C˲r�������B\*��'9C/�\����t��E�,���࣏>z���T�F�gg�J-h4��QW���$�IQ!� ��C�E}Ĳ���z�\��rA��9�\*4e�bBH�i"�0ƒ$e2�˲VcB׮�A%�a�T\*u�ƍk׮���l6���=ϛ�����,��j5���I��b�>Ƌ�HC�q� ��,�J�drii !��v��F�
MQO�A��˲�(�!,�q���!��y�0B�aX�UU�X,z�g�6-)sU���.K��o�����N�Cq]��阦�i��(���
�� �F��eY�X,V\*UUAH&��L&#���"J�\Ì�cEQ��t]������RNu�K�g��(�w�}�R�1��m#�6662������\.W�T4M����{���  �H$�I�9ǁ�ǭVKE���x��A��d'�S�5�{:����i������q�XL�哓�f�Y(�ܹ&ϝ;w��  x�������\_�����r�<ϥ<�~}xx�駟j��������>�paa!�NW\*��`P�VUU]\\��b  EQhT����Q�Vk�ڽ{�>��Ý������s�K��O>������v�����y^�充�R�!�e�RG�S�zZR���Z�6���&����4!�t� ���Ϯ���1�e�X,.--)�B"���;-����
Ø�Ǘ,��\_��9�~������a��ٶ
!�$��:-a��+W�lll���u����ٳg�1!���\* �q��&Z�<��4��l��c�u}ߧZ�D轒$�q��M�clYփ,˚��r���I�.<����B]���v�׳,��<�q|�g�k׮�z=����\*���z����|��ښ��ifX��}���DL�l4��!�W�Vڧ��n�P�8�n���`�2g�
�|:D;˲����}Y�EQL�R�e2A�RJ��eY!�4Y�E��I�cN�" |�Ϳ���h���B��ER�xA.g��t�!�y�}�Z�m{����%Ir�&1�s��w�G��>�B�~�� qT1d!�G
c����ݻ��4�0����D��� �J���ÿ�Nh�dEQ|߷m��h�r95��y�2`�N:1�0��~�嗣ш��� �f��n�fY�q��������>}��������hD�
��&R&� ����x�b�RI%�4[&=� ���Z���珎���&!D������e]���~<�e�"���ݻw���eY����S���O��T\*!�V�����I�^D����>|���,�J�VB8�t]�d2������;���K���7��4�>���^{��h�U�q�u���b�㸷�z�������?88(�˙L��o���y��Y^^.
�=�yc\\*�nݺ�uc�����|&I�|���ǹr��  ��:�c��    IEND�B`�

=== Content from github.com_d96fef36_20250115_175842.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv8.0.3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv8.0.3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v8.0.3)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v8.0.3)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v8.0.3](/npgsql/npgsql/releases/tag/v8.0.3)

# v8.0.3

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v8.0.3)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:26

·
[186 commits](/npgsql/npgsql/compare/v8.0.3...main)
to main
since this release

[v8.0.3](/npgsql/npgsql/tree/v8.0.3)

[`c5aab16`](/npgsql/npgsql/commit/c5aab163a27a328af4cdb2e2285c7dcc46b2d1d8)

This commit was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/4218809?s=64&v=4)](/NinoFloris)
[NinoFloris](/NinoFloris)
Nino Floris

GPG key ID: E369AF867692D088

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

A large number of number of bugs have been fixed, [here is the full list](https://github.com/npgsql/npgsql/milestone/112?closed=1).

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

 👍
7
 mhguelleh, htmlexe, callmekohei, 1270011, maykelsantos, Junaid-6, and Kabasa008 reacted with thumbs up emoji
 🚀
1
 totpero reacted with rocket emoji

All reactions

* 👍
  7 reactions
* 🚀
  1 reaction

 8 people reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_30efb049_20250115_181600.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fsecurity%2Fadvisories%2FGHSA-x9vc-6hfv-hg8c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fsecurity%2Fadvisories%2FGHSA-x9vc-6hfv-hg8c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

# SQL Injection via Protocol Message Size Overflow

High

[NinoFloris](/NinoFloris)
published
GHSA-x9vc-6hfv-hg8c
May 9, 2024

## Package

nuget

Npgsql
([NuGet](/advisories?query=ecosystem%3Anuget))

## Affected versions

>= 8.0.0, < 8.0.3 <= 4.0.13 >= 4.1.0, < 4.1.13 >= 5.0.0, < 5.0.18 >= 6.0.0, < 6.0.11 >= 7.0.0, < 7.0.7

## Patched versions

8.0.3 4.0.14 4.1.13 5.0.18 6.0.11 7.0.7

## Description

### Summary

The `WriteBind()` method in `src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs` uses `int` variables to store the message length and the sum of parameter lengths. Both variables overflow when the sum of parameter lengths becomes too large.

This causes Npgsql to write a message size that is too small when constructing a Postgres protocol message to send it over the network to the database. When parsing the message, the database will only read a small number of bytes and treat any following bytes as new messages while they belong to the old message.

Attackers can abuse this to inject arbitrary Postgres protocol messages into the connection, leading to the execution of arbitrary SQL statements on the application's behalf.

### Impact

Attackers can issue arbitrary SQL statements to the database on behalf of the application. The final impact depends on the application that uses Npgsql, the data it stores in Postgres, etc.

### Severity

High

8.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H

### CVE ID

CVE-2024-32655

### Weaknesses

[CWE-20](/advisories?query=cwe%3A20)

### Credits

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=40&v=4)](/paul-gerste-sonarsource)
  [paul-gerste-sonarsource](/paul-gerste-sonarsource)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_bf2c6808_20250115_175836.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/e34e2ba8042e666d9af54a1b255fba4d5b11df56)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/e34e2ba8042e666d9af54a1b255fba4d5b11df56)
Browse the repository at this point in the history

```
* Changes to make project compile

(cherry picked from commit 300bbeaaf4b70200a4994ec68e3dd8fe9c469c16)

* Add message length validation to flush and direct write

(cherry picked from commit 6746110fcd3bc14435f3388d46686561ff33c534)

* Fix direct write byte count

(cherry picked from commit 983bc37586cd8da706bb2ef9ad2170556577fe6f)

---------

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[8471dbd](/npgsql/npgsql/commit/8471dbd7d90448414999f76c2b07bc0577f27ede)

commit e34e2ba

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**182 additions**
and
**20 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + Npgsql.Json.NET

    - src/Npgsql.Json.NET/Npgsql.Json.NET.csproj
      [Npgsql.Json.NET.csproj](#diff-42e3243507b8a7accd293b4771063a2de2467e400688fd8ef4e3b526e9213c3e)
  + Npgsql

    - src/Npgsql/Common.cs
      [Common.cs](#diff-34b06f934c666ef68b8db5e856236fab8580f46278ef4cf20f86be3b3bf24886)
    - FrontendMessages

      * src/Npgsql/FrontendMessages/BindMessage.cs
        [BindMessage.cs](#diff-8f6e4dc8810aa44a380e8bd79b752aebfa82b845deaf41fa9dad8227e3ed1718)
      * src/Npgsql/FrontendMessages/ParseMessage.cs
        [ParseMessage.cs](#diff-6f0c730a0106116765c2437c19d442f1ae2cd3ab68662c29083e7521ac16694d)
      * src/Npgsql/FrontendMessages/QueryMessage.cs
        [QueryMessage.cs](#diff-d433817affb03f64c1aca00750d13e8d3397e7e674298204dca65be84a540e9c)
    - src/Npgsql/NpgsqlConnector.cs
      [NpgsqlConnector.cs](#diff-6544882ef81854ab9fa862f633446ae09e60a35a4442bba92bd03deade9ae600)
    - src/Npgsql/NpgsqlTransaction.cs
      [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
    - src/Npgsql/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2)
* test

  + Npgsql.PluginTests

    - test/Npgsql.PluginTests/Npgsql.PluginTests.csproj
      [Npgsql.PluginTests.csproj](#diff-6bcc32676278f2b5aea85ff685ab734fdb89934e286557c6207d6cad031c19aa)
  + Npgsql.Tests

    - test/Npgsql.Tests/CommandTests.cs
      [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
    - test/Npgsql.Tests/Npgsql.Tests.csproj
      [Npgsql.Tests.csproj](#diff-36b85acc566f5ecc753d62e95b62d618be4455f730e5212c5718ccdc7a440716)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[src/Npgsql.Json.NET/Npgsql.Json.NET.csproj](#diff-42e3243507b8a7accd293b4771063a2de2467e400688fd8ef4e3b526e9213c3e "src/Npgsql.Json.NET/Npgsql.Json.NET.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql.Json.NET/Npgsql.Json.NET.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,7 +23,7 @@ |
|  |  | </PropertyGroup> |
|  |  |  |
|  |  | <ItemGroup> |
|  |  | <PackageReference Include="Newtonsoft.Json" Version="11.0.2" /> |
|  |  | <PackageReference Include="Newtonsoft.Json" Version="13.0.3" /> |
|  |  | <!-- Causes issues in Appveyor and Travis |
|  |  | <PackageReference Include="Microsoft.CodeQuality.Analyzers" Version="2.6.0-beta2" PrivateAssets="All" /> |
|  |  | --> |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[src/Npgsql/Common.cs](#diff-34b06f934c666ef68b8db5e856236fab8580f46278ef4cf20f86be3b3bf24886 "src/Npgsql/Common.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/Common.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -77,6 +77,7 @@ abstract class SimpleFrontendMessage : FrontendMessage |
|  |  |  |
|  |  | internal sealed override Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | { |
|  |  | buf.StartMessage(Length); |
|  |  | if (buf.WriteSpaceLeft < Length) |
|  |  | return FlushAndWrite(buf, async); |
|  |  | Debug.Assert(Length <= buf.WriteSpaceLeft, $"Message of type {GetType().Name} has length {Length} which is bigger than the buffer ({buf.WriteSpaceLeft})"); |
| Expand Down | |  |

13 changes: 7 additions & 6 deletions

13
[src/Npgsql/FrontendMessages/BindMessage.cs](#diff-8f6e4dc8810aa44a380e8bd79b752aebfa82b845deaf41fa9dad8227e3ed1718 "src/Npgsql/FrontendMessages/BindMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/BindMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -78,12 +78,6 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | Statement.Length + 1 + |
|  |  | 2; // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (buf.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(buf.Size >= headerLength, "Buffer too small for Bind header"); |
|  |  | await buf.Flush(async); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | foreach (var p in InputParameters) |
| Expand All | | @@ -103,6 +97,13 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | 2 + // Number of result format codes |
|  |  | 2 \* (UnknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | buf.StartMessage(messageLength); |
|  |  | if (buf.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(buf.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await buf.Flush(async); |
|  |  | } |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(Portal == string.Empty); |
| Expand Down | |  |

6 changes: 4 additions & 2 deletions

6
[src/Npgsql/FrontendMessages/ParseMessage.cs](#diff-6f0c730a0106116765c2437c19d442f1ae2cd3ab68662c29083e7521ac16694d "src/Npgsql/FrontendMessages/ParseMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/ParseMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -81,8 +81,6 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | Debug.Assert(Statement != null && Statement.All(c => c < 128)); |
|  |  |  |
|  |  | var queryByteLen = \_encoding.GetByteCount(Query); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4 + Statement.Length + 1) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | var messageLength = |
|  |  | 1 + // Message code |
| Expand All | | @@ -94,6 +92,10 @@ internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | 2 + // Number of parameters |
|  |  | ParameterTypeOIDs.Count \* 4; |
|  |  |  |
|  |  | buf.StartMessage(messageLength); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4 + Statement.Length + 1) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(messageLength - 1); |
|  |  | buf.WriteNullTerminatedString(Statement); |
| Expand Down | |  |

15 changes: 10 additions & 5 deletions

15
[src/Npgsql/FrontendMessages/QueryMessage.cs](#diff-d433817affb03f64c1aca00750d13e8d3397e7e674298204dca65be84a540e9c "src/Npgsql/FrontendMessages/QueryMessage.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/FrontendMessages/QueryMessage.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -56,14 +56,19 @@ internal QueryMessage Populate(string query) |
|  |  |  |
|  |  | internal override async Task Write(NpgsqlWriteBuffer buf, bool async) |
|  |  | { |
|  |  | if (buf.WriteSpaceLeft < 1 + 4) |
|  |  | await buf.Flush(async); |
|  |  | var queryByteLen = \_encoding.GetByteCount(\_query); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | buf.StartMessage(len); |
|  |  | if (buf.WriteSpaceLeft < 1 + 4) |
|  |  | await buf.Flush(async); |
|  |  |  |
|  |  | buf.WriteByte(Code); |
|  |  | buf.WriteInt32(4 + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | 1); // Null terminator |
|  |  | buf.WriteInt32(len - 1); |
|  |  |  |
|  |  | await buf.WriteString(\_query, queryByteLen, async); |
|  |  | if (buf.WriteSpaceLeft < 1) |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[src/Npgsql/NpgsqlConnector.cs](#diff-6544882ef81854ab9fa862f633446ae09e60a35a4442bba92bd03deade9ae600 "src/Npgsql/NpgsqlConnector.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlConnector.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -502,6 +502,7 @@ void WriteStartupMessage(string username) |
|  |  | if (startupMessage.Length > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(startupMessage.Length); |
|  |  | startupMessage.WriteFully(WriteBuffer); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -229,6 +229,9 @@ public void Save(string name) |
|  |  | CheckReady(); |
|  |  | if (!\_connector.DatabaseInfo.SupportsTransactions) |
|  |  | return; |
|  |  |  |
|  |  | // Note that creating a savepoint doesn't actually send anything to the backend (only prepends), so strictly speaking we don't |
|  |  | // have to start a user action. However, we do this for consistency as if we did (for the checks and exceptions) |
|  |  | using (\_connector.StartUserAction()) |
|  |  | { |
|  |  | Log.Debug($"Creating savepoint {name}", \_connector.Id); |
| Expand Down | |  |

61 changes: 60 additions & 1 deletion

61
[src/Npgsql/NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2 "src/Npgsql/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/src/Npgsql/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -45,6 +45,7 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  | internal readonly NpgsqlConnector Connector; |
|  |  |  |
|  |  | internal Stream Underlying { private get; set; } |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// The total byte length of the buffer. |
| Expand All | | @@ -61,6 +62,9 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | [CanBeNull] |
|  |  | ParameterStream \_parameterStream; |
|  |  |  |
| Expand Down  Expand Up | | @@ -106,6 +110,8 @@ public async Task Flush(bool async) |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -148,15 +154,19 @@ internal void DirectWrite(byte[] buffer, int offset, int count) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(count + 4); |
|  |  | WriteInt32(checked(count + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(count); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -484,9 +494,58 @@ void WriteCopyDataHeader() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength != null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Did not write the amount of bytes the message length specified"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | new InvalidOperationException("No message was started"); |
|  |  | } |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Tried to write more bytes than the message length specified"); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[test/Npgsql.PluginTests/Npgsql.PluginTests.csproj](#diff-6bcc32676278f2b5aea85ff685ab734fdb89934e286557c6207d6cad031c19aa "test/Npgsql.PluginTests/Npgsql.PluginTests.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.PluginTests/Npgsql.PluginTests.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,8 +21,8 @@ |
|  |  | <PackageReference Include="NodaTime" Version="2.4.4" /> |
|  |  | <PackageReference Include="NUnit" Version="3.11.0" /> |
|  |  | <PackageReference Include="NLog" Version="4.5.11" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="15.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="3.12.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | </Project> |

90 changes: 90 additions & 0 deletions

90
[test/Npgsql.Tests/CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b "test/Npgsql.Tests/CommandTests.cs")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.Tests/CommandTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -885,6 +885,96 @@ public void UseAcrossConnectionChange([Values(PrepareOrNot.Prepared, PrepareOrNo |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | [Test] |
|  |  | public void Parameter\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | using var conn = OpenConnection(); |
|  |  | using var cmd = new NpgsqlCommand("SELECT @a, @b, @c, @d, @e, @f, @g, @h", conn); |
|  |  |  |
|  |  | var largeParam = new string('A', 1 << 29); |
|  |  | cmd.Parameters.AddWithValue("a", largeParam); |
|  |  | cmd.Parameters.AddWithValue("b", largeParam); |
|  |  | cmd.Parameters.AddWithValue("c", largeParam); |
|  |  | cmd.Parameters.AddWithValue("d", largeParam); |
|  |  | cmd.Parameters.AddWithValue("e", largeParam); |
|  |  | cmd.Parameters.AddWithValue("f", largeParam); |
|  |  | cmd.Parameters.AddWithValue("g", largeParam); |
|  |  | cmd.Parameters.AddWithValue("h", largeParam); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(() => cmd.ExecuteReaderAsync()); |
|  |  | } |
|  |  |  |
|  |  | [Test, NonParallelizable] |
|  |  | public void Composite\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | var csb = new NpgsqlConnectionStringBuilder(ConnectionString) |
|  |  | { |
|  |  | ApplicationName = nameof(Composite\_overflow\_message\_length\_throws), // Prevent backend type caching in TypeHandlerRegistry |
|  |  | Pooling = false |
|  |  | }; |
|  |  |  |
|  |  | using var connection = OpenConnection(csb.ToString()); |
|  |  | connection.ExecuteNonQuery( |
|  |  | "CREATE TYPE pg\_temp.composite\_overflow AS (a text, b text, c text, d text, e text, f text, g text, h text)"); |
|  |  | connection.ReloadTypes(); |
|  |  | connection.TypeMapper.MapComposite<BigComposite>("composite\_overflow"); |
|  |  |  |
|  |  | var largeString = new string('A', 1 << 29); |
|  |  |  |
|  |  | using var cmd = connection.CreateCommand(); |
|  |  | cmd.CommandText = "SELECT @a"; |
|  |  | cmd.Parameters.AddWithValue("a", new BigComposite |
|  |  | { |
|  |  | A = largeString, |
|  |  | B = largeString, |
|  |  | C = largeString, |
|  |  | D = largeString, |
|  |  | E = largeString, |
|  |  | F = largeString, |
|  |  | G = largeString, |
|  |  | H = largeString |
|  |  | }); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(async () => await cmd.ExecuteNonQueryAsync()); |
|  |  | } |
|  |  |  |
|  |  | class BigComposite |
|  |  | { |
|  |  | public string A { get; set; } = null!; |
|  |  | public string B { get; set; } = null!; |
|  |  | public string C { get; set; } = null!; |
|  |  | public string D { get; set; } = null!; |
|  |  | public string E { get; set; } = null!; |
|  |  | public string F { get; set; } = null!; |
|  |  | public string G { get; set; } = null!; |
|  |  | public string H { get; set; } = null!; |
|  |  | } |
|  |  |  |
|  |  | [Test] |
|  |  | public void Array\_overflow\_message\_length\_throws() |
|  |  | { |
|  |  | using var connection = OpenConnection(); |
|  |  |  |
|  |  | var largeString = new string('A', 1 << 29); |
|  |  |  |
|  |  | using var cmd = connection.CreateCommand(); |
|  |  | cmd.CommandText = "SELECT @a"; |
|  |  | var array = new[] |
|  |  | { |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString, |
|  |  | largeString |
|  |  | }; |
|  |  | cmd.Parameters.AddWithValue("a", array); |
|  |  |  |
|  |  | Assert.ThrowsAsync<OverflowException>(async () => await cmd.ExecuteNonQueryAsync()); |
|  |  | } |
|  |  |  |
|  |  | [Test, Description("CreateCommand before connection open")] |
|  |  | [IssueLink("https://github.com/npgsql/npgsql/issues/565")] |
|  |  | public void CreateCommandBeforeConnectionOpen() |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[test/Npgsql.Tests/Npgsql.Tests.csproj](#diff-36b85acc566f5ecc753d62e95b62d618be4455f730e5212c5718ccdc7a440716 "test/Npgsql.Tests/Npgsql.Tests.csproj")

Show comments

[View file](/npgsql/npgsql/blob/e34e2ba8042e666d9af54a1b255fba4d5b11df56/test/Npgsql.Tests/Npgsql.Tests.csproj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,11 +16,11 @@ |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | <ItemGroup> |
|  |  | <PackageReference Include="NUnit" Version="3.11.0" /> |
|  |  | <PackageReference Include="NUnit" Version="3.12.0" /> |
|  |  | <PackageReference Include="NLog" Version="4.5.11" /> |
|  |  | <PackageReference Include="Microsoft.CSharp" Version="4.5.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="15.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="3.12.0" /> |
|  |  | <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Include="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | </ItemGroup> |
|  |  |  |
|  |  | <ItemGroup Condition=" '$(TargetFramework)' == 'net451' "> |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e34e2ba`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2Fe34e2ba8042e666d9af54a1b255fba4d5b11df56) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ee336423_20250115_175839.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv4.1.13)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv4.1.13)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v4.1.13)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v4.1.13)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v4.1.13](/npgsql/npgsql/releases/tag/v4.1.13)

# v4.1.13

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v4.1.13)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:22

·
[1485 commits](/npgsql/npgsql/compare/v4.1.13...main)
to main
since this release

[v4.1.13](/npgsql/npgsql/tree/v4.1.13)

[`db69b1c`](/npgsql/npgsql/commit/db69b1c964e532d30a18ec5e11d8a4491f4be661)

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

 👍
1
 firstDismay reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

 1 person reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a9b0d65d_20250115_175838.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv4.0.14)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv4.0.14)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v4.0.14)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v4.0.14)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v4.0.14](/npgsql/npgsql/releases/tag/v4.0.14)

# v4.0.14

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v4.0.14)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:22

·
[1938 commits](/npgsql/npgsql/compare/v4.0.14...main)
to main
since this release

[v4.0.14](/npgsql/npgsql/tree/v4.0.14)

[`e34e2ba`](/npgsql/npgsql/commit/e34e2ba8042e666d9af54a1b255fba4d5b11df56)

This commit was created on GitHub.com and signed with GitHub’s **verified signature**.

GPG key ID: B5690EEEBB952194

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_c2b8030e_20250115_175840.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv6.0.11)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Freleases%2Ftag%2Fv6.0.11)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql/tree/v6.0.11)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql/tree/v6.0.11)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

1. [Releases](/npgsql/npgsql/releases)
2. [v6.0.11](/npgsql/npgsql/releases/tag/v6.0.11)

# v6.0.11

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/npgsql/npgsql/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v6.0.11)

 Loading

[View all tags](/npgsql/npgsql/tags)

![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)
[roji](/roji)
released this
09 May 14:23

·
[788 commits](/npgsql/npgsql/compare/v6.0.11...main)
to main
since this release

[v6.0.11](/npgsql/npgsql/tree/v6.0.11)

[`3419c99`](/npgsql/npgsql/commit/3419c993b672e1bdf1f1e1730d2bc306ca6cc066)

This commit was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/4218809?s=64&v=4)](/NinoFloris)
[NinoFloris](/NinoFloris)
Nino Floris

GPG key ID: E369AF867692D088

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

This version contains a high-severity security patch for [CVE-2024-32655](https://github.com/npgsql/npgsql/security/advisories/GHSA-x9vc-6hfv-hg8c) everyone is advised to upgrade.

Thanks to [@paul-gerste-sonarsource](https://github.com/paul-gerste-sonarsource) for reporting the vulnerability.

### Contributors

* [![@paul-gerste-sonarsource](https://avatars.githubusercontent.com/u/79814126?s=64&v=4)](https://github.com/paul-gerste-sonarsource)

paul-gerste-sonarsource

 Assets
2

 Loading

All reactions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_9822c7d3_20250115_175829.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F091655eed0c84e502ab424950c930339d17c1928)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F091655eed0c84e502ab424950c930339d17c1928)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/091655eed0c84e502ab424950c930339d17c1928)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/091655eed0c84e502ab424950c930339d17c1928)
Browse the repository at this point in the history

* Loading branch information

[![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[be50041](/npgsql/npgsql/commit/be50041cb2c383f3846d54f0c864659ad3fd61ee)

commit 091655e

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**272 additions**
and
**30 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Npgsql

  + Internal

    - src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs
      [NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b)
    - src/Npgsql/Internal/NpgsqlWriteBuffer.cs
      [NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
* test/Npgsql.Tests

  + test/Npgsql.Tests/CommandTests.cs
    [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)
  + Support

    - test/Npgsql.Tests/Support/PgPostmasterMock.cs
      [PgPostmasterMock.cs](#diff-e8fb4b1594aca03e660f01ad16cc7571aa536820df33d1e3c1b5ef34e76b888b)
    - test/Npgsql.Tests/Support/PgServerMock.cs
      [PgServerMock.cs](#diff-48ad1927ec29dea7081310f5f40348824f0378f81eea18c28939caa2b42e62c0)
  + test/Npgsql.Tests/WriteBufferTests.cs
    [WriteBufferTests.cs](#diff-b75e35eba1a49ae8fa5ec1030cc05440d7caa2a2b391bf9f42af26bbe06bd374)

## There are no files selected for viewing

56 changes: 38 additions & 18 deletions

56
[src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs](#diff-23d46be3980cd5e3493df8e527db6e261b71e9695490333f8aeb75c7c449bc8b "src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/091655eed0c84e502ab424950c930339d17c1928/src/Npgsql/Internal/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, byte[] asciiNam |
|  |  | (asciiName.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, asciiName, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -48,6 +49,7 @@ internal Task WriteSync(bool async, CancellationToken cancellationToken = defaul |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -79,6 +81,7 @@ internal Task WriteExecute(int maxRows, bool async, CancellationToken cancellati |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -118,9 +121,6 @@ internal async Task WriteParse(string sql, byte[] asciiName, List<NpgsqlParamete |
|  |  | } |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | if (writeBuffer.WriteSpaceLeft < 1 + 4 + asciiName.Length + 1) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
|  |  | sizeof(int) + // Length |
| Expand All | | @@ -130,9 +130,14 @@ internal async Task WriteParse(string sql, byte[] asciiName, List<NpgsqlParamete |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | writeBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | writeBuffer.WriteInt32(messageLength - 1); |
|  |  | writeBuffer.WriteNullTerminatedString(asciiName); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + asciiName.Length + 1) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(asciiName); |
|  |  |  |
|  |  | await writeBuffer.WriteString(sql, queryByteLen, async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand Down  Expand Up | | @@ -171,12 +176,6 @@ internal async Task WriteBind( |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | if (writeBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(writeBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | for (var paramIndex = 0; paramIndex < parameters.Count; paramIndex++) |
| Expand All | | @@ -197,8 +196,15 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | writeBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | writeBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
|  |  | writeBuffer.WriteByte(0); // Portal is always empty |
|  |  |  |
| Expand Down  Expand Up | | @@ -269,6 +275,7 @@ internal Task WriteClose(StatementOrPortal type, byte[] asciiName, bool async, C |
|  |  | asciiName.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | var writeBuffer = WriteBuffer; |
|  |  | writeBuffer.StartMessage(len); |
|  |  | if (writeBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, type, asciiName, async, cancellationToken); |
|  |  |  |
| Expand Down  Expand Up | | @@ -296,14 +303,17 @@ internal async Task WriteQuery(string sql, bool async, CancellationToken cancell |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async, cancellationToken).ConfigureAwait(false); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -316,6 +326,7 @@ internal async Task WriteCopyDone(bool async, CancellationToken cancellationToke |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -331,6 +342,7 @@ internal async Task WriteCopyFail(bool async, CancellationToken cancellationToke |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -348,6 +360,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -362,6 +375,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -374,6 +388,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -394,6 +409,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | NpgsqlWriteBuffer.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -417,8 +433,10 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
|  |  | WriteBuffer.WriteInt32(sizeof(int) + count); |
|  |  |  |
| Expand All | | @@ -441,6 +459,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  |  |
| Expand All | | @@ -464,6 +483,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async = false, CancellationToken cancellationToken = default) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async, cancellationToken); |
|  |  |  |
| Expand Down | |  |

61 changes: 59 additions & 2 deletions

61
[src/Npgsql/Internal/NpgsqlWriteBuffer.cs](#diff-39c618fd41cae66bec55e4361b1fa615270e61abef463eea749599e1f7f1040c "src/Npgsql/Internal/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/091655eed0c84e502ab424950c930339d17c1928/src/Npgsql/Internal/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,8 @@ sealed class NpgsqlWriteBuffer : IDisposable |
|  |  | internal Stream Underlying { private get; set; } |
|  |  |  |
|  |  | readonly Socket? \_underlyingSocket; |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | readonly ResettableCancellationTokenSource \_timeoutCts; |
|  |  | readonly MetricsReporter? \_metricsReporter; |
|  |  |  |
| Expand Down  Expand Up | | @@ -77,6 +79,9 @@ internal PgWriter GetWriter(NpgsqlDatabaseInfo typeCatalog, FlushMode flushMode |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | bool \_disposed; |
|  |  | readonly PgWriter \_pgWriter; |
|  |  |  |
| Expand Down  Expand Up | | @@ -132,6 +137,8 @@ public async Task Flush(bool async, CancellationToken cancellationToken = defaul |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | var finalCt = async && Timeout > TimeSpan.Zero |
|  |  | ? \_timeoutCts.Start(cancellationToken) |
| Expand Down  Expand Up | | @@ -200,15 +207,19 @@ internal void DirectWrite(ReadOnlySpan<byte> buffer) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(buffer.Length + 4); |
|  |  | WriteInt32(checked(buffer.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(buffer.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand All | | @@ -231,15 +242,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async, Cancell |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async, cancellationToken).ConfigureAwait(false); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -537,9 +552,51 @@ public void Dispose() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength is not null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | throw Connector.Break(new OverflowException("Did not write the amount of bytes the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | throw Connector.Break(new InvalidOperationException("No message was started")); |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | throw Connector.Break(new OverflowException("Tried to write more bytes than the message length specified")); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

11 changes: 1 addition & 10 deletions

11
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/091655eed0c84e502ab424950c930339d17c1928/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -224,16 +224,7 @@ public void Save(string name) |
|  |  |  |
|  |  | // Note: savepoint names are PostgreSQL identifiers, and so limited by default to 63 characters. |
|  |  | // Since we are prepending, we assume below that the statement will always fit in the buffer. |
|  |  | \_connector.WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | \_connector.WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | \_connector.TextEncoding.GetByteCount("SAVEPOINT ") + |
|  |  | \_connector.TextEncoding.GetByteCount(name) + |
|  |  | sizeof(byte)); // Null terminator |
|  |  |  |
|  |  | \_connector.WriteBuffer.WriteString("SAVEPOINT "); |
|  |  | \_connector.WriteBuffer.WriteString(name); |
|  |  | \_connector.WriteBuffer.WriteByte(0); |
|  |  | \_connector.WriteQuery("SAVEPOINT " + name, async: false).GetAwaiter().GetResult(); |
|  |  |  |
|  |  | \_connector.PendingPrependedResponses += 2; |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `091655e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F091655eed0c84e502ab424950c930339d17c1928) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.youtube.com_2c7438d5_20250115_175844.html ===
[00:00] welcome everybody to SQL injection isn't
[00:03] dead smuggling queries at the protocol
[00:06] level or how I like to call it SQL
[00:09] injection lower
[00:11] decks because usually with SQL injection
[00:13] you're at the high level like at the
[00:15] bridge where the captain and the high
[00:16] ranking officers are and they're
[00:18] speaking their query language and their
[00:20] business language but today we're going
[00:23] to do go down to the lower decks where
[00:25] the mechanics are and where they shift
[00:27] around the bits and bites
[00:30] so to hook you at the beginning I have a
[00:32] small teaser this code snippit is a
[00:34] small HTTP request Handler written in go
[00:37] and it just takes a user ID from the
[00:40] body and uses it in a prepared statement
[00:42] to select the user and if you think
[00:44] everything's fine here there's no way
[00:46] for skl injection then you should stay
[00:48] because I'm going to prove you
[00:50] wrong and at a high level in this talk
[00:53] we're going to look at how applications
[00:55] talk to their databases over the network
[00:57] and how attackers can inject in that
[01:00] connection and what can go wrong and
[01:03] also how prevalent the problem
[01:05] is a bit about me I'm Paul I'm a
[01:08] vulnerability researcher at sonar's R&D
[01:11] team and if you don't know sonar we're
[01:13] the home of clean code so we help
[01:14] developers Write Clean code which also
[01:16] means secure code and that's why we look
[01:18] at a lot of code and uh try to find
[01:21] stuff there so for the rough outline
[01:24] first we're going to look at the idea of
[01:26] all of this research and then we'll go
[01:28] into the main part of the talk which is
[01:29] is attacking the database wire protocols
[01:32] and we're going to focus on post grass
[01:34] and mongodb here then we'll put things
[01:37] into perspective uh by looking at the
[01:39] real world applicability of the research
[01:41] and then give you some ideas for future
[01:43] re future research and draw some
[01:46] takeaways so in short the idea is to do
[01:50] request smuggling but for binary
[01:53] protocols and of course for this I have
[01:55] to mention James kettle's HTP DC attacks
[01:59] where you BAS basically cause a
[02:00] disagreement between two systems over
[02:02] the end of a HTTP request for example
[02:05] between a reverse proxy and an upstream
[02:07] backend and if they don't agree on where
[02:09] a message ends or a HTTP request in this
[02:12] case then the attacker can do some bad
[02:15] things and the root causes of this were
[02:17] many fold but some examples are text
[02:19] parsing where one system would only
[02:21] accept the exact word chunked and the
[02:24] other one would also allow a tapped
[02:26] character in front uh or they were
[02:28] logical where one system used the
[02:29] content length header and the other used
[02:31] the transfer encoding and then things
[02:33] were off again but what about other
[02:36] protocols and specifically what about
[02:38] binary
[02:39] protocols uh where do they have M
[02:42] message boundaries how do they do it um
[02:44] some of them have delimiters where for
[02:47] example in null terminated strings the
[02:49] null bite is the delimiter that tells
[02:50] the end of the string or you might have
[02:53] length Fields uh and there's an entirely
[02:55] entire family of protocols that are
[02:57] called tlv or type length value
[02:59] protocols because I have a type field
[03:01] and then a length field and then the
[03:03] rest of the message is the
[03:05] value so how could we desync in these
[03:08] protocols uh for the limiters it sounds
[03:11] quite easy you just have to find a way
[03:12] to put a delimiter where it's not
[03:14] supposed to be in a value of course it's
[03:17] not that simple but at least you
[03:19] directly have an idea of what you could
[03:21] do uh but for length Fields I was stuck
[03:24] for a moment and thought about okay you
[03:25] have a length field it has a fixed size
[03:27] it has a fixed location in the message
[03:29] so what could go wrong there and then I
[03:31] thought okay maybe some indianness
[03:33] issues or maybe uh integer overflows and
[03:37] I wanted to go deeper into that so for
[03:40] that I first looked at the Modern web
[03:42] application landscape where are binary
[03:45] protocols used there so at the center
[03:47] you always have the application and it
[03:49] talks to databases or caches uh storages
[03:54] message cues structured logging and so
[03:57] on and I wanted to focus on connection
[04:00] between the application and the
[04:02] database uh and that was because I
[04:04] thought that if I would find something
[04:07] it would have a great applicability
[04:08] because every almost every web app has a
[04:11] database um then there's a big potential
[04:14] severity because databases are high
[04:16] value targets because they either
[04:17] contain interesting data like personal
[04:19] information or relevant data to the
[04:22] application for example used for
[04:24] authentication and then also the
[04:26] exploitability should be quite good
[04:28] because what web app has a database but
[04:31] doesn't let the user query something
[04:33] from that database right so we have kind
[04:36] of guaranteed user
[04:38] input so let's start in and look at some
[04:42] uh database wire protocols and for that
[04:44] I have a small overview of four uh
[04:47] popular databases and how their messages
[04:50] in their protocols look like so for
[04:53] postgress this is how a message looks
[04:55] like uh you have a type byte then a 4
[04:57] byte length and then develop which in
[05:00] this case is just uh the string that's
[05:02] an SQL
[05:03] statement for MySQL it looks kind of
[05:06] similar your first have the length it's
[05:08] only three bytes but then you have a one
[05:10] bite sequence which would allow you to
[05:13] send multiple packets that would be
[05:15] reassembled to one big message at the
[05:17] end and there Al of course Al you have
[05:20] the value for redis which is not exactly
[05:23] a binary protocol but their docs kind of
[05:26] read like this uh because they talk
[05:28] about oh here the have this bite so I
[05:30] wanted to include it anyways there you
[05:33] first have a type bite then you have a
[05:34] length but it's not a fixed size field
[05:37] it's a decimal integer that has to be
[05:39] pared then you have a delimiter and then
[05:41] the value and then another
[05:43] delimiter and finally for mongodb um
[05:47] it's a little bit longer you first have
[05:48] the message length again a 4 byte field
[05:51] then you have a little bit more metadata
[05:53] for example the op code is like the
[05:54] message type and then the value is a
[05:56] little bit more of a complicated binary
[05:58] structure called B
[06:01] on so let's start with postgress uh
[06:05] again this is how a packet looks there
[06:07] one byte type identifier 4 byte integer
[06:10] length field and then the value so I
[06:13] thought about okay 4 byte integer Fields
[06:16] you can fit quite big numbers in there
[06:18] like 2 to the^ of 32 minus 1 which is
[06:21] roughly the size of 4 GB but maybe what
[06:25] if we could somehow make a query that's
[06:29] bigger than that how do actually
[06:31] libraries handle this um this kind of
[06:34] too large thing and for that I started
[06:38] to look into code of postgress client
[06:40] libraries and I found the first bug this
[06:43] is the code of a library called PGX it's
[06:46] written in go and this function is
[06:48] supposed to encode the content of a of a
[06:51] message into a larger message buffer so
[06:54] first it writes the message type in this
[06:56] case it's a B for a bind message then it
[06:59] saves the offset where it should later
[07:01] write the size to then it adds all of
[07:04] the actual data of the message and
[07:07] finally it writes the size and to do
[07:09] that it first slices the message buffer
[07:12] to the exact size of what is included in
[07:15] the length for example not the type bite
[07:18] then it takes the length of this sliced
[07:19] buffer and here the length is of type
[07:22] int which in most modern systems is a
[07:24] 64-bit integer but then this is
[07:28] truncated down explicitly to an
[07:30] in32 so we have a problem here because
[07:33] if the length was bigger than what can
[07:35] be expressed in an
[07:36] in32 we now have a truncation and the
[07:39] number becomes very small but then the
[07:41] library still sends all of the data
[07:44] after that so then if the database has
[07:46] to parse this message it will just see a
[07:48] very small length and only parse a very
[07:50] small message and then try to parse
[07:53] whatever is coming after that as more
[07:55] messages but in fact it's data from the
[07:58] first message
[08:00] so let's look at this again with example
[08:02] messenges um so here we have a very
[08:05] small one we have a four by value and
[08:08] then the length becomes eight because
[08:09] the size of the length field itself is
[08:11] also included in the length so it's a
[08:13] length of
[08:14] eight this is how the largest possible
[08:18] message looks like you can see the
[08:19] length is filled to the brim with hex FF
[08:23] because the value is just almost 4
[08:25] gigabytes of Ace but still everything's
[08:27] good because the application can Express
[08:30] this length in the four bytes and so the
[08:32] database will parse the same
[08:34] size but if we make it just a little bit
[08:37] larger we can see that the truncation
[08:40] happens because the most significant bit
[08:42] is not represented in the length anymore
[08:44] so the length is just four which means
[08:46] this is a tiny message and then after
[08:48] that in the connection there come some
[08:50] garbage A's that the database can't
[08:52] really understand but if the attacker
[08:54] chooses not A's but some bites that the
[08:58] database can understand they can craft
[09:00] an injected message
[09:02] here so let's zoom out again and look at
[09:05] this again this is the small message all
[09:08] is good this is the large message that
[09:11] does not cause a truncation so both the
[09:14] application and the data base see it and
[09:16] pars it the same
[09:17] way but if we make the size a little bit
[09:20] too big the application thinks it's
[09:22] writing this big number but actually
[09:25] because of the truncation bug it writes
[09:27] a small number so when the database
[09:29] pares it it sees one small message and
[09:32] then garbage or if the payload is
[09:35] cleverly crafted it sees more messages
[09:38] that can contain attacker controlled SQL
[09:40] statements like this one that adds a new
[09:42] admin
[09:44] user so the impact is quite High here um
[09:47] you can inject entire SQL statements
[09:50] you're not limited to Union based or
[09:52] subquery based SQL injection like with
[09:54] the very classic ones it's more like if
[09:56] you have stack queries enabled so you
[09:58] can just finish the first statement that
[10:01] you're injecting into and then have a
[10:03] whole another one that can be an insert
[10:05] even if the other one was a select and
[10:07] so on so this means the attacker can
[10:10] essentially read write and delete all
[10:12] the data in the database with the
[10:14] permissions of the application and if
[10:16] the database is configured insecurely
[10:18] this can already lead to code execution
[10:20] um or you just have all of the data from
[10:23] the database which is bad
[10:25] enough the only thing that's a little
[10:27] bit less convenient than with classic
[10:29] SQL injections is that data exfiltration
[10:33] is a little bit uh less straightforward
[10:36] because if you're injecting more
[10:38] messages into the connection then the
[10:40] application will still only process the
[10:42] answer for the first message so you
[10:45] don't directly get the result of your
[10:47] injected message where you maybe select
[10:49] all the password reset tokens of users
[10:52] um so you have to go uh a different
[10:54] route of maybe doing a sub cury and then
[10:56] using an insert to put this data you
[10:58] want to exfiltrate another table and
[11:00] then use business logic of the
[11:01] application to access the data so it
[11:03] still works just a little less
[11:06] convenient but how does this look in the
[11:08] real world uh some of you might have
[11:11] already noticed that if we control all
[11:13] of these A's that we have in a message
[11:15] why can't we just directly put any SQL
[11:17] statement in the first place why do we
[11:19] need to have the Overflow and you would
[11:21] be correct because this was just the
[11:24] simplification so let's look at how this
[11:26] actually looks um this is a two line
[11:29] code snippet uh the ID here is user
[11:32] controlled in this case it's a very
[11:34] small one and then we have our query you
[11:37] might recognize it from the teaser code
[11:38] snippet that uses the ID to select a
[11:41] user from the database and the resulting
[11:43] packet or message that's sent over the
[11:45] wire looks like this we have our type
[11:47] bite then a small length and then we
[11:49] have the value with a trailing null bite
[11:52] uh all is fine here but now if the
[11:54] attacker makes the user controlled ID
[11:57] very large for a gigabyte
[11:59] then suddenly the length in the packet
[12:01] is smaller than before even then even
[12:04] though we send more data so we see that
[12:06] the truncation happened and now when the
[12:09] database tries to parse this packet um
[12:11] it will see okay it's a length of 38
[12:14] bytes so I'm going to parse until that
[12:17] and after that it will try to parse the
[12:19] next message so the attacker has to put
[12:21] their cleverly crafted payLo at that
[12:23] exact offset in this big buffer of
[12:27] a but how does the attacker know this
[12:31] offset um the offset depends on the
[12:34] query that they are injecting into and
[12:37] uh especially on the injection point in
[12:38] the query and the length of the whole
[12:40] query so if you know these things you
[12:43] can just calculate the offset and you're
[12:45] done but maybe you're lazy and don't
[12:47] want to do the math or you don't know
[12:48] the query because it's kind of a
[12:50] blackbox test um so what can you do
[12:53] then and of course the naive solution is
[12:55] to Brute Force the offsets uh but
[12:58] unfortunately you for each try you have
[13:00] to send four gigabytes which is slow
[13:02] even on local setups and on like
[13:04] production setups it creates a lot of
[13:06] noise and risks Deni of service because
[13:08] it's a lot of data so can we make this
[13:11] more
[13:12] reliable and the first technique uh I
[13:15] tried out here was to borrow something
[13:17] from binary exploitation from 20 plus
[13:19] years ago which is called a knob slat
[13:22] and mapped to this problem we just use a
[13:25] lot of very small message at the
[13:27] beginning of the buffer so that when we
[13:29] hit the start of one of these messages
[13:32] uh everything's fine because the message
[13:33] is parsed and then the next one and then
[13:35] the next one and so on until at the very
[13:38] end the big message with the actual Atta
[13:41] SQL payload is poed and executed but if
[13:45] we hit any other bite um the database
[13:48] will cause a fatal error because it
[13:50] cannot par there and it will close the
[13:53] connection between the application and
[13:54] the database but usually that's not too
[13:56] bad because applications have connection
[13:58] pools and they just reopen connections
[14:01] if they get
[14:02] closed so let's visualize this this is
[14:05] the smallest possible message in the
[14:07] posterous wire protocol so we repeat
[14:09] this a lot of times and in the end we
[14:12] have our actual payload so if the offset
[14:16] happens to align with the first or the
[14:18] fifth and so on buy it then we're good
[14:21] but if it hits one of the other biets
[14:24] then there's this fatal parsing error
[14:25] and the connection is closed so if that
[14:28] happens we can try again and now we just
[14:31] prepended one petting bite and then if
[14:35] it if the offset happened to align with
[14:37] the second bite and so on then now this
[14:40] attempt would be lucky otherwise we'
[14:41] just try again and again and again until
[14:45] we're lucky at the last
[14:47] try uh so this means that after a
[14:50] maximum of five attempts uh the attack
[14:53] is successful because each try has a 20%
[14:55] chance of success and we can repeat the
[14:57] attack but still in the worst case we
[15:00] have to send 5 Time 4 GB which can still
[15:03] be a lot so maybe we can make it even
[15:06] better and for this I looked at what was
[15:09] holding us back with the last strategy
[15:12] and here it was the length bites because
[15:14] those were not valid type bites so not a
[15:16] valid start of a message so maybe we can
[15:19] make them valid type bites and I call
[15:22] this technique trampolines and what we
[15:24] do here is first we just use the Q which
[15:27] is a valid Tye bite for each bite uh
[15:30] because this is also uh some big length
[15:34] it's hex 51 51 and so on and uh we can
[15:38] see down below the whole Atta uh payload
[15:42] and uh we'll see how things are parsed
[15:45] when the offset hits certain uh certain
[15:47] bites here so if it hits the very
[15:50] beginning uh the database parles it like
[15:52] this first Q is the type bite and then
[15:55] qqqq is the length of the first message
[15:58] so the database will parse the following
[16:01] whatever qqqq means as a number bytes
[16:04] and try to run this as a query and of
[16:06] course this will cause like a semantic
[16:08] syntax error but this does not close the
[16:11] connection so the datab base will just
[16:13] complain with error response but
[16:15] continue paing the next message so this
[16:17] is like jumping over this many bytes so
[16:21] that's the trampoline right there and
[16:23] where we land after that we have a
[16:25] preconstructed message that has the
[16:27] exact size that then does another jump
[16:30] that ends up at right at the uh end of
[16:34] the attacker payload where the actual
[16:36] SQL uh statement message is so if we
[16:40] would have hit any of the other bites
[16:42] things look slightly different but not
[16:44] too different here the length is pared
[16:47] as Q SSS the S is also a very valid type
[16:51] bite uh now it jumps over some more
[16:55] bytes and it lands at a different
[16:57] preconstructed message that again has
[16:59] the exact size that it does the right
[17:01] jump to land at the
[17:04] end but does this actually work like we
[17:07] plan to do and unfortunately uh after I
[17:11] tried to implement this I noticed well
[17:13] postgress has a logical maximum message
[17:16] size next to the actual size that you
[17:19] can possibly fit into four bytes and
[17:21] this is just under 1 Gigabyte so the
[17:24] first bite of the length can never be
[17:26] larger than hex 3F so that's bad because
[17:29] with a q that doesn't
[17:31] work so what if we just use 3F as the
[17:35] type and all of the length bites then
[17:38] also doesn't work because x3f is not a
[17:40] valid type bite and also none below that
[17:44] at least not for messages from the
[17:46] application to the database um so I had
[17:49] to use a compromise here which is an
[17:50] alternating pattern and with this uh now
[17:54] every second bite is a valid type bite
[17:56] so a valid start of a message so so H we
[17:59] if we have hit any of those uh bites
[18:02] we're good because everything is pars
[18:03] okay and then we can do our trampolines
[18:05] like I just showed and if we hit any of
[18:08] the other bites like the null bite then
[18:10] we get the error and the connection is
[18:12] closed but still we can try again so
[18:14] after a maximum of two attempts we are
[18:17] successful um which is much better than
[18:20] the initial brute
[18:22] force all right let's see how many
[18:26] vulnerable libraries there were that we
[18:27] found and and this is just a selection
[18:30] we looked at more but uh these are only
[18:32] the ones that were potentially
[18:34] vulnerable so for a go we tested four
[18:37] libraries and we found all of them to be
[18:39] vulnerable and also exploitable and I'm
[18:41] going to go into exploitability in a
[18:43] minute unfortunately only one of them uh
[18:47] fixed the issues we reported and the
[18:48] others did not so they are still
[18:50] vulnerable in the latest version for C
[18:53] there was one Library we looked at it
[18:55] was vulnerable and exploitable but
[18:57] unfortunately they fix and also
[18:59] backported it to older branches of the
[19:02] library uh so that's great to see and
[19:05] then for Java and Java Script uh we
[19:08] tested a bunch of libraries and a lot of
[19:10] them were in theory vulnerable they had
[19:12] overflows without the right checks but
[19:15] they were not exploitable uh and this
[19:17] was most of the times due to language
[19:19] limitations where for example you cannot
[19:21] have large enough strings or buffers
[19:24] that would be more than 4 GB so their
[19:26] length would never overflow the 4 by
[19:28] length field and we're going to look at
[19:31] into these language differences
[19:33] later so short disclosure timeline for
[19:36] transparency we sent out the advisories
[19:38] in February this year then PGX fixed in
[19:42] March n pgsql fixed in May and for a PG
[19:45] and PG driver the maintainer first
[19:48] responded to our advisory but then
[19:50] stopped and didn't Implement fixes until
[19:52] now and for a PQ we couldn't even reach
[19:55] the maintainers we tried to do it via
[19:57] their GitHub made an issue or made a
[19:58] poll request with the fix but they got
[20:00] no attention
[20:03] unfortunately so now let's go from
[20:05] vulnerable libraries to exploitable
[20:07] Applications so first we have a set of
[20:09] applications that use these libraries or
[20:12] have used the libraries in a vulnerable
[20:13] version um and these for example include
[20:16] grafana or G or S thing but we weren't
[20:19] able to confirm if there's an
[20:21] exploitable path here so they might be
[20:23] but we haven't proven it yet and then
[20:26] there's a set of applications that we
[20:29] found to be vulnerable in a non-default
[20:31] configuration for example metam or G and
[20:35] then there was also The Sweet Spot which
[20:37] is applications that are vulnerable in
[20:39] the default config and our example here
[20:42] was Harbor and harbor is a container
[20:45] registry it's a cncf graduate project
[20:47] which means it's quite mature and people
[20:49] are using it uh it's also apparently
[20:51] part of the mare tanzu cinas but we
[20:54] don't look into more of that so we don't
[20:56] know if that's exploitable in that
[20:57] scenario as well well um but in its
[21:00] default version uh it's vulnerable in
[21:03] the default configuration and also
[21:05] pre-authentication which is quite bad so
[21:08] they fixed this in version 2.11 which is
[21:11] the latest one uh by updating their
[21:13] dependency so if you have a Harware
[21:15] instance you definitely should update to
[21:17] the latest version and I'm going to try
[21:20] to demo the Harware exploit now I'm
[21:23] going to try to do it live I also have a
[21:25] backup video um but let's see so first I
[21:29] will try to log in as the attacker to
[21:33] show that there should be no uh attacker
[21:37] user as you can see the login doesn't
[21:39] work so now if we start the exploit and
[21:43] I hope this works over the unstable
[21:46] internet um we have to wait a bit so
[21:50] there we see the query that the exploit
[21:52] is sending this is an insert query that
[21:54] will insert the attacka user into the
[21:56] database so then we could log in in and
[21:59] as we can see it's sending a lot of
[22:00] bytes 4 gigabytes so it takes some time
[22:05] um and if it's Works successfully then
[22:07] we should be able to log in and have
[22:10] administrative privileges in the Harare
[22:12] application so that we then could send
[22:15] uh or mess with the containers in there
[22:17] so we saw an error which is expected
[22:19] here so if I now try to log in
[22:23] again we should log in successfully I
[22:26] hope
[22:29] okay it doesn't seem to work I have to
[22:30] switch to the backup
[22:36] video and there on the left now we try
[22:38] to log in
[22:40] again and there we can see we can now
[22:42] log in and have admin
[22:51] privileges all right that was postgress
[22:54] now also let's look at mongodb to show
[22:56] that it's not a postgress and go only
[22:59] problem so to look back this is what a
[23:02] message in mongodb looks like we have a
[23:04] 4 by length field this time it's little
[23:06] Indian then we have two metadata fields
[23:09] that are not relevant here and then we
[23:10] have the op code which is like the
[23:12] message type and then the value is a
[23:14] complex binary structure that's called
[23:16] bon which I think stands for binary Json
[23:19] and it's some nested data uh that's
[23:21] serialized to tlv sections so they also
[23:24] have lengths
[23:25] again and to directly look at some code
[23:28] it's a little bit more but I'm going to
[23:29] walk you through it we first have uh a
[23:32] line here that takes the content bytes
[23:34] so it takes the query and puts it into
[23:36] this B Bon
[23:39] representation then it computes the
[23:41] total length of the message by adding
[23:43] the header length and all and so on and
[23:46] this is saved as a type usze variable
[23:49] again on most modern systems this is a
[23:51] 64-bit
[23:53] integer and then again this is truncated
[23:55] explicitly to an INT 32 because that
[23:58] what fits into the field so the
[24:00] developer had to cut it down here but of
[24:03] course this is the same issue as before
[24:05] if the length was larger what can than
[24:08] what can be expressed here um we have
[24:10] our truncation and things go wrong the
[24:12] exact same way as it did for post
[24:15] dress so for crafting a payload for
[24:18] mongodb it's a little bit more involved
[24:21] because we have to avoid bad bites uh
[24:23] the payload uh must be valid utf8
[24:26] because the strings are serialized as
[24:28] utf8 to the wire so we cannot create any
[24:31] byes that are invalid
[24:32] utf8 but the problem is the message type
[24:35] that we need to write in order to craft
[24:37] the right injected message is hex dd7
[24:41] and that's always invalid utf8 so how
[24:43] can we do that and also size Fields
[24:47] inside the message could become some
[24:50] bite values that would also be inv valid
[24:51] utfa so we have to be careful there as
[24:53] well and the solution was to just use
[24:56] other metadata of the message we're
[24:58] injecting into to create these bite
[25:01] values and I have an example for that so
[25:04] this is a normal mongodb query it just
[25:07] queries for a movie based on a few
[25:08] attributes and this is serialized to the
[25:11] following Bon document in the beginning
[25:14] we have in blue the length of the whole
[25:16] document then in red we have a type uh
[25:19] identifier that says the next key value
[25:21] pair has a string value then in yellow
[25:24] we have the uh key which in this case is
[25:27] title with a the trailing null bite then
[25:29] in blue again we have the length of the
[25:31] following string and then in green we
[25:34] have the actual string with a
[25:35] terminating null bite then we have the
[25:37] next key value Pairs and so on and at
[25:39] the end we have another null bite that
[25:41] shows the end of the document so if we
[25:44] want to have the hex uh sequence dd7
[25:47] anywhere in here we cannot use the
[25:49] yellow and green Parts because they have
[25:51] to be AV valid utf8 but what we can do
[25:54] is for example use the length of a
[25:56] string and just make the string the
[25:59] length that will when serialized to
[26:02] bytes will be the exact bite sequence we
[26:05] need so here we need to subtract one
[26:07] because there's a appended null bite but
[26:10] then we have the dd7 there and with this
[26:12] trick now we can craft the entire
[26:15] injected message I cannot go into all of
[26:18] this here because we don't have time but
[26:20] this is the trick you need to be able to
[26:22] do
[26:23] it so we also looked at libraries here
[26:26] and uh we found the official rust
[26:29] mongodb client library to be vulnerable
[26:31] and exploitable uh we sent out our
[26:34] advisory also in February and they fixed
[26:36] in March so if you use this especially
[26:38] if you use it in production which I
[26:40] doubt because it's rust but then you
[26:42] should update to
[26:45] 2.8.2 okay let's now take a step back uh
[26:49] we've seen all the cool bugs and the
[26:50] exploitation but is this actually
[26:53] applicable to the real world uh we've
[26:55] seen the demo but maybe this was just a
[26:57] lucky punch
[26:58] so let's talk about constraints and
[27:01] especially about the elephant in the
[27:02] room which here weighs 4 gbt because a
[27:06] lot of you probably are thinking well
[27:08] can we actually send 4 gigabytes into
[27:11] all the applications aren't apps
[27:13] limiting input sizes and you would be
[27:15] right now there's a lot of common
[27:17] protections like default body size
[27:19] limits of your favorite web framework or
[27:21] maybe Json and Forum decode maximum
[27:24] sizes or you have your reverse proxy
[27:26] that's limiting request size and and so
[27:29] on and I also encountered this and
[27:31] thought about some potential bypasses
[27:33] here so the first idea is that sometimes
[27:36] end points are just unprotected maybe
[27:39] your framework doesn't have a default
[27:40] size limit and also sometimes the
[27:43] developers explicitly disable the limits
[27:46] this was the case with Harbor for
[27:47] example they have an engine X reverse
[27:50] proxy which usually has a 1 Megabyte
[27:53] request limit but they explicitly
[27:55] disabled it I guess because they need to
[27:57] receive big docka images so they need
[27:59] more uh request size but this also meant
[28:02] that the whole API is now not limited
[28:04] anymore and the go framework that's used
[28:07] under the hood of the server did not
[28:09] limit this so we could send our big
[28:12] payload the next trick would be to use
[28:15] compression uh this on the one hand
[28:18] allows you to send your attacker payload
[28:20] much quicker because you can compress it
[28:21] down and don't have to send 4 GB over
[28:24] the internet and also there can be logic
[28:26] bucks where maybe your reverse proxy or
[28:28] your framework first checks the request
[28:31] size but does the decompression after
[28:34] that so the check is essentially useless
[28:37] because your compressed data will
[28:39] inflate a lot and you can craft a big uh
[28:43] payload that after decompression still
[28:45] causes the Overflow so for engine X for
[28:48] example this works because engine X does
[28:50] not look at the body it doesn't try to
[28:51] decompress it it just looks at the raw
[28:53] size of the request so if your back end
[28:56] does decompression then you could bypass
[28:59] this and also for example the JavaScript
[29:01] fastify framework does both checks the
[29:04] body size and also does the
[29:06] decompression but it does it in the
[29:07] wrong order so you can bypass the
[29:10] limit then you might also have
[29:12] websockets uh support on the server of
[29:15] your target uh this is cool because
[29:17] websockets also in theory uh supports
[29:19] compression it's not always enabled but
[29:22] it can help you but even without that a
[29:25] single web ciruit request can be super
[29:27] large I I think it's a 64-bit integer uh
[29:30] the size field so you can definitely
[29:33] send 4 gab messages with that and maybe
[29:36] U the middle Wares and filters that are
[29:38] present in your framework don't apply to
[29:40] each individual web circuit message so
[29:43] maybe there's no limit
[29:45] there then you could also use alternate
[29:48] body types for example a multipod form
[29:50] instead of adjacent body and maybe the
[29:53] limits are different there or the
[29:55] developer forgot to configure a limit so
[29:57] this could be another
[29:59] bypass and then this one which I like
[30:01] the most is a little bit more creative
[30:03] and open which I call server site
[30:05] creation which is you just find other
[30:07] means of bringing a big string to the
[30:10] server uh without sending it in your
[30:12] request and one example is ssrf where
[30:15] you point uh some functionality of the
[30:18] server to an attacka server which then
[30:21] returns a very large response and if
[30:23] this one gets saved into the database or
[30:25] used in a query it will also cause the
[30:27] overlow and this for example worked in
[30:30] Gog where you have a web hooks feature
[30:33] uh but beyond the ssrf you might also
[30:35] have templating or a translation that
[30:37] you could use to inflate a string and
[30:40] this all depends on the business logic
[30:42] and the features of the server so that's
[30:44] where you can get creative to find
[30:47] bypasses all right now that we've seen
[30:49] how we might bypass limitations of
[30:51] Frameworks and servers we also need to
[30:53] look at languages we already seen some
[30:56] differences at the vulnerable Library
[30:58] so we need to see how well languages
[31:01] handle large payloads like how big can
[31:03] strings and buffers be and also what
[31:05] about integer overflows does every
[31:07] language have silent integer overflows
[31:09] or maybe some languages are
[31:11] safe so for the large payloads we can
[31:14] see that go Python and rust out of the
[31:17] languages we we looked at uh have large
[31:20] enough string and buffer sizes that uh
[31:22] you can send for gigabytes and they can
[31:24] handle it for Java uh you're out of luck
[31:27] and we also saw See the s seen this with
[31:31] uh unexploitable libraries in Java and
[31:34] that's because uh strings and buffers
[31:36] here are backed by arrays which have
[31:38] integer indexes so you cannot index more
[31:43] than I think yeah two to the power 31
[31:45] here for C the string size is not big
[31:49] enough but the buffer size is so if you
[31:52] have uh multiple strings that you
[31:54] control then you can still end up with a
[31:56] buffer that becomes bigger than than 4
[31:58] GB and for JavaScript it totally depends
[32:01] on the implementation for node strings
[32:04] are much smaller compared to the other
[32:05] languages but buffers can be large
[32:09] enough for integer overflows we can see
[32:12] that uh for addition overflows which
[32:15] just means you add two integers um we
[32:18] can see that in go Java and C CP a
[32:21] silent integer overflow happens so it
[32:23] will just wrap around for JavaScript uh
[32:26] there will be no overflow things will
[32:28] just get more inaccurate because it's
[32:30] JavaScript and they use floats under the
[32:33] hood and in Python you have arbitrarily
[32:35] sized integers so you cannot overflow
[32:39] that and in Rust it depends on how you
[32:41] build your project if you build it in
[32:43] debug mode the compiler will emit a
[32:46] check that checks for overflows but in a
[32:48] release build it will not do
[32:51] that and for serialization overflows
[32:54] which uh basically is the case when you
[32:56] have a standard function in your
[32:58] language that allows you to write a
[33:01] integer to a fixed size field um does
[33:04] this function check for overflows or not
[33:07] and in all of the type save languages
[33:08] this does not does not apply because the
[33:10] types that the function can receive uh
[33:13] cannot overflow uh the size field or the
[33:17] the field that it gets serialized to uh
[33:19] but this this just means that the
[33:21] developers now have to do the check
[33:22] before casting to this type and we've
[33:25] seen that this leads to bugs in uh our
[33:27] go and rust examples in JavaScript it's
[33:30] again Implement implementation dependent
[33:33] uh I think in no JS it does the check
[33:35] but in bun or Dino it might not do it
[33:38] and in Python the struck. pack function
[33:42] actually does a check if you pass it too
[33:44] large integer it will throw an error if
[33:46] you try to serialize it to a twoo small
[33:49] field so to summarize the real world
[33:52] applicability we can say that in a lot
[33:55] of times we can send large payloads past
[33:57] Li uh the
[33:59] limits um for silent inter integer
[34:02] overflows or truncations uh we also seen
[34:05] that in many languages it works or the
[34:07] developers do the mistake for the
[34:09] language and we also seen that you can
[34:12] definitely exploit some real world
[34:13] applications with
[34:16] this all right now let's look at what is
[34:20] there more to do in this kind of
[34:22] research for binary protocol
[34:24] smuggling but first I have to give a
[34:26] small disclaimer here please don't go
[34:29] out and send 4 GB to every API endpoint
[34:32] in your buck Bounty scope because you
[34:34] will crash systems you will get blocked
[34:36] and you will ruin a devops engineer day
[34:38] because they have to look at the
[34:40] monitoring alert so don't do it
[34:43] please um but speaking of this it would
[34:47] be cool to actually have a non-invasive
[34:49] detection mechanism uh in whitebox test
[34:51] it's okay you can make your local
[34:53] testing environment and just hammer it
[34:55] with gigabytes of data but of course in
[34:57] Black box tests that doesn't work so if
[35:00] we could find a methodology to find for
[35:03] example a fingerprint of a database
[35:05] client lbrary being used and we would
[35:07] know that this library is vulnerable to
[35:09] these kind of texts then we could either
[35:11] directly report it or only do the large
[35:14] payload then and if would this would be
[35:17] a tool it would be great uh to Aid you
[35:19] in in pentests and so
[35:22] on and of course uh it would be awesome
[35:25] to research a lot of more stuff uh more
[35:28] protocols like there's more databases
[35:30] than we stuff than the stuff we looked
[35:31] at today and there's all of the other
[35:33] systems caches message cues and so on
[35:36] that the application has to talk to we
[35:39] can also try to find more DN techniques
[35:41] for example look into protocols that use
[35:43] the limiters and not size fields and we
[35:46] can also find more large payload message
[35:49] which is uh ways to bypass the filters
[35:52] of a framework for example to bypass the
[35:55] request size limits uh or maybe we can
[35:58] find generic ways of making a server
[36:01] craft a very large string um maybe
[36:04] there's some way to do
[36:06] this and of course all of the stuff we
[36:09] looked at today had four byte length
[36:11] Fields but what about 2 byte length
[36:14] Fields this would be much easier to
[36:16] exploit sending 65 kiloby instead of 4
[36:19] gab uh is much easier you don't have the
[36:23] hustle with all the uh limitations and I
[36:26] already already started to look into
[36:28] this a little bit so uh stay tuned for
[36:30] more to come in the future but feel free
[36:32] to also go out and check this
[36:36] yourself so let's wrap things up uh I
[36:40] have a few takeaways and the first one
[36:42] is that I think integer overflows are
[36:44] still relevant in memory safe languages
[36:47] of course in C if you have an integer
[36:49] overflow uh it's easily easy to get some
[36:52] memory corruption with it so uh that's
[36:55] done but in memory safe languages um the
[36:58] worst case that can happen is a array
[37:00] out of bounds or whatever but with these
[37:03] data attacks uh in the uh binary
[37:05] protocols that we've seen today uh now
[37:08] we have a new way of exploiting these
[37:09] and I think developers kind of forgot
[37:12] about integer overflows and maybe
[37:14] researches as well at least in the
[37:16] memory safe
[37:17] languages then we also seen that uh it's
[37:20] entirely feasible to send large amounts
[37:22] of data even with uh protections because
[37:25] there's many ways how you can buy bypass
[37:27] these protections and finally to get
[37:30] back to the title SQL injection isn't
[37:33] dead of course it was never dead at Le
[37:36] at least not in the real world we've
[37:38] seen a lot of uh real world applications
[37:40] uh with SQL injections but on paper you
[37:43] could say uh developers have the right
[37:46] tools to write secure SQL based
[37:49] applications they have parameterized
[37:51] queries they have query Builders they
[37:54] have orm so if they use all of this and
[37:57] the ation is safe so if you can't hack
[38:00] it you just have to go a level
[38:02] deeper thank you
[38:04] [Applause]

=== Content from docs.github.com_56104f48_20250115_181601.html ===
[Skip to main content](#main-content)[GitHub Docs](/en)Version: Free, Pro, & TeamSearch GitHub DocsSearchSelect language: current language is EnglishOpen Search BarClose Search BarOpen MenuOpen Sidebar

* [Authentication](/en/authentication "Authentication")/
* [Verify commit signatures](/en/authentication/managing-commit-signature-verification "Verify commit signatures")/
* [Displaying verification for all commits](/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits "Displaying verification for all commits")
[Home](/en)[Authentication](/en/authentication)

* Account security
  + [Authentication to GitHub](/en/authentication/keeping-your-account-and-data-secure/about-authentication-to-github)
  + [Create a strong password](/en/authentication/keeping-your-account-and-data-secure/creating-a-strong-password)
  + [Switching between accounts](/en/authentication/keeping-your-account-and-data-secure/switching-between-accounts)
  + [Verifying devices on sign in](/en/authentication/keeping-your-account-and-data-secure/verifying-new-devices-when-signing-in)
  + [Update access credentials](/en/authentication/keeping-your-account-and-data-secure/updating-your-github-access-credentials)
  + [Manage personal access tokens](/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)
  + [Reviewing your SSH keys](/en/authentication/keeping-your-account-and-data-secure/reviewing-your-ssh-keys)
  + [Deploy keys](/en/authentication/keeping-your-account-and-data-secure/reviewing-your-deploy-keys)
  + [Token expiration](/en/authentication/keeping-your-account-and-data-secure/token-expiration-and-revocation)
  + [Review security log](/en/authentication/keeping-your-account-and-data-secure/reviewing-your-security-log)
  + [Security log events](/en/authentication/keeping-your-account-and-data-secure/security-log-events)
  + [Remove sensitive data](/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository)
  + [About anonymized URLs](/en/authentication/keeping-your-account-and-data-secure/about-anonymized-urls)
  + [GitHub's IP addresses](/en/authentication/keeping-your-account-and-data-secure/about-githubs-ip-addresses)
  + [SSH key fingerprints](/en/authentication/keeping-your-account-and-data-secure/githubs-ssh-key-fingerprints)
  + [Sudo mode](/en/authentication/keeping-your-account-and-data-secure/sudo-mode)
  + [Unauthorized access](/en/authentication/keeping-your-account-and-data-secure/preventing-unauthorized-access)
  + [Viewing and managing sessions](/en/authentication/keeping-your-account-and-data-secure/viewing-and-managing-your-sessions)
* Secure your account with 2FA
  + [About 2FA](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/about-two-factor-authentication)
  + [Configure 2FA](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/configuring-two-factor-authentication)
  + [Configure 2FA recovery](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/configuring-two-factor-authentication-recovery-methods)
  + [Access GitHub with 2FA](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/accessing-github-using-two-factor-authentication)
  + [Recover an account with 2FA](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/recovering-your-account-if-you-lose-your-2fa-credentials)
  + [Change 2FA method](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/changing-your-two-factor-authentication-method)
  + [About mandatory 2FA](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/about-mandatory-two-factor-authentication)
  + [Countries supporting SMS](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/countries-where-sms-authentication-is-supported)
  + [Disable 2FA](/en/authentication/securing-your-account-with-two-factor-authentication-2fa/disabling-two-factor-authentication-for-your-personal-account)
* Authenticate with a passkey
  + [About passkeys](/en/authentication/authenticating-with-a-passkey/about-passkeys)
  + [Manage your passkeys](/en/authentication/authenticating-with-a-passkey/managing-your-passkeys)
  + [Sign in with a passkey](/en/authentication/authenticating-with-a-passkey/signing-in-with-a-passkey)
* Connect with SSH
  + [About SSH](/en/authentication/connecting-to-github-with-ssh/about-ssh)
  + [SSH agent forwarding](/en/authentication/connecting-to-github-with-ssh/using-ssh-agent-forwarding)
  + [Managing deploy keys](/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys)
  + [Check for existing SSH key](/en/authentication/connecting-to-github-with-ssh/checking-for-existing-ssh-keys)
  + [Generate new SSH key](/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent)
  + [Add a new SSH key](/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account)
  + [Test your SSH connection](/en/authentication/connecting-to-github-with-ssh/testing-your-ssh-connection)
  + [SSH key passphrases](/en/authentication/connecting-to-github-with-ssh/working-with-ssh-key-passphrases)
* Troubleshooting SSH
  + [Use SSH over HTTPS port](/en/authentication/troubleshooting-ssh/using-ssh-over-the-https-port)
  + [Recover SSH key passphrase](/en/authentication/troubleshooting-ssh/recovering-your-ssh-key-passphrase)
  + [Deleted or missing SSH keys](/en/authentication/troubleshooting-ssh/deleted-or-missing-ssh-keys)
  + [Error: Host key verification failed](/en/authentication/troubleshooting-ssh/error-host-key-verification-failed)
  + [Permission denied (publickey)](/en/authentication/troubleshooting-ssh/error-permission-denied-publickey)
  + [Error: Bad file number](/en/authentication/troubleshooting-ssh/error-bad-file-number)
  + [Error: Key already in use](/en/authentication/troubleshooting-ssh/error-key-already-in-use)
  + [Permission denied other-user](/en/authentication/troubleshooting-ssh/error-permission-to-userrepo-denied-to-other-user)
  + [Permission denied other-repo](/en/authentication/troubleshooting-ssh/error-permission-to-userrepo-denied-to-userother-repo)
  + [Agent failure to sign](/en/authentication/troubleshooting-ssh/error-agent-admitted-failure-to-sign)
  + [ssh-add "illegal option" error](/en/authentication/troubleshooting-ssh/error-ssh-add-illegal-option----apple-use-keychain)
  + [SSL certificate problem](/en/authentication/troubleshooting-ssh/error-ssl-certificate-problem-verify-that-the-ca-cert-is-ok)
  + [Error: Unknown key type](/en/authentication/troubleshooting-ssh/error-unknown-key-type)
  + [SSH key audit](/en/authentication/troubleshooting-ssh/error-were-doing-an-ssh-key-audit)
* Verify commit signatures
  + [Commit signature verification](/en/authentication/managing-commit-signature-verification/about-commit-signature-verification)
  + [Displaying verification for all commits](/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits)
  + [Existing GPG keys](/en/authentication/managing-commit-signature-verification/checking-for-existing-gpg-keys)
  + [Generating a new GPG key](/en/authentication/managing-commit-signature-verification/generating-a-new-gpg-key)
  + [Add a GPG key](/en/authentication/managing-commit-signature-verification/adding-a-gpg-key-to-your-github-account)
  + [Tell Git about your signing key](/en/authentication/managing-commit-signature-verification/telling-git-about-your-signing-key)
  + [Associate email with GPG key](/en/authentication/managing-commit-signature-verification/associating-an-email-with-your-gpg-key)
  + [Signing commits](/en/authentication/managing-commit-signature-verification/signing-commits)
  + [Signing tags](/en/authentication/managing-commit-signature-verification/signing-tags)
* Troubleshoot verification
  + [Check verification status](/en/authentication/troubleshooting-commit-signature-verification/checking-your-commit-and-tag-signature-verification-status)
  + [Use verified email in GPG key](/en/authentication/troubleshooting-commit-signature-verification/using-a-verified-email-address-in-your-gpg-key)

* [Authentication](/en/authentication "Authentication")/
* [Verify commit signatures](/en/authentication/managing-commit-signature-verification "Verify commit signatures")/
* [Displaying verification for all commits](/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits "Displaying verification for all commits")
# Displaying verification statuses for all of your commits

You can enable vigilant mode for commit signature verification to mark all of your commits and tags with a signature verification status.

## In this article

* [About vigilant mode](#about-vigilant-mode)
* [Enabling vigilant mode](#enabling-vigilant-mode)
## [About vigilant mode](#about-vigilant-mode)

When you work locally on your computer, Git allows you to set the author of your changes and the identity of the committer. This, potentially, makes it difficult for other people to be confident that commits and tags you create were actually created by you. To help solve this problem you can sign your commits and tags. For more information, see [Signing commits](/en/authentication/managing-commit-signature-verification/signing-commits) and [Signing tags](/en/authentication/managing-commit-signature-verification/signing-tags). GitHub marks signed commits and tags with a verification status.

By default commits and tags are marked "Verified" if they are signed with a GPG, SSH, or S/MIME key that was successfully verified. If a commit or tag has a signature that can't be verified by GitHub, we mark the commit or tag "Unverified." In all other cases no verification status is displayed.

However, you can give other users increased confidence in the identity attributed to your commits and tags by enabling vigilant mode in your GitHub settings. With vigilant mode enabled, all of your commits and tags are marked with one of three verification statuses:

| Status | Description |
| --- | --- |
| **Verified** | The commit is signed, the signature was successfully verified, and the committer is the only author who has enabled vigilant mode. |
| **Partially verified** | The commit is signed, and the signature was successfully verified, but the commit has an author who: a) is not the committer and b) has enabled vigilant mode. In this case, the commit signature doesn't guarantee the consent of the author, so the commit is only partially verified. |
| **Unverified** | Any of the following is true:- The commit is signed but the signature could not be verified.- The commit is not signed and the committer has enabled vigilant mode.- The commit is not signed and an author has enabled vigilant mode. |

You should only enable vigilant mode if you sign all of your commits and tags and use an email address that is verified for your account on GitHub as your committer email address. After enabling this mode, any unsigned commits or tags that you generate locally and push to GitHub will be marked "Unverified."

You can check the verification status of your signed commits or tags on GitHub and view why your commit signatures might be unverified. For more information, see [Checking your commit and tag signature verification status](/en/authentication/troubleshooting-commit-signature-verification/checking-your-commit-and-tag-signature-verification-status).

## [Enabling vigilant mode](#enabling-vigilant-mode)

1. In the upper-right corner of any page on GitHub, click your profile photo, then click  **Settings**.
2. In the "Access" section of the sidebar, click  **SSH and GPG keys**.
3. Under "Vigilant mode," select **Flag unsigned commits as unverified**.
## Help and support

### Did you find what you needed?

 Yes No[Privacy policy](/en/site-policy/privacy-policies/github-privacy-statement)
### Help us make these docs great!

All GitHub docs are open source. See something that's wrong or unclear? Submit a pull request.

[Make a contribution](https://github.com/github/docs/blob/main/content/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits.md)

[Learn how to contribute](/contributing)

### Still need help?

[Ask the GitHub community](https://github.com/orgs/community/discussions)[Contact support](https://support.github.com)
## Legal

* © 2025 GitHub, Inc.
* [Terms](/en/site-policy/github-terms/github-terms-of-service)
* [Privacy](/en/site-policy/privacy-policies/github-privacy-statement)
* [Status](https://www.githubstatus.com/)
* [Pricing](https://github.com/pricing)
* [Expert services](https://services.github.com)
* [Blog](https://github.blog)


=== Content from github.com_822d0bf2_20250115_175832.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F67acbe027e28477ac2199e15cfb554bb2ffaf169)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F67acbe027e28477ac2199e15cfb554bb2ffaf169)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npgsql%2Fnpgsql)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[npgsql](/npgsql)
/
**[npgsql](/npgsql/npgsql)**
Public

* [Notifications](/login?return_to=%2Fnpgsql%2Fnpgsql) You must be signed in to change notification settings
* [Fork
  826](/login?return_to=%2Fnpgsql%2Fnpgsql)
* [Star
   3.4k](/login?return_to=%2Fnpgsql%2Fnpgsql)

* [Code](/npgsql/npgsql)
* [Issues
  232](/npgsql/npgsql/issues)
* [Pull requests
  42](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

Additional navigation options

* [Code](/npgsql/npgsql)
* [Issues](/npgsql/npgsql/issues)
* [Pull requests](/npgsql/npgsql/pulls)
* [Actions](/npgsql/npgsql/actions)
* [Security](/npgsql/npgsql/security)
* [Insights](/npgsql/npgsql/pulse)

## Commit

[Permalink](/npgsql/npgsql/commit/67acbe027e28477ac2199e15cfb554bb2ffaf169)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-x9vc-6hfv-hg8c](https://github.com/advisories/GHSA-x9vc-6hfv-hg8c "GHSA-x9vc-6hfv-hg8c")

[Browse files](/npgsql/npgsql/tree/67acbe027e28477ac2199e15cfb554bb2ffaf169)
Browse the repository at this point in the history

```
* Changes to make project compile

(cherry picked from commit c3079f1492d27d38564255716678ce8a33ee7039)

* Add message length validation to flush and direct write

(cherry picked from commit 0e833ba4c278d6dab71a460a1fcc34f89cbb6f49)

* Fix direct write byte count

---------

Co-authored-by: Nino Floris <mail@ninofloris.com>
```

* Loading branch information

[![@roji](https://avatars.githubusercontent.com/u/1862641?s=40&v=4)](/roji) [![@NinoFloris](https://avatars.githubusercontent.com/u/4218809?s=40&v=4)](/NinoFloris)

[roji](/npgsql/npgsql/commits?author=roji "View all commits by roji")
and
[NinoFloris](/npgsql/npgsql/commits?author=NinoFloris "View all commits by NinoFloris")
authored
May 9, 2024

1 parent
[337acb3](/npgsql/npgsql/commit/337acb3c8b13dc9f53d293cc1a06e254829dd815)

commit 67acbe0

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**202 additions**
and
**24 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Directory.Build.targets
  [Directory.Build.targets](#diff-50e91c82311ea26f2a73202525dfdf2b0a89c178ee666b2bf3ad4c84ac4c06dc)
* global.json
  [global.json](#diff-8df3cd354bc584349d04ad5675b33c042d8b99b741b8b95af394c55e0f5001bf)
* src/Npgsql

  + src/Npgsql/NpgsqlConnector.FrontendMessages.cs
    [NpgsqlConnector.FrontendMessages.cs](#diff-c30f6b27a9eff111937042ab38f91ae685284db87f5e2346d30bb769a2449d4e)
  + src/Npgsql/NpgsqlTransaction.cs
    [NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3)
  + src/Npgsql/NpgsqlWriteBuffer.cs
    [NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2)
  + TypeHandlers

    - CompositeHandlers

      * src/Npgsql/TypeHandlers/CompositeHandlers/MappedCompositeHandler.cs
        [MappedCompositeHandler.cs](#diff-02600e1081b6b3e59a9e0ccf430f9bee6ddec11a62158494a8bf0305e021956a)
    - src/Npgsql/TypeHandlers/HstoreHandler.cs
      [HstoreHandler.cs](#diff-6e1ae7af74bf9b5b9ca622dd12aa4e1c79895522bd4aed5e50b1eca781667f4c)
* test

  + Npgsql.PluginTests

    - test/Npgsql.PluginTests/JsonNetTests.cs
      [JsonNetTests.cs](#diff-e3ab8dd4ca94d928249246e8b7986463da0dd3daa998cf68c2cd90b25b8618d9)
  + Npgsql.Tests

    - test/Npgsql.Tests/CommandTests.cs
      [CommandTests.cs](#diff-e6c17507bd26e76a542550a4aa06624cca348f50daa9d400a5b86ee4acbac14b)

## There are no files selected for viewing

6 changes: 3 additions & 3 deletions

6
[Directory.Build.targets](#diff-50e91c82311ea26f2a73202525dfdf2b0a89c178ee666b2bf3ad4c84ac4c06dc "Directory.Build.targets")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/Directory.Build.targets)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,14 +13,14 @@ |
|  |  | <PackageReference Update="NetTopologySuite.IO.PostGIS" Version="2.0.0" /> |
|  |  | <PackageReference Update="NodaTime" Version="2.4.7" /> |
|  |  | <PackageReference Update="GeoJSON.Net" Version="1.1.73" /> |
|  |  | <PackageReference Update="Newtonsoft.Json" Version="11.0.2" /> |
|  |  | <PackageReference Update="Newtonsoft.Json" Version="13.0.3" /> |
|  |  |  |
|  |  | <!-- Tests --> |
|  |  | <PackageReference Update="NUnit" Version="3.12.0" /> |
|  |  | <PackageReference Update="NLog" Version="4.6.7" /> |
|  |  | <PackageReference Update="Microsoft.CSharp" Version="4.6.0" /> |
|  |  | <PackageReference Update="Microsoft.NET.Test.Sdk" Version="16.5.0" /> |
|  |  | <PackageReference Update="NUnit3TestAdapter" Version="3.15.1" /> |
|  |  | <PackageReference Update="Microsoft.NET.Test.Sdk" Version="17.9.0" /> |
|  |  | <PackageReference Update="NUnit3TestAdapter" Version="4.5.0" /> |
|  |  | <PackageReference Update="xunit" Version="2.4.1" /> |
|  |  | <PackageReference Update="xunit.runner.visualstudio" Version="2.4.1" /> |
|  |  | <PackageReference Update="GitHubActionsTestLogger" Version="1.1.0" /> |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[global.json](#diff-8df3cd354bc584349d04ad5675b33c042d8b99b741b8b95af394c55e0f5001bf "global.json")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/global.json)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,7 +1,7 @@ |
|  |  | { |
|  |  | "sdk": { |
|  |  | "version": "3.1.302", |
|  |  | "rollForward": "minor", |
|  |  | "allowPrerelease": "false" |
|  |  | "version": "6.0.401", |
|  |  | "rollForward": "latestMajor", |
|  |  | "allowPrerelease": "true" |
|  |  | } |
|  |  | } |

43 changes: 31 additions & 12 deletions

43
[src/Npgsql/NpgsqlConnector.FrontendMessages.cs](#diff-c30f6b27a9eff111937042ab38f91ae685284db87f5e2346d30bb769a2449d4e "src/Npgsql/NpgsqlConnector.FrontendMessages.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/NpgsqlConnector.FrontendMessages.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,6 +19,7 @@ internal Task WriteDescribe(StatementOrPortal statementOrPortal, string name, bo |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | (name.Length + 1); // Statement/portal name |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(len, statementOrPortal, name, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -46,6 +47,7 @@ internal Task WriteSync(bool async) |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -75,6 +77,7 @@ internal Task WriteExecute(int maxRows, bool async) |
|  |  | sizeof(byte) + // Null-terminated portal name (always empty for now) |
|  |  | sizeof(int); // Max number of rows |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | return FlushAndWrite(maxRows, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -102,8 +105,6 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | Debug.Assert(statementName.All(c => c < 128)); |
|  |  |  |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async); |
|  |  |  |
|  |  | var messageLength = |
|  |  | sizeof(byte) + // Message code |
| Expand All | | @@ -114,6 +115,10 @@ internal async Task WriteParse(string sql, string statementName, List<NpgsqlPara |
|  |  | sizeof(ushort) + // Number of parameters |
|  |  | inputParameters.Count \* sizeof(int); // Parameter OIDs |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4 + statementName.Length + 1) |
|  |  | await Flush(async); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Parse); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | WriteBuffer.WriteNullTerminatedString(statementName); |
| Expand Down  Expand Up | | @@ -152,12 +157,6 @@ internal async Task WriteBind( |
|  |  | statement.Length + sizeof(byte) + // Statement name plus null terminator |
|  |  | sizeof(ushort); // Number of parameter format codes that follow |
|  |  |  |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async); |
|  |  | } |
|  |  |  |
|  |  | var formatCodesSum = 0; |
|  |  | var paramsLength = 0; |
|  |  | foreach (var p in inputParameters) |
| Expand All | | @@ -177,6 +176,13 @@ internal async Task WriteBind( |
|  |  | sizeof(short) + // Number of result format codes |
|  |  | sizeof(short) \* (unknownResultTypeList?.Length ?? 1); // Result format codes |
|  |  |  |
|  |  | WriteBuffer.StartMessage(messageLength); |
|  |  | if (WriteBuffer.WriteSpaceLeft < headerLength) |
|  |  | { |
|  |  | Debug.Assert(WriteBuffer.Size >= headerLength, "Write buffer too small for Bind header"); |
|  |  | await Flush(async); |
|  |  | } |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Bind); |
|  |  | WriteBuffer.WriteInt32(messageLength - 1); |
|  |  | Debug.Assert(portal == string.Empty); |
| Expand Down  Expand Up | | @@ -237,6 +243,7 @@ internal Task WriteClose(StatementOrPortal type, string name, bool async) |
|  |  | sizeof(byte) + // Statement or portal |
|  |  | name.Length + sizeof(byte); // Statement or portal name plus null terminator |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 10) |
|  |  | return FlushAndWrite(len, type, name, async); |
|  |  |  |
| Expand Down  Expand Up | | @@ -265,14 +272,17 @@ internal async Task WriteQuery(string sql, bool async) |
|  |  | { |
|  |  | var queryByteLen = TextEncoding.GetByteCount(sql); |
|  |  |  |
|  |  | var len = sizeof(byte) + |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1 + 4) |
|  |  | await Flush(async); |
|  |  |  |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Query); |
|  |  | WriteBuffer.WriteInt32( |
|  |  | sizeof(int) + // Message length (including self excluding code) |
|  |  | queryByteLen + // Query byte length |
|  |  | sizeof(byte)); // Null terminator |
|  |  | WriteBuffer.WriteInt32(len - 1); |
|  |  |  |
|  |  | await WriteBuffer.WriteString(sql, queryByteLen, async); |
|  |  | if (WriteBuffer.WriteSpaceLeft < 1) |
| Expand All | | @@ -287,6 +297,7 @@ internal async Task WriteCopyDone(bool async) |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async); |
|  |  |  |
| Expand All | | @@ -302,6 +313,7 @@ internal async Task WriteCopyFail(bool async) |
|  |  | sizeof(int) + // Length |
|  |  | sizeof(byte); // Error message is always empty (only a null terminator) |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await Flush(async); |
|  |  |  |
| Expand All | | @@ -319,6 +331,7 @@ internal void WriteCancelRequest(int backendProcessId, int backendSecretKey) |
|  |  |  |
|  |  | Debug.Assert(backendProcessId != 0); |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -333,6 +346,7 @@ internal void WriteTerminate() |
|  |  | const int len = sizeof(byte) + // Message code |
|  |  | sizeof(int); // Length |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -345,6 +359,7 @@ internal void WriteSslRequest() |
|  |  | const int len = sizeof(int) + // Length |
|  |  | sizeof(int); // SSL request code |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | Flush(false).GetAwaiter().GetResult(); |
|  |  |  |
| Expand All | | @@ -365,6 +380,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  | PGUtil.UTF8Encoding.GetByteCount(kvp.Value) + 1; |
|  |  |  |
|  |  | // Should really never happen, just in case |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (len > WriteBuffer.Size) |
|  |  | throw new Exception("Startup message bigger than buffer"); |
|  |  |  |
| Expand All | | @@ -388,6 +404,7 @@ internal void WriteStartup(Dictionary<string, string> parameters) |
|  |  |  |
|  |  | internal async Task WritePassword(byte[] payload, int offset, int count, bool async) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(sizeof(byte) + sizeof(int) + count); |
|  |  | if (WriteBuffer.WriteSpaceLeft < sizeof(byte) + sizeof(int)) |
|  |  | await WriteBuffer.Flush(async); |
|  |  | WriteBuffer.WriteByte(FrontendMessageCode.Password); |
| Expand All | | @@ -412,6 +429,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  | sizeof(int) + // Initial response length |
|  |  | (initialResponse?.Length ?? 0); // Initial response payload |
|  |  |  |
|  |  | WriteBuffer.StartMessage(len); |
|  |  | if (WriteBuffer.WriteSpaceLeft < len) |
|  |  | await WriteBuffer.Flush(async); |
|  |  |  |
| Expand All | | @@ -435,6 +453,7 @@ internal async Task WriteSASLInitialResponse(string mechanism, byte[] initialRes |
|  |  |  |
|  |  | internal Task WritePregenerated(byte[] data, bool async=false) |
|  |  | { |
|  |  | WriteBuffer.StartMessage(data.Length); |
|  |  | if (WriteBuffer.WriteSpaceLeft < data.Length) |
|  |  | return FlushAndWrite(data, async); |
|  |  |  |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[src/Npgsql/NpgsqlTransaction.cs](#diff-5aec611d9d5051728941e204a4c1d48a045936fffdaa69a72572b0759b9932c3 "src/Npgsql/NpgsqlTransaction.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/NpgsqlTransaction.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -204,6 +204,9 @@ async Task Save(string name, bool async) |
|  |  | CheckReady(); |
|  |  | if (!\_connector.DatabaseInfo.SupportsTransactions) |
|  |  | return; |
|  |  |  |
|  |  | // Note that creating a savepoint doesn't actually send anything to the backend (only prepends), so strictly speaking we don't |
|  |  | // have to start a user action. However, we do this for consistency as if we did (for the checks and exceptions) |
|  |  | using (\_connector.StartUserAction()) |
|  |  | { |
|  |  | Log.Debug($"Creating savepoint {name}", \_connector.Id); |
| Expand Down | |  |

69 changes: 66 additions & 3 deletions

69
[src/Npgsql/NpgsqlWriteBuffer.cs](#diff-a681328532dcb0cab8df3e242bf096418516a346e1791d90e23096d4c5f36da2 "src/Npgsql/NpgsqlWriteBuffer.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/NpgsqlWriteBuffer.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,6 +21,7 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  | internal readonly NpgsqlConnector Connector; |
|  |  |  |
|  |  | internal Stream Underlying { private get; set; } |
|  |  | internal bool MessageLengthValidation { get; set; } = true; |
|  |  |  |
|  |  | /// <summary> |
|  |  | /// The total byte length of the buffer. |
| Expand All | | @@ -37,6 +38,9 @@ public sealed partial class NpgsqlWriteBuffer |
|  |  |  |
|  |  | internal int WritePosition; |
|  |  |  |
|  |  | int \_messageBytesFlushed; |
|  |  | int? \_messageLength; |
|  |  |  |
|  |  | ParameterStream? \_parameterStream; |
|  |  |  |
|  |  | /// <summary> |
| Expand Down  Expand Up | | @@ -81,6 +85,8 @@ public async Task Flush(bool async) |
|  |  | WritePosition = pos; |
|  |  | } else if (WritePosition == 0) |
|  |  | return; |
|  |  | else |
|  |  | AdvanceMessageBytesFlushed(WritePosition); |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -133,15 +139,19 @@ internal async Task DirectWrite(byte[] buffer, int offset, int count, bool async |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(count + 4); |
|  |  | WriteInt32(checked(count + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | await Flush(async); |
|  |  | StartMessage(5); |
|  |  | Flush(); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(count); |
|  |  | } |
|  |  |  |
|  |  | try |
|  |  | { |
| Expand Down  Expand Up | | @@ -169,15 +179,19 @@ internal async Task DirectWrite(ReadOnlyMemory<byte> memory, bool async) |
|  |  | Debug.Assert(WritePosition == 5); |
|  |  |  |
|  |  | WritePosition = 1; |
|  |  | WriteInt32(memory.Length + 4); |
|  |  | WriteInt32(checked(memory.Length + 4)); |
|  |  | WritePosition = 5; |
|  |  | \_copyMode = false; |
|  |  | StartMessage(5); |
|  |  | await Flush(async); |
|  |  | \_copyMode = true; |
|  |  | WriteCopyDataHeader(); // And ready the buffer after the direct write completes |
|  |  | } |
|  |  | else |
|  |  | { |
|  |  | Debug.Assert(WritePosition == 0); |
|  |  | AdvanceMessageBytesFlushed(memory.Length); |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | try |
| Expand Down  Expand Up | | @@ -508,9 +522,58 @@ void WriteCopyDataHeader() |
|  |  |  |
|  |  | #region Misc |
|  |  |  |
|  |  | internal void StartMessage(int messageLength) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (\_messageLength != null && \_messageBytesFlushed != \_messageLength && WritePosition != -\_messageBytesFlushed + \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | // Add negative WritePosition to compensate for previous message(s) written without flushing. |
|  |  | \_messageBytesFlushed = -WritePosition; |
|  |  | \_messageLength = messageLength; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Did not write the amount of bytes the message length specified"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void AdvanceMessageBytesFlushed(int count) |
|  |  | { |
|  |  | if (!MessageLengthValidation) |
|  |  | return; |
|  |  |  |
|  |  | if (count < 0 || \_messageLength is null || (long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | Throw(); |
|  |  |  |
|  |  | \_messageBytesFlushed += count; |
|  |  |  |
|  |  | void Throw() |
|  |  | { |
|  |  | if (count < 0) |
|  |  | throw new ArgumentOutOfRangeException(nameof(count), "Can't advance by a negative count"); |
|  |  |  |
|  |  | if (\_messageLength is null) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | new InvalidOperationException("No message was started"); |
|  |  | } |
|  |  |  |
|  |  | if ((long)\_messageBytesFlushed + count > \_messageLength) |
|  |  | { |
|  |  | Connector.Break(); |
|  |  | throw new OverflowException("Tried to write more bytes than the message length specified"); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | internal void Clear() |
|  |  | { |
|  |  | WritePosition = 0; |
|  |  | \_messageLength = null; |
|  |  | } |
|  |  |  |
|  |  | /// <summary> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql/TypeHandlers/CompositeHandlers/MappedCompositeHandler.cs](#diff-02600e1081b6b3e59a9e0ccf430f9bee6ddec11a62158494a8bf0305e021956a "src/Npgsql/TypeHandlers/CompositeHandlers/MappedCompositeHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/TypeHandlers/CompositeHandlers/MappedCompositeHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -97,7 +97,7 @@ public override int ValidateAndGetLength(T value, ref NpgsqlLengthCache? lengthC |
|  |  | foreach (var member in \_memberHandlers) |
|  |  | length += member.ValidateAndGetLength(value, ref lengthCache); |
|  |  |  |
|  |  | return lengthCache.Lengths[position] = length; |
|  |  | return lengthCache!.Lengths[position] = length; |
|  |  | } |
|  |  |  |
|  |  | [MethodImpl(MethodImplOptions.AggressiveInlining)] |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Npgsql/TypeHandlers/HstoreHandler.cs](#diff-6e1ae7af74bf9b5b9ca622dd12aa4e1c79895522bd4aed5e50b1eca781667f4c "src/Npgsql/TypeHandlers/HstoreHandler.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/src/Npgsql/TypeHandlers/HstoreHandler.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -76,7 +76,7 @@ public int ValidateAndGetLength(IDictionary<string, string?> value, ref NpgsqlLe |
|  |  | totalLen += \_textHandler.ValidateAndGetLength(kv.Value!, ref lengthCache, null); |
|  |  | } |
|  |  |  |
|  |  | return lengthCache.Lengths[pos] = totalLen; |
|  |  | return lengthCache!.Lengths[pos] = totalLen; |
|  |  | } |
|  |  |  |
|  |  | /// <inheritdoc /> |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[test/Npgsql.PluginTests/JsonNetTests.cs](#diff-e3ab8dd4ca94d928249246e8b7986463da0dd3daa998cf68c2cd90b25b8618d9 "test/Npgsql.PluginTests/JsonNetTests.cs")

Show comments

[View file](/npgsql/npgsql/blob/67acbe027e28477ac2199e15cfb554bb2ffaf169/test/Npgsql.PluginTests/JsonNetTests.cs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -79,7 +79,7 @@ public void RoundtripJObject() |
|  |  | { |
|  |  | reader.Read(); |
|  |  | var actual = reader.GetFieldValue<JObject>(0); |
|  |  | Assert.That((int)actual["Bar"], Is.EqualTo(8)); |
|  |  | Assert.That((int)actual["Bar"]!, Is.EqualTo(8)); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `67acbe0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpgsql%2Fnpgsql%2Fcommit%2F67acbe027e28477ac2199e15cfb554bb2ffaf169) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


