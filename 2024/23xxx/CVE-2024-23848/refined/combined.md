=== Content from lore.kernel.org_c63c7fbe_20250114_220643.html ===

```
[linux-kernel.vger.kernel.org archive mirror](../?t=20240118075211)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Hans Verkuil <hverkuil-cisco@xs4all.nl>
To: "Zhao, Zijie" <zijie4@illinois.edu>,
	"jani.nikula@intel.com" <jani.nikula@intel.com>,
	"mchehab@kernel.org" <mchehab@kernel.org>,
	"[linux-media@vger.kernel.org](../../linux-media/?t=20240118075211)" <[linux-media@vger.kernel.org](../../linux-media/?t=20240118075211)>,
	"[linux-kernel@vger.kernel.org](../../lkml/?t=20240118075211)" <[linux-kernel@vger.kernel.org](../../lkml/?t=20240118075211)>
Cc: "syzkaller@googlegroups.com" <syzkaller@googlegroups.com>,
	"Zhang, Lingming" <lingming@illinois.edu>,
	"Yang, Chenyuan" <cy54@illinois.edu>
Subject: [Re: [Linux Kernel Bugs] KASAN: slab-use-after-free Read in cec_queue_msg_fh and 4 other crashes in the cec device (`cec_ioctl`)](#r)
Date: Thu, 18 Jan 2024 08:52:07 +0100	[[thread overview]](#r)
Message-ID: <e9f42704-2f99-4f2c-ade5-f952e5fd53e5@xs4all.nl> (<raw>)
In-Reply-To: <[SN6PR11MB345527101A2C8A1AC99B04B5FA712@SN6PR11MB3455.namprd11.prod.outlook.com](../SN6PR11MB345527101A2C8A1AC99B04B5FA712%40SN6PR11MB3455.namprd11.prod.outlook.com/)>

On 18/01/2024 05:25, Zhao, Zijie wrote:
> Dear Developers,
>
> We hope this email finds you well. We took a deeper look at the first crash KASAN: slab-use-after-free Read in cec_queue_msg_fh. We believe the cause is that one thread took the lock of a `struct
> cec_fh` but another thread freed it:
>
> One thread takes the lock of the `fh` of type `struct cec_fh`first (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L219>);
> Another thread frees this `fh` without checking if any other thread is holding the lock (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-api.c#L684>);
> Then KASAN is triggered when the first thread tries to access `fh->msgs` (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L224>).
>
>
> While this particular reproducer seems harmless, we think the free might cause more problems when paired with threads running other functions that work on `fh`and then KASAN is disabled. We also think
> the `struct cec_fh` (<https://elixir.bootlin.com/linux/v6.7-rc7/source/include/media/cec.h#L90>) is worth attention since it stores many function pointers (e.g. `fh->adap->ops` stores
> <https://elixir.bootlin.com/linux/v6.7-rc7/source/include/media/cec.h#L115> and `fh->adap->pin->ops` stores <https://elixir.bootlin.com/linux/v6.7-rc7/source/include/media/cec-pin.h#L36>).
>
> Could you please kindly take a look at the crashes as you have more expertise in them?

I've been looking at these on and off whenever I have some time. I found two issues and am
on the trail of a third. Once I have a patch for the third I was planning to post the patches
and ask you to retest. Some of the issues you found might all relate to the same root cause
(esp. the locking issue), so it would be great if you could help with that.

Regards,

	Hans

>
> Thank you for your time!
> --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> *From:* Yang, Chenyuan <cy54@illinois.edu>
> *Sent:* Wednesday, December 27, 2023 8:33 PM
> *To:* linux-media@vger.kernel.org <linux-media@vger.kernel.org>; linux-kernel@vger.kernel.org <linux-kernel@vger.kernel.org>
> *Cc:* jani.nikula@intel.com <jani.nikula@intel.com>; hverkuil-cisco@xs4all.nl <hverkuil-cisco@xs4all.nl>; syzkaller@googlegroups.com <syzkaller@googlegroups.com>; mchehab@kernel.org
> <mchehab@kernel.org>; Zhao, Zijie <zijie4@illinois.edu>; Zhang, Lingming <lingming@illinois.edu>
> *Subject:* [Linux Kernel Bugs] KASAN: slab-use-after-free Read in cec_queue_msg_fh and 4 other crashes in the cec device (`cec_ioctl`)
>
>
> Hello,
>
>
>
> We encountered 5 different crashes in the cec device by using our generated syscall specification for it, here are the descriptions of these 5 crashes and the related files are attached:
>
> 1. KASAN: slab-use-after-free Read in cec_queue_msg_fh (Reproducible)
>
> 2. WARNING: ODEBUG bug in cec_transmit_msg_fh
>
> 3. WARNING in cec_data_cancel
>
> 4. INFO: task hung in cec_claim_log_addrs (Reproducible)
>
> 5. general protection fault in cec_transmit_done_ts
>
>
>
> For “KASAN: slab-use-after-free Read in cec_queue_msg_fh”, we attached a syzkaller program to reproduce it. This crash is caused by ` list_add_tail(&entry->list, &fh->msgs);`
> (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L224> <<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L224>>), which reads a
> variable freed by `kfree(fh);` (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-api.c#L684>
> <<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-api.c#L684>>). The reproducible program is a Syzkaller program, which can be executed following this document:
> <https://github.com/google/syzkaller/blob/master/docs/executing_syzkaller_programs.md> <<https://github.com/google/syzkaller/blob/master/docs/executing_syzkaller_programs.md>>.
>
>
>
> For “WARNING: ODEBUG bug in cec_transmit_msg_fh”, unfortunately we failed to reproduce it but we indeed trigger this crash almost every time when we fuzz the cec device only. We attached the report
> and log for this bug. It tries freeing an active object by using `kfree(data);` (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L930>
> <<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L930>>).
>
>
>
> For “WARNING in cec_data_cancel”, it is an internal warning used in cec_data_cancel (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L365>
> <<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L365>>), which checks whether the transmit is the current or pending. Unfortunately, we also don't have the
> reproducible program for this bug, but we attach the report and log.
>
>
>
> For “INFO: task hung in cec_claim_log_addrs”, the kernel hangs when the cec device ` wait_for_completion(&adap->config_completion);`
> (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L1579> <<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L1579>>). We have a
> reproducible C program for this.
>
>
>
> For “general protection fault in cec_transmit_done_ts”, the cec device tries derefencing a non-canonical address 0xdffffc00000000e0: 0000 [#1], which is related to the invocation `
> cec_transmit_attempt_done_ts ` (<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L697>
> <<https://elixir.bootlin.com/linux/v6.7-rc7/source/drivers/media/cec/core/cec-adap.c#L697>>). It seems that the address of cec_adapter is totally wrong. We do not have a reproducible program for this
> bug, but the log and report for it are attached.
>
>
>
> If you have any questions or require more information, please feel free to contact us.
>
>
>
> Best,
>
> Chenyuan
>

```

---

```
[next](../f985d664-d907-48ed-9b3d-dc956c178b88%40xs4all.nl/) [prev](../CACT4Y%2BYFk_7z_n2SyTGAWYBa_HRjMqNwXUO8AiDqHpDy_H2Rsg%40mail.gmail.com/) [parent](../SN6PR11MB345527101A2C8A1AC99B04B5FA712%40SN6PR11MB3455.namprd11.prod.outlook.com/) [reply](#R)other threads:[[~2024-01-18  7:52 UTC](../?t=20240118075211)|[newest](../)]

Thread overview: 25+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2023-12-28  2:33 [[Linux Kernel Bugs] KASAN: slab-use-after-free Read in cec_queue_msg_fh and 4 other crashes in the cec device (`cec_ioctl`)](../PH7PR11MB57688E64ADE4FE82E658D86DA09EA%40PH7PR11MB5768.namprd11.prod.outlook.com/) Yang, Chenyuan
2023-12-29  6:23 ` [Dmitry Vyukov](../CACT4Y%2BYFk_7z_n2SyTGAWYBa_HRjMqNwXUO8AiDqHpDy_H2Rsg%40mail.gmail.com/)
     [not found] ` <[SN6PR11MB345527101A2C8A1AC99B04B5FA712@SN6PR11MB3455.namprd11.prod.outlook.com](../SN6PR11MB345527101A2C8A1AC99B04B5FA712%40SN6PR11MB3455.namprd11.prod.outlook.com/)>
2024-01-18  7:52   ` [Hans Verkuil [this message]](#t)
2024-01-19  8:17 ` [Hans Verkuil](../f985d664-d907-48ed-9b3d-dc956c178b88%40xs4all.nl/)
2024-01-22 19:11   ` [Yang, Chenyuan](../89FAADA9-D4EC-4C27-9F8F-1D86B7416DE1%40illinois.edu/)
2024-01-23  8:02     ` [Hans Verkuil](../382c37c0-15c1-48ad-a8d0-a6bc4bd7160a%40xs4all.nl/)
2024-01-23 10:39       ` [Hans Verkuil](../a67a75da-a506-48c4-ac5e-21d84cfae2e3%40xs4all.nl/)
2024-01-24 13:33   ` [Yang, Chenyuan](../89ED2612-DFEA-448A-9637-3522B9E92B74%40illinois.edu/)
2024-01-25 10:35     ` [Hans Verkuil](../a0ba0375-a96e-4ab1-840e-a00d3133728e%40xs4all.nl/)
2024-01-29  3:03   ` [Yang, Chenyuan](../526380BE-57AC-493D-A7B0-B8F0ECC0FE0A%40illinois.edu/)
2024-01-30 14:35     ` [Hans Verkuil](../f1855145-9562-4bef-800f-43bcacff6fc8%40xs4all.nl/)
2024-02-12 14:42       ` [Hans Verkuil](../2e5f1e92-7fad-4a74-b375-1e194ff08ce6%40xs4all.nl/)
2024-02-13 15:40         ` [Yang, Chenyuan](../F8D4A291-8CFB-4A25-B296-3CA07B56F459%40illinois.edu/)
2024-02-13 16:05           ` [Yang, Chenyuan](../0C7B75A2-B4C8-43CB-A57A-910B3674E787%40illinois.edu/)
2024-02-23 14:44           ` [Hans Verkuil](../49a68c10-9549-4fd8-b929-d4c7a9c8debf%40xs4all.nl/)
     [not found]             ` <[PH7PR11MB5768B0BC3C042A6EA4EC1EF0A0542@PH7PR11MB5768.namprd11.prod.outlook.com](../PH7PR11MB5768B0BC3C042A6EA4EC1EF0A0542%40PH7PR11MB5768.namprd11.prod.outlook.com/)>
2024-02-26 12:27               ` [Yang, Chenyuan](../7E36CBBD-F2AD-4D98-8D4E-F52E62C3E812%40illinois.edu/)
2024-04-19 14:51                 ` [Takashi Iwai](../87le59s8wi.wl-tiwai%40suse.de/)
2024-04-22 12:14                   ` [Hans Verkuil](../966f5847-d007-4425-a902-1e1c05a820ae%40xs4all.nl/)
2024-04-22 19:30                     ` [Takashi Iwai](../87zftli49a.wl-tiwai%40suse.de/)
2024-04-22 15:04                 ` [Hans Verkuil](../f196c736-dbfe-4ca0-995b-1720bf530edf%40xs4all.nl/)
2024-04-22 18:54                   ` [Yang, Chenyuan](../C84ADEF3-5553-41AF-B127-85D5630CC8A1%40illinois.edu/)
2024-04-22 20:57                     ` [Hans Verkuil](../9e76f971-b2d7-424a-bf21-c6cf5cd4a3f3%40xs4all.nl/)
2024-04-29 15:42                       ` [Yang, Chenyuan](../CA3D308A-ED29-440C-A6C5-C5450CDA2C84%40illinois.edu/)
2024-04-30 10:26                         ` [Hans Verkuil](../ace1b749-9a4d-4c68-b5a7-530e0d3ff504%40xs4all.nl/)
2024-04-30 17:06                           ` [Yang, Chenyuan](../7E76BF48-21F3-4C96-B6A7-C0E9D107D61F%40illinois.edu/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=e9f42704-2f99-4f2c-ade5-f952e5fd53e5@xs4all.nl \
    --to=hverkuil-cisco@xs4all.nl \
    --cc=cy54@illinois.edu \
    --cc=jani.nikula@intel.com \
    --cc=lingming@illinois.edu \
    --cc=linux-kernel@vger.kernel.org \
    --cc=linux-media@vger.kernel.org \
    --cc=mchehab@kernel.org \
    --cc=syzkaller@googlegroups.com \
    --cc=zijie4@illinois.edu \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

