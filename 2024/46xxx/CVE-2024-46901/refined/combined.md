=== Content from subversion.apache.org_e035215b_20250114_182200.html ===
 mod\_dav\_svn denial-of-service via control characters in paths
Summary:
========
It has been discovered that the patch for CVE-2013-1968 was incomplete
and unintentionally left mod\_dav\_svn vulnerable to control characters
in filenames.
If a path or a revision-property which contains control characters is
committed to a repository then SVN operations served by mod\_dav\_svn
can be disrupted.
Known vulnerable:
=================
Subversion mod\_dav\_svn servers through 1.14.4 (inclusive).
Known fixed:
============
Servers running Subversion 1.14.5
Details:
========
If a path which contains control characters is committed to a repository
then SVN operations served by mod\_dav\_svn can be disrupted by encoding
errors raised from the XML library.
This leads to disruption for users accessing the repository via HTTP.
Affected repositories can be repaired (see "Recommendations" below).
However, restoring proper operation might take some time because a
full dump/load cycle may be required.
Local repositories and svnserve repository servers (accessed via a
file://, svn://, or svn+ssh:// URL) are not affected. In these cases,
control characters have been rejected since CVE-2013-1968 was patched
in Subversion 1.6.21 and Subversion 1.7.9.
Known symptoms of the problem include:
1) 'svn checkout', 'svnsync', and other operations that attempt to
read the affected revision may produce errors like:
svn: E175009: The XML response contains invalid XML
svn: E130003: Malformed XML: not well-formed (invalid token)
2) Attempts to browse affected files or directories via the web
interface will cause the server to return:
500 Internal Server Error
Apache Subversion clients have always rejected filenames with control
characters, so control characters cannot be introduced with stock
Subversion clients. They could, however, be triggered by custom
malicious Subversion clients or by third-party client implementations.
Servers updated to Subversion 1.14.5 will reject control characters in
all cases.
Severity:
=========
CVSSv3.1 Base Score: 3.1
CVSSv3.1 Base Vector: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:L
A remote authenticated attacker with commit access may be able to
corrupt repositories on a Subversion server and cause disruption for
other users.
Configurations that allow anonymous write access to the repository
will be vulnerable to this without authentication.
Recommendations:
================
We recommend all users to upgrade their servers to a known fixed
release of Subversion.
Users who are unable to upgrade may apply the patch included below.
New Subversion packages can be found at:
http://subversion.apache.org/packages.html
Repositories affected by this problem can be repaired manually:
Bad revision properties can be repaired by using svn propedit over
the file://, svn:// or svn+ssh:// protocols.
Bad paths which have entered a repository need to be removed from
history with a dump/load cycle, using svnadmin dump --exclude to
filter out the bad paths, and loading the result into a fresh
repository with svnadmin load.
References:
===========
CVE-2024-46901 (Subversion)
CVE-2013-1968 (Subversion)
XML Characters: https://www.w3.org/TR/xml/#charsets
Reported by:
============
HaoZi, WordPress China
Patches:
========
Patch against Subversion 1.14.4:
[[[
Index: subversion/include/private/svn\_repos\_private.h
===================================================================
--- subversion/include/private/svn\_repos\_private.h (revision 1921550)
+++ subversion/include/private/svn\_repos\_private.h (working copy)
@@ -390,6 +390,14 @@ svn\_repos\_\_get\_dump\_editor(const svn\_delta\_editor\_
const char \*update\_anchor\_relpath,
apr\_pool\_t \*pool);
+/\* Validate that the given PATH is a valid pathname that can be stored in
+ \* a Subversion repository, according to the name constraints used by the
+ \* svn\_repos\_\* layer.
+ \*/
+svn\_error\_t \*
+svn\_repos\_\_validate\_new\_path(const char \*path,
+ apr\_pool\_t \*scratch\_pool);
+
#ifdef \_\_cplusplus
}
#endif /\* \_\_cplusplus \*/
Index: subversion/libsvn\_repos/commit.c
===================================================================
--- subversion/libsvn\_repos/commit.c (revision 1921550)
+++ subversion/libsvn\_repos/commit.c (working copy)
@@ -308,8 +308,7 @@ add\_file\_or\_directory(const char \*path,
svn\_boolean\_t was\_copied = FALSE;
const char \*full\_path, \*canonicalized\_path;
- /\* Reject paths which contain control characters (related to issue #4340). \*/
- SVN\_ERR(svn\_path\_check\_valid(path, pool));
+ SVN\_ERR(svn\_repos\_\_validate\_new\_path(path, pool));
SVN\_ERR(svn\_relpath\_canonicalize\_safe(&canonicalized\_path, NULL, path,
pool, pool));
Index: subversion/libsvn\_repos/repos.c
===================================================================
--- subversion/libsvn\_repos/repos.c (revision 1921550)
+++ subversion/libsvn\_repos/repos.c (working copy)
@@ -2092,3 +2092,13 @@ svn\_repos\_\_fs\_type(const char \*\*fs\_type,
svn\_dirent\_join(repos\_path, SVN\_REPOS\_\_DB\_DIR, pool),
pool);
}
+
+svn\_error\_t \*
+svn\_repos\_\_validate\_new\_path(const char \*path,
+ apr\_pool\_t \*scratch\_pool)
+{
+ /\* Reject paths which contain control characters (related to issue #4340). \*/
+ SVN\_ERR(svn\_path\_check\_valid(path, scratch\_pool));
+
+ return SVN\_NO\_ERROR;
+}
Index: subversion/mod\_dav\_svn/lock.c
===================================================================
--- subversion/mod\_dav\_svn/lock.c (revision 1921550)
+++ subversion/mod\_dav\_svn/lock.c (working copy)
@@ -36,6 +36,7 @@
#include "svn\_pools.h"
#include "svn\_props.h"
#include "private/svn\_log.h"
+#include "private/svn\_repos\_private.h"
#include "dav\_svn.h"
@@ -717,6 +718,12 @@ append\_locks(dav\_lockdb \*lockdb,
/\* Commit a 0-byte file: \*/
+ if ((serr = svn\_repos\_\_validate\_new\_path(resource->info->repos\_path,
+ resource->pool)))
+ return dav\_svn\_\_convert\_err(serr, HTTP\_BAD\_REQUEST,
+ "Request specifies an invalid path.",
+ resource->pool);
+
if ((serr = dav\_svn\_\_get\_youngest\_rev(&rev, repos, resource->pool)))
return dav\_svn\_\_convert\_err(serr, HTTP\_INTERNAL\_SERVER\_ERROR,
"Could not determine youngest revision",
Index: subversion/mod\_dav\_svn/repos.c
===================================================================
--- subversion/mod\_dav\_svn/repos.c (revision 1921550)
+++ subversion/mod\_dav\_svn/repos.c (working copy)
@@ -2928,6 +2928,16 @@ open\_stream(const dav\_resource \*resource,
if (kind == svn\_node\_none) /\* No existing file. \*/
{
+ serr = svn\_repos\_\_validate\_new\_path(resource->info->repos\_path,
+ resource->pool);
+
+ if (serr != NULL)
+ {
+ return dav\_svn\_\_convert\_err(serr, HTTP\_BAD\_REQUEST,
+ "Request specifies an invalid path.",
+ resource->pool);
+ }
+
serr = svn\_fs\_make\_file(resource->info->root.root,
resource->info->repos\_path,
resource->pool);
@@ -4120,6 +4130,14 @@ create\_collection(dav\_resource \*resource)
return err;
}
+ if ((serr = svn\_repos\_\_validate\_new\_path(resource->info->repos\_path,
+ resource->pool)) != NULL)
+ {
+ return dav\_svn\_\_convert\_err(serr, HTTP\_BAD\_REQUEST,
+ "Request specifies an invalid path.",
+ resource->pool);
+ }
+
if ((serr = svn\_fs\_make\_dir(resource->info->root.root,
resource->info->repos\_path,
resource->pool)) != NULL)
@@ -4194,6 +4212,12 @@ copy\_resource(const dav\_resource \*src,
return err;
}
+ serr = svn\_repos\_\_validate\_new\_path(dst->info->repos\_path, dst->pool);
+ if (serr)
+ return dav\_svn\_\_convert\_err(serr, HTTP\_BAD\_REQUEST,
+ "Request specifies an invalid path.",
+ dst->pool);
+
src\_repos\_path = svn\_repos\_path(src->info->repos->repos, src->pool);
dst\_repos\_path = svn\_repos\_path(dst->info->repos->repos, dst->pool);
@@ -4430,6 +4454,12 @@ move\_resource(dav\_resource \*src,
if (err)
return err;
+ serr = svn\_repos\_\_validate\_new\_path(dst->info->repos\_path, dst->pool);
+ if (serr)
+ return dav\_svn\_\_convert\_err(serr, HTTP\_BAD\_REQUEST,
+ "Request specifies an invalid path.",
+ dst->pool);
+
/\* Copy the src to the dst. \*/
serr = svn\_fs\_copy(src->info->root.root, /\* the root object of src rev\*/
src->info->repos\_path, /\* the relative path of src \*/
]]]

