=== Content from github.com_eeaa5e57_20250115_083759.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmastodon%2Fmastodon%2Fcommit%2Fb31af34c9716338e4a32a62cc812d1ca59e88d15)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmastodon%2Fmastodon%2Fcommit%2Fb31af34c9716338e4a32a62cc812d1ca59e88d15)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=mastodon%2Fmastodon)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mastodon](/mastodon)
/
**[mastodon](/mastodon/mastodon)**
Public

* [Notifications](/login?return_to=%2Fmastodon%2Fmastodon) You must be signed in to change notification settings
* [Fork
  7.1k](/login?return_to=%2Fmastodon%2Fmastodon)
* [Star
   47.5k](/login?return_to=%2Fmastodon%2Fmastodon)

* [Code](/mastodon/mastodon)
* [Issues
  3.8k](/mastodon/mastodon/issues)
* [Pull requests
  163](/mastodon/mastodon/pulls)
* [Discussions](/mastodon/mastodon/discussions)
* [Actions](/mastodon/mastodon/actions)
* [Projects
  1](/mastodon/mastodon/projects)
* [Security](/mastodon/mastodon/security)
* [Insights](/mastodon/mastodon/pulse)

Additional navigation options

* [Code](/mastodon/mastodon)
* [Issues](/mastodon/mastodon/issues)
* [Pull requests](/mastodon/mastodon/pulls)
* [Discussions](/mastodon/mastodon/discussions)
* [Actions](/mastodon/mastodon/actions)
* [Projects](/mastodon/mastodon/projects)
* [Security](/mastodon/mastodon/security)
* [Insights](/mastodon/mastodon/pulse)

## Commit

[Permalink](/mastodon/mastodon/commit/b31af34c9716338e4a32a62cc812d1ca59e88d15)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-vm39-j3vx-pch3](https://github.com/mastodon/mastodon/security/advisories/GHSA-vm39-j3vx-pch3 "GHSA-vm39-j3vx-pch3")

[Browse files](/mastodon/mastodon/tree/b31af34c9716338e4a32a62cc812d1ca59e88d15)
Browse the repository at this point in the history

```
* Prevent different identities from a same SSO provider from accessing a same account

* Lock auth provider changes behind `ALLOW_UNSAFE_AUTH_PROVIDER_REATTACH=true`

* Rename methods to avoid confusion between OAuth and OmniAuth
```

* Loading branch information

[![@ClearlyClaire](https://avatars.githubusercontent.com/u/384364?s=40&v=4)](/ClearlyClaire)

[ClearlyClaire](/mastodon/mastodon/commits?author=ClearlyClaire "View all commits by ClearlyClaire")
authored
Feb 14, 2024

1 parent
[68eaa80](/mastodon/mastodon/commit/68eaa804c9bafdc5f798e114e9ba00161425dd71)

commit b31af34

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**44 additions**
and
**20 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* app

  + controllers/auth

    - app/controllers/auth/omniauth\_callbacks\_controller.rb
      [omniauth\_callbacks\_controller.rb](#diff-c108184baea93c9a87486451e54605ca3da49167f41a13cf966258f7819e838c)
  + models

    - concerns/user

      * app/models/concerns/user/omniauthable.rb
        [omniauthable.rb](#diff-c4fb33defa9c52fd41945a0765ea02a62f515c49024d154daae19b214e01da88)
    - app/models/identity.rb
      [identity.rb](#diff-2d17b0ec73a07d3caf07d4d84915b160fd676a739f9a8ecd6e43f61c27a36d3d)
* spec

  + models

    - spec/models/identity\_spec.rb
      [identity\_spec.rb](#diff-a51a4507e469f51d506528aeffd589b7725bdecded47838ae02521d0b3082dc1)
  + requests

    - spec/requests/omniauth\_callbacks\_spec.rb
      [omniauth\_callbacks\_spec.rb](#diff-b175cb520b316cea2754c90273d0fa0fc9f18424afeea7a370fa2b734be2b88d)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[app/controllers/auth/omniauth\_callbacks\_controller.rb](#diff-c108184baea93c9a87486451e54605ca3da49167f41a13cf966258f7819e838c "app/controllers/auth/omniauth_callbacks_controller.rb")

Show comments

[View file](/mastodon/mastodon/blob/b31af34c9716338e4a32a62cc812d1ca59e88d15/app/controllers/auth/omniauth_callbacks_controller.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -7,7 +7,7 @@ class Auth::OmniauthCallbacksController < Devise::OmniauthCallbacksController |
|  |  | def self.provides\_callback\_for(provider) |
|  |  | define\_method provider do |
|  |  | @provider = provider |
|  |  | @user = User.find\_for\_oauth(request.env['omniauth.auth'], current\_user) |
|  |  | @user = User.find\_for\_omniauth(request.env['omniauth.auth'], current\_user) |
|  |  |  |
|  |  | if @user.persisted? |
|  |  | record\_login\_activity |
| Expand Down | |  |

52 changes: 38 additions & 14 deletions

52
[app/models/concerns/user/omniauthable.rb](#diff-c4fb33defa9c52fd41945a0765ea02a62f515c49024d154daae19b214e01da88 "app/models/concerns/user/omniauthable.rb")

Show comments

[View file](/mastodon/mastodon/blob/b31af34c9716338e4a32a62cc812d1ca59e88d15/app/models/concerns/user/omniauthable.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -19,17 +19,18 @@ def email\_present? |
|  |  | end |
|  |  |  |
|  |  | class\_methods do |
|  |  | def find\_for\_oauth(auth, signed\_in\_resource = nil) |
|  |  | def find\_for\_omniauth(auth, signed\_in\_resource = nil) |
|  |  | # EOLE-SSO Patch |
|  |  | auth.uid = (auth.uid[0][:uid] || auth.uid[0][:user]) if auth.uid.is\_a? Hashie::Array |
|  |  | identity = Identity.find\_for\_oauth(auth) |
|  |  | identity = Identity.find\_for\_omniauth(auth) |
|  |  |  |
|  |  | # If a signed\_in\_resource is provided it always overrides the existing user |
|  |  | # to prevent the identity being locked with accidentally created accounts. |
|  |  | # Note that this may leave zombie accounts (with no associated identity) which |
|  |  | # can be cleaned up at a later date. |
|  |  | user = signed\_in\_resource || identity.user |
|  |  | user ||= create\_for\_oauth(auth) |
|  |  | user ||= reattach\_for\_auth(auth) |
|  |  | user ||= create\_for\_auth(auth) |
|  |  |  |
|  |  | if identity.user.nil? |
|  |  | identity.user = user |
| Expand All | | @@ -39,19 +40,35 @@ def find\_for\_oauth(auth, signed\_in\_resource = nil) |
|  |  | user |
|  |  | end |
|  |  |  |
|  |  | def create\_for\_oauth(auth) |
|  |  | # Check if the user exists with provided email. If no email was provided, |
|  |  | # we assign a temporary email and ask the user to verify it on |
|  |  | # the next step via Auth::SetupController.show |
|  |  | private |
|  |  |  |
|  |  | strategy = Devise.omniauth\_configs[auth.provider.to\_sym].strategy |
|  |  | assume\_verified = strategy&.security&.assume\_email\_is\_verified |
|  |  | email\_is\_verified = auth.info.verified || auth.info.verified\_email || auth.info.email\_verified || assume\_verified |
|  |  | email = auth.info.verified\_email || auth.info.email |
|  |  | def reattach\_for\_auth(auth) |
|  |  | # If allowed, check if a user exists with the provided email address, |
|  |  | # and return it if they does not have an associated identity with the |
|  |  | # current authentication provider. |
|  |  |  |
|  |  | # This can be used to provide a choice of alternative auth providers |
|  |  | # or provide smooth gradual transition between multiple auth providers, |
|  |  | # but this is discouraged because any insecure provider will put \*all\* |
|  |  | # local users at risk, regardless of which provider they registered with. |
|  |  |  |
|  |  | return unless ENV['ALLOW\_UNSAFE\_AUTH\_PROVIDER\_REATTACH'] == 'true' |
|  |  |  |
|  |  | user = User.find\_by(email: email) if email\_is\_verified |
|  |  | email, email\_is\_verified = email\_from\_auth(auth) |
|  |  | return unless email\_is\_verified |
|  |  |  |
|  |  | return user unless user.nil? |
|  |  | user = User.find\_by(email: email) |
|  |  | return if user.nil? || Identity.exists?(provider: auth.provider, user\_id: user.id) |
|  |  |  |
|  |  | user |
|  |  | end |
|  |  |  |
|  |  | def create\_for\_auth(auth) |
|  |  | # Create a user for the given auth params. If no email was provided, |
|  |  | # we assign a temporary email and ask the user to verify it on |
|  |  | # the next step via Auth::SetupController.show |
|  |  |  |
|  |  | email, email\_is\_verified = email\_from\_auth(auth) |
|  |  |  |
|  |  | user = User.new(user\_params\_from\_auth(email, auth)) |
|  |  |  |
| Expand All | | @@ -66,7 +83,14 @@ def create\_for\_oauth(auth) |
|  |  | user |
|  |  | end |
|  |  |  |
|  |  | private |
|  |  | def email\_from\_auth(auth) |
|  |  | strategy = Devise.omniauth\_configs[auth.provider.to\_sym].strategy |
|  |  | assume\_verified = strategy&.security&.assume\_email\_is\_verified |
|  |  | email\_is\_verified = auth.info.verified || auth.info.verified\_email || auth.info.email\_verified || assume\_verified |
|  |  | email = auth.info.verified\_email || auth.info.email |
|  |  |  |
|  |  | [email, email\_is\_verified] |
|  |  | end |
|  |  |  |
|  |  | def user\_params\_from\_auth(email, auth) |
|  |  | { |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[app/models/identity.rb](#diff-2d17b0ec73a07d3caf07d4d84915b160fd676a739f9a8ecd6e43f61c27a36d3d "app/models/identity.rb")

Show comments

[View file](/mastodon/mastodon/blob/b31af34c9716338e4a32a62cc812d1ca59e88d15/app/models/identity.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,7 +17,7 @@ class Identity < ApplicationRecord |
|  |  | validates :uid, presence: true, uniqueness: { scope: :provider } |
|  |  | validates :provider, presence: true |
|  |  |  |
|  |  | def self.find\_for\_oauth(auth) |
|  |  | def self.find\_for\_omniauth(auth) |
|  |  | find\_or\_create\_by(uid: auth.uid, provider: auth.provider) |
|  |  | end |
|  |  | end |

6 changes: 3 additions & 3 deletions

6
[spec/models/identity\_spec.rb](#diff-a51a4507e469f51d506528aeffd589b7725bdecded47838ae02521d0b3082dc1 "spec/models/identity_spec.rb")

Show comments

[View file](/mastodon/mastodon/blob/b31af34c9716338e4a32a62cc812d1ca59e88d15/spec/models/identity_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,19 +3,19 @@ |
|  |  | require 'rails\_helper' |
|  |  |  |
|  |  | RSpec.describe Identity do |
|  |  | describe '.find\_for\_oauth' do |
|  |  | describe '.find\_for\_omniauth' do |
|  |  | let(:auth) { Fabricate(:identity, user: Fabricate(:user)) } |
|  |  |  |
|  |  | it 'calls .find\_or\_create\_by' do |
|  |  | allow(described\_class).to receive(:find\_or\_create\_by) |
|  |  |  |
|  |  | described\_class.find\_for\_oauth(auth) |
|  |  | described\_class.find\_for\_omniauth(auth) |
|  |  |  |
|  |  | expect(described\_class).to have\_received(:find\_or\_create\_by).with(uid: auth.uid, provider: auth.provider) |
|  |  | end |
|  |  |  |
|  |  | it 'returns an instance of Identity' do |
|  |  | expect(described\_class.find\_for\_oauth(auth)).to be\_instance\_of described\_class |
|  |  | expect(described\_class.find\_for\_omniauth(auth)).to be\_instance\_of described\_class |
|  |  | end |
|  |  | end |
|  |  | end |

2 changes: 1 addition & 1 deletion

2
[spec/requests/omniauth\_callbacks\_spec.rb](#diff-b175cb520b316cea2754c90273d0fa0fc9f18424afeea7a370fa2b734be2b88d "spec/requests/omniauth_callbacks_spec.rb")

Show comments

[View file](/mastodon/mastodon/blob/b31af34c9716338e4a32a62cc812d1ca59e88d15/spec/requests/omniauth_callbacks_spec.rb)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -96,7 +96,7 @@ |
|  |  |  |
|  |  | context 'when a user cannot be built' do |
|  |  | before do |
|  |  | allow(User).to receive(:find\_for\_oauth).and\_return(User.new) |
|  |  | allow(User).to receive(:find\_for\_omniauth).and\_return(User.new) |
|  |  | end |
|  |  |  |
|  |  | it 'redirects to the new user signup page' do |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b31af34`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmastodon%2Fmastodon%2Fcommit%2Fb31af34c9716338e4a32a62cc812d1ca59e88d15) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_5d8cd5b6_20250115_083759.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmastodon%2Fmastodon%2Fsecurity%2Fadvisories%2FGHSA-vm39-j3vx-pch3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmastodon%2Fmastodon%2Fsecurity%2Fadvisories%2FGHSA-vm39-j3vx-pch3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=mastodon%2Fmastodon)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mastodon](/mastodon)
/
**[mastodon](/mastodon/mastodon)**
Public

* [Notifications](/login?return_to=%2Fmastodon%2Fmastodon) You must be signed in to change notification settings
* [Fork
  7.1k](/login?return_to=%2Fmastodon%2Fmastodon)
* [Star
   47.5k](/login?return_to=%2Fmastodon%2Fmastodon)

* [Code](/mastodon/mastodon)
* [Issues
  3.8k](/mastodon/mastodon/issues)
* [Pull requests
  163](/mastodon/mastodon/pulls)
* [Discussions](/mastodon/mastodon/discussions)
* [Actions](/mastodon/mastodon/actions)
* [Projects
  1](/mastodon/mastodon/projects)
* [Security](/mastodon/mastodon/security)
* [Insights](/mastodon/mastodon/pulse)

Additional navigation options

* [Code](/mastodon/mastodon)
* [Issues](/mastodon/mastodon/issues)
* [Pull requests](/mastodon/mastodon/pulls)
* [Discussions](/mastodon/mastodon/discussions)
* [Actions](/mastodon/mastodon/actions)
* [Projects](/mastodon/mastodon/projects)
* [Security](/mastodon/mastodon/security)
* [Insights](/mastodon/mastodon/pulse)

# External OpenID Connect Account Takeover by E-Mail Change

Moderate

[renchap](/renchap)
published
GHSA-vm39-j3vx-pch3
Feb 14, 2024

## Package

No package listed

## Affected versions

all

## Patched versions

4.2.6, 4.1.14, 4.0.14, 3.5.18

## Description

### Summary

Dominik George and Pingu from Teckids discovered that Mastodon allows new identities from configured authentication providers (CAS, SAML, OIDC) to attach to existing local users with the same e-mail address. This results in a possible account takeover if the authentication provider allows changing the e-mail address or multiple authentication providers are configured.

### Details

When a user logs in through an external authentication provider for the first time, Mastodon checks the e-mail address passed by the provider to find an existing account.

However, using the e-mail address alone means that if the authentication provider allows changing the e-mail address of an account, the Mastodon account can immediately be hijacked.

### PoC

1. Install an OIDC provider, like Keycloak
2. Connect Mastodon to the OIDC provider
3. Create two accounts in Keycloak, `foo` and `bar`. Assign the e-mail addresses `foo@example.com` and `bar@example.com`, respectively
4. Login to Mastodon with `foo`
5. Logout in Mastodon
6. Swap the e-mail addresses in Keycloak
7. Login in Mastodon again

### Impact

All users logging in through external authentication providers are affected. The severity is medium, as it also requires the external authentication provider to misbehave.

However, some well-known OIDC providers (like Microsoft Azure) make it very easy to accidentally allow unverified e-mail changes. Moreover, OpenID Connect also allows dynamic client registration.

### Severity

Moderate

### CVE ID

CVE-2024-25618

### Weaknesses

[CWE-287](/advisories?query=cwe%3A287)

### Credits

* [![@Natureshadow](https://avatars.githubusercontent.com/u/212972?s=40&v=4)](/Natureshadow)
  [Natureshadow](/Natureshadow)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


