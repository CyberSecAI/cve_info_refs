=== Content from github.com_3d6dfb28_20250114_185951.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fblob%2F92e8ede24e9277a5440d403f75877209f1269884%2Fapp%2Froutes.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fblob%2F92e8ede24e9277a5440d403f75877209f1269884%2Fapp%2Froutes.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=benbusby%2Fwhoogle-search)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[benbusby](/benbusby)
/
**[whoogle-search](/benbusby/whoogle-search)**
Public

* [Notifications](/login?return_to=%2Fbenbusby%2Fwhoogle-search) You must be signed in to change notification settings
* [Fork
  960](/login?return_to=%2Fbenbusby%2Fwhoogle-search)
* [Star
   9.8k](/login?return_to=%2Fbenbusby%2Fwhoogle-search)

* [Code](/benbusby/whoogle-search)
* [Issues
  68](/benbusby/whoogle-search/issues)
* [Pull requests
  9](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects
  0](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

Additional navigation options

* [Code](/benbusby/whoogle-search)
* [Issues](/benbusby/whoogle-search/issues)
* [Pull requests](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

## Files

 92e8ede
## Breadcrumbs

1. [whoogle-search](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884)
2. /[app](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884/app)
/
# routes.py

Copy path Blame  Blame
## Latest commit

## History

[History](/benbusby/whoogle-search/commits/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py)648 lines (543 loc) · 22.2 KB 92e8ede
## Breadcrumbs

1. [whoogle-search](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884)
2. /[app](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884/app)
/
# routes.py

Top
## File metadata and controls

* Code
* Blame

648 lines (543 loc) · 22.2 KB[Raw](https://github.com/benbusby/whoogle-search/raw/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648import argparseimport base64import ioimport jsonimport osimport pickleimport urllib.parse as urlparseimport uuidfrom datetime import datetime, timedeltafrom functools import wraps
import waitressfrom app import appfrom app.models.config import Configfrom app.models.endpoint import Endpointfrom app.request import Request, TorErrorfrom app.utils.bangs import resolve\_bangfrom app.utils.misc import get\_proxy\_host\_urlfrom app.filter import Filterfrom app.utils.misc import read\_config\_bool, get\_client\_ip, get\_request\_url, \ check\_for\_updatefrom app.utils.widgets import \*from app.utils.results import bold\_search\_terms,\ add\_currency\_card, check\_currency, get\_tabs\_contentfrom app.utils.search import Search, needs\_https, has\_captchafrom app.utils.session import valid\_user\_sessionfrom bs4 import BeautifulSoup as bsoupfrom flask import jsonify, make\_response, request, redirect, render\_template, \ send\_file, session, url\_for, gfrom requests import exceptionsfrom requests.models import PreparedRequestfrom cryptography.fernet import Fernet, InvalidTokenfrom cryptography.exceptions import InvalidSignature
# Load DDG bang json files only on initbang\_json = json.load(open(app.config['BANG\_FILE'])) or {}
ac\_var = 'WHOOGLE\_AUTOCOMPLETE'autocomplete\_enabled = os.getenv(ac\_var, '1')
def get\_search\_name(tbm): for tab in app.config['HEADER\_TABS'].values(): if tab['tbm'] == tbm: return tab['name']
def auth\_required(f): @wraps(f) def decorated(\*args, \*\*kwargs): # do not ask password if cookies already present if ( valid\_user\_session(session) and 'cookies\_disabled' not in request.args and session['auth'] ): return f(\*args, \*\*kwargs)
 auth = request.authorization
 # Skip if username/password not set whoogle\_user = os.getenv('WHOOGLE\_USER', '') whoogle\_pass = os.getenv('WHOOGLE\_PASS', '') if (not whoogle\_user or not whoogle\_pass) or ( auth and whoogle\_user == auth.username and whoogle\_pass == auth.password): session['auth'] = True return f(\*args, \*\*kwargs) else: return make\_response('Not logged in', 401, { 'WWW-Authenticate': 'Basic realm="Login Required"'})
 return decorated
def session\_required(f): @wraps(f) def decorated(\*args, \*\*kwargs): if not valid\_user\_session(session): session.pop('\_permanent', None)
 # Note: This sets all requests to use the encryption key determined per # instance on app init. This can be updated in the future to use a key # that is unique for their session (session['key']) but this should use # a config setting to enable the session based key. Otherwise there can # be problems with searches performed by users with cookies blocked if # a session based key is always used. g.session\_key = app.enc\_key
 # Clear out old sessions invalid\_sessions = [] for user\_session in os.listdir(app.config['SESSION\_FILE\_DIR']): file\_path = os.path.join( app.config['SESSION\_FILE\_DIR'], user\_session)
 try: # Ignore files that are larger than the max session file size if os.path.getsize(file\_path) > app.config['MAX\_SESSION\_SIZE']: continue
 with open(file\_path, 'rb') as session\_file: \_ = pickle.load(session\_file) data = pickle.load(session\_file) if isinstance(data, dict) and 'valid' in data: continue invalid\_sessions.append(file\_path) except Exception: # Broad exception handling here due to how instances installed # with pip seem to have issues storing unrelated files in the # same directory as sessions pass
 for invalid\_session in invalid\_sessions: try: os.remove(invalid\_session) except FileNotFoundError: # Don't throw error if the invalid session has been removed pass
 return f(\*args, \*\*kwargs)
 return decorated
@app.before\_requestdef before\_request\_func(): global bang\_json session.permanent = True
 # Check for latest version if needed now = datetime.now() if now - timedelta(hours=24) > app.config['LAST\_UPDATE\_CHECK']: app.config['LAST\_UPDATE\_CHECK'] = now app.config['HAS\_UPDATE'] = check\_for\_update( app.config['RELEASES\_URL'], app.config['VERSION\_NUMBER'])
 g.request\_params = ( request.args if request.method == 'GET' else request.form )
 default\_config = json.load(open(app.config['DEFAULT\_CONFIG'])) \ if os.path.exists(app.config['DEFAULT\_CONFIG']) else {}
 # Generate session values for user if unavailable if not valid\_user\_session(session): session['config'] = default\_config session['uuid'] = str(uuid.uuid4()) session['key'] = app.enc\_key session['auth'] = False
 # Establish config values per user session g.user\_config = Config(\*\*session['config'])
 # Update user config if specified in search args g.user\_config = g.user\_config.from\_params(g.request\_params)
 if not g.user\_config.url: g.user\_config.url = get\_request\_url(request.url\_root)
 g.user\_request = Request( request.headers.get('User-Agent'), get\_request\_url(request.url\_root), config=g.user\_config)
 g.app\_location = g.user\_config.url
 # Attempt to reload bangs json if not generated yet if not bang\_json and os.path.getsize(app.config['BANG\_FILE']) > 4: try: bang\_json = json.load(open(app.config['BANG\_FILE'])) except json.decoder.JSONDecodeError: # Ignore decoding error, can occur if file is still # being written pass
@app.after\_requestdef after\_request\_func(resp): resp.headers['X-Content-Type-Options'] = 'nosniff' resp.headers['X-Frame-Options'] = 'DENY'
 if os.getenv('WHOOGLE\_CSP', False): resp.headers['Content-Security-Policy'] = app.config['CSP'] if os.environ.get('HTTPS\_ONLY', False): resp.headers['Content-Security-Policy'] += \ 'upgrade-insecure-requests'
 return resp
@app.errorhandler(404)def unknown\_page(e): app.logger.warn(e) return redirect(g.app\_location)
@app.route(f'/{Endpoint.healthz}', methods=['GET'])def healthz(): return ''
@app.route('/', methods=['GET'])@app.route(f'/{Endpoint.home}', methods=['GET'])@auth\_requireddef index(): # Redirect if an error was raised if 'error\_message' in session and session['error\_message']: error\_message = session['error\_message'] session['error\_message'] = '' return render\_template('error.html', error\_message=error\_message)
 return render\_template('index.html', has\_update=app.config['HAS\_UPDATE'], languages=app.config['LANGUAGES'], countries=app.config['COUNTRIES'], time\_periods=app.config['TIME\_PERIODS'], themes=app.config['THEMES'], autocomplete\_enabled=autocomplete\_enabled, translation=app.config['TRANSLATIONS'][ g.user\_config.get\_localization\_lang() ], logo=render\_template( 'logo.html', dark=g.user\_config.dark), config\_disabled=( app.config['CONFIG\_DISABLE'] or not valid\_user\_session(session)), config=g.user\_config, tor\_available=int(os.environ.get('TOR\_AVAILABLE')), version\_number=app.config['VERSION\_NUMBER'])
@app.route(f'/{Endpoint.opensearch}', methods=['GET'])def opensearch(): opensearch\_url = g.app\_location if opensearch\_url.endswith('/'): opensearch\_url = opensearch\_url[:-1]
 # Enforce https for opensearch template if needs\_https(opensearch\_url): opensearch\_url = opensearch\_url.replace('http://', 'https://', 1)
 get\_only = g.user\_config.get\_only or 'Chrome' in request.headers.get( 'User-Agent')
 return render\_template( 'opensearch.xml', main\_url=opensearch\_url, request\_type='' if get\_only else 'method="post"', search\_type=request.args.get('tbm'), search\_name=get\_search\_name(request.args.get('tbm')) ), 200, {'Content-Type': 'application/xml'}
@app.route(f'/{Endpoint.search\_html}', methods=['GET'])def search\_html(): search\_url = g.app\_location if search\_url.endswith('/'): search\_url = search\_url[:-1] return render\_template('search.html', url=search\_url)
@app.route(f'/{Endpoint.autocomplete}', methods=['GET', 'POST'])def autocomplete(): if os.getenv(ac\_var) and not read\_config\_bool(ac\_var): return jsonify({})
 q = g.request\_params.get('q') if not q: # FF will occasionally (incorrectly) send the q field without a # mimetype in the format "b'q=<query>'" through the request.data field q = str(request.data).replace('q=', '')
 # Search bangs if the query begins with "!", but not "! " (feeling lucky) if q.startswith('!') and len(q) > 1 and not q.startswith('! '): return jsonify([q, [bang\_json[\_]['suggestion'] for \_ in bang\_json if \_.startswith(q)]])
 if not q and not request.data: return jsonify({'?': []}) elif request.data: q = urlparse.unquote\_plus( request.data.decode('utf-8').replace('q=', ''))
 # Return a list of suggestions for the query # # Note: If Tor is enabled, this returns nothing, as the request is # almost always rejected return jsonify([ q, g.user\_request.autocomplete(q) if not g.user\_config.tor else [] ])
@app.route(f'/{Endpoint.search}', methods=['GET', 'POST'])@session\_required@auth\_requireddef search(): search\_util = Search(request, g.user\_config, g.session\_key) query = search\_util.new\_search\_query()
 bang = resolve\_bang(query, bang\_json) if bang: return redirect(bang)
 # Redirect to home if invalid/blank search if not query: return redirect(url\_for('.index'))
 # Generate response and number of external elements from the page try: response = search\_util.generate\_response() except TorError as e: session['error\_message'] = e.message + ( "\\n\\nTor config is now disabled!" if e.disable else "") session['config']['tor'] = False if e.disable else session['config'][ 'tor'] return redirect(url\_for('.index'))
 if search\_util.feeling\_lucky: return redirect(response, code=303)
 # If the user is attempting to translate a string, determine the correct # string for formatting the lingva.ml url localization\_lang = g.user\_config.get\_localization\_lang() translation = app.config['TRANSLATIONS'][localization\_lang] translate\_to = localization\_lang.replace('lang\_', '')
 # removing st-card to only use whoogle time selector soup = bsoup(response, "html.parser"); for x in soup.find\_all(attrs={"id": "st-card"}): x.replace\_with("")
 response = str(soup)
 # Return 503 if temporarily blocked by captcha if has\_captcha(str(response)): app.logger.error('503 (CAPTCHA)') return render\_template( 'error.html', blocked=True, error\_message=translation['ratelimit'], translation=translation, farside='https://farside.link', config=g.user\_config, query=urlparse.unquote(query), params=g.user\_config.to\_params(keys=['preferences'])), 503
 response = bold\_search\_terms(response, query)
 # check for widgets and add if requested if search\_util.widget != '': html\_soup = bsoup(str(response), 'html.parser') if search\_util.widget == 'ip': response = add\_ip\_card(html\_soup, get\_client\_ip(request)) elif search\_util.widget == 'calculator' and not 'nojs' in request.args: response = add\_calculator\_card(html\_soup)
 # Update tabs content tabs = get\_tabs\_content(app.config['HEADER\_TABS'], search\_util.full\_query, search\_util.search\_type, g.user\_config.preferences, translation)
 # Feature to display currency\_card # Since this is determined by more than just the # query is it not defined as a standard widget conversion = check\_currency(str(response)) if conversion: html\_soup = bsoup(str(response), 'html.parser') response = add\_currency\_card(html\_soup, conversion)
 preferences = g.user\_config.preferences home\_url = f"home?preferences={preferences}" if preferences else "home" cleanresponse = str(response).replace("andlt;","&lt;").replace("andgt;","&gt;")
 return render\_template( 'display.html', has\_update=app.config['HAS\_UPDATE'], query=urlparse.unquote(query), search\_type=search\_util.search\_type, search\_name=get\_search\_name(search\_util.search\_type), config=g.user\_config, autocomplete\_enabled=autocomplete\_enabled, lingva\_url=app.config['TRANSLATE\_URL'], translation=translation, translate\_to=translate\_to, translate\_str=query.replace( 'translate', '' ).replace( translation['translate'], '' ), is\_translation=any( \_ in query.lower() for \_ in [translation['translate'], 'translate'] ) and not search\_util.search\_type, # Standard search queries only response=cleanresponse, version\_number=app.config['VERSION\_NUMBER'], search\_header=render\_template( 'header.html', home\_url=home\_url, config=g.user\_config, translation=translation, languages=app.config['LANGUAGES'], countries=app.config['COUNTRIES'], time\_periods=app.config['TIME\_PERIODS'], logo=render\_template('logo.html', dark=g.user\_config.dark), query=urlparse.unquote(query), search\_type=search\_util.search\_type, mobile=g.user\_request.mobile, tabs=tabs)).replace(" ", "")
@app.route(f'/{Endpoint.config}', methods=['GET', 'POST', 'PUT'])@session\_required@auth\_requireddef config(): config\_disabled = ( app.config['CONFIG\_DISABLE'] or not valid\_user\_session(session)) if request.method == 'GET': return json.dumps(g.user\_config.\_\_dict\_\_) elif request.method == 'PUT' and not config\_disabled: if 'name' in request.args: config\_pkl = os.path.join( app.config['CONFIG\_PATH'], request.args.get('name')) session['config'] = (pickle.load(open(config\_pkl, 'rb')) if os.path.exists(config\_pkl) else session['config']) return json.dumps(session['config']) else: return json.dumps({}) elif not config\_disabled: config\_data = request.form.to\_dict() if 'url' not in config\_data or not config\_data['url']: config\_data['url'] = g.user\_config.url
 # Save config by name to allow a user to easily load later if 'name' in request.args: pickle.dump( config\_data, open(os.path.join( app.config['CONFIG\_PATH'], request.args.get('name')), 'wb'))
 session['config'] = config\_data return redirect(config\_data['url']) else: return redirect(url\_for('.index'), code=403)
@app.route(f'/{Endpoint.imgres}')@session\_required@auth\_requireddef imgres(): return redirect(request.args.get('imgurl'))
@app.route(f'/{Endpoint.element}')@session\_required@auth\_requireddef element(): element\_url = src\_url = request.args.get('url') if element\_url.startswith('gAAAAA'): try: cipher\_suite = Fernet(g.session\_key) src\_url = cipher\_suite.decrypt(element\_url.encode()).decode() except (InvalidSignature, InvalidToken) as e: return render\_template( 'error.html', error\_message=str(e)), 401
 src\_type = request.args.get('type')
 try: file\_data = g.user\_request.send(base\_url=src\_url).content tmp\_mem = io.BytesIO() tmp\_mem.write(file\_data) tmp\_mem.seek(0)
 return send\_file(tmp\_mem, mimetype=src\_type) except exceptions.RequestException: pass
 empty\_gif = base64.b64decode( 'R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==') return send\_file(io.BytesIO(empty\_gif), mimetype='image/gif')
@app.route(f'/{Endpoint.window}')@session\_required@auth\_requireddef window(): target\_url = request.args.get('location') if target\_url.startswith('gAAAAA'): cipher\_suite = Fernet(g.session\_key) target\_url = cipher\_suite.decrypt(target\_url.encode()).decode()
 content\_filter = Filter( g.session\_key, root\_url=request.url\_root, config=g.user\_config) target = urlparse.urlparse(target\_url) host\_url = f'{target.scheme}://{target.netloc}'
 get\_body = g.user\_request.send(base\_url=target\_url).text
 results = bsoup(get\_body, 'html.parser') src\_attrs = ['src', 'href', 'srcset', 'data-srcset', 'data-src']
 # Parse HTML response and replace relative links w/ absolute for element in results.find\_all(): for attr in src\_attrs: if not element.has\_attr(attr) or not element[attr].startswith('/'): continue
 element[attr] = host\_url + element[attr]
 # Replace or remove javascript sources for script in results.find\_all('script', {'src': True}): if 'nojs' in request.args: script.decompose() else: content\_filter.update\_element\_src(script, 'application/javascript')
 # Replace all possible image attributes img\_sources = ['src', 'data-src', 'data-srcset', 'srcset'] for img in results.find\_all('img'): \_ = [ content\_filter.update\_element\_src(img, 'image/png', attr=\_) for \_ in img\_sources if img.has\_attr(\_) ]
 # Replace all stylesheet sources for link in results.find\_all('link', {'href': True}): content\_filter.update\_element\_src(link, 'text/css', attr='href')
 # Use anonymous view for all links on page for a in results.find\_all('a', {'href': True}): a['href'] = f'{Endpoint.window}?location=' + a['href'] + ( '&nojs=1' if 'nojs' in request.args else '')
 # Remove all iframes -- these are commonly used inside of <noscript> tags # to enforce loading Google Analytics for iframe in results.find\_all('iframe'): iframe.decompose()
 return render\_template( 'display.html', response=results, translation=app.config['TRANSLATIONS'][ g.user\_config.get\_localization\_lang() ] )
@app.route(f'/robots.txt')def robots(): response = make\_response('''User-Agent: \*Disallow: /''', 200) response.mimetype = 'text/plain' return response
@app.errorhandler(404)def page\_not\_found(e): return render\_template('error.html', error\_message=str(e)), 404
def run\_app() -> None: parser = argparse.ArgumentParser( description='Whoogle Search console runner') parser.add\_argument( '--port', default=5000, metavar='<port number>', help='Specifies a port to run on (default 5000)') parser.add\_argument( '--host', default='127.0.0.1', metavar='<ip address>', help='Specifies the host address to use (default 127.0.0.1)') parser.add\_argument( '--unix-socket', default='', metavar='</path/to/unix.sock>', help='Listen for app on unix socket instead of host:port') parser.add\_argument( '--debug', default=False, action='store\_true', help='Activates debug mode for the server (default False)') parser.add\_argument( '--https-only', default=False, action='store\_true', help='Enforces HTTPS redirects for all requests') parser.add\_argument( '--userpass', default='', metavar='<username:password>', help='Sets a username/password basic auth combo (default None)') parser.add\_argument( '--proxyauth', default='', metavar='<username:password>', help='Sets a username/password for a HTTP/SOCKS proxy (default None)') parser.add\_argument( '--proxytype', default='', metavar='<socks4|socks5|http>', help='Sets a proxy type for all connections (default None)') parser.add\_argument( '--proxyloc', default='', metavar='<location:port>', help='Sets a proxy location for all connections (default None)') args = parser.parse\_args()
 if args.userpass: user\_pass = args.userpass.split(':') os.environ['WHOOGLE\_USER'] = user\_pass[0] os.environ['WHOOGLE\_PASS'] = user\_pass[1]
 if args.proxytype and args.proxyloc: if args.proxyauth: proxy\_user\_pass = args.proxyauth.split(':') os.environ['WHOOGLE\_PROXY\_USER'] = proxy\_user\_pass[0] os.environ['WHOOGLE\_PROXY\_PASS'] = proxy\_user\_pass[1] os.environ['WHOOGLE\_PROXY\_TYPE'] = args.proxytype os.environ['WHOOGLE\_PROXY\_LOC'] = args.proxyloc
 if args.https\_only: os.environ['HTTPS\_ONLY'] = '1'
 if args.debug: app.run(host=args.host, port=args.port, debug=args.debug) elif args.unix\_socket: waitress.serve(app, unix\_socket=args.unix\_socket) else: waitress.serve( app, listen="{}:{}".format(args.host, args.port), url\_prefix=os.environ.get('WHOOGLE\_URL\_PREFIX', ''))

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from securitylab.github.com_6010e15e_20250114_185959.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

January 18, 2024
# GHSL-2023-186\_GHSL-2023-189: Server-Side Request Forgery (SSRF) and Cross-Site Scripting (XSS) in whoogle-search - CVE-2024-22203, CVE-2024-22204, CVE-2024-22205, CVE-2024-22417

[![Author avatar](https://avatars.githubusercontent.com/u/102833689)
Sylwia Budzynska](https://github.com/sylwia-budzynska)

## Coordinated Disclosure Timeline

* 2023-09-12: Sent a report to the maintainer’s email.
* 2023-09-27: Received a reply that issues have been fixed and a new version will be available in a couple of weeks.
* 2023-09-28: Answered the email and asked for creating an advisory and assigning a CVE.
* 2023-10-31: Sent an email asking for creating an advisory and assigning a CVE.
* 2023-12-11: Sent an email asking for creating an advisory and assigning a CVE.
* 2023-01-04: Sent an email with a information that the deadline for publishing the advisories has passed.
* 2023-01-12: GitHub Security Lab assigned CVEs for the issues.

## Summary

Whoogle-search is vulnerable to Server-Side Request Forgery (SSRFs), Cross-Site Scripting (XSS) and a limited file write vulnerability.

## Project

whoogle-search

## Tested Version

[0.8.3](https://github.com/benbusby/whoogle-search/releases/tag/v0.8.3)

## Details

### Issue 1: SSRF in the `element` endpoint (`GHSL-2023-186`)

The [`element`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L465-L490) method in app/routes.py does not validate the user-controlled [`src_type`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L476) and [`element_url`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L466) variables and passes them to the [`send`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L479) method which sends a GET request on lines [339-343](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/request.py#L339-L343) in request.py, which leads to a server-side request forgery.

routes.py snippet from the `element` method

```
def element():
    element_url = src_url = request.args.get('url')

    #code cut out for readability
    src_type = request.args.get('type')

    try:
        file_data = g.user_request.send(base_url=src_url).content

```

request.py snippet from the `send` method

```
response = requests.get(
    (base_url or self.search_url) + query,
    proxies=self.proxies,
    headers=headers,
    cookies=cookies)

```

This issue was found with the CodeQL query [Full server-side request forgery](https://codeql.github.com/codeql-query-help/python/py-full-ssrf/).

#### Impact

This issue allows for crafting GET requests to internal and external resources on behalf of the server. For example, this issue would allow for accessing resources on the internal network that the server has access to, even though these resources may not be accessible on the internet.

#### Resources

* [SSRF prevention cheatsheet](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html).

### Issue 2: SSRF in the `window` endpoint (`GHSL-2023-187`)

In a similar way as with the `element` endpoint, the [`window`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L496-L557) endpoint does not sanitize user-supplied input from the [`location`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L497) variable and passes it to the [`send`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L479) method which sends a GET request on lines [339-343](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/request.py#L339-L343) in request.py, which leads to a server-side request forgery.

routes.py snippet from the `window` method

```
def window():
    target_url = request.args.get('location')

    #code cut out for readability

    get_body = g.user_request.send(base_url=target_url).text

```

request.py—snippet from the `send` method

```
response = requests.get(
    (base_url or self.search_url) + query,
    proxies=self.proxies,
    headers=headers,
    cookies=cookies)

```

This issue was found with the CodeQL query [Full server-side request forgery](https://codeql.github.com/codeql-query-help/python/py-full-ssrf/).

#### Impact

This issue allows for crafting GET requests to internal and external resources on behalf of the server. For example, this issue would allow for accessing resources on the internal network that the server has access to, even though these resources may not be accessible on the internet.

#### Resources

* [SSRF prevention cheatsheet](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html).

### Issue 3: XSS in the `element` endpoint (`GHSL-2023-188`)

This issue is tightly related to the vulnerability in issue 1: SSRF in the `element` endpoint (`GHSL-2023-186`).

The [`element`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L465-L490) method in app/routes.py does not validate the user-controlled [`src_type`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L476) and [`element_url`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L466) variables and passes them to the [`send`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L479) method which sends a GET request on lines [339-343](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/request.py#L339-L343) in requests.py.

The returned contents of the URL are then passed to and reflected back to the user in the [`send_file`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L484C6-L484C7) function on line 484, together with the user-controlled `src_type`, which allows the attacker to control the HTTP response content type leading to a cross-site scripting vulnerability.

routes.py snippet from the `element` method

```
def element():
    element_url = src_url = request.args.get('url')

    #code cut out for readability
    src_type = request.args.get('type')

    try:
        file_data = g.user_request.send(base_url=src_url).content
        tmp_mem = io.BytesIO()
        tmp_mem.write(file_data)
        tmp_mem.seek(0)

        return send_file(tmp_mem, mimetype=src_type)
    except exceptions.RequestException:
        pass

```
#### Impact

An attacker could craft a special URL to point to a malicious website and send the link to a victim. The fact that the link would contain a trusted domain (e.g. from one of public Whoogle instances) could be used to trick the user into clicking the link.The malicious website could, for example, be a copy of a real website, meant to steal a person’s credentials to the website, or trick that person in another way.

### Issue 4: Limited file write in the `config` endpoint (`GHSL-2023-189`)

This issue exists only if the configuration options in Whoogle are enabled.

The [`config` function](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L419-L452) in app/routes.py does not validate the user-controlled [`name`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L447) variable on line 447 and [`config_data`](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L437) variable on line 437. The `name` variable is insecurely concatenated in `os.path.join`, leading to path manipulation. The [POST data from the `config_data` variable](https://github.com/benbusby/whoogle-search/blob/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py#L444) is saved with `pickle.dump` which leads to a limited file write.
However, the data that is saved is earlier transformed into a dictionary and the `url` key value pair is added before the file is saved on the system. All in all, the issue allows us to save and overwrite files on the system that the application has permissions to, with a dictionary containing arbitrary data and the `url` key value, which is a limited file write.

This issue was found with the CodeQL query [Uncontrolled data used in path expression](https://codeql.github.com/codeql-query-help/python/py-path-injection/).

#### Impact

This issue may lead to limited file write.

## CVE

* GHSL-2023-186 has CVE-2024-22203
* GHSL-2023-187 has CVE-2024-22205
* GHSL-2023-188 has CVE-2024-22417
* GHSL-2023-189 has CVE-2024-22204

## Credit

These issues were discovered and reported by GHSL team member [@sylwia-budzynska (Sylwia Budzynska)](https://github.com/sylwia-budzynska).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2023-186`, `GHSL-2023-187`, `GHSL-2023-188`, or `GHSL-2023-189` in any communication regarding these issues.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information



=== Content from github.com_a728f99a_20250114_185958.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fcommit%2F3a2e0b262e4a076a20416b45e6b6f23fd265aeda)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fcommit%2F3a2e0b262e4a076a20416b45e6b6f23fd265aeda)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=benbusby%2Fwhoogle-search)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[benbusby](/benbusby)
/
**[whoogle-search](/benbusby/whoogle-search)**
Public

* [Notifications](/login?return_to=%2Fbenbusby%2Fwhoogle-search) You must be signed in to change notification settings
* [Fork
  960](/login?return_to=%2Fbenbusby%2Fwhoogle-search)
* [Star
   9.8k](/login?return_to=%2Fbenbusby%2Fwhoogle-search)

* [Code](/benbusby/whoogle-search)
* [Issues
  68](/benbusby/whoogle-search/issues)
* [Pull requests
  9](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects
  0](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

Additional navigation options

* [Code](/benbusby/whoogle-search)
* [Issues](/benbusby/whoogle-search/issues)
* [Pull requests](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

## Commit

[Permalink](/benbusby/whoogle-search/commit/3a2e0b262e4a076a20416b45e6b6f23fd265aeda)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Validate urls in `element` and `window` endpoints

[Browse files](/benbusby/whoogle-search/tree/3a2e0b262e4a076a20416b45e6b6f23fd265aeda)
Browse the repository at this point in the history

```
Domains were previously not validated before being handled, leading to a
potential scenario where someone could pass something like
"element_url=127.0.0.1:<port>/<resource>" to access other resources on a
machine running Whoogle. This change ensures that the resource used in
both endpoints is a valid domain.

This also includes validation of config names to prevent names from
including path values such as "../../(etc)".
```

* Loading branch information

[![@benbusby](https://avatars.githubusercontent.com/u/33362396?s=40&v=4)](/benbusby)

[benbusby](/benbusby/whoogle-search/commits?author=benbusby "View all commits by benbusby")
committed
Sep 13, 2023

1 parent
[8830615](/benbusby/whoogle-search/commit/8830615abcf17e0cd3991fbf963debfb161784cd)

commit 3a2e0b2

Showing
**1 changed file**
with
**26 additions**
and
**7 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

33 changes: 26 additions & 7 deletions

33
[app/routes.py](#diff-f67826701212aab477be0634a23fdcd7ffdfe748b8ce35eb27b8f690d334c732 "app/routes.py")

Show comments

[View file](/benbusby/whoogle-search/blob/3a2e0b262e4a076a20416b45e6b6f23fd265aeda/app/routes.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,8 +4,10 @@ |
|  |  | import json |
|  |  | import os |
|  |  | import pickle |
|  |  | import re |
|  |  | import urllib.parse as urlparse |
|  |  | import uuid |
|  |  | import validators |
|  |  | from datetime import datetime, timedelta |
|  |  | from functools import wraps |
|  |  |  |
| Expand Down  Expand Up | | @@ -420,13 +422,18 @@ def config(): |
|  |  | config\_disabled = ( |
|  |  | app.config['CONFIG\_DISABLE'] or |
|  |  | not valid\_user\_session(session)) |
|  |  |  |
|  |  | name = '' |
|  |  | if 'name' in request.args: |
|  |  | name = os.path.normpath(request.args.get('name')) |
|  |  | if not re.match(r'^[A-Za-z0-9\_.+-]+$', name): |
|  |  | return make\_response('Invalid config name', 400) |
|  |  |  |
|  |  | if request.method == 'GET': |
|  |  | return json.dumps(g.user\_config.\_\_dict\_\_) |
|  |  | elif request.method == 'PUT' and not config\_disabled: |
|  |  | if 'name' in request.args: |
|  |  | config\_pkl = os.path.join( |
|  |  | app.config['CONFIG\_PATH'], |
|  |  | request.args.get('name')) |
|  |  | if name: |
|  |  | config\_pkl = os.path.join(app.config['CONFIG\_PATH'], name) |
|  |  | session['config'] = (pickle.load(open(config\_pkl, 'rb')) |
|  |  | if os.path.exists(config\_pkl) |
|  |  | else session['config']) |
| Expand All | | @@ -444,7 +451,7 @@ def config(): |
|  |  | config\_data, |
|  |  | open(os.path.join( |
|  |  | app.config['CONFIG\_PATH'], |
|  |  | request.args.get('name')), 'wb')) |
|  |  | name), 'wb')) |
|  |  |  |
|  |  | session['config'] = config\_data |
|  |  | return redirect(config\_data['url']) |
| Expand All | | @@ -463,6 +470,8 @@ def imgres(): |
|  |  | @session\_required |
|  |  | @auth\_required |
|  |  | def element(): |
|  |  | empty\_gif = base64.b64decode( |
|  |  | 'R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==') |
|  |  | element\_url = src\_url = request.args.get('url') |
|  |  | if element\_url.startswith('gAAAAA'): |
|  |  | try: |
| Expand All | | @@ -475,6 +484,11 @@ def element(): |
|  |  |  |
|  |  | src\_type = request.args.get('type') |
|  |  |  |
|  |  | # Ensure requested element is from a valid domain |
|  |  | domain = urlparse.urlparse(src\_url).netloc |
|  |  | if not validators.domain(domain): |
|  |  | return send\_file(io.BytesIO(empty\_gif), mimetype='image/gif') |
|  |  |  |
|  |  | try: |
|  |  | file\_data = g.user\_request.send(base\_url=src\_url).content |
|  |  | tmp\_mem = io.BytesIO() |
| Expand All | | @@ -485,8 +499,6 @@ def element(): |
|  |  | except exceptions.RequestException: |
|  |  | pass |
|  |  |  |
|  |  | empty\_gif = base64.b64decode( |
|  |  | 'R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==') |
|  |  | return send\_file(io.BytesIO(empty\_gif), mimetype='image/gif') |
|  |  |  |
|  |  |  |
| Expand All | | @@ -504,6 +516,13 @@ def window(): |
|  |  | root\_url=request.url\_root, |
|  |  | config=g.user\_config) |
|  |  | target = urlparse.urlparse(target\_url) |
|  |  |  |
|  |  | # Ensure requested URL has a valid domain |
|  |  | if not validators.domain(target.netloc): |
|  |  | return render\_template( |
|  |  | 'error.html', |
|  |  | error\_message='Invalid location'), 400 |
|  |  |  |
|  |  | host\_url = f'{target.scheme}://{target.netloc}' |
|  |  |  |
|  |  | get\_body = g.user\_request.send(base\_url=target\_url).text |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3a2e0b2`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fcommit%2F3a2e0b262e4a076a20416b45e6b6f23fd265aeda) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_7bac3f8e_20250114_185953.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fblob%2F92e8ede24e9277a5440d403f75877209f1269884%2Fapp%2Froutes.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fblob%2F92e8ede24e9277a5440d403f75877209f1269884%2Fapp%2Froutes.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=benbusby%2Fwhoogle-search)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[benbusby](/benbusby)
/
**[whoogle-search](/benbusby/whoogle-search)**
Public

* [Notifications](/login?return_to=%2Fbenbusby%2Fwhoogle-search) You must be signed in to change notification settings
* [Fork
  960](/login?return_to=%2Fbenbusby%2Fwhoogle-search)
* [Star
   9.8k](/login?return_to=%2Fbenbusby%2Fwhoogle-search)

* [Code](/benbusby/whoogle-search)
* [Issues
  68](/benbusby/whoogle-search/issues)
* [Pull requests
  9](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects
  0](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

Additional navigation options

* [Code](/benbusby/whoogle-search)
* [Issues](/benbusby/whoogle-search/issues)
* [Pull requests](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

## Files

 92e8ede
## Breadcrumbs

1. [whoogle-search](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884)
2. /[app](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884/app)
/
# routes.py

Copy path Blame  Blame
## Latest commit

## History

[History](/benbusby/whoogle-search/commits/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py)648 lines (543 loc) · 22.2 KB 92e8ede
## Breadcrumbs

1. [whoogle-search](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884)
2. /[app](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884/app)
/
# routes.py

Top
## File metadata and controls

* Code
* Blame

648 lines (543 loc) · 22.2 KB[Raw](https://github.com/benbusby/whoogle-search/raw/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648import argparseimport base64import ioimport jsonimport osimport pickleimport urllib.parse as urlparseimport uuidfrom datetime import datetime, timedeltafrom functools import wraps
import waitressfrom app import appfrom app.models.config import Configfrom app.models.endpoint import Endpointfrom app.request import Request, TorErrorfrom app.utils.bangs import resolve\_bangfrom app.utils.misc import get\_proxy\_host\_urlfrom app.filter import Filterfrom app.utils.misc import read\_config\_bool, get\_client\_ip, get\_request\_url, \ check\_for\_updatefrom app.utils.widgets import \*from app.utils.results import bold\_search\_terms,\ add\_currency\_card, check\_currency, get\_tabs\_contentfrom app.utils.search import Search, needs\_https, has\_captchafrom app.utils.session import valid\_user\_sessionfrom bs4 import BeautifulSoup as bsoupfrom flask import jsonify, make\_response, request, redirect, render\_template, \ send\_file, session, url\_for, gfrom requests import exceptionsfrom requests.models import PreparedRequestfrom cryptography.fernet import Fernet, InvalidTokenfrom cryptography.exceptions import InvalidSignature
# Load DDG bang json files only on initbang\_json = json.load(open(app.config['BANG\_FILE'])) or {}
ac\_var = 'WHOOGLE\_AUTOCOMPLETE'autocomplete\_enabled = os.getenv(ac\_var, '1')
def get\_search\_name(tbm): for tab in app.config['HEADER\_TABS'].values(): if tab['tbm'] == tbm: return tab['name']
def auth\_required(f): @wraps(f) def decorated(\*args, \*\*kwargs): # do not ask password if cookies already present if ( valid\_user\_session(session) and 'cookies\_disabled' not in request.args and session['auth'] ): return f(\*args, \*\*kwargs)
 auth = request.authorization
 # Skip if username/password not set whoogle\_user = os.getenv('WHOOGLE\_USER', '') whoogle\_pass = os.getenv('WHOOGLE\_PASS', '') if (not whoogle\_user or not whoogle\_pass) or ( auth and whoogle\_user == auth.username and whoogle\_pass == auth.password): session['auth'] = True return f(\*args, \*\*kwargs) else: return make\_response('Not logged in', 401, { 'WWW-Authenticate': 'Basic realm="Login Required"'})
 return decorated
def session\_required(f): @wraps(f) def decorated(\*args, \*\*kwargs): if not valid\_user\_session(session): session.pop('\_permanent', None)
 # Note: This sets all requests to use the encryption key determined per # instance on app init. This can be updated in the future to use a key # that is unique for their session (session['key']) but this should use # a config setting to enable the session based key. Otherwise there can # be problems with searches performed by users with cookies blocked if # a session based key is always used. g.session\_key = app.enc\_key
 # Clear out old sessions invalid\_sessions = [] for user\_session in os.listdir(app.config['SESSION\_FILE\_DIR']): file\_path = os.path.join( app.config['SESSION\_FILE\_DIR'], user\_session)
 try: # Ignore files that are larger than the max session file size if os.path.getsize(file\_path) > app.config['MAX\_SESSION\_SIZE']: continue
 with open(file\_path, 'rb') as session\_file: \_ = pickle.load(session\_file) data = pickle.load(session\_file) if isinstance(data, dict) and 'valid' in data: continue invalid\_sessions.append(file\_path) except Exception: # Broad exception handling here due to how instances installed # with pip seem to have issues storing unrelated files in the # same directory as sessions pass
 for invalid\_session in invalid\_sessions: try: os.remove(invalid\_session) except FileNotFoundError: # Don't throw error if the invalid session has been removed pass
 return f(\*args, \*\*kwargs)
 return decorated
@app.before\_requestdef before\_request\_func(): global bang\_json session.permanent = True
 # Check for latest version if needed now = datetime.now() if now - timedelta(hours=24) > app.config['LAST\_UPDATE\_CHECK']: app.config['LAST\_UPDATE\_CHECK'] = now app.config['HAS\_UPDATE'] = check\_for\_update( app.config['RELEASES\_URL'], app.config['VERSION\_NUMBER'])
 g.request\_params = ( request.args if request.method == 'GET' else request.form )
 default\_config = json.load(open(app.config['DEFAULT\_CONFIG'])) \ if os.path.exists(app.config['DEFAULT\_CONFIG']) else {}
 # Generate session values for user if unavailable if not valid\_user\_session(session): session['config'] = default\_config session['uuid'] = str(uuid.uuid4()) session['key'] = app.enc\_key session['auth'] = False
 # Establish config values per user session g.user\_config = Config(\*\*session['config'])
 # Update user config if specified in search args g.user\_config = g.user\_config.from\_params(g.request\_params)
 if not g.user\_config.url: g.user\_config.url = get\_request\_url(request.url\_root)
 g.user\_request = Request( request.headers.get('User-Agent'), get\_request\_url(request.url\_root), config=g.user\_config)
 g.app\_location = g.user\_config.url
 # Attempt to reload bangs json if not generated yet if not bang\_json and os.path.getsize(app.config['BANG\_FILE']) > 4: try: bang\_json = json.load(open(app.config['BANG\_FILE'])) except json.decoder.JSONDecodeError: # Ignore decoding error, can occur if file is still # being written pass
@app.after\_requestdef after\_request\_func(resp): resp.headers['X-Content-Type-Options'] = 'nosniff' resp.headers['X-Frame-Options'] = 'DENY'
 if os.getenv('WHOOGLE\_CSP', False): resp.headers['Content-Security-Policy'] = app.config['CSP'] if os.environ.get('HTTPS\_ONLY', False): resp.headers['Content-Security-Policy'] += \ 'upgrade-insecure-requests'
 return resp
@app.errorhandler(404)def unknown\_page(e): app.logger.warn(e) return redirect(g.app\_location)
@app.route(f'/{Endpoint.healthz}', methods=['GET'])def healthz(): return ''
@app.route('/', methods=['GET'])@app.route(f'/{Endpoint.home}', methods=['GET'])@auth\_requireddef index(): # Redirect if an error was raised if 'error\_message' in session and session['error\_message']: error\_message = session['error\_message'] session['error\_message'] = '' return render\_template('error.html', error\_message=error\_message)
 return render\_template('index.html', has\_update=app.config['HAS\_UPDATE'], languages=app.config['LANGUAGES'], countries=app.config['COUNTRIES'], time\_periods=app.config['TIME\_PERIODS'], themes=app.config['THEMES'], autocomplete\_enabled=autocomplete\_enabled, translation=app.config['TRANSLATIONS'][ g.user\_config.get\_localization\_lang() ], logo=render\_template( 'logo.html', dark=g.user\_config.dark), config\_disabled=( app.config['CONFIG\_DISABLE'] or not valid\_user\_session(session)), config=g.user\_config, tor\_available=int(os.environ.get('TOR\_AVAILABLE')), version\_number=app.config['VERSION\_NUMBER'])
@app.route(f'/{Endpoint.opensearch}', methods=['GET'])def opensearch(): opensearch\_url = g.app\_location if opensearch\_url.endswith('/'): opensearch\_url = opensearch\_url[:-1]
 # Enforce https for opensearch template if needs\_https(opensearch\_url): opensearch\_url = opensearch\_url.replace('http://', 'https://', 1)
 get\_only = g.user\_config.get\_only or 'Chrome' in request.headers.get( 'User-Agent')
 return render\_template( 'opensearch.xml', main\_url=opensearch\_url, request\_type='' if get\_only else 'method="post"', search\_type=request.args.get('tbm'), search\_name=get\_search\_name(request.args.get('tbm')) ), 200, {'Content-Type': 'application/xml'}
@app.route(f'/{Endpoint.search\_html}', methods=['GET'])def search\_html(): search\_url = g.app\_location if search\_url.endswith('/'): search\_url = search\_url[:-1] return render\_template('search.html', url=search\_url)
@app.route(f'/{Endpoint.autocomplete}', methods=['GET', 'POST'])def autocomplete(): if os.getenv(ac\_var) and not read\_config\_bool(ac\_var): return jsonify({})
 q = g.request\_params.get('q') if not q: # FF will occasionally (incorrectly) send the q field without a # mimetype in the format "b'q=<query>'" through the request.data field q = str(request.data).replace('q=', '')
 # Search bangs if the query begins with "!", but not "! " (feeling lucky) if q.startswith('!') and len(q) > 1 and not q.startswith('! '): return jsonify([q, [bang\_json[\_]['suggestion'] for \_ in bang\_json if \_.startswith(q)]])
 if not q and not request.data: return jsonify({'?': []}) elif request.data: q = urlparse.unquote\_plus( request.data.decode('utf-8').replace('q=', ''))
 # Return a list of suggestions for the query # # Note: If Tor is enabled, this returns nothing, as the request is # almost always rejected return jsonify([ q, g.user\_request.autocomplete(q) if not g.user\_config.tor else [] ])
@app.route(f'/{Endpoint.search}', methods=['GET', 'POST'])@session\_required@auth\_requireddef search(): search\_util = Search(request, g.user\_config, g.session\_key) query = search\_util.new\_search\_query()
 bang = resolve\_bang(query, bang\_json) if bang: return redirect(bang)
 # Redirect to home if invalid/blank search if not query: return redirect(url\_for('.index'))
 # Generate response and number of external elements from the page try: response = search\_util.generate\_response() except TorError as e: session['error\_message'] = e.message + ( "\\n\\nTor config is now disabled!" if e.disable else "") session['config']['tor'] = False if e.disable else session['config'][ 'tor'] return redirect(url\_for('.index'))
 if search\_util.feeling\_lucky: return redirect(response, code=303)
 # If the user is attempting to translate a string, determine the correct # string for formatting the lingva.ml url localization\_lang = g.user\_config.get\_localization\_lang() translation = app.config['TRANSLATIONS'][localization\_lang] translate\_to = localization\_lang.replace('lang\_', '')
 # removing st-card to only use whoogle time selector soup = bsoup(response, "html.parser"); for x in soup.find\_all(attrs={"id": "st-card"}): x.replace\_with("")
 response = str(soup)
 # Return 503 if temporarily blocked by captcha if has\_captcha(str(response)): app.logger.error('503 (CAPTCHA)') return render\_template( 'error.html', blocked=True, error\_message=translation['ratelimit'], translation=translation, farside='https://farside.link', config=g.user\_config, query=urlparse.unquote(query), params=g.user\_config.to\_params(keys=['preferences'])), 503
 response = bold\_search\_terms(response, query)
 # check for widgets and add if requested if search\_util.widget != '': html\_soup = bsoup(str(response), 'html.parser') if search\_util.widget == 'ip': response = add\_ip\_card(html\_soup, get\_client\_ip(request)) elif search\_util.widget == 'calculator' and not 'nojs' in request.args: response = add\_calculator\_card(html\_soup)
 # Update tabs content tabs = get\_tabs\_content(app.config['HEADER\_TABS'], search\_util.full\_query, search\_util.search\_type, g.user\_config.preferences, translation)
 # Feature to display currency\_card # Since this is determined by more than just the # query is it not defined as a standard widget conversion = check\_currency(str(response)) if conversion: html\_soup = bsoup(str(response), 'html.parser') response = add\_currency\_card(html\_soup, conversion)
 preferences = g.user\_config.preferences home\_url = f"home?preferences={preferences}" if preferences else "home" cleanresponse = str(response).replace("andlt;","&lt;").replace("andgt;","&gt;")
 return render\_template( 'display.html', has\_update=app.config['HAS\_UPDATE'], query=urlparse.unquote(query), search\_type=search\_util.search\_type, search\_name=get\_search\_name(search\_util.search\_type), config=g.user\_config, autocomplete\_enabled=autocomplete\_enabled, lingva\_url=app.config['TRANSLATE\_URL'], translation=translation, translate\_to=translate\_to, translate\_str=query.replace( 'translate', '' ).replace( translation['translate'], '' ), is\_translation=any( \_ in query.lower() for \_ in [translation['translate'], 'translate'] ) and not search\_util.search\_type, # Standard search queries only response=cleanresponse, version\_number=app.config['VERSION\_NUMBER'], search\_header=render\_template( 'header.html', home\_url=home\_url, config=g.user\_config, translation=translation, languages=app.config['LANGUAGES'], countries=app.config['COUNTRIES'], time\_periods=app.config['TIME\_PERIODS'], logo=render\_template('logo.html', dark=g.user\_config.dark), query=urlparse.unquote(query), search\_type=search\_util.search\_type, mobile=g.user\_request.mobile, tabs=tabs)).replace(" ", "")
@app.route(f'/{Endpoint.config}', methods=['GET', 'POST', 'PUT'])@session\_required@auth\_requireddef config(): config\_disabled = ( app.config['CONFIG\_DISABLE'] or not valid\_user\_session(session)) if request.method == 'GET': return json.dumps(g.user\_config.\_\_dict\_\_) elif request.method == 'PUT' and not config\_disabled: if 'name' in request.args: config\_pkl = os.path.join( app.config['CONFIG\_PATH'], request.args.get('name')) session['config'] = (pickle.load(open(config\_pkl, 'rb')) if os.path.exists(config\_pkl) else session['config']) return json.dumps(session['config']) else: return json.dumps({}) elif not config\_disabled: config\_data = request.form.to\_dict() if 'url' not in config\_data or not config\_data['url']: config\_data['url'] = g.user\_config.url
 # Save config by name to allow a user to easily load later if 'name' in request.args: pickle.dump( config\_data, open(os.path.join( app.config['CONFIG\_PATH'], request.args.get('name')), 'wb'))
 session['config'] = config\_data return redirect(config\_data['url']) else: return redirect(url\_for('.index'), code=403)
@app.route(f'/{Endpoint.imgres}')@session\_required@auth\_requireddef imgres(): return redirect(request.args.get('imgurl'))
@app.route(f'/{Endpoint.element}')@session\_required@auth\_requireddef element(): element\_url = src\_url = request.args.get('url') if element\_url.startswith('gAAAAA'): try: cipher\_suite = Fernet(g.session\_key) src\_url = cipher\_suite.decrypt(element\_url.encode()).decode() except (InvalidSignature, InvalidToken) as e: return render\_template( 'error.html', error\_message=str(e)), 401
 src\_type = request.args.get('type')
 try: file\_data = g.user\_request.send(base\_url=src\_url).content tmp\_mem = io.BytesIO() tmp\_mem.write(file\_data) tmp\_mem.seek(0)
 return send\_file(tmp\_mem, mimetype=src\_type) except exceptions.RequestException: pass
 empty\_gif = base64.b64decode( 'R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==') return send\_file(io.BytesIO(empty\_gif), mimetype='image/gif')
@app.route(f'/{Endpoint.window}')@session\_required@auth\_requireddef window(): target\_url = request.args.get('location') if target\_url.startswith('gAAAAA'): cipher\_suite = Fernet(g.session\_key) target\_url = cipher\_suite.decrypt(target\_url.encode()).decode()
 content\_filter = Filter( g.session\_key, root\_url=request.url\_root, config=g.user\_config) target = urlparse.urlparse(target\_url) host\_url = f'{target.scheme}://{target.netloc}'
 get\_body = g.user\_request.send(base\_url=target\_url).text
 results = bsoup(get\_body, 'html.parser') src\_attrs = ['src', 'href', 'srcset', 'data-srcset', 'data-src']
 # Parse HTML response and replace relative links w/ absolute for element in results.find\_all(): for attr in src\_attrs: if not element.has\_attr(attr) or not element[attr].startswith('/'): continue
 element[attr] = host\_url + element[attr]
 # Replace or remove javascript sources for script in results.find\_all('script', {'src': True}): if 'nojs' in request.args: script.decompose() else: content\_filter.update\_element\_src(script, 'application/javascript')
 # Replace all possible image attributes img\_sources = ['src', 'data-src', 'data-srcset', 'srcset'] for img in results.find\_all('img'): \_ = [ content\_filter.update\_element\_src(img, 'image/png', attr=\_) for \_ in img\_sources if img.has\_attr(\_) ]
 # Replace all stylesheet sources for link in results.find\_all('link', {'href': True}): content\_filter.update\_element\_src(link, 'text/css', attr='href')
 # Use anonymous view for all links on page for a in results.find\_all('a', {'href': True}): a['href'] = f'{Endpoint.window}?location=' + a['href'] + ( '&nojs=1' if 'nojs' in request.args else '')
 # Remove all iframes -- these are commonly used inside of <noscript> tags # to enforce loading Google Analytics for iframe in results.find\_all('iframe'): iframe.decompose()
 return render\_template( 'display.html', response=results, translation=app.config['TRANSLATIONS'][ g.user\_config.get\_localization\_lang() ] )
@app.route(f'/robots.txt')def robots(): response = make\_response('''User-Agent: \*Disallow: /''', 200) response.mimetype = 'text/plain' return response
@app.errorhandler(404)def page\_not\_found(e): return render\_template('error.html', error\_message=str(e)), 404
def run\_app() -> None: parser = argparse.ArgumentParser( description='Whoogle Search console runner') parser.add\_argument( '--port', default=5000, metavar='<port number>', help='Specifies a port to run on (default 5000)') parser.add\_argument( '--host', default='127.0.0.1', metavar='<ip address>', help='Specifies the host address to use (default 127.0.0.1)') parser.add\_argument( '--unix-socket', default='', metavar='</path/to/unix.sock>', help='Listen for app on unix socket instead of host:port') parser.add\_argument( '--debug', default=False, action='store\_true', help='Activates debug mode for the server (default False)') parser.add\_argument( '--https-only', default=False, action='store\_true', help='Enforces HTTPS redirects for all requests') parser.add\_argument( '--userpass', default='', metavar='<username:password>', help='Sets a username/password basic auth combo (default None)') parser.add\_argument( '--proxyauth', default='', metavar='<username:password>', help='Sets a username/password for a HTTP/SOCKS proxy (default None)') parser.add\_argument( '--proxytype', default='', metavar='<socks4|socks5|http>', help='Sets a proxy type for all connections (default None)') parser.add\_argument( '--proxyloc', default='', metavar='<location:port>', help='Sets a proxy location for all connections (default None)') args = parser.parse\_args()
 if args.userpass: user\_pass = args.userpass.split(':') os.environ['WHOOGLE\_USER'] = user\_pass[0] os.environ['WHOOGLE\_PASS'] = user\_pass[1]
 if args.proxytype and args.proxyloc: if args.proxyauth: proxy\_user\_pass = args.proxyauth.split(':') os.environ['WHOOGLE\_PROXY\_USER'] = proxy\_user\_pass[0] os.environ['WHOOGLE\_PROXY\_PASS'] = proxy\_user\_pass[1] os.environ['WHOOGLE\_PROXY\_TYPE'] = args.proxytype os.environ['WHOOGLE\_PROXY\_LOC'] = args.proxyloc
 if args.https\_only: os.environ['HTTPS\_ONLY'] = '1'
 if args.debug: app.run(host=args.host, port=args.port, debug=args.debug) elif args.unix\_socket: waitress.serve(app, unix\_socket=args.unix\_socket) else: waitress.serve( app, listen="{}:{}".format(args.host, args.port), url\_prefix=os.environ.get('WHOOGLE\_URL\_PREFIX', ''))

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_08e25747_20250114_185949.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fblob%2F92e8ede24e9277a5440d403f75877209f1269884%2Fapp%2Froutes.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fblob%2F92e8ede24e9277a5440d403f75877209f1269884%2Fapp%2Froutes.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=benbusby%2Fwhoogle-search)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[benbusby](/benbusby)
/
**[whoogle-search](/benbusby/whoogle-search)**
Public

* [Notifications](/login?return_to=%2Fbenbusby%2Fwhoogle-search) You must be signed in to change notification settings
* [Fork
  960](/login?return_to=%2Fbenbusby%2Fwhoogle-search)
* [Star
   9.8k](/login?return_to=%2Fbenbusby%2Fwhoogle-search)

* [Code](/benbusby/whoogle-search)
* [Issues
  68](/benbusby/whoogle-search/issues)
* [Pull requests
  9](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects
  0](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

Additional navigation options

* [Code](/benbusby/whoogle-search)
* [Issues](/benbusby/whoogle-search/issues)
* [Pull requests](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

## Files

 92e8ede
## Breadcrumbs

1. [whoogle-search](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884)
2. /[app](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884/app)
/
# routes.py

Copy path Blame  Blame
## Latest commit

## History

[History](/benbusby/whoogle-search/commits/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py)648 lines (543 loc) · 22.2 KB 92e8ede
## Breadcrumbs

1. [whoogle-search](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884)
2. /[app](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884/app)
/
# routes.py

Top
## File metadata and controls

* Code
* Blame

648 lines (543 loc) · 22.2 KB[Raw](https://github.com/benbusby/whoogle-search/raw/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648import argparseimport base64import ioimport jsonimport osimport pickleimport urllib.parse as urlparseimport uuidfrom datetime import datetime, timedeltafrom functools import wraps
import waitressfrom app import appfrom app.models.config import Configfrom app.models.endpoint import Endpointfrom app.request import Request, TorErrorfrom app.utils.bangs import resolve\_bangfrom app.utils.misc import get\_proxy\_host\_urlfrom app.filter import Filterfrom app.utils.misc import read\_config\_bool, get\_client\_ip, get\_request\_url, \ check\_for\_updatefrom app.utils.widgets import \*from app.utils.results import bold\_search\_terms,\ add\_currency\_card, check\_currency, get\_tabs\_contentfrom app.utils.search import Search, needs\_https, has\_captchafrom app.utils.session import valid\_user\_sessionfrom bs4 import BeautifulSoup as bsoupfrom flask import jsonify, make\_response, request, redirect, render\_template, \ send\_file, session, url\_for, gfrom requests import exceptionsfrom requests.models import PreparedRequestfrom cryptography.fernet import Fernet, InvalidTokenfrom cryptography.exceptions import InvalidSignature
# Load DDG bang json files only on initbang\_json = json.load(open(app.config['BANG\_FILE'])) or {}
ac\_var = 'WHOOGLE\_AUTOCOMPLETE'autocomplete\_enabled = os.getenv(ac\_var, '1')
def get\_search\_name(tbm): for tab in app.config['HEADER\_TABS'].values(): if tab['tbm'] == tbm: return tab['name']
def auth\_required(f): @wraps(f) def decorated(\*args, \*\*kwargs): # do not ask password if cookies already present if ( valid\_user\_session(session) and 'cookies\_disabled' not in request.args and session['auth'] ): return f(\*args, \*\*kwargs)
 auth = request.authorization
 # Skip if username/password not set whoogle\_user = os.getenv('WHOOGLE\_USER', '') whoogle\_pass = os.getenv('WHOOGLE\_PASS', '') if (not whoogle\_user or not whoogle\_pass) or ( auth and whoogle\_user == auth.username and whoogle\_pass == auth.password): session['auth'] = True return f(\*args, \*\*kwargs) else: return make\_response('Not logged in', 401, { 'WWW-Authenticate': 'Basic realm="Login Required"'})
 return decorated
def session\_required(f): @wraps(f) def decorated(\*args, \*\*kwargs): if not valid\_user\_session(session): session.pop('\_permanent', None)
 # Note: This sets all requests to use the encryption key determined per # instance on app init. This can be updated in the future to use a key # that is unique for their session (session['key']) but this should use # a config setting to enable the session based key. Otherwise there can # be problems with searches performed by users with cookies blocked if # a session based key is always used. g.session\_key = app.enc\_key
 # Clear out old sessions invalid\_sessions = [] for user\_session in os.listdir(app.config['SESSION\_FILE\_DIR']): file\_path = os.path.join( app.config['SESSION\_FILE\_DIR'], user\_session)
 try: # Ignore files that are larger than the max session file size if os.path.getsize(file\_path) > app.config['MAX\_SESSION\_SIZE']: continue
 with open(file\_path, 'rb') as session\_file: \_ = pickle.load(session\_file) data = pickle.load(session\_file) if isinstance(data, dict) and 'valid' in data: continue invalid\_sessions.append(file\_path) except Exception: # Broad exception handling here due to how instances installed # with pip seem to have issues storing unrelated files in the # same directory as sessions pass
 for invalid\_session in invalid\_sessions: try: os.remove(invalid\_session) except FileNotFoundError: # Don't throw error if the invalid session has been removed pass
 return f(\*args, \*\*kwargs)
 return decorated
@app.before\_requestdef before\_request\_func(): global bang\_json session.permanent = True
 # Check for latest version if needed now = datetime.now() if now - timedelta(hours=24) > app.config['LAST\_UPDATE\_CHECK']: app.config['LAST\_UPDATE\_CHECK'] = now app.config['HAS\_UPDATE'] = check\_for\_update( app.config['RELEASES\_URL'], app.config['VERSION\_NUMBER'])
 g.request\_params = ( request.args if request.method == 'GET' else request.form )
 default\_config = json.load(open(app.config['DEFAULT\_CONFIG'])) \ if os.path.exists(app.config['DEFAULT\_CONFIG']) else {}
 # Generate session values for user if unavailable if not valid\_user\_session(session): session['config'] = default\_config session['uuid'] = str(uuid.uuid4()) session['key'] = app.enc\_key session['auth'] = False
 # Establish config values per user session g.user\_config = Config(\*\*session['config'])
 # Update user config if specified in search args g.user\_config = g.user\_config.from\_params(g.request\_params)
 if not g.user\_config.url: g.user\_config.url = get\_request\_url(request.url\_root)
 g.user\_request = Request( request.headers.get('User-Agent'), get\_request\_url(request.url\_root), config=g.user\_config)
 g.app\_location = g.user\_config.url
 # Attempt to reload bangs json if not generated yet if not bang\_json and os.path.getsize(app.config['BANG\_FILE']) > 4: try: bang\_json = json.load(open(app.config['BANG\_FILE'])) except json.decoder.JSONDecodeError: # Ignore decoding error, can occur if file is still # being written pass
@app.after\_requestdef after\_request\_func(resp): resp.headers['X-Content-Type-Options'] = 'nosniff' resp.headers['X-Frame-Options'] = 'DENY'
 if os.getenv('WHOOGLE\_CSP', False): resp.headers['Content-Security-Policy'] = app.config['CSP'] if os.environ.get('HTTPS\_ONLY', False): resp.headers['Content-Security-Policy'] += \ 'upgrade-insecure-requests'
 return resp
@app.errorhandler(404)def unknown\_page(e): app.logger.warn(e) return redirect(g.app\_location)
@app.route(f'/{Endpoint.healthz}', methods=['GET'])def healthz(): return ''
@app.route('/', methods=['GET'])@app.route(f'/{Endpoint.home}', methods=['GET'])@auth\_requireddef index(): # Redirect if an error was raised if 'error\_message' in session and session['error\_message']: error\_message = session['error\_message'] session['error\_message'] = '' return render\_template('error.html', error\_message=error\_message)
 return render\_template('index.html', has\_update=app.config['HAS\_UPDATE'], languages=app.config['LANGUAGES'], countries=app.config['COUNTRIES'], time\_periods=app.config['TIME\_PERIODS'], themes=app.config['THEMES'], autocomplete\_enabled=autocomplete\_enabled, translation=app.config['TRANSLATIONS'][ g.user\_config.get\_localization\_lang() ], logo=render\_template( 'logo.html', dark=g.user\_config.dark), config\_disabled=( app.config['CONFIG\_DISABLE'] or not valid\_user\_session(session)), config=g.user\_config, tor\_available=int(os.environ.get('TOR\_AVAILABLE')), version\_number=app.config['VERSION\_NUMBER'])
@app.route(f'/{Endpoint.opensearch}', methods=['GET'])def opensearch(): opensearch\_url = g.app\_location if opensearch\_url.endswith('/'): opensearch\_url = opensearch\_url[:-1]
 # Enforce https for opensearch template if needs\_https(opensearch\_url): opensearch\_url = opensearch\_url.replace('http://', 'https://', 1)
 get\_only = g.user\_config.get\_only or 'Chrome' in request.headers.get( 'User-Agent')
 return render\_template( 'opensearch.xml', main\_url=opensearch\_url, request\_type='' if get\_only else 'method="post"', search\_type=request.args.get('tbm'), search\_name=get\_search\_name(request.args.get('tbm')) ), 200, {'Content-Type': 'application/xml'}
@app.route(f'/{Endpoint.search\_html}', methods=['GET'])def search\_html(): search\_url = g.app\_location if search\_url.endswith('/'): search\_url = search\_url[:-1] return render\_template('search.html', url=search\_url)
@app.route(f'/{Endpoint.autocomplete}', methods=['GET', 'POST'])def autocomplete(): if os.getenv(ac\_var) and not read\_config\_bool(ac\_var): return jsonify({})
 q = g.request\_params.get('q') if not q: # FF will occasionally (incorrectly) send the q field without a # mimetype in the format "b'q=<query>'" through the request.data field q = str(request.data).replace('q=', '')
 # Search bangs if the query begins with "!", but not "! " (feeling lucky) if q.startswith('!') and len(q) > 1 and not q.startswith('! '): return jsonify([q, [bang\_json[\_]['suggestion'] for \_ in bang\_json if \_.startswith(q)]])
 if not q and not request.data: return jsonify({'?': []}) elif request.data: q = urlparse.unquote\_plus( request.data.decode('utf-8').replace('q=', ''))
 # Return a list of suggestions for the query # # Note: If Tor is enabled, this returns nothing, as the request is # almost always rejected return jsonify([ q, g.user\_request.autocomplete(q) if not g.user\_config.tor else [] ])
@app.route(f'/{Endpoint.search}', methods=['GET', 'POST'])@session\_required@auth\_requireddef search(): search\_util = Search(request, g.user\_config, g.session\_key) query = search\_util.new\_search\_query()
 bang = resolve\_bang(query, bang\_json) if bang: return redirect(bang)
 # Redirect to home if invalid/blank search if not query: return redirect(url\_for('.index'))
 # Generate response and number of external elements from the page try: response = search\_util.generate\_response() except TorError as e: session['error\_message'] = e.message + ( "\\n\\nTor config is now disabled!" if e.disable else "") session['config']['tor'] = False if e.disable else session['config'][ 'tor'] return redirect(url\_for('.index'))
 if search\_util.feeling\_lucky: return redirect(response, code=303)
 # If the user is attempting to translate a string, determine the correct # string for formatting the lingva.ml url localization\_lang = g.user\_config.get\_localization\_lang() translation = app.config['TRANSLATIONS'][localization\_lang] translate\_to = localization\_lang.replace('lang\_', '')
 # removing st-card to only use whoogle time selector soup = bsoup(response, "html.parser"); for x in soup.find\_all(attrs={"id": "st-card"}): x.replace\_with("")
 response = str(soup)
 # Return 503 if temporarily blocked by captcha if has\_captcha(str(response)): app.logger.error('503 (CAPTCHA)') return render\_template( 'error.html', blocked=True, error\_message=translation['ratelimit'], translation=translation, farside='https://farside.link', config=g.user\_config, query=urlparse.unquote(query), params=g.user\_config.to\_params(keys=['preferences'])), 503
 response = bold\_search\_terms(response, query)
 # check for widgets and add if requested if search\_util.widget != '': html\_soup = bsoup(str(response), 'html.parser') if search\_util.widget == 'ip': response = add\_ip\_card(html\_soup, get\_client\_ip(request)) elif search\_util.widget == 'calculator' and not 'nojs' in request.args: response = add\_calculator\_card(html\_soup)
 # Update tabs content tabs = get\_tabs\_content(app.config['HEADER\_TABS'], search\_util.full\_query, search\_util.search\_type, g.user\_config.preferences, translation)
 # Feature to display currency\_card # Since this is determined by more than just the # query is it not defined as a standard widget conversion = check\_currency(str(response)) if conversion: html\_soup = bsoup(str(response), 'html.parser') response = add\_currency\_card(html\_soup, conversion)
 preferences = g.user\_config.preferences home\_url = f"home?preferences={preferences}" if preferences else "home" cleanresponse = str(response).replace("andlt;","&lt;").replace("andgt;","&gt;")
 return render\_template( 'display.html', has\_update=app.config['HAS\_UPDATE'], query=urlparse.unquote(query), search\_type=search\_util.search\_type, search\_name=get\_search\_name(search\_util.search\_type), config=g.user\_config, autocomplete\_enabled=autocomplete\_enabled, lingva\_url=app.config['TRANSLATE\_URL'], translation=translation, translate\_to=translate\_to, translate\_str=query.replace( 'translate', '' ).replace( translation['translate'], '' ), is\_translation=any( \_ in query.lower() for \_ in [translation['translate'], 'translate'] ) and not search\_util.search\_type, # Standard search queries only response=cleanresponse, version\_number=app.config['VERSION\_NUMBER'], search\_header=render\_template( 'header.html', home\_url=home\_url, config=g.user\_config, translation=translation, languages=app.config['LANGUAGES'], countries=app.config['COUNTRIES'], time\_periods=app.config['TIME\_PERIODS'], logo=render\_template('logo.html', dark=g.user\_config.dark), query=urlparse.unquote(query), search\_type=search\_util.search\_type, mobile=g.user\_request.mobile, tabs=tabs)).replace(" ", "")
@app.route(f'/{Endpoint.config}', methods=['GET', 'POST', 'PUT'])@session\_required@auth\_requireddef config(): config\_disabled = ( app.config['CONFIG\_DISABLE'] or not valid\_user\_session(session)) if request.method == 'GET': return json.dumps(g.user\_config.\_\_dict\_\_) elif request.method == 'PUT' and not config\_disabled: if 'name' in request.args: config\_pkl = os.path.join( app.config['CONFIG\_PATH'], request.args.get('name')) session['config'] = (pickle.load(open(config\_pkl, 'rb')) if os.path.exists(config\_pkl) else session['config']) return json.dumps(session['config']) else: return json.dumps({}) elif not config\_disabled: config\_data = request.form.to\_dict() if 'url' not in config\_data or not config\_data['url']: config\_data['url'] = g.user\_config.url
 # Save config by name to allow a user to easily load later if 'name' in request.args: pickle.dump( config\_data, open(os.path.join( app.config['CONFIG\_PATH'], request.args.get('name')), 'wb'))
 session['config'] = config\_data return redirect(config\_data['url']) else: return redirect(url\_for('.index'), code=403)
@app.route(f'/{Endpoint.imgres}')@session\_required@auth\_requireddef imgres(): return redirect(request.args.get('imgurl'))
@app.route(f'/{Endpoint.element}')@session\_required@auth\_requireddef element(): element\_url = src\_url = request.args.get('url') if element\_url.startswith('gAAAAA'): try: cipher\_suite = Fernet(g.session\_key) src\_url = cipher\_suite.decrypt(element\_url.encode()).decode() except (InvalidSignature, InvalidToken) as e: return render\_template( 'error.html', error\_message=str(e)), 401
 src\_type = request.args.get('type')
 try: file\_data = g.user\_request.send(base\_url=src\_url).content tmp\_mem = io.BytesIO() tmp\_mem.write(file\_data) tmp\_mem.seek(0)
 return send\_file(tmp\_mem, mimetype=src\_type) except exceptions.RequestException: pass
 empty\_gif = base64.b64decode( 'R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==') return send\_file(io.BytesIO(empty\_gif), mimetype='image/gif')
@app.route(f'/{Endpoint.window}')@session\_required@auth\_requireddef window(): target\_url = request.args.get('location') if target\_url.startswith('gAAAAA'): cipher\_suite = Fernet(g.session\_key) target\_url = cipher\_suite.decrypt(target\_url.encode()).decode()
 content\_filter = Filter( g.session\_key, root\_url=request.url\_root, config=g.user\_config) target = urlparse.urlparse(target\_url) host\_url = f'{target.scheme}://{target.netloc}'
 get\_body = g.user\_request.send(base\_url=target\_url).text
 results = bsoup(get\_body, 'html.parser') src\_attrs = ['src', 'href', 'srcset', 'data-srcset', 'data-src']
 # Parse HTML response and replace relative links w/ absolute for element in results.find\_all(): for attr in src\_attrs: if not element.has\_attr(attr) or not element[attr].startswith('/'): continue
 element[attr] = host\_url + element[attr]
 # Replace or remove javascript sources for script in results.find\_all('script', {'src': True}): if 'nojs' in request.args: script.decompose() else: content\_filter.update\_element\_src(script, 'application/javascript')
 # Replace all possible image attributes img\_sources = ['src', 'data-src', 'data-srcset', 'srcset'] for img in results.find\_all('img'): \_ = [ content\_filter.update\_element\_src(img, 'image/png', attr=\_) for \_ in img\_sources if img.has\_attr(\_) ]
 # Replace all stylesheet sources for link in results.find\_all('link', {'href': True}): content\_filter.update\_element\_src(link, 'text/css', attr='href')
 # Use anonymous view for all links on page for a in results.find\_all('a', {'href': True}): a['href'] = f'{Endpoint.window}?location=' + a['href'] + ( '&nojs=1' if 'nojs' in request.args else '')
 # Remove all iframes -- these are commonly used inside of <noscript> tags # to enforce loading Google Analytics for iframe in results.find\_all('iframe'): iframe.decompose()
 return render\_template( 'display.html', response=results, translation=app.config['TRANSLATIONS'][ g.user\_config.get\_localization\_lang() ] )
@app.route(f'/robots.txt')def robots(): response = make\_response('''User-Agent: \*Disallow: /''', 200) response.mimetype = 'text/plain' return response
@app.errorhandler(404)def page\_not\_found(e): return render\_template('error.html', error\_message=str(e)), 404
def run\_app() -> None: parser = argparse.ArgumentParser( description='Whoogle Search console runner') parser.add\_argument( '--port', default=5000, metavar='<port number>', help='Specifies a port to run on (default 5000)') parser.add\_argument( '--host', default='127.0.0.1', metavar='<ip address>', help='Specifies the host address to use (default 127.0.0.1)') parser.add\_argument( '--unix-socket', default='', metavar='</path/to/unix.sock>', help='Listen for app on unix socket instead of host:port') parser.add\_argument( '--debug', default=False, action='store\_true', help='Activates debug mode for the server (default False)') parser.add\_argument( '--https-only', default=False, action='store\_true', help='Enforces HTTPS redirects for all requests') parser.add\_argument( '--userpass', default='', metavar='<username:password>', help='Sets a username/password basic auth combo (default None)') parser.add\_argument( '--proxyauth', default='', metavar='<username:password>', help='Sets a username/password for a HTTP/SOCKS proxy (default None)') parser.add\_argument( '--proxytype', default='', metavar='<socks4|socks5|http>', help='Sets a proxy type for all connections (default None)') parser.add\_argument( '--proxyloc', default='', metavar='<location:port>', help='Sets a proxy location for all connections (default None)') args = parser.parse\_args()
 if args.userpass: user\_pass = args.userpass.split(':') os.environ['WHOOGLE\_USER'] = user\_pass[0] os.environ['WHOOGLE\_PASS'] = user\_pass[1]
 if args.proxytype and args.proxyloc: if args.proxyauth: proxy\_user\_pass = args.proxyauth.split(':') os.environ['WHOOGLE\_PROXY\_USER'] = proxy\_user\_pass[0] os.environ['WHOOGLE\_PROXY\_PASS'] = proxy\_user\_pass[1] os.environ['WHOOGLE\_PROXY\_TYPE'] = args.proxytype os.environ['WHOOGLE\_PROXY\_LOC'] = args.proxyloc
 if args.https\_only: os.environ['HTTPS\_ONLY'] = '1'
 if args.debug: app.run(host=args.host, port=args.port, debug=args.debug) elif args.unix\_socket: waitress.serve(app, unix\_socket=args.unix\_socket) else: waitress.serve( app, listen="{}:{}".format(args.host, args.port), url\_prefix=os.environ.get('WHOOGLE\_URL\_PREFIX', ''))

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_74c785ed_20250114_185956.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fblob%2F92e8ede24e9277a5440d403f75877209f1269884%2Fapp%2Froutes.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbenbusby%2Fwhoogle-search%2Fblob%2F92e8ede24e9277a5440d403f75877209f1269884%2Fapp%2Froutes.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=benbusby%2Fwhoogle-search)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[benbusby](/benbusby)
/
**[whoogle-search](/benbusby/whoogle-search)**
Public

* [Notifications](/login?return_to=%2Fbenbusby%2Fwhoogle-search) You must be signed in to change notification settings
* [Fork
  960](/login?return_to=%2Fbenbusby%2Fwhoogle-search)
* [Star
   9.8k](/login?return_to=%2Fbenbusby%2Fwhoogle-search)

* [Code](/benbusby/whoogle-search)
* [Issues
  68](/benbusby/whoogle-search/issues)
* [Pull requests
  9](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects
  0](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

Additional navigation options

* [Code](/benbusby/whoogle-search)
* [Issues](/benbusby/whoogle-search/issues)
* [Pull requests](/benbusby/whoogle-search/pulls)
* [Discussions](/benbusby/whoogle-search/discussions)
* [Actions](/benbusby/whoogle-search/actions)
* [Projects](/benbusby/whoogle-search/projects)
* [Wiki](/benbusby/whoogle-search/wiki)
* [Security](/benbusby/whoogle-search/security)
* [Insights](/benbusby/whoogle-search/pulse)

## Files

 92e8ede
## Breadcrumbs

1. [whoogle-search](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884)
2. /[app](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884/app)
/
# routes.py

Copy path Blame  Blame
## Latest commit

## History

[History](/benbusby/whoogle-search/commits/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py)648 lines (543 loc) · 22.2 KB 92e8ede
## Breadcrumbs

1. [whoogle-search](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884)
2. /[app](/benbusby/whoogle-search/tree/92e8ede24e9277a5440d403f75877209f1269884/app)
/
# routes.py

Top
## File metadata and controls

* Code
* Blame

648 lines (543 loc) · 22.2 KB[Raw](https://github.com/benbusby/whoogle-search/raw/92e8ede24e9277a5440d403f75877209f1269884/app/routes.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648import argparseimport base64import ioimport jsonimport osimport pickleimport urllib.parse as urlparseimport uuidfrom datetime import datetime, timedeltafrom functools import wraps
import waitressfrom app import appfrom app.models.config import Configfrom app.models.endpoint import Endpointfrom app.request import Request, TorErrorfrom app.utils.bangs import resolve\_bangfrom app.utils.misc import get\_proxy\_host\_urlfrom app.filter import Filterfrom app.utils.misc import read\_config\_bool, get\_client\_ip, get\_request\_url, \ check\_for\_updatefrom app.utils.widgets import \*from app.utils.results import bold\_search\_terms,\ add\_currency\_card, check\_currency, get\_tabs\_contentfrom app.utils.search import Search, needs\_https, has\_captchafrom app.utils.session import valid\_user\_sessionfrom bs4 import BeautifulSoup as bsoupfrom flask import jsonify, make\_response, request, redirect, render\_template, \ send\_file, session, url\_for, gfrom requests import exceptionsfrom requests.models import PreparedRequestfrom cryptography.fernet import Fernet, InvalidTokenfrom cryptography.exceptions import InvalidSignature
# Load DDG bang json files only on initbang\_json = json.load(open(app.config['BANG\_FILE'])) or {}
ac\_var = 'WHOOGLE\_AUTOCOMPLETE'autocomplete\_enabled = os.getenv(ac\_var, '1')
def get\_search\_name(tbm): for tab in app.config['HEADER\_TABS'].values(): if tab['tbm'] == tbm: return tab['name']
def auth\_required(f): @wraps(f) def decorated(\*args, \*\*kwargs): # do not ask password if cookies already present if ( valid\_user\_session(session) and 'cookies\_disabled' not in request.args and session['auth'] ): return f(\*args, \*\*kwargs)
 auth = request.authorization
 # Skip if username/password not set whoogle\_user = os.getenv('WHOOGLE\_USER', '') whoogle\_pass = os.getenv('WHOOGLE\_PASS', '') if (not whoogle\_user or not whoogle\_pass) or ( auth and whoogle\_user == auth.username and whoogle\_pass == auth.password): session['auth'] = True return f(\*args, \*\*kwargs) else: return make\_response('Not logged in', 401, { 'WWW-Authenticate': 'Basic realm="Login Required"'})
 return decorated
def session\_required(f): @wraps(f) def decorated(\*args, \*\*kwargs): if not valid\_user\_session(session): session.pop('\_permanent', None)
 # Note: This sets all requests to use the encryption key determined per # instance on app init. This can be updated in the future to use a key # that is unique for their session (session['key']) but this should use # a config setting to enable the session based key. Otherwise there can # be problems with searches performed by users with cookies blocked if # a session based key is always used. g.session\_key = app.enc\_key
 # Clear out old sessions invalid\_sessions = [] for user\_session in os.listdir(app.config['SESSION\_FILE\_DIR']): file\_path = os.path.join( app.config['SESSION\_FILE\_DIR'], user\_session)
 try: # Ignore files that are larger than the max session file size if os.path.getsize(file\_path) > app.config['MAX\_SESSION\_SIZE']: continue
 with open(file\_path, 'rb') as session\_file: \_ = pickle.load(session\_file) data = pickle.load(session\_file) if isinstance(data, dict) and 'valid' in data: continue invalid\_sessions.append(file\_path) except Exception: # Broad exception handling here due to how instances installed # with pip seem to have issues storing unrelated files in the # same directory as sessions pass
 for invalid\_session in invalid\_sessions: try: os.remove(invalid\_session) except FileNotFoundError: # Don't throw error if the invalid session has been removed pass
 return f(\*args, \*\*kwargs)
 return decorated
@app.before\_requestdef before\_request\_func(): global bang\_json session.permanent = True
 # Check for latest version if needed now = datetime.now() if now - timedelta(hours=24) > app.config['LAST\_UPDATE\_CHECK']: app.config['LAST\_UPDATE\_CHECK'] = now app.config['HAS\_UPDATE'] = check\_for\_update( app.config['RELEASES\_URL'], app.config['VERSION\_NUMBER'])
 g.request\_params = ( request.args if request.method == 'GET' else request.form )
 default\_config = json.load(open(app.config['DEFAULT\_CONFIG'])) \ if os.path.exists(app.config['DEFAULT\_CONFIG']) else {}
 # Generate session values for user if unavailable if not valid\_user\_session(session): session['config'] = default\_config session['uuid'] = str(uuid.uuid4()) session['key'] = app.enc\_key session['auth'] = False
 # Establish config values per user session g.user\_config = Config(\*\*session['config'])
 # Update user config if specified in search args g.user\_config = g.user\_config.from\_params(g.request\_params)
 if not g.user\_config.url: g.user\_config.url = get\_request\_url(request.url\_root)
 g.user\_request = Request( request.headers.get('User-Agent'), get\_request\_url(request.url\_root), config=g.user\_config)
 g.app\_location = g.user\_config.url
 # Attempt to reload bangs json if not generated yet if not bang\_json and os.path.getsize(app.config['BANG\_FILE']) > 4: try: bang\_json = json.load(open(app.config['BANG\_FILE'])) except json.decoder.JSONDecodeError: # Ignore decoding error, can occur if file is still # being written pass
@app.after\_requestdef after\_request\_func(resp): resp.headers['X-Content-Type-Options'] = 'nosniff' resp.headers['X-Frame-Options'] = 'DENY'
 if os.getenv('WHOOGLE\_CSP', False): resp.headers['Content-Security-Policy'] = app.config['CSP'] if os.environ.get('HTTPS\_ONLY', False): resp.headers['Content-Security-Policy'] += \ 'upgrade-insecure-requests'
 return resp
@app.errorhandler(404)def unknown\_page(e): app.logger.warn(e) return redirect(g.app\_location)
@app.route(f'/{Endpoint.healthz}', methods=['GET'])def healthz(): return ''
@app.route('/', methods=['GET'])@app.route(f'/{Endpoint.home}', methods=['GET'])@auth\_requireddef index(): # Redirect if an error was raised if 'error\_message' in session and session['error\_message']: error\_message = session['error\_message'] session['error\_message'] = '' return render\_template('error.html', error\_message=error\_message)
 return render\_template('index.html', has\_update=app.config['HAS\_UPDATE'], languages=app.config['LANGUAGES'], countries=app.config['COUNTRIES'], time\_periods=app.config['TIME\_PERIODS'], themes=app.config['THEMES'], autocomplete\_enabled=autocomplete\_enabled, translation=app.config['TRANSLATIONS'][ g.user\_config.get\_localization\_lang() ], logo=render\_template( 'logo.html', dark=g.user\_config.dark), config\_disabled=( app.config['CONFIG\_DISABLE'] or not valid\_user\_session(session)), config=g.user\_config, tor\_available=int(os.environ.get('TOR\_AVAILABLE')), version\_number=app.config['VERSION\_NUMBER'])
@app.route(f'/{Endpoint.opensearch}', methods=['GET'])def opensearch(): opensearch\_url = g.app\_location if opensearch\_url.endswith('/'): opensearch\_url = opensearch\_url[:-1]
 # Enforce https for opensearch template if needs\_https(opensearch\_url): opensearch\_url = opensearch\_url.replace('http://', 'https://', 1)
 get\_only = g.user\_config.get\_only or 'Chrome' in request.headers.get( 'User-Agent')
 return render\_template( 'opensearch.xml', main\_url=opensearch\_url, request\_type='' if get\_only else 'method="post"', search\_type=request.args.get('tbm'), search\_name=get\_search\_name(request.args.get('tbm')) ), 200, {'Content-Type': 'application/xml'}
@app.route(f'/{Endpoint.search\_html}', methods=['GET'])def search\_html(): search\_url = g.app\_location if search\_url.endswith('/'): search\_url = search\_url[:-1] return render\_template('search.html', url=search\_url)
@app.route(f'/{Endpoint.autocomplete}', methods=['GET', 'POST'])def autocomplete(): if os.getenv(ac\_var) and not read\_config\_bool(ac\_var): return jsonify({})
 q = g.request\_params.get('q') if not q: # FF will occasionally (incorrectly) send the q field without a # mimetype in the format "b'q=<query>'" through the request.data field q = str(request.data).replace('q=', '')
 # Search bangs if the query begins with "!", but not "! " (feeling lucky) if q.startswith('!') and len(q) > 1 and not q.startswith('! '): return jsonify([q, [bang\_json[\_]['suggestion'] for \_ in bang\_json if \_.startswith(q)]])
 if not q and not request.data: return jsonify({'?': []}) elif request.data: q = urlparse.unquote\_plus( request.data.decode('utf-8').replace('q=', ''))
 # Return a list of suggestions for the query # # Note: If Tor is enabled, this returns nothing, as the request is # almost always rejected return jsonify([ q, g.user\_request.autocomplete(q) if not g.user\_config.tor else [] ])
@app.route(f'/{Endpoint.search}', methods=['GET', 'POST'])@session\_required@auth\_requireddef search(): search\_util = Search(request, g.user\_config, g.session\_key) query = search\_util.new\_search\_query()
 bang = resolve\_bang(query, bang\_json) if bang: return redirect(bang)
 # Redirect to home if invalid/blank search if not query: return redirect(url\_for('.index'))
 # Generate response and number of external elements from the page try: response = search\_util.generate\_response() except TorError as e: session['error\_message'] = e.message + ( "\\n\\nTor config is now disabled!" if e.disable else "") session['config']['tor'] = False if e.disable else session['config'][ 'tor'] return redirect(url\_for('.index'))
 if search\_util.feeling\_lucky: return redirect(response, code=303)
 # If the user is attempting to translate a string, determine the correct # string for formatting the lingva.ml url localization\_lang = g.user\_config.get\_localization\_lang() translation = app.config['TRANSLATIONS'][localization\_lang] translate\_to = localization\_lang.replace('lang\_', '')
 # removing st-card to only use whoogle time selector soup = bsoup(response, "html.parser"); for x in soup.find\_all(attrs={"id": "st-card"}): x.replace\_with("")
 response = str(soup)
 # Return 503 if temporarily blocked by captcha if has\_captcha(str(response)): app.logger.error('503 (CAPTCHA)') return render\_template( 'error.html', blocked=True, error\_message=translation['ratelimit'], translation=translation, farside='https://farside.link', config=g.user\_config, query=urlparse.unquote(query), params=g.user\_config.to\_params(keys=['preferences'])), 503
 response = bold\_search\_terms(response, query)
 # check for widgets and add if requested if search\_util.widget != '': html\_soup = bsoup(str(response), 'html.parser') if search\_util.widget == 'ip': response = add\_ip\_card(html\_soup, get\_client\_ip(request)) elif search\_util.widget == 'calculator' and not 'nojs' in request.args: response = add\_calculator\_card(html\_soup)
 # Update tabs content tabs = get\_tabs\_content(app.config['HEADER\_TABS'], search\_util.full\_query, search\_util.search\_type, g.user\_config.preferences, translation)
 # Feature to display currency\_card # Since this is determined by more than just the # query is it not defined as a standard widget conversion = check\_currency(str(response)) if conversion: html\_soup = bsoup(str(response), 'html.parser') response = add\_currency\_card(html\_soup, conversion)
 preferences = g.user\_config.preferences home\_url = f"home?preferences={preferences}" if preferences else "home" cleanresponse = str(response).replace("andlt;","&lt;").replace("andgt;","&gt;")
 return render\_template( 'display.html', has\_update=app.config['HAS\_UPDATE'], query=urlparse.unquote(query), search\_type=search\_util.search\_type, search\_name=get\_search\_name(search\_util.search\_type), config=g.user\_config, autocomplete\_enabled=autocomplete\_enabled, lingva\_url=app.config['TRANSLATE\_URL'], translation=translation, translate\_to=translate\_to, translate\_str=query.replace( 'translate', '' ).replace( translation['translate'], '' ), is\_translation=any( \_ in query.lower() for \_ in [translation['translate'], 'translate'] ) and not search\_util.search\_type, # Standard search queries only response=cleanresponse, version\_number=app.config['VERSION\_NUMBER'], search\_header=render\_template( 'header.html', home\_url=home\_url, config=g.user\_config, translation=translation, languages=app.config['LANGUAGES'], countries=app.config['COUNTRIES'], time\_periods=app.config['TIME\_PERIODS'], logo=render\_template('logo.html', dark=g.user\_config.dark), query=urlparse.unquote(query), search\_type=search\_util.search\_type, mobile=g.user\_request.mobile, tabs=tabs)).replace(" ", "")
@app.route(f'/{Endpoint.config}', methods=['GET', 'POST', 'PUT'])@session\_required@auth\_requireddef config(): config\_disabled = ( app.config['CONFIG\_DISABLE'] or not valid\_user\_session(session)) if request.method == 'GET': return json.dumps(g.user\_config.\_\_dict\_\_) elif request.method == 'PUT' and not config\_disabled: if 'name' in request.args: config\_pkl = os.path.join( app.config['CONFIG\_PATH'], request.args.get('name')) session['config'] = (pickle.load(open(config\_pkl, 'rb')) if os.path.exists(config\_pkl) else session['config']) return json.dumps(session['config']) else: return json.dumps({}) elif not config\_disabled: config\_data = request.form.to\_dict() if 'url' not in config\_data or not config\_data['url']: config\_data['url'] = g.user\_config.url
 # Save config by name to allow a user to easily load later if 'name' in request.args: pickle.dump( config\_data, open(os.path.join( app.config['CONFIG\_PATH'], request.args.get('name')), 'wb'))
 session['config'] = config\_data return redirect(config\_data['url']) else: return redirect(url\_for('.index'), code=403)
@app.route(f'/{Endpoint.imgres}')@session\_required@auth\_requireddef imgres(): return redirect(request.args.get('imgurl'))
@app.route(f'/{Endpoint.element}')@session\_required@auth\_requireddef element(): element\_url = src\_url = request.args.get('url') if element\_url.startswith('gAAAAA'): try: cipher\_suite = Fernet(g.session\_key) src\_url = cipher\_suite.decrypt(element\_url.encode()).decode() except (InvalidSignature, InvalidToken) as e: return render\_template( 'error.html', error\_message=str(e)), 401
 src\_type = request.args.get('type')
 try: file\_data = g.user\_request.send(base\_url=src\_url).content tmp\_mem = io.BytesIO() tmp\_mem.write(file\_data) tmp\_mem.seek(0)
 return send\_file(tmp\_mem, mimetype=src\_type) except exceptions.RequestException: pass
 empty\_gif = base64.b64decode( 'R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==') return send\_file(io.BytesIO(empty\_gif), mimetype='image/gif')
@app.route(f'/{Endpoint.window}')@session\_required@auth\_requireddef window(): target\_url = request.args.get('location') if target\_url.startswith('gAAAAA'): cipher\_suite = Fernet(g.session\_key) target\_url = cipher\_suite.decrypt(target\_url.encode()).decode()
 content\_filter = Filter( g.session\_key, root\_url=request.url\_root, config=g.user\_config) target = urlparse.urlparse(target\_url) host\_url = f'{target.scheme}://{target.netloc}'
 get\_body = g.user\_request.send(base\_url=target\_url).text
 results = bsoup(get\_body, 'html.parser') src\_attrs = ['src', 'href', 'srcset', 'data-srcset', 'data-src']
 # Parse HTML response and replace relative links w/ absolute for element in results.find\_all(): for attr in src\_attrs: if not element.has\_attr(attr) or not element[attr].startswith('/'): continue
 element[attr] = host\_url + element[attr]
 # Replace or remove javascript sources for script in results.find\_all('script', {'src': True}): if 'nojs' in request.args: script.decompose() else: content\_filter.update\_element\_src(script, 'application/javascript')
 # Replace all possible image attributes img\_sources = ['src', 'data-src', 'data-srcset', 'srcset'] for img in results.find\_all('img'): \_ = [ content\_filter.update\_element\_src(img, 'image/png', attr=\_) for \_ in img\_sources if img.has\_attr(\_) ]
 # Replace all stylesheet sources for link in results.find\_all('link', {'href': True}): content\_filter.update\_element\_src(link, 'text/css', attr='href')
 # Use anonymous view for all links on page for a in results.find\_all('a', {'href': True}): a['href'] = f'{Endpoint.window}?location=' + a['href'] + ( '&nojs=1' if 'nojs' in request.args else '')
 # Remove all iframes -- these are commonly used inside of <noscript> tags # to enforce loading Google Analytics for iframe in results.find\_all('iframe'): iframe.decompose()
 return render\_template( 'display.html', response=results, translation=app.config['TRANSLATIONS'][ g.user\_config.get\_localization\_lang() ] )
@app.route(f'/robots.txt')def robots(): response = make\_response('''User-Agent: \*Disallow: /''', 200) response.mimetype = 'text/plain' return response
@app.errorhandler(404)def page\_not\_found(e): return render\_template('error.html', error\_message=str(e)), 404
def run\_app() -> None: parser = argparse.ArgumentParser( description='Whoogle Search console runner') parser.add\_argument( '--port', default=5000, metavar='<port number>', help='Specifies a port to run on (default 5000)') parser.add\_argument( '--host', default='127.0.0.1', metavar='<ip address>', help='Specifies the host address to use (default 127.0.0.1)') parser.add\_argument( '--unix-socket', default='', metavar='</path/to/unix.sock>', help='Listen for app on unix socket instead of host:port') parser.add\_argument( '--debug', default=False, action='store\_true', help='Activates debug mode for the server (default False)') parser.add\_argument( '--https-only', default=False, action='store\_true', help='Enforces HTTPS redirects for all requests') parser.add\_argument( '--userpass', default='', metavar='<username:password>', help='Sets a username/password basic auth combo (default None)') parser.add\_argument( '--proxyauth', default='', metavar='<username:password>', help='Sets a username/password for a HTTP/SOCKS proxy (default None)') parser.add\_argument( '--proxytype', default='', metavar='<socks4|socks5|http>', help='Sets a proxy type for all connections (default None)') parser.add\_argument( '--proxyloc', default='', metavar='<location:port>', help='Sets a proxy location for all connections (default None)') args = parser.parse\_args()
 if args.userpass: user\_pass = args.userpass.split(':') os.environ['WHOOGLE\_USER'] = user\_pass[0] os.environ['WHOOGLE\_PASS'] = user\_pass[1]
 if args.proxytype and args.proxyloc: if args.proxyauth: proxy\_user\_pass = args.proxyauth.split(':') os.environ['WHOOGLE\_PROXY\_USER'] = proxy\_user\_pass[0] os.environ['WHOOGLE\_PROXY\_PASS'] = proxy\_user\_pass[1] os.environ['WHOOGLE\_PROXY\_TYPE'] = args.proxytype os.environ['WHOOGLE\_PROXY\_LOC'] = args.proxyloc
 if args.https\_only: os.environ['HTTPS\_ONLY'] = '1'
 if args.debug: app.run(host=args.host, port=args.port, debug=args.debug) elif args.unix\_socket: waitress.serve(app, unix\_socket=args.unix\_socket) else: waitress.serve( app, listen="{}:{}".format(args.host, args.port), url\_prefix=os.environ.get('WHOOGLE\_URL\_PREFIX', ''))

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


