=== Content from github.com_64590d86_20250114_192740.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fsecurity%2Fadvisories%2FGHSA-2q8v-3gqq-4f8p)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fsecurity%2Fadvisories%2FGHSA-2q8v-3gqq-4f8p)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=vyperlang%2Fvyper)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vyperlang](/vyperlang)
/
**[vyper](/vyperlang/vyper)**
Public

* [Notifications](/login?return_to=%2Fvyperlang%2Fvyper) You must be signed in to change notification settings
* [Fork
  818](/login?return_to=%2Fvyperlang%2Fvyper)
* [Star
   5k](/login?return_to=%2Fvyperlang%2Fvyper)

* [Code](/vyperlang/vyper)
* [Issues
  407](/vyperlang/vyper/issues)
* [Pull requests
  82](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects
  0](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

Additional navigation options

* [Code](/vyperlang/vyper)
* [Issues](/vyperlang/vyper/issues)
* [Pull requests](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

# concat built-in can corrupt memory

High

[charles-cooper](/charles-cooper)
published
GHSA-2q8v-3gqq-4f8p
Jan 18, 2024

## Package

pip

vyper
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

<=0.3.10

## Patched versions

0.4.0

## Description

### Summary

`concat` built-in can write over the bounds of the memory buffer that was allocated for it and thus overwrite existing valid data. The root cause is that the `build_IR` for `concat` doesn't properly adhere to the API of copy functions (for `>=0.3.2` the `copy_bytes` function).

A contract search was performed and no vulnerable contracts were found in production.

Tracked in issue [#3737](https://github.com/vyperlang/vyper/issues/3737)

### Details

The `build_IR` allocates a new internal variable for the concatenation:

[vyper/vyper/builtins/functions.py](https://github.com/vyperlang/vyper/blob/3b310d5292c4d1448e673d7b3adb223f9353260e/vyper/builtins/functions.py#L534-L550)

Lines 534 to 550
in
[3b310d5](/vyperlang/vyper/commit/3b310d5292c4d1448e673d7b3adb223f9353260e)

|  | dst\_maxlen = sum( |
| --- | --- |
|  | [arg.typ.maxlen if isinstance(arg.typ, \_BytestringT) else arg.typ.m for arg in args] |
|  | ) |
|  |  |
|  | # TODO: try to grab these from semantic analysis |
|  | if isinstance(args[0].typ, StringT): |
|  | ret\_typ = StringT(dst\_maxlen) |
|  | else: |
|  | ret\_typ = BytesT(dst\_maxlen) |
|  |  |
|  | # Node representing the position of the output in memory |
|  | dst = IRnode.from\_list( |
|  | context.new\_internal\_variable(ret\_typ), |
|  | typ=ret\_typ, |
|  | location=MEMORY, |
|  | annotation="concat destination", |
|  | ) |

Notice that the buffer is allocated for the `maxlen` + 1 word to actually hold the length of the array.

Later the `copy_bytes` function is used to copy the actual source arguments to the destination:

[vyper/vyper/builtins/functions.py](https://github.com/vyperlang/vyper/blob/3b310d5292c4d1448e673d7b3adb223f9353260e/vyper/builtins/functions.py#L569-L572)

Lines 569 to 572
in
[3b310d5](/vyperlang/vyper/commit/3b310d5292c4d1448e673d7b3adb223f9353260e)

|  | do\_copy = [ |
| --- | --- |
|  | "seq", |
|  | copy\_bytes(dst\_data, argdata, arglen, arg.typ.maxlen), |
|  | ["set", ofst, ["add", ofst, arglen]], |

The `dst_data` is defined via:

* `data ptr` - to skip the 1 word that holds the length
* `offset` - to skip the source arguments that were already written to the buffer
  + the `offset` is increased via: `["set", ofst, ["add", ofst, arglen]]`, ie it is increased by the length of the source argument

Now, the `copy_bytes` function has multiple control flow paths, the following ones are of interest:

1. [vyper/vyper/codegen/core.py](https://github.com/vyperlang/vyper/blob/3b310d5292c4d1448e673d7b3adb223f9353260e/vyper/codegen/core.py#L270-L273)

   Lines 270 to 273
   in
   [3b310d5](/vyperlang/vyper/commit/3b310d5292c4d1448e673d7b3adb223f9353260e)

   |  | if length\_bound <= 32: |
   | --- | --- |
   |  | copy\_op = STORE(dst, LOAD(src)) |
   |  | ret = IRnode.from\_list(copy\_op, annotation=annotation) |
   |  | return b1.resolve(b2.resolve(b3.resolve(ret))) |
2. [vyper/vyper/codegen/core.py](https://github.com/vyperlang/vyper/blob/3b310d5292c4d1448e673d7b3adb223f9353260e/vyper/codegen/core.py#L301-L320)

   Lines 301 to 320
   in
   [3b310d5](/vyperlang/vyper/commit/3b310d5292c4d1448e673d7b3adb223f9353260e)

   |  | # general case, copy word-for-word |
   | --- | --- |
   |  | # pseudocode for our approach (memory-storage as example): |
   |  | # for i in range(len, bound=MAX\_LEN): |
   |  | # sstore(\_dst + i, mload(src + i \* 32)) |
   |  | i = IRnode.from\_list(\_freshname("copy\_bytes\_ix"), typ=UINT256\_T) |
   |  |  |
   |  | # optimized form of (div (ceil32 len) 32) |
   |  | n = ["div", ["add", 31, length], 32] |
   |  | n\_bound = ceil32(length\_bound) // 32 |
   |  |  |
   |  | dst\_i = add\_ofst(dst, \_mul(i, dst.location.word\_scale)) |
   |  | src\_i = add\_ofst(src, \_mul(i, src.location.word\_scale)) |
   |  |  |
   |  | copy\_one\_word = STORE(dst\_i, LOAD(src\_i)) |
   |  |  |
   |  | main\_loop = ["repeat", i, 0, n, n\_bound, copy\_one\_word] |
   |  |  |
   |  | return b1.resolve( |
   |  | b2.resolve(b3.resolve(IRnode.from\_list(main\_loop, annotation=annotation))) |
   |  | ) |

Note that the function itself contains the following note:

[vyper/vyper/codegen/core.py](https://github.com/vyperlang/vyper/blob/3b310d5292c4d1448e673d7b3adb223f9353260e/vyper/codegen/core.py#L245-L247)

Lines 245 to 247
in
[3b310d5](/vyperlang/vyper/commit/3b310d5292c4d1448e673d7b3adb223f9353260e)

|  | # NOTE: may pad to ceil32 of `length`! If you ask to copy 1 byte, it may |
| --- | --- |
|  | # copy an entire (32-byte) word, depending on the copy routine chosen. |
|  | # TODO maybe always pad to ceil32, to reduce dirty bytes bugs |

That is we can ask for a copy of `1B` yet a whole word is copied.

Consider the first interesting path - if the `dst_data`'s distance to the end of the concat data buffer is `< 32B`, the `copy_op = STORE(dst, LOAD(src))` from `copy_bytes` will result in buffer overflow as it essentially will `mstore` to `dst_data` the `mload` of the source (mload will load whole word and the distance of the `dst_data` to the word boundary is `<32B`).

From the two mentioned paths in `copy_bytes` it can be seen that both sources from memory and storage can cause the corruption.

### PoC

The main attack vector that was found was when the `concat` is inside an `internal` function. Suppose we have an `external` function that calls `internal` one. In such case the address space is divided such that the memory for the internal function is in *lower* portion of the adr space. As such the buffer overflow can overwrite *valid* data of the caller.

Here is a simple example:

```
#@version ^0.3.9

@internal
def bar() -> uint256:
    sss: String[2] = concat("a", "b")
    return 1

@external
def foo() -> int256:
    a: int256 = -1
    b: uint256 = self.bar()
    return a
```

`foo` should clearly return `-1`, but it returns `452312848583266388373324160190187140051835877600158453279131187530910662655`

`-1` was used intentionally due to its bit structure but the value here is fairly irelevant. In this example during the second iteration of the for loop in the `build_IR` `mload` to `dst+1` will be executed (because len('a') == 1), thus the function will write `1B` over the bounds of the buffer. The string 'b' is stored such that its right-most byte is a zero byte. So a zero byte will be written over the bounds. So when `-1` is considered it's left-most B will be overwritten to all 0. Therefore it can be seen: `452312848583266388373324160190187140051835877600158453279131187530910662655 == (2**248-1)` will output `True`.

#### IR

If we look at the contract's IR (vyper --no optimize -f ir), we see:

```
# Line 30
                          /* a: int256 = -1 */ [mstore, 320, -1 <-1>],

```

And for the second iteration of the loop in concat:

```
 len,
                        [mload, arg],
                        [seq,
                          [with,
                            src,
                            [add, arg, 32],
                            [with,
                              dst,
                              [add, [add, 256 <concat destination>, 32], concat_ofst],
                              [mstore, dst, [mload, src]]]],
                          [set, concat_ofst, [add, concat_ofst, len]]]]],
                    [mstore, 256 <concat destination>, concat_ofst],
                    256 <concat destination>]],

```

So the address of the `int` is 320.

The `dst` is defined as: `[add, [add, 256 <concat destination>, 32], concat_ofst],`.

In the second iteration the `concat_ofst` will be 1 because `len('a)==1` so `256+32+1 = 289`. Now this address will be `mstored` to - so the last mstored B will have the address `289+32=320` which clearly overlaps with the address of the `int a`.

#### PoC 2

Due to how `immutables` are handled, they can be corrupted too:

```
#@version ^0.3.9

i: immutable(int256)

@external
def __init__():
    i = -1
    s: String[2] = concat("a", "b")

@external
def foo() -> int256:
    return i
```

Output of calling `foo()` = `452312848583266388373324160190187140051835877600158453279131187530910662655`.

### Impact

The buffer overflow can result in the change of semantics of the contract. The overflow is length-dependent and thus it might go unnoticed during contract testing.

However, certainly not all usages of `concat` will result in overwritten valid data as we require it to be in an `internal` function and close to the `return` statement where other memory allocations don't occur.

### Concluding remarks

The bug based on the fast path in `copy_bytes` was likely introduced in: `548d35d720fb6fd8efbdc0ce525bed259a73f0b9`. `git bisect` was used between v0.3.1 and v0.3.2, `forge test` was run and the test asserted that the function indeed returns -1.

For the general case, `0.3.0` and `0.3.1` are also affected.

### Severity

High

### CVE ID

CVE-2024-22419

### Weaknesses

No CWEs

### Credits

* [![@cyberthirst](https://avatars.githubusercontent.com/u/16179769?s=40&v=4)](/cyberthirst)
  [cyberthirst](/cyberthirst)
  Reporter
* [![@kuroi8](https://avatars.githubusercontent.com/u/146698017?s=40&v=4)](/kuroi8)
  [kuroi8](/kuroi8)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_94154c0c_20250114_192738.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fissues%2F3737)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fissues%2F3737)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=vyperlang%2Fvyper)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vyperlang](/vyperlang)
/
**[vyper](/vyperlang/vyper)**
Public

* [Notifications](/login?return_to=%2Fvyperlang%2Fvyper) You must be signed in to change notification settings
* [Fork
  818](/login?return_to=%2Fvyperlang%2Fvyper)
* [Star
   5k](/login?return_to=%2Fvyperlang%2Fvyper)

* [Code](/vyperlang/vyper)
* [Issues
  407](/vyperlang/vyper/issues)
* [Pull requests
  82](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects
  0](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

Additional navigation options

* [Code](/vyperlang/vyper)
* [Issues](/vyperlang/vyper/issues)
* [Pull requests](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fvyperlang%2Fvyper%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fvyperlang%2Fvyper%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# concat builtin can overrun memory #3737

Closed

[charles-cooper](/charles-cooper) opened this issue
Jan 18, 2024
· 0 comments
 · Fixed by [#3738](https://github.com/vyperlang/vyper/pull/3738)

Closed

# [concat builtin can overrun memory](#top) #3737

[charles-cooper](/charles-cooper) opened this issue
Jan 18, 2024
· 0 comments
 · Fixed by [#3738](https://github.com/vyperlang/vyper/pull/3738)

Labels
[bug - codegen](/vyperlang/vyper/labels/bug%20-%20codegen)
[bug - type 1](/vyperlang/vyper/labels/bug%20-%20type%201)
bug which results in incorrect codegen

## Comments

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=80&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)

Copy link

Member

### **[charles-cooper](/charles-cooper)** commented [Jan 18, 2024](#issue-2088619961)

| Version Information  * vyper Version (output of `vyper --version`): x.x.x * OS: osx/linux/win * Python Version (output of `python --version`):  What's your issue about? tracking issue for [GHSA-2q8v-3gqq-4f8p](https://github.com/vyperlang/vyper/security/advisories/GHSA-2q8v-3gqq-4f8p "GHSA-2q8v-3gqq-4f8p") How can it be fixed? Fill this in if you know how to fix it. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
added
[bug - codegen](/vyperlang/vyper/labels/bug%20-%20codegen)
[bug - type 1](/vyperlang/vyper/labels/bug%20-%20type%201)
bug which results in incorrect codegen
labels
[Jan 18, 2024](#event-11527344055)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
mentioned this issue
[Jan 18, 2024](#ref-pullrequest-2088642989)

[fix: concat buffer bug
#3738](/vyperlang/vyper/pull/3738)
 Merged

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
closed this as [completed](/vyperlang/vyper/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#3738](/vyperlang/vyper/pull/3738)
[Jan 18, 2024](#event-11528558963)

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&u=8126b3c609b132f8625faae11480d2f8113f5acb&v=4)](/charles-cooper)
[charles-cooper](/charles-cooper)
mentioned this issue
[Feb 10, 2024](#ref-issue-2128514802)

[meta: 0.4.0 checklist
#3767](/vyperlang/vyper/issues/3767)

Closed

33 tasks

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fissues%2F3737)

Assignees

No one assigned

Labels

[bug - codegen](/vyperlang/vyper/labels/bug%20-%20codegen)
[bug - type 1](/vyperlang/vyper/labels/bug%20-%20type%201)
bug which results in incorrect codegen

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [fix: concat buffer bug](/vyperlang/vyper/pull/3738)
 [charles-cooper/vyper](/charles-cooper/vyper)

1 participant

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=52&v=4)](/charles-cooper)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4a9298b2_20250114_192737.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fcommit%2F55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fcommit%2F55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=vyperlang%2Fvyper)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[vyperlang](/vyperlang)
/
**[vyper](/vyperlang/vyper)**
Public

* [Notifications](/login?return_to=%2Fvyperlang%2Fvyper) You must be signed in to change notification settings
* [Fork
  818](/login?return_to=%2Fvyperlang%2Fvyper)
* [Star
   5k](/login?return_to=%2Fvyperlang%2Fvyper)

* [Code](/vyperlang/vyper)
* [Issues
  407](/vyperlang/vyper/issues)
* [Pull requests
  82](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects
  0](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

Additional navigation options

* [Code](/vyperlang/vyper)
* [Issues](/vyperlang/vyper/issues)
* [Pull requests](/vyperlang/vyper/pulls)
* [Discussions](/vyperlang/vyper/discussions)
* [Actions](/vyperlang/vyper/actions)
* [Projects](/vyperlang/vyper/projects)
* [Wiki](/vyperlang/vyper/wiki)
* [Security](/vyperlang/vyper/security)
* [Insights](/vyperlang/vyper/pulse)

## Commit

[Permalink](/vyperlang/vyper/commit/55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix: concat buffer bug ([#3738](https://github.com/vyperlang/vyper/pull/3738))

[Browse files](/vyperlang/vyper/tree/55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f)
Browse the repository at this point in the history

```
the `concat()` builtin did not respect the `copy_bytes()` API, it
allocated a buffer in some cases which did not have enough padding.

patches [GHSA-2q8v-3gqq-4f8p](https://github.com/advisories/GHSA-2q8v-3gqq-4f8p "GHSA-2q8v-3gqq-4f8p")

---------

Co-authored-by: cyberthirst <cyberthirst.eth@gmail.com>
```

* Loading branch information

[![@charles-cooper](https://avatars.githubusercontent.com/u/3867501?s=40&v=4)](/charles-cooper) [![@cyberthirst](https://avatars.githubusercontent.com/u/16179769?s=40&v=4)](/cyberthirst)

[charles-cooper](/vyperlang/vyper/commits?author=charles-cooper "View all commits by charles-cooper")
and
[cyberthirst](/vyperlang/vyper/commits?author=cyberthirst "View all commits by cyberthirst")
authored
Jan 18, 2024

1 parent
[56b0d4f](/vyperlang/vyper/commit/56b0d4fc3cb110ea9a53f3ca3affb4e758213d22)

commit 55e18f6

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**69 additions**
and
**6 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tests/functional/builtins/codegen

  + tests/functional/builtins/codegen/test\_concat.py
    [test\_concat.py](#diff-257d4eb0d7079b781af9e711575b3147c054b936a39facea7598a519d36860f3)
* vyper/builtins

  + vyper/builtins/functions.py
    [functions.py](#diff-e90bab969567793a8abf25b22fa03548e4abe48db25f48a05e2c51ce78e0613e)

## There are no files selected for viewing

64 changes: 64 additions & 0 deletions

64
[tests/functional/builtins/codegen/test\_concat.py](#diff-257d4eb0d7079b781af9e711575b3147c054b936a39facea7598a519d36860f3 "tests/functional/builtins/codegen/test_concat.py")

Show comments

[View file](/vyperlang/vyper/blob/55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f/tests/functional/builtins/codegen/test_concat.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -55,6 +55,70 @@ def krazykonkat(z: Bytes[10]) -> Bytes[25]: |
|  |  | print("Passed third concat test") |
|  |  |  |
|  |  |  |
|  |  | def test\_concat\_buffer(get\_contract): |
|  |  | # GHSA-2q8v-3gqq-4f8p |
|  |  | code = """ |
|  |  | @internal |
|  |  | def bar() -> uint256: |
|  |  | sss: String[2] = concat("a", "b") |
|  |  | return 1 |
|  |  |  |
|  |  |  |
|  |  | @external |
|  |  | def foo() -> int256: |
|  |  | a: int256 = -1 |
|  |  | b: uint256 = self.bar() |
|  |  | return a |
|  |  | """ |
|  |  | c = get\_contract(code) |
|  |  | assert c.foo() == -1 |
|  |  |  |
|  |  |  |
|  |  | def test\_concat\_buffer2(get\_contract): |
|  |  | # GHSA-2q8v-3gqq-4f8p |
|  |  | code = """ |
|  |  | i: immutable(int256) |
|  |  |  |
|  |  | @external |
|  |  | def \_\_init\_\_(): |
|  |  | i = -1 |
|  |  | s: String[2] = concat("a", "b") |
|  |  |  |
|  |  | @external |
|  |  | def foo() -> int256: |
|  |  | return i |
|  |  | """ |
|  |  | c = get\_contract(code) |
|  |  | assert c.foo() == -1 |
|  |  |  |
|  |  |  |
|  |  | def test\_concat\_buffer3(get\_contract): |
|  |  | # GHSA-2q8v-3gqq-4f8p |
|  |  | code = """ |
|  |  | s: String[1] |
|  |  | s2: String[33] |
|  |  | s3: String[34] |
|  |  |  |
|  |  | @external |
|  |  | def \_\_init\_\_(): |
|  |  | self.s = "a" |
|  |  | self.s2 = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" # 33\*'a' |
|  |  |  |
|  |  | @internal |
|  |  | def bar() -> uint256: |
|  |  | self.s3 = concat(self.s, self.s2) |
|  |  | return 1 |
|  |  |  |
|  |  | @external |
|  |  | def foo() -> int256: |
|  |  | i: int256 = -1 |
|  |  | b: uint256 = self.bar() |
|  |  | return i |
|  |  | """ |
|  |  | c = get\_contract(code) |
|  |  | assert c.foo() == -1 |
|  |  |  |
|  |  |  |
|  |  | def test\_concat\_bytes32(get\_contract\_with\_gas\_estimation): |
|  |  | test\_concat\_bytes32 = """ |
|  |  | @external |
| Expand Down | |  |

11 changes: 5 additions & 6 deletions

11
[vyper/builtins/functions.py](#diff-e90bab969567793a8abf25b22fa03548e4abe48db25f48a05e2c51ce78e0613e "vyper/builtins/functions.py")

Show comments

[View file](/vyperlang/vyper/blob/55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f/vyper/builtins/functions.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -543,13 +543,12 @@ def build\_IR(self, expr, context): |
|  |  | else: |
|  |  | ret\_typ = BytesT(dst\_maxlen) |
|  |  |  |
|  |  | # respect API of copy\_bytes |
|  |  | bufsize = dst\_maxlen + 32 |
|  |  | buf = context.new\_internal\_variable(BytesT(bufsize)) |
|  |  |  |
|  |  | # Node representing the position of the output in memory |
|  |  | dst = IRnode.from\_list( |
|  |  | context.new\_internal\_variable(ret\_typ), |
|  |  | typ=ret\_typ, |
|  |  | location=MEMORY, |
|  |  | annotation="concat destination", |
|  |  | ) |
|  |  | dst = IRnode.from\_list(buf, typ=ret\_typ, location=MEMORY, annotation="concat destination") |
|  |  |  |
|  |  | ret = ["seq"] |
|  |  | # stack item representing our current offset in the dst buffer |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `55e18f6`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fvyperlang%2Fvyper%2Fcommit%2F55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


