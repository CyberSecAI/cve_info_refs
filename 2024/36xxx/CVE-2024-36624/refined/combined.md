=== Content from github.com_84c83046_20250114_183021.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fblob%2F8.3%2Fweb%2Fsrc%2Fcopy_and_paste.js)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fblob%2F8.3%2Fweb%2Fsrc%2Fcopy_and_paste.js)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=zulip%2Fzulip)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zulip](/zulip)
/
**[zulip](/zulip/zulip)**
Public

* [Notifications](/login?return_to=%2Fzulip%2Fzulip) You must be signed in to change notification settings
* [Fork
  8.1k](/login?return_to=%2Fzulip%2Fzulip)
* [Star
   22k](/login?return_to=%2Fzulip%2Fzulip)

* [Code](/zulip/zulip/tree/8.3)
* [Issues
  1.6k](/zulip/zulip/issues)
* [Pull requests
  886](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects
  2](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

Additional navigation options

* [Code](/zulip/zulip/tree/8.3)
* [Issues](/zulip/zulip/issues)
* [Pull requests](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

## Files

 8.3
## Breadcrumbs

1. [zulip](/zulip/zulip/tree/8.3)
2. /[web](/zulip/zulip/tree/8.3/web)
3. /[src](/zulip/zulip/tree/8.3/web/src)
/
# copy\_and\_paste.js

Copy path Blame  Blame
## Latest commit

## History

[History](/zulip/zulip/commits/8.3/web/src/copy_and_paste.js)574 lines (511 loc) · 22.2 KB 8.3
## Breadcrumbs

1. [zulip](/zulip/zulip/tree/8.3)
2. /[web](/zulip/zulip/tree/8.3/web)
3. /[src](/zulip/zulip/tree/8.3/web/src)
/
# copy\_and\_paste.js

Top
## File metadata and controls

* Code
* Blame

574 lines (511 loc) · 22.2 KB[Raw](https://github.com/zulip/zulip/raw/refs/tags/8.3/web/src/copy_and_paste.js)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574import isUrl from "is-url";import $ from "jquery";import TurndownService from "turndown";
import \* as compose\_ui from "./compose\_ui";import \* as message\_lists from "./message\_lists";import {page\_params} from "./page\_params";import \* as rows from "./rows";
function find\_boundary\_tr($initial\_tr, iterate\_row) { let j; let skip\_same\_td\_check = false; let $tr = $initial\_tr;
 // If the selection boundary is somewhere that does not have a // parent tr, we should let the browser handle the copy-paste // entirely on its own if ($tr.length === 0) { return undefined; }
 // If the selection boundary is on a table row that does not have an // associated message id (because the user clicked between messages), // then scan downwards until we hit a table row with a message id. // To ensure we can't enter an infinite loop, bail out (and let the // browser handle the copy-paste on its own) if we don't hit what we // are looking for within 10 rows. for (j = 0; !$tr.is(".message\_row") && j < 10; j += 1) { $tr = iterate\_row($tr); } if (j === 10) { return undefined; } else if (j !== 0) { // If we updated tr, then we are not dealing with a selection // that is entirely within one td, and we can skip the same td // check (In fact, we need to because it won't work correctly // in this case) skip\_same\_td\_check = true; } return [rows.id($tr), skip\_same\_td\_check];}
function construct\_recipient\_header($message\_row) { const message\_header\_content = rows .get\_message\_recipient\_header($message\_row) .text() .replaceAll(/\s+/g, " ") .replace(/^\s/, "") .replace(/\s$/, ""); return $("<p>").append($("<strong>").text(message\_header\_content));}
/\*The techniques we use in this code date back to2013 and may be obsolete today (and may not havebeen even the best workaround back then).
https://github.com/zulip/zulip/commit/fc0b7c00f16316a554349f0ad58c6517ebdd7ac4
The idea is that we build a temp div, let jQuery process theselection, then restore the selection on a zero-second timer backto the original selection.
Do not be afraid to change this code if you understandhow modern browsers deal with copy/paste. Just testyour changes carefully.\*/function construct\_copy\_div($div, start\_id, end\_id) { const copy\_rows = rows.visible\_range(start\_id, end\_id);
 const $start\_row = copy\_rows[0]; const $start\_recipient\_row = rows.get\_message\_recipient\_row($start\_row); const start\_recipient\_row\_id = rows.id\_for\_recipient\_row($start\_recipient\_row); let should\_include\_start\_recipient\_header = false; let last\_recipient\_row\_id = start\_recipient\_row\_id;
 for (const $row of copy\_rows) { const recipient\_row\_id = rows.id\_for\_recipient\_row(rows.get\_message\_recipient\_row($row)); // if we found a message from another recipient, // it means that we have messages from several recipients, // so we have to add new recipient's bar to final copied message // and wouldn't forget to add start\_recipient's bar at the beginning of final message if (recipient\_row\_id !== last\_recipient\_row\_id) { $div.append(construct\_recipient\_header($row)); last\_recipient\_row\_id = recipient\_row\_id; should\_include\_start\_recipient\_header = true; } const message = message\_lists.current.get(rows.id($row)); const $content = $(message.content); $content.first().prepend(message.sender\_full\_name + ": "); $div.append($content); }
 if (should\_include\_start\_recipient\_header) { $div.prepend(construct\_recipient\_header($start\_row)); }}
function select\_div($div, selection) { $div.css({ position: "absolute", left: "-99999px", // Color and background is made according to "light theme" // exclusively here because when copying the content // into, say, Gmail compose box, the styles come along. // This is done to avoid copying the content with dark // background when using the app in dark theme. // We can avoid other custom styles since they are wrapped // inside another parent such as `.message\_content`. color: "#333", background: "#FFF", }).attr("id", "copytempdiv"); $("body").append($div); selection.selectAllChildren($div[0]);}
function remove\_div(\_div, ranges, selection) { window.setTimeout(() => { selection = window.getSelection(); selection.removeAllRanges();
 for (const range of ranges) { selection.addRange(range); }
 $("#copytempdiv").remove(); }, 0);}
export function copy\_handler() { // This is the main handler for copying message content via // `Ctrl+C` in Zulip (note that this is totally independent of the // "select region" copy behavior on Linux; that is handled // entirely by the browser, our HTML layout, and our use of the // no-select CSS classes). We put considerable effort // into producing a nice result that pastes well into other tools. // Our user-facing specification is the following: // // \* If the selection is contained within a single message, we // want to just copy the portion that was selected, which we // implement by letting the browser handle the Ctrl+C event. // // \* Otherwise, we want to copy the bodies of all messages that // were partially covered by the selection.
 const selection = window.getSelection(); const analysis = analyze\_selection(selection); const ranges = analysis.ranges; const start\_id = analysis.start\_id; const end\_id = analysis.end\_id; const skip\_same\_td\_check = analysis.skip\_same\_td\_check; const $div = $("<div>");
 if (start\_id === undefined || end\_id === undefined) { // In this case either the starting message or the ending // message is not defined, so this is definitely not a // multi-message selection and we can let the browser handle // the copy. document.execCommand("copy"); return; }
 if (!skip\_same\_td\_check && start\_id === end\_id) { // Check whether the selection both starts and ends in the // same message. If so, Let the browser handle this. document.execCommand("copy"); return; }
 // We've now decided to handle the copy event ourselves. // // We construct a temporary div for what we want the copy to pick up. // We construct the div only once, rather than for each range as we can // determine the starting and ending point with more confidence for the // whole selection. When constructing for each `Range`, there is a high // chance for overlaps between same message ids, avoiding which is much // more difficult since we can get a range (start\_id and end\_id) for // each selection `Range`. construct\_copy\_div($div, start\_id, end\_id);
 // Select div so that the browser will copy it // instead of copying the original selection select\_div($div, selection); document.execCommand("copy"); remove\_div($div, ranges, selection);}
export function analyze\_selection(selection) { // Here we analyze our selection to determine if part of a message // or multiple messages are selected. // // Firefox and Chrome handle selection of multiple messages // differently. Firefox typically creates multiple ranges for the // selection, whereas Chrome typically creates just one. // // Our goal in the below loop is to compute and be prepared to // analyze the combined range of the selections, and copy their // full content.
 let i; let range; const ranges = []; let $startc; let $endc; let $initial\_end\_tr; let start\_id; let end\_id; let start\_data; let end\_data; // skip\_same\_td\_check is true whenever we know for a fact that the // selection covers multiple messages (and thus we should no // longer consider letting the browser handle the copy event). let skip\_same\_td\_check = false;
 for (i = 0; i < selection.rangeCount; i += 1) { range = selection.getRangeAt(i); ranges.push(range);
 $startc = $(range.startContainer); start\_data = find\_boundary\_tr( $startc.parents(".selectable\_row, .message\_header").first(), ($row) => $row.next(), ); if (start\_data === undefined) { // Skip any selection sections that don't intersect a message. continue; } if (start\_id === undefined) { // start\_id is the Zulip message ID of the first message // touched by the selection. start\_id = start\_data[0]; }
 $endc = $(range.endContainer); $initial\_end\_tr = get\_end\_tr\_from\_endc($endc); end\_data = find\_boundary\_tr($initial\_end\_tr, ($row) => $row.prev());
 if (end\_data === undefined) { // Skip any selection sections that don't intersect a message. continue; } if (end\_data[0] !== undefined) { end\_id = end\_data[0]; }
 if (start\_data[1] || end\_data[1]) { // If the find\_boundary\_tr call for either the first or // the last message covered by the selection skip\_same\_td\_check = true; } }
 return { ranges, start\_id, end\_id, skip\_same\_td\_check, };}
function get\_end\_tr\_from\_endc($endc) { if ($endc.attr("id") === "bottom\_whitespace" || $endc.attr("id") === "compose\_close") { // If the selection ends in the bottom whitespace, we should // act as though the selection ends on the final message. // This handles the issue that Chrome seems to like selecting // the compose\_close button when you go off the end of the // last message return $(".message\_row").last(); }
 // Sometimes (especially when three click selecting in Chrome) the selection // can end in a hidden element in e.g. the next message, a date divider. // We can tell this is the case because the selection isn't inside a // `messagebox-content` div, which is where the message text itself is. // TODO: Ideally make it so that the selection cannot end there. // For now, we find the message row directly above wherever the // selection ended. if ($endc.closest(".messagebox-content").length === 0) { // If the selection ends within the message following the selected // messages, go back to use the actual last message. if ($endc.parents(".message\_row").length > 0) { const $parent\_msg = $endc.parents(".message\_row").first(); return $parent\_msg.prev(".message\_row"); } // If it's not in a .message\_row, it's probably in a .message\_header and // we can use the last message from the previous recipient\_row. if ($endc.parents(".message\_header").length > 0) { const $overflow\_recipient\_row = $endc.parents(".recipient\_row").first(); return $overflow\_recipient\_row.prev(".recipient\_row").last(".message\_row"); } // If somehow we get here, do the default return. }
 return $endc.parents(".selectable\_row").first();}
function deduplicate\_newlines(attribute) { // We replace any occurrences of one or more consecutive newlines followed by // zero or more whitespace characters with a single newline character. return attribute ? attribute.replaceAll(/(\n+\s\*)+/g, "\n") : "";}
function image\_to\_zulip\_markdown(\_content, node) { if (node.nodeName === "IMG" && node.classList.contains("emoji") && node.hasAttribute("alt")) { // For Zulip's custom emoji return node.getAttribute("alt"); } const src = node.getAttribute("src") || node.getAttribute("href") || ""; const title = deduplicate\_newlines(node.getAttribute("title")) || ""; // Using Zulip's link like syntax for images return src ? "[" + title + "](" + src + ")" : node.getAttribute("alt") || "";}
export function paste\_handler\_converter(paste\_html) { const copied\_html\_fragment = new DOMParser() .parseFromString(paste\_html, "text/html") .querySelector("body"); const copied\_within\_single\_element = copied\_html\_fragment.childNodes.length === 1 && copied\_html\_fragment.firstElementChild && copied\_html\_fragment.firstElementChild.innerHTML; const outer\_elements\_to\_retain = ["PRE", "UL", "OL", "A"]; // If the entire selection copied is within a single HTML element (like an // `h1`), we don't want to retain its styling, except when it is needed to // identify the intended structure of the copied content. if ( copied\_within\_single\_element && !outer\_elements\_to\_retain.includes(copied\_html\_fragment.firstElementChild.nodeName) ) { paste\_html = copied\_html\_fragment.firstChild.innerHTML; }
 // turning off escaping (for now) to remove extra `/` TurndownService.prototype.escape = (string) => string;
 const turndownService = new TurndownService({ emDelimiter: "\*", codeBlockStyle: "fenced", headingStyle: "atx", br: "", }); turndownService.addRule("style", { filter: "style", replacement() { return ""; }, }); turndownService.addRule("strikethrough", { filter: ["del", "s", "strike"], replacement(content) { return "~~" + content + "~~"; }, }); turndownService.addRule("links", { filter: ["a"], replacement(content, node) { if (node.href === content) { // Checks for raw links without custom text. return content; } if (node.childNodes.length === 1 && node.firstChild.nodeName === "IMG") { // ignore link's url if it only has an image return content; } return "[" + content + "](" + node.href + ")"; }, }); turndownService.addRule("listItem", { // We override the original upstream implementation of this rule // to have a custom indent of 2 spaces for list items, instead of // the default 4 spaces. Everything else is the same as upstream. filter: "li", replacement(content, node) { content = content .replace(/^\n+/, "") // remove leading newlines .replace(/\n+$/, "\n") // replace trailing newlines with just a single one .replaceAll(/\n/gm, "\n "); // custom 2 space indent let prefix = "\* "; const parent = node.parentNode; if (parent.nodeName === "OL") { const start = parent.getAttribute("start"); const index = Array.prototype.indexOf.call(parent.children, node); prefix = (start ? Number(start) + index : index + 1) + ". "; } return prefix + content + (node.nextSibling && !/\n$/.test(content) ? "\n" : ""); }, }); turndownService.addRule("zulipCodeBlock", { // We create a new rule to exclusively handle code blocks in Zulip messages since // the `fencedCodeBlock` rule in upstream won't work for them. The reason is that // `fencedCodeBlock` only works for `pre` elements that have `code` elements as // their 1st child, while Zulip code blocks have an empty span as the 1st child // of the `pre` element, and then the `code` element. This new rule is a variation // of upstream's `fencedCodeBlock` rule.
 // We modify the filter of upstream's `fencedCodeBlock` rule to only apply to // Zulip code blocks with the Zulip specific class of `zulip-code-block`. filter(node, options) { return ( options.codeBlockStyle === "fenced" && node.nodeName === "CODE" && node.parentElement?.nodeName === "PRE" && node.parentElement.parentElement?.classList.contains("zulip-code-block") ); },
 // We modify the replacement of upstream's `fencedCodeBlock` rule only slightly // to extract and add the language of the code block (if any) to the fence. replacement(content, node, options) { const language = node.closest(".codehilite")?.dataset?.codeLanguage || "";
 const fenceChar = options.fence.charAt(0); let fenceSize = 3; const fenceInCodeRegex = new RegExp("^" + fenceChar + "{3,}", "gm");
 let match; while ((match = fenceInCodeRegex.exec(content))) { if (match[0].length >= fenceSize) { fenceSize = match[0].length + 1; } }
 const fence = fenceChar.repeat(fenceSize);
 return ( "\n\n" + fence + language + "\n" + content.replace(/\n$/, "") + "\n" + fence + "\n\n" ); }, }); turndownService.addRule("zulipImagePreview", { filter(node) { // select image previews in Zulip messages return ( node.classList.contains("message\_inline\_image") && node.firstChild.nodeName === "A" ); },
 replacement(content, node) { // We parse the copied html to then check if the generating link (which, if // present, always comes before the preview in the copied html) is also there.
 // If the preview has an aria-label, it means it does have a named link in the // message, and if the 1st element with the same image link in the copied html // does not have the `message\_inline\_image` class, it means it is the generating // link, and not the preview, meaning the generating link is copied as well. const copied\_html = new DOMParser().parseFromString(paste\_html, "text/html"); if ( node.firstChild.hasAttribute("aria-label") && !copied\_html .querySelector("a[href='" + node.firstChild.getAttribute("href") + "']") ?.parentNode?.classList.contains("message\_inline\_image") ) { // We skip previews which have their generating link copied too, to avoid // double pasting the same link. return ""; } return image\_to\_zulip\_markdown(content, node.firstChild); }, }); turndownService.addRule("images", { filter: "img",
 replacement: image\_to\_zulip\_markdown, }); turndownService.addRule("math", { // We don't have a way to get the original LaTeX code from the rendered // `math` so we drop it to avoid pasting gibberish. // In the future, we could have a data-original-latex feature in Zulip HTML // if we wanted to paste the original LaTeX for Zulip messages. filter: "math",
 replacement() { return ""; }, });
 let markdown\_text = turndownService.turndown(paste\_html);
 // Checks for escaped ordered list syntax. markdown\_text = markdown\_text.replaceAll(/^(\W\* {0,3})(\d+)\\\. /gm, "$1$2. ");
 // Removes newlines before the start of a list and between list elements. markdown\_text = markdown\_text.replaceAll(/\n+([\*+-])/g, "\n$1"); return markdown\_text;}
function is\_safe\_url\_paste\_target($textarea) { const range = $textarea.range();
 if (!range.text) { // No range is selected return false; }
 if (isUrl(range.text.trim())) { // Don't engage our URL paste logic over existing URLs return false; }
 if (range.start <= 2) { // The range opens too close to the start of the textarea // to have to worry about Markdown link syntax return true; }
 // Look at the two characters before the start of the original // range in search of the tell-tale `](` from existing Markdown // link syntax const possible\_markdown\_link\_markers = $textarea[0].value.slice(range.start - 2, range.start);
 if (possible\_markdown\_link\_markers === "](") { return false; }
 return true;}
export function paste\_handler(event) { const clipboardData = event.originalEvent.clipboardData; if (!clipboardData) { // On IE11, ClipboardData isn't defined. One can instead // access it with `window.clipboardData`, but even that // doesn't support text/html, so this code path couldn't do // anything special anyway. So we instead just let the // default paste handler run on IE11. return; }
 if (clipboardData.getData) { const $textarea = $(event.currentTarget); const paste\_text = clipboardData.getData("text"); const paste\_html = clipboardData.getData("text/html"); // Trim the paste\_text to accommodate sloppy copying const trimmed\_paste\_text = paste\_text.trim();
 // Only intervene to generate formatted links when dealing // with a URL and a URL-safe range selection. if (isUrl(trimmed\_paste\_text) && is\_safe\_url\_paste\_target($textarea)) { event.preventDefault(); event.stopPropagation(); const url = trimmed\_paste\_text; compose\_ui.format\_text($textarea, "linked", url); return; }
 // We do not paste formatted markdoown when inside a code block. // Unlike Chrome, Firefox doesn't automatically paste plainly on using Ctrl+Shift+V, // hence we need to handle it ourselves, by checking if shift key is pressed, and only // if not, we proceed with the default formatted paste. if ( !compose\_ui.cursor\_inside\_code\_block($textarea) && paste\_html && !compose\_ui.shift\_pressed && page\_params.development\_environment ) { event.preventDefault(); event.stopPropagation(); const text = paste\_handler\_converter(paste\_html); compose\_ui.insert\_and\_scroll\_into\_view(text, $textarea); } }}
export function initialize() { $("textarea#compose-textarea").on("paste", paste\_handler); $("body").on("paste", ".message\_edit\_content", paste\_handler);}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_fc7ad711_20250114_183019.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F64720d2aa5afd943eb7e5a1ed4808ad6)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F64720d2aa5afd943eb7e5a1ed4808ad6&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F64720d2aa5afd943eb7e5a1ed4808ad6) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F64720d2aa5afd943eb7e5a1ed4808ad6&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@1047524396](https://avatars.githubusercontent.com/u/77877041?s=64&v=4)](/1047524396)

# [1047524396](/1047524396)/**[CVE-2024-36624](/1047524396/64720d2aa5afd943eb7e5a1ed4808ad6)**

Last active
November 29, 2024 04:39

Show Gist options

* [Download ZIP](/1047524396/64720d2aa5afd943eb7e5a1ed4808ad6/archive/92df83594e1240bf9c6baf0b3190e00f16402c55.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F64720d2aa5afd943eb7e5a1ed4808ad6)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F64720d2aa5afd943eb7e5a1ed4808ad6)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/1047524396/64720d2aa5afd943eb7e5a1ed4808ad6.js&quot;&gt;&lt;/script&gt;
* Save 1047524396/64720d2aa5afd943eb7e5a1ed4808ad6 to your computer and use it in GitHub Desktop.

[Code](/1047524396/64720d2aa5afd943eb7e5a1ed4808ad6)
[Revisions
2](/1047524396/64720d2aa5afd943eb7e5a1ed4808ad6/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/1047524396/64720d2aa5afd943eb7e5a1ed4808ad6.js&quot;&gt;&lt;/script&gt;

Save 1047524396/64720d2aa5afd943eb7e5a1ed4808ad6 to your computer and use it in GitHub Desktop.

[Download ZIP](/1047524396/64720d2aa5afd943eb7e5a1ed4808ad6/archive/92df83594e1240bf9c6baf0b3190e00f16402c55.zip)

CVE-2024-36624

 [Raw](/1047524396/64720d2aa5afd943eb7e5a1ed4808ad6/raw/92df83594e1240bf9c6baf0b3190e00f16402c55/CVE-2024-36624)

[**CVE-2024-36624**](#file-cve-2024-36624)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | [CVE ID] |
| --- | --- |
|  | CVE-2024-36624 |
|  | [PRODUCT] |
|  | zulip |
|  | [VERSION] |
|  | 8.3 |
|  | [PROBLEM TYPE] |
|  | Cross Site Scripting (XSS) |
|  | [DESCRIPTION] |
|  | Zulip 8.3 is vulnerable to Cross Site Scripting (XSS) via the construct\_copy\_div function in copy\_and\_paste.js. |
|  | [PATCH LINK] |
|  | https://github.com/zulip/zulip/commit/e1029b59ede0c4f314c367ffa1ba2904ffaf6768 |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F64720d2aa5afd943eb7e5a1ed4808ad6)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_aa06b865_20250114_183022.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2Fe1029b59ede0c4f314c367ffa1ba2904ffaf6768)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2Fe1029b59ede0c4f314c367ffa1ba2904ffaf6768)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=zulip%2Fzulip)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zulip](/zulip)
/
**[zulip](/zulip/zulip)**
Public

* [Notifications](/login?return_to=%2Fzulip%2Fzulip) You must be signed in to change notification settings
* [Fork
  8.1k](/login?return_to=%2Fzulip%2Fzulip)
* [Star
   22k](/login?return_to=%2Fzulip%2Fzulip)

* [Code](/zulip/zulip)
* [Issues
  1.6k](/zulip/zulip/issues)
* [Pull requests
  886](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects
  2](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

Additional navigation options

* [Code](/zulip/zulip)
* [Issues](/zulip/zulip/issues)
* [Pull requests](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

## Commit

[Permalink](/zulip/zulip/commit/e1029b59ede0c4f314c367ffa1ba2904ffaf6768)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

copy\_and\_paste: Fix HTML injection bug in construct\_copy\_div.

[Browse files](/zulip/zulip/tree/e1029b59ede0c4f314c367ffa1ba2904ffaf6768)
Browse the repository at this point in the history

```
Signed-off-by: Anders Kaseorg <anders@zulip.com>
```

* Loading branch information

[![@andersk](https://avatars.githubusercontent.com/u/26471?s=40&v=4)](/andersk) [![@timabbott](https://avatars.githubusercontent.com/u/2746074?s=40&v=4)](/timabbott)

[andersk](/zulip/zulip/commits?author=andersk "View all commits by andersk")
authored and
[timabbott](/zulip/zulip/commits?author=timabbott "View all commits by timabbott")
committed
Apr 3, 2024

1 parent
[25ff0d4](/zulip/zulip/commit/25ff0d441858aa5c8f0bf51b47ad2a872141c262)

commit e1029b5

Showing
**1 changed file**
with
**5 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 5 additions & 1 deletion

6
[web/src/copy\_and\_paste.js](#diff-0bd9a2a367bfa033dc227adab33c0116bf7017acebf526f092bef6e2c9be0d7b "web/src/copy_and_paste.js")

Show comments

[View file](/zulip/zulip/blob/e1029b59ede0c4f314c367ffa1ba2904ffaf6768/web/src/copy_and_paste.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -90,7 +90,11 @@ function construct\_copy\_div($div, start\_id, end\_id) { |
|  |  | } |
|  |  | const message = message\_lists.current.get(rows.id($row)); |
|  |  | const $content = $(message.content); |
|  |  | $content.first().prepend(message.sender\_full\_name + ": "); |
|  |  | $content.first().prepend( |
|  |  | $("<span>") |
|  |  | .text(message.sender\_full\_name + ": ") |
|  |  | .contents(), |
|  |  | ); |
|  |  | $div.append($content); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e1029b5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2Fe1029b59ede0c4f314c367ffa1ba2904ffaf6768) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


