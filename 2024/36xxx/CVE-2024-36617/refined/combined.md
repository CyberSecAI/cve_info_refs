=== Content from github.com_1f567f71_20250115_094738.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fblob%2Fn6.1.1%2Flibavformat%2Fcafdec.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fblob%2Fn6.1.1%2Flibavformat%2Fcafdec.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=FFmpeg%2FFFmpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FFmpeg](/FFmpeg)
/
**[FFmpeg](/FFmpeg/FFmpeg)**
Public

* [Notifications](/login?return_to=%2FFFmpeg%2FFFmpeg) You must be signed in to change notification settings
* [Fork
  12.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)
* [Star
   47.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)

* [Code](/FFmpeg/FFmpeg/tree/n6.1.1)
* [Pull requests
  1](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

Additional navigation options

* [Code](/FFmpeg/FFmpeg/tree/n6.1.1)
* [Pull requests](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

## Files

 n6.1.1
## Breadcrumbs

1. [FFmpeg](/FFmpeg/FFmpeg/tree/n6.1.1)
2. /[libavformat](/FFmpeg/FFmpeg/tree/n6.1.1/libavformat)
/
# cafdec.c

Copy path Blame  Blame
## Latest commit

## History

[History](/FFmpeg/FFmpeg/commits/n6.1.1/libavformat/cafdec.c)524 lines (459 loc) · 18.2 KB n6.1.1
## Breadcrumbs

1. [FFmpeg](/FFmpeg/FFmpeg/tree/n6.1.1)
2. /[libavformat](/FFmpeg/FFmpeg/tree/n6.1.1/libavformat)
/
# cafdec.c

Top
## File metadata and controls

* Code
* Blame

524 lines (459 loc) · 18.2 KB[Raw](https://github.com/FFmpeg/FFmpeg/raw/refs/tags/n6.1.1/libavformat/cafdec.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524/\* \* Core Audio Format demuxer \* Copyright (c) 2007 Justin Ruggles \* Copyright (c) 2009 Peter Ross \* \* This file is part of FFmpeg. \* \* FFmpeg is free software; you can redistribute it and/or \* modify it under the terms of the GNU Lesser General Public \* License as published by the Free Software Foundation; either \* version 2.1 of the License, or (at your option) any later version. \* \* FFmpeg is distributed in the hope that it will be useful, \* but WITHOUT ANY WARRANTY; without even the implied warranty of \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU \* Lesser General Public License for more details. \* \* You should have received a copy of the GNU Lesser General Public \* License along with FFmpeg; if not, write to the Free Software \* Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA \*/
/\*\* \* @file \* Core Audio Format demuxer \*/
#include <inttypes.h>
#include "avformat.h"#include "demux.h"#include "internal.h"#include "isom.h"#include "mov\_chan.h"#include "libavcodec/flac.h"#include "libavutil/intreadwrite.h"#include "libavutil/intfloat.h"#include "libavutil/dict.h"#include "caf.h"
typedef struct CafContext { int bytes\_per\_packet; ///< bytes in a packet, or 0 if variable int frames\_per\_packet; ///< frames in a packet, or 0 if variable int64\_t num\_bytes; ///< total number of bytes in stream
 int64\_t packet\_cnt; ///< packet counter int64\_t frame\_cnt; ///< frame counter
 int64\_t data\_start; ///< data start position, in bytes int64\_t data\_size; ///< raw data size, in bytes} CafContext;
static int probe(const AVProbeData \*p){ if (AV\_RB32(p->buf) != MKBETAG('c','a','f','f')) return 0; if (AV\_RB16(&p->buf[4]) != 1) return 0; if (AV\_RB32(p->buf + 8) != MKBETAG('d','e','s','c')) return 0; if (AV\_RB64(p->buf + 12) != 32) return 0; return AVPROBE\_SCORE\_MAX;}
/\*\* Read audio description chunk \*/static int read\_desc\_chunk(AVFormatContext \*s){ AVIOContext \*pb = s->pb; CafContext \*caf = s->priv\_data; AVStream \*st; int flags;
 /\* new audio stream \*/ st = avformat\_new\_stream(s, NULL); if (!st) return AVERROR(ENOMEM);
 /\* parse format description \*/ st->codecpar->codec\_type = AVMEDIA\_TYPE\_AUDIO; st->codecpar->sample\_rate = av\_clipd(av\_int2double(avio\_rb64(pb)), 0, INT\_MAX); st->codecpar->codec\_tag = avio\_rl32(pb); flags = avio\_rb32(pb); caf->bytes\_per\_packet = avio\_rb32(pb); st->codecpar->block\_align = caf->bytes\_per\_packet; caf->frames\_per\_packet = avio\_rb32(pb); st->codecpar->ch\_layout.nb\_channels = avio\_rb32(pb); st->codecpar->bits\_per\_coded\_sample = avio\_rb32(pb);
 if (caf->bytes\_per\_packet < 0 || caf->frames\_per\_packet < 0 || st->codecpar->ch\_layout.nb\_channels < 0) return AVERROR\_INVALIDDATA;
 /\* calculate bit rate for constant size packets \*/ if (caf->frames\_per\_packet > 0 && caf->bytes\_per\_packet > 0) { st->codecpar->bit\_rate = (uint64\_t)st->codecpar->sample\_rate \* (uint64\_t)caf->bytes\_per\_packet \* 8 / (uint64\_t)caf->frames\_per\_packet; } else { st->codecpar->bit\_rate = 0; }
 /\* determine codec \*/ if (st->codecpar->codec\_tag == MKTAG('l','p','c','m')) st->codecpar->codec\_id = ff\_mov\_get\_lpcm\_codec\_id(st->codecpar->bits\_per\_coded\_sample, (flags ^ 0x2) | 0x4); else st->codecpar->codec\_id = ff\_codec\_get\_id(ff\_codec\_caf\_tags, st->codecpar->codec\_tag); return 0;}
/\*\* Read magic cookie chunk \*/static int read\_kuki\_chunk(AVFormatContext \*s, int64\_t size){ AVIOContext \*pb = s->pb; AVStream \*st = s->streams[0]; int ret;
 if (size < 0 || size > INT\_MAX - AV\_INPUT\_BUFFER\_PADDING\_SIZE) return -1;
 if (st->codecpar->codec\_id == AV\_CODEC\_ID\_AAC) { /\* The magic cookie format for AAC is an mp4 esds atom. The lavc AAC decoder requires the data from the codec specific description as extradata input. \*/ int strt, skip;
 strt = avio\_tell(pb); ff\_mov\_read\_esds(s, pb); skip = size - (avio\_tell(pb) - strt); if (skip < 0 || !st->codecpar->extradata || st->codecpar->codec\_id != AV\_CODEC\_ID\_AAC) { av\_log(s, AV\_LOG\_ERROR, "invalid AAC magic cookie\n"); return AVERROR\_INVALIDDATA; } avio\_skip(pb, skip); } else if (st->codecpar->codec\_id == AV\_CODEC\_ID\_ALAC) {#define ALAC\_PREAMBLE 12#define ALAC\_HEADER 36#define ALAC\_NEW\_KUKI 24 uint8\_t preamble[12]; if (size < ALAC\_NEW\_KUKI) { av\_log(s, AV\_LOG\_ERROR, "invalid ALAC magic cookie\n"); avio\_skip(pb, size); return AVERROR\_INVALIDDATA; } if (avio\_read(pb, preamble, ALAC\_PREAMBLE) != ALAC\_PREAMBLE) { av\_log(s, AV\_LOG\_ERROR, "failed to read preamble\n"); return AVERROR\_INVALIDDATA; }
 if ((ret = ff\_alloc\_extradata(st->codecpar, ALAC\_HEADER)) < 0) return ret;
 /\* For the old style cookie, we skip 12 bytes, then read 36 bytes. \* The new style cookie only contains the last 24 bytes of what was \* 36 bytes in the old style cookie, so we fabricate the first 12 bytes \* in that case to maintain compatibility. \*/ if (!memcmp(&preamble[4], "frmaalac", 8)) { if (size < ALAC\_PREAMBLE + ALAC\_HEADER) { av\_log(s, AV\_LOG\_ERROR, "invalid ALAC magic cookie\n"); av\_freep(&st->codecpar->extradata); return AVERROR\_INVALIDDATA; } if (avio\_read(pb, st->codecpar->extradata, ALAC\_HEADER) != ALAC\_HEADER) { av\_log(s, AV\_LOG\_ERROR, "failed to read kuki header\n"); av\_freep(&st->codecpar->extradata); return AVERROR\_INVALIDDATA; } avio\_skip(pb, size - ALAC\_PREAMBLE - ALAC\_HEADER); } else { AV\_WB32(st->codecpar->extradata, 36); memcpy(&st->codecpar->extradata[4], "alac", 4); AV\_WB32(&st->codecpar->extradata[8], 0); memcpy(&st->codecpar->extradata[12], preamble, 12); if (avio\_read(pb, &st->codecpar->extradata[24], ALAC\_NEW\_KUKI - 12) != ALAC\_NEW\_KUKI - 12) { av\_log(s, AV\_LOG\_ERROR, "failed to read new kuki header\n"); av\_freep(&st->codecpar->extradata); return AVERROR\_INVALIDDATA; } avio\_skip(pb, size - ALAC\_NEW\_KUKI); } } else if (st->codecpar->codec\_id == AV\_CODEC\_ID\_FLAC) { int last, type, flac\_metadata\_size; uint8\_t buf[4]; /\* The magic cookie format for FLAC consists mostly of an mp4 dfLa atom. \*/ if (size < (16 + FLAC\_STREAMINFO\_SIZE)) { av\_log(s, AV\_LOG\_ERROR, "invalid FLAC magic cookie\n"); return AVERROR\_INVALIDDATA; } /\* Check cookie version. \*/ if (avio\_r8(pb) != 0) { av\_log(s, AV\_LOG\_ERROR, "unknown FLAC magic cookie\n"); return AVERROR\_INVALIDDATA; } avio\_rb24(pb); /\* Flags \*/ /\* read dfLa fourcc \*/ if (avio\_read(pb, buf, 4) != 4) { av\_log(s, AV\_LOG\_ERROR, "failed to read FLAC magic cookie\n"); return pb->error < 0 ? pb->error : AVERROR\_INVALIDDATA; } if (memcmp(buf, "dfLa", 4)) { av\_log(s, AV\_LOG\_ERROR, "invalid FLAC magic cookie\n"); return AVERROR\_INVALIDDATA; } /\* Check dfLa version. \*/ if (avio\_r8(pb) != 0) { av\_log(s, AV\_LOG\_ERROR, "unknown dfLa version\n"); return AVERROR\_INVALIDDATA; } avio\_rb24(pb); /\* Flags \*/ if (avio\_read(pb, buf, sizeof(buf)) != sizeof(buf)) { av\_log(s, AV\_LOG\_ERROR, "failed to read FLAC metadata block header\n"); return pb->error < 0 ? pb->error : AVERROR\_INVALIDDATA; } flac\_parse\_block\_header(buf, &last, &type, &flac\_metadata\_size); if (type != FLAC\_METADATA\_TYPE\_STREAMINFO || flac\_metadata\_size != FLAC\_STREAMINFO\_SIZE) { av\_log(s, AV\_LOG\_ERROR, "STREAMINFO must be first FLACMetadataBlock\n"); return AVERROR\_INVALIDDATA; } ret = ff\_get\_extradata(s, st->codecpar, pb, FLAC\_STREAMINFO\_SIZE); if (ret < 0) return ret; if (!last) av\_log(s, AV\_LOG\_WARNING, "non-STREAMINFO FLACMetadataBlock(s) ignored\n"); } else if (st->codecpar->codec\_id == AV\_CODEC\_ID\_OPUS) { // The data layout for Opus is currently unknown, so we do not export // extradata at all. Multichannel streams are not supported. if (st->codecpar->ch\_layout.nb\_channels > 2) { avpriv\_request\_sample(s, "multichannel Opus in CAF"); return AVERROR\_PATCHWELCOME; } avio\_skip(pb, size); } else if ((ret = ff\_get\_extradata(s, st->codecpar, pb, size)) < 0) { return ret; }
 return 0;}
/\*\* Read packet table chunk \*/static int read\_pakt\_chunk(AVFormatContext \*s, int64\_t size){ AVIOContext \*pb = s->pb; AVStream \*st = s->streams[0]; CafContext \*caf = s->priv\_data; int64\_t pos = 0, ccount, num\_packets; int i; int ret;
 ccount = avio\_tell(pb);
 num\_packets = avio\_rb64(pb); if (num\_packets < 0 || INT32\_MAX / sizeof(AVIndexEntry) < num\_packets) return AVERROR\_INVALIDDATA;
 st->nb\_frames = avio\_rb64(pb); /\* valid frames \*/ st->nb\_frames += avio\_rb32(pb); /\* priming frames \*/ st->nb\_frames += avio\_rb32(pb); /\* remainder frames \*/
 if (caf->bytes\_per\_packet > 0 && caf->frames\_per\_packet > 0) { st->duration = caf->frames\_per\_packet \* num\_packets; pos = caf-> bytes\_per\_packet \* num\_packets; } else { st->duration = 0; for (i = 0; i < num\_packets; i++) { if (avio\_feof(pb)) return AVERROR\_INVALIDDATA; ret = av\_add\_index\_entry(s->streams[0], pos, st->duration, 0, 0, AVINDEX\_KEYFRAME); if (ret < 0) return ret; pos += caf->bytes\_per\_packet ? caf->bytes\_per\_packet : ff\_mp4\_read\_descr\_len(pb); st->duration += caf->frames\_per\_packet ? caf->frames\_per\_packet : ff\_mp4\_read\_descr\_len(pb); } }
 if (avio\_tell(pb) - ccount > size) { av\_log(s, AV\_LOG\_ERROR, "error reading packet table\n"); return AVERROR\_INVALIDDATA; } avio\_seek(pb, ccount + size, SEEK\_SET);
 caf->num\_bytes = pos; return 0;}
/\*\* Read information chunk \*/static void read\_info\_chunk(AVFormatContext \*s, int64\_t size){ AVIOContext \*pb = s->pb; unsigned int i; unsigned int nb\_entries = avio\_rb32(pb); for (i = 0; i < nb\_entries && !avio\_feof(pb); i++) { char key[32]; char value[1024]; avio\_get\_str(pb, INT\_MAX, key, sizeof(key)); avio\_get\_str(pb, INT\_MAX, value, sizeof(value)); if (!\*key) continue; av\_dict\_set(&s->metadata, key, value, 0); }}
static int read\_header(AVFormatContext \*s){ AVIOContext \*pb = s->pb; CafContext \*caf = s->priv\_data; AVStream \*st; uint32\_t tag = 0; int found\_data, ret; int64\_t size, pos;
 avio\_skip(pb, 8); /\* magic, version, file flags \*/
 /\* audio description chunk \*/ if (avio\_rb32(pb) != MKBETAG('d','e','s','c')) { av\_log(s, AV\_LOG\_ERROR, "desc chunk not present\n"); return AVERROR\_INVALIDDATA; } size = avio\_rb64(pb); if (size != 32) return AVERROR\_INVALIDDATA;
 ret = read\_desc\_chunk(s); if (ret) return ret; st = s->streams[0];
 /\* parse each chunk \*/ found\_data = 0; while (!avio\_feof(pb)) {
 /\* stop at data chunk if seeking is not supported or data chunk size is unknown \*/ if (found\_data && (caf->data\_size < 0 || !(pb->seekable & AVIO\_SEEKABLE\_NORMAL))) break;
 tag = avio\_rb32(pb); size = avio\_rb64(pb); pos = avio\_tell(pb); if (avio\_feof(pb)) break;
 switch (tag) { case MKBETAG('d','a','t','a'): avio\_skip(pb, 4); /\* edit count \*/ caf->data\_start = avio\_tell(pb); caf->data\_size = size < 0 ? -1 : size - 4; if (caf->data\_size > 0 && (pb->seekable & AVIO\_SEEKABLE\_NORMAL)) avio\_skip(pb, caf->data\_size); found\_data = 1; break;
 case MKBETAG('c','h','a','n'): if ((ret = ff\_mov\_read\_chan(s, s->pb, st, size)) < 0) return ret; break;
 /\* magic cookie chunk \*/ case MKBETAG('k','u','k','i'): if (read\_kuki\_chunk(s, size)) return AVERROR\_INVALIDDATA; break;
 /\* packet table chunk \*/ case MKBETAG('p','a','k','t'): if (read\_pakt\_chunk(s, size)) return AVERROR\_INVALIDDATA; break;
 case MKBETAG('i','n','f','o'): read\_info\_chunk(s, size); break;
 default: av\_log(s, AV\_LOG\_WARNING, "skipping CAF chunk: %08"PRIX32" (%s), size %"PRId64"\n", tag, av\_fourcc2str(av\_bswap32(tag)), size); case MKBETAG('f','r','e','e'): if (size < 0 && found\_data) goto found\_data; if (size < 0) return AVERROR\_INVALIDDATA; break; }
 if (size > 0 && (pb->seekable & AVIO\_SEEKABLE\_NORMAL)) { if (pos > INT64\_MAX - size) return AVERROR\_INVALIDDATA; avio\_seek(pb, pos + size, SEEK\_SET); } }
 if (!found\_data) return AVERROR\_INVALIDDATA;
found\_data: if (caf->bytes\_per\_packet > 0 && caf->frames\_per\_packet > 0) { if (caf->data\_size > 0 && caf->data\_size / caf->bytes\_per\_packet < INT64\_MAX / caf->frames\_per\_packet) st->nb\_frames = (caf->data\_size / caf->bytes\_per\_packet) \* caf->frames\_per\_packet; } else if (ffstream(st)->nb\_index\_entries && st->duration > 0) { if (st->codecpar->sample\_rate && caf->data\_size / st->duration > INT64\_MAX / st->codecpar->sample\_rate / 8) { av\_log(s, AV\_LOG\_ERROR, "Overflow during bit rate calculation %d \* 8 \* %"PRId64"\n", st->codecpar->sample\_rate, caf->data\_size / st->duration); return AVERROR\_INVALIDDATA; } st->codecpar->bit\_rate = st->codecpar->sample\_rate \* 8LL \* (caf->data\_size / st->duration); } else { av\_log(s, AV\_LOG\_ERROR, "Missing packet table. It is required when " "block size or frame size are variable.\n"); return AVERROR\_INVALIDDATA; }
 avpriv\_set\_pts\_info(st, 64, 1, st->codecpar->sample\_rate); st->start\_time = 0;
 /\* position the stream at the start of data \*/ if (caf->data\_size >= 0) avio\_seek(pb, caf->data\_start, SEEK\_SET);
 return 0;}
#define CAF\_MAX\_PKT\_SIZE 4096
static int read\_packet(AVFormatContext \*s, AVPacket \*pkt){ AVIOContext \*pb = s->pb; AVStream \*st = s->streams[0]; FFStream \*const sti = ffstream(st); CafContext \*caf = s->priv\_data; int res, pkt\_size = 0, pkt\_frames = 0; int64\_t left = CAF\_MAX\_PKT\_SIZE;
 if (avio\_feof(pb)) return AVERROR\_EOF;
 /\* don't read past end of data chunk \*/ if (caf->data\_size > 0) { left = (caf->data\_start + caf->data\_size) - avio\_tell(pb); if (!left) return AVERROR\_EOF; if (left < 0) return AVERROR(EIO); }
 pkt\_frames = caf->frames\_per\_packet; pkt\_size = caf->bytes\_per\_packet;
 if (pkt\_size > 0 && pkt\_frames == 1) { pkt\_size = (CAF\_MAX\_PKT\_SIZE / pkt\_size) \* pkt\_size; pkt\_size = FFMIN(pkt\_size, left); pkt\_frames = pkt\_size / caf->bytes\_per\_packet; } else if (sti->nb\_index\_entries) { if (caf->packet\_cnt < sti->nb\_index\_entries - 1) { pkt\_size = sti->index\_entries[caf->packet\_cnt + 1].pos - sti->index\_entries[caf->packet\_cnt].pos; pkt\_frames = sti->index\_entries[caf->packet\_cnt + 1].timestamp - sti->index\_entries[caf->packet\_cnt].timestamp; } else if (caf->packet\_cnt == sti->nb\_index\_entries - 1) { pkt\_size = caf->num\_bytes - sti->index\_entries[caf->packet\_cnt].pos; pkt\_frames = st->duration - sti->index\_entries[caf->packet\_cnt].timestamp; } else { return AVERROR(EIO); } }
 if (pkt\_size == 0 || pkt\_frames == 0 || pkt\_size > left) return AVERROR(EIO);
 res = av\_get\_packet(pb, pkt, pkt\_size); if (res < 0) return res;
 pkt->size = res; pkt->stream\_index = 0; pkt->dts = pkt->pts = caf->frame\_cnt;
 caf->packet\_cnt++; caf->frame\_cnt += pkt\_frames;
 return 0;}
static int read\_seek(AVFormatContext \*s, int stream\_index, int64\_t timestamp, int flags){ AVStream \*st = s->streams[0]; FFStream \*const sti = ffstream(st); CafContext \*caf = s->priv\_data; int64\_t pos, packet\_cnt, frame\_cnt;
 timestamp = FFMAX(timestamp, 0);
 if (caf->frames\_per\_packet > 0 && caf->bytes\_per\_packet > 0) { /\* calculate new byte position based on target frame position \*/ pos = caf->bytes\_per\_packet \* (timestamp / caf->frames\_per\_packet); if (caf->data\_size > 0) pos = FFMIN(pos, caf->data\_size); packet\_cnt = pos / caf->bytes\_per\_packet; frame\_cnt = caf->frames\_per\_packet \* packet\_cnt; } else if (sti->nb\_index\_entries) { packet\_cnt = av\_index\_search\_timestamp(st, timestamp, flags); frame\_cnt = sti->index\_entries[packet\_cnt].timestamp; pos = sti->index\_entries[packet\_cnt].pos; } else { return -1; }
 if (avio\_seek(s->pb, pos + caf->data\_start, SEEK\_SET) < 0) return -1;
 caf->packet\_cnt = packet\_cnt; caf->frame\_cnt = frame\_cnt;
 return 0;}
const AVInputFormat ff\_caf\_demuxer = { .name = "caf", .long\_name = NULL\_IF\_CONFIG\_SMALL("Apple CAF (Core Audio Format)"), .priv\_data\_size = sizeof(CafContext), .read\_probe = probe, .read\_header = read\_header, .read\_packet = read\_packet, .read\_seek = read\_seek, .codec\_tag = ff\_caf\_codec\_tags\_list,};

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_19213a4e_20250115_094739.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2Fd973fcbcc2f944752ff10e6a76b0b2d9329937a7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2Fd973fcbcc2f944752ff10e6a76b0b2d9329937a7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=FFmpeg%2FFFmpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FFmpeg](/FFmpeg)
/
**[FFmpeg](/FFmpeg/FFmpeg)**
Public

* [Notifications](/login?return_to=%2FFFmpeg%2FFFmpeg) You must be signed in to change notification settings
* [Fork
  12.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)
* [Star
   47.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)

* [Code](/FFmpeg/FFmpeg)
* [Pull requests
  1](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

Additional navigation options

* [Code](/FFmpeg/FFmpeg)
* [Pull requests](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

## Commit

[Permalink](/FFmpeg/FFmpeg/commit/d973fcbcc2f944752ff10e6a76b0b2d9329937a7)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

avformat/cafdec: dont seek beyond 64bit

[Browse files](/FFmpeg/FFmpeg/tree/d973fcbcc2f944752ff10e6a76b0b2d9329937a7)
Browse the repository at this point in the history

```
Fixes: signed integer overflow: 64 + 9223372036854775807 cannot be represented in type 'long long'
Fixes: 51896/clusterfuzz-testcase-minimized-ffmpeg_dem_CAF_fuzzer-6418242730328064
Fixes: 62276/clusterfuzz-testcase-minimized-ffmpeg_dem_CAF_fuzzer-6418242730328064

Found-by: continuous fuzzing process <https://github.com/google/oss-fuzz/tree/master/projects/ffmpeg>
Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>
```

* Loading branch information

[![@michaelni](https://avatars.githubusercontent.com/u/729390?s=40&v=4)](/michaelni)

[michaelni](/FFmpeg/FFmpeg/commits?author=michaelni "View all commits by michaelni")
committed
Mar 25, 2024

1 parent
[d384af5](/FFmpeg/FFmpeg/commit/d384af52261ff01ee35c05d46303d617de5305bb)

commit d973fcb

Showing
**1 changed file**
with
**1 addition**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[libavformat/cafdec.c](#diff-713c411bd171384f26c29fbffbb1407de7dc514216694aa9605e6ce3a09af86a "libavformat/cafdec.c")

Show comments

[View file](/FFmpeg/FFmpeg/blob/d973fcbcc2f944752ff10e6a76b0b2d9329937a7/libavformat/cafdec.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -271,7 +271,7 @@ static int read\_pakt\_chunk(AVFormatContext \*s, int64\_t size) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (avio\_tell(pb) - ccount > size) { |
|  |  | if (avio\_tell(pb) - ccount > size || size > INT64\_MAX - ccount) { |
|  |  | av\_log(s, AV\_LOG\_ERROR, "error reading packet table\n"); |
|  |  | return AVERROR\_INVALIDDATA; |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d973fcb`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2Fd973fcbcc2f944752ff10e6a76b0b2d9329937a7) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_f40f3406_20250115_094735.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2Ff20749f8addc8f86de9cfacf17ba29df)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2Ff20749f8addc8f86de9cfacf17ba29df&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2Ff20749f8addc8f86de9cfacf17ba29df) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2Ff20749f8addc8f86de9cfacf17ba29df&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@1047524396](https://avatars.githubusercontent.com/u/77877041?s=64&v=4)](/1047524396)

# [1047524396](/1047524396)/**[CVE-2024-36617](/1047524396/f20749f8addc8f86de9cfacf17ba29df)**

Created
November 29, 2024 04:27

Show Gist options

* [Download ZIP](/1047524396/f20749f8addc8f86de9cfacf17ba29df/archive/69530971f193693e31090a3072f29ec5d706b530.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2Ff20749f8addc8f86de9cfacf17ba29df)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2Ff20749f8addc8f86de9cfacf17ba29df)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/1047524396/f20749f8addc8f86de9cfacf17ba29df.js&quot;&gt;&lt;/script&gt;
* Save 1047524396/f20749f8addc8f86de9cfacf17ba29df to your computer and use it in GitHub Desktop.

[Code](/1047524396/f20749f8addc8f86de9cfacf17ba29df)
[Revisions
1](/1047524396/f20749f8addc8f86de9cfacf17ba29df/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/1047524396/f20749f8addc8f86de9cfacf17ba29df.js&quot;&gt;&lt;/script&gt;

Save 1047524396/f20749f8addc8f86de9cfacf17ba29df to your computer and use it in GitHub Desktop.

[Download ZIP](/1047524396/f20749f8addc8f86de9cfacf17ba29df/archive/69530971f193693e31090a3072f29ec5d706b530.zip)

CVE-2024-36617

 [Raw](/1047524396/f20749f8addc8f86de9cfacf17ba29df/raw/69530971f193693e31090a3072f29ec5d706b530/CVE-2024-36617)

[**CVE-2024-36617**](#file-cve-2024-36617)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | [CVE ID] |
| --- | --- |
|  | CVE-2024-36617 |
|  | [PRODUCT] |
|  | FFmpeg |
|  | [VERSION] |
|  | n6.1.1 |
|  | [PROBLEM TYPE] |
|  | Integer Overflow |
|  | [DESCRIPTION] |
|  | FFmpeg n6.1.1 has an integer overflow vulnerability in the FFmpeg CAF decoder. |
|  | [PATCH LINK] |
|  | https://github.com/ffmpeg/ffmpeg/commit/d973fcbcc2f944752ff10e6a76b0b2d9329937a7 |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2Ff20749f8addc8f86de9cfacf17ba29df)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


