The provided content is related to CVE-2024-52293.

**Root cause of vulnerability:**
The vulnerability stems from a missing path normalization in the `FileHelper::absolutePath` function. This allows an attacker to bypass the `isSystemDir` check and create a local filesystem within the system directories. Specifically, the `absolutePath` function was returning `$from . $ds . $to` without normalizing the resulting path which can lead to directory traversal.

**Weaknesses/vulnerabilities present:**
- Missing path normalization in `FileHelper::absolutePath`.
- Incomplete Twig sandbox, allowing the use of functions like 'system' and 'passthru' via filters.
- Ability to bypass `isSystemDir` by crafting paths using directory traversal such as `../templates/poc`.
- Ability to create a local filesystem and asset volume within system directories.
- Resulting ability to upload a file containing Twig code and execute it via a new route.

**Impact of exploitation:**
- Remote Code Execution (RCE) on the server.
- Full control of the vulnerable system
- Potential data exfiltration, malware execution, and further attacks.

**Attack vectors:**
- Network-based attack.
- Exploitation occurs through a crafted path that bypasses security checks, followed by uploading a file with malicious Twig code.

**Required attacker capabilities/position:**
- Authenticated user with administrative privileges (`ALLOW_ADMIN_CHANGES=true`).
- Ability to create a new filesystem, asset volume, and route.
- Ability to upload a file.

**Technical Details:**
The vulnerability is a sequel to CVE-2023-40035.
The `FileHelper::absolutePath` function in `src/helpers/FileHelper.php` did not normalize the path after combining the from and to paths, returning `$from . $ds . $to`.
This could lead to multiple security risks, where `../templates/poc` was not considered a system dir when passed to `isSystemDir` because the `absolutePath` function call returned `/var/www/html/web//../templates/poc`
This allowed for bypassing `validatePath` function.
The attacker can then create a local filesystem within the system directories like `/var/www/html/templates/poc`.
After creating an asset volume using the crafted filesystem, attacker can upload a `poc.ttml` file containing malicious twig code.
The attacker can create a new route to execute the uploaded twig file.
The twig sandbox was incomplete and allowed for usage of functions such as `system` and `passthru` via `find` filter in twig.
The fix is to normalize the path after concatenation in `FileHelper::absolutePath` and adding more filters to the twig sandbox.
The vulnerability affects Craft CMS versions >= 4.0.0-RC1 and <= 4.12.1, and >= 5.0.0-RC1 and <= 5.4.2.
Patched versions are 4.12.2 and 5.4.3.
The CVSS score is 7.2 High.