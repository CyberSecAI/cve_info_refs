=== Content from lists.debian.org_4e726fa2_20250114_182811.html ===


---

[[Date Prev](msg00015.html)][[Date Next](msg00017.html)]
[[Thread Prev](msg00015.html)][[Thread Next](msg00017.html)]
[[Date Index](maillist.html#00016)]
[[Thread Index](threads.html#00016)]

# [SECURITY] [DLA 3959-1] guix security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3959-1] guix security update
* *From*: Adrian Bunk <bunk@debian.org>
* *Date*: Tue, 19 Nov 2024 23:42:54 +0200
* *Message-id*: <[[🔎]](/msgid-search/Zz0GXgFiyIpDTO1j%40localhost) [Zz0GXgFiyIpDTO1j@localhost](msg00016.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian LTS Advisory DLA-3959-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                          Adrian Bunk
November 19, 2024                             <https://wiki.debian.org/LTS>
- -------------------------------------------------------------------------

Package        : guix
Version        : 1.2.0-4+deb11u3
CVE ID         : CVE-2024-52867

Privilege escalation has been fixed in the GNU Guix package manager.

For Debian 11 bullseye, this problem has been fixed in version
1.2.0-4+deb11u3.

We recommend that you upgrade your guix packages.

For the detailed security status of guix please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/guix>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEOvp1f6xuoR0v9F3wiNJCh6LYmLEFAmc9BloACgkQiNJCh6LY
mLFv5hAAooFDl24sdlViOoe+/9KcqUYBOTtGHd1kzSLft/l1gzKS8VOC/9odSN9w
TypaxEoTAy2u20yrjvyU+p+j5oE3oROCjYDjsrg/MAuWS+Mw/qXzQcnx8Bn8wfwn
XzRhZUVjdZpOgjd38i8DEvxeW7Ro7aOTAdb4lD60OtHJWHpImfvblfGdV5PyPDjq
P0FGio9kEYxl5XTQrj9SLXQY61HRJMHflI3nkR4H7jg0+4cnnUDVoNwYrQDBnBhM
Fl+tjNdUZ324udMWyssLGoNtGKcdcZVsK1dQFM7rHanP2E0cByXOsVE4VlcVu+PE
wdHJvFWWL7GwtOf+2Uoz+ZeFh+E/jISdvkhLrIqPk+nCD/8FxxGMbhGrVuL6JdAD
NsIAPFNorW6SD9f5yitBNKzW2a7dpzWA9vE+7TmJSEB3Vpn3TsYDkr1rHVq8me+S
AROYxhSgpsOy+NqHHdOYAESunKUMOwsm9SZhItUlJF5teu5LGPeWnWQgVVykg260
9m4IJnaVWKa+3c6eX2uVMkKZOkvFqfP5vhF2p02uIVa/qCv8i3urB0+ufx+DJZE3
HryJ0dRysY46gtmXnQvSw6+NlhWV4o/6ScOwJmv1p3Kc/teRqfCkbEIEU9sFSHML
MeBpP7YqkkGtmmorFBiDMR3V2R3f7S9NSA3x+BW+bRpULjAhtL8=
=Xm1L
-----END PGP SIGNATURE-----

```

---



=== Content from guix.gnu.org_6d7ba49b_20250114_182810.html ===

# [Guix](/)

## website menu:

* [Overview](/)
* DownloadDownload
  + [Standard](/en/download/)
  + [Latest](/en/download/latest/)
* HelpHelp
  + [All](/en/help/)
  + [GNU Guix Manual 1.4.0](/manual/en/)
  + [GNU Guix Manual (latest)](/manual/devel/en/)
  + [Guix Reference Card](/guix-refcard.pdf)
  + [Videos](/en/videos/)
  + [Cookbook](/cookbook/en/)
  + [GNU Manuals](https://gnu.org/manual/)
  + [Wiki](https://libreplanet.org/wiki/Group%3AGuix)
  + [IRC Chat](/en/contact/irc/)
  + [Mailing Lists](/en/contact/)
* [Packages](https://packages.guix.gnu.org/)
* [Blog](/en/blog/)
* MediaMedia
  + [Videos](/en/videos/)
  + [Screenshots](/en/screenshots/)
  + [Publications](/en/publications/)
* [Donate](/en/donate/)
* AboutAbout
  + [About](/en/about/)
  ![](/themes/initial/img/h-separator.png)+ [Contact](/en/contact/)
  + [Contribute](/en/contribute/)
  + [Security](/en/security/)
  + [Graphics](/en/graphics/)
* EnglishEnglish
  + [Äesky](/cs/)
  + [Deutsch](/de/)
  + [Esperanto](/eo/)
  + [EspaÃ±ol](/es/)
  + [ÙØ§Ø±Ø³Û](/fa/)
  + [FranÃ§ais](/fr/)
  + [æ¥æ¬èª](/ja/)
  + [íêµ­ì´](/ko/)
  + [LietuviÅ³](/lt/)
  + [Norsk bokmÃ¥l](/nb-NO/)
  + [PortuguÃªs (Brasil)](/pt-BR/)
  + [Ð ÑÑÑÐºÐ¸Ð¹](/ru/)
  + [SlovenÄina](/sk/)
  + [Svenska](/sv/)
  + [TÃ¼rkÃ§e](/tr/)
  + [Ð£ÐºÑÐ°ÑÐ½ÑÑÐºÐ°](/uk/)
  + [ç®ä½ä¸­æ (zh-CN)](/zh-CN/)
  + [ç¹é«ä¸­æ](/zh-TW/)
  + [Translate](https://translate.fedoraproject.org/projects/guix/website)
## Your location:

[Home](/) â [Blog](/en/blog/) â [Build User Takeover Vulnerability (CVE-2024-52867)](/en/blog/2024/build-user-takeover-vulnerability/)
## Build User Takeover Vulnerability (CVE-2024-52867)

Caleb Ristvedt â October 21, 2024

A security issue, known as [**CVE-2024-52867**](https://nvd.nist.gov/vuln/detail/CVE-2024-52867), has been identified in
[`guix-daemon`](https://guix.gnu.org/en/manual/devel/en/html_node/Invoking-guix_002ddaemon.html)
which allows for a local user to gain the privileges of any of the build users
and subsequently use this to manipulate the output of any build. You
are strongly advised to **upgrade your daemon now** (see instructions
below), especially on multi-user systems.

This exploit requires the ability to start a derivation build and the ability to
run arbitrary code with access to the store in the root PID namespace on the
machine the build occurs on. As such, this represents an increased risk
primarily to multi-user systems and systems using dedicated privilege-separation
users for various daemons: without special sandboxing measures, any process of
theirs can take advantage of this vulnerability.

# Vulnerability

For a very long time, `guix-daemon` [has helpfully made the outputs of failed
derivation builds
available](https://git.savannah.gnu.org/cgit/guix.git/tree/nix/libstore/build.cc?id=e951a375a01262dfd470ee343baf7c41dbc6ff58#n1371)
at the same location they were at in the build container. This has aided greatly
especially in situations where test suites require the package to already be
installed in order to run, as it allows one to re-run the test suite
interactively outside of the container when built with `--keep-failed`. This
transferral of store items from inside the chroot to the real store was
implemented with a simple `rename`, and no modification of the store item or
any files it may contain.

If an attacker starts a build of a derivation that creates a binary with the
setuid and/or setgid bit in an output directory, then, and the build fails, that
binary will be accessible unaltered for anybody on the system. The attacker or a
cooperating user can then execute the binary, gain the privileges, and from
there use a combination of signals and procfs to freeze a builder, open any file
it has open via `/proc/$PID/fd`, and overwrite it with whatever it wants. This
manipulation of builds can happen regardless of which user started the build, so
it can work not only for producing compromised outputs for commonly-used
programs before anybody else uses them, but also for compromising any builds
another user happens to start.

A related vulnerability was also discovered concerning the outputs of
*successful* builds. These were
[moved](https://git.savannah.gnu.org/cgit/guix.git/tree/nix/libstore/build.cc?id=e951a375a01262dfd470ee343baf7c41dbc6ff58#n2343) -
also via `rename()` - outside of the container prior to having their
permissions, ownership, and timestamps
[canonicalized](https://git.savannah.gnu.org/cgit/guix.git/tree/nix/libstore/build.cc?id=e951a375a01262dfd470ee343baf7c41dbc6ff58#n2429). This
means that there also exists a window of time for a successful build's outputs
during which a setuid/setgid binary can be executed.

In general, any time that a build user running a build for some submitter can
get a setuid/setgid binary to a place the submitter can execute it, it is
possible for the submitter to use it to take over the build user. This situation
always occurs when `--disable-chroot` is passed to `guix-daemon`. This holds
even in the case where there are no dedicated build users, and builds happen
under the same user the daemon runs as, as happens during `make check` in the
guix repository. Consequently, if a permissive umask that allows execute
permission for untrusted users on directories all the way to a user's guix
checkout is used, an attacker can use that user's test-environment daemon to
gain control over their user while `make check` is running.

# Mitigation

This [security issue](https://issues.guix.gnu.org/73919) has been fixed by
[two](https://git.savannah.gnu.org/cgit/guix.git/commit/?id=558224140dab669cabdaebabff18504a066c48d4)
[commits](https://git.savannah.gnu.org/cgit/guix.git/commit/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1). Users
should make sure they have updated to the second commit to be protected from
this vulnerability. Upgrade instructions are in the following section. If there
is a possibility that a failed build has left a setuid/setgid binary lying
around in the store by accident, run `guix gc` to remove all failed build
outputs.

The fix was accomplished by sanitizing the permissions of all files in a failed
build output prior to moving it to the store, and also by waiting to move
successful build outputs to the store until after their permissions had been
canonicalized. The sanitizing was done in such a way as to preserve as many
non-security-critical properties of failed build outputs as possible to aid in
debugging. After applying these two commits, the `guix` package in Guix was
[updated](https://git.savannah.gnu.org/cgit/guix.git/commit/?id=5966e0fdc78771c562e0f484a22f381a77908be0)
so that `guix-daemon` deployed using it would use the fixed version.

If you are using `--disable-chroot`, whether with dedicated build users or not,
make sure that access to your daemon's socket is restricted to trusted
users. This particularly affects anyone running `make check` and anyone running
on GNU/Hurd. The former should either manually remove execute permission for
untrusted users on their guix checkout or apply [this
patch](https://issues.guix.gnu.org/73924), which restricts access to the
test-environment daemon to the user running the tests. The latter should adjust
the ownership and permissions of `/var/guix/daemon-socket`, which can be done
for Guix System users using the new `socket-directory-{perms,group,user}` fields
in [this patch](https://issues.guix.gnu.org/73925).

A proof of concept is available at the end of this post. One can run this code
with:

```
guix repl -- setuid-exposure-vuln-check.scm
```

This will output whether the current `guix-daemon` being used is vulnerable or
not. If it is *not* vulnerable, the last line will contain `your system is not vulnerable`, otherwise the last line will contain `YOUR SYSTEM IS VULNERABLE`.

# Upgrading

Due to the severity of this security advisory, we strongly recommend
all users to upgrade their `guix-daemon` immediately.

For Guix System, [the
procedure](https://guix.gnu.org/manual/devel/en/html_node/Getting-Started-with-the-System.html)
is to reconfigure the system after a `guix pull`, either restarting
`guix-daemon` or rebooting. For example:

```
guix pull
sudo guix system reconfigure /run/current-system/configuration.scm
sudo herd restart guix-daemon
```

where `/run/current-system/configuration.scm` is the current system
configuration but could, of course, be replaced by a system
configuration file of a user's choice.

For Guix running as a package manager on other distributions, one
needs to `guix pull` with `sudo`, as the `guix-daemon` runs as root,
and restart the `guix-daemon` service, [as
documented](https://guix.gnu.org/manual/devel/en/html_node/Upgrading-Guix.html).
For example, on a system using systemd to manage services, run:

```
sudo --login guix pull
sudo systemctl restart guix-daemon.service
```

Note that for users with their distro's package of Guix (as opposed to
having used the [install
script](https://guix.gnu.org/en/manual/devel/en/html_node/Binary-Installation.html))
you may need to take other steps or upgrade the Guix package as per
other packages on your distro. Please consult the relevant
documentation from your distro or contact the package maintainer for
additional information or questions.

# Conclusion

Even with the sandboxing features of modern kernels, it can be quite challenging
to synthesize a situation in which two users on the same system who are
determined to cooperate nevertheless cannot. Guix has an especially difficult
job because it needs to not only realize such a situation, but also maintain the
ability to interact with both users itself, while not allowing them to cooperate
through itself in unintended ways. Keeping failed build outputs around for
debugging introduced a vulnerability, but finding that vulnerability because of
it enabled the discovery of an additional vulnerability that would have existed
anyway, and prompted the use of mechanisms for securing access to the guix
daemon.

I would like to thank Ludovic CourtÃ¨s for giving feedback on these
vulnerabilities and their fixes â discussion of which led to discovering the
vulnerable time window with successful build outputs â and also for helping me
to discover that my email server was broken.

## Proof of Concept

Below is code to check if your `guix-daemon` is vulnerable to this exploit. Save
this file as `setuid-exposure-vuln-check.scm` and run following the instructions
above, in "Mitigation."

```
(use-modules (guix)
             (srfi srfi-34))

(define maybe-setuid-file
  ;; Attempt to create a setuid file in the store, with one of the build
  ;; users as its owner.
  (computed-file "maybe-setuid-file"
                 #~(begin
                     (call-with-output-file #$output (const #t))
                     (chmod #$output #o6000)

                     ;; Failing causes guix-daemon to copy the output from
                     ;; its temporary location back to the store.
                     (exit 1))))

(with-store store
  (let* ((drv (run-with-store store
                (lower-object maybe-setuid-file)))
         (out (derivation->output-path drv)))
    (guard (c (#t
               (if (zero? (logand #o6000 (stat:perms (stat out))))
                   (format #t "~a is not setuid: your system is not \
vulnerable.~%"
                           out)
                   (format #t "~a is setuid: YOUR SYSTEM IS VULNERABLE.

Run 'guix gc' to remove that file and upgrade.~%"
                           out))))
      (build-things store (list (derivation-file-name drv))))))
```

Related topics:

[Security Advisory](/en/blog/tags/security-advisory/)

Unless otherwise stated, blog posts on this site are
copyrighted by their respective authors and published under the terms of
the [CC-BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/) license and those of the [GNU Free Documentation License](https://www.gnu.org/licenses/fdl-1.3.html) (version 1.3 or later, with no Invariant Sections, no
Front-Cover Texts, and no Back-Cover Texts).

Made with â¥ by humans and powered by [GNU Guile](https://gnu.org/software/guile/). [Source code](//git.savannah.gnu.org/cgit/guix/guix-artwork.git/tree/website) under the [GNU AGPL](https://gnu.org/licenses/agpl-3.0.html).

=== Content from git.savannah.gnu.org_1135c296_20250114_182802.html ===


| [cgit logo](/cgit/) | [index](/cgit/) : [guix.git](/cgit/guix.git/ "guix.git") | core-packages-team core-packages-team-old core-updates-glibc-2.39 emacs-team gnome-team go-team guile-daemon haskell-team-shellcheck haskell-team-shellcheck-v2 install-doc-overhaul kde-team kernel-updates keyring libgcrypt-gpg-update librewolf-updates lisp-team-asdf-build-system-clasp master old-guix-wip-file-offset-bits-64-sledgehammer python-team qt-team r-team rust-team tex-team version-0.10.0 version-0.11.0 version-0.12.0 version-0.13.0 version-0.14.0 version-0.15.0 version-0.16.0 version-0.8.3 version-0.9.0 version-1.0.0 version-1.0.1 version-1.1.0 version-1.2.0 version-1.3.0 version-1.4.0 wip-aarch64-bootstrap wip-arm-bootstrap wip-buildroot wip-check wip-container wip-cpu-tuning wip-deploy wip-deploy2 wip-desktop wip-digests wip-file-offset-bits-64 wip-file-offset-bits-64-sledgehammer wip-filesearch wip-full-source-bootstrap wip-gexp-grafts wip-gexp-hygiene wip-git-https wip-gmp wip-guix-log wip-harden-installer wip-hurd-vm wip-ipfs wip-ipfs-substitutes wip-ipfs2 wip-java-aarch64 wip-julia-upgrade wip-kde-education wip-kde-plasma wip-loongson2f wip-mediagoblin wip-mnt-reform wip-node-14 wip-node-18-updates wip-node-importer wip-node-reproducibility wip-ocaml wip-pandas-upgrade wip-perl6 wip-pinebook-pro wip-plmshift wip-postfix wip-ppc wip-ppc64le wip-python-mne wip-python-team wip-r wip-r-team wip-riscv-bootstrap wip-system-bootstrap wip-webkit xorg-updates zig-next |
| --- | --- | --- |
| GNU Guix and GNU Guix System |  |

| [summary](/cgit/guix.git/)[refs](/cgit/guix.git/refs/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1)[log](/cgit/guix.git/log/)[tree](/cgit/guix.git/tree/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1)[commit](/cgit/guix.git/commit/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1)[diff](/cgit/guix.git/diff/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Reepca Russelstein <reepca@russelstein.xyz> | 2024-10-20 15:39:02 -0500 |
| --- | --- | --- |
| committer | Ludovic Courtès <ludo@gnu.org> | 2024-10-21 00:09:24 +0200 |
| commit | [5ab3c4c1e43ebb637551223791db0ea3519986e1](/cgit/guix.git/commit/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1) ([patch](/cgit/guix.git/patch/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1)) | |
| tree | [eed91396837697f77deff12e8c50a54ed01c4cb2](/cgit/guix.git/tree/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1) | |
| parent | [558224140dab669cabdaebabff18504a066c48d4](/cgit/guix.git/commit/?id=558224140dab669cabdaebabff18504a066c48d4) ([diff](/cgit/guix.git/diff/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1&id2=558224140dab669cabdaebabff18504a066c48d4)) | |
| download | [guix-5ab3c4c1e43ebb637551223791db0ea3519986e1.tar.gz](/cgit/guix.git/snapshot/guix-5ab3c4c1e43ebb637551223791db0ea3519986e1.tar.gz) | |

daemon: Sanitize successful build outputs prior to exposing them.There is currently a window of time between when the build outputs are exposed
and when their metadata is canonicalized.
\* nix/libstore/build.cc (DerivationGoal::registerOutputs): wait until after
metadata canonicalization to move successful build outputs to the store.
Change-Id: Ia995136f3f965eaf7b0e1d92af964b816f3fb276
Signed-off-by: Ludovic Courtès <ludo@gnu.org>
[Diffstat](/cgit/guix.git/diff/?id=5ab3c4c1e43ebb637551223791db0ea3519986e1)

| -rw-r--r-- | [nix/libstore/build.cc](/cgit/guix.git/diff/nix/libstore/build.cc?id=5ab3c4c1e43ebb637551223791db0ea3519986e1) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 9 deletions

| diff --git a/nix/libstore/build.cc b/nix/libstore/build.ccindex 67ebfe2..43a8a37 100644--- a/[nix/libstore/build.cc](/cgit/guix.git/tree/nix/libstore/build.cc?id=558224140dab669cabdaebabff18504a066c48d4)+++ b/[nix/libstore/build.cc](/cgit/guix.git/tree/nix/libstore/build.cc?id=5ab3c4c1e43ebb637551223791db0ea3519986e1)@@ -2369,15 +2369,6 @@ void DerivationGoal::registerOutputs() Path actualPath = path; if (useChroot) { actualPath = chrootRootDir + path;- if (pathExists(actualPath)) {- /\* Move output paths from the chroot to the store. \*/- if (buildMode == bmRepair)- replaceValidPath(path, actualPath);- else- if (buildMode != bmCheck && rename(actualPath.c\_str(), path.c\_str()) == -1)- throw SysError(format("moving build output `%1%' from the chroot to the store") % path);- }- if (buildMode != bmCheck) actualPath = path; } else { Path redirected = redirectedOutputs[path]; if (buildMode == bmRepair@@ -2463,6 +2454,20 @@ void DerivationGoal::registerOutputs() canonicalisePathMetaData(actualPath, buildUser.enabled() && !rewritten ? buildUser.getUID() : -1, inodesSeen); + if (useChroot) {+ if (pathExists(actualPath)) {+ /\* Now that output paths have been canonicalized (in particular+ there are no setuid files left), move them outside of the+ chroot and to the store. \*/+ if (buildMode == bmRepair)+ replaceValidPath(path, actualPath);+ else+ if (buildMode != bmCheck && rename(actualPath.c\_str(), path.c\_str()) == -1)+ throw SysError(format("moving build output `%1%' from the chroot to the store") % path);+ }+ if (buildMode != bmCheck) actualPath = path;+ }+ /\* For this output path, find the references to other paths contained in it. Compute the SHA-256 NAR hash at the same time. The hash is stored in the database so that we can |
| --- |

generated by [cgit v1.1](https://git.zx2c4.com/cgit/about/) at 2025-01-14 18:28:01 +0000



=== Content from git.savannah.gnu.org_2b13c40f_20250114_182801.html ===


| [cgit logo](/cgit/) | [index](/cgit/) : [guix.git](/cgit/guix.git/ "guix.git") | core-packages-team core-packages-team-old core-updates-glibc-2.39 emacs-team gnome-team go-team guile-daemon haskell-team-shellcheck haskell-team-shellcheck-v2 install-doc-overhaul kde-team kernel-updates keyring libgcrypt-gpg-update librewolf-updates lisp-team-asdf-build-system-clasp master old-guix-wip-file-offset-bits-64-sledgehammer python-team qt-team r-team rust-team tex-team version-0.10.0 version-0.11.0 version-0.12.0 version-0.13.0 version-0.14.0 version-0.15.0 version-0.16.0 version-0.8.3 version-0.9.0 version-1.0.0 version-1.0.1 version-1.1.0 version-1.2.0 version-1.3.0 version-1.4.0 wip-aarch64-bootstrap wip-arm-bootstrap wip-buildroot wip-check wip-container wip-cpu-tuning wip-deploy wip-deploy2 wip-desktop wip-digests wip-file-offset-bits-64 wip-file-offset-bits-64-sledgehammer wip-filesearch wip-full-source-bootstrap wip-gexp-grafts wip-gexp-hygiene wip-git-https wip-gmp wip-guix-log wip-harden-installer wip-hurd-vm wip-ipfs wip-ipfs-substitutes wip-ipfs2 wip-java-aarch64 wip-julia-upgrade wip-kde-education wip-kde-plasma wip-loongson2f wip-mediagoblin wip-mnt-reform wip-node-14 wip-node-18-updates wip-node-importer wip-node-reproducibility wip-ocaml wip-pandas-upgrade wip-perl6 wip-pinebook-pro wip-plmshift wip-postfix wip-ppc wip-ppc64le wip-python-mne wip-python-team wip-r wip-r-team wip-riscv-bootstrap wip-system-bootstrap wip-webkit xorg-updates zig-next |
| --- | --- | --- |
| GNU Guix and GNU Guix System |  |

| [summary](/cgit/guix.git/)[refs](/cgit/guix.git/refs/?id=558224140dab669cabdaebabff18504a066c48d4)[log](/cgit/guix.git/log/)[tree](/cgit/guix.git/tree/?id=558224140dab669cabdaebabff18504a066c48d4)[commit](/cgit/guix.git/commit/?id=558224140dab669cabdaebabff18504a066c48d4)[diff](/cgit/guix.git/diff/?id=558224140dab669cabdaebabff18504a066c48d4) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Reepca Russelstein <reepca@russelstein.xyz> | 2024-10-20 15:36:06 -0500 |
| --- | --- | --- |
| committer | Ludovic Courtès <ludo@gnu.org> | 2024-10-21 00:09:10 +0200 |
| commit | [558224140dab669cabdaebabff18504a066c48d4](/cgit/guix.git/commit/?id=558224140dab669cabdaebabff18504a066c48d4) ([patch](/cgit/guix.git/patch/?id=558224140dab669cabdaebabff18504a066c48d4)) | |
| tree | [e5bae2ebffdbbc33695f09917b13f6aebc1cdbe4](/cgit/guix.git/tree/?id=558224140dab669cabdaebabff18504a066c48d4) | |
| parent | [92910f5413fd9112c0502138eed5fff758c5de65](/cgit/guix.git/commit/?id=92910f5413fd9112c0502138eed5fff758c5de65) ([diff](/cgit/guix.git/diff/?id=558224140dab669cabdaebabff18504a066c48d4&id2=92910f5413fd9112c0502138eed5fff758c5de65)) | |
| download | [guix-558224140dab669cabdaebabff18504a066c48d4.tar.gz](/cgit/guix.git/snapshot/guix-558224140dab669cabdaebabff18504a066c48d4.tar.gz) | |

daemon: Sanitize failed build outputs prior to exposing them.The only thing keeping a rogue builder and a local user from collaborating to
usurp control over the builder's user during the build is the fact that
whatever files the builder may produce are not accessible to any other users
yet. If we're going to make them accessible, we should probably do some
sanity checking to ensure that sort of collaborating can't happen.
Currently this isn't happening when failed build outputs are moved from the
chroot as an aid to debugging.
\* nix/libstore/build.cc (secureFilePerms): new function.
(DerivationGoal::buildDone): use it.
Change-Id: I9dce1e3d8813b31cabd87a0e3219bf9830d8be96
Signed-off-by: Ludovic Courtès <ludo@gnu.org>
[Diffstat](/cgit/guix.git/diff/?id=558224140dab669cabdaebabff18504a066c48d4)

| -rw-r--r-- | [nix/libstore/build.cc](/cgit/guix.git/diff/nix/libstore/build.cc?id=558224140dab669cabdaebabff18504a066c48d4) | 36 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 35 insertions, 1 deletions

| diff --git a/nix/libstore/build.cc b/nix/libstore/build.ccindex d23c094..67ebfe2 100644--- a/[nix/libstore/build.cc](/cgit/guix.git/tree/nix/libstore/build.cc?id=92910f5413fd9112c0502138eed5fff758c5de65)+++ b/[nix/libstore/build.cc](/cgit/guix.git/tree/nix/libstore/build.cc?id=558224140dab669cabdaebabff18504a066c48d4)@@ -1301,6 +1301,34 @@ void replaceValidPath(const Path & storePath, const Path tmpPath) MakeError(NotDeterministic, BuildError)  +/\* Recursively make the file permissions of a path safe for exposure to+ arbitrary users, but without canonicalising its permissions, timestamp, and+ user. Throw an exception if a file type that isn't explicitly known to be+ safe is found. \*/+static void secureFilePerms(Path path)+{+ struct stat st;+ if (lstat(path.c\_str(), &st)) return;++ switch(st.st\_mode & S\_IFMT) {+ case S\_IFLNK:+ return;++ case S\_IFDIR:+ for (auto & i : readDirectory(path)) {+ secureFilePerms(path + "/" + i.name);+ }+ /\* FALLTHROUGH \*/++ case S\_IFREG:+ chmod(path.c\_str(), (st.st\_mode & ~S\_IFMT) & ~(S\_ISUID | S\_ISGID | S\_IWOTH));+ break;++ default:+ throw Error(format("file `%1%' has an unsupported type") % path);+ }+}+ void DerivationGoal::buildDone() { trace("build done");@@ -1372,8 +1400,14 @@ void DerivationGoal::buildDone() build failures. \*/ if (useChroot && buildMode == bmNormal) foreach (PathSet::iterator, i, missingPaths)- if (pathExists(chrootRootDir + \*i))+ if (pathExists(chrootRootDir + \*i)) {+ try {+ secureFilePerms(chrootRootDir + \*i); rename((chrootRootDir + \*i).c\_str(), i->c\_str());+ } catch(Error & e) {+ printMsg(lvlError, e.msg());+ }+ }  if (diskFull) printMsg(lvlError, "note: build failure may have been caused by lack of free disk space"); |
| --- |

generated by [cgit v1.1](https://git.zx2c4.com/cgit/about/) at 2025-01-14 18:28:00 +0000


