=== Content from www.openwall.com_aec716a3_20250115_090258.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](../../../2024/11/29/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <e1b7db91-ab63-8e45-b00b-c72111846618@apache.org>
Date: Thu, 28 Nov 2024 16:20:39 +0000
From: Dewey Dunnington <paleolimbot@...che.org>
To: oss-security@...ts.openwall.com
Subject: CVE-2024-52338: Apache Arrow R package: Arbitrary code execution
 when loading a malicious data file

Severity: critical

Affected versions:

- Apache Arrow R package 4.0.0 through 16.1.0

Description:

Deserialization of untrusted data in IPC and Parquet readers in the Apache Arrow R package versions 4.0.0 through 16.1.0 allows arbitrary code execution. An application is vulnerable if it
reads Arrow IPC, Feather or Parquet data from untrusted sources (for
example, user-supplied input files). This vulnerability only affects the arrow R package, not other Apache Arrow
implementations or bindings unless those bindings are specifically used via the R package (for example, an R application that embeds a Python interpreter and uses PyArrow to read files from untrusted sources is still vulnerable if the arrow R package is an affected version). It is recommended that users of the arrow R package upgrade to 17.0.0 or later. Similarly, it
 is recommended that downstream libraries upgrade their dependency
requirements to arrow 17.0.0 or later. If using an affected
version of the package, untrusted data can read into a Table and its internal to_data_frame() method can be used as a workaround (e.g., read_parquet(..., as_data_frame = FALSE)$to_data_frame()).

This issue affects the Apache Arrow R package: from 4.0.0 through 16.1.0.

Users are recommended to upgrade to version 17.0.0, which fixes the issue.

References:

<https://github.com/apache/arrow/commit/801de2fbcf5bcbce0c019ed4b35ff3fc863b141b>
<https://arrow.apache.org/>
<https://www.cve.org/CVERecord?id=CVE-2024-52338>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_396b514a_20250115_090301.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fapache%2Farrow%2Fcommit%2F801de2fbcf5bcbce0c019ed4b35ff3fc863b141b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fapache%2Farrow%2Fcommit%2F801de2fbcf5bcbce0c019ed4b35ff3fc863b141b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=apache%2Farrow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[apache](/apache)
/
**[arrow](/apache/arrow)**
Public

* [Notifications](/login?return_to=%2Fapache%2Farrow) You must be signed in to change notification settings
* [Fork
  3.6k](/login?return_to=%2Fapache%2Farrow)
* [Star
   14.8k](/login?return_to=%2Fapache%2Farrow)

* [Code](/apache/arrow)
* [Issues
  4.1k](/apache/arrow/issues)
* [Pull requests
  324](/apache/arrow/pulls)
* [Actions](/apache/arrow/actions)
* [Projects
  1](/apache/arrow/projects)
* [Security](/apache/arrow/security)
* [Insights](/apache/arrow/pulse)

Additional navigation options

* [Code](/apache/arrow)
* [Issues](/apache/arrow/issues)
* [Pull requests](/apache/arrow/pulls)
* [Actions](/apache/arrow/actions)
* [Projects](/apache/arrow/projects)
* [Security](/apache/arrow/security)
* [Insights](/apache/arrow/pulse)

## Commit

[Permalink](/apache/arrow/commit/801de2fbcf5bcbce0c019ed4b35ff3fc863b141b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[GH-42143](https://github.com/apache/arrow/issues/42143): [R] Sanitize R metadata ([#41969](https://github.com/apache/arrow/pull/41969))

[Browse files](/apache/arrow/tree/801de2fbcf5bcbce0c019ed4b35ff3fc863b141b)
Browse the repository at this point in the history

```
### Rationale for this change

`arrow` uses R `serialize()`/`unserialize()` to store additional
metadata in the Arrow schema. This PR adds some extra checking and
sanitizing in order to make the reading of this metadata robust to data
of unknown provenance.

### What changes are included in this PR?

* When writing metadata, we strip out all but simple types: strings,
numbers, boolean, lists, etc. Objects of other types, such as
environments, external pointers, and other language types, are removed.
* When reading metadata, the same filter is applied. If there are types
that are not in the allowlist, one of two things happen. By default,
they are removed with a warning. If you set
`options(arrow.unsafe_metadata = TRUE)`, the full metadata including
disallowed types is returned, also with a warning. This option is an
escape hatch in case we are too strict with dropping types when reading
files produced by older versions of the package that did not filter them
out.
* `unserialize()` is called in a way that prevents promises contained in
the data from being automatically invoked. This technique works on all
versions of R: it is not dependent on the patch for RDS reading that was
included in 4.4.
* Other sanity checking to be stricter about only reading back in
something of the form we wrote out: assert that the data is
ASCII-serialized, and if it is compressed, it is gzip, the same way we
do on serialization. It's not clear that it's necessary, but it's not
bad to be extra strict here.

### Are these changes tested?

Yes

### Are there any user-facing changes?

For most, no. But:

**This PR contains a "Critical Fix".**

Without this patch, it is possible to construct an Arrow or Parquet file
that would contain code that would execute when the R metadata is
applied when converting to a data.frame. If you are using an older
version of the package and are reading data from a source you do not
trust, you can read into a `Table` and use its internal
`$to_data_frame()` method, like `read_parquet(..., as_data_frame =
FALSE)$to_data_frame()`. This should skip the reading of the R metadata.
* GitHub Issue: [#42143](https://github.com/apache/arrow/issues/42143)
```

* Loading branch information

[![@nealrichardson](https://avatars.githubusercontent.com/u/2975928?s=40&v=4)](/nealrichardson)

[nealrichardson](/apache/arrow/commits?author=nealrichardson "View all commits by nealrichardson")
authored
Jun 14, 2024

1 parent
[69e8a78](/apache/arrow/commit/69e8a78c018da88b60f9eb2b3b45703f81f3c93d)

commit 801de2f

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**169 additions**
and
**14 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* r

  + r/NEWS.md
    [NEWS.md](#diff-8144c1c2862a5da6eb971578e69638777db8e7906a28621fe65b4ebc11c120fe)
  + R

    - r/R/extension.R
      [extension.R](#diff-9c6001fab66a85086456e6f096617a8b5e30303a59ffe638866e26f48486382c)
    - r/R/metadata.R
      [metadata.R](#diff-659e9fa6b66e5a72b4e3f9ac79ffddf08f92d9ea3d7aa45bd8c73b9a022fa2e5)
  + tests/testthat

    - r/tests/testthat/test-metadata.R
      [test-metadata.R](#diff-0386351ec2a20934987de3d32d4aee6fc609fbfbe3af3bf287a66941e8d563a7)

## There are no files selected for viewing

3 changes: 1 addition & 2 deletions

3
[r/NEWS.md](#diff-8144c1c2862a5da6eb971578e69638777db8e7906a28621fe65b4ebc11c120fe "r/NEWS.md")

Show comments

[View file](/apache/arrow/blob/801de2fbcf5bcbce0c019ed4b35ff3fc863b141b/r/NEWS.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -19,11 +19,10 @@ |
|  |  |  |
|  |  | # arrow 16.1.0.9000 |
|  |  |  |
|  |  | # arrow 16.1.0 |
|  |  |  |
|  |  | \* R functions that users write that use functions that Arrow supports in dataset queries now can be used in queries too. Previously, only functions that used arithmetic operators worked. For example, `time\_hours <- function(mins) mins / 60` worked, but `time\_hours\_rounded <- function(mins) round(mins / 60)` did not; now both work. These are automatic translations rather than true user-defined functions (UDFs); for UDFs, see `register\_scalar\_function()`. (#41223) |
|  |  | \* `summarize()` supports more complex expressions, and correctly handles cases where column names are reused in expressions. |
|  |  | \* The `na\_matches` argument to the `dplyr::\*\_join()` functions is now supported. This argument controls whether `NA` values are considered equal when joining. (#41358) |
|  |  | \* R metadata, stored in the Arrow schema to support round-tripping data between R and Arrow/Parquet, is now serialized and deserialized more strictly. This makes it safer to load data from files from unknown sources into R data.frames. (#41969) |
|  |  |  |
|  |  | # arrow 16.1.0 |
|  |  |  |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[r/R/extension.R](#diff-9c6001fab66a85086456e6f096617a8b5e30303a59ffe638866e26f48486382c "r/R/extension.R")

Show comments

[View file](/apache/arrow/blob/801de2fbcf5bcbce0c019ed4b35ff3fc863b141b/r/R/extension.R)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -429,7 +429,7 @@ VctrsExtensionType <- R6Class("VctrsExtensionType", |
|  |  | paste0(capture.output(print(self$ptype())), collapse = "\n") |
|  |  | }, |
|  |  | deserialize\_instance = function() { |
|  |  | private$.ptype <- unserialize(self$extension\_metadata()) |
|  |  | private$.ptype <- safe\_r\_metadata(safe\_unserialize(self$extension\_metadata())) |
|  |  | }, |
|  |  | ExtensionEquals = function(other) { |
|  |  | inherits(other, "VctrsExtensionType") && identical(self$ptype(), other$ptype()) |
| Expand Down | |  |

109 changes: 98 additions & 11 deletions

109
[r/R/metadata.R](#diff-659e9fa6b66e5a72b4e3f9ac79ffddf08f92d9ea3d7aa45bd8c73b9a022fa2e5 "r/R/metadata.R")

Show comments

[View file](/apache/arrow/blob/801de2fbcf5bcbce0c019ed4b35ff3fc863b141b/r/R/metadata.R)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -30,7 +30,7 @@ |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | out <- serialize(x, NULL, ascii = TRUE) |
|  |  | out <- serialize(safe\_r\_metadata(x, on\_save = TRUE), NULL, ascii = TRUE) |
|  |  |  |
|  |  | # if the metadata is over 100 kB, compress |
|  |  | if (option\_compress\_metadata() && object.size(out) > 100000) { |
| Expand All | | @@ -44,23 +44,110 @@ |
|  |  | } |
|  |  |  |
|  |  | .deserialize\_arrow\_r\_metadata <- function(x) { |
|  |  | tryCatch( |
|  |  | expr = { |
|  |  | out <- unserialize(charToRaw(x)) |
|  |  |  |
|  |  | # if this is still raw, try decompressing |
|  |  | if (is.raw(out)) { |
|  |  | out <- unserialize(memDecompress(out, type = "gzip")) |
|  |  | } |
|  |  | out |
|  |  | }, |
|  |  | tryCatch(unserialize\_r\_metadata(x), |
|  |  | error = function(e) { |
|  |  | if (getOption("arrow.debug", FALSE)) { |
|  |  | print(conditionMessage(e)) |
|  |  | } |
|  |  | warning("Invalid metadata$r", call. = FALSE) |
|  |  | NULL |
|  |  | } |
|  |  | ) |
|  |  | } |
|  |  |  |
|  |  | unserialize\_r\_metadata <- function(x) { |
|  |  | # Check that this is ASCII serialized data (as in, what we wrote) |
|  |  | if (!identical(substr(unclass(x), 1, 1), "A")) { |
|  |  | stop("Invalid serialized data") |
|  |  | } |
|  |  | out <- safe\_unserialize(charToRaw(x)) |
|  |  | # If it's still raw, decompress and unserialize again |
|  |  | if (is.raw(out)) { |
|  |  | decompressed <- memDecompress(out, type = "gzip") |
|  |  | if (!identical(rawToChar(decompressed[1]), "A")) { |
|  |  | stop("Invalid serialized compressed data") |
|  |  | } |
|  |  | out <- safe\_unserialize(decompressed) |
|  |  | } |
|  |  | if (!is.list(out)) { |
|  |  | stop("Invalid serialized data: must be a list") |
|  |  | } |
|  |  | safe\_r\_metadata(out) |
|  |  | } |
|  |  |  |
|  |  | safe\_unserialize <- function(x) { |
|  |  | # By capturing the data in a list, we can inspect it for promises without |
|  |  | # triggering their evaluation. |
|  |  | out <- list(unserialize(x)) |
|  |  | if (typeof(out[[1]]) == "promise") { |
|  |  | stop("Serialized data contains a promise object") |
|  |  | } |
|  |  | out[[1]] |
|  |  | } |
|  |  |  |
|  |  | safe\_r\_metadata <- function(metadata, on\_save = FALSE) { |
|  |  | # This function recurses through the metadata list and checks that all |
|  |  | # elements are of types that are allowed in R metadata. |
|  |  | # If it finds an element that is not allowed, it removes it. |
|  |  | # |
|  |  | # This function is used both when saving and loading metadata. |
|  |  | # @param on\_save: If TRUE, the function will not warn if it removes elements: |
|  |  | # we're just cleaning up the metadata for saving. If FALSE, it means we're |
|  |  | # loading the metadata, and we'll warn if we find invalid elements. |
|  |  | # |
|  |  | # When loading metadata, you can optionally keep the invalid elements by |
|  |  | # setting `options(arrow.unsafe\_metadata = TRUE)`. It will still check |
|  |  | # for invalid elements and warn if any are found, though. |
|  |  |  |
|  |  | # This variable will be used to store the types of elements that were removed, |
|  |  | # if any, so we can give an informative warning if needed. |
|  |  | types\_removed <- c() |
|  |  |  |
|  |  | # Internal function that we'll recursively apply, |
|  |  | # and mutate the `types\_removed` variable outside of it. |
|  |  | check\_r\_metadata\_types\_recursive <- function(x) { |
|  |  | allowed\_types <- c("character", "double", "integer", "logical", "complex", "list", "NULL") |
|  |  | if (is.list(x)) { |
|  |  | types <- map\_chr(x, typeof) |
|  |  | x[types == "list"] <- map(x[types == "list"], check\_r\_metadata\_types\_recursive) |
|  |  | ok <- types %in% allowed\_types |
|  |  | if (!all(ok)) { |
|  |  | # Record the invalid types, then remove the offending elements |
|  |  | types\_removed <<- c(types\_removed, setdiff(types, allowed\_types)) |
|  |  | x <- x[ok] |
|  |  | } |
|  |  | } |
|  |  | x |
|  |  | } |
|  |  | new <- check\_r\_metadata\_types\_recursive(metadata) |
|  |  |  |
|  |  | # On save: don't warn, just save the filtered metadata |
|  |  | if (on\_save) { |
|  |  | return(new) |
|  |  | } |
|  |  | # On load: warn if any elements were removed |
|  |  | if (length(types\_removed)) { |
|  |  | types\_msg <- paste("Type:", oxford\_paste(unique(types\_removed))) |
|  |  | if (getOption("arrow.unsafe\_metadata", FALSE)) { |
|  |  | # We've opted-in to unsafe metadata, so warn but return the original metadata |
|  |  | rlang::warn( |
|  |  | "R metadata may have unsafe or invalid elements", |
|  |  | body = c("i" = types\_msg) |
|  |  | ) |
|  |  | new <- metadata |
|  |  | } else { |
|  |  | rlang::warn( |
|  |  | "Potentially unsafe or invalid elements have been discarded from R metadata.", |
|  |  | body = c( |
|  |  | "i" = types\_msg, |
|  |  | ">" = "If you trust the source, you can set `options(arrow.unsafe\_metadata = TRUE)` to preserve them." |
|  |  | ) |
|  |  | ) |
|  |  | } |
|  |  | } |
|  |  | new |
|  |  | } |
|  |  |  |
|  |  | #' @importFrom rlang trace\_back |
|  |  | apply\_arrow\_r\_metadata <- function(x, r\_metadata) { |
|  |  | if (is.null(r\_metadata)) { |
| Expand Down | |  |

69 changes: 69 additions & 0 deletions

69
[r/tests/testthat/test-metadata.R](#diff-0386351ec2a20934987de3d32d4aee6fc609fbfbe3af3bf287a66941e8d563a7 "r/tests/testthat/test-metadata.R")

Show comments

[View file](/apache/arrow/blob/801de2fbcf5bcbce0c019ed4b35ff3fc863b141b/r/tests/testthat/test-metadata.R)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -107,6 +107,73 @@ test\_that("Garbage R metadata doesn't break things", { |
|  |  | "Invalid metadata$r", |
|  |  | fixed = TRUE |
|  |  | ) |
|  |  |  |
|  |  | bad <- new.env(parent = emptyenv()) |
|  |  | makeActiveBinding("columns", function() stop("This should not run"), bad) |
|  |  | tab$metadata <- list(r = rawToChar(serialize(bad, NULL, ascii = TRUE))) |
|  |  | expect\_warning( |
|  |  | as.data.frame(tab), |
|  |  | "Invalid metadata$r", |
|  |  | fixed = TRUE |
|  |  | ) |
|  |  |  |
|  |  | # https://hiddenlayer.com/research/r-bitrary-code-execution/ |
|  |  | tab$metadata <- list(r = "A |
|  |  | 3 |
|  |  | 262913 |
|  |  | 197888 |
|  |  | 5 |
|  |  | UTF-8 |
|  |  | 5 |
|  |  | 252 |
|  |  | 6 |
|  |  | 1 |
|  |  | 262153 |
|  |  | 7 |
|  |  | message |
|  |  | 2 |
|  |  | 16 |
|  |  | 1 |
|  |  | 262153 |
|  |  | 32 |
|  |  | arbitrary\040code\040was\040just\040executed |
|  |  | 254 |
|  |  | ") |
|  |  | expect\_message( |
|  |  | expect\_warning( |
|  |  | as.data.frame(tab), |
|  |  | "Invalid metadata$r", |
|  |  | fixed = TRUE |
|  |  | ), |
|  |  | NA |
|  |  | ) |
|  |  | }) |
|  |  |  |
|  |  | test\_that("Complex or unsafe attributes are pruned from R metadata, if they exist", { |
|  |  | tab <- Table$create(example\_data[1:6]) |
|  |  | bad <- new.env() |
|  |  | makeActiveBinding("class", function() stop("This should not run"), bad) |
|  |  | tab$metadata <- list(r = rawToChar(serialize(list(attributes = bad), NULL, ascii = TRUE))) |
|  |  | expect\_warning( |
|  |  | as.data.frame(tab), |
|  |  | "Potentially unsafe or invalid elements have been discarded from R metadata. |
|  |  | i Type: \"environment\" |
|  |  | > If you trust the source, you can set `options(arrow.unsafe\_metadata = TRUE)` to preserve them.", |
|  |  | fixed = TRUE |
|  |  | ) |
|  |  | # You can set an option to allow them through. |
|  |  | # It still warns, just differently, and it doesn't prune the attributes |
|  |  | withr::local\_options(list("arrow.unsafe\_metadata" = TRUE)) |
|  |  | expect\_warning( |
|  |  | expect\_warning( |
|  |  | as.data.frame(tab), |
|  |  | "R metadata may have unsafe or invalid elements |
|  |  | i Type: \"environment\"" |
|  |  | ), |
|  |  | # This particular example ultimately fails because it's not a list |
|  |  | "Invalid metadata$r", |
|  |  | fixed = TRUE |
|  |  | ) |
|  |  | }) |
|  |  |  |
|  |  | test\_that("Metadata serialization compression", { |
| Expand Down  Expand Up | | @@ -254,6 +321,8 @@ test\_that("Row-level metadata (does not) roundtrip in datasets", { |
|  |  | skip\_if\_not\_available("dataset") |
|  |  | skip\_if\_not\_available("parquet") |
|  |  |  |
|  |  | library(dplyr, warn.conflicts = FALSE) |
|  |  |  |
|  |  | df <- tibble::tibble( |
|  |  | metadata = list( |
|  |  | structure(1, my\_value\_as\_attr = 1), |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `801de2f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fapache%2Farrow%2Fcommit%2F801de2fbcf5bcbce0c019ed4b35ff3fc863b141b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.apache.org_3611f3de_20250115_090302.html ===


[![Foal logo](images/logo.png)](./)

* ![Display Settings](images/cog.png "Display Settings")
  **Email display mode:**

  ---

   Modern rendering

   Legacy rendering
* ![Logged out](images/user_loggedout.png "Not logged in")

This site requires JavaScript enabled. Please enable it.


