=== Content from github.com_5bac25be_20250114_231758.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdrakkan%2Fsftpgo%2Fcommit%2F88b1850b5806eee81150873d4e565144b21021fb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdrakkan%2Fsftpgo%2Fcommit%2F88b1850b5806eee81150873d4e565144b21021fb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=drakkan%2Fsftpgo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[drakkan](/drakkan)
/
**[sftpgo](/drakkan/sftpgo)**
Public

* [Notifications](/login?return_to=%2Fdrakkan%2Fsftpgo) You must be signed in to change notification settings
* [Fork
  761](/login?return_to=%2Fdrakkan%2Fsftpgo)
* [Star
   9.8k](/login?return_to=%2Fdrakkan%2Fsftpgo)

* [Code](/drakkan/sftpgo)
* [Issues
  63](/drakkan/sftpgo/issues)
* [Pull requests
  4](/drakkan/sftpgo/pulls)
* [Discussions](/drakkan/sftpgo/discussions)
* [Actions](/drakkan/sftpgo/actions)
* [Projects
  0](/drakkan/sftpgo/projects)
* [Security](/drakkan/sftpgo/security)
* [Insights](/drakkan/sftpgo/pulse)

Additional navigation options

* [Code](/drakkan/sftpgo)
* [Issues](/drakkan/sftpgo/issues)
* [Pull requests](/drakkan/sftpgo/pulls)
* [Discussions](/drakkan/sftpgo/discussions)
* [Actions](/drakkan/sftpgo/actions)
* [Projects](/drakkan/sftpgo/projects)
* [Security](/drakkan/sftpgo/security)
* [Insights](/drakkan/sftpgo/pulse)

## Commit

[Permalink](/drakkan/sftpgo/commit/88b1850b5806eee81150873d4e565144b21021fb)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

EventManager: allow to define the allowed system commands

[Browse files](/drakkan/sftpgo/tree/88b1850b5806eee81150873d4e565144b21021fb)
Browse the repository at this point in the history

```
Signed-off-by: Nicola Murino <nicola.murino@gmail.com>
```

* Loading branch information

[![@drakkan](https://avatars.githubusercontent.com/u/553263?s=40&v=4)](/drakkan)

[drakkan](/drakkan/sftpgo/commits?author=drakkan "View all commits by drakkan")
committed
Nov 1, 2024

1 parent
[60558de](/drakkan/sftpgo/commit/60558de72847f4af473028f11340c0a96f162da2)

commit 88b1850

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**259 additions**
and
**17 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* internal

  + common

    - internal/common/common.go
      [common.go](#diff-e0a57b903e60761f673a4485b4a747f500f4155828e182cc19786ee5648cd6e6)
    - internal/common/common\_test.go
      [common\_test.go](#diff-3968a6ad0a248dc00f77033b4b093c351137d5c08bedd78df826889214b9b9a7)
    - internal/common/eventmanager.go
      [eventmanager.go](#diff-41933cc41fd8102717f478b50d27a69ef21fb39a2ae5b586528b397832fbb6e1)
    - internal/common/protocol\_test.go
      [protocol\_test.go](#diff-922f45cec052702697ca09c4dc3e4afdb3b87f79db7db1bc5c09a790b049cc74)
  + config

    - internal/config/config.go
      [config.go](#diff-54c7c1af5fa8d5db4dc49f0e8e80e93ba2b1183ba4d5c9e2e5729e6deae6a3cd)
  + dataprovider

    - internal/dataprovider/eventrule.go
      [eventrule.go](#diff-df6a3d7a4f3abe11be93a7355b3893294cc100771ab8565befd4071271506e7a)
  + httpd

    - internal/httpd/httpd\_test.go
      [httpd\_test.go](#diff-5d436a5fa9015aba81a47cc31edc8ffe8dcb85f9d8a06ae22d0113ae7b913fe0)
    - internal/httpd/webadmin.go
      [webadmin.go](#diff-7a8bb15b5f54396b96d7c15ff08d175b6265902fbf8a112fbd15c7ec642f4f0c)
* sftpgo.json
  [sftpgo.json](#diff-eaf2c24fdab223960cf2c557819fd1bca6cf5a14d7e9c8109588d86fa1ffe72e)
* templates/webadmin

  + templates/webadmin/eventaction.html
    [eventaction.html](#diff-9b7640a139958f8535f091d06ac4cb39a1541491807d45645c36eae32950de11)

## There are no files selected for viewing

25 changes: 24 additions & 1 deletion

25
[internal/common/common.go](#diff-e0a57b903e60761f673a4485b4a747f500f4155828e182cc19786ee5648cd6e6 "internal/common/common.go")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/internal/common/common.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -239,6 +239,9 @@ func Initialize(c Configuration, isShared int) error { |
|  |  | if err := c.initializeProxyProtocol(); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | if err := c.EventManager.validate(); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | vfs.SetTempPath(c.TempPath) |
|  |  | dataprovider.SetTempPath(c.TempPath) |
|  |  | vfs.SetAllowSelfConnections(c.AllowSelfConnections) |
| Expand All | | @@ -247,6 +250,7 @@ func Initialize(c Configuration, isShared int) error { |
|  |  | vfs.SetResumeMaxSize(c.ResumeMaxSize) |
|  |  | vfs.SetUploadMode(c.UploadMode) |
|  |  | dataprovider.SetAllowSelfConnections(c.AllowSelfConnections) |
|  |  | dataprovider.EnabledActionCommands = c.EventManager.EnabledCommands |
|  |  | transfersChecker = getTransfersChecker(isShared) |
|  |  | return nil |
|  |  | } |
| Expand Down  Expand Up | | @@ -512,6 +516,23 @@ type ConnectionTransfer struct { |
|  |  | DLSize int64 `json:"-"` |
|  |  | } |
|  |  |  |
|  |  | // EventManagerConfig defines the configuration for the EventManager |
|  |  | type EventManagerConfig struct { |
|  |  | // EnabledCommands defines the system commands that can be executed via EventManager, |
|  |  | // an empty list means that any command is allowed to be executed. |
|  |  | // Commands must be set as an absolute path |
|  |  | EnabledCommands []string `json:"enabled\_commands" mapstructure:"enabled\_commands"` |
|  |  | } |
|  |  |  |
|  |  | func (c \*EventManagerConfig) validate() error { |
|  |  | for \_, c := range c.EnabledCommands { |
|  |  | if !filepath.IsAbs(c) { |
|  |  | return fmt.Errorf("invalid command %q: it must be an absolute path", c) |
|  |  | } |
|  |  | } |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | // MetadataConfig defines how to handle metadata for cloud storage backends |
|  |  | type MetadataConfig struct { |
|  |  | // If not zero the metadata will be read before downloads and will be |
| Expand Down  Expand Up | | @@ -621,7 +642,9 @@ type Configuration struct { |
|  |  | // server's local time, otherwise UTC will be used. |
|  |  | TZ string `json:"tz" mapstructure:"tz"` |
|  |  | // Metadata configuration |
|  |  | Metadata MetadataConfig `json:"metadata" mapstructure:"metadata"` |
|  |  | Metadata MetadataConfig `json:"metadata" mapstructure:"metadata"` |
|  |  | // EventManager configuration |
|  |  | EventManager EventManagerConfig `json:"event\_manager" mapstructure:"event\_manager"` |
|  |  | idleTimeoutAsDuration time.Duration |
|  |  | idleLoginTimeout time.Duration |
|  |  | defender Defender |
| Expand Down | |  |

27 changes: 27 additions & 0 deletions

27
[internal/common/common\_test.go](#diff-3968a6ad0a248dc00f77033b4b093c351137d5c08bedd78df826889214b9b9a7 "internal/common/common_test.go")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/internal/common/common_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -217,6 +217,33 @@ func TestConnections(t \*testing.T) { |
|  |  | Connections.RUnlock() |
|  |  | } |
|  |  |  |
|  |  | func TestEventManagerCommandsInitialization(t \*testing.T) { |
|  |  | configCopy := Config |
|  |  |  |
|  |  | c := Configuration{ |
|  |  | EventManager: EventManagerConfig{ |
|  |  | EnabledCommands: []string{"ls"}, // not an absolute path |
|  |  | }, |
|  |  | } |
|  |  | err := Initialize(c, 0) |
|  |  | assert.ErrorContains(t, err, "invalid command") |
|  |  |  |
|  |  | var commands []string |
|  |  | if runtime.GOOS == osWindows { |
|  |  | commands = []string{"C:\\command"} |
|  |  | } else { |
|  |  | commands = []string{"/bin/ls"} |
|  |  | } |
|  |  |  |
|  |  | c.EventManager.EnabledCommands = commands |
|  |  | err = Initialize(c, 0) |
|  |  | assert.NoError(t, err) |
|  |  | assert.Equal(t, commands, dataprovider.EnabledActionCommands) |
|  |  |  |
|  |  | dataprovider.EnabledActionCommands = configCopy.EventManager.EnabledCommands |
|  |  | Config = configCopy |
|  |  | } |
|  |  |  |
|  |  | func TestInitializationProxyErrors(t \*testing.T) { |
|  |  | configCopy := Config |
|  |  |  |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[internal/common/eventmanager.go](#diff-41933cc41fd8102717f478b50d27a69ef21fb39a2ae5b586528b397832fbb6e1 "internal/common/eventmanager.go")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/internal/common/eventmanager.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1484,6 +1484,9 @@ func executeHTTPRuleAction(c dataprovider.EventActionHTTPConfig, params \*EventPa |
|  |  | } |
|  |  |  |
|  |  | func executeCommandRuleAction(c dataprovider.EventActionCommandConfig, params \*EventParams) error { |
|  |  | if !dataprovider.IsActionCommandAllowed(c.Cmd) { |
|  |  | return fmt.Errorf("command %q is not allowed", c.Cmd) |
|  |  | } |
|  |  | addObjectData := false |
|  |  | if params.Object != nil { |
|  |  | for \_, k := range c.EnvVars { |
| Expand Down | |  |

142 changes: 142 additions & 0 deletions

142
[internal/common/protocol\_test.go](#diff-922f45cec052702697ca09c4dc3e4afdb3b87f79db7db1bc5c09a790b049cc74 "internal/common/protocol_test.go")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/internal/common/protocol_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4208,6 +4208,148 @@ func TestEventRuleStatues(t \*testing.T) { |
|  |  | require.NoError(t, err) |
|  |  | } |
|  |  |  |
|  |  | func TestEventRuleDisabledCommand(t \*testing.T) { |
|  |  | if runtime.GOOS == osWindows { |
|  |  | t.Skip("this test is not available on Windows") |
|  |  | } |
|  |  | smtpCfg := smtp.Config{ |
|  |  | Host: "127.0.0.1", |
|  |  | Port: 2525, |
|  |  | From: "notification@example.com", |
|  |  | TemplatesPath: "templates", |
|  |  | } |
|  |  | err := smtpCfg.Initialize(configDir, true) |
|  |  | require.NoError(t, err) |
|  |  |  |
|  |  | saveObjectScriptPath := filepath.Join(os.TempDir(), "provider.sh") |
|  |  | outPath := filepath.Join(os.TempDir(), "provider\_out.json") |
|  |  | err = os.WriteFile(saveObjectScriptPath, getSaveProviderObjectScriptContent(outPath, 0), 0755) |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | a1 := dataprovider.BaseEventAction{ |
|  |  | Name: "a1", |
|  |  | Type: dataprovider.ActionTypeCommand, |
|  |  | Options: dataprovider.BaseEventActionOptions{ |
|  |  | CmdConfig: dataprovider.EventActionCommandConfig{ |
|  |  | Cmd: saveObjectScriptPath, |
|  |  | Timeout: 10, |
|  |  | EnvVars: []dataprovider.KeyValue{ |
|  |  | { |
|  |  | Key: "SFTPGO\_OBJECT\_DATA", |
|  |  | Value: "{{ObjectData}}", |
|  |  | }, |
|  |  | }, |
|  |  | }, |
|  |  | }, |
|  |  | } |
|  |  | a2 := dataprovider.BaseEventAction{ |
|  |  | Name: "a2", |
|  |  | Type: dataprovider.ActionTypeEmail, |
|  |  | Options: dataprovider.BaseEventActionOptions{ |
|  |  | EmailConfig: dataprovider.EventActionEmailConfig{ |
|  |  | Recipients: []string{"test3@example.com"}, |
|  |  | Subject: `New "{{Event}}" from "{{Name}}"`, |
|  |  | Body: "Object name: {{ObjectName}} object type: {{ObjectType}} Data: {{ObjectData}}", |
|  |  | }, |
|  |  | }, |
|  |  | } |
|  |  |  |
|  |  | a3 := dataprovider.BaseEventAction{ |
|  |  | Name: "a3", |
|  |  | Type: dataprovider.ActionTypeEmail, |
|  |  | Options: dataprovider.BaseEventActionOptions{ |
|  |  | EmailConfig: dataprovider.EventActionEmailConfig{ |
|  |  | Recipients: []string{"failure@example.com"}, |
|  |  | Subject: `Failed "{{Event}}" from "{{Name}}"`, |
|  |  | Body: "Object name: {{ObjectName}} object type: {{ObjectType}}, IP: {{IP}}", |
|  |  | }, |
|  |  | }, |
|  |  | } |
|  |  | action1, \_, err := httpdtest.AddEventAction(a1, http.StatusCreated) |
|  |  | assert.NoError(t, err) |
|  |  | action2, \_, err := httpdtest.AddEventAction(a2, http.StatusCreated) |
|  |  | assert.NoError(t, err) |
|  |  | action3, \_, err := httpdtest.AddEventAction(a3, http.StatusCreated) |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | r := dataprovider.EventRule{ |
|  |  | Name: "rule", |
|  |  | Status: 1, |
|  |  | Trigger: dataprovider.EventTriggerProviderEvent, |
|  |  | Conditions: dataprovider.EventConditions{ |
|  |  | ProviderEvents: []string{"add"}, |
|  |  | Options: dataprovider.ConditionOptions{ |
|  |  | ProviderObjects: []string{"folder"}, |
|  |  | }, |
|  |  | }, |
|  |  | Actions: []dataprovider.EventAction{ |
|  |  | { |
|  |  | BaseEventAction: dataprovider.BaseEventAction{ |
|  |  | Name: action1.Name, |
|  |  | }, |
|  |  | Order: 1, |
|  |  | Options: dataprovider.EventActionOptions{ |
|  |  | StopOnFailure: true, |
|  |  | }, |
|  |  | }, |
|  |  | { |
|  |  | BaseEventAction: dataprovider.BaseEventAction{ |
|  |  | Name: action2.Name, |
|  |  | }, |
|  |  | Order: 2, |
|  |  | }, |
|  |  | { |
|  |  | BaseEventAction: dataprovider.BaseEventAction{ |
|  |  | Name: action3.Name, |
|  |  | }, |
|  |  | Order: 3, |
|  |  | Options: dataprovider.EventActionOptions{ |
|  |  | IsFailureAction: true, |
|  |  | StopOnFailure: true, |
|  |  | }, |
|  |  | }, |
|  |  | }, |
|  |  | } |
|  |  | rule, \_, err := httpdtest.AddEventRule(r, http.StatusCreated) |
|  |  | assert.NoError(t, err) |
|  |  | // restrit command execution |
|  |  | dataprovider.EnabledActionCommands = []string{"/bin/ls"} |
|  |  |  |
|  |  | lastReceivedEmail.reset() |
|  |  | // create a folder to trigger the rule |
|  |  | folder := vfs.BaseVirtualFolder{ |
|  |  | Name: "ftest failed command", |
|  |  | MappedPath: filepath.Join(os.TempDir(), "p"), |
|  |  | } |
|  |  | folder, \_, err = httpdtest.AddFolder(folder, http.StatusCreated) |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | assert.NoFileExists(t, outPath) |
|  |  | assert.Eventually(t, func() bool { |
|  |  | return lastReceivedEmail.get().From != "" |
|  |  | }, 3000\*time.Millisecond, 100\*time.Millisecond) |
|  |  | email := lastReceivedEmail.get() |
|  |  | assert.Len(t, email.To, 1) |
|  |  | assert.True(t, slices.Contains(email.To, "failure@example.com")) |
|  |  | assert.Contains(t, email.Data, `Subject: Failed "add" from "admin"`) |
|  |  | assert.Contains(t, email.Data, fmt.Sprintf("Object name: %s object type: folder", folder.Name)) |
|  |  | lastReceivedEmail.reset() |
|  |  |  |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  |  |
|  |  | \_, err = httpdtest.RemoveFolder(folder, http.StatusOK) |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | \_, err = httpdtest.RemoveEventRule(rule, http.StatusOK) |
|  |  | assert.NoError(t, err) |
|  |  | \_, err = httpdtest.RemoveEventAction(action1, http.StatusOK) |
|  |  | assert.NoError(t, err) |
|  |  | \_, err = httpdtest.RemoveEventAction(action2, http.StatusOK) |
|  |  | assert.NoError(t, err) |
|  |  | \_, err = httpdtest.RemoveEventAction(action3, http.StatusOK) |
|  |  | assert.NoError(t, err) |
|  |  | } |
|  |  |  |
|  |  | func TestEventRuleProviderEvents(t \*testing.T) { |
|  |  | if runtime.GOOS == osWindows { |
|  |  | t.Skip("this test is not available on Windows") |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[internal/config/config.go](#diff-54c7c1af5fa8d5db4dc49f0e8e80e93ba2b1183ba4d5c9e2e5729e6deae6a3cd "internal/config/config.go")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/internal/config/config.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -242,6 +242,9 @@ func Init() { |
|  |  | Metadata: common.MetadataConfig{ |
|  |  | Read: 0, |
|  |  | }, |
|  |  | EventManager: common.EventManagerConfig{ |
|  |  | EnabledCommands: []string{}, |
|  |  | }, |
|  |  | }, |
|  |  | ACME: acme.Configuration{ |
|  |  | Email: "", |
| Expand Down  Expand Up | | @@ -2032,6 +2035,7 @@ func setViperDefaults() { |
|  |  | viper.SetDefault("common.server\_version", globalConf.Common.ServerVersion) |
|  |  | viper.SetDefault("common.tz", globalConf.Common.TZ) |
|  |  | viper.SetDefault("common.metadata.read", globalConf.Common.Metadata.Read) |
|  |  | viper.SetDefault("common.event\_manager.enabled\_commands", globalConf.Common.EventManager.EnabledCommands) |
|  |  | viper.SetDefault("acme.email", globalConf.ACME.Email) |
|  |  | viper.SetDefault("acme.key\_type", globalConf.ACME.KeyType) |
|  |  | viper.SetDefault("acme.certs\_path", globalConf.ACME.CertsPath) |
| Expand Down | |  |

14 changes: 14 additions & 0 deletions

14
[internal/dataprovider/eventrule.go](#diff-df6a3d7a4f3abe11be93a7355b3893294cc100771ab8565befd4071271506e7a "internal/dataprovider/eventrule.go")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/internal/dataprovider/eventrule.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -58,6 +58,9 @@ var ( |
|  |  | ActionTypeBackup, ActionTypeUserQuotaReset, ActionTypeFolderQuotaReset, ActionTypeTransferQuotaReset, |
|  |  | ActionTypeDataRetentionCheck, ActionTypePasswordExpirationCheck, ActionTypeUserExpirationCheck, |
|  |  | ActionTypeUserInactivityCheck, ActionTypeIDPAccountCheck, ActionTypeRotateLogs} |
|  |  | // EnabledActionCommands defines the system commands that can be executed via EventManager, |
|  |  | // an empty list means that any command is allowed to be executed. |
|  |  | EnabledActionCommands []string |
|  |  | ) |
|  |  |  |
|  |  | func isActionTypeValid(action int) bool { |
| Expand Down  Expand Up | | @@ -450,6 +453,14 @@ func (c \*EventActionHTTPConfig) GetHTTPClient() \*http.Client { |
|  |  | return client |
|  |  | } |
|  |  |  |
|  |  | // IsActionCommandAllowed returns true if the specified command is allowed |
|  |  | func IsActionCommandAllowed(cmd string) bool { |
|  |  | if len(EnabledActionCommands) == 0 { |
|  |  | return true |
|  |  | } |
|  |  | return slices.Contains(EnabledActionCommands, cmd) |
|  |  | } |
|  |  |  |
|  |  | // EventActionCommandConfig defines the configuration for a command event target |
|  |  | type EventActionCommandConfig struct { |
|  |  | Cmd string `json:"cmd,omitempty"` |
| Expand All | | @@ -462,6 +473,9 @@ func (c \*EventActionCommandConfig) validate() error { |
|  |  | if c.Cmd == "" { |
|  |  | return util.NewI18nError(util.NewValidationError("command is required"), util.I18nErrorCommandRequired) |
|  |  | } |
|  |  | if !IsActionCommandAllowed(c.Cmd) { |
|  |  | return util.NewValidationError(fmt.Sprintf("command %q is not allowed", c.Cmd)) |
|  |  | } |
|  |  | if !filepath.IsAbs(c.Cmd) { |
|  |  | return util.NewI18nError( |
|  |  | util.NewValidationError("invalid command, it must be an absolute path"), |
| Expand Down | |  |

11 changes: 11 additions & 0 deletions

11
[internal/httpd/httpd\_test.go](#diff-5d436a5fa9015aba81a47cc31edc8ffe8dcb85f9d8a06ae22d0113ae7b913fe0 "internal/httpd/httpd_test.go")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/internal/httpd/httpd_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2395,6 +2395,17 @@ func TestEventActionValidation(t \*testing.T) { |
|  |  | \_, resp, err = httpdtest.AddEventAction(action, http.StatusBadRequest) |
|  |  | assert.NoError(t, err) |
|  |  | assert.Contains(t, string(resp), "invalid command args") |
|  |  | action.Options.CmdConfig.Args = nil |
|  |  | // restrict commands |
|  |  | if runtime.GOOS == osWindows { |
|  |  | dataprovider.EnabledActionCommands = []string{"C:\\cmd.exe"} |
|  |  | } else { |
|  |  | dataprovider.EnabledActionCommands = []string{"/bin/sh"} |
|  |  | } |
|  |  | \_, resp, err = httpdtest.AddEventAction(action, http.StatusBadRequest) |
|  |  | assert.NoError(t, err) |
|  |  | assert.Contains(t, string(resp), "is not allowed") |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  |  |
|  |  | action.Type = dataprovider.ActionTypeEmail |
|  |  | \_, resp, err = httpdtest.AddEventAction(action, http.StatusBadRequest) |
| Expand Down | |  |

32 changes: 17 additions & 15 deletions

32
[internal/httpd/webadmin.go](#diff-7a8bb15b5f54396b96d7c15ff08d175b6265902fbf8a112fbd15c7ec642f4f0c "internal/httpd/webadmin.go")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/internal/httpd/webadmin.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -297,13 +297,14 @@ type rolePage struct { |
|  |  |  |
|  |  | type eventActionPage struct { |
|  |  | basePage |
|  |  | Action dataprovider.BaseEventAction |
|  |  | ActionTypes []dataprovider.EnumMapping |
|  |  | FsActions []dataprovider.EnumMapping |
|  |  | HTTPMethods []string |
|  |  | RedactedSecret string |
|  |  | Error \*util.I18nError |
|  |  | Mode genericPageMode |
|  |  | Action dataprovider.BaseEventAction |
|  |  | ActionTypes []dataprovider.EnumMapping |
|  |  | FsActions []dataprovider.EnumMapping |
|  |  | HTTPMethods []string |
|  |  | EnabledCommands []string |
|  |  | RedactedSecret string |
|  |  | Error \*util.I18nError |
|  |  | Mode genericPageMode |
|  |  | } |
|  |  |  |
|  |  | type eventRulePage struct { |
| Expand Down  Expand Up | | @@ -1088,14 +1089,15 @@ func (s \*httpdServer) renderEventActionPage(w http.ResponseWriter, r \*http.Reque |
|  |  | } |
|  |  |  |
|  |  | data := eventActionPage{ |
|  |  | basePage: s.getBasePageData(title, currentURL, w, r), |
|  |  | Action: action, |
|  |  | ActionTypes: dataprovider.EventActionTypes, |
|  |  | FsActions: dataprovider.FsActionTypes, |
|  |  | HTTPMethods: dataprovider.SupportedHTTPActionMethods, |
|  |  | RedactedSecret: redactedSecret, |
|  |  | Error: getI18nError(err), |
|  |  | Mode: mode, |
|  |  | basePage: s.getBasePageData(title, currentURL, w, r), |
|  |  | Action: action, |
|  |  | ActionTypes: dataprovider.EventActionTypes, |
|  |  | FsActions: dataprovider.FsActionTypes, |
|  |  | HTTPMethods: dataprovider.SupportedHTTPActionMethods, |
|  |  | EnabledCommands: dataprovider.EnabledActionCommands, |
|  |  | RedactedSecret: redactedSecret, |
|  |  | Error: getI18nError(err), |
|  |  | Mode: mode, |
|  |  | } |
|  |  | renderAdminTemplate(w, templateEventAction, data) |
|  |  | } |
| Expand Down | |  |

5 changes: 4 additions & 1 deletion

5
[sftpgo.json](#diff-eaf2c24fdab223960cf2c557819fd1bca6cf5a14d7e9c8109588d86fa1ffe72e "sftpgo.json")

Show comments

[View file](/drakkan/sftpgo/blob/88b1850b5806eee81150873d4e565144b21021fb/sftpgo.json)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -62,7 +62,10 @@ |
|  |  | "entries\_soft\_limit": 100, |
|  |  | "entries\_hard\_limit": 150 |
|  |  | } |
|  |  | ] |
|  |  | ], |
|  |  | "event\_manager": { |
|  |  | "enabled\_commands": [] |
|  |  | } |
|  |  | }, |
|  |  | "acme": { |
|  |  | "domains": [], |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `88b1850`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdrakkan%2Fsftpgo%2Fcommit%2F88b1850b5806eee81150873d4e565144b21021fb) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_948dd904_20250114_231802.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdrakkan%2Fsftpgo%2Fcommit%2Fb524da11e9466d05fe03304713ee1c61bb276ec4)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdrakkan%2Fsftpgo%2Fcommit%2Fb524da11e9466d05fe03304713ee1c61bb276ec4)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=drakkan%2Fsftpgo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[drakkan](/drakkan)
/
**[sftpgo](/drakkan/sftpgo)**
Public

* [Notifications](/login?return_to=%2Fdrakkan%2Fsftpgo) You must be signed in to change notification settings
* [Fork
  761](/login?return_to=%2Fdrakkan%2Fsftpgo)
* [Star
   9.8k](/login?return_to=%2Fdrakkan%2Fsftpgo)

* [Code](/drakkan/sftpgo)
* [Issues
  63](/drakkan/sftpgo/issues)
* [Pull requests
  4](/drakkan/sftpgo/pulls)
* [Discussions](/drakkan/sftpgo/discussions)
* [Actions](/drakkan/sftpgo/actions)
* [Projects
  0](/drakkan/sftpgo/projects)
* [Security](/drakkan/sftpgo/security)
* [Insights](/drakkan/sftpgo/pulse)

Additional navigation options

* [Code](/drakkan/sftpgo)
* [Issues](/drakkan/sftpgo/issues)
* [Pull requests](/drakkan/sftpgo/pulls)
* [Discussions](/drakkan/sftpgo/discussions)
* [Actions](/drakkan/sftpgo/actions)
* [Projects](/drakkan/sftpgo/projects)
* [Security](/drakkan/sftpgo/security)
* [Insights](/drakkan/sftpgo/pulse)

## Commit

[Permalink](/drakkan/sftpgo/commit/b524da11e9466d05fe03304713ee1c61bb276ec4)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

EventManager: disable commands by default

[Browse files](/drakkan/sftpgo/tree/b524da11e9466d05fe03304713ee1c61bb276ec4)
Browse the repository at this point in the history

```
Signed-off-by: Nicola Murino <nicola.murino@gmail.com>
```

* Loading branch information

[![@drakkan](https://avatars.githubusercontent.com/u/553263?s=40&v=4)](/drakkan)

[drakkan](/drakkan/sftpgo/commits?author=drakkan "View all commits by drakkan")
committed
Nov 10, 2024

1 parent
[3dd412f](/drakkan/sftpgo/commit/3dd412f6e328dbf2322bce69248a5084c0e76542)

commit b524da1

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**47 additions**
and
**17 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* internal

  + common

    - internal/common/protocol\_test.go
      [protocol\_test.go](#diff-922f45cec052702697ca09c4dc3e4afdb3b87f79db7db1bc5c09a790b049cc74)
  + dataprovider

    - internal/dataprovider/eventrule.go
      [eventrule.go](#diff-df6a3d7a4f3abe11be93a7355b3893294cc100771ab8565befd4071271506e7a)
  + httpd

    - internal/httpd/httpd\_test.go
      [httpd\_test.go](#diff-5d436a5fa9015aba81a47cc31edc8ffe8dcb85f9d8a06ae22d0113ae7b913fe0)
* templates/webadmin

  + templates/webadmin/eventaction.html
    [eventaction.html](#diff-9b7640a139958f8535f091d06ac4cb39a1541491807d45645c36eae32950de11)

## There are no files selected for viewing

25 changes: 21 additions & 4 deletions

25
[internal/common/protocol\_test.go](#diff-922f45cec052702697ca09c4dc3e4afdb3b87f79db7db1bc5c09a790b049cc74 "internal/common/protocol_test.go")

Show comments

[View file](/drakkan/sftpgo/blob/b524da11e9466d05fe03304713ee1c61bb276ec4/internal/common/protocol_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3928,6 +3928,11 @@ func TestEventRule(t \*testing.T) { |
|  |  | err = os.WriteFile(uploadScriptPath, getUploadScriptContent(movedPath, "", 0), 0755) |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | dataprovider.EnabledActionCommands = []string{uploadScriptPath} |
|  |  | defer func() { |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  | }() |
|  |  |  |
|  |  | action1.Type = dataprovider.ActionTypeCommand |
|  |  | action1.Options = dataprovider.BaseEventActionOptions{ |
|  |  | CmdConfig: dataprovider.EventActionCommandConfig{ |
| Expand Down  Expand Up | | @@ -4265,6 +4270,10 @@ func TestEventRuleDisabledCommand(t \*testing.T) { |
|  |  | }, |
|  |  | }, |
|  |  | } |
|  |  | \_, \_, err = httpdtest.AddEventAction(a1, http.StatusBadRequest) |
|  |  | assert.NoError(t, err) |
|  |  | // Enable the command to allow saving |
|  |  | dataprovider.EnabledActionCommands = []string{a1.Options.CmdConfig.Cmd} |
|  |  | action1, \_, err := httpdtest.AddEventAction(a1, http.StatusCreated) |
|  |  | assert.NoError(t, err) |
|  |  | action2, \_, err := httpdtest.AddEventAction(a2, http.StatusCreated) |
| Expand Down  Expand Up | | @@ -4312,8 +4321,8 @@ func TestEventRuleDisabledCommand(t \*testing.T) { |
|  |  | } |
|  |  | rule, \_, err := httpdtest.AddEventRule(r, http.StatusCreated) |
|  |  | assert.NoError(t, err) |
|  |  | // restrit command execution |
|  |  | dataprovider.EnabledActionCommands = []string{"/bin/ls"} |
|  |  | // restrict command execution |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  |  |
|  |  | lastReceivedEmail.reset() |
|  |  | // create a folder to trigger the rule |
| Expand All | | @@ -4335,8 +4344,6 @@ func TestEventRuleDisabledCommand(t \*testing.T) { |
|  |  | assert.Contains(t, email.Data, fmt.Sprintf("Object name: %s object type: folder", folder.Name)) |
|  |  | lastReceivedEmail.reset() |
|  |  |  |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  |  |
|  |  | \_, err = httpdtest.RemoveFolder(folder, http.StatusOK) |
|  |  | assert.NoError(t, err) |
|  |  |  |
| Expand Down  Expand Up | | @@ -4368,6 +4375,11 @@ func TestEventRuleProviderEvents(t \*testing.T) { |
|  |  | err = os.WriteFile(saveObjectScriptPath, getSaveProviderObjectScriptContent(outPath, 0), 0755) |
|  |  | assert.NoError(t, err) |
|  |  |  |
|  |  | dataprovider.EnabledActionCommands = []string{saveObjectScriptPath} |
|  |  | defer func() { |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  | }() |
|  |  |  |
|  |  | a1 := dataprovider.BaseEventAction{ |
|  |  | Name: "a1", |
|  |  | Type: dataprovider.ActionTypeCommand, |
| Expand Down  Expand Up | | @@ -5231,6 +5243,11 @@ func TestEventActionCommandEnvVars(t \*testing.T) { |
|  |  | envName := "MY\_ENV" |
|  |  | uploadScriptPath := filepath.Join(os.TempDir(), "upload.sh") |
|  |  |  |
|  |  | dataprovider.EnabledActionCommands = []string{uploadScriptPath} |
|  |  | defer func() { |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  | }() |
|  |  |  |
|  |  | err := os.WriteFile(uploadScriptPath, getUploadScriptEnvContent(envName), 0755) |
|  |  | assert.NoError(t, err) |
|  |  | a1 := dataprovider.BaseEventAction{ |
| Expand Down | |  |

5 changes: 1 addition & 4 deletions

5
[internal/dataprovider/eventrule.go](#diff-df6a3d7a4f3abe11be93a7355b3893294cc100771ab8565befd4071271506e7a "internal/dataprovider/eventrule.go")

Show comments

[View file](/drakkan/sftpgo/blob/b524da11e9466d05fe03304713ee1c61bb276ec4/internal/dataprovider/eventrule.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -59,7 +59,7 @@ var ( |
|  |  | ActionTypeDataRetentionCheck, ActionTypePasswordExpirationCheck, ActionTypeUserExpirationCheck, |
|  |  | ActionTypeUserInactivityCheck, ActionTypeIDPAccountCheck, ActionTypeRotateLogs} |
|  |  | // EnabledActionCommands defines the system commands that can be executed via EventManager, |
|  |  | // an empty list means that any command is allowed to be executed. |
|  |  | // an empty list means that no command is allowed to be executed. |
|  |  | EnabledActionCommands []string |
|  |  | ) |
|  |  |  |
| Expand Down  Expand Up | | @@ -455,9 +455,6 @@ func (c \*EventActionHTTPConfig) GetHTTPClient() \*http.Client { |
|  |  |  |
|  |  | // IsActionCommandAllowed returns true if the specified command is allowed |
|  |  | func IsActionCommandAllowed(cmd string) bool { |
|  |  | if len(EnabledActionCommands) == 0 { |
|  |  | return true |
|  |  | } |
|  |  | return slices.Contains(EnabledActionCommands, cmd) |
|  |  | } |
|  |  |  |
| Expand Down | |  |

19 changes: 19 additions & 0 deletions

19
[internal/httpd/httpd\_test.go](#diff-5d436a5fa9015aba81a47cc31edc8ffe8dcb85f9d8a06ae22d0113ae7b913fe0 "internal/httpd/httpd_test.go")

Show comments

[View file](/drakkan/sftpgo/blob/b524da11e9466d05fe03304713ee1c61bb276ec4/internal/httpd/httpd_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1840,6 +1840,10 @@ func TestBasicActionRulesHandling(t \*testing.T) { |
|  |  | }, |
|  |  | }, |
|  |  | } |
|  |  | dataprovider.EnabledActionCommands = []string{a.Options.CmdConfig.Cmd} |
|  |  | defer func() { |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  | }() |
|  |  | \_, \_, err = httpdtest.UpdateEventAction(a, http.StatusOK) |
|  |  | assert.NoError(t, err) |
|  |  | // invalid type |
| Expand Down  Expand Up | | @@ -2374,13 +2378,24 @@ func TestEventActionValidation(t \*testing.T) { |
|  |  | assert.NoError(t, err) |
|  |  | assert.Contains(t, string(resp), "command is required") |
|  |  | action.Options.CmdConfig.Cmd = "relative" |
|  |  | dataprovider.EnabledActionCommands = []string{action.Options.CmdConfig.Cmd} |
|  |  | defer func() { |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  | }() |
|  |  |  |
|  |  | \_, resp, err = httpdtest.AddEventAction(action, http.StatusBadRequest) |
|  |  | assert.NoError(t, err) |
|  |  | assert.Contains(t, string(resp), "invalid command, it must be an absolute path") |
|  |  | action.Options.CmdConfig.Cmd = filepath.Join(os.TempDir(), "cmd") |
|  |  | \_, resp, err = httpdtest.AddEventAction(action, http.StatusBadRequest) |
|  |  | assert.NoError(t, err) |
|  |  | assert.Contains(t, string(resp), "is not allowed") |
|  |  |  |
|  |  | dataprovider.EnabledActionCommands = []string{action.Options.CmdConfig.Cmd} |
|  |  | \_, resp, err = httpdtest.AddEventAction(action, http.StatusBadRequest) |
|  |  | assert.NoError(t, err) |
|  |  | assert.Contains(t, string(resp), "invalid command action timeout") |
|  |  |  |
|  |  | action.Options.CmdConfig.Timeout = 30 |
|  |  | action.Options.CmdConfig.EnvVars = []dataprovider.KeyValue{ |
|  |  | { |
| Expand Down  Expand Up | | @@ -24027,6 +24042,10 @@ func TestWebEventAction(t \*testing.T) { |
|  |  | }, |
|  |  | }, |
|  |  | } |
|  |  | dataprovider.EnabledActionCommands = []string{action.Options.CmdConfig.Cmd} |
|  |  | defer func() { |
|  |  | dataprovider.EnabledActionCommands = nil |
|  |  | }() |
|  |  | form.Set("type", fmt.Sprintf("%d", action.Type)) |
|  |  | req, err = http.NewRequest(http.MethodPost, path.Join(webAdminEventActionPath, action.Name), |
|  |  | bytes.NewBuffer([]byte(form.Encode()))) |
| Expand Down | |  |

15 changes: 6 additions & 9 deletions

15
[templates/webadmin/eventaction.html](#diff-9b7640a139958f8535f091d06ac4cb39a1541491807d45645c36eae32950de11 "templates/webadmin/eventaction.html")

Show comments

[View file](/drakkan/sftpgo/blob/b524da11e9466d05fe03304713ee1c61bb276ec4/templates/webadmin/eventaction.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -44,6 +44,11 @@ <h3 data-i18n="{{.Title}}" class="card-title section-title"></h3> |
|  |  | <div class="col-md-9"> |
|  |  | <select id="idType" name="type" class="form-select" data-control="i18n-select2" data-hide-search="true"> |
|  |  | {{- range .ActionTypes}} |
|  |  | {{- if eq .Value 2}} |
|  |  | {{- if not $.EnabledCommands}} |
|  |  | {{- continue}} |
|  |  | {{- end}} |
|  |  | {{- end}} |
|  |  | <option value="{{.Value}}" {{if eq $.Action.Type .Value }}selected{{end}} data-i18n="{{.Name}}"></option> |
|  |  | {{- end}} |
|  |  | </select> |
| Expand Down  Expand Up | | @@ -400,21 +405,13 @@ <h3 data-i18n="actions.multipart\_body" class="card-title section-title-inner">Mu |
|  |  | <div class="form-group row action-type action-cmd mt-10"> |
|  |  | <label for="idCmdPath" data-i18n="actions.types.command" class="col-md-3 col-form-label">Command</label> |
|  |  | <div class="col-md-9"> |
|  |  | <select id="idCmdPath" name="cmd\_path" class="form-select" data-control="i18n-select2" data-hide-search="true"> |
|  |  | <select id="idCmdPath" name="cmd\_path" class="form-select" data-control="i18n-select2" data-hide-search="false"> |
|  |  | {{- range .EnabledCommands}} |
|  |  | <option value="{{.}}" {{if eq $.Action.Options.CmdConfig.Cmd . }}selected{{end}}>{{.}}</option> |
|  |  | {{- end}} |
|  |  | </select> |
|  |  | </div> |
|  |  | </div> |
|  |  | {{- else}} |
|  |  | <div class="form-group row action-type action-cmd mt-10"> |
|  |  | <label for="idCmdPath" data-i18n="actions.types.command" class="col-md-3 col-form-label">Command</label> |
|  |  | <div class="col-md-9"> |
|  |  | <input id="idCmdPath" type="text" class="form-control" name="cmd\_path" value="{{.Action.Options.CmdConfig.Cmd}}" aria-describedby="idCmdPathHelp" /> |
|  |  | <div id="idCmdPathHelp" class="form-text" data-i18n="actions.command\_help"></div> |
|  |  | </div> |
|  |  | </div> |
|  |  | {{- end}} |
|  |  |  |
|  |  | <div class="form-group row action-type action-cmd mt-10"> |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b524da1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdrakkan%2Fsftpgo%2Fcommit%2Fb524da11e9466d05fe03304713ee1c61bb276ec4) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3bad9ade_20250114_231805.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdrakkan%2Fsftpgo%2Fsecurity%2Fadvisories%2FGHSA-49cc-xrjf-9qf7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdrakkan%2Fsftpgo%2Fsecurity%2Fadvisories%2FGHSA-49cc-xrjf-9qf7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=drakkan%2Fsftpgo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[drakkan](/drakkan)
/
**[sftpgo](/drakkan/sftpgo)**
Public

* [Notifications](/login?return_to=%2Fdrakkan%2Fsftpgo) You must be signed in to change notification settings
* [Fork
  761](/login?return_to=%2Fdrakkan%2Fsftpgo)
* [Star
   9.8k](/login?return_to=%2Fdrakkan%2Fsftpgo)

* [Code](/drakkan/sftpgo)
* [Issues
  63](/drakkan/sftpgo/issues)
* [Pull requests
  4](/drakkan/sftpgo/pulls)
* [Discussions](/drakkan/sftpgo/discussions)
* [Actions](/drakkan/sftpgo/actions)
* [Projects
  0](/drakkan/sftpgo/projects)
* [Security](/drakkan/sftpgo/security)
* [Insights](/drakkan/sftpgo/pulse)

Additional navigation options

* [Code](/drakkan/sftpgo)
* [Issues](/drakkan/sftpgo/issues)
* [Pull requests](/drakkan/sftpgo/pulls)
* [Discussions](/drakkan/sftpgo/discussions)
* [Actions](/drakkan/sftpgo/actions)
* [Projects](/drakkan/sftpgo/projects)
* [Security](/drakkan/sftpgo/security)
* [Insights](/drakkan/sftpgo/pulse)

# Restrict command execution from the EventManager

Moderate

[drakkan](/drakkan)
published
GHSA-49cc-xrjf-9qf7
Nov 21, 2024

## Package

gomod

sftpgo
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

>= 2.4.0, < 2.6.3

## Patched versions

2.6.3

## Description

### Impact

One powerful feature of SFTPGo is the ability to have the EventManager execute scripts or run applications in response to certain events.

This feature is very common in all software similar to SFTPGo and is generally unrestricted.

However, any SFTPGo administrator with permission to run a script has access to the underlying OS/container with the same permissions as the user running SFTPGo, so they can access the database and server configurations.

This is unexpected for some SFTPGo administrators who think that there is a clear distinction between accessing the system shell and accessing the SFTPGo WebAdmin UI.

### Patches

To avoid this confusion, running system commands is now disabled by default, and an allow list has been added so that system administrators configuring SFTPGo must explicitly define which commands are allowed to be configured from the WebAdmin UI.

[88b1850](https://github.com/drakkan/sftpgo/commit/88b1850b5806eee81150873d4e565144b21021fb)

[b524da1](https://github.com/drakkan/sftpgo/commit/b524da11e9466d05fe03304713ee1c61bb276ec4)

### Workarounds

Allow EventManager to be used only by SFTPGo administrators who also have shell access.

### Severity

Moderate

### CVE ID

CVE-2024-52309

### Weaknesses

No CWEs

### Credits

* [![@hyperreality](https://avatars.githubusercontent.com/u/6343433?s=40&v=4)](/hyperreality)
  [hyperreality](/hyperreality)
  Finder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


