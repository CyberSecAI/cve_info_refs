=== Content from github.com_bbf36635_20250114_185841.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Favwo%2Fwhistle%2Fcommit%2Fd1b8ca275dc4e453bd2efed392c0fd4b92f73cdf)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Favwo%2Fwhistle%2Fcommit%2Fd1b8ca275dc4e453bd2efed392c0fd4b92f73cdf)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=avwo%2Fwhistle)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[avwo](/avwo)
/
**[whistle](/avwo/whistle)**
Public

* [Notifications](/login?return_to=%2Favwo%2Fwhistle) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2Favwo%2Fwhistle)
* [Star
   14.5k](/login?return_to=%2Favwo%2Fwhistle)

* [Code](/avwo/whistle)
* [Issues
  31](/avwo/whistle/issues)
* [Pull requests
  16](/avwo/whistle/pulls)
* [Actions](/avwo/whistle/actions)
* [Projects
  0](/avwo/whistle/projects)
* [Wiki](/avwo/whistle/wiki)
* [Security](/avwo/whistle/security)
* [Insights](/avwo/whistle/pulse)

Additional navigation options

* [Code](/avwo/whistle)
* [Issues](/avwo/whistle/issues)
* [Pull requests](/avwo/whistle/pulls)
* [Actions](/avwo/whistle/actions)
* [Projects](/avwo/whistle/projects)
* [Wiki](/avwo/whistle/wiki)
* [Security](/avwo/whistle/security)
* [Insights](/avwo/whistle/pulse)

## Commit

[Permalink](/avwo/whistle/commit/d1b8ca275dc4e453bd2efed392c0fd4b92f73cdf)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

feat: refine --allowOrigin

[Browse files](/avwo/whistle/tree/d1b8ca275dc4e453bd2efed392c0fd4b92f73cdf)
Browse the repository at this point in the history

* Loading branch information

[![@avwo](https://avatars.githubusercontent.com/u/11450939?s=40&v=4)](/avwo)

[avwo](/avwo/whistle/commits?author=avwo "View all commits by avwo")
committed
Sep 4, 2024

1 parent
[ed8002e](/avwo/whistle/commit/ed8002e8265bfbaaf9dbc0c83f7c22d4b775e42d)

commit d1b8ca2

Showing
**1 changed file**
with
**32 additions**
and
**39 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

71 changes: 32 additions & 39 deletions

71
[biz/webui/lib/index.js](#diff-33320496561356a115d056b4c1c02daa2106f805b21dd9447dc33c9caf0d27f8 "biz/webui/lib/index.js")

Show comments

[View file](/avwo/whistle/blob/d1b8ca275dc4e453bd2efed392c0fd4b92f73cdf/biz/webui/lib/index.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -291,47 +291,17 @@ app.use(function(req, res, next) { |
|  |  | if (req.headers.host !== 'rootca.pro') { |
|  |  | return next(); |
|  |  | } |
|  |  | var type = 'crt'; |
|  |  | if (!req.path.indexOf('/cer')) { |
|  |  | type = 'cer'; |
|  |  | var type = 'cer'; |
|  |  | if (!req.path.indexOf('/crt')) { |
|  |  | type = 'crt'; |
|  |  | } else if (!req.path.indexOf('/pem')) { |
|  |  | type = 'pem'; |
|  |  | } |
|  |  | res.download(getRootCAFile(), 'rootCA.' + type); |
|  |  | }); |
|  |  |  |
|  |  | function checkAllowOrigin(req) { |
|  |  | if (config.allowAllOrigin || |
|  |  | req.headers['sec-fetch-site'] === 'same-origin' || |
|  |  | ALLOW\_CROSS\_URLS.indexOf(req.path) !== -1) { |
|  |  | return true; |
|  |  | } |
|  |  | var host = req.headers['x-whistle-origin-host']; |
|  |  | function isAllowHost(host) { |
|  |  | var list = config.allowOrigin; |
|  |  | if (!host) { |
|  |  | host = req.headers.origin; |
|  |  | if (!host || typeof host !== 'string') { |
|  |  | return true; |
|  |  | } |
|  |  | var index = host.indexOf('://'); |
|  |  | if (index !== -1) { |
|  |  | host = host.substring(index + 3); |
|  |  | } |
|  |  | host = util.parseHost(host)[0]; |
|  |  | if (!host) { |
|  |  | return false; |
|  |  | } |
|  |  | if (!list) { |
|  |  | if (config.isWebUIHost(host)) { |
|  |  | req.\_isWebUIHost = true; |
|  |  | return true; |
|  |  | } |
|  |  | return false; |
|  |  | } |
|  |  | } |
|  |  | if (host === '\*') { |
|  |  | return false; |
|  |  | } |
|  |  | if (list) { |
|  |  | for (var i = 0, len = list.length; i < len; i++) { |
|  |  | var h = list[i]; |
| Expand All | | @@ -340,18 +310,41 @@ function checkAllowOrigin(req) { |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | if (config.isWebUIHost(host)) { |
|  |  | req.\_isWebUIHost = true; |
|  |  | } |
|  |  |  |
|  |  | function checkInternalPath(req) { |
|  |  | if (config.allowAllOrigin || ALLOW\_CROSS\_URLS.indexOf(req.path) !== -1) { |
|  |  | return true; |
|  |  | } |
|  |  | return false; |
|  |  | var host = req.headers['x-whistle-origin-host']; |
|  |  | return !host || isAllowHost(host); |
|  |  | } |
|  |  |  |
|  |  | function checkAllowOrigin(req) { |
|  |  | var host = req.headers.origin; |
|  |  | if (!host || typeof host !== 'string' || |
|  |  | req.headers['sec-fetch-site'] === 'same-origin') { |
|  |  | return false; |
|  |  | } |
|  |  | if (config.allowAllOrigin) { |
|  |  | return true; |
|  |  | } |
|  |  | if (!config.allowOrigin) { |
|  |  | return false; |
|  |  | } |
|  |  | var index = host.indexOf('://'); |
|  |  | if (index !== -1) { |
|  |  | host = host.substring(index + 3); |
|  |  | } |
|  |  | host = util.parseHost(host)[0]; |
|  |  | return host && isAllowHost(host); |
|  |  | } |
|  |  |  |
|  |  | function cgiHandler(req, res) { |
|  |  | if (UP\_PATH\_REGEXP.test(req.path) || !checkAllowOrigin(req)) { |
|  |  | if (UP\_PATH\_REGEXP.test(req.path) || !checkInternalPath(req)) { |
|  |  | return res.status(403).end('Forbidden'); |
|  |  | } |
|  |  | if (!req.\_isWebUIHost && req.headers.origin) { |
|  |  | if (checkAllowOrigin(req)) { |
|  |  | res.setHeader('access-control-allow-origin', req.headers.origin); |
|  |  | res.setHeader('access-control-allow-credentials', true); |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d1b8ca2`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Favwo%2Fwhistle%2Fcommit%2Fd1b8ca275dc4e453bd2efed392c0fd4b92f73cdf) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.sonarsource.com_f395748f_20250114_185841.html ===
NEW![Sonar has entered a definitive agreement to acquire Tidelift! Read the press release.](/company/press-releases/sonar-to-acquire-tidelift/) [![](data:image/svg+xml;charset=utf-8...)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=128&h=32&auto=format&fit=clip)](/ "Home")

* Solutions

  Use Cases

  [AI-assisted & quality-assured codeEnsure code generated by AI assistants is of the highest quality](/solutions/ai/)[DevOps transformationHarness the full potential of DevOps by reducing roll backs and improving quality of releases](/solutions/devops-transformation/)[Code coverageEnsure code quality and security by facilitating faster debugging through clear visibility of coverage gaps.](/solutions/code-coverage/) [Reduce & manage technical debtMaximize innovation by proactively managing technical debt](/solutions/reduce-technical-debt/)[Secure by designIntegrate code security in compliance with NIST Secure Software Development Framework](/solutions/secure-by-design-code/)[All Use CasesRead more about Sonar Use cases with blog articles, technical articles and developer guides](/solutions/use-cases/)

  Clean Code

  [What is clean codeA detailed definition of Clean Code](/solutions/clean-code/)[Power of clean codeBusiness success built on Clean Code](/solutions/power-of-clean-code/)[Security starts with Clean CodeStatic Application Security Testing with Sonar](/solutions/security/)[Clean as You CodeOur unique approach to Clean Code](/solutions/our-unique-approach/)

  Something For Everyone

  [For DevelopersFind and fix issues as you code](/solutions/for-developers/)[For DevOpsBuild your apps on Clean Code foundations](/solutions/infrastructure-as-code/)[For EnterpriseClean Code delivery from development to production](/solutions/for-enterprise/)[For the Public SectorClean Code for the public sector](/solutions/public-sector/)
* Products

  Industry Leading Products

  [![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/aa3b1f02-f1b0-448f-a3f2-a1bd32923a08/SQ_Logo_Cloud_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarCloudCloud-based static analysis tool for your CI/CD workflows](/products/sonarcloud/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/bdac1871-464e-4051-88db-7df20c3bfffa/SQ_Logo_Server_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarQubeSelf-managed static analysis tool for continuous codebase inspection](/products/sonarqube/)[![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/49f23af2-a29b-4d0f-95d7-ffd361f375e1/SQ_Logo_IDE_Light%20Backgrounds.svg?w=176&h=48&auto=format&fit=crop)Formerly SonarLintFree IDE extension that provides on-the-fly analysis and coding guidance](/products/sonarlint/)

  Languages and Frameworks

  [Java](/knowledge/languages/java/)[JavaScript](/knowledge/languages/js/)[TypeScript](/knowledge/languages/ts/)[Python](/knowledge/languages/python/)[C#](/knowledge/languages/csharp/)[C++](/knowledge/languages/cpp/)[C](/knowledge/languages/c/)[PHP](/knowledge/languages/php/)[Kotlin](/knowledge/languages/kotlin/)[See All](/lp/knowledge/languages/)
* Resources

  Learn About Clean Code

  [BlogStay connected with our latest development news and articles](/blog/)[Events hubLet's meet up online or in person - browse our conferences and webinars, or watch previous talks](/resources/events/)[Customer StoriesCheck out Sonar implementation success stories](/resources/customer-stories/)[White PapersFind in-depth articles on clean code](/resources/white-papers/)[LearnDeveloper learning hub - covering essential topics](/learn/)[Solution BriefsOur library of solution briefs](/resources/solution-briefs/)

  Go In Depth

  [SonarQube Server DocumentationFind more information on the technical details of SonarQube Server](https://docs.sonarsource.com/sonarqube/latest/)[SonarQube Cloud DocumentationFind more information on the technical details of SonarQube Cloud](https://docs.sonarsource.com/sonarcloud/)[SonarQube for IDE DocumentationFind more information on the technical details of SonarQube IDE](https://docs.sonarsource.com/sonarlint/)[Explore SonarpediaExplore our publicly available multi-language rules database](https://rules.sonarsource.com/)[LanguagesSee our multi-language coverage](/knowledge/languages/)
* Company

  Deliver Better Software

  [About UsSonar’s industry leading solution enables developers to write clean code and remediate existing code organically](/company/about/)[CareersJoin our growing team](/company/careers/)[Commitment to open sourceOur commitment to transparency, security, and continuous improvement](/solutions/commitment-to-open-source/)[CommunityGet latest updates, suggest features, and share your knowledge](https://community.sonarsource.com/)[PartnersSonar partners with the best resellers to bring Clean Code closer to you](/company/partners/)[Contact usHave questions? Get in touch](/company/contact/)

  Media

  [NewsroomNews announcements, media coverage, and more](/company/newsroom/)[CoverageFind articles about Sonar in the news](/company/coverage/)[Press ReleasesThe latest Sonar updates](/company/press-releases/)[CustomersAn overview of customers using Sonar by industry](/company/customers/)[Press KitExecutive headshots, quick stats, customer logos, and more](/company/press-kit/)
[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)
Search modal toggle button[Start for free](/open-source-editions/)[Explore pricing](/plans-and-pricing/)Mobile menu toggle button

Blog post

# Never Underestimate CSRF: Why Origin Reflection is a Bad Idea

![](data:image/svg+xml;charset=utf-8...)![Paul Gerste photo]()![Paul Gerste photo](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/e712603b-cf90-4c56-a666-cd2691b3def2/404b3fe2-4818-41dc-bbe0-9cae851eb542_Paul_Gerste.jpg?w=800&h=800&auto=format&fit=crop)

Paul Gerste

Vulnerability Researcher

December 10, 2024

Date

* [Security](/blog/tag/security/)
![](data:image/svg+xml;charset=utf-8...)![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/c9a1ac0a-f9cc-4bf0-9154-3d6de380a8d2/Never%20Underestimate%20CSRF_Blog-landscape.png?w=2400&h=1256&auto=format&fit=crop)![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/c9a1ac0a-f9cc-4bf0-9154-3d6de380a8d2/Never%20Underestimate%20CSRF_Blog-landscape.png?w=2400&h=1256&auto=format&fit=crop)

[Whistle](https://github.com/avwo/whistle "Whistle") is a popular HTTP debugging proxy with over 14k stars on GitHub. It helps users debug HTTP(S) requests on their system and comes with a wide range of match-and-modify features. Its capabilities can even be extended using a plugin system.

In our continuous effort to help secure open-source projects and improve our static code security analysis, we regularly scan open-source projects via SonarQube Cloud and evaluate the findings. In fact, everybody can also do it – [SonarQube Cloud](https://www.sonarsource.com/products/sonarcloud/ "SonarQube Cloud") is a free code analysis product for open-source projects, regardless of their size or language.

While scanning Whistle's code base, SonarQube reported a CORS misconfiguration issue that turned out to be a serious real-world vulnerability. In this blog post, we will explain the technical details behind the issue, how it can lead to a full system compromise, and how to avoid such bugs in your code.

## Impact

We reported the issue to the Whistle maintainer in June 2024, along with patch suggestions. After they developed an initial fix, we discovered the issue was broader than we first thought. Unfortunately, the vulnerability was never fully fixed, and we stopped hearing back from the maintainer. Therefore, **the latest version of Whistle** (2.9.90 at the time of writing this blog post) **is still vulnerable**. Since our 90-day responsible disclosure deadline has elapsed, we release this information to allow users to protect themselves.

The vulnerability ([CVE-2024-55500](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-55500 "CVE-2024-55500")) is a Cross-Site Request Forgery (CSRF) issue caused by a CORS misconfiguration. To exploit the vulnerability, an attacker has to trick a victim into visiting a malicious webpage. Once the victim visits, the site can exploit the Whistle instance on the victim's machine without the user noticing it. As a result, the attacker can execute arbitrary system commands on the victim's machine:

## Technical Details

Whistle aims to help developers and other technical users debug HTTP requests made in their systems. It can help develop and debug complex applications or trouble-shooting proprietary programs.

To enable debugging of all HTTP requests made on a system, Whistle installs itself as an intercepting proxy. To support HTTPS interception, it also registers a custom certificate authority (CA) that can sign certificates on the fly. After installing itself, Whistle lists all requests in a web interface:

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8cd80aab-7d69-4603-9be9-68fae163a77e/whistle-requests.png?w=2560&h=1325&auto=format&fit=crop)

Users can create rules for automatic request modifications, such as redirects, changing request headers, or modifying response bodies. For this, the user must create rules that match URL patterns. These rules can use values that the user creates, for example, to replace a response body with a static value.

### The Bug: Origin Reflection

While investigating issues raised in Whistle's code by SonarQube, we came across the following security hotspot. Such security hotspots highlight parts of your code that are security-sensitive and require a thorough human review:

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/5b794a56-47bf-4e45-a0d9-2301a7c49b9b/whistle-issue.png?w=814&h=197&auto=format&fit=crop)

If you want to follow along and explore the vulnerable code section, you can [check out the issue on SonarQube Cloud](https://sonarcloud.io/project/security_hotspots?id=SonarResearch_whistle-blogpost&hotspots=AZOR1FlOQuTUchWtx3pF "check out the issue on SonarQube Cloud").

What is highlighted here is a potential Cross-Origin Resource Sharing (CORS) configuration issue. CORS can be used by a webserver to allow other websites to interact with it. This is done by setting special `Access-Control-*` HTTP response headers that the browser will abide by.

In the highlighted code snippet, we can see that the request's `Origin` header is reflected in the response's `Access-Control-Allow-Origin` header. This is unsafe because it essentially enables CORS for all origins, allowing any website to send requests to the server and read the response!

If sensitive information is contained in any response, malicious websites can read it when the user visits them. Similarly, the malicious website can also control what data is included in the request, resulting in a Cross-Site Request Forgery (CSRF) vulnerability. This affects Whistle's `/cgi-bin/*` API endpoints, which can now be called from any website. In addition, the `Access-Control-Allow-Credentials` header is set to `true`, causing the browser to include cookies or basic authentication information in these cross-site requests.

The impact of such a vulnerability depends on the actions that an attacker can trigger by forging cross-site requests. As we will see next, the implications are critical in the context of Whistle. CORS controls not only the origins but also the data that can be contained in requests. More specifically, the `Access-Control-Allow-Headers` response header tells the browser which headers can be sent in the cross-origin request.

At first glance, it looked like Whistle's API only used JSON request bodies. This would require the attacker page to set the `Content-Type: application/json` header so that the Express.js-based server correctly parses the request. However, it turned out that the server always tries to parse *both* URL-encoded form data and JSON requests and uses whichever works:

[biz/webui/lib/index.js](https://github.com/avwo/whistle/blob/v2.9.74/biz/webui/lib/index.js#L466-L471 "biz/webui/lib/index.js"):

```
app.all('/cgi-bin/*', function(req, res, next) {
  req.isUploadReq = UPLOAD_URLS.indexOf(req.path) !== -1;
  return req.isUploadReq ? uploadUrlencodedParser(req, res, next) : urlencodedParser(req, res, next);
}, function(req, res, next) {
  return req.isUploadReq ? uploadJsonParser(req, res, next) : jsonParser(req, res, next);
}, cgiHandler);
```

To send a form-encoded body, the attacker would need to set a `Content-Type` header, this time with the value of `application/x-www-form-urlencoded`. But shouldn't this also fail since `Content-Type` is not in the server's `Access-Control-Allow-Headers`?

In this case, the attacker is lucky because of the [Simple Requests](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests "Simple Requests") concept. Simple Requests can be sent cross-origin without the need for CORS. Similarly, parts of Simple Requests, such as [safelisted request headers](https://fetch.spec.whatwg.org/#simple-header "safelisted request headers"), can be included in cross-origin requests, even when CORS did not specifically negotiate them. This includes the `Content-Type` header when its value is either `application/x-www-form-urlencoded`, `multipart/form-data`, or `text/plain`.

This means the attacker can send a CORS request with `Content-Type: application/x-www-form-urlencoded` even though the server does not explicitly allow the `Content-Type` header! Attackers can now send arbitrary request bodies to any `/cgi-bin/*` handler and interact with potentially sensitive features of Whistle.

We reported this to the maintainer, and they [fixed](https://github.com/avwo/whistle/commit/d1b8ca275dc4e453bd2efed392c0fd4b92f73cdf "fixed") the origin reflection behavior by only sending the CORS headers when the request comes from an allowed origin. However, while reviewing the patch, we noticed that attackers can exploit this without using CORS at all!

We already talked about the `Content-Type` header in Simple Requests, but what else does a request need to be considered simple? There are several minor requirements, but the important one for our case is that a Simple Request can only use the `GET`, `POST`, or `HEAD` methods, which work with most of Whistle's API endpoints.

This shows that an attacker can craft a Simple Request that is still processed by Whistle! We also reported this to the maintainer with suggestions on how to fix it. Unfortunately, they stopped communicating with us since then, and the non-CORS variant has never been fixed. As of the time of writing this blog post, it can still be exploited using a Simple Request.

### Exploring the Impact

Let's try to understand this vulnerability's impact on Whistle and its users. As mentioned earlier, the attacker can talk to any `/cgi-bin/*` endpoint and control the request body. There are various reachable handlers, but two of them stand out.

The `/cgi-bin/rules/select` endpoint can enable new interception rules. This would allow an attacker to modify requests and responses for specific URLs. The `/cgi-bin/values/add` endpoint can be used to add new values that can be used in rules, such as alternate response bodies. However, there is a feature that is even more interesting from an attacker's point of view. Whistle enables users to create dynamic rules by providing a [scripting interface](https://wproxy.org/whistle/rules/reqScript.html "scripting interface"):

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/b7ec5869-3628-4e30-8764-3545825ee81a/whistle-scripting-interface.png?w=1184&h=486&auto=format&fit=crop)

These scripts are executed for each request or response that matches the rule's pattern. During execution, they are isolated from Whistle's main environment using Node.js's `vm` module. [According to its documentation](https://nodejs.org/api/vm.html#:~:text=The%20node%3Avm%20module%20is%20not%20a%20security%20mechanism.%20Do%20not%20use%20it%20to%20run%20untrusted%20code. "According to its documentation"), this module is not considered a security boundary, making it easy for an attacker to break out and execute arbitrary code on the system.

In the case of Whistle, this is done by getting access to the global scope outside of the isolated environment (called "isolate" from here). Whistle passes some objects into the isolate's global context when running the script, such as a `values` object. Since this object was created outside of the isolate, it also references other things outside of the isolate.

By accessing `values.constructor.constructor`, an attacker can get a reference to the function constructor of the outside scope. Calling this constructor inside the isolate allows an attacker to create new functions as if they were declared in the host's scope. Such functions can then retrieve useful globals such as `process`:

```
values.constructor.constructor('return process')()
```

This expression creates and calls a function that returns the `process` object of the host scope. From there, the attacker can get access to the `require` function via `process.mainModule.require` and use it to load arbitrary modules, e.g., to execute commands:

```
process.mainModule.require('child_process').execSync('calc')
```

These steps showed that an attacker could add a malicious payload using the `/cgi-bin/values/add` endpoint and then reference it when creating a rule that executes it as a request script for a specific domain. The final attack flow looks like this:

![](data:image/svg+xml;charset=utf-8...)![]()![](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/669482f5-37bf-4a6c-b053-8a86016b5d6a/Whistle%20Attack%20Flow.png?w=1920&h=1080&auto=format&fit=crop)

### Patch

As mentioned earlier, the vulnerability is only partially patched, and the latest version of Whistle is still vulnerable (as of this blog post). The maintainer's initial fix successfully prevented the origin reflection:

```
if (checkAllowOrigin(req)) {
  res.setHeader('access-control-allow-origin', req.headers.origin);
  res.setHeader('access-control-allow-credentials', true);
}
```

Technically, this still reflects the request's origin, but it is limited to trusted origins. However, as we learned earlier, Simple Requests can still be used to communicate with Whistle's API because they don't require CORS. To fix this issue, we suggested checking the `Sec-Fetch-Site` header to identify cross-origin requests and block them:

```
if (req.headers['sec-fetch-site'] !== 'same-origin') {
  return res.status(403).end('Forbidden');
}
```

This header is a so-called [forbidden header,](https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_header_name "forbidden header,") which is set by the browser and cannot be changed by the page. It will only have the value `same-origin` when the requesting page is of the same origin as the destination URL, making it a good solution for this problem.

## Timeline

| Date | Action |
| --- | --- |
| 2024-06-20 | We report all issues to the Whistle maintainer via email |
| 2024-08-21 | We reach out again via a GitHub issue |
| 2024-08-23 | The maintainer confirms the issues |
| 2024-09-02 | The maintainer publishes a patch and asks for a review |
| 2024-09-05 | We follow up after noticing that the issue is still exploitable |
| 2024-11-21 | Our 90-day responsible disclosure deadline elapses |
| 2024-12-10 | This blog post is published |

## Summary

In this blog post, we demonstrated why it is essential to investigate security hotspots raised by SonarQube. An issue that didn't look very impactful at first turned out to be a dangerous vulnerability that can compromise a user's machine just by visiting a malicious website.

We also learned details about CORS, Simple Requests, and forbidden headers such as `Sec-Fetch-Site`. We hope this equips you with the right ideas for tackling similar issues in your own code. If you need more information, you can visit the [Sonar Rules page covering CORS](https://rules.sonarsource.com/javascript/RSPEC-5122/ "Sonar Rules page covering CORS").

## Related Blog Posts

* [Basic HTTP Authentication Risk: Uncovering pyspider Vulnerabilities](https://www.sonarsource.com/blog/basic-http-authentication-risk-uncovering-pyspider-vulnerabilities/ "Basic HTTP Authentication Risk: Uncovering pyspider Vulnerabilities")
* [Re-moo-te Code Execution in Mailcow: Always Sanitize Error Messages](https://www.sonarsource.com/blog/remote-code-execution-in-mailcow-always-sanitize-error-messages/ "Re-moo-te Code Execution in Mailcow: Always Sanitize Error Messages")
* [Sanitize Client-Side: Why Server-Side HTML Sanitization is Doomed to Fail](http://Sanitize Client-Side: Why Server-Side HTML Sanitization is Doomed to Fail "Sanitize Client-Side: Why Server-Side HTML Sanitization is Doomed to Fail")
* [Why Code Security Matters - Even in Hardened Environments](http://Why Code Security Matters - Even in Hardened Environments "Why Code Security Matters - Even in Hardened Environments")

#### SHARE

[twitter](https://twitter.com/share?text=undefined)[facebook](https://www.facebook.com/sharer/sharer.php?u=undefined)[linkedin](https://www.linkedin.com/sharing/share-offsite/?url=undefined)mail
## Get new blogs delivered directly to your inbox!

Stay up-to-date with the latest Sonar content. Subscribe now to receive the latest blog articles.

Email\*cheqSign up

By submitting this form, you agree to the storing and processing of your personal data as described in the [Privacy Policy](/company/privacy/ "Privacy Policy") and [Cookie Policy](/company/cookie-policy/ "Cookie Policy"). You can withdraw your consent by unsubscribing at any time.

This site is protected by reCAPTCHA and the Google [Privacy Policy](https://policies.google.com/privacy) and [Terms of Service](https://policies.google.com/terms) apply.

[Go to SonarSource homepage![](data:image/svg+xml;charset=utf-8...)![sonar logo ]()![sonar logo ](https://assets-eu-01.kc-usercontent.com:443/95361965-6528-012b-61fc-b49456de9702/8e59bcad-6e39-41dc-abd9-a0e251e8d63f/Sonar%20%282%29.svg?w=160&h=40&auto=format&fit=crop)](/)

* **Sonar Solutions**
  + [SAST](/solutions/security/)
  + [What is clean code](/solutions/clean-code/)
  + [Power of clean code](/solutions/power-of-clean-code/)
  + [Clean as you code](/solutions/our-unique-approach/)
  + [AI-assisted & quality-assured code](/solutions/ai/)
  + [DevOps transformation](/solutions/devops-transformation/)
  + [Outsourcing software development](/solutions/reduce-outsourcing-software-development-risk/)
  + [Reduce & manage technical debt](/solutions/reduce-technical-debt/)
  + [Secure by design](/solutions/secure-by-design-code/)
  + [Code coverage](/solutions/code-coverage/)
  + [Code review](/solutions/code-review/)
  + [For developers](/solutions/for-developers/)
  + [For enterprise](/solutions/for-enterprise/)
  + [Infrastructure as code](/solutions/infrastructure-as-code/)
  + [Public sector](/solutions/public-sector/)
* **Products**
  + [SonarQube for IDE](/products/sonarlint/)
  + [SonarQube Server](/products/sonarqube/)
  + [SonarQube Cloud](/products/sonarcloud/)**Pricing**
  + [Start for free](/open-source-editions/)
  + [Explore pricing](/plans-and-pricing/)
* **Company**
  + [About](/company/about/)
  + [Careers](/company/careers/)
  + [Commitment to open source](/solutions/commitment-to-open-source/)
  + [Customers](/company/customers/)
  + [Partners](/company/partners/)
  + [Contact us](/company/contact/)
  + [Accessibility](/accessibility/)
  + [NEW! Brand identity](/brand-identity/)**Media**
  + [Coverage](/company/coverage/)
  + [Press releases](/company/press-releases/)
* **Resources**
  + [Events hub](/resources/events/)
  + [Customer stories](/resources/customer-stories/)
  + [White papers](/resources/white-papers/)
  + [Learn](/learn/guide/)
  + [Community](https://community.sonarsource.com/)
  + [Support](/support/)
* **Knowledge**
  + [Explore Sonarpedia](https://rules.sonarsource.com/)
  + [Blog](/blog/)
  + [Languages](/knowledge/languages/)
  + [SonarQube Server Documentation](https://docs.sonarsource.com/sonarqube/latest/)
  + [SonarQube Cloud Documentation](https://docs.sonarsource.com/sonarcloud/)
  + [SonarQube for IDE Documentation](https://docs.sonarsource.com/sonarlint/)

* [Legal documentation](/legal/)
* [Trust center](/trust-center/)

* [Follow SonarSource on Twitter](https://twitter.com/sonarsource)
* [Follow SonarSource on Linkedin](https://www.linkedin.com/company/sonarsource/)

© 2008-2025 SonarSource SA. All rights reserved. SONAR, SONARSOURCE, SONARQUBE, and CLEAN AS YOU CODE are trademarks of SonarSource SA.


