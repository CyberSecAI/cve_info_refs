=== Content from ftp.openbsd.org_0fef8433_20250115_083850.html ===
untrusted comment: verify with openbsd-74-base.pub
RWRoyQmAD08ajcXNlno8mTIw7unrBjvHapVQjvo1+lHZEXLMGX/q49a8IFffBoRx01Cv2bwBL2yjb9FnnC4A/fmL8cxEPsdJ3As=
OpenBSD 7.4 errata 014, February 29, 2024:
vmm(4) did not restore GDTR limits properly on Intel (VMX) CPUs.
Apply by doing:
signify -Vep /etc/signify/openbsd-74-base.pub -x 014\_vmm.patch.sig \
-m - | (cd /usr/src && patch -p0)
And then rebuild and install a new kernel:
KK=`sysctl -n kern.osversion | cut -d# -f1`
cd /usr/src/sys/arch/`machine`/compile/$KK
make obj
make config
make
make install
Index: sys/arch/amd64/amd64/vmm\_machdep.c
===================================================================
RCS file: /cvs/src/sys/arch/amd64/amd64/vmm\_machdep.c,v
diff -u -p -r1.8.2.1 vmm\_machdep.c
--- sys/arch/amd64/amd64/vmm\_machdep.c 10 Dec 2023 00:30:01 -0000 1.8.2.1
+++ sys/arch/amd64/amd64/vmm\_machdep.c 28 Feb 2024 00:43:22 -0000
@@ -3954,9 +3954,8 @@ vcpu\_run\_vmx(struct vcpu \*vcpu, struct v
struct schedstate\_percpu \*spc;
struct vmx\_invvpid\_descriptor vid;
uint64\_t eii, procbased, int\_st;
- uint16\_t irq, ldt\_sel;
+ uint16\_t irq;
u\_long s;
- struct region\_descriptor idtr;
rw\_assert\_wrlock(&vcpu->vc\_lock);
@@ -4169,9 +4168,6 @@ vcpu\_run\_vmx(struct vcpu \*vcpu, struct v
break;
}
- sidt(&idtr);
- sldt(&ldt\_sel);
-
TRACEPOINT(vmm, guest\_enter, vcpu, vrp);
/\* Restore any guest PKRU state. \*/
@@ -4189,8 +4185,14 @@ vcpu\_run\_vmx(struct vcpu \*vcpu, struct v
wrpkru(PGK\_VALUE);
}
- lidt(&idtr);
- lldt(ldt\_sel);
+ /\*
+ \* VM exit restores the GDT and IDT bases, but gives
+ \* them high limits. Reload with the correct limits here.
+ \* 'gdt' is set above first time through and reset there
+ \* whenever this thread switches CPU.
+ \*/
+ bare\_lgdt(&gdt);
+ cpu\_init\_idt();
/\*
\* On exit, interrupts are disabled, and we are running with

