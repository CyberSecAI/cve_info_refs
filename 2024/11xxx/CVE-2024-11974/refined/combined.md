=== Content from wordpress.org_0ae3a34c_20250114_213140.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

Media Library Assistant

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fmedia-library-assistant&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fmedia-library-assistant&locale=en_US)

Search plugins

![](https://ps.w.org/media-library-assistant/assets/banner-772x250.jpg?rev=585077)
![](https://ps.w.org/media-library-assistant/assets/icon-256x256.png?rev=973502)
# Media Library Assistant

By [David Lingren](http://davidlingren.com/)

[Download](https://downloads.wordpress.org/plugin/media-library-assistant.3.24.zip)

* [Details](https://wordpress.org/plugins/media-library-assistant/#description)
* [Reviews](https://wordpress.org/plugins/media-library-assistant/#reviews)
* [Installation](https://wordpress.org/plugins/media-library-assistant/#installation)
* [Development](https://wordpress.org/plugins/media-library-assistant/#developers)

[Support](https://wordpress.org/support/plugin/media-library-assistant/)

## Description

The Media Library Assistant provides several enhancements for managing the Media Library, including:

* The **`[mla_gallery]` shortcode**, used in a post, page or custom post type to add a gallery of images and/or other Media Library items (such as PDF documents). MLA Gallery is a superset of the WordPress `[gallery]` shortcode; it is compatible with `[gallery]` and provides many enhancements. These include: 1) full query and display support for WordPress categories, tags, custom taxonomies and custom fields, 2) support for all post\_mime\_type values, not just images 3) media Library items need not be “attached” to the post, and 4) control over the styles, markup and content of each gallery using Style and Markup Templates. **Twenty-eight hooks** are provided for complete gallery customization from your theme or plugin code.
* The **`[mla_tag_cloud]` shortcode**, used in a post, page, custom post type or widget to display the “most used” terms in your Media Library where the size of each term is determined by how many times that particular term has been assigned to Media Library items. **Twenty-five hooks** are provided for complete cloud customization from your theme or plugin code.
* The **`[mla_term_list]` shortcode**, used in a post, page, custom post type or widget to display hierarchical (and flat) taxonomy terms in list, dropdown control or checklist formats. **Twenty hooks** are provided for complete list customization from your theme or plugin code.
* The **`[mla_custom_list]` shortcode**, used in a post, page, custom post type or widget to display flat lists, dropdown controls and checkbox lists of custom field values. **Twenty-seven hooks** are provided for complete list customization from your theme or plugin code.
* Support for **[WPML](https://wpml.org/)** and **Polylang** multi-language CMS plugins. MLA has earned a place on [WPML’s List of Recommended Plugins](https://wpml.org/plugin/media-library-assistant/).
* **Integrates with Photonic Gallery, Justified Image Grid, Jetpack and other plugins**, so you can add slideshows, thumbnail strips and special effects to your `[mla_gallery]` galleries.
* Works with **[WordPress Real Media Library: Media Library Folder & File Manager](https://wordpress.org/plugins/real-media-library-lite/)** (Lite and Pro) to organize your files into folders, collections and galleries. This combination enhances both the Media/Assistant admin submenu and the `[mla_gallery]` shortcode.
* Works with **[CatFolders – WP Media Folders](https://wordpress.org/plugins/catfolders/)** (Lite and Pro) to categorize media files better and faster. This combination enhances both the Media/Assistant admin submenu and the `[mla_gallery]` shortcode.
* Powerful **Content Templates**, which let you compose a value from multiple data sources, mix literal text with data values, test for empty values and choose among two or more alternatives or suppress output entirely.
* **Attachment metadata** such as file size, image dimensions and where-used information can be assigned to WordPress custom fields. You can then use the custom fields in your `[mla_gallery]` display and you can add custom fields as sortable, searchable columns in the Media/Assistant submenu table. You can also **modify the WordPress `_wp_attachment_metadata` contents** to suit your needs.
* **IPTC**, **EXIF (including GPS)**, **XMP** and **PDF** metadata can be assigned to standard WordPress fields, taxonomy terms and custom fields. You can update all existing attachments from the Settings page IPTC/EXIF tab, groups of existing attachments with a Bulk Action or one existing attachment from the Edit Media/Edit Single Item screen. **Twelve hooks** provided for complete mapping customization from your theme or plugin code. You can view and/or download this PDF document with more information: [Mapping File Metadata to WordPress Fields with Media Library Assistant](http://davidlingren.com/assets/MLA-Metadata-Mapping.pdf)
* Complete control over **Post MIME Types, File Upload extensions/MIME Types and file type icon images**. Fifty four (54) additional upload types, 112 file type icon images and a searchable list of over 1,500 file extension/MIME type associations.
* **Enhanced Search Media box**. Search can be extended to the name/slug, ALT text and caption fields. The connector between search terms can be “and” or “or”. Search by attachment ID or Parent ID is supported, and you can search on keywords in the taxonomy terms assigned to Media Library items. Works in the Media Manager Modal Window, too.
* **Complete support for ALL taxonomies**, including the standard Categories and Tags, your custom taxonomies and the Assistant’s pre-defined Att. Categories and Att. Tags. You can add taxonomy columns to the Assistant listing, filter on any taxonomy, assign terms and list the attachments for a term.
* Taxonomy and custom field support in the ATTACHMENT DETAILS pane of the Media Manager Modal Window and Media/Library Grid view.
* Inline **“Bulk Edit”** and **“Quick Edit”** areas; update author, parent and custom fields, add, remove or replace taxonomy terms for several attachments at once. Works on the Media/Add New screen as well.
* Displays more attachment information such as parent information, file URL and image metadata. Provides many more listing columns (more than 20) to choose from.
* Provides additional view filters for MIME types and taxonomies, and features to cmpose custom views of your own.
* Works with the popular [Admin Columns](https://wordpress.org/plugins/codepress-admin-columns/) plugins for even more Media/Assistant screen customization.

The Assistant is designed to work like the standard Media Library pages, so the learning curve is short and gentle. Contextual help is provided on every new screen to highlight new features.

**NOTE:** Complete documentation is included in the Documentation tab on the Settings/Media Library Assistant admin screen and the drop-down “Help” content in the admin screens. You can find a stand-alone version of the Documentation on my web site: [Media Library Assistant Documentation](http://davidlingren.com/assets/mla-doc.html)

**I do not solicit nor accept personal donations in support of the plugin.** WordPress and its global community means a lot to me and I am happy to give something back.

If you find the Media Library Assistant plugin useful and would like to support a great cause, consider a [tax-deductible donation](http://secure.alsnetwork.org/goto/Chateau_Seaview_Fund) to our [Chateau Seaview Fund](http://secure.alsnetwork.org/goto/Chateau_Seaview_Fund) at the ALS Network. Every dollar of the fund goes to make the lives of people with ALS, their families and caregivers easier. Thank you!

### Acknowledgements

Media Library Assistant includes many images drawn (with permission) from the [Crystal Project Icons](http://www.softicons.com/free-icons/system-icons/crystal-project-icons-by-everaldo-coelho), created by [Everaldo Coelho](http://www.everaldo.com), founder of [Yellowicon](http://www.yellowicon.com).

**Many thanks** to Aurovrata Venet, Il’ya Karastel and Kristian Adolfsson for testing and advising on the multilingual support features!

#### The Example Plugins

The MLA example plugins have been developed to illustrate practical applications that use the hooks MLA provides to enhance the admin-mode screens and front-end content produced by the MLA shortcodes. Most of the examples are drawn from topics in the MLA Support Forum.

The Documentation/Example Plugins submenu lets you browse the list of MLA example plugins, install or update them in the Plugins/Installed Plugins area and see which examples you have already installed. To activate, deactivate or delete the plugins you must go to the Plugins/Installed Plugins admin submenu.

The Example plugins submenu lists all of the MLA example plugins and identifies those already in the Installed Plugins area. In the submenu:

* the “Screen Options” dropdown area lets you choose which columns to display and how many items appear on each page
* the “Help” dropdown area gives you a brief explanation of the submenu content and functions
* the “Search Plugins” text box lets you filter the display to items containing one or more keywords or phrases
* bulk and rollover actions are provided to install or update example plugins
* the table can be sorted by any of the displayed columns

Once you have installed an example plugin you can use the WordPress Plugins/Editor submenu to view the source code and (with extreme caution) make small changes to the code. **Be very careful if you choose to modify the code!** Making changes to active plugins is not recommended. If your changes cause a fatal error, the plugin will be automatically deactivated. It is much safer to download the file(s) or use FTP access to your site to modify the code offline in a more robust HTML/PHP editor.

You can use the “Download” rollover action to download a plugin to your local system. Once you have made your modifications you can copy the plugin to a compressed file (ZIP archive) and then upload it to your server with the Plugins/Add New (Upload Plugin) admin submenu.

If you do make changes to the example plugin code the best practice is to save the modified file(s) under a different name, so your changes won’t be lost in a future update. If you want to retain the file name, consider changing the version number, e.g. adding 100 to the MLA value, so you can more easily identify the plugins you have modified.

## Screenshots

* [![](https://ps.w.org/media-library-assistant/assets/screenshot-1.png?rev=626818)](https://ps.w.org/media-library-assistant/assets/screenshot-1.png?rev=626818)

  The Media/Assistant submenu table showing the available columns, including “Featured in”, “Inserted in”, “Att. Categories” and “Att. Tags”; also shows the Quick Edit area.
* [![](https://ps.w.org/media-library-assistant/assets/screenshot-2.png?rev=626818)](https://ps.w.org/media-library-assistant/assets/screenshot-2.png?rev=626818)

  The Media/Assistant submenu table showing the Bulk Edit area with taxonomy Add, Remove and Replace options; also shows the tags suggestion popup.
* [![](https://ps.w.org/media-library-assistant/assets/screenshot-3.png?rev=607535)](https://ps.w.org/media-library-assistant/assets/screenshot-3.png?rev=607535)

  A typical edit taxonomy page, showing the “Attachments” column.
* [![](https://ps.w.org/media-library-assistant/assets/screenshot-4.png?rev=701939)](https://ps.w.org/media-library-assistant/assets/screenshot-4.png?rev=701939)

  The enhanced Edit page showing additional fields, categories and tags.
* [![](https://ps.w.org/media-library-assistant/assets/screenshot-5.png?rev=701939)](https://ps.w.org/media-library-assistant/assets/screenshot-5.png?rev=701939)

  The Settings page General tab, where you can customize support of Att. Categories, Att. Tags and other taxonomies, where-used reporting and the default sort order.
* [![](https://ps.w.org/media-library-assistant/assets/screenshot-6.png?rev=626818)](https://ps.w.org/media-library-assistant/assets/screenshot-6.png?rev=626818)

  The Settings page MLA Gallery tab, where you can add custom style and markup templates for `[mla_gallery]` shortcode output.
* [![](https://ps.w.org/media-library-assistant/assets/screenshot-7.png?rev=701939)](https://ps.w.org/media-library-assistant/assets/screenshot-7.png?rev=701939)

  The Settings page IPTC & EXIF Processing Options screen, where you can map image metadata to standard fields (e.g. caption), taxonomy terms and custom fields.
* [![](https://ps.w.org/media-library-assistant/assets/screenshot-8.png?rev=701939)](https://ps.w.org/media-library-assistant/assets/screenshot-8.png?rev=701939)

  The Settings page Custom Field Processing Options screen, where you can map attachment metadata to custom fields for display in [mla\_gallery] shortcodes and as sortable, searchable columns in the Media/Assistant submenu.
* [![](https://ps.w.org/media-library-assistant/assets/screenshot-9.png?rev=883328)](https://ps.w.org/media-library-assistant/assets/screenshot-9.png?rev=883328)

  The Media Manager popup modal window showing additional filters for date and taxonomy terms. Also shows the enhanced Search Media box and the full-function taxonomy support in the ATTACHMENT DETAILS area.

## Installation

1. Upload `media-library-assistant` and its subfolders to your `/wp-content/plugins/` directory, **OR** Visit the Plugins/Add New page and search for “Media Library Assistant”; click “Install Now” to upload it
2. Activate the plugin through the “Plugins” menu in WordPress
3. Visit the Settings/Media Library Assistant page to customize taxonomy (e.g., category and tag) support
4. Visit the Settings/Media Library Assistant Custom Fields and IPTC/EXIF tabs to map metadata to attachment fields
5. Visit the “Assistant” submenu in the Media admin section
6. Click the Screen Options link to customize the display
7. Use the enhanced Edit, Quick Edit and Bulk Edit pages to assign categories and tags
8. Use the `[mla_gallery]` shortcode to add galleries of images, documents and more to your posts and pages
9. Use the `[mla_tag_cloud]`, `[mla_term_list]` and `[mla_custom_list]` shortcodes to add clickable lists of taxonomy terms and custom field values to your posts and pages

## FAQ

### How can I sort the Media/Assistant submenu table on values such as File Size?

You can add support for many attachment metadata values such as file size by visiting the Custom Fields tab on the Settings page. There you can define a rule that maps the data to a WordPress custom field and check the “MLA Column” box to make that field a sortable column in the Media/Assistant submenu table. You can also use the field in your `[mla_gallery]` shortcodes. For example, this shortcode displays a gallery of the ten largest images in the “general” category, with a custom caption:

```
[mla_gallery category="general" mla_caption="{+caption+}<br>{+custom:File Size+}" meta_key="File Size" orderby="meta_value" order="DESC" numberposts=10]

```

### How can I use Categories, Tags and custom taxonomies to select images for display in my posts and pages?

The powerful `[mla_gallery]` shortcode supports almost all of the query flexibility provided by the WP\_Query class. You can find complete documentation in the Settings/Media Library Assistant Documentation tab. A simple example is in the preceding question. Here’s an example that displays PDF documents with Att. Category “fauna” or Att. Tag “animal”:

```
[mla_gallery post_mime_type="application/pdf" size=icon mla_caption="{+title+}" tax_query="array(array('taxonomy'=>'attachment_category','field'=>'slug','terms'=>'fauna'),array('taxonomy'=>'attachment_tag','field'=>'slug','terms'=>'animal'),'relation'=>'OR')"]

```

### Can I use [mla\_gallery] for attachments other than images?

Yes! The `[mla_gallery]` shortcode supports all MIME types when you add the post\_mime\_type parameter to your query. You can build a gallery of your PDF documents, plain text files and other attachments. You can mix images and other MIME types in the same gallery, too. Here’s an example that displays a gallery of PDF documents, using Imagick and Ghostscript to show the first page of each document as a thumbnail:

```
[mla_gallery post_mime_type=application/pdf post_parent=all link=file mla_viewer=true columns=1 orderby=date order=desc]

```

### Can I attach an image to more than one post or page?

No; that’s a structural limitation of the WordPress database. However, you can use Categories, Tags and custom taxonomies to organize your images and associate them with posts and pages in any way you like. The `[mla_gallery]` shortcode makes it easy. You can also use the `ids=` parameter to compose a gallery from a list of specific images.

### Can the Assistant use the standard WordPress post Categories and Tags?

Yes! You can activate or deactivate support for Categories and Tags at any time by visiting the Media Library Assistant Settings page.

### Do I have to use the WordPress post Categories and Tags?

No! The Assistant supplies pre-defined Att. Categories and Att. Tags; these are WordPress custom taxonomies, with all of the API support that implies. You can activate or deactivate the pre-defined taxonomies at any time by visiting the Media Library Assistant Settings page.

### Can I add my own custom taxonomies to the Assistant?

Yes. Any custom taxonomy you register with the Attachment post type will appear in the Assistant UI. Use the Media Library Assistant Settings page to add support for your taxonomies to the Assistant UI.

### Can I use Jetpack Tiled Gallery or a lightbox plugin to display my gallery?

You can use other gallery-generating shortcodes to give you the data selection power of [mla\_gallery] and the formatting/display power of popular alternatives such as the WordPress.com Jetpack Carousel and Tiled Galleries modules. Any shortcode that accepts “ids=” or a similar parameter listing the attachment ID values for the gallery can be used. Here’s an example of a Jetpack Tiled gallery for everything except vegetables:

```
[mla_gallery attachment_category=vegetable tax_operator="NOT IN" mla_alt_shortcode=gallery type="rectangular"]

```

Most lightbox plugins use HTML `class=` and/or `rel=` tags to activate their features. `[mla_gallery]` lets you add this tag information to your gallery output. Here’s an example that opens PDF documents in a shadowbox using Easy Fancybox:

```
[mla_gallery post_mime_type=application/pdf post_parent=all link=file size=icon mla_caption='<a class="fancybox-iframe fancybox-pdf" href={+filelink_url+} target=_blank>{+title+}</a>' mla_link_attributes='class="fancybox-pdf fancybox-iframe"']

```

In the example, the `mla_caption=` parameter turns the document title into a link to the shadowbox display so you can click on the thumbnail image or the caption to activate the display.

### Why don’t the “Posts” counts in the taxonomy edit screens match the search results when you click on them?

This is a known WordPress problem with multiple support tickets already in Trac, e.g.,

Ticket #20708(closed defect (bug): duplicate) Wrong posts count in taxonomy table,

Ticket #14084(assigned defect (bug)) Custom taxonomy count includes draft & trashed posts,

and Ticket #14076(closed defect (bug): duplicate) Misleading post count on taxonomy screen.

For example, if you add Tags support to the Assistant and then assign tag values to your attachments, the “Posts” column in the “Tags” edit screen under the Posts admin section includes attachments in the count. If you click on the number in that column, only posts and pages are displayed. There are similar issues with custom post types and taxonomies (whether you use the Assistant or not). The “Attachments” column in the edit screens added by the Assistant shows the correct count because it works in a different way.

### How do I “unattach” an item?

Hover over the item you want to modify and click the “Edit” or “Quick Edit” action. Set the ID portion of the Parent Info field to zero (0), then click “Update” to record your changes. If you change your mind, click “Cancel” to return to the main page without recording any changes. You can also click the “Select” button to bring up a list of posts//pages and select one to be the new parent for the item. The “Set Parent” link in the Media/Assistant submenu table also supports changing the parent and unattaching an item.

### The Media/Assistant submenu seems sluggish; is there anything I can do to make it faster?

Some of the MLA features such as where-used reporting and ALT Text sorting/searching require a lot of database processing. If this is an issue for you, go to the Settings page and adjust the **“Where-used database access tuning”** settings. For any where-used category you can enable or disable processing. For the “Gallery in” and “MLA Gallery in” you can also choose to update the results on every page load or to cache the results for fifteen minutes between updates. The cache is also flushed automatically when posts, pages or attachments are inserted or updated.

### Do custom templates and option settings survive version upgrades?

Rest assured, custom templates and all of your option settings persist unchanged whenever you update to a new MLA version.

You can also back a backup of your templates and settings from the Settings/Media Library Assistant General tab. Scroll to the bottom of the page and click “Export ALL Settings” to create a backup file. You can create as many files as you like; they are date and time stamped so you can restore the one you want later.

In addition, you can deactivate and even delete the plugin without losing the settings. They will be there when you reinstall and activate in the future.

You can permanently delete the settings and (optionally) the backup files if you are removing MLA for good. The “Uninstall (Delete)” Plugin Settings section of the General tab enables these options.

### Are other language versions available?

Not many, but all of the internationalization work in the plugin source code has been completed and there is a Portable Object Template (.POT) available in the “/languages” directory. I don’t have working knowledge of anything but English, but if you’d like to volunteer to produce a translation, I would be delighted to work with you to make it happen. Have a look at the “MLA Internationalization Guide.pdf” file in the languages directory and get in touch.

### What’s in the “phpDocs” directory and do I need it?

All of the MLA source code has been annotated with “DocBlocks”, a special type of comment used by phpDocumentor to generate API documentation. If you’d like a deeper understanding of the code, navigate to the [MLA phpDocs web page](http://davidlingren.com/assets/phpDocs/index.html "Read the API documentation") and have a look. Note that these pages require JavaScript for much of their functionality.

## Reviews

![](https://secure.gravatar.com/avatar/876813fb624407a217b76b3023ad79efa12435d522bea5c94ad27cb7442d489d?s=60&d=retro&r=g)
### [This is how to manage WordPress media properly](https://wordpress.org/support/topic/this-is-how-to-manage-wordpress-media-properly/)

[tonyuk](https://profiles.wordpress.org/tonycsanders/ "Posts by tonyuk")
November 15, 2024

Extremely well built plug-in and generously maintained free of charge to the community.

![](https://secure.gravatar.com/avatar/022c5b3469b13b287d1c64961548acc906522d0541f003a8ee11d34adb3a0a55?s=60&d=retro&r=g)
### [It doesn’t work](https://wordpress.org/support/topic/it-doesnt-work-346/)

[Settembre](https://profiles.wordpress.org/er11desettembre/ "Posts by Settembre")
October 2, 2024
1 reply

Tried and useless

![](https://secure.gravatar.com/avatar/f494001f15fb59b8dbd4ba402633dfc81b083eb04bee1f4fdbc37280afe46d0c?s=60&d=retro&r=g)
### [Edit pictures names in bulk](https://wordpress.org/support/topic/edit-pictures-names-in-bulk/)

[ainasewing](https://profiles.wordpress.org/ainasewing/ "Posts by ainasewing")
September 10, 2024
1 reply

HI,Thank you for this great plugin ! I am trying to edit pictures names in bulk, is it possible?My best

![](https://secure.gravatar.com/avatar/b89af680647c05d2cec17ff0371b876f2eb8015c892d2c2a59153694d56f4cc5?s=60&d=retro&r=g)
### [great plugin](https://wordpress.org/support/topic/great-plugin-39277/)

[sinanisler](https://profiles.wordpress.org/sinanisler/ "Posts by sinanisler")
August 2, 2024

great plugin

![](https://secure.gravatar.com/avatar/5950dccfd63ddb7d4a6af70afa453b9c99d13ced809cfd3750f467310df26ab9?s=60&d=retro&r=g)
### [Powerhouse media plugin](https://wordpress.org/support/topic/powerhouse-media-plugin/)

[nickynick](https://profiles.wordpress.org/nickynick/ "Posts by nickynick")
February 23, 2024

This plugin is absolute gem. I had been working with a team of photographers who were uploading car racing pictures on the fly. I needed to filter certain information to make it accessible to the press. While I don’t recall the specific details, I can certainly say this plugin was the solution I was looking for. There is a lot more under the hood of this plugin.

![](https://secure.gravatar.com/avatar/1397b20d758e919531553d22ad891201462fba045e439d354b3fac5ffde4fcb2?s=60&d=retro&r=g)
### [Powerful and extremely well supported plugin](https://wordpress.org/support/topic/powerful-and-extremely-well-supported-plugin/)

[rumples2022](https://profiles.wordpress.org/rumples2022/ "Posts by rumples2022")
September 4, 2023

MLA is an extraordinarily powerful and rich plugin for media files. The documentation is extensive, and, perhaps most importantly, the developer, David Lingren, responds quickly, thoughtfully, and generously to requests for help or information. The plugin is a model of how software ought to be build; the threads on the support site are an example of what the internet is at its best.

[Read all 193 reviews](https://wordpress.org/support/plugin/media-library-assistant/reviews/)
## Contributors & Developers

“Media Library Assistant” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/299ab71850a3d6fb44062f52ef927c600dd5570c3d4ce1286dff97342be6a31e?s=32&d=mm&r=g) [David Lingren](https://profiles.wordpress.org/dglingren/)

“Media Library Assistant” has been translated into 3 locales. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/media-library-assistant/contributors) for their contributions.

[Translate “Media Library Assistant” into your language.](https://translate.wordpress.org/projects/wp-plugins/media-library-assistant)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/media-library-assistant/), check out the [SVN repository](https://plugins.svn.wordpress.org/media-library-assistant/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/media-library-assistant/) by [RSS](https://plugins.trac.wordpress.org/log/media-library-assistant/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 3.24

* New: Field-level data sources for accessing information about the original, unscaled files for very large images.
* New: Extend REST support to the Att. Categories and Att. Tags taxonomies.
* Fix: **IMPORTANT: Reflected Cross-Site Scripting security risks in the Smart Media Categories, MLA Unattached Fixit, and WooCommerce Fixit example plugins have been mitigated.**
* Fix: For the `[mla_gallery]` shortcode, improved processing of the `mla_image_class` and `mla_image_alt` parameters when the attachment link contains other HTML tags.

#### 3.23

* Fix: For the `[mla_gallery]` shortcode, a defect regarding default post parent processing, e.g. when the shortcode has no explicit parameters, has been corrected.

#### 3.22

* Fix: IMPORTANT: Resolve “Fatal error: Uncaught TypeError: array\_key\_exists():” in `class-mla-options.php`.
* Fix: Delay localization of built-in style and markup templates until `init` action.

#### 3.21

* New: For the Media/Assistant admin page, a new entry in the “Screen Options” pulldown menu lets you change the “List Taxonomy” that populates the dropdown at the top of the submenu table.
* New: For the `[mla_gallery]` shortcode, Simple Custom Field Parameters now include `meta_value_delimiter` to change the delimiter between multiple custom field values.
* New: A brief reference to calling MLA’s shortcode support functions has been added to the Settings/Media Library Assistant Documentation tab.
* Fix: Removed i18n function calls from the `plugins_loaded` action to resolve WP 6.7 PHP Notice “Function \_load\_textdomain\_just\_in\_time was called incorrectly”.
* Fix: **IMPORTANT: A Cross-Site Scripting (XSS) security risk in the Settings/Media Library Assistant page, various tabs, has been mitigated.**
* Fix: Various i18n cleanup touches to improve Plugin Check/Plugin Repo results
* Fix: Code cleanup to remove calls to deprecated `like_escape()` function.
* Fix: For the Media/Assistant admin page, fixed layout of the Search Media box and associated controls, the Bulk Edit area and the Quick Edit Area.
* Fix: For EXIF metadata extraction, some PHP fatal errors caused by unusual values in the data have been corrected.
* Fix: When the Real Media Library plugin is active, an array to string conversion defect on the Media/Assistant screen has been corrected.
* Fix: For the “MLA Path Mapping Example” plugin, corrected term assignment copying when destination Term ID is not equal to Term Taxonomy ID.
* Fix: For the “MLA Path Mapping Example” plugin, delayed initialization for compatibility with Enhanced Media Library.
* Fix: Added logic to avoid errors in items with corrupted `_wp_attached_file` (array) values.

#### 3.20

* Fix: **IMPORTANT: A security risk that allowed remote code execution from a logged in administrator account has been mitigated.**
* Fix: For mapping rules, an AJAX nonce problem in the “Execute” rollover action has been corrected.
* Fix: For the `[mla_gallery]` shortcode, a defect in processing `mla_link_href` parameters containing multiple query string parameters has been corrected.
* Fix: For the `[mla_gallery]` shortcode when `mla_viewer=true`, a “PHP Warning: Undefined array key…” issue has been eliminated.

#### 3.19

* New: For mapping rules, a new “Replace All” option for the “Keep Existing” setting will replace Standard Fields with an empty value and delete Taxonomy term assignments if the mapping rule evaluates to an empty value.
* Fix: **IMPORTANT: A security risk that allowed authenticated non-administrator (Author+) users to add file extensions to the Uploads list has been mitigated.**
* Fix: More precise jQuery specification may improve handling of the Edit and Thumbnails bulk actions on the Media/Assistant admin submenu screen.
* Fix: For Custom Fields and IPTC/EXIF/WP custom field rules, the “Replace” option for the “Keep Existing” setting will not delete existing non-empty values if the new value is empty.
* Fix: For IPTC/EXIF/WP custom field rules, the “Multi” Option setting is now respected. A defect in previous MLA versions caused this setting to be ignored.
* Fix: For IPTC/EXIF/WP custom field rules, the “Delete NULL Values” setting is now respected. A defect in previous MLA versions always deleted NULL values.
* Fix: The `utf8_encode()` function has been replaced by `mb_convert_encoding()` to eliminate a PHP 8.2 “Deprecated” warning.

#### 3.00 – 3.18

* 3.18 – IMPORTANT: A security risk in the Media/Edit Media screen has been mitigated. A defect in formatting the order=DESC shortcode parameter has been corrected. Two fixes in all.
* 3.17 – IMPORTANT: Security risks in the Media/Edit Media screen and shortcodes have been mitigated. Elementor fix for the Media Manager Modal (popup) Window. Eight fixes in all.
* 3.16 – IMPORTANT: Security risks in the Media/Edit Media screen and [mla\_custom\_list] shortcode have been mitigated. Shortcode bug fixes and a new feature in the MLA Multi-search Example plugin. One enhancement, four fixes in all.
* 3.15 – IMPORTANT: Eliminate PHP Fatal Error when accessing Example Plugins from the Settings/Media Library Assistant Documentation tab.
* 3.14 – IMPORTANT: WordPress 6.5 updates and two security fixes. New and enhanced example plugins. Shortcode enhancements. Seven enhancements in all, eleven fixes.
* 3.13 – IMPORTANT: `[mla_gallery]` parameters containing HTML are once again processed correctly. New “MLA Custom Field List” shortcode. Code refactor reduces load time and memory required for the `[mla_gallery]` shortcode. Four enhancements in all, six fixes.
* 3.12 – IMPORTANT: Cross-site scripting security risk for authenticated users with the “Author” role has been eliminated.
* 3.11 – IMPORTANT: security risk fixes for shortcode parameters and example plugin. Custom file icon support for Uploads file types. One enhancement, four fixes.
* 3.10 – IMPORTANT: WP 6.3 Gutenberg/Media Manager fix and a security risk fix. File Extension and MIME Type Processing fixes. “MLA Multisite Extensions” example plugin enhancements. Four enhancements in all, nine fixes.
* 3.09 – IMPORTANT: security risk fixes for shortcode parameters and example plugin. Custom file icon support for Uploads file types. One enhancement, four fixes.
* 3.08 – PNG metadata fixes, terms search enhancements, example plugin enhancements, MLA Insert Fixit security fix, Documentation updates and additions. Eight enhancements in all, eleven fixes.
* 3.07 – Metadata extraction for PNG files, “Set Featured Image” enhancements, extensive “Where-used Reporting” documentation, Modern Event Calendar fix and Example Plugin enhancements. Eight enhancements in all, seven fixes.
* 3.06 – IMPORTANT: SECURITY FIX for the MLA Insert Fixit example plugin removes an SQL injection risk. New mapping rules tutorial available, some PDF parsing improvements and documentation improvements. One enhancement, eight fixes in all.
* 3.05- IMPORTANT: Admin Columns Pro v6.0+ support. Support for the “CatFolders – WP Media Folders” plugin. The “MLA Yoast SEO Example” plugin has been completely rewritten. New “MLA Content Items Example” plugin. Three enhancements in all, two fixes.
* 3.04 – Fix: When Photo Engine (WP/LR Sync) is active, a PHP Fatal Error with mapping rules during “sync” operations has been corrected.
* 3.03 – IMPORTANT: For the [mla\_gallery] shortcode, a defect (introduced in v3.02) in expanding template values has been corrected.
* 3.02 – MLA Text Widget, WPML, Polylang and Photo Engine (WP/LR Sync) fixes. Some PHP errors eliminated. Bulk Edit Area enhancements. New “MLA WFU Data Source” example plugin. Two enhancements in all, ten fixes.
* 3.01 – IMPORTANT: For the Media/Assistant Bulk Edit feature, AJAX errors have been corrected.
* 3.00 – WordPress 6.0 support, security improvements, shortcode and example plugin enhancements. Seven enhancements in all, seventeen fixes.

#### 2.90 – 2.99

* 2.99 – WordPress 5.9 support. Bulk Edit values save/restore, current date/time data sources, custom field Library views filtered by MIME type. Four enhancements in all, fifteen fixes.
* 2.98 – New “Attachment File Metadata” meta box on the Media/Edit Media screen. Enhanced “MLA Advanced Custom Fields Example” and new “MLA Filename Issues Example” plugins. Five enhancements in all, eleven fixes.
* 2.97 – IMPORTANT: [mla\_gallery] PHP “Warning: array\_key\_exists()…” messages have been eliminated. WP 5.8, cropping of MMMW top row image thubmnails fixed. Description element added to mapping rules. Four enhancements in all, four fixes.
* 2.96 – WordPress 5.8 support! New [muie\_archive\_list] shortcode. CSV export item values. Support for Enhanced Media Library plugin. Donation links are back. Thirteen enhancements in all, fourteen fixes.
* 2.95 – Support for Real Media Library plugin in Media/Assistant and `[mla_gallery]`, MLA Insert Fixit improvements, `[mla_gallery]` simple date parameters, “Mine” filter/view. Four enhancements in all, twelve fixes.
* 2.94 – For [mla\_gallery], icon handling, mla\_viewer, and performance fixes. New and enhanced example plugins. Three enhancements in all, nine fixes.
* 2.93 – Correct defects in handling array values, e.g., tax\_input, in request: parameters and pagination controls. Example plugin enhancements. Two enhancements in all, three fixes.
* 2.92 – Correct Media/Assistant Quick Edit error that deleted term assignments in the WordPress Categories taxonomy.
* 2.91 – Correct PHP Fatal Error in Media Manager Search Media operations. Correct defect that caused Media Manager “Edit Gallery” operations to lose existing items. Two fixes in all.
* 2.90 – WP 5.6 support, thorough review and update of all files for validating, sanitizing and escaping user data to reduce the risk of security exploits, two new example plugins. Seven enhancements in all, seven fixes.

#### 2.80 – 2.84

* 2.84 – WP 5.5 support, new Always Use MLA MIME Type option, CSV Data Source example plugin, Support for PaidMembershipsPro, Simple Taxonomy Ordering, Simple Custom Post Order, Featured Image from URL plugins. Thirteen enhancements in all, twelve fixes.
* 2.83 – Avoid “Fatal error:” with Admin Columns Pro version 5.1+. Fix Attachments area positioning in the Media Manager Modal (popup) Window. Two fixes in all.
* 2.82 – Compatibility updates for WordPress 5.4. Security fixes to prevent three categories of attacks. New tools for “MLA Insert Fixit” and “WooCommerce Fixit Tools” example plugins. Fixes for `[mla_gallery]` and Media Manager Modal Window. Seven enhancements in all, eleven fixes.
* 2.81 – Compatibility updates for WordPress 5.3. New “mso:” prefix gives access to the Document Properties embedded in Office Open XML file formats (e.g., docx, xlsx, pptx). Three enhancements, eight fixes.
* 2.80 – A new “MLA Phoenix Media Rename Example” plugin supports the Phoenix Media Rename plugin. MLA Insert Fixit example plugin improvements, improved support for other plugins and themes. One enhancement, twelve fixes.

#### 2.70 – 2.79

* 2.79 – [mla\_gallery] keyword/term search “exclude” logic, [mla\_tag\_cloud] performance improvements, Media/Assistant Download bulk action. Nine enhancements in all, six fixes.
* 2.78 – Support Admin Columns Pro v4.5.x, add “Search Media” and “Terms Search” exclude logic, Eliminate PHP messages for Polylang and some AJAX actions. One enhancement, five fixes.
* 2.77 – Preserve current term assignments for checklist-style taxonomies when opening the Media/Assistant Quick Edit area. This defect was introduced in v2.76.
* 2.76 – “Checklist-style” term search and additions in the Bulk and Quick Edit areas. New and improved example plugins. Seven enhancements, four fixes.
* 2.75 – Admin Columns (and Pro) fixes to eliminate PHP messages. Five fixes in all.
* 2.74 – Cross-Site Scripting vulnerabilities have been removed from the Media/Assistant and Settings/Media Library assistant admin submenu screens. One enhancement, seven fixes.
* 2.73 – Checklist-style flat taxonomy improvements, Admin Columns Pro fix, new and improved example plugins, e.g., “parent search”. Five enhancements, four fixes.
* 2.72 – Remove “Circular Reference” PHP Warnings in class-mla-mime-types.php.
* 2.71 – Admin Columns Pro CSV Export support, Uploaded on date editing, regular expression match/replace functions in shortcodes, new and improved example plugins. Thirteen enhancements, seven fixes.
* 2.70 – Improved file download security, Polylang fixes. Two enhancements, seven fixes.

#### 2.60 – 2.65

* 2.65 – Corrects an “ajax.fail error” in the Media/Assistant “Set Parent” function and the Media/Edit Media screen. One other enhancement, two other fixes.
* 2.64 – For `[mla_gallery]`, corrects v2.63 problem that applied `mla_named_transfer` to all `link=file` and `link=download` galleries.
* 2.63 – Download by name and pretty links, str\_replace format option, disable mapping rules, debug tab. Eight enhancements in all, nine fixes.
* 2.62 – Corrects a PHP Fatal Error when loading MLA Media Manager enhancements for “front-end” use.
* 2.61 – Several new example plugins and hooks, new shortcode parameters. Thirteen enhancements in all, thirteen fixes.
* 2.60 – Completely new Settings/IPTC/EXIF tab and example plugin enhancements. Five enhancements in all, five

#### 2.50 – 2.54

* 2.54 – Admin Columns/PHP 7.1.x Fix, thumbnail generation enhancements, [mla\_term\_list] fix and Settings/Shortcodes tab updates. Six fixes in all.
* 2.53 – Correct PHP Fatal Error defect for users of Admin Columns (free version).
* 2.52 – Improved Admin Columns Pro integration, better PHP 7 support. Example plugin improvements. Six enhancements in all, eight fixes.
* 2.51 – Change “primary column” handling for WP 4.3+ to be more like Media/Library submenu table. Some MLA UI Elements Example plugin fixes.
* 2.50 – Completely new Settings/Custom Fields tab, [mla\_term\_list] and example plugin enhancements. Fourteen enhancements in all, sixteen fixes.

#### 2.40 – 2.41

* 2.41 – Updated example plugins, EXIF improvements, PHP 5.3 compatibility, Polylang fix. Five enhancements in all, ten fixes.
* 2.40 – Generate WP 4.7 PDF thumbnails, new Shortcodes tab, requires less admin-mode memory, Examples tab “View” action and “Installed” view. Seventeen other enhancements, fourteen fixes.

#### 2.30 – 2.33

* 2.33 – Fix WordPress “The plugin does not have a valid header” errors on initial MLA installs. Two enhancements, one other fix.
* 2.32 – New Documentation/Example Plugins submenu and installer, WordPress 4.6 fixes and several new example plugins. Sixteen enhancements in all, nine fixes.
* 2.31 – Remove call to `xdebug_get_function_stack()` causing fatal PHP error.
* 2.30 – New [mla\_term-list] shortcode for hierarchical taxonomy display, Uncaught RangeError fix, custom data sources. Thirteen enhancements in all, six fixes.

#### 2.00 – 2.25

* 2.25 – Default shortcode parameters in templates, list/grid view switcher, delete option settings, better XML parsing. Eight enhancements in all, eleven fixes.
* 2.24 – Corrects the MLA error that suppressed Admin Columns functions for Posts, Pages, Custom Post Types, Users and Comments.
* 2.23 – Admin Columns 2.4.9 fixes, EXIF/XMP/PDF improvements, Posts, Pages and custom Post Types in `[mla_gallery]` display. Seven enhancements in all, six fixes.
* 2.22 – Support for the “Admin Columns” plugin, PHP7 and “enclosing shortcode” syntax. Better performance, new filters and examples. Eight enhancements in all, eight fixes.
* 2.21 – Fix for “empty grid”, “No media attachments found”, “No items found” and “Unknown column” symptoms. Thanks to all who quickly alerted me to the problem. One other fix for “Featured Image” handling of size=none.
* 2.20 – Reduced memory/time footprint, default setting changes, WPML/Polylang IPTC/EXIF mapping fixes, partial German translation. Nine other enhancements, thirteen fixes.
* 2.15 – Bulk Edit Reset button, Debug tab enhancements, Quick Edit thumbnails, new examples and hooks. Sixteen enhancements in all, sixteen fixes.
* 2.14 – Final WordPress 4.3 updates. New Debug tab features. Updated Dutch translation. Four other fixes.
* 2.13 – WordPress 4.3 updates. PDF Thumbnail image generator. Wildcard keyword/term searching. Several WPML and Polylang fixes. Dutch and Swedish translations! Twelve other enhancements, twelve other fixes.
* 2.12 – Fixes a defect in [mla\_gallery] handling of the mla\_caption parameter. Adds mla\_debug=log option.
* 2.11 – Enhanced WPML and new Polylang support. “Attached” Media/Assistant table view. Eight other enhancements, fifteen fixes.

  \*2.10 – mla\_viewer is back, with a Featured Image option! XMP support for image meta data. Eight other enhancements, twelve fixes.
* 2.02 – Bulk Edit on Media/Add New, pause/restart IPTC/EXIF mapping, EXIF CAMERA fields, “timestamp”, “date” and “fraction” format options. Six other enhancements, twelve fixes.
* 2.01 – Google File Viewer (mla\_viewer) disabled. IPTC/EXIF mapping performance gains. Four other enhancements, five fixes.
* 2.00 – Requires WP v3.5+. Ajax-powered bulk edit and mapping, front-end “terms search” for [mla\_gallery]. Five other enhancements, two fixes.

#### 1.00 – 1.95

* 1.95: New [mla\_gallery] parameters, Download rollover action, Media/Assistant submenu filters. Eleven enhancements, seven fixes.
* 1.94: Media Manager fixes and new “current-item” parameters for [mla\_tag\_cloud]. Two other enhancements, seven fixes.
* 1.93: WordPress 4.0 Media Grid enhancements (optional) and compatibility fixes. New auto-fill option for Media Manager taxonomy meta boxes. One other enhancement, three other fixes.
* 1.92: Three bug fixes, one serious.
* 1.91: WordPress 4.0 support! New “Edit Media meta box” and “Media Modal Initial Values” filters and example plugins. Four other enhancements, six fixes.
* 1.90: New “Terms Search” popup window and Search Media “Terms” checkbox. Post Type filter and pagination for “Select Parent” popup. Ten other enhancements, five fixes.
* 1.83: Corrects serious defect, restoring Quick Edit, Bulk Edit and Screen Options to Media/Assistant submenu. Three other fixes.
* 1.82: “Select Parent” popup window (Media/Edit Media, Attached to column, Quick Edit area), SVG support and several new filter examples. Five other enhancements, three other fixes.
* 1.81: Corrects serious defect in Media Manager Modal Window file uploading. Adds item-specific tag clouds. One other enhancement, five other fixes.
* 1.80: Full taxonomy meta box support in the Media Manager Modal Window. Checkbox-style meta box for flat taxonomies. Fourteen other enhancements, nine fixes.
* 1.71: Searchable Category meta boxes for the Media/Edit Media screen. Support for the WordPress “Attachment Display Settings”. Six fixes.
* 1.70: Internationalization and localization support! Custom Field and IPTC/EXIF Mapping hooks. One other enhancement, six fixes.
* 1.61: Three fixes, including one significant fix for item-specific markup substitution parameters. Tested for compatibility with WP 3.8.
* 1.60: New [mla\_tag\_cloud] shortcode and shortcode-enabled MLA Text Widget. Five other enhancements, four fixes.
* 1.52: Corrected serious defect in [mla\_gallery] that incorrectly limited the number of items returned for non-paginated galleries. One other fix.
* 1.51: Attachment Metadata mapping/updating, [mla\_gallery] “apply\_filters” hooks, multiple paginated galleries per page, “ALL\_CUSTOM” pseudo value. Three other enhancements, six fixes.
* 1.50: PDF and GPS Metadata support. Content Templates; mix literal text with data values, test for empty values and choose among two or more alternatives for [mla\_gallery] and data mapping. Four other enhancements, seven fixes.
* 1.43: Generalized pagination support with “mla\_output=paginate\_links”. One other enhancement, four fixes.
* 1.42: Pagination support for [mla\_gallery]! Improved CSS width (itemwidth) and margin handling. Eight other enhancements, six fixes.
* 1.41: New [mla\_gallery] “previous link” and “next link” output for gallery navigation. New “request” substitution parameter to access $\_REQUEST variables. Three other enhancements, seven fixes.
* 1.40: Better performance! New custom table views, Post MIME Type and Upload file/MIMEs control; 112 file type icons to choose from. Four new Gallery Display Content parameters. four other enhancements, twelve fixes.
* 1.30: New “mla\_alt\_shortcode” parameter combines [mla\_gallery] with other gallery display shortcodes, e.g., Jetpack Carousel and Tiled Mosaic. Support for new 3.6 audio/video metadata. One other enhancement, eight fixes.
* 1.20: Media Manager (Add Media, etc.) enhancements: filter by more MIME types, date, taxonomy terms; enhanced search box for name/slug, ALT text, caption and attachment ID. New [mla\_gallery] sort options. Four other enhancements, four fixes.
* 1.14: New [mla\_gallery] mla\_target and tax\_operator parameters, tax\_query cleanup and ids/include fix. Attachments column fix. IPTC/EXIF and Custom Field mapping fixes. Three other fixes.
* 1.13: Add custom fields to the quick and bulk edit areas; sort and search on them in the Media/Assistant submenu. Expanded EXIF data access, including COMPUTED values. Google File Viewer support, two other enhancements and two fixes.
* 1.11: Search by attachment ID, avoid fatal errors and other odd results when adding taxonomy terms. One other fix.
* 1.10: Map attachment metadata to custom fields; add them to [mla\_gallery] display and as sortable columns on the Media/Assistant submenu table. Get Photonic Gallery (plugin) integration and six other fixes.
* 1.00: Map IPTC and EXIF metadata to standard fields, taxonomy terms and custom fields. Improved performance for where-used reporting. Specify default `[mla_gallery]` style and markup templates. Five other fixes.

#### 0.11 – 0.90

* `[mla_gallery]` support for custom fields, taxonomy terms and IPTC/EXIF metadata. Updated for WordPress 3.5!
* Improved default Style template, `[mla_gallery]` parameters “mla\_itemwidth” and “mla\_margin” for control of gallery item spacing. Quick edit support of WordPress standard Categories taxonomy has been fixed.
* MLA Gallery Style and Markup Templates for control over CSS styles, HTML markup and data content of `[mla_gallery]` shortcode output. Eight other enhancements and four fixes.
* Removed (!) Warning displays for empty Gallery in and MLA Gallery in column entries.
* New “Gallery in” and “MLA Gallery in” where-used reporting to see where items are returned by the `[gallery]` and `[mla_gallery]` shortcodes. Two other enhancements and two fixes.
* Enhanced Search Media box. Extend search to the name/slug, ALT text and caption fields. Connect search terms with “and” or “or”. Five other enhancements and two fixes.
* New `[mla_gallery]` shortcode, a superset of the `[gallery]` shortcode that provides many enhancements. These include taxonomy support and all post\_mime\_type values (not just images). Media Library items need not be “attached” to the post.
* SQL View (supporting ALT Text sorting) now created for automatic plugin upgrades
* Bulk Edit area; add, remove or replace taxonomy terms for several attachments at once. Sort your media listing on ALT Text, exclude revisions from where-used reporting.
* Support ALL taxonomies, including the standard Categories and Tags, your custom taxonomies and the Assistant’s pre-defined Att. Categories and Att. Tags. Add taxonomy columns to the Assistant admin screen, filter on any taxonomy, assign terms and list the attachments for a term.
* Quick Edit action for inline editing of attachment metadata
* Fixed “404 Not Found” errors when updating single items.

#### 0.1

* Initial release.

## Meta

* Version **3.24**
* Last updated **2 weeks ago**
* Active installations **70,000+**
* WordPress version **4.1 or higher**
* Tested up to **6.7.1**
* PHP version **5.3 or higher**
* Languages
  See all 4

  Close

  [Czech](https://cs.wordpress.org/plugins/media-library-assistant/), [Dutch](https://nl.wordpress.org/plugins/media-library-assistant/), [English (US)](https://wordpress.org/plugins/media-library-assistant/), and [Finnish](https://fi.wordpress.org/plugins/media-library-assistant/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/media-library-assistant)
* Tags [categories](https://wordpress.org/plugins/tags/categories/)[images](https://wordpress.org/plugins/tags/images/)[media](https://wordpress.org/plugins/tags/media/)[media library](https://wordpress.org/plugins/tags/media-library/)[tags](https://wordpress.org/plugins/tags/tags/)
* [Advanced View](https://wordpress.org/plugins/media-library-assistant/advanced/)

## Ratings

4.8 out of 5 stars.

* [178 5-star reviews
  5 stars

  178](https://wordpress.org/support/plugin/media-library-assistant/reviews/?filter=5)
* [8 4-star reviews
  4 stars

  8](https://wordpress.org/support/plugin/media-library-assistant/reviews/?filter=4)
* [2 3-star reviews
  3 stars

  2](https://wordpress.org/support/plugin/media-library-assistant/reviews/?filter=3)
* [1 2-star review
  2 stars

  1](https://wordpress.org/support/plugin/media-library-assistant/reviews/?filter=2)
* [4 1-star reviews
  1 star

  4](https://wordpress.org/support/plugin/media-library-assistant/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/media-library-assistant/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/media-library-assistant/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/299ab71850a3d6fb44062f52ef927c600dd5570c3d4ce1286dff97342be6a31e?s=32&d=mm&r=g) [David Lingren](https://profiles.wordpress.org/dglingren/)
## Support

Issues resolved in last two months:

13 out of 16

[View support forum](https://wordpress.org/support/plugin/media-library-assistant/)

## Donate

Would you like to support the advancement of this plugin?

[Donate to this plugin](http://davidlingren.com/#donate)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_6c31176f_20250114_213137.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmedia-library-assistant%2Ftrunk%2Fexamples%2Fplugins%2Fwoofixit.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/media-library-assistant/trunk/examples/plugins/woofixit.php?rev=2828011 "Revision 2828011")
* Next Revision →
* [Blame](/browser/media-library-assistant/trunk/examples/plugins/woofixit.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/media-library-assistant/trunk/examples/plugins/woofixit.php)

---

# [source:](/browser?order=name "Go to repository root") [media-library-assistant](/browser/media-library-assistant?order=name "View media-library-assistant")/[trunk](/browser/media-library-assistant/trunk?order=name "View trunk")/[examples](/browser/media-library-assistant/trunk/examples?order=name "View examples")/[plugins](/browser/media-library-assistant/trunk/examples/plugins?order=name "View plugins")/[woofixit.php](/browser/media-library-assistant/trunk/examples/plugins/woofixit.php?order=name "View woofixit.php")

View diff against:

View revision:

| [Last change](/changeset/3202657/media-library-assistant/trunk/examples/plugins/woofixit.php "View differences") on this file was [3202657](/changeset/3202657/ "View changeset 3202657"), checked in by dglingren, [6 weeks ago](/timeline?from=2024-12-04T21%3A10%3A24Z&precision=second "See timeline at 12/04/2024 09:10:24 PM") |
| --- |
| Field-level data sources for accessing information about the original, unscaled files for very large images. Reflected Cross-Site Scripting security risks in the Smart Media Categories, MLA Unattached Fixit, and WooCommerce Fixit example plugins have been mitigated. |
| **File size:** 155.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Adds "product:" and "product\_terms:" custom substitution prefixes and |
| [4](#L4) | \* adds a Tools/Woo Fixit submenu with buttons to perform a variety of |
| [5](#L5) | \* MLA/WooCommerce repair and enhancement operations. |
| [6](#L6) | \* |
| [7](#L7) | \* This example supports several "tools"/operations: |
| [8](#L8) | \* |
| [9](#L9) | \*  - Delete ALL Title fields for Product Image/Product Gallery items. |
| [10](#L10) | \*  - Fill empty item Title field with re-formatted file name. |
| [11](#L11) | \*  - Replace ALL item Title fields with re-formatted file name. |
| [12](#L12) | \*  - Replace ALL item Name/Slug fields with (unique) file name. |
| [13](#L13) | \* |
| [14](#L14) | \*  - Delete ALL ALT Text fields for Product Image/Product Gallery items. |
| [15](#L15) | \*  - Fill empty ALT Text field with first top-level Product Category. |
| [16](#L16) | \*  - Replace ALL ALT Text field with first top-level Product Category. |
| [17](#L17) | \*  - Fill empty ALT Text field with Product Title. |
| [18](#L18) | \*  - Replace ALL ALT Text field with Product Title. |
| [19](#L19) | \*  - Fill empty item Title field with Product Title. |
| [20](#L20) | \*  - Replace ALL item Title field with Product Title. |
| [21](#L21) | \* |
| [22](#L22) | \*  - Remove Product/Featured Image from the Product Gallery. |
| [23](#L23) | \*  - Restore Product/Featured Image to the Product Gallery. |
| [24](#L24) | \*  - Reverse the image order in the Product Gallery. |
| [25](#L25) | \*  - Replace "where\_used" information in custom field "Woo Used In". |
| [26](#L26) | \* |
| [27](#L27) | \*  - Delete ALL Product Tags assignments where a Product Image exists. |
| [28](#L28) | \*  - Fill empty Product Tags assignments from Product Image Att. Tags |
| [29](#L29) | \*    where a Product Image exists. |
| [30](#L30) | \*  - Append Product Tags assignments to ALL Products from Product Image |
| [31](#L31) | \*    Att. Tags where a Product Image exists. |
| [32](#L32) | \*  - Replace ALL Product Tags assignments from Product Image Att. Tags |
| [33](#L33) | \*    where a Product Image exists. |
| [34](#L34) | \* |
| [35](#L35) | \*  - Delete ALL Products' Product Categories assignments where a Product Image exists. |
| [36](#L36) | \*  - Fill empty Product Categories assignments from Product Image Att. Tags, |
| [37](#L37) | \*    where the Product Image Att. Tag matches an existing Product Category. |
| [38](#L38) | \*  - Append Product Categories assignments to ALL Products from Product Image |
| [39](#L39) | \*    Att. Tags, where the Product Image Att. Tag matches an existing Product Category. |
| [40](#L40) | \*  - Replace ALL Product Categories assignments from Product Image Att. Tags, |
| [41](#L41) | \*    where the Product Image Att. Tag matches an existing Product Category. |
| [42](#L42) | \* |
| [43](#L43) | \*  - Delete ALL Att. Categories assignments. |
| [44](#L44) | \*  - Fill empty Att. Categories assignments from Att. Tags, where the |
| [45](#L45) | \*    Att. Tag matches an existing Att. Category. |
| [46](#L46) | \*  - Append Att. Categories assignments to ALL items from Att. Tags, |
| [47](#L47) | \*    where the Att. Tag matches an existing Att. Category. |
| [48](#L48) | \*  - Replace ALL Att. Categories assignments from Att. Tags, where the |
| [49](#L49) | \*    Att. Tag matches an existing Att. Category. |
| [50](#L50) | \* |
| [51](#L51) | \*  - Delete product\_category and/or product\_tag term assignments to Media Library items. |
| [52](#L52) | \*  - Copy product\_category and/or product\_tag term assignments to Media Library items |
| [53](#L53) | \*    for items used as Product Image or in the Product Gallery |
| [54](#L54) | \* |
| [55](#L55) | \*  - Populate Product values from Content Template(s) using Product Image data sources |
| [56](#L56) | \*    Name, Description, Short Description, Categories, SKU |
| [57](#L57) | \* |
| [58](#L58) | \* Created for support topic "Remove first image in all product galleries" |
| [59](#L59) | \* opened on 5/23/2014 by "Dana S". |
| [60](#L60) | \* https://wordpress.org/support/topic/remove-first-image-in-all-product-galleries/ |
| [61](#L61) | \* |
| [62](#L62) | \* and for support topic "set the product category as alt and title tag for all images" |
| [63](#L63) | \* opened on 5/23/2014 by "Dana S". |
| [64](#L64) | \* https://wordpress.org/support/topic/set-the-product-category-as-alt-and-title-tag-for-all-images/ |
| [65](#L65) | \* |
| [66](#L66) | \* Enhanced for support topic "Woocommerce product category" |
| [67](#L67) | \* opened on 9/17/2015 by "vnp\_nl". |
| [68](#L68) | \* https://wordpress.org/support/topic/woocommerce-product-category-2/ |
| [69](#L69) | \* |
| [70](#L70) | \* Enhanced for support topic "Bulk addition of image alt tags to WooCommerce Product Images" |
| [71](#L71) | \* opened on 11/18/2015 by "Thrive Internet Marketing". |
| [72](#L72) | \* https://wordpress.org/support/topic/bulk-addition-of-image-alt-tags-to-woocommerce-product-images/ |
| [73](#L73) | \* |
| [74](#L74) | \* Enhanced for support topic "Woocommerce product tags?" |
| [75](#L75) | \* opened on 11/12/2016 by "gyulai.zoltan". |
| [76](#L76) | \* https://wordpress.org/support/topic/woocommerce-product-tags-2/ |
| [77](#L77) | \* |
| [78](#L78) | \* Enhanced for support topic "Maping Image ALT Tags to Product Meta Title" |
| [79](#L79) | \* opened on 12/6/2016 by "webpresencech". |
| [80](#L80) | \* https://wordpress.org/support/topic/maping-image-alt-tags-to-product-meta-title/ |
| [81](#L81) | \* |
| [82](#L82) | \* Enhanced for support topic "Regenerate Bulk ALT TEXT with Product Name + Product Category + Keyword" |
| [83](#L83) | \* opened on 2/21/2017 by "bueyfx". |
| [84](#L84) | \* https://wordpress.org/support/topic/regenerate-bulk-alt-text-with-product-name-product-category-keyword/ |
| [85](#L85) | \* |
| [86](#L86) | \* Enhanced for support topic "WC Fixit Tools: Replace ALL item Name/Slug" |
| [87](#L87) | \* opened on 10/18/2018 by "alx359". |
| [88](#L88) | \* https://wordpress.org/support/topic/wc-fixit-tools-replace-all-item-name-slug/ |
| [89](#L89) | \* |
| [90](#L90) | \* Enhanced for support topic "Product categories thumbnails" |
| [91](#L91) | \* opened on 9/18/2019 by "wimvl". |
| [92](#L92) | \* https://wordpress.org/support/topic/product-categories-thumbnails-2/ |
| [93](#L93) | \* |
| [94](#L94) | \* Enhanced for support topic "Populating WooCommerce Fields when Uploading Media" |
| [95](#L95) | \* opened on 11/26/2019 by "mrphil". |
| [96](#L96) | \* https://wordpress.org/support/topic/populating-woocommerce-fields-when-uploading-media/ |
| [97](#L97) | \* |
| [98](#L98) | \* Enhanced for support topic "Image keywords (tags) into a product tags" |
| [99](#L99) | \* opened on 1/19/2020 by "kuassar". |
| [100](#L100) | \* https://wordpress.org/support/topic/image-keywords-tags-into-a-product-tags/ |
| [101](#L101) | \* |
| [102](#L102) | \* Enhanced for support topic "Adding images to product" |
| [103](#L103) | \* opened on 2/25/2021 by "fireskyresale". |
| [104](#L104) | \* https://wordpress.org/support/topic/adding-images-to-product/ |
| [105](#L105) | \* |
| [106](#L106) | \* Enhanced (Reflected Cross-Site Scripting security fix) for Wordfence CVE ID: CVE-2024-11974 report |
| [107](#L107) | \* opened on 12/03/2024 by "vgo0": |
| [108](#L108) | \* |
| [109](#L109) | \* @package WooCommerce Fixit |
| [110](#L110) | \* @version 2.12 |
| [111](#L111) | \*/ |
| [112](#L112) |  |
| [113](#L113) | /\* |
| [114](#L114) | Plugin Name: WooCommerce Fixit |
| [115](#L115) | Plugin URI: http://davidlingren.com/ |
| [116](#L116) | Description: Adds "product:" and "product\_terms:" custom substitution prefixes and adds a Tools/Woo Fixit submenu with buttons to perform a variety of MLA/WooCommerce repair and enhancement operations. |
| [117](#L117) | Author: David Lingren |
| [118](#L118) | Version: 2.12 |
| [119](#L119) | Author URI: http://davidlingren.com/ |
| [120](#L120) |  |
| [121](#L121) | Copyright 2014-2021 David Lingren |
| [122](#L122) |  |
| [123](#L123) | This program is free software; you can redistribute it and/or modify |
| [124](#L124) | it under the terms of the GNU General Public License as published by |
| [125](#L125) | the Free Software Foundation; either version 2 of the License, or |
| [126](#L126) | (at your option) any later version. |
| [127](#L127) |  |
| [128](#L128) | This program is distributed in the hope that it will be useful, |
| [129](#L129) | but WITHOUT ANY WARRANTY; without even the implied warranty of |
| [130](#L130) | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the |
| [131](#L131) | GNU General Public License for more details. |
| [132](#L132) |  |
| [133](#L133) | You can get a copy of the GNU General Public License by writing to the |
| [134](#L134) | Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110, USA |
| [135](#L135) | \*/ |
| [136](#L136) |  |
| [137](#L137) | /\*\* |
| [138](#L138) | \* Class Woo Fixit implements a Tools submenu page with several image-fixing tools. |
| [139](#L139) | \* |
| [140](#L140) | \* @package WooCommerce Fixit |
| [141](#L141) | \* @since 1.00 |
| [142](#L142) | \*/ |
| [143](#L143) | class Woo\_Fixit { |
| [144](#L144) | /\*\* |
| [145](#L145) | \* Current version number |
| [146](#L146) | \* |
| [147](#L147) | \* @since 1.00 |
| [148](#L148) | \* |
| [149](#L149) | \* @var string |
| [150](#L150) | \*/ |
| [151](#L151) | const CURRENT\_VERSION = '2.12'; |
| [152](#L152) |  |
| [153](#L153) | /\*\* |
| [154](#L154) | \* Slug prefix for registering and enqueueing submenu pages, style sheets and scripts |
| [155](#L155) | \* |
| [156](#L156) | \* @since 1.00 |
| [157](#L157) | \* |
| [158](#L158) | \* @var string |
| [159](#L159) | \*/ |
| [160](#L160) | const SLUG\_PREFIX = 'woofixit-'; |
| [161](#L161) |  |
| [162](#L162) | /\*\* |
| [163](#L163) | \* Lowest product ID to be processed |
| [164](#L164) | \* |
| [165](#L165) | \* @since 1.26 |
| [166](#L166) | \* |
| [167](#L167) | \* @var string |
| [168](#L168) | \*/ |
| [169](#L169) | private static $first\_product = ''; |
| [170](#L170) | const INPUT\_FIRST\_PRODUCT = 'lower'; |
| [171](#L171) |  |
| [172](#L172) | /\*\* |
| [173](#L173) | \* Highest product ID to be processed |
| [174](#L174) | \* |
| [175](#L175) | \* @since 1.26 |
| [176](#L176) | \* |
| [177](#L177) | \* @var string |
| [178](#L178) | \*/ |
| [179](#L179) | private static $last\_product = ''; |
| [180](#L180) | const INPUT\_LAST\_PRODUCT = 'upper'; |
| [181](#L181) |  |
| [182](#L182) | /\*\* |
| [183](#L183) | \* Append Item ID to make file name slug unique |
| [184](#L184) | \* |
| [185](#L185) | \* @since 2.04 |
| [186](#L186) | \* |
| [187](#L187) | \* @var boolean |
| [188](#L188) | \*/ |
| [189](#L189) | private static $append\_item\_id = false; |
| [190](#L190) | const APPEND\_ITEM\_ID = 'append-item-id'; |
| [191](#L191) |  |
| [192](#L192) | /\*\* |
| [193](#L193) | \* Append Item ID checkbox attribute |
| [194](#L194) | \* |
| [195](#L195) | \* @since 2.06 |
| [196](#L196) | \* |
| [197](#L197) | \* @var string |
| [198](#L198) | \*/ |
| [199](#L199) | private static $append\_item\_id\_attr = ' '; |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Use WordPress unique slug function |
| [203](#L203) | \* |
| [204](#L204) | \* @since 2.04 |
| [205](#L205) | \* |
| [206](#L206) | \* @var boolean |
| [207](#L207) | \*/ |
| [208](#L208) | private static $check\_unique\_slug = false; |
| [209](#L209) | const CHECK\_UNIQUE\_SLUG = 'check-unique-slug'; |
| [210](#L210) |  |
| [211](#L211) | /\*\* |
| [212](#L212) | \* Use WordPress unique slug checkbox attribute |
| [213](#L213) | \* |
| [214](#L214) | \* @since 2.06 |
| [215](#L215) | \* |
| [216](#L216) | \* @var string |
| [217](#L217) | \*/ |
| [218](#L218) | private static $check\_unique\_slug\_attr = ' '; |
| [219](#L219) |  |
| [220](#L220) | /\*\* |
| [221](#L221) | \* Add Product Image to Product Gallery |
| [222](#L222) | \* |
| [223](#L223) | \* @since 2.10 |
| [224](#L224) | \* |
| [225](#L225) | \* @var boolean |
| [226](#L226) | \*/ |
| [227](#L227) | private static $add\_image\_to\_gallery = false; |
| [228](#L228) | const ADD\_IMAGE\_TO\_GALLERY = 'add-image-to-gallery'; |
| [229](#L229) |  |
| [230](#L230) | /\*\* |
| [231](#L231) | \* Append Item ID checkbox attribute |
| [232](#L232) | \* |
| [233](#L233) | \* @since 2.10 |
| [234](#L234) | \* |
| [235](#L235) | \* @var string |
| [236](#L236) | \*/ |
| [237](#L237) | private static $add\_image\_to\_gallery\_attr = ' '; |
| [238](#L238) |  |
| [239](#L239) | /\*\* |
| [240](#L240) | \* Use WordPress unique slug function |
| [241](#L241) | \* |
| [242](#L242) | \* @since 2.10 |
| [243](#L243) | \* |
| [244](#L244) | \* @var boolean |
| [245](#L245) | \*/ |
| [246](#L246) | private static $delete\_no\_children = false; |
| [247](#L247) | const DELETE\_NO\_CHILDREN = 'delete-no-children'; |
| [248](#L248) |  |
| [249](#L249) | /\*\* |
| [250](#L250) | \* Use WordPress unique slug checkbox attribute |
| [251](#L251) | \* |
| [252](#L252) | \* @since 2.10 |
| [253](#L253) | \* |
| [254](#L254) | \* @var string |
| [255](#L255) | \*/ |
| [256](#L256) | private static $delete\_no\_children\_attr = ' '; |
| [257](#L257) |  |
| [258](#L258) | /\*\* |
| [259](#L259) | \* Populate Product Image and Gallery with children from MLA Bulk Edit on Upload |
| [260](#L260) | \* |
| [261](#L261) | \* @since 2.10 |
| [262](#L262) | \* |
| [263](#L263) | \* @var boolean |
| [264](#L264) | \*/ |
| [265](#L265) | const POPULATE\_PI\_PG\_ON\_UPLOAD = 'populate-pi-pg-on-upload'; |
| [266](#L266) | const DEFAULT\_POPULATE\_PI\_PG\_ON\_UPLOAD = false; |
| [267](#L267) |  |
| [268](#L268) | /\*\* |
| [269](#L269) | \* Append Item ID checkbox attribute |
| [270](#L270) | \* |
| [271](#L271) | \* @since 2.10 |
| [272](#L272) | \* |
| [273](#L273) | \* @var string |
| [274](#L274) | \*/ |
| [275](#L275) | private static $populate\_pi\_pg\_on\_upload\_attr = ' '; |
| [276](#L276) |  |
| [277](#L277) | /\*\* |
| [278](#L278) | \* Populate Product Image and Gallery with children from WP MMMW |
| [279](#L279) | \* |
| [280](#L280) | \* @since 2.10 |
| [281](#L281) | \* |
| [282](#L282) | \* @var boolean |
| [283](#L283) | \*/ |
| [284](#L284) | const POPULATE\_PI\_PG\_ON\_MMMW = 'populate-pi-pg-on-mmmw'; |
| [285](#L285) | const DEFAULT\_POPULATE\_PI\_PG\_ON\_MMMW = false; |
| [286](#L286) |  |
| [287](#L287) | /\*\* |
| [288](#L288) | \* Append Item ID checkbox attribute |
| [289](#L289) | \* |
| [290](#L290) | \* @since 2.10 |
| [291](#L291) | \* |
| [292](#L292) | \* @var string |
| [293](#L293) | \*/ |
| [294](#L294) | private static $populate\_pi\_pg\_on\_mmmw\_attr = ' '; |
| [295](#L295) |  |
| [296](#L296) | /\*\* |
| [297](#L297) | \* Content Template for Product Image/Product Gallery Images |
| [298](#L298) | \* |
| [299](#L299) | \* @since 1.28 |
| [300](#L300) | \* |
| [301](#L301) | \* @var string |
| [302](#L302) | \*/ |
| [303](#L303) | private static $content\_template = ''; |
| [304](#L304) | const INPUT\_CONTENT\_TEMPLATE = 'template'; |
| [305](#L305) |  |
| [306](#L306) | /\*\* |
| [307](#L307) | \* Process term assignments for Product Category |
| [308](#L308) | \* |
| [309](#L309) | \* @since 1.26 |
| [310](#L310) | \* |
| [311](#L311) | \* @var boolean |
| [312](#L312) | \*/ |
| [313](#L313) | private static $process\_category = false; |
| [314](#L314) | const INPUT\_PROCESS\_CATEGORY = 'category'; |
| [315](#L315) |  |
| [316](#L316) | /\*\* |
| [317](#L317) | \* Process term assignments for Product Category checkbox attribute |
| [318](#L318) | \* |
| [319](#L319) | \* @since 2.06 |
| [320](#L320) | \* |
| [321](#L321) | \* @var string |
| [322](#L322) | \*/ |
| [323](#L323) | private static $category\_attr = ' '; |
| [324](#L324) |  |
| [325](#L325) | /\*\* |
| [326](#L326) | \* Process term assignments for Product Tag |
| [327](#L327) | \* |
| [328](#L328) | \* @since 1.26 |
| [329](#L329) | \* |
| [330](#L330) | \* @var boolean |
| [331](#L331) | \*/ |
| [332](#L332) | private static $process\_tag = false; |
| [333](#L333) | const INPUT\_PROCESS\_TAG = 'tag'; |
| [334](#L334) |  |
| [335](#L335) | /\*\* |
| [336](#L336) | \* Process term assignments for Product Tag checkbox attribute |
| [337](#L337) | \* |
| [338](#L338) | \* @since 2.06 |
| [339](#L339) | \* |
| [340](#L340) | \* @var string |
| [341](#L341) | \*/ |
| [342](#L342) | private static $tag\_attr = ' '; |
| [343](#L343) |  |
| [344](#L344) | /\*\* |
| [345](#L345) | \* Chunk (offset) to start term assignments at |
| [346](#L346) | \* |
| [347](#L347) | \* @since 1.26 |
| [348](#L348) | \* |
| [349](#L349) | \* @var integer |
| [350](#L350) | \*/ |
| [351](#L351) | private static $start\_chunk = 1; |
| [352](#L352) | const INPUT\_FIRST\_CHUNK = 'first'; |
| [353](#L353) |  |
| [354](#L354) | /\*\* |
| [355](#L355) | \* Chunk (offset) to stop term assignments at |
| [356](#L356) | \* |
| [357](#L357) | \* @since 1.26 |
| [358](#L358) | \* |
| [359](#L359) | \* @var integer |
| [360](#L360) | \*/ |
| [361](#L361) | private static $stop\_chunk = 999; |
| [362](#L362) | const INPUT\_LAST\_CHUNK = 'last'; |
| [363](#L363) |  |
| [364](#L364) | /\*\* |
| [365](#L365) | \* Chunk size (limit) for term assignment processing |
| [366](#L366) | \* |
| [367](#L367) | \* @since 1.26 |
| [368](#L368) | \* |
| [369](#L369) | \* @var integer |
| [370](#L370) | \*/ |
| [371](#L371) | private static $chunk\_size = 1000; |
| [372](#L372) | const INPUT\_CHUNK\_SIZE = 'size'; |
| [373](#L373) |  |
| [374](#L374) | /\*\* |
| [375](#L375) | \* Product Name (post\_title) Template for Populate Product from Product Image |
| [376](#L376) | \* |
| [377](#L377) | \* @since 2.06 |
| [378](#L378) | \* |
| [379](#L379) | \* @var string |
| [380](#L380) | \*/ |
| [381](#L381) | const NAME\_TEMPLATE = 'name-template'; |
| [382](#L382) | const DEFAULT\_NAME\_TEMPLATE = '[+alt\_text+]'; |
| [383](#L383) |  |
| [384](#L384) | /\*\* |
| [385](#L385) | \* Product Description (post\_content)  Template for Populate Product from Product Image |
| [386](#L386) | \* |
| [387](#L387) | \* @since 2.06 |
| [388](#L388) | \* |
| [389](#L389) | \* @var string |
| [390](#L390) | \*/ |
| [391](#L391) | const DESCRIPTION\_TEMPLATE = 'description-template'; |
| [392](#L392) | const DEFAULT\_DESCRIPTION\_TEMPLATE = '[+post\_content+]'; |
| [393](#L393) |  |
| [394](#L394) | /\*\* |
| [395](#L395) | \* Product Short Description (post\_excerpt) Template for Populate Product from Product Image |
| [396](#L396) | \* |
| [397](#L397) | \* @since 2.06 |
| [398](#L398) | \* |
| [399](#L399) | \* @var string |
| [400](#L400) | \*/ |
| [401](#L401) | const SHORT\_DESCRIPTION\_TEMPLATE = 'short-description-template'; |
| [402](#L402) | const DEFAULT\_SHORT\_DESCRIPTION\_TEMPLATE = '[+post\_content+]'; |
| [403](#L403) |  |
| [404](#L404) | /\*\* |
| [405](#L405) | \* Product Categories ( taxonomy product\_cat ) Template for Populate Product from Product Image |
| [406](#L406) | \* |
| [407](#L407) | \* @since 2.06 |
| [408](#L408) | \* |
| [409](#L409) | \* @var string |
| [410](#L410) | \*/ |
| [411](#L411) | const CATEGORIES\_TEMPLATE = 'categories-template'; |
| [412](#L412) | const DEFAULT\_CATEGORIES\_TEMPLATE = '[+terms:attachment\_category+]'; |
| [413](#L413) |  |
| [414](#L414) | /\*\* |
| [415](#L415) | \* Product Tags ( taxonomy product\_tag ) Template for Populate Product from Product Image |
| [416](#L416) | \* |
| [417](#L417) | \* @since 2.09 |
| [418](#L418) | \* |
| [419](#L419) | \* @var string |
| [420](#L420) | \*/ |
| [421](#L421) | const TAGS\_TEMPLATE = 'tags-template'; |
| [422](#L422) | const DEFAULT\_TAGS\_TEMPLATE = ''; |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Product SKU ( postmeta \_sku ) Template for Populate Product from Product Image |
| [426](#L426) | \* |
| [427](#L427) | \* @since 2.06 |
| [428](#L428) | \* |
| [429](#L429) | \* @var string |
| [430](#L430) | \*/ |
| [431](#L431) | const SKU\_TEMPLATE = 'sku-template'; |
| [432](#L432) | const DEFAULT\_SKU\_TEMPLATE = '[+name\_only+]'; |
| [433](#L433) |  |
| [434](#L434) | /\*\* |
| [435](#L435) | \* Populate when Product Image is set |
| [436](#L436) | \* |
| [437](#L437) | \* @since 2.06 |
| [438](#L438) | \* |
| [439](#L439) | \* @var boolean |
| [440](#L440) | \*/ |
| [441](#L441) | const POPULATE\_ON\_ADD = 'populate-on-add'; |
| [442](#L442) | const DEFAULT\_POPULATE\_ON\_ADD = false; |
| [443](#L443) |  |
| [444](#L444) | /\*\* |
| [445](#L445) | \* Append Item ID checkbox attribute |
| [446](#L446) | \* |
| [447](#L447) | \* @since 2.06 |
| [448](#L448) | \* |
| [449](#L449) | \* @var string |
| [450](#L450) | \*/ |
| [451](#L451) | private static $populate\_on\_add\_attr = ' '; |
| [452](#L452) |  |
| [453](#L453) | /\*\* |
| [454](#L454) | \* Populate when Product Image is changed |
| [455](#L455) | \* |
| [456](#L456) | \* @since 2.06 |
| [457](#L457) | \* |
| [458](#L458) | \* @var boolean |
| [459](#L459) | \*/ |
| [460](#L460) | const POPULATE\_ON\_UPDATE = 'populate-on-update'; |
| [461](#L461) | const DEFAULT\_POPULATE\_ON\_UPDATE = false; |
| [462](#L462) |  |
| [463](#L463) | /\*\* |
| [464](#L464) | \* Append Item ID checkbox attribute |
| [465](#L465) | \* |
| [466](#L466) | \* @since 2.06 |
| [467](#L467) | \* |
| [468](#L468) | \* @var string |
| [469](#L469) | \*/ |
| [470](#L470) | private static $populate\_on\_update\_attr = ' '; |
| [471](#L471) |  |
| [472](#L472) | /\*\* |
| [473](#L473) | \* Processing options |
| [474](#L474) | \* |
| [475](#L475) | \* This array specifies the components used in the pretty links and whether |
| [476](#L476) | \* the mla\_debug=log argument is appended to the links |
| [477](#L477) | \* |
| [478](#L478) | \* @since 2.06 |
| [479](#L479) | \* |
| [480](#L480) | \* @var array |
| [481](#L481) | \*/ |
| [482](#L482) | private static $settings = array (); |
| [483](#L483) |  |
| [484](#L484) | /\*\* |
| [485](#L485) | \* Default processing options |
| [486](#L486) | \* |
| [487](#L487) | \* @since 2.06 |
| [488](#L488) | \* |
| [489](#L489) | \* @var array |
| [490](#L490) | \*/ |
| [491](#L491) | private static $default\_settings = array ( |
| [492](#L492) | self::POPULATE\_PI\_PG\_ON\_UPLOAD => self::DEFAULT\_POPULATE\_PI\_PG\_ON\_UPLOAD, |
| [493](#L493) | self::POPULATE\_PI\_PG\_ON\_MMMW => self::DEFAULT\_POPULATE\_PI\_PG\_ON\_MMMW, |
| [494](#L494) | self::NAME\_TEMPLATE => self::DEFAULT\_NAME\_TEMPLATE, |
| [495](#L495) | self::DESCRIPTION\_TEMPLATE => self::DEFAULT\_DESCRIPTION\_TEMPLATE, |
| [496](#L496) | self::SHORT\_DESCRIPTION\_TEMPLATE => self::DEFAULT\_SHORT\_DESCRIPTION\_TEMPLATE, |
| [497](#L497) | self::CATEGORIES\_TEMPLATE => self::DEFAULT\_CATEGORIES\_TEMPLATE, |
| [498](#L498) | self::TAGS\_TEMPLATE => self::DEFAULT\_TAGS\_TEMPLATE, |
| [499](#L499) | self::SKU\_TEMPLATE => self::DEFAULT\_SKU\_TEMPLATE, |
| [500](#L500) | self::POPULATE\_ON\_ADD => self::DEFAULT\_POPULATE\_ON\_ADD, |
| [501](#L501) | self::POPULATE\_ON\_UPDATE => self::DEFAULT\_POPULATE\_ON\_UPDATE, |
| [502](#L502) | ); |
| [503](#L503) |  |
| [504](#L504) | /\*\* |
| [505](#L505) | \* Update the plugin options from the wp\_options table or set defaults |
| [506](#L506) | \* |
| [507](#L507) | \* @since 2.06 |
| [508](#L508) | \*/ |
| [509](#L509) | private static function \_load\_settings() { |
| [510](#L510) | $settings = get\_option( self::SLUG\_PREFIX . 'settings' ); |
| [511](#L511) | if ( is\_array( $settings ) ) { |
| [512](#L512) | self::$settings = $settings; |
| [513](#L513) | // Adapt settings added in version 2.09 |
| [514](#L514) | if ( !isset( self::$settings[self::TAGS\_TEMPLATE] ) ) { |
| [515](#L515) | self::$settings[self::TAGS\_TEMPLATE] = self::$default\_settings[self::TAGS\_TEMPLATE]; |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | // Adapt settings added in version 2.10 |
| [519](#L519) | if ( !isset( self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] ) ) { |
| [520](#L520) | self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] = self::$default\_settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD]; |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | if ( !isset( self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] ) ) { |
| [524](#L524) | self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] = self::$default\_settings[self::POPULATE\_PI\_PG\_ON\_MMMW]; |
| [525](#L525) | } |
| [526](#L526) |  |
| [527](#L527) | self::$populate\_pi\_pg\_on\_upload\_attr = self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] ? ' checked="checked" ' : ' '; |
| [528](#L528) | self::$populate\_pi\_pg\_on\_mmmw\_attr = self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] ? ' checked="checked" ' : ' '; |
| [529](#L529) | self::$populate\_on\_add\_attr = self::$settings[self::POPULATE\_ON\_ADD] ? ' checked="checked" ' : ' '; |
| [530](#L530) | self::$populate\_on\_update\_attr = self::$settings[self::POPULATE\_ON\_UPDATE] ? ' checked="checked" ' : ' '; |
| [531](#L531) |  |
| [532](#L532) | return 'Settings loaded from database.'; |
| [533](#L533) | } else { |
| [534](#L534) | self::$settings = self::$default\_settings; |
| [535](#L535) | self::$populate\_pi\_pg\_on\_upload\_attr = self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] ? ' checked="checked" ' : ' '; |
| [536](#L536) | self::$populate\_pi\_pg\_on\_mmmw\_attr = self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] ? ' checked="checked" ' : ' '; |
| [537](#L537) | self::$populate\_on\_add\_attr = self::$settings[self::POPULATE\_ON\_ADD] ? ' checked="checked" ' : ' '; |
| [538](#L538) | self::$populate\_on\_update\_attr = self::$settings[self::POPULATE\_ON\_UPDATE] ? ' checked="checked" ' : ' '; |
| [539](#L539) |  |
| [540](#L540) | return 'No settings in database; defaults loaded.'; |
| [541](#L541) | } |
| [542](#L542) | } |
| [543](#L543) |  |
| [544](#L544) | /\*\* |
| [545](#L545) | \* Save settings as a WordPress wp\_options entry |
| [546](#L546) | \* |
| [547](#L547) | \* @since 2.06 |
| [548](#L548) | \* |
| [549](#L549) | \* @return      string  HTML markup for results/messages |
| [550](#L550) | \*/ |
| [551](#L551) | private static function \_save\_setting\_changes() { |
| [552](#L552) | $new\_settings = self::$settings; |
| [553](#L553) |  |
| [554](#L554) | // Load old settings from the database or defaults |
| [555](#L555) | self::\_load\_product\_templates(); |
| [556](#L556) |  |
| [557](#L557) | $new\_settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::POPULATE\_PI\_PG\_ON\_UPLOAD ] ) ? true : false; |
| [558](#L558) | $new\_settings[self::POPULATE\_PI\_PG\_ON\_MMMW] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::POPULATE\_PI\_PG\_ON\_MMMW ] ) ? true : false; |
| [559](#L559) |  |
| [560](#L560) | $new\_settings[self::NAME\_TEMPLATE] = trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::NAME\_TEMPLATE ] ), 'post' ) ); |
| [561](#L561) | $new\_settings[self::DESCRIPTION\_TEMPLATE] = trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::DESCRIPTION\_TEMPLATE ] ), 'post' ) ); |
| [562](#L562) | $new\_settings[self::SHORT\_DESCRIPTION\_TEMPLATE] = trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::SHORT\_DESCRIPTION\_TEMPLATE ] ), 'post' ) ); |
| [563](#L563) | $new\_settings[self::CATEGORIES\_TEMPLATE] = trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::CATEGORIES\_TEMPLATE ] ), 'post' ) ); |
| [564](#L564) | $new\_settings[self::TAGS\_TEMPLATE] = trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::TAGS\_TEMPLATE ] ), 'post' ) ); |
| [565](#L565) | $new\_settings[self::SKU\_TEMPLATE] = trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::SKU\_TEMPLATE ] ), 'post' ) ); |
| [566](#L566) | $new\_settings[self::POPULATE\_ON\_ADD] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::POPULATE\_ON\_ADD ] ) ? true : false; |
| [567](#L567) | $new\_settings[self::POPULATE\_ON\_UPDATE] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::POPULATE\_ON\_UPDATE ] ) ? true : false; |
| [568](#L568) |  |
| [569](#L569) | if ( $new\_settings === self::$settings ) { |
| [570](#L570) | return "Settings unchanged.\n"; |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | $success = update\_option( self::SLUG\_PREFIX . 'settings', $new\_settings, false ); |
| [574](#L574) | if ( $success )  { |
| [575](#L575) | self::$settings = $new\_settings; |
| [576](#L576) | self::$populate\_pi\_pg\_on\_upload\_attr = self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] ? ' checked="checked" ' : ' '; |
| [577](#L577) | self::$populate\_pi\_pg\_on\_mmmw\_attr = self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] ? ' checked="checked" ' : ' '; |
| [578](#L578) | self::$populate\_on\_add\_attr = self::$settings[self::POPULATE\_ON\_ADD] ? ' checked="checked" ' : ' '; |
| [579](#L579) | self::$populate\_on\_update\_attr = self::$settings[self::POPULATE\_ON\_UPDATE] ? ' checked="checked" ' : ' '; |
| [580](#L580) | return "Settings have been updated.\n"; |
| [581](#L581) | } |
| [582](#L582) |  |
| [583](#L583) | return "Settings update failed.\n"; |
| [584](#L584) | } // \_save\_setting\_changes |
| [585](#L585) |  |
| [586](#L586) | /\*\* |
| [587](#L587) | \* Delete WordPress wp\_options entry |
| [588](#L588) | \* |
| [589](#L589) | \* @since 1.00 |
| [590](#L590) | \* |
| [591](#L591) | \* @return      string  HTML markup for results/messages |
| [592](#L592) | \*/ |
| [593](#L593) | private static function \_delete\_settings() { |
| [594](#L594) | delete\_option( self::SLUG\_PREFIX . 'settings' ); |
| [595](#L595) | self::$settings = self::$default\_settings; |
| [596](#L596) |  |
| [597](#L597) | return "Settings removed from database and reset to default values.\n"; |
| [598](#L598) | } // \_delete\_settings |
| [599](#L599) |  |
| [600](#L600) | /\*\* |
| [601](#L601) | \* Initialization function, similar to \_\_construct() |
| [602](#L602) | \* |
| [603](#L603) | \* @since 1.00 |
| [604](#L604) | \* |
| [605](#L605) | \* @return      void |
| [606](#L606) | \*/ |
| [607](#L607) | public static function initialize() { |
| [608](#L608) | // Defined in /media-library-assistant/includes/class-mla-data.php |
| [609](#L609) | add\_filter( 'mla\_expand\_custom\_prefix', 'Woo\_Fixit::mla\_expand\_custom\_prefix', 10, 8 ); |
| [610](#L610) |  |
| [611](#L611) | // The other filters are only useful in the admin section; exit if in front-end posts/pages |
| [612](#L612) | if ( !is\_admin() ) |
| [613](#L613) | return; |
| [614](#L614) |  |
| [615](#L615) | self::\_load\_product\_templates(); |
| [616](#L616) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::initialize settings = " . var\_export( self::$settings, true ), 0 ); |
| [617](#L617) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::initialize populate\_pi\_pg\_on\_upload\_attr = " . var\_export( self::$populate\_pi\_pg\_on\_upload\_attr, true ), 0 ); |
| [618](#L618) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::initialize populate\_pi\_pg\_on\_mmmw\_attr = " . var\_export( self::$populate\_pi\_pg\_on\_mmmw\_attr, true ), 0 ); |
| [619](#L619) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::initialize populate\_on\_add\_attr = " . var\_export( self::$populate\_on\_add\_attr, true ), 0 ); |
| [620](#L620) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::initialize populate\_on\_update\_attr = " . var\_export( self::$populate\_on\_update\_attr, true ), 0 ); |
| [621](#L621) |  |
| [622](#L622) | if ( self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] || self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] ) { |
| [623](#L623) | // Defined in class-mla-options.php |
| [624](#L624) | add\_action( 'add\_attachment', 'Woo\_Fixit::add\_attachment', 10, 1 ); |
| [625](#L625) | } |
| [626](#L626) |  |
| [627](#L627) | if ( self::$settings[self::POPULATE\_ON\_ADD] ) { |
| [628](#L628) | // Defined in /wp-includes/meta.php |
| [629](#L629) | add\_action( 'added\_post\_meta', 'Woo\_Fixit::added\_post\_meta', 10, 4 ); |
| [630](#L630) | } |
| [631](#L631) |  |
| [632](#L632) | if ( self::$settings[self::POPULATE\_ON\_UPDATE] ) { |
| [633](#L633) | // Defined in /wp-includes/meta.php |
| [634](#L634) | add\_action( 'updated\_postmeta', 'Woo\_Fixit::updated\_postmeta', 10, 4 ); |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | add\_action( 'admin\_menu', 'Woo\_Fixit::admin\_menu' ); |
| [638](#L638) | } |
| [639](#L639) |  |
| [640](#L640) | /\*\* |
| [641](#L641) | \* Evaluate product\_terms: values |
| [642](#L642) | \* |
| [643](#L643) | \* @since 2.00 |
| [644](#L644) | \* |
| [645](#L645) | \* @param mixed String or array - initial value |
| [646](#L646) | \* @param mixed Integer or array; the Post ID(s) of the product(s) |
| [647](#L647) | \* @param string Taxonomy slug |
| [648](#L648) | \* @param string Field name in term object |
| [649](#L649) | \* @param string Format/option; text,single,export,unpack,array |
| [650](#L650) | \* |
| [651](#L651) | \* @return mixed String or array; values or error messages |
| [652](#L652) | \*/ |
| [653](#L653) | private static function \_evaluate\_terms( $custom\_value, $products, $taxonomy, $qualifier, $option ) { |
| [654](#L654) | if ( empty( $products ) ) { |
| [655](#L655) | return $custom\_value; |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | if ( is\_scalar( $products ) ) { |
| [659](#L659) | $products = array( absint( $products ) => absint( $products ) ); |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | if ( empty( $qualifier ) ) { |
| [663](#L663) | $qualifier = 'name'; |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | $all\_terms = array(); |
| [667](#L667) | foreach ( $products as $product ) { |
| [668](#L668) | $terms = get\_object\_term\_cache( $product, $taxonomy ); |
| [669](#L669) | if ( false === $terms ) { |
| [670](#L670) | $terms = wp\_get\_object\_terms( $product, $taxonomy ); |
| [671](#L671) | if ( is\_wp\_error( $terms ) ) { |
| [672](#L672) | return implode( ',', $terms->get\_error\_messages() ); |
| [673](#L673) | } |
| [674](#L674) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_evaluate\_terms( {$product}, {$taxonomy}, {$qualifier}, {$option} ) terms = " . var\_export( $terms, true ), 0 ); |
| [675](#L675) |  |
| [676](#L676) | wp\_cache\_add( $product, $terms, $taxonomy . '\_relationships' ); |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | $all\_terms = array\_merge( $all\_terms, $terms ); |
| [680](#L680) | } |
| [681](#L681) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_evaluate\_terms( {$product}, {$taxonomy}, {$qualifier}, {$option} ) all\_terms = " . var\_export( $all\_terms, true ), 0 ); |
| [682](#L682) |  |
| [683](#L683) | if ( 'array' == $option ) { |
| [684](#L684) | $custom\_value = array(); |
| [685](#L685) | } else { |
| [686](#L686) | $custom\_value = ''; |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) | if ( ! empty( $all\_terms ) ) { |
| [690](#L690) | if ( 'single' == $option || 1 == count( $all\_terms ) ) { |
| [691](#L691) | reset( $all\_terms ); |
| [692](#L692) | $term = current( $all\_terms ); |
| [693](#L693) | $fields = get\_object\_vars( $term ); |
| [694](#L694) | $custom\_value = isset( $fields[ $qualifier ] ) ? $fields[ $qualifier ] : $fields['name']; |
| [695](#L695) | $custom\_value = sanitize\_term\_field( $qualifier, $custom\_value, $term->term\_id, $taxonomy, 'display' ); |
| [696](#L696) | } elseif ( ( 'export' == $option ) || ( 'unpack' == $option ) ) { |
| [697](#L697) | $custom\_value = sanitize\_text\_field( var\_export( $all\_terms, true ) ); |
| [698](#L698) | } else { |
| [699](#L699) | foreach ( $all\_terms as $term ) { |
| [700](#L700) | $fields = get\_object\_vars( $term ); |
| [701](#L701) | $field\_value = isset( $fields[ $qualifier ] ) ? $fields[ $qualifier ] : $fields['name']; |
| [702](#L702) | $field\_value = sanitize\_term\_field( $qualifier, $field\_value, $term->term\_id, $taxonomy, 'display' ); |
| [703](#L703) |  |
| [704](#L704) | if ( 'array' == $option ) { |
| [705](#L705) | $custom\_value[] = $field\_value; |
| [706](#L706) | } else { |
| [707](#L707) | $custom\_value .= strlen( $custom\_value ) ? ', ' . $field\_value : $field\_value; |
| [708](#L708) | } |
| [709](#L709) | } |
| [710](#L710) | } |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_evaluate\_terms( {$product}, {$taxonomy}, {$qualifier}, {$option} ) custom\_value = " . var\_export( $custom\_value, true ), 0 ); |
| [714](#L714) | return $custom\_value; |
| [715](#L715) | } // \_evaluate\_terms |
| [716](#L716) |  |
| [717](#L717) | /\*\* |
| [718](#L718) | \* Add the "product:" and "product\_terms:" custom substitution prefixes. |
| [719](#L719) | \* For any Media Library item that is used as a Product Image or Product Gallery item, |
| [720](#L720) | \* these will return values from the associated Product. |
| [721](#L721) | \* |
| [722](#L722) | \* @since 2.00 |
| [723](#L723) | \* |
| [724](#L724) | \* @param       string  NULL, indicating that by default, no custom value is available |
| [725](#L725) | \* @param       string  the data-source name |
| [726](#L726) | \* @param       array   data-source components; prefix (empty), value, option, format and args (if present) |
| [727](#L727) | \* @param       array   values from the query, if any, e.g. shortcode parameters |
| [728](#L728) | \* @param       array   item-level markup template values, if any |
| [729](#L729) | \* @param       integer attachment ID for attachment-specific values |
| [730](#L730) | \* @param       boolean for option 'multi', retain existing values |
| [731](#L731) | \* @param       string  default option value |
| [732](#L732) | \*/ |
| [733](#L733) | public static function mla\_expand\_custom\_prefix( $custom\_value, $key, $value, $query, $markup\_values, $post\_id, $keep\_existing, $default\_option ) { |
| [734](#L734) | static $product\_cache = array(); |
| [735](#L735) |  |
| [736](#L736) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_expand\_custom\_prefix( {$key}, {$post\_id}, {$keep\_existing}, {$default\_option} ) value = " . var\_export( $value, true ), 0 ); |
| [737](#L737) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_expand\_custom\_prefix( {$key}, {$post\_id} ) query = " . var\_export( $query, true ), 0 ); |
| [738](#L738) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_expand\_custom\_prefix( {$key}, {$post\_id} ) markup\_values = " . var\_export( $markup\_values, true ), 0 ); |
| [739](#L739) |  |
| [740](#L740) | // Look for field/value qualifier |
| [741](#L741) | $match\_count = preg\_match( '/^(.+)\((.+)\)/', $value['value'], $matches ); |
| [742](#L742) | if ( $match\_count ) { |
| [743](#L743) | $field = $matches[1]; |
| [744](#L744) | $qualifier = $matches[2]; |
| [745](#L745) | } else { |
| [746](#L746) | $field = $value['value']; |
| [747](#L747) | $qualifier = ''; |
| [748](#L748) | } |
| [749](#L749) |  |
| [750](#L750) | if ( 0 == absint( $post\_id ) ) { |
| [751](#L751) | return $custom\_value; |
| [752](#L752) | } |
| [753](#L753) |  |
| [754](#L754) | // Find all the attachments associated with products |
| [755](#L755) | if ( empty( self::$attachment\_products ) ) { |
| [756](#L756) | self::\_build\_product\_attachments( true ); |
| [757](#L757) | } |
| [758](#L758) |  |
| [759](#L759) | // What product(s) are associated with this item? |
| [760](#L760) | $products = array(); |
| [761](#L761) | if ( isset( self::$attachment\_products[ $post\_id ] ) ) { |
| [762](#L762) | if ( isset( self::$attachment\_products[ $post\_id ]['\_thumbnail\_id'] ) ) { |
| [763](#L763) | foreach ( self::$attachment\_products[ $post\_id ]['\_thumbnail\_id'] as $product ) { |
| [764](#L764) | $products[ $product ] = $product; |
| [765](#L765) | } |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | if ( !empty( self::$attachment\_products[ $post\_id ]['\_product\_image\_gallery'] ) ) { |
| [769](#L769) | foreach ( self::$attachment\_products[ $post\_id ]['\_product\_image\_gallery'] as $product ) { |
| [770](#L770) | $products[ $product ] = $product; |
| [771](#L771) | } |
| [772](#L772) | } |
| [773](#L773) | } else { |
| [774](#L774) | return $custom\_value; |
| [775](#L775) | } |
| [776](#L776) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_expand\_custom\_prefix( {$key}, {$post\_id} ) products = " . var\_export( $products, true ), 0 ); |
| [777](#L777) |  |
| [778](#L778) | if ( 'product\_terms' == $value['prefix'] ) { |
| [779](#L779) | $custom\_value = self::\_evaluate\_terms( $custom\_value, $products, $field, $qualifier, $value['option'] ); |
| [780](#L780) | } elseif ( 'product' == $value['prefix'] ) { |
| [781](#L781) | $custom\_value = array(); |
| [782](#L782) | foreach ( $products as $product\_id ) { |
| [783](#L783) | if ( isset( $product\_cache[ $product\_id ] ) ) { |
| [784](#L784) | $product = $product\_cache[ $product\_id ]; |
| [785](#L785) | } else { |
| [786](#L786) | $product = get\_post( $product\_id ); |
| [787](#L787) |  |
| [788](#L788) | if ( $product instanceof WP\_Post && $product->ID == $product\_id ) { |
| [789](#L789) | $product\_cache[ $product\_id ] = $product; |
| [790](#L790) | } else { |
| [791](#L791) | continue; |
| [792](#L792) | } |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | if ( property\_exists( $product, $value['value'] ) ) { |
| [796](#L796) | $custom\_value[] = $product->{$value['value']}; |
| [797](#L797) | } elseif ( 'permalink' == $value['value'] ) { |
| [798](#L798) | $custom\_value[] = get\_permalink( $product ); |
| [799](#L799) | } else { |
| [800](#L800) | // Look for a custom field match |
| [801](#L801) | $meta\_value = get\_metadata( 'post', $product\_id, $value['value'], false ); |
| [802](#L802) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_expand\_custom\_prefix( {$key}, {$post\_id}, {$product\_id} ) meta\_value = " . var\_export( $meta\_value, true ), 0 ); |
| [803](#L803) | if ( !empty( $meta\_value ) ) { |
| [804](#L804) | if ( is\_array( $meta\_value ) ) { |
| [805](#L805) | $custom\_value = array\_merge( $custom\_value, $meta\_value ); |
| [806](#L806) | } else { |
| [807](#L807) | $custom\_value[] = $meta\_value; |
| [808](#L808) | } |
| [809](#L809) | } |
| [810](#L810) | } |
| [811](#L811) | } |
| [812](#L812) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_expand\_custom\_prefix( {$key}, {$post\_id} ) custom\_value = " . var\_export( $custom\_value, true ), 0 ); |
| [813](#L813) |  |
| [814](#L814) | if ( is\_array( $custom\_value ) ) { |
| [815](#L815) | if ( 'single' == $value['option'] || 1 == count( $custom\_value ) ) { |
| [816](#L816) | $custom\_value = sanitize\_text\_field( reset( $custom\_value ) ); |
| [817](#L817) | } elseif ( ( 'export' == $value['option'] ) || ( 'unpack' == $value['option'] ) ) { |
| [818](#L818) | $custom\_value = sanitize\_text\_field( var\_export( $custom\_value, true ) ); |
| [819](#L819) | } else { |
| [820](#L820) | if ( 'array' == $value['option'] ) { |
| [821](#L821) | $new\_value = array(); |
| [822](#L822) | } else { |
| [823](#L823) | $new\_value = ''; |
| [824](#L824) | } |
| [825](#L825) |  |
| [826](#L826) | foreach ( $custom\_value as $element ) { |
| [827](#L827) | $field\_value = sanitize\_text\_field( $element ); |
| [828](#L828) |  |
| [829](#L829) | if ( 'array' == $value['option'] ) { |
| [830](#L830) | $new\_value[] = $field\_value; |
| [831](#L831) | } else { |
| [832](#L832) | $new\_value .= strlen( $new\_value ) ? ', ' . $field\_value : $field\_value; |
| [833](#L833) | } |
| [834](#L834) | } // foreach element |
| [835](#L835) |  |
| [836](#L836) | $custom\_value = $new\_value; |
| [837](#L837) | } |
| [838](#L838) | } |
| [839](#L839) | } // prefix = product: |
| [840](#L840) |  |
| [841](#L841) | return $custom\_value; |
| [842](#L842) | } // mla\_expand\_custom\_prefix |
| [843](#L843) |  |
| [844](#L844) | /\*\* |
| [845](#L845) | \* Attachment ID passed from add\_attachment\_action to mla\_list\_table\_end\_bulk\_action |
| [846](#L846) | \* |
| [847](#L847) | \* Ensures that product population is only performed when the attachment is first |
| [848](#L848) | \* added to the Media Library. |
| [849](#L849) | \* |
| [850](#L850) | \* @since 2.10 |
| [851](#L851) | \* |
| [852](#L852) | \* @var integer |
| [853](#L853) | \*/ |
| [854](#L854) | private static $add\_attachment\_id = 0; |
| [855](#L855) |  |
| [856](#L856) | /\*\* |
| [857](#L857) | \* After a new attachment is added, arm the filters to populate Priduct Image and Gallery. |
| [858](#L858) | \* |
| [859](#L859) | \* @since 2.10 |
| [860](#L860) | \* |
| [861](#L861) | \* @param int    $object\_id  Post ID. |
| [862](#L862) | \*/ |
| [863](#L863) | public static function add\_attachment( $object\_id ) { |
| [864](#L864) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::add\_attachment( $object\_id )", 0 ); |
| [865](#L865) | self::$add\_attachment\_id = $object\_id; |
| [866](#L866) |  |
| [867](#L867) | // If MLA's Bulk Edit on Upload isn't present, use the WP filters instead |
| [868](#L868) | if ( empty( $\_REQUEST['mlaAddNewBulkEditFormString'] ) ) { |
| [869](#L869) | if ( self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] ) { |
| [870](#L870) | add\_filter( 'wp\_generate\_attachment\_metadata', 'Woo\_Fixit::generate\_attachment\_metadata', 0x7FFFFFFF, 2 ); |
| [871](#L871) | } |
| [872](#L872) | } else { |
| [873](#L873) | if ( self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] ) { |
| [874](#L874) | add\_filter( 'mla\_list\_table\_end\_bulk\_action', 'Woo\_Fixit::mla\_list\_table\_end\_bulk\_action', 10, 2 ); |
| [875](#L875) | } |
| [876](#L876) | } |
| [877](#L877) | } |
| [878](#L878) |  |
| [879](#L879) | /\*\* |
| [880](#L880) | \* This filter tests the $add\_attachment\_id variable set by the add\_attachment\_action |
| [881](#L881) | \* to ensure that population is only performed once, after the generation of all intermediate sizes is complete. |
| [882](#L882) | \* |
| [883](#L883) | \* The filter is applied by function wp\_generate\_attachment\_metadata() in /wp-includes/image.php |
| [884](#L884) | \* This function is called only Bulk Edit on Upload is not in process. |
| [885](#L885) | \* |
| [886](#L886) | \* @since 2.96 |
| [887](#L887) | \* |
| [888](#L888) | \* @param       array   Attachment metadata for just-inserted attachment |
| [889](#L889) | \* @param       integer ID of just-inserted attachment |
| [890](#L890) | \* |
| [891](#L891) | \* @return      array   Updated attachment metadata |
| [892](#L892) | \*/ |
| [893](#L893) | public static function generate\_attachment\_metadata( $data, $post\_id ) { |
| [894](#L894) | $add\_attachment\_id = self::$add\_attachment\_id; |
| [895](#L895) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::generate\_attachment\_metadata( {$post\_id}, {$add\_attachment\_id} ) \$data = " . var\_export( $data, true ), 0 ); |
| [896](#L896) | if ( $add\_attachment\_id === $post\_id ) { |
| [897](#L897) | add\_filter( 'wp\_update\_attachment\_metadata', 'Woo\_Fixit::update\_attachment\_metadata', 0x7FFFFFFF, 2 ); |
| [898](#L898) | remove\_filter( 'wp\_generate\_attachment\_metadata', 'Woo\_Fixit::generate\_attachment\_metadata', 0x7FFFFFFF ); |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::generate\_attachment\_metadata( {$post\_id}, {$add\_attachment\_id} )", 0 ); |
| [902](#L902) | return $data; |
| [903](#L903) | } // generate\_attachment\_metadata |
| [904](#L904) |  |
| [905](#L905) | /\*\* |
| [906](#L906) | \* This filter tests the MLAEdit::$add\_attachment\_id variable set by the mla\_add\_attachment\_action |
| [907](#L907) | \* to ensure that mapping is only performed after the generation of all intermediate sizes is complete. |
| [908](#L908) | \* |
| [909](#L909) | \* The filter is applied by function wp\_generate\_attachment\_metadata() in /wp-includes/image.php |
| [910](#L910) | \* This function is called only if Custom Field AND IPTC/EXIF mapping on new attachments are disabled |
| [911](#L911) | \* |
| [912](#L912) | \* @since 2.96 |
| [913](#L913) | \* |
| [914](#L914) | \* @param       array   Attachment metadata for just-inserted attachment |
| [915](#L915) | \* @param       integer ID of just-inserted attachment |
| [916](#L916) | \* |
| [917](#L917) | \* @return      array   Updated attachment metadata |
| [918](#L918) | \*/ |
| [919](#L919) | public static function update\_attachment\_metadata( $data, $post\_id ) { |
| [920](#L920) | $add\_attachment\_id = self::$add\_attachment\_id; |
| [921](#L921) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::update\_attachment\_metadata( {$post\_id}, {$add\_attachment\_id} ) \$data = " . var\_export( $data, true ), 0 ); |
| [922](#L922) | if ( $add\_attachment\_id === $post\_id ) { |
| [923](#L923) | // Only do this once per attachment |
| [924](#L924) | self::mla\_list\_table\_end\_bulk\_action( NULL, 'edit' ); |
| [925](#L925) |  |
| [926](#L926) | self::$add\_attachment\_id = 0; |
| [927](#L927) | remove\_filter( 'wp\_update\_attachment\_metadata', 'Woo\_Fixit::update\_attachment\_metadata', 0x7FFFFFFF ); |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::update\_attachment\_metadata( {$post\_id}, {$add\_attachment\_id} )", 0 ); |
| [931](#L931) | return $data; |
| [932](#L932) | } // mla\_generate\_attachment\_metadata\_filter |
| [933](#L933) |  |
| [934](#L934) | /\*\* |
| [935](#L935) | \* After a new attachment is added, populate the Product Image and Product Gallery. |
| [936](#L936) | \* |
| [937](#L937) | \* @since 2.10 |
| [938](#L938) | \* |
| [939](#L939) | \* @param string    $content      Default message and page content. |
| [940](#L940) | \* @param string    $bulk\_action  Should be "edit". |
| [941](#L941) | \*/ |
| [942](#L942) | public static function mla\_list\_table\_end\_bulk\_action( $content, $bulk\_action ) { |
| [943](#L943) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_list\_table\_end\_bulk\_action( $bulk\_action )", 0 ); |
| [944](#L944) |  |
| [945](#L945) | if (  0 < self::$add\_attachment\_id ) { |
| [946](#L946) | $attachment = get\_post( self::$add\_attachment\_id ); |
| [947](#L947) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_list\_table\_end\_bulk\_action( $bulk\_action ) attachment = " . var\_export( $attachment, true ), 0 ); |
| [948](#L948) | if ( isset( $attachment->post\_parent ) && ( 0 < $attachment->post\_parent ) ) { |
| [949](#L949) | if ( 0 === strpos( $attachment->post\_mime\_type, 'image' ) ) { |
| [950](#L950) | $parent = get\_post( $attachment->post\_parent );                         } |
| [951](#L951) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_list\_table\_end\_bulk\_action( $bulk\_action ) parent = " . var\_export( $parent, true ), 0 ); |
| [952](#L952) | if ( isset( $parent->post\_type ) && ( 'product' === $parent->post\_type ) ) { |
| [953](#L953) | $product\_id = $parent->ID; |
| [954](#L954) | $thumbnail = get\_post\_meta( $product\_id, '\_thumbnail\_id', true ); |
| [955](#L955) | $gallery = get\_post\_meta( $product\_id, '\_product\_image\_gallery', true ); |
| [956](#L956) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_list\_table\_end\_bulk\_action( $bulk\_action ) thumbnail = " . var\_export( $thumbnail, true ), 0 ); |
| [957](#L957) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_list\_table\_end\_bulk\_action( $bulk\_action ) gallery = " . var\_export( $gallery, true ), 0 ); |
| [958](#L958) |  |
| [959](#L959) | // First new item becomes the thumbnail, if needed |
| [960](#L960) | if ( empty( $thumbnail ) ) { |
| [961](#L961) | $result = update\_post\_meta( $product\_id, '\_thumbnail\_id', self::$add\_attachment\_id ); |
| [962](#L962) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_list\_table\_end\_bulk\_action( $bulk\_action ) \_thumbnail\_id result = " . var\_export( $result, true ), 0 ); |
| [963](#L963) | $thumbnail = self::$add\_attachment\_id; |
| [964](#L964) | } |
| [965](#L965) |  |
| [966](#L966) | // Add the new item at the end of the gallery |
| [967](#L967) | if ( ( self::$add\_attachment\_id !== $thumbnail ) || self::$add\_image\_to\_gallery ) { |
| [968](#L968) | $gallery .= empty( $gallery ) ? self::$add\_attachment\_id : ',' . self::$add\_attachment\_id; |
| [969](#L969) | $result = update\_post\_meta( $product\_id, '\_product\_image\_gallery', $gallery ); |
| [970](#L970) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::mla\_list\_table\_end\_bulk\_action( $bulk\_action ) \_product\_image\_gallery result = " . var\_export( $result, true ), 0 ); |
| [971](#L971) | } |
| [972](#L972) |  |
| [973](#L973) | } // parent is product |
| [974](#L974) | } // attachment is image |
| [975](#L975) | } // adding an attachment |
| [976](#L976) |  |
| [977](#L977) | remove\_filter( 'mla\_list\_table\_end\_bulk\_action', 'Woo\_Fixit::mla\_list\_table\_end\_bulk\_action', 10 ); |
| [978](#L978) | return $content; |
| [979](#L979) | } |
| [980](#L980) |  |
| [981](#L981) | /\*\* |
| [982](#L982) | \* After adding a post's metadata, check for Product Image add. |
| [983](#L983) | \* |
| [984](#L984) | \* @since 2.06 |
| [985](#L985) | \* |
| [986](#L986) | \* @param int    $meta\_id    ID of updated metadata entry. |
| [987](#L987) | \* @param int    $object\_id  Post ID. |
| [988](#L988) | \* @param string $meta\_key   Meta key. |
| [989](#L989) | \* @param mixed  $meta\_value Meta value. This will be a PHP-serialized string representation of the value if |
| [990](#L990) | \*                           the value is an array, an object, or itself a PHP-serialized string. |
| [991](#L991) | \* @return      void |
| [992](#L992) | \*/ |
| [993](#L993) | public static function added\_post\_meta( $meta\_id, $object\_id, $meta\_key, $meta\_value ) { |
| [994](#L994) | global $post; |
| [995](#L995) |  |
| [996](#L996) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::added\_post\_meta( $meta\_id, $object\_id, $meta\_key ) meta\_value = " . var\_export( $meta\_value, true ), 0 ); |
| [997](#L997) | if ( '\_thumbnail\_id' === $meta\_key ) { |
| [998](#L998) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::added\_post\_meta( $meta\_id, $object\_id, $meta\_key ) post = " . var\_export( $post, true ), 0 ); |
| [999](#L999) | if ( !empty( $post->post\_type ) && ( 'product' === $post->post\_type ) ) { |
| [1000](#L1000) | self::$first\_product = self::$last\_product = $object\_id; |
| [1001](#L1001) | $result = self::\_populate\_product\_from\_product\_image(); |
| [1002](#L1002) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::added\_post\_meta( $meta\_id, $object\_id, $meta\_key ) result = " . var\_export( $result, true ), 0 ); |
| [1003](#L1003) | } |
| [1004](#L1004) | } |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | /\*\* |
| [1008](#L1008) | \* After updating a post's metadata, check for Product Image add/update. |
| [1009](#L1009) | \* |
| [1010](#L1010) | \* @since 2.06 |
| [1011](#L1011) | \* |
| [1012](#L1012) | \* @param int    $meta\_id    ID of updated metadata entry. |
| [1013](#L1013) | \* @param int    $object\_id  Post ID. |
| [1014](#L1014) | \* @param string $meta\_key   Meta key. |
| [1015](#L1015) | \* @param mixed  $meta\_value Meta value. This will be a PHP-serialized string representation of the value if |
| [1016](#L1016) | \*                           the value is an array, an object, or itself a PHP-serialized string. |
| [1017](#L1017) | \* @return      void |
| [1018](#L1018) | \*/ |
| [1019](#L1019) | public static function updated\_postmeta( $meta\_id, $object\_id, $meta\_key, $meta\_value ) { |
| [1020](#L1020) | global $post; |
| [1021](#L1021) |  |
| [1022](#L1022) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::updated\_postmeta( $meta\_id, $object\_id, $meta\_key ) meta\_value = " . var\_export( $meta\_value, true ), 0 ); |
| [1023](#L1023) | if ( '\_thumbnail\_id' === $meta\_key ) { |
| [1024](#L1024) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::updated\_postmeta( $meta\_id, $object\_id, $meta\_key ) post = " . var\_export( $post, true ), 0 ); |
| [1025](#L1025) | if ( !empty( $post->post\_type ) && ( 'product' === $post->post\_type ) ) { |
| [1026](#L1026) | self::$first\_product = self::$last\_product = $object\_id; |
| [1027](#L1027) | $result = self::\_populate\_product\_from\_product\_image(); |
| [1028](#L1028) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::updated\_postmeta( $meta\_id, $object\_id, $meta\_key ) result = " . var\_export( $result, true ), 0 ); |
| [1029](#L1029) | } |
| [1030](#L1030) | } |
| [1031](#L1031) | } |
| [1032](#L1032) |  |
| [1033](#L1033) | /\*\* |
| [1034](#L1034) | \* Add submenu page in the "Tools" section |
| [1035](#L1035) | \* |
| [1036](#L1036) | \* @since 1.00 |
| [1037](#L1037) | \* |
| [1038](#L1038) | \* @return      void |
| [1039](#L1039) | \*/ |
| [1040](#L1040) | public static function admin\_menu( ) { |
| [1041](#L1041) | $current\_page\_hook = add\_submenu\_page( 'tools.php', 'WooCommerce Fixit Tools', 'Woo Fixit', 'manage\_options', self::SLUG\_PREFIX . 'tools', 'Woo\_Fixit::render\_tools\_page' ); |
| [1042](#L1042) | add\_filter( 'plugin\_action\_links', 'Woo\_Fixit::add\_plugin\_links\_filter', 10, 2 ); |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) | /\*\* |
| [1046](#L1046) | \* Add the "Tools" link to the Plugins section entry |
| [1047](#L1047) | \* |
| [1048](#L1048) | \* @since 1.00 |
| [1049](#L1049) | \* |
| [1050](#L1050) | \* @param       array   array of links for the Plugin, e.g., "Activate" |
| [1051](#L1051) | \* @param       string  Directory and name of the plugin Index file |
| [1052](#L1052) | \* |
| [1053](#L1053) | \* @return      array   Updated array of links for the Plugin |
| [1054](#L1054) | \*/ |
| [1055](#L1055) | public static function add\_plugin\_links\_filter( $links, $file ) { |
| [1056](#L1056) | if ( 0 === strpos( $file, 'woofixit' ) ) { |
| [1057](#L1057) | $tools\_link = sprintf( '<a href="%s">%s</a>', admin\_url( 'tools.php?page=' . self::SLUG\_PREFIX . 'tools' ), 'Tools' ); |
| [1058](#L1058) | array\_unshift( $links, $tools\_link ); |
| [1059](#L1059) | } |
| [1060](#L1060) |  |
| [1061](#L1061) | return $links; |
| [1062](#L1062) | } |
| [1063](#L1063) |  |
| [1064](#L1064) | /\*\* |
| [1065](#L1065) | \* Compose the Settings Actions table, with the woofixit-acton handlers |
| [1066](#L1066) | \* |
| [1067](#L1067) | \* @since 2.06 |
| [1068](#L1068) | \* |
| [1069](#L1069) | \* @return      array Actions, handlers, comments, input tables, etc. |
| [1070](#L1070) | \*/ |
| [1071](#L1071) | private static function \_compose\_settings\_actions() { |
| [1072](#L1072) | return array( |
| [1073](#L1073) | 'help' => array( 'handler' => '', 'comment' => 'Enter first/last Product ID values above to restrict tool application range. You can find ID values by hovering over the "Name" column in the WooCommerce/Products submenu table.' ), |
| [1074](#L1074) | 'warning' => array( 'handler' => '', 'comment' => '<strong>These tools make permanent updates to your database.</strong> Make a backup before you use the tools so you can restore your old values if you don&rsquo;t like the results.' ), |
| [1075](#L1075) |  |
| [1076](#L1076) | 'c0' => array( 'handler' => '', 'comment' => '<h3>Operations on ALL Media Library Images</h3>' ), |
| [1077](#L1077) | 'warning2' => array( 'handler' => '', 'comment' => '<strong>The tools in this section are not restricted</strong> by the First &amp; Last Product IDs above. They operate on <strong>ALL</strong> of the items in your Media Library.' ), |
| [1078](#L1078) | 'Clear Title' => array( 'handler' => '\_clear\_title', |
| [1079](#L1079) | 'comment' => '<strong>Delete ALL</strong> item Title fields.' ), |
| [1080](#L1080) | 'c1' => array( 'handler' => '', 'comment' => '<hr>' ), |
| [1081](#L1081) | 'Fill Title' => array( 'handler' => '\_fill\_title', |
| [1082](#L1082) | 'comment' => 'Fill empty item Title field with re-formatted file name.' ), |
| [1083](#L1083) | 'Replace Title' => array( 'handler' => '\_replace\_title', |
| [1084](#L1084) | 'comment' => '<strong>Replace ALL</strong> item Title fields with re-formatted file name.' ), |
| [1085](#L1085) | 'c1a' => array( 'handler' => '', 'comment' => '<hr>' ), |
| [1086](#L1086) | 't0301' => array( 'open' => '<table><tr>' ), |
| [1087](#L1087) | 't0302' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::APPEND\_ITEM\_ID . '" type="checkbox"' . self::$append\_item\_id\_attr . 'value="' . self::APPEND\_ITEM\_ID . '"></td>' ), |
| [1088](#L1088) | 't0303' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">Append Item ID</td>' ), |
| [1089](#L1089) | 't0304' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::CHECK\_UNIQUE\_SLUG . '" type="checkbox"' . self::$check\_unique\_slug\_attr . 'value="' . self::CHECK\_UNIQUE\_SLUG . '"></td>' ), |
| [1090](#L1090) | 't0305' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">Ensure Unique Slug</td>' ), |
| [1091](#L1091) | 't0306' => array( 'continue' => '  <td colspan=2 style="text-align: right; padding-right: 5px" valign="middle">&nbsp;</td>' ), |
| [1092](#L1092) | 't0307' => array( 'continue' => '</tr><tr>' ), |
| [1093](#L1093) | 't0308' => array( 'continue' => '<td>&nbsp;</td><td colspan="5">Check Append Item ID to add the ID to the slug value for uniqueness.<br>Check Ensure Unique Slug to activate WordPress slug validation (may be slow).</td>' ), |
| [1094](#L1094) | 't0309' => array( 'close' => '</tr></table>&nbsp;<br>' ), |
| [1095](#L1095) | 'Replace Name/Slug' => array( 'handler' => '\_replace\_slug', |
| [1096](#L1096) | 'comment' => '<strong>Replace ALL</strong> item Name/Slug fields with file name.' ), |
| [1097](#L1097) |  |
| [1098](#L1098) | 'c2' => array( 'handler' => '', 'comment' => '<h3>Operations on Product Image/Product Gallery Images</h3>' ), |
| [1099](#L1099) | 'Clear ALT Text' => array( 'handler' => '\_clear\_alt\_text', |
| [1100](#L1100) | 'comment' => '<strong>Delete ALL</strong> ALT Text fields for Product Image/Product Gallery items.' ), |
| [1101](#L1101) | 'Clear Title' => array( 'handler' => '\_clear\_title', |
| [1102](#L1102) | 'comment' => '<strong>Delete ALL</strong> Title fields for Product Image/Product Gallery items.' ), |
| [1103](#L1103) | 'c3' => array( 'handler' => '', 'comment' => '<hr>' ), |
| [1104](#L1104) | 'Fill ALT Text (PC)' => array( 'handler' => '\_fill\_alt\_text', |
| [1105](#L1105) | 'comment' => 'Fill empty ALT Text field with first top-level <strong>Product Category</strong>.' ), |
| [1106](#L1106) | 'Replace ALT Text (PC)' => array( 'handler' => '\_replace\_alt\_text', |
| [1107](#L1107) | 'comment' => '<strong>Replace ALL</strong> ALT Text field with first top-level <strong>Product Category</strong>.' ), |
| [1108](#L1108) | 'c4' => array( 'handler' => '', 'comment' => '<hr>' ), |
| [1109](#L1109) | 'Fill ALT Text (T)' => array( 'handler' => '\_fill\_alt\_text\_t', |
| [1110](#L1110) | 'comment' => 'Fill empty ALT Text field with <strong>Product Title</strong>.' ), |
| [1111](#L1111) | 'Replace ALT Text (T)' => array( 'handler' => '\_replace\_alt\_text\_t', |
| [1112](#L1112) | 'comment' => '<strong>Replace ALL</strong> ALT Text field with <strong>Product Title</strong>.' ), |
| [1113](#L1113) | 'c4a' => array( 'handler' => '', 'comment' => '<hr>' ), |
| [1114](#L1114) | 'Fill Title (T)' => array( 'handler' => '\_fill\_title\_t', |
| [1115](#L1115) | 'comment' => 'Fill empty item Title field with <strong>Product Title</strong>.' ), |
| [1116](#L1116) | 'Replace Title (T)' => array( 'handler' => '\_replace\_title\_t', |
| [1117](#L1117) | 'comment' => '<strong>Replace ALL</strong> item Title field with <strong>Product Title</strong>.' ), |
| [1118](#L1118) |  |
| [1119](#L1119) | 'c4b' => array( 'handler' => '', 'comment' => '<h3>Apply Template to Product Image/Product Gallery Images</h3>' ), |
| [1120](#L1120) | 't0101' => array( 'open' => '<table><tr>' ), |
| [1121](#L1121) | 't0110' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Template</td>' ), |
| [1122](#L1122) | 't0111' => array( 'continue' => '  <td style="text-align: left; padding-right: 20px">' ), |
| [1123](#L1123) | 't0112' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::INPUT\_CONTENT\_TEMPLATE . '" type="text" size="40" value="' . self::$content\_template . '">' ), |
| [1124](#L1124) | 't0113' => array( 'continue' => '  </td>' ), |
| [1125](#L1125) | 't0122' => array( 'continue' => '</tr><tr>' ), |
| [1126](#L1126) | 't0123' => array( 'continue' => '<td>&nbsp;</td><td colspan="1">Enter a Content Template (without the "template:" prefix).</td>' ), |
| [1127](#L1127) | 't0124' => array( 'close' => '</tr></table>&nbsp;<br>' ), |
| [1128](#L1128) | 'Fill ALT Text (CT)' => array( 'handler' => '\_fill\_alt\_text\_ct', |
| [1129](#L1129) | 'comment' => 'Apply non-empty Content Template values to empty ALT Text fields.' ), |
| [1130](#L1130) | 'Replace ALT Text (CT)' => array( 'handler' => '\_replace\_alt\_text\_ct', |
| [1131](#L1131) | 'comment' => 'Apply non-empty Content Template values to <strong>ALL</strong> ALT Text fields.' ), |
| [1132](#L1132) |  |
| [1133](#L1133) | 'c5' => array( 'handler' => '', 'comment' => '<h3>Operations on the Product Image and Product Gallery</h3>' ), |
| [1134](#L1134) | 'Remove Feature' => array( 'handler' => '\_remove\_feature', |
| [1135](#L1135) | 'comment' => 'Remove Product/Featured Image from the Product Gallery.' ), |
| [1136](#L1136) | 'Restore Feature' => array( 'handler' => '\_restore\_feature', |
| [1137](#L1137) | 'comment' => 'Restore Product/Featured Image to the Product Gallery.' ), |
| [1138](#L1138) | 'Reverse Gallery' => array( 'handler' => '\_reverse\_gallery', |
| [1139](#L1139) | 'comment' => 'Reverse the image order in the Product Gallery.' ), |
| [1140](#L1140) | 'c5a' => array( 'handler' => '', 'comment' => '<hr>' ), |
| [1141](#L1141) | 'c5b' => array( 'handler' => '', 'comment' => 'Options for the &ldquo;... from Children&rdquo; tools:' ), |
| [1142](#L1142) | 't0401' => array( 'open' => '<table><tr>' ), |
| [1143](#L1143) | 't0402' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::ADD\_IMAGE\_TO\_GALLERY . '" type="checkbox"' . self::$add\_image\_to\_gallery\_attr . 'value="' . self::ADD\_IMAGE\_TO\_GALLERY . '"></td>' ), |
| [1144](#L1144) | 't0403' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">Add Product Image to Gallery</td>' ), |
| [1145](#L1145) | 't0404' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::DELETE\_NO\_CHILDREN . '" type="checkbox"' . self::$delete\_no\_children\_attr . 'value="' . self::DELETE\_NO\_CHILDREN . '"></td>' ), |
| [1146](#L1146) | 't0405' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">Delete P.I. and P.G. if no children</td>' ), |
| [1147](#L1147) | 't0406' => array( 'continue' => '  <td colspan=2 style="text-align: right; padding-right: 5px" valign="middle">&nbsp;</td>' ), |
| [1148](#L1148) | 't0407' => array( 'continue' => '</tr><tr>' ), |
| [1149](#L1149) | 't0408' => array( 'continue' => '<td>&nbsp;</td><td colspan="5">Check Add Product Image to Gallery to add the Product Image to the Product Gallery.<br>For the Replace tool, check Delete P.I. and P.G. ... to delete the Product Image and Product Gallery<br>if there are no attached children.</td>' ), |
| [1150](#L1150) | 't0409' => array( 'close' => '</tr></table>&nbsp;<br>' ), |
| [1151](#L1151) | 'Fill from Children' => array( 'handler' => '\_fill\_from\_children', |
| [1152](#L1152) | 'comment' => 'Add product\'s children to the Product/Featured Image and Product Gallery.' ), |
| [1153](#L1153) | 'Replace from Children' => array( 'handler' => '\_replace\_from\_children', |
| [1154](#L1154) | 'comment' => 'Replace Product/Featured Image and Product Gallery from product\'s children.' ), |
| [1155](#L1155) | 'c5c' => array( 'handler' => '', 'comment' => '<hr>' ), |
| [1156](#L1156) | 't0501' => array( 'open' => '<table><tr>' ), |
| [1157](#L1157) | 't0502' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::POPULATE\_PI\_PG\_ON\_UPLOAD . '" type="checkbox"' . self::$populate\_pi\_pg\_on\_upload\_attr . 'value="' . self::POPULATE\_PI\_PG\_ON\_UPLOAD . '"></td>' ), |
| [1158](#L1158) | 't0503' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">Populate P.I. and P.G. with children<br>from MLA&rsquo;s Bulk Edit on Upload</td>' ), |
| [1159](#L1159) | 't0504' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::POPULATE\_PI\_PG\_ON\_MMMW . '" type="checkbox"' . self::$populate\_pi\_pg\_on\_mmmw\_attr . 'value="' . self::POPULATE\_PI\_PG\_ON\_MMMW . '"></td>' ), |
| [1160](#L1160) | 't0505' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">Populate P.I. and P.G. with children<br>from WordPress MMMW Add Files</td>' ), |
| [1161](#L1161) | 't0506' => array( 'continue' => '  <td colspan=2 style="text-align: right; padding-right: 5px" valign="middle">&nbsp;</td>' ), |
| [1162](#L1162) | 't0507' => array( 'continue' => '</tr><tr>' ), |
| [1163](#L1163) | 't0508' => array( 'continue' => '<td colspan="5">Check this options to populate the Product Image and Product Gallery when images are attached to a Product during the Media/Add New Bulk Edit on Upload processing and/or the WordPress "Add Files" popup window tab.</td>' ), |
| [1164](#L1164) | 't0509' => array( 'close' => '</tr></table>&nbsp;<br>' ), |
| [1165](#L1165) | 'Save Changes' => array( 'handler' => '\_save\_upload\_children\_option', 'comment' => 'Click here to record the new Populate P.I. and P.G. with children option settings.' ), |
| [1166](#L1166) | 'c5d' => array( 'handler' => '', 'comment' => '<hr>' ), |
| [1167](#L1167) | 'Where-used' => array( 'handler' => '\_where\_used', |
| [1168](#L1168) | 'comment' => 'Replace &quot;where\_used&quot; information in custom field &quot;Woo Used In&quot;.' ), |
| [1169](#L1169) | 'c6' => array( 'handler' => '', 'comment' => '<h3>Operations on Products, using the Product Image, Product Tags and Att. Tags</h3>' ), |
| [1170](#L1170) | 'Clear Product Tags' => array( 'handler' => '\_clear\_product\_tags', |
| [1171](#L1171) | 'comment' => '<strong>Delete ALL</strong> Product Tags assignments where a Product Image exists.' ), |
| [1172](#L1172) | 'Fill Product Tags' => array( 'handler' => '\_fill\_product\_tags', |
| [1173](#L1173) | 'comment' => 'Fill empty Product Tags assignments from Product Image Att. Tags where a Product Image exists.' ), |
| [1174](#L1174) | 'Add Product Tags' => array( 'handler' => '\_append\_product\_tags', |
| [1175](#L1175) | 'comment' => 'Append Product Tags assignments to <strong>ALL Products</strong> from Product Image Att. Tags where a Product Image exists.' ), |
| [1176](#L1176) | 'Replace Product Tags' => array( 'handler' => '\_replace\_product\_tags', |
| [1177](#L1177) | 'comment' => '<strong>Replace ALL</strong> Product Tags assignments from Product Image Att. Tags where a Product Image exists.' ), |
| [1178](#L1178) |  |
| [1179](#L1179) | 'c7' => array( 'handler' => '', 'comment' => '<h3>Operations on Products, using the Product Image, Product Categories and Att. Tags</h3>' ), |
| [1180](#L1180) | 'Clear Product Cats' => array( 'handler' => '\_clear\_product\_categories', |
| [1181](#L1181) | 'comment' => '<strong>Delete ALL Products&rsquo;</strong> Product Categories assignments where a Product Image exists.' ), |
| [1182](#L1182) | 'Fill Product Cats' => array( 'handler' => '\_fill\_product\_categories', |
| [1183](#L1183) | 'comment' => 'Fill empty Product Categories assignments from Product Image Att. Tags,<br>where the Product Image Att. Tag matches an existing Product Category.' ), |
| [1184](#L1184) | 'Add Product Cats' => array( 'handler' => '\_append\_product\_categories', |
| [1185](#L1185) | 'comment' => 'Append Product Categories assignments to <strong>ALL Products</strong> from Product Image Att. Tags,<br>where the Product Image Att. Tag matches an existing Product Category.' ), |
| [1186](#L1186) | 'Replace Product Cats' => array( 'handler' => '\_replace\_product\_categories', |
| [1187](#L1187) | 'comment' => '<strong>Replace ALL</strong> Product Categories assignments from Product Image Att. Tags,<br>where the Product Image Att. Tag matches an existing Product Category.' ), |
| [1188](#L1188) |  |
| [1189](#L1189) | 'c8' => array( 'handler' => '', 'comment' => '<h3>Operations on the Att. Categories Taxonomy</h3>' ), |
| [1190](#L1190) | 'Clear Att. Cats' => array( 'handler' => '\_clear\_attachment\_categories', |
| [1191](#L1191) | 'comment' => '<strong>Delete ALL</strong> Att. Categories assignments.' ), |
| [1192](#L1192) | 'Fill Att. Cats' => array( 'handler' => '\_fill\_attachment\_categories', |
| [1193](#L1193) | 'comment' => 'Fill empty Att. Categories assignments from Att. Tags, where the Att. Tag matches an existing Att. Category.' ), |
| [1194](#L1194) | 'Add Att. Cats' => array( 'handler' => '\_append\_attachment\_categories', |
| [1195](#L1195) | 'comment' => 'Append Att. Categories assignments to <strong>ALL items</strong> from Att. Tags,<br>where the Att. Tag matches an existing Att. Category.' ), |
| [1196](#L1196) | 'Replace Att. Cats' => array( 'handler' => '\_replace\_attachment\_categories', |
| [1197](#L1197) | 'comment' => '<strong>Replace ALL</strong> Att. Categories assignments from Att. Tags, where the Att. Tag matches an existing Att. Category.' ), |
| [1198](#L1198) | 'c9' => array( 'handler' => '', 'comment' => '<h3>Term Assignments for Media Library Items</h3>' ), |
| [1199](#L1199) | 't0201' => array( 'open' => '<table><tr>' ), |
| [1200](#L1200) | 't0202' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::INPUT\_PROCESS\_CATEGORY . '" type="checkbox"' . self::$category\_attr . 'value="' . self::INPUT\_PROCESS\_CATEGORY . '"></td>' ), |
| [1201](#L1201) | 't0203' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">product\_category</td>' ), |
| [1202](#L1202) | 't0204' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::INPUT\_PROCESS\_TAG . '" type="checkbox"' . self::$tag\_attr . 'value="' . self::INPUT\_PROCESS\_TAG . '"></td>' ), |
| [1203](#L1203) | 't0205' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">product\_tag</td>' ), |
| [1204](#L1204) | 't0206' => array( 'continue' => '  <td colspan=2 style="text-align: right; padding-right: 5px" valign="middle">&nbsp;</td>' ), |
| [1205](#L1205) | 't0207' => array( 'continue' => '</tr><tr>' ), |
| [1206](#L1206) | 't0208' => array( 'continue' => '<td>&nbsp;</td><td colspan="5">Check a box above to include the taxonomy in the processing.</td>' ), |
| [1207](#L1207) | 't0209' => array( 'continue' => '</tr><tr style="display: none">' ), |
| [1208](#L1208) | 't0210' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Start Chunk</td>' ), |
| [1209](#L1209) | 't0211' => array( 'continue' => '  <td style="text-align: left; padding-right: 20px">' ), |
| [1210](#L1210) | 't0212' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::INPUT\_FIRST\_CHUNK . '" type="text" size="5" value="' . self::$start\_chunk . '">' ), |
| [1211](#L1211) | 't0213' => array( 'continue' => '  </td>' ), |
| [1212](#L1212) | 't0214' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Stop Chunk</td>' ), |
| [1213](#L1213) | 't0215' => array( 'continue' => '  <td style="text-align: left;">' ), |
| [1214](#L1214) | 't0216' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::INPUT\_LAST\_CHUNK . '" type="text" size="5" value="' . self::$stop\_chunk . '">' ), |
| [1215](#L1215) | 't0217' => array( 'continue' => '  </td>' ), |
| [1216](#L1216) | 't0218' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Chunk Size</td>' ), |
| [1217](#L1217) | 't0219' => array( 'continue' => '  <td style="text-align: left;">' ), |
| [1218](#L1218) | 't0220' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::INPUT\_CHUNK\_SIZE . '" type="text" size="5" value="' . self::$chunk\_size . '">' ), |
| [1219](#L1219) | 't0221' => array( 'continue' => '  </td>' ), |
| [1220](#L1220) | 't0222' => array( 'continue' => '</tr><tr style="display: none">' ), |
| [1221](#L1221) | 't0223' => array( 'continue' => '<td>&nbsp;</td><td colspan="5">Enter start and stop chunks to restrict processing range;<br>chunk size is number of proucts/chunk.</td>' ), |
| [1222](#L1222) | 't0224' => array( 'close' => '</tr></table>&nbsp;<br>' ), |
| [1223](#L1223) | 'Clear Terms' => array( 'handler' => '\_clear\_term\_assignments', |
| [1224](#L1224) | 'comment' => '<strong>Delete ALL</strong> product\_category and/or product\_tag term assignments to Media Library items.' ), |
| [1225](#L1225) | 'Assign Terms' => array( 'handler' => '\_copy\_term\_assignments', |
| [1226](#L1226) | 'comment' => 'Copy product\_category and/or product\_tag term assignments to Media Library items for items used as Product Image or in the Product Gallery.' ), |
| [1227](#L1227) |  |
| [1228](#L1228) | 'c10' => array( 'handler' => '', 'comment' => '<h3>Populate Product from Product Image</h3>' ), |
| [1229](#L1229) | 't1001' => array( 'open' => '<table><tr>' ), |
| [1230](#L1230) | 't1002' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Name</td>' ), |
| [1231](#L1231) | 't1003' => array( 'continue' => '  <td colspan="4" style="text-align: left; padding-right: 20px">' ), |
| [1232](#L1232) | 't1004' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::NAME\_TEMPLATE . '" type="text" size="60" value="' . self::$settings[self::NAME\_TEMPLATE] . '">' ), |
| [1233](#L1233) | 't1005' => array( 'continue' => '  </td>' ), |
| [1234](#L1234) | 't1006' => array( 'continue' => '</tr><tr>' ), |
| [1235](#L1235) | 't1007' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Description</td>' ), |
| [1236](#L1236) | 't1008' => array( 'continue' => '  <td colspan="4" style="text-align: left; padding-right: 20px">' ), |
| [1237](#L1237) | 't1009' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::DESCRIPTION\_TEMPLATE . '" type="text" size="60" value="' . self::$settings[self::DESCRIPTION\_TEMPLATE] . '">' ), |
| [1238](#L1238) | 't1010' => array( 'continue' => '  </td>' ), |
| [1239](#L1239) | 't1011' => array( 'continue' => '</tr><tr>' ), |
| [1240](#L1240) | 't1012' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Short Description</td>' ), |
| [1241](#L1241) | 't1013' => array( 'continue' => '  <td colspan="4" style="text-align: left; padding-right: 20px">' ), |
| [1242](#L1242) | 't1014' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::SHORT\_DESCRIPTION\_TEMPLATE . '" type="text" size="60" value="' . self::$settings[self::SHORT\_DESCRIPTION\_TEMPLATE] . '">' ), |
| [1243](#L1243) | 't1015' => array( 'continue' => '  </td>' ), |
| [1244](#L1244) | 't1016' => array( 'continue' => '</tr><tr>' ), |
| [1245](#L1245) | 't1017' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Categories</td>' ), |
| [1246](#L1246) | 't1018' => array( 'continue' => '  <td colspan="4" style="text-align: left; padding-right: 20px">' ), |
| [1247](#L1247) | 't1019' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::CATEGORIES\_TEMPLATE . '" type="text" size="60" value="' . self::$settings[self::CATEGORIES\_TEMPLATE] . '">' ), |
| [1248](#L1248) | 't1020' => array( 'continue' => '  </td>' ), |
| [1249](#L1249) | 't1021' => array( 'continue' => '</tr><tr>' ), |
| [1250](#L1250) | 't1022' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">Tags</td>' ), |
| [1251](#L1251) | 't1023' => array( 'continue' => '  <td colspan="4" style="text-align: left; padding-right: 20px">' ), |
| [1252](#L1252) | 't1024' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::TAGS\_TEMPLATE . '" type="text" size="60" value="' . self::$settings[self::TAGS\_TEMPLATE] . '">' ), |
| [1253](#L1253) | 't1025' => array( 'continue' => '  </td>' ), |
| [1254](#L1254) | 't1026' => array( 'continue' => '</tr><tr>' ), |
| [1255](#L1255) | 't1027' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle">SKU</td>' ), |
| [1256](#L1256) | 't1028' => array( 'continue' => '  <td colspan="4"  style="text-align: left; padding-right: 20px">' ), |
| [1257](#L1257) | 't1029' => array( 'continue' => '    <input name="' . self::SLUG\_PREFIX . self::SKU\_TEMPLATE . '" type="text" size="60" value="' . self::$settings[self::SKU\_TEMPLATE] . '">' ), |
| [1258](#L1258) | 't1030' => array( 'continue' => '  </td>' ), |
| [1259](#L1259) | 't1031' => array( 'continue' => '</tr><tr>' ), |
| [1260](#L1260) | 't1032' => array( 'continue' => '<td>&nbsp;</td><td colspan="4" >Enter Content Template(s) (without the "template:" prefix). To leave a field unchanged, delete the template from the corresponding text box.<br>&nbsp;</td>' ), |
| [1261](#L1261) | 't1033' => array( 'continue' => '</tr><tr>' ), |
| [1262](#L1262) | 't1034' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::POPULATE\_ON\_ADD . '" type="checkbox"' . self::$populate\_on\_add\_attr . 'value="' . self::POPULATE\_ON\_ADD . '"></td>' ), |
| [1263](#L1263) | 't1035' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">Active for adding Product Image</td>' ), |
| [1264](#L1264) | 't1036' => array( 'continue' => '  <td style="text-align: right; padding-right: 5px" valign="middle"><input name="' . self::SLUG\_PREFIX . self::POPULATE\_ON\_UPDATE . '" type="checkbox"' . self::$populate\_on\_update\_attr . 'value="' . self::POPULATE\_ON\_UPDATE . '"></td>' ), |
| [1265](#L1265) | 't1037' => array( 'continue' => '  <td style="text-align: left; padding-right: 5px" valign="middle">Active for updating Product Image</td>' ), |
| [1266](#L1266) | 't1038' => array( 'continue' => '  <td colspan=2 style="text-align: right; padding-right: 5px" valign="middle">&nbsp;</td>' ), |
| [1267](#L1267) | 't1039' => array( 'continue' => '</tr><tr>' ), |
| [1268](#L1268) | 't1040' => array( 'continue' => '<td>&nbsp;</td><td colspan="5">Check Active for adding... to populate when Product Image is set.<br>Check Active for updating... to populate when Product Image is changed.</td>' ), |
| [1269](#L1269) | 't1041' => array( 'close' => '</tr></table>&nbsp;<br>' ), |
| [1270](#L1270) | 'Populate Products' => array( 'handler' => '\_populate\_product\_from\_product\_image', |
| [1271](#L1271) | 'comment' => 'Populate Product values from the attached Product Image item.' ), |
| [1272](#L1272) | 'Save Templates' => array( 'handler' => '\_save\_product\_templates', |
| [1273](#L1273) | 'comment' => 'Save current template values to the database.' ), |
| [1274](#L1274) | 'Load Templates' => array( 'handler' => '\_load\_product\_templates', |
| [1275](#L1275) | 'comment' => 'Load template values from the database.' ), |
| [1276](#L1276) | 'Restore Defaults' => array( 'handler' => '\_restore\_product\_template\_defaults', |
| [1277](#L1277) | 'comment' => 'Erase stored values from the database and set the default template values.' ), |
| [1278](#L1278) | ); |
| [1279](#L1279) | } |
| [1280](#L1280) |  |
| [1281](#L1281) | /\*\* |
| [1282](#L1282) | \* Render (echo) the "WooCommerce Fixit" submenu in the Tools section |
| [1283](#L1283) | \* |
| [1284](#L1284) | \* @since 1.00 |
| [1285](#L1285) | \* |
| [1286](#L1286) | \* @return      void Echoes HTML markup for the submenu page |
| [1287](#L1287) | \*/ |
| [1288](#L1288) | public static function render\_tools\_page() { |
| [1289](#L1289) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::render\_tools\_page() $\_REQUEST = ' . var\_export( $\_REQUEST, true ), 0 ); |
| [1290](#L1290) | if ( !current\_user\_can( 'manage\_options' ) ) { |
| [1291](#L1291) | echo "WooCommerce Fixit - Error</h2>\n"; |
| [1292](#L1292) | wp\_die( 'You do not have permission to manage plugin settings.' ); |
| [1293](#L1293) | } |
| [1294](#L1294) |  |
| [1295](#L1295) | // Load the Product from Product Image templates from the database or set defaults |
| [1296](#L1296) | //self::\_load\_settings(); |
| [1297](#L1297) |  |
| [1298](#L1298) | // Extract relevant query arguments |
| [1299](#L1299) | self::$first\_product = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_FIRST\_PRODUCT ] ) ? $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_FIRST\_PRODUCT ] : ''; |
| [1300](#L1300) | self::$last\_product = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_LAST\_PRODUCT ] ) ? $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_LAST\_PRODUCT ] : ''; |
| [1301](#L1301) |  |
| [1302](#L1302) | // Operations on ALL Media Library Images |
| [1303](#L1303) | self::$append\_item\_id = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::APPEND\_ITEM\_ID ] ) ? true : false; |
| [1304](#L1304) | self::$append\_item\_id\_attr = self::$append\_item\_id ? ' checked="checked" ' : ' '; |
| [1305](#L1305) | self::$check\_unique\_slug = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::CHECK\_UNIQUE\_SLUG ] ) ? true : false; |
| [1306](#L1306) | self::$check\_unique\_slug\_attr = self::$check\_unique\_slug ? ' checked="checked" ' : ' '; |
| [1307](#L1307) |  |
| [1308](#L1308) | // Operations on the Product Image and Product Gallery |
| [1309](#L1309) | self::$add\_image\_to\_gallery = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::ADD\_IMAGE\_TO\_GALLERY ] ) ? true : false; |
| [1310](#L1310) | self::$add\_image\_to\_gallery\_attr = self::$add\_image\_to\_gallery ? ' checked="checked" ' : ' '; |
| [1311](#L1311) | self::$delete\_no\_children = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::DELETE\_NO\_CHILDREN ] ) ? true : false; |
| [1312](#L1312) | self::$delete\_no\_children\_attr = self::$delete\_no\_children ? ' checked="checked" ' : ' '; |
| [1313](#L1313) | self::$delete\_no\_children = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::DELETE\_NO\_CHILDREN ] ) ? true : false; |
| [1314](#L1314) | self::$delete\_no\_children\_attr = self::$delete\_no\_children ? ' checked="checked" ' : ' '; |
| [1315](#L1315) |  |
| [1316](#L1316) | // No checkbox settings on initial page load |
| [1317](#L1317) | if ( isset( $\_REQUEST[ self::SLUG\_PREFIX . 'action' ] ) ) { |
| [1318](#L1318) | self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::POPULATE\_PI\_PG\_ON\_UPLOAD ] ); |
| [1319](#L1319) | self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::POPULATE\_PI\_PG\_ON\_MMMW ] ); |
| [1320](#L1320) | } |
| [1321](#L1321) |  |
| [1322](#L1322) | self::$populate\_pi\_pg\_on\_upload\_attr = self::$settings[self::POPULATE\_PI\_PG\_ON\_UPLOAD] ? ' checked="checked" ' : ' '; |
| [1323](#L1323) | self::$populate\_pi\_pg\_on\_mmmw\_attr = self::$settings[self::POPULATE\_PI\_PG\_ON\_MMMW] ? ' checked="checked" ' : ' '; |
| [1324](#L1324) |  |
| [1325](#L1325) | // Apply Template to Product Image/Product Gallery Images |
| [1326](#L1326) | self::$content\_template = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_CONTENT\_TEMPLATE ] ) ? trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_CONTENT\_TEMPLATE ] ), 'post' ) ) : self::$content\_template; |
| [1327](#L1327) |  |
| [1328](#L1328) | // Term Assignments for Media Library Items |
| [1329](#L1329) | self::$process\_category = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_PROCESS\_CATEGORY ] ) ? true : false; |
| [1330](#L1330) | self::$category\_attr = self::$process\_category ? ' checked="checked" ' : ' '; |
| [1331](#L1331) | self::$process\_tag = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_PROCESS\_TAG ] ) ? true : false; |
| [1332](#L1332) | self::$tag\_attr = self::$process\_tag ? ' checked="checked" ' : ' '; |
| [1333](#L1333) |  |
| [1334](#L1334) | self::$start\_chunk = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_FIRST\_CHUNK ] ) ? absint( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_FIRST\_CHUNK ] ) : self::$start\_chunk; |
| [1335](#L1335) | self::$stop\_chunk = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_LAST\_CHUNK ] ) ? absint( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_LAST\_CHUNK ] ) : self::$stop\_chunk; |
| [1336](#L1336) | self::$chunk\_size = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_CHUNK\_SIZE ] ) ? absint( $\_REQUEST[ self::SLUG\_PREFIX . self::INPUT\_CHUNK\_SIZE ] ) : self::$chunk\_size; |
| [1337](#L1337) |  |
| [1338](#L1338) | // Populate Product from Product Image |
| [1339](#L1339) | self::$settings[self::NAME\_TEMPLATE] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::NAME\_TEMPLATE ] ) ? trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::NAME\_TEMPLATE ] ), 'post' ) ) : self::$settings[self::NAME\_TEMPLATE]; |
| [1340](#L1340) | self::$settings[self::DESCRIPTION\_TEMPLATE] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::DESCRIPTION\_TEMPLATE ] ) ? trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::DESCRIPTION\_TEMPLATE ] ), 'post' ) ) : self::$settings[self::DESCRIPTION\_TEMPLATE]; |
| [1341](#L1341) | self::$settings[self::SHORT\_DESCRIPTION\_TEMPLATE] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::SHORT\_DESCRIPTION\_TEMPLATE ] ) ? trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::SHORT\_DESCRIPTION\_TEMPLATE ] ), 'post' ) ) : self::$settings[self::SHORT\_DESCRIPTION\_TEMPLATE]; |
| [1342](#L1342) | self::$settings[self::CATEGORIES\_TEMPLATE] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::CATEGORIES\_TEMPLATE ] ) ? trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::CATEGORIES\_TEMPLATE ] ), 'post' ) ) : self::$settings[self::CATEGORIES\_TEMPLATE]; |
| [1343](#L1343) | self::$settings[self::TAGS\_TEMPLATE] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::TAGS\_TEMPLATE ] ) ? trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::TAGS\_TEMPLATE ] ), 'post' ) ) : self::$settings[self::TAGS\_TEMPLATE]; |
| [1344](#L1344) | self::$settings[self::SKU\_TEMPLATE] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::SKU\_TEMPLATE ] ) ? trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . self::SKU\_TEMPLATE ] ), 'post' ) ) : self::$settings[self::SKU\_TEMPLATE]; |
| [1345](#L1345) |  |
| [1346](#L1346) | // No checkbox settings on initial page load |
| [1347](#L1347) | if ( isset( $\_REQUEST[ self::SLUG\_PREFIX . 'action' ] ) ) { |
| [1348](#L1348) | self::$settings[self::POPULATE\_ON\_ADD] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::POPULATE\_ON\_ADD ] ); |
| [1349](#L1349) | self::$settings[self::POPULATE\_ON\_UPDATE] = isset( $\_REQUEST[ self::SLUG\_PREFIX . self::POPULATE\_ON\_UPDATE ] ); |
| [1350](#L1350) | } |
| [1351](#L1351) |  |
| [1352](#L1352) | self::$populate\_on\_add\_attr = self::$settings[self::POPULATE\_ON\_ADD] ? ' checked="checked" ' : ' '; |
| [1353](#L1353) | self::$populate\_on\_update\_attr = self::$settings[self::POPULATE\_ON\_UPDATE] ? ' checked="checked" ' : ' '; |
| [1354](#L1354) |  |
| [1355](#L1355) | echo '<div class="wrap">' . "\n"; |
| [1356](#L1356) | echo "\t\t" . '<div id="icon-tools" class="icon32"><br/></div>' . "\n"; |
| [1357](#L1357) | echo "\t\t" . '<h2>WooCommerce Fixit Tools v' . self::CURRENT\_VERSION . '</h2>' . "\n"; |
| [1358](#L1358) |  |
| [1359](#L1359) | if ( isset( $\_REQUEST[ self::SLUG\_PREFIX . 'action' ] ) ) { |
| [1360](#L1360) | $setting\_actions = self::\_compose\_settings\_actions(); |
| [1361](#L1361) | $label = trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . 'action' ] ), 'post' ) ); |
| [1362](#L1362) | if( isset( $setting\_actions[ $label ] ) ) { |
| [1363](#L1363) | $action = $setting\_actions[ $label ]['handler']; |
| [1364](#L1364) | if ( ! empty( $action ) ) { |
| [1365](#L1365) | if ( method\_exists( 'Woo\_Fixit', $action ) ) { |
| [1366](#L1366) | $message = self::$action(); |
| [1367](#L1367) |  |
| [1368](#L1368) | if ( !empty( $message ) ) { |
| [1369](#L1369) | $is\_error = ( false !== strpos( $message, \_\_( 'ERROR', 'media-library-assistant' ) ) ); |
| [1370](#L1370) | if ( $is\_error ) { |
| [1371](#L1371) | $messages\_class = 'updated error'; |
| [1372](#L1372) | } else { |
| [1373](#L1373) | $messages\_class = 'updated notice is-dismissible'; |
| [1374](#L1374) | } |
| [1375](#L1375) |  |
| [1376](#L1376) | echo "  <div class=\"{$messages\_class}\" id=\"message\"><p>\n"; |
| [1377](#L1377) | echo '    ' . $message . "\n"; |
| [1378](#L1378) | echo "  </p>\n"; |
| [1379](#L1379) |  |
| [1380](#L1380) | if ( !$is\_error ) { |
| [1381](#L1381) | // Obsolete as of WP 4.4.0 |
| [1382](#L1382) | // echo "  <button class=\"notice-dismiss\" type=\"button\"><span class=\"screen-reader-text\">Dismiss this notice.</span></button>\n"; |
| [1383](#L1383) | } |
| [1384](#L1384) |  |
| [1385](#L1385) | echo "  </div>\n"; |
| [1386](#L1386) | } |
| [1387](#L1387) | } else { |
| [1388](#L1388) | echo "\t\t<br><strong>ERROR</strong>: handler \"{$action}\" does not exist for action: \"{$label}\"\n"; |
| [1389](#L1389) | } |
| [1390](#L1390) | } else { |
| [1391](#L1391) | echo "\t\t<br><strong>ERROR</strong>: no handler for action: \"{$label}\"\n"; |
| [1392](#L1392) | } |
| [1393](#L1393) | } else { |
| [1394](#L1394) | echo "\t\t<br>ERROR: unknown action: \"{$label}\"\n"; |
| [1395](#L1395) | } |
| [1396](#L1396) | } |
| [1397](#L1397) |  |
| [1398](#L1398) | echo "\t\t" . '<p><strong>NOTE:</strong> This plugin adds "product:" and "product\_terms:" custom substitution prefixes.<br />' . "\n"; |
| [1399](#L1399) | echo "\t\t" . 'For any Media Library item that is used as a Product Image or Product Gallery item,<br />' . "\n"; |
| [1400](#L1400) | echo "\t\t" . 'these will return values from the associated Product.</p>' . "\n"; |
| [1401](#L1401) |  |
| [1402](#L1402) | echo "\t\t" . '<div style="width:700px">' . "\n"; |
| [1403](#L1403) | echo "\t\t" . '<form action="' . admin\_url( 'tools.php?page=' . self::SLUG\_PREFIX . 'tools' ) . '" method="post" class="' . self::SLUG\_PREFIX . 'tools-form-class" id="' . self::SLUG\_PREFIX . 'tools-form-id">' . "\n"; |
| [1404](#L1404) | echo "\t\t" . '  <p class="submit" style="padding-bottom: 0;">' . "\n"; |
| [1405](#L1405) | echo "\t\t" . '    <table>' . "\n"; |
| [1406](#L1406) |  |
| [1407](#L1407) | echo "\t\t" . '      <tr valign="top"><th valign="middle" style="text-align: right;" scope="row">First Product</th><td style="text-align: left;">' . "\n"; |
| [1408](#L1408) | echo "\t\t" . '        <input name="' . self::SLUG\_PREFIX . self::INPUT\_FIRST\_PRODUCT . '" type="text" size="5" value="' . self::$first\_product . '">' . "\n"; |
| [1409](#L1409) | echo "\t\t" . '      </td></tr>' . "\n"; |
| [1410](#L1410) |  |
| [1411](#L1411) | echo "\t\t" . '      <tr valign="top"><th valign="middle" style="text-align: right;" scope="row">Last Product</th><td style="text-align: left;">' . "\n"; |
| [1412](#L1412) | echo "\t\t" . '        <input name="' . self::SLUG\_PREFIX . self::INPUT\_LAST\_PRODUCT . '" type="text" size="5" value="' . self::$last\_product . '">' . "\n"; |
| [1413](#L1413) | echo "\t\t" . '      </td></tr>' . "\n"; |
| [1414](#L1414) |  |
| [1415](#L1415) | // Refresh the settings actions, which may be modified by the just-executed action. |
| [1416](#L1416) | $setting\_actions = self::\_compose\_settings\_actions(); |
| [1417](#L1417) | foreach ( $setting\_actions as $label => $action ) { |
| [1418](#L1418) | if ( isset( $action['open'] ) ) { |
| [1419](#L1419) | echo "\t\t" . '      <tr><td colspan=2 style="padding: 2px 0px;">' . "\n"; |
| [1420](#L1420) | echo "\t\t" . '        ' . $action['open'] . "\n"; |
| [1421](#L1421) | } elseif ( isset( $action['continue'] ) ) { |
| [1422](#L1422) | echo "\t\t" . '        ' . $action['continue'] . "\n"; |
| [1423](#L1423) | } elseif ( isset( $action['close'] ) ) { |
| [1424](#L1424) | echo "\t\t" . '        ' . $action['close'] . "\n"; |
| [1425](#L1425) | echo "\t\t" . '      </td></tr>' . "\n"; |
| [1426](#L1426) | } else { |
| [1427](#L1427) | if ( empty( $action['handler'] ) ) { |
| [1428](#L1428) | echo "\t\t" . '      <tr><td colspan=2 style="padding: 2px 0px;">' . $action['comment'] . "</td></tr>\n"; |
| [1429](#L1429) | } else { |
| [1430](#L1430) | echo "\t\t" . '      <tr><td width="160px">' . "\n"; |
| [1431](#L1431) | echo "\t\t" . '        <input name="' . self::SLUG\_PREFIX . 'action" type="submit" class="button-primary" style="width: 150px;" value="' . $label . '" />&nbsp;&nbsp;' . "\n"; |
| [1432](#L1432) | echo "\t\t" . '      </td><td>' . "\n"; |
| [1433](#L1433) | echo "\t\t" . '        ' . $action['comment'] . "\n"; |
| [1434](#L1434) | echo "\t\t" . '      </td></tr>' . "\n"; |
| [1435](#L1435) | } |
| [1436](#L1436) | } |
| [1437](#L1437) | } |
| [1438](#L1438) |  |
| [1439](#L1439) | echo "\t\t" . '    </table>' . "\n"; |
| [1440](#L1440) | echo "\t\t" . '  </p>' . "\n"; |
| [1441](#L1441) | echo "\t\t" . '</form>' . "\n"; |
| [1442](#L1442) | echo "\t\t" . '</div>' . "\n"; |
| [1443](#L1443) | echo "\t\t" . '</div><!-- wrap -->' . "\n"; |
| [1444](#L1444) | } |
| [1445](#L1445) |  |
| [1446](#L1446) | /\*\* |
| [1447](#L1447) | \* Array of Products giving Product Image and Product Gallery attachments: |
| [1448](#L1448) | \* product\_id => array( 'post\_title' => product Title, '\_thumbnail\_id' => image\_id, '\_product\_image\_gallery' => gallery\_ids (comma-delimited string), 'children' => array( child IDs ) ) |
| [1449](#L1449) | \* |
| [1450](#L1450) | \* @since 1.00 |
| [1451](#L1451) | \* |
| [1452](#L1452) | \* @var array |
| [1453](#L1453) | \*/ |
| [1454](#L1454) | private static $product\_attachments = array(); |
| [1455](#L1455) |  |
| [1456](#L1456) | /\*\* |
| [1457](#L1457) | \* Array of Attachments giving Product assignments: |
| [1458](#L1458) | \* attachment\_id => array( '\_thumbnail\_id' => array( thumbnail\_ids ), '\_product\_image\_gallery' => array( gallery\_ids ), 'category\_thumbnail' => array( term\_id => name ) ) |
| [1459](#L1459) | \* |
| [1460](#L1460) | \* @since 1.00 |
| [1461](#L1461) | \* |
| [1462](#L1462) | \* @var array |
| [1463](#L1463) | \*/ |
| [1464](#L1464) | private static $attachment\_products = array(); |
| [1465](#L1465) |  |
| [1466](#L1466) | /\*\* |
| [1467](#L1467) | \* Compile array of Product Image and Product Gallery attachments |
| [1468](#L1468) | \* |
| [1469](#L1469) | \* @since 1.00 |
| [1470](#L1470) | \* |
| [1471](#L1471) | \* @param boolean $build\_pa Optional. Build the product\_attachments array. Default: true. |
| [1472](#L1472) | \* @param boolean $add\_children Optional. Add product children to the product\_attachments array. Default: false. |
| [1473](#L1473) | \*/ |
| [1474](#L1474) | private static function \_build\_product\_attachments( $build\_pa = true, $add\_children = false ) { |
| [1475](#L1475) | global $wpdb; |
| [1476](#L1476) |  |
| [1477](#L1477) | if ( ! empty( self::$first\_product ) ) { |
| [1478](#L1478) | $lower\_bound = (integer) self::$first\_product; |
| [1479](#L1479) | } else { |
| [1480](#L1480) | $lower\_bound = 0; |
| [1481](#L1481) | } |
| [1482](#L1482) |  |
| [1483](#L1483) | if ( ! empty( self::$last\_product ) ) { |
| [1484](#L1484) | $upper\_bound = (integer) self::$last\_product; |
| [1485](#L1485) | } elseif ( $lower\_bound ) { |
| [1486](#L1486) | $upper\_bound = $lower\_bound; |
| [1487](#L1487) | } else { |
| [1488](#L1488) | $upper\_bound = 0x7FFFFFFF; |
| [1489](#L1489) | } |
| [1490](#L1490) |  |
| [1491](#L1491) | self::$product\_attachments = array(); |
| [1492](#L1492) | self::$attachment\_products = array(); |
| [1493](#L1493) |  |
| [1494](#L1494) | $query = sprintf( 'SELECT t.term\_id, t.name, tm.meta\_value FROM %1$s as t INNER JOIN %2$s as tt ON t.term\_id = tt.term\_id INNER JOIN %3$s as tm ON t.term\_id = tm.term\_id  WHERE ( ( tt.taxonomy = \'product\_cat\' ) AND ( tm.meta\_key = \'thumbnail\_id\' ) AND ( tm.meta\_value > 0 ) AND ( tm.meta\_value >= %4$d ) AND ( tm.meta\_value <= %5$d) ) ORDER BY tm.meta\_value, t.term\_id', $wpdb->terms, $wpdb->term\_taxonomy, $wpdb->termmeta, $lower\_bound, $upper\_bound ); |
| [1495](#L1495) | $results = $wpdb->get\_results( $query ); |
| [1496](#L1496) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_build\_product\_attachments() $results = ' . var\_export( $results, true ), 0 ); |
| [1497](#L1497) | foreach ( $results as $result ) { |
| [1498](#L1498) | $key = (integer) $result->meta\_value; |
| [1499](#L1499) | if ( isset( self::$attachment\_products[ $key ] ) ) { |
| [1500](#L1500) | self::$attachment\_products[ $key ]['category\_thumbnail'][ (integer) $result->term\_id ] = $result->name; |
| [1501](#L1501) | } else { |
| [1502](#L1502) | self::$attachment\_products[ $key ]['category\_thumbnail'] = array( (integer) $result->term\_id => $result->name ); |
| [1503](#L1503) | } |
| [1504](#L1504) | } |
| [1505](#L1505) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_build\_product\_attachments() self::$attachment\_products = ' . var\_export( self::$attachment\_products, true ), 0 ); |
| [1506](#L1506) |  |
| [1507](#L1507) | unset( $results ); |
| [1508](#L1508) |  |
| [1509](#L1509) | $query = sprintf( 'SELECT m.\*, p.post\_title FROM %1$s as m INNER JOIN %2$s as p ON m.post\_id = p.ID WHERE ( p.post\_type = \'product\' ) AND ( p.ID >= %3$d ) AND ( p.ID <= %4$d) AND ( m.meta\_key IN ( \'\_product\_image\_gallery\', \'\_thumbnail\_id\' ) ) GROUP BY m.post\_id, m.meta\_id ORDER BY m.post\_id', $wpdb->postmeta, $wpdb->posts, $lower\_bound, $upper\_bound ); |
| [1510](#L1510) | $results = $wpdb->get\_results( $query ); |
| [1511](#L1511) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_build\_product\_attachments() $results = ' . var\_export( $results, true ), 0 ); |
| [1512](#L1512) |  |
| [1513](#L1513) | foreach ( $results as $result ) { |
| [1514](#L1514) | if ( $build\_pa ) { |
| [1515](#L1515) | self::$product\_attachments[ $result->post\_id ]['post\_title'] = trim( $result->post\_title ); |
| [1516](#L1516) | self::$product\_attachments[ $result->post\_id ][ $result->meta\_key ] = trim( $result->meta\_value ); |
| [1517](#L1517) | } |
| [1518](#L1518) |  |
| [1519](#L1519) | if ( '\_thumbnail\_id' == $result->meta\_key ) { |
| [1520](#L1520) | $key = (integer) $result->meta\_value; |
| [1521](#L1521) |  |
| [1522](#L1522) | if ( isset( self::$attachment\_products[ $key ] ) ) { |
| [1523](#L1523) | self::$attachment\_products[ $key ]['\_thumbnail\_id'][] = (integer) $result->post\_id; |
| [1524](#L1524) | } else { |
| [1525](#L1525) | self::$attachment\_products[ $key ]['\_thumbnail\_id'] = array( (integer) $result->post\_id ); |
| [1526](#L1526) | } |
| [1527](#L1527) | } else { |
| [1528](#L1528) | foreach( explode( ',', $result->meta\_value ) as $key ) { |
| [1529](#L1529) | $key = (integer) trim( $key ); |
| [1530](#L1530) | if ( isset( self::$attachment\_products[ $key ] ) ) { |
| [1531](#L1531) | self::$attachment\_products[ $key ]['\_product\_image\_gallery'][] = (integer) $result->post\_id; |
| [1532](#L1532) | } else { |
| [1533](#L1533) | self::$attachment\_products[ $key ]['\_product\_image\_gallery'] = array( (integer) $result->post\_id ); |
| [1534](#L1534) | } |
| [1535](#L1535) | } |
| [1536](#L1536) | } |
| [1537](#L1537) | } // foreach attachment\_products thumbnail/gallery |
| [1538](#L1538) |  |
| [1539](#L1539) | if ( $build\_pa && $add\_children ) { |
| [1540](#L1540) | // Exclude unattached items |
| [1541](#L1541) | if ( 0 === $lower\_bound ) { |
| [1542](#L1542) | $lower\_bound = 1; |
| [1543](#L1543) | } |
| [1544](#L1544) |  |
| [1545](#L1545) | $query = sprintf( 'SELECT p.ID, p.post\_mime\_type, p.post\_parent FROM %1$s as p INNER JOIN %1$s as parent ON parent.ID = p.post\_parent WHERE ( parent.post\_type = \'product\' ) AND ( p.post\_type = \'attachment\' ) AND ( p.post\_status = \'inherit\' ) AND ( p.post\_parent >= %2$d ) AND ( p.post\_parent <= %3$d ) ORDER BY p.ID', $wpdb->posts, $lower\_bound, $upper\_bound ); |
| [1546](#L1546) | $results = $wpdb->get\_results( $query ); |
| [1547](#L1547) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_build\_product\_attachments() add\_children $results = ' . var\_export( $results, true ), 0 ); |
| [1548](#L1548) |  |
| [1549](#L1549) | foreach ( $results as $result ) { |
| [1550](#L1550) | if ( 0 === strpos( $result->post\_mime\_type, 'image' ) ) { |
| [1551](#L1551) | $key = (integer) trim( $result->post\_parent ); |
| [1552](#L1552) | $ID = (integer) $result->ID; |
| [1553](#L1553) | if ( isset( self::$product\_attachments[ $key ] ) ) { |
| [1554](#L1554) | self::$product\_attachments[ $key ]['children'][ $ID ] = $ID; |
| [1555](#L1555) | } else { |
| [1556](#L1556) | self::$product\_attachments[ $key ]['children'] = array( $ID => $ID ); |
| [1557](#L1557) | } |
| [1558](#L1558) | } // image child |
| [1559](#L1559) | } // foreach product child |
| [1560](#L1560) | } |
| [1561](#L1561) |  |
| [1562](#L1562) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_build\_product\_attachments() self::$product\_attachments = ' . var\_export( self::$product\_attachments, true ), 0 ); |
| [1563](#L1563) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_build\_product\_attachments() self::$attachment\_products = ' . var\_export( self::$attachment\_products, true ), 0 ); |
| [1564](#L1564) | } // \_build\_product\_attachments |
| [1565](#L1565) |  |
| [1566](#L1566) | /\*\* |
| [1567](#L1567) | \* Replace ALL item Title fields with empty value |
| [1568](#L1568) | \* |
| [1569](#L1569) | \* @since 1.00 |
| [1570](#L1570) | \* |
| [1571](#L1571) | \* @return      string  HTML markup for results/messages |
| [1572](#L1572) | \*/ |
| [1573](#L1573) | private static function \_clear\_title() { |
| [1574](#L1574) | global $wpdb; |
| [1575](#L1575) |  |
| [1576](#L1576) | $results = $wpdb->query( "UPDATE {$wpdb->posts} SET post\_title = '' WHERE post\_type = 'attachment'" ); |
| [1577](#L1577) | return "\_clear\_title() performed {$results} update(s).\n"; |
| [1578](#L1578) | } // \_clear\_title |
| [1579](#L1579) |  |
| [1580](#L1580) | /\*\* |
| [1581](#L1581) | \* Fill empty item Title field with re-formatted file name |
| [1582](#L1582) | \* |
| [1583](#L1583) | \* @since 1.00 |
| [1584](#L1584) | \* |
| [1585](#L1585) | \* @return      string  HTML markup for results/messages |
| [1586](#L1586) | \*/ |
| [1587](#L1587) | private static function \_fill\_title() { |
| [1588](#L1588) | global $wpdb; |
| [1589](#L1589) |  |
| [1590](#L1590) | $query = sprintf( 'SELECT m.post\_id, m.meta\_value FROM %1$s as m INNER JOIN %2$s as p ON m.post\_id = p.ID WHERE ( p.post\_title = \'\' ) AND ( p.post\_type = \'attachment\' ) AND ( m.meta\_key IN ( \'\_wp\_attached\_file\' ) )', $wpdb->postmeta, $wpdb->posts ); |
| [1591](#L1591) | $results = $wpdb->get\_results( $query ); |
| [1592](#L1592) |  |
| [1593](#L1593) | $update\_count = 0; |
| [1594](#L1594) | $select\_bits = ''; |
| [1595](#L1595) | $where\_bits = array(); |
| [1596](#L1596) | $chunk\_count = 0; |
| [1597](#L1597) | foreach( $results as $result ) { |
| [1598](#L1598) | $path\_info = pathinfo( $result->meta\_value ); |
| [1599](#L1599) | $new\_title = str\_replace( array( '-', '\_', '.' ), ' ', $path\_info['filename'] ); |
| [1600](#L1600) | $select\_bits .= " WHEN ID = {$result->post\_id} THEN '{$new\_title}'"; |
| [1601](#L1601) | $where\_bits[] = $result->post\_id; |
| [1602](#L1602) |  |
| [1603](#L1603) | // Run an update when the chunk is full |
| [1604](#L1604) | if ( 25 <= ++$chunk\_count ) { |
| [1605](#L1605) | $where\_bits = implode( ',', $where\_bits ); |
| [1606](#L1606) | $update\_query = "UPDATE {$wpdb->posts} SET post\_title = CASE{$select\_bits} ELSE post\_title END WHERE ID IN ( {$where\_bits} )"; |
| [1607](#L1607) | $query\_result = $wpdb->query( $update\_query ); |
| [1608](#L1608) | $update\_count += $chunk\_count; |
| [1609](#L1609) | $select\_bits = ''; |
| [1610](#L1610) | $where\_bits = array(); |
| [1611](#L1611) | $chunk\_count = 0; |
| [1612](#L1612) | } |
| [1613](#L1613) | } |
| [1614](#L1614) |  |
| [1615](#L1615) | // Run a final update if the chunk is partially filled |
| [1616](#L1616) | if ( $chunk\_count ) { |
| [1617](#L1617) | $where\_bits = implode( ',', $where\_bits ); |
| [1618](#L1618) | $update\_query = "UPDATE {$wpdb->posts} SET post\_title = CASE{$select\_bits} ELSE post\_title END WHERE ID IN ( {$where\_bits} )"; |
| [1619](#L1619) | $query\_result = $wpdb->query( $update\_query ); |
| [1620](#L1620) | $update\_count += $chunk\_count; |
| [1621](#L1621) | } |
| [1622](#L1622) |  |
| [1623](#L1623) | return "\_fill\_title() performed {$update\_count} update(s).\n"; |
| [1624](#L1624) | } // \_fill\_title |
| [1625](#L1625) |  |
| [1626](#L1626) | /\*\* |
| [1627](#L1627) | \* Replace ALL item Title fields with re-formatted file name |
| [1628](#L1628) | \* |
| [1629](#L1629) | \* @since 1.00 |
| [1630](#L1630) | \* |
| [1631](#L1631) | \* @return      string  HTML markup for results/messages |
| [1632](#L1632) | \*/ |
| [1633](#L1633) | private static function \_replace\_title() { |
| [1634](#L1634) | global $wpdb; |
| [1635](#L1635) |  |
| [1636](#L1636) | $query = sprintf( 'SELECT m.post\_id, m.meta\_value FROM %1$s as m INNER JOIN %2$s as p ON m.post\_id = p.ID WHERE ( p.post\_mime\_type LIKE \'%3$s\' ) AND ( p.post\_type = \'attachment\' ) AND ( m.meta\_key IN ( \'\_wp\_attached\_file\' ) )', $wpdb->postmeta, $wpdb->posts, 'image/%' ); |
| [1637](#L1637) | $results = $wpdb->get\_results( $query ); |
| [1638](#L1638) |  |
| [1639](#L1639) | $update\_count = 0; |
| [1640](#L1640) | $select\_bits = ''; |
| [1641](#L1641) | $where\_bits = array(); |
| [1642](#L1642) | $chunk\_count = 0; |
| [1643](#L1643) | foreach( $results as $result ) { |
| [1644](#L1644) | $path\_info = pathinfo( $result->meta\_value ); |
| [1645](#L1645) | $new\_title = str\_replace( array( '-', '\_', '.' ), ' ', $path\_info['filename'] ); |
| [1646](#L1646) | $select\_bits .= " WHEN ID = {$result->post\_id} THEN '{$new\_title}'"; |
| [1647](#L1647) | $where\_bits[] = $result->post\_id; |
| [1648](#L1648) |  |
| [1649](#L1649) | // Run an update when the chunk is full |
| [1650](#L1650) | if ( 25 <= ++$chunk\_count ) { |
| [1651](#L1651) | $where\_bits = implode( ',', $where\_bits ); |
| [1652](#L1652) | $update\_query = "UPDATE {$wpdb->posts} SET post\_title = CASE{$select\_bits} ELSE post\_title END WHERE ID IN ( {$where\_bits} )"; |
| [1653](#L1653) | $query\_result = $wpdb->query( $update\_query ); |
| [1654](#L1654) | $update\_count += $chunk\_count; |
| [1655](#L1655) | $select\_bits = ''; |
| [1656](#L1656) | $where\_bits = array(); |
| [1657](#L1657) | $chunk\_count = 0; |
| [1658](#L1658) | } |
| [1659](#L1659) | } |
| [1660](#L1660) |  |
| [1661](#L1661) | // Run a final update if the chunk is partially filled |
| [1662](#L1662) | if ( $chunk\_count ) { |
| [1663](#L1663) | $where\_bits = implode( ',', $where\_bits ); |
| [1664](#L1664) | $update\_query = "UPDATE {$wpdb->posts} SET post\_title = CASE{$select\_bits} ELSE post\_title END WHERE ID IN ( {$where\_bits} )"; |
| [1665](#L1665) | $query\_result = $wpdb->query( $update\_query ); |
| [1666](#L1666) | $update\_count += $chunk\_count; |
| [1667](#L1667) | } |
| [1668](#L1668) |  |
| [1669](#L1669) | return "\_replace\_title() performed {$update\_count} update(s).\n"; |
| [1670](#L1670) | } // \_replace\_title |
| [1671](#L1671) |  |
| [1672](#L1672) | /\*\* |
| [1673](#L1673) | \* Replace ALL item Name/Slug fields with file name |
| [1674](#L1674) | \* |
| [1675](#L1675) | \* @since 2.04 |
| [1676](#L1676) | \* |
| [1677](#L1677) | \* @return string HTML markup for results/messages |
| [1678](#L1678) | \*/ |
| [1679](#L1679) | private static function \_replace\_slug() { |
| [1680](#L1680) | global $wpdb; |
| [1681](#L1681) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_replace\_slug append\_item\_id = " . var\_export( self::$append\_item\_id, true ), 0 ); |
| [1682](#L1682) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_replace\_slug check\_unique\_slug = " . var\_export( self::$check\_unique\_slug, true ), 0 ); |
| [1683](#L1683) |  |
| [1684](#L1684) | $query = sprintf( 'SELECT m.post\_id, m.meta\_value, p.post\_status FROM %1$s as m INNER JOIN %2$s as p ON m.post\_id = p.ID WHERE ( p.post\_mime\_type LIKE \'%3$s\' ) AND ( p.post\_type = \'attachment\' ) AND ( m.meta\_key IN ( \'\_wp\_attached\_file\' ) )', $wpdb->postmeta, $wpdb->posts, 'image/%' ); |
| [1685](#L1685) | $results = $wpdb->get\_results( $query ); |
| [1686](#L1686) |  |
| [1687](#L1687) | $update\_count = 0; |
| [1688](#L1688) | $select\_bits = ''; |
| [1689](#L1689) | $where\_bits = array(); |
| [1690](#L1690) | $chunk\_count = 0; |
| [1691](#L1691) | foreach( $results as $result ) { |
| [1692](#L1692) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_replace\_slug result = " . var\_export( $result, true ), 0 ); |
| [1693](#L1693) | $path\_info = pathinfo( $result->meta\_value ); |
| [1694](#L1694) | $new\_slug = sanitize\_title( $path\_info['filename'] ); |
| [1695](#L1695) |  |
| [1696](#L1696) | if ( self::$append\_item\_id ) { |
| [1697](#L1697) | $new\_slug .= '-' . $result->post\_id; |
| [1698](#L1698) | } |
| [1699](#L1699) |  |
| [1700](#L1700) | if ( self::$check\_unique\_slug ) { |
| [1701](#L1701) | $new\_slug = wp\_unique\_post\_slug( $new\_slug, $result->post\_id, $result->post\_status, 'attachment', 0 ); |
| [1702](#L1702) | } |
| [1703](#L1703) |  |
| [1704](#L1704) | $select\_bits .= " WHEN ID = {$result->post\_id} THEN '{$new\_slug}'"; |
| [1705](#L1705) | $where\_bits[] = $result->post\_id; |
| [1706](#L1706) |  |
| [1707](#L1707) | // Run an update when the chunk is full |
| [1708](#L1708) | if ( 25 <= ++$chunk\_count ) { |
| [1709](#L1709) | $where\_bits = implode( ',', $where\_bits ); |
| [1710](#L1710) | $update\_query = "UPDATE {$wpdb->posts} SET post\_name = CASE{$select\_bits} ELSE post\_name END WHERE ID IN ( {$where\_bits} )"; |
| [1711](#L1711) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_replace\_slug update\_query = " . var\_export( $update\_query, true ), 0 ); |
| [1712](#L1712) | $query\_result = $wpdb->query( $update\_query ); |
| [1713](#L1713) | $update\_count += $chunk\_count; |
| [1714](#L1714) | $select\_bits = ''; |
| [1715](#L1715) | $where\_bits = array(); |
| [1716](#L1716) | $chunk\_count = 0; |
| [1717](#L1717) | } |
| [1718](#L1718) | } |
| [1719](#L1719) |  |
| [1720](#L1720) | // Run a final update if the chunk is partially filled |
| [1721](#L1721) | if ( $chunk\_count ) { |
| [1722](#L1722) | $where\_bits = implode( ',', $where\_bits ); |
| [1723](#L1723) | $update\_query = "UPDATE {$wpdb->posts} SET post\_name = CASE{$select\_bits} ELSE post\_name END WHERE ID IN ( {$where\_bits} )"; |
| [1724](#L1724) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_replace\_slug update\_query = " . var\_export( $update\_query, true ), 0 ); |
| [1725](#L1725) | $query\_result = $wpdb->query( $update\_query ); |
| [1726](#L1726) | $update\_count += $chunk\_count; |
| [1727](#L1727) | } |
| [1728](#L1728) |  |
| [1729](#L1729) | return "\_replace\_slug() performed {$update\_count} update(s).\n"; |
| [1730](#L1730) | } // \_replace\_slug |
| [1731](#L1731) |  |
| [1732](#L1732) | /\*\* |
| [1733](#L1733) | \* Empty ALT Text field in all Product Image/Product Gallery items |
| [1734](#L1734) | \* |
| [1735](#L1735) | \* @since 1.00 |
| [1736](#L1736) | \* |
| [1737](#L1737) | \* @return      string  HTML markup for results/messages |
| [1738](#L1738) | \*/ |
| [1739](#L1739) | private static function \_clear\_alt\_text() { |
| [1740](#L1740) | global $wpdb; |
| [1741](#L1741) |  |
| [1742](#L1742) | self::\_build\_product\_attachments(); |
| [1743](#L1743) | ksort( self::$attachment\_products ); |
| [1744](#L1744) | $update\_count = 0; |
| [1745](#L1745) | foreach ( array\_chunk( self::$attachment\_products, 25, true ) as $chunk ) { |
| [1746](#L1746) | $keys = implode( ',', array\_keys( $chunk ) ); |
| [1747](#L1747) | $delete\_query = "DELETE FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [1748](#L1748) | $query\_result = $wpdb->query( $delete\_query ); |
| [1749](#L1749) | $update\_count += $query\_result; |
| [1750](#L1750) | } |
| [1751](#L1751) |  |
| [1752](#L1752) | return "\_clear\_alt\_text() performed {$update\_count} delete(s).\n"; |
| [1753](#L1753) | } // \_clear\_alt\_text |
| [1754](#L1754) |  |
| [1755](#L1755) | /\*\* |
| [1756](#L1756) | \* Fill empty ALT Text field with first top-level Product Category |
| [1757](#L1757) | \* |
| [1758](#L1758) | \* @since 1.00 |
| [1759](#L1759) | \* |
| [1760](#L1760) | \* @return      string  HTML markup for results/messages |
| [1761](#L1761) | \*/ |
| [1762](#L1762) | private static function \_fill\_alt\_text() { |
| [1763](#L1763) | global $wpdb; |
| [1764](#L1764) |  |
| [1765](#L1765) | self::\_build\_product\_attachments(); |
| [1766](#L1766) | $delete\_count = 0; |
| [1767](#L1767) | $insert\_count = 0; |
| [1768](#L1768) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [1769](#L1769) | $terms = wp\_get\_object\_terms( array\_keys( $chunk ), 'product\_cat', array( 'orderby' => 'name', 'fields' => 'all\_with\_object\_id' ) ); |
| [1770](#L1770) |  |
| [1771](#L1771) | if ( empty( $terms ) ) { |
| [1772](#L1772) | continue; |
| [1773](#L1773) | } |
| [1774](#L1774) |  |
| [1775](#L1775) | // Build an array of "first product category" names |
| [1776](#L1776) | $product\_terms = array(); |
| [1777](#L1777) | foreach ( $terms as $term ) { |
| [1778](#L1778) | if ( isset( $product\_terms[ $term->object\_id ] ) ) { |
| [1779](#L1779) | // The first top-level term wins |
| [1780](#L1780) | if ( 0 == $product\_terms[ $term->object\_id ]['parent'] ) { |
| [1781](#L1781) | continue; |
| [1782](#L1782) | } elseif ( ( (integer) $term->parent ) < $product\_terms[ $term->object\_id ]['parent'] ) { |
| [1783](#L1783) | $product\_terms[ $term->object\_id ] = array( 'name' => $term->name, 'parent' => (integer) $term->parent ); |
| [1784](#L1784) | } |
| [1785](#L1785) | } else { |
| [1786](#L1786) | $product\_terms[ $term->object\_id ] = array( 'name' => $term->name, 'parent' => (integer) $term->parent ); |
| [1787](#L1787) | } |
| [1788](#L1788) | } |
| [1789](#L1789) |  |
| [1790](#L1790) | // Assign the names to each attachment |
| [1791](#L1791) | $attachment\_values = array(); |
| [1792](#L1792) | foreach ( $chunk as $key => $value ) { |
| [1793](#L1793) | if ( empty( $product\_terms[ $key ] ) ) { |
| [1794](#L1794) | continue; |
| [1795](#L1795) | } |
| [1796](#L1796) |  |
| [1797](#L1797) | if ( ! empty( $value['\_thumbnail\_id'] ) ) { |
| [1798](#L1798) | $attachment\_values[ $value['\_thumbnail\_id'] ] = $product\_terms[ $key ]['name']; |
| [1799](#L1799) | } |
| [1800](#L1800) |  |
| [1801](#L1801) | if ( ! empty( $value['\_product\_image\_gallery'] ) ) { |
| [1802](#L1802) | $ids = explode( ',', $value['\_product\_image\_gallery'] ); |
| [1803](#L1803) | foreach( $ids as $id ) { |
| [1804](#L1804) | $attachment\_values[ $id ] = $product\_terms[ $key ]['name']; |
| [1805](#L1805) | } |
| [1806](#L1806) | } |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | // Find the existing ALT Text values and remove them from the update |
| [1810](#L1810) | $keys = implode( ',', array\_keys( $attachment\_values ) ); |
| [1811](#L1811) | $select\_query = "SELECT post\_id, meta\_value FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [1812](#L1812) | $empty\_values = array(); |
| [1813](#L1813) | foreach( $wpdb->get\_results( $select\_query ) as $existing\_value ) { |
| [1814](#L1814) | $trim =  trim( $existing\_value->meta\_value ); |
| [1815](#L1815) | if ( empty( $trim ) ) { |
| [1816](#L1816) | $empty\_values[] = $existing\_value->post\_id; |
| [1817](#L1817) | continue; |
| [1818](#L1818) | } |
| [1819](#L1819) | unset( $attachment\_values[ (integer) $existing\_value->post\_id ] ); |
| [1820](#L1820) | } |
| [1821](#L1821) |  |
| [1822](#L1822) | // Delete empty ALT Text values |
| [1823](#L1823) | if ( ! empty( $empty\_values ) ) { |
| [1824](#L1824) | $keys = implode( ',', $empty\_values ); |
| [1825](#L1825) | $delete\_query = "DELETE FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [1826](#L1826) | $query\_result = $wpdb->query( $delete\_query ); |
| [1827](#L1827) | $delete\_count += $query\_result; |
| [1828](#L1828) | } |
| [1829](#L1829) |  |
| [1830](#L1830) | // Insert the new values |
| [1831](#L1831) | foreach ( $attachment\_values as $attachment => $text ) { |
| [1832](#L1832) | $insert\_query = "INSERT INTO {$wpdb->postmeta} ( `post\_id`,`meta\_key`,`meta\_value` ) |
| [1833](#L1833) | VALUES ( {$attachment},'\_wp\_attachment\_image\_alt','{$text}' )"; |
| [1834](#L1834) | $query\_result = $wpdb->query( $insert\_query ); |
| [1835](#L1835) | $insert\_count += $query\_result; |
| [1836](#L1836) | } |
| [1837](#L1837) | } |
| [1838](#L1838) |  |
| [1839](#L1839) | return "\_fill\_alt\_text() performed {$delete\_count} delete(s), {$insert\_count} inserts(s).\n"; |
| [1840](#L1840) | } // \_fill\_alt\_text |
| [1841](#L1841) |  |
| [1842](#L1842) | /\*\* |
| [1843](#L1843) | \* Replace ALL ALT Text field with first top-level Product Category |
| [1844](#L1844) | \* |
| [1845](#L1845) | \* @since 1.00 |
| [1846](#L1846) | \* |
| [1847](#L1847) | \* @return      string  HTML markup for results/messages |
| [1848](#L1848) | \*/ |
| [1849](#L1849) | private static function \_replace\_alt\_text() { |
| [1850](#L1850) | global $wpdb; |
| [1851](#L1851) |  |
| [1852](#L1852) | self::\_build\_product\_attachments(); |
| [1853](#L1853) | $delete\_count = 0; |
| [1854](#L1854) | $insert\_count = 0; |
| [1855](#L1855) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [1856](#L1856) | $terms = wp\_get\_object\_terms( array\_keys( $chunk ), 'product\_cat', array( 'orderby' => 'name', 'fields' => 'all\_with\_object\_id' ) ); |
| [1857](#L1857) |  |
| [1858](#L1858) | if ( empty( $terms ) ) { |
| [1859](#L1859) | continue; |
| [1860](#L1860) | } |
| [1861](#L1861) |  |
| [1862](#L1862) | // Build an array of "first product category" names |
| [1863](#L1863) | $product\_terms = array(); |
| [1864](#L1864) | foreach ( $terms as $term ) { |
| [1865](#L1865) | if ( isset( $product\_terms[ $term->object\_id ] ) ) { |
| [1866](#L1866) | // The first top-level term wins |
| [1867](#L1867) | if ( 0 == $product\_terms[ $term->object\_id ]['parent'] ) { |
| [1868](#L1868) | continue; |
| [1869](#L1869) | } elseif ( ( (integer) $term->parent ) < $product\_terms[ $term->object\_id ]['parent'] ) { |
| [1870](#L1870) | $product\_terms[ $term->object\_id ] = array( 'name' => $term->name, 'parent' => (integer) $term->parent ); |
| [1871](#L1871) | } |
| [1872](#L1872) | } else { |
| [1873](#L1873) | $product\_terms[ $term->object\_id ] = array( 'name' => $term->name, 'parent' => (integer) $term->parent ); |
| [1874](#L1874) | } |
| [1875](#L1875) | } |
| [1876](#L1876) |  |
| [1877](#L1877) | // Assign the names to each attachment |
| [1878](#L1878) | $attachment\_values = array(); |
| [1879](#L1879) | foreach ( $chunk as $key => $value ) { |
| [1880](#L1880) | if ( isset( $value['\_thumbnail\_id'] ) ) { |
| [1881](#L1881) | $attachment\_values[ $value['\_thumbnail\_id'] ] = $product\_terms[ $key ]['name']; |
| [1882](#L1882) | } |
| [1883](#L1883) |  |
| [1884](#L1884) | if ( !empty( $value['\_product\_image\_gallery'] ) ) { |
| [1885](#L1885) | $ids = explode( ',', $value['\_product\_image\_gallery'] ); |
| [1886](#L1886) | foreach( $ids as $id ) { |
| [1887](#L1887) | $attachment\_values[ $id ] = $product\_terms[ $key ]['name']; |
| [1888](#L1888) | } |
| [1889](#L1889) | } |
| [1890](#L1890) | } |
| [1891](#L1891) |  |
| [1892](#L1892) | // Remove the old ALT Text values |
| [1893](#L1893) | $keys = implode( ',', array\_keys( $attachment\_values ) ); |
| [1894](#L1894) | $delete\_query = "DELETE FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [1895](#L1895) | $query\_result = $wpdb->query( $delete\_query ); |
| [1896](#L1896) | $delete\_count += $query\_result; |
| [1897](#L1897) |  |
| [1898](#L1898) | // Insert the new values |
| [1899](#L1899) | foreach ( $attachment\_values as $attachment => $text ) { |
| [1900](#L1900) | $insert\_query = "INSERT INTO {$wpdb->postmeta} ( `post\_id`,`meta\_key`,`meta\_value` ) |
| [1901](#L1901) | VALUES ( {$attachment},'\_wp\_attachment\_image\_alt','{$text}' )"; |
| [1902](#L1902) | $query\_result = $wpdb->query( $insert\_query ); |
| [1903](#L1903) | $insert\_count += $query\_result; |
| [1904](#L1904) | } |
| [1905](#L1905) | } |
| [1906](#L1906) |  |
| [1907](#L1907) | return "\_replace\_alt\_text() performed {$delete\_count} delete(s), {$insert\_count} inserts(s).\n"; |
| [1908](#L1908) | } // \_replace\_alt\_text |
| [1909](#L1909) |  |
| [1910](#L1910) | /\*\* |
| [1911](#L1911) | \* Fill empty ALT Text field with Product Title |
| [1912](#L1912) | \* |
| [1913](#L1913) | \* @since 1.20 |
| [1914](#L1914) | \* |
| [1915](#L1915) | \* @return      string  HTML markup for results/messages |
| [1916](#L1916) | \*/ |
| [1917](#L1917) | private static function \_fill\_alt\_text\_t() { |
| [1918](#L1918) | global $wpdb; |
| [1919](#L1919) |  |
| [1920](#L1920) | self::\_build\_product\_attachments(); |
| [1921](#L1921) | $delete\_count = 0; |
| [1922](#L1922) | $insert\_count = 0; |
| [1923](#L1923) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [1924](#L1924) | // Assign the Product Title to each attachment |
| [1925](#L1925) | $attachment\_values = array(); |
| [1926](#L1926) | foreach ( $chunk as $key => $value ) { |
| [1927](#L1927) | if ( ! empty( $value['\_thumbnail\_id'] ) ) { |
| [1928](#L1928) | $attachment\_values[ $value['\_thumbnail\_id'] ] = $value['post\_title']; |
| [1929](#L1929) | } |
| [1930](#L1930) |  |
| [1931](#L1931) | if ( ! empty( $value['\_product\_image\_gallery'] ) ) { |
| [1932](#L1932) | $ids = explode( ',', $value['\_product\_image\_gallery'] ); |
| [1933](#L1933) | foreach( $ids as $id ) { |
| [1934](#L1934) | $attachment\_values[ $id ] = $value['post\_title']; |
| [1935](#L1935) | } |
| [1936](#L1936) | } |
| [1937](#L1937) | } |
| [1938](#L1938) |  |
| [1939](#L1939) | // Find the existing ALT Text values and remove them from the update |
| [1940](#L1940) | $keys = implode( ',', array\_keys( $attachment\_values ) ); |
| [1941](#L1941) | $select\_query = "SELECT post\_id, meta\_value FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [1942](#L1942) | $empty\_values = array(); |
| [1943](#L1943) | foreach( $wpdb->get\_results( $select\_query ) as $existing\_value ) { |
| [1944](#L1944) | $trim =  trim( $existing\_value->meta\_value ); |
| [1945](#L1945) | if ( empty( $trim ) ) { |
| [1946](#L1946) | $empty\_values[] = $existing\_value->post\_id; |
| [1947](#L1947) | continue; |
| [1948](#L1948) | } |
| [1949](#L1949) | unset( $attachment\_values[ (integer) $existing\_value->post\_id ] ); |
| [1950](#L1950) | } |
| [1951](#L1951) |  |
| [1952](#L1952) | // Delete empty ALT Text values |
| [1953](#L1953) | if ( ! empty( $empty\_values ) ) { |
| [1954](#L1954) | $keys = implode( ',', $empty\_values ); |
| [1955](#L1955) | $delete\_query = "DELETE FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [1956](#L1956) | $query\_result = $wpdb->query( $delete\_query ); |
| [1957](#L1957) | $delete\_count += $query\_result; |
| [1958](#L1958) | } |
| [1959](#L1959) |  |
| [1960](#L1960) | // Insert the new values |
| [1961](#L1961) | foreach ( $attachment\_values as $attachment => $text ) { |
| [1962](#L1962) | $insert\_query = "INSERT INTO {$wpdb->postmeta} ( `post\_id`,`meta\_key`,`meta\_value` ) |
| [1963](#L1963) | VALUES ( {$attachment},'\_wp\_attachment\_image\_alt','{$text}' )"; |
| [1964](#L1964) | $query\_result = $wpdb->query( $insert\_query ); |
| [1965](#L1965) | $insert\_count += $query\_result; |
| [1966](#L1966) | } |
| [1967](#L1967) | } |
| [1968](#L1968) |  |
| [1969](#L1969) | return "\_fill\_alt\_text\_t() performed {$delete\_count} delete(s), {$insert\_count} inserts(s).\n"; |
| [1970](#L1970) | } // \_fill\_alt\_text\_t |
| [1971](#L1971) |  |
| [1972](#L1972) | /\*\* |
| [1973](#L1973) | \* Replace ALL ALT Text field with Product Title |
| [1974](#L1974) | \* |
| [1975](#L1975) | \* @since 1.20 |
| [1976](#L1976) | \* |
| [1977](#L1977) | \* @return      string  HTML markup for results/messages |
| [1978](#L1978) | \*/ |
| [1979](#L1979) | private static function \_replace\_alt\_text\_t() { |
| [1980](#L1980) | global $wpdb; |
| [1981](#L1981) |  |
| [1982](#L1982) | self::\_build\_product\_attachments(); |
| [1983](#L1983) | $delete\_count = 0; |
| [1984](#L1984) | $insert\_count = 0; |
| [1985](#L1985) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [1986](#L1986) | // Assign the Product Title to each attachment |
| [1987](#L1987) | $attachment\_values = array(); |
| [1988](#L1988) | foreach ( $chunk as $key => $value ) { |
| [1989](#L1989) | if ( isset( $value['\_thumbnail\_id'] ) ) { |
| [1990](#L1990) | $attachment\_values[ $value['\_thumbnail\_id'] ] = $value['post\_title']; |
| [1991](#L1991) | } |
| [1992](#L1992) |  |
| [1993](#L1993) | if ( !empty( $value['\_product\_image\_gallery'] ) ) { |
| [1994](#L1994) | $ids = explode( ',', $value['\_product\_image\_gallery'] ); |
| [1995](#L1995) | foreach( $ids as $id ) { |
| [1996](#L1996) | $attachment\_values[ $id ] = $value['post\_title']; |
| [1997](#L1997) | } |
| [1998](#L1998) | } |
| [1999](#L1999) | } |
| [2000](#L2000) |  |
| [2001](#L2001) | // Remove the old ALT Text values |
| [2002](#L2002) | $keys = implode( ',', array\_keys( $attachment\_values ) ); |
| [2003](#L2003) | $delete\_query = "DELETE FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [2004](#L2004) | $query\_result = $wpdb->query( $delete\_query ); |
| [2005](#L2005) | $delete\_count += $query\_result; |
| [2006](#L2006) |  |
| [2007](#L2007) | // Insert the new values |
| [2008](#L2008) | foreach ( $attachment\_values as $attachment => $text ) { |
| [2009](#L2009) | $insert\_query = "INSERT INTO {$wpdb->postmeta} ( `post\_id`,`meta\_key`,`meta\_value` ) |
| [2010](#L2010) | VALUES ( {$attachment},'\_wp\_attachment\_image\_alt','{$text}' )"; |
| [2011](#L2011) | $query\_result = $wpdb->query( $insert\_query ); |
| [2012](#L2012) | $insert\_count += $query\_result; |
| [2013](#L2013) | } |
| [2014](#L2014) | } |
| [2015](#L2015) |  |
| [2016](#L2016) | return "\_replace\_alt\_text\_t() performed {$delete\_count} delete(s), {$insert\_count} inserts(s).\n"; |
| [2017](#L2017) | } // \_replace\_alt\_text\_t |
| [2018](#L2018) |  |
| [2019](#L2019) | /\*\* |
| [2020](#L2020) | \* Fill empty item Title field with Product Title |
| [2021](#L2021) | \* |
| [2022](#L2022) | \* @since 1.20 |
| [2023](#L2023) | \* |
| [2024](#L2024) | \* @return      string  HTML markup for results/messages |
| [2025](#L2025) | \*/ |
| [2026](#L2026) | private static function \_fill\_title\_t() { |
| [2027](#L2027) | global $wpdb; |
| [2028](#L2028) |  |
| [2029](#L2029) | self::\_build\_product\_attachments(); |
| [2030](#L2030) | $update\_count = 0; |
| [2031](#L2031) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [2032](#L2032) | // Assign the Product Title to each attachment |
| [2033](#L2033) | $attachment\_values = array(); |
| [2034](#L2034) | foreach ( $chunk as $key => $value ) { |
| [2035](#L2035) | if ( ! empty( $value['\_thumbnail\_id'] ) ) { |
| [2036](#L2036) | $attachment\_values[ $value['\_thumbnail\_id'] ] = $value['post\_title']; |
| [2037](#L2037) | } |
| [2038](#L2038) |  |
| [2039](#L2039) | if ( ! empty( $value['\_product\_image\_gallery'] ) ) { |
| [2040](#L2040) | $ids = explode( ',', $value['\_product\_image\_gallery'] ); |
| [2041](#L2041) | foreach( $ids as $id ) { |
| [2042](#L2042) | $attachment\_values[ $id ] = $value['post\_title']; |
| [2043](#L2043) | } |
| [2044](#L2044) | } |
| [2045](#L2045) | } |
| [2046](#L2046) |  |
| [2047](#L2047) | // Find the non-empty Title values and remove them from the update |
| [2048](#L2048) | $keys = implode( ',', array\_keys( $attachment\_values ) ); |
| [2049](#L2049) | $select\_query = "SELECT ID, post\_title FROM {$wpdb->posts} WHERE ( ID IN ( {$keys} ) )"; |
| [2050](#L2050) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_fill\_title\_t() $select\_query = ' . var\_export( $select\_query, true ), 0 ); |
| [2051](#L2051) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_fill\_title\_t() get\_results = ' . var\_export( $wpdb->get\_results( $select\_query ), true ), 0 ); |
| [2052](#L2052) | foreach( $wpdb->get\_results( $select\_query ) as $existing\_value ) { |
| [2053](#L2053) | $trim =  trim( $existing\_value->post\_title ); |
| [2054](#L2054) | if ( ! empty( $trim ) ) { |
| [2055](#L2055) | unset( $attachment\_values[ (integer) $existing\_value->ID ] ); |
| [2056](#L2056) | } |
| [2057](#L2057) | } |
| [2058](#L2058) |  |
| [2059](#L2059) | // Update with new values, if any |
| [2060](#L2060) | if ( empty( $attachment\_values ) ) { |
| [2061](#L2061) | continue; |
| [2062](#L2062) | } |
| [2063](#L2063) |  |
| [2064](#L2064) | $select\_bits = ''; |
| [2065](#L2065) | $where\_bits = array(); |
| [2066](#L2066) | foreach ( $attachment\_values as $attachment => $text ) { |
| [2067](#L2067) | $select\_bits .= " WHEN ID = {$attachment} THEN '{$text}'"; |
| [2068](#L2068) | $where\_bits[] = $attachment; |
| [2069](#L2069) | } |
| [2070](#L2070) |  |
| [2071](#L2071) | $where\_bits = implode( ',', $where\_bits ); |
| [2072](#L2072) | $update\_query = "UPDATE {$wpdb->posts} SET post\_title = CASE{$select\_bits} ELSE post\_title END WHERE ID IN ( {$where\_bits} )"; |
| [2073](#L2073) | $query\_result = $wpdb->query( $update\_query ); |
| [2074](#L2074) | $update\_count += absint( $query\_result ); |
| [2075](#L2075) | } // foreach $chunk |
| [2076](#L2076) |  |
| [2077](#L2077) | return "\_fill\_title\_t() performed performed {$update\_count} update(s).\n"; |
| [2078](#L2078) | } // \_fill\_title\_t |
| [2079](#L2079) |  |
| [2080](#L2080) | /\*\* |
| [2081](#L2081) | \* Replace ALL item Title field with Product Title |
| [2082](#L2082) | \* |
| [2083](#L2083) | \* @since 1.20 |
| [2084](#L2084) | \* |
| [2085](#L2085) | \* @return      string  HTML markup for results/messages |
| [2086](#L2086) | \*/ |
| [2087](#L2087) | private static function \_replace\_title\_t() { |
| [2088](#L2088) | global $wpdb; |
| [2089](#L2089) |  |
| [2090](#L2090) | self::\_build\_product\_attachments(); |
| [2091](#L2091) | $update\_count = 0; |
| [2092](#L2092) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [2093](#L2093) | // Assign the Product Title to each attachment |
| [2094](#L2094) | $attachment\_values = array(); |
| [2095](#L2095) | foreach ( $chunk as $key => $value ) { |
| [2096](#L2096) | if ( isset( $value['\_thumbnail\_id'] ) ) { |
| [2097](#L2097) | $attachment\_values[ $value['\_thumbnail\_id'] ] = $value['post\_title']; |
| [2098](#L2098) | } |
| [2099](#L2099) |  |
| [2100](#L2100) | if ( !empty( $value['\_product\_image\_gallery'] ) ) { |
| [2101](#L2101) | $ids = explode( ',', $value['\_product\_image\_gallery'] ); |
| [2102](#L2102) | foreach( $ids as $id ) { |
| [2103](#L2103) | $attachment\_values[ $id ] = $value['post\_title']; |
| [2104](#L2104) | } |
| [2105](#L2105) | } |
| [2106](#L2106) | } |
| [2107](#L2107) |  |
| [2108](#L2108) | // Update with new values, if any |
| [2109](#L2109) | if ( empty( $attachment\_values ) ) { |
| [2110](#L2110) | continue; |
| [2111](#L2111) | } |
| [2112](#L2112) | $select\_bits = ''; |
| [2113](#L2113) | $where\_bits = array(); |
| [2114](#L2114) | foreach ( $attachment\_values as $attachment => $text ) { |
| [2115](#L2115) | $select\_bits .= " WHEN ID = {$attachment} THEN '{$text}'"; |
| [2116](#L2116) | $where\_bits[] = $attachment; |
| [2117](#L2117) | } |
| [2118](#L2118) |  |
| [2119](#L2119) | $where\_bits = implode( ',', $where\_bits ); |
| [2120](#L2120) | $update\_query = "UPDATE {$wpdb->posts} SET post\_title = CASE{$select\_bits} ELSE post\_title END WHERE ID IN ( {$where\_bits} )"; |
| [2121](#L2121) | $query\_result = $wpdb->query( $update\_query ); |
| [2122](#L2122) | $update\_count += absint( $query\_result ); |
| [2123](#L2123) | } // foreach $chunk |
| [2124](#L2124) |  |
| [2125](#L2125) | return "\_replace\_title\_t() performed {$update\_count} update(s).\n"; |
| [2126](#L2126) | } // \_replace\_title\_t |
| [2127](#L2127) |  |
| [2128](#L2128) | /\*\* |
| [2129](#L2129) | \* Process the "Apply a Content Template to ALT Text fields" actions |
| [2130](#L2130) | \* |
| [2131](#L2131) | \* @since 1.28 |
| [2132](#L2132) | \* |
| [2133](#L2133) | \* @param boolean $retain\_existing Retain existing ALT Text values |
| [2134](#L2134) | \* |
| [2135](#L2135) | \* @return array ( 'error' => $error\_message, 'delete\_count' => $delete\_count, |
| [2136](#L2136) | \*                 'insert\_count' => $insert\_count ) |
| [2137](#L2137) | \*/ |
| [2138](#L2138) | private static function \_process\_alt\_text\_ct( $retain\_existing ) { |
| [2139](#L2139) | global $wpdb; |
| [2140](#L2140) |  |
| [2141](#L2141) | $results = array( 'error' => '', 'delete\_count' => 0, 'insert\_count' => 0 ); |
| [2142](#L2142) |  |
| [2143](#L2143) | $content\_template = self::$content\_template; |
| [2144](#L2144) | if ( 'template:' == substr( $content\_template, 0, 9 ) ) { |
| [2145](#L2145) | $content\_template = substr( $content\_template, 9 ); |
| [2146](#L2146) | } |
| [2147](#L2147) |  |
| [2148](#L2148) | if ( empty( $content\_template ) ) { |
| [2149](#L2149) | $results['error'] =  "Content Template is empty; no updates done.\n"; |
| [2150](#L2150) | return $results; |
| [2151](#L2151) | } |
| [2152](#L2152) |  |
| [2153](#L2153) | // Define the template |
| [2154](#L2154) | $my\_setting = array( |
| [2155](#L2155) | 'data\_source' => 'template', |
| [2156](#L2156) | 'meta\_name' => '(' . $content\_template . ')', |
| [2157](#L2157) | 'option' => 'raw' |
| [2158](#L2158) | ); |
| [2159](#L2159) |  |
| [2160](#L2160) | self::\_build\_product\_attachments(); |
| [2161](#L2161) | $delete\_count = 0; |
| [2162](#L2162) | $insert\_count = 0; |
| [2163](#L2163) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [2164](#L2164) | $all\_values = array(); |
| [2165](#L2165) | $delete\_values = array(); |
| [2166](#L2166) | $replace\_values = array(); |
| [2167](#L2167) |  |
| [2168](#L2168) | // Evaluate the template for each attachment |
| [2169](#L2169) | foreach ( $chunk as $key => $value ) { |
| [2170](#L2170) | if ( ! empty( $value['\_thumbnail\_id'] ) ) { |
| [2171](#L2171) | $all\_values[] = $id = $value['\_thumbnail\_id']; |
| [2172](#L2172) |  |
| [2173](#L2173) | // Evaluate the template for the Product Image |
| [2174](#L2174) | $template\_value = trim( MLAOptions::mla\_get\_data\_source( $id, 'single\_attachment\_mapping', $my\_setting, NULL ) ); |
| [2175](#L2175) | if ( !empty( $template\_value ) ) { |
| [2176](#L2176) | $replace\_values[ $id ] = $template\_value; |
| [2177](#L2177) | } |
| [2178](#L2178) | } |
| [2179](#L2179) |  |
| [2180](#L2180) | if ( ! empty( $value['\_product\_image\_gallery'] ) ) { |
| [2181](#L2181) | $ids = explode( ',', $value['\_product\_image\_gallery'] ); |
| [2182](#L2182) | foreach( $ids as $id ) { |
| [2183](#L2183) | $all\_values[] = $id; |
| [2184](#L2184) |  |
| [2185](#L2185) | // Evaluate the template for a Product Gallery Image |
| [2186](#L2186) | $template\_value = trim( MLAOptions::mla\_get\_data\_source( $id, 'single\_attachment\_mapping', $my\_setting, NULL ) ); |
| [2187](#L2187) | if ( !empty( $template\_value ) ) { |
| [2188](#L2188) | $replace\_values[ $id ] = $template\_value; |
| [2189](#L2189) | } |
| [2190](#L2190) | } // each Product Gallery image |
| [2191](#L2191) | } // has gallery |
| [2192](#L2192) | } // each Product |
| [2193](#L2193) |  |
| [2194](#L2194) | if ( $retain\_existing ) { |
| [2195](#L2195) | // Find the existing ALT Text values and remove them from the update |
| [2196](#L2196) | $keys = implode( ',', array\_keys( $replace\_values ) ); |
| [2197](#L2197) | $select\_query = "SELECT post\_id, meta\_value FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [2198](#L2198) | $delete\_values = array(); |
| [2199](#L2199) | foreach( $wpdb->get\_results( $select\_query ) as $existing\_value ) { |
| [2200](#L2200) | $trim =  trim( $existing\_value->meta\_value ); |
| [2201](#L2201) | if ( empty( $trim ) ) { |
| [2202](#L2202) | $delete\_values[] = $existing\_value->post\_id; |
| [2203](#L2203) | continue; |
| [2204](#L2204) | } |
| [2205](#L2205) | unset( $replace\_values[ (integer) $existing\_value->post\_id ] ); |
| [2206](#L2206) | } |
| [2207](#L2207) | } else { |
| [2208](#L2208) | // Delete all of the existing values |
| [2209](#L2209) | $delete\_values = $all\_values; |
| [2210](#L2210) | } |
| [2211](#L2211) |  |
| [2212](#L2212) | // Delete ALT Text values that are empty or will be replaced |
| [2213](#L2213) | if ( ! empty( $delete\_values ) ) { |
| [2214](#L2214) | $keys = implode( ',', $delete\_values ); |
| [2215](#L2215) | $delete\_query = "DELETE FROM {$wpdb->postmeta} WHERE ( post\_id IN ( {$keys} ) ) AND ( meta\_key = '\_wp\_attachment\_image\_alt' )"; |
| [2216](#L2216) | $query\_result = $wpdb->query( $delete\_query ); |
| [2217](#L2217) | $delete\_count += $query\_result; |
| [2218](#L2218) | } |
| [2219](#L2219) |  |
| [2220](#L2220) | // Insert the new values |
| [2221](#L2221) | foreach ( $replace\_values as $attachment => $text ) { |
| [2222](#L2222) | $insert\_query = "INSERT INTO {$wpdb->postmeta} ( `post\_id`,`meta\_key`,`meta\_value` ) |
| [2223](#L2223) | VALUES ( {$attachment},'\_wp\_attachment\_image\_alt','{$text}' )"; |
| [2224](#L2224) | $query\_result = $wpdb->query( $insert\_query ); |
| [2225](#L2225) | $insert\_count += $query\_result; |
| [2226](#L2226) | } |
| [2227](#L2227) | } // each chunk |
| [2228](#L2228) |  |
| [2229](#L2229) | $results['delete\_count'] =  $delete\_count; |
| [2230](#L2230) | $results['insert\_count'] =  $insert\_count; |
| [2231](#L2231) | return $results; |
| [2232](#L2232) | } // \_process\_alt\_text\_ct |
| [2233](#L2233) |  |
| [2234](#L2234) | /\*\* |
| [2235](#L2235) | \* Apply a Content Template to empty ALT Text fields |
| [2236](#L2236) | \* |
| [2237](#L2237) | \* @since 1.28 |
| [2238](#L2238) | \* |
| [2239](#L2239) | \* @return      string  HTML markup for results/messages |
| [2240](#L2240) | \*/ |
| [2241](#L2241) | private static function \_fill\_alt\_text\_ct() { |
| [2242](#L2242) | $results = self::\_process\_alt\_text\_ct( true ); |
| [2243](#L2243) | if ( empty( $results['error'] ) ) { |
| [2244](#L2244) | $delete\_count = $results['delete\_count']; |
| [2245](#L2245) | $insert\_count = $results['insert\_count']; |
| [2246](#L2246) | return "\_fill\_alt\_text\_ct() performed {$delete\_count} delete(s), {$insert\_count} inserts(s).\n"; |
| [2247](#L2247) | } |
| [2248](#L2248) |  |
| [2249](#L2249) | return "\_fill\_alt\_text\_ct() " . $results['error']; |
| [2250](#L2250) | } // \_fill\_alt\_text\_ct |
| [2251](#L2251) |  |
| [2252](#L2252) | /\*\* |
| [2253](#L2253) | \* Apply a Content Template to ALL ALT Text fields |
| [2254](#L2254) | \* |
| [2255](#L2255) | \* @since 1.28 |
| [2256](#L2256) | \* |
| [2257](#L2257) | \* @return      string  HTML markup for results/messages |
| [2258](#L2258) | \*/ |
| [2259](#L2259) | private static function \_replace\_alt\_text\_ct() { |
| [2260](#L2260) | $results = self::\_process\_alt\_text\_ct( false ); |
| [2261](#L2261) | if ( empty( $results['error'] ) ) { |
| [2262](#L2262) | $delete\_count = $results['delete\_count']; |
| [2263](#L2263) | $insert\_count = $results['insert\_count']; |
| [2264](#L2264) | return "\_replace\_alt\_text\_ct() performed {$delete\_count} delete(s), {$insert\_count} inserts(s).\n"; |
| [2265](#L2265) | } |
| [2266](#L2266) |  |
| [2267](#L2267) | return "\_replace\_alt\_text\_ct() " . $results['error']; |
| [2268](#L2268) | } // \_replace\_alt\_text\_ct |
| [2269](#L2269) |  |
| [2270](#L2270) | /\*\* |
| [2271](#L2271) | \* Remove Product/Featured Image from the Product Gallery |
| [2272](#L2272) | \* |
| [2273](#L2273) | \* @since 1.10 |
| [2274](#L2274) | \* |
| [2275](#L2275) | \* @return      string  HTML markup for results/messages |
| [2276](#L2276) | \*/ |
| [2277](#L2277) | private static function \_remove\_feature() { |
| [2278](#L2278) | global $wpdb; |
| [2279](#L2279) |  |
| [2280](#L2280) | self::\_build\_product\_attachments(); |
| [2281](#L2281) |  |
| [2282](#L2282) | $update\_count = 0; |
| [2283](#L2283) | $select\_bits = ''; |
| [2284](#L2284) | $where\_bits = array(); |
| [2285](#L2285) | $chunk\_count = 0; |
| [2286](#L2286) | foreach( self::$product\_attachments as $post\_id => $result ) { |
| [2287](#L2287) | if ( empty( $result['\_thumbnail\_id'] ) ) { |
| [2288](#L2288) | continue; |
| [2289](#L2289) | } |
| [2290](#L2290) |  |
| [2291](#L2291) | $feature = (integer) $result['\_thumbnail\_id']; |
| [2292](#L2292) | $gallery = array(); |
| [2293](#L2293) | $feature\_found = false; |
| [2294](#L2294) |  |
| [2295](#L2295) | if ( ! empty( $result['\_product\_image\_gallery'] ) ) { |
| [2296](#L2296) | foreach ( explode( ',', $result['\_product\_image\_gallery'] ) as $item ) { |
| [2297](#L2297) | if ( $feature == (integer) $item ) { |
| [2298](#L2298) | $feature\_found = true; |
| [2299](#L2299) | } else { |
| [2300](#L2300) | $gallery[] = $item; |
| [2301](#L2301) | } |
| [2302](#L2302) | } // foreach gallery item |
| [2303](#L2303) | } |
| [2304](#L2304) |  |
| [2305](#L2305) | if ( $feature\_found ) { |
| [2306](#L2306) | $new\_gallery = implode( ',', $gallery ); |
| [2307](#L2307) | $select\_bits .= " WHEN post\_id = {$post\_id} THEN '{$new\_gallery}'"; |
| [2308](#L2308) | $where\_bits[] = $post\_id; |
| [2309](#L2309) |  |
| [2310](#L2310) | // Run an update when the chunk is full |
| [2311](#L2311) | if ( 25 <= ++$chunk\_count ) { |
| [2312](#L2312) | $where\_bits = implode( ',', $where\_bits ); |
| [2313](#L2313) | $update\_query = "UPDATE {$wpdb->postmeta} SET meta\_value = CASE{$select\_bits} ELSE meta\_value END WHERE post\_id IN ( {$where\_bits} ) AND meta\_key = '\_product\_image\_gallery'"; |
| [2314](#L2314) | $query\_result = $wpdb->query( $update\_query ); |
| [2315](#L2315) | $update\_count += $chunk\_count; |
| [2316](#L2316) | $select\_bits = ''; |
| [2317](#L2317) | $where\_bits = array(); |
| [2318](#L2318) | $chunk\_count = 0; |
| [2319](#L2319) | } |
| [2320](#L2320) | } // feature removed |
| [2321](#L2321) | } // foreach product |
| [2322](#L2322) |  |
| [2323](#L2323) | // Run a final update if the chunk is partially filled |
| [2324](#L2324) | if ( $chunk\_count ) { |
| [2325](#L2325) | $where\_bits = implode( ',', $where\_bits ); |
| [2326](#L2326) | $update\_query = "UPDATE {$wpdb->postmeta} SET meta\_value = CASE{$select\_bits} ELSE meta\_value END WHERE post\_id IN ( {$where\_bits} ) AND meta\_key = '\_product\_image\_gallery'"; |
| [2327](#L2327) | $query\_result = $wpdb->query( $update\_query ); |
| [2328](#L2328) | $update\_count += $chunk\_count; |
| [2329](#L2329) | } |
| [2330](#L2330) |  |
| [2331](#L2331) | return "\_remove\_feature() performed {$update\_count} update(s).\n"; |
| [2332](#L2332) | } // \_remove\_feature |
| [2333](#L2333) |  |
| [2334](#L2334) | /\*\* |
| [2335](#L2335) | \* Restore Product/Featured Image to the Product Gallery |
| [2336](#L2336) | \* |
| [2337](#L2337) | \* @since 1.10 |
| [2338](#L2338) | \* |
| [2339](#L2339) | \* @return      string  HTML markup for results/messages |
| [2340](#L2340) | \*/ |
| [2341](#L2341) | private static function \_restore\_feature() { |
| [2342](#L2342) | global $wpdb; |
| [2343](#L2343) |  |
| [2344](#L2344) | self::\_build\_product\_attachments(); |
| [2345](#L2345) |  |
| [2346](#L2346) | $update\_count = 0; |
| [2347](#L2347) | $select\_bits = ''; |
| [2348](#L2348) | $where\_bits = array(); |
| [2349](#L2349) | $chunk\_count = 0; |
| [2350](#L2350) | foreach( self::$product\_attachments as $post\_id => $result ) { |
| [2351](#L2351) | if ( empty( $result['\_thumbnail\_id'] ) ) { |
| [2352](#L2352) | continue; |
| [2353](#L2353) | } |
| [2354](#L2354) |  |
| [2355](#L2355) | $feature = (integer) $result['\_thumbnail\_id']; |
| [2356](#L2356) | $gallery = array(); |
| [2357](#L2357) | $feature\_found = false; |
| [2358](#L2358) | if ( ! empty( $result['\_product\_image\_gallery'] ) ) { |
| [2359](#L2359) | foreach ( explode( ',', $result['\_product\_image\_gallery'] ) as $item ) { |
| [2360](#L2360) | if ( $feature == (integer) $item ) { |
| [2361](#L2361) | $feature\_found = true; |
| [2362](#L2362) | } else { |
| [2363](#L2363) | $gallery[] = $item; |
| [2364](#L2364) | } |
| [2365](#L2365) | } // foreach gallery item |
| [2366](#L2366) | } |
| [2367](#L2367) |  |
| [2368](#L2368) | if ( ! $feature\_found ) { |
| [2369](#L2369) | if ( count( $gallery ) ) { |
| [2370](#L2370) | $new\_gallery = implode( ',', $gallery ) . ',' . $feature; |
| [2371](#L2371) | } else { |
| [2372](#L2372) | $new\_gallery = (string) $feature; |
| [2373](#L2373) | } |
| [2374](#L2374) |  |
| [2375](#L2375) | $select\_bits .= " WHEN post\_id = {$post\_id} THEN '{$new\_gallery}'"; |
| [2376](#L2376) | $where\_bits[] = $post\_id; |
| [2377](#L2377) |  |
| [2378](#L2378) | // Run an update when the chunk is full |
| [2379](#L2379) | if ( 25 <= ++$chunk\_count ) { |
| [2380](#L2380) | $where\_bits = implode( ',', $where\_bits ); |
| [2381](#L2381) | $update\_query = "UPDATE {$wpdb->postmeta} SET meta\_value = CASE{$select\_bits} ELSE meta\_value END WHERE post\_id IN ( {$where\_bits} ) AND meta\_key = '\_product\_image\_gallery'"; |
| [2382](#L2382) | $query\_result = $wpdb->query( $update\_query ); |
| [2383](#L2383) | $update\_count += $chunk\_count; |
| [2384](#L2384) | $select\_bits = ''; |
| [2385](#L2385) | $where\_bits = array(); |
| [2386](#L2386) | $chunk\_count = 0; |
| [2387](#L2387) | } |
| [2388](#L2388) | } // feature restored |
| [2389](#L2389) | } // foreach product |
| [2390](#L2390) |  |
| [2391](#L2391) | // Run a final update if the chunk is partially filled |
| [2392](#L2392) | if ( $chunk\_count ) { |
| [2393](#L2393) | $where\_bits = implode( ',', $where\_bits ); |
| [2394](#L2394) | $update\_query = "UPDATE {$wpdb->postmeta} SET meta\_value = CASE{$select\_bits} ELSE meta\_value END WHERE post\_id IN ( {$where\_bits} ) AND meta\_key = '\_product\_image\_gallery'"; |
| [2395](#L2395) | $query\_result = $wpdb->query( $update\_query ); |
| [2396](#L2396) | $update\_count += $chunk\_count; |
| [2397](#L2397) | } |
| [2398](#L2398) |  |
| [2399](#L2399) | return "\_restore\_feature() performed {$update\_count} update(s).\n"; |
| [2400](#L2400) | } // \_restore\_feature |
| [2401](#L2401) |  |
| [2402](#L2402) | /\*\* |
| [2403](#L2403) | \* Reverse the image order in the Product Gallery |
| [2404](#L2404) | \* |
| [2405](#L2405) | \* @since 1.10 |
| [2406](#L2406) | \* |
| [2407](#L2407) | \* @return      string  HTML markup for results/messages |
| [2408](#L2408) | \*/ |
| [2409](#L2409) | private static function \_reverse\_gallery() { |
| [2410](#L2410) | global $wpdb; |
| [2411](#L2411) |  |
| [2412](#L2412) | self::\_build\_product\_attachments(); |
| [2413](#L2413) |  |
| [2414](#L2414) | $update\_count = 0; |
| [2415](#L2415) | $select\_bits = ''; |
| [2416](#L2416) | $where\_bits = array(); |
| [2417](#L2417) | $chunk\_count = 0; |
| [2418](#L2418) | foreach( self::$product\_attachments as $post\_id => $result ) { |
| [2419](#L2419) | if ( empty( $result['\_product\_image\_gallery'] ) ) { |
| [2420](#L2420) | $gallery = array(); |
| [2421](#L2421) | } else { |
| [2422](#L2422) | $gallery = explode( ',', $result['\_product\_image\_gallery'] ); |
| [2423](#L2423) | } |
| [2424](#L2424) |  |
| [2425](#L2425) | if ( 1 < count( $gallery ) ) { |
| [2426](#L2426) | $new\_gallery = implode( ',', array\_reverse( $gallery ) ); |
| [2427](#L2427) | $select\_bits .= " WHEN post\_id = {$post\_id} THEN '{$new\_gallery}'"; |
| [2428](#L2428) | $where\_bits[] = $post\_id; |
| [2429](#L2429) |  |
| [2430](#L2430) | // Run an update when the chunk is full |
| [2431](#L2431) | if ( 25 <= ++$chunk\_count ) { |
| [2432](#L2432) | $where\_bits = implode( ',', $where\_bits ); |
| [2433](#L2433) | $update\_query = "UPDATE {$wpdb->postmeta} SET meta\_value = CASE{$select\_bits} ELSE meta\_value END WHERE post\_id IN ( {$where\_bits} ) AND meta\_key = '\_product\_image\_gallery'"; |
| [2434](#L2434) | $query\_result = $wpdb->query( $update\_query ); |
| [2435](#L2435) | $update\_count += $chunk\_count; |
| [2436](#L2436) | $select\_bits = ''; |
| [2437](#L2437) | $where\_bits = array(); |
| [2438](#L2438) | $chunk\_count = 0; |
| [2439](#L2439) | } |
| [2440](#L2440) | } // gallery reversed |
| [2441](#L2441) | } // foreach product |
| [2442](#L2442) |  |
| [2443](#L2443) | // Run a final update if the chunk is partially filled |
| [2444](#L2444) | if ( $chunk\_count ) { |
| [2445](#L2445) | $where\_bits = implode( ',', $where\_bits ); |
| [2446](#L2446) | $update\_query = "UPDATE {$wpdb->postmeta} SET meta\_value = CASE{$select\_bits} ELSE meta\_value END WHERE post\_id IN ( {$where\_bits} ) AND meta\_key = '\_product\_image\_gallery'"; |
| [2447](#L2447) | $query\_result = $wpdb->query( $update\_query ); |
| [2448](#L2448) | $update\_count += $chunk\_count; |
| [2449](#L2449) | } |
| [2450](#L2450) |  |
| [2451](#L2451) | return "\_reverse\_gallery() performed {$update\_count} update(s).\n"; |
| [2452](#L2452) | } // \_reverse\_gallery |
| [2453](#L2453) |  |
| [2454](#L2454) | /\*\* |
| [2455](#L2455) | \* Updates the postmeta table one chunk at a time. |
| [2456](#L2456) | \* |
| [2457](#L2457) | \* @since 2.10 |
| [2458](#L2458) | \* |
| [2459](#L2459) | \* @param string $meta\_key Meta value name |
| [2460](#L2460) | \* @param array  $updates  ( $post\_id => $meta\_value ) |
| [2461](#L2461) | \* @param array  $inserts  optional. ( $post\_id => $meta\_value ) |
| [2462](#L2462) | \* |
| [2463](#L2463) | \* @return      integer number of rows updated |
| [2464](#L2464) | \*/ |
| [2465](#L2465) | private static function \_update\_postmeta( $meta\_key, $updates, $inserts = array() ) { |
| [2466](#L2466) | global $wpdb; |
| [2467](#L2467) | //error\_log( \_\_LINE\_\_ . " \_update\_postmeta( $meta\_key ) updates = " . var\_export( $updates, true ), 0 ); |
| [2468](#L2468) | //error\_log( \_\_LINE\_\_ . " \_update\_postmeta( $meta\_key ) inserts = " . var\_export( $inserts, true ), 0 ); |
| [2469](#L2469) |  |
| [2470](#L2470) | $update\_count = 0; |
| [2471](#L2471) | $select\_bits = ''; |
| [2472](#L2472) | $where\_bits = array(); |
| [2473](#L2473) | $chunk\_count = 0; |
| [2474](#L2474) | foreach( $updates as $post\_id => $meta\_value ) { |
| [2475](#L2475) | $select\_bits .= " WHEN post\_id = {$post\_id} THEN '{$meta\_value}'"; |
| [2476](#L2476) | $where\_bits[] = $post\_id; |
| [2477](#L2477) |  |
| [2478](#L2478) | // Run an update when the chunk is full |
| [2479](#L2479) | if ( 25 <= ++$chunk\_count ) { |
| [2480](#L2480) | $where\_bits = implode( ',', $where\_bits ); |
| [2481](#L2481) | $query = "UPDATE {$wpdb->postmeta} SET meta\_value = CASE{$select\_bits} ELSE meta\_value END WHERE post\_id IN ( {$where\_bits} ) AND meta\_key = '{$meta\_key}'"; |
| [2482](#L2482) | $query\_result = $wpdb->query( $query ); |
| [2483](#L2483) | $update\_count += $chunk\_count; |
| [2484](#L2484) | $select\_bits = ''; |
| [2485](#L2485) | $where\_bits = array(); |
| [2486](#L2486) | $chunk\_count = 0; |
| [2487](#L2487) | } |
| [2488](#L2488) | } // foreach product |
| [2489](#L2489) |  |
| [2490](#L2490) | // Run a final update if the chunk is partially filled |
| [2491](#L2491) | if ( $chunk\_count ) { |
| [2492](#L2492) | $where\_bits = implode( ',', $where\_bits ); |
| [2493](#L2493) | $query = "UPDATE {$wpdb->postmeta} SET meta\_value = CASE{$select\_bits} ELSE meta\_value END WHERE post\_id IN ( {$where\_bits} ) AND meta\_key = '{$meta\_key}'"; |
| [2494](#L2494) | $query\_result = $wpdb->query( $query ); |
| [2495](#L2495) | $update\_count += $chunk\_count; |
| [2496](#L2496) | } |
| [2497](#L2497) |  |
| [2498](#L2498) | // Insertsd are done one row at a time |
| [2499](#L2499) | foreach( $inserts as $post\_id => $meta\_value ) { |
| [2500](#L2500) | $query = "INSERT INTO {$wpdb->postmeta} ( `post\_id`,`meta\_key`,`meta\_value` ) |
| [2501](#L2501) | VALUES ( {$post\_id},'{$meta\_key}','{$meta\_value}' )"; |
| [2502](#L2502) | $query\_result = $wpdb->query( $query ); |
| [2503](#L2503) | $update\_count++; |
| [2504](#L2504) | } // foreach product |
| [2505](#L2505) |  |
| [2506](#L2506) | return $update\_count; |
| [2507](#L2507) | } // \_update\_postmeta |
| [2508](#L2508) |  |
| [2509](#L2509) | /\*\* |
| [2510](#L2510) | \* Add product's children to Product Image and Product Gallery. |
| [2511](#L2511) | \* |
| [2512](#L2512) | \* @since 2.10 |
| [2513](#L2513) | \* |
| [2514](#L2514) | \* @return      string  HTML markup for results/messages |
| [2515](#L2515) | \*/ |
| [2516](#L2516) | private static function \_fill\_from\_children() { |
| [2517](#L2517) | self::\_build\_product\_attachments( true, true ); |
| [2518](#L2518) |  |
| [2519](#L2519) | $product\_count = count( self::$product\_attachments ); |
| [2520](#L2520) | $update\_count = 0; |
| [2521](#L2521) | $thumbnail\_count = 0; |
| [2522](#L2522) | $gallery\_count = 0; |
| [2523](#L2523) |  |
| [2524](#L2524) | $thumbnail\_updates = array(); |
| [2525](#L2525) | $thumbnail\_inserts = array(); |
| [2526](#L2526) | $gallery\_updates = array(); |
| [2527](#L2527) | $gallery\_inserts = array(); |
| [2528](#L2528) |  |
| [2529](#L2529) | foreach ( self::$product\_attachments as $ID => $images ) { |
| [2530](#L2530) | $thumbnail = isset( $images['\_thumbnail\_id'] ) ? (integer) $images['\_thumbnail\_id'] : 0; |
| [2531](#L2531) | $gallery = isset( $images['\_product\_image\_gallery'] ) ? array\_map( 'absint', explode( ',', $images['\_product\_image\_gallery'] ) ) : array(); |
| [2532](#L2532) | $children = isset( $images['children'] ) ? $images['children'] : array(); |
| [2533](#L2533) | $updated = false; |
| [2534](#L2534) |  |
| [2535](#L2535) | if ( empty( $children ) ) { |
| [2536](#L2536) | continue; |
| [2537](#L2537) | } |
| [2538](#L2538) |  |
| [2539](#L2539) | // Use the earliest child for a missing product image |
| [2540](#L2540) | if ( 0 === $thumbnail ) { |
| [2541](#L2541) | $thumbnail = reset( $children ); |
| [2542](#L2542) |  |
| [2543](#L2543) | if ( !empty( $images['\_thumbnail\_id'] ) ) { |
| [2544](#L2544) | $thumbnail\_updates[ $ID ] = $thumbnail; |
| [2545](#L2545) | } else { |
| [2546](#L2546) | $thumbnail\_inserts[ $ID ] = $thumbnail; |
| [2547](#L2547) | } |
| [2548](#L2548) |  |
| [2549](#L2549) | $updated = true; |
| [2550](#L2550) | } |
| [2551](#L2551) |  |
| [2552](#L2552) | // Make sure all children are in the gallery |
| [2553](#L2553) | $gallery\_additions = array(); |
| [2554](#L2554) | $child\_thumbnail\_in\_gallery = false; |
| [2555](#L2555) | foreach ( $children as $child ) { |
| [2556](#L2556) | if ( in\_array( $child, $gallery ) ) { |
| [2557](#L2557) | if ( $child === $thumbnail ) { |
| [2558](#L2558) | $child\_thumbnail\_in\_gallery = true; |
| [2559](#L2559) | } |
| [2560](#L2560) |  |
| [2561](#L2561) | continue; |
| [2562](#L2562) | } |
| [2563](#L2563) |  |
| [2564](#L2564) | if ( ( $child !== $thumbnail ) || self::$add\_image\_to\_gallery ) { |
| [2565](#L2565) | $gallery\_additions[] = $child; |
| [2566](#L2566) | } |
| [2567](#L2567) | } // foreach child |
| [2568](#L2568) |  |
| [2569](#L2569) | // See if we must remove the "thumbnail child" from the gallery |
| [2570](#L2570) | if ( $child\_thumbnail\_in\_gallery && !self::$add\_image\_to\_gallery ) { |
| [2571](#L2571) | unset( $gallery[ array\_search( $thumbnail, $gallery ) ] ); |
| [2572](#L2572) | $gallery\_additions = array\_merge( $gallery, $gallery\_additions ); |
| [2573](#L2573) | $gallery = array(); |
| [2574](#L2574) | } |
| [2575](#L2575) |  |
| [2576](#L2576) | if ( !empty( $gallery\_additions ) ) { |
| [2577](#L2577) | if ( !empty( $images['\_product\_image\_gallery'] ) ) { |
| [2578](#L2578) | $gallery\_updates[ $ID ] = implode( ',', array\_merge( $gallery, $gallery\_additions ) ); |
| [2579](#L2579) | } else { |
| [2580](#L2580) | $gallery\_inserts[ $ID ] = implode( ',', $gallery\_additions ); |
| [2581](#L2581) | } |
| [2582](#L2582) |  |
| [2583](#L2583) | $updated = true; |
| [2584](#L2584) | } |
| [2585](#L2585) |  |
| [2586](#L2586) | if ( $updated ) { |
| [2587](#L2587) | $update\_count++; |
| [2588](#L2588) | } |
| [2589](#L2589) | } // foreach product |
| [2590](#L2590) |  |
| [2591](#L2591) | // Apply the updates, if any |
| [2592](#L2592) | if ( !empty( $thumbnail\_updates ) || !empty( $thumbnail\_inserts ) ) { |
| [2593](#L2593) | $thumbnail\_count = self::\_update\_postmeta( '\_thumbnail\_id', $thumbnail\_updates, $thumbnail\_inserts ); |
| [2594](#L2594) | } |
| [2595](#L2595) |  |
| [2596](#L2596) | if ( !empty( $gallery\_updates ) || !empty( $gallery\_inserts ) ) { |
| [2597](#L2597) | $gallery\_count = self::\_update\_postmeta( '\_product\_image\_gallery', $gallery\_updates, $gallery\_inserts ); |
| [2598](#L2598) | } |
| [2599](#L2599) |  |
| [2600](#L2600) | return "\_fill\_from\_children examined {$product\_count} products, updated {$update\_count}, filling {$thumbnail\_count} product images and {$gallery\_count} galleries"; |
| [2601](#L2601) | } // \_fill\_from\_children |
| [2602](#L2602) |  |
| [2603](#L2603) | /\*\* |
| [2604](#L2604) | \* Use product's children to replace Product Image and Product Gallery. |
| [2605](#L2605) | \* |
| [2606](#L2606) | \* @since 2.10 |
| [2607](#L2607) | \* |
| [2608](#L2608) | \* @return      string  HTML markup for results/messages |
| [2609](#L2609) | \*/ |
| [2610](#L2610) | private static function \_replace\_from\_children() { |
| [2611](#L2611) | self::\_build\_product\_attachments( true, true ); |
| [2612](#L2612) |  |
| [2613](#L2613) | $product\_count = count( self::$product\_attachments ); |
| [2614](#L2614) | $update\_count = 0; |
| [2615](#L2615) | $thumbnail\_count = 0; |
| [2616](#L2616) | $gallery\_count = 0; |
| [2617](#L2617) |  |
| [2618](#L2618) | $thumbnail\_updates = array(); |
| [2619](#L2619) | $thumbnail\_inserts = array(); |
| [2620](#L2620) | $gallery\_updates = array(); |
| [2621](#L2621) | $gallery\_inserts = array(); |
| [2622](#L2622) |  |
| [2623](#L2623) | foreach ( self::$product\_attachments as $ID => $images ) { |
| [2624](#L2624) | $thumbnail = isset( $images['\_thumbnail\_id'] ) ? (integer) $images['\_thumbnail\_id'] : 0; |
| [2625](#L2625) | $gallery = isset( $images['\_product\_image\_gallery'] ) ? array\_map( 'absint', explode( ',', $images['\_product\_image\_gallery'] ) ) : array(); |
| [2626](#L2626) | $children = isset( $images['children'] ) ? $images['children'] : array(); |
| [2627](#L2627) | $updated = false; |
| [2628](#L2628) |  |
| [2629](#L2629) | if ( empty( $children ) ) { |
| [2630](#L2630) | if ( self::$delete\_no\_children ) { |
| [2631](#L2631) | if ( delete\_post\_meta( $ID, '\_thumbnail\_id' ) ) { |
| [2632](#L2632) | $updated = true; |
| [2633](#L2633) | $thumbnail\_count++; |
| [2634](#L2634) | } |
| [2635](#L2635) |  |
| [2636](#L2636) | if ( delete\_post\_meta( $ID, '\_product\_image\_gallery' ) ) { |
| [2637](#L2637) | $updated = true; |
| [2638](#L2638) | $gallery\_count++; |
| [2639](#L2639) | } |
| [2640](#L2640) |  |
| [2641](#L2641) | if ( $updated ) { |
| [2642](#L2642) | $update\_count++; |
| [2643](#L2643) | } |
| [2644](#L2644) | } |
| [2645](#L2645) |  |
| [2646](#L2646) | continue; |
| [2647](#L2647) | } |
| [2648](#L2648) |  |
| [2649](#L2649) | // Use the earliest child for the product image |
| [2650](#L2650) | $first\_child = reset( $children ); |
| [2651](#L2651) | if ( $first\_child !== $thumbnail ) { |
| [2652](#L2652) | if ( !empty( $images['\_thumbnail\_id'] ) ) { |
| [2653](#L2653) | $thumbnail\_updates[ $ID ] = $first\_child; |
| [2654](#L2654) | } else { |
| [2655](#L2655) | $thumbnail\_inserts[ $ID ] = $first\_child; |
| [2656](#L2656) | } |
| [2657](#L2657) |  |
| [2658](#L2658) | $updated = true; |
| [2659](#L2659) | } |
| [2660](#L2660) |  |
| [2661](#L2661) | if ( !self::$add\_image\_to\_gallery ) { |
| [2662](#L2662) | unset( $children[ $first\_child ] ); |
| [2663](#L2663) | } |
| [2664](#L2664) |  |
| [2665](#L2665) | // See if the galleries match, ignoring the order of the current gallery. |
| [2666](#L2666) | $current\_gallery = $gallery; |
| [2667](#L2667) | $gallery\_additions = $children; |
| [2668](#L2668) |  |
| [2669](#L2669) | foreach ( $current\_gallery as $index => $image ) { |
| [2670](#L2670) | if ( in\_array( $image, $gallery\_additions ) ) { |
| [2671](#L2671) | unset( $current\_gallery[ $index ] ); |
| [2672](#L2672) | unset( $gallery\_additions[ $image ] ); |
| [2673](#L2673) | } |
| [2674](#L2674) | } // foreach current gallery image |
| [2675](#L2675) |  |
| [2676](#L2676) | // If they match, both arrays will be empty |
| [2677](#L2677) | if ( !empty( $current\_gallery ) || !empty( $gallery\_additions ) ) { |
| [2678](#L2678) | if ( !empty( $images['\_product\_image\_gallery'] ) ) { |
| [2679](#L2679) | $gallery\_updates[ $ID ] = implode( ',', $children ); |
| [2680](#L2680) | } else { |
| [2681](#L2681) | $gallery\_inserts[ $ID ] = implode( ',', $children ); |
| [2682](#L2682) | } |
| [2683](#L2683) |  |
| [2684](#L2684) | $updated = true; |
| [2685](#L2685) | } |
| [2686](#L2686) |  |
| [2687](#L2687) | if ( $updated ) { |
| [2688](#L2688) | $update\_count++; |
| [2689](#L2689) | } |
| [2690](#L2690) | } // foreach product |
| [2691](#L2691) |  |
| [2692](#L2692) | // Apply the updates, if any |
| [2693](#L2693) | if ( !empty( $thumbnail\_updates ) || !empty( $thumbnail\_inserts ) ) { |
| [2694](#L2694) | $thumbnail\_count = self::\_update\_postmeta( '\_thumbnail\_id', $thumbnail\_updates, $thumbnail\_inserts ); |
| [2695](#L2695) | } |
| [2696](#L2696) |  |
| [2697](#L2697) | if ( !empty( $gallery\_updates ) || !empty( $gallery\_inserts ) ) { |
| [2698](#L2698) | $gallery\_count = self::\_update\_postmeta( '\_product\_image\_gallery', $gallery\_updates, $gallery\_inserts ); |
| [2699](#L2699) | } |
| [2700](#L2700) |  |
| [2701](#L2701) | return "\_replace\_from\_children examined {$product\_count} products, updated {$update\_count}, replacing {$thumbnail\_count} product images and {$gallery\_count} galleries"; |
| [2702](#L2702) | } // \_replace\_from\_children |
| [2703](#L2703) |  |
| [2704](#L2704) | /\*\* |
| [2705](#L2705) | \* Save the Populate Product from Product Image templates to the database |
| [2706](#L2706) | \* |
| [2707](#L2707) | \* @since 2.06 |
| [2708](#L2708) | \* |
| [2709](#L2709) | \* @return      string  HTML markup for results/messages |
| [2710](#L2710) | \*/ |
| [2711](#L2711) | private static function \_save\_upload\_children\_option() { |
| [2712](#L2712) | return self::\_save\_setting\_changes(); |
| [2713](#L2713) | } // \_save\_upload\_children\_option |
| [2714](#L2714) |  |
| [2715](#L2715) | /\*\* |
| [2716](#L2716) | \* Replace "where\_used" information in custom field "Woo Used In". |
| [2717](#L2717) | \* |
| [2718](#L2718) | \* @since 1.24 |
| [2719](#L2719) | \* |
| [2720](#L2720) | \* @return      string  HTML markup for results/messages |
| [2721](#L2721) | \*/ |
| [2722](#L2722) | private static function \_where\_used() { |
| [2723](#L2723) | global $wpdb; |
| [2724](#L2724) |  |
| [2725](#L2725) | $post\_meta\_ids = $wpdb->get\_col( $wpdb->prepare( "SELECT meta\_id FROM {$wpdb->postmeta} LEFT JOIN {$wpdb->posts} ON ( {$wpdb->posts}.ID = {$wpdb->postmeta}.post\_id ) WHERE {$wpdb->postmeta}.meta\_key = '%s' AND {$wpdb->posts}.post\_type = 'attachment'", 'Woo Used In' )); |
| [2726](#L2726) |  |
| [2727](#L2727) | if ( $delete\_count = count( $post\_meta\_ids ) ) { |
| [2728](#L2728) | foreach ( $post\_meta\_ids as $mid ) { |
| [2729](#L2729) | delete\_metadata\_by\_mid( 'post', $mid ); |
| [2730](#L2730) | } |
| [2731](#L2731) | } |
| [2732](#L2732) |  |
| [2733](#L2733) | self::\_build\_product\_attachments(); |
| [2734](#L2734) |  |
| [2735](#L2735) | $insert\_count = 0; |
| [2736](#L2736) | $thumbnail\_count = 0; |
| [2737](#L2737) | $gallery\_count = 0; |
| [2738](#L2738) | $category\_count = 0; |
| [2739](#L2739) |  |
| [2740](#L2740) | foreach( self::$attachment\_products as $post\_id => $result ) { |
| [2741](#L2741) | if ( empty( $result['\_thumbnail\_id'] ) ) { |
| [2742](#L2742) | $thumbnails = array(); |
| [2743](#L2743) | } else { |
| [2744](#L2744) | $thumbnails = $result['\_thumbnail\_id']; |
| [2745](#L2745) | } |
| [2746](#L2746) |  |
| [2747](#L2747) | if ( empty( $result['\_product\_image\_gallery'] ) ) { |
| [2748](#L2748) | $galleries = array(); |
| [2749](#L2749) | } else { |
| [2750](#L2750) | $galleries = $result['\_product\_image\_gallery']; |
| [2751](#L2751) | } |
| [2752](#L2752) |  |
| [2753](#L2753) | if ( empty( $result['category\_thumbnail'] ) ) { |
| [2754](#L2754) | $categories = array(); |
| [2755](#L2755) | } else { |
| [2756](#L2756) | $categories = $result['category\_thumbnail']; |
| [2757](#L2757) | } |
| [2758](#L2758) |  |
| [2759](#L2759) | // Compose references |
| [2760](#L2760) | $references = ''; |
| [2761](#L2761) | $thumbnail\_text = ''; |
| [2762](#L2762) | foreach ( $thumbnails as $thumbnail ) { |
| [2763](#L2763) | $thumbnail\_text .= sprintf( '(%1$d) %2$s,', $thumbnail, self::$product\_attachments[ $thumbnail ]['post\_title'] ); |
| [2764](#L2764) | } |
| [2765](#L2765) | if ( !empty( $thumbnail\_text ) ) { |
| [2766](#L2766) | $references .= 'Thumbnails: ' . $thumbnail\_text; |
| [2767](#L2767) | } |
| [2768](#L2768) |  |
| [2769](#L2769) | $gallery\_text = ''; |
| [2770](#L2770) | foreach ( $galleries as $gallery ) { |
| [2771](#L2771) | $gallery\_text .= sprintf( '(%1$d) %2$s,', $gallery, self::$product\_attachments[ $gallery ]['post\_title'] ); |
| [2772](#L2772) | } |
| [2773](#L2773) | if ( !empty( $gallery\_text ) ) { |
| [2774](#L2774) | if ( !empty( $references ) ) { |
| [2775](#L2775) | $references .= '; '; |
| [2776](#L2776) | } |
| [2777](#L2777) |  |
| [2778](#L2778) | $references .= 'Galleries: ' . $gallery\_text; |
| [2779](#L2779) | } |
| [2780](#L2780) |  |
| [2781](#L2781) | $category\_text = ''; |
| [2782](#L2782) | foreach ( $categories as $term\_id => $category ) { |
| [2783](#L2783) | $category\_text .= sprintf( '(%1$d) %2$s,', $term\_id, $category ); |
| [2784](#L2784) | } |
| [2785](#L2785) | if ( !empty( $category\_text ) ) { |
| [2786](#L2786) | if ( !empty( $references ) ) { |
| [2787](#L2787) | $references .= '; '; |
| [2788](#L2788) | } |
| [2789](#L2789) |  |
| [2790](#L2790) | $references .= 'Categories: ' . $category\_text; |
| [2791](#L2791) | } |
| [2792](#L2792) |  |
| [2793](#L2793) | if ( !empty( $references ) ) { |
| [2794](#L2794) | $thumbnail\_count += count( $thumbnails ); |
| [2795](#L2795) | $gallery\_count += count( $galleries ); |
| [2796](#L2796) | $category\_count += count( $categories ); |
| [2797](#L2797) |  |
| [2798](#L2798) | // Insert the new values |
| [2799](#L2799) | $insert\_query = "INSERT INTO {$wpdb->postmeta} ( `post\_id`,`meta\_key`,`meta\_value` ) |
| [2800](#L2800) | VALUES ( {$post\_id},'Woo Used In','{$references}' )"; |
| [2801](#L2801) | $query\_result = $wpdb->query( $insert\_query ); |
| [2802](#L2802) | $insert\_count += $query\_result; |
| [2803](#L2803) | } // found references |
| [2804](#L2804) | } // foreach product |
| [2805](#L2805) |  |
| [2806](#L2806) | return "\_where\_used() deleted {$delete\_count} items(s) in &quot;Woo Used In&quot;, then inserted {$insert\_count} items(s) with {$thumbnail\_count} thumbnail(s), {$gallery\_count} gallery(s) and {$category\_count} category thumbnails.\n"; |
| [2807](#L2807) | } // \_where\_used |
| [2808](#L2808) |  |
| [2809](#L2809) | /\*\* |
| [2810](#L2810) | \* Delete ALL Products' Product Tags assignments where a Product Image exists |
| [2811](#L2811) | \* |
| [2812](#L2812) | \* @since 1.11 |
| [2813](#L2813) | \* |
| [2814](#L2814) | \* @return      string  HTML markup for results/messages |
| [2815](#L2815) | \*/ |
| [2816](#L2816) | private static function \_clear\_product\_tags() { |
| [2817](#L2817) | return self::\_update\_product\_tags( 'clear' ); |
| [2818](#L2818) | } // \_clear\_product\_tags |
| [2819](#L2819) |  |
| [2820](#L2820) | /\*\* |
| [2821](#L2821) | \* Fill empty Product Tags assignments from Product Image Att. Tags, |
| [2822](#L2822) | \* where the Product Image exists |
| [2823](#L2823) | \* |
| [2824](#L2824) | \* @since 1.11 |
| [2825](#L2825) | \* |
| [2826](#L2826) | \* @return      string  HTML markup for results/messages |
| [2827](#L2827) | \*/ |
| [2828](#L2828) | private static function \_fill\_product\_tags() { |
| [2829](#L2829) | return self::\_update\_product\_tags( 'fill' ); |
| [2830](#L2830) | } // \_fill\_product\_tags |
| [2831](#L2831) |  |
| [2832](#L2832) | /\*\* |
| [2833](#L2833) | \* Append Product Tags assignments to ALL Products from Product Image Att. Tags, |
| [2834](#L2834) | \* where the Product Image exists |
| [2835](#L2835) | \* |
| [2836](#L2836) | \* @since 1.11 |
| [2837](#L2837) | \* |
| [2838](#L2838) | \* @return      string  HTML markup for results/messages |
| [2839](#L2839) | \*/ |
| [2840](#L2840) | private static function \_append\_product\_tags() { |
| [2841](#L2841) | return self::\_update\_product\_tags( 'append' ); |
| [2842](#L2842) | } // \_append\_product\_tags |
| [2843](#L2843) |  |
| [2844](#L2844) | /\*\* |
| [2845](#L2845) | \* Replace ALL Product Tags assignments from Product Image Att. Tags, |
| [2846](#L2846) | \* where the Product Image exists |
| [2847](#L2847) | \* |
| [2848](#L2848) | \* @since 1.11 |
| [2849](#L2849) | \* |
| [2850](#L2850) | \* @return      string  HTML markup for results/messages |
| [2851](#L2851) | \*/ |
| [2852](#L2852) | private static function \_replace\_product\_tags() { |
| [2853](#L2853) | return self::\_update\_product\_tags( 'replace' ); |
| [2854](#L2854) | } // \_replace\_product\_tags |
| [2855](#L2855) |  |
| [2856](#L2856) | /\*\* |
| [2857](#L2857) | \* Common code for the Product Tag operations |
| [2858](#L2858) | \* |
| [2859](#L2859) | \* @since 1.11 |
| [2860](#L2860) | \* |
| [2861](#L2861) | \* @param       string  Action to be taken - clear, fill, append, replace |
| [2862](#L2862) | \* |
| [2863](#L2863) | \* @return      string  HTML markup for results/messages |
| [2864](#L2864) | \*/ |
| [2865](#L2865) | private static function \_update\_product\_tags( $action ) { |
| [2866](#L2866) | global $wpdb; |
| [2867](#L2867) |  |
| [2868](#L2868) | self::\_build\_product\_attachments(); |
| [2869](#L2869) |  |
| [2870](#L2870) | $update\_count = 0; |
| [2871](#L2871) | $delete\_count = 0; |
| [2872](#L2872) | $terms\_added = 0; |
| [2873](#L2873) | $terms\_removed = 0; |
| [2874](#L2874) |  |
| [2875](#L2875) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [2876](#L2876) | // Find the Products that have Product Images |
| [2877](#L2877) | $products = array(); |
| [2878](#L2878) | foreach ( $chunk as $product\_id => $attachments ) { |
| [2879](#L2879) | if ( ! empty( $attachments['\_thumbnail\_id'] ) ) { |
| [2880](#L2880) | $id = absint( $attachments['\_thumbnail\_id'] ); |
| [2881](#L2881) | $products[ $product\_id ] = $id; |
| [2882](#L2882) | } |
| [2883](#L2883) | } |
| [2884](#L2884) |  |
| [2885](#L2885) | if ( count( $products ) == 0 ) { |
| [2886](#L2886) | continue; |
| [2887](#L2887) | } |
| [2888](#L2888) |  |
| [2889](#L2889) | switch ( $action ) { |
| [2890](#L2890) | case 'clear': |
| [2891](#L2891) | case 'fill': |
| [2892](#L2892) | // Select the attachments that have product\_tag term assignments |
| [2893](#L2893) | $ids = implode( ',', array\_keys( $products ) ); |
| [2894](#L2894) | $query = sprintf( 'SELECT DISTINCT tr.object\_id FROM %1$s as tr INNER JOIN %2$s as tt ON tr.term\_taxonomy\_id = tt.term\_taxonomy\_id WHERE ( tr.object\_id IN ( %3$s ) AND tt.taxonomy = \'product\_tag\' ) ', $wpdb->term\_relationships, $wpdb->term\_taxonomy, $ids ); |
| [2895](#L2895) | $assignments = $wpdb->get\_col( $query ); |
| [2896](#L2896) |  |
| [2897](#L2897) | if ( 'clear' == $action ) { |
| [2898](#L2898) | foreach ( $assignments as $assignment ) { |
| [2899](#L2899) | wp\_delete\_object\_term\_relationships( $assignment, 'product\_tag' ); |
| [2900](#L2900) | $update\_count++; |
| [2901](#L2901) | } // each assignment |
| [2902](#L2902) | } else { |
| [2903](#L2903) | // Find the products that have no assignments |
| [2904](#L2904) | $assignments = array\_diff\_key( $products, array\_flip( $assignments ) ); |
| [2905](#L2905) |  |
| [2906](#L2906) | foreach ( $assignments as $product\_id => $assignment ) { |
| [2907](#L2907) | $attachment\_tags = wp\_get\_object\_terms( $assignment, 'attachment\_tag', array( 'orderby' => 'none', 'fields' => 'names' ) ); |
| [2908](#L2908) |  |
| [2909](#L2909) | if ( ! empty( $attachment\_tags ) ) { |
| [2910](#L2910) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $product\_id, $attachment\_tags, 'product\_tag' ); |
| [2911](#L2911) | $terms\_added += count( $term\_taxonomy\_ids ); |
| [2912](#L2912) | $update\_count++; |
| [2913](#L2913) | } |
| [2914](#L2914) | } // each assignment |
| [2915](#L2915) | } |
| [2916](#L2916) | break; |
| [2917](#L2917) | case 'append': |
| [2918](#L2918) | case 'replace': |
| [2919](#L2919) | foreach ( $products as $product\_id => $assignment ) { |
| [2920](#L2920) | $attachment\_tags = wp\_get\_object\_terms( $assignment, 'attachment\_tag', array( 'orderby' => 'none', 'fields' => 'names' ) ); |
| [2921](#L2921) |  |
| [2922](#L2922) | if ( 'append' == $action ) { |
| [2923](#L2923) | if ( ! empty( $attachment\_tags ) ) { |
| [2924](#L2924) | $old\_term\_taxonomy\_ids = wp\_get\_object\_terms( $product\_id, 'product\_tag', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [2925](#L2925) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $product\_id, $attachment\_tags, 'product\_tag', true ); |
| [2926](#L2926) | $new\_terms = count( array\_diff( $term\_taxonomy\_ids, $old\_term\_taxonomy\_ids ) ); |
| [2927](#L2927) | if ( 0 < $new\_terms ) { |
| [2928](#L2928) | $terms\_added += $new\_terms; |
| [2929](#L2929) | $update\_count++; |
| [2930](#L2930) | } |
| [2931](#L2931) | } // common terms |
| [2932](#L2932) | } else { |
| [2933](#L2933) | if ( ! empty( $attachment\_tags ) ) { |
| [2934](#L2934) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $product\_id, $attachment\_tags, 'product\_tag', false ); |
| [2935](#L2935) | $new\_terms = count( $term\_taxonomy\_ids ); |
| [2936](#L2936) | if ( 0 < $new\_terms ) { |
| [2937](#L2937) | $terms\_added += $new\_terms; |
| [2938](#L2938) | $update\_count++; |
| [2939](#L2939) | } |
| [2940](#L2940) | } else { |
| [2941](#L2941) | $term\_taxonomy\_ids = wp\_get\_object\_terms( $product\_id, 'product\_tag', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [2942](#L2942) |  |
| [2943](#L2943) | $old\_terms = count( $term\_taxonomy\_ids ); |
| [2944](#L2944) | if ( 0 < $old\_terms ) { |
| [2945](#L2945) | $terms\_removed += $old\_terms; |
| [2946](#L2946) | $delete\_count++; |
| [2947](#L2947) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $product\_id, NULL, 'product\_tag', false ); |
| [2948](#L2948) | } |
| [2949](#L2949) | } // no common terms |
| [2950](#L2950) | } |
| [2951](#L2951) | } // each assignment |
| [2952](#L2952) | } // action |
| [2953](#L2953) | } // each chunk |
| [2954](#L2954) |  |
| [2955](#L2955) | switch ( $action ) { |
| [2956](#L2956) | case 'clear': |
| [2957](#L2957) | return "\_clear\_product\_tags() cleared {$update\_count} Product(s).\n"; |
| [2958](#L2958) | break; |
| [2959](#L2959) | case 'fill': |
| [2960](#L2960) | return "\_fill\_product\_tags() added {$terms\_added} term(s) to {$update\_count} Product(s).\n"; |
| [2961](#L2961) | break; |
| [2962](#L2962) | case 'append': |
| [2963](#L2963) | return "\_append\_product\_tags() added {$terms\_added} term(s) to {$update\_count} Product(s).\n"; |
| [2964](#L2964) | break; |
| [2965](#L2965) | case 'replace': |
| [2966](#L2966) | return "\_replace\_product\_tags() replaced {$terms\_added} term(s) in {$update\_count} Product(s), and deleted {$terms\_removed} term(s) from {$delete\_count} Product(s).\n"; |
| [2967](#L2967) | } |
| [2968](#L2968) |  |
| [2969](#L2969) | return "ERROR: Unknown \_update\_product\_tags action: {$action}"; |
| [2970](#L2970) | } // \_update\_product\_tags |
| [2971](#L2971) |  |
| [2972](#L2972) | /\*\* |
| [2973](#L2973) | \* Delete ALL Products' Product Categories assignments where a Product Image exists |
| [2974](#L2974) | \* |
| [2975](#L2975) | \* @since 1.11 |
| [2976](#L2976) | \* |
| [2977](#L2977) | \* @return      string  HTML markup for results/messages |
| [2978](#L2978) | \*/ |
| [2979](#L2979) | private static function \_clear\_product\_categories() { |
| [2980](#L2980) | return self::\_update\_product\_categories( 'clear' ); |
| [2981](#L2981) | } // \_clear\_product\_categories |
| [2982](#L2982) |  |
| [2983](#L2983) | /\*\* |
| [2984](#L2984) | \* Fill empty Product Categories assignments from Product Image Att. Tags, |
| [2985](#L2985) | \* where the Product Image Att. Tag matches an existing Product Category |
| [2986](#L2986) | \* |
| [2987](#L2987) | \* @since 1.11 |
| [2988](#L2988) | \* |
| [2989](#L2989) | \* @return      string  HTML markup for results/messages |
| [2990](#L2990) | \*/ |
| [2991](#L2991) | private static function \_fill\_product\_categories() { |
| [2992](#L2992) | return self::\_update\_product\_categories( 'fill' ); |
| [2993](#L2993) | } // \_fill\_product\_categories |
| [2994](#L2994) |  |
| [2995](#L2995) | /\*\* |
| [2996](#L2996) | \* Append Product Categories assignments to ALL Products from Product Image Att. Tags, |
| [2997](#L2997) | \* where the Product Image Att. Tag matches an existing Product Category |
| [2998](#L2998) | \* |
| [2999](#L2999) | \* @since 1.11 |
| [3000](#L3000) | \* |
| [3001](#L3001) | \* @return      string  HTML markup for results/messages |
| [3002](#L3002) | \*/ |
| [3003](#L3003) | private static function \_append\_product\_categories() { |
| [3004](#L3004) | return self::\_update\_product\_categories( 'append' ); |
| [3005](#L3005) | } // \_append\_product\_categories |
| [3006](#L3006) |  |
| [3007](#L3007) | /\*\* |
| [3008](#L3008) | \* Replace ALL Product Categories assignments from Product Image Att. Tags, |
| [3009](#L3009) | \* where the Product Image Att. Tag matches an existing Product Category |
| [3010](#L3010) | \* |
| [3011](#L3011) | \* @since 1.11 |
| [3012](#L3012) | \* |
| [3013](#L3013) | \* @return      string  HTML markup for results/messages |
| [3014](#L3014) | \*/ |
| [3015](#L3015) | private static function \_replace\_product\_categories() { |
| [3016](#L3016) | return self::\_update\_product\_categories( 'replace' ); |
| [3017](#L3017) | } // \_replace\_product\_categories |
| [3018](#L3018) |  |
| [3019](#L3019) | /\*\* |
| [3020](#L3020) | \* Common code for the Product Category operations |
| [3021](#L3021) | \* |
| [3022](#L3022) | \* @since 1.11 |
| [3023](#L3023) | \* |
| [3024](#L3024) | \* @param       string  Action to be taken - clear, fill, append, replace |
| [3025](#L3025) | \* |
| [3026](#L3026) | \* @return      string  HTML markup for results/messages |
| [3027](#L3027) | \*/ |
| [3028](#L3028) | private static function \_update\_product\_categories( $action ) { |
| [3029](#L3029) | global $wpdb; |
| [3030](#L3030) |  |
| [3031](#L3031) | self::\_build\_product\_attachments(); |
| [3032](#L3032) |  |
| [3033](#L3033) | if ( 'clear' != $action ) { |
| [3034](#L3034) | // Get the array of the Product Category term objects for comparison |
| [3035](#L3035) | $product\_categories = MLAQuery::mla\_wp\_get\_terms( 'product\_cat', array( 'orderby' => 'none', 'hide\_empty' => 0, 'fields' => 'id=>name' ) ); |
| [3036](#L3036) | } else { |
| [3037](#L3037) | $product\_categories = array(); |
| [3038](#L3038) | } |
| [3039](#L3039) |  |
| [3040](#L3040) | $update\_count = 0; |
| [3041](#L3041) | $delete\_count = 0; |
| [3042](#L3042) | $terms\_added = 0; |
| [3043](#L3043) | $terms\_removed = 0; |
| [3044](#L3044) |  |
| [3045](#L3045) | foreach ( array\_chunk( self::$product\_attachments, 25, true ) as $chunk ) { |
| [3046](#L3046) | // Find the Products that have Product Images |
| [3047](#L3047) | $products = array(); |
| [3048](#L3048) | foreach ( $chunk as $product\_id => $attachments ) { |
| [3049](#L3049) | if ( ! empty( $attachments['\_thumbnail\_id'] ) ) { |
| [3050](#L3050) | $id = absint( $attachments['\_thumbnail\_id'] ); |
| [3051](#L3051) | $products[ $product\_id ] = $id; |
| [3052](#L3052) | } |
| [3053](#L3053) | } |
| [3054](#L3054) |  |
| [3055](#L3055) | if ( count( $products ) == 0 ) { |
| [3056](#L3056) | continue; |
| [3057](#L3057) | } |
| [3058](#L3058) |  |
| [3059](#L3059) | switch ( $action ) { |
| [3060](#L3060) | case 'clear': |
| [3061](#L3061) | case 'fill': |
| [3062](#L3062) | // Select the attachments that have product\_cat term assignments |
| [3063](#L3063) | $ids = implode( ',', array\_keys( $products ) ); |
| [3064](#L3064) | $query = sprintf( 'SELECT DISTINCT tr.object\_id FROM %1$s as tr INNER JOIN %2$s as tt ON tr.term\_taxonomy\_id = tt.term\_taxonomy\_id WHERE ( tr.object\_id IN ( %3$s ) AND tt.taxonomy = \'product\_cat\' ) ', $wpdb->term\_relationships, $wpdb->term\_taxonomy, $ids ); |
| [3065](#L3065) | $assignments = $wpdb->get\_col( $query ); |
| [3066](#L3066) |  |
| [3067](#L3067) | if ( 'clear' == $action ) { |
| [3068](#L3068) | foreach ( $assignments as $assignment ) { |
| [3069](#L3069) | wp\_delete\_object\_term\_relationships( $assignment, 'product\_cat' ); |
| [3070](#L3070) | $update\_count++; |
| [3071](#L3071) | } // each assignment |
| [3072](#L3072) | } else { |
| [3073](#L3073) | // Find the products that have no assignments |
| [3074](#L3074) | $assignments = array\_diff\_key( $products, array\_flip( $assignments ) ); |
| [3075](#L3075) |  |
| [3076](#L3076) | foreach ( $assignments as $product\_id => $assignment ) { |
| [3077](#L3077) | $attachment\_tags = wp\_get\_object\_terms( $assignment, 'attachment\_tag', array( 'orderby' => 'none', 'fields' => 'names' ) ); |
| [3078](#L3078) | $common\_terms = array\_keys( array\_intersect( $product\_categories, $attachment\_tags ) ); |
| [3079](#L3079) |  |
| [3080](#L3080) | if ( ! empty( $common\_terms ) ) { |
| [3081](#L3081) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $product\_id, $common\_terms, 'product\_cat' ); |
| [3082](#L3082) | $terms\_added += count( $term\_taxonomy\_ids ); |
| [3083](#L3083) | $update\_count++; |
| [3084](#L3084) | } // common terms |
| [3085](#L3085) | } // each assignment |
| [3086](#L3086) | } |
| [3087](#L3087) | break; |
| [3088](#L3088) | case 'append': |
| [3089](#L3089) | case 'replace': |
| [3090](#L3090) | foreach ( $products as $product\_id => $assignment ) { |
| [3091](#L3091) | $attachment\_tags = wp\_get\_object\_terms( $assignment, 'attachment\_tag', array( 'orderby' => 'none', 'fields' => 'names' ) ); |
| [3092](#L3092) | $common\_terms = array\_keys( array\_intersect( $product\_categories, $attachment\_tags ) ); |
| [3093](#L3093) |  |
| [3094](#L3094) | if ( 'append' == $action ) { |
| [3095](#L3095) | if ( ! empty( $common\_terms ) ) { |
| [3096](#L3096) | $old\_term\_taxonomy\_ids = wp\_get\_object\_terms( $product\_id, 'product\_cat', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3097](#L3097) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $product\_id, $common\_terms, 'product\_cat', true ); |
| [3098](#L3098) | $new\_terms = count( array\_diff( $term\_taxonomy\_ids, $old\_term\_taxonomy\_ids ) ); |
| [3099](#L3099) | if ( 0 < $new\_terms ) { |
| [3100](#L3100) | $terms\_added += $new\_terms; |
| [3101](#L3101) | $update\_count++; |
| [3102](#L3102) | } |
| [3103](#L3103) | } // common terms |
| [3104](#L3104) | } else { |
| [3105](#L3105) | if ( ! empty( $common\_terms ) ) { |
| [3106](#L3106) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $product\_id, $common\_terms, 'product\_cat', false ); |
| [3107](#L3107) | $new\_terms = count( $term\_taxonomy\_ids ); |
| [3108](#L3108) | if ( 0 < $new\_terms ) { |
| [3109](#L3109) | $terms\_added += $new\_terms; |
| [3110](#L3110) | $update\_count++; |
| [3111](#L3111) | } |
| [3112](#L3112) | } else { |
| [3113](#L3113) | $term\_taxonomy\_ids = wp\_get\_object\_terms( $product\_id, 'product\_cat', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3114](#L3114) |  |
| [3115](#L3115) | $old\_terms = count( $term\_taxonomy\_ids ); |
| [3116](#L3116) | if ( 0 < $old\_terms ) { |
| [3117](#L3117) | $terms\_removed += $old\_terms; |
| [3118](#L3118) | $delete\_count++; |
| [3119](#L3119) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $product\_id, NULL, 'product\_cat', false ); |
| [3120](#L3120) | } |
| [3121](#L3121) | } // no common terms |
| [3122](#L3122) | } |
| [3123](#L3123) | } // each assignment |
| [3124](#L3124) | } // action |
| [3125](#L3125) | } // each chunk |
| [3126](#L3126) |  |
| [3127](#L3127) | switch ( $action ) { |
| [3128](#L3128) | case 'clear': |
| [3129](#L3129) | return "\_clear\_product\_categories() cleared {$update\_count} Product(s).\n"; |
| [3130](#L3130) | break; |
| [3131](#L3131) | case 'fill': |
| [3132](#L3132) | return "\_fill\_product\_categories() added {$terms\_added} term(s) to {$update\_count} Product(s).\n"; |
| [3133](#L3133) | break; |
| [3134](#L3134) | case 'append': |
| [3135](#L3135) | return "\_append\_product\_categories() added {$terms\_added} term(s) to {$update\_count} Product(s).\n"; |
| [3136](#L3136) | break; |
| [3137](#L3137) | case 'replace': |
| [3138](#L3138) | return "\_replace\_product\_categories() replaced {$terms\_added} term(s) in {$update\_count} Product(s), and deleted {$terms\_removed} term(s) from {$delete\_count} Product(s).\n"; |
| [3139](#L3139) | } |
| [3140](#L3140) |  |
| [3141](#L3141) | return "ERROR: Unknown \_update\_product\_categories action: {$action}"; |
| [3142](#L3142) | } // \_update\_product\_categories |
| [3143](#L3143) |  |
| [3144](#L3144) | /\*\* |
| [3145](#L3145) | \* Delete ALL Att. Categories assignments |
| [3146](#L3146) | \* |
| [3147](#L3147) | \* @since 1.11 |
| [3148](#L3148) | \* |
| [3149](#L3149) | \* @return      string  HTML markup for results/messages |
| [3150](#L3150) | \*/ |
| [3151](#L3151) | private static function \_clear\_attachment\_categories() { |
| [3152](#L3152) | global $wpdb; |
| [3153](#L3153) |  |
| [3154](#L3154) | $update\_count = 0; |
| [3155](#L3155) | $offset = 0; |
| [3156](#L3156) | $limit = 25; |
| [3157](#L3157) |  |
| [3158](#L3158) | do { |
| [3159](#L3159) | // Select a chunk of attachment IDs |
| [3160](#L3160) | $query = sprintf( 'SELECT p.ID FROM %1$s as p WHERE ( p.post\_type = \'attachment\' ) ORDER BY p.ID LIMIT %2$d, %3$d', $wpdb->posts, $offset, $limit ); |
| [3161](#L3161) | $results = $wpdb->get\_col( $query ); |
| [3162](#L3162) |  |
| [3163](#L3163) | if ( is\_array( $results ) && count( $results ) > 0 ) { |
| [3164](#L3164) | // Select the attachments that have attachment\_category term assignments |
| [3165](#L3165) | $ids = implode( ',', $results ); |
| [3166](#L3166) | $query = sprintf( 'SELECT DISTINCT tr.object\_id FROM %1$s as tr INNER JOIN %2$s as tt ON tr.term\_taxonomy\_id = tt.term\_taxonomy\_id WHERE ( tr.object\_id IN ( %3$s ) AND tt.taxonomy = \'attachment\_category\' ) ', $wpdb->term\_relationships, $wpdb->term\_taxonomy, $ids ); |
| [3167](#L3167) | $assignments = $wpdb->get\_col( $query ); |
| [3168](#L3168) |  |
| [3169](#L3169) | foreach ( $assignments as $assignment ) { |
| [3170](#L3170) | wp\_delete\_object\_term\_relationships( $assignment, 'attachment\_category' ); |
| [3171](#L3171) | $update\_count++; |
| [3172](#L3172) | } |
| [3173](#L3173) | } else { |
| [3174](#L3174) | $results = array(); |
| [3175](#L3175) | } |
| [3176](#L3176) |  |
| [3177](#L3177) | $offset += $limit; |
| [3178](#L3178) | } while ( count( $results ) == $limit ); |
| [3179](#L3179) |  |
| [3180](#L3180) | return "\_clear\_attachment\_categories() cleared {$update\_count} items(s).\n"; |
| [3181](#L3181) | } // \_clear\_attachment\_categories |
| [3182](#L3182) |  |
| [3183](#L3183) | /\*\* |
| [3184](#L3184) | \* Fill empty Att. Categories assignments from Att. Tags, |
| [3185](#L3185) | \* where the Att. Tag matches an existing Att. Category |
| [3186](#L3186) | \* |
| [3187](#L3187) | \* @since 1.11 |
| [3188](#L3188) | \* |
| [3189](#L3189) | \* @return      string  HTML markup for results/messages |
| [3190](#L3190) | \*/ |
| [3191](#L3191) | private static function \_fill\_attachment\_categories() { |
| [3192](#L3192) | global $wpdb; |
| [3193](#L3193) |  |
| [3194](#L3194) | // Get the array of the Att. Category term objects for comparison |
| [3195](#L3195) | $attachment\_categories = MLAQuery::mla\_wp\_get\_terms( 'attachment\_category', array( 'orderby' => 'none', 'hide\_empty' => 0, 'fields' => 'id=>name' ) ); |
| [3196](#L3196) |  |
| [3197](#L3197) | $update\_count = 0; |
| [3198](#L3198) | $terms\_added = 0; |
| [3199](#L3199) | $offset = 0; |
| [3200](#L3200) | $limit = 25; |
| [3201](#L3201) |  |
| [3202](#L3202) | do { |
| [3203](#L3203) | // Select a chunk of attachment IDs |
| [3204](#L3204) | $query = sprintf( 'SELECT p.ID FROM %1$s as p WHERE ( p.post\_type = \'attachment\' ) ORDER BY p.ID LIMIT %2$d, %3$d', $wpdb->posts, $offset, $limit ); |
| [3205](#L3205) | $results = $wpdb->get\_col( $query ); |
| [3206](#L3206) |  |
| [3207](#L3207) | if ( is\_array( $results ) && count( $results ) > 0 ) { |
| [3208](#L3208) | // Select the attachments that have attachment\_category term assignments |
| [3209](#L3209) | $ids = implode( ',', $results ); |
| [3210](#L3210) | $query = sprintf( 'SELECT DISTINCT tr.object\_id FROM %1$s as tr INNER JOIN %2$s as tt ON tr.term\_taxonomy\_id = tt.term\_taxonomy\_id WHERE ( tr.object\_id IN ( %3$s ) AND tt.taxonomy = \'attachment\_category\' ) ', $wpdb->term\_relationships, $wpdb->term\_taxonomy, $ids ); |
| [3211](#L3211) | $assignments = $wpdb->get\_col( $query ); |
| [3212](#L3212) |  |
| [3213](#L3213) | // find the attachments that have no assignments |
| [3214](#L3214) | $assignments = array\_diff( $results, $assignments ); |
| [3215](#L3215) |  |
| [3216](#L3216) | foreach ( $assignments as $assignment ) { |
| [3217](#L3217) | $attachment\_tags = wp\_get\_object\_terms( $assignment, 'attachment\_tag', array( 'orderby' => 'none', 'fields' => 'names' ) ); |
| [3218](#L3218) | $common\_terms = array\_keys( array\_intersect( $attachment\_categories, $attachment\_tags ) ); |
| [3219](#L3219) | if ( ! empty( $common\_terms ) ) { |
| [3220](#L3220) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $assignment, $common\_terms, 'attachment\_category' ); |
| [3221](#L3221) | $terms\_added += count( $term\_taxonomy\_ids ); |
| [3222](#L3222) | $update\_count++; |
| [3223](#L3223) | } |
| [3224](#L3224) | } |
| [3225](#L3225) | } else { |
| [3226](#L3226) | $results = array(); |
| [3227](#L3227) | } |
| [3228](#L3228) |  |
| [3229](#L3229) | $offset += $limit; |
| [3230](#L3230) | } while ( count( $results ) == $limit ); |
| [3231](#L3231) |  |
| [3232](#L3232) | return "\_fill\_attachment\_categories() added {$terms\_added} term(s) to {$update\_count} item(s).\n"; |
| [3233](#L3233) | } // \_fill\_attachment\_categories |
| [3234](#L3234) |  |
| [3235](#L3235) | /\*\* |
| [3236](#L3236) | \* Append Att. Categories assignments to ALL items from Att. Tags, |
| [3237](#L3237) | \* where the Att. Tag matches an existing Att. Category |
| [3238](#L3238) | \* |
| [3239](#L3239) | \* @since 1.11 |
| [3240](#L3240) | \* |
| [3241](#L3241) | \* @return      string  HTML markup for results/messages |
| [3242](#L3242) | \*/ |
| [3243](#L3243) | private static function \_append\_attachment\_categories() { |
| [3244](#L3244) | global $wpdb; |
| [3245](#L3245) |  |
| [3246](#L3246) | // Get the array of the Att. Category term objects for comparison |
| [3247](#L3247) | $attachment\_categories = MLAQuery::mla\_wp\_get\_terms( 'attachment\_category', array( 'orderby' => 'none', 'hide\_empty' => 0, 'fields' => 'id=>name' ) ); |
| [3248](#L3248) |  |
| [3249](#L3249) | $update\_count = 0; |
| [3250](#L3250) | $terms\_added = 0; |
| [3251](#L3251) | $offset = 0; |
| [3252](#L3252) | $limit = 25; |
| [3253](#L3253) |  |
| [3254](#L3254) | do { |
| [3255](#L3255) | // Select a chunk of attachment IDs |
| [3256](#L3256) | $query = sprintf( 'SELECT p.ID FROM %1$s as p WHERE ( p.post\_type = \'attachment\' ) ORDER BY p.ID LIMIT %2$d, %3$d', $wpdb->posts, $offset, $limit ); |
| [3257](#L3257) | $results = $wpdb->get\_col( $query ); |
| [3258](#L3258) |  |
| [3259](#L3259) | if ( is\_array( $results ) && count( $results ) > 0 ) { |
| [3260](#L3260) | // Select the attachments that have attachment\_tag term assignments |
| [3261](#L3261) | $ids = implode( ',', $results ); |
| [3262](#L3262) | $query = sprintf( 'SELECT DISTINCT tr.object\_id FROM %1$s as tr INNER JOIN %2$s as tt ON tr.term\_taxonomy\_id = tt.term\_taxonomy\_id WHERE ( tr.object\_id IN ( %3$s ) AND tt.taxonomy = \'attachment\_tag\' ) ', $wpdb->term\_relationships, $wpdb->term\_taxonomy, $ids ); |
| [3263](#L3263) | $assignments = $wpdb->get\_col( $query ); |
| [3264](#L3264) |  |
| [3265](#L3265) | foreach ( $assignments as $assignment ) { |
| [3266](#L3266) | $attachment\_tags = wp\_get\_object\_terms( $assignment, 'attachment\_tag', array( 'orderby' => 'none', 'fields' => 'names' ) ); |
| [3267](#L3267) | $common\_terms = array\_keys( array\_intersect( $attachment\_categories, $attachment\_tags ) ); |
| [3268](#L3268) | if ( ! empty( $common\_terms ) ) { |
| [3269](#L3269) | $old\_term\_taxonomy\_ids = wp\_get\_object\_terms( $assignment, 'attachment\_category', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3270](#L3270) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $assignment, $common\_terms, 'attachment\_category', true ); |
| [3271](#L3271) |  |
| [3272](#L3272) | $new\_terms = count( array\_diff( $term\_taxonomy\_ids, $old\_term\_taxonomy\_ids ) ); |
| [3273](#L3273) | if ( 0 < $new\_terms ) { |
| [3274](#L3274) | $terms\_added += $new\_terms; |
| [3275](#L3275) | $update\_count++; |
| [3276](#L3276) | } |
| [3277](#L3277) | } |
| [3278](#L3278) | } |
| [3279](#L3279) | } else { |
| [3280](#L3280) | $results = array(); |
| [3281](#L3281) | } |
| [3282](#L3282) |  |
| [3283](#L3283) | $offset += $limit; |
| [3284](#L3284) | } while ( count( $results ) == $limit ); |
| [3285](#L3285) |  |
| [3286](#L3286) | return "\_append\_attachment\_categories() added {$terms\_added} term(s) to {$update\_count} item(s).\n"; |
| [3287](#L3287) | } // \_append\_attachment\_categories |
| [3288](#L3288) |  |
| [3289](#L3289) | /\*\* |
| [3290](#L3290) | \* Replace ALL Att. Categories assignments from Att. Tags, |
| [3291](#L3291) | \* where the Att. Tag matches an existing Att. Category |
| [3292](#L3292) | \* |
| [3293](#L3293) | \* @since 1.11 |
| [3294](#L3294) | \* |
| [3295](#L3295) | \* @return      string  HTML markup for results/messages |
| [3296](#L3296) | \*/ |
| [3297](#L3297) | private static function \_replace\_attachment\_categories() { |
| [3298](#L3298) | global $wpdb; |
| [3299](#L3299) |  |
| [3300](#L3300) | // Get the array of the Att. Category term objects for comparison |
| [3301](#L3301) | $attachment\_categories = MLAQuery::mla\_wp\_get\_terms( 'attachment\_category', array( 'orderby' => 'none', 'hide\_empty' => 0, 'fields' => 'id=>name' ) ); |
| [3302](#L3302) |  |
| [3303](#L3303) | $update\_count = 0; |
| [3304](#L3304) | $delete\_count = 0; |
| [3305](#L3305) | $terms\_added = 0; |
| [3306](#L3306) | $terms\_removed = 0; |
| [3307](#L3307) |  |
| [3308](#L3308) | $offset = 0; |
| [3309](#L3309) | $limit = 25; |
| [3310](#L3310) |  |
| [3311](#L3311) | do { |
| [3312](#L3312) | // Select a chunk of attachment IDs |
| [3313](#L3313) | $query = sprintf( 'SELECT p.ID FROM %1$s as p WHERE ( p.post\_type = \'attachment\' ) ORDER BY p.ID LIMIT %2$d, %3$d', $wpdb->posts, $offset, $limit ); |
| [3314](#L3314) | $results = $wpdb->get\_col( $query ); |
| [3315](#L3315) |  |
| [3316](#L3316) | if ( is\_array( $results ) && count( $results ) > 0 ) { |
| [3317](#L3317) | foreach ( $results as $assignment ) { |
| [3318](#L3318) | $attachment\_tags = wp\_get\_object\_terms( $assignment, 'attachment\_tag', array( 'orderby' => 'none', 'fields' => 'names' ) ); |
| [3319](#L3319) | $common\_terms = array\_keys( array\_intersect( $attachment\_categories, $attachment\_tags ) ); |
| [3320](#L3320) |  |
| [3321](#L3321) | if ( ! empty( $common\_terms ) ) { |
| [3322](#L3322) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $assignment, $common\_terms, 'attachment\_category' ); |
| [3323](#L3323) | $new\_terms = count( $term\_taxonomy\_ids ); |
| [3324](#L3324) | if ( 0 < $new\_terms ) { |
| [3325](#L3325) | $terms\_added += $new\_terms; |
| [3326](#L3326) | $update\_count++; |
| [3327](#L3327) | } |
| [3328](#L3328) | } else { |
| [3329](#L3329) | $term\_taxonomy\_ids = wp\_get\_object\_terms( $assignment, 'attachment\_category', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3330](#L3330) | $old\_terms = count( $term\_taxonomy\_ids ); |
| [3331](#L3331) | if ( 0 < $old\_terms ) { |
| [3332](#L3332) | $terms\_removed += $old\_terms; |
| [3333](#L3333) | $delete\_count++; |
| [3334](#L3334) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $assignment, NULL, 'attachment\_category' ); |
| [3335](#L3335) | } |
| [3336](#L3336) | } // no common terms |
| [3337](#L3337) | } |
| [3338](#L3338) | } else { |
| [3339](#L3339) | $results = array(); |
| [3340](#L3340) | } |
| [3341](#L3341) |  |
| [3342](#L3342) | $offset += $limit; |
| [3343](#L3343) | } while ( count( $results ) == $limit ); |
| [3344](#L3344) |  |
| [3345](#L3345) | return "\_replace\_attachment\_categories() replaced {$terms\_added} term(s) in {$update\_count} item(s), and deleted {$terms\_removed} term(s) from {$delete\_count} item(s).\n"; |
| [3346](#L3346) | } // \_replace\_attachment\_categories |
| [3347](#L3347) |  |
| [3348](#L3348) | /\*\* |
| [3349](#L3349) | \* Delete ALL product\_category and/or product\_tag term assignments |
| [3350](#L3350) | \* for Media Library items. |
| [3351](#L3351) | \* |
| [3352](#L3352) | \* @since 1.26 |
| [3353](#L3353) | \* |
| [3354](#L3354) | \* @return      string  HTML markup for results/messages |
| [3355](#L3355) | \*/ |
| [3356](#L3356) | private static function \_clear\_term\_assignments() { |
| [3357](#L3357) | self::\_build\_product\_attachments( false ); |
| [3358](#L3358) |  |
| [3359](#L3359) | $item\_count = 0; |
| [3360](#L3360) | $cat\_count = 0; |
| [3361](#L3361) | $cat\_removed = 0; |
| [3362](#L3362) | $tag\_count = 0; |
| [3363](#L3363) | $tag\_removed = 0; |
| [3364](#L3364) |  |
| [3365](#L3365) | foreach ( self::$attachment\_products as $ID => $used\_in ) { |
| [3366](#L3366) | $item\_count++; |
| [3367](#L3367) |  |
| [3368](#L3368) | if ( self::$process\_category ) { |
| [3369](#L3369) | $term\_taxonomy\_ids = wp\_get\_object\_terms( $ID, 'product\_cat', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3370](#L3370) | $old\_terms = count( $term\_taxonomy\_ids ); |
| [3371](#L3371) | if ( 0 < $old\_terms ) { |
| [3372](#L3372) | $cat\_removed += $old\_terms; |
| [3373](#L3373) | $cat\_count++; |
| [3374](#L3374) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $ID, NULL, 'product\_cat' ); |
| [3375](#L3375) | } |
| [3376](#L3376) | } |
| [3377](#L3377) |  |
| [3378](#L3378) | if ( self::$process\_tag ) { |
| [3379](#L3379) | $term\_taxonomy\_ids = wp\_get\_object\_terms( $ID, 'product\_tag', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3380](#L3380) | $old\_terms = count( $term\_taxonomy\_ids ); |
| [3381](#L3381) | if ( 0 < $old\_terms ) { |
| [3382](#L3382) | $tag\_removed += $old\_terms; |
| [3383](#L3383) | $tag\_count++; |
| [3384](#L3384) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $ID, NULL, 'product\_tag' ); |
| [3385](#L3385) | } |
| [3386](#L3386) | } |
| [3387](#L3387) | } // foreach ID |
| [3388](#L3388) |  |
| [3389](#L3389) | $cat\_text = ( 1 == $cat\_removed ) ? 'category' : 'categories'; |
| [3390](#L3390) | $tag\_text = ( 1 == $tag\_removed ) ? 'tag' : 'tags'; |
| [3391](#L3391) | return "\_clear\_term\_assignments() processed {$item\_count} item(s), deleted {$cat\_removed} {$cat\_text} from {$cat\_count} item(s), and deleted {$tag\_removed} {$tag\_text} from {$tag\_count} item(s).\n"; |
| [3392](#L3392) | } // \_clear\_term\_assignments |
| [3393](#L3393) |  |
| [3394](#L3394) | /\*\* |
| [3395](#L3395) | \* Append ALL product\_category and/or product\_tag term assignments |
| [3396](#L3396) | \* for Media Library items. |
| [3397](#L3397) | \* |
| [3398](#L3398) | \* @since 1.26 |
| [3399](#L3399) | \* |
| [3400](#L3400) | \* @return      string  HTML markup for results/messages |
| [3401](#L3401) | \*/ |
| [3402](#L3402) | private static function \_copy\_term\_assignments() { |
| [3403](#L3403) | self::\_build\_product\_attachments( false ); |
| [3404](#L3404) |  |
| [3405](#L3405) | $item\_count = 0; |
| [3406](#L3406) | $cat\_count = 0; |
| [3407](#L3407) | $cat\_added = 0; |
| [3408](#L3408) | $tag\_count = 0; |
| [3409](#L3409) | $tag\_added = 0; |
| [3410](#L3410) |  |
| [3411](#L3411) | $current\_product\_cat = array(); |
| [3412](#L3412) | $current\_product\_tag = array(); |
| [3413](#L3413) |  |
| [3414](#L3414) | foreach ( self::$attachment\_products as $ID => $used\_in ) { |
| [3415](#L3415) | $item\_count++; |
| [3416](#L3416) |  |
| [3417](#L3417) | if ( self::$process\_category ) { |
| [3418](#L3418) | $current\_product\_cat = wp\_get\_object\_terms( $ID, 'product\_cat', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3419](#L3419) | } |
| [3420](#L3420) |  |
| [3421](#L3421) | if ( self::$process\_tag ) { |
| [3422](#L3422) | $current\_product\_tag = wp\_get\_object\_terms( $ID, 'product\_tag', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3423](#L3423) | } |
| [3424](#L3424) |  |
| [3425](#L3425) | $new\_product\_cat = array(); |
| [3426](#L3426) | $new\_product\_tag = array(); |
| [3427](#L3427) |  |
| [3428](#L3428) | foreach ( $used\_in as $usage => $products ) { |
| [3429](#L3429) | foreach ( $products as $product\_id ) { |
| [3430](#L3430) | if ( self::$process\_category ) { |
| [3431](#L3431) | $term\_taxonomy\_ids = wp\_get\_object\_terms( $product\_id, 'product\_cat', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3432](#L3432) | foreach( $term\_taxonomy\_ids as $new\_cat ) { |
| [3433](#L3433) | if ( in\_array( $new\_cat, $current\_product\_cat ) ) { |
| [3434](#L3434) | continue; |
| [3435](#L3435) | } |
| [3436](#L3436) |  |
| [3437](#L3437) | $new\_product\_cat[ $new\_cat ] = $new\_cat; |
| [3438](#L3438) | } |
| [3439](#L3439) | } |
| [3440](#L3440) |  |
| [3441](#L3441) | if ( self::$process\_tag ) { |
| [3442](#L3442) | $term\_taxonomy\_ids = wp\_get\_object\_terms( $product\_id, 'product\_tag', array( 'orderby' => 'none', 'fields' => 'tt\_ids' ) ); |
| [3443](#L3443) | foreach( $term\_taxonomy\_ids as $new\_tag ) { |
| [3444](#L3444) | if ( in\_array( $new\_tag, $current\_product\_tag ) ) { |
| [3445](#L3445) | continue; |
| [3446](#L3446) | } |
| [3447](#L3447) |  |
| [3448](#L3448) | $new\_product\_tag[ $new\_tag ] = $new\_tag; |
| [3449](#L3449) | } |
| [3450](#L3450) | } |
| [3451](#L3451) | } // foreach product\_id |
| [3452](#L3452) | } // foreach usage |
| [3453](#L3453) |  |
| [3454](#L3454) | if ( 0 < ( $new\_terms = count( $new\_product\_cat ) ) ) { |
| [3455](#L3455) | $cat\_added += $new\_terms; |
| [3456](#L3456) | $cat\_count++; |
| [3457](#L3457) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $ID, $new\_product\_cat, 'product\_cat', true ); |
| [3458](#L3458) | } |
| [3459](#L3459) |  |
| [3460](#L3460) | if ( 0 < ( $new\_terms = count( $new\_product\_tag ) ) ) { |
| [3461](#L3461) | $tag\_added += $new\_terms; |
| [3462](#L3462) | $tag\_count++; |
| [3463](#L3463) | $term\_taxonomy\_ids = wp\_set\_object\_terms( $ID, $new\_product\_tag, 'product\_tag', true ); |
| [3464](#L3464) | } |
| [3465](#L3465) | } // foreach ID |
| [3466](#L3466) |  |
| [3467](#L3467) | $cat\_text = ( 1 == $cat\_added ) ? 'category' : 'categories'; |
| [3468](#L3468) | $tag\_text = ( 1 == $tag\_added ) ? 'tag' : 'tags'; |
| [3469](#L3469) | return "\_copy\_term\_assignments() processed {$item\_count} item(s), added {$cat\_added} {$cat\_text} to {$cat\_count} item(s), and added {$tag\_added} {$tag\_text} to {$tag\_count} item(s).\n"; |
| [3470](#L3470) | } // \_copy\_term\_assignments |
| [3471](#L3471) |  |
| [3472](#L3472) | /\*\* |
| [3473](#L3473) | \* Restore default values for the Populate Product from Product Image templates |
| [3474](#L3474) | \* |
| [3475](#L3475) | \* @since 2.06 |
| [3476](#L3476) | \* |
| [3477](#L3477) | \* @return      string  HTML markup for results/messages |
| [3478](#L3478) | \*/ |
| [3479](#L3479) | private static function \_populate\_product\_from\_product\_image() { |
| [3480](#L3480) | global $wpdb; |
| [3481](#L3481) |  |
| [3482](#L3482) | if ( ! empty( self::$first\_product ) ) { |
| [3483](#L3483) | $lower\_bound = (integer) self::$first\_product; |
| [3484](#L3484) | } else { |
| [3485](#L3485) | $lower\_bound = 0; |
| [3486](#L3486) | } |
| [3487](#L3487) |  |
| [3488](#L3488) | if ( ! empty( self::$last\_product ) ) { |
| [3489](#L3489) | $upper\_bound = (integer) self::$last\_product; |
| [3490](#L3490) | } elseif ( $lower\_bound ) { |
| [3491](#L3491) | $upper\_bound = $lower\_bound; |
| [3492](#L3492) | } else { |
| [3493](#L3493) | $upper\_bound = 0x7FFFFFFF; |
| [3494](#L3494) | } |
| [3495](#L3495) |  |
| [3496](#L3496) | $query = sprintf( 'SELECT m.post\_id, m.meta\_key, m.meta\_value, p.post\_title, p.post\_content, p.post\_excerpt FROM %1$s as m INNER JOIN %2$s as p ON m.post\_id = p.ID WHERE ( p.post\_type = \'product\' ) AND ( p.ID >= %3$d ) AND ( p.ID <= %4$d) AND ( m.meta\_key IN ( \'\_thumbnail\_id\', \'\_sku\' ) ) GROUP BY m.post\_id, m.meta\_id ORDER BY m.post\_id', $wpdb->postmeta, $wpdb->posts, $lower\_bound, $upper\_bound ); |
| [3497](#L3497) | $results = $wpdb->get\_results( $query ); |
| [3498](#L3498) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_populate\_product\_from\_product\_image() $results = ' . var\_export( $results, true ), 0 ); |
| [3499](#L3499) |  |
| [3500](#L3500) | $old\_values = array(); |
| [3501](#L3501) | foreach ( $results as $result ) { |
| [3502](#L3502) | $value = isset( $old\_values[ $result->post\_id ] ) ? $old\_values[ $result->post\_id ] : array(); |
| [3503](#L3503) | $value['post\_title'] = $result->post\_title; |
| [3504](#L3504) | $value['post\_content'] = $result->post\_content; |
| [3505](#L3505) | $value['post\_excerpt'] = $result->post\_excerpt; |
| [3506](#L3506) | $value[$result->meta\_key] = $result->meta\_value; |
| [3507](#L3507) | $old\_values[ $result->post\_id ] = $value; |
| [3508](#L3508) | } |
| [3509](#L3509) |  |
| [3510](#L3510) | unset( $reaults, $result ); |
| [3511](#L3511) |  |
| [3512](#L3512) | foreach( $old\_values as $product\_id => $value ) { |
| [3513](#L3513) | // Find existing product\_cat terms |
| [3514](#L3514) | $terms = get\_object\_term\_cache( $product\_id, 'product\_cat' ); |
| [3515](#L3515) | if ( false === $terms ) { |
| [3516](#L3516) | $terms = wp\_get\_object\_terms( $product\_id, 'product\_cat' ); |
| [3517](#L3517) | if ( is\_wp\_error( $terms ) ) { |
| [3518](#L3518) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $product\_id, 'product\_cat' ) terms error = " . var\_export( $terms->get\_error\_messages(), true ), 0 ); |
| [3519](#L3519) | continue; |
| [3520](#L3520) | } |
| [3521](#L3521) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $product\_id, 'product\_cat' ) terms = " . var\_export( $terms, true ), 0 ); |
| [3522](#L3522) |  |
| [3523](#L3523) | wp\_cache\_add( $product\_id, $terms, 'product\_cat' . '\_relationships' ); |
| [3524](#L3524) | } |
| [3525](#L3525) |  |
| [3526](#L3526) | foreach ( $terms as $term ) { |
| [3527](#L3527) | $old\_values[ $product\_id ]['product\_cat\_terms'][] = $term->term\_id; |
| [3528](#L3528) | } |
| [3529](#L3529) | sort( $old\_values[ $product\_id ]['product\_cat\_terms'] ); |
| [3530](#L3530) |  |
| [3531](#L3531) | // Find existing product\_tag terms |
| [3532](#L3532) | $terms = get\_object\_term\_cache( $product\_id, 'product\_tag' ); |
| [3533](#L3533) | if ( false === $terms ) { |
| [3534](#L3534) | $terms = wp\_get\_object\_terms( $product\_id, 'product\_tag' ); |
| [3535](#L3535) | if ( is\_wp\_error( $terms ) ) { |
| [3536](#L3536) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $product\_id, 'product\_cat' ) terms error = " . var\_export( $terms->get\_error\_messages(), true ), 0 ); |
| [3537](#L3537) | continue; |
| [3538](#L3538) | } |
| [3539](#L3539) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $product\_id, 'product\_cat' ) terms = " . var\_export( $terms, true ), 0 ); |
| [3540](#L3540) |  |
| [3541](#L3541) | wp\_cache\_add( $product\_id, $terms, 'product\_tag' . '\_relationships' ); |
| [3542](#L3542) | } |
| [3543](#L3543) |  |
| [3544](#L3544) | foreach ( $terms as $term ) { |
| [3545](#L3545) | $old\_values[ $product\_id ]['product\_tag\_terms'][] = $term->term\_id; |
| [3546](#L3546) | } |
| [3547](#L3547) | sort( $old\_values[ $product\_id ]['product\_tag\_terms'] ); |
| [3548](#L3548) | } // foreach old\_values ID |
| [3549](#L3549) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_populate\_product\_from\_product\_image() $old\_values = ' . var\_export( $old\_values, true ), 0 ); |
| [3550](#L3550) |  |
| [3551](#L3551) | $product\_count = 0; |
| [3552](#L3552) | $updated\_count= 0; |
| [3553](#L3553) |  |
| [3554](#L3554) | // Define the template |
| [3555](#L3555) | $my\_setting = array( |
| [3556](#L3556) | 'data\_source' => 'template', |
| [3557](#L3557) | 'meta\_name' => '', |
| [3558](#L3558) | 'option' => 'raw' |
| [3559](#L3559) | ); |
| [3560](#L3560) |  |
| [3561](#L3561) | foreach ( $old\_values as $product\_id => $value ) { |
| [3562](#L3562) | $product\_count++; |
| [3563](#L3563) | $update\_count = 0; |
| [3564](#L3564) | $attachment\_id = $value['\_thumbnail\_id']; |
| [3565](#L3565) | $replace\_values = array(); |
| [3566](#L3566) |  |
| [3567](#L3567) | // Evaluate the template for the Product Name (post\_title) |
| [3568](#L3568) | if ( !empty( self::$settings[self::NAME\_TEMPLATE] ) ) { |
| [3569](#L3569) | $my\_setting['meta\_name'] = '(' . self::$settings[self::NAME\_TEMPLATE] . ')'; |
| [3570](#L3570) |  |
| [3571](#L3571) | $template\_value = trim( MLAOptions::mla\_get\_data\_source( $attachment\_id, 'single\_attachment\_mapping', $my\_setting, NULL ) ); |
| [3572](#L3572) | if ( !empty( $template\_value ) && ( $template\_value !== $value['post\_title'] ) ) { |
| [3573](#L3573) | $replace\_values[ 'post\_title' ] = $template\_value; |
| [3574](#L3574) | } |
| [3575](#L3575) | } |
| [3576](#L3576) |  |
| [3577](#L3577) | // Evaluate the template for the Product Description (post\_content) |
| [3578](#L3578) | if ( !empty( self::$settings[self::DESCRIPTION\_TEMPLATE] ) ) { |
| [3579](#L3579) | $my\_setting['meta\_name'] = '(' . self::$settings[self::DESCRIPTION\_TEMPLATE] . ')'; |
| [3580](#L3580) |  |
| [3581](#L3581) | $template\_value = trim( MLAOptions::mla\_get\_data\_source( $attachment\_id, 'single\_attachment\_mapping', $my\_setting, NULL ) ); |
| [3582](#L3582) | if ( !empty( $template\_value ) && ( $template\_value !== $value['post\_content'] ) ) { |
| [3583](#L3583) | $replace\_values[ 'post\_content' ] = $template\_value; |
| [3584](#L3584) | } |
| [3585](#L3585) | } |
| [3586](#L3586) |  |
| [3587](#L3587) | // Evaluate the template for the Product Short Description (post\_excerpt) |
| [3588](#L3588) | if ( !empty( self::$settings[self::SHORT\_DESCRIPTION\_TEMPLATE] ) ) { |
| [3589](#L3589) | $my\_setting['meta\_name'] = '(' . self::$settings[self::SHORT\_DESCRIPTION\_TEMPLATE] . ')'; |
| [3590](#L3590) |  |
| [3591](#L3591) | $template\_value = trim( MLAOptions::mla\_get\_data\_source( $attachment\_id, 'single\_attachment\_mapping', $my\_setting, NULL ) ); |
| [3592](#L3592) | if ( !empty( $template\_value ) && ( $template\_value !== $value['post\_excerpt'] ) ) { |
| [3593](#L3593) | $replace\_values[ 'post\_excerpt' ] = $template\_value; |
| [3594](#L3594) | } |
| [3595](#L3595) | } |
| [3596](#L3596) |  |
| [3597](#L3597) | //error\_log( \_\_LINE\_\_ . ' Woo\_Fixit::\_populate\_product\_from\_product\_image() $replace\_values = ' . var\_export( $replace\_values, true ), 0 ); |
| [3598](#L3598) | $update\_count = count( $replace\_values ); |
| [3599](#L3599) | if ( $update\_count ) { |
| [3600](#L3600) | $replace\_values['ID'] = $product\_id; |
| [3601](#L3601) | $result = wp\_update\_post( $replace\_values ); |
| [3602](#L3602) | } else { |
| [3603](#L3603) | $result = NULL; |
| [3604](#L3604) | } |
| [3605](#L3605) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $update\_count ) result = " . var\_export( $result, true ), 0 ); |
| [3606](#L3606) |  |
| [3607](#L3607) | // Evaluate the template for the Product Categories ( taxonomy product\_cat ) |
| [3608](#L3608) | if ( !empty( self::$settings[self::CATEGORIES\_TEMPLATE] ) ) { |
| [3609](#L3609) | $my\_setting['meta\_name'] = '(' . self::$settings[self::CATEGORIES\_TEMPLATE] . ')'; |
| [3610](#L3610) |  |
| [3611](#L3611) | $template\_value = trim( MLAOptions::mla\_get\_data\_source( $attachment\_id, 'single\_attachment\_mapping', $my\_setting, NULL ) ); |
| [3612](#L3612) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $update\_count ) template\_value = " . var\_export( $template\_value, true ), 0 ); |
| [3613](#L3613) | if ( !empty( $template\_value ) ) { |
| [3614](#L3614) | /\* |
| [3615](#L3615) | \* Convert term names to term IDs, to avoid ambiguity. |
| [3616](#L3616) | \* Adapted from edit\_post() in /wp-admin/includes/post.php |
| [3617](#L3617) | \*/ |
| [3618](#L3618) | $comma = \_x( ',', 'tag delimiter' ); |
| [3619](#L3619) | if ( ',' !== $comma ) { |
| [3620](#L3620) | $template\_value = str\_replace( $comma, ',', $template\_value ); |
| [3621](#L3621) | } |
| [3622](#L3622) | $tags = explode( ',', trim( $template\_value, " \n\t\r\0\x0B," ) ); |
| [3623](#L3623) |  |
| [3624](#L3624) | $clean\_terms = array(); |
| [3625](#L3625) | foreach ( $tags as $tag ) { |
| [3626](#L3626) | // Empty terms are invalid input. |
| [3627](#L3627) | if ( empty( $tag ) ) { |
| [3628](#L3628) | continue; |
| [3629](#L3629) | } |
| [3630](#L3630) |  |
| [3631](#L3631) | $tag = trim( $tag ); |
| [3632](#L3632) | $\_term = MLAQuery::mla\_wp\_get\_terms( 'product\_cat', array( |
| [3633](#L3633) | 'name' => $tag, |
| [3634](#L3634) | 'fields' => 'ids', |
| [3635](#L3635) | 'hide\_empty' => false, |
| [3636](#L3636) | ) ); |
| [3637](#L3637) |  |
| [3638](#L3638) | if ( ! empty( $\_term ) ) { |
| [3639](#L3639) | $clean\_terms[] = intval( $\_term[0] ); |
| [3640](#L3640) | } else { |
| [3641](#L3641) | // No existing term was found, so pass the string. A new term will be created. |
| [3642](#L3642) | $clean\_terms[] = $tag; |
| [3643](#L3643) | } |
| [3644](#L3644) | } |
| [3645](#L3645) |  |
| [3646](#L3646) | sort( $clean\_terms ); |
| [3647](#L3647) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $update\_count ) clean\_terms = " . var\_export( $clean\_terms, true ), 0 ); |
| [3648](#L3648) | if ( $clean\_terms !== $value['product\_cat\_terms'] ) { |
| [3649](#L3649) | $result = wp\_set\_object\_terms( $product\_id, $clean\_terms, 'product\_cat' ); |
| [3650](#L3650) | if ( is\_wp\_error( $result ) ) { |
| [3651](#L3651) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $product\_id, 'product\_cat' ) wp\_get\_object\_terms error = " . var\_export( $result->get\_error\_messages(), true ), 0 ); |
| [3652](#L3652) | } else { |
| [3653](#L3653) | $update\_count++; |
| [3654](#L3654) | } |
| [3655](#L3655) | } // terms unequal |
| [3656](#L3656) | } // $template\_value |
| [3657](#L3657) | } // CATEGORIES\_TEMPLATE |
| [3658](#L3658) |  |
| [3659](#L3659) | // Evaluate the template for the Product Tags ( taxonomy product\_tag ) |
| [3660](#L3660) | if ( !empty( self::$settings[self::TAGS\_TEMPLATE] ) ) { |
| [3661](#L3661) | $my\_setting['meta\_name'] = '(' . self::$settings[self::TAGS\_TEMPLATE] . ')'; |
| [3662](#L3662) |  |
| [3663](#L3663) | $template\_value = trim( MLAOptions::mla\_get\_data\_source( $attachment\_id, 'single\_attachment\_mapping', $my\_setting, NULL ) ); |
| [3664](#L3664) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $update\_count ) template\_value = " . var\_export( $template\_value, true ), 0 ); |
| [3665](#L3665) | if ( !empty( $template\_value ) ) { |
| [3666](#L3666) | /\* |
| [3667](#L3667) | \* Convert term names to term IDs, to avoid ambiguity. |
| [3668](#L3668) | \* Adapted from edit\_post() in /wp-admin/includes/post.php |
| [3669](#L3669) | \*/ |
| [3670](#L3670) | $comma = \_x( ',', 'tag delimiter' ); |
| [3671](#L3671) | if ( ',' !== $comma ) { |
| [3672](#L3672) | $template\_value = str\_replace( $comma, ',', $template\_value ); |
| [3673](#L3673) | } |
| [3674](#L3674) | $tags = explode( ',', trim( $template\_value, " \n\t\r\0\x0B," ) ); |
| [3675](#L3675) |  |
| [3676](#L3676) | $clean\_terms = array(); |
| [3677](#L3677) | foreach ( $tags as $tag ) { |
| [3678](#L3678) | // Empty terms are invalid input. |
| [3679](#L3679) | if ( empty( $tag ) ) { |
| [3680](#L3680) | continue; |
| [3681](#L3681) | } |
| [3682](#L3682) |  |
| [3683](#L3683) | $tag = trim( $tag ); |
| [3684](#L3684) | $\_term = MLAQuery::mla\_wp\_get\_terms( 'product\_tag', array( |
| [3685](#L3685) | 'name' => $tag, |
| [3686](#L3686) | 'fields' => 'ids', |
| [3687](#L3687) | 'hide\_empty' => false, |
| [3688](#L3688) | ) ); |
| [3689](#L3689) |  |
| [3690](#L3690) | if ( ! empty( $\_term ) ) { |
| [3691](#L3691) | $clean\_terms[] = intval( $\_term[0] ); |
| [3692](#L3692) | } else { |
| [3693](#L3693) | // No existing term was found, so pass the string. A new term will be created. |
| [3694](#L3694) | $clean\_terms[] = $tag; |
| [3695](#L3695) | } |
| [3696](#L3696) | } |
| [3697](#L3697) |  |
| [3698](#L3698) | sort( $clean\_terms ); |
| [3699](#L3699) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $update\_count ) clean\_terms = " . var\_export( $clean\_terms, true ), 0 ); |
| [3700](#L3700) | if ( $clean\_terms !== $value['product\_tag\_terms'] ) { |
| [3701](#L3701) | $result = wp\_set\_object\_terms( $product\_id, $clean\_terms, 'product\_tag' ); |
| [3702](#L3702) | if ( is\_wp\_error( $result ) ) { |
| [3703](#L3703) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $product\_id, 'product\_tag' ) wp\_get\_object\_terms error = " . var\_export( $result->get\_error\_messages(), true ), 0 ); |
| [3704](#L3704) | } else { |
| [3705](#L3705) | $update\_count++; |
| [3706](#L3706) | } |
| [3707](#L3707) | } // terms unequal |
| [3708](#L3708) | } // $template\_value |
| [3709](#L3709) | } // TAGS\_TEMPLATE |
| [3710](#L3710) |  |
| [3711](#L3711) | // Evaluate the template for the Product SKU ( postmeta \_sku ) |
| [3712](#L3712) | if ( !empty( self::$settings[self::SKU\_TEMPLATE] ) ) { |
| [3713](#L3713) | $my\_setting['meta\_name'] = '(' . self::$settings[self::SKU\_TEMPLATE] . ')'; |
| [3714](#L3714) |  |
| [3715](#L3715) | $template\_value = trim( MLAOptions::mla\_get\_data\_source( $attachment\_id, 'single\_attachment\_mapping', $my\_setting, NULL ) ); |
| [3716](#L3716) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $update\_count ) template\_value = " . var\_export( $template\_value, true ), 0 ); |
| [3717](#L3717) | if ( !empty( $template\_value ) && ( $template\_value !== $value['\_sku'] ) ) { |
| [3718](#L3718) | $result = update\_post\_meta( $product\_id, '\_sku', $template\_value ); |
| [3719](#L3719) | $update\_count++; |
| [3720](#L3720) | } |
| [3721](#L3721) | //error\_log( \_\_LINE\_\_ . " Woo\_Fixit::\_populate\_product\_from\_product\_image( $update\_count ) SKU result = " . var\_export( $result, true ), 0 ); |
| [3722](#L3722) | } // SKU\_TEMPLATE |
| [3723](#L3723) |  |
| [3724](#L3724) | if ( $update\_count ) { |
| [3725](#L3725) | $updated\_count++; |
| [3726](#L3726) | } |
| [3727](#L3727) | } // foreach product |
| [3728](#L3728) |  |
| [3729](#L3729) | return "Populate Product examined {$product\_count} Product(s) and updated {$updated\_count} Product(s)."; |
| [3730](#L3730) | } // \_populate\_product\_from\_product\_image |
| [3731](#L3731) |  |
| [3732](#L3732) | /\*\* |
| [3733](#L3733) | \* Save the Populate Product from Product Image templates to the database |
| [3734](#L3734) | \* |
| [3735](#L3735) | \* @since 2.06 |
| [3736](#L3736) | \* |
| [3737](#L3737) | \* @return      string  HTML markup for results/messages |
| [3738](#L3738) | \*/ |
| [3739](#L3739) | private static function \_save\_product\_templates() { |
| [3740](#L3740) | return self::\_save\_setting\_changes(); |
| [3741](#L3741) | } // \_save\_product\_templates |
| [3742](#L3742) |  |
| [3743](#L3743) | /\*\* |
| [3744](#L3744) | \* Load the Populate Product from Product Image templates from the database |
| [3745](#L3745) | \* |
| [3746](#L3746) | \* @since 2.06 |
| [3747](#L3747) | \* |
| [3748](#L3748) | \* @return      string  HTML markup for results/messages |
| [3749](#L3749) | \*/ |
| [3750](#L3750) | private static function \_load\_product\_templates() { |
| [3751](#L3751) | $result = self::\_load\_settings(); |
| [3752](#L3752) |  |
| [3753](#L3753) | return $result; |
| [3754](#L3754) | } // \_load\_product\_templates |
| [3755](#L3755) |  |
| [3756](#L3756) | /\*\* |
| [3757](#L3757) | \* Restore default values for the Populate Product from Product Image templates |
| [3758](#L3758) | \* |
| [3759](#L3759) | \* @since 2.06 |
| [3760](#L3760) | \* |
| [3761](#L3761) | \* @return      string  HTML markup for results/messages |
| [3762](#L3762) | \*/ |
| [3763](#L3763) | private static function \_restore\_product\_template\_defaults() { |
| [3764](#L3764) | self::$populate\_pi\_pg\_on\_upload\_attr = self::DEFAULT\_POPULATE\_PI\_PG\_ON\_UPLOAD ? ' checked="checked" ' : ' '; |
| [3765](#L3765) | self::$populate\_pi\_pg\_on\_mmmw\_attr = self::DEFAULT\_POPULATE\_PI\_PG\_ON\_MMMW ? ' checked="checked" ' : ' '; |
| [3766](#L3766) |  |
| [3767](#L3767) | self::$populate\_on\_add\_attr = self::DEFAULT\_POPULATE\_ON\_ADD ? ' checked="checked" ' : ' '; |
| [3768](#L3768) | self::$populate\_on\_update\_attr = self::DEFAULT\_POPULATE\_ON\_UPDATE ? ' checked="checked" ' : ' '; |
| [3769](#L3769) |  |
| [3770](#L3770) | return self::\_delete\_settings(); |
| [3771](#L3771) | } // \_restore\_product\_template\_defaults |
| [3772](#L3772) | } //Woo\_Fixit |
| [3773](#L3773) |  |
| [3774](#L3774) | // Install the submenu at an early opportunity |
| [3775](#L3775) | add\_action('init', 'Woo\_Fixit::initialize'); |
| [3776](#L3776) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/media-library-assistant/trunk/examples/plugins/woofixit.php?format=txt)
* [Original Format](/export/3222480/media-library-assistant/trunk/examples/plugins/woofixit.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_f4c5a188_20250114_213139.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3215759)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3215758 "Changeset 3215758")
* [Next Changeset](/changeset/3215760 "Changeset 3215760") →

---

# Changeset 3215759

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
01/01/2025 09:14:14 PM
([13 days](/timeline?from=2025-01-01T21%3A14%3A14Z&precision=second "See timeline at 01/01/2025 09:14:14 PM") ago)

Author:
dglingren
Message:

For the Media/Library Grid mode, an incompatibility with the Enhanced Media Library plugin has been eliminated.

Location:
[media-library-assistant/trunk](/browser/media-library-assistant/trunk?rev=3215759)
Files:

4 edited

* [includes/class-mla-core.php](/browser/media-library-assistant/trunk/includes/class-mla-core.php?rev=3215759 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [includes/class-mla-media-modal-ajax.php](/browser/media-library-assistant/trunk/includes/class-mla-media-modal-ajax.php?rev=3215759 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [index.php](/browser/media-library-assistant/trunk/index.php?rev=3215759 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [readme.txt](/browser/media-library-assistant/trunk/readme.txt?rev=3215759 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [media-library-assistant/trunk/includes/class-mla-core.php](/changeset/3215759/media-library-assistant/trunk/includes/class-mla-core.php "Show the changeset 3215759 restricted to media-library-assistant/trunk/includes/class-mla-core.php")

  | [r3214567](/browser/media-library-assistant/trunk/includes/class-mla-core.php?rev=3214567#L31 "Show revision 3214567 of this file in browser") | [r3215759](/browser/media-library-assistant/trunk/includes/class-mla-core.php?rev=3215759#L31 "Show revision 3215759 of this file in browser") |  |
  | --- | --- | --- |
  | 31 | 31 | \* @var string |
  | 32 | 32 | \*/ |
  | 33 |  | const MLA\_DEVELOPMENT\_VERSION = ''; |
  |  | 33 | const MLA\_DEVELOPMENT\_VERSION = '20250101'; |
  | 34 | 34 |  |
  | 35 | 35 | /\*\* |
* ## [media-library-assistant/trunk/includes/class-mla-media-modal-ajax.php](/changeset/3215759/media-library-assistant/trunk/includes/class-mla-media-modal-ajax.php "Show the changeset 3215759 restricted to media-library-assistant/trunk/includes/class-mla-media-modal-ajax.php")

  | [r2990225](/browser/media-library-assistant/trunk/includes/class-mla-media-modal-ajax.php?rev=2990225#L70 "Show revision 2990225 of this file in browser") | [r3215759](/browser/media-library-assistant/trunk/includes/class-mla-media-modal-ajax.php?rev=3215759#L70 "Show revision 3215759 of this file in browser") |  |
  | --- | --- | --- |
  | 70 | 70 | \*/ |
  | 71 | 71 | $enhanced\_taxonomies = array(); |
  |  | 72 | $mla\_supported\_taxonomies = array(); |
  | 72 | 73 | foreach ( get\_taxonomies( array ( 'show\_ui' => true ), 'objects' ) as $key => $value ) { |
  | 73 | 74 | if ( MLACore::mla\_taxonomy\_support( $key ) ) { |
  |  | 75 | $mla\_supported\_taxonomies[] = $key; |
  |  | 76 |  |
  | 74 | 77 | if ( ! $use\_checklist = $value->hierarchical ) { |
  | 75 | 78 | $use\_checklist = MLACore::mla\_taxonomy\_support( $key, 'flat-checklist' ); |
  | […](/browser/media-library-assistant/trunk/includes/class-mla-media-modal-ajax.php?rev=2990225#L161) | […](/browser/media-library-assistant/trunk/includes/class-mla-media-modal-ajax.php?rev=3215759#L164) |  |
  | 161 | 164 |  |
  | 162 | 165 | if ( isset( $\_REQUEST['tax\_input'] ) ) { |
  | 163 |  | unset( $\_REQUEST['tax\_input'] ); |
  | 164 |  | unset( $\_POST['tax\_input'] ); |
  |  | 166 | // Enhanced Media Library uses tax\_input, so we must remove only the taxonomies MLA supports |
  |  | 167 | if ( defined('EML\_VERSION') ) { |
  |  | 168 | foreach ( $mla\_supported\_taxonomies as $taxonomy ) { |
  |  | 169 | unset( $\_REQUEST['tax\_input'][ $taxonomy ] ); |
  |  | 170 | unset( $\_POST['tax\_input'][ $taxonomy ] ); |
  |  | 171 | } |
  |  | 172 | } else { |
  |  | 173 | unset( $\_REQUEST['tax\_input'] ); |
  |  | 174 | unset( $\_POST['tax\_input'] ); |
  |  | 175 | } |
  | 165 | 176 | } |
  | 166 | 177 |  |
* ## [media-library-assistant/trunk/index.php](/changeset/3215759/media-library-assistant/trunk/index.php "Show the changeset 3215759 restricted to media-library-assistant/trunk/index.php")

  | [r3214567](/browser/media-library-assistant/trunk/index.php?rev=3214567#L16 "Show revision 3214567 of this file in browser") | [r3215759](/browser/media-library-assistant/trunk/index.php?rev=3215759#L16 "Show revision 3215759 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | Plugin Name: Media Library Assistant |
  | 17 | 17 | Plugin URI: http://davidlingren.com/#two |
  | 18 |  | Description: Enhances the Media Library; powerful [mla\_gallery] [mla\_tag\_cloud] [mla\_term\_list], taxonomy support, IPTC/EXIF/XMP/PDF processing, bulk/quick edit. |
  |  | 18 | Description: 20250101 Enhances the Media Library; powerful [mla\_gallery] [mla\_tag\_cloud] [mla\_term\_list], taxonomy support, IPTC/EXIF/XMP/PDF processing, bulk/quick edit. |
  | 19 | 19 | Version: 3.24 |
  | 20 | 20 | Requires at least: 4.1 |
* ## [media-library-assistant/trunk/readme.txt](/changeset/3215759/media-library-assistant/trunk/readme.txt "Show the changeset 3215759 restricted to media-library-assistant/trunk/readme.txt")

  | [r3214567](/browser/media-library-assistant/trunk/readme.txt?rev=3214567#L187 "Show revision 3214567 of this file in browser") | [r3215759](/browser/media-library-assistant/trunk/readme.txt?rev=3215759#L187 "Show revision 3215759 of this file in browser") |  |
  | --- | --- | --- |
  | 187 | 187 |  |
  | 188 | 188 | == Changelog == |
  |  | 189 |  |
  |  | 190 | = 3.25 = |
  |  | 191 | \* Fix: For the Media/Library Grid mode, an incompatibility with the Enhanced Media Library plugin has been eliminated. |
  | 189 | 192 |  |
  | 190 | 193 | = 3.24 = |
  | […](/browser/media-library-assistant/trunk/readme.txt?rev=3214567#L216) | […](/browser/media-library-assistant/trunk/readme.txt?rev=3215759#L219) |  |
  | 216 | 219 | \* Fix: Added logic to avoid errors in items with corrupted `\_wp\_attached\_file` (array) values. |
  | 217 | 220 |  |
  | 218 |  | = 3.20 = |
  | 219 |  | \* Fix: \*\*IMPORTANT: A security risk that allowed remote code execution from a logged in administrator account has been mitigated.\*\* |
  | 220 |  | \* Fix: For mapping rules, an AJAX nonce problem in the "Execute" rollover action has been corrected. |
  | 221 |  | \* Fix: For the `[mla\_gallery]` shortcode, a defect in processing `mla\_link\_href` parameters containing multiple query string parameters has been corrected. |
  | 222 |  | \* Fix: For the `[mla\_gallery]` shortcode when `mla\_viewer=true`, a "PHP Warning: Undefined array key..." issue has been eliminated. |
  | 223 |  |  |
  | 224 |  | = 3.19 = |
  | 225 |  | \* New: For mapping rules, a new "Replace All" option for the "Keep Existing" setting will replace Standard Fields with an empty value and delete Taxonomy term assignments if the mapping rule evaluates to an empty value. |
  | 226 |  | \* Fix: \*\*IMPORTANT: A security risk that allowed authenticated non-administrator (Author+) users to add file extensions to the Uploads list has been mitigated.\*\* |
  | 227 |  | \* Fix: More precise jQuery specification may improve handling of the Edit and Thumbnails bulk actions on the Media/Assistant admin submenu screen. |
  | 228 |  | \* Fix: For Custom Fields and IPTC/EXIF/WP custom field rules, the "Replace" option for the "Keep Existing" setting will not delete existing non-empty values if the new value is empty. |
  | 229 |  | \* Fix: For IPTC/EXIF/WP custom field rules, the "Multi" Option setting is now respected. A defect in previous MLA versions caused this setting to be ignored. |
  | 230 |  | \* Fix: For IPTC/EXIF/WP custom field rules, the "Delete NULL Values" setting is now respected. A defect in previous MLA versions always deleted NULL values. |
  | 231 |  | \* Fix: The `utf8\_encode()` function has been replaced by `mb\_convert\_encoding()` to eliminate a PHP 8.2 "Deprecated" warning. |
  | 232 |  |  |
  | 233 |  | = 3.00 - 3.18 = |
  |  | 221 | = 3.00 - 3.20 = |
  |  | 222 | \* 3.20 - IMPORTANT: A security risk that allowed remote code execution from a logged in administrator account has been mitigated. Mapping rule and shortcode fixes. Four fixes in all. |
  |  | 223 | \* 3.19 - IMPORTANT: A security risk in the Settings/Media Library Assistant Uploads tab has been mitigated. Mapping rule fixes and enhancement. Media/Assistant bulk action fix. One enhancement, six fixes in all. |
  |  | 224 |  |
  | 234 | 225 | \* 3.18 - IMPORTANT: A security risk in the Media/Edit Media screen has been mitigated. A defect in formatting the order=DESC shortcode parameter has been corrected. Two fixes in all. |
  | 235 | 226 | \* 3.17 - IMPORTANT: Security risks in the Media/Edit Media screen and shortcodes have been mitigated. Elementor fix for the Media Manager Modal (popup) Window. Eight fixes in all. |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3215759)
* [Zip Archive](?format=zip&new=3215759)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_6cba5592_20250114_213120.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmedia-library-assistant%2Ftrunk%2Fexamples%2Fplugins%2Fmla-unattached-fixit.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/media-library-assistant/trunk/examples/plugins/mla-unattached-fixit.php?rev=3171053 "Revision 3171053")
* Next Revision →
* [Blame](/browser/media-library-assistant/trunk/examples/plugins/mla-unattached-fixit.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/media-library-assistant/trunk/examples/plugins/mla-unattached-fixit.php)

---

# [source:](/browser?order=name "Go to repository root") [media-library-assistant](/browser/media-library-assistant?order=name "View media-library-assistant")/[trunk](/browser/media-library-assistant/trunk?order=name "View trunk")/[examples](/browser/media-library-assistant/trunk/examples?order=name "View examples")/[plugins](/browser/media-library-assistant/trunk/examples/plugins?order=name "View plugins")/[mla-unattached-fixit.php](/browser/media-library-assistant/trunk/examples/plugins/mla-unattached-fixit.php?order=name "View mla-unattached-fixit.php")

View diff against:

View revision:

| [Last change](/changeset/3202657/media-library-assistant/trunk/examples/plugins/mla-unattached-fixit.php "View differences") on this file was [3202657](/changeset/3202657/ "View changeset 3202657"), checked in by dglingren, [6 weeks ago](/timeline?from=2024-12-04T21%3A10%3A24Z&precision=second "See timeline at 12/04/2024 09:10:24 PM") |
| --- |
| Field-level data sources for accessing information about the original, unscaled files for very large images. Reflected Cross-Site Scripting security risks in the Smart Media Categories, MLA Unattached Fixit, and WooCommerce Fixit example plugins have been mitigated. |
| **File size:** 12.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Removes Unattached items from the Media Library |
| [4](#L4) | \* |
| [5](#L5) | \* Adds a Tools/Unattached Fixit submenu with buttons to perform the operations. |
| [6](#L6) | \* |
| [7](#L7) | \* Created for support topic "Bulk delete Unattached images/media" |
| [8](#L8) | \* opened on 11/24/2015 by "lododicesimo": |
| [9](#L9) | \* https://wordpress.org/support/topic/bulk-delete-unattached-imagesmedia/ |
| [10](#L10) | \* |
| [11](#L11) | \* Enhanced (Reflected Cross-Site Scripting security fix) for Wordfence CVE ID: CVE-2024-11974 report |
| [12](#L12) | \* opened on 12/03/2024 by "vgo0": |
| [13](#L13) | \* |
| [14](#L14) | \* @package Unattached Fixit |
| [15](#L15) | \* @version 1.05 |
| [16](#L16) | \*/ |
| [17](#L17) |  |
| [18](#L18) | /\* |
| [19](#L19) | Plugin Name: MLA Unattached Fixit |
| [20](#L20) | Plugin URI: http://davidlingren.com/ |
| [21](#L21) | Description: Removes Unattached items from the Media Library |
| [22](#L22) | Author: David Lingren |
| [23](#L23) | Version: 1.05 |
| [24](#L24) | Author URI: http://davidlingren.com/ |
| [25](#L25) |  |
| [26](#L26) | Copyright 2015 David Lingren |
| [27](#L27) |  |
| [28](#L28) | This program is free software; you can redistribute it and/or modify |
| [29](#L29) | it under the terms of the GNU General Public License as published by |
| [30](#L30) | the Free Software Foundation; either version 2 of the License, or |
| [31](#L31) | (at your option) any later version. |
| [32](#L32) |  |
| [33](#L33) | This program is distributed in the hope that it will be useful, |
| [34](#L34) | but WITHOUT ANY WARRANTY; without even the implied warranty of |
| [35](#L35) | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the |
| [36](#L36) | GNU General Public License for more details. |
| [37](#L37) |  |
| [38](#L38) | You can get a copy of the GNU General Public License by writing to the |
| [39](#L39) | Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110, USA |
| [40](#L40) | \*/ |
| [41](#L41) |  |
| [42](#L42) | /\*\* |
| [43](#L43) | \* Class Unattached Fixit implements a Tools submenu page with several image-fixing tools. |
| [44](#L44) | \* |
| [45](#L45) | \* Created for support topic "Bulk delete Unattached images/media" |
| [46](#L46) | \* opened on 11/24/2015 by "lododicesimo": |
| [47](#L47) | \* https://wordpress.org/support/topic/bulk-delete-unattached-imagesmedia |
| [48](#L48) | \* |
| [49](#L49) | \* @package Unattached Fixit |
| [50](#L50) | \* @since 1.00 |
| [51](#L51) | \*/ |
| [52](#L52) | class Unattached\_Fixit { |
| [53](#L53) | /\*\* |
| [54](#L54) | \* Current version number |
| [55](#L55) | \* |
| [56](#L56) | \* @since 1.00 |
| [57](#L57) | \* |
| [58](#L58) | \* @var string |
| [59](#L59) | \*/ |
| [60](#L60) | const CURRENT\_VERSION = '1.05'; |
| [61](#L61) |  |
| [62](#L62) | /\*\* |
| [63](#L63) | \* Slug prefix for registering and enqueueing submenu pages, style sheets and scripts |
| [64](#L64) | \* |
| [65](#L65) | \* @since 1.00 |
| [66](#L66) | \* |
| [67](#L67) | \* @var string |
| [68](#L68) | \*/ |
| [69](#L69) | const SLUG\_PREFIX = 'unattachfixit-'; |
| [70](#L70) |  |
| [71](#L71) | /\*\* |
| [72](#L72) | \* Initialization function, similar to \_\_construct() |
| [73](#L73) | \* |
| [74](#L74) | \* @since 1.00 |
| [75](#L75) | \* |
| [76](#L76) | \* @return      void |
| [77](#L77) | \*/ |
| [78](#L78) | public static function initialize() { |
| [79](#L79) | //add\_action( 'admin\_init', 'Unattached\_Fixit::admin\_init\_action' ); |
| [80](#L80) | add\_action( 'admin\_menu', 'Unattached\_Fixit::admin\_menu\_action' ); |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | /\*\* |
| [84](#L84) | \* Admin Init Action |
| [85](#L85) | \* |
| [86](#L86) | \* @since 1.00 |
| [87](#L87) | \* |
| [88](#L88) | \* @return      void |
| [89](#L89) | \*/ |
| [90](#L90) | public static function admin\_init\_action() { |
| [91](#L91) | } |
| [92](#L92) |  |
| [93](#L93) | /\*\* |
| [94](#L94) | \* Add submenu page in the "Tools" section |
| [95](#L95) | \* |
| [96](#L96) | \* @since 1.00 |
| [97](#L97) | \* |
| [98](#L98) | \* @return      void |
| [99](#L99) | \*/ |
| [100](#L100) | public static function admin\_menu\_action( ) { |
| [101](#L101) | $current\_page\_hook = add\_submenu\_page( 'tools.php', 'Unattached Fixit Tools', 'Unattached Fixit', 'manage\_options', self::SLUG\_PREFIX . 'tools', 'Unattached\_Fixit::render\_tools\_page' ); |
| [102](#L102) | add\_filter( 'plugin\_action\_links', 'Unattached\_Fixit::add\_plugin\_links\_filter', 10, 2 ); |
| [103](#L103) | } |
| [104](#L104) |  |
| [105](#L105) | /\*\* |
| [106](#L106) | \* Add the "Tools" link to the Plugins section entry |
| [107](#L107) | \* |
| [108](#L108) | \* @since 1.00 |
| [109](#L109) | \* |
| [110](#L110) | \* @param       array   array of links for the Plugin, e.g., "Activate" |
| [111](#L111) | \* @param       string  Directory and name of the plugin Index file |
| [112](#L112) | \* |
| [113](#L113) | \* @return      array   Updated array of links for the Plugin |
| [114](#L114) | \*/ |
| [115](#L115) | public static function add\_plugin\_links\_filter( $links, $file ) { |
| [116](#L116) | if ( 0 === strpos( $file, 'mla-unattached-fixit' ) ) { |
| [117](#L117) | $tools\_link = sprintf( '<a href="%s">%s</a>', admin\_url( 'tools.php?page=' . self::SLUG\_PREFIX . 'tools' ), 'Tools' ); |
| [118](#L118) | array\_unshift( $links, $tools\_link ); |
| [119](#L119) | } |
| [120](#L120) |  |
| [121](#L121) | return $links; |
| [122](#L122) | } |
| [123](#L123) |  |
| [124](#L124) | /\*\* |
| [125](#L125) | \* Render (echo) the "Unattached Fixit" submenu in the Tools section |
| [126](#L126) | \* |
| [127](#L127) | \* @since 1.00 |
| [128](#L128) | \* |
| [129](#L129) | \* @return      void Echoes HTML markup for the submenu page |
| [130](#L130) | \*/ |
| [131](#L131) | public static function render\_tools\_page() { |
| [132](#L132) | //error\_log( \_\_LINE\_\_ . ' Unattached\_Fixit::render\_tools\_page() $\_REQUEST = ' . var\_export( $\_REQUEST, true ), 0 ); |
| [133](#L133) | if ( !current\_user\_can( 'manage\_options' ) ) { |
| [134](#L134) | echo "Unattached Fixit - Error</h2>\n"; |
| [135](#L135) | wp\_die( 'You do not have permission to manage plugin settings.' ); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | $setting\_actions = array( |
| [139](#L139) | 'help' => array( 'handler' => '', 'comment' => '<strong>Enter first and (optional) last attachment/item ID values above to restrict tool application range</strong>. To operate on one ID, enter just the "First ID". The default is to perform the operation on <strong>all Media Library items</strong>.<br />&nbsp;<br />You can find ID values in the "ID/Parent" column or by by hovering over the thumbnail image in the Media/Assistant submenu table; look for the number following <code>post=</code> in the item&rsquo;s URL.' ), |
| [140](#L140) | 'warning' => array( 'handler' => '', 'comment' => '<strong>These tools make permanent updates to your database.</strong> Make a backup before you use the tools so you can restore your old values if you don&rsquo;t like the results.' ), |
| [141](#L141) | 'trash' => array( 'handler' => '', 'comment' => 'You can <code>define (&quot;MEDIA\_TRASH&quot;, true);</code> in your <code>wp-config.php</code> to activate the WordPress "Trash" feature for attachments.' ), |
| [142](#L142) |  |
| [143](#L143) | 'c0' => array( 'handler' => '', 'comment' => '<h3>Unattached Media Library item operations</h3>' ), |
| [144](#L144) | 'Trash Unattached' => array( 'handler' => '\_trash\_unattached\_items', |
| [145](#L145) | 'comment' => 'Move unattached items to "media trash".' ), |
| [146](#L146) | 'Delete Unattached' => array( 'handler' => '\_delete\_unattached\_items', |
| [147](#L147) | 'comment' => 'Permanently delete unattached items.' ), |
| [148](#L148) | ); |
| [149](#L149) |  |
| [150](#L150) | // Conditional display of the "Trash" action |
| [151](#L151) | if ( ! ( defined('MEDIA\_TRASH') && MEDIA\_TRASH ) ) { |
| [152](#L152) | unset( $setting\_actions['Trash Unattached'] ); |
| [153](#L153) | } |
| [154](#L154) |  |
| [155](#L155) | echo '<div class="wrap">' . "\n"; |
| [156](#L156) | echo "\t\t" . '<div id="icon-tools" class="icon32"><br/></div>' . "\n"; |
| [157](#L157) | echo "\t\t" . '<h2>Unattached Fixit Tools v' . self::CURRENT\_VERSION . '</h2>' . "\n"; |
| [158](#L158) |  |
| [159](#L159) | if ( !current\_user\_can( 'delete\_posts' ) ) { |
| [160](#L160) | echo "\t\t<br>ERROR: You are not allowed to delete/trash Media Library items.\n"; |
| [161](#L161) | return; |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | if ( isset( $\_REQUEST[ self::SLUG\_PREFIX . 'action' ] ) ) { |
| [165](#L165) | $label = trim( wp\_kses( wp\_unslash( $\_REQUEST[ self::SLUG\_PREFIX . 'action' ] ), 'post' ) ); |
| [166](#L166) | if( isset( $setting\_actions[ $label ] ) ) { |
| [167](#L167) | $action = $setting\_actions[ $label ]['handler']; |
| [168](#L168) | if ( ! empty( $action ) ) { |
| [169](#L169) | if ( method\_exists( 'Unattached\_Fixit', $action ) ) { |
| [170](#L170) | echo self::$action(); |
| [171](#L171) | } else { |
| [172](#L172) | echo "\t\t<br>ERROR: handler does not exist for action: \"{$label}\"\n"; |
| [173](#L173) | } |
| [174](#L174) | } else { |
| [175](#L175) | echo "\t\t<br>ERROR: no handler for action: \"{$label}\"\n"; |
| [176](#L176) | } |
| [177](#L177) | } else { |
| [178](#L178) | echo "\t\t<br>ERROR: unknown action: \"{$label}\"\n"; |
| [179](#L179) | } |
| [180](#L180) | } |
| [181](#L181) |  |
| [182](#L182) | echo "\t\t" . '<div style="width:700px">' . "\n"; |
| [183](#L183) | echo "\t\t" . '<form action="' . admin\_url( 'tools.php?page=' . self::SLUG\_PREFIX . 'tools' ) . '" method="post" class="' . self::SLUG\_PREFIX . 'tools-form-class" id="' . self::SLUG\_PREFIX . 'tools-form-id">' . "\n"; |
| [184](#L184) | echo "\t\t" . '  <p class="submit" style="padding-bottom: 0;">' . "\n"; |
| [185](#L185) | echo "\t\t" . '    <table>' . "\n"; |
| [186](#L186) |  |
| [187](#L187) | echo "\t\t" . '      <tr valign="top">' . "\n"; |
| [188](#L188) | echo "\t\t" . '        <td width="24%" style="text-align: right; padding-right: 5px" >First Attachment ID</td>' . "\n"; |
| [189](#L189) | echo "\t\t" . '        <td width="24%" style="text-align: left;"><input name="' . self::SLUG\_PREFIX . 'attachment\_lower" type="text" size="5" value=""></td>' . "\n"; |
| [190](#L190) | echo "\t\t" . '      </tr>' . "\n"; |
| [191](#L191) |  |
| [192](#L192) | echo "\t\t" . '      <tr valign="top">' . "\n"; |
| [193](#L193) | echo "\t\t" . '        <td width="24%" style="text-align: right; padding-right: 5px" >Last Attachment ID</td>' . "\n"; |
| [194](#L194) | echo "\t\t" . '        <td style="text-align: left;"><input name="' . self::SLUG\_PREFIX . 'attachment\_upper" type="text" size="5" value=""></td>' . "\n"; |
| [195](#L195) | echo "\t\t" . '      </tr>' . "\n"; |
| [196](#L196) |  |
| [197](#L197) | echo "\t\t" . '      <tr valign="top">' . "\n"; |
| [198](#L198) | echo "\t\t" . '        <td width="24%" style="text-align: right; padding-right: 5px" >Attachment Limit</td>' . "\n"; |
| [199](#L199) | echo "\t\t" . '        <td style="text-align: left;"><input name="' . self::SLUG\_PREFIX . 'attachment\_limit" type="text" size="5" value=""></td>' . "\n"; |
| [200](#L200) | echo "\t\t" . '      </tr>' . "\n"; |
| [201](#L201) |  |
| [202](#L202) | echo "\t\t" . '    <table>' . "\n"; |
| [203](#L203) |  |
| [204](#L204) | foreach ( $setting\_actions as $label => $action ) { |
| [205](#L205) | if ( empty( $action['handler'] ) ) { |
| [206](#L206) | echo "\t\t" . '      <tr><td colspan=2 style="padding: 2px 0px;">' . $action['comment'] . "</td></tr>\n"; |
| [207](#L207) | } else { |
| [208](#L208) | echo "\t\t" . '      <tr><td width="150px">' . "\n"; |
| [209](#L209) | echo "\t\t" . '        <input name="' . self::SLUG\_PREFIX . 'action" type="submit" class="button-primary" style="width: 140px;" value="' . $label . '" />&nbsp;&nbsp;' . "\n"; |
| [210](#L210) | echo "\t\t" . '      </td><td>' . "\n"; |
| [211](#L211) | echo "\t\t" . '        ' . $action['comment'] . "\n"; |
| [212](#L212) | echo "\t\t" . '      </td></tr>' . "\n"; |
| [213](#L213) | } |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | echo "\t\t" . '    </table>' . "\n"; |
| [217](#L217) | echo "\t\t" . '  </p>' . "\n"; |
| [218](#L218) | echo "\t\t" . '</form>' . "\n"; |
| [219](#L219) | echo "\t\t" . '</div>' . "\n"; |
| [220](#L220) | echo "\t\t" . '</div><!-- wrap -->' . "\n"; |
| [221](#L221) | } |
| [222](#L222) |  |
| [223](#L223) | /\*\* |
| [224](#L224) | \* Compile array of attachment ID values for the operation |
| [225](#L225) | \* |
| [226](#L226) | \* @since 1.00 |
| [227](#L227) | \* |
| [228](#L228) | \* @return      array |
| [229](#L229) | \*/ |
| [230](#L230) | private static function \_get\_attachment\_ids() { |
| [231](#L231) | global $wpdb; |
| [232](#L232) |  |
| [233](#L233) | $range\_clause = ''; |
| [234](#L234) |  |
| [235](#L235) | if ( ! empty( $\_REQUEST[ self::SLUG\_PREFIX . 'attachment\_lower' ] ) ) { |
| [236](#L236) | $lower\_bound = (integer) $\_REQUEST[ self::SLUG\_PREFIX . 'attachment\_lower' ]; |
| [237](#L237) | } else { |
| [238](#L238) | $lower\_bound = 0; |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) | if ( ! empty( $\_REQUEST[ self::SLUG\_PREFIX . 'attachment\_upper' ] ) ) { |
| [242](#L242) | $upper\_bound = (integer) $\_REQUEST[ self::SLUG\_PREFIX . 'attachment\_upper' ]; |
| [243](#L243) | $range\_clause = '( ID >= ' . $lower\_bound . ' ) AND ( ID <= ' . $upper\_bound . ' ) AND '; |
| [244](#L244) | } elseif ( $lower\_bound ) { |
| [245](#L245) | $range\_clause = '( ID = ' . $lower\_bound . ' ) AND '; |
| [246](#L246) | } |
| [247](#L247) |  |
| [248](#L248) | if ( ! empty( $\_REQUEST[ self::SLUG\_PREFIX . 'attachment\_limit' ] ) ) { |
| [249](#L249) | $limit\_clause = 'LIMIT ' . (integer) $\_REQUEST[ self::SLUG\_PREFIX . 'attachment\_limit' ]; |
| [250](#L250) | } else { |
| [251](#L251) | $limit\_clause = ''; |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | $query = sprintf( 'SELECT ID FROM %1$s WHERE %2$s( post\_type = \'attachment\' ) AND ( post\_status = \'inherit\' ) AND ( post\_parent = 0 ) ORDER BY ID %3$s', $wpdb->posts, $range\_clause, $limit\_clause ); |
| [255](#L255) | //error\_log( \_\_LINE\_\_ . ' Unattached\_Fixit::\_get\_attachment\_ids() $query = ' . var\_export( $query, true ), 0 ); |
| [256](#L256) | $results = $wpdb->get\_col( $query ); |
| [257](#L257) | //error\_log( \_\_LINE\_\_ . ' Unattached\_Fixit::\_get\_attachment\_ids() $results = ' . var\_export( $results, true ), 0 ); |
| [258](#L258) |  |
| [259](#L259) | return $results; |
| [260](#L260) | } // \_get\_attachment\_ids |
| [261](#L261) |  |
| [262](#L262) | /\*\* |
| [263](#L263) | \* Move unattached items to "media trash" |
| [264](#L264) | \* @since 1.00 |
| [265](#L265) | \* |
| [266](#L266) | \* @return      string  HTML markup for results/messages |
| [267](#L267) | \*/ |
| [268](#L268) | private static function \_trash\_unattached\_items() { |
| [269](#L269) | /\* |
| [270](#L270) | \* Compile array of attachment ID values |
| [271](#L271) | \*/ |
| [272](#L272) | $attachment\_ids = self::\_get\_attachment\_ids(); |
| [273](#L273) |  |
| [274](#L274) | // Initialize statistics |
| [275](#L275) | $attachment\_count = count( $attachment\_ids ); |
| [276](#L276) | $updates = 0; |
| [277](#L277) | $errors = 0; |
| [278](#L278) |  |
| [279](#L279) | foreach ( $attachment\_ids as $attachment\_id ) { |
| [280](#L280) | if ( wp\_trash\_post( $attachment\_id ) ) { |
| [281](#L281) | $updates++; |
| [282](#L282) | } else { |
| [283](#L283) | $errors++; |
| [284](#L284) | } |
| [285](#L285) | } // foreach attachment |
| [286](#L286) |  |
| [287](#L287) | return "<br>Trash Unattached matched {$attachment\_count} attachments and made {$updates} update(s). There were {$errors} error(s).\n"; |
| [288](#L288) | } // \_trash\_unattached\_items |
| [289](#L289) |  |
| [290](#L290) | /\*\* |
| [291](#L291) | \* Permanently delete unattached items |
| [292](#L292) | \* @since 1.00 |
| [293](#L293) | \* |
| [294](#L294) | \* @return      string  HTML markup for results/messages |
| [295](#L295) | \*/ |
| [296](#L296) | private static function \_delete\_unattached\_items() { |
| [297](#L297) | /\* |
| [298](#L298) | \* Compile array of attachment ID values |
| [299](#L299) | \*/ |
| [300](#L300) | $attachment\_ids = self::\_get\_attachment\_ids(); |
| [301](#L301) |  |
| [302](#L302) | // Initialize statistics |
| [303](#L303) | $attachment\_count = count( $attachment\_ids ); |
| [304](#L304) | $updates = 0; |
| [305](#L305) | $errors = 0; |
| [306](#L306) |  |
| [307](#L307) | foreach ( $attachment\_ids as $attachment\_id ) { |
| [308](#L308) | if ( wp\_delete\_attachment( $attachment\_id, true ) ) { |
| [309](#L309) | $updates++; |
| [310](#L310) | } else { |
| [311](#L311) | $errors++; |
| [312](#L312) | } |
| [313](#L313) | } // foreach attachment |
| [314](#L314) |  |
| [315](#L315) | return "<br>Delete Unattached matched {$attachment\_count} attachments and made {$updates} update(s). There were {$errors} error(s).\n"; |
| [316](#L316) | } // \_delete\_unattached\_items |
| [317](#L317) | } //Unattached\_Fixit |
| [318](#L318) |  |
| [319](#L319) | /\* |
| [320](#L320) | \* Install the submenu at an early opportunity |
| [321](#L321) | \*/ |
| [322](#L322) | add\_action('init', 'Unattached\_Fixit::initialize'); |
| [323](#L323) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/media-library-assistant/trunk/examples/plugins/mla-unattached-fixit.php?format=txt)
* [Original Format](/export/3222480/media-library-assistant/trunk/examples/plugins/mla-unattached-fixit.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_f101d086_20250114_213123.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmedia-library-assistant%2Ftrunk%2Fexamples%2Fplugins%2Fsmart-media-categories%2Fadmin%2Fincludes%2Fclass-smc-settings-support.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes/class-smc-settings-support.php?rev=2452210 "Revision 2452210")
* Next Revision →
* [Blame](/browser/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes/class-smc-settings-support.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes/class-smc-settings-support.php)

---

# [source:](/browser?order=name "Go to repository root") [media-library-assistant](/browser/media-library-assistant?order=name "View media-library-assistant")/[trunk](/browser/media-library-assistant/trunk?order=name "View trunk")/[examples](/browser/media-library-assistant/trunk/examples?order=name "View examples")/[plugins](/browser/media-library-assistant/trunk/examples/plugins?order=name "View plugins")/[smart-media-categories](/browser/media-library-assistant/trunk/examples/plugins/smart-media-categories?order=name "View smart-media-categories")/[admin](/browser/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin?order=name "View admin")/[includes](/browser/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes?order=name "View includes")/[class-smc-settings-support.php](/browser/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes/class-smc-settings-support.php?order=name "View class-smc-settings-support.php")

View diff against:

View revision:

| [Last change](/changeset/3202657/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes/class-smc-settings-support.php "View differences") on this file was [3202657](/changeset/3202657/ "View changeset 3202657"), checked in by dglingren, [6 weeks ago](/timeline?from=2024-12-04T21%3A10%3A24Z&precision=second "See timeline at 12/04/2024 09:10:24 PM") |
| --- |
| Field-level data sources for accessing information about the original, unscaled files for very large images. Reflected Cross-Site Scripting security risks in the Smart Media Categories, MLA Unattached Fixit, and WooCommerce Fixit example plugins have been mitigated. |
| **File size:** 16.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Support functions for the SMC Settings page. |
| [4](#L4) | \* |
| [5](#L5) | \* @package   Smart\_Media\_Categories\_Admin |
| [6](#L6) | \* @author    David Lingren <david@davidlingren.com> |
| [7](#L7) | \* @license   GPL-2.0+ |
| [8](#L8) | \* @link      http://davidlingren.com |
| [9](#L9) | \* @copyright 2014 David Lingren |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* This support class provides functions to manage the SMC options |
| [14](#L14) | \* |
| [15](#L15) | \* In the current version all of the support functions are static, and there is |
| [16](#L16) | \* no need to create a new instance of the class. |
| [17](#L17) | \* |
| [18](#L18) | \* @package Smart\_Media\_Categories\_Admin |
| [19](#L19) | \* @author  David Lingren <david@davidlingren.com> |
| [20](#L20) | \*/ |
| [21](#L21) | class SMC\_Settings\_Support { |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Option definitions |
| [24](#L24) | \* |
| [25](#L25) | \* Defined NULL and initialized at runtime for I18N support. |
| [26](#L26) | \* |
| [27](#L27) | \* @since    1.0.6 |
| [28](#L28) | \* |
| [29](#L29) | \* @var      array |
| [30](#L30) | \*/ |
| [31](#L31) | protected static $option\_definitions = NULL; |
| [32](#L32) |  |
| [33](#L33) | /\*\* |
| [34](#L34) | \* Initialize the $option\_definitions array |
| [35](#L35) | \* |
| [36](#L36) | \* @since    1.0.6 |
| [37](#L37) | \* |
| [38](#L38) | \* @return      void |
| [39](#L39) | \*/ |
| [40](#L40) | public static function initialize() { |
| [41](#L41) | SMC\_Settings\_Support::$option\_definitions = array( |
| [42](#L42) | 'smc\_automatic\_options' => array( |
| [43](#L43) | 'post\_types' => array( |
| [44](#L44) | 'type' => 'text', |
| [45](#L45) | 'size' => 40, |
| [46](#L46) | 'default' => 'post', |
| [47](#L47) | 'id' => 'smc\_automatic\_post\_types', |
| [48](#L48) | 'title' => \_\_( 'Sync Post Types', 'smart-media-categories' ), |
| [49](#L49) | 'description' => \_\_( "Which Post Type(s) are subject to these rules. Separate multiple types by commas.", 'smart-media-categories' ), |
| [50](#L50) | ), |
| [51](#L51) | 'scroll\_threshold' => array( |
| [52](#L52) | 'type' => 'text', |
| [53](#L53) | 'size' => 2, |
| [54](#L54) | 'default' => '10', |
| [55](#L55) | 'id' => 'smc\_automatic\_scroll\_threshold', |
| [56](#L56) | 'title' => \_\_( 'Scroll Threshold', 'smart-media-categories' ), |
| [57](#L57) | 'description' => \_\_( "The number of children required to activate column scrolling.", 'smart-media-categories' ), |
| [58](#L58) | ), |
| [59](#L59) | 'scroll\_height' => array( |
| [60](#L60) | 'type' => 'text', |
| [61](#L61) | 'size' => 5, |
| [62](#L62) | 'default' => '150px', |
| [63](#L63) | 'id' => 'smc\_automatic\_scroll\_height', |
| [64](#L64) | 'title' => \_\_( 'Scroll Height', 'smart-media-categories' ), |
| [65](#L65) | 'description' => \_\_( "Maximum height of scrolling Children column cell.", 'smart-media-categories' ), |
| [66](#L66) | ), |
| [67](#L67) | 'upload\_item' => array( |
| [68](#L68) | 'type' => 'checkbox', |
| [69](#L69) | 'default' => '1', |
| [70](#L70) | 'id' => 'smc\_automatic\_upload\_item', |
| [71](#L71) | 'title' => \_\_( 'Upload Item', 'smart-media-categories' ), |
| [72](#L72) | 'description' => \_\_( "When an item is uploaded to a <strong>Sync Post Type</strong> (any post\_type in the Sync Post Types list above), it will inherit the parent's terms.", 'smart-media-categories' ), |
| [73](#L73) | ), |
| [74](#L74) | 'attach\_orphan' => array( |
| [75](#L75) | 'type' => 'checkbox', |
| [76](#L76) | 'default' => '1', |
| [77](#L77) | 'id' => 'smc\_automatic\_attach\_orphan', |
| [78](#L78) | 'title' => \_\_( 'Attach Orphan', 'smart-media-categories' ), |
| [79](#L79) | 'description' => \_\_( "When an orphan is attached to a <strong>Sync Post Type</strong>, it will inherit the parent's terms.", 'smart-media-categories' ), |
| [80](#L80) | ), |
| [81](#L81) | 'insert\_orphan' => array( |
| [82](#L82) | 'type' => 'checkbox', |
| [83](#L83) | 'default' => '1', |
| [84](#L84) | 'id' => 'smc\_automatic\_insert\_orphan', |
| [85](#L85) | 'title' => \_\_( 'Insert Orphan', 'smart-media-categories' ), |
| [86](#L86) | 'description' => \_\_( "Inserting an orphan in a <strong>Sync Post Type</strong> will attach it to the <strong>Sync Post Type</strong> and assign its terms.", 'smart-media-categories' ), |
| [87](#L87) | ), |
| [88](#L88) | 'insert\_attached' => array( |
| [89](#L89) | 'type' => 'checkbox', |
| [90](#L90) | 'default' => '1', |
| [91](#L91) | 'id' => 'smc\_automatic\_insert\_attached', |
| [92](#L92) | 'title' => \_\_( 'Insert Attached', 'smart-media-categories' ), |
| [93](#L93) | 'description' => \_\_( "Inserting an item already attached to a different <strong>Sync Post Type</strong> (or Page or Custom Post Type) will change the item's post\_parent, delete its terms and assign the terms assigned to the new parent <strong>Sync Post Type</strong>.", 'smart-media-categories' ), |
| [94](#L94) | ), |
| [95](#L95) | 'update\_post\_terms' => array( |
| [96](#L96) | 'type' => 'checkbox', |
| [97](#L97) | 'default' => '1', |
| [98](#L98) | 'id' => 'smc\_automatic\_update\_post\_terms', |
| [99](#L99) | 'title' => \_\_( 'Update Post', 'smart-media-categories' ), |
| [100](#L100) | 'description' => \_\_( "When a <strong>Sync Post Type's</strong> terms are updated, the <strong>Sync Post Type's</strong> children inherit the current terms of the parent.", 'smart-media-categories' ), |
| [101](#L101) | ), |
| [102](#L102) | 'set\_feature' => array( |
| [103](#L103) | 'type' => 'checkbox', |
| [104](#L104) | 'default' => '1', |
| [105](#L105) | 'id' => 'smc\_automatic\_set\_feature', |
| [106](#L106) | 'title' => \_\_( 'Set Feature', 'smart-media-categories' ), |
| [107](#L107) | 'description' => \_\_( "When an orphan is set as a Featured Image of a <strong>Sync Post Type</strong> it is attached to the <strong>Sync Post Type</strong> and inherits the <strong>Sync Post Type's</strong> terms.", 'smart-media-categories' ), |
| [108](#L108) | ), |
| [109](#L109) | 'reattach\_feature' => array( |
| [110](#L110) | 'type' => 'checkbox', |
| [111](#L111) | 'default' => '1', |
| [112](#L112) | 'id' => 'smc\_automatic\_reattach\_feature', |
| [113](#L113) | 'title' => \_\_( 'Reattach Feature', 'smart-media-categories' ), |
| [114](#L114) | 'description' => \_\_( "If the item was previously attached to a different <strong>Sync Post Type</strong>, Page or Custom Post Type, it is detached from the previous parent, reattached to the current <strong>Sync Post Type</strong> and inherits the current parent's terms.", 'smart-media-categories' ), |
| [115](#L115) | ), |
| [116](#L116) | 'remove\_feature' => array( |
| [117](#L117) | 'type' => 'checkbox', |
| [118](#L118) | 'default' => '1', |
| [119](#L119) | 'id' => 'smc\_automatic\_remove\_feature', |
| [120](#L120) | 'title' => \_\_( 'Remove Old Feature', 'smart-media-categories' ), |
| [121](#L121) | 'description' => \_\_( "If the item was the Featured Image of a different <strong>Sync Post Type</strong>, it is removed as the Featured Image of that <strong>Sync Post Type</strong>. ", 'smart-media-categories' ), |
| [122](#L122) | ), |
| [123](#L123) | 'reattach\_item' => array( |
| [124](#L124) | 'type' => 'checkbox', |
| [125](#L125) | 'default' => '1', |
| [126](#L126) | 'id' => 'smc\_automatic\_reattach\_item', |
| [127](#L127) | 'title' => \_\_( 'Reattach Item', 'smart-media-categories' ), |
| [128](#L128) | 'description' => \_\_( "When an items new parent is a <strong>Sync Post Type</strong>, it will inherit the parent's terms.", 'smart-media-categories' ), |
| [129](#L129) | ), |
| [130](#L130) | 'exclude\_default' => array( |
| [131](#L131) | 'type' => 'checkbox', |
| [132](#L132) | 'default' => '0', |
| [133](#L133) | 'id' => 'smc\_automatic\_exclude\_default', |
| [134](#L134) | 'title' => \_\_( 'Exclude Post Default', 'smart-media-categories' ), |
| [135](#L135) | 'description' => \_\_( "Exclude the Settings/Wriing 'Default Post Category' term from Attachments.", 'smart-media-categories' ), |
| [136](#L136) | ), |
| [137](#L137) | 'postie\_sync' => array( |
| [138](#L138) | 'type' => 'checkbox', |
| [139](#L139) | 'default' => '1', |
| [140](#L140) | 'id' => 'smc\_automatic\_postie\_sync', |
| [141](#L141) | 'title' => \_\_( 'Sync Postie Emails', 'smart-media-categories' ), |
| [142](#L142) | 'description' => \_\_( "Apply syncronization options to posts created by Postie email processing.", 'smart-media-categories' ), |
| [143](#L143) | ), |
| [144](#L144) | ), |
| [145](#L145) | 'smc\_manual\_options' => array( |
| [146](#L146) | ), |
| [147](#L147) | ); |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | /\*\* |
| [151](#L151) | \* Find the SMC Settings page active tab |
| [152](#L152) | \* |
| [153](#L153) | \* @since    1.0.6 |
| [154](#L154) | \* |
| [155](#L155) | \* @param       string  Optional; 'smc\_automatic\_options', 'smc\_manual\_options' |
| [156](#L156) | \* |
| [157](#L157) | \* @return      string  Active tab value |
| [158](#L158) | \*/ |
| [159](#L159) | public static function get\_active\_tab( $active\_tab = NULL ) { |
| [160](#L160) | if ( isset( $\_REQUEST[ 'smc\_settings\_tab' ] ) ) { |
| [161](#L161) | $active\_tab = trim( wp\_kses( wp\_unslash( $\_REQUEST['smc\_settings\_tab'] ), 'post' ) ); |
| [162](#L162) | } elseif ( is\_null( $active\_tab ) ) { |
| [163](#L163) | $active\_tab = 'smc\_automatic\_options'; |
| [164](#L164) | } elseif ( ! in\_array( $active\_tab, array( 'smc\_automatic\_options', 'smc\_manual\_options' ) ) ) { |
| [165](#L165) | $active\_tab = 'smc\_automatic\_options'; |
| [166](#L166) | } |
| [167](#L167) |  |
| [168](#L168) | return $active\_tab; |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | /\*\* |
| [172](#L172) | \* Find taxonomies subjet to SMC rules |
| [173](#L173) | \* |
| [174](#L174) | \* @since    1.0.9 |
| [175](#L175) | \* |
| [176](#L176) | \* @return      array   Taxonomies subject to the SMC rules, if any |
| [177](#L177) | \*/ |
| [178](#L178) | public static function smc\_taxonomies() { |
| [179](#L179) | static $smc\_taxonomies = NULL; |
| [180](#L180) |  |
| [181](#L181) | if ( is\_null( $smc\_taxonomies ) ) { |
| [182](#L182) | $smc\_types = array\_map( 'trim', explode( ',', self::get\_option('post\_types') ) ); |
| [183](#L183) | //error\_log( \_\_LINE\_\_ . ' SMC\_Settings\_Support::smc\_taxonomies $smc\_types = ' . var\_export( $smc\_types, true ), 0 ); |
| [184](#L184) |  |
| [185](#L185) | $smc\_taxonomies = array(); |
| [186](#L186) | foreach ( $smc\_types as $smc\_type ) { |
| [187](#L187) | $taxonomies = get\_object\_taxonomies( $smc\_type, 'names' ); |
| [188](#L188) | //error\_log( \_\_LINE\_\_ . " SMC\_Settings\_Support::smc\_taxonomies( {$smc\_type} ) taxonomies = " . var\_export( $taxonomies, true ), 0 ); |
| [189](#L189) | foreach ( $taxonomies as $tax\_name ) { |
| [190](#L190) | // Index on name to avoid duplicates |
| [191](#L191) | $smc\_taxonomies[ $tax\_name ] = $tax\_name; |
| [192](#L192) | } |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | //error\_log( \_\_LINE\_\_ . ' SMC\_Settings\_Support::smc\_taxonomies $smc\_taxonomies = ' . var\_export( $smc\_taxonomies, true ), 0 ); |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) | return $smc\_taxonomies; |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Find Post Types subjet to SMC rules |
| [203](#L203) | \* |
| [204](#L204) | \* @since    1.0.9 |
| [205](#L205) | \* |
| [206](#L206) | \* @return      array   Post Types subject to the SMC rules, if any |
| [207](#L207) | \*/ |
| [208](#L208) | public static function smc\_post\_types() { |
| [209](#L209) | static $smc\_types = NULL; |
| [210](#L210) |  |
| [211](#L211) | if ( is\_null( $smc\_types ) ) { |
| [212](#L212) | $smc\_types = array\_map( 'trim', explode( ',', self::get\_option('post\_types') ) ); |
| [213](#L213) | //error\_log( \_\_LINE\_\_ . ' SMC\_Settings\_Support::smc\_post\_types $smc\_types = ' . var\_export( $smc\_types, true ), 0 ); |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | return $smc\_types; |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | /\*\* |
| [220](#L220) | \* See if a Post Type is subjet to SMC rules |
| [221](#L221) | \* |
| [222](#L222) | \* @since    1.0.9 |
| [223](#L223) | \* |
| [224](#L224) | \* @param       string  $post\_type Post Type slug |
| [225](#L225) | \* |
| [226](#L226) | \* @return      boolean True if the Post Type is subject to the SMC rules |
| [227](#L227) | \*/ |
| [228](#L228) | public static function is\_smc\_post\_type( $post\_type ) { |
| [229](#L229) | static $smc\_types = NULL; |
| [230](#L230) |  |
| [231](#L231) | if ( is\_null( $smc\_types ) ) { |
| [232](#L232) | $smc\_types = array\_map( 'trim', explode( ',', self::get\_option('post\_types') ) ); |
| [233](#L233) | //error\_log( \_\_LINE\_\_ . ' SMC\_Settings\_Support::is\_smc\_post\_type $smc\_types = ' . var\_export( $smc\_types, true ), 0 ); |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | return in\_array( $post\_type, $smc\_types ); |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | /\*\* |
| [240](#L240) | \* Find an SMC option by slug |
| [241](#L241) | \* |
| [242](#L242) | \* @since    1.0.6 |
| [243](#L243) | \* |
| [244](#L244) | \* @param       string  Option slug |
| [245](#L245) | \* |
| [246](#L246) | \* @return      string  Option value |
| [247](#L247) | \*/ |
| [248](#L248) | public static function get\_option( $slug ) { |
| [249](#L249) | $group = NULL; |
| [250](#L250) | $definition = NULL; |
| [251](#L251) |  |
| [252](#L252) | foreach ( SMC\_Settings\_Support::$option\_definitions as $key => $value ) { |
| [253](#L253) | if ( array\_key\_exists( $slug, $value ) ) { |
| [254](#L254) | $group = $key; |
| [255](#L255) | $definition = $value[ $slug ]; |
| [256](#L256) | break; |
| [257](#L257) | } |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | if ( is\_null( $definition ) ) { |
| [261](#L261) | return NULL; |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | $options = get\_option( $group ); |
| [265](#L265) | if ( is\_array( $options ) && isset( $options[ $slug ] ) ) { |
| [266](#L266) | return $options[ $slug ]; |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | return $definition['default']; |
| [270](#L270) | } |
| [271](#L271) |  |
| [272](#L272) | /\*\* |
| [273](#L273) | \* Render the SMC Settings page, section and options |
| [274](#L274) | \* |
| [275](#L275) | \* @since    1.0.6 |
| [276](#L276) | \* |
| [277](#L277) | \* @param       string  Settings page slug, as used in add\_options\_page() |
| [278](#L278) | \* @param       string  Optional; 'smc\_automatic\_options', 'smc\_manual\_options' |
| [279](#L279) | \* |
| [280](#L280) | \* @return      void |
| [281](#L281) | \*/ |
| [282](#L282) | public static function initialize\_settings\_page( $page\_slug, $active\_tab = NULL ) { |
| [283](#L283) | $active\_tab = SMC\_Settings\_Support::get\_active\_tab( $active\_tab ); |
| [284](#L284) |  |
| [285](#L285) | if ( 'smc\_automatic\_options' == $active\_tab ) { |
| [286](#L286) | add\_settings\_section( // $id, $title, $callback, $page |
| [287](#L287) | 'smc\_automatic\_options\_section', |
| [288](#L288) | \_\_( 'Automatic Actions', 'smart-media-categories' ), |
| [289](#L289) | 'SMC\_Settings\_Support::render\_automatic\_options\_section', |
| [290](#L290) | $page\_slug |
| [291](#L291) | ); |
| [292](#L292) |  |
| [293](#L293) | foreach( SMC\_Settings\_Support::$option\_definitions['smc\_automatic\_options'] as $key => $value ) { |
| [294](#L294) | add\_settings\_field(     // $id, $title, $callback, $page, $section, $args |
| [295](#L295) | $value['id'], |
| [296](#L296) | $value['title'], |
| [297](#L297) | 'SMC\_Settings\_Support::render\_automatic\_options', |
| [298](#L298) | $page\_slug, |
| [299](#L299) | 'smc\_automatic\_options\_section', |
| [300](#L300) | array\_merge( $value, array( 'slug' => $key ) ) |
| [301](#L301) | ); |
| [302](#L302) | } |
| [303](#L303) | } // smc\_automatic\_options |
| [304](#L304) |  |
| [305](#L305) | if ( 'smc\_manual\_options' == $active\_tab ) { |
| [306](#L306) | add\_settings\_section( // $id, $title, $callback, $page |
| [307](#L307) | 'smc\_manual\_options\_section', |
| [308](#L308) | \_\_( 'Manual Actions', 'smart-media-categories' ), |
| [309](#L309) | 'SMC\_Settings\_Support::render\_manual\_options\_section', |
| [310](#L310) | $page\_slug |
| [311](#L311) | ); |
| [312](#L312) | } // smc\_manual\_options |
| [313](#L313) | } |
| [314](#L314) |  |
| [315](#L315) | /\*\* |
| [316](#L316) | \* Render the SMC Settings page Automatic tab section-level content |
| [317](#L317) | \* |
| [318](#L318) | \* @since    1.0.6 |
| [319](#L319) | \* |
| [320](#L320) | \* @param       string  Optional; 'smc\_automatic\_options', 'smc\_manual\_options' |
| [321](#L321) | \* |
| [322](#L322) | \* @return      void    echoes HTML markup for the section description |
| [323](#L323) | \*/ |
| [324](#L324) | public static function render\_automatic\_options\_section() { |
| [325](#L325) | echo '<p>' . \_\_( "You can find some User Interface notes and more information about the rules in this PDF document: ", 'smart-media-categories' ) . "<a href=\"http://davidlingren.com/assets/Smart-Media-Categories-v07.pdf\" target=\"\_blank\">Smart-Media-Categories-v07.pdf</a></p>\n"; |
| [326](#L326) | echo '<p>' . \_\_( "Check the box of each automatic rule you want to apply.", 'smart-media-categories' ) . "</p>\n"; |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | /\*\* |
| [330](#L330) | \* Render the SMC Settings page Automatic tab section-level content |
| [331](#L331) | \* |
| [332](#L332) | \* @since    1.0.6 |
| [333](#L333) | \* |
| [334](#L334) | \* @param       string  Optional; 'smc\_automatic\_options', 'smc\_manual\_options' |
| [335](#L335) | \* |
| [336](#L336) | \* @return      void    echoes HTML markup for the section description |
| [337](#L337) | \*/ |
| [338](#L338) | public static function render\_manual\_options\_section() { |
| [339](#L339) | echo '<p><strong>' . \_\_( "There are no Manual Settings in this version of the plugin.", 'smart-media-categories' ) . "</strong></p>\n"; |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | /\*\* |
| [343](#L343) | \* Render the Automatic tab Upload Item setting |
| [344](#L344) | \* |
| [345](#L345) | \* @since    1.0.6 |
| [346](#L346) | \* |
| [347](#L347) | \* @param       array   ( [0] => explaination of this setting ) |
| [348](#L348) | \* |
| [349](#L349) | \* @return      void    echoes HTML markup for the setting |
| [350](#L350) | \*/ |
| [351](#L351) | public static function render\_automatic\_options( $args ) { |
| [352](#L352) | //error\_log( \_\_LINE\_\_ . ' SMC\_Settings\_Support::render\_automatic\_options $args = ' . var\_export( $args, true ), 0 ); |
| [353](#L353) |  |
| [354](#L354) | $slug = $args['slug']; |
| [355](#L355) | $value = SMC\_Settings\_Support::get\_option( $slug ); |
| [356](#L356) | if ( NULL === $value ) { |
| [357](#L357) | echo \_\_( 'Option not found: ', 'smart-media-categories' ) . $slug; |
| [358](#L358) | return; |
| [359](#L359) | } |
| [360](#L360) |  |
| [361](#L361) | switch ( $args['type'] ) { |
| [362](#L362) | case 'checkbox': |
| [363](#L363) | $html = '<input name="smc\_automatic\_options[' . $slug . ']" id="' . $args['id'] . '" type="checkbox" ' . checked( 1, $value, false ) . " value=\"1\"/>\n"; |
| [364](#L364) | $html .= '<label for="smc\_automatic\_' . $slug . '"> '  . $args['description'] . "</label>\n"; |
| [365](#L365) | break; |
| [366](#L366) | case 'text': |
| [367](#L367) | $html = '<input name="smc\_automatic\_options[' . $slug . ']" id="' . $args['id'] . '" type="text" size=' . $args['size'] . ' value="' . $value . "\"/>\n"; |
| [368](#L368) | $html .= '<br><label for="smc\_automatic\_' . $slug . '"> '  . $args['description'] . "</label>\n"; |
| [369](#L369) | break; |
| [370](#L370) | default: |
| [371](#L371) | $html = ''; |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | echo $html; |
| [375](#L375) | } |
| [376](#L376) |  |
| [377](#L377) | /\*\* |
| [378](#L378) | \* Validate the SMC Settings page Automatic options |
| [379](#L379) | \* |
| [380](#L380) | \* @since    1.0.6 |
| [381](#L381) | \* |
| [382](#L382) | \* @param       array   Option values as entered |
| [383](#L383) | \* |
| [384](#L384) | \* @return      void |
| [385](#L385) | \*/ |
| [386](#L386) | public static function validate\_automatic\_options( $input ) { |
| [387](#L387) | //error\_log( \_\_LINE\_\_ ." SMC\_Settings\_Support::validate\_automatic\_options input = " . var\_export( $input, true ), 0 ); |
| [388](#L388) | $output = array(); |
| [389](#L389) | $updates = 0; |
| [390](#L390) |  |
| [391](#L391) | foreach( SMC\_Settings\_Support::$option\_definitions['smc\_automatic\_options'] as $key => $value ) { |
| [392](#L392) | //error\_log( \_\_LINE\_\_ ." SMC\_Settings\_Support::validate\_automatic\_options {$key} = " . var\_export( $value, true ), 0 ); |
| [393](#L393) |  |
| [394](#L394) | $update = NULL; |
| [395](#L395) | switch ( $value['type'] ) { |
| [396](#L396) | case 'checkbox': |
| [397](#L397) | if ( isset( $input[ $key ] ) && absint( $input[ $key ] ) ) { |
| [398](#L398) | $update = '1'; |
| [399](#L399) | } else  { |
| [400](#L400) | $update = '0'; |
| [401](#L401) | } |
| [402](#L402) | break; |
| [403](#L403) | case 'text': |
| [404](#L404) | if ( isset( $input[ $key ] ) ) { |
| [405](#L405) | $update = trim( $input[ $key ] ); |
| [406](#L406) | } |
| [407](#L407) | break; |
| [408](#L408) | default: |
| [409](#L409) | break; |
| [410](#L410) | } |
| [411](#L411) |  |
| [412](#L412) | if ( !is\_null( $update ) ) { |
| [413](#L413) | $output[ $key ] = $update; |
| [414](#L414) | if ( $output[ $key ] != SMC\_Settings\_Support::get\_option(  $key ) ) { |
| [415](#L415) | $updates++; |
| [416](#L416) | add\_settings\_error( // $setting, $code, $message, $type |
| [417](#L417) | $key, |
| [418](#L418) | $key, |
| [419](#L419) | $value['title'] . \_\_( ' updated', 'smart-media-categories' ), |
| [420](#L420) | 'updated' |
| [421](#L421) | ); |
| [422](#L422) |  |
| [423](#L423) | } |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | if ( 0 == $updates ) { |
| [428](#L428) | add\_settings\_error( // $setting, $code, $message, $type |
| [429](#L429) | 'smc\_automatic\_options', |
| [430](#L430) | 'smc\_automatic\_options', |
| [431](#L431) | \_\_( 'No updates', 'smart-media-categories' ), |
| [432](#L432) | 'updated' |
| [433](#L433) | ); |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | //error\_log( \_\_LINE\_\_ ." SMC\_Settings\_Support::validate\_automatic\_options output = " . var\_export( $output, true ), 0 ); |
| [437](#L437) | update\_option( 'smc\_automatic\_options', $output ); |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | /\*\* |
| [441](#L441) | \* Render the SMC Settings page, section and options |
| [442](#L442) | \* |
| [443](#L443) | \* @since    1.0.6 |
| [444](#L444) | \* |
| [445](#L445) | \* @param       string  Settings page slug |
| [446](#L446) | \* @param       string  Optional; 'smc\_automatic\_options', 'smc\_manual\_options' |
| [447](#L447) | \* |
| [448](#L448) | \* @return      void    echoes HTML markup for the settings page |
| [449](#L449) | \*/ |
| [450](#L450) | public static function render\_settings\_page( $page, $active\_tab = NULL ) { |
| [451](#L451) | $active\_tab = SMC\_Settings\_Support::get\_active\_tab( $active\_tab ); |
| [452](#L452) | ?> |
| [453](#L453) |  |
| [454](#L454) | <h2 class="nav-tab-wrapper"> |
| [455](#L455) | <a href="?page=smart-media-categories&smc\_settings\_tab=smc\_automatic\_options" class="nav-tab <?php echo $active\_tab == 'smc\_automatic\_options' ? 'nav-tab-active' : ''; ?>"><?php \_e( 'Automatic', 'smart-media-categories' ); ?></a> |
| [456](#L456) | <a href="?page=smart-media-categories&smc\_settings\_tab=smc\_manual\_options" class="nav-tab <?php echo $active\_tab == 'smc\_manual\_options' ? 'nav-tab-active' : ''; ?>"><?php \_e( 'Manual', 'smart-media-categories' ); ?></a> |
| [457](#L457) | </h2> |
| [458](#L458) |  |
| [459](#L459) | <form method="post" action="options-general.php?page=smart-media-categories&smc\_settings\_tab=<?php echo $active\_tab ?>"> |
| [460](#L460) | <?php |
| [461](#L461) | settings\_fields( $page ); |
| [462](#L462) | do\_settings\_sections( $page ); |
| [463](#L463) | submit\_button(); |
| [464](#L464) | ?> |
| [465](#L465) | </form> |
| [466](#L466) |  |
| [467](#L467) | <?php } |
| [468](#L468) | } |
| [469](#L469) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes/class-smc-settings-support.php?format=txt)
* [Original Format](/export/3222480/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes/class-smc-settings-support.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_1e12e588_20250114_213142.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Media Library Assistant <= 3.23 - Reflected Cross-Site Scripting via smc\_settings\_tab, unattachfixit-action, and woofixit-action Parameters

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Media Library Assistant <= 3.23 - Reflected Cross-Site Scripting via smc\_settings\_tab, unattachfixit-action, and woofixit-action Parameters

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-11974](https://www.cve.org/CVERecord?id=CVE-2024-11974) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | January 3, 2025 |
| Last Updated | January 4, 2025 |
| Researcher | [vgo0](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/dale-mavers) |

### Description

The Media Library Assistant plugin for WordPress is vulnerable to Reflected Cross-Site Scripting via the ‘smc\_settings\_tab', 'unattachfixit-action', and 'woofixit-action’ parameters in all versions up to, and including, 3.23 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/media-library-assistant/trunk/examples/plugins/mla-unattached-fixit.php#L177)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/media-library-assistant/trunk/examples/plugins/woofixit.php#L1391)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/media-library-assistant/trunk/examples/plugins/smart-media-categories/admin/includes/class-smc-settings-support.php#L459)
* [wordpress.org](https://wordpress.org/plugins/media-library-assistant/#developers)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3215759/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmedia-library-assistant%2Fmedia-library-assistant-323-reflected-cross-site-scripting-via-smc-settings-tab-unattachfixit-action-and-woofixit-action-parameters&t=Media%20Library%20Assistant%20%3C%3D%203.23%20-%20Reflected%20Cross-Site%20Scripting%20via%20smc_settings_tab%2C%20unattachfixit-action%2C%20and%20woofixit-action%20Parameters "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmedia-library-assistant%2Fmedia-library-assistant-323-reflected-cross-site-scripting-via-smc-settings-tab-unattachfixit-action-and-woofixit-action-parameters&text=Media%20Library%20Assistant%20%3C%3D%203.23%20-%20Reflected%20Cross-Site%20Scripting%20via%20smc_settings_tab%2C%20unattachfixit-action%2C%20and%20woofixit-action%20Parameters "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmedia-library-assistant%2Fmedia-library-assistant-323-reflected-cross-site-scripting-via-smc-settings-tab-unattachfixit-action-and-woofixit-action-parameters "LinkedIn")
Email

## Vulnerability Details for Media Library Assistant

#### [Media Library Assistant](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/media-library-assistant)

| Software Type | Plugin |
| --- | --- |
| Software Slug | media-library-assistant [(view on wordpress.org)](https://wordpress.org/plugins/media-library-assistant) |
| Patched? | Yes |
| Remediation | Update to version 3.24, or a newer patched version |
| Affected Version | * <= 3.23 |
| Patched Version | * 3.24 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


