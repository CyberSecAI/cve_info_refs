=== Content from www.wordfence.com_a15f3b62_20250114_210151.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# One Click Upsell Funnel for WooCommerce <= 3.4.9 - Authenticated (Contributor+) Stored Cross-Site Scripting via wps\_wocuf\_pro\_yes Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   One Click Upsell Funnel for WooCommerce <= 3.4.9 - Authenticated (Contributor+) Stored Cross-Site Scripting via wps\_wocuf\_pro\_yes Shortcode

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-11938](https://www.cve.org/CVERecord?id=CVE-2024-11938) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | December 20, 2024 |
| Last Updated | December 24, 2024 |
| Researcher | [Peter Thaleikis](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/spek) |

### Description

The One Click Upsell Funnel for WooCommerce – Funnel Builder for WordPress, Create WooCommerce Upsell, Post-Purchase Upsell & Cross Sell Offers that Boost Sales & Increase Profits with Sales Funnel Builder plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the plugin's wps\_wocuf\_pro\_yes shortcode in all versions up to, and including, 3.4.9 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers, with contributor-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/woo-one-click-upsell-funnel/tags/3.4.9/public/class-woocommerce-one-click-upsell-funnel-public.php)
* [wordpress.org](https://wordpress.org/plugins/woo-one-click-upsell-funnel/#developers)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3212244%40woo-one-click-upsell-funnel&new=3212244%40woo-one-click-upsell-funnel&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-one-click-upsell-funnel%2Fone-click-upsell-funnel-for-woocommerce-349-authenticated-contributor-stored-cross-site-scripting-via-wps-wocuf-pro-yes-shortcode&t=One%20Click%20Upsell%20Funnel%20for%20WooCommerce%20%3C%3D%203.4.9%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20wps_wocuf_pro_yes%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-one-click-upsell-funnel%2Fone-click-upsell-funnel-for-woocommerce-349-authenticated-contributor-stored-cross-site-scripting-via-wps-wocuf-pro-yes-shortcode&text=One%20Click%20Upsell%20Funnel%20for%20WooCommerce%20%3C%3D%203.4.9%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20wps_wocuf_pro_yes%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwoo-one-click-upsell-funnel%2Fone-click-upsell-funnel-for-woocommerce-349-authenticated-contributor-stored-cross-site-scripting-via-wps-wocuf-pro-yes-shortcode "LinkedIn")
Email

## Vulnerability Details for One Click Upsell Funnel for WooCommerce – Funnel Builder for WordPress, Create WooCommerce Upsell, Post-Purchase Upsell & Cross Sell Offers that Boost Sales & Increase Profits with Sales Funnel Builder

#### [One Click Upsell Funnel for WooCommerce – Funnel Builder for WordPress, Create WooCommerce Upsell, Post-Purchase Upsell & Cross Sell Offers that Boost Sales & Increase Profits with Sales Funnel Builder](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/woo-one-click-upsell-funnel)

| Software Type | Plugin |
| --- | --- |
| Software Slug | woo-one-click-upsell-funnel [(view on wordpress.org)](https://wordpress.org/plugins/woo-one-click-upsell-funnel) |
| Patched? | Yes |
| Remediation | Update to version 3.4.10, or a newer patched version |
| Affected Version | * <= 3.4.9 |
| Patched Version | * 3.4.10 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_2e8edc3f_20250114_210148.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwoo-one-click-upsell-funnel%2Ftags%2F3.4.9%2Fpublic%2Fclass-woocommerce-one-click-upsell-funnel-public.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/woo-one-click-upsell-funnel/tags/3.4.9/public/class-woocommerce-one-click-upsell-funnel-public.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/woo-one-click-upsell-funnel/tags/3.4.9/public/class-woocommerce-one-click-upsell-funnel-public.php)

---

# [source:](/browser?order=name "Go to repository root") [woo-one-click-upsell-funnel](/browser/woo-one-click-upsell-funnel?order=name "View woo-one-click-upsell-funnel")/[tags](/browser/woo-one-click-upsell-funnel/tags?order=name "View tags")/[3.4.9](/browser/woo-one-click-upsell-funnel/tags/3.4.9?order=name "View 3.4.9")/[public](/browser/woo-one-click-upsell-funnel/tags/3.4.9/public?order=name "View public")/[class-woocommerce-one-click-upsell-funnel-public.php](/browser/woo-one-click-upsell-funnel/tags/3.4.9/public/class-woocommerce-one-click-upsell-funnel-public.php?order=name "View class-woocommerce-one-click-upsell-funnel-public.php")

View diff against:

View revision:

| [Last change](/changeset/3178004/woo-one-click-upsell-funnel/tags/3.4.9/public/class-woocommerce-one-click-upsell-funnel-public.php "View differences") on this file was [3178004](/changeset/3178004/ "View changeset 3178004"), checked in by wpswings, [3 months ago](/timeline?from=2024-10-29T12%3A55%3A51Z&precision=second "See timeline at 10/29/2024 12:55:51 PM") |
| --- |
| Released Version 3.4.9 |
| **File size:** 137.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* The public-facing functionality of the plugin. |
| [4](#L4) | \* |
| [5](#L5) | \* @link       https://wpswings.com/?utm\_source=wpswings-official&utm\_medium=upsell-org-backend&utm\_campaign=official |
| [6](#L6) | \* @since      1.0.0 |
| [7](#L7) | \* |
| [8](#L8) | \* @package     woo\_one\_click\_upsell\_funnel |
| [9](#L9) | \* @subpackage  woo\_one\_click\_upsell\_funnel/public |
| [10](#L10) | \*/ |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* The public-facing functionality of the plugin. |
| [14](#L14) | \* |
| [15](#L15) | \* Defines the plugin name, version, and two examples hooks for how to |
| [16](#L16) | \* enqueue the public-facing stylesheet and JavaScript. |
| [17](#L17) | \* |
| [18](#L18) | \* @package     woo\_one\_click\_upsell\_funnel |
| [19](#L19) | \* @subpackage woo\_one\_click\_upsell\_funnel/public |
| [20](#L20) | \* @author     wpswings <webmaster@wpswings.com> |
| [21](#L21) | \*/ |
| [22](#L22) | class Woocommerce\_One\_Click\_Upsell\_Funnel\_Public { |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* The ID of this plugin. |
| [26](#L26) | \* |
| [27](#L27) | \* @since    1.0.0 |
| [28](#L28) | \* @access   private |
| [29](#L29) | \* @var      string    $plugin\_name    The ID of this plugin. |
| [30](#L30) | \*/ |
| [31](#L31) | private $plugin\_name; |
| [32](#L32) |  |
| [33](#L33) | /\*\* |
| [34](#L34) | \* The version of this plugin. |
| [35](#L35) | \* |
| [36](#L36) | \* @since    1.0.0 |
| [37](#L37) | \* @access   private |
| [38](#L38) | \* @var      string    $version    The current version of this plugin. |
| [39](#L39) | \*/ |
| [40](#L40) | private $version; |
| [41](#L41) |  |
| [42](#L42) | /\*\* |
| [43](#L43) | \* Initialize the class and set its properties. |
| [44](#L44) | \* |
| [45](#L45) | \* @since    1.0.0 |
| [46](#L46) | \* @param      string $plugin\_name       The name of the plugin. |
| [47](#L47) | \* @param      string $version    The version of this plugin. |
| [48](#L48) | \*/ |
| [49](#L49) | public function \_\_construct( $plugin\_name, $version ) { |
| [50](#L50) | $this->plugin\_name = $plugin\_name; |
| [51](#L51) | $this->version     = $version; |
| [52](#L52) | } |
| [53](#L53) |  |
| [54](#L54) | /\*\* |
| [55](#L55) | \* Register the stylesheets for the public-facing side of the site. |
| [56](#L56) | \* |
| [57](#L57) | \* @since    1.0.0 |
| [58](#L58) | \*/ |
| [59](#L59) | public function enqueue\_styles() { |
| [60](#L60) | /\*\* |
| [61](#L61) | \* This function is provided for demonstration purposes only. |
| [62](#L62) | \* |
| [63](#L63) | \* An instance of this class should be passed to the run() function |
| [64](#L64) | \* defined in woocommerce\_one\_click\_upsell\_funnel\_pro\_Loader as all of the hooks are defined |
| [65](#L65) | \* in that particular class. |
| [66](#L66) | \* |
| [67](#L67) | \* The woocommerce\_one\_click\_upsell\_funnel\_pro\_Loader will then create the relationship |
| [68](#L68) | \* between the defined hooks and the functions defined in this |
| [69](#L69) | \* class. |
| [70](#L70) | \*/ |
| [71](#L71) |  |
| [72](#L72) | wp\_enqueue\_style( $this->plugin\_name, plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/woocommerce\_one\_click\_upsell\_funnel\_pro-public.css', array(), $this->version, 'all' ); |
| [73](#L73) | } |
| [74](#L74) |  |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Enqueue Scripts. |
| [77](#L77) | \* |
| [78](#L78) | \* @return void |
| [79](#L79) | \*/ |
| [80](#L80) | public function enqueue\_scripts() { |
| [81](#L81) |  |
| [82](#L82) | wp\_enqueue\_script( 'wps-upsell-sweet-alert-js', plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/sweet-alert.js', array(), '2.1.2', false ); |
| [83](#L83) |  |
| [84](#L84) | wp\_enqueue\_script( 'woocommerce-one-click-upsell-public-script', plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/woocommerce-oneclick-upsell-funnel-public.js', array( 'jquery' ), $this->version, true ); |
| [85](#L85) |  |
| [86](#L86) | $show\_upsell\_loader = false; |
| [87](#L87) |  |
| [88](#L88) | // Add Upsell loader only when Live Offer or admin view. |
| [89](#L89) | if ( $this->validate\_shortcode() ) { |
| [90](#L90) |  |
| [91](#L91) | $show\_upsell\_loader    = true; |
| [92](#L92) | $upsell\_global\_options = get\_option( 'wps\_upsell\_lite\_global\_options', array() ); |
| [93](#L93) |  |
| [94](#L94) | $upsell\_loader\_redirect\_link = ! empty( $upsell\_global\_options['upsell\_actions\_message'] ) ? sanitize\_text\_field( $upsell\_global\_options['upsell\_actions\_message'] ) : ''; |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | wp\_localize\_script( |
| [98](#L98) | 'woocommerce-one-click-upsell-public-script', |
| [99](#L99) | 'wps\_upsell\_public', |
| [100](#L100) | array( |
| [101](#L101) | 'alert\_preview\_title'    => esc\_html\_\_( 'One Click Upsell', 'woo-one-click-upsell-funnel' ), |
| [102](#L102) | 'alert\_preview\_content'  => esc\_html\_\_( 'This is Preview Mode, please checkout to see Live Offers.', 'woo-one-click-upsell-funnel' ), |
| [103](#L103) | 'show\_upsell\_loader'     => $show\_upsell\_loader, |
| [104](#L104) | 'upsell\_actions\_message' => ! empty( $show\_upsell\_loader ) ? $upsell\_loader\_redirect\_link : '', |
| [105](#L105) | ) |
| [106](#L106) | ); |
| [107](#L107) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [108](#L108) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [109](#L109) |  |
| [110](#L110) | if ( $id\_nonce\_verified ) { |
| [111](#L111) | $is\_upsell\_page = ''; |
| [112](#L112) | if ( isset( $\_GET['ocuf\_ns'] ) ) { |
| [113](#L113) | $is\_upsell\_page = true; |
| [114](#L114) | } |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | if ( ! empty( $is\_upsell\_page ) ) { |
| [118](#L118) | $upsell\_global\_options = get\_option( 'wps\_upsell\_lite\_global\_options', array() ); |
| [119](#L119) | $upsell\_skip\_function = ! empty( $upsell\_global\_options['wps\_wocuf\_pro\_skip\_exit\_intent\_toggle'] ) ? sanitize\_text\_field( $upsell\_global\_options['wps\_wocuf\_pro\_skip\_exit\_intent\_toggle'] ) : ''; |
| [120](#L120) | $upsell\_exit\_intent\_message = \_\_( 'Enhance your shopping experience! Explore additional products at a discount before you exit.', 'one-click-upsell-funnel-for-woocommerce-pro' ); |
| [121](#L121) |  |
| [122](#L122) | wp\_enqueue\_script( 'woocommerce-one-click-upsell-public-exit-intent-script', plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/woocommerce-one-click-upsell-funnel-public-exit-intent\_lite.js', array( 'jquery' ), $this->version, true ); |
| [123](#L123) |  |
| [124](#L124) | wp\_localize\_script( |
| [125](#L125) | 'woocommerce-one-click-upsell-public-exit-intent-script', |
| [126](#L126) | 'wps\_upsell\_public\_exit', |
| [127](#L127) | array( |
| [128](#L128) | 'ajaxurl'                => admin\_url( 'admin-ajax.php' ), |
| [129](#L129) | 'nonce'                  => wp\_create\_nonce( 'wps\_wocuf\_nonce' ), |
| [130](#L130) | 'skip\_enabled'           => $upsell\_skip\_function, |
| [131](#L131) | 'skip\_message'           => $upsell\_exit\_intent\_message, |
| [132](#L132) | ) |
| [133](#L133) | ); |
| [134](#L134) | } |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | /\*\* |
| [138](#L138) | \* Initiate Upsell Orders before processing payment in case of checkout shortcode. |
| [139](#L139) | \* |
| [140](#L140) | \* @param int $order\_id order id. |
| [141](#L141) | \* |
| [142](#L142) | \* @since 1.0.0 |
| [143](#L143) | \* |
| [144](#L144) | \* @throws Exception Throws exception when error. |
| [145](#L145) | \*/ |
| [146](#L146) | public function wps\_wocuf\_initate\_upsell\_orders\_shortcode\_checkout\_org( $order\_id ) { |
| [147](#L147) | $checkout\_nonce = ! empty( $\_POST['checkout\_order\_processed\_nonce'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['checkout\_order\_processed\_nonce'] ) ) : ''; |
| [148](#L148) |  |
| [149](#L149) | if ( isset( $\_POST['checkout\_order\_processed\_nonce'] ) && wp\_verify\_nonce( $checkout\_nonce, 'checkout\_order\_processed\_nonce' ) ) { |
| [150](#L150) | if ( empty( $\_GET['wc-ajax'] ) || 'checkout' !== $\_GET['wc-ajax'] ) { |
| [151](#L151) | return; |
| [152](#L152) | } |
| [153](#L153) | } |
| [154](#L154) | $order = wc\_get\_order( $order\_id ); |
| [155](#L155) | $this->wps\_wocuf\_initiate\_upsell\_orders( $order ); |
| [156](#L156) |  |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) |  |
| [160](#L160) | /\*\* |
| [161](#L161) | \* Initiate Upsell Orders before processing payment in case of checkout block. |
| [162](#L162) | \* |
| [163](#L163) | \* @param object $order is the current order object. |
| [164](#L164) | \* |
| [165](#L165) | \* @since 1.0.0 |
| [166](#L166) | \* |
| [167](#L167) | \* @throws Exception Throws exception when error. |
| [168](#L168) | \*/ |
| [169](#L169) | public function wps\_wocuf\_initate\_upsell\_orders\_api\_checkout\_org( $order ) { |
| [170](#L170) | $order\_id = $order->get\_id(); |
| [171](#L171) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_wocfo\_org\_checkout\_through\_block', 'block\_checkout' ); |
| [172](#L172) |  |
| [173](#L173) | $this->wps\_wocuf\_initiate\_upsell\_orders( $order ); |
| [174](#L174) |  |
| [175](#L175) | } |
| [176](#L176) |  |
| [177](#L177) |  |
| [178](#L178) |  |
| [179](#L179) | /\*\* |
| [180](#L180) | \* Initiate Upsell Orders before processing payment. |
| [181](#L181) | \* |
| [182](#L182) | \* @param object $order Order data. |
| [183](#L183) | \* @since    1.0.0 |
| [184](#L184) | \*/ |
| [185](#L185) | public function wps\_wocuf\_initiate\_upsell\_orders( $order ) { |
| [186](#L186) |  |
| [187](#L187) | $order\_id = $order->get\_id(); |
| [188](#L188) | $payment\_method = $order->get\_payment\_method(); |
| [189](#L189) |  |
| [190](#L190) | $supported\_gateways = wps\_upsell\_lite\_supported\_gateways(); |
| [191](#L191) |  |
| [192](#L192) | if ( in\_array( $payment\_method, $supported\_gateways, true ) ) { |
| [193](#L193) |  |
| [194](#L194) | $wps\_wocuf\_pro\_all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [195](#L195) |  |
| [196](#L196) | $wps\_wocuf\_pro\_flag = 0; |
| [197](#L197) |  |
| [198](#L198) | $wps\_wocuf\_pro\_proceed = false; |
| [199](#L199) |  |
| [200](#L200) | if ( empty( $wps\_wocuf\_pro\_all\_funnels ) ) { |
| [201](#L201) | return; |
| [202](#L202) | } elseif ( empty( $order ) ) { |
| [203](#L203) | return; |
| [204](#L204) | } |
| [205](#L205) |  |
| [206](#L206) | $funnel\_redirect = false; |
| [207](#L207) |  |
| [208](#L208) | if ( ! empty( $order ) ) { |
| [209](#L209) | if ( function\_exists( 'wcs\_order\_contains\_subscription' ) && ( wcs\_order\_contains\_subscription( $order\_id ) || wcs\_order\_contains\_renewal( $order\_id ) ) ) { |
| [210](#L210) | return; |
| [211](#L211) | } |
| [212](#L212) |  |
| [213](#L213) | $wps\_wocuf\_pro\_placed\_order\_items = $order->get\_items(); |
| [214](#L214) |  |
| [215](#L215) | $ocuf\_ok = $order->get\_order\_key(); |
| [216](#L216) |  |
| [217](#L217) | $ocuf\_ofd = 0; |
| [218](#L218) |  |
| [219](#L219) | if ( is\_array( $wps\_wocuf\_pro\_all\_funnels ) ) { |
| [220](#L220) |  |
| [221](#L221) | // Move Global Funnels at the last of the array while maintaining it's key, so they execute at last. |
| [222](#L222) | foreach ( $wps\_wocuf\_pro\_all\_funnels as $funnel\_key => $single\_funnel\_array ) { |
| [223](#L223) |  |
| [224](#L224) | $global\_funnel = ! empty( $single\_funnel\_array['wps\_wocuf\_global\_funnel'] ) ? $single\_funnel\_array['wps\_wocuf\_global\_funnel'] : ''; |
| [225](#L225) |  |
| [226](#L226) | // Check if global funnel. |
| [227](#L227) | if ( 'yes' === $global\_funnel ) { |
| [228](#L228) |  |
| [229](#L229) | // Unset. |
| [230](#L230) | unset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_key ] ); |
| [231](#L231) |  |
| [232](#L232) | // Append at last with the same key. |
| [233](#L233) | $wps\_wocuf\_pro\_all\_funnels[ $funnel\_key ] = $single\_funnel\_array; |
| [234](#L234) | } |
| [235](#L235) | } |
| [236](#L236) |  |
| [237](#L237) | // Main Foreach for Triggering Upsell Offers. |
| [238](#L238) | foreach ( $wps\_wocuf\_pro\_all\_funnels as $wps\_wocuf\_pro\_single\_funnel => $wps\_wocuf\_pro\_funnel\_data ) { |
| [239](#L239) |  |
| [240](#L240) | $is\_global\_funnel = ! empty( $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_global\_funnel'] ) && 'yes' === $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_global\_funnel'] ? $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_global\_funnel'] : false; |
| [241](#L241) |  |
| [242](#L242) | $wps\_wocuf\_pro\_funnel\_target\_products = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_target\_pro\_ids'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_target\_pro\_ids'] : array(); |
| [243](#L243) |  |
| [244](#L244) | $wps\_wocuf\_pro\_existing\_offers = ! empty( $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_applied\_offer\_number'] ) ? $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_applied\_offer\_number'] : array(); |
| [245](#L245) |  |
| [246](#L246) | // To get the first offer from current funnel. |
| [247](#L247) | if ( count( $wps\_wocuf\_pro\_existing\_offers ) ) { |
| [248](#L248) |  |
| [249](#L249) | foreach ( $wps\_wocuf\_pro\_existing\_offers as $key => $value ) { |
| [250](#L250) |  |
| [251](#L251) | $ocuf\_ofd = $key; |
| [252](#L252) | break; |
| [253](#L253) | } |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | if ( is\_array( $wps\_wocuf\_pro\_placed\_order\_items ) && count( $wps\_wocuf\_pro\_placed\_order\_items ) ) { |
| [257](#L257) | foreach ( $wps\_wocuf\_pro\_placed\_order\_items as $item\_key => $wps\_wocuf\_pro\_single\_item ) { |
| [258](#L258) | $wps\_wocuf\_pro\_variation\_id = $wps\_wocuf\_pro\_single\_item->get\_variation\_id(); |
| [259](#L259) |  |
| [260](#L260) | $wps\_wocuf\_pro\_product\_id = $wps\_wocuf\_pro\_single\_item->get\_product\_id(); |
| [261](#L261) |  |
| [262](#L262) | if ( in\_array( (string) $wps\_wocuf\_pro\_product\_id, $wps\_wocuf\_pro\_funnel\_target\_products, true ) || ( ! empty( $wps\_wocuf\_pro\_variation\_id ) && in\_array( (string) $wps\_wocuf\_pro\_variation\_id, $wps\_wocuf\_pro\_funnel\_target\_products, true ) ) || ( $is\_global\_funnel ) ) { |
| [263](#L263) |  |
| [264](#L264) | // Check if funnel is saved after version 3.0.0. |
| [265](#L265) | $funnel\_saved\_after\_version\_3 = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_upsell\_fsav3'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_upsell\_fsav3'] : ''; |
| [266](#L266) |  |
| [267](#L267) | // For funnels saved after version 3.0.0. |
| [268](#L268) | if ( 'true' === $funnel\_saved\_after\_version\_3 ) { |
| [269](#L269) |  |
| [270](#L270) | // Check if funnel is live or not. |
| [271](#L271) | $funnel\_status = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_upsell\_funnel\_status'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_upsell\_funnel\_status'] : ''; |
| [272](#L272) |  |
| [273](#L273) | // For Admin Funnel Will trigger for both Live and Sandbox statuses. |
| [274](#L274) |  |
| [275](#L275) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [276](#L276) |  |
| [277](#L277) | if ( 'yes' !== $funnel\_status ) { |
| [278](#L278) |  |
| [279](#L279) | // Break from placed order items loop and move to next funnel. |
| [280](#L280) | break; |
| [281](#L281) | } |
| [282](#L282) | } |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | /\*\* |
| [286](#L286) | \* Check for funnel schedule. |
| [287](#L287) | \* Since v3.0.0 convert data into array first. |
| [288](#L288) | \*/ |
| [289](#L289) | $wps\_wocuf\_pro\_funnel\_schedule = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_pro\_funnel\_schedule'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_pro\_funnel\_schedule'] : array( '7' ); |
| [290](#L290) |  |
| [291](#L291) | if ( '0' === $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_pro\_funnel\_schedule'] ) { |
| [292](#L292) |  |
| [293](#L293) | $wps\_wocuf\_pro\_funnel\_schedule = array( '0' ); |
| [294](#L294) | } elseif ( ! is\_array( $wps\_wocuf\_pro\_funnel\_schedule ) ) { |
| [295](#L295) |  |
| [296](#L296) | $wps\_wocuf\_pro\_funnel\_schedule = array( $wps\_wocuf\_pro\_funnel\_schedule ); |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | // In order to use server time only. |
| [300](#L300) | $current\_schedule = gmdate( 'w' ); |
| [301](#L301) |  |
| [302](#L302) | if ( in\_array( '7', $wps\_wocuf\_pro\_funnel\_schedule, true ) ) { |
| [303](#L303) |  |
| [304](#L304) | $wps\_wocuf\_pro\_proceed = true; |
| [305](#L305) |  |
| [306](#L306) | } elseif ( in\_array( (string) $current\_schedule, $wps\_wocuf\_pro\_funnel\_schedule, true ) ) { |
| [307](#L307) |  |
| [308](#L308) | $wps\_wocuf\_pro\_proceed = true; |
| [309](#L309) | } |
| [310](#L310) |  |
| [311](#L311) | if ( false === $wps\_wocuf\_pro\_proceed ) { |
| [312](#L312) |  |
| [313](#L313) | // Break from placed order items loop and move to next funnel. |
| [314](#L314) | break; |
| [315](#L315) | } |
| [316](#L316) |  |
| [317](#L317) | // Array of offers with product id. |
| [318](#L318) | if ( ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_products\_in\_offer'] ) && is\_array( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_products\_in\_offer'] ) ) { |
| [319](#L319) |  |
| [320](#L320) | /\*\* |
| [321](#L321) | \* Set funnel as shown if is exclusive offer funnel. |
| [322](#L322) | \* Do it just after checking target. |
| [323](#L323) | \* Exclusive Offer |
| [324](#L324) | \*/ |
| [325](#L325) | if ( ! empty( $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_exclusive\_offer'] ) && 'yes' === $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_exclusive\_offer'] ) { |
| [326](#L326) |  |
| [327](#L327) | // Check if funnel still exists. |
| [328](#L328) | if ( ! empty( $wps\_wocuf\_pro\_funnel\_data ) ) { |
| [329](#L329) |  |
| [330](#L330) | if ( ! empty( $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_exclusive\_offer'] ) && 'yes' === $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_exclusive\_offer'] ) { |
| [331](#L331) |  |
| [332](#L332) | $offer\_already\_shown\_to\_users = ! empty( $wps\_wocuf\_pro\_funnel\_data['offer\_already\_shown\_to\_users'] ) ? $wps\_wocuf\_pro\_funnel\_data['offer\_already\_shown\_to\_users'] : array(); |
| [333](#L333) |  |
| [334](#L334) | $current\_customer = ! empty( $order ) ? $order->get\_billing\_email() : ''; |
| [335](#L335) |  |
| [336](#L336) | if ( ! empty( $current\_customer ) && ! empty( $offer\_already\_shown\_to\_users ) && in\_array( $current\_customer, $offer\_already\_shown\_to\_users, true ) ) { |
| [337](#L337) |  |
| [338](#L338) | // Skip to next funnel. |
| [339](#L339) | break; |
| [340](#L340) | } |
| [341](#L341) |  |
| [342](#L342) | // Not skipped. Mark as shown to this customer. |
| [343](#L343) | array\_push( $offer\_already\_shown\_to\_users, $current\_customer ); |
| [344](#L344) | $wps\_wocuf\_pro\_funnel\_data['offer\_already\_shown\_to\_users'] = $offer\_already\_shown\_to\_users; |
| [345](#L345) |  |
| [346](#L346) | $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ] = $wps\_wocuf\_pro\_funnel\_data; |
| [347](#L347) |  |
| [348](#L348) | // Sort Funnels before saving. |
| [349](#L349) | $sorted\_upsell\_funnels = $wps\_wocuf\_pro\_all\_funnels; |
| [350](#L350) |  |
| [351](#L351) | ksort( $sorted\_upsell\_funnels ); |
| [352](#L352) |  |
| [353](#L353) | update\_option( 'wps\_wocuf\_funnels\_list', $sorted\_upsell\_funnels ); |
| [354](#L354) | } |
| [355](#L355) | } |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | /\*\* |
| [359](#L359) | \* Smart Offer Upgrade. ( Will not work for Global Funnel ) |
| [360](#L360) | \*/ |
| [361](#L361) | if ( ! empty( $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_smart\_offer\_upgrade'] ) && 'yes' === $wps\_wocuf\_pro\_funnel\_data['wps\_wocuf\_smart\_offer\_upgrade'] && ! $is\_global\_funnel ) { |
| [362](#L362) |  |
| [363](#L363) | if ( ! empty( $item\_key ) ) { |
| [364](#L364) |  |
| [365](#L365) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_\_smart\_offer\_upgrade\_target\_key', $item\_key ); |
| [366](#L366) | } |
| [367](#L367) | } |
| [368](#L368) |  |
| [369](#L369) | // To skip funnel if any funnel offer product is already present during checkout ( Order Items ). |
| [370](#L370) | $wps\_upsell\_global\_settings = get\_option( 'wps\_upsell\_lite\_global\_options', array() ); |
| [371](#L371) |  |
| [372](#L372) | $skip\_similar\_offer = ! empty( $wps\_upsell\_global\_settings['skip\_similar\_offer'] ) ? $wps\_upsell\_global\_settings['skip\_similar\_offer'] : 'yes'; |
| [373](#L373) |  |
| [374](#L374) | if ( 'yes' === $skip\_similar\_offer ) { |
| [375](#L375) |  |
| [376](#L376) | $offer\_product\_in\_cart = false; |
| [377](#L377) |  |
| [378](#L378) | foreach ( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_products\_in\_offer'] as $product\_in\_funnel\_id\_array ) { |
| [379](#L379) |  |
| [380](#L380) | if ( ! empty( $product\_in\_funnel\_id\_array ) ) { |
| [381](#L381) |  |
| [382](#L382) | // In v2.0.0, it was array so handling accordingly. |
| [383](#L383) | if ( is\_array( $product\_in\_funnel\_id\_array ) && count( $product\_in\_funnel\_id\_array ) ) { |
| [384](#L384) |  |
| [385](#L385) | foreach ( $product\_in\_funnel\_id\_array as $product\_in\_funnel\_id ) { |
| [386](#L386) |  |
| [387](#L387) | foreach ( $wps\_wocuf\_pro\_placed\_order\_items as $item\_key => $wps\_wocuf\_pro\_single\_item ) { |
| [388](#L388) |  |
| [389](#L389) | /\*\* |
| [390](#L390) | \* Get get\_product()->get\_id() will return actual id, no need to call |
| [391](#L391) | \* get\_variation\_id() separately. |
| [392](#L392) | \*/ |
| [393](#L393) | if ( (int) $wps\_wocuf\_pro\_single\_item->get\_product()->get\_id() === absint( $product\_in\_funnel\_id ) ) { |
| [394](#L394) |  |
| [395](#L395) | $offer\_product\_in\_cart = true; |
| [396](#L396) | break 3; |
| [397](#L397) |  |
| [398](#L398) | } |
| [399](#L399) | } |
| [400](#L400) | } |
| [401](#L401) | } else { |
| [402](#L402) |  |
| [403](#L403) | foreach ( $wps\_wocuf\_pro\_placed\_order\_items as $item\_key => $wps\_wocuf\_pro\_single\_item ) { |
| [404](#L404) |  |
| [405](#L405) | /\*\* |
| [406](#L406) | \* Get get\_product()->get\_id() will return actual id, no need to call |
| [407](#L407) | \* get\_variation\_id() separately. |
| [408](#L408) | \*/ |
| [409](#L409) | if ( (int) $wps\_wocuf\_pro\_single\_item->get\_product()->get\_id() === absint( $product\_in\_funnel\_id\_array ) ) { |
| [410](#L410) |  |
| [411](#L411) | $offer\_product\_in\_cart = true; |
| [412](#L412) | break 2; |
| [413](#L413) |  |
| [414](#L414) | } |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) | } |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | if ( true === $offer\_product\_in\_cart ) { |
| [421](#L421) |  |
| [422](#L422) | break; |
| [423](#L423) | } |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | /\*\* |
| [427](#L427) | \* Smart Skip if already purchased. |
| [428](#L428) | \* since v3.0.0 |
| [429](#L429) | \*/ |
| [430](#L430) | $smart\_skip\_if\_purchased = ! empty( $wps\_upsell\_global\_settings['smart\_skip\_if\_purchased'] ) ? $wps\_upsell\_global\_settings['smart\_skip\_if\_purchased'] : ''; |
| [431](#L431) |  |
| [432](#L432) | if ( is\_user\_logged\_in() && 'yes' === $smart\_skip\_if\_purchased ) { |
| [433](#L433) |  |
| [434](#L434) | $offer\_product\_already\_purchased = false; |
| [435](#L435) |  |
| [436](#L436) | if ( ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_products\_in\_offer'] ) && is\_array( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_products\_in\_offer'] ) ) { |
| [437](#L437) |  |
| [438](#L438) | foreach ( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_products\_in\_offer'] as $single\_offer\_id ) { |
| [439](#L439) |  |
| [440](#L440) | if ( true === self::wps\_wocuf\_skip\_for\_pre\_order( $single\_offer\_id ) ) { |
| [441](#L441) |  |
| [442](#L442) | // If already purchased. |
| [443](#L443) | $offer\_product\_already\_purchased = true; |
| [444](#L444) | break; |
| [445](#L445) | } |
| [446](#L446) | } |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | if ( true === $offer\_product\_already\_purchased ) { |
| [450](#L450) |  |
| [451](#L451) | break; |
| [452](#L452) | } |
| [453](#L453) | } |
| [454](#L454) |  |
| [455](#L455) | // To skip funnel if any offer product in funnel is out of stock. |
| [456](#L456) |  |
| [457](#L457) | $product\_in\_funnel\_stock\_out = false; |
| [458](#L458) | foreach ( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_products\_in\_offer'] as $product\_in\_funnel\_id\_array ) { |
| [459](#L459) |  |
| [460](#L460) | if ( ! empty( $product\_in\_funnel\_id\_array ) ) { |
| [461](#L461) |  |
| [462](#L462) | // In v2.0.0, it was array so handling accordingly. |
| [463](#L463) | if ( is\_array( $product\_in\_funnel\_id\_array ) && count( $product\_in\_funnel\_id\_array ) ) { |
| [464](#L464) |  |
| [465](#L465) | foreach ( $product\_in\_funnel\_id\_array as $product\_in\_funnel\_id ) { |
| [466](#L466) |  |
| [467](#L467) | $product\_in\_funnel = wc\_get\_product( $product\_in\_funnel\_id ); |
| [468](#L468) |  |
| [469](#L469) | if ( ! $product\_in\_funnel->is\_in\_stock() ) { |
| [470](#L470) |  |
| [471](#L471) | $product\_in\_funnel\_stock\_out = true; |
| [472](#L472) | break 2; |
| [473](#L473) | } |
| [474](#L474) | } |
| [475](#L475) | } else { |
| [476](#L476) |  |
| [477](#L477) | $product\_in\_funnel = wc\_get\_product( $product\_in\_funnel\_id\_array ); |
| [478](#L478) |  |
| [479](#L479) | if ( ! $product\_in\_funnel->is\_in\_stock() ) { |
| [480](#L480) |  |
| [481](#L481) | $product\_in\_funnel\_stock\_out = true; |
| [482](#L482) | break; |
| [483](#L483) | } |
| [484](#L484) | } |
| [485](#L485) | } |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | if ( true === $product\_in\_funnel\_stock\_out ) { |
| [489](#L489) |  |
| [490](#L490) | break; |
| [491](#L491) | } |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | // $ocuf\_ofd is first offer id in funnel, check if product id is set in it. |
| [495](#L495) | if ( ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_products\_in\_offer'][ $ocuf\_ofd ] ) ) { |
| [496](#L496) |  |
| [497](#L497) | $funnel\_offer\_post\_id\_assigned = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_upsell\_post\_id\_assigned'][ $ocuf\_ofd ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_upsell\_post\_id\_assigned'][ $ocuf\_ofd ] : ''; |
| [498](#L498) |  |
| [499](#L499) | // When funnel is saved since v3.0.0 and offer post id is assigned and elementor active. |
| [500](#L500) | if ( ! empty( $funnel\_offer\_post\_id\_assigned ) && ( 'true' === $funnel\_saved\_after\_version\_3 && wps\_upsell\_lite\_elementor\_plugin\_active() ) || wps\_upsell\_divi\_builder\_plugin\_active() ) { |
| [501](#L501) |  |
| [502](#L502) | $redirect\_to\_upsell = false; |
| [503](#L503) |  |
| [504](#L504) | $offer\_template = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_pro\_offer\_template'][ $ocuf\_ofd ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_pro\_offer\_template'][ $ocuf\_ofd ] : ''; |
| [505](#L505) |  |
| [506](#L506) | // When template is set to custom. |
| [507](#L507) | if ( 'custom' === $offer\_template ) { |
| [508](#L508) |  |
| [509](#L509) | $custom\_offer\_page\_url = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_offer\_custom\_page\_url'][ $ocuf\_ofd ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_offer\_custom\_page\_url'][ $ocuf\_ofd ] : ''; |
| [510](#L510) |  |
| [511](#L511) | if ( ! empty( $custom\_offer\_page\_url ) ) { |
| [512](#L512) |  |
| [513](#L513) | $redirect\_to\_upsell = true; |
| [514](#L514) | $redirect\_to\_url    = $custom\_offer\_page\_url; |
| [515](#L515) | } |
| [516](#L516) | } elseif ( ! empty( $offer\_template ) ) { |
| [517](#L517) |  |
| [518](#L518) | // When template is set to one, two or three. |
| [519](#L519) | $offer\_assigned\_post\_id = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_upsell\_post\_id\_assigned'][ $ocuf\_ofd ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_upsell\_post\_id\_assigned'][ $ocuf\_ofd ] : ''; |
| [520](#L520) | if ( ! empty( $offer\_assigned\_post\_id ) && 'publish' === get\_post\_status( $offer\_assigned\_post\_id ) ) { |
| [521](#L521) |  |
| [522](#L522) | $redirect\_to\_upsell = true; |
| [523](#L523) | $redirect\_to\_url    = get\_page\_link( $offer\_assigned\_post\_id ); |
| [524](#L524) | } |
| [525](#L525) | } |
| [526](#L526) |  |
| [527](#L527) | if ( true === $redirect\_to\_upsell ) { |
| [528](#L528) |  |
| [529](#L529) | $funnel\_redirect = true; |
| [530](#L530) |  |
| [531](#L531) | $wps\_wocuf\_pro\_nonce = wp\_create\_nonce( 'funnel\_offers' ); |
| [532](#L532) |  |
| [533](#L533) | $result = add\_query\_arg( |
| [534](#L534) | array( |
| [535](#L535) | 'ocuf\_ns' => $wps\_wocuf\_pro\_nonce, |
| [536](#L536) | 'ocuf\_fid' => $wps\_wocuf\_pro\_single\_funnel, |
| [537](#L537) | 'ocuf\_ok' => $ocuf\_ok, |
| [538](#L538) | 'ocuf\_ofd' => $ocuf\_ofd, |
| [539](#L539) | ), |
| [540](#L540) | $redirect\_to\_url |
| [541](#L541) | ); |
| [542](#L542) |  |
| [543](#L543) | $wps\_wocuf\_pro\_flag = 1; |
| [544](#L544) |  |
| [545](#L545) | // Break from placed order items loop with both funnel redirect and pro flag as true. |
| [546](#L546) | break; |
| [547](#L547) | } |
| [548](#L548) | } else { // When funnel is saved before v3.0.0. |
| [549](#L549) | $wps\_wocuf\_pro\_offer\_page\_id = get\_option( 'wps\_wocuf\_pro\_funnel\_default\_offer\_page', '' ); |
| [550](#L550) |  |
| [551](#L551) | if ( isset( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_offer\_custom\_page\_url'][ $ocuf\_ofd ] ) && ! empty( $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_offer\_custom\_page\_url'][ $ocuf\_ofd ] ) ) { |
| [552](#L552) | $redirect\_to\_url = $wps\_wocuf\_pro\_all\_funnels[ $wps\_wocuf\_pro\_single\_funnel ]['wps\_wocuf\_offer\_custom\_page\_url'][ $ocuf\_ofd ]; |
| [553](#L553) | } elseif ( ! empty( $wps\_wocuf\_pro\_offer\_page\_id ) && 'publish' === get\_post\_status( $wps\_wocuf\_pro\_offer\_page\_id ) ) { |
| [554](#L554) | $redirect\_to\_url = get\_page\_link( $wps\_wocuf\_pro\_offer\_page\_id ); |
| [555](#L555) | } else { |
| [556](#L556) |  |
| [557](#L557) | // Break from placed order items loop and move to next funnel. |
| [558](#L558) | break; |
| [559](#L559) | } |
| [560](#L560) |  |
| [561](#L561) | $funnel\_redirect = true; |
| [562](#L562) |  |
| [563](#L563) | $wps\_wocuf\_pro\_nonce = wp\_create\_nonce( 'funnel\_offers' ); |
| [564](#L564) |  |
| [565](#L565) | $result = add\_query\_arg( |
| [566](#L566) | array( |
| [567](#L567) | 'ocuf\_ns' => $wps\_wocuf\_pro\_nonce, |
| [568](#L568) | 'ocuf\_fid' => $wps\_wocuf\_pro\_single\_funnel, |
| [569](#L569) | 'ocuf\_ok' => $ocuf\_ok, |
| [570](#L570) | 'ocuf\_ofd' => $ocuf\_ofd, |
| [571](#L571) | ), |
| [572](#L572) | $redirect\_to\_url |
| [573](#L573) | ); |
| [574](#L574) |  |
| [575](#L575) | $wps\_wocuf\_pro\_flag = 1; |
| [576](#L576) |  |
| [577](#L577) | // Break from placed order items loop with both funnel redirect and pro flag as true. |
| [578](#L578) | break; |
| [579](#L579) | } |
| [580](#L580) | } |
| [581](#L581) | } |
| [582](#L582) | } |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | if ( 1 === $wps\_wocuf\_pro\_flag ) { |
| [586](#L586) |  |
| [587](#L587) | // Break from 'all funnels' loop. |
| [588](#L588) | break; |
| [589](#L589) | } |
| [590](#L590) | } |
| [591](#L591) | } |
| [592](#L592) | if ( $funnel\_redirect ) { |
| [593](#L593) |  |
| [594](#L594) | // For cron - Upsell is initialized. As just going to Redirect. |
| [595](#L595) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, 'wps\_ocufp\_upsell\_initialized', time() ); |
| [596](#L596) |  |
| [597](#L597) | $this->initial\_redirection\_to\_upsell\_offer\_and\_triggers( $order\_id, $wps\_wocuf\_pro\_single\_funnel, $result ); |
| [598](#L598) |  |
| [599](#L599) | } else { |
| [600](#L600) |  |
| [601](#L601) | return; |
| [602](#L602) | } |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | return; |
| [606](#L606) |  |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) | /\*\* |
| [612](#L612) | \* Initial redirection to Upsell offers |
| [613](#L613) | \* and important Triggers. |
| [614](#L614) | \* |
| [615](#L615) | \* @param int   $order\_id order id. |
| [616](#L616) | \* @param mixed $funnel\_id funnel id. |
| [617](#L617) | \* @param mixed $upsell\_offer\_link upsell offer link. |
| [618](#L618) | \* @param mixed $safe\_redirect safe redirect. |
| [619](#L619) | \* |
| [620](#L620) | \* @since    3.0.0 |
| [621](#L621) | \*/ |
| [622](#L622) | public function initial\_redirection\_to\_upsell\_offer\_and\_triggers( $order\_id, $funnel\_id, $upsell\_offer\_link, $safe\_redirect = false ) { |
| [623](#L623) |  |
| [624](#L624) | /\*\* |
| [625](#L625) | \* As just going to redirect, means upsell is initialized for this order. |
| [626](#L626) | \* |
| [627](#L627) | \* This can be used to track upsell orders in which browser window was closed |
| [628](#L628) | \* and other purposes. |
| [629](#L629) | \*/ |
| [630](#L630) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, 'wps\_upsell\_order\_started', 'true' ); |
| [631](#L631) |  |
| [632](#L632) | // Add Upsell Funnel Id to order meta for Sales by Funnel tracking. |
| [633](#L633) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, 'wps\_upsell\_funnel\_id', $funnel\_id ); |
| [634](#L634) |  |
| [635](#L635) | // Add Funnel Triggered count and Offer View Count for the current Funnel. |
| [636](#L636) | $sales\_by\_funnel = new WPS\_Upsell\_Report\_Sales\_By\_Funnel( $funnel\_id ); |
| [637](#L637) | $sales\_by\_funnel->add\_funnel\_triggered\_count(); |
| [638](#L638) | $sales\_by\_funnel->add\_offer\_view\_count(); |
| [639](#L639) |  |
| [640](#L640) | // Store Order ID in session so it can be re-used after payment failure. |
| [641](#L641) | WC()->session->set( 'order\_awaiting\_payment', $order\_id ); |
| [642](#L642) |  |
| [643](#L643) | $upsell\_result = array( |
| [644](#L644) | 'result'   => 'success', |
| [645](#L645) | 'redirect' => $upsell\_offer\_link, |
| [646](#L646) | ); |
| [647](#L647) |  |
| [648](#L648) | $is\_block\_checkout = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_wocfo\_org\_checkout\_through\_block', true ); |
| [649](#L649) |  |
| [650](#L650) | if ( 'block\_checkout' == $is\_block\_checkout ) { |
| [651](#L651) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, 'wps\_wocfo\_upsell\_funnel\_redirection\_link\_org', $upsell\_offer\_link ); |
| [652](#L652) |  |
| [653](#L653) | } else { |
| [654](#L654) | // Redirect to upsell offer page. |
| [655](#L655) | if ( ! is\_ajax() ) { |
| [656](#L656) | wp\_redirect( $upsell\_result['redirect'] ); //phpcs:ignore |
| [657](#L657) | exit; |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | wp\_send\_json( $upsell\_result ); |
| [661](#L661) |  |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) |  |
| [667](#L667) | /\*\* |
| [668](#L668) | \* When user clicks on No thanks for Upsell offer. |
| [669](#L669) | \* |
| [670](#L670) | \* @since    1.0.0 |
| [671](#L671) | \*/ |
| [672](#L672) | public function wps\_wocuf\_pro\_process\_the\_funnel() { |
| [673](#L673) |  |
| [674](#L674) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [675](#L675) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [676](#L676) |  |
| [677](#L677) | if ( ! $id\_nonce\_verified ) { |
| [678](#L678) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | if ( isset( $\_GET['ocuf\_th'] ) && 1 === (int) $\_GET['ocuf\_th'] && isset( $\_GET['ocuf\_ofd'] ) && isset( $\_GET['ocuf\_fid'] ) && isset( $\_GET['ocuf\_ok'] ) && isset( $\_GET['ocuf\_ns'] ) ) { |
| [682](#L682) |  |
| [683](#L683) | $offer\_id = sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ofd'] ) ); |
| [684](#L684) |  |
| [685](#L685) | $funnel\_id = sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_fid'] ) ); |
| [686](#L686) |  |
| [687](#L687) | $order\_key = sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ); |
| [688](#L688) |  |
| [689](#L689) | $wp\_nonce = sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ns'] ) ); |
| [690](#L690) |  |
| [691](#L691) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [692](#L692) |  |
| [693](#L693) | if ( ! empty( $order\_id ) ) { |
| [694](#L694) |  |
| [695](#L695) | $order = wc\_get\_order( $order\_id ); |
| [696](#L696) |  |
| [697](#L697) | $already\_processed\_order\_statuses = array( |
| [698](#L698) | 'failed', |
| [699](#L699) | ); |
| [700](#L700) |  |
| [701](#L701) | // If order or payment is already processed. |
| [702](#L702) | if ( in\_array( $order->get\_status(), $already\_processed\_order\_statuses, true ) || $this->expire\_further\_offers( $order\_id ) ) { |
| [703](#L703) |  |
| [704](#L704) | $this->expire\_offer(); |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | // Check for offers processed. |
| [708](#L708) | $current\_offer\_id = $offer\_id; |
| [709](#L709) | $this->validate\_offers\_processed\_on\_upsell\_action( $order\_id, $current\_offer\_id ); |
| [710](#L710) | } |
| [711](#L711) |  |
| [712](#L712) | // Add Offer Reject Count for the current Funnel. |
| [713](#L713) | $sales\_by\_funnel = new WPS\_Upsell\_Report\_Sales\_By\_Funnel( $funnel\_id ); |
| [714](#L714) | $sales\_by\_funnel->add\_offer\_reject\_count(); |
| [715](#L715) |  |
| [716](#L716) | $wps\_wocuf\_pro\_all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [717](#L717) |  |
| [718](#L718) | $wps\_wocuf\_pro\_action\_on\_no = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_attached\_offers\_on\_no'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_attached\_offers\_on\_no'] : array(); |
| [719](#L719) |  |
| [720](#L720) | $wps\_wocuf\_pro\_check\_action = isset( $wps\_wocuf\_pro\_action\_on\_no[ $offer\_id ] ) ? $wps\_wocuf\_pro\_action\_on\_no[ $offer\_id ] : ''; |
| [721](#L721) |  |
| [722](#L722) | if ( 'thanks' === $wps\_wocuf\_pro\_check\_action ) { |
| [723](#L723) |  |
| [724](#L724) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [725](#L725) | } elseif ( 'thanks' !== $wps\_wocuf\_pro\_check\_action ) { |
| [726](#L726) |  |
| [727](#L727) | // Next offer id. |
| [728](#L728) | $offer\_id = $wps\_wocuf\_pro\_check\_action; |
| [729](#L729) |  |
| [730](#L730) | // Check if next offer has product. |
| [731](#L731) | $wps\_wocuf\_pro\_upcoming\_offer = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'][ $offer\_id ] : array(); |
| [732](#L732) |  |
| [733](#L733) | // If next offer has no product then redirect. |
| [734](#L734) | if ( empty( $wps\_wocuf\_pro\_upcoming\_offer ) ) { |
| [735](#L735) |  |
| [736](#L736) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [737](#L737) | } |
| [738](#L738) |  |
| [739](#L739) | $funnel\_saved\_after\_version\_3 = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_fsav3'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_fsav3'] : ''; |
| [740](#L740) |  |
| [741](#L741) | $funnel\_offer\_post\_id\_assigned = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_post\_id\_assigned'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_post\_id\_assigned'][ $offer\_id ] : ''; |
| [742](#L742) |  |
| [743](#L743) | // When funnel is saved since v3.0.0 and offer post id is assigned and elementor active. |
| [744](#L744) | if ( ! empty( $funnel\_offer\_post\_id\_assigned ) && ( 'true' === $funnel\_saved\_after\_version\_3 && wps\_upsell\_lite\_elementor\_plugin\_active() ) || wps\_upsell\_divi\_builder\_plugin\_active() ) { |
| [745](#L745) |  |
| [746](#L746) | $redirect\_to\_upsell = false; |
| [747](#L747) |  |
| [748](#L748) | $offer\_template = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_pro\_offer\_template'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_pro\_offer\_template'][ $offer\_id ] : ''; |
| [749](#L749) |  |
| [750](#L750) | // When template is set to custom. |
| [751](#L751) | if ( 'custom' === $offer\_template ) { |
| [752](#L752) |  |
| [753](#L753) | $custom\_offer\_page\_url = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ] : ''; |
| [754](#L754) |  |
| [755](#L755) | if ( ! empty( $custom\_offer\_page\_url ) ) { |
| [756](#L756) |  |
| [757](#L757) | $redirect\_to\_upsell = true; |
| [758](#L758) | $redirect\_to\_url    = $custom\_offer\_page\_url; |
| [759](#L759) | } |
| [760](#L760) | } elseif ( ! empty( $offer\_template ) ) { |
| [761](#L761) | // When template is set to one, two or three. |
| [762](#L762) | $offer\_assigned\_post\_id = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_post\_id\_assigned'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_post\_id\_assigned'][ $offer\_id ] : ''; |
| [763](#L763) |  |
| [764](#L764) | if ( ! empty( $offer\_assigned\_post\_id ) && 'publish' === get\_post\_status( $offer\_assigned\_post\_id ) ) { |
| [765](#L765) |  |
| [766](#L766) | $redirect\_to\_upsell = true; |
| [767](#L767) | $redirect\_to\_url    = get\_page\_link( $offer\_assigned\_post\_id ); |
| [768](#L768) | } |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | if ( true === $redirect\_to\_upsell ) { |
| [772](#L772) |  |
| [773](#L773) | $url = add\_query\_arg( |
| [774](#L774) | array( |
| [775](#L775) | 'ocuf\_ns'  => $wp\_nonce, |
| [776](#L776) | 'ocuf\_fid' => $funnel\_id, |
| [777](#L777) | 'ocuf\_ok'  => $order\_key, |
| [778](#L778) | 'ocuf\_ofd' => $offer\_id, |
| [779](#L779) | ), |
| [780](#L780) | $redirect\_to\_url |
| [781](#L781) | ); |
| [782](#L782) |  |
| [783](#L783) | // Set offers processed when there is another offer to come up means when not last offer. |
| [784](#L784) | $this->set\_offers\_processed\_on\_upsell\_action( $order\_id, $current\_offer\_id, $url ); |
| [785](#L785) |  |
| [786](#L786) | } else { |
| [787](#L787) |  |
| [788](#L788) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [789](#L789) | } |
| [790](#L790) | } else { // When funnel is saved before v3.0.0. |
| [791](#L791) |  |
| [792](#L792) | $wps\_wocuf\_pro\_offer\_page\_id = get\_option( 'wps\_wocuf\_pro\_funnel\_default\_offer\_page', '' ); |
| [793](#L793) |  |
| [794](#L794) | if ( isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ] ) && ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ] ) ) { |
| [795](#L795) |  |
| [796](#L796) | $wps\_wocuf\_pro\_next\_offer\_url = $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ]; |
| [797](#L797) | } elseif ( ! empty( $wps\_wocuf\_pro\_offer\_page\_id ) && get\_post\_status( 'publish' === $wps\_wocuf\_pro\_offer\_page\_id ) ) { |
| [798](#L798) |  |
| [799](#L799) | $wps\_wocuf\_pro\_next\_offer\_url = get\_page\_link( $wps\_wocuf\_pro\_offer\_page\_id ); |
| [800](#L800) | } else { |
| [801](#L801) |  |
| [802](#L802) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | $wps\_wocuf\_pro\_next\_offer\_url = add\_query\_arg( |
| [806](#L806) | array( |
| [807](#L807) | 'ocuf\_ns'  => $wp\_nonce, |
| [808](#L808) | 'ocuf\_fid' => $funnel\_id, |
| [809](#L809) | 'ocuf\_ok'  => $order\_key, |
| [810](#L810) | 'ocuf\_ofd' => $offer\_id, |
| [811](#L811) | ), |
| [812](#L812) | $wps\_wocuf\_pro\_next\_offer\_url |
| [813](#L813) | ); |
| [814](#L814) |  |
| [815](#L815) | $url = $wps\_wocuf\_pro\_next\_offer\_url; |
| [816](#L816) | } |
| [817](#L817) |  |
| [818](#L818) | // Add Offer View Count for the current Funnel. |
| [819](#L819) | $sales\_by\_funnel = new WPS\_Upsell\_Report\_Sales\_By\_Funnel( $funnel\_id ); |
| [820](#L820) | $sales\_by\_funnel->add\_offer\_view\_count(); |
| [821](#L821) |  |
| [822](#L822) | wp\_redirect( $url ); //phpcs:ignore |
| [823](#L823) | exit(); |
| [824](#L824) | } |
| [825](#L825) | } |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | /\*\* |
| [829](#L829) | \* Mwb\_wocuf\_pro\_funnel\_offers\_shortcode. |
| [830](#L830) | \* |
| [831](#L831) | \* @return $result |
| [832](#L832) | \*/ |
| [833](#L833) | public function wps\_wocuf\_pro\_funnel\_offers\_shortcode() { |
| [834](#L834) | $result = ''; |
| [835](#L835) |  |
| [836](#L836) | if ( isset( $\_GET['ocuf\_ok'] ) ) { |
| [837](#L837) | $order\_key = sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ); |
| [838](#L838) |  |
| [839](#L839) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [840](#L840) |  |
| [841](#L841) | if ( isset( $\_GET['ocuf\_ofd'] ) && isset( $\_GET['ocuf\_fid'] ) ) { |
| [842](#L842) | $offer\_id = sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ofd'] ) ); |
| [843](#L843) |  |
| [844](#L844) | $funnel\_id = sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_fid'] ) ); |
| [845](#L845) |  |
| [846](#L846) | if ( isset( $\_GET['ocuf\_ns'] ) ) { |
| [847](#L847) |  |
| [848](#L848) | $wp\_nonce = sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ns'] ) ); |
| [849](#L849) |  |
| [850](#L850) | wp\_verify\_nonce( $wp\_nonce, 'funnel\_offers' ); |
| [851](#L851) |  |
| [852](#L852) | $wps\_wocuf\_pro\_all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [853](#L853) |  |
| [854](#L854) | $wps\_wocuf\_pro\_buy\_text = get\_option( 'wps\_wocuf\_pro\_buy\_text', esc\_html\_\_( 'Buy Now', 'woo-one-click-upsell-funnel' ) ); |
| [855](#L855) |  |
| [856](#L856) | $wps\_wocuf\_pro\_no\_text = get\_option( 'wps\_wocuf\_pro\_no\_text', esc\_html\_\_( 'No,thanks', 'woo-one-click-upsell-funnel' ) ); |
| [857](#L857) |  |
| [858](#L858) | $wps\_wocuf\_pro\_before\_offer\_price\_text = get\_option( 'wps\_wocuf\_pro\_before\_offer\_price\_text', esc\_html\_\_( 'Special Offer Price', 'woo-one-click-upsell-funnel' ) ); |
| [859](#L859) |  |
| [860](#L860) | $wps\_wocuf\_pro\_offered\_products = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'] : array(); |
| [861](#L861) |  |
| [862](#L862) | $wps\_wocuf\_pro\_offered\_discount = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_discount\_price'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_discount\_price'] : array(); |
| [863](#L863) |  |
| [864](#L864) | $wps\_wocuf\_pro\_buy\_button\_color = get\_option( 'wps\_wocuf\_pro\_buy\_button\_color', '' ); |
| [865](#L865) |  |
| [866](#L866) | $ocuf\_th\_button\_color = get\_option( 'wps\_wocuf\_pro\_thanks\_button\_color', '' ); |
| [867](#L867) |  |
| [868](#L868) | $result .= '<div style="display:none;" id="wps\_wocuf\_pro\_offer\_loader"><img id="wps-wocuf-loading-offer" src="' . WPS\_WOCUF\_URL . 'public/images/ajax-loader.gif"></div><div class="wps\_wocuf\_pro\_offer\_container"><div class="woocommerce"><div class="wps\_wocuf\_pro\_special\_offers\_for\_you">'; |
| [869](#L869) |  |
| [870](#L870) | $wps\_wocuf\_pro\_offer\_banner\_text = get\_option( 'wps\_wocuf\_pro\_offer\_banner\_text', esc\_html\_\_( 'Special Offer For You Only', 'woo-one-click-upsell-funnel' ) ); |
| [871](#L871) |  |
| [872](#L872) | $result .= '<div class="wps\_wocuf\_pro\_special\_offer\_banner"> |
| [873](#L873) | <h1>' . trim( $wps\_wocuf\_pro\_offer\_banner\_text, '"' ) . '</h1></div>'; |
| [874](#L874) |  |
| [875](#L875) | $wps\_wocuf\_pro\_single\_offered\_product = ''; |
| [876](#L876) |  |
| [877](#L877) | if ( ! empty( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) ) { |
| [878](#L878) |  |
| [879](#L879) | // In v2.0.0, it was array so handling to get the first product id. |
| [880](#L880) | if ( is\_array( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) && count( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) ) { |
| [881](#L881) |  |
| [882](#L882) | foreach ( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] as $handling\_offer\_product\_id ) { |
| [883](#L883) |  |
| [884](#L884) | $wps\_wocuf\_pro\_single\_offered\_product = absint( $handling\_offer\_product\_id ); |
| [885](#L885) | break; |
| [886](#L886) | } |
| [887](#L887) | } else { |
| [888](#L888) |  |
| [889](#L889) | $wps\_wocuf\_pro\_single\_offered\_product = absint( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ); |
| [890](#L890) | } |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | $wps\_wocuf\_pro\_original\_offered\_product = wc\_get\_product( $wps\_wocuf\_pro\_single\_offered\_product ); |
| [894](#L894) |  |
| [895](#L895) | $original\_price = $wps\_wocuf\_pro\_original\_offered\_product->get\_price\_html(); |
| [896](#L896) |  |
| [897](#L897) | $product = $wps\_wocuf\_pro\_original\_offered\_product; |
| [898](#L898) |  |
| [899](#L899) | if ( ! $wps\_wocuf\_pro\_original\_offered\_product->is\_type( 'variable' ) ) { |
| [900](#L900) | $wps\_wocuf\_pro\_offered\_product = $this->wps\_wocuf\_pro\_change\_offered\_product\_price( $wps\_wocuf\_pro\_original\_offered\_product, $wps\_wocuf\_pro\_offered\_discount[ $offer\_id ] ); |
| [901](#L901) |  |
| [902](#L902) | $product = $wps\_wocuf\_pro\_offered\_product; |
| [903](#L903) | } |
| [904](#L904) |  |
| [905](#L905) | $result .= '<div class="wps\_wocuf\_pro\_main\_wrapper">'; |
| [906](#L906) |  |
| [907](#L907) | $image = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( $wps\_wocuf\_pro\_single\_offered\_product ), 'full' ); |
| [908](#L908) |  |
| [909](#L909) | if ( empty( $image[0] ) ) { |
| [910](#L910) | $image[0] = wc\_placeholder\_img\_src(); |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | $result .= '<div class="wps\_wocuf\_pro\_product\_image"><img src="' . $image[0] . '"></div>'; |
| [914](#L914) |  |
| [915](#L915) | $result .= '<div class="wps\_wocuf\_pro\_offered\_product"><div class="wps\_wocuf\_pro\_product\_title"><h2>' . $product->get\_title() . '</h2></div>'; |
| [916](#L916) |  |
| [917](#L917) | $result .= '<div class="wps\_wocuf\_pro\_offered\_product\_description"> |
| [918](#L918) | <p class="wps\_wocuf\_pro\_product\_desc">' . $product->get\_description() . '</p></div>'; |
| [919](#L919) |  |
| [920](#L920) | $result .= '<div class="wps\_wocuf\_pro\_product\_price"> |
| [921](#L921) | <h4>' . $wps\_wocuf\_pro\_before\_offer\_price\_text . ' : |
| [922](#L922) | ' . $product->get\_price\_html() . '</h4></div></div></div>'; |
| [923](#L923) |  |
| [924](#L924) | $result .= '<div class="wps\_wocuf\_pro\_offered\_product\_actions"> |
| [925](#L925) | <form class="wps\_wocuf\_pro\_offer\_form" method="post"> |
| [926](#L926) | <input type="hidden" name="ocuf\_ns" value="' . $wp\_nonce . '"> |
| [927](#L927) | <input type="hidden" name="ocuf\_fid" value="' . $funnel\_id . '"> |
| [928](#L928) | <input type="hidden" class="wps\_wocuf\_pro\_variation\_id" name="product\_id" value="' . absint( $product->get\_id() ) . '"> |
| [929](#L929) | <div id="wps\_wocuf\_pro\_variation\_attributes" ></div> |
| [930](#L930) | <input type="hidden" name="ocuf\_ofd" value="' . $offer\_id . '"> |
| [931](#L931) | <input type="hidden" name="ocuf\_ok" value="' . $order\_key . '"> |
| [932](#L932) | <input type="hidden" name="wps\_wocuf\_post\_nonce" value="' . wp\_create\_nonce( 'wps\_wocuf\_field\_post\_nonce' ) . '"> |
| [933](#L933) | <input type="hidden" name="wps\_wocuf\_after\_post\_nonce" value="' . wp\_create\_nonce( 'wps\_wocuf\_after\_field\_post\_nonce' ) . '"> |
| [934](#L934) | <button data-id="' . $funnel\_id . '" style="background-color:' . $wps\_wocuf\_pro\_buy\_button\_color . '" class="wps\_wocuf\_pro\_buy wps\_wocuf\_pro\_custom\_buy" type="submit" name="wps\_wocuf\_pro\_buy">' . $wps\_wocuf\_pro\_buy\_text . '</button></form> |
| [935](#L935) | <a style="color:' . $ocuf\_th\_button\_color . '" |
| [936](#L936) | class="wps\_wocuf\_pro\_skip wps\_wocuf\_pro\_no" |
| [937](#L937) | href="?ocuf\_ns=' . $wp\_nonce . ' |
| [938](#L938) | &ocuf\_th=1&ocuf\_ok=' . $order\_key . ' |
| [939](#L939) | &ocuf\_ofd=' . $offer\_id . ' |
| [940](#L940) | &ocuf\_fid=' . $funnel\_id . '"> |
| [941](#L941) | ' . $wps\_wocuf\_pro\_no\_text . '</a> |
| [942](#L942) | </div> |
| [943](#L943) | </div></div>'; |
| [944](#L944) |  |
| [945](#L945) | $result .= '</div>'; |
| [946](#L946) |  |
| [947](#L947) | $result .= '</div></div></div>'; |
| [948](#L948) | } else { |
| [949](#L949) | $error\_msg = esc\_html\_\_( 'You ran out of the special offers session.', 'woo-one-click-upsell-funnel' ); |
| [950](#L950) |  |
| [951](#L951) | $link\_text = esc\_html\_\_( 'Go to the "Order details" page.', 'woo-one-click-upsell-funnel' ); |
| [952](#L952) |  |
| [953](#L953) | $error\_msg = apply\_filters( 'wps\_wocuf\_pro\_error\_message', $error\_msg ); |
| [954](#L954) |  |
| [955](#L955) | $link\_text = apply\_filters( 'wps\_wocuf\_pro\_order\_details\_link\_text', $link\_text ); |
| [956](#L956) |  |
| [957](#L957) | $order\_received\_url = wc\_get\_endpoint\_url( 'order-received', $order\_id, wc\_get\_page\_permalink( 'checkout' ) ); |
| [958](#L958) |  |
| [959](#L959) | $order\_received\_url = add\_query\_arg( 'key', $order\_key, $order\_received\_url ); |
| [960](#L960) |  |
| [961](#L961) | $result .= $error\_msg . '<a href="' . $order\_received\_url . '" class="button">' . $link\_text . '</a>'; |
| [962](#L962) | } |
| [963](#L963) | } else { |
| [964](#L964) | $error\_msg = esc\_html\_\_( 'You ran out of the special offers session.', 'woo-one-click-upsell-funnel' ); |
| [965](#L965) |  |
| [966](#L966) | $link\_text = esc\_html\_\_( 'Go to the "Order details" page.', 'woo-one-click-upsell-funnel' ); |
| [967](#L967) |  |
| [968](#L968) | $error\_msg = apply\_filters( 'wps\_wocuf\_pro\_error\_message', $error\_msg ); |
| [969](#L969) |  |
| [970](#L970) | $link\_text = apply\_filters( 'wps\_wocuf\_pro\_order\_details\_link\_text', $link\_text ); |
| [971](#L971) |  |
| [972](#L972) | $order\_received\_url = wc\_get\_endpoint\_url( 'order-received', $order\_id, wc\_get\_page\_permalink( 'checkout' ) ); |
| [973](#L973) |  |
| [974](#L974) | $order\_received\_url = add\_query\_arg( 'key', $order\_key, $order\_received\_url ); |
| [975](#L975) |  |
| [976](#L976) | $result .= $error\_msg . '<a href="' . $order\_received\_url . '" class="button">' . $link\_text . '</a>'; |
| [977](#L977) | } |
| [978](#L978) | } |
| [979](#L979) |  |
| [980](#L980) | if ( ! isset( $\_GET['ocuf\_ok'] ) || ! isset( $\_GET['ocuf\_ofd'] ) || ! isset( $\_GET['ocuf\_fid'] ) ) { |
| [981](#L981) | $wps\_wocuf\_pro\_no\_offer\_text = get\_option( 'wps\_wocuf\_pro\_no\_offer\_text', esc\_html\_\_( 'Sorry, you have no offers', 'woo-one-click-upsell-funnel' ) ); |
| [982](#L982) |  |
| [983](#L983) | $result .= '<div class="wps-wocuf\_pro-no-offer"><h2>' . trim( $wps\_wocuf\_pro\_no\_offer\_text, '"' ) . '</h2>'; |
| [984](#L984) |  |
| [985](#L985) | $result .= '<a class="button wc-backward" href="' . esc\_url( apply\_filters( 'woocommerce\_return\_to\_shop\_redirect', wc\_get\_page\_permalink( 'shop' ) ) ) . '">' . esc\_html\_\_( 'Return to Shop', 'woo-one-click-upsell-funnel' ) . '</a></div>'; |
| [986](#L986) |  |
| [987](#L987) | } |
| [988](#L988) |  |
| [989](#L989) | return $result; |
| [990](#L990) | } |
| [991](#L991) |  |
| [992](#L992) | /\*\* |
| [993](#L993) | \* Applying offer discount on product price. |
| [994](#L994) | \* |
| [995](#L995) | \* @since    3.0.0 |
| [996](#L996) | \* @param    object $temp\_product    Object of product. |
| [997](#L997) | \* @param    string $price           Offer price. |
| [998](#L998) | \* @return   object     $temp\_product    Object of product with new offer price. |
| [999](#L999) | \*/ |
| [1000](#L1000) | public function wps\_wocuf\_pro\_change\_offered\_product\_price( $temp\_product, $price ) { |
| [1001](#L1001) |  |
| [1002](#L1002) | if ( ! empty( $price ) && ! empty( $temp\_product ) ) { |
| [1003](#L1003) |  |
| [1004](#L1004) | $payable\_price = $temp\_product->get\_price(); |
| [1005](#L1005) | $sale\_price    = $temp\_product->get\_sale\_price(); |
| [1006](#L1006) | $regular\_price = $temp\_product->get\_regular\_price(); |
| [1007](#L1007) | $is\_fixed      = false; |
| [1008](#L1008) |  |
| [1009](#L1009) | // Change amount in case of chargeable currency is different. |
| [1010](#L1010) | if ( ! empty( WC()->session ) && WC()->session->\_\_isset( 's\_selected\_currency' ) && function\_exists( 'wps\_wmcs\_fixed\_price\_for\_simple\_sales\_price' ) ) { |
| [1011](#L1011) | $\_regular\_price = wps\_wmcs\_fixed\_price\_for\_simple\_regular\_price( $temp\_product->get\_id() ); |
| [1012](#L1012) | $\_sale\_price    = wps\_wmcs\_fixed\_price\_for\_simple\_sales\_price( $temp\_product->get\_id() ); |
| [1013](#L1013) |  |
| [1014](#L1014) | $sale\_price    = ! empty( $\_sale\_price ) ? $\_sale\_price : $sale\_price; |
| [1015](#L1015) | $regular\_price = ! empty( $\_regular\_price ) ? $\_regular\_price : $regular\_price; |
| [1016](#L1016) | $payable\_price = ! empty( $sale\_price ) ? $sale\_price : $regular\_price; |
| [1017](#L1017) | if ( ! empty( $\_regular\_price ) || ! empty( $\_sale\_price ) ) { |
| [1018](#L1018) | $is\_fixed = true; |
| [1019](#L1019) | } |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) | // Discount is in %. |
| [1023](#L1023) | if ( false !== strpos( $price, '%' ) ) { |
| [1024](#L1024) |  |
| [1025](#L1025) | $discounted\_percent = trim( $price, '%' ); |
| [1026](#L1026) | $discounted\_price   = floatval( $payable\_price ) \* ( floatval( $discounted\_percent ) / 100 ); |
| [1027](#L1027) |  |
| [1028](#L1028) | // Original price must be greater than zero. |
| [1029](#L1029) | if ( $payable\_price > 0 ) { |
| [1030](#L1030) |  |
| [1031](#L1031) | $offer\_price = $payable\_price - $discounted\_price; |
| [1032](#L1032) |  |
| [1033](#L1033) | } else { |
| [1034](#L1034) |  |
| [1035](#L1035) | $offer\_price = $payable\_price; |
| [1036](#L1036) | } |
| [1037](#L1037) | } else { // Discount is fixed. |
| [1038](#L1038) |  |
| [1039](#L1039) | $offer\_price = floatval( $price ); |
| [1040](#L1040) | } |
| [1041](#L1041) |  |
| [1042](#L1042) | /\*\* |
| [1043](#L1043) | \* Original price : $payable\_price. |
| [1044](#L1044) | \* Sale price : $sale\_price. |
| [1045](#L1045) | \* Regular price : $regular\_price. |
| [1046](#L1046) | \* Offer price : $offer\_price. |
| [1047](#L1047) | \*/ |
| [1048](#L1048) | $wps\_upsell\_global\_settings = get\_option( 'wps\_upsell\_lite\_global\_options', array() ); |
| [1049](#L1049) |  |
| [1050](#L1050) | $price\_html\_format = ! empty( $wps\_upsell\_global\_settings['offer\_price\_html\_type'] ) ? $wps\_upsell\_global\_settings['offer\_price\_html\_type'] : 'regular'; |
| [1051](#L1051) |  |
| [1052](#L1052) | // ̶S̶a̶l̶e̶ ̶P̶r̶i̶c̶e̶  Offer Price. |
| [1053](#L1053) | if ( 'sale' === $price\_html\_format ) { |
| [1054](#L1054) |  |
| [1055](#L1055) | if ( ! empty( $sale\_price ) ) { |
| [1056](#L1056) |  |
| [1057](#L1057) | $temp\_product->set\_regular\_price( $sale\_price ); |
| [1058](#L1058) | $temp\_product->set\_sale\_price( $offer\_price ); |
| [1059](#L1059) | } else { |
| [1060](#L1060) |  |
| [1061](#L1061) | // No sale price is present. |
| [1062](#L1062) | $temp\_product->set\_sale\_price( $offer\_price ); |
| [1063](#L1063) | } |
| [1064](#L1064) | } else { // ̶R̶e̶g̶u̶l̶a̶r̶ ̶P̶r̶i̶c̶e̶ Offer Price. |
| [1065](#L1065) |  |
| [1066](#L1066) | // In this case set the regular price as sale. |
| [1067](#L1067) | $temp\_product->set\_sale\_price( $offer\_price ); |
| [1068](#L1068) | } |
| [1069](#L1069) |  |
| [1070](#L1070) | // Change amount in case of chargeable currency is different. |
| [1071](#L1071) | if ( false === $is\_fixed && ! empty( WC()->session ) && WC()->session->\_\_isset( 's\_selected\_currency' ) && class\_exists( 'Mwb\_Multi\_Currency\_Switcher\_For\_Woocommerce\_Public' ) ) { |
| [1072](#L1072) | $currency\_switcher\_obj = new Mwb\_Multi\_Currency\_Switcher\_For\_Woocommerce\_Public( 'WPS Multi Currency Switcher For WooCommerce', '1.2.0' ); |
| [1073](#L1073) | $offer\_price           = $currency\_switcher\_obj->wps\_mmcsfw\_get\_price\_of\_product( $offer\_price, $temp\_product->get\_id() ); |
| [1074](#L1074) | } |
| [1075](#L1075) |  |
| [1076](#L1076) | $temp\_product->set\_price( $offer\_price ); |
| [1077](#L1077) | } else { |
| [1078](#L1078) | /\*\* |
| [1079](#L1079) | \* If the discount is 0 and fixed. |
| [1080](#L1080) | \*/ |
| [1081](#L1081) | $temp\_product->set\_price( 0 ); |
| [1082](#L1082) | } |
| [1083](#L1083) |  |
| [1084](#L1084) | return $temp\_product; |
| [1085](#L1085) | } |
| [1086](#L1086) |  |
| [1087](#L1087) |  |
| [1088](#L1088) | /\*\* |
| [1089](#L1089) | \* When user clicks on Add upsell product to my Order. |
| [1090](#L1090) | \* |
| [1091](#L1091) | \* @since    1.0.0 |
| [1092](#L1092) | \*/ |
| [1093](#L1093) | public function wps\_wocuf\_pro\_charge\_the\_offer() { |
| [1094](#L1094) |  |
| [1095](#L1095) | $add\_product\_nonce = ! empty( $\_POST['wps\_wocuf\_post\_nonce'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['wps\_wocuf\_post\_nonce'] ) ) : ''; |
| [1096](#L1096) |  |
| [1097](#L1097) | if ( ( isset( $add\_product\_nonce ) ) && ( wp\_verify\_nonce( $add\_product\_nonce, 'wps\_wocuf\_field\_post\_nonce' ) && isset( $\_POST['wps\_wocuf\_pro\_buy'] ) ) || isset( $\_GET['wps\_wocuf\_pro\_buy'] ) ) { |
| [1098](#L1098) |  |
| [1099](#L1099) | unset( $\_POST['wps\_wocuf\_pro\_buy'] ); |
| [1100](#L1100) |  |
| [1101](#L1101) | $live\_offer\_url\_params = wps\_upsell\_lite\_live\_offer\_url\_params(); |
| [1102](#L1102) |  |
| [1103](#L1103) | if ( 'true' === $live\_offer\_url\_params['status'] ) { |
| [1104](#L1104) |  |
| [1105](#L1105) | $is\_product\_with\_variations = false; |
| [1106](#L1106) |  |
| [1107](#L1107) | if ( ! empty( $\_POST['wocuf\_var\_attb'] ) ) { |
| [1108](#L1108) |  |
| [1109](#L1109) | // Retrieve all variations from form. |
| [1110](#L1110) | $variation\_attributes = sanitize\_text\_field( wp\_unslash( $\_POST['wocuf\_var\_attb'] ) ); |
| [1111](#L1111) | $variation\_attributes = stripslashes( $variation\_attributes ); |
| [1112](#L1112) | $variation\_attributes = str\_replace( "'", '"', $variation\_attributes ); |
| [1113](#L1113) |  |
| [1114](#L1114) | $variation\_attributes = json\_decode( $variation\_attributes, true ); |
| [1115](#L1115) |  |
| [1116](#L1116) | $is\_product\_with\_variations = true; |
| [1117](#L1117) | } |
| [1118](#L1118) |  |
| [1119](#L1119) | $wp\_nonce = $live\_offer\_url\_params['upsell\_nonce']; |
| [1120](#L1120) |  |
| [1121](#L1121) | $offer\_id = $live\_offer\_url\_params['offer\_id']; |
| [1122](#L1122) |  |
| [1123](#L1123) | $funnel\_id = $live\_offer\_url\_params['funnel\_id']; |
| [1124](#L1124) |  |
| [1125](#L1125) | $product\_id = $live\_offer\_url\_params['product\_id']; |
| [1126](#L1126) | $order\_key = $live\_offer\_url\_params['order\_key']; |
| [1127](#L1127) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [1128](#L1128) | $shipping\_price = floatval( get\_post\_meta( $product\_id, 'wps\_upsell\_simple\_shipping\_product\_' . $product\_id, true ) ); |
| [1129](#L1129) | if ( ! empty( $shipping\_price ) ) { |
| [1130](#L1130) | $shipping\_price\_order = floatval( wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, 'wps\_upsell\_simple\_shipping\_product\_', true ) ); |
| [1131](#L1131) | $shipping\_price\_order += $shipping\_price; |
| [1132](#L1132) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, 'wps\_upsell\_simple\_shipping\_product\_', $shipping\_price\_order ); |
| [1133](#L1133) |  |
| [1134](#L1134) | } |
| [1135](#L1135) |  |
| [1136](#L1136) | $offer\_quantity = ! empty( $live\_offer\_url\_params['quantity'] ) ? $live\_offer\_url\_params['quantity'] : '1'; |
| [1137](#L1137) |  |
| [1138](#L1138) | if ( ! empty( $order\_id ) ) { |
| [1139](#L1139) |  |
| [1140](#L1140) | $order = wc\_get\_order( $order\_id ); |
| [1141](#L1141) |  |
| [1142](#L1142) | $already\_processed\_order\_statuses = array( |
| [1143](#L1143) | 'failed', |
| [1144](#L1144) | ); |
| [1145](#L1145) |  |
| [1146](#L1146) | // If order or payment is already processed. |
| [1147](#L1147) | if ( in\_array( $order->get\_status(), $already\_processed\_order\_statuses, true ) || $this->expire\_further\_offers( $order\_id ) ) { |
| [1148](#L1148) |  |
| [1149](#L1149) | $this->expire\_offer(); |
| [1150](#L1150) | } |
| [1151](#L1151) |  |
| [1152](#L1152) | // Check for offers processed. |
| [1153](#L1153) | $current\_offer\_id = $offer\_id; |
| [1154](#L1154) | $this->validate\_offers\_processed\_on\_upsell\_action( $order\_id, $current\_offer\_id ); |
| [1155](#L1155) | } |
| [1156](#L1156) |  |
| [1157](#L1157) | if ( ! empty( $order ) ) { |
| [1158](#L1158) | $upsell\_product = wc\_get\_product( $product\_id ); |
| [1159](#L1159) |  |
| [1160](#L1160) | if ( ! empty( $upsell\_product ) && $upsell\_product->is\_purchasable() ) { |
| [1161](#L1161) |  |
| [1162](#L1162) | $wps\_wocuf\_pro\_all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list' ); |
| [1163](#L1163) |  |
| [1164](#L1164) | $wps\_wocuf\_pro\_offered\_discount = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_discount\_price'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_discount\_price'][ $offer\_id ] : ''; |
| [1165](#L1165) |  |
| [1166](#L1166) | $upsell\_product = $this->wps\_wocuf\_pro\_change\_offered\_product\_price( $upsell\_product, $wps\_wocuf\_pro\_offered\_discount ); |
| [1167](#L1167) |  |
| [1168](#L1168) | if ( $is\_product\_with\_variations ) { |
| [1169](#L1169) |  |
| [1170](#L1170) | if ( 'variation' === $upsell\_product->get\_type() ) { |
| [1171](#L1171) |  |
| [1172](#L1172) | $upsell\_var\_attb = $upsell\_product->get\_variation\_attributes(); |
| [1173](#L1173) |  |
| [1174](#L1174) | // Variation has blank attribute when it is set as 'Any..' in backend. |
| [1175](#L1175) |  |
| [1176](#L1176) | // Check if upsell product variation has any blank attribute ? |
| [1177](#L1177) | if ( false !== array\_search( '', $upsell\_var\_attb, true ) ) { |
| [1178](#L1178) |  |
| [1179](#L1179) | // If yes then set attributes retrieved from form. |
| [1180](#L1180) | $upsell\_product->set\_attributes( $variation\_attributes ); |
| [1181](#L1181) | } |
| [1182](#L1182) | } |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) | $upsell\_item\_id = $order->add\_product( $upsell\_product, $offer\_quantity ); |
| [1186](#L1186) |  |
| [1187](#L1187) | // Add Offer Accept Count for the current Funnel. |
| [1188](#L1188) | $sales\_by\_funnel = new WPS\_Upsell\_Report\_Sales\_By\_Funnel( $funnel\_id ); |
| [1189](#L1189) | $sales\_by\_funnel->add\_offer\_accept\_count(); |
| [1190](#L1190) |  |
| [1191](#L1191) | $target\_item\_id = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_\_smart\_offer\_upgrade\_target\_key', true ); |
| [1192](#L1192) |  |
| [1193](#L1193) | $force\_payment = false; |
| [1194](#L1194) |  |
| [1195](#L1195) | if ( ! empty( $target\_item\_id ) && is\_numeric( $target\_item\_id ) ) { |
| [1196](#L1196) |  |
| [1197](#L1197) | foreach ( (array) $order->get\_items() as $item\_id => $item ) { |
| [1198](#L1198) |  |
| [1199](#L1199) | if ( (int) $item\_id === (int) $target\_item\_id ) { |
| [1200](#L1200) |  |
| [1201](#L1201) | $order->remove\_item( $item\_id ); |
| [1202](#L1202) | wps\_wocfo\_hpos\_delete\_meta\_data( $order\_id, '\_\_smart\_offer\_upgrade\_target\_key' ); |
| [1203](#L1203) | $force\_payment = true; |
| [1204](#L1204) | } |
| [1205](#L1205) | } |
| [1206](#L1206) |  |
| [1207](#L1207) | $order->save(); |
| [1208](#L1208) | } |
| [1209](#L1209) | foreach ( $order->get\_items() as $item\_id => $item ) { |
| [1210](#L1210) | // Check if this is the product you want to add custom meta to (optional). |
| [1211](#L1211) | if ( $item\_id == $upsell\_item\_id ) { |
| [1212](#L1212) | $item->add\_meta\_data( 'is\_upsell\_purchase', 'true' ); |
| [1213](#L1213) | } |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | $order->calculate\_totals(); |
| [1217](#L1217) |  |
| [1218](#L1218) | // Upsell product was purchased for this order. |
| [1219](#L1219) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, 'wps\_wocuf\_upsell\_order', 'true' ); |
| [1220](#L1220) |  |
| [1221](#L1221) | } |
| [1222](#L1222) |  |
| [1223](#L1223) | $wps\_wocuf\_pro\_all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [1224](#L1224) |  |
| [1225](#L1225) | $wps\_wocuf\_pro\_buy\_action = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_attached\_offers\_on\_buy'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_attached\_offers\_on\_buy'] : ''; |
| [1226](#L1226) |  |
| [1227](#L1227) | $url = ''; |
| [1228](#L1228) |  |
| [1229](#L1229) | /\*\* |
| [1230](#L1230) | \* After v3.4.1 :: Smart offer upgraded. |
| [1231](#L1231) | \* If target product is removed, then process the payment. |
| [1232](#L1232) | \*/ |
| [1233](#L1233) | if ( ! empty( $force\_payment ) && true === $force\_payment ) { |
| [1234](#L1234) |  |
| [1235](#L1235) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [1236](#L1236) | } elseif ( isset( $wps\_wocuf\_pro\_buy\_action[ $offer\_id ] ) && 'thanks' === $wps\_wocuf\_pro\_buy\_action[ $offer\_id ] ) { |
| [1237](#L1237) |  |
| [1238](#L1238) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [1239](#L1239) |  |
| [1240](#L1240) | } elseif ( isset( $wps\_wocuf\_pro\_buy\_action[ $offer\_id ] ) && 'thanks' !== $wps\_wocuf\_pro\_buy\_action[ $offer\_id ] ) { |
| [1241](#L1241) | // Next offer id. |
| [1242](#L1242) | $offer\_id = $wps\_wocuf\_pro\_buy\_action[ $offer\_id ]; |
| [1243](#L1243) |  |
| [1244](#L1244) | // Check if next offer has product. |
| [1245](#L1245) | $wps\_wocuf\_pro\_upcoming\_offer = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'][ $offer\_id ] : ''; |
| [1246](#L1246) |  |
| [1247](#L1247) | // If next offer has no product then redirect. |
| [1248](#L1248) | if ( empty( $wps\_wocuf\_pro\_upcoming\_offer ) ) { |
| [1249](#L1249) |  |
| [1250](#L1250) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [1251](#L1251) |  |
| [1252](#L1252) | } else { |
| [1253](#L1253) |  |
| [1254](#L1254) | $funnel\_saved\_after\_version\_3 = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_fsav3'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_fsav3'] : ''; |
| [1255](#L1255) |  |
| [1256](#L1256) | $funnel\_offer\_post\_id\_assigned = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_post\_id\_assigned'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_post\_id\_assigned'][ $offer\_id ] : ''; |
| [1257](#L1257) |  |
| [1258](#L1258) | // When funnel is saved since v3.0.0 and offer post id is assigned and elementor active. |
| [1259](#L1259) | if ( ! empty( $funnel\_offer\_post\_id\_assigned ) && ( 'true' === $funnel\_saved\_after\_version\_3 && wps\_upsell\_lite\_elementor\_plugin\_active() ) || wps\_upsell\_divi\_builder\_plugin\_active() ) { |
| [1260](#L1260) |  |
| [1261](#L1261) | $redirect\_to\_upsell = false; |
| [1262](#L1262) |  |
| [1263](#L1263) | $offer\_template = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_pro\_offer\_template'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_pro\_offer\_template'][ $offer\_id ] : ''; |
| [1264](#L1264) |  |
| [1265](#L1265) | // When template is set to custom. |
| [1266](#L1266) | if ( 'custom' === $offer\_template ) { |
| [1267](#L1267) |  |
| [1268](#L1268) | $custom\_offer\_page\_url = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ] : ''; |
| [1269](#L1269) |  |
| [1270](#L1270) | if ( ! empty( $custom\_offer\_page\_url ) ) { |
| [1271](#L1271) |  |
| [1272](#L1272) | $redirect\_to\_upsell = true; |
| [1273](#L1273) | $redirect\_to\_url    = $custom\_offer\_page\_url; |
| [1274](#L1274) | } |
| [1275](#L1275) | } elseif ( ! empty( $offer\_template ) ) { // When template is set to one, two or three. |
| [1276](#L1276) |  |
| [1277](#L1277) | $offer\_assigned\_post\_id = ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_post\_id\_assigned'][ $offer\_id ] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_upsell\_post\_id\_assigned'][ $offer\_id ] : ''; |
| [1278](#L1278) |  |
| [1279](#L1279) | if ( ! empty( $offer\_assigned\_post\_id ) && 'publish' === get\_post\_status( $offer\_assigned\_post\_id ) ) { |
| [1280](#L1280) |  |
| [1281](#L1281) | $redirect\_to\_upsell = true; |
| [1282](#L1282) | $redirect\_to\_url    = get\_page\_link( $offer\_assigned\_post\_id ); |
| [1283](#L1283) | } |
| [1284](#L1284) | } |
| [1285](#L1285) |  |
| [1286](#L1286) | if ( true === $redirect\_to\_upsell ) { |
| [1287](#L1287) |  |
| [1288](#L1288) | $url = add\_query\_arg( |
| [1289](#L1289) | array( |
| [1290](#L1290) | 'ocuf\_ns'  => $wp\_nonce, |
| [1291](#L1291) | 'ocuf\_fid' => $funnel\_id, |
| [1292](#L1292) | 'ocuf\_ok'  => $order\_key, |
| [1293](#L1293) | 'ocuf\_ofd' => $offer\_id, |
| [1294](#L1294) | ), |
| [1295](#L1295) | $redirect\_to\_url |
| [1296](#L1296) | ); |
| [1297](#L1297) |  |
| [1298](#L1298) | // Set offers processed when there is another offer to come up means when not last offer. |
| [1299](#L1299) | $this->set\_offers\_processed\_on\_upsell\_action( $order\_id, $current\_offer\_id, $url ); |
| [1300](#L1300) |  |
| [1301](#L1301) | } else { |
| [1302](#L1302) |  |
| [1303](#L1303) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [1304](#L1304) | } |
| [1305](#L1305) | } else { |
| [1306](#L1306) | // When funnel is saved before v3.0.0. |
| [1307](#L1307) | $wps\_wocuf\_pro\_offer\_page\_id = get\_option( 'wps\_wocuf\_pro\_funnel\_default\_offer\_page', '' ); |
| [1308](#L1308) |  |
| [1309](#L1309) | if ( isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ] ) && ! empty( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ] ) ) { |
| [1310](#L1310) |  |
| [1311](#L1311) | $wps\_wocuf\_pro\_next\_offer\_url = $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_custom\_page\_url'][ $offer\_id ]; |
| [1312](#L1312) | } elseif ( ! empty( $wps\_wocuf\_pro\_offer\_page\_id ) && 'publish' === get\_post\_status( $wps\_wocuf\_pro\_offer\_page\_id ) ) { |
| [1313](#L1313) |  |
| [1314](#L1314) | $wps\_wocuf\_pro\_next\_offer\_url = get\_page\_link( $wps\_wocuf\_pro\_offer\_page\_id ); |
| [1315](#L1315) | } else { |
| [1316](#L1316) |  |
| [1317](#L1317) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [1318](#L1318) | } |
| [1319](#L1319) |  |
| [1320](#L1320) | $url = add\_query\_arg( |
| [1321](#L1321) | array( |
| [1322](#L1322) | 'ocuf\_ns'  => $wp\_nonce, |
| [1323](#L1323) | 'ocuf\_fid' => $funnel\_id, |
| [1324](#L1324) | 'ocuf\_ok'  => $order\_key, |
| [1325](#L1325) | 'ocuf\_ofd' => $offer\_id, |
| [1326](#L1326) | ), |
| [1327](#L1327) | $wps\_wocuf\_pro\_next\_offer\_url |
| [1328](#L1328) | ); |
| [1329](#L1329) | } |
| [1330](#L1330) | } |
| [1331](#L1331) |  |
| [1332](#L1332) | // Add Offer View Count for the current Funnel. |
| [1333](#L1333) | $sales\_by\_funnel = new WPS\_Upsell\_Report\_Sales\_By\_Funnel( $funnel\_id ); |
| [1334](#L1334) | $sales\_by\_funnel->add\_offer\_view\_count(); |
| [1335](#L1335) |  |
| [1336](#L1336) | wp\_redirect( $url ); //phpcs:ignore |
| [1337](#L1337) | exit; |
| [1338](#L1338) | } |
| [1339](#L1339) | } else { |
| [1340](#L1340) |  |
| [1341](#L1341) | $this->initiate\_order\_payment\_and\_redirect( $order\_id ); |
| [1342](#L1342) | } |
| [1343](#L1343) | } |
| [1344](#L1344) | } |
| [1345](#L1345) | } |
| [1346](#L1346) |  |
| [1347](#L1347) | /\*\* |
| [1348](#L1348) | \* Add custom cron recurrence time interval. |
| [1349](#L1349) | \* |
| [1350](#L1350) | \* @since    1.0.0 |
| [1351](#L1351) | \* @param       array $schedules       Array of cron Schedule times for recurrence. |
| [1352](#L1352) | \*/ |
| [1353](#L1353) | public function set\_cron\_schedule\_time( $schedules ) { |
| [1354](#L1354) |  |
| [1355](#L1355) | if ( ! isset( $schedules['wps\_wocuf\_twenty\_minutes'] ) ) { |
| [1356](#L1356) |  |
| [1357](#L1357) | $schedules['wps\_wocuf\_twenty\_minutes'] = array( |
| [1358](#L1358) | 'interval' => 20 \* 60, |
| [1359](#L1359) | 'display'  => esc\_html\_\_( 'Once every 20 minutes', 'woo-one-click-upsell-funnel' ), |
| [1360](#L1360) | ); |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | return $schedules; |
| [1364](#L1364) | } |
| [1365](#L1365) |  |
| [1366](#L1366) | /\*\* |
| [1367](#L1367) | \* Cron schedule fire Event for Order payment process. |
| [1368](#L1368) | \* |
| [1369](#L1369) | \* @since    1.0.0 |
| [1370](#L1370) | \*/ |
| [1371](#L1371) | public function order\_payment\_cron\_fire\_event() { |
| [1372](#L1372) |  |
| [1373](#L1373) | // Pending Orders. |
| [1374](#L1374) | $pending\_upsell\_orders = get\_posts( |
| [1375](#L1375) | array( |
| [1376](#L1376) | 'numberposts' => -1, |
| [1377](#L1377) | 'post\_status' => 'wc-pending', |
| [1378](#L1378) | 'fields'      => 'ids', // return only ids. |
| [1379](#L1379) | 'meta\_key'    => 'wps\_ocufp\_upsell\_initialized', // phpcs:ignore |
| [1380](#L1380) | 'post\_type'   => 'shop\_order', |
| [1381](#L1381) | 'order'       => 'ASC', |
| [1382](#L1382) | ) |
| [1383](#L1383) | ); |
| [1384](#L1384) |  |
| [1385](#L1385) | if ( ! empty( $pending\_upsell\_orders ) && is\_array( $pending\_upsell\_orders ) && count( $pending\_upsell\_orders ) ) { |
| [1386](#L1386) |  |
| [1387](#L1387) | foreach ( $pending\_upsell\_orders as $order\_id ) { |
| [1388](#L1388) |  |
| [1389](#L1389) | $time\_stamp = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, 'wps\_ocufp\_upsell\_initialized', true ); |
| [1390](#L1390) |  |
| [1391](#L1391) | if ( ! empty( $time\_stamp ) ) { |
| [1392](#L1392) |  |
| [1393](#L1393) | $fifteen\_minutes = strtotime( '+15 minutes', $time\_stamp ); |
| [1394](#L1394) |  |
| [1395](#L1395) | $current\_time = time(); |
| [1396](#L1396) |  |
| [1397](#L1397) | $time\_diff = $fifteen\_minutes - $current\_time; |
| [1398](#L1398) |  |
| [1399](#L1399) | if ( 0 > $time\_diff ) { |
| [1400](#L1400) |  |
| [1401](#L1401) | global $woocommerce; |
| [1402](#L1402) |  |
| [1403](#L1403) | $gateways = $woocommerce->payment\_gateways->get\_available\_payment\_gateways(); |
| [1404](#L1404) |  |
| [1405](#L1405) | $order = new WC\_Order( $order\_id ); |
| [1406](#L1406) |  |
| [1407](#L1407) | // For cron - Payment initialized. |
| [1408](#L1408) | wps\_wocfo\_hpos\_delete\_meta\_data( $order\_id, 'wps\_ocufp\_upsell\_initialized' ); |
| [1409](#L1409) |  |
| [1410](#L1410) | $payment\_method = $order->get\_payment\_method(); |
| [1411](#L1411) |  |
| [1412](#L1412) | $gateways[ $payment\_method ]->process\_payment( $order\_id, 'cron' ); |
| [1413](#L1413) | } |
| [1414](#L1414) | } |
| [1415](#L1415) | } |
| [1416](#L1416) | } |
| [1417](#L1417) | } |
| [1418](#L1418) |  |
| [1419](#L1419) | /\*\* |
| [1420](#L1420) | \* Initiate Order Payment and redirect. |
| [1421](#L1421) | \* |
| [1422](#L1422) | \* @since    1.0.0 |
| [1423](#L1423) | \* @param    int $order\_id    Order ID. |
| [1424](#L1424) | \*/ |
| [1425](#L1425) | public function initiate\_order\_payment\_and\_redirect( $order\_id ) { |
| [1426](#L1426) |  |
| [1427](#L1427) | $order = new WC\_Order( $order\_id ); |
| [1428](#L1428) |  |
| [1429](#L1429) | if ( empty( $order ) ) { |
| [1430](#L1430) |  |
| [1431](#L1431) | return false; |
| [1432](#L1432) | } |
| [1433](#L1433) |  |
| [1434](#L1434) | // As Order Payment is initiated so Expire further Offers. |
| [1435](#L1435) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_upsell\_expire\_further\_offers', true ); |
| [1436](#L1436) |  |
| [1437](#L1437) | // Delete Offers Processed data as now we don't need it. |
| [1438](#L1438) | wps\_wocfo\_hpos\_delete\_meta\_data( $order\_id, '\_wps\_upsell\_offers\_processed' ); |
| [1439](#L1439) |  |
| [1440](#L1440) | $result = $this->upsell\_order\_final\_payment( $order\_id ); |
| [1441](#L1441) |  |
| [1442](#L1442) | $is\_block\_checkout = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_wocfo\_org\_checkout\_through\_block', true ); |
| [1443](#L1443) |  |
| [1444](#L1444) | if ( 'block\_checkout' == $is\_block\_checkout ) { |
| [1445](#L1445) |  |
| [1446](#L1446) | $url    = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, 'wps\_wocuf\_upsell\_funnel\_order\_redirection\_link', true ); |
| [1447](#L1447) |  |
| [1448](#L1448) | wp\_redirect( $url ); //phpcs:ignore |
| [1449](#L1449) | exit(); |
| [1450](#L1450) | } |
| [1451](#L1451) |  |
| [1452](#L1452) | $url = $order->get\_checkout\_order\_received\_url(); |
| [1453](#L1453) |  |
| [1454](#L1454) | if ( isset( $result['result'] ) && 'success' === $result['result'] ) { |
| [1455](#L1455) |  |
| [1456](#L1456) | wp\_redirect( $result['redirect'] ); //phpcs:ignore |
| [1457](#L1457) | exit; |
| [1458](#L1458) | } |
| [1459](#L1459) |  |
| [1460](#L1460) | if ( isset( $result['result'] ) && 'failure' === $result['result'] ) { |
| [1461](#L1461) |  |
| [1462](#L1462) | global $woocommerce; |
| [1463](#L1463) | $cart\_page\_url = function\_exists( 'wc\_get\_cart\_url' ) ? wc\_get\_cart\_url() : $woocommerce->cart->get\_cart\_url(); |
| [1464](#L1464) |  |
| [1465](#L1465) | wp\_redirect( $cart\_page\_url ); //phpcs:ignore |
| [1466](#L1466) | exit; |
| [1467](#L1467) | } else { |
| [1468](#L1468) |  |
| [1469](#L1469) | wp\_redirect( $url ); //phpcs:ignore |
| [1470](#L1470) | exit; |
| [1471](#L1471) | } |
| [1472](#L1472) | } |
| [1473](#L1473) |  |
| [1474](#L1474) |  |
| [1475](#L1475) | /\*\* |
| [1476](#L1476) | \* Process Payment for Upsell order. |
| [1477](#L1477) | \* |
| [1478](#L1478) | \* @since    1.0.0 |
| [1479](#L1479) | \* @param    int $order\_id    Order ID. |
| [1480](#L1480) | \*/ |
| [1481](#L1481) | public function upsell\_order\_final\_payment( $order\_id = '' ) { |
| [1482](#L1482) |  |
| [1483](#L1483) | if ( empty( $order\_id ) ) { |
| [1484](#L1484) |  |
| [1485](#L1485) | return false; |
| [1486](#L1486) | } |
| [1487](#L1487) | $order = new WC\_Order( $order\_id ); |
| [1488](#L1488) | $shipping\_price\_order = 0; |
| [1489](#L1489) | if ( ! empty( $order ) ) { |
| [1490](#L1490) | $shipping\_price\_order = floatval( wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, 'wps\_upsell\_simple\_shipping\_product\_', true ) ); |
| [1491](#L1491) | } |
| [1492](#L1492) |  |
| [1493](#L1493) | if ( 0 != $shipping\_price\_order && ! empty( $shipping\_price\_order ) ) { |
| [1494](#L1494) | $item\_ship = new WC\_Order\_Item\_Shipping(); |
| [1495](#L1495) | $item\_ship->set\_name( 'Upsell shipping' ); |
| [1496](#L1496) | $item\_ship->set\_total( $shipping\_price\_order ); |
| [1497](#L1497) | // Add Shipping item to the order. |
| [1498](#L1498) | $order->add\_item( $item\_ship ); |
| [1499](#L1499) | $order->calculate\_totals(); |
| [1500](#L1500) |  |
| [1501](#L1501) | } |
| [1502](#L1502) |  |
| [1503](#L1503) | global $woocommerce; |
| [1504](#L1504) |  |
| [1505](#L1505) | $gateways = $woocommerce->payment\_gateways->get\_available\_payment\_gateways(); |
| [1506](#L1506) |  |
| [1507](#L1507) | // For cron - Payment initialized. |
| [1508](#L1508) | wps\_wocfo\_hpos\_delete\_meta\_data( $order\_id, 'wps\_ocufp\_upsell\_initialized' ); |
| [1509](#L1509) |  |
| [1510](#L1510) | $payment\_method = $order->get\_payment\_method(); |
| [1511](#L1511) |  |
| [1512](#L1512) | $result = $gateways[ $payment\_method ]->process\_payment( $order\_id, 'true' ); |
| [1513](#L1513) | $order->reduce\_order\_stock(); |
| [1514](#L1514) | return $result; |
| [1515](#L1515) |  |
| [1516](#L1516) | } |
| [1517](#L1517) |  |
| [1518](#L1518) | /\*\* |
| [1519](#L1519) | \* Shortcodes for Upsell action and Product attributes. |
| [1520](#L1520) | \* The life of this plugin. |
| [1521](#L1521) | \* |
| [1522](#L1522) | \* @since    1.0.0 |
| [1523](#L1523) | \*/ |
| [1524](#L1524) | public function upsell\_shortcodes() { |
| [1525](#L1525) |  |
| [1526](#L1526) | // OLD shortcodes. |
| [1527](#L1527) |  |
| [1528](#L1528) | // Creating shortcode for accept link on custom page. |
| [1529](#L1529) | add\_shortcode( 'wps\_wocuf\_pro\_yes', array( $this, 'wps\_wocuf\_pro\_custom\_page\_action\_link\_yes' ) ); |
| [1530](#L1530) |  |
| [1531](#L1531) | // creating shortcode for thanks link on custom page. |
| [1532](#L1532) | add\_shortcode( 'wps\_wocuf\_pro\_no', array( $this, 'wps\_wocuf\_pro\_custom\_page\_action\_link\_no' ) ); |
| [1533](#L1533) |  |
| [1534](#L1534) | // creating shortcode for showing product price on custom page. |
| [1535](#L1535) | add\_shortcode( 'wps\_wocuf\_pro\_offer\_price', array( $this, 'wps\_wocuf\_pro\_custom\_page\_product\_offer\_price' ) ); |
| [1536](#L1536) | // creating shortcode for showing order details link on custom page. |
| [1537](#L1537) | add\_shortcode( 'wps\_wocuf\_pro\_order\_details', array( $this, 'wps\_wocuf\_pro\_custom\_page\_order\_details\_link' ) ); |
| [1538](#L1538) |  |
| [1539](#L1539) | // adding shortcode for default funnel offer page. |
| [1540](#L1540) | add\_shortcode( 'wps\_wocuf\_pro\_funnel\_default\_offer\_page', array( $this, 'wps\_wocuf\_pro\_funnel\_offers\_shortcode' ) ); |
| [1541](#L1541) |  |
| [1542](#L1542) | // New shortcodes. |
| [1543](#L1543) |  |
| [1544](#L1544) | // Upsell Action. |
| [1545](#L1545) |  |
| [1546](#L1546) | add\_shortcode( 'wps\_upsell\_yes', array( $this, 'buy\_now\_shortcode\_content' ) ); |
| [1547](#L1547) |  |
| [1548](#L1548) | add\_shortcode( 'wps\_upsell\_no', array( $this, 'no\_thanks\_shortcode\_content' ) ); |
| [1549](#L1549) |  |
| [1550](#L1550) | // Product. |
| [1551](#L1551) | add\_shortcode( 'wps\_upsell\_title', array( $this, 'product\_title\_shortcode\_content' ) ); |
| [1552](#L1552) |  |
| [1553](#L1553) | add\_shortcode( 'wps\_upsell\_desc', array( $this, 'product\_description\_shortcode\_content' ) ); |
| [1554](#L1554) |  |
| [1555](#L1555) | add\_shortcode( 'wps\_upsell\_desc\_short', array( $this, 'product\_short\_description\_shortcode\_content' ) ); |
| [1556](#L1556) |  |
| [1557](#L1557) | add\_shortcode( 'wps\_upsell\_image', array( $this, 'product\_image\_shortcode\_content' ) ); |
| [1558](#L1558) |  |
| [1559](#L1559) | add\_shortcode( 'wps\_upsell\_price', array( $this, 'product\_price\_shortcode\_content' ) ); |
| [1560](#L1560) |  |
| [1561](#L1561) | add\_shortcode( 'wps\_upsell\_product\_shipping\_price', array( $this, 'upsell\_product\_shipping\_price\_shortcode\_content' ) ); |
| [1562](#L1562) |  |
| [1563](#L1563) | add\_shortcode( 'wps\_upsell\_variations', array( $this, 'variations\_selector\_shortcode\_content' ) ); |
| [1564](#L1564) |  |
| [1565](#L1565) | // Review. |
| [1566](#L1566) | add\_shortcode( 'wps\_upsell\_star\_review', array( $this, 'product\_star\_review' ) ); |
| [1567](#L1567) |  |
| [1568](#L1568) | // Default Gutenberg offer. |
| [1569](#L1569) | add\_shortcode( 'wps\_upsell\_default\_offer\_identification', array( $this, 'default\_offer\_identification' ) ); |
| [1570](#L1570) |  |
| [1571](#L1571) | /\*\* |
| [1572](#L1572) | \* Shortcodes since v3.0.0. |
| [1573](#L1573) | \* Quantity Field and Timer Shortcode. |
| [1574](#L1574) | \*/ |
| [1575](#L1575) | add\_shortcode( 'wps\_upsell\_timer', array( $this, 'timer\_shortcode\_content' ) ); |
| [1576](#L1576) |  |
| [1577](#L1577) | add\_shortcode( 'wps\_upsell\_quantity', array( $this, 'quantity\_shortcode\_content' ) ); |
| [1578](#L1578) | } |
| [1579](#L1579) |  |
| [1580](#L1580) | /\*\* |
| [1581](#L1581) | \* Remove http and https from Upsell Action shortcodes added by Page Builders. |
| [1582](#L1582) | \* |
| [1583](#L1583) | \* @param string $content content. |
| [1584](#L1584) | \* |
| [1585](#L1585) | \* @since    2.0.3 |
| [1586](#L1586) | \*/ |
| [1587](#L1587) | public function filter\_upsell\_shortcodes\_content( $content = '' ) { |
| [1588](#L1588) |  |
| [1589](#L1589) | $upsell\_yes\_shortcode = array( 'http://?wps\_wocuf\_pro\_buy', 'https://?wps\_wocuf\_pro\_buy' ); |
| [1590](#L1590) | $upsell\_no\_shortcode  = array( 'http://?ocuf\_ns', 'https://?ocuf\_ns' ); |
| [1591](#L1591) |  |
| [1592](#L1592) | $content = str\_replace( $upsell\_yes\_shortcode, '?wps\_wocuf\_pro\_buy', $content ); |
| [1593](#L1593) | $content = str\_replace( $upsell\_no\_shortcode, '?ocuf\_ns', $content ); |
| [1594](#L1594) |  |
| [1595](#L1595) | $upsell\_yes\_shortcode = array( 'http://[wps\_upsell\_yes]', 'https://[wps\_upsell\_yes]' ); |
| [1596](#L1596) | $upsell\_no\_shortcode  = array( 'http://[wps\_upsell\_no]', 'https://[wps\_upsell\_no]' ); |
| [1597](#L1597) |  |
| [1598](#L1598) | $content = str\_replace( $upsell\_yes\_shortcode, '[wps\_upsell\_yes]', $content ); |
| [1599](#L1599) | $content = str\_replace( $upsell\_no\_shortcode, '[wps\_upsell\_no]', $content ); |
| [1600](#L1600) |  |
| [1601](#L1601) | return $content; |
| [1602](#L1602) | } |
| [1603](#L1603) |  |
| [1604](#L1604) | /\*\* |
| [1605](#L1605) | \* Get upsell product id from offer page id. |
| [1606](#L1606) | \* |
| [1607](#L1607) | \* @since    3.0.0 |
| [1608](#L1608) | \*/ |
| [1609](#L1609) | public function get\_upsell\_product\_id\_for\_shortcode() { |
| [1610](#L1610) |  |
| [1611](#L1611) | // Firstly try to get product id from url offer and funnel id i.e. the case of live offer. |
| [1612](#L1612) |  |
| [1613](#L1613) | $product\_id\_from\_get = wps\_upsell\_lite\_get\_pid\_from\_url\_params(); |
| [1614](#L1614) |  |
| [1615](#L1615) | // When it is live offer. |
| [1616](#L1616) | if ( 'true' === $product\_id\_from\_get['status'] ) { |
| [1617](#L1617) |  |
| [1618](#L1618) | $funnel\_id = $product\_id\_from\_get['funnel\_id']; |
| [1619](#L1619) | $offer\_id  = $product\_id\_from\_get['offer\_id']; |
| [1620](#L1620) |  |
| [1621](#L1621) | // Get all funnels. |
| [1622](#L1622) | $all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [1623](#L1623) |  |
| [1624](#L1624) | $product\_id = ! empty( $all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'][ $offer\_id ] ) ? $all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'][ $offer\_id ] : ''; |
| [1625](#L1625) |  |
| [1626](#L1626) | return $product\_id; |
| [1627](#L1627) | } |
| [1628](#L1628) |  |
| [1629](#L1629) | // Will only execute from here when it is not live offer. |
| [1630](#L1630) |  |
| [1631](#L1631) | // Get product id from current offer page post id. |
| [1632](#L1632) | global $post; |
| [1633](#L1633) | $offer\_page\_id = $post->ID; |
| [1634](#L1634) |  |
| [1635](#L1635) | // Means this is Upsell offer template. |
| [1636](#L1636) | $funnel\_data = get\_post\_meta( $offer\_page\_id, 'wps\_upsell\_funnel\_data', true ); |
| [1637](#L1637) |  |
| [1638](#L1638) | $product\_found\_in\_funnel = false; |
| [1639](#L1639) |  |
| [1640](#L1640) | if ( ! empty( $funnel\_data ) && is\_array( $funnel\_data ) && count( $funnel\_data ) ) { |
| [1641](#L1641) |  |
| [1642](#L1642) | $funnel\_id = $funnel\_data['funnel\_id']; |
| [1643](#L1643) | $offer\_id  = $funnel\_data['offer\_id']; |
| [1644](#L1644) |  |
| [1645](#L1645) | // Get all funnels. |
| [1646](#L1646) | $all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [1647](#L1647) |  |
| [1648](#L1648) | $product\_id = ! empty( $all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'][ $offer\_id ] ) ? $all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'][ $offer\_id ] : ''; |
| [1649](#L1649) |  |
| [1650](#L1650) | if ( ! empty( $product\_id ) ) { |
| [1651](#L1651) |  |
| [1652](#L1652) | $product\_found\_in\_funnel = true; |
| [1653](#L1653) | return $product\_id; |
| [1654](#L1654) | } |
| [1655](#L1655) | } |
| [1656](#L1656) |  |
| [1657](#L1657) | // Get global product only for Custom Offer page and not for Upsell offer templates. |
| [1658](#L1658) | if ( empty( $funnel\_data ) && ! $product\_found\_in\_funnel ) { |
| [1659](#L1659) |  |
| [1660](#L1660) | $wps\_upsell\_global\_settings = get\_option( 'wps\_upsell\_lite\_global\_options', array() ); |
| [1661](#L1661) |  |
| [1662](#L1662) | $product\_id = ! empty( $wps\_upsell\_global\_settings['global\_product\_id'] ) ? $wps\_upsell\_global\_settings['global\_product\_id'] : ''; |
| [1663](#L1663) |  |
| [1664](#L1664) | if ( ! empty( $product\_id ) ) { |
| [1665](#L1665) |  |
| [1666](#L1666) | return $product\_id; |
| [1667](#L1667) | } |
| [1668](#L1668) | } |
| [1669](#L1669) |  |
| [1670](#L1670) | /\*\* |
| [1671](#L1671) | \* Product not selected? show alert! Will run one time in one reload. |
| [1672](#L1672) | \* Run this alert only on a page. |
| [1673](#L1673) | \*/ |
| [1674](#L1674) | if ( is\_page() && false === wp\_cache\_get( 'wps\_upsell\_no\_product\_in\_offer' ) ) { |
| [1675](#L1675) |  |
| [1676](#L1676) | $product\_not\_selected\_alert = esc\_html\_\_( 'One Click Upsell', 'woo-one-click-upsell-funnel' ); |
| [1677](#L1677) |  |
| [1678](#L1678) | // For Upsell offer template. |
| [1679](#L1679) | if ( ! empty( $funnel\_data ) ) { |
| [1680](#L1680) |  |
| [1681](#L1681) | $product\_not\_selected\_content = esc\_html\_\_( 'Offer Product is not selected, please save a Offer Product in Funnel Offer settings.', 'woo-one-click-upsell-funnel' ); |
| [1682](#L1682) | } else { |
| [1683](#L1683) |  |
| [1684](#L1684) | // For Custom offer page. |
| [1685](#L1685) | $product\_not\_selected\_content = esc\_html\_\_( 'Custom Offer page - detected! Please save a global Offer product in Global settings for testing purpose.', 'woo-one-click-upsell-funnel' ); |
| [1686](#L1686) | } |
| [1687](#L1687) |  |
| [1688](#L1688) | ?> |
| [1689](#L1689) |  |
| [1690](#L1690) | <script type="text/javascript"> |
| [1691](#L1691) |  |
| [1692](#L1692) | var product\_not\_selected\_alert = '<?php echo esc\_html( $product\_not\_selected\_alert ); ?>'; |
| [1693](#L1693) |  |
| [1694](#L1694) | var product\_not\_selected\_content = '<?php echo esc\_html( $product\_not\_selected\_content ); ?> '; |
| [1695](#L1695) |  |
| [1696](#L1696) | swal( product\_not\_selected\_alert , product\_not\_selected\_content, 'warning' ); |
| [1697](#L1697) | </script> |
| [1698](#L1698) |  |
| [1699](#L1699) | <?php |
| [1700](#L1700) | } |
| [1701](#L1701) |  |
| [1702](#L1702) | wp\_cache\_set( 'wps\_upsell\_no\_product\_in\_offer', 'true' ); |
| [1703](#L1703) |  |
| [1704](#L1704) | } |
| [1705](#L1705) |  |
| [1706](#L1706) | /\*\* |
| [1707](#L1707) | \* Validate shortcode for rendering content according to user( live offer ) |
| [1708](#L1708) | \* and admin ( for viewing purpose ). |
| [1709](#L1709) | \* |
| [1710](#L1710) | \* @since    3.0.0 |
| [1711](#L1711) | \*/ |
| [1712](#L1712) | public function validate\_shortcode() { |
| [1713](#L1713) |  |
| [1714](#L1714) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [1715](#L1715) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [1716](#L1716) |  |
| [1717](#L1717) | if ( ! $id\_nonce\_verified ) { |
| [1718](#L1718) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [1719](#L1719) | } |
| [1720](#L1720) |  |
| [1721](#L1721) | if ( isset( $\_GET['ocuf\_ns'] ) && isset( $\_GET['ocuf\_ok'] ) && isset( $\_GET['ocuf\_ofd'] ) && isset( $\_GET['ocuf\_fid'] ) ) { |
| [1722](#L1722) |  |
| [1723](#L1723) | if ( wps\_upsell\_lite\_validate\_upsell\_nonce() ) { |
| [1724](#L1724) |  |
| [1725](#L1725) | return 'live\_offer'; |
| [1726](#L1726) | } |
| [1727](#L1727) | } elseif ( current\_user\_can( 'manage\_options' ) ) { |
| [1728](#L1728) |  |
| [1729](#L1729) | return 'admin\_view'; |
| [1730](#L1730) | } |
| [1731](#L1731) |  |
| [1732](#L1732) | return false; |
| [1733](#L1733) | } |
| [1734](#L1734) |  |
| [1735](#L1735) | /\*\* |
| [1736](#L1736) | \* Shortcode for Upsell product title. |
| [1737](#L1737) | \* Returns : Just the Content :) |
| [1738](#L1738) | \* |
| [1739](#L1739) | \* @since       3.0.0 |
| [1740](#L1740) | \*/ |
| [1741](#L1741) | public function product\_title\_shortcode\_content() { |
| [1742](#L1742) |  |
| [1743](#L1743) | $validate\_shortcode = $this->validate\_shortcode(); |
| [1744](#L1744) |  |
| [1745](#L1745) | if ( $validate\_shortcode ) { |
| [1746](#L1746) |  |
| [1747](#L1747) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [1748](#L1748) |  |
| [1749](#L1749) | if ( ! empty( $product\_id ) ) { |
| [1750](#L1750) |  |
| [1751](#L1751) | $post\_type = get\_post\_type( $product\_id ); |
| [1752](#L1752) |  |
| [1753](#L1753) | if ( 'product' !== $post\_type && 'product\_variation' !== $post\_type ) { |
| [1754](#L1754) |  |
| [1755](#L1755) | return ''; |
| [1756](#L1756) | } |
| [1757](#L1757) |  |
| [1758](#L1758) | $upsell\_product = wc\_get\_product( $product\_id ); |
| [1759](#L1759) |  |
| [1760](#L1760) | $upsell\_product\_title = $upsell\_product->get\_title(); |
| [1761](#L1761) | $upsell\_product\_title = ! empty( $upsell\_product\_title ) ? $upsell\_product\_title : ''; |
| [1762](#L1762) |  |
| [1763](#L1763) | return $upsell\_product\_title; |
| [1764](#L1764) | } |
| [1765](#L1765) | } |
| [1766](#L1766) |  |
| [1767](#L1767) | } |
| [1768](#L1768) |  |
| [1769](#L1769) | /\*\* |
| [1770](#L1770) | \* Shortcode for Upsell product description. |
| [1771](#L1771) | \* Returns : Just the Content :) |
| [1772](#L1772) | \* |
| [1773](#L1773) | \* @since       3.0.0 |
| [1774](#L1774) | \*/ |
| [1775](#L1775) | public function product\_description\_shortcode\_content() { |
| [1776](#L1776) |  |
| [1777](#L1777) | $validate\_shortcode = $this->validate\_shortcode(); |
| [1778](#L1778) |  |
| [1779](#L1779) | if ( $validate\_shortcode ) { |
| [1780](#L1780) |  |
| [1781](#L1781) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [1782](#L1782) |  |
| [1783](#L1783) | if ( ! empty( $product\_id ) ) { |
| [1784](#L1784) |  |
| [1785](#L1785) | $post\_type = get\_post\_type( $product\_id ); |
| [1786](#L1786) |  |
| [1787](#L1787) | if ( 'product' !== $post\_type && 'product\_variation' !== $post\_type ) { |
| [1788](#L1788) |  |
| [1789](#L1789) | return ''; |
| [1790](#L1790) | } |
| [1791](#L1791) |  |
| [1792](#L1792) | $upsell\_product = wc\_get\_product( $product\_id ); |
| [1793](#L1793) |  |
| [1794](#L1794) | $upsell\_product\_desc = $upsell\_product->get\_description(); |
| [1795](#L1795) | $upsell\_product\_desc = ! empty( $upsell\_product\_desc ) ? $upsell\_product\_desc : ''; |
| [1796](#L1796) |  |
| [1797](#L1797) | return $upsell\_product\_desc; |
| [1798](#L1798) | } |
| [1799](#L1799) | } |
| [1800](#L1800) |  |
| [1801](#L1801) | } |
| [1802](#L1802) |  |
| [1803](#L1803) | /\*\* |
| [1804](#L1804) | \* Shortcode for Upsell product short description. |
| [1805](#L1805) | \* Returns : Just the Content :) |
| [1806](#L1806) | \* |
| [1807](#L1807) | \* @since       3.0.0 |
| [1808](#L1808) | \*/ |
| [1809](#L1809) | public function product\_short\_description\_shortcode\_content() { |
| [1810](#L1810) |  |
| [1811](#L1811) | $validate\_shortcode = $this->validate\_shortcode(); |
| [1812](#L1812) |  |
| [1813](#L1813) | if ( $validate\_shortcode ) { |
| [1814](#L1814) |  |
| [1815](#L1815) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [1816](#L1816) |  |
| [1817](#L1817) | if ( ! empty( $product\_id ) ) { |
| [1818](#L1818) |  |
| [1819](#L1819) | $post\_type = get\_post\_type( $product\_id ); |
| [1820](#L1820) |  |
| [1821](#L1821) | if ( 'product' !== $post\_type && 'product\_variation' !== $post\_type ) { |
| [1822](#L1822) |  |
| [1823](#L1823) | return ''; |
| [1824](#L1824) | } |
| [1825](#L1825) |  |
| [1826](#L1826) | $upsell\_product = wc\_get\_product( $product\_id ); |
| [1827](#L1827) |  |
| [1828](#L1828) | $upsell\_product\_short\_desc = $upsell\_product->get\_short\_description(); |
| [1829](#L1829) | $upsell\_product\_short\_desc = ! empty( $upsell\_product\_short\_desc ) ? $upsell\_product\_short\_desc : ''; |
| [1830](#L1830) |  |
| [1831](#L1831) | return $upsell\_product\_short\_desc; |
| [1832](#L1832) | } |
| [1833](#L1833) | } |
| [1834](#L1834) |  |
| [1835](#L1835) | } |
| [1836](#L1836) |  |
| [1837](#L1837) | /\*\* |
| [1838](#L1838) | \* Shortcode for Upsell product image. |
| [1839](#L1839) | \* |
| [1840](#L1840) | \* @param mixed $atts shortcode attributes. |
| [1841](#L1841) | \* @since       3.0.0 |
| [1842](#L1842) | \*/ |
| [1843](#L1843) | public function product\_image\_shortcode\_content( $atts ) { |
| [1844](#L1844) |  |
| [1845](#L1845) | $validate\_shortcode = $this->validate\_shortcode(); |
| [1846](#L1846) | if ( $validate\_shortcode ) { |
| [1847](#L1847) |  |
| [1848](#L1848) | $live\_params\_from\_url = wps\_upsell\_lite\_get\_pid\_from\_url\_params(); |
| [1849](#L1849) |  |
| [1850](#L1850) | // When Live Offer. |
| [1851](#L1851) | if ( ! empty( $live\_params\_from\_url['status'] ) && 'true' === $live\_params\_from\_url['status'] ) { |
| [1852](#L1852) |  |
| [1853](#L1853) | $offer\_id  = ! empty( $live\_params\_from\_url['offer\_id'] ) ? wc\_clean( $live\_params\_from\_url['offer\_id'] ) : ''; |
| [1854](#L1854) | $funnel\_id = ! empty( $live\_params\_from\_url['funnel\_id'] ) ? wc\_clean( $live\_params\_from\_url['funnel\_id'] ) : ''; |
| [1855](#L1855) |  |
| [1856](#L1856) | if ( ! empty( $funnel\_id ) && ! empty( $offer\_id ) ) { |
| [1857](#L1857) |  |
| [1858](#L1858) | $all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [1859](#L1859) |  |
| [1860](#L1860) | $upsell\_product\_image\_post\_id = ! empty( $all\_funnels[ $funnel\_id ]['wps\_upsell\_offer\_image'][ $offer\_id ] ) ? $all\_funnels[ $funnel\_id ]['wps\_upsell\_offer\_image'][ $offer\_id ] : ''; |
| [1861](#L1861) |  |
| [1862](#L1862) | if ( ! empty( $upsell\_product\_image\_post\_id ) ) { |
| [1863](#L1863) |  |
| [1864](#L1864) | $image\_attributes = wp\_get\_attachment\_image\_src( $upsell\_product\_image\_post\_id, 'full' ); |
| [1865](#L1865) |  |
| [1866](#L1866) | $upsell\_product\_image\_src = ! empty( $image\_attributes[0] ) && filter\_var( $image\_attributes[0], FILTER\_VALIDATE\_URL ) ? $image\_attributes[0] : false; |
| [1867](#L1867) | } |
| [1868](#L1868) |  |
| [1869](#L1869) | if ( ! empty( $upsell\_product\_image\_src ) ) { |
| [1870](#L1870) |  |
| [1871](#L1871) | // Shortcode attributes. |
| [1872](#L1872) | $atts = shortcode\_atts( |
| [1873](#L1873) | array( |
| [1874](#L1874) | 'id'    => '', |
| [1875](#L1875) | 'class' => '', |
| [1876](#L1876) | 'style' => '', |
| [1877](#L1877) | ), |
| [1878](#L1878) | $atts |
| [1879](#L1879) | ); |
| [1880](#L1880) |  |
| [1881](#L1881) | $id    = $atts['id']; |
| [1882](#L1882) | $class = $atts['class']; |
| [1883](#L1883) | $style = $atts['style']; |
| [1884](#L1884) |  |
| [1885](#L1885) | $upsell\_product\_image\_src\_div = |
| [1886](#L1886) | "<div id='$id' class='wps\_upsell\_offer\_product\_image $class' style='$style'> |
| [1887](#L1887) | <img src='$upsell\_product\_image\_src'> |
| [1888](#L1888) | </div>"; |
| [1889](#L1889) |  |
| [1890](#L1890) | return $upsell\_product\_image\_src\_div; |
| [1891](#L1891) | } |
| [1892](#L1892) | } |
| [1893](#L1893) | } else { // When not Live Offer. |
| [1894](#L1894) |  |
| [1895](#L1895) | global $post; |
| [1896](#L1896) | $offer\_page\_id = $post->ID; |
| [1897](#L1897) |  |
| [1898](#L1898) | // Means this is Upsell offer template. |
| [1899](#L1899) | $funnel\_data = get\_post\_meta( $offer\_page\_id, 'wps\_upsell\_funnel\_data', true ); |
| [1900](#L1900) |  |
| [1901](#L1901) | if ( ! empty( $funnel\_data ) && is\_array( $funnel\_data ) ) { |
| [1902](#L1902) |  |
| [1903](#L1903) | $funnel\_id = $funnel\_data['funnel\_id']; |
| [1904](#L1904) | $offer\_id  = $funnel\_data['offer\_id']; |
| [1905](#L1905) |  |
| [1906](#L1906) | if ( ! empty( $funnel\_id ) && ! empty( $offer\_id ) ) { |
| [1907](#L1907) |  |
| [1908](#L1908) | $all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [1909](#L1909) |  |
| [1910](#L1910) | $upsell\_product\_image\_post\_id = ! empty( $all\_funnels[ $funnel\_id ]['wps\_upsell\_offer\_image'][ $offer\_id ] ) ? $all\_funnels[ $funnel\_id ]['wps\_upsell\_offer\_image'][ $offer\_id ] : ''; |
| [1911](#L1911) |  |
| [1912](#L1912) | if ( ! empty( $upsell\_product\_image\_post\_id ) ) { |
| [1913](#L1913) |  |
| [1914](#L1914) | $image\_attributes = wp\_get\_attachment\_image\_src( $upsell\_product\_image\_post\_id, 'full' ); |
| [1915](#L1915) |  |
| [1916](#L1916) | $upsell\_product\_image\_src = ! empty( $image\_attributes[0] ) && filter\_var( $image\_attributes[0], FILTER\_VALIDATE\_URL ) ? $image\_attributes[0] : false; |
| [1917](#L1917) | } |
| [1918](#L1918) |  |
| [1919](#L1919) | if ( ! empty( $upsell\_product\_image\_src ) ) { |
| [1920](#L1920) |  |
| [1921](#L1921) | // Shortcode attributes. |
| [1922](#L1922) | $atts = shortcode\_atts( |
| [1923](#L1923) | array( |
| [1924](#L1924) | 'id'    => '', |
| [1925](#L1925) | 'class' => '', |
| [1926](#L1926) | 'style' => '', |
| [1927](#L1927) | ), |
| [1928](#L1928) | $atts |
| [1929](#L1929) | ); |
| [1930](#L1930) |  |
| [1931](#L1931) | $id    = $atts['id']; |
| [1932](#L1932) | $class = $atts['class']; |
| [1933](#L1933) | $style = $atts['style']; |
| [1934](#L1934) |  |
| [1935](#L1935) | $upsell\_product\_image\_src\_div = |
| [1936](#L1936) | "<div id='$id' class='wps\_upsell\_offer\_product\_image $class' style='$style'> |
| [1937](#L1937) | <img src='$upsell\_product\_image\_src'> |
| [1938](#L1938) | </div>"; |
| [1939](#L1939) |  |
| [1940](#L1940) | return $upsell\_product\_image\_src\_div; |
| [1941](#L1941) | } |
| [1942](#L1942) | } |
| [1943](#L1943) | } |
| [1944](#L1944) | } |
| [1945](#L1945) |  |
| [1946](#L1946) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [1947](#L1947) |  |
| [1948](#L1948) | if ( ! empty( $product\_id ) ) { |
| [1949](#L1949) |  |
| [1950](#L1950) | $post\_type = get\_post\_type( $product\_id ); |
| [1951](#L1951) |  |
| [1952](#L1952) | if ( 'product' !== $post\_type && 'product\_variation' !== $post\_type ) { |
| [1953](#L1953) |  |
| [1954](#L1954) | return ''; |
| [1955](#L1955) | } |
| [1956](#L1956) |  |
| [1957](#L1957) | $upsell\_product\_image = wp\_get\_attachment\_image\_src( get\_post\_thumbnail\_id( $product\_id ), 'full' ); |
| [1958](#L1958) |  |
| [1959](#L1959) | $upsell\_product\_image\_src = ! empty( $upsell\_product\_image[0] ) ? $upsell\_product\_image[0] : wc\_placeholder\_img\_src(); |
| [1960](#L1960) |  |
| [1961](#L1961) | // Shortcode attributes. |
| [1962](#L1962) | $atts = shortcode\_atts( |
| [1963](#L1963) | array( |
| [1964](#L1964) | 'id'    => '', |
| [1965](#L1965) | 'class' => '', |
| [1966](#L1966) | 'style' => '', |
| [1967](#L1967) | ), |
| [1968](#L1968) | $atts |
| [1969](#L1969) | ); |
| [1970](#L1970) |  |
| [1971](#L1971) | $id    = $atts['id']; |
| [1972](#L1972) | $class = $atts['class']; |
| [1973](#L1973) | $style = $atts['style']; |
| [1974](#L1974) |  |
| [1975](#L1975) | $upsell\_product\_image\_src\_div = |
| [1976](#L1976) | "<div id='$id' class='wps\_upsell\_offer\_product\_image $class' style='$style'> |
| [1977](#L1977) | <img src='$upsell\_product\_image\_src'> |
| [1978](#L1978) | </div>"; |
| [1979](#L1979) | return $upsell\_product\_image\_src\_div; |
| [1980](#L1980) | } |
| [1981](#L1981) | } |
| [1982](#L1982) | } |
| [1983](#L1983) |  |
| [1984](#L1984) |  |
| [1985](#L1985) | /\*\* |
| [1986](#L1986) | \* Shortcode for Upsell product shipping price. |
| [1987](#L1987) | \* |
| [1988](#L1988) | \* @param mixed $atts shortcode attributes. |
| [1989](#L1989) | \* @since       3.0.0 |
| [1990](#L1990) | \*/ |
| [1991](#L1991) | public function upsell\_product\_shipping\_price\_shortcode\_content( $atts ) { |
| [1992](#L1992) |  |
| [1993](#L1993) | $validate\_shortcode = $this->validate\_shortcode(); |
| [1994](#L1994) |  |
| [1995](#L1995) | if ( $validate\_shortcode ) { |
| [1996](#L1996) |  |
| [1997](#L1997) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [1998](#L1998) | $atts = shortcode\_atts( |
| [1999](#L1999) | array( |
| [2000](#L2000) | 'id'    => '', |
| [2001](#L2001) | 'class' => '', |
| [2002](#L2002) | 'style' => '', |
| [2003](#L2003) | ), |
| [2004](#L2004) | $atts |
| [2005](#L2005) | ); |
| [2006](#L2006) | $id    = $atts['id']; |
| [2007](#L2007) | $class = $atts['class']; |
| [2008](#L2008) | $style = $atts['style']; |
| [2009](#L2009) | $upsell\_shipping\_product = wps\_wocfo\_hpos\_get\_meta\_data( $product\_id, 'wps\_upsell\_simple\_shipping\_product\_' . $product\_id, true ); |
| [2010](#L2010) |  |
| [2011](#L2011) | $upsell\_product\_price\_html\_div = "Shipping Price <br> <div id='$id' class='wps\_upsell\_offer\_product\_price $class' style='$style'> |
| [2012](#L2012) | " . wc\_price( $upsell\_shipping\_product ) . '</div>'; |
| [2013](#L2013) |  |
| [2014](#L2014) | } |
| [2015](#L2015) |  |
| [2016](#L2016) | return $upsell\_product\_price\_html\_div; |
| [2017](#L2017) |  |
| [2018](#L2018) | } |
| [2019](#L2019) |  |
| [2020](#L2020) | /\*\* |
| [2021](#L2021) | \* Shortcode for Upsell product price. |
| [2022](#L2022) | \* |
| [2023](#L2023) | \* @param mixed $atts shortcode attributes. |
| [2024](#L2024) | \* @since       3.0.0 |
| [2025](#L2025) | \*/ |
| [2026](#L2026) | public function product\_price\_shortcode\_content( $atts ) { |
| [2027](#L2027) |  |
| [2028](#L2028) | $validate\_shortcode = $this->validate\_shortcode(); |
| [2029](#L2029) |  |
| [2030](#L2030) | if ( $validate\_shortcode ) { |
| [2031](#L2031) |  |
| [2032](#L2032) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [2033](#L2033) |  |
| [2034](#L2034) | if ( ! empty( $product\_id ) ) { |
| [2035](#L2035) |  |
| [2036](#L2036) | $post\_type = get\_post\_type( $product\_id ); |
| [2037](#L2037) |  |
| [2038](#L2038) | if ( 'product' !== $post\_type && 'product\_variation' !== $post\_type ) { |
| [2039](#L2039) | return ''; |
| [2040](#L2040) | } |
| [2041](#L2041) |  |
| [2042](#L2042) | $upsell\_product = wc\_get\_product( $product\_id ); |
| [2043](#L2043) |  |
| [2044](#L2044) | // Get offer discount. |
| [2045](#L2045) | $upsell\_offered\_discount = wps\_upsell\_lite\_get\_product\_discount(); |
| [2046](#L2046) |  |
| [2047](#L2047) | // Apply discount on product. |
| [2048](#L2048) | if ( ! empty( $upsell\_offered\_discount ) ) { |
| [2049](#L2049) |  |
| [2050](#L2050) | $upsell\_product = $this->wps\_wocuf\_pro\_change\_offered\_product\_price( $upsell\_product, $upsell\_offered\_discount ); |
| [2051](#L2051) | } else { |
| [2052](#L2052) | $upsell\_product->set\_price( 0 ); |
| [2053](#L2053) | } |
| [2054](#L2054) |  |
| [2055](#L2055) | $upsell\_product\_price\_html = $upsell\_product->get\_price\_html(); |
| [2056](#L2056) | $upsell\_product\_price\_html = ! empty( $upsell\_product\_price\_html ) ? $upsell\_product\_price\_html : ''; |
| [2057](#L2057) |  |
| [2058](#L2058) | /\*\* |
| [2059](#L2059) | \* Replaces the currency switcher fixed price. |
| [2060](#L2060) | \*/ |
| [2061](#L2061) | if ( ! empty( WC()->session ) && WC()->session->\_\_isset( 's\_selected\_currency' ) ) { |
| [2062](#L2062) |  |
| [2063](#L2063) | if ( function\_exists( 'wps\_wmcs\_fixed\_price\_for\_simple\_sales\_price' ) ) { |
| [2064](#L2064) | $\_regular\_price = wps\_wmcs\_fixed\_price\_for\_simple\_regular\_price( $upsell\_product->get\_id() ); |
| [2065](#L2065) | $\_sale\_price    = wps\_wmcs\_fixed\_price\_for\_simple\_sales\_price( $upsell\_product->get\_id() ); |
| [2066](#L2066) | } else { |
| [2067](#L2067) | $\_regular\_price = $upsell\_product->get\_regular\_price(); |
| [2068](#L2068) | $\_sale\_price    = $upsell\_product->get\_price(); |
| [2069](#L2069) | } |
| [2070](#L2070) |  |
| [2071](#L2071) | if ( empty( $upsell\_offered\_discount ) ) { |
| [2072](#L2072) | $\_sale\_price = 'full\_disc'; |
| [2073](#L2073) | } |
| [2074](#L2074) |  |
| [2075](#L2075) | // In case of fixed custom price in currency switcher. |
| [2076](#L2076) | if ( ! empty( $\_regular\_price ) || ! empty( $\_sale\_price ) ) { |
| [2077](#L2077) | /\*\* |
| [2078](#L2078) | \* Upsell offer will be zero then the offer price will not be changed. |
| [2079](#L2079) | \* In that case add sale price as the payable price. |
| [2080](#L2080) | \*/ |
| [2081](#L2081) | if ( empty( $upsell\_offered\_discount ) ) { |
| [2082](#L2082) | if ( ! empty( $\_sale\_price ) && 'full\_disc' !== $\_sale\_price ) { |
| [2083](#L2083) | $upsell\_product\_price\_html = wc\_format\_sale\_price( $\_regular\_price, $\_sale\_price ); |
| [2084](#L2084) | } elseif ( 'full\_disc' === $\_sale\_price ) { |
| [2085](#L2085) | $upsell\_product\_price\_html = wc\_format\_sale\_price( $\_regular\_price, 0 ); |
| [2086](#L2086) | } else { |
| [2087](#L2087) | $upsell\_product\_price\_html = wc\_price( $\_regular\_price ); |
| [2088](#L2088) | } |
| [2089](#L2089) | } else { |
| [2090](#L2090) | $upsell\_product\_price\_html = wc\_format\_sale\_price( $\_regular\_price, $upsell\_product->get\_price() ); |
| [2091](#L2091) | } |
| [2092](#L2092) | } |
| [2093](#L2093) | } |
| [2094](#L2094) |  |
| [2095](#L2095) | // Remove amount class, as it changes price css wrt theme change. |
| [2096](#L2096) | $upsell\_product\_price\_html = str\_replace( ' amount', ' wps-upsell-amount', $upsell\_product\_price\_html ); |
| [2097](#L2097) |  |
| [2098](#L2098) | // Shortcode attributes. |
| [2099](#L2099) | $atts = shortcode\_atts( |
| [2100](#L2100) | array( |
| [2101](#L2101) | 'id'    => '', |
| [2102](#L2102) | 'class' => '', |
| [2103](#L2103) | 'style' => '', |
| [2104](#L2104) | ), |
| [2105](#L2105) | $atts |
| [2106](#L2106) | ); |
| [2107](#L2107) |  |
| [2108](#L2108) | $id    = $atts['id']; |
| [2109](#L2109) | $class = $atts['class']; |
| [2110](#L2110) | $style = $atts['style']; |
| [2111](#L2111) |  |
| [2112](#L2112) | $upsell\_product\_price\_html\_div = "<div id='$id' class='wps\_upsell\_offer\_product\_price $class' style='$style'> |
| [2113](#L2113) | $upsell\_product\_price\_html</div>"; |
| [2114](#L2114) |  |
| [2115](#L2115) | /\*\* |
| [2116](#L2116) | \* Replaces the currrency symbol. |
| [2117](#L2117) | \*/ |
| [2118](#L2118) | if ( ! empty( WC()->session ) && WC()->session->\_\_isset( 's\_selected\_currency' ) ) { |
| [2119](#L2119) |  |
| [2120](#L2120) | $selected\_currency = WC()->session->get( 's\_selected\_currency' ); |
| [2121](#L2121) | $store\_currency    = get\_woocommerce\_currency(); |
| [2122](#L2122) |  |
| [2123](#L2123) | if ( $selected\_currency !== $store\_currency ) { |
| [2124](#L2124) | $store\_currency\_symbol    = get\_option( 'wps\_mmcsfw\_symbol\_' . $store\_currency ); |
| [2125](#L2125) | $selected\_currency\_symbol = get\_option( 'wps\_mmcsfw\_symbol\_' . $selected\_currency ); |
| [2126](#L2126) |  |
| [2127](#L2127) | // Remove default currency into selected currency. |
| [2128](#L2128) | $upsell\_product\_price\_html\_div = str\_replace( $store\_currency\_symbol, $selected\_currency\_symbol, $upsell\_product\_price\_html\_div ); |
| [2129](#L2129) | } |
| [2130](#L2130) | } |
| [2131](#L2131) |  |
| [2132](#L2132) | return $upsell\_product\_price\_html\_div; |
| [2133](#L2133) | } |
| [2134](#L2134) | } |
| [2135](#L2135) | } |
| [2136](#L2136) |  |
| [2137](#L2137) | /\*\* |
| [2138](#L2138) | \* Shortcode for offer - Buy now button. |
| [2139](#L2139) | \* Returns : Link :) |
| [2140](#L2140) | \* |
| [2141](#L2141) | \* Also Requires the ID to be applied on the link or button, for variable products only. |
| [2142](#L2142) | \* Using this ID form is submitted from js. |
| [2143](#L2143) | \* |
| [2144](#L2144) | \* @since       3.0.0 |
| [2145](#L2145) | \*/ |
| [2146](#L2146) | public function buy\_now\_shortcode\_content() { |
| [2147](#L2147) |  |
| [2148](#L2148) | $validate\_shortcode = $this->validate\_shortcode(); |
| [2149](#L2149) |  |
| [2150](#L2150) | if ( $validate\_shortcode ) { |
| [2151](#L2151) |  |
| [2152](#L2152) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [2153](#L2153) |  |
| [2154](#L2154) | if ( ! empty( $product\_id ) ) { |
| [2155](#L2155) |  |
| [2156](#L2156) | $post\_type = get\_post\_type( $product\_id ); |
| [2157](#L2157) |  |
| [2158](#L2158) | if ( 'product' !== $post\_type && 'product\_variation' !== $post\_type ) { |
| [2159](#L2159) |  |
| [2160](#L2160) | return ''; |
| [2161](#L2161) | } |
| [2162](#L2162) |  |
| [2163](#L2163) | if ( 'live\_offer' === $validate\_shortcode ) { |
| [2164](#L2164) |  |
| [2165](#L2165) | $upsell\_product = wc\_get\_product( $product\_id ); |
| [2166](#L2166) |  |
| [2167](#L2167) | if ( $upsell\_product->is\_type( 'variable' ) ) { |
| [2168](#L2168) |  |
| [2169](#L2169) | // In this case buy now form ( in variation selector shortcode ) will be posted from js. |
| [2170](#L2170) | $buy\_now\_link = '#wps\_upsell'; |
| [2171](#L2171) | } else { |
| [2172](#L2172) |  |
| [2173](#L2173) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [2174](#L2174) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [2175](#L2175) |  |
| [2176](#L2176) | if ( ! $id\_nonce\_verified ) { |
| [2177](#L2177) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [2178](#L2178) | } |
| [2179](#L2179) |  |
| [2180](#L2180) | $wp\_nonce  = isset( $\_GET['ocuf\_ns'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ns'] ) ) : ''; |
| [2181](#L2181) | $order\_key = isset( $\_GET['ocuf\_ok'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ) : ''; |
| [2182](#L2182) | $offer\_id  = isset( $\_GET['ocuf\_ofd'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ofd'] ) ) : ''; |
| [2183](#L2183) | $funnel\_id = isset( $\_GET['ocuf\_fid'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_fid'] ) ) : ''; |
| [2184](#L2184) |  |
| [2185](#L2185) | $buy\_now\_link = '?wps\_wocuf\_pro\_buy |
| [2186](#L2186) | =true&ocuf\_ns=' . $wp\_nonce . ' |
| [2187](#L2187) | &ocuf\_ok=' . $order\_key . ' |
| [2188](#L2188) | &ocuf\_ofd=' . $offer\_id . ' |
| [2189](#L2189) | &ocuf\_fid=' . $funnel\_id . ' |
| [2190](#L2190) | &product\_id=' . $product\_id; |
| [2191](#L2191) | } |
| [2192](#L2192) | } elseif ( 'admin\_view' === $validate\_shortcode ) { |
| [2193](#L2193) |  |
| [2194](#L2194) | $buy\_now\_link = '#preview'; |
| [2195](#L2195) | } |
| [2196](#L2196) |  |
| [2197](#L2197) | return $buy\_now\_link; |
| [2198](#L2198) | } |
| [2199](#L2199) | } |
| [2200](#L2200) | } |
| [2201](#L2201) |  |
| [2202](#L2202) | /\*\* |
| [2203](#L2203) | \* Shortcode for offer - No thanks button. |
| [2204](#L2204) | \* Returns : Link :) |
| [2205](#L2205) | \* |
| [2206](#L2206) | \* @since       3.0.0 |
| [2207](#L2207) | \*/ |
| [2208](#L2208) | public function no\_thanks\_shortcode\_content() { |
| [2209](#L2209) |  |
| [2210](#L2210) | $validate\_shortcode = $this->validate\_shortcode(); |
| [2211](#L2211) |  |
| [2212](#L2212) | if ( $validate\_shortcode ) { |
| [2213](#L2213) |  |
| [2214](#L2214) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [2215](#L2215) |  |
| [2216](#L2216) | if ( ! empty( $product\_id ) ) { |
| [2217](#L2217) |  |
| [2218](#L2218) | $post\_type = get\_post\_type( $product\_id ); |
| [2219](#L2219) |  |
| [2220](#L2220) | if ( 'product' !== $post\_type && 'product\_variation' !== $post\_type ) { |
| [2221](#L2221) |  |
| [2222](#L2222) | return ''; |
| [2223](#L2223) | } |
| [2224](#L2224) |  |
| [2225](#L2225) | if ( 'live\_offer' === $validate\_shortcode ) { |
| [2226](#L2226) |  |
| [2227](#L2227) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [2228](#L2228) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [2229](#L2229) |  |
| [2230](#L2230) | if ( ! $id\_nonce\_verified ) { |
| [2231](#L2231) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [2232](#L2232) | } |
| [2233](#L2233) | $wp\_nonce  = isset( $\_GET['ocuf\_ns'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ns'] ) ) : ''; |
| [2234](#L2234) | $order\_key = isset( $\_GET['ocuf\_ok'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ) : ''; |
| [2235](#L2235) | $offer\_id  = isset( $\_GET['ocuf\_ofd'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ofd'] ) ) : ''; |
| [2236](#L2236) | $funnel\_id = isset( $\_GET['ocuf\_fid'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_fid'] ) ) : ''; |
| [2237](#L2237) |  |
| [2238](#L2238) | $no\_thanks\_link = '?ocuf\_ns=' . $wp\_nonce . ' |
| [2239](#L2239) | &ocuf\_th=1&ocuf\_ok=' . $order\_key . ' |
| [2240](#L2240) | &ocuf\_ofd=' . $offer\_id . ' |
| [2241](#L2241) | &ocuf\_fid=' . $funnel\_id; |
| [2242](#L2242) |  |
| [2243](#L2243) | } elseif ( 'admin\_view' === $validate\_shortcode ) { |
| [2244](#L2244) |  |
| [2245](#L2245) | $no\_thanks\_link = '#preview'; |
| [2246](#L2246) | } |
| [2247](#L2247) |  |
| [2248](#L2248) | return $no\_thanks\_link; |
| [2249](#L2249) | } |
| [2250](#L2250) | } |
| [2251](#L2251) | } |
| [2252](#L2252) |  |
| [2253](#L2253) | /\*\* |
| [2254](#L2254) | \* Shortcode for offer - product variations. |
| [2255](#L2255) | \* |
| [2256](#L2256) | \* @since       3.0.0 |
| [2257](#L2257) | \*/ |
| [2258](#L2258) | public function variations\_selector\_shortcode\_content() { |
| [2259](#L2259) |  |
| [2260](#L2260) | return ''; |
| [2261](#L2261) | } |
| [2262](#L2262) |  |
| [2263](#L2263) | /\*\* |
| [2264](#L2264) | \* Shortcode for star review. |
| [2265](#L2265) | \* Returns : star review html. |
| [2266](#L2266) | \* |
| [2267](#L2267) | \* @param mixed $atts shrtcode attributes. |
| [2268](#L2268) | \* @since       3.0.0 |
| [2269](#L2269) | \*/ |
| [2270](#L2270) | public function product\_star\_review( $atts ) { |
| [2271](#L2271) |  |
| [2272](#L2272) | $stars = ! empty( $atts['stars'] ) ? abs( $atts['stars'] ) : '5'; |
| [2273](#L2273) |  |
| [2274](#L2274) | $stars = ( $stars >= 1 && $stars <= 5 ) ? $stars : '5'; |
| [2275](#L2275) |  |
| [2276](#L2276) | $stars\_percent = $stars \* 20; |
| [2277](#L2277) |  |
| [2278](#L2278) | $review\_html = '<div class="wps-upsell-star-rating"><span style="width: ' . $stars\_percent . '%;"></div>'; |
| [2279](#L2279) |  |
| [2280](#L2280) | return $review\_html; |
| [2281](#L2281) |  |
| [2282](#L2282) | } |
| [2283](#L2283) |  |
| [2284](#L2284) | /\*\* |
| [2285](#L2285) | \* Shortcode for Default Gutenberg offer identification. |
| [2286](#L2286) | \* Returns : empty string. |
| [2287](#L2287) | \* |
| [2288](#L2288) | \* @since       3.0.0 |
| [2289](#L2289) | \*/ |
| [2290](#L2290) | public function default\_offer\_identification() { |
| [2291](#L2291) |  |
| [2292](#L2292) | return ''; |
| [2293](#L2293) |  |
| [2294](#L2294) | } |
| [2295](#L2295) |  |
| [2296](#L2296) | /\*\* |
| [2297](#L2297) | \* Creating shortcode for special price on custom page. |
| [2298](#L2298) | \* |
| [2299](#L2299) | \* @since 1.0.0 |
| [2300](#L2300) | \* @param mixed $atts attributes of the shortcode. |
| [2301](#L2301) | \* @param mixed $content content under wrapping mode. |
| [2302](#L2302) | \*/ |
| [2303](#L2303) | public function wps\_wocuf\_pro\_custom\_page\_product\_offer\_price( $atts, $content = '' ) { |
| [2304](#L2304) | $atts = shortcode\_atts( |
| [2305](#L2305) | array( |
| [2306](#L2306) | 'style' => '', |
| [2307](#L2307) | 'class' => '', |
| [2308](#L2308) | ), |
| [2309](#L2309) | $atts |
| [2310](#L2310) | ); |
| [2311](#L2311) |  |
| [2312](#L2312) | return $this->wps\_wocuf\_pro\_custom\_page\_offer\_price\_for\_all( |
| [2313](#L2313) | array( |
| [2314](#L2314) | 'style' => $atts['style'], |
| [2315](#L2315) | 'class' => $atts['class'], |
| [2316](#L2316) | ), |
| [2317](#L2317) | $content |
| [2318](#L2318) | ); |
| [2319](#L2319) | } |
| [2320](#L2320) |  |
| [2321](#L2321) | /\*\* |
| [2322](#L2322) | \* Creating shortcode for yes link on custom page. |
| [2323](#L2323) | \* |
| [2324](#L2324) | \* @since 1.0.0 |
| [2325](#L2325) | \* @param mixed $atts attributes of the shortcode. |
| [2326](#L2326) | \* @param mixed $content content under wrapping mode. |
| [2327](#L2327) | \*/ |
| [2328](#L2328) | public function wps\_wocuf\_pro\_custom\_page\_action\_link\_yes( $atts, $content = '' ) { |
| [2329](#L2329) | $atts = shortcode\_atts( |
| [2330](#L2330) | array( |
| [2331](#L2331) | 'style' => '', |
| [2332](#L2332) | 'class' => '', |
| [2333](#L2333) | ), |
| [2334](#L2334) | $atts |
| [2335](#L2335) | ); |
| [2336](#L2336) |  |
| [2337](#L2337) | return $this->wps\_wocuf\_pro\_custom\_page\_yes\_link\_for\_all( |
| [2338](#L2338) | array( |
| [2339](#L2339) | 'style' => $atts['style'], |
| [2340](#L2340) | 'class' => $atts['class'], |
| [2341](#L2341) | ), |
| [2342](#L2342) | $content |
| [2343](#L2343) | ); |
| [2344](#L2344) | } |
| [2345](#L2345) |  |
| [2346](#L2346) | /\*\* |
| [2347](#L2347) | \* Creating shortcode for showing order details page. |
| [2348](#L2348) | \* |
| [2349](#L2349) | \* @since 1.0.0 |
| [2350](#L2350) | \* @param mixed $atts attributes of the shortcode. |
| [2351](#L2351) | \* @param mixed $content content under wrapping mode. |
| [2352](#L2352) | \*/ |
| [2353](#L2353) | public function wps\_wocuf\_pro\_custom\_page\_order\_details\_link( $atts, $content = '' ) { |
| [2354](#L2354) | $atts = shortcode\_atts( |
| [2355](#L2355) | array( |
| [2356](#L2356) | 'style' => '', |
| [2357](#L2357) | 'class' => '', |
| [2358](#L2358) | ), |
| [2359](#L2359) | $atts |
| [2360](#L2360) | ); |
| [2361](#L2361) |  |
| [2362](#L2362) | return $this->wps\_wocuf\_pro\_custom\_page\_order\_details\_link\_for\_all( |
| [2363](#L2363) | array( |
| [2364](#L2364) | 'style' => $atts['style'], |
| [2365](#L2365) | 'class' => $atts['class'], |
| [2366](#L2366) | ), |
| [2367](#L2367) | $content |
| [2368](#L2368) | ); |
| [2369](#L2369) | } |
| [2370](#L2370) |  |
| [2371](#L2371) | /\*\* |
| [2372](#L2372) | \* Showing order details at thankyou page. |
| [2373](#L2373) | \* |
| [2374](#L2374) | \* @since 1.0.0 |
| [2375](#L2375) | \* @param mixed $atts attributes of the shortcode. |
| [2376](#L2376) | \* @param mixed $content content under wrapping mode. |
| [2377](#L2377) | \*/ |
| [2378](#L2378) | public function wps\_wocuf\_pro\_custom\_page\_order\_details\_link\_for\_all( $atts, $content = '' ) { |
| [2379](#L2379) | $result = ''; |
| [2380](#L2380) |  |
| [2381](#L2381) | if ( empty( $atts['style'] ) ) { |
| [2382](#L2382) | $atts['style'] = ''; |
| [2383](#L2383) | } |
| [2384](#L2384) |  |
| [2385](#L2385) | if ( empty( $atts['class'] ) ) { |
| [2386](#L2386) | $atts['class'] = ''; |
| [2387](#L2387) | } |
| [2388](#L2388) |  |
| [2389](#L2389) | if ( empty( $content ) ) { |
| [2390](#L2390) | $content = esc\_html\_\_( 'Show Order Details', 'woo-one-click-upsell-funnel' ); |
| [2391](#L2391) | $content = apply\_filters( 'wps\_wocuf\_pro\_order\_details\_link\_text', $content ); |
| [2392](#L2392) | } |
| [2393](#L2393) |  |
| [2394](#L2394) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [2395](#L2395) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [2396](#L2396) |  |
| [2397](#L2397) | if ( ! $id\_nonce\_verified ) { |
| [2398](#L2398) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [2399](#L2399) | } |
| [2400](#L2400) |  |
| [2401](#L2401) | $order\_key = isset( $\_GET['ocuf\_ok'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ) : ''; |
| [2402](#L2402) |  |
| [2403](#L2403) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [2404](#L2404) |  |
| [2405](#L2405) | $order\_received\_url = wc\_get\_endpoint\_url( 'order-received', $order\_id, wc\_get\_page\_permalink( 'checkout' ) ); |
| [2406](#L2406) |  |
| [2407](#L2407) | $order\_received\_url = add\_query\_arg( 'key', $order\_key, $order\_received\_url ); |
| [2408](#L2408) |  |
| [2409](#L2409) | $result = '<a href="' . $order\_received\_url . '" |
| [2410](#L2410) | class="button' . $atts['class'] . '" |
| [2411](#L2411) | style="' . $atts['style'] . '"> |
| [2412](#L2412) | ' . $content . '</a>'; |
| [2413](#L2413) |  |
| [2414](#L2414) | return $result; |
| [2415](#L2415) | } |
| [2416](#L2416) |  |
| [2417](#L2417) | /\*\* |
| [2418](#L2418) | \* Internal functioning of price shortcode. |
| [2419](#L2419) | \* |
| [2420](#L2420) | \* @since 1.0.0 |
| [2421](#L2421) | \* @param mixed $atts attributes of the shortcode. |
| [2422](#L2422) | \* @param mixed $content content under wrapping mode. |
| [2423](#L2423) | \*/ |
| [2424](#L2424) | public function wps\_wocuf\_pro\_custom\_page\_offer\_price\_for\_all( $atts, $content = '' ) { |
| [2425](#L2425) | $result = ''; |
| [2426](#L2426) |  |
| [2427](#L2427) | if ( empty( $atts['style'] ) ) { |
| [2428](#L2428) | $atts['style'] = ''; |
| [2429](#L2429) | } |
| [2430](#L2430) |  |
| [2431](#L2431) | if ( empty( $atts['class'] ) ) { |
| [2432](#L2432) | $atts['class'] = ''; |
| [2433](#L2433) | } |
| [2434](#L2434) |  |
| [2435](#L2435) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [2436](#L2436) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [2437](#L2437) |  |
| [2438](#L2438) | if ( ! $id\_nonce\_verified ) { |
| [2439](#L2439) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [2440](#L2440) | } |
| [2441](#L2441) |  |
| [2442](#L2442) | $offer\_id = isset( $\_GET['ocuf\_ofd'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ofd'] ) ) : ''; |
| [2443](#L2443) |  |
| [2444](#L2444) | $funnel\_id = isset( $\_GET['ocuf\_fid'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_fid'] ) ) : ''; |
| [2445](#L2445) |  |
| [2446](#L2446) | $order\_key = isset( $\_GET['ocuf\_ok'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ) : ''; |
| [2447](#L2447) |  |
| [2448](#L2448) | $wp\_nonce = isset( $\_GET['ocuf\_ns'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ns'] ) ) : ''; |
| [2449](#L2449) |  |
| [2450](#L2450) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [2451](#L2451) |  |
| [2452](#L2452) | $wps\_wocuf\_pro\_all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [2453](#L2453) |  |
| [2454](#L2454) | $wps\_wocuf\_pro\_before\_offer\_price\_text = get\_option( 'wps\_wocuf\_pro\_before\_offer\_price\_text', esc\_html\_\_( 'Special Offer Price', 'woo-one-click-upsell-funnel' ) ); |
| [2455](#L2455) |  |
| [2456](#L2456) | $wps\_wocuf\_pro\_offered\_products = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'] : array(); |
| [2457](#L2457) |  |
| [2458](#L2458) | $wps\_wocuf\_pro\_offered\_discount = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_discount\_price'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_discount\_price'] : array(); |
| [2459](#L2459) |  |
| [2460](#L2460) | $wps\_wocuf\_pro\_single\_offered\_product = ''; |
| [2461](#L2461) |  |
| [2462](#L2462) | if ( ! empty( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) ) { |
| [2463](#L2463) |  |
| [2464](#L2464) | // In v2.0.0, it was array so handling to get the first product id. |
| [2465](#L2465) | if ( is\_array( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) && count( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) ) { |
| [2466](#L2466) |  |
| [2467](#L2467) | foreach ( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] as $handling\_offer\_product\_id ) { |
| [2468](#L2468) |  |
| [2469](#L2469) | $wps\_wocuf\_pro\_single\_offered\_product = absint( $handling\_offer\_product\_id ); |
| [2470](#L2470) | break; |
| [2471](#L2471) | } |
| [2472](#L2472) | } else { |
| [2473](#L2473) |  |
| [2474](#L2474) | $wps\_wocuf\_pro\_single\_offered\_product = absint( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ); |
| [2475](#L2475) | } |
| [2476](#L2476) | } |
| [2477](#L2477) |  |
| [2478](#L2478) | if ( ! empty( $wps\_wocuf\_pro\_single\_offered\_product ) ) { |
| [2479](#L2479) |  |
| [2480](#L2480) | $wps\_wocuf\_pro\_original\_offered\_product = wc\_get\_product( $wps\_wocuf\_pro\_single\_offered\_product ); |
| [2481](#L2481) |  |
| [2482](#L2482) | $wps\_wocuf\_pro\_offered\_product = $this->wps\_wocuf\_pro\_change\_offered\_product\_price( $wps\_wocuf\_pro\_original\_offered\_product, $wps\_wocuf\_pro\_offered\_discount[ $offer\_id ] ); |
| [2483](#L2483) |  |
| [2484](#L2484) | $product = $wps\_wocuf\_pro\_offered\_product; |
| [2485](#L2485) |  |
| [2486](#L2486) | $result .= '<div style="' . $atts['style'] . '" |
| [2487](#L2487) | class="wps\_wocuf\_pro\_custom\_offer\_price ' . $atts['class'] . '"> |
| [2488](#L2488) | ' . $wps\_wocuf\_pro\_before\_offer\_price\_text . ' : |
| [2489](#L2489) | ' . $product->get\_price\_html() . '</div>'; |
| [2490](#L2490) |  |
| [2491](#L2491) | } else { |
| [2492](#L2492) | $result .= '<div style="' . $atts['style'] . '" |
| [2493](#L2493) | class="wps\_wocuf\_pro\_custom\_offer\_price ' . $atts['class'] . '"> |
| [2494](#L2494) | ' . $content . '</div>'; |
| [2495](#L2495) | } |
| [2496](#L2496) |  |
| [2497](#L2497) | return $result; |
| [2498](#L2498) | } |
| [2499](#L2499) |  |
| [2500](#L2500) | /\*\* |
| [2501](#L2501) | \* Internal functioning of yes link shortcode. |
| [2502](#L2502) | \* |
| [2503](#L2503) | \* @since 1.0.0 |
| [2504](#L2504) | \* @param mixed $atts attributes of the shortcode. |
| [2505](#L2505) | \* @param mixed $content content under wrapping mode. |
| [2506](#L2506) | \*/ |
| [2507](#L2507) | public function wps\_wocuf\_pro\_custom\_page\_yes\_link\_for\_all( $atts, $content = '' ) { |
| [2508](#L2508) | $result = ''; |
| [2509](#L2509) |  |
| [2510](#L2510) | if ( empty( $atts[0] ) ) { |
| [2511](#L2511) | $atts[0] = 'yes'; |
| [2512](#L2512) | } |
| [2513](#L2513) |  |
| [2514](#L2514) | if ( empty( $atts['style'] ) ) { |
| [2515](#L2515) | $atts['style'] = ''; |
| [2516](#L2516) | } |
| [2517](#L2517) |  |
| [2518](#L2518) | if ( empty( $atts['class'] ) ) { |
| [2519](#L2519) | $atts['class'] = ''; |
| [2520](#L2520) | } |
| [2521](#L2521) |  |
| [2522](#L2522) | $wps\_wocuf\_pro\_all\_funnels = get\_option( 'wps\_wocuf\_funnels\_list', array() ); |
| [2523](#L2523) |  |
| [2524](#L2524) | $wps\_wocuf\_pro\_buy\_text = get\_option( 'wps\_wocuf\_pro\_buy\_text', esc\_html\_\_( 'Add to my order', 'woo-one-click-upsell-funnel' ) ); |
| [2525](#L2525) |  |
| [2526](#L2526) | if ( empty( $content ) ) { |
| [2527](#L2527) | $content = $wps\_wocuf\_pro\_buy\_text; |
| [2528](#L2528) | } |
| [2529](#L2529) |  |
| [2530](#L2530) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [2531](#L2531) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [2532](#L2532) |  |
| [2533](#L2533) | if ( ! $id\_nonce\_verified ) { |
| [2534](#L2534) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [2535](#L2535) | } |
| [2536](#L2536) |  |
| [2537](#L2537) | $offer\_id = isset( $\_GET['ocuf\_ofd'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ofd'] ) ) : ''; |
| [2538](#L2538) |  |
| [2539](#L2539) | $funnel\_id = isset( $\_GET['ocuf\_fid'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_fid'] ) ) : ''; |
| [2540](#L2540) |  |
| [2541](#L2541) | $order\_key = isset( $\_GET['ocuf\_ok'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ) : ''; |
| [2542](#L2542) |  |
| [2543](#L2543) | $wp\_nonce = isset( $\_GET['ocuf\_ns'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ns'] ) ) : ''; |
| [2544](#L2544) |  |
| [2545](#L2545) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [2546](#L2546) |  |
| [2547](#L2547) | $wps\_wocuf\_pro\_offered\_products = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_products\_in\_offer'] : array(); |
| [2548](#L2548) |  |
| [2549](#L2549) | $wps\_wocuf\_pro\_offered\_discount = isset( $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_discount\_price'] ) ? $wps\_wocuf\_pro\_all\_funnels[ $funnel\_id ]['wps\_wocuf\_offer\_discount\_price'] : array(); |
| [2550](#L2550) |  |
| [2551](#L2551) | $wps\_wocuf\_pro\_single\_offered\_product = ''; |
| [2552](#L2552) |  |
| [2553](#L2553) | if ( ! empty( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) ) { |
| [2554](#L2554) |  |
| [2555](#L2555) | // In v2.0.0, it was array so handling to get the first product id. |
| [2556](#L2556) | if ( is\_array( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) && count( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ) ) { |
| [2557](#L2557) |  |
| [2558](#L2558) | foreach ( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] as $handling\_offer\_product\_id ) { |
| [2559](#L2559) |  |
| [2560](#L2560) | $wps\_wocuf\_pro\_single\_offered\_product = absint( $handling\_offer\_product\_id ); |
| [2561](#L2561) | break; |
| [2562](#L2562) | } |
| [2563](#L2563) | } else { |
| [2564](#L2564) |  |
| [2565](#L2565) | $wps\_wocuf\_pro\_single\_offered\_product = absint( $wps\_wocuf\_pro\_offered\_products[ $offer\_id ] ); |
| [2566](#L2566) | } |
| [2567](#L2567) | } |
| [2568](#L2568) |  |
| [2569](#L2569) | if ( ! empty( $wps\_wocuf\_pro\_single\_offered\_product ) ) { |
| [2570](#L2570) |  |
| [2571](#L2571) | $wps\_wocuf\_pro\_original\_offered\_product = wc\_get\_product( $wps\_wocuf\_pro\_single\_offered\_product ); |
| [2572](#L2572) |  |
| [2573](#L2573) | $wps\_wocuf\_pro\_offered\_product = $this->wps\_wocuf\_pro\_change\_offered\_product\_price( $wps\_wocuf\_pro\_original\_offered\_product, $wps\_wocuf\_pro\_offered\_discount[ $offer\_id ] ); |
| [2574](#L2574) |  |
| [2575](#L2575) | $product = $wps\_wocuf\_pro\_offered\_product; |
| [2576](#L2576) |  |
| [2577](#L2577) | $result .= '<form method="post" class="wps\_wocuf\_pro\_custom\_offer"> |
| [2578](#L2578) | <input type="hidden" name="ocuf\_ns" value="' . $wp\_nonce . '"> |
| [2579](#L2579) | <input type="hidden" name="ocuf\_fid" value="' . $funnel\_id . '"> |
| [2580](#L2580) | <input type="hidden" name="product\_id" class="wps\_wocuf\_pro\_variation\_id" value="' . absint( $product->get\_id() ) . '"> |
| [2581](#L2581) | <input type="hidden" name="ocuf\_ofd" value="' . $offer\_id . '"> |
| [2582](#L2582) | <input type="hidden" name="ocuf\_ok" value="' . $order\_key . '"> |
| [2583](#L2583) | <input type="hidden" name="wps\_wocuf\_post\_nonce" value="' . wp\_create\_nonce( 'wps\_wocuf\_field\_post\_nonce' ) . '"> |
| [2584](#L2584) | <input type="hidden" name="wps\_wocuf\_after\_post\_nonce" value="' . wp\_create\_nonce( 'wps\_wocuf\_after\_field\_post\_nonce' ) . '"> |
| [2585](#L2585) | <button style="' . $atts['style'] . '" class="wps\_wocuf\_pro\_custom\_buy ' . $atts['class'] . '" type="submit" onclick="" name="wps\_wocuf\_pro\_buy">' . $content . '</button> |
| [2586](#L2586) | </form>'; |
| [2587](#L2587) |  |
| [2588](#L2588) | } else { |
| [2589](#L2589) | $result .= '<form method="post" class="wps\_wocuf\_pro\_custom\_offer"> |
| [2590](#L2590) | <input type="hidden" name="ocuf\_ns" value="' . $wp\_nonce . '"> |
| [2591](#L2591) | <input type="hidden" name="ocuf\_fid" value="' . $funnel\_id . '"> |
| [2592](#L2592) | <input type="hidden" name="product\_id" class="wps\_wocuf\_pro\_variation\_id" value=""> |
| [2593](#L2593) | <input type="hidden" name="ocuf\_ofd" value="' . $offer\_id . '"> |
| [2594](#L2594) | <input type="hidden" name="ocuf\_ok" value="' . $order\_key . '"> |
| [2595](#L2595) | <input type="hidden" name="wps\_wocuf\_post\_nonce" value="' . wp\_create\_nonce( 'wps\_wocuf\_field\_post\_nonce' ) . '"> |
| [2596](#L2596) | <input type="hidden" name="wps\_wocuf\_after\_post\_nonce" value="' . wp\_create\_nonce( 'wps\_wocuf\_after\_field\_post\_nonce' ) . '"> |
| [2597](#L2597) | <button style="' . $atts['style'] . '" class="wps\_wocuf\_pro\_custom\_buy ' . $atts['class'] . '" type="submit" name="wps\_wocuf\_pro\_buy">' . $content . '</button> |
| [2598](#L2598) | </form>'; |
| [2599](#L2599) | } |
| [2600](#L2600) |  |
| [2601](#L2601) | return $result; |
| [2602](#L2602) | } |
| [2603](#L2603) |  |
| [2604](#L2604) | /\*\* |
| [2605](#L2605) | \* Creating shortcode for thanks link on custom page. |
| [2606](#L2606) | \* |
| [2607](#L2607) | \* @since 1.0.0 |
| [2608](#L2608) | \* @param mixed $atts attributes of the shortcode. |
| [2609](#L2609) | \* @param mixed $content content under wrapping mode. |
| [2610](#L2610) | \*/ |
| [2611](#L2611) | public function wps\_wocuf\_pro\_custom\_page\_action\_link\_no( $atts, $content = '' ) { |
| [2612](#L2612) | $atts = shortcode\_atts( |
| [2613](#L2613) | array( |
| [2614](#L2614) | 'style' => '', |
| [2615](#L2615) | 'class' => '', |
| [2616](#L2616) | ), |
| [2617](#L2617) | $atts |
| [2618](#L2618) | ); |
| [2619](#L2619) |  |
| [2620](#L2620) | return $this->wps\_wocuf\_pro\_custom\_page\_no\_link\_for\_all( |
| [2621](#L2621) | array( |
| [2622](#L2622) | 'style' => $atts['style'], |
| [2623](#L2623) | 'class' => $atts['class'], |
| [2624](#L2624) | ), |
| [2625](#L2625) | $content |
| [2626](#L2626) | ); |
| [2627](#L2627) | } |
| [2628](#L2628) |  |
| [2629](#L2629) | /\*\* |
| [2630](#L2630) | \* Creating shortcode for thanks link on custom page for simple as well variable product |
| [2631](#L2631) | \* |
| [2632](#L2632) | \* @since 1.0.0 |
| [2633](#L2633) | \* @param mixed $atts attributes of the shortcode. |
| [2634](#L2634) | \* @param mixed $content content under wrapping mode. |
| [2635](#L2635) | \*/ |
| [2636](#L2636) | public function wps\_wocuf\_pro\_custom\_page\_no\_link\_for\_all( $atts, $content = '' ) { |
| [2637](#L2637) | $result = ''; |
| [2638](#L2638) |  |
| [2639](#L2639) | if ( empty( $atts['style'] ) ) { |
| [2640](#L2640) | $atts['style'] = ''; |
| [2641](#L2641) | } |
| [2642](#L2642) |  |
| [2643](#L2643) | if ( empty( $atts['class'] ) ) { |
| [2644](#L2644) | $atts['class'] = ''; |
| [2645](#L2645) | } |
| [2646](#L2646) |  |
| [2647](#L2647) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [2648](#L2648) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [2649](#L2649) |  |
| [2650](#L2650) | if ( ! $id\_nonce\_verified ) { |
| [2651](#L2651) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [2652](#L2652) | } |
| [2653](#L2653) |  |
| [2654](#L2654) | $offer\_id = isset( $\_GET['ocuf\_ofd'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ofd'] ) ) : ''; |
| [2655](#L2655) |  |
| [2656](#L2656) | $funnel\_id = isset( $\_GET['ocuf\_fid'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_fid'] ) ) : ''; |
| [2657](#L2657) |  |
| [2658](#L2658) | $order\_key = isset( $\_GET['ocuf\_ok'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ) : ''; |
| [2659](#L2659) |  |
| [2660](#L2660) | $wp\_nonce = isset( $\_GET['ocuf\_ns'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ns'] ) ) : ''; |
| [2661](#L2661) |  |
| [2662](#L2662) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [2663](#L2663) |  |
| [2664](#L2664) | $th = 1; |
| [2665](#L2665) |  |
| [2666](#L2666) | $wps\_wocuf\_pro\_no\_text = get\_option( 'wps\_wocuf\_pro\_no\_text', esc\_html\_\_( 'No,thanks', 'woo-one-click-upsell-funnel' ) ); |
| [2667](#L2667) |  |
| [2668](#L2668) | if ( empty( $content ) ) { |
| [2669](#L2669) | $content = $wps\_wocuf\_pro\_no\_text; |
| [2670](#L2670) | } |
| [2671](#L2671) |  |
| [2672](#L2672) | if ( ! empty( $offer\_id ) && ! empty( $order\_key ) && ! empty( $wp\_nonce ) ) { |
| [2673](#L2673) | $result .= '<a style="' . $atts['style'] . '" class= |
| [2674](#L2674) | "wps\_wocuf\_pro\_no wps\_wocuf\_pro\_custom\_skip ' . $atts['class'] . '" |
| [2675](#L2675) | href="?ocuf\_ns=' . $wp\_nonce . ' |
| [2676](#L2676) | &ocuf\_th=1&ocuf\_ok=' . $order\_key . ' |
| [2677](#L2677) | &ocuf\_ofd=' . $offer\_id . ' |
| [2678](#L2678) | &ocuf\_fid=' . $funnel\_id . '" |
| [2679](#L2679) | >' . $content . '</a>'; |
| [2680](#L2680) | } else { |
| [2681](#L2681) | $result .= '<a style="' . $atts['style'] . '" |
| [2682](#L2682) | class="wps\_wocuf\_pro\_custom\_skip ' . $atts['class'] . '" |
| [2683](#L2683) | href="">' . $content . '</a>'; |
| [2684](#L2684) | } |
| [2685](#L2685) |  |
| [2686](#L2686) | return $result; |
| [2687](#L2687) | } |
| [2688](#L2688) |  |
| [2689](#L2689) | /\*\* |
| [2690](#L2690) | \* Remove all styles from offer pages |
| [2691](#L2691) | \* |
| [2692](#L2692) | \* @since    3.0.0 |
| [2693](#L2693) | \*/ |
| [2694](#L2694) | public function remove\_styles\_offer\_pages() { |
| [2695](#L2695) |  |
| [2696](#L2696) | $saved\_offer\_post\_ids = get\_option( 'wps\_upsell\_lite\_offer\_post\_ids', array() ); |
| [2697](#L2697) |  |
| [2698](#L2698) | if ( ! empty( $saved\_offer\_post\_ids ) && is\_array( $saved\_offer\_post\_ids ) && count( $saved\_offer\_post\_ids ) ) { |
| [2699](#L2699) |  |
| [2700](#L2700) | global $post; |
| [2701](#L2701) |  |
| [2702](#L2702) | if ( ! empty( $post->ID ) && in\_array( (int) $post->ID, $saved\_offer\_post\_ids, true ) ) { |
| [2703](#L2703) |  |
| [2704](#L2704) | global $wp\_styles; |
| [2705](#L2705) |  |
| [2706](#L2706) | // To dequeue all wp-content styles. |
| [2707](#L2707) | foreach ( $wp\_styles->registered as $k => $s ) { |
| [2708](#L2708) |  |
| [2709](#L2709) | if ( mb\_strpos( $s->src, 'wp-content/' ) ) { |
| [2710](#L2710) |  |
| [2711](#L2711) | // Except for upsell and elementor plugins. |
| [2712](#L2712) | if ( mb\_strpos( $s->src, 'elementor' ) || mb\_strpos( $s->src, 'woo-one-click-upsell-funnel' ) ) { |
| [2713](#L2713) |  |
| [2714](#L2714) | continue; |
| [2715](#L2715) | } |
| [2716](#L2716) |  |
| [2717](#L2717) | wp\_deregister\_style( $k ); |
| [2718](#L2718) | } |
| [2719](#L2719) | } |
| [2720](#L2720) |  |
| [2721](#L2721) | global $wp\_scripts; |
| [2722](#L2722) |  |
| [2723](#L2723) | // To dequeue all theme scripts. |
| [2724](#L2724) | foreach ( $wp\_scripts->registered as $k => $s ) { |
| [2725](#L2725) |  |
| [2726](#L2726) | if ( mb\_strpos( $s->src, 'wp-content/themes/' ) ) { |
| [2727](#L2727) |  |
| [2728](#L2728) | wp\_deregister\_script( $k ); |
| [2729](#L2729) | } |
| [2730](#L2730) | } |
| [2731](#L2731) |  |
| [2732](#L2732) | ?> |
| [2733](#L2733) |  |
| [2734](#L2734) | <style type="text/css"> |
| [2735](#L2735) | body{ |
| [2736](#L2736) | margin: auto; |
| [2737](#L2737) | } |
| [2738](#L2738) | </style> |
| [2739](#L2739) |  |
| [2740](#L2740) | <?php |
| [2741](#L2741) | } |
| [2742](#L2742) | } |
| [2743](#L2743) | } |
| [2744](#L2744) |  |
| [2745](#L2745) | /\*\* |
| [2746](#L2746) | \* Hide upsell offer pages from nav menu front-end. |
| [2747](#L2747) | \* |
| [2748](#L2748) | \* @param mixed $args args. |
| [2749](#L2749) | \* @since    3.0.0 |
| [2750](#L2750) | \*/ |
| [2751](#L2751) | public function exclude\_pages\_from\_front\_end( $args ) { |
| [2752](#L2752) |  |
| [2753](#L2753) | $saved\_offer\_post\_ids = get\_option( 'wps\_upsell\_lite\_offer\_post\_ids', array() ); |
| [2754](#L2754) |  |
| [2755](#L2755) | if ( ! empty( $saved\_offer\_post\_ids ) && is\_array( $saved\_offer\_post\_ids ) && count( $saved\_offer\_post\_ids ) ) { |
| [2756](#L2756) |  |
| [2757](#L2757) | $exclude\_pages     = $saved\_offer\_post\_ids; |
| [2758](#L2758) | $exclude\_pages\_ids = ''; |
| [2759](#L2759) |  |
| [2760](#L2760) | foreach ( $exclude\_pages as $\_post\_id ) { |
| [2761](#L2761) |  |
| [2762](#L2762) | if ( ! empty( $exclude\_pages\_ids ) ) { |
| [2763](#L2763) |  |
| [2764](#L2764) | $exclude\_pages\_ids .= ', '; |
| [2765](#L2765) | } |
| [2766](#L2766) |  |
| [2767](#L2767) | $exclude\_pages\_ids .= $\_post\_id; |
| [2768](#L2768) | } |
| [2769](#L2769) |  |
| [2770](#L2770) | if ( ! empty( $args['exclude'] ) ) { |
| [2771](#L2771) |  |
| [2772](#L2772) | $args['exclude'] .= ','; |
| [2773](#L2773) | } else { |
| [2774](#L2774) |  |
| [2775](#L2775) | $args['exclude'] = ''; |
| [2776](#L2776) | } |
| [2777](#L2777) |  |
| [2778](#L2778) | $args['exclude'] .= $exclude\_pages\_ids; |
| [2779](#L2779) |  |
| [2780](#L2780) | } |
| [2781](#L2781) |  |
| [2782](#L2782) | return $args; |
| [2783](#L2783) | } |
| [2784](#L2784) |  |
| [2785](#L2785) | /\*\* |
| [2786](#L2786) | \* Hide upsell offer pages from added menu list in customizer and admin panel. |
| [2787](#L2787) | \* |
| [2788](#L2788) | \* @param mixed $items items. |
| [2789](#L2789) | \* @since    3.0.0 |
| [2790](#L2790) | \*/ |
| [2791](#L2791) | public function exclude\_pages\_from\_menu\_list( $items ) { |
| [2792](#L2792) |  |
| [2793](#L2793) | $saved\_offer\_post\_ids = get\_option( 'wps\_upsell\_lite\_offer\_post\_ids', array() ); |
| [2794](#L2794) |  |
| [2795](#L2795) | if ( ! empty( $saved\_offer\_post\_ids ) && is\_array( $saved\_offer\_post\_ids ) && count( $saved\_offer\_post\_ids ) ) { |
| [2796](#L2796) |  |
| [2797](#L2797) | $exclude\_pages     = $saved\_offer\_post\_ids; |
| [2798](#L2798) | $exclude\_pages\_ids = array(); |
| [2799](#L2799) |  |
| [2800](#L2800) | foreach ( $exclude\_pages as $\_post\_id ) { |
| [2801](#L2801) |  |
| [2802](#L2802) | array\_push( $exclude\_pages\_ids, (int) $\_post\_id ); |
| [2803](#L2803) | } |
| [2804](#L2804) |  |
| [2805](#L2805) | if ( ! empty( $exclude\_pages\_ids ) ) { |
| [2806](#L2806) |  |
| [2807](#L2807) | foreach ( $items as $key => $item ) { |
| [2808](#L2808) |  |
| [2809](#L2809) | if ( in\_array( (int) $item->object\_id, $exclude\_pages\_ids, true ) ) { |
| [2810](#L2810) |  |
| [2811](#L2811) | unset( $items[ $key ] ); |
| [2812](#L2812) | } |
| [2813](#L2813) | } |
| [2814](#L2814) | } |
| [2815](#L2815) | } |
| [2816](#L2816) |  |
| [2817](#L2817) | return $items; |
| [2818](#L2818) | } |
| [2819](#L2819) |  |
| [2820](#L2820) | /\*\* |
| [2821](#L2821) | \* Redirect upsell offer pages if not admin or upsell nonce expired. |
| [2822](#L2822) | \* |
| [2823](#L2823) | \* @since    3.0.0 |
| [2824](#L2824) | \*/ |
| [2825](#L2825) | public function upsell\_offer\_page\_redirect() { |
| [2826](#L2826) |  |
| [2827](#L2827) | $saved\_offer\_post\_ids = get\_option( 'wps\_upsell\_lite\_offer\_post\_ids', array() ); |
| [2828](#L2828) |  |
| [2829](#L2829) | if ( ! empty( $saved\_offer\_post\_ids ) && is\_array( $saved\_offer\_post\_ids ) && count( $saved\_offer\_post\_ids ) ) { |
| [2830](#L2830) |  |
| [2831](#L2831) | global $post; |
| [2832](#L2832) |  |
| [2833](#L2833) | // When current page is one of the upsell offer page. |
| [2834](#L2834) | if ( ! empty( $post->ID ) && in\_array( $post->ID, $saved\_offer\_post\_ids, true ) ) { |
| [2835](#L2835) |  |
| [2836](#L2836) | $validate\_shortcode = $this->validate\_shortcode(); |
| [2837](#L2837) |  |
| [2838](#L2838) | if ( wps\_upsell\_divi\_builder\_plugin\_active() ) { |
| [2839](#L2839) |  |
| [2840](#L2840) | // 1833px |
| [2841](#L2841) | update\_post\_meta( $post->ID, '\_et\_pb\_page\_layout', 'et\_no\_sidebar' ); |
| [2842](#L2842) | ?> |
| [2843](#L2843) | <style type="text/css"> |
| [2844](#L2844) | body{ |
| [2845](#L2845) | margin: auto; |
| [2846](#L2846) | } |
| [2847](#L2847) | .main\_title{ |
| [2848](#L2848) | display: none !important; |
| [2849](#L2849) | } |
| [2850](#L2850) | .page-id-<?php echo esc\_attr( $post->ID ); ?> header, .page-id-<?php echo esc\_attr( $post->ID ); ?> footer { |
| [2851](#L2851) | display: none !important; } |
| [2852](#L2852) | .container{ |
| [2853](#L2853) | width:100% !important; |
| [2854](#L2854) | max-width: 100% !important; |
| [2855](#L2855) | } |
| [2856](#L2856) | body:not(.et-tb) #main-content .container, body:not(.et-tb-has-header) #main-content .container { |
| [2857](#L2857) | padding-top: 0px !important; |
| [2858](#L2858) | } |
| [2859](#L2859) | </style> |
| [2860](#L2860) | <?php |
| [2861](#L2861) | } |
| [2862](#L2862) | if ( false === $validate\_shortcode ) { |
| [2863](#L2863) |  |
| [2864](#L2864) | $this->expire\_offer(); |
| [2865](#L2865) |  |
| [2866](#L2866) | } |
| [2867](#L2867) | } |
| [2868](#L2868) | } |
| [2869](#L2869) |  |
| [2870](#L2870) | } |
| [2871](#L2871) |  |
| [2872](#L2872) | /\*\* |
| [2873](#L2873) | \* Expire offer and show return to shop link. |
| [2874](#L2874) | \* |
| [2875](#L2875) | \* @since    2.0.0 |
| [2876](#L2876) | \*/ |
| [2877](#L2877) | private function expire\_offer() { |
| [2878](#L2878) |  |
| [2879](#L2879) | $shop\_page\_url = function\_exists( 'wc\_get\_page\_id' ) ? get\_permalink( wc\_get\_page\_id( 'shop' ) ) : get\_permalink( woocommerce\_get\_page\_id( 'shop' ) ); |
| [2880](#L2880) | ?> |
| [2881](#L2881) | <div style="text-align: center;margin-top: 30px;" id="wps\_upsell\_offer\_expired"><h2 style="font-weight: 200;"><?php esc\_html\_e( 'Sorry, Offer expired.', 'woo-one-click-upsell-funnel' ); ?></h2><a class="button wc-backward" href="<?php echo esc\_url( $shop\_page\_url ); ?>"><?php esc\_html\_e( 'Return to Shop ', 'woo-one-click-upsell-funnel' ); ?>&rarr;</a></div> |
| [2882](#L2882) | <?php |
| [2883](#L2883) |  |
| [2884](#L2884) | // It just displayes the html itself. Content in it is already escaped. |
| [2885](#L2885) |  |
| [2886](#L2886) | wp\_die(); |
| [2887](#L2887) | } |
| [2888](#L2888) |  |
| [2889](#L2889) | /\*\* |
| [2890](#L2890) | \* Expire further Offers Order meta value. |
| [2891](#L2891) | \* |
| [2892](#L2892) | \* @param mixed $order\_id order id. |
| [2893](#L2893) | \* @since    3.0.0 |
| [2894](#L2894) | \*/ |
| [2895](#L2895) | private function expire\_further\_offers( $order\_id = 0 ) { |
| [2896](#L2896) |  |
| [2897](#L2897) | $expire\_further\_offers = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_expire\_further\_offers', true ); |
| [2898](#L2898) |  |
| [2899](#L2899) | if ( ! empty( $expire\_further\_offers ) ) { |
| [2900](#L2900) |  |
| [2901](#L2901) | return true; |
| [2902](#L2902) | } else { |
| [2903](#L2903) |  |
| [2904](#L2904) | return false; |
| [2905](#L2905) | } |
| [2906](#L2906) | } |
| [2907](#L2907) |  |
| [2908](#L2908) | /\*\* |
| [2909](#L2909) | \* Handle Upsell Orders on Thankyou for Success Rate and Stats. |
| [2910](#L2910) | \* |
| [2911](#L2911) | \* @param mixed $order\_id order id. |
| [2912](#L2912) | \* @since    3.0.0 |
| [2913](#L2913) | \*/ |
| [2914](#L2914) | public function upsell\_sales\_by\_funnel\_handling( $order\_id ) { |
| [2915](#L2915) |  |
| [2916](#L2916) | if ( ! $order\_id ) { |
| [2917](#L2917) |  |
| [2918](#L2918) | return; |
| [2919](#L2919) | } |
| [2920](#L2920) |  |
| [2921](#L2921) | // Process once and only for Upsells. |
| [2922](#L2922) | $funnel\_id = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, 'wps\_upsell\_funnel\_id', true ); |
| [2923](#L2923) |  |
| [2924](#L2924) | if ( empty( $funnel\_id ) ) { |
| [2925](#L2925) |  |
| [2926](#L2926) | return; |
| [2927](#L2927) | } |
| [2928](#L2928) |  |
| [2929](#L2929) | $order = new WC\_Order( $order\_id ); |
| [2930](#L2930) |  |
| [2931](#L2931) | if ( empty( $order ) ) { |
| [2932](#L2932) |  |
| [2933](#L2933) | return; |
| [2934](#L2934) | } |
| [2935](#L2935) |  |
| [2936](#L2936) | $processed\_order\_statuses = array( |
| [2937](#L2937) | 'processing', |
| [2938](#L2938) | 'completed', |
| [2939](#L2939) | 'on-hold', |
| [2940](#L2940) | ); |
| [2941](#L2941) |  |
| [2942](#L2942) | if ( ! in\_array( $order->get\_status(), $processed\_order\_statuses, true ) ) { |
| [2943](#L2943) | return; |
| [2944](#L2944) | } |
| [2945](#L2945) |  |
| [2946](#L2946) | $order\_items = $order->get\_items(); |
| [2947](#L2947) |  |
| [2948](#L2948) | if ( ! empty( $order\_items ) && is\_array( $order\_items ) ) { |
| [2949](#L2949) |  |
| [2950](#L2950) | $upsell\_purchased  = false; |
| [2951](#L2951) | $upsell\_item\_total = 0; |
| [2952](#L2952) |  |
| [2953](#L2953) | foreach ( $order\_items as $item\_id => $single\_item ) { |
| [2954](#L2954) |  |
| [2955](#L2955) | if ( ! empty( $single\_item->get\_meta( 'is\_upsell\_purchase' ) ) ) { |
| [2956](#L2956) |  |
| [2957](#L2957) | $upsell\_purchased   = true; |
| [2958](#L2958) | $upsell\_item\_total\_data = $single\_item->get\_meta( '\_line\_total' ); |
| [2959](#L2959) | $upsell\_item\_total = $upsell\_item\_total + intval( $upsell\_item\_total\_data ); |
| [2960](#L2960) | } |
| [2961](#L2961) | } |
| [2962](#L2962) | } |
| [2963](#L2963) |  |
| [2964](#L2964) | if ( $upsell\_purchased ) { |
| [2965](#L2965) |  |
| [2966](#L2966) | // Add Funnel Success count and Total Sales for the current Funnel. |
| [2967](#L2967) | $sales\_by\_funnel = new WPS\_Upsell\_Report\_Sales\_By\_Funnel( $funnel\_id ); |
| [2968](#L2968) |  |
| [2969](#L2969) | $sales\_by\_funnel->add\_funnel\_success\_count(); |
| [2970](#L2970) | $sales\_by\_funnel->add\_funnel\_total\_sales( $upsell\_item\_total ); |
| [2971](#L2971) | } |
| [2972](#L2972) |  |
| [2973](#L2973) | /\*\* |
| [2974](#L2974) | \* Delete Funnel id so that this is processed only once and funnel id |
| [2975](#L2975) | \* might change so no need to associate the order with it. |
| [2976](#L2976) | \*/ |
| [2977](#L2977) | wps\_wocfo\_hpos\_delete\_meta\_data( $order\_id, 'wps\_upsell\_funnel\_id' ); |
| [2978](#L2978) | } |
| [2979](#L2979) |  |
| [2980](#L2980) | /\*\* |
| [2981](#L2981) | \* Add Base Code for Google Analyics and Facebook Pixel. |
| [2982](#L2982) | \* |
| [2983](#L2983) | \* @since    3.0.0 |
| [2984](#L2984) | \*/ |
| [2985](#L2985) | public function add\_ga\_and\_fb\_pixel\_base\_code() { |
| [2986](#L2986) |  |
| [2987](#L2987) | $upsell\_analytics\_options = get\_option( 'wps\_upsell\_analytics\_configuration', array() ); |
| [2988](#L2988) |  |
| [2989](#L2989) | $ga\_analytics\_config = ! empty( $upsell\_analytics\_options['google-analytics'] ) ? $upsell\_analytics\_options['google-analytics'] : array(); |
| [2990](#L2990) | $fb\_pixel\_config     = ! empty( $upsell\_analytics\_options['facebook-pixel'] ) ? $upsell\_analytics\_options['facebook-pixel'] : array(); |
| [2991](#L2991) |  |
| [2992](#L2992) | $add\_ga\_base\_code       = false; |
| [2993](#L2993) | $add\_fb\_pixel\_base\_code = false; |
| [2994](#L2994) |  |
| [2995](#L2995) | if ( ! empty( $ga\_analytics\_config['enable\_ga\_gst'] ) && 'yes' === $ga\_analytics\_config['enable\_ga\_gst'] && ! empty( $ga\_analytics\_config['ga\_account\_id'] ) ) { |
| [2996](#L2996) |  |
| [2997](#L2997) | $add\_ga\_base\_code = true; |
| [2998](#L2998) |  |
| [2999](#L2999) | $ga\_tracking\_id = $ga\_analytics\_config['ga\_account\_id']; |
| [3000](#L3000) | } |
| [3001](#L3001) |  |
| [3002](#L3002) | if ( ! empty( $fb\_pixel\_config['enable\_pixel\_basecode'] ) && 'yes' === $fb\_pixel\_config['enable\_pixel\_basecode'] && ! empty( $fb\_pixel\_config['pixel\_account\_id'] ) ) { |
| [3003](#L3003) |  |
| [3004](#L3004) | $add\_fb\_pixel\_base\_code = true; |
| [3005](#L3005) |  |
| [3006](#L3006) | $pixel\_id = $fb\_pixel\_config['pixel\_account\_id']; |
| [3007](#L3007) | } |
| [3008](#L3008) |  |
| [3009](#L3009) | if ( true === $add\_ga\_base\_code ) : |
| [3010](#L3010) |  |
| [3011](#L3011) | // Global site tag (gtag.js) - Google Analytics - Start ( 1 Click Upsell Plugin ). |
| [3012](#L3012) | wp\_enqueue\_script( $this->plugin\_name . '-googletagmanager', 'https://www.googletagmanager.com/gtag/js?id=' . $ga\_tracking\_id, array( 'jquery' ), '1.0.0', false ); |
| [3013](#L3013) |  |
| [3014](#L3014) | ?> |
| [3015](#L3015) | <script> |
| [3016](#L3016) | window.dataLayer = window.dataLayer || []; |
| [3017](#L3017) | function gtag(){dataLayer.push(arguments)}; |
| [3018](#L3018) | gtag('js', new Date()); |
| [3019](#L3019) |  |
| [3020](#L3020) | gtag('config', '<?php echo esc\_attr( $ga\_tracking\_id ); ?>'); |
| [3021](#L3021) | </script> |
| [3022](#L3022) | <!-- Global site tag (gtag.js) - Google Analytics - End ( 1 Click Upsell Plugin ) --> |
| [3023](#L3023) | <?php |
| [3024](#L3024) |  |
| [3025](#L3025) | endif; |
| [3026](#L3026) |  |
| [3027](#L3027) | if ( true === $add\_fb\_pixel\_base\_code ) : |
| [3028](#L3028) |  |
| [3029](#L3029) | ?> |
| [3030](#L3030) | <!-- Facebook Pixel Code ( 1 Click Upsell Plugin ) --> |
| [3031](#L3031) | <script> |
| [3032](#L3032) | !function(f,b,e,v,n,t,s) |
| [3033](#L3033) | {if(f.fbq)return;n=f.fbq=function(){n.callMethod? |
| [3034](#L3034) | n.callMethod.apply(n,arguments):n.queue.push(arguments)}; |
| [3035](#L3035) | if(!f.\_fbq)f.\_fbq=n;n.push=n;n.loaded=!0;n.version='2.0'; |
| [3036](#L3036) | n.queue=[];t=b.createElement(e);t.async=!0; |
| [3037](#L3037) | t.src=v;s=b.getElementsByTagName(e)[0]; |
| [3038](#L3038) | s.parentNode.insertBefore(t,s)}(window, document,'script', |
| [3039](#L3039) | 'https://connect.facebook.net/en\_US/fbevents.js'); |
| [3040](#L3040) | fbq('init', '<?php echo( esc\_html( $pixel\_id ) ); ?>'); |
| [3041](#L3041) | fbq('track', 'PageView'); |
| [3042](#L3042) | </script> |
| [3043](#L3043) | <noscript> |
| [3044](#L3044) | <img height="1" width="1" style="display:none" |
| [3045](#L3045) | src="https://www.facebook.com/tr?id=<?php echo( esc\_html( $pixel\_id ) ); ?>&ev=PageView&noscript=1" |
| [3046](#L3046) | /> |
| [3047](#L3047) | </noscript> |
| [3048](#L3048) | <!-- End Facebook Pixel Code ( 1 Click Upsell Plugin ) --> |
| [3049](#L3049) | <?php |
| [3050](#L3050) |  |
| [3051](#L3051) | endif; |
| [3052](#L3052) | } |
| [3053](#L3053) |  |
| [3054](#L3054) | /\*\* |
| [3055](#L3055) | \* GA and FB Pixel Purchase Event - Track Parent Order on 1st Upsell Offer Page. |
| [3056](#L3056) | \* |
| [3057](#L3057) | \* @since    3.0.0 |
| [3058](#L3058) | \*/ |
| [3059](#L3059) | public function ga\_and\_fb\_pixel\_purchase\_event\_for\_parent\_order() { |
| [3060](#L3060) |  |
| [3061](#L3061) | $validate\_shortcode = $this->validate\_shortcode(); |
| [3062](#L3062) |  |
| [3063](#L3063) | if ( 'live\_offer' === $validate\_shortcode ) { |
| [3064](#L3064) |  |
| [3065](#L3065) | $upsell\_analytics\_options = get\_option( 'wps\_upsell\_analytics\_configuration', array() ); |
| [3066](#L3066) |  |
| [3067](#L3067) | $ga\_analytics\_config = ! empty( $upsell\_analytics\_options['google-analytics'] ) ? $upsell\_analytics\_options['google-analytics'] : array(); |
| [3068](#L3068) | $fb\_pixel\_config     = ! empty( $upsell\_analytics\_options['facebook-pixel'] ) ? $upsell\_analytics\_options['facebook-pixel'] : array(); |
| [3069](#L3069) |  |
| [3070](#L3070) | $add\_ga\_purchase\_event       = false; |
| [3071](#L3071) | $add\_fb\_pixel\_purchase\_event = false; |
| [3072](#L3072) |  |
| [3073](#L3073) | if ( ! empty( $ga\_analytics\_config['enable\_purchase\_event'] ) && 'yes' === $ga\_analytics\_config['enable\_purchase\_event'] ) { |
| [3074](#L3074) |  |
| [3075](#L3075) | $add\_ga\_purchase\_event = true; |
| [3076](#L3076) | } |
| [3077](#L3077) |  |
| [3078](#L3078) | if ( ! empty( $fb\_pixel\_config['enable\_purchase\_event'] ) && 'yes' === $fb\_pixel\_config['enable\_purchase\_event'] ) { |
| [3079](#L3079) |  |
| [3080](#L3080) | $add\_fb\_pixel\_purchase\_event = true; |
| [3081](#L3081) | } |
| [3082](#L3082) |  |
| [3083](#L3083) | if ( $add\_ga\_purchase\_event ) : |
| [3084](#L3084) |  |
| [3085](#L3085) | $this->add\_ga\_purchase\_event\_for\_parent\_order(); |
| [3086](#L3086) |  |
| [3087](#L3087) | endif; |
| [3088](#L3088) |  |
| [3089](#L3089) | if ( $add\_fb\_pixel\_purchase\_event ) : |
| [3090](#L3090) |  |
| [3091](#L3091) | $this->add\_fb\_pixel\_purchase\_event\_for\_parent\_order(); |
| [3092](#L3092) |  |
| [3093](#L3093) | endif; |
| [3094](#L3094) | } |
| [3095](#L3095) | } |
| [3096](#L3096) |  |
| [3097](#L3097) | /\*\* |
| [3098](#L3098) | \* GA and FB Pixel Purchase Event - Track Order on Thankyou page. |
| [3099](#L3099) | \* |
| [3100](#L3100) | \* @param mixed $order\_id order id. |
| [3101](#L3101) | \* @since    3.0.0 |
| [3102](#L3102) | \*/ |
| [3103](#L3103) | public function ga\_and\_fb\_pixel\_purchase\_event( $order\_id = '' ) { |
| [3104](#L3104) |  |
| [3105](#L3105) | $upsell\_analytics\_options = get\_option( 'wps\_upsell\_analytics\_configuration', array() ); |
| [3106](#L3106) |  |
| [3107](#L3107) | $ga\_analytics\_config = ! empty( $upsell\_analytics\_options['google-analytics'] ) ? $upsell\_analytics\_options['google-analytics'] : array(); |
| [3108](#L3108) | $fb\_pixel\_config     = ! empty( $upsell\_analytics\_options['facebook-pixel'] ) ? $upsell\_analytics\_options['facebook-pixel'] : array(); |
| [3109](#L3109) |  |
| [3110](#L3110) | $add\_ga\_purchase\_event       = false; |
| [3111](#L3111) | $add\_fb\_pixel\_purchase\_event = false; |
| [3112](#L3112) |  |
| [3113](#L3113) | if ( ! empty( $ga\_analytics\_config['enable\_purchase\_event'] ) && 'yes' === $ga\_analytics\_config['enable\_purchase\_event'] ) { |
| [3114](#L3114) |  |
| [3115](#L3115) | $add\_ga\_purchase\_event = true; |
| [3116](#L3116) | } |
| [3117](#L3117) |  |
| [3118](#L3118) | if ( ! empty( $fb\_pixel\_config['enable\_purchase\_event'] ) && 'yes' === $fb\_pixel\_config['enable\_purchase\_event'] ) { |
| [3119](#L3119) |  |
| [3120](#L3120) | $add\_fb\_pixel\_purchase\_event = true; |
| [3121](#L3121) | } |
| [3122](#L3122) |  |
| [3123](#L3123) | if ( $add\_ga\_purchase\_event ) : |
| [3124](#L3124) |  |
| [3125](#L3125) | $this->add\_ga\_purchase\_event( $order\_id ); |
| [3126](#L3126) |  |
| [3127](#L3127) | endif; |
| [3128](#L3128) |  |
| [3129](#L3129) | if ( $add\_fb\_pixel\_purchase\_event ) : |
| [3130](#L3130) |  |
| [3131](#L3131) | $this->add\_fb\_pixel\_purchase\_event( $order\_id ); |
| [3132](#L3132) |  |
| [3133](#L3133) | endif; |
| [3134](#L3134) | } |
| [3135](#L3135) |  |
| [3136](#L3136) | /\*\* |
| [3137](#L3137) | \* Google Analyics Purchase Event for Parent Order. |
| [3138](#L3138) | \* |
| [3139](#L3139) | \* @since    3.0.0 |
| [3140](#L3140) | \*/ |
| [3141](#L3141) | public function add\_ga\_purchase\_event\_for\_parent\_order() { |
| [3142](#L3142) |  |
| [3143](#L3143) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [3144](#L3144) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [3145](#L3145) |  |
| [3146](#L3146) | if ( ! $id\_nonce\_verified ) { |
| [3147](#L3147) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [3148](#L3148) | } |
| [3149](#L3149) | $order\_key = isset( $\_GET['ocuf\_ok'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ) : ''; |
| [3150](#L3150) |  |
| [3151](#L3151) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [3152](#L3152) |  |
| [3153](#L3153) | // Process once and only for Upsells. |
| [3154](#L3154) | if ( empty( $order\_id ) || ! wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, 'wps\_upsell\_order\_started', true ) === true || ! empty( wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_ga\_parent\_tracked', true ) ) || wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_ga\_tracked', true ) === 1 ) { |
| [3155](#L3155) |  |
| [3156](#L3156) | return; |
| [3157](#L3157) | } |
| [3158](#L3158) |  |
| [3159](#L3159) | $order = wc\_get\_order( $order\_id ); |
| [3160](#L3160) |  |
| [3161](#L3161) | if ( empty( $order ) ) { |
| [3162](#L3162) |  |
| [3163](#L3163) | return; |
| [3164](#L3164) | } |
| [3165](#L3165) |  |
| [3166](#L3166) | // Only for those payment gateways with which Parent Order is Secured. |
| [3167](#L3167) | $payment\_method = $order->get\_payment\_method(); |
| [3168](#L3168) |  |
| [3169](#L3169) | $gateways\_with\_parent\_secured = wps\_upsell\_lite\_payment\_gateways\_with\_parent\_secured(); |
| [3170](#L3170) |  |
| [3171](#L3171) | if ( ! in\_array( $payment\_method, $gateways\_with\_parent\_secured, true ) ) { |
| [3172](#L3172) |  |
| [3173](#L3173) | return; |
| [3174](#L3174) | } |
| [3175](#L3175) |  |
| [3176](#L3176) | // Start Tracking handling. |
| [3177](#L3177) |  |
| [3178](#L3178) | global $woocommerce; |
| [3179](#L3179) |  |
| [3180](#L3180) | // Get Coupon Codes. |
| [3181](#L3181) | $coupons\_list = ''; |
| [3182](#L3182) |  |
| [3183](#L3183) | if ( version\_compare( $woocommerce->version, '3.7', '>' ) ) { |
| [3184](#L3184) |  |
| [3185](#L3185) | if ( $order->get\_coupon\_codes() ) { |
| [3186](#L3186) |  |
| [3187](#L3187) | $coupons\_count = count( $order->get\_coupon\_codes() ); |
| [3188](#L3188) | $i             = 1; |
| [3189](#L3189) |  |
| [3190](#L3190) | foreach ( $order->get\_coupon\_codes() as $coupon ) { |
| [3191](#L3191) |  |
| [3192](#L3192) | $coupons\_list .= $coupon; |
| [3193](#L3193) | if ( $i < $coupons\_count ) { |
| [3194](#L3194) | $coupons\_list .= ', '; |
| [3195](#L3195) | } |
| [3196](#L3196) | $i++; |
| [3197](#L3197) | } |
| [3198](#L3198) | } |
| [3199](#L3199) | } else { |
| [3200](#L3200) |  |
| [3201](#L3201) | if ( $order->get\_used\_coupons() ) { |
| [3202](#L3202) |  |
| [3203](#L3203) | $coupons\_count = count( $order->get\_used\_coupons() ); |
| [3204](#L3204) | $i             = 1; |
| [3205](#L3205) |  |
| [3206](#L3206) | foreach ( $order->get\_used\_coupons() as $coupon ) { |
| [3207](#L3207) |  |
| [3208](#L3208) | $coupons\_list .= $coupon; |
| [3209](#L3209) | if ( $i < $coupons\_count ) { |
| [3210](#L3210) | $coupons\_list .= ', '; |
| [3211](#L3211) | } |
| [3212](#L3212) | $i++; |
| [3213](#L3213) | } |
| [3214](#L3214) | } |
| [3215](#L3215) | } |
| [3216](#L3216) |  |
| [3217](#L3217) | // All Order items. |
| [3218](#L3218) | $order\_items = $order->get\_items(); |
| [3219](#L3219) |  |
| [3220](#L3220) | if ( ! empty( $order\_items ) && is\_array( $order\_items ) ) { |
| [3221](#L3221) |  |
| [3222](#L3222) | foreach ( $order\_items as $item ) { |
| [3223](#L3223) |  |
| [3224](#L3224) | $\_product = $item->get\_product(); |
| [3225](#L3225) |  |
| [3226](#L3226) | if ( isset( $\_product->variation\_data ) ) { |
| [3227](#L3227) |  |
| [3228](#L3228) | $categories = esc\_js( wc\_get\_formatted\_variation( $\_product->get\_variation\_attributes(), true ) ); |
| [3229](#L3229) | } else { |
| [3230](#L3230) |  |
| [3231](#L3231) | $out = array(); |
| [3232](#L3232) |  |
| [3233](#L3233) | $categories = get\_the\_terms( $\_product->get\_id(), 'product\_cat' ); |
| [3234](#L3234) |  |
| [3235](#L3235) | if ( $categories ) { |
| [3236](#L3236) |  |
| [3237](#L3237) | foreach ( $categories as $category ) { |
| [3238](#L3238) |  |
| [3239](#L3239) | $out[] = $category->name; |
| [3240](#L3240) | } |
| [3241](#L3241) | } |
| [3242](#L3242) |  |
| [3243](#L3243) | $categories = esc\_js( join( ',', $out ) ); |
| [3244](#L3244) | } |
| [3245](#L3245) |  |
| [3246](#L3246) | $product\_data[ get\_permalink( $\_product->get\_id() ) ] = array( |
| [3247](#L3247) | 'p\_id'    => esc\_html( $\_product->get\_id() ), |
| [3248](#L3248) | 'p\_sku'   => esc\_js( $\_product->get\_sku() ? $\_product->get\_sku() : $\_product->get\_id() ), |
| [3249](#L3249) | 'p\_name'  => html\_entity\_decode( $\_product->get\_title() ), |
| [3250](#L3250) | 'p\_price' => esc\_js( $order->get\_item\_total( $item ) ), |
| [3251](#L3251) | 'p\_cat'   => $categories, |
| [3252](#L3252) | 'p\_qty'   => esc\_js( $item['qty'] ), |
| [3253](#L3253) | ); |
| [3254](#L3254) | } |
| [3255](#L3255) |  |
| [3256](#L3256) | if ( ! empty( $product\_data ) ) { |
| [3257](#L3257) |  |
| [3258](#L3258) | // Add Product data json. |
| [3259](#L3259) | wc\_enqueue\_js( 'wps\_upsell\_ga\_pd=' . wp\_json\_encode( $product\_data ) . ';' ); |
| [3260](#L3260) | } |
| [3261](#L3261) | } |
| [3262](#L3262) |  |
| [3263](#L3263) | // Get Shipping total. |
| [3264](#L3264) | $total\_shipping = $order->get\_total\_shipping(); |
| [3265](#L3265) |  |
| [3266](#L3266) | $order\_total     = $order->get\_total(); |
| [3267](#L3267) | $order\_total\_tax = $order->get\_total\_tax(); |
| [3268](#L3268) |  |
| [3269](#L3269) | $upsell\_ga\_parent\_tracked\_data = array( |
| [3270](#L3270) | 'order\_total'          => $order\_total, |
| [3271](#L3271) | 'order\_total\_tax'      => $order\_total\_tax, |
| [3272](#L3272) | 'order\_total\_shipping' => $total\_shipping, |
| [3273](#L3273) | ); |
| [3274](#L3274) |  |
| [3275](#L3275) | $transaction\_data = array( |
| [3276](#L3276) | 'id'          => esc\_js( $order->get\_order\_number() ), |
| [3277](#L3277) | 'affiliation' => esc\_js( get\_bloginfo( 'name' ) ), |
| [3278](#L3278) | 'revenue'     => esc\_js( $order\_total ), |
| [3279](#L3279) | 'tax'         => esc\_js( $order\_total\_tax ), |
| [3280](#L3280) | 'shipping'    => esc\_js( $total\_shipping ), |
| [3281](#L3281) | 'coupon'      => $coupons\_list, |
| [3282](#L3282) | 'currency'    => get\_woocommerce\_currency(), |
| [3283](#L3283) | 'label'       => 'Parent Purchase', |
| [3284](#L3284) | ); |
| [3285](#L3285) |  |
| [3286](#L3286) | // Add Transaction data json. |
| [3287](#L3287) | wc\_enqueue\_js( 'wps\_upsell\_ga\_td=' . wp\_json\_encode( $transaction\_data ) . ';' ); |
| [3288](#L3288) |  |
| [3289](#L3289) | $ga\_purchase\_js = ' |
| [3290](#L3290) | var items = []; |
| [3291](#L3291) | //set local currencies |
| [3292](#L3292) | gtag("set", {"currency": wps\_upsell\_ga\_td.currency}); |
| [3293](#L3293) | for(var p\_item in wps\_upsell\_ga\_pd){ |
| [3294](#L3294) | items.push({ |
| [3295](#L3295) | "id": wps\_upsell\_ga\_pd[p\_item].p\_sku, |
| [3296](#L3296) | "name": wps\_upsell\_ga\_pd[p\_item].p\_name, |
| [3297](#L3297) | "category": wps\_upsell\_ga\_pd[p\_item].p\_cat, |
| [3298](#L3298) | "price": wps\_upsell\_ga\_pd[p\_item].p\_price, |
| [3299](#L3299) | "quantity": wps\_upsell\_ga\_pd[p\_item].p\_qty, |
| [3300](#L3300) | }); |
| [3301](#L3301) |  |
| [3302](#L3302) | } |
| [3303](#L3303) | gtag("event", "purchase", { |
| [3304](#L3304) | "transaction\_id":wps\_upsell\_ga\_td.id, |
| [3305](#L3305) | "affiliation": wps\_upsell\_ga\_td.affiliation, |
| [3306](#L3306) | "value":wps\_upsell\_ga\_td.revenue, |
| [3307](#L3307) | "tax": wps\_upsell\_ga\_td.tax, |
| [3308](#L3308) | "shipping": wps\_upsell\_ga\_td.shipping, |
| [3309](#L3309) | "coupon": wps\_upsell\_ga\_td.coupon, |
| [3310](#L3310) | "event\_category": "ecommerce", |
| [3311](#L3311) | "event\_label": wps\_upsell\_ga\_td.label, |
| [3312](#L3312) | "non\_interaction": true, |
| [3313](#L3313) | "items":items |
| [3314](#L3314) | }); |
| [3315](#L3315) | '; |
| [3316](#L3316) |  |
| [3317](#L3317) | wc\_enqueue\_js( $ga\_purchase\_js ); |
| [3318](#L3318) |  |
| [3319](#L3319) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_upsell\_ga\_parent\_tracked', $upsell\_ga\_parent\_tracked\_data ); |
| [3320](#L3320) | } |
| [3321](#L3321) |  |
| [3322](#L3322) | /\*\* |
| [3323](#L3323) | \* Google Analyics Purchase Event for Parent Order. |
| [3324](#L3324) | \* |
| [3325](#L3325) | \* @param string $order\_id order id. |
| [3326](#L3326) | \* |
| [3327](#L3327) | \* @since    3.0.0 |
| [3328](#L3328) | \*/ |
| [3329](#L3329) | public function add\_ga\_purchase\_event( $order\_id = '' ) { |
| [3330](#L3330) |  |
| [3331](#L3331) | if ( empty( $order\_id ) || wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_ga\_tracked', true ) === 1 ) { |
| [3332](#L3332) |  |
| [3333](#L3333) | return; |
| [3334](#L3334) | } |
| [3335](#L3335) |  |
| [3336](#L3336) | $order = wc\_get\_order( $order\_id ); |
| [3337](#L3337) |  |
| [3338](#L3338) | if ( empty( $order ) ) { |
| [3339](#L3339) |  |
| [3340](#L3340) | return; |
| [3341](#L3341) | } |
| [3342](#L3342) |  |
| [3343](#L3343) | // Start Tracking handling. |
| [3344](#L3344) |  |
| [3345](#L3345) | global $woocommerce; |
| [3346](#L3346) |  |
| [3347](#L3347) | // Get Coupon Codes. |
| [3348](#L3348) | $coupons\_list = ''; |
| [3349](#L3349) |  |
| [3350](#L3350) | if ( version\_compare( $woocommerce->version, '3.7', '>' ) ) { |
| [3351](#L3351) |  |
| [3352](#L3352) | if ( $order->get\_coupon\_codes() ) { |
| [3353](#L3353) |  |
| [3354](#L3354) | $coupons\_count = count( $order->get\_coupon\_codes() ); |
| [3355](#L3355) | $i             = 1; |
| [3356](#L3356) |  |
| [3357](#L3357) | foreach ( $order->get\_coupon\_codes() as $coupon ) { |
| [3358](#L3358) |  |
| [3359](#L3359) | $coupons\_list .= $coupon; |
| [3360](#L3360) | if ( $i < $coupons\_count ) { |
| [3361](#L3361) | $coupons\_list .= ', '; |
| [3362](#L3362) | } |
| [3363](#L3363) | $i++; |
| [3364](#L3364) | } |
| [3365](#L3365) | } |
| [3366](#L3366) | } else { |
| [3367](#L3367) |  |
| [3368](#L3368) | if ( $order->get\_used\_coupons() ) { |
| [3369](#L3369) |  |
| [3370](#L3370) | $coupons\_count = count( $order->get\_used\_coupons() ); |
| [3371](#L3371) | $i             = 1; |
| [3372](#L3372) |  |
| [3373](#L3373) | foreach ( $order->get\_used\_coupons() as $coupon ) { |
| [3374](#L3374) |  |
| [3375](#L3375) | $coupons\_list .= $coupon; |
| [3376](#L3376) | if ( $i < $coupons\_count ) { |
| [3377](#L3377) | $coupons\_list .= ', '; |
| [3378](#L3378) | } |
| [3379](#L3379) | $i++; |
| [3380](#L3380) | } |
| [3381](#L3381) | } |
| [3382](#L3382) | } |
| [3383](#L3383) |  |
| [3384](#L3384) | $upsell\_ga\_parent\_tracked      = false; |
| [3385](#L3385) | $upsell\_ga\_parent\_tracked\_data = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_ga\_parent\_tracked', true ); |
| [3386](#L3386) |  |
| [3387](#L3387) | if ( ! empty( $upsell\_ga\_parent\_tracked\_data ) && is\_array( $upsell\_ga\_parent\_tracked\_data ) ) { |
| [3388](#L3388) |  |
| [3389](#L3389) | $upsell\_ga\_parent\_tracked = true; |
| [3390](#L3390) | $upsell\_purchase          = false; |
| [3391](#L3391) | } |
| [3392](#L3392) |  |
| [3393](#L3393) | // All Order items. |
| [3394](#L3394) | $order\_items = $order->get\_items(); |
| [3395](#L3395) |  |
| [3396](#L3396) | if ( ! empty( $order\_items ) && is\_array( $order\_items ) ) { |
| [3397](#L3397) |  |
| [3398](#L3398) | foreach ( $order\_items as $item\_id => $item ) { |
| [3399](#L3399) |  |
| [3400](#L3400) | // When Parent Order is already tracked. |
| [3401](#L3401) | if ( $upsell\_ga\_parent\_tracked ) { |
| [3402](#L3402) |  |
| [3403](#L3403) | // If not Upsell Purchase Item then Continue. So this loop will only add Upsell items if Parent Order is already tracked. |
| [3404](#L3404) | if ( empty( $item->get\_meta( 'is\_upsell\_purchase' ) ) ) { |
| [3405](#L3405) |  |
| [3406](#L3406) | continue; |
| [3407](#L3407) | } |
| [3408](#L3408) |  |
| [3409](#L3409) | // Did not continue means there is an Upsell item. |
| [3410](#L3410) | $upsell\_purchase = true; |
| [3411](#L3411) | } |
| [3412](#L3412) |  |
| [3413](#L3413) | $\_product = $item->get\_product(); |
| [3414](#L3414) |  |
| [3415](#L3415) | if ( isset( $\_product->variation\_data ) ) { |
| [3416](#L3416) |  |
| [3417](#L3417) | $categories = esc\_js( wc\_get\_formatted\_variation( $\_product->get\_variation\_attributes(), true ) ); |
| [3418](#L3418) | } else { |
| [3419](#L3419) |  |
| [3420](#L3420) | $out = array(); |
| [3421](#L3421) |  |
| [3422](#L3422) | $categories = get\_the\_terms( $\_product->get\_id(), 'product\_cat' ); |
| [3423](#L3423) |  |
| [3424](#L3424) | if ( $categories ) { |
| [3425](#L3425) |  |
| [3426](#L3426) | foreach ( $categories as $category ) { |
| [3427](#L3427) |  |
| [3428](#L3428) | $out[] = $category->name; |
| [3429](#L3429) | } |
| [3430](#L3430) | } |
| [3431](#L3431) |  |
| [3432](#L3432) | $categories = esc\_js( join( ',', $out ) ); |
| [3433](#L3433) | } |
| [3434](#L3434) |  |
| [3435](#L3435) | $product\_data[ get\_permalink( $\_product->get\_id() ) ] = array( |
| [3436](#L3436) | 'p\_id'    => esc\_html( $\_product->get\_id() ), |
| [3437](#L3437) | 'p\_sku'   => esc\_js( $\_product->get\_sku() ? $\_product->get\_sku() : $\_product->get\_id() ), |
| [3438](#L3438) | 'p\_name'  => html\_entity\_decode( $\_product->get\_title() ), |
| [3439](#L3439) | 'p\_price' => esc\_js( $order->get\_item\_total( $item ) ), |
| [3440](#L3440) | 'p\_cat'   => $categories, |
| [3441](#L3441) | 'p\_qty'   => esc\_js( $item['qty'] ), |
| [3442](#L3442) | ); |
| [3443](#L3443) | } |
| [3444](#L3444) |  |
| [3445](#L3445) | if ( ! empty( $product\_data ) ) { |
| [3446](#L3446) |  |
| [3447](#L3447) | // Add Product data json. |
| [3448](#L3448) | wc\_enqueue\_js( 'wps\_upsell\_ga\_pd=' . wp\_json\_encode( $product\_data ) . ';' ); |
| [3449](#L3449) | } |
| [3450](#L3450) | } |
| [3451](#L3451) |  |
| [3452](#L3452) | // When Parent Order is already tracked. |
| [3453](#L3453) | if ( $upsell\_ga\_parent\_tracked ) { |
| [3454](#L3454) |  |
| [3455](#L3455) | // No Upsell Items so return as no need to send any data to GA as it's already tracked. |
| [3456](#L3456) | if ( false === $upsell\_purchase ) { |
| [3457](#L3457) |  |
| [3458](#L3458) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_upsell\_ga\_tracked', 1 ); |
| [3459](#L3459) | return; |
| [3460](#L3460) | } |
| [3461](#L3461) | } |
| [3462](#L3462) |  |
| [3463](#L3463) | // Get Shipping total. |
| [3464](#L3464) | $total\_shipping = $order->get\_total\_shipping(); |
| [3465](#L3465) |  |
| [3466](#L3466) | $order\_total     = $order->get\_total(); |
| [3467](#L3467) | $order\_total\_tax = $order->get\_total\_tax(); |
| [3468](#L3468) |  |
| [3469](#L3469) | $transaction\_data = array( |
| [3470](#L3470) | 'id'          => esc\_js( $order->get\_order\_number() ), |
| [3471](#L3471) | 'affiliation' => esc\_js( get\_bloginfo( 'name' ) ), |
| [3472](#L3472) | 'revenue'     => esc\_js( $order\_total ), |
| [3473](#L3473) | 'tax'         => esc\_js( $order\_total\_tax ), |
| [3474](#L3474) | 'shipping'    => esc\_js( $total\_shipping ), |
| [3475](#L3475) | 'coupon'      => $coupons\_list, |
| [3476](#L3476) | 'currency'    => get\_woocommerce\_currency(), |
| [3477](#L3477) | 'label'       => 'Purchase', |
| [3478](#L3478) |  |
| [3479](#L3479) | ); |
| [3480](#L3480) |  |
| [3481](#L3481) | // When Parent Order is already tracked. |
| [3482](#L3482) | if ( $upsell\_ga\_parent\_tracked ) { |
| [3483](#L3483) |  |
| [3484](#L3484) | $parent\_order\_total          = ! empty( $upsell\_ga\_parent\_tracked\_data['order\_total'] ) ? $upsell\_ga\_parent\_tracked\_data['order\_total'] : 0; |
| [3485](#L3485) | $parent\_order\_total\_tax      = ! empty( $upsell\_ga\_parent\_tracked\_data['order\_total\_tax'] ) ? $upsell\_ga\_parent\_tracked\_data['order\_total\_tax'] : 0; |
| [3486](#L3486) | $parent\_order\_total\_shipping = ! empty( $upsell\_ga\_parent\_tracked\_data['order\_total\_shipping'] ) ? $upsell\_ga\_parent\_tracked\_data['order\_total\_shipping'] : 0; |
| [3487](#L3487) |  |
| [3488](#L3488) | $current\_order\_total          = $order\_total - $parent\_order\_total; |
| [3489](#L3489) | $current\_order\_total\_tax      = $order\_total\_tax - $parent\_order\_total\_tax; |
| [3490](#L3490) | $current\_order\_total\_shipping = $total\_shipping - $parent\_order\_total\_shipping; |
| [3491](#L3491) |  |
| [3492](#L3492) | $transaction\_data = array( |
| [3493](#L3493) | 'id'          => esc\_js( $order->get\_order\_number() ), |
| [3494](#L3494) | 'affiliation' => esc\_js( get\_bloginfo( 'name' ) ), |
| [3495](#L3495) | 'revenue'     => esc\_js( $current\_order\_total ), |
| [3496](#L3496) | 'tax'         => esc\_js( $current\_order\_total\_tax ), |
| [3497](#L3497) | 'shipping'    => esc\_js( $current\_order\_total\_shipping ), |
| [3498](#L3498) | 'currency'    => get\_woocommerce\_currency(), |
| [3499](#L3499) | 'label'       => 'Upsell Purchase', |
| [3500](#L3500) | ); |
| [3501](#L3501) | } |
| [3502](#L3502) |  |
| [3503](#L3503) | // Add Transaction data json. |
| [3504](#L3504) | wc\_enqueue\_js( 'wps\_upsell\_ga\_td=' . wp\_json\_encode( $transaction\_data ) . ';' ); |
| [3505](#L3505) |  |
| [3506](#L3506) | $ga\_purchase\_js = ' |
| [3507](#L3507) | var items = []; |
| [3508](#L3508) | //set local currencies |
| [3509](#L3509) | gtag("set", {"currency": wps\_upsell\_ga\_td.currency}); |
| [3510](#L3510) | for(var p\_item in wps\_upsell\_ga\_pd){ |
| [3511](#L3511) | items.push({ |
| [3512](#L3512) | "id": wps\_upsell\_ga\_pd[p\_item].p\_sku, |
| [3513](#L3513) | "name": wps\_upsell\_ga\_pd[p\_item].p\_name, |
| [3514](#L3514) | "category": wps\_upsell\_ga\_pd[p\_item].p\_cat, |
| [3515](#L3515) | "price": wps\_upsell\_ga\_pd[p\_item].p\_price, |
| [3516](#L3516) | "quantity": wps\_upsell\_ga\_pd[p\_item].p\_qty, |
| [3517](#L3517) | }); |
| [3518](#L3518) |  |
| [3519](#L3519) | } |
| [3520](#L3520) | gtag("event", "purchase", { |
| [3521](#L3521) | "transaction\_id":wps\_upsell\_ga\_td.id, |
| [3522](#L3522) | "affiliation": wps\_upsell\_ga\_td.affiliation, |
| [3523](#L3523) | "value":wps\_upsell\_ga\_td.revenue, |
| [3524](#L3524) | "tax": wps\_upsell\_ga\_td.tax, |
| [3525](#L3525) | "shipping": wps\_upsell\_ga\_td.shipping, |
| [3526](#L3526) | "coupon": wps\_upsell\_ga\_td.coupon, |
| [3527](#L3527) | "event\_category": "ecommerce", |
| [3528](#L3528) | "event\_label": wps\_upsell\_ga\_td.label, |
| [3529](#L3529) | "non\_interaction": true, |
| [3530](#L3530) | "items":items |
| [3531](#L3531) | }); |
| [3532](#L3532) | '; |
| [3533](#L3533) |  |
| [3534](#L3534) | wc\_enqueue\_js( $ga\_purchase\_js ); |
| [3535](#L3535) |  |
| [3536](#L3536) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_upsell\_ga\_tracked', 1 ); |
| [3537](#L3537) | } |
| [3538](#L3538) |  |
| [3539](#L3539) | /\*\* |
| [3540](#L3540) | \* Facebook Pixel Purchase Event for Parent Order. |
| [3541](#L3541) | \* |
| [3542](#L3542) | \* @since    3.0.0 |
| [3543](#L3543) | \*/ |
| [3544](#L3544) | public function add\_fb\_pixel\_purchase\_event\_for\_parent\_order() { |
| [3545](#L3545) |  |
| [3546](#L3546) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [3547](#L3547) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [3548](#L3548) |  |
| [3549](#L3549) | if ( ! $id\_nonce\_verified ) { |
| [3550](#L3550) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [3551](#L3551) | } |
| [3552](#L3552) |  |
| [3553](#L3553) | $order\_key = isset( $\_GET['ocuf\_ok'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ok'] ) ) : ''; |
| [3554](#L3554) |  |
| [3555](#L3555) | $order\_id = wc\_get\_order\_id\_by\_order\_key( $order\_key ); |
| [3556](#L3556) |  |
| [3557](#L3557) | // Process once and only for Upsells. |
| [3558](#L3558) | if ( empty( $order\_id ) || ! wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, 'wps\_upsell\_order\_started', true ) === true || ! empty( wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_fbp\_parent\_tracked', true ) ) || wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_fbp\_tracked', true ) === true ) { |
| [3559](#L3559) |  |
| [3560](#L3560) | return; |
| [3561](#L3561) | } |
| [3562](#L3562) |  |
| [3563](#L3563) | $order = wc\_get\_order( $order\_id ); |
| [3564](#L3564) |  |
| [3565](#L3565) | if ( empty( $order ) ) { |
| [3566](#L3566) |  |
| [3567](#L3567) | return; |
| [3568](#L3568) | } |
| [3569](#L3569) |  |
| [3570](#L3570) | // Only for those payment gateways with which Parent Order is Secured. |
| [3571](#L3571) | $payment\_method = $order->get\_payment\_method(); |
| [3572](#L3572) |  |
| [3573](#L3573) | $gateways\_with\_parent\_secured = wps\_upsell\_lite\_payment\_gateways\_with\_parent\_secured(); |
| [3574](#L3574) |  |
| [3575](#L3575) | if ( ! in\_array( $payment\_method, $gateways\_with\_parent\_secured, true ) ) { |
| [3576](#L3576) |  |
| [3577](#L3577) | return; |
| [3578](#L3578) | } |
| [3579](#L3579) |  |
| [3580](#L3580) | // Start Tracking handling. |
| [3581](#L3581) |  |
| [3582](#L3582) | $order\_total = $order->get\_total() ? $order->get\_total() : 0; |
| [3583](#L3583) |  |
| [3584](#L3584) | $content\_type = 'product'; |
| [3585](#L3585) | $product\_ids  = array(); |
| [3586](#L3586) |  |
| [3587](#L3587) | foreach ( $order->get\_items() as $item ) { |
| [3588](#L3588) | $product = wc\_get\_product( $item['product\_id'] ); |
| [3589](#L3589) |  |
| [3590](#L3590) | $product\_ids[] = $product->get\_id(); |
| [3591](#L3591) |  |
| [3592](#L3592) | if ( $product->get\_type() === 'variable' ) { |
| [3593](#L3593) | $content\_type = 'product\_group'; |
| [3594](#L3594) | } |
| [3595](#L3595) | } |
| [3596](#L3596) |  |
| [3597](#L3597) | $params = array( |
| [3598](#L3598) | 'content\_ids'  => wp\_json\_encode( $product\_ids ), |
| [3599](#L3599) | 'content\_type' => $content\_type, |
| [3600](#L3600) | 'value'        => $order\_total, |
| [3601](#L3601) | 'currency'     => get\_woocommerce\_currency(), |
| [3602](#L3602) | ); |
| [3603](#L3603) |  |
| [3604](#L3604) | $fb\_purchase\_js = sprintf( "fbq('%s', '%s', %s);", 'track', 'Purchase', wp\_json\_encode( $params, JSON\_PRETTY\_PRINT | JSON\_FORCE\_OBJECT ) ); |
| [3605](#L3605) |  |
| [3606](#L3606) | wc\_enqueue\_js( $fb\_purchase\_js ); |
| [3607](#L3607) |  |
| [3608](#L3608) | $upsell\_fb\_pixel\_parent\_tracked\_data = array( |
| [3609](#L3609) | 'order\_total' => $order\_total, |
| [3610](#L3610) | ); |
| [3611](#L3611) |  |
| [3612](#L3612) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_upsell\_fbp\_parent\_tracked', $upsell\_fb\_pixel\_parent\_tracked\_data ); |
| [3613](#L3613) | } |
| [3614](#L3614) |  |
| [3615](#L3615) | /\*\* |
| [3616](#L3616) | \* Facebook Pixel Purchase Event. |
| [3617](#L3617) | \* |
| [3618](#L3618) | \* @param string $order\_id order id. |
| [3619](#L3619) | \* |
| [3620](#L3620) | \* @since    3.0.0 |
| [3621](#L3621) | \*/ |
| [3622](#L3622) | public function add\_fb\_pixel\_purchase\_event( $order\_id = '' ) { |
| [3623](#L3623) |  |
| [3624](#L3624) | if ( empty( $order\_id ) || true === wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_fbp\_tracked', true ) ) { |
| [3625](#L3625) |  |
| [3626](#L3626) | return; |
| [3627](#L3627) | } |
| [3628](#L3628) |  |
| [3629](#L3629) | $order = wc\_get\_order( $order\_id ); |
| [3630](#L3630) |  |
| [3631](#L3631) | if ( empty( $order ) ) { |
| [3632](#L3632) |  |
| [3633](#L3633) | return; |
| [3634](#L3634) | } |
| [3635](#L3635) |  |
| [3636](#L3636) | // Start Tracking handling. |
| [3637](#L3637) |  |
| [3638](#L3638) | $order\_total = $order->get\_total() ? $order->get\_total() : 0; |
| [3639](#L3639) |  |
| [3640](#L3640) | $content\_type = 'product'; |
| [3641](#L3641) | $product\_ids  = array(); |
| [3642](#L3642) |  |
| [3643](#L3643) | $upsell\_fb\_pixel\_parent\_tracked      = false; |
| [3644](#L3644) | $upsell\_fb\_pixel\_parent\_tracked\_data = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_fbp\_parent\_tracked', true ); |
| [3645](#L3645) |  |
| [3646](#L3646) | if ( ! empty( $upsell\_fb\_pixel\_parent\_tracked\_data ) && is\_array( $upsell\_fb\_pixel\_parent\_tracked\_data ) ) { |
| [3647](#L3647) |  |
| [3648](#L3648) | $upsell\_fb\_pixel\_parent\_tracked = true; |
| [3649](#L3649) | $upsell\_purchase                = false; |
| [3650](#L3650) | } |
| [3651](#L3651) |  |
| [3652](#L3652) | foreach ( $order->get\_items() as $item\_id => $item ) { |
| [3653](#L3653) |  |
| [3654](#L3654) | // When Parent Order is already tracked. |
| [3655](#L3655) | if ( $upsell\_fb\_pixel\_parent\_tracked ) { |
| [3656](#L3656) |  |
| [3657](#L3657) | // If not Upsell Purchase Item then Continue. |
| [3658](#L3658) | if ( empty( $item->get\_meta( 'is\_upsell\_purchase' ) ) ) { |
| [3659](#L3659) |  |
| [3660](#L3660) | continue; |
| [3661](#L3661) | } |
| [3662](#L3662) |  |
| [3663](#L3663) | // Did not continue means there is an Upsell item. |
| [3664](#L3664) | $upsell\_purchase = true; |
| [3665](#L3665) | } |
| [3666](#L3666) |  |
| [3667](#L3667) | $product = wc\_get\_product( $item['product\_id'] ); |
| [3668](#L3668) |  |
| [3669](#L3669) | $product\_ids[] = $product->get\_id(); |
| [3670](#L3670) |  |
| [3671](#L3671) | if ( $product->get\_type() === 'variable' ) { |
| [3672](#L3672) | $content\_type = 'product\_group'; |
| [3673](#L3673) | } |
| [3674](#L3674) | } |
| [3675](#L3675) |  |
| [3676](#L3676) | // When Parent Order is already tracked. |
| [3677](#L3677) | if ( $upsell\_fb\_pixel\_parent\_tracked ) { |
| [3678](#L3678) |  |
| [3679](#L3679) | // No Upsell Items so return as no need to send any data. |
| [3680](#L3680) | if ( false === $upsell\_purchase ) { |
| [3681](#L3681) |  |
| [3682](#L3682) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_upsell\_fbp\_tracked', true ); |
| [3683](#L3683) | return; |
| [3684](#L3684) | } |
| [3685](#L3685) | } |
| [3686](#L3686) |  |
| [3687](#L3687) | // When Parent Order is already tracked. |
| [3688](#L3688) | if ( $upsell\_fb\_pixel\_parent\_tracked ) { |
| [3689](#L3689) |  |
| [3690](#L3690) | $parent\_order\_total = ! empty( $upsell\_fb\_pixel\_parent\_tracked\_data['order\_total'] ) ? $upsell\_fb\_pixel\_parent\_tracked\_data['order\_total'] : 0; |
| [3691](#L3691) |  |
| [3692](#L3692) | $order\_total = $order\_total - $parent\_order\_total; |
| [3693](#L3693) |  |
| [3694](#L3694) | $params = array( |
| [3695](#L3695) | 'content\_ids'  => wp\_json\_encode( $product\_ids ), |
| [3696](#L3696) | 'content\_type' => $content\_type, |
| [3697](#L3697) | 'value'        => $order\_total, |
| [3698](#L3698) | 'currency'     => get\_woocommerce\_currency(), |
| [3699](#L3699) | ); |
| [3700](#L3700) | } else { |
| [3701](#L3701) |  |
| [3702](#L3702) | $params = array( |
| [3703](#L3703) | 'content\_ids'  => wp\_json\_encode( $product\_ids ), |
| [3704](#L3704) | 'content\_type' => $content\_type, |
| [3705](#L3705) | 'value'        => $order\_total, |
| [3706](#L3706) | 'currency'     => get\_woocommerce\_currency(), |
| [3707](#L3707) | ); |
| [3708](#L3708) | } |
| [3709](#L3709) |  |
| [3710](#L3710) | $fb\_purchase\_js = sprintf( "fbq('%s', '%s', %s);", 'track', 'Purchase', wp\_json\_encode( $params, JSON\_PRETTY\_PRINT | JSON\_FORCE\_OBJECT ) ); |
| [3711](#L3711) |  |
| [3712](#L3712) | wc\_enqueue\_js( $fb\_purchase\_js ); |
| [3713](#L3713) |  |
| [3714](#L3714) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_upsell\_fbp\_tracked', true ); |
| [3715](#L3715) | } |
| [3716](#L3716) |  |
| [3717](#L3717) |  |
| [3718](#L3718) | /\*\* |
| [3719](#L3719) | \* Compatibility for Enhanced Ecommerce Google Analytics Plugin by Tatvic. |
| [3720](#L3720) | \* Remove plugin's Purchase Event from Thankyou page when |
| [3721](#L3721) | \* Upsell Purchase is enabled. |
| [3722](#L3722) | \* |
| [3723](#L3723) | \* @since    3.0.0 |
| [3724](#L3724) | \*/ |
| [3725](#L3725) | public function upsell\_ga\_compatibility\_for\_eega() { |
| [3726](#L3726) |  |
| [3727](#L3727) | if ( ! class\_exists( 'Enhanced\_Ecommerce\_Google\_Analytics' ) ) { |
| [3728](#L3728) |  |
| [3729](#L3729) | return; |
| [3730](#L3730) | } |
| [3731](#L3731) |  |
| [3732](#L3732) | $upsell\_analytics\_options = get\_option( 'wps\_upsell\_analytics\_configuration', array() ); |
| [3733](#L3733) |  |
| [3734](#L3734) | $ga\_analytics\_config = ! empty( $upsell\_analytics\_options['google-analytics'] ) ? $upsell\_analytics\_options['google-analytics'] : array(); |
| [3735](#L3735) |  |
| [3736](#L3736) | $add\_ga\_purchase\_event = false; |
| [3737](#L3737) |  |
| [3738](#L3738) | if ( ! empty( $ga\_analytics\_config['enable\_purchase\_event'] ) && 'yes' === $ga\_analytics\_config['enable\_purchase\_event'] ) { |
| [3739](#L3739) |  |
| [3740](#L3740) | $add\_ga\_purchase\_event = true; |
| [3741](#L3741) | } |
| [3742](#L3742) |  |
| [3743](#L3743) | // Only when Upsell Purchase is enabled. |
| [3744](#L3744) | if ( $add\_ga\_purchase\_event ) { |
| [3745](#L3745) |  |
| [3746](#L3746) | global $wp\_filter; |
| [3747](#L3747) |  |
| [3748](#L3748) | foreach ( $wp\_filter['woocommerce\_thankyou']->callbacks as $key => $plugin\_cbs ) { |
| [3749](#L3749) |  |
| [3750](#L3750) | // Only remove the one with default priority. |
| [3751](#L3751) | if ( 10 !== $key ) { |
| [3752](#L3752) |  |
| [3753](#L3753) | continue; |
| [3754](#L3754) | } |
| [3755](#L3755) |  |
| [3756](#L3756) | foreach ( $plugin\_cbs as $cb\_key => $cb\_obj ) { |
| [3757](#L3757) |  |
| [3758](#L3758) | if ( isset( $cb\_obj['function'] ) && is\_array( $cb\_obj['function'] ) ) { |
| [3759](#L3759) |  |
| [3760](#L3760) | // Check if the current object belongs to the class. |
| [3761](#L3761) | if ( is\_a( $cb\_obj['function']['0'], 'Enhanced\_Ecommerce\_Google\_Analytics\_Public' ) ) { |
| [3762](#L3762) |  |
| [3763](#L3763) | $enhanced\_ecommerce\_google\_analytics = $cb\_obj['function']['0']; |
| [3764](#L3764) |  |
| [3765](#L3765) | remove\_action( 'woocommerce\_thankyou', array( $enhanced\_ecommerce\_google\_analytics, 'ecommerce\_tracking\_code' ) ); |
| [3766](#L3766) |  |
| [3767](#L3767) | break 2; |
| [3768](#L3768) | } |
| [3769](#L3769) | } |
| [3770](#L3770) | } |
| [3771](#L3771) | } |
| [3772](#L3772) | } |
| [3773](#L3773) | } |
| [3774](#L3774) |  |
| [3775](#L3775) | /\*\* |
| [3776](#L3776) | \* Compatibility for Facebook for WooCommerce plugin. |
| [3777](#L3777) | \* Remove plugin's Purchase Event from Thankyou page when |
| [3778](#L3778) | \* Upsell Purchase is enabled. |
| [3779](#L3779) | \* |
| [3780](#L3780) | \* @since    3.0.0 |
| [3781](#L3781) | \*/ |
| [3782](#L3782) | public function upsell\_fbp\_compatibility\_for\_ffw() { |
| [3783](#L3783) |  |
| [3784](#L3784) | if ( ! class\_exists( 'WC\_Facebookcommerce\_EventsTracker' ) ) { |
| [3785](#L3785) |  |
| [3786](#L3786) | return; |
| [3787](#L3787) | } |
| [3788](#L3788) |  |
| [3789](#L3789) | $wc\_integrations = WC()->integrations->get\_integrations(); |
| [3790](#L3790) |  |
| [3791](#L3791) | if ( isset( $wc\_integrations['facebookcommerce'] ) && $wc\_integrations['facebookcommerce'] instanceof WC\_Facebookcommerce\_Integration ) { |
| [3792](#L3792) |  |
| [3793](#L3793) | $upsell\_analytics\_options = get\_option( 'wps\_upsell\_analytics\_configuration', array() ); |
| [3794](#L3794) |  |
| [3795](#L3795) | $fb\_pixel\_config = ! empty( $upsell\_analytics\_options['facebook-pixel'] ) ? $upsell\_analytics\_options['facebook-pixel'] : array(); |
| [3796](#L3796) |  |
| [3797](#L3797) | $add\_fb\_pixel\_purchase\_event = false; |
| [3798](#L3798) |  |
| [3799](#L3799) | if ( ! empty( $fb\_pixel\_config['enable\_purchase\_event'] ) && 'yes' === $fb\_pixel\_config['enable\_purchase\_event'] ) { |
| [3800](#L3800) |  |
| [3801](#L3801) | $add\_fb\_pixel\_purchase\_event = true; |
| [3802](#L3802) | } |
| [3803](#L3803) |  |
| [3804](#L3804) | if ( $add\_fb\_pixel\_purchase\_event ) { |
| [3805](#L3805) |  |
| [3806](#L3806) | // For Facebook for WooCommerce plugin version >= 1.1.0. |
| [3807](#L3807) | remove\_action( 'woocommerce\_thankyou', array( $wc\_integrations['facebookcommerce']->events\_tracker, 'inject\_purchase\_event' ), 40 ); |
| [3808](#L3808) | } |
| [3809](#L3809) | } |
| [3810](#L3810) | } |
| [3811](#L3811) |  |
| [3812](#L3812) | /\*\* |
| [3813](#L3813) | \* Global Custom CSS. |
| [3814](#L3814) | \* |
| [3815](#L3815) | \* @since    3.0.0 |
| [3816](#L3816) | \*/ |
| [3817](#L3817) | public function global\_custom\_css() { |
| [3818](#L3818) |  |
| [3819](#L3819) | // Ignore admin, feed, robots or trackbacks. |
| [3820](#L3820) | if ( is\_admin() || is\_feed() || is\_robots() || is\_trackback() ) { |
| [3821](#L3821) |  |
| [3822](#L3822) | return; |
| [3823](#L3823) | } |
| [3824](#L3824) |  |
| [3825](#L3825) | $wps\_upsell\_global\_settings = get\_option( 'wps\_upsell\_lite\_global\_options', array() ); |
| [3826](#L3826) |  |
| [3827](#L3827) | $global\_custom\_css = ! empty( $wps\_upsell\_global\_settings['global\_custom\_css'] ) ? $wps\_upsell\_global\_settings['global\_custom\_css'] : ''; |
| [3828](#L3828) |  |
| [3829](#L3829) | if ( empty( $global\_custom\_css ) ) { |
| [3830](#L3830) |  |
| [3831](#L3831) | return; |
| [3832](#L3832) | } |
| [3833](#L3833) |  |
| [3834](#L3834) | wp\_register\_style( 'wps\_upsell\_pro\_global\_custom\_css', false, array(), WC\_VERSION, 'all' ); |
| [3835](#L3835) | wp\_enqueue\_style( 'wps\_upsell\_pro\_global\_custom\_css' ); |
| [3836](#L3836) | wp\_add\_inline\_style( 'wps\_upsell\_pro\_global\_custom\_css', $global\_custom\_css ); |
| [3837](#L3837) |  |
| [3838](#L3838) | } |
| [3839](#L3839) |  |
| [3840](#L3840) | /\*\* |
| [3841](#L3841) | \* Global Custom JS. |
| [3842](#L3842) | \* |
| [3843](#L3843) | \* @since    3.0.0 |
| [3844](#L3844) | \*/ |
| [3845](#L3845) | public function global\_custom\_js() { |
| [3846](#L3846) |  |
| [3847](#L3847) | // Ignore admin, feed, robots or trackbacks. |
| [3848](#L3848) | if ( is\_admin() || is\_feed() || is\_robots() || is\_trackback() ) { |
| [3849](#L3849) |  |
| [3850](#L3850) | return; |
| [3851](#L3851) | } |
| [3852](#L3852) |  |
| [3853](#L3853) | $wps\_upsell\_global\_settings = get\_option( 'wps\_upsell\_lite\_global\_options', array() ); |
| [3854](#L3854) |  |
| [3855](#L3855) | $global\_custom\_js = ! empty( $wps\_upsell\_global\_settings['global\_custom\_js'] ) ? $wps\_upsell\_global\_settings['global\_custom\_js'] : ''; |
| [3856](#L3856) |  |
| [3857](#L3857) | if ( empty( $global\_custom\_js ) ) { |
| [3858](#L3858) | return; |
| [3859](#L3859) | } |
| [3860](#L3860) |  |
| [3861](#L3861) | wp\_register\_script( 'wps\_upsell\_pro\_global\_custom\_js', false, array( 'jquery' ), WC\_VERSION, false ); |
| [3862](#L3862) | wp\_enqueue\_script( 'wps\_upsell\_pro\_global\_custom\_js' ); |
| [3863](#L3863) | wp\_add\_inline\_script( 'wps\_upsell\_pro\_global\_custom\_js', $global\_custom\_js ); |
| [3864](#L3864) | } |
| [3865](#L3865) |  |
| [3866](#L3866) | /\*\* |
| [3867](#L3867) | \* Allow Script tags in wp\_kses |
| [3868](#L3868) | \* |
| [3869](#L3869) | \* @param array $allowedposttags allowed post tags. |
| [3870](#L3870) | \* @return array |
| [3871](#L3871) | \*/ |
| [3872](#L3872) | public function wocuf\_lite\_allow\_script\_tags( $allowedposttags ) { |
| [3873](#L3873) | $allowedposttags['script'] = array( |
| [3874](#L3874) | 'src'    => true, |
| [3875](#L3875) | 'height' => true, |
| [3876](#L3876) | 'width'  => true, |
| [3877](#L3877) | ); |
| [3878](#L3878) | return $allowedposttags; |
| [3879](#L3879) | } |
| [3880](#L3880) |  |
| [3881](#L3881) | /\*\* |
| [3882](#L3882) | \* Shortcode for offer - Timer button. |
| [3883](#L3883) | \* |
| [3884](#L3884) | \* @param array  $atts    atts. |
| [3885](#L3885) | \* @param string $content content. |
| [3886](#L3886) | \* |
| [3887](#L3887) | \* @since       3.0.0 |
| [3888](#L3888) | \*/ |
| [3889](#L3889) | public function timer\_shortcode\_content( $atts, $content = '' ) { |
| [3890](#L3890) |  |
| [3891](#L3891) | $validate\_shortcode = $this->validate\_shortcode(); |
| [3892](#L3892) |  |
| [3893](#L3893) | if ( $validate\_shortcode ) { |
| [3894](#L3894) |  |
| [3895](#L3895) | $minutes    = ! empty( $atts['minutes'] ) ? abs( $atts['minutes'] ) : 5; |
| [3896](#L3896) | $expiration = $minutes \* 60; |
| [3897](#L3897) |  |
| [3898](#L3898) | if ( empty( $expiration ) || ! is\_numeric( $expiration ) ) { |
| [3899](#L3899) |  |
| [3900](#L3900) | return esc\_html\_\_( 'Time is not specified correctly.', 'woo-one-click-upsell-funnel' ); |
| [3901](#L3901) | } |
| [3902](#L3902) |  |
| [3903](#L3903) | ?> |
| [3904](#L3904) |  |
| [3905](#L3905) | <?php ob\_start(); ?> |
| [3906](#L3906) |  |
| [3907](#L3907) | <?php if ( false === wp\_cache\_get( 'wps\_upsell\_countdown\_timer' ) ) : ?> |
| [3908](#L3908) |  |
| [3909](#L3909) | <script type="text/javascript"> |
| [3910](#L3910) |  |
| [3911](#L3911) | jQuery(document).ready(function($) { |
| [3912](#L3912) |  |
| [3913](#L3913) | // Set the date we're counting down to. |
| [3914](#L3914) | var current = new Date(); |
| [3915](#L3915) | var expiration = parseFloat( <?php echo( esc\_html( $expiration ) ); ?> ); // Digit in seconds. |
| [3916](#L3916) | <?php |
| [3917](#L3917) | $secure\_nonce      = wp\_create\_nonce( 'wps-upsell-auth-nonce' ); |
| [3918](#L3918) | $id\_nonce\_verified = wp\_verify\_nonce( $secure\_nonce, 'wps-upsell-auth-nonce' ); |
| [3919](#L3919) |  |
| [3920](#L3920) | if ( ! $id\_nonce\_verified ) { |
| [3921](#L3921) | wp\_die( esc\_html\_\_( 'Nonce Not verified', ' woo-one-click-upsell-funnel' ) ); |
| [3922](#L3922) | } |
| [3923](#L3923) | ?> |
| [3924](#L3924) | var offer\_id = <?php echo ! empty( $\_GET['ocuf\_ofd'] ) ? esc\_html( sanitize\_text\_field( wp\_unslash( $\_GET['ocuf\_ofd'] ) ) ) : 'null'; ?>; |
| [3925](#L3925) |  |
| [3926](#L3926) | var timer\_limit = sessionStorage.getItem( 'timerlimit\_' + offer\_id ); |
| [3927](#L3927) | var countDowntime = null != offer\_id && null != timer\_limit ? timer\_limit : current.setSeconds( current.getSeconds()+expiration ); |
| [3928](#L3928) |  |
| [3929](#L3929) | // Update the count down every 1 second. |
| [3930](#L3930) | var  timer  = setInterval(function() { |
| [3931](#L3931) |  |
| [3932](#L3932) | // Find the distance between now and the count down time. |
| [3933](#L3933) | var distance = countDowntime - new Date().getTime(); |
| [3934](#L3934) |  |
| [3935](#L3935) | // Time calculations for days, hours, minutes and seconds |
| [3936](#L3936) | var hours = Math.floor((distance % (1000 \* 60 \* 60 \* 24)) / (1000 \* 60 \* 60)); |
| [3937](#L3937) | var minutes = Math.floor((distance % (1000 \* 60 \* 60)) / (1000 \* 60)); |
| [3938](#L3938) | var seconds = Math.floor((distance % (1000 \* 60)) / 1000); |
| [3939](#L3939) |  |
| [3940](#L3940) | // If the count down is finished, redirect; |
| [3941](#L3941) | if ( distance < 0 ) { |
| [3942](#L3942) |  |
| [3943](#L3943) | clearInterval( timer ); |
| [3944](#L3944) |  |
| [3945](#L3945) | // Expired the session before redirecting. |
| [3946](#L3946) | $( 'a' ).each(function() { |
| [3947](#L3947) |  |
| [3948](#L3948) | if( this.href.includes( 'ocuf\_th' ) ) { |
| [3949](#L3949) |  |
| [3950](#L3950) | jQuery( this )[0].click(); |
| [3951](#L3951) | } |
| [3952](#L3952) | }); |
| [3953](#L3953) |  |
| [3954](#L3954) | } else { |
| [3955](#L3955) |  |
| [3956](#L3956) | if( seconds.toString().length == '1' ) { |
| [3957](#L3957) |  |
| [3958](#L3958) | seconds = '0' + seconds; |
| [3959](#L3959) |  |
| [3960](#L3960) | } |
| [3961](#L3961) |  |
| [3962](#L3962) | if( minutes.toString().length == '1' ) { |
| [3963](#L3963) |  |
| [3964](#L3964) | minutes = '0' + minutes; |
| [3965](#L3965) |  |
| [3966](#L3966) | } |
| [3967](#L3967) |  |
| [3968](#L3968) | $('.wps\_upsell\_lite\_display\_hours').html( hours ); |
| [3969](#L3969) | $('.wps\_upsell\_lite\_display\_minutes').html( minutes ); |
| [3970](#L3970) | $('.wps\_upsell\_lite\_display\_seconds').html( seconds ); |
| [3971](#L3971) |  |
| [3972](#L3972) | } |
| [3973](#L3973) |  |
| [3974](#L3974) | }, 300 ); |
| [3975](#L3975) |  |
| [3976](#L3976) | sessionStorage.setItem( 'timerlimit\_' + offer\_id, countDowntime ); |
| [3977](#L3977) | }); |
| [3978](#L3978) |  |
| [3979](#L3979) | </script> |
| [3980](#L3980) |  |
| [3981](#L3981) | <?php wp\_cache\_set( 'wps\_upsell\_countdown\_timer', 'true' ); ?> |
| [3982](#L3982) |  |
| [3983](#L3983) | <?php endif; ?> |
| [3984](#L3984) |  |
| [3985](#L3985) | <!-- Countdown timer html. --> |
| [3986](#L3986) | <span class="wps\_upsell\_lite\_display\_timer\_wrap"> |
| [3987](#L3987) | <span class="wps\_upsell\_lite\_timer\_digit"> |
| [3988](#L3988) | <span class="wps\_upsell\_lite\_display\_minutes wps\_upsell\_lite\_display\_timer">00</span> |
| [3989](#L3989) | <span class="wps\_upsell\_lite\_text"><?php esc\_html\_e( 'minutes', 'woo-one-click-upsell-funnel' ); ?></span> |
| [3990](#L3990) | </span> |
| [3991](#L3991) | <span class="wps\_upsell\_lite\_timer\_digit"> |
| [3992](#L3992) | <span class="wps\_upsell\_lite\_display\_timer\_col">:</span> |
| [3993](#L3993) | </span> |
| [3994](#L3994) | <span class="wps\_upsell\_lite\_timer\_digit"> |
| [3995](#L3995) | <span class="wps\_upsell\_lite\_display\_seconds wps\_upsell\_lite\_display\_timer">00</span> |
| [3996](#L3996) | <span class="wps\_upsell\_lite\_text"><?php esc\_html\_e( 'seconds', 'woo-one-click-upsell-funnel' ); ?></span> |
| [3997](#L3997) | </span> |
| [3998](#L3998) | </span> |
| [3999](#L3999) |  |
| [4000](#L4000) | <?php |
| [4001](#L4001) |  |
| [4002](#L4002) | $output = ob\_get\_contents(); |
| [4003](#L4003) | ob\_end\_clean(); |
| [4004](#L4004) |  |
| [4005](#L4005) | return $output; |
| [4006](#L4006) | } |
| [4007](#L4007) | } |
| [4008](#L4008) |  |
| [4009](#L4009) | /\*\* |
| [4010](#L4010) | \* Delete the Timer data in browser session for Timer shortcode. |
| [4011](#L4011) | \* |
| [4012](#L4012) | \* @since   3.0.0 |
| [4013](#L4013) | \*/ |
| [4014](#L4014) | public function reset\_timer\_session\_data() { |
| [4015](#L4015) |  |
| [4016](#L4016) | // Don this only on thank you page. |
| [4017](#L4017) | if ( ! is\_wc\_endpoint\_url( 'order-received' ) ) { |
| [4018](#L4018) |  |
| [4019](#L4019) | return; |
| [4020](#L4020) | } |
| [4021](#L4021) |  |
| [4022](#L4022) | ?> |
| [4023](#L4023) |  |
| [4024](#L4024) | <script type="text/javascript"> |
| [4025](#L4025) |  |
| [4026](#L4026) | // Clear timestamp from SessionStorage. |
| [4027](#L4027) | if( typeof sessionStorage !== 'undefined' && sessionStorage.length > 0 ) { |
| [4028](#L4028) |  |
| [4029](#L4029) | // Must reduce these variable. |
| [4030](#L4030) | sessionStorage.removeItem( 'timerlimit\_1' ); |
| [4031](#L4031) | sessionStorage.removeItem( 'timerlimit\_null' ); |
| [4032](#L4032) |  |
| [4033](#L4033) | for ( var i = 0; i < sessionStorage.length; i++ ) { |
| [4034](#L4034) |  |
| [4035](#L4035) | if( sessionStorage.key(i).search( 'timerlimit\_' ) == 0 ) { |
| [4036](#L4036) |  |
| [4037](#L4037) | sessionStorage.removeItem( sessionStorage.key(i) ); |
| [4038](#L4038) | } |
| [4039](#L4039) | } |
| [4040](#L4040) | } |
| [4041](#L4041) |  |
| [4042](#L4042) | </script> |
| [4043](#L4043) |  |
| [4044](#L4044) | <?php |
| [4045](#L4045) |  |
| [4046](#L4046) | } |
| [4047](#L4047) |  |
| [4048](#L4048) |  |
| [4049](#L4049) | /\*\* |
| [4050](#L4050) | \* Shortcode for quantity. |
| [4051](#L4051) | \* Returns : html :) |
| [4052](#L4052) | \* |
| [4053](#L4053) | \* Shows woocommerce quantity field. |
| [4054](#L4054) | \* |
| [4055](#L4055) | \* @param mixed $atts shortcode attributes. |
| [4056](#L4056) | \* @since       3.0.0 |
| [4057](#L4057) | \*/ |
| [4058](#L4058) | public function quantity\_shortcode\_content( $atts ) { |
| [4059](#L4059) |  |
| [4060](#L4060) | $validate\_shortcode = $this->validate\_shortcode(); |
| [4061](#L4061) |  |
| [4062](#L4062) | if ( $validate\_shortcode ) { |
| [4063](#L4063) |  |
| [4064](#L4064) | $maximum = ! empty( $atts['max'] ) ? abs( $atts['max'] ) : 3; |
| [4065](#L4065) | $minimum = ! empty( $atts['min'] ) ? abs( $atts['min'] ) : 1; |
| [4066](#L4066) |  |
| [4067](#L4067) | $product\_id = $this->get\_upsell\_product\_id\_for\_shortcode(); |
| [4068](#L4068) |  |
| [4069](#L4069) | if ( ! empty( $product\_id ) ) { |
| [4070](#L4070) |  |
| [4071](#L4071) | $post\_type = get\_post\_type( $product\_id ); |
| [4072](#L4072) | $product   = wc\_get\_product( $product\_id ); |
| [4073](#L4073) |  |
| [4074](#L4074) | if ( empty( $product ) ) { |
| [4075](#L4075) |  |
| [4076](#L4076) | return ''; |
| [4077](#L4077) | } |
| [4078](#L4078) |  |
| [4079](#L4079) | if ( 'product' !== $post\_type && 'product\_variation' !== $post\_type ) { |
| [4080](#L4080) |  |
| [4081](#L4081) | return ''; |
| [4082](#L4082) | } |
| [4083](#L4083) |  |
| [4084](#L4084) | ob\_start(); |
| [4085](#L4085) |  |
| [4086](#L4086) | ?> |
| [4087](#L4087) |  |
| [4088](#L4088) | <!-- Countdown timer html. --> |
| [4089](#L4089) | <div class="wps\_upsell\_quantity quantity"> |
| [4090](#L4090) | <label class="screen-reader-text" for="wps\_upsell\_quantity\_field"><?php echo esc\_html( $product->get\_title() ); ?></label> |
| [4091](#L4091) | <input type="number" id="wps\_upsell\_quantity\_field" class="input-text qty text wps\_upsell\_quantity\_input" step="1" min="<?php echo( esc\_html( $minimum ) ); ?>" max="<?php echo( esc\_html( $maximum ) ); ?>" value="1" title="Qty" inputmode="numeric"> |
| [4092](#L4092) | </div> |
| [4093](#L4093) |  |
| [4094](#L4094) | <?php |
| [4095](#L4095) |  |
| [4096](#L4096) | $output = ob\_get\_contents(); |
| [4097](#L4097) | ob\_end\_clean(); |
| [4098](#L4098) |  |
| [4099](#L4099) | return $output; |
| [4100](#L4100) | } |
| [4101](#L4101) | } |
| [4102](#L4102) | } |
| [4103](#L4103) |  |
| [4104](#L4104) |  |
| [4105](#L4105) | /\*\* |
| [4106](#L4106) | \* Hide upsell Items meta string. |
| [4107](#L4107) | \* |
| [4108](#L4108) | \* @param mixed $formatted\_meta formatted meta. |
| [4109](#L4109) | \* @since       3.0.0 |
| [4110](#L4110) | \*/ |
| [4111](#L4111) | public function hide\_order\_item\_formatted\_meta\_data( $formatted\_meta ) { |
| [4112](#L4112) |  |
| [4113](#L4113) | foreach ( $formatted\_meta as $key => $meta ) { |
| [4114](#L4114) |  |
| [4115](#L4115) | if ( ! empty( $meta->key ) && 'is\_upsell\_purchase' === $meta->key ) { |
| [4116](#L4116) |  |
| [4117](#L4117) | unset( $formatted\_meta[ $key ] ); |
| [4118](#L4118) | } |
| [4119](#L4119) | } |
| [4120](#L4120) |  |
| [4121](#L4121) | return $formatted\_meta; |
| [4122](#L4122) | } |
| [4123](#L4123) |  |
| [4124](#L4124) | /\*\* |
| [4125](#L4125) | \* Skip offer product in case of the purchased in prevous orders. |
| [4126](#L4126) | \* |
| [4127](#L4127) | \* @param      string $offer\_product\_id    The Offer product id to check. |
| [4128](#L4128) | \* |
| [4129](#L4129) | \* @since    3.0.0 |
| [4130](#L4130) | \*/ |
| [4131](#L4131) | public static function wps\_wocuf\_skip\_for\_pre\_order( $offer\_product\_id = '' ) { |
| [4132](#L4132) |  |
| [4133](#L4133) | if ( empty( $offer\_product\_id ) ) { |
| [4134](#L4134) |  |
| [4135](#L4135) | return; |
| [4136](#L4136) | } |
| [4137](#L4137) |  |
| [4138](#L4138) | $offer\_product = wc\_get\_product( $offer\_product\_id ); |
| [4139](#L4139) |  |
| [4140](#L4140) | // In case the offer is variable parent then no need to check this. |
| [4141](#L4141) | if ( ! empty( $offer\_product ) && is\_object( $offer\_product ) && $offer\_product->has\_child() ) { |
| [4142](#L4142) |  |
| [4143](#L4143) | return false; |
| [4144](#L4144) | } |
| [4145](#L4145) |  |
| [4146](#L4146) | // Current user ID. |
| [4147](#L4147) | $customer\_user\_id = get\_current\_user\_id(); |
| [4148](#L4148) |  |
| [4149](#L4149) | // Getting current customer orders. |
| [4150](#L4150) | $order\_statuses = array( 'wc-on-hold', 'wc-processing', 'wc-completed' ); |
| [4151](#L4151) |  |
| [4152](#L4152) | $customer\_user\_id = get\_current\_user\_id(); |
| [4153](#L4153) | $customer\_orders = wc\_get\_orders( |
| [4154](#L4154) | array( |
| [4155](#L4155) | 'customer' => $customer\_user\_id, |
| [4156](#L4156) | 'order' => 'DESC', |
| [4157](#L4157) | 'status' => array( 'wc-on-hold', 'wc-processing', 'wc-completed' ), |
| [4158](#L4158) | 'return'   => 'ids', |
| [4159](#L4159) | 'numberposts' => -1, |
| [4160](#L4160) | ) |
| [4161](#L4161) | ); |
| [4162](#L4162) |  |
| [4163](#L4163) | // Past Orders. |
| [4164](#L4164) | foreach ( $customer\_orders as $key => $single\_order\_id ) { |
| [4165](#L4165) |  |
| [4166](#L4166) | // Continue if order is not a valid one. |
| [4167](#L4167) | if ( ! $single\_order\_id ) { |
| [4168](#L4168) |  |
| [4169](#L4169) | continue; |
| [4170](#L4170) | } |
| [4171](#L4171) |  |
| [4172](#L4172) | $single\_order = wc\_get\_order( $single\_order\_id ); |
| [4173](#L4173) |  |
| [4174](#L4174) | // Continue if Order object is not a valid one. |
| [4175](#L4175) | if ( empty( $single\_order ) || ! is\_object( $single\_order ) || is\_wp\_error( $single\_order ) ) { |
| [4176](#L4176) |  |
| [4177](#L4177) | continue; |
| [4178](#L4178) | } |
| [4179](#L4179) |  |
| [4180](#L4180) | $items\_purchased = $single\_order->get\_items(); |
| [4181](#L4181) |  |
| [4182](#L4182) | foreach ( $items\_purchased as $key => $single\_item ) { |
| [4183](#L4183) |  |
| [4184](#L4184) | $product\_id = ! empty( $single\_item['variation\_id'] ) ? $single\_item['variation\_id'] : $single\_item['product\_id']; |
| [4185](#L4185) |  |
| [4186](#L4186) | if ( (int) $product\_id === (int) $offer\_product\_id ) { |
| [4187](#L4187) |  |
| [4188](#L4188) | return true; |
| [4189](#L4189) | } |
| [4190](#L4190) | } |
| [4191](#L4191) | } |
| [4192](#L4192) |  |
| [4193](#L4193) | return false; |
| [4194](#L4194) | } |
| [4195](#L4195) |  |
| [4196](#L4196) | /\*\* |
| [4197](#L4197) | \* Set Offers Processed for Order on Upsell Action. |
| [4198](#L4198) | \* Except for last offer. |
| [4199](#L4199) | \* |
| [4200](#L4200) | \* @param mixed $order\_id order id. |
| [4201](#L4201) | \* @param mixed $current\_offer\_id current offer id. |
| [4202](#L4202) | \* @param mixed $url url. |
| [4203](#L4203) | \* @since    3.0.1 |
| [4204](#L4204) | \*/ |
| [4205](#L4205) | public function set\_offers\_processed\_on\_upsell\_action( $order\_id, $current\_offer\_id, $url ) { |
| [4206](#L4206) |  |
| [4207](#L4207) | if ( empty( $order\_id ) || empty( $current\_offer\_id ) || empty( $url ) ) { |
| [4208](#L4208) |  |
| [4209](#L4209) | return; |
| [4210](#L4210) | } |
| [4211](#L4211) |  |
| [4212](#L4212) | $offers\_processed = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_offers\_processed', true ); |
| [4213](#L4213) |  |
| [4214](#L4214) | $offers\_processed = ! empty( $offers\_processed ) ? $offers\_processed : array(); |
| [4215](#L4215) |  |
| [4216](#L4216) | $offers\_processed[ $current\_offer\_id ] = $url; |
| [4217](#L4217) |  |
| [4218](#L4218) | wps\_wocfo\_hpos\_update\_meta\_data( $order\_id, '\_wps\_upsell\_offers\_processed', $offers\_processed ); |
| [4219](#L4219) | } |
| [4220](#L4220) |  |
| [4221](#L4221) | /\*\* |
| [4222](#L4222) | \* Validate if current offer is already processed on Upsell Action. |
| [4223](#L4223) | \* |
| [4224](#L4224) | \* @param mixed $order\_id order id. |
| [4225](#L4225) | \* @param mixed $current\_offer\_id current offer id. |
| [4226](#L4226) | \* @since    3.0.1 |
| [4227](#L4227) | \*/ |
| [4228](#L4228) | public function validate\_offers\_processed\_on\_upsell\_action( $order\_id, $current\_offer\_id ) { |
| [4229](#L4229) |  |
| [4230](#L4230) | if ( empty( $order\_id ) || empty( $current\_offer\_id ) ) { |
| [4231](#L4231) |  |
| [4232](#L4232) | return; |
| [4233](#L4233) | } |
| [4234](#L4234) |  |
| [4235](#L4235) | $offers\_processed = wps\_wocfo\_hpos\_get\_meta\_data( $order\_id, '\_wps\_upsell\_offers\_processed', true ); |
| [4236](#L4236) |  |
| [4237](#L4237) | if ( ! empty( $offers\_processed ) && is\_array( $offers\_processed ) ) { |
| [4238](#L4238) |  |
| [4239](#L4239) | foreach ( $offers\_processed as $offer\_id => $url ) { |
| [4240](#L4240) |  |
| [4241](#L4241) | // When offer is already processed, redirect to previous result of action that was taken. |
| [4242](#L4242) | if ( (int) $current\_offer\_id === (int) $offer\_id ) { |
| [4243](#L4243) |  |
| [4244](#L4244) | wp\_redirect( $url ); //phpcs:ignore |
| [4245](#L4245) | exit; |
| [4246](#L4246) | } |
| [4247](#L4247) | } |
| [4248](#L4248) | } |
| [4249](#L4249) | } |
| [4250](#L4250) |  |
| [4251](#L4251) | /\*\* |
| [4252](#L4252) | \* Remove Currency switcher on upsell page. |
| [4253](#L4253) | \* |
| [4254](#L4254) | \* @param mixed $content content. |
| [4255](#L4255) | \* @since 3.6.3 |
| [4256](#L4256) | \*/ |
| [4257](#L4257) | public function hide\_switcher\_on\_upsell\_page( $content = '' ) { |
| [4258](#L4258) |  |
| [4259](#L4259) | $validate\_shortcode = $this->validate\_shortcode(); |
| [4260](#L4260) | if ( 'live\_offer' === $validate\_shortcode ) { |
| [4261](#L4261) | return ''; |
| [4262](#L4262) | } else { |
| [4263](#L4263) | return $content; |
| [4264](#L4264) | } |
| [4265](#L4265) | } |
| [4266](#L4266) |  |
| [4267](#L4267) | /\*\* |
| [4268](#L4268) | \* Remove Currency switcher in session on deactivate. |
| [4269](#L4269) | \* |
| [4270](#L4270) | \* @since 3.6.3 |
| [4271](#L4271) | \*/ |
| [4272](#L4272) | public function check\_compatibltiy\_instance\_cs() { |
| [4273](#L4273) | if ( function\_exists( 'wps\_upsell\_lite\_is\_plugin\_active' ) ) { |
| [4274](#L4274) | $cs\_exists = wps\_upsell\_lite\_is\_plugin\_active( 'wps-multi-currency-switcher-for-woocommerce/wps-multi-currency-switcher-for-woocommerce.php' ); |
| [4275](#L4275) | if ( false === $cs\_exists ) { |
| [4276](#L4276) | if ( ! empty( WC()->session ) && WC()->session->\_\_isset( 's\_selected\_currency' ) ) { |
| [4277](#L4277) | WC()->session->\_\_unset( 's\_selected\_currency' ); |
| [4278](#L4278) | } |
| [4279](#L4279) | } |
| [4280](#L4280) | } |
| [4281](#L4281) | } |
| [4282](#L4282) |  |
| [4283](#L4283) | /\*\* |
| [4284](#L4284) | \* Add custom nonce for checkout field. |
| [4285](#L4285) | \* |
| [4286](#L4286) | \* @return void |
| [4287](#L4287) | \*/ |
| [4288](#L4288) | public function wps\_upsell\_add\_nonce\_field\_at\_checkout() { |
| [4289](#L4289) | wp\_nonce\_field( 'checkout\_order\_processed\_nonce', 'checkout\_order\_processed\_nonce' ); |
| [4290](#L4290) |  |
| [4291](#L4291) | } |
| [4292](#L4292) |  |
| [4293](#L4293) |  |
| [4294](#L4294) |  |
| [4295](#L4295) | } // End of class. |
| [4296](#L4296) |  |
| [4297](#L4297) |  |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/woo-one-click-upsell-funnel/tags/3.4.9/public/class-woocommerce-one-click-upsell-funnel-public.php?format=txt)
* [Original Format](/export/3222474/woo-one-click-upsell-funnel/tags/3.4.9/public/class-woocommerce-one-click-upsell-funnel-public.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from wordpress.org_feb6291c_20250114_210150.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

One Click Upsell Funnel for WooCommerce – Funnel Builder for WordPress, Create WooCommerce Upsell, Post-Purchase Upsell & Cross Sell Offers that Boost Sales & Increase Profits with Sales Funnel Builder

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fwoo-one-click-upsell-funnel&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fwoo-one-click-upsell-funnel&locale=en_US)

Search plugins

![](https://ps.w.org/woo-one-click-upsell-funnel/assets/banner-772x250.png?rev=2672029)
![](https://ps.w.org/woo-one-click-upsell-funnel/assets/icon-256x256.gif?rev=2903100)
# One Click Upsell Funnel for WooCommerce – Funnel Builder for WordPress, Create WooCommerce Upsell, Post-Purchase Upsell & Cross Sell Offers that Boost Sales & Increase Profits with Sales Funnel Builder

By [WP Swings](https://wpswings.com/?utm_source=wpswings-official&utm_medium=upsell-org-backend&utm_campaign=official)

[Download](https://downloads.wordpress.org/plugin/woo-one-click-upsell-funnel.3.4.10.zip)

* [Details](https://wordpress.org/plugins/woo-one-click-upsell-funnel/#description)
* [Reviews](https://wordpress.org/plugins/woo-one-click-upsell-funnel/#reviews)
* [Installation](https://wordpress.org/plugins/woo-one-click-upsell-funnel/#installation)
* [Development](https://wordpress.org/plugins/woo-one-click-upsell-funnel/#developers)

[Support](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/)

## Description

**ONE CLICK UPSELL FUNNEL FOR WOOCOMMERCE IS A FREE FUNNEL BUILDER THAT INCREASES SALES, AND AOV WITH UPSELL, CROSS SELL, DOWNSELL, AND FREQUENTLY BOUGHT TOGETHER**

💰 Upsell Funnel Creator 🛍️ Maximize Sales with eCommerce Upsells 📈 Boost Average Order Value with Upsell Funnels

Looking for the best funnel builder to skyrocket your sales? One Click Upsell Funnel for WooCommerce plugin allows the merchants to create post purchase upsell and cross sell offers, quick and easy integration into WooCommerce checkout pages and thank you pages, this plugin enables merchants to create engaging sales funnels that convert.

Customers can add these upsell products in just 1 click upsell to their cart with no hassle of re-entering the payment details. It is a complete solution for building one click upsell funnels for WooCommerce as it facilitates creating, testing, and maintaining post purchase / aftersell funnels.

Our plugin is compatible with Elementor, Divi, Themify, WP Bakery, Beaver, Site Origin, and Gutenberg page builder, allowing you to create, edit, and import upsell funnel templates, Customize checkout pages, and thank you pages with advanced designs.

Create unlimited upsell for woocommerce offers using the WooCommerce upsell plugin, and examine a track report for each sales funnel. Additionally, you may use pre-made sales funnel templates to easily set up and provide upsell for WooCommerce on your online store. Encourage customers to purchase more!

[**WooCommerce Upsell Demo**](https://demo.wpswings.com/one-click-upsell-funnel-for-woocommerce-pro/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=frontend-demo) | [**Documentation**](https://docs.wpswings.com/one-click-upsell-funnel-for-woocommerce/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-doc) | [**Contact Us**](https://wpswings.com/contact-us/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=contactus)

### Why Choose Our One Click Upsell Funnel Builder Plugin?

The One Click Upsell Funnel for WooCommerce Pro boosts sales with quick one-click post-purchase upsell offers.

Don’t miss our 🎃 Halloween Sale—grab the [**One Click Upsell Funnel PRO**](https://wpswings.com/product/one-click-upsell-funnel-for-woocommerce-pro/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-pro-halloween-24) today at 25% Off! 🎉👻

### ⭐ KEY FEATURES OF FREE ONE-CLICK UPSELL FUNNEL FOR WOOCOMMERCE PLUGIN:

**1) Create Order Bump Offers**: The Upsell Funnel plugin allows you to create Order Bump Offers directly from the funnel lists. This can be helpful in managing your upsell and order bump operations together.

**2) Pop-Up on Exit Intent**: Using the WooCommerce Upsell Plugin you can enable the pop-up on exit intent feature, allowing you to show a pop-up on upsell offer pages when a customer tries to exit the browser, this can be an ultimate upselling hack for your business.

**3) Unlimited Funnels with an Unlimited Number of Offers**: With the WordPress Sales Funnel plugin, you can create unlimited sales funnels with any number of Upsell and Cross-Sell Offers. Show your customers multiple post-purchase or aftersell offers in a single sales funnel which increases the impulse buys, average order value, and revenue of your store.

**4) Add the Shipping Price on COD One Click Upsells**: Our free click funnel plugin allows you to set the shipping price for the cash-on-delivery payment method for upsell offers. This allows you to cover operational costs for delivering the COD upsell products and maintain your profits.

**5) Generate Reports for Upsell Funnel Tracking**: The WooCommerce post-purchase upsell plugin renders funnel reports that include trigger frequency, accepted & rejected offers, conversion rates, overall sales, etc. This information emphasizes the preferences of customers for particular WordPress funnels. Moreover, using both Google Analytics and Facebook Pixel, you can also track WooCommerce upsell

**6) Global Funnels**: Create global one click funnels that trigger independently without needing target products. You can use the universal WooCommerce one-click upsell to show offers to your customers every time they purchase in your online store.

**7) Smart Offer Upgrade**: The Smart Offer Upgrade feature replaces the existing product (customer is buying) with the offer product as soon as they accept the WooCommerce upsell offer. This intelligent feature removes manual work and makes switching to upsell products seamless.

**8) Exclusive Offer Feature**: The upsell sales funnel builder creates exclusive offers for the customers, which will be shown to customers only once based on the order email. Such one click upsell offers garner higher conversion rates.

**9) Test Product Upsell Offers in Sandbox Mode**: In the Sandbox mode, the Upsell funnel builder triggers only for the admin and not for Live Customers. This enables store owners to freely view, test, and customize their Upsell funnel offers before making them live.

**10) Page Builder Support to Build Responsive Upsell Offer Pages**: Build the one-click upsell funnel for WooCommerce with Elementor Page Builder and other top builders available on WordPress. Our plugin allows you to easily create and customize your upsell offer pages without coding knowledge.

**11) Shortcodes to Build Useful Offer Page Elements**: This WordPress upsell plugin provides various shortcodes to create different offer page elements. The plugin offers shortcodes for Buy Now, No Thanks, Product Title, Description, Short Description, Image, Price, Variations, Offer Quantity, and Urgency Timer.

**12) Ability to Simplify The Buying Process**: Streamline your purchase process with additional products that customers can buy with one click checkout, without re-entering their payment details. These 1 click-upsell deals minimize churn, improve the shopping experience, and speed up the checkout process.

### A WordPress Funnel Builder for All Businesses in Every Niche

One Click Upsell is a WordPress Funnel Builder for **marketing agencies**, **eCommerce merchants**, **course creators**, **financial coaches**, **software firms**, and other **agencies** who want to offer smooth, hassle-free funnels in no time.

Visit [**One Click Upsell Funnel for WooCommerce Documentation**](https://docs.wpswings.com/one-click-upsell-funnel-for-woocommerce/?utm_source=wpswings-upsell-doc&utm_medium=upsell-org-page&utm_campaign=upsell-doc) and learn more about the features and workings of the plugin.

### LIVE DEMO OF ONE CLICK UPSELL FUNNEL PLUGIN

* [**One Click Upsell Funnel for WooCommerce Frontend Demo**](https://demo.wpswings.com/one-click-upsell-funnel-for-woocommerce-pro/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-frontend-demo)
* [**One Click Upsell Funnel for WooCommerce Backend Demo**](https://demo.wpswings.com/one-click-upsell-funnel-for-woocommerce-pro/request-for-personal-demo/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-backend-demo)

### Create Multiple Sales Funnels with One-Click Upsell Funnel For WooCommerce

* Create unlimited WordPress funnels with an unlimited number of WooCommerce upselling and cross-selling offers.
* Get a comprehensive tracking report for every sales funnel.
* Track your WordPress upsell funnel data on Google Analytics and Facebook Pixel.
* Create global woofunnels that trigger regardless of any product or category.
* Offer an upgrade of the existing product in the cart
* Show exclusive product upsell offers based on the order email.
* Display intelligently upsell offers if a customer skips the first funnel for a specific product in the purchase.
* View and edit your WooCommerce upsell funnels in sandbox mode.
* Offer upsell products in different ways with 3 pre-defined and fully customizable offer templates.
* Link your custom WooCommerce upsell offer page in the free funnel builder.
* Use pre-defined shortcodes to create offer page elements.
* Create fully customizable upsell offer pages without any coding skills.
* Build responsive and product-specific offer pages.

### 🤝 ONE CLICK UPSELL FUNNEL FOR WOOCOMMERCE PLUGIN COMPATIBILITIES

**1)** Compatibility with [**Upsell Order Bump Offer For WooCommerce Free**](https://wordpress.org/plugins/upsell-order-bump-offer-for-woocommerce/) and [**Upsell Order Bump Offer For WooCommerce Pro**](https://wpswings.com/product/upsell-order-bump-offer-for-woocommerce-pro/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=orderbump-pro)

**2)** Compatibility with [**Subscriptions For WooCommerce**](https://wordpress.org/plugins/subscriptions-for-woocommerce/),

**3)** Compatibility with [**Currency Switcher Professional for WooCommerce**](https://wordpress.org/plugins/woocommerce-currency-switcher/)

**4)** Compatibility with WooCommerce HPOS

**5)** Compatibility With Multiple Payment Gateways [**WooCommerce Stripe Payment Gateway**](https://wordpress.org/plugins/woocommerce-gateway-stripe/), [**WooCommerce PayPal Payments**](https://wordpress.org/plugins/woocommerce-paypal-payments/), [**Mollie Payments**](https://wordpress.org/plugins/mollie-payments-for-woocommerce/), [**Square**](https://wordpress.org/plugins/woocommerce-square/), and more.

**Also, we can do customization for our users to add other payment gateways.**

### WHAT PREMIUM VERSION OF ONE CLICK UPSELL FUNNEL FOR WOOCOMMERCE OFFERS

* Customize Checkout and Thank You Page Fields
* Checkout Page Design Template
* Fully Customizable and highly Converting Sales Funnel Kit Templates
* Variable Products
* Subscription Products
* Bundled Products
* Category-Based Offers
* Multiple Payment Gateways
* Premium Support
* Frequently Bought Offers
* A/b Testing

### 🏆 Take Advantage of the Exclusive Features of the One Click Upsell Funnel For WooCommerce Pro Plugin

The One Click Upsell Funnel For WooCommerce Pro plugin, is designed to help merchants create exclusive post-purchase upsell offers in WooCommerce. It allows you to create unlimited one-click upsell, cross-sell, down-sell, one-time offers, sales funnels, and exclusive customized offers. It also offers features like A/B testing to test offers effectiveness, mobile responsive templates, and the option to build custom templates from scratch.

> **Note:** 👉 Get [**One Click Upsell Funnel for WooCommerce Pro**](https://wpswings.com/product/one-click-upsell-funnel-for-woocommerce-pro/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-pro)

### See what Kolagen Boost is saying about the WooCommerce Upsell Plugin:

> Kolagen Boost noticed an increase in the average total of almost every order placed with a customer over a defined period of time with the help of the One Click Upsell plugin. [**See WooCommerce Upsell Case Study**](https://wpswings.com/case-studies/kolagen-boost/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-case-study)

“Using One click upsell plugin from WP Swings for a year and it works really well. Will add more plugins from them soon. The support is great and really fast.

– ⭐⭐⭐⭐⭐ @milla “

### ❤️‍ Support

If you need support or have questions, kindly use our online chat window [**here**](https://wpswings.com/contact-us/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=contact-us) and discover all types of [**WooCommerce Extensions**](https://wpswings.com/woocommerce-plugins/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=woocommerce-plugins) for your eCommerce store.

## Screenshots

* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-1.png?rev=2949165)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-1.png?rev=2949165)

  Create a new Funnel: Create a new upsell funnel by clicking on Create New Funnel button
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-2.png?rev=2949165)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-2.png?rev=2949165)

  Add Offer in the funnel: Add an offered product to your upsell funnel
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-3.png?rev=2949165)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-3.png?rev=2949165)

  Make Funnel Live: Save your funnel and click on the toggle button to publish it
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-4.png?rev=2623442)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-4.png?rev=2623442)

  Template 1: Upsell offer page template #1
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-5.png?rev=2623442)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-5.png?rev=2623442)

  Template 2: Upsell offer page template #2
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-6.png?rev=2672029)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-6.png?rev=2672029)

  Template 3: Upsell offer page template #3
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-7.png?rev=2672029)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-7.png?rev=2672029)

  Funnels List: View all your funnels in the Funnel List tab
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-8.png?rev=2949165)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-8.png?rev=2949165)

  Shortcodes: The Shortcodes tab provides you with several shortcodes to add different elements
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-9.png?rev=2672029)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-9.png?rev=2672029)

  Global Settings: Global settings that take effect on all funnels
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-10.png?rev=2672029)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-10.png?rev=2672029)

  Upsell Report: Check the performance of each upsell funnel
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-11.png?rev=2672029)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-11.png?rev=2672029)

  Upsell Report by date: Check the upsell performance for a set time period
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-12.png?rev=2672029)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-12.png?rev=2672029)

  Google Analytics tracking: Track upsell sales through Google Analytics
* [![](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-13.png?rev=2672029)](https://ps.w.org/woo-one-click-upsell-funnel/assets/screenshot-13.png?rev=2672029)

  FB Pixel tracking: Track upsell sales through Facebook Pixel

## Installation

#### Automatic Installation

Automatic installation is the easiest option handled by WordPress. Follow these steps for automatic installation:

Type “One-Click Upsell For WooCommerce” and hit on Search Plugins. Once you find ‘One-Click Upsell For WooCommerce’ by WP Swings you can view the details about it such as the point release, rating, and description. One can install it, simply by clicking “Install Now”.

#### Manual Installation

Manual installation of the plugin is another option to install the plugin in the seller’s WordPress environment.

The manual installation method involves downloading our One-Click Upsell For WooCommerce Extension and uploading it to the web server via their favorite FTP application. The steps for manual installation are as follows:

1) Upload the One-Click Upsell For WooCommerce folder to the /WP-content/plugins/ directory.

2) Activate the plugin through the ‘Plugins’ menu in WordPress.

## FAQ

### What is a funnel builder?

A funnel builder is a powerful tool used to create and manage sales funnels for businesses. A sales funnel is the process a customer follows, from first discovering a product to making a purchase. With a sales funnel builder, you can easily design and automate each step of this journey, starting from the funnel page, where potential customers first learn about your product, to the checkout page, where they complete the purchase.

### How to build a funnel for free?

To build a funnel for free using the WP Swings One Click Upsell Funnel for WooCommerce plugin, follow these steps:

1. Install the Free Plugin: Download and install the One Click Upsell Funnel plugin from the WordPress repository.
2. Create a New Funnel: Navigate to the Upsell Funnels option in your WooCommerce dashboard. Click on “Add New Funnel” to start creating a new funnel.
3. Set Up Funnel Details: Enter the funnel name, choose the target products or categories, and define the offer triggers that will activate the upsell funnel.
4. Customize the Offer Pages: You can customize the upsell or downsell offer pages, adjusting content, design, and pricing to match your brand’s needs.
5. Activate and Test: Once your funnel is ready, activate it and test the entire customer journey to ensure everything works as expected.

This allows you to create a sales funnel for free using the plugin’s basic features, driving conversions and boosting sales without any cost involved.

For more details, you can check the full guide [**here**](https://docs.wpswings.com/one-click-upsell-funnel-for-woocommerce/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-doc)

### How many sales funnels can I create with One Click Upsell?

With the free version of the One Click Upsell Funnel for WooCommerce, you can create unlimited sales funnels. This allows you to set up multiple upsell and downsell offers for different products or categories, giving you flexibility in your sales strategies.

For more detailed information, you can check the official guide [**here**](https://docs.wpswings.com/one-click-upsell-funnel-for-woocommerce/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-doc)

### What is a Page Builder and Funnel Builder?

A Page Builder is a tool used to design and customize web pages without needing to code. It allows users to drag and drop elements like text, images, and buttons to create attractive, functional websites easily.

A Funnel Builder, on the other hand, is designed to create and manage sales funnels. It helps guide potential customers from discovering a product to making a purchase by organizing steps like landing pages, checkout pages, and upsell offers. This tool focuses on boosting conversions and sales.

### How to create a Funnel builder checkout page template ?

To create a checkout page template using the One Click Upsell Funnel for WooCommerce plugin by WP Swings, follow these steps:

1. **Install and Activate:** Install and activate the plugin on your WooCommerce store.
2. **Access Funnels:** Go to the WordPress dashboard, click on the “One Click Upsell Funnels” tab to access the funnel management page.
3. **Create Funnel:** Click “Add New Funnel,” name your funnel, and select the triggering products.
4. **Customize Checkout Page:** Design your checkout page using available templates or from scratch, adding product details, pricing, and a call-to-action.
5. **Add Upsell Offers:** Include upsell offers to present additional products after purchase.
6. **Configure Settings:** Set conditions for upsell offers and define the checkout flow behavior.
7. **Test and Publish:** Test your funnel, then publish and monitor its performance.

These steps will help you create an effective checkout page template to boost sales and order value

### I installed an upsell plugin, created funnels, and added the offers too but still, it does not show up on purchasing the funnel targets.

If the upsell offers are not showing, make sure the:

1) You’ve enabled the One-Click Upsell funnel plugin. Navigate to Global Settings and enable the plugin if it is disabled.

2) Your funnel is not in Sandbox Mode. If it is, edit the funnel and make it Live, and Save Changes.

3) You are testing for the correct target product or category you’ve set in the funnel builder.

4) The offer page is published.

5) You’re making the payment through one of our supported payment gateways. The offer will not be displayed if you make payments through a payment gateway not supported by our plugin.

6) Make sure you have selected any one of the following sales funnel templates or made your own custom template and inserted a page link.

### What types of Products does the upsell plugin support?

Customers can buy one-click WooCommerce products of the following types:

**Free Version**: Only Simple Products.

**Premium version**: Simple, Variable, Bundled, and Subscription products.

### What are the payment methods that the upsell plugin supports?

**Free Version**: Supports only Cash on Delivery.

**Premium version**: Supports Stripe, Paypal Payments, Authorize.net, Braintree, Square, Paystack, Vipps, Cardcom, and core payment options such as Cash On Delivery, Direct Bank Transfer, and Cheque Payments.

### What are the payment methods that the WordPress upsell plugin supports?

**Free Version**: Supports only Cash on Delivery.

**Premium Version**: Supports Stripe, Paypal Payments, Authorize.net, Braintree, Square, Paystack, Vipps, Cardcom, Mollie, and core payment options such as Cash On Delivery, Direct Bank Transfer, and Cheque Payments.

### Is my Payment Gateway compatible with the upsell plugin?

You can see the list of supported payment gateways on our [product page](https://wpswings.com/product/one-click-upsell-funnel-for-woocommerce-pro/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-pro). But if your required gateway is not there, You can contact our [support](https://wpswings.com/submit-query/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=query) team for this.

We will check the possibilities and make your gateway compatible with our plugin on your request. There is always a way for everyone.

### How to make a custom offer page for an upsell of my own?

If you want to make a custom offer page for upsell of your own without our pre-defined templates you can do it with the link we have given in the **‘Offer Template’** section. Click on **‘ Click here to Create Custom Sales Funnel Template’** and make a new offer as per your website needs. After making that page insert a link in the below box and save.

**Note:** Make sure you are using page builders which are supported by the WordPress upsell plugin.

### How can I use Custom Page Shortcodes for BUY NOW and NO THANKS?

For the **“Buy Now”** shortcode: You need to copy this **Buy Now → [wps\_upsell\_yes]** and place it at a suitable place on your page.

**Description:** This shortcode only returns the link so it has to be used in the link section. In HTML use it as href=”[wps\_upsell\_yes]” of an anchor tag.

For the **“No thanks”** shortcode: You need to copy this **No Thanks → [wps\_upsell\_no]** and place it at a suitable place on your page.

**Description:** This shortcode only returns the link so it has to be used in the link section. In HTML use it as href=”[wps\_upsell\_no]” of an anchor tag.

### Can I design an upsell offer page if I don’t have a designer?

Yes, you can. WordPress upsell plugin is compatible with some page builders and we have also provided shortcodes for designing your Offer page. You can design yourself and don’t need any designer for that. Simply drag and drop and your page is ready.

### Can I show an upsell offer as per the buyer’s behavior?

Yes. Depending on what kind of product a customer has purchased, you can offer them relevant WooCommerce upsell products.

### Can I offer an upgrade to my customers after checkout?

Yes. Just set the Target and Offer Product and Enable Smart Offer Upgrade Feature in Funnel builder settings. As soon as the customer accepts the offer, the target product will be replaced by the offer product.

### What is the difference between Exclusive Offer and Smart Skip If Already Purchased?

Exclusive Offer is a Funnel Feature, this feature makes the funnel offer to be shown to the customers only once, whether they accept or reject it.

Smart Skip If Already Purchased is a Global Feature. With this feature, the Offer will be shown to the customers only if they haven’t purchased the offer product already either normally or via upsell.

### I want my Upsell Offer to always trigger no matter what target product people choose.

Yes, our upsell WooCommerce plugin has a feature to do this. You just need to enable the Global Funnel feature and the Funnel Offers will be triggered always.

### Can I track the performance of my Upsell Funnels?

Yes, we have Upsell Sales by Funnel Stats that show Individual Funnel Performance metrics such as Trigger Count, Success Count, Offers Viewed, Offers Accepted, Offers Rejected, Offers Pending, Conversion Rate, and Total Sales. With the help of these metrics, you can easily figure out how your Upsell funnels are performing and make changes accordingly.

### Can I show multiple upsell offers in a single funnel?

Yes. The WordPress Sales Funnel plugin lets you add multiple upsell products in a single funnel builder. So, you can offer more than one product after checkout by adding new offers to the funnel. Or you can use a feature named Additional Offers in the pro version.

### What page builders does this plugin support?

Most of the major WordPress page builders like Elementor, WPBakery, Divibuilders, Thrive Architect, and other WordPress page builders are supported for creating attractive upsell offers.

### My Question is Not Listed.

Please visit [**WooCommerce Upsell Knowledge Base**](https://support.wpswings.com/wordpress-plugins-knowledge-base/category/one-click-upsell-funnel-for-woocommerce/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=upsell-kb)

## Reviews

![](https://secure.gravatar.com/avatar/26d9c0bdc1ef64d8bc4394cc778a60aa95ccfc1eff713da87d3877a5871ab805?s=60&d=retro&r=g)
### [Excellent Support](https://wordpress.org/support/topic/excellent-support-2388/)

[cipher87](https://profiles.wordpress.org/cipher87/ "Posts by cipher87")
December 12, 2024
1 reply

Excellent Customer Support! Quick response from support and incredibly helpful!

![](https://secure.gravatar.com/avatar/8f9dd98d625ee59f45b7db65e3263cc66b019bbeb61d1055810513fed19cbd55?s=60&d=retro&r=g)
### [This Funnel Builder – One Click Upsell Funnel plugin is brilliant](https://wordpress.org/support/topic/this-funnel-builder-one-click-upsell-funnel-plugin-is-brilliant/)

[Alex](https://profiles.wordpress.org/alexanderson2233/ "Posts by Alex")
October 14, 2024
1 reply

This Funnel Builder – One Click Upsell Funnel plugin is a brilliant addition to my store’s toolkit. Increase my stores revenue without complicated marketing strategies, this plugin does the trick with ease. The upsell feature works seamlessly after the checkout, offering customers more additional and frequently bought products with just one click – no need for them to re-enter payment details. Integration with Elementor and Divi makes it easy to design visually stunning upsell template pages that can be edited with page builders and that actually convert.

![](https://secure.gravatar.com/avatar/4f0c47a275bab0b246d438b9fbbd57a7e84345e8aff0ee5e7fdfef972865b7cc?s=60&d=retro&r=g)
### [Ignored Refund Request](https://wordpress.org/support/topic/ignored-refund-request/)

[Rosso Digital](https://profiles.wordpress.org/roberthemsing/ "Posts by Rosso Digital")
September 20, 2024
1 reply

Paid for the pro version and it doesn’t work with subscriptions (removes subscription coupons and weirdly changes variation/price…) and clashes with Memcached as well (after one order the upsell doesn’t work anymore). We’ve been liaising with their support for over a year. We paid for the plugin for a year and couldn’t use it because it didn’t work. We didn’t ask for a refund at the time because we didn’t expect that in over a year they wouldn’t be able to fix the issues. We followed up a dozen times and were always told the team is still looking into it. When the subscription renewed we immediately asked for a refund as we hadn’t been able to use the plugin. We didn’t cancel prior as we were hopeful their team would finally be able to fix the issues. Our chat message to their support went unanswered so we followed up via email. Three times. The emails were completely ignored so we took this up with our credit card provider to dispute the charge. Suddenly the team was able to respond to the credit card provider (not to us) to say that they responded to us and we ignored them which is the opposite of what happened.
I’m sure the plugin works for some, and the developers seem somewhat interested in helping though they weren’t able to fix any of our issues. We have probably exchanged close to 100 WhatsApp messages and emails with them and have created various staging sites. I’m shocked, however, that they blatantly lied about getting back to us about the refund request and are refusing to even consider a refund when we paid for two years and the plugin hasn’t worked for a day.

![](https://secure.gravatar.com/avatar/f7ea25d8fc601b72736a0d91a216fc43e444c4ef6821adc7b3dc6d6e22ba1273?s=60&d=retro&r=g)
### [Great Plugin!](https://wordpress.org/support/topic/great-plugin-39210/)

[kstojchev125](https://profiles.wordpress.org/kstojchev125/ "Posts by kstojchev125")
July 15, 2024
1 reply

The One Click Upsell Funnel for WooCommerce plugin has been a game-changer for our online store! Implementing post-purchase upsell and cross-sell offers has never been easier, and the results have been phenomenal. Our sales and profits have significantly increased since we started using this plugin. The setup is straightforward, and the support team is incredibly responsive and helpful. Highly recommend this plugin to anyone looking to boost their WooCommerce store’s performance and revenue. Worth every penny!

![](https://secure.gravatar.com/avatar/ce160c163e00f977560bc843e66ed00d9259b1cdc1156f854a0434ba65b85548?s=60&d=retro&r=g)
### [Plugin Stopped Working Costing Us Thousands of Dollars](https://wordpress.org/support/topic/plugin-stopped-working-costing-us-thousands-of-dollars/)

[primalmarketing](https://profiles.wordpress.org/primalmarketing/ "Posts by primalmarketing")
May 1, 2024
3 replies

We purchased the paid version of this plugin. Randomly a week ago it stopped working. We noticed sales dropping and checked the plugin. Even though it is two months before our license needed to be renewed it prompted us to enter a license code. When we entered the code it said that the license was already in use on our site. This is the same site that it was asking us to enter the code on. Support reset our license but the damage has already been done.

![](https://secure.gravatar.com/avatar/5082027e849da554747ebd602817ec12d229dab1afc5c580eb2904a5d1341738?s=60&d=retro&r=g)
### [Best ever! Excellent job!](https://wordpress.org/support/topic/best-ever-excellent-job/)

[stickitsibiu](https://profiles.wordpress.org/stickitsibiu/ "Posts by stickitsibiu")
April 29, 2024
1 reply

Excellent job! The quality of the work provided is outstanding, and the support offered is truly exceptional. We wholeheartedly recommend it to others who may be seeking similar services or products. Our experience with this has been nothing short of excellent, and we believe others will benefit greatly from it as well. From the high standards of workmanship to the prompt and effective support, every aspect has exceeded our expectations. Therefore, we confidently endorse it for anyone in need of reliable and top-notch service.

[Read all 97 reviews](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/reviews/)
## Contributors & Developers

“One Click Upsell Funnel for WooCommerce – Funnel Builder for WordPress, Create WooCommerce Upsell, Post-Purchase Upsell & Cross Sell Offers that Boost Sales & Increase Profits with Sales Funnel Builder” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/6cb964660fbf89aafd80816991c605c4c8786709a1d3e24418f24a012ccf994b?s=32&d=mm&r=g) [WP Swings](https://profiles.wordpress.org/wpswings/)

“One Click Upsell Funnel for WooCommerce – Funnel Builder for WordPress, Create WooCommerce Upsell, Post-Purchase Upsell & Cross Sell Offers that Boost Sales & Increase Profits with Sales Funnel Builder” has been translated into 26 locales. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/woo-one-click-upsell-funnel/contributors) for their contributions.

[Translate “One Click Upsell Funnel for WooCommerce – Funnel Builder for WordPress, Create WooCommerce Upsell, Post-Purchase Upsell & Cross Sell Offers that Boost Sales & Increase Profits with Sales Funnel Builder” into your language.](https://translate.wordpress.org/projects/wp-plugins/woo-one-click-upsell-funnel)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/woo-one-click-upsell-funnel/), check out the [SVN repository](https://plugins.svn.wordpress.org/woo-one-click-upsell-funnel/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/woo-one-click-upsell-funnel/) by [RSS](https://plugins.trac.wordpress.org/log/woo-one-click-upsell-funnel/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 3.4.10 – Released on 20 Dec 2024

* New: Compatible with latest WP ( 6.7.1 ) & WC ( 9.5.1 )
* Fix : Fix Security issues

#### 3.4.9 – Released on 29 Oct 2024

* New : Compatible with latest WP ( 6.6.2 ) & WC ( 9.3.3 )
* Fix : Minor bug fixes

#### 3.4.8 – Released on 04 Oct 2024

* New: Compatible with latest WP ( 6.6.2 ) & WC ( 9.3.3 )
* Fix: Minor Issues

#### 3.4.7 – Released on 16 Aug 2024

* New: Latest WP (6.6.1) and WC (9.1.4)
* Fixes: Bug fixed for Upsell Templates

#### 3.4.6 – Released on 29 July 2024

* New: Latest WP (6.6.1) and WC (9.1.4)
* Fixes: Issue with shortcode redirection.

#### 3.4.5 – Released on 15 May 2024

* New: Latest WP (6.5.3) and WC (8.9.0)

#### 3.4.4 – Released on 21 March 2024

* New: Latest WP (6.4.3) and WC (8.7.0)
* New: Order bump option added in Org plugin

#### 3.4.3 – Released on 29 January 2024

* New: Latest WP(6.4.2) and WC(8.5.2)
* Fix: Stock update issue fixed

#### 3.4.2 – Released on 21 December 2023

* New: Banner section added in org
* New: Compatibility with WP(6.4.2) and WC(8.4.0)

#### 3.4.1 – Released on 29 November 2023

* New: Cart and Checkout Block compatibility
* New: Compatibility with WP(6.4.1) and WC(8.3.1)

#### 3.4.0 – Released on 31 October 2023

* New: HPOS compatibility
* New: Latest WP [6.3.2] and WC [8.2.1] update

#### 3.3.1 – Released on 13 October 2023

* New: Exit Intent Popup
* New: Latest WP [6.3.2] and WC [8.2.0] update

#### 3.3.0 – Released on 25 August 2023

* New: Compatibility with Divi Theme
* New: Added three templates for Divi Theme
* New: Compatibility with WP[6.3.0] and WC[8.0.2]
* Fix: Issue fix in case of variation upsell product

#### 3.2.9 – Released on 8 August 2023

* New: Compatible with WP(6.3) and WC(8.0.0)

#### 3.2.8 – Released on 8 June 2023

* New: Compatibility with Currency Switcher
* New: Compatible with the latest WP(6.2.2) and WC(7.7.2)

#### 3.2.7 – Released on 28 April 2023

* New: Compatible with the latest WP(6.2) and WC(7.6.1)

#### 3.2.6 – Released on 16 March 2023

* New: Compatible with the latest WP(6.1.1) and WC(7.5.0)

#### 3.2.5 – Released on 02 February 2023

* Feature: Add the shipping price on COD
* New: Compatible with the latest WP and WC

#### 3.2.4 – Released on 20 December 2022

* Enhancement: Show pro features in the free version with an upgraded label [Appearance section].
* New: Compatible with the latest WP and WC

#### 3.2.3 – Released on 10 November 2022

* New: Compatible with the latest WP and WC

#### 3.2.2 – Released on 23 August 2022

* New: Minor bug fixes
* New: Compatible with the latest WP and WC

#### 3.2.1 – Released on 30 May 2022

* New: Minor bug fixes

#### 3.2.0 – Released on 31 March 2022

* New: Some substantial changes across different areas of the plugin.
* New: Minor Bug Fixes
* New: Inbuilt Migrator for existing users to import all plugin data at once.
* New: Compatible with the latest WP and WC

#### 3.1.3 – Released on 03 Feb 2022

* New: Change author from MakeWebBetter to WP Swings
* New: Notice display of current version for [**WP Swings**](https://wpswings.com/?utm_source=upsell-org-page&utm_medium=referral&utm_campaign=wpswings-official-page)
* New: Minor Bug fixes
* New: Compatible with the latest WP and WC

#### 3.1.2 – Released on 16 Dec 2021

* Bug Fixes
* New: Elementor Widgets with shortcodes
* Compatibility with WooCommerce (6.0.0)

#### 3.1.1 – Released on 22 Nov 2021

* Bug Fixes
* Compatibility with MWB Currency switcher.
* Compatibility with MWB Currency Switcher Pro.
* Compatibility with Invoice System for WooCommerce.

#### 3.1.0 – Released on 2 Nov 2021

* Dependency with Free Plugin
* Bug fixes
* Guest Nonce Error Fix
* Compatibility with New PayPal payments
* WooCommerce One Click Upsell Funnel Pro Compatible with WooCommerce Subscriptions Free/Pro

#### 3.0.4 -Released on 31 Aug 2021

* Improved: Compatibility with the latest WP(5.8) and WC(5.6.0)
* Other: Issues and Bugs Fixed.

#### 3.0.3 – Released on 6 April 2021

* Improved: Compatibility with the latest WP(5.7) and WC(5.1.0)
* Other: Issues and Bugs Fixed.

#### 3.0.2 – Released on 19 December 2020

* Improved: Compatibility with the latest WP(5.6) and WC(4.8.0)

#### 3.0.1

* Improved: Better Security.
* Other: Issues and Bugs Fixed.

#### 3.0.0

* New: Funnel features – Global Funnel, Exclusive Offer, and Smart Offer Upgrade.
* New: Global feature – Smart Skip If Already Purchased.
* New: Offer feature – Offer Image.
* New: Shortcodes – Offer Quantity and Urgency Timer.
* New: Upsell Sales – Reports and Upsell Sales by Funnel – Stats.
* New: Google Analytics and Facebook Pixel compatibility.
* Improved: Alert Messages and Upsell Action Buttons Loader.
* Other: Issues and Bugs Fixed.

#### 2.0.3

* Fix: Upsell Action Links Issue with Elementor fixed.
* Fix: Changed Text Domain according to WordPress standards.

#### 2.0.2

* Improved: Better Security and Performance
* Other: Issues and Bugs Fixed.

#### 2.0.1

* Improved: Better Security and Performance
* Improved: Better Funnels listing page
* Other: Issues and Bugs Fixed.

#### 2.0.0

* New: Default Offer with WordPress new Live editor ( Please reactivate plugin once )
* New: Built-in Offer templates
* New: View and Customize offer pages in Sandbox mode
* Improved: Better and more dynamic Shortcodes
* Improved: Better and smooth Admin UI
* Other: Issues and Bugs Fixed.

#### 1.0.2

* bug fix

#### 1.0.1

* Bug fix

#### 1.0.1

* Added support for WooCommerce standard product page for funnel offers and a few new options in settings.

#### 1.0.0

* First version

## Commercial plugin

This plugin is free but offers additional paid commercial upgrades or support. [View support](https://wpswings.com/product/one-click-upsell-funnel-for-woocommerce-pro/?utm_source=one-click-org-page&utm_medium=referral&utm_campaign=free-to-premium)

## Meta

* Version **3.4.10**
* Last updated **3 weeks ago**
* Active installations **600+**
* WordPress version **5.5.0 or higher**
* Tested up to **6.7.1**
* PHP version **7.0.0 or higher**
* Languages
  See all 27

  Close

  [Arabic](https://ar.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Chinese (China)](https://cn.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Czech](https://cs.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Danish](https://da.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Dutch](https://nl.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Dutch (Belgium)](https://nl-be.wordpress.org/plugins/woo-one-click-upsell-funnel/), [English (Australia)](https://en-au.wordpress.org/plugins/woo-one-click-upsell-funnel/), [English (UK)](https://en-gb.wordpress.org/plugins/woo-one-click-upsell-funnel/), [English (US)](https://wordpress.org/plugins/woo-one-click-upsell-funnel/), [German](https://de.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Hindi](https://hi.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Indonesian](https://id.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Italian](https://it.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Japanese](https://ja.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Korean](https://ko.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Portuguese (Brazil)](https://br.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Russian](https://ru.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Spanish (Colombia)](https://es-co.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Spanish (Ecuador)](https://es-ec.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Spanish (Mexico)](https://es-mx.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Spanish (Spain)](https://es.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Spanish (Venezuela)](https://ve.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Swedish](https://sv.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Turkish](https://tr.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Ukrainian](https://uk.wordpress.org/plugins/woo-one-click-upsell-funnel/), [Urdu](https://ur.wordpress.org/plugins/woo-one-click-upsell-funnel/), and [Vietnamese](https://vi.wordpress.org/plugins/woo-one-click-upsell-funnel/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/woo-one-click-upsell-funnel)
* Tags [cross-sell](https://wordpress.org/plugins/tags/cross-sell/)[Funnel Builder](https://wordpress.org/plugins/tags/funnel-builder/)[sales funnel](https://wordpress.org/plugins/tags/sales-funnel/)[upsell](https://wordpress.org/plugins/tags/upsell/)[WooCommerce checkout](https://wordpress.org/plugins/tags/woocommerce-checkout/)
* [Advanced View](https://wordpress.org/plugins/woo-one-click-upsell-funnel/advanced/)

## Ratings

4.5 out of 5 stars.

* [82 5-star reviews
  5 stars

  82](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/reviews/?filter=5)
* [4 4-star reviews
  4 stars

  4](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/reviews/?filter=4)
* [0 3-star reviews
  3 stars

  0](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/reviews/?filter=3)
* [3 2-star reviews
  2 stars

  3](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/reviews/?filter=2)
* [8 1-star reviews
  1 star

  8](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/6cb964660fbf89aafd80816991c605c4c8786709a1d3e24418f24a012ccf994b?s=32&d=mm&r=g) [WP Swings](https://profiles.wordpress.org/wpswings/)
## Support

Issues resolved in last two months:

1 out of 1

[View support forum](https://wordpress.org/support/plugin/woo-one-click-upsell-funnel/)

## Donate

Would you like to support the advancement of this plugin?

[Donate to this plugin](https://wpswings.com/)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


