=== Content from plugins.trac.wordpress.org_9543dafa_20250114_213719.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Flogin-with-vipps%2Ftags%2F1.3.3%2FVippsLogin.class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/login-with-vipps/tags/1.3.3/VippsLogin.class.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/login-with-vipps/tags/1.3.3/VippsLogin.class.php)

---

# [source:](/browser?order=name "Go to repository root") [login-with-vipps](/browser/login-with-vipps?order=name "View login-with-vipps")/[tags](/browser/login-with-vipps/tags?order=name "View tags")/[1.3.3](/browser/login-with-vipps/tags/1.3.3?order=name "View 1.3.3")/[VippsLogin.class.php](/browser/login-with-vipps/tags/1.3.3/VippsLogin.class.php?order=name "View VippsLogin.class.php")

View diff against:

View revision:

| [Last change](/changeset/3186435/login-with-vipps/tags/1.3.3/VippsLogin.class.php "View differences") on this file was [3186435](/changeset/3186435/ "View changeset 3186435"), checked in by wphostingdev, [2 months ago](/timeline?from=2024-11-12T11%3A06%3A38Z&precision=second "See timeline at 11/12/2024 11:06:38 AM") |
| --- |
| v1.3.3 |
| **File size:** 78.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | VippsLogin |
| [4](#L4) | This class uses the ContinueWithVipps class to implement \*logins\* and \*confirmations\* of user accounts so that a user can link their Vipps and Wordpress accounts and log in using just the app. |
| [5](#L5) | It is written extensible, so that further 'applications' - like WooCommerce - can use this class to implement specific login rules (for errorhandling, user modification, and end-user pages / profiles). |
| [6](#L6) |  |
| [7](#L7) | It implements the login actions using Ajax for simplicity, and stores in the session a cookie value stored also in the browser. Any session that does not have the corresponding browser cookie is invalid. |
| [8](#L8) |  |
| [9](#L9) | Previously, Vipps email-addresses weren't verified, so we required that a user wanting to use Vipps should confirm their email address and the connection. This is now optional,  and is done using the standard Wordpress 'user request' API if the user hasn't logged in yet.  If they are, they can connect directly from their profile page with another 'action' using ContinueWithVipps. |
| [10](#L10) |  |
| [11](#L11) | Furthermore, and really mostly a Woo application, there is an 'synch' action that lets an existing, connected user syncrhronize their user data with Vipps if it has become separate. If this is done, |
| [12](#L12) | the address will be synchronized at each login until the user changes the address specifically in the Worpdress instance. |
| [13](#L13) |  |
| [14](#L14) |  |
| [15](#L15) | This file is part of the plugin Login with Vipps |
| [16](#L16) | Copyright (c) 2019 WP-Hosting AS |
| [17](#L17) |  |
| [18](#L18) | MIT License |
| [19](#L19) |  |
| [20](#L20) | Copyright (c) 2019 WP-Hosting AS |
| [21](#L21) |  |
| [22](#L22) | Permission is hereby granted, free of charge, to any person obtaining a copy |
| [23](#L23) | of this software and associated documentation files (the "Software"), to deal |
| [24](#L24) | in the Software without restriction, including without limitation the rights |
| [25](#L25) | to use, copy, modify, merge, publish, distribute, sublicense, and/or sell |
| [26](#L26) | copies of the Software, and to permit persons to whom the Software is |
| [27](#L27) | furnished to do so, subject to the following conditions: |
| [28](#L28) |  |
| [29](#L29) | The above copyright notice and this permission notice shall be included in all |
| [30](#L30) | copies or substantial portions of the Software. |
| [31](#L31) |  |
| [32](#L32) | THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR |
| [33](#L33) | IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, |
| [34](#L34) | FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE |
| [35](#L35) | AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER |
| [36](#L36) | LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, |
| [37](#L37) | OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE |
| [38](#L38) | SOFTWARE. |
| [39](#L39) |  |
| [40](#L40) | \*/ |
| [41](#L41) | class VippsLogin { |
| [42](#L42) | protected static $instance = null; |
| [43](#L43) | protected static $isactive = null; |
| [44](#L44) |  |
| [45](#L45) |  |
| [46](#L46) | public static function CompanyName() { |
| [47](#L47) | return \_\_("Vipps MobilePay", 'login-with-vipps'); |
| [48](#L48) | } |
| [49](#L49) |  |
| [50](#L50) | function \_\_construct() { |
| [51](#L51) | } |
| [52](#L52) | // This is a singleton class; access the single instance with this method. IOK 2019-10-14 |
| [53](#L53) | public static function instance()  { |
| [54](#L54) | if (!static::$instance) static::$instance = new VippsLogin(); |
| [55](#L55) | return static::$instance; |
| [56](#L56) | } |
| [57](#L57) |  |
| [58](#L58) | // We use this to annotate the users' login session with a a current Vipps session. Not in use now, but can be used to require Vipps logins for instance. IOK 2019-10-14 |
| [59](#L59) | protected $currentSid = null; |
| [60](#L60) |  |
| [61](#L61) | static public function is\_active() { |
| [62](#L62) | if (static::$isactive !== null) return static::$isactive; |
| [63](#L63) | $settings  = ContinueWithVipps::instance()->settings; |
| [64](#L64) | if (!$settings || empty($settings['clientid']) || empty($settings['clientsecret'])) { |
| [65](#L65) | static::$isactive = 0; |
| [66](#L66) | return 0; |
| [67](#L67) | } |
| [68](#L68) | $options = get\_option('vipps\_login\_settings'); |
| [69](#L69) | $usevipps = @$options['use\_vipps\_login']; |
| [70](#L70) | static::$isactive   = $usevipps; |
| [71](#L71) | return $usevipps; |
| [72](#L72) | } |
| [73](#L73) |  |
| [74](#L74) | public function log ($what,$type='info') { |
| [75](#L75) | ContinueWithVipps::instance()->log($what,$type); |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | // The main init hook. We are going to hook into authentication, logout, error handling, the hooks defined by ContinueWithVipps and to the UserRequest handlers |
| [79](#L79) | // for connecting accounts. IOK 2019-10-14 |
| [80](#L80) | public function init () { |
| [81](#L81) |  |
| [82](#L82) |  |
| [83](#L83) | if (!static::is\_active()) return; |
| [84](#L84) | // Hook into standard auth and logout, but do so after the secure signon bits and so forth. |
| [85](#L85) | add\_filter('authenticate', array($this,'authenticate'),50,3); |
| [86](#L86) | // Can be used to manage sessions later it is hoped. |
| [87](#L87) | add\_action('wp\_logout', array($this,'wp\_logout'),10,3); |
| [88](#L88) | // Any errors from 'continue\_with\_vipps\_error\_login' will be handled here on the wp-login.php screen. IOK 2019-10-14 |
| [89](#L89) | add\_filter('wp\_login\_errors', array($this, 'wp\_login\_errors'), 10, 2); |
| [90](#L90) |  |
| [91](#L91) | // Profile updates for customers. 2019-10-14. Used to connect/disconnect from Vipps. IOK 2019-10-14 |
| [92](#L92) | // disconnect now handled separately, this handles other settings like if App usage is required for the user. IOK 2024-08-27 |
| [93](#L93) | add\_action('personal\_options\_update',array($this,'profile\_update')); |
| [94](#L94) | add\_action('edit\_user\_profile\_update',array($this,'profile\_update')); |
| [95](#L95) | add\_action('user\_profile\_update\_errors', array($this,'user\_profile\_update\_errors'), 10,3); |
| [96](#L96) | add\_action('admin\_post\_profile\_disconnect\_vipps', array($this,'disconnect\_vipps\_post\_handler')); |
| [97](#L97) |  |
| [98](#L98) | // Action that handles the 'waiting' page - originally, this was the page that will be shown to the user while they confirm their email account. |
| [99](#L99) | // It can however be used for other actions to be done before actually logging a user in, so the filters are kept. |
| [100](#L100) | // On confirmation and reload, the user will be logged in .  This also integrates with 'template\_redirect' because of this. IOK 2019-10-14 |
| [101](#L101) | add\_action('continue\_with\_vipps\_page\_login', array($this, 'continue\_with\_vipps\_page\_login'), 10, 1); |
| [102](#L102) | add\_action('continue\_with\_vipps\_before\_page\_login', array($this, 'continue\_with\_vipps\_before\_page\_login') , 10, 1); |
| [103](#L103) |  |
| [104](#L104) | // Ajax code loaded here. IOK 2019-10-14 |
| [105](#L105) | add\_action('wp\_enqueue\_scripts', array($this, 'wp\_enqueue\_scripts')); |
| [106](#L106) |  |
| [107](#L107) | // Login form button on wp-login.php main screen. IOK 2019-10-14 |
| [108](#L108) | add\_action('login\_form', array($this, 'login\_form\_continue\_with\_vipps')); |
| [109](#L109) | add\_action('register\_form', array($this, 'register\_form\_continue\_with\_vipps')); |
| [110](#L110) | add\_action( 'login\_enqueue\_scripts', array($this,'login\_enqueue\_scripts' )); |
| [111](#L111) |  |
| [112](#L112) | // We provide 'login with vipps / continue with vipps' button shortcodes'. IOK 2019-10-14 |
| [113](#L113) | $this->add\_shortcodes(); |
| [114](#L114) |  |
| [115](#L115) | // Ajax code to get the redirect url to start the login/confirmation process. IOK 2019-10-14 |
| [116](#L116) | add\_action('wp\_ajax\_vipps\_login\_get\_link', array($this,'ajax\_vipps\_login\_get\_link')); |
| [117](#L117) | add\_action('wp\_ajax\_nopriv\_vipps\_login\_get\_link', array($this,'ajax\_vipps\_login\_get\_link')); |
| [118](#L118) | add\_action('wp\_ajax\_vipps\_confirm\_get\_link', array($this,'ajax\_vipps\_confirm\_get\_link')); |
| [119](#L119) | add\_action('wp\_ajax\_vipps\_synch\_get\_link', array($this,'ajax\_vipps\_synch\_get\_link')); |
| [120](#L120) |  |
| [121](#L121) | // Main return handler. This will do all the work neccessary to login a user, register a user, ask for confirmation etc before redirecting to |
| [122](#L122) | // either the users' profile page or to the waiting page for confirmations. IOK 2019-10-14 |
| [123](#L123) | add\_action('continue\_with\_vipps\_login', array($this, 'continue\_with\_vipps\_login'), 10, 2); |
| [124](#L124) | add\_action('continue\_with\_vipps\_error\_login', array($this, 'continue\_with\_vipps\_error\_login'), 10, 4); |
| [125](#L125) |  |
| [126](#L126) | // Main return handler for 'confirm your account'. Same as the above, except that for this the user is already logged in. |
| [127](#L127) | add\_action('continue\_with\_vipps\_confirm', array($this, 'continue\_with\_vipps\_confirm'), 10, 2); |
| [128](#L128) | add\_action('continue\_with\_vipps\_error\_confirm', array($this, 'continue\_with\_vipps\_error\_confirm'), 10, 4); |
| [129](#L129) | add\_action('continue\_with\_vipps\_error\_wordpress\_confirm', array($this, 'continue\_with\_vipps\_error\_wordpress\_confirm'), 10, 4); |
| [130](#L130) |  |
| [131](#L131) | // And for synching addresses. Again, the user would be logged in. |
| [132](#L132) | add\_action('continue\_with\_vipps\_synch', array($this, 'continue\_with\_vipps\_synch'), 10, 2); |
| [133](#L133) | add\_action('continue\_with\_vipps\_error\_synch', array($this, 'continue\_with\_vipps\_error\_synch'), 10, 4); |
| [134](#L134) | add\_action('continue\_with\_vipps\_error\_wordpress\_synch', array($this, 'continue\_with\_vipps\_error\_wordpress\_synch'), 10, 4); |
| [135](#L135) |  |
| [136](#L136) | // This is for confirming - with Vipps - an already existing user. |
| [137](#L137) | add\_action('continue\_with\_vipps\_confirm\_login', array($this, 'continue\_with\_vipps\_confirm\_login'), 10, 2); |
| [138](#L138) | add\_action('continue\_with\_vipps\_error\_confirm\_login', array($this, 'continue\_with\_vipps\_error\_confirm\_login'), 10, 4); |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | // Scripts used to make the 'login' button work; they use Ajax. IOK 2019-10-14 |
| [142](#L142) | public function wp\_enqueue\_scripts() { |
| [143](#L143) | if (!static::is\_active()) return; |
| [144](#L144) | wp\_enqueue\_script('login-with-vipps',plugins\_url('js/login-with-vipps.js',\_\_FILE\_\_),array('jquery'),filemtime(dirname(\_\_FILE\_\_) . "/js/login-with-vipps.js"), 'true'); |
| [145](#L145) |  |
| [146](#L146) | $loginconfig = array( 'ajax\_url' => admin\_url( 'admin-ajax.php' )); |
| [147](#L147) |  |
| [148](#L148) | $loginconfig['lang'] = $this->get\_customer\_language(); |
| [149](#L149) |  |
| [150](#L150) | wp\_localize\_script('login-with-vipps', 'vippsLoginConfig', $loginconfig); |
| [151](#L151) | wp\_enqueue\_style('login-with-vipps',plugins\_url('css/login-with-vipps.css',\_\_FILE\_\_),array(),filemtime(dirname(\_\_FILE\_\_) . "/css/login-with-vipps.css"), 'all'); |
| [152](#L152) | $logo = plugins\_url("img/vmp-logo.png", \_\_FILE\_\_); |
| [153](#L153) | wp\_add\_inline\_style('login-with-vipps', ".woocommerce-MyAccount-navigation ul li.woocommerce-MyAccount-navigation-link--vipps a::before { background-image: url('{$logo}'); }"); |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) |  |
| [157](#L157) | public function login\_enqueue\_scripts() { |
| [158](#L158) | if (!static::is\_active()) return; |
| [159](#L159) | $options = get\_option('vipps\_login\_settings'); |
| [160](#L160) | if (!$options['login\_page']) return; |
| [161](#L161) | wp\_enqueue\_script('jquery'); |
| [162](#L162) | wp\_enqueue\_script('login-with-vipps',plugins\_url('js/login-with-vipps.js',\_\_FILE\_\_),array('jquery'),filemtime(dirname(\_\_FILE\_\_) . "/js/login-with-vipps.js"), 'true'); |
| [163](#L163) | wp\_localize\_script('login-with-vipps', 'vippsLoginConfig', array( 'ajax\_url' => admin\_url( 'admin-ajax.php' ) ) ); |
| [164](#L164) | wp\_enqueue\_style('login-with-vipps',plugins\_url('css/login-with-vipps.css',\_\_FILE\_\_),array(),filemtime(dirname(\_\_FILE\_\_) . "/css/login-with-vipps.css"), 'all'); |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) |  |
| [168](#L168) | // This will return to the user an URL that when followed will start the login process. IOK 2019-10-14 |
| [169](#L169) | // Default application is 'wordpress', others would be wp-members,woocommerce, bbpress, your own. IOK 2019-10-14 |
| [170](#L170) | public function ajax\_vipps\_login\_get\_link () { |
| [171](#L171) | //NB We are not using a nonce here - the user has not yet logged in, and the page may be cached. To continue logging in, |
| [172](#L172) | // the users' browser must retrieve the url from this json value. IOK 2019-10-03 |
| [173](#L173) | $application = 'wordpress'; |
| [174](#L174) | if (isset($\_REQUEST['application'])) { |
| [175](#L175) | $application = sanitize\_title($\_REQUEST['application']); |
| [176](#L176) | } |
| [177](#L177) | // We need the 'originating page' even when we are doing a POST to ourselves, so use 'raw reverer'. This means that this |
| [178](#L178) | // must use 'safe redirect' as well. |
| [179](#L179) | $referer = wp\_get\_raw\_referer(); |
| [180](#L180) | $data = array('referer' => $referer); |
| [181](#L181) |  |
| [182](#L182) | // Allow applications to extend the values added to the session IOK 2021-11-09 |
| [183](#L183) | $data = apply\_filters('login\_with\_vipps\_login\_link\_data', $data, $application); |
| [184](#L184) |  |
| [185](#L185) | $url = $this->get\_vipps\_login\_link($application, $data); |
| [186](#L186) | wp\_send\_json(array('ok'=>1,'url'=>$url,'message'=>'ok')); |
| [187](#L187) | wp\_die(); |
| [188](#L188) | } |
| [189](#L189) |  |
| [190](#L190) | // This method will create the URL that when redirected to, will start the login process for the given application. It will |
| [191](#L191) | // also create a browser cookie (secure, no javascript access) and store this in the session for validation. IOK 2019-10-14 |
| [192](#L192) | public function get\_vipps\_login\_link($application='wordpress', $data=array()) { |
| [193](#L193) | // We are going to store a random cookie in the browser so we can verify that this |
| [194](#L194) | // calls' session belongs to a single browser. IOK 2019-10-09 |
| [195](#L195) | // Incidentally, this will invalidate any current session as well. |
| [196](#L196) | // Also, this \*must\* be called with POST to ensure you actually get the cookies, at least if you have |
| [197](#L197) | // caching proxies somewhere in your chain. |
| [198](#L198) | $cookie = $this->setBrowserCookie(); |
| [199](#L199) | $data['cookie'] = $cookie; |
| [200](#L200) | $data['application'] = $application; |
| [201](#L201) | $action = apply\_filters('login\_with\_vipps\_login\_action', 'login', $application, $data); |
| [202](#L202) | $url = ContinueWithVipps::getAuthRedirect($action ,$data); |
| [203](#L203) | return $url; |
| [204](#L204) | } |
| [205](#L205) |  |
| [206](#L206) | // This is like for login, except it is for confirming that user login should be connected to Vipps. User is logged in, so we |
| [207](#L207) | // are using a nonce here. IOK 2019-10-14 |
| [208](#L208) | public function ajax\_vipps\_confirm\_get\_link () { |
| [209](#L209) | check\_ajax\_referer('vippsconfirmnonce','vippsconfirmnonce',true); |
| [210](#L210) | $application = 'wordpress'; |
| [211](#L211) | if (isset($\_REQUEST['application'])) { |
| [212](#L212) | $application = sanitize\_title($\_REQUEST['application']); |
| [213](#L213) | } |
| [214](#L214) | $referer = wp\_get\_raw\_referer(); |
| [215](#L215) | $url = $this->get\_vipps\_confirm\_link($application, array('referer'=>$referer)); |
| [216](#L216) | wp\_send\_json(array('ok'=>1,'url'=>$url,'message'=>'ok')); |
| [217](#L217) | wp\_die(); |
| [218](#L218) | } |
| [219](#L219) | public function get\_vipps\_confirm\_link($application='wordpress', $sessiondata=array()) { |
| [220](#L220) | if (!is\_user\_logged\_in()) return; |
| [221](#L221) | $cookie = $this->setBrowserCookie(); |
| [222](#L222) | $sessiondata['cookie'] = $cookie; |
| [223](#L223) | $sessiondata['application'] = $application; |
| [224](#L224) | $sessiondata['userid'] = get\_current\_user\_id(); |
| [225](#L225) | $url = ContinueWithVipps::getAuthRedirect('confirm',$sessiondata); |
| [226](#L226) | return $url; |
| [227](#L227) | } |
| [228](#L228) |  |
| [229](#L229) | // And this is for synchronizing already connected accounts. Again, we use a nonce, it will only work for logged-in users. IOK 2019-10-14 |
| [230](#L230) | public function ajax\_vipps\_synch\_get\_link () { |
| [231](#L231) | check\_ajax\_referer('vippsconfirmnonce','vippsconfirmnonce',true); |
| [232](#L232) |  |
| [233](#L233) | $application = 'wordpress'; |
| [234](#L234) | if (isset($\_REQUEST['application'])) { |
| [235](#L235) | $application = sanitize\_title($\_REQUEST['application']); |
| [236](#L236) | } |
| [237](#L237) | $referer = wp\_get\_raw\_referer(); |
| [238](#L238) | $url = $this->get\_vipps\_synch\_link($application, array('referer'=>$referer)); |
| [239](#L239) | wp\_send\_json(array('ok'=>1,'url'=>$url,'message'=>'ok')); |
| [240](#L240) | wp\_die(); |
| [241](#L241) | } |
| [242](#L242) | //  And this for users that want to synch their address with Vipps |
| [243](#L243) | public function get\_vipps\_synch\_link($application='wordpress', $sessiondata=array()) { |
| [244](#L244) | if (!is\_user\_logged\_in()) return; |
| [245](#L245) | $cookie = $this->setBrowserCookie(); |
| [246](#L246) | $sessiondata['cookie'] = $cookie; |
| [247](#L247) | $sessiondata['application'] = $application; |
| [248](#L248) | $sessiondata['userid'] = get\_current\_user\_id(); |
| [249](#L249) | $url = ContinueWithVipps::getAuthRedirect('synch',$sessiondata); |
| [250](#L250) | return $url; |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | // We need to do this because on earlier versions of WordPress, COOKEPATH can be wrong for multisites. IOK 2021-12-17 |
| [254](#L254) | public function getCookiePath() { |
| [255](#L255) | $cookiepath = defined("COOKIEPATH") ? COOKIEPATH : ""; |
| [256](#L256) | if (!$cookiepath) { |
| [257](#L257) | $cookiepath = trailingslashit(parse\_url(get\_option( 'home' ), PHP\_URL\_PATH)); |
| [258](#L258) | } |
| [259](#L259) | return apply\_filters('login\_with\_vipps\_cookie\_path', $cookiepath); |
| [260](#L260) | } |
| [261](#L261) |  |
| [262](#L262) | // This ensures that a session is valid for the browser we are interacting with, using this cookie as a one-time password. 2019-10-14 |
| [263](#L263) | public function setBrowserCookie() { |
| [264](#L264) | $cookie = base64\_encode(hash('sha256',random\_bytes(256), true)); |
| [265](#L265) | $path = $this->getCookiePath(); |
| [266](#L266) | $\_COOKIE['wordpress\_vipps\_session\_key'] = $cookie; |
| [267](#L267) | setcookie('wordpress\_vipps\_session\_key', $cookie, time() + (2\*3600), $path, COOKIE\_DOMAIN,true,true); |
| [268](#L268) | return $cookie; |
| [269](#L269) | } |
| [270](#L270) | public function deleteBrowserCookie() { |
| [271](#L271) | unset($\_COOKIE['wordpress\_vipps\_session\_key']); |
| [272](#L272) | $path = $this->getCookiePath(); |
| [273](#L273) | setcookie('wordpress\_vipps\_session\_key', '', time() - (2\*3600), $path, COOKIE\_DOMAIN,true,true); |
| [274](#L274) | } |
| [275](#L275) | public function checkBrowserCookie($against) { |
| [276](#L276) | if (!isset($\_COOKIE['wordpress\_vipps\_session\_key'])) return false; |
| [277](#L277) | if (empty($against)) return false; |
| [278](#L278) | return ($\_COOKIE['wordpress\_vipps\_session\_key'] == $against); |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | public function admin\_init () { |
| [282](#L282) | // This is for creating a page for admins to manage user confirmations. It's not needed here, so this line is just information. IOK 2019-10-14 |
| [283](#L283) | // add\_management\_page( 'Show user confirmations', 'Show user confirmations!', 'install\_plugins', 'vipps\_connect\_login', array( $this, 'show\_confirmations' ), '' ); |
| [284](#L284) |  |
| [285](#L285) | add\_action('admin\_enqueue\_scripts', array($this,'admin\_enqueue\_scripts'), 10, 1); |
| [286](#L286) |  |
| [287](#L287) | // This adds fields indicating if the user is connected to Vipps or not, and allows connecting/disconnecting . IOK 2019-10-14 |
| [288](#L288) | if (current\_user\_can('manage\_options')) { |
| [289](#L289) | $uid = isset($\_REQUEST['user\_id']) ? intval($\_REQUEST['user\_id']) : 0; |
| [290](#L290) | if ($uid>0 && current\_user\_can('edit\_user', $uid)) { |
| [291](#L291) | add\_action( 'edit\_user\_profile\_update', array($this,'profile\_update')); |
| [292](#L292) | add\_action( 'edit\_user\_profile', array($this,'show\_extra\_profile\_fields')); |
| [293](#L293) | } |
| [294](#L294) | } |
| [295](#L295) | add\_action('show\_user\_profile', array($this,'show\_extra\_profile\_fields')); |
| [296](#L296) |  |
| [297](#L297) | // Error- and successhandling on the profile page: Add some feedback in standard WP idioms. IOK 2019-10-14 |
| [298](#L298) | global $pagenow; |
| [299](#L299) | if ($pagenow == 'profile.php') { |
| [300](#L300) | $userid = get\_current\_user\_id(); |
| [301](#L301) | $justconnected = get\_user\_meta($userid,'\_vipps\_just\_connected',true); |
| [302](#L302) | $justsynched = get\_user\_meta($userid,'\_vipps\_just\_synched',true); |
| [303](#L303) |  |
| [304](#L304) | list($vippsphone, $vippsid) = $this->get\_vipps\_account($userid); |
| [305](#L305) |  |
| [306](#L306) | if ($justconnected) { |
| [307](#L307) | delete\_user\_meta($userid, '\_vipps\_just\_connected'); |
| [308](#L308) | $notice = sprintf(\_\_('You are now connected to the %1$s profile <b>%2$s</b>.', 'login-with-vipps'), VippsLogin::CompanyName(), $vippsphone); |
| [309](#L309) | add\_action('admin\_notices', function() use ($notice) { echo "<div class='notice notice-success notice-vipps is-dismissible'><p>$notice</p></div>"; }); |
| [310](#L310) | } |
| [311](#L311) | if ($justsynched) { |
| [312](#L312) | delete\_user\_meta($userid, '\_vipps\_just\_synched'); |
| [313](#L313) | $notice = sprintf(\_\_('You are now synchronized with the %1$s profile <b>%2$s</b>.', 'login-with-vipps'), VippsLogin::CompanyName(), $vippsphone); |
| [314](#L314) | add\_action('admin\_notices', function() use ($notice) { echo "<div class='notice notice-success notice-vipps is-dismissible'><p>$notice</p></div>"; }); |
| [315](#L315) | } |
| [316](#L316) | } |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | // Ajax methods for connecting accounts externalized here. IOK 2019-10-14 |
| [320](#L320) | public function admin\_enqueue\_scripts ($suffix) { |
| [321](#L321) | if ($suffix == 'profile.php') { |
| [322](#L322) | wp\_enqueue\_script('vipps-login-profile',plugins\_url('js/vipps-profile.js',\_\_FILE\_\_),array('jquery'),filemtime(dirname(\_\_FILE\_\_) . "/js/vipps-profile.js"), 'true'); |
| [323](#L323) | wp\_localize\_script('vipps-login-profile', 'vippsLoginProfileConfig', array( 'ajax\_url' => admin\_url( 'admin-ajax.php' ), 'vippsconfirmnonce'=>wp\_create\_nonce('vippsconfirmnonce') ) ); |
| [324](#L324) | } |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | public function get\_login\_method() { |
| [328](#L328) | $settings = get\_option('vipps\_login\_settings', array()); |
| [329](#L329) | if(!isset($settings['login\_method'])) { |
| [330](#L330) | return $this->detect\_default\_login\_method(); |
| [331](#L331) | } |
| [332](#L332) | return $settings['login\_method']; |
| [333](#L333) | } |
| [334](#L334) |  |
| [335](#L335) | // Detect default payment method based on store location, user locale, currency NT 2023-11-30 |
| [336](#L336) | // Modified for Login IOK 2024-04-22 |
| [337](#L337) | public function detect\_default\_login\_method() { |
| [338](#L338) | // IOK 2023-12-01 use the main locale instead of the user locale |
| [339](#L339) | $locale = get\_locale(); |
| [340](#L340) | $settings = get\_option('vipps\_login\_settings', array()); |
| [341](#L341) | if ($settings['migrated'] ?? false) { |
| [342](#L342) | // All pre-existing installs are known to use Vipps |
| [343](#L343) | return 'Vipps'; |
| [344](#L344) | } |
| [345](#L345) | if ( class\_exists( 'WooCommerce' ) ) { |
| [346](#L346) | // Countries object not yet available at this point IOK 2023-12-01 |
| [347](#L347) | // $store\_location = WC()->countries->get\_base\_country(); |
| [348](#L348) | $store\_location=  wc\_get\_base\_location(); |
| [349](#L349) | $store\_country = $store\_location['country'] ?? ''; |
| [350](#L350) | $currency = get\_woocommerce\_currency(); |
| [351](#L351) |  |
| [352](#L352) | // If store location, locale, or currency is Norwegian, use Vipps |
| [353](#L353) | if ($store\_country== "NO" || preg\_match("/.\*\_NO/", $locale) || $currency == "NOK") { |
| [354](#L354) | return 'Vipps'; |
| [355](#L355) | } |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | if (preg\_match("/.\*\_NO/", $locale)) { |
| [359](#L359) | return 'Vipps'; |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | return 'MobilePay'; |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | // Try to get the current language in the format Vipps wants, one of 'en' and 'no' |
| [366](#L366) | // Follows the same implementation as the main VippsMobilePay plugin |
| [367](#L367) | public function get\_customer\_language() { |
| [368](#L368) | $user = wp\_get\_current\_user(); |
| [369](#L369) | $user\_locale = get\_user\_meta($user->ID, 'locale', true); |
| [370](#L370) | $language = substr($user\_locale, 0, 2); |
| [371](#L371) | if (function\_exists('pll\_current\_language')) { |
| [372](#L372) | $language = pll\_current\_language('slug'); |
| [373](#L373) | } elseif (has\_filter('wpml\_current\_language')){ |
| [374](#L374) | $language=apply\_filters('wpml\_current\_language',null); |
| [375](#L375) | } |
| [376](#L376) | if (! $language) $language = substr(get\_bloginfo('language'),0,2); |
| [377](#L377) | if ($language == 'nb' || $language == 'nn') $language = 'no'; |
| [378](#L378) | if ($language == 'da') $language = 'dk'; |
| [379](#L379) | if (! in\_array($language, ['en', 'no', 'dk', 'fi'])) $language = 'en'; |
| [380](#L380) | return $language; |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) |  |
| [384](#L384) | public function init\_form\_login\_options2() { |
| [385](#L385) | $options = get\_option('vipps\_login\_settings'); |
| [386](#L386) |  |
| [387](#L387) | $continuepageoptions = array( |
| [388](#L388) | ''=>\_\_('Create a new page', 'login-with-vipps'), |
| [389](#L389) | ); |
| [390](#L390) | $continuepageid = $options['continuepageid'] ?? 0; |
| [391](#L391) |  |
| [392](#L392) | $continuepage = $this->ensure\_continue\_with\_vipps\_page(); |
| [393](#L393) | if (is\_wp\_error($continuepage)) { |
| [394](#L394) | $notice = $continuepage->get\_error\_message(); |
| [395](#L395) | add\_action('admin\_notices', function() use ($notice) { echo "<div class='notice notice-error is-dismissible'><p>$notice</p></div>"; }); |
| [396](#L396) | } else { |
| [397](#L397) | $continuepageid = $continuepage->ID; |
| [398](#L398) | } |
| [399](#L399) | foreach(get\_pages() as $page) { |
| [400](#L400) | $continuepageoptions[$page->ID] = $page->post\_title; |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | $roles = array( |
| [404](#L404) | '\_all\_' => \_\_('Everybody', 'login-with-vipps'), |
| [405](#L405) | ); |
| [406](#L406) | foreach(wp\_roles()->roles as $role=>$roledata) { |
| [407](#L407) | $roles[$role] = $roledata['name']; |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | $fields = array( |
| [411](#L411) | 'use\_vipps\_login' => array( |
| [412](#L412) | 'type' => 'checkbox', |
| [413](#L413) | 'title' => sprintf(\_\_('Enable Login with %1$s', 'login-with-vipps'), $this->get\_login\_method()), |
| [414](#L414) | 'description' => sprintf(\_\_('Turn Login with %1$s on and off', 'login-with-vipps'), $this->get\_login\_method()), |
| [415](#L415) | 'default' => false, |
| [416](#L416) | ), |
| [417](#L417) | 'login\_page' => array( |
| [418](#L418) | 'type' => 'checkbox', |
| [419](#L419) | 'title' => sprintf(\_\_('Add %1$s to login page', 'login-with-vipps'), $this->get\_login\_method()), |
| [420](#L420) | 'description' => sprintf(\_\_('Log in with %1$s on the Wordpress login page', 'login-with-vipps'), $this->get\_login\_method()), |
| [421](#L421) | 'default' => false, |
| [422](#L422) | ), |
| [423](#L423) | 'required\_roles' => array( |
| [424](#L424) | 'type' => 'multicheck', |
| [425](#L425) | 'title' => sprintf(\_\_('Require users in these roles to log in with %1$s', 'login-with-vipps'), $this->get\_login\_method()), |
| [426](#L426) | 'description' => sprintf(\_\_('Users in these roles \*must\* use login with %1$s. You can also require this for a given user on the profile page', 'login-with-vipps'), $this->get\_login\_method()), |
| [427](#L427) | 'options' => $roles, |
| [428](#L428) | 'default' => array(), |
| [429](#L429) | ), |
| [430](#L430) | 'continuepageid' => array( |
| [431](#L431) | 'type' => 'select', |
| [432](#L432) | 'title' => sprintf(\_\_('Continue with %1$s page', 'login-with-vipps'), $this->get\_login\_method()), |
| [433](#L433) | 'description' => \_\_('Sometimes, the user may need to confirm their email or answer follow up questions to complete sign in. This page, which you may leave blank, will be used for this purpose. A blank page will have been installed for you when activating the plugin, this is the default page which will be used. Do \*not\* use any system pages or anything that is being used for other things.', 'login-with-vipps'), |
| [434](#L434) | 'options' => $continuepageoptions, |
| [435](#L435) | 'default' => 0, |
| [436](#L436) | ) |
| [437](#L437) | ); |
| [438](#L438) |  |
| [439](#L439) | return array( |
| [440](#L440) | 'title' => sprintf(\_\_('Login with %1$s', 'login-with-vipps'), $this->get\_login\_method()), |
| [441](#L441) | 'fields' => $fields, |
| [442](#L442) | ); |
| [443](#L443) | } |
| [444](#L444) |  |
| [445](#L445) | // Upon activation, this plugin will create a new page that is used for one thing only: Waiting for the user to confirm that the |
| [446](#L446) | // account they are trying to log into is actually owned by them, or that they control the email address. This code ensures that this page exists. IOK 2019-10-14 |
| [447](#L447) | public function activate () { |
| [448](#L448) | $continuepage = $this->ensure\_continue\_with\_vipps\_page(); |
| [449](#L449) | $continueid = 0; |
| [450](#L450) | if (!is\_wp\_error($continuepage)) { |
| [451](#L451) | $continueid = $continuepage->ID; |
| [452](#L452) | } |
| [453](#L453) | $default = array('continuepageid'=>$continueid, 'use\_vipps\_login'=>true,'login\_page'=>true,'require\_confirmation'=>false); |
| [454](#L454) | add\_option('vipps\_login\_settings',$default,false); |
| [455](#L455) | } |
| [456](#L456) |  |
| [457](#L457) | public static function deactivate () { |
| [458](#L458) | // We don't delete anything however, just in case. |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | // Returns the page object of the 'continue with vipps' page, creating it if neccessary. 2019-10-14 |
| [462](#L462) | public function ensure\_continue\_with\_vipps\_page() { |
| [463](#L463) | $options = get\_option('vipps\_login\_settings'); |
| [464](#L464) | $continuepageid = $options['continuepageid'] ?? false; |
| [465](#L465) | if ($continuepageid) { |
| [466](#L466) | $page = get\_post($continuepageid); |
| [467](#L467) | if ($page) return $page; |
| [468](#L468) | if (!$page) { |
| [469](#L469) | $options['continuepageid'] = 0; |
| [470](#L470) | update\_option('vipps\_login\_settings', $options); |
| [471](#L471) | } |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | // This is the typical case, when the user installs and activates the plugin. We use the users' id as the pages author. 2019-10-14 |
| [475](#L475) | $author = null; |
| [476](#L476) | if (current\_user\_can('manage\_options')) $author = wp\_get\_current\_user(); |
| [477](#L477) |  |
| [478](#L478) | // Otherwise, use a random admin as author. 2019-10-14 |
| [479](#L479) | if (!$author) { |
| [480](#L480) | $alladmins = get\_users(array('role'=>'administrator')); |
| [481](#L481) | if ($alladmins) { |
| [482](#L482) | $alladmins = array\_reverse($alladmins); |
| [483](#L483) | $author = $alladmins[0]; |
| [484](#L484) | } |
| [485](#L485) | } |
| [486](#L486) | $authorid = 0; |
| [487](#L487) | if ($author) $authorid = $author->ID; |
| [488](#L488) |  |
| [489](#L489) | $defaultname = sprintf(\_\_('Continue with %1$s page', 'login-with-vipps'), VippsLogin::instance()->get\_login\_method()); |
| [490](#L490) |  |
| [491](#L491) | $pagedata = array('post\_title'=>$defaultname, 'post\_status'=> 'publish', 'post\_author'=>$authorid, 'post\_type'=>'page'); |
| [492](#L492) | $newid = wp\_insert\_post($pagedata); |
| [493](#L493) | if (is\_wp\_error($newid)) { |
| [494](#L494) | return new WP\_Error(sprintf(\_\_('Could not find or create the "Continue with %1$s" page.', 'login-with-vipps'), VippsLogin::instance()->get\_login\_method()) . ": " .  $newid->get\_error\_message()); |
| [495](#L495) | } |
| [496](#L496) |  |
| [497](#L497) | $options['continuepageid'] = $newid; |
| [498](#L498) | update\_option('vipps\_login\_settings', $options); |
| [499](#L499) | return get\_post($newid); |
| [500](#L500) | } |
| [501](#L501) |  |
| [502](#L502) | // On the profile page, show extra buttons to connect and disconnect a user with a Vipps account . IOK 2019-10-14 |
| [503](#L503) | function show\_extra\_profile\_fields( $user ) { |
| [504](#L504) | $allow\_login = true; |
| [505](#L505) | $allow\_login = apply\_filters('continue\_with\_vipps\_allow\_login', $allow\_login, $user, array(), array()); |
| [506](#L506) | list($vippsphone, $vippsid) = $this->get\_vipps\_account($user); |
| [507](#L507) | $its\_you = (get\_current\_user\_id() == $user->ID); |
| [508](#L508) | $is\_admin = current\_user\_can('manage\_options'); |
| [509](#L509) |  |
| [510](#L510) | // Use an admin-post URL to disconnect users if we have the capability IOK 2024-08-27 |
| [511](#L511) | $disconnect\_url = |
| [512](#L512) | add\_query\_arg( ['action'=>'profile\_disconnect\_vipps', 'userid'=>$user->ID], |
| [513](#L513) | wp\_nonce\_url(admin\_url("/admin-post.php"), 'disconnect\_vipps', 'disconnect\_vipps\_nonce')); |
| [514](#L514) |  |
| [515](#L515) | ?> |
| [516](#L516) | <h2 class='vipps-profile-section-header'><?php printf(\_\_('Log in with %1$s', 'login-with-vipps'), VippsLogin::CompanyName()); ?> </h2> |
| [517](#L517) | <?php if ($allow\_login): ?> |
| [518](#L518) | <table class="form-table"> |
| [519](#L519) | <tr> |
| [520](#L520) | <th><?php printf(\_\_('Use %1$s to login to your account', 'login-with-vipps'), VippsLogin::CompanyName()); ?></th> |
| [521](#L521) | <td> |
| [522](#L522) | <?php if ($vippsphone && $vippsid): ?> |
| [523](#L523) | <?php if ($its\_you): ?> |
| [524](#L524) | <p> <?php printf(\_\_('You are connected to the %1$s profile with the phone number <b>%2$s</b>', 'login-with-vipps'), VippsLogin::CompanyName(), esc\_html($vippsphone)); ?></p> |
| [525](#L525) | <?php else: ?> |
| [526](#L526) | <p> <?php printf(\_\_('The user is connected to the %1$s profile with the phone number <b>%2$s</b>', 'login-with-vipps'), VippsLogin::CompanyName(), esc\_html($vippsphone)); ?></p> |
| [527](#L527) | <?php endif; ?> |
| [528](#L528) | <p><a href="<?php echo $disconnect\_url; ?>" class="button vipps-disconnect" ><?php \_e('Unlink account','login-with-vipps'); ?></a></p> |
| [529](#L529) | <span class="description"><?php printf(\_\_('As long as your profile is connected to %1$s, you can log in with %1$s.','login-with-vipps'), VippsLogin::CompanyName()); ?></span> |
| [530](#L530) | <?php else: ?> |
| [531](#L531) | <?php if ($its\_you): ?> |
| [532](#L532) | <p> <?php printf(\_\_('You are not connected to any %1$s profile', 'login-with-vipps'), VippsLogin::CompanyName()); ?></p> |
| [533](#L533) | <p><button type="button" onclick="connect\_vipps\_account('wordpress');return false"; class="button vipps-connect" value="1" name="vipps-connect"><?php \_e('Press here to connect with your app','login-with-vipps'); ?></button></p> |
| [534](#L534) | <?php else: ?> |
| [535](#L535) | <p> <?php printf(\_\_('The user is not connected to a %1$s profile.', 'login-with-vipps'), VippsLogin::CompanyName()); ?></p> |
| [536](#L536) | <?php endif; ?> |
| [537](#L537) | <span class="description"><?php printf(\_\_('You can connect to your %1$s profile if you use the same email address in the %1$s app and on this site.', 'login-with-vipps'), VippsLogin::CompanyName()); ?></span> |
| [538](#L538) | <?php endif; ?> |
| [539](#L539) | </td> |
| [540](#L540) | </tr> |
| [541](#L541) | <?php if ($is\_admin): ?> |
| [542](#L542) | <tr> |
| [543](#L543) | <th><?php printf(\_\_('Require this user to confirm their login with %1$s if logging in normally', 'login-with-vipps'), $this->get\_login\_method()); ?></th> |
| [544](#L544) | <td> |
| [545](#L545) | <input type="hidden" name="\_require\_vipps\_confirm" value=0> |
| [546](#L546) |  |
| [547](#L547) | <input type="radio" name="\_require\_vipps\_confirm" id="\_require\_vipps\_confirm\_yes" |
| [548](#L548) | <?php if (get\_user\_meta($user->ID, "\_require\_vipps\_confirm", true)=='yes') echo "checked=checked" ?> |
| [549](#L549) | value="yes"><label for="\_require\_vipps\_confirm\_yes"><?php \_e("Yes, require confirmation", 'login-with-vipps'); ?></label><br> |
| [550](#L550) | <input type="radio" name="\_require\_vipps\_confirm" id="\_require\_vipps\_confirm\_no" |
| [551](#L551) | <?php if (get\_user\_meta($user->ID, "\_require\_vipps\_confirm", true)=='no') echo "checked=checked" ?> |
| [552](#L552) | value="no"><label for="\_require\_vipps\_confirm\_no"> <?php \_e("No, allow login without the app", 'login-with-vipps'); ?></label><br> |
| [553](#L553) | <input type="radio" name="\_require\_vipps\_confirm" id="\_require\_vipps\_confirm\_default" |
| [554](#L554) | <?php if (!get\_user\_meta($user->ID, "\_require\_vipps\_confirm", true)) echo "checked=checked" ?> |
| [555](#L555) | value=""><label for="\_require\_vipps\_confirm\_default"> <?php \_e("Only if member of restricted groups", 'login-with-vipps'); ?></label><br> |
| [556](#L556) | <span class="description"><?php printf(\_\_('If you check this, this user will not be allowed to log in without confirming this operation with their %1$s app - email addresses must match.','login-with-vipps'), VippsLogin::CompanyName()); ?></span> |
| [557](#L557) |  |
| [558](#L558) |  |
| [559](#L559) |  |
| [560](#L560) | </td> |
| [561](#L561) | </tr> |
| [562](#L562) | <?php endif; ?> |
| [563](#L563) |  |
| [564](#L564) | </table> |
| [565](#L565) | <?php else: ?> |
| [566](#L566) | <table class="form-table"> |
| [567](#L567) | <tr> |
| [568](#L568) | <th><?php printf(\_\_('Login with %1$s is disabled', 'login-with-vipps'), $this->get\_login\_method()); ?></th> |
| [569](#L569) | <td> |
| [570](#L570) | <span class="description"><?php printf(\_\_('It is unfortunately not possible for your account to use %1$s to log in to this system due to the site administrators policy.'), $this->get\_login\_method()); ?></span> |
| [571](#L571) | </td> |
| [572](#L572) | </tr> |
| [573](#L573) | </table> |
| [574](#L574) | <?php endif; ?> |
| [575](#L575) |  |
| [576](#L576) | <?php |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | // This runs when the users saves the profile page, which here includes disconnecting from Vipps. IOK 2019-10-14 |
| [580](#L580) | // Disconnect moved to disconnect\_vipps\_post\_handler, called from admin-post. IOK 2024-09-27 |
| [581](#L581) | function profile\_update( $userid ) { |
| [582](#L582) | if (!current\_user\_can('edit\_user',$userid)) return false; |
| [583](#L583) |  |
| [584](#L584) | // Allow admin (only) to set the "require Vipps confirmation field |
| [585](#L585) | if (current\_user\_can('manage\_options') && isset($\_POST['\_require\_vipps\_confirm'])) { |
| [586](#L586) | update\_user\_meta($userid, '\_require\_vipps\_confirm', sanitize\_key($\_POST['\_require\_vipps\_confirm'])); |
| [587](#L587) | } |
| [588](#L588) | } |
| [589](#L589) |  |
| [590](#L590) | // If neccessary, add errors et to the profile update. |
| [591](#L591) | public function user\_profile\_update\_errors($errors,$update,$user) { |
| [592](#L592) | // Not actually neccessary, yet. |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | // Disconnect handler. Done using admin-post, but check nonce first. IOK 2019-10-14 |
| [596](#L596) | public function disconnect\_vipps\_post\_handler () { |
| [597](#L597) | check\_admin\_referer('disconnect\_vipps', 'disconnect\_vipps\_nonce'); |
| [598](#L598) | $userid = intval($\_REQUEST['userid']); |
| [599](#L599) | if (!$userid) wp\_die(\_\_('Cannot disconnect', 'login-with-vipps')); |
| [600](#L600) | if (!current\_user\_can('edit\_user',$userid)) wp\_die(\_\_('Cannot disconnect', 'login-with-vipps')); |
| [601](#L601) |  |
| [602](#L602) | list($vippsphone, $vippsid) =  VippsLogin::instance()->get\_vipps\_account($userid); |
| [603](#L603) | VippsLogin::instance()->unmap\_phone\_to\_user(get\_user\_by('id', $userid)); |
| [604](#L604) | VippsLogin::instance()->log(sprintf(\_\_('Unmapping user %2$d from %1$s', 'login-with-vipps'), VippsLogin::instance()->get\_login\_method(), $userid)); |
| [605](#L605) |  |
| [606](#L606) | $notice = sprintf(\_\_('Connection to %1$s profile %2$s <b>removed</b>.', 'login-with-vipps'), VippsLogin::CompanyName(), $phone); |
| [607](#L607) | $continue = ContinueWithVipps::instance(); |
| [608](#L608) | $continue->add\_admin\_notice($notice); |
| [609](#L609) | $continue->store\_admin\_notices(); |
| [610](#L610) |  |
| [611](#L611) | wp\_safe\_redirect(wp\_get\_referer()); |
| [612](#L612) | exit(); |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | // At this point, this method does not do anything. However, it is intended to |
| [616](#L616) | // allow this plugin to \*require\* that Vipps be used for connected users. This will then |
| [617](#L617) | // allow this plugin to deny bruteforce attacks against these accounts. IOK 2019-10-14 |
| [618](#L618) | public function authenticate ($user, $username, $password) { |
| [619](#L619) | if (!$user) return $user; |
| [620](#L620) | if (! ($user instanceof WP\_User)) return $user; |
| [621](#L621) |  |
| [622](#L622) | // This is the Vipps login session ID, if it is missing, we're not logging in via Vipps 2020-12-21 |
| [623](#L623) | if (!$this->currentSid) $this->currentSid = array($user->ID, null); |
| [624](#L624) | if ($this->currentSid) { |
| [625](#L625) | list ($userid, $sid) = $this->currentSid; |
| [626](#L626) | if (!$sid) { |
| [627](#L627) | $options = get\_option('vipps\_login\_settings'); |
| [628](#L628) | $option\_roles= isset($options['required\_roles']) ? $options['required\_roles'] : []; |
| [629](#L629) | if (!is\_array($option\_roles)) $option\_roles=array(); |
| [630](#L630) |  |
| [631](#L631) | $needs\_verification = false; |
| [632](#L632) | $needs\_verification\_setting = get\_user\_meta($userid,'\_require\_vipps\_confirm',true); |
| [633](#L633) |  |
| [634](#L634) | // This user has been marked as requiring verification by Vipps before login |
| [635](#L635) | if (!$needs\_verification && $needs\_verification\_setting == 'yes') $needs\_verification=true; |
| [636](#L636) |  |
| [637](#L637) | // Unless an exception has been made for this user, role rules apply |
| [638](#L638) | if ($needs\_verification\_setting!= 'no' && !$needs\_verification) { |
| [639](#L639) | // Everybody should be verified |
| [640](#L640) | if (!$needs\_verification && isset($option\_roles['\_all\_']) && $option\_roles['\_all\_']) { |
| [641](#L641) | $needs\_verification = true; |
| [642](#L642) | } |
| [643](#L643) | // Some roles need verification, and this user is in one of them |
| [644](#L644) | if (!$needs\_verification && !empty($option\_roles)) { |
| [645](#L645) | $required\_roles=array\_keys($option\_roles); |
| [646](#L646) | if (!empty(array\_intersect($user->roles, $required\_roles))) { |
| [647](#L647) | $needs\_verification=true; |
| [648](#L648) | } |
| [649](#L649) | } |
| [650](#L650) | } |
| [651](#L651) |  |
| [652](#L652) | // A final filter |
| [653](#L653) | $needs\_verification = apply\_filters('login\_with\_vipps\_user\_needs\_verification', $needs\_verification, $user); |
| [654](#L654) |  |
| [655](#L655) |  |
| [656](#L656) | if ($needs\_verification) { |
| [657](#L657) | $referer = wp\_get\_raw\_referer(); |
| [658](#L658) | $url = ContinueWithVipps::getAuthRedirect('confirm\_login',array('uid'=>$userid,'origin'=>$referer)); |
| [659](#L659) | wp\_redirect($url); |
| [660](#L660) | exit(); |
| [661](#L661) | } |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) | return $user; |
| [665](#L665) | } |
| [666](#L666) |  |
| [667](#L667) | // Ideally, we would interact with Vipps here, but these parts of the API is not yet implemented. IOK 2019-10-14 |
| [668](#L668) | public function wp\_logout () { |
| [669](#L669) | $user = wp\_get\_current\_user(); |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) | // For convenience, some shortcodes that output the same buttons added to the login page. IOK 2019-10-14 |
| [673](#L673) | public function add\_shortcodes() { |
| [674](#L674) | add\_shortcode('login-with-vipps', array($this, 'log\_in\_with\_vipps\_shortcode')); |
| [675](#L675) | add\_shortcode('log-in-with-vipps', array($this, 'log\_in\_with\_vipps\_shortcode')); |
| [676](#L676) | add\_shortcode('continue-with-vipps', array($this, 'continue\_with\_vipps\_shortcode')); |
| [677](#L677) | } |
| [678](#L678) | public function log\_in\_with\_vipps\_shortcode($atts, $content, $tag) { |
| [679](#L679) | if (!is\_array($atts)) $atts = array(); |
| [680](#L680) | if (!isset($atts['text'])) $atts['text'] = \_\_('Log in with', 'login-with-vipps'); |
| [681](#L681) | return $this->continue\_with\_vipps\_shortcode($atts,$content,$tag); |
| [682](#L682) | } |
| [683](#L683) | public function continue\_with\_vipps\_shortcode($atts,$content,$tag) { |
| [684](#L684) | $args = shortcode\_atts(array('application'=>'wordpress', 'text'=>\_\_('Continue with', 'login-with-vipps')), $atts); |
| [685](#L685) | $text = esc\_html($args['text']); |
| [686](#L686) | $application = $args['application']; |
| [687](#L687) | ob\_start(); |
| [688](#L688) | ?> |
| [689](#L689) | <span class='continue-with-vipps-wrapper inline'> |
| [690](#L690) | <?php $this->login\_button\_html($text, $application); ?> |
| [691](#L691) | </span> |
| [692](#L692) | <?php |
| [693](#L693) | return ob\_get\_clean(); |
| [694](#L694) | } |
| [695](#L695) |  |
| [696](#L696) | // The login-button on the front page. Moved up in front of the main form using javascript. IOK 2019-10-14 |
| [697](#L697) | public function login\_form\_continue\_with\_vipps () { |
| [698](#L698) | $options = get\_option('vipps\_login\_settings'); |
| [699](#L699) | if (!$options['login\_page']) return; |
| [700](#L700) | $this->wp\_login\_button(\_\_('Log in with', 'login-with-vipps')); |
| [701](#L701) | $this->move\_continue\_button\_over\_login\_form(); |
| [702](#L702) | } |
| [703](#L703) | public function register\_form\_continue\_with\_vipps () { |
| [704](#L704) | $options = get\_option('vipps\_login\_settings'); |
| [705](#L705) | if (!$options['login\_page']) return; |
| [706](#L706) | $this->wp\_login\_button(\_\_('Continue with', 'login-with-vipps')); |
| [707](#L707) | $this->move\_continue\_button\_over\_login\_form(); |
| [708](#L708) | } |
| [709](#L709) | public function wp\_login\_button($text, $application='wordpress') { |
| [710](#L710) | ?> |
| [711](#L711) | <div id='continue-with-vipps-wrapper' class='continue-with-vipps-wrapper'> |
| [712](#L712) | <?php $this->login\_button\_html($text, $application); ?> |
| [713](#L713) | </div> |
| [714](#L714) | <?php |
| [715](#L715) | } |
| [716](#L716) |  |
| [717](#L717) | // The HTML for this button. IOK 2019-10-14 |
| [718](#L718) | public function login\_button\_html($text, $application) { |
| [719](#L719) | $login\_method = $this->get\_login\_method(); |
| [720](#L720) | $logo = $this->get\_transparent\_logo(); |
| [721](#L721) | $bg = $this->get\_background\_class(); |
| [722](#L722) | ob\_start(); |
| [723](#L723) | ?> |
| [724](#L724) | <a href='javascript:login\_with\_vipps("<?php echo $application; ?>");' class="button vipps-orange vipps-button continue-with-vipps <?php echo $bg;?>" title="<?php echo sprintf("%s %s", $text, $login\_method); ?>"><?php echo $text;?> <img |
| [725](#L725) | alt="<?php printf(\_\_('Log in without password using %1$s', 'login-with-vipps'), $login\_method); ?>" src="<?php echo $logo; ?>">!</a> |
| [726](#L726) | <?php |
| [727](#L727) | echo apply\_filters('continue\_with\_vipps\_login\_button\_html', ob\_get\_clean(), $application, $text); |
| [728](#L728) | } |
| [729](#L729) |  |
| [730](#L730) |  |
| [731](#L731) | // The logo for the login button, depending on the login method. |
| [732](#L732) | public function get\_transparent\_logo() { |
| [733](#L733) | $method = $this->get\_login\_method(); |
| [734](#L734) | if ($method == 'MobilePay') { |
| [735](#L735) | return plugins\_url('img/mobilepay\_logo\_negativ\_rgb\_transparent.png',\_\_FILE\_\_); |
| [736](#L736) | } |
| [737](#L737) | if ($method == 'Vipps') { |
| [738](#L738) | return plugins\_url('img/vipps\_logo\_negativ\_rgb\_transparent.png',\_\_FILE\_\_); |
| [739](#L739) | } |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | // The background for the login button, depending on the login method. |
| [743](#L743) | public function get\_background\_class() { |
| [744](#L744) | $method = $this->get\_login\_method(); |
| [745](#L745) | if ($method == 'MobilePay') { |
| [746](#L746) | return 'mobilepay-background'; |
| [747](#L747) | } |
| [748](#L748) | if ($method == 'Vipps') { |
| [749](#L749) | return 'vipps-background'; |
| [750](#L750) | } |
| [751](#L751) | } |
| [752](#L752) |  |
| [753](#L753) | // The login form does not have any action that runs right before the form, where we want to be. So we cheat, rewriting the page using javascript. IOK 2019-10-14 |
| [754](#L754) | public function move\_continue\_button\_over\_login\_form() { |
| [755](#L755) | ?> |
| [756](#L756) | <script> |
| [757](#L757) | window.onload = function () { |
| [758](#L758) | var me =  document.getElementById('continue-with-vipps-wrapper'); |
| [759](#L759) | var theform = document.getElementById('loginform'); |
| [760](#L760) | if (!theform) theform = document.getElementById('registerform'); |
| [761](#L761) | if (theform) { |
| [762](#L762) | var tops = theform.parentNode; |
| [763](#L763) | tops.insertBefore(me, theform); |
| [764](#L764) | } |
| [765](#L765) | me.style.display = 'block'; |
| [766](#L766) | } |
| [767](#L767) | </script> |
| [768](#L768) | <?php |
| [769](#L769) | return true; |
| [770](#L770) | } |
| [771](#L771) |  |
| [772](#L772) | // The hook into template\_redirect is to handle the Vipps Confirmation waiting page. If the user confirms, and this page is reloaded, we want to log in. Also |
| [773](#L773) | // we will allow applications to modify this behaviour. IOK 2019-10-14 |
| [774](#L774) | public function template\_redirect () { |
| [775](#L775) | $continuepage = $this->ensure\_continue\_with\_vipps\_page(); |
| [776](#L776) | if ($continuepage && !is\_wp\_error($continuepage) && is\_page($continuepage->ID)) { |
| [777](#L777) |  |
| [778](#L778) | $state = sanitize\_text\_field(@$\_REQUEST['state']); |
| [779](#L779) | $sessionkey = ''; |
| [780](#L780) | $action = ''; |
| [781](#L781) | if ($state) list($action,$sessionkey) = explode("::",$state); |
| [782](#L782) | do\_action('continue\_with\_vipps\_before\_page\_' . $action, $sessionkey); |
| [783](#L783) |  |
| [784](#L784) | header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0'); |
| [785](#L785) | header('Pragma: no-cache'); |
| [786](#L786) | header('Expires: Thu, 01 Dec 1990 16:00:00 GMT'); |
| [787](#L787) | add\_filter('the\_content', function ($content) { |
| [788](#L788) | return $this->continue\_with\_vipps\_waiting\_page($content); |
| [789](#L789) | }); |
| [790](#L790) | } |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | // If for some reason we need to go to the waiting page (e.g user is not confirmed). IOK 2019-10-1e |
| [794](#L794) | public function redirect\_to\_waiting\_page($forwhat,$session) { |
| [795](#L795) | $state = $forwhat . "::" . $session->sessionkey; |
| [796](#L796) | $continuepage = $this->ensure\_continue\_with\_vipps\_page(); |
| [797](#L797) | if (is\_wp\_error($continuepage)) { |
| [798](#L798) | wp\_die(sprintf(\_\_('Cannot redirect to %1$s waiting page as it doesn\'t exist. If you just tried to log in, check your email.', 'login-with-vipps'), VippsLogin::CompanyName())); |
| [799](#L799) | } |
| [800](#L800) | $waiturl = get\_permalink($continuepage); |
| [801](#L801) | $redir = add\_query\_arg(array('state'=>urlencode($state)), $waiturl); |
| [802](#L802) | wp\_safe\_redirect($redir, 302, 'Vipps'); |
| [803](#L803) | exit(); |
| [804](#L804) | } |
| [805](#L805) |  |
| [806](#L806) | // This is actually run as the 'the\_content' filter for the waiting page, replacing the contents of whatever page was used with this. IOK 2019-10-14 |
| [807](#L807) | public  function continue\_with\_vipps\_waiting\_page($content) { |
| [808](#L808) | $state = sanitize\_text\_field(@$\_REQUEST['state']); |
| [809](#L809) | $sessionkey = ''; |
| [810](#L810) | $action = ''; |
| [811](#L811) | if ($state) list($action,$sessionkey) = explode("::",$state); |
| [812](#L812) | $session = VippsSession::get($sessionkey); |
| [813](#L813) |  |
| [814](#L814) | if (!$session  || !$this->checkBrowserCookie($session['cookie'])) { |
| [815](#L815) | $message = sprintf(\_\_('This page is used to handle your requests when continuing from %1$s and further action is required to complete your task. But in this case, it doesn\'t seem to be an open session', 'login-with-vipps'), VippsLogin::CompanyName()); |
| [816](#L816) | $message = apply\_filters('continue\_with\_vipps\_waiting\_page\_expired\_session\_' . $action, $message,  $session); |
| [817](#L817) | if ($session) $session->destroy(); |
| [818](#L818) | return $message; |
| [819](#L819) | } |
| [820](#L820) | ob\_start(); |
| [821](#L821) | do\_action('continue\_with\_vipps\_page\_' . $action, $session); |
| [822](#L822) | return ob\_get\_clean(); |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | // This happens right before the waiting page, before output is started. If you need to use the "Before login" waiting page, you can check if your requirements (ie, terms acceptance, email confimation etc) |
| [826](#L826) | // are now ok, and if so, you could go ahead and use the still active session to log your user in etc. Remember to destroy the session and preferably delete the browser cookie too. |
| [827](#L827) | public function continue\_with\_vipps\_before\_page\_login($sessionkey) { |
| [828](#L828) | if (!$sessionkey) return; |
| [829](#L829) | $session = VippsSession::get($sessionkey); |
| [830](#L830) | if (!$session  || !$this->checkBrowserCookie($session['cookie'])) return; |
| [831](#L831) | // Check your session here if you are ready to login the/any user etc. |
| [832](#L832) | do\_action('vipps\_login\_before\_waiting\_page\_actions', $session); |
| [833](#L833) | return false; |
| [834](#L834) | } |
| [835](#L835) |  |
| [836](#L836) | // This is a "the\_content" filter added to the waiting page for login sessions.  Typically, you would add something to the session (still alive here) |
| [837](#L837) | // and dispatch on that. An example is provided below; also we add a simple filter to extend functionality. You would here ask your users to confirm something or select something before actually logging them in. |
| [838](#L838) | public function continue\_with\_vipps\_page\_login($session)  { |
| [839](#L839) | $handled = false; |
| [840](#L840) | if ($session['subaction'] == 'confirm\_your\_account') { |
| [841](#L841) | // No longer used, but kept as documentation as to how one could use a 'waiting page' like this. You would a) not delete the session b) set some flag in it, |
| [842](#L842) | //  redirect to the "continue with vipps" waiting page, and do your output here. IOK 2022-04-01 |
| [843](#L843) | print "<p>"; |
| [844](#L844) | print "</p>"; |
| [845](#L845) | $handled = true; |
| [846](#L846) | } else { |
| [847](#L847) | do\_action('vipps\_login\_waiting\_page\_actions', $session); |
| [848](#L848) | $handled = apply\_filters('vipps\_login\_waiting\_page\_handled', $handled,  $session); |
| [849](#L849) | } |
| [850](#L850) | if (!$handled) { |
| [851](#L851) | $msg = \_\_("Welcome! If you see this page, an really unexpected error has occur. Unfortunately, we can't do better than to send you to the <a href='%s'>login page</a>", 'login-with-vipps'); |
| [852](#L852) | printf($msg, wp\_login\_url()); |
| [853](#L853) | } |
| [854](#L854) | } |
| [855](#L855) |  |
| [856](#L856) | // This is used in a hook when redirecing to wp-login.php. It will format and output any errors that occured during login. IOK 2019-10-14 |
| [857](#L857) | // In this situation we use a fresh VippsSession to carry this information. |
| [858](#L858) | public function wp\_login\_errors ($errors, $redirect\_to) { |
| [859](#L859) | $session = array(); |
| [860](#L860) | $state = sanitize\_text\_field(@$\_REQUEST['vippsstate']); |
| [861](#L861) | $errorcode = sanitize\_text\_field(@$\_REQUEST['vippserror']); |
| [862](#L862) | if ($state) { |
| [863](#L863) | $session = VippsSession::get($state); |
| [864](#L864) | } |
| [865](#L865) | if (!$session) return $errors; |
| [866](#L866) | if (isset($session['error'])) { |
| [867](#L867) | $desc = \_\_($session['error'],'login-with-vipps'); |
| [868](#L868) | if (isset($session['errordesc'])) { |
| [869](#L869) | $desc = \_\_($session['errordesc'],'login-with-vipps'); |
| [870](#L870) | } |
| [871](#L871) | $errors->add($session['error'], $desc); |
| [872](#L872) | } |
| [873](#L873) | if ($session) $session->destroy(); |
| [874](#L874) | return $errors; |
| [875](#L875) | } |
| [876](#L876) |  |
| [877](#L877) |  |
| [878](#L878) | // This is an action handler for all errors for the action 'login'. We format the errors, create a new session, store them there, then redirect to the login URL. |
| [879](#L879) | // Before any of this, we parametrize everything with the passed 'application' - since this is handled completely different when logging in via Woocommerce for instance. IOK 2019-10-14 |
| [880](#L880) | // The last parameter, 'sessiondata' is not a live session. It is an Array, or any object that can be accessed as such. If you need to |
| [881](#L881) | // create a new session here, you should not try to pass it as the new sessions contens - create a new array instead. IOK 2019-10-08 |
| [882](#L882) | public function continue\_with\_vipps\_error\_login($error,$errordesc,$error\_hint='',$sessiondata=array()) { |
| [883](#L883) | $redir = wp\_login\_url(); |
| [884](#L884) | $app = sanitize\_title(($sessiondata && isset($sessiondata['application'])) ? $sessiondata['application'] : 'wordpress'); |
| [885](#L885) | $referer = ($sessiondata && isset($sessiondata['referer'])) ? $sessiondata['referer'] : ''; |
| [886](#L886) |  |
| [887](#L887) | // Override error page redirect for your application. No access to the possible new session. IOK 2019-10-08 |
| [888](#L888) | $redir = apply\_filters('continue\_with\_vipps\_error\_login\_redirect', $redir, $error, $sessiondata); |
| [889](#L889) | $redir = apply\_filters("continue\_with\_vipps\_error\_{$app}\_login\_redirect", $redir, $error, $sessiondata); |
| [890](#L890) |  |
| [891](#L891) | // Only create a session if your application needs it, to avoid getting messy URLs. IOK 2019-10-14 |
| [892](#L892) | $createSession = true; |
| [893](#L893) | $createSession = apply\_filters("continue\_with\_vipps\_error\_{$app}\_login\_create\_session", $createSession, $sessiondata); |
| [894](#L894) |  |
| [895](#L895) | $continue = ContinueWithVipps::instance(); |
| [896](#L896) | $session = $createSession ? VippsSession::create(array('application'=>$app, 'error'=>$error,'errordesc'=>$errordesc,'error\_hint'=>$error\_hint,'action'=>'login','referer'=>$referer)) : null; |
| [897](#L897) |  |
| [898](#L898) | // Final chance for tweaking error messages |
| [899](#L899) | $errordesc = apply\_filters('continue\_with\_vipps\_login\_errordescription', $errordesc, $error, $sessiondata, $app); |
| [900](#L900) |  |
| [901](#L901) | // This would be for an application to extend the session if needed IOK 2019-10-08 |
| [902](#L902) | do\_action("continue\_with\_vipps\_error\_{$app}\_login", $error, $errordesc, $error\_hint, $session); |
| [903](#L903) |  |
| [904](#L904) |  |
| [905](#L905) | if ($createSession) $redir = add\_query\_arg(array('vippsstate'=>urlencode($session->sessionkey), 'vippserror'=>urlencode($error)), $redir); |
| [906](#L906) | wp\_safe\_redirect($redir); |
| [907](#L907) | exit(); |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) |  |
| [911](#L911) | // This function will login your user when appropriate (ie, after 'authenticate' has run and everything is good). |
| [912](#L912) | // NB: 'authenticate' may well redirect to another page, and then back here. Therefore the session will be active right until we |
| [913](#L913) | // can redirect to the final page ('login\_redirect').  IOK 2019-10-14 |
| [914](#L914) | // This page is also parametrized on the passed application so that for instance Woo can update addressses and so forth. IOK 2019-10-14 |
| [915](#L915) | protected function actually\_login\_user($user,$sid=null,$session=null) { |
| [916](#L916) | // Note our session ID. This also will indicate that we have logged in via Vipps. IOK 2020-12-21 |
| [917](#L917) | $this->currentSid = array($user->ID, $sid); |
| [918](#L918) |  |
| [919](#L919) | // Then, ensure that we interact properly with MFA stuff and so forth so other plugins can invalidate the login |
| [920](#L920) | $user = apply\_filters('authenticate', $user, '', ''); |
| [921](#L921) | if (is\_wp\_error($user)) { |
| [922](#L922) | $error = $user; |
| [923](#L923) | $this->continue\_with\_vipps\_error\_login($error->get\_error\_code(),$error->get\_error\_message(),'', $session); |
| [924](#L924) | exit(); |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) |  |
| [928](#L928) | $app = sanitize\_title(($session && isset($session['application'])) ? $session['application'] : 'wordpress'); |
| [929](#L929) | do\_action('continue\_with\_vipps\_before\_user\_login', $user, $session); |
| [930](#L930) | do\_action("continue\_with\_vipps\_before\_{$app}\_user\_login", $user, $session); |
| [931](#L931) |  |
| [932](#L932) | add\_filter('attach\_session\_information', function ($data,$user\_id) use ($sid) { |
| [933](#L933) | $data['vippssession'] = $sid; |
| [934](#L934) | return $data; |
| [935](#L935) | }, 10, 2); |
| [936](#L936) |  |
| [937](#L937) | $remember = apply\_filters('login\_with\_vipps\_remember\_user', false, $user, $data); |
| [938](#L938) | wp\_set\_auth\_cookie($user->ID, $remember); |
| [939](#L939) | wp\_set\_current\_user($user->ID,$user->user\_login); // 'secure' |
| [940](#L940) | do\_action('wp\_login', $user->user\_login, $user); |
| [941](#L941) | $profile = get\_edit\_user\_link($user->ID); |
| [942](#L942) |  |
| [943](#L943) | do\_action('continue\_with\_vipps\_before\_login\_redirect', $user, $session); |
| [944](#L944) | do\_action("continue\_with\_vipps\_before\_{$app}\_login\_redirect", $user, $session); |
| [945](#L945) |  |
| [946](#L946) | $redir = apply\_filters('login\_redirect', $profile,$profile, $user); |
| [947](#L947) | if($session) $session->destroy(); |
| [948](#L948) | $this->deleteBrowserCookie(); |
| [949](#L949) | wp\_safe\_redirect($redir, 302, 'Vipps'); |
| [950](#L950) | exit(); |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | // Standard method of finding "the" user mapped to this phone number. The table in principle supports |
| [954](#L954) | // 1-n mappings, but we don't support that out of the box, as that would require user interaction on login. |
| [955](#L955) | // The 'sub' is unique per merchant, so we require that too. |
| [956](#L956) | public function get\_user\_by\_vipps\_creds($phone,$sub) { |
| [957](#L957) | global $wpdb; |
| [958](#L958) | $tablename2  = $wpdb->prefix . 'vipps\_login\_users'; |
| [959](#L959) | $q = $wpdb->prepare("SELECT \* FROM `{$tablename2}` WHERE vippsphone=%s AND vippsid=%s ORDER BY id DESC LIMIT 1", $phone, $sub); |
| [960](#L960) | $result = $wpdb->get\_row($q, ARRAY\_A); |
| [961](#L961) | if (!$result) return null; |
| [962](#L962) | $user = get\_user\_by('id', $result['userid']); |
| [963](#L963) | if (!is\_wp\_error($user)) return $user; |
| [964](#L964) | return null; |
| [965](#L965) | } |
| [966](#L966) |  |
| [967](#L967) | // Get the account (currently the only one) mapped to a Vipps account by user id |
| [968](#L968) | public function get\_vipps\_account($user=null) { |
| [969](#L969) | $userid = 0; |
| [970](#L970) | if (is\_int($user)) { |
| [971](#L971) | $userid = $user; |
| [972](#L972) | } else if (! $user) { |
| [973](#L973) | $userid = get\_current\_user\_id(); |
| [974](#L974) | } else { |
| [975](#L975) | $userid = $user->ID; |
| [976](#L976) | } |
| [977](#L977) | if (!$userid) { |
| [978](#L978) | return array(null, null); |
| [979](#L979) | } |
| [980](#L980) | global $wpdb; |
| [981](#L981) | $tablename2  = $wpdb->prefix . 'vipps\_login\_users'; |
| [982](#L982) | $q = $wpdb->prepare("SELECT vippsphone, vippsid  FROM `{$tablename2}` WHERE userid=%d ORDER BY id DESC LIMIT 1", $userid); |
| [983](#L983) | $result = $wpdb->get\_row($q, ARRAY\_A); |
| [984](#L984) | if (!empty($result)) { |
| [985](#L985) | return array($result['vippsphone'], $result['vippsid']); |
| [986](#L986) | } |
| [987](#L987) | // Try to see if this user \*is\* mapped, but in the old way. To be deleted later. IOK 2022-04-04 |
| [988](#L988) | $phone = get\_user\_meta($userid, '\_vipps\_phone',true); |
| [989](#L989) | $sub = get\_user\_meta($userid, '\_vipps\_id',true); |
| [990](#L990) | if ($phone && $sub) { |
| [991](#L991) | $this->map\_phone\_to\_user($phone, $sub, get\_user\_by('id', $userid)); |
| [992](#L992) | return array($phone, $sub); |
| [993](#L993) | } |
| [994](#L994) | return array(null, null); |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) | // This maintains the mapping table from Vipps phones to users, which is used for logins once the user is "connected". Before this, you will |
| [998](#L998) | // either need to be logged in (and connect), or the users' verified email address will be used. IOK 2022-04-01 |
| [999](#L999) | public function map\_phone\_to\_user($phone, $sub, $user) { |
| [1000](#L1000) | global $wpdb; |
| [1001](#L1001) | $tablename2  = $wpdb->prefix . 'vipps\_login\_users'; |
| [1002](#L1002) |  |
| [1003](#L1003) | // The uniqueness constraint here is for phone x userid, not just phone, so we \*can\* actually map many-to-many here. But standardly, we won't (see below). |
| [1004](#L1004) | $q = $wpdb->prepare("INSERT INTO `{$tablename2}` (vippsphone, vippsid, userid) VALUES (%s, %s, %d) ON DUPLICATE KEY UPDATE vippsid=VALUES(vippsid)", $phone, $sub, $user->ID); |
| [1005](#L1005) | $ok = $wpdb->query($q); |
| [1006](#L1006) | if ($ok === false) return; |
| [1007](#L1007) |  |
| [1008](#L1008) | // We are probably going to delete these after a while as they duplicate the info in the above table. Keep the updating for now just in case these are in use |
| [1009](#L1009) | // by developers, but do not use them in the login process. IOK 2022-04-04 |
| [1010](#L1010) | update\_user\_meta($user->ID,'\_vipps\_phone',$phone); |
| [1011](#L1011) | update\_user\_meta($user->ID,'\_vipps\_id',$sub); |
| [1012](#L1012) |  |
| [1013](#L1013) | //  This is for future reference, allow filters to stop us deleting the \*other\* linkages so that one Vipps account |
| [1014](#L1014) | // \*could\* be used to log in to several accounts. |
| [1015](#L1015) | if (! apply\_filters('login\_with\_vipps\_allow\_multiple\_acount\_binding', false)) { |
| [1016](#L1016) |  |
| [1017](#L1017) | $others = $wpdb->prepare("SELECT userid FROM `{$tablename2}` WHERE vippsphone = %s AND userid != %d", $phone, $user->ID); |
| [1018](#L1018) | // Handle the usermeta variables, temporarily. We'll delete these at some point in the future. IOK 2022-04-04 |
| [1019](#L1019) | if (is\_array($others)) { |
| [1020](#L1020) | foreach($others as $entry) { |
| [1021](#L1021) | $otherid = $entry['userid']; |
| [1022](#L1022) | delete\_user\_meta($otherid,'\_vipps\_phone'); |
| [1023](#L1023) | delete\_user\_meta($otherid,'\_vipps\_id'); |
| [1024](#L1024) | } |
| [1025](#L1025) | } |
| [1026](#L1026) | $delete = $wpdb->prepare("DELETE FROM {$tablename2} WHERE vippsphone  = %s AND userid != %d", $phone, $user->ID); |
| [1027](#L1027) | $wpdb->query($delete); |
| [1028](#L1028) | } |
| [1029](#L1029) |  |
| [1030](#L1030) | return; |
| [1031](#L1031) | } |
| [1032](#L1032) | // In reverse. Current version unmaps every connected account, because we only allow one, but we may allow other configurations in the future. IOK 2022-04-04 |
| [1033](#L1033) | public function unmap\_phone\_to\_user($user, $phone=null, $sub=null) { |
| [1034](#L1034) | global $wpdb; |
| [1035](#L1035) | $tablename2  = $wpdb->prefix . 'vipps\_login\_users'; |
| [1036](#L1036) | $delete = null; |
| [1037](#L1037) | if ($phone && $sub) { |
| [1038](#L1038) | $delete = $wpdb->prepare("DELETE FROM {$tablename2} WHERE vippsphone = %s AND userid = %d", $phone, $user->ID); |
| [1039](#L1039) | } else { |
| [1040](#L1040) | $delete = $wpdb->prepare("DELETE FROM {$tablename2} WHERE userid = %d", $user->ID); |
| [1041](#L1041) | } |
| [1042](#L1042) | if ($delete) { |
| [1043](#L1043) | $wpdb->query($delete); |
| [1044](#L1044) | } |
| [1045](#L1045) | delete\_user\_meta($user->ID,'\_vipps\_phone'); |
| [1046](#L1046) | delete\_user\_meta($user->ID,'\_vipps\_id'); |
| [1047](#L1047) | } |
| [1048](#L1048) |  |
| [1049](#L1049) | // Main login handler action! This should redirect to either a success page (the profile page as default) or it should call the error handler. |
| [1050](#L1050) | // It will log in a new user if a) there is no existing user with that email, and registration is allowed or b) the user is connected to the Vipps account using |
| [1051](#L1051) | // the user\_meta values. If not, then a confirmation message will be sent to the user. IOK 2019. |
| [1052](#L1052) | public function continue\_with\_vipps\_login($userinfo,$session) { |
| [1053](#L1053) | if (!$userinfo) { |
| [1054](#L1054) | $this->deleteBrowserCookie(); |
| [1055](#L1055) | if ($session) $session->destroy(); |
| [1056](#L1056) | $loginurl = wp\_login\_url() ; |
| [1057](#L1057) | wp\_safe\_redirect($loginurl); |
| [1058](#L1058) | exit(); |
| [1059](#L1059) | } |
| [1060](#L1060) | $email = $userinfo['email']; |
| [1061](#L1061) | $name = $userinfo['name']; |
| [1062](#L1062) | $username = sanitize\_user($email); |
| [1063](#L1063) | $lastname = $userinfo['family\_name']; |
| [1064](#L1064) | $firstname =  $userinfo['given\_name']; |
| [1065](#L1065) | $phone =  $userinfo['phone\_number']; |
| [1066](#L1066) | $sub =  $userinfo['sub']; |
| [1067](#L1067) |  |
| [1068](#L1068) | // $sid=  $userinfo['sid']; |
| [1069](#L1069) | $sid = 'no\_longer\_relevant'; // IOK SID no longer avaiable from $userinfo. |
| [1070](#L1070) |  |
| [1071](#L1071) | // First, see if we have this user already mapped: |
| [1072](#L1072) | $mapped = false; |
| [1073](#L1073) | $user = $this->get\_user\_by\_vipps\_creds($phone, $sub); |
| [1074](#L1074) | if ($user) { |
| [1075](#L1075) | $mapped = true; |
| [1076](#L1076) | } else  { |
| [1077](#L1077) | // Else, use  the verified email address to retrieve the user |
| [1078](#L1078) | $mapped = false; |
| [1079](#L1079) | if (intval($userinfo['email\_verified'])) { |
| [1080](#L1080) | $user = get\_user\_by('email',$email); |
| [1081](#L1081) | } |
| [1082](#L1082) | } |
| [1083](#L1083) | // Allow a filter to find the user for special applications (phone number as username etc etc) |
| [1084](#L1084) | $user = apply\_filters( 'login\_with\_vipps\_authenticate\_user', $user, $userinfo, $session); |
| [1085](#L1085) |  |
| [1086](#L1086) | // Login is parametrized by 'application' stored in the session. Will be 'wordpress', 'woocommerce' etc. IOK 2019-10-14 |
| [1087](#L1087) | $app = sanitize\_title(($session && isset($session['application'])) ? $session['application'] : 'wordpress'); |
| [1088](#L1088) |  |
| [1089](#L1089) | // MFA plugins may actually redirect here again, in which case we will now be logged in, and we can just redirect. Destroy session first of course. IOK 2019-10-14 |
| [1090](#L1090) | if ($user && (is\_user\_logged\_in() == $user)) { |
| [1091](#L1091) | $profile = get\_edit\_user\_link($user->ID); |
| [1092](#L1092) | do\_action('continue\_with\_vipps\_before\_login\_redirect', $user, $session); |
| [1093](#L1093) | do\_action("continue\_with\_vipps\_before\_{$app}\_login\_redirect", $user, $session); |
| [1094](#L1094) | $redir = apply\_filters('login\_redirect', $profile,$profile, $user); |
| [1095](#L1095) | if($session) $session->destroy(); |
| [1096](#L1096) | wp\_safe\_redirect($redir, 302, 'Vipps'); |
| [1097](#L1097) | exit(); |
| [1098](#L1098) | } |
| [1099](#L1099) |  |
| [1100](#L1100) | // If not we must now check that the browser is actually allowed to do this thing - if the user has no cookie, it can't log in. IOK 2019-10-14 |
| [1101](#L1101) | if (!isset($session['cookie']) || !$this->checkBrowserCookie($session['cookie'])){ |
| [1102](#L1102) | // The user doesn't have a valid cookie for this session in their browser. |
| [1103](#L1103) | // Leave the browser cookie for debugging. IOK 2019-10-14 |
| [1104](#L1104) | if ($session) $session->destroy(); |
| [1105](#L1105) | $this->continue\_with\_vipps\_error\_login('invalid\_session', \_\_("Your login session is missing. Ensure that you are accessing this site on a secure link (using HTTPS). Also, ensure that you are not blocking cookies – you will need those to log in.", 'login-with-vipps'), '', $session); |
| [1106](#L1106) | } |
| [1107](#L1107) |  |
| [1108](#L1108) |  |
| [1109](#L1109) | // Check if we allow user registrations |
| [1110](#L1110) | $can\_register = apply\_filters('option\_users\_can\_register', get\_option('users\_can\_register')); |
| [1111](#L1111) | $can\_register = apply\_filters('continue\_with\_vipps\_users\_can\_register', $can\_register, $userinfo, $session); |
| [1112](#L1112) | $can\_register = apply\_filters("continue\_with\_vipps\_{$app}\_users\_can\_register", $can\_register, $userinfo, $session); |
| [1113](#L1113) |  |
| [1114](#L1114) | if (!$user && !$can\_register) { |
| [1115](#L1115) | if($session) $session->destroy(); |
| [1116](#L1116) | $this->deleteBrowserCookie(); |
| [1117](#L1117) |  |
| [1118](#L1118) | $msg = \_\_('Could not find any user with your registered email. Cannot log in.', 'login-with-vipps'); |
| [1119](#L1119) | $msg = apply\_filters('login\_with\_vipps\_invalid\_user\_message', $msg, $userinfo, $session); |
| [1120](#L1120) |  |
| [1121](#L1121) | $this->continue\_with\_vipps\_error\_login('unknown\_user', $msg, '', $session); |
| [1122](#L1122) | exit(); |
| [1123](#L1123) | } |
| [1124](#L1124) |  |
| [1125](#L1125) | // Here we don't have a user, but we are allowed to register, so let's do that |
| [1126](#L1126) | if (!$user) { |
| [1127](#L1127) | $pass = wp\_generate\_password( 32, true); |
| [1128](#L1128) |  |
| [1129](#L1129) | // Fix username here so it's unique, then allow applications to change it |
| [1130](#L1130) | $newusername = apply\_filters('continue\_with\_vipps\_create\_username', $username, $userinfo,$session); |
| [1131](#L1131) | $newusername = apply\_filters("continue\_with\_vipps\_{$app}\_create\_username", $username, $userinfo,$session); |
| [1132](#L1132) | $user\_id = wp\_create\_user( $newusername, $pass, $email); |
| [1133](#L1133) | if (is\_wp\_error($user\_id)) { |
| [1134](#L1134) | if($session) $session->destroy(); |
| [1135](#L1135) | $this->deleteBrowserCookie(); |
| [1136](#L1136) | $this->continue\_with\_vipps\_error\_login('unknown\_user', sprintf(\_\_('Could not create a new user - an error occured: %s', 'login-with-vipps'), esc\_html($user\_id->get\_error\_message())), '', $session); |
| [1137](#L1137) | exit(); |
| [1138](#L1138) | } |
| [1139](#L1139) |  |
| [1140](#L1140) | $userdata = array('ID'=>$user\_id, 'user\_nicename'=>$name, 'display\_name'=>"$firstname $lastname", |
| [1141](#L1141) | 'nickname'=>$firstname, 'first\_name'=>$firstname, 'last\_name'=>$lastname, |
| [1142](#L1142) | 'user\_registered'=>date('Y-m-d H:i:s')); |
| [1143](#L1143) |  |
| [1144](#L1144) | // Allow applications to modify this, or they can use the hook below IOK 2019-10-14 |
| [1145](#L1145) | $userdata = apply\_filters('continue\_with\_vipps\_create\_userdata', $userdata, $userinfo,$session); |
| [1146](#L1146) | $userdata = apply\_filters("continue\_with\_vipps\_{$app}\_create\_userdata", $userdata, $userinfo,$session); |
| [1147](#L1147) |  |
| [1148](#L1148) | wp\_update\_user($userdata); |
| [1149](#L1149) |  |
| [1150](#L1150) | $this->map\_phone\_to\_user($phone, $sub, $user); # This will make logging in use the \*phone\* for the Vipps account instead of the account from now on. |
| [1151](#L1151) | update\_user\_meta($user\_id, '\_vipps\_just\_connected', 1); |
| [1152](#L1152) | // This is currently mostly for Woo, but in general: User has no address, so please update addresses when logging in. IOK 2019-10-25 |
| [1153](#L1153) | update\_user\_meta($user\_id,'\_vipps\_synchronize\_addresses', 1); |
| [1154](#L1154) | $this->log(sprintf(\_\_('%1$s user with phone %2$s just connected to account %3$d during account creation', 'login-with-vipps'), VippsLogin::CompanyName(), $phone, $user\_id)); |
| [1155](#L1155) |  |
| [1156](#L1156) | $user = get\_user\_by('id', $user\_id); |
| [1157](#L1157) |  |
| [1158](#L1158) | // Unfortunately we need this to do the WooCommerce calls correctly that send emails after an account has been created. |
| [1159](#L1159) | $session->set('created\_pw', $pass); |
| [1160](#L1160) | do\_action('continue\_with\_vipps\_after\_create\_user', $user, $session); |
| [1161](#L1161) | do\_action("continue\_with\_vipps\_after\_create\_{$app}\_user", $user, $session); |
| [1162](#L1162) | $session->set('created\_pw', null); |
| [1163](#L1163) |  |
| [1164](#L1164) | $this->actually\_login\_user($user,$sid,$session); |
| [1165](#L1165) | exit(); |
| [1166](#L1166) | } |
| [1167](#L1167) |  |
| [1168](#L1168) | // Allow applications to allow or deny logins for a given user (e.g. to  disallow admin accounts or simila IOK 2019-10-14r) |
| [1169](#L1169) | $allow\_login = true; |
| [1170](#L1170) | $allow\_login = apply\_filters('continue\_with\_vipps\_allow\_login', $allow\_login, $user, $userinfo, $session); |
| [1171](#L1171) | $allow\_login= apply\_filters("continue\_with\_vipps\_{$app}\_allow\_login", $allow\_login, $user,$userinfo,$session); |
| [1172](#L1172) |  |
| [1173](#L1173) | if (!$allow\_login) { |
| [1174](#L1174) | if($session) $session->destroy(); |
| [1175](#L1175) | $this->deleteBrowserCookie(); |
| [1176](#L1176) | $this->continue\_with\_vipps\_error\_login('login\_disallowed', sprintf(\_\_('It is unfortunately not allowed for your account to log-in using %1$s', 'login-with-vipps'), VippsLogin::CompanyName()), '', $session); |
| [1177](#L1177) | exit(); |
| [1178](#L1178) | } |
| [1179](#L1179) |  |
| [1180](#L1180) | // Now, if we were previously mapped, we can log in. Call the "map" function anyway in case we need to do some cleanup (we do, at first). |
| [1181](#L1181) | if ($mapped) { |
| [1182](#L1182) | $this->map\_phone\_to\_user($phone, $sub, $user); |
| [1183](#L1183) | $this->actually\_login\_user($user,$sid,$session); |
| [1184](#L1184) | exit(); |
| [1185](#L1185) | } |
| [1186](#L1186) |  |
| [1187](#L1187) | // We have a user not connected to the Vipps account, but with the same email. However, Vipps accounts are now verified, so unless we explicitly want confirmation, |
| [1188](#L1188) | // we'll just connect the accounts and log right in. IOK 2020-05-27 |
| [1189](#L1189) | // IOK 2021-05-27 No longer in effect as the "user request" API is being limited at WP, and no longer required |
| [1190](#L1190) | // as Vipps does confirm email addresses. |
| [1191](#L1191) | // We'll leave a filter in the short term to allow any users depending on this to find another solution. |
| [1192](#L1192) | $require\_confirmation = apply\_filters('login\_with\_vipps\_require\_email\_confirmation', false); |
| [1193](#L1193) | if (!$require\_confirmation) { |
| [1194](#L1194) | $this->map\_phone\_to\_user($phone, $sub, $user); |
| [1195](#L1195) | update\_user\_meta($user->ID,'\_vipps\_just\_connected', 1); |
| [1196](#L1196) | $this->log(sprintf(\_\_('%1$s user with phone %2$s just connected to account %3$d during login', 'login-with-vipps'), VippsLogin::CompanyName(), $phone, $user->ID)); |
| [1197](#L1197) | $this->actually\_login\_user($user,$sid,$session); |
| [1198](#L1198) | exit(); |
| [1199](#L1199) | } |
| [1200](#L1200) |  |
| [1201](#L1201) | // This branch used to contain a system for having the user confirm their email address as sent by Vipps, which is no longer relevant as Vipps does this. |
| [1202](#L1202) | // It is removed because the user request api is being limited by WP so we can't assume it will continue to work without using internal APIs. so we'll just replace this with a filter (for admins that want to handle this |
| [1203](#L1203) | // in other ways) and an error message. |
| [1204](#L1204) | if($session) $session->destroy(); |
| [1205](#L1205) | $this->deleteBrowserCookie(); |
| [1206](#L1206) | $handled = apply\_filters('login\_with\_vipps\_handle\_email\_confirmation', false, $user, $session); |
| [1207](#L1207) | if (!$handled) { |
| [1208](#L1208) | $this->continue\_with\_vipps\_error\_login('login\_disallowed', sprintf(\_\_('You need to confirm your email account before Login with %1$s can be used. Login to your account normally and connect with %1$s on your user page, or contact the site admin', 'login-with-vipps'), $this->get\_login\_method()), '', $session); |
| [1209](#L1209) | } |
| [1210](#L1210) | exit(); |
| [1211](#L1211) | } |
| [1212](#L1212) |  |
| [1213](#L1213) | // Errorhandling for confirming account connection. This will happen on the profile page, so it is a bit easier. IOK 2019-10-14 |
| [1214](#L1214) | public function continue\_with\_vipps\_error\_confirm($error,$errordesc,$error\_hint='',$sessiondata=array()) { |
| [1215](#L1215) | $userid = get\_current\_user\_id(); |
| [1216](#L1216) | if (!$userid) wp\_die(\_\_('You must be logged in to confirm your account', 'login-with-vipps')); |
| [1217](#L1217) | $redir = get\_edit\_user\_link($userid); |
| [1218](#L1218) | $app = sanitize\_title(($sessiondata && isset($sessiondata['application'])) ? $sessiondata['application'] : 'wordpress'); |
| [1219](#L1219) | $referer = ($sessiondata && isset($sessiondata['referer'])) ? $sessiondata['referer'] : ''; |
| [1220](#L1220) |  |
| [1221](#L1221) | // Override error page redirect for your application. No access to the possible new session. IOK 2019-10-08 |
| [1222](#L1222) | $redir = apply\_filters('continue\_with\_vipps\_error\_confirm\_redirect', $redir, $error, $sessiondata); |
| [1223](#L1223) | $redir = apply\_filters("continue\_with\_vipps\_error\_{$app}\_confirm\_redirect", $redir, $error, $sessiondata); |
| [1224](#L1224) |  |
| [1225](#L1225) | do\_action("continue\_with\_vipps\_error\_{$app}\_confirm", $error, $errordesc, $error\_hint, $sessiondata); |
| [1226](#L1226) |  |
| [1227](#L1227) | wp\_safe\_redirect($redir); |
| [1228](#L1228) | exit(); |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | // This stores the error-messages temporarily in a transient keyed with the users' cookie. They can then be displayed on the profile page after reloads. IOK 2019-10-14 |
| [1232](#L1232) | public function continue\_with\_vipps\_error\_wordpress\_confirm ($error, $errordesc, $errorhint, $sessiondata) { |
| [1233](#L1233) | // Cannot  use the 'store\_admin\_notices' of ContinueWithVipps here, because it breaks Woocommerce which will not have been loaded yet - so we inline it. IOK 2019-10-14 |
| [1234](#L1234) | $cookie = sanitize\_text\_field(@$\_COOKIE[LOGGED\_IN\_COOKIE]); |
| [1235](#L1235) | if (!$cookie) return; |
| [1236](#L1236) | $cookiehash =  hash('sha256',$cookie,false); |
| [1237](#L1237) | $notices = "<div class='notice notice-error is-dismissible'><p>" . sprintf(\_\_('Could not connect to your %1$s profile: ', 'login-with-vipps'), VippsLogin::CompanyName()) . esc\_html($errordesc) . "<p></div>"; |
| [1238](#L1238) | set\_transient('\_vipps\_login\_save\_admin\_notices\_' . $cookiehash,$notices, 5\*60); |
| [1239](#L1239) | } |
| [1240](#L1240) |  |
| [1241](#L1241) | // Main handler for confirming your accounts connection with Vipps. IOK 2019-10-14. |
| [1242](#L1242) | public function continue\_with\_vipps\_confirm($userinfo,$session) { |
| [1243](#L1243) | if (!is\_user\_logged\_in()) { |
| [1244](#L1244) | $this->deleteBrowserCookie(); |
| [1245](#L1245) | if ($session) $session->destroy(); |
| [1246](#L1246) | wp\_die(\_\_('This can only be called when logged in', 'login-with-vipps')); |
| [1247](#L1247) | } |
| [1248](#L1248) | $app = sanitize\_title(($session && isset($session['application'])) ? $session['application'] : 'wordpress'); |
| [1249](#L1249) |  |
| [1250](#L1250) | $userid = get\_current\_user\_id(); |
| [1251](#L1251) | $profile = get\_edit\_user\_link($userid); |
| [1252](#L1252) | $redir = apply\_filters('continue\_with\_vipps\_confirm\_redirect', $profile, $userid, $session); |
| [1253](#L1253) | $redir = apply\_filters("continue\_with\_vipps\_{$app}\_confirm\_redirect", $redir , $userid, $session); |
| [1254](#L1254) |  |
| [1255](#L1255) | if (!$userinfo) { |
| [1256](#L1256) | $this->deleteBrowserCookie(); |
| [1257](#L1257) | if ($session) $session->destroy(); |
| [1258](#L1258) | wp\_safe\_redirect($redir); |
| [1259](#L1259) | exit(); |
| [1260](#L1260) | } |
| [1261](#L1261) |  |
| [1262](#L1262) | $email = $userinfo['email']; |
| [1263](#L1263) | $phone =  sanitize\_text\_field($userinfo['phone\_number']); |
| [1264](#L1264) | $sub =  sanitize\_text\_field($userinfo['sub']); |
| [1265](#L1265) | // $sid=  $userinfo['sid']; |
| [1266](#L1266) | $sid = 'no\_longer\_relevant'; // IOK 2021-03-23 SID no longer avaiable from $userinfo. |
| [1267](#L1267) | $user = get\_user\_by('id', $userid); |
| [1268](#L1268) |  |
| [1269](#L1269) | // By default we will only allow 'new' connections where the verified Vipps email address is the same |
| [1270](#L1270) | // as the account email. This is to be completely sure this can't be gamed. We may relieve this constraint |
| [1271](#L1271) | // in time, and we allow a filter to change the constraint for developers with specific needs. IOK 2022-04-04 |
| [1272](#L1272) | $ok = $user->user\_email == $email; |
| [1273](#L1273) | $ok = apply\_filters('login\_with\_vipps\_allow\_connection', $ok, $user, $userinfo); |
| [1274](#L1274) | if (!$ok) { |
| [1275](#L1275) | if($session) $session->destroy(); |
| [1276](#L1276) | $this->deleteBrowserCookie(); |
| [1277](#L1277) | $sorrymessage = apply\_filters('login\_with\_vipps\_cannot\_connect\_message', sprintf(\_\_('Unfortunately, you cannot connect to this %1$s-profile: The email addresses are not the same.', 'login-with-vipps'), VippsLogin::CompanyName()), $user, $userinfo); |
| [1278](#L1278) | $this->continue\_with\_vipps\_error\_confirm('wrong\_user', $sorrymessage, '', $session); |
| [1279](#L1279) | exit(); |
| [1280](#L1280) | } |
| [1281](#L1281) | // Actually connect user to phone/sub here |
| [1282](#L1282) | $this->map\_phone\_to\_user($phone, $sub, $user); |
| [1283](#L1283) | update\_user\_meta($userid, '\_vipps\_just\_connected', 1); |
| [1284](#L1284) | $this->log(sprintf(\_\_('%1$s user with phone %2$s just connected to account %1$d', 'login-with-vipps'), VippsLogin::CompanyName(), $phone, $userid)); |
| [1285](#L1285) |  |
| [1286](#L1286) | do\_action("continue\_with\_vipps\_{$app}\_confirm\_before\_redirect", $userid, $userinfo, $session); |
| [1287](#L1287) |  |
| [1288](#L1288) | $this->deleteBrowserCookie(); |
| [1289](#L1289) | if ($session) $session->destroy(); |
| [1290](#L1290) | wp\_safe\_redirect($redir); |
| [1291](#L1291) | exit(); |
| [1292](#L1292) |  |
| [1293](#L1293) | } |
| [1294](#L1294) |  |
| [1295](#L1295) | // This handler runs when normal logins need to be confirmed with Vipps. It is \*only\* called from "authenticate" after the user is verified, so we know that the userid in the |
| [1296](#L1296) | // session is good. Therefore we will just log right in.  If there are other MFA applications active, they may cause an interesting loop at this point, so probably don't do that. |
| [1297](#L1297) | //  IOK 2019-10-14. |
| [1298](#L1298) | public function continue\_with\_vipps\_confirm\_login ($userinfo,$session) { |
| [1299](#L1299) |  |
| [1300](#L1300) | $userid = $session['uid']; |
| [1301](#L1301) | $user = new WP\_User($userid); |
| [1302](#L1302) | $referer = $session['referer']; |
| [1303](#L1303) | if (!$userinfo) { |
| [1304](#L1304) | $this->deleteBrowserCookie(); |
| [1305](#L1305) | if ($session) $session->destroy(); |
| [1306](#L1306) | $msg = \_\_('Not a valid user', 'login-with-vipps'); |
| [1307](#L1307) | wp\_die($msg); |
| [1308](#L1308) | exit(); |
| [1309](#L1309) | } |
| [1310](#L1310) | if (!$user || is\_wp\_error($user)) { |
| [1311](#L1311) | $this->deleteBrowserCookie(); |
| [1312](#L1312) | if ($session) $session->destroy(); |
| [1313](#L1313) | $msg = \_\_('Not a valid user', 'login-with-vipps'); |
| [1314](#L1314) | if (is\_wp\_error($user)) $msg .= "<br>" . $user->get\_error\_message(); |
| [1315](#L1315) | wp\_die($msg); |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | $email = $userinfo['email']; |
| [1319](#L1319) | // $sid=  $userinfo['sid']; |
| [1320](#L1320) | $sid = 'no\_longer\_relevant'; // IOK 2021-03-23 SID no longer avaiable from $userinfo. |
| [1321](#L1321) | $phone =  $userinfo['phone\_number']; |
| [1322](#L1322) | $sub =  $userinfo['sub']; |
| [1323](#L1323) |  |
| [1324](#L1324) | // First, see if we have this user already mapped |
| [1325](#L1325) | $mapped = false; |
| [1326](#L1326) | $verifieduser = $this->get\_user\_by\_vipps\_creds($phone, $sub); |
| [1327](#L1327) | if ($verifieduser) { |
| [1328](#L1328) | $mapped = true; |
| [1329](#L1329) | } else  { |
| [1330](#L1330) | // Else, use  the verified email address to retrieve the user |
| [1331](#L1331) | $mapped = false; |
| [1332](#L1332) | if (intval($userinfo['email\_verified'])) { |
| [1333](#L1333) | $verifieduser = get\_user\_by('email',$email); |
| [1334](#L1334) | } |
| [1335](#L1335) | } |
| [1336](#L1336) | // Allow a filter to find the user for special applications (phone number as username etc etc) |
| [1337](#L1337) | $verifieduser = apply\_filters( 'login\_with\_vipps\_authenticate\_user', $verifieduser, $userinfo, $session); |
| [1338](#L1338) |  |
| [1339](#L1339) | if ($verifieduser && $verifieduser->ID != $userid) { |
| [1340](#L1340) | if($session) $session->destroy(); |
| [1341](#L1341) | $this->deleteBrowserCookie(); |
| [1342](#L1342) | $sorrytext  = sprintf(\_\_('Login not confirmed: This user is not the user mapped to the %1$s account, and does not have the same email account', 'login-with-vipps'), VippsLogin::CompanyName()); |
| [1343](#L1343) | $sorrytext = apply\_filters('login\_with\_vipps\_confirm\_login\_wrong\_usertext', $sorrytext, wp\_get\_current\_user(), $userinfo, $session); |
| [1344](#L1344) | return $this->continue\_with\_vipps\_error\_confirm\_login('wrong\_user', $sorrytext); |
| [1345](#L1345) | } |
| [1346](#L1346) | $this->deleteBrowserCookie(); |
| [1347](#L1347) | if ($session) $session->destroy(); |
| [1348](#L1348) |  |
| [1349](#L1349) | $this->map\_phone\_to\_user($phone, $sub, $user);  // Map the user to the Vipps account just in case. |
| [1350](#L1350) | $this->actually\_login\_user($user,$sid,$session); |
| [1351](#L1351) | } |
| [1352](#L1352) |  |
| [1353](#L1353) | // The error handling punts a bit: Just print the referer and exit. |
| [1354](#L1354) | public function continue\_with\_vipps\_error\_confirm\_login ($error,$errordesc,$error\_hint='',$sessiondata=array()) { |
| [1355](#L1355) | $origin = $sessiondata['referer']; |
| [1356](#L1356) | if (!$origin) $origin = wp\_login\_url(); |
| [1357](#L1357) | $message .= "<h2>" . sprint(\_\_('Cannot log in: It is required for this account to verify login with the %1$s app', 'login-with-vipps'), VippsLogin::CompanyName()) . "</h2>"; |
| [1358](#L1358) | $message .= "<p>" . "<b>" . esc\_html($error) . "<b>: " .  esc\_html($errordesc) . "</p>"; |
| [1359](#L1359) | $message .= "<p>" . sprintf(\_\_("<a href='%s'>Return to your previous page</a> to try again</a>", 'login-with-vipps'), esc\_attr($origin)) . "</p>"; |
| [1360](#L1360) | wp\_die($message); |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | // Very much like for confirmation, this handles errors for the action that marks the account to be synched with Vipps as to addressinfo etc. IOK 2019-10-14 |
| [1364](#L1364) | public function continue\_with\_vipps\_error\_synch($error,$errordesc,$error\_hint='',$sessiondata=array()) { |
| [1365](#L1365) | $userid = get\_current\_user\_id(); |
| [1366](#L1366) | if (!$userid) wp\_die(\_\_('You must be logged in to synchronise your account', 'login-with-vipps')); |
| [1367](#L1367) | $redir = get\_edit\_user\_link($userid); |
| [1368](#L1368) | $app = sanitize\_title(($sessiondata && isset($sessiondata['application'])) ? $sessiondata['application'] : 'wordpress'); |
| [1369](#L1369) | $referer = ($sessiondata && isset($sessiondata['referer'])) ? $sessiondata['referer'] : ''; |
| [1370](#L1370) |  |
| [1371](#L1371) | // Override error page redirect for your application. No access to the possible new session. IOK 2019-10-08 |
| [1372](#L1372) | $redir = apply\_filters('continue\_with\_vipps\_error\_synch\_redirect', $redir, $error, $sessiondata); |
| [1373](#L1373) | $redir = apply\_filters("continue\_with\_vipps\_error\_{$app}\_synch\_redirect", $redir, $error, $sessiondata); |
| [1374](#L1374) | do\_action("continue\_with\_vipps\_error\_{$app}\_synch", $error, $errordesc, $error\_hint, $sessiondata); |
| [1375](#L1375) | wp\_safe\_redirect($redir); |
| [1376](#L1376) | exit(); |
| [1377](#L1377) | } |
| [1378](#L1378) | // Again, errors to the wordpress proflepage. IOK 2019-10-14 |
| [1379](#L1379) | public function continue\_with\_vipps\_error\_wordpress\_synch ($error, $errordesc, $errorhint, $sessiondata) { |
| [1380](#L1380) | // Cannot  use the 'store\_admin\_notices' of ContinueWithVipps here, because it breaks Woocommerce which will not have been loaded yet |
| [1381](#L1381) | $cookie = sanitize\_text\_field(@$\_COOKIE[LOGGED\_IN\_COOKIE]); |
| [1382](#L1382) | if (!$cookie) return; |
| [1383](#L1383) | $cookiehash =  hash('sha256',$cookie,false); |
| [1384](#L1384) | $notices = "<div class='notice notice-error is-dismissible'><p>" . sprintf(\_\_('Could not synchronize your %1$s profile: ', 'login-with-vipps'), VippsLogin::CompanyName()) . esc\_html($errordesc) . "<p></div>"; |
| [1385](#L1385) | set\_transient('\_vipps\_login\_save\_admin\_notices\_' . $cookiehash,$notices, 5\*60); |
| [1386](#L1386) | } |
| [1387](#L1387) |  |
| [1388](#L1388) | // This handler marks the users so that we know that at every login, we want to synchronize address info etc from Vipps to Wordrpess. Mostly used for Woocommerce, so see the VippsWooLogin class. IOK 2019-10-14 |
| [1389](#L1389) | public function continue\_with\_vipps\_synch($userinfo,$session) { |
| [1390](#L1390) | if (!is\_user\_logged\_in()) { |
| [1391](#L1391) | $this->deleteBrowserCookie(); |
| [1392](#L1392) | if ($session) $session->destroy(); |
| [1393](#L1393) | wp\_die(\_\_('This can only be called when logged in', 'login-with-vipps')); |
| [1394](#L1394) | } |
| [1395](#L1395) | if (!$userinfo) { |
| [1396](#L1396) | $this->deleteBrowserCookie(); |
| [1397](#L1397) | if ($session) $session->destroy(); |
| [1398](#L1398) | wp\_safe\_redirect($redir); |
| [1399](#L1399) | exit(); |
| [1400](#L1400) | } |
| [1401](#L1401) | $userid = get\_current\_user\_id(); |
| [1402](#L1402) | update\_user\_meta($userid,'\_vipps\_synchronize\_addresses', 1); |
| [1403](#L1403) | update\_user\_meta($userid,'\_vipps\_just\_synched', 1); |
| [1404](#L1404) |  |
| [1405](#L1405) | $app = sanitize\_title(($session && isset($session['application'])) ? $session['application'] : 'wordpress'); |
| [1406](#L1406) | do\_action("continue\_with\_vipps\_{$app}\_synch",$userid,$userinfo,$session); |
| [1407](#L1407) |  |
| [1408](#L1408) |  |
| [1409](#L1409) | $profile = get\_edit\_user\_link($userid); |
| [1410](#L1410) | $redir = $profile; |
| [1411](#L1411) | if (isset($sessiondata['referer']) && $sessiondata['referer']) { |
| [1412](#L1412) | $link = $sessiondata['referer']; |
| [1413](#L1413) | } |
| [1414](#L1414) | $userid = get\_current\_user\_id(); |
| [1415](#L1415) | $redir = apply\_filters('continue\_with\_vipps\_synch\_redirect', $profile, $userid, $session); |
| [1416](#L1416) | $redir = apply\_filters("continue\_with\_vipps\_{$app}\_synch\_redirect", $redir , $userid, $session); |
| [1417](#L1417) | $this->deleteBrowserCookie(); |
| [1418](#L1418) | if ($session) $session->destroy(); |
| [1419](#L1419) | wp\_safe\_redirect($redir); |
| [1420](#L1420) | exit(); |
| [1421](#L1421) | } |
| [1422](#L1422) |  |
| [1423](#L1423) |  |
| [1424](#L1424) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/login-with-vipps/tags/1.3.3/VippsLogin.class.php?format=txt)
* [Original Format](/export/3222481/login-with-vipps/tags/1.3.3/VippsLogin.class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_9f658a41_20250114_213721.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Login with Vipps and MobilePay <= 1.3.3 - Authenticated (Contributor+) Stored Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Login with Vipps and MobilePay <= 1.3.3 - Authenticated (Contributor+) Stored Cross-Site Scripting

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-11786](https://www.cve.org/CVERecord?id=CVE-2024-11786) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | November 27, 2024 |
| Last Updated | November 28, 2024 |
| Researcher | [Peter Thaleikis](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/spek) |

### Description

The Login with Vipps and MobilePay plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the plugin's 'continue-with-vipps' shortcode in all versions up to, and including, 1.3.3 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers, with contributor-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/login-with-vipps/tags/1.3.3/VippsLogin.class.php#L724)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3197620/login-with-vipps/trunk/VippsLogin.class.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flogin-with-vipps%2Flogin-with-vipps-and-mobilepay-133-authenticated-contributor-stored-cross-site-scripting&t=Login%20with%20Vipps%20and%20MobilePay%20%3C%3D%201.3.3%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flogin-with-vipps%2Flogin-with-vipps-and-mobilepay-133-authenticated-contributor-stored-cross-site-scripting&text=Login%20with%20Vipps%20and%20MobilePay%20%3C%3D%201.3.3%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flogin-with-vipps%2Flogin-with-vipps-and-mobilepay-133-authenticated-contributor-stored-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for Login with Vipps and MobilePay

#### [Login with Vipps and MobilePay](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/login-with-vipps)

| Software Type | Plugin |
| --- | --- |
| Software Slug | login-with-vipps [(view on wordpress.org)](https://wordpress.org/plugins/login-with-vipps) |
| Patched? | Yes |
| Remediation | Update to version 1.3.4, or a newer patched version |
| Affected Version | * <= 1.3.3 |
| Patched Version | * 1.3.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_6b3cddac_20250114_213719.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3197620%2Flogin-with-vipps%2Ftrunk%2FVippsLogin.class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3186435/login-with-vipps/trunk/VippsLogin.class.php "Changeset 3186435 for login-with-vipps/trunk/VippsLogin.class.php")
* [Next Change](/changeset/3200694/login-with-vipps/trunk/VippsLogin.class.php "Changeset 3200694 for login-with-vipps/trunk/VippsLogin.class.php") →

---

# Changeset [3197620](/changeset/3197620 "Show full changeset") for [login-with-vipps/trunk/VippsLogin.class.php](/browser/login-with-vipps/trunk/VippsLogin.class.php?rev=3197620 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/26/2024 05:47:16 PM
([7 weeks](/timeline?from=2024-11-26T17%3A47%3A16Z&precision=second "See timeline at 11/26/2024 05:47:16 PM") ago)

Author:
wphostingdev
Message:

1.3.4

File:

1 edited

* [login-with-vipps/trunk/VippsLogin.class.php](/browser/login-with-vipps/trunk/VippsLogin.class.php?rev=3197620 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [login-with-vipps/trunk/VippsLogin.class.php](/changeset/3197620/login-with-vipps/trunk/VippsLogin.class.php "Show the changeset 3197620 restricted to login-with-vipps/trunk/VippsLogin.class.php")

  | [r3186435](/browser/login-with-vipps/trunk/VippsLogin.class.php?rev=3186435#L720 "Show revision 3186435 of this file in browser") | [r3197620](/browser/login-with-vipps/trunk/VippsLogin.class.php?rev=3197620#L720 "Show revision 3197620 of this file in browser") |  |
  | --- | --- | --- |
  | 720 | 720 | $logo = $this->get\_transparent\_logo(); |
  | 721 | 721 | $bg = $this->get\_background\_class(); |
  |  | 722 | // The "application" should only contain letters, numbers and hyphens. IOK 2024-11-26 |
  |  | 723 | $application = preg\_replace("![^a-zA-Z0-9-\_]!", "", $application); |
  | 722 | 724 | ob\_start(); |
  | 723 | 725 | ?> |
  | 724 |  | <a href='javascript:login\_with\_vipps("<?php echo $application; ?>");' class="button vipps-orange vipps-button continue-with-vipps <?php echo ~~$bg;?>" title="<?php echo sprintf("%s %s", $text, $login\_method); ?>"><?php echo $text~~;?> <img |
  | 725 |  | alt="<?php ~~printf(\_\_('Log in without password using %1$s', 'login-with-vipps'), $login\_method); ?>" src="<?php echo $logo~~; ?>">!</a> |
  |  | 726 | <a href='javascript:login\_with\_vipps("<?php echo $application; ?>");' class="button vipps-orange vipps-button continue-with-vipps <?php echo esc\_attr($bg);?>" title="<?php echo esc\_attr(sprintf("%s %s", $text, $login\_method)); ?>"><?php echo esc\_html($text);?> <img |
  |  | 727 | alt="<?php echo esc\_attr(sprintf(\_\_('Log in without password using %1$s', 'login-with-vipps'), $login\_method)); ?>" src="<?php echo esc\_attr($logo); ?>">!</a> |
  | 726 | 728 | <?php |
  | 727 | 729 | echo apply\_filters('continue\_with\_vipps\_login\_button\_html', ob\_get\_clean(), $application, $text); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3197620)
* [Zip Archive](?format=zip&new=3197620)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


