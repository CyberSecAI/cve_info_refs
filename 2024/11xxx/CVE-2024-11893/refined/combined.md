=== Content from wordpress.org_8e989263_20250115_102922.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

Spoki – Chat Buttons and WooCommerce Notifications

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fspoki&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fspoki&locale=en_US)

Search plugins

![](https://ps.w.org/spoki/assets/banner-772x250.png?rev=2545162)
![](https://ps.w.org/spoki/assets/icon-256x256.gif?rev=2523539)
# Spoki – Chat Buttons and WooCommerce Notifications

By [NextAI Srl](https://spoki.it)

[Download](https://downloads.wordpress.org/plugin/spoki.2.15.16.zip)

* [Details](https://wordpress.org/plugins/spoki/#description)
* [Reviews](https://wordpress.org/plugins/spoki/#reviews)
* [Installation](https://wordpress.org/plugins/spoki/#installation)
* [Development](https://wordpress.org/plugins/spoki/#developers)

[Support](https://wordpress.org/support/plugin/spoki/)

## Description

**Increase your sales with Spoki plugin!**

**Spoki allow to add WhatsApp button chat on your web-site, send order notifications and recovery cart using WhatsApp**

### With Spoki you can:

* 🛒 Recover Abandoned Carts sending notifications massage via WhatsApp
* 💬 Send multilanguage WooCommerce notifications via WhatsApp to your customers
* 🖥 Insert the Whatsapp Floating Button on your website
* 🛍 Insert Whatsapp Chat Buttons For WooCommerce (Shop page, Product page, Cart page)

[Demo](https://woocommerce.spoki.it/) | [What is Spoki?](https://spoki.it/spoki-flex/) | [Support](https://api.whatsapp.com/send/?phone=393666989618&text=Hi%20Spoki,%20I%20need%20info%20about%20Spoki%20Plugin.)

### 🚀 The advantages of using Spoki in your Business

Spoki gives you the ability to:

* Increase your sales recovering the Abandoned Cart
* Spoki notify you about the presence of abandoned carts in your WordPress store
* Communicate quickly and directly with your customers via WhatsApp
* Be on the most used communication channel in the world
* Achieve a competitive advantage over your competitors who use less user friendly communication channels
* Insert different chat buttons within your site
* Make your customer’s shopping experience more immersive and engaging
* Use a more efficient communication channel than traditional ones (SMS, Email, …)
* Reach message open rates close to 100%
* Interact more easily with your customers
* No account activation costs

### 🛒 Recovery Cart

Spoki notify you about the presence of abandoned carts in your WordPress store and send automatic reminder on cus-tomers’ WhatsApp to complete order.

Spoki plugin allow you to:

– Track: orders, customer names and WhatsApp Number, as soon as they’re entered at checkout

– Send automatic notification recovery message, to your customer, via WhatsApp

– Notify: you will be notified by email when purchase is complete

– Easy to use

– Track abandoned carts and configure automatic recov-ery WhatsApp message to be sent to potential custom-ers.

– Use Official API WhatsApp

When a user adds a product to the cart but does not check out.

After a selected time (15’, for example) the cart will be tag as “abandoned”. Spoki will capture the cart information as: cart date, customer email address, WhatsApp number, cart items, price.

You could use this info to contact the customer via WhatsApp end request him/her to complete check out.

If the purchase is not completed within 15 minutes, it starts sending an automated message to your customer on WhatsApp.

The recovery message includes: page checkout link, text message for remind to complete the purchase, item added to cart items, price.

### 💬 Send WooCommerce notifications via WhatsApp

With the Spoki Plugin you can send order status notifications to your customers on WhatsApp!

Spoki is the WordPress plugin that uses the official WhatsApp Business API to:

* automatically send updates on the status of the order
* notify the tracking number via a note to the customer

### What Spoki can do for you 💡

💥 Spoki helps you make communications with your customers faster and more direct through Spoki Flex plans!

🔁 With Spoki you can **send notifications on the status of the order** directly to your customer’s **WhatsApp** number, inform them about **order status updates** or send notifications regarding the **tracking number** via an order note to the customer.

💥 **You will be able to manage 10 free contacts every month**

Each month Spoki will allow you to manage 10 free contacts per month.

[See the plans](https://spoki.it/pricing/)

💥 **No activation fee**

You will not be charged any account activation fees to use Spoki

💥 **Personalize your messages**

✏️ With Spoki each order notification message sent to your customer will contain:

✅ the name of your store

🏷 the number of the order placed

💻 the support link to contact in case of assistance

📞 the WhatsApp number to use in case of assistance

### 💬 Insert chat buttons

💬 You can install fixed WhatsApp chat buttons on your website, on the product page and in the product list, thus encouraging interaction with the user in specific moments of their purchase journey.

### 🖥 Fixed Whatsapp Chat Button

➡️ Create standard messages to be inserted within the fixed chat buttons and make it easier for your customers to interact with your company.

➡️ With fixed chat buttons you decide which message to receive from your customer!

➡️ You can insert a chat button within each page of your website and always be available for your customers!

*ex. “Hello, I need some information”*

### 🛍 Free Whatsapp Button For WooCommerce

### 📄 WHATSAPP SHOP BUTTON

➡️ You can insert the WhatsApp chat button in the product list.

➡️ Once the user wants to interact with you, you will receive the message requesting information on your personal chat, with the page references (LINK).

*ex. “Hello I would like more information about this product [Link Page]”*

### 🛍 WHATSAPP PRODUCT BUTTON

➡️ You can insert a WhatsApp button within each product sheet to encourage interaction.

➡️ When a user sends you a message (which you will receive on your personal number) you will also receive the link of the page and the product code, so you always have the situation under control.

*ex. “Hello I would like to know the delivery times on this product [Link] and [Product identification ID]”*

### 🛒 WHATSAPP CART BUTTON

Add WhatsApp button on cart page and increase your sales!

➡️ You can insert a WhatsApp button in the cart page

➡️ When a user sends you a message (which you will receive on your personal number) you will receive the products code, products name, quantity, price and link.,

*ex. “Hello I would like to know the delivery times on this product [Product Name, ID, Price, Quantity, Link]”*

### How to Install Spoki 🔍

✔️ Download the Spoki plugin – Install and activate it

✔️ Enter your WhatsApp number

✔️ Select which automatic notification messages to send (e.g. updated order, completed order, tracking number, …)

✔️ Activate the WhatsApp chat buttons

### Why choose Spoki 🤩

* Recover abandoned carts
* Increase sales
* Receive messages on your WhatsApp number
* Use Official WhatsApp APIs
* Ready to use (configurable in less than 1 minute)
* Free WhatsApp floating button
* WooCommerce buttons
* Customize messages and CTA
* Send order status notifications automatically via WhatsApp
* Send unlimited messages to your customers
* Multilingual notifications
* Test order status notifications button
* 100% compatible with WooCommerce

### FAQ ❓

**What number will my customers write to by clicking on the fixed WhatsApp chat button?**

If your customers click on the fixed chat button on your site, they will send a message directly to the WhatsApp number you have selected

## Screenshots

* [![](https://ps.w.org/spoki/assets/screenshot-1.png?rev=2549110)](https://ps.w.org/spoki/assets/screenshot-1.png?rev=2549110)

  WhatsApp floating button | Website
* [![](https://ps.w.org/spoki/assets/screenshot-2.png?rev=2549110)](https://ps.w.org/spoki/assets/screenshot-2.png?rev=2549110)

  WhatsApp buttons | Website Shop Page
* [![](https://ps.w.org/spoki/assets/screenshot-3.png?rev=2549110)](https://ps.w.org/spoki/assets/screenshot-3.png?rev=2549110)

  WhatsApp button | Website Product Page
* [![](https://ps.w.org/spoki/assets/screenshot-4.png?rev=2549110)](https://ps.w.org/spoki/assets/screenshot-4.png?rev=2549110)

  WhatsApp button | Website Cart Page
* [![](https://ps.w.org/spoki/assets/screenshot-5.png?rev=2610481)](https://ps.w.org/spoki/assets/screenshot-5.png?rev=2610481)

  Statistics
* [![](https://ps.w.org/spoki/assets/screenshot-6.png?rev=2679781)](https://ps.w.org/spoki/assets/screenshot-6.png?rev=2679781)

  Floating Button
* [![](https://ps.w.org/spoki/assets/screenshot-7.png?rev=2679781)](https://ps.w.org/spoki/assets/screenshot-7.png?rev=2679781)

  Shortcode Button
* [![](https://ps.w.org/spoki/assets/screenshot-8.png?rev=2574088)](https://ps.w.org/spoki/assets/screenshot-8.png?rev=2574088)

  Customer Notifications
* [![](https://ps.w.org/spoki/assets/screenshot-9.png?rev=2610481)](https://ps.w.org/spoki/assets/screenshot-9.png?rev=2610481)

  Abandoned Carts Settings
* [![](https://ps.w.org/spoki/assets/screenshot-10.png?rev=2610481)](https://ps.w.org/spoki/assets/screenshot-10.png?rev=2610481)

  Resend Abandoned Carts
* [![](https://ps.w.org/spoki/assets/screenshot-11.png?rev=2610481)](https://ps.w.org/spoki/assets/screenshot-11.png?rev=2610481)

  Seller Notifications
* [![](https://ps.w.org/spoki/assets/screenshot-12.png?rev=2679781)](https://ps.w.org/spoki/assets/screenshot-12.png?rev=2679781)

  Shop Page
* [![](https://ps.w.org/spoki/assets/screenshot-13.png?rev=2679781)](https://ps.w.org/spoki/assets/screenshot-13.png?rev=2679781)

  Product Page
* [![](https://ps.w.org/spoki/assets/screenshot-14.png?rev=2679781)](https://ps.w.org/spoki/assets/screenshot-14.png?rev=2679781)

  Cart Page
* [![](https://ps.w.org/spoki/assets/screenshot-15.png?rev=2610481)](https://ps.w.org/spoki/assets/screenshot-15.png?rev=2610481)

  QR Code
* [![](https://ps.w.org/spoki/assets/screenshot-16.png?rev=2679781)](https://ps.w.org/spoki/assets/screenshot-16.png?rev=2679781)

  Elementor
* [![](https://ps.w.org/spoki/assets/screenshot-17.png?rev=2679781)](https://ps.w.org/spoki/assets/screenshot-17.png?rev=2679781)

  Settings
* [![](https://ps.w.org/spoki/assets/screenshot-18.png?rev=2610481)](https://ps.w.org/spoki/assets/screenshot-18.png?rev=2610481)

  Send From Your Number
* [![](https://ps.w.org/spoki/assets/screenshot-19.png?rev=2617051)](https://ps.w.org/spoki/assets/screenshot-19.png?rev=2617051)

  Invite a friend

## Installation

1. Upload the plugin files to the `/wp-content/plugins/plugin-name` directory, or install the plugin through the WordPress plugins screen directly.
2. Activate the plugin through the `Plugins` screen in WordPress.
3. Select the order status messages you want to send to your customers.
4. Spoki will automatically communicate with WooCommerce and, based on the status of the order, will send the message to your customer with its number. The message will contain the number of the order placed, the name of the store and the references of the store in case of a request for support.

## Reviews

![](https://secure.gravatar.com/avatar/446a9085a1398897ea8c1ebb43e863c9b5415d331fed4121bb22999cc91e3afe?s=60&d=retro&r=g)
### [Great whatsapp order plugin](https://wordpress.org/support/topic/great-whatsapp-order-plugin/)

[genieqatar](https://profiles.wordpress.org/genieqatar/ "Posts by genieqatar")
October 12, 2021

Awesome features and updates are recieving frequently thanks a lot

![](https://secure.gravatar.com/avatar/8a348ee23ebf865e786a96195068bfb430bcc28dbc809aa3a810c5a201ade773?s=60&d=retro&r=g)
### [Finally a WhatsApp button for Elementor!](https://wordpress.org/support/topic/finally-a-whatsapp-button-for-elementor/)

[manu8904](https://profiles.wordpress.org/manu8904/ "Posts by manu8904")
August 6, 2021

This plugin is huge! I can quickly insert WhatsApp button on my website with Elementor and see the statistics of the clicks! I also love the automated WhatsApp notifications for WooCommerce! Highly recommended!

![](https://secure.gravatar.com/avatar/c9dde4e6ce03e232e97f19523bc7af3d35cc443b7628b949ef0d5bb65d4d9081?s=60&d=retro&r=g)
### [The best WhatsApp plugin I ever used](https://wordpress.org/support/topic/the-best-whatsapp-plugin-i-ever-used/)

[salvatorecorsa](https://profiles.wordpress.org/salvatorecorsa/ "Posts by salvatorecorsa")
July 22, 2021

Thank to spoki I improved my e-commerce service. Customers are happy to receive notifications about their orders. I’ve also recovered some orders thank to the abandoned carts service.
Try it and you’ll never get back

![](https://secure.gravatar.com/avatar/3632331707bfb3c5bac40a1ab7bfa3949c1fe5eeb3d910953772dfe445843bae?s=60&d=retro&r=g)
### [Straordinario!](https://wordpress.org/support/topic/straordinario-3/)

[manuelbua](https://profiles.wordpress.org/manuelbua/ "Posts by manuelbua")
July 8, 2021

Semplicemente straordinario! Il plugin è davvero unico, lo abbiamo installato sul nostro sito non appena uscito perché sappiamo quanto sia importante comunicare con i nostri clienti e Spoki è stata la soluzione ideale per la nostra azienda. Ti permette di gestire al meglio il post acquisto tramite WhatsApp inviando il riepilogo dell’ordine e altri messaggi in maniera automatica, ha inoltre anche tantissime altre funzionalità come la gestione dei carrelli abbandonati (importantissima), le notifiche al venditore, la possibilità di inserire live chat e molto altro ancora. Se vuoi davvero ottenere il massimo puoi passare anche alla versione pro e personalizzare tutto. Davvero eccezionale. Per finire il servizio clienti e tutto lo staff sono sempre presenti, cortesi e molto in gamba, pronti a risolvere ogni problema. Consigliatissimo!

![](https://secure.gravatar.com/avatar/9036a6d7990bd7effa11fff386688132534a76e3bd4a9c58c86a978c7ebfba3d?s=60&d=retro&r=g)
### [abandoned carts is amazing](https://wordpress.org/support/topic/abandoned-carts-is-amazing/)

[lelejacko](https://profiles.wordpress.org/lelejacko/ "Posts by lelejacko")
July 7, 2021

The most useful feature is the “abandoned carts”. Thanks to this feature I started receiving more orders than ever before.

![](https://secure.gravatar.com/avatar/62b40c4e44d9e8382de00d122ca5138f3197b56f59ba4cec72e28a22423b3b05?s=60&d=retro&r=g)
### [Best Plugin for Woocomerce Order Receive](https://wordpress.org/support/topic/best-plugin-for-woocomerce-order-receive/)

[admiza](https://profiles.wordpress.org/admiza/ "Posts by admiza")
June 17, 2021
1 reply

Hi Spoki team,
thank you so much for you effort, i really like your plugin it is the best whatsapp order and chat plugin in wordpress great team work. good luck !!

[Read all 11 reviews](https://wordpress.org/support/plugin/spoki/reviews/)
## Contributors & Developers

“Spoki – Chat Buttons and WooCommerce Notifications” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/6fb25f817b076aa276a4e4932604ec5ad1ebe355cb2e168541c5bf7a7efd6f75?s=32&d=mm&r=g) [spoki](https://profiles.wordpress.org/spoki/)

“Spoki – Chat Buttons and WooCommerce Notifications” has been translated into 1 locale. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/spoki/contributors) for their contributions.

[Translate “Spoki – Chat Buttons and WooCommerce Notifications” into your language.](https://translate.wordpress.org/projects/wp-plugins/spoki)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/spoki/), check out the [SVN repository](https://plugins.svn.wordpress.org/spoki/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/spoki/) by [RSS](https://plugins.trac.wordpress.org/log/spoki/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 2.15.16 – 2025-01-08

* Vulnerability Fix

#### 2.15.15 – 2025-01-07

* Vulnerability Fix

#### 2.15.14 – 2024-12-10

* Performance improvements

#### 2.15.13 – 2024-12-09

* Performance improvements

#### 2.15.12 – 2024-10-15

* Support last version of WordPress

#### 2.15.11 – 2023-06-29

* Alert if there is an error making calls to Spoki (Firewall, Cache, MaxExecutionTime, …)

#### 2.15.10 – 2023-06-28

* Set NextAI as company
* Improved plugin settings performance

#### 2.15.9 – 2023-06-28

* Improved save settings performance

#### 2.15.5 – 2023-06-27

* Improved check secret performance

#### 2.15.4 – 2023-06-27

* Improved enable Spoki performance

#### 2.15.3 – 2023-03-28

* Minor Fix

#### 2.15.2 – 2023-01-10

* Fix if WooCommerce is not installed
* New support phone
* New Upgrade Spoki link

#### 2.15.1 – 2022-08-23

* Minor fix it translation

#### 2.15.0 – 2022-08-23

* Easy connect your Spoki account to the plugin
* Fixed info icons color

#### 2.14.0 – 2022-07-04

* Support Abandoned Carts for customized checkouts (customize checkout\_url and session\_id param)

#### 2.13.0 – 2022-06-27

* Set default prefix phone numbers
* Fixed emoji size in FAB’s label

#### 2.12.3 – 2022-06-06

* Support to WP 6.0.1

#### 2.12.2 – 2022-05-09

* Total in the WooCommerce Cart Button message
* Minor fix

#### 2.12.1 – 2022-02-17

* Minor fix

#### 2.12.0 – 2022-02-16

* Send different message from buttons on non-working days and times

#### 2.11.1 – 2022-02-07

* Improved compatibility with custom checkouts
* Improved performances

#### 2.11.0 – 2022-02-04

* Set working days and times
* Hide buttons in non-working days and times
* Not enable automatically notifications after onboarding

#### 2.10.0 – 2022-01-12

* New pricing linked

#### 2.9.3 – 2021-11-29

* Handle recontact abandoned carts for recharge accounts

#### 2.9.2 – 2021-10-19

* Added “immediatly” option for “Require a review” notification
* Added hours and days options for “Abandoned cart” notification
* Improved “abandoned checkout” to “order” trigger

#### 2.9.1 – 2021-10-14

* Extended order notifications even for orders with offline payments

#### 2.9.0 – 2021-10-12

* Customize buttons Padding
* Put store currency in the message of product & checkout buttons
* Customize shortcode buttons with custom css, id & class
* Minor fixes to prevent null pointers

#### 2.8.3 – 2021-10-07

* Hotfix: improved performance

#### 2.8.2 – 2021-10-06

* Select the Trigger Time for Abandoned Cart Notification
* Recontacted and recovered statistics
* Added “60+ days ago” slot to recontact abandoned carts
* Improved Abandoned Carts to let it work even with websites with custom checkouts
* Increased timeout to prevent errors when server is slow
* Fixed Pro User Onboarding

#### 2.8.1 – 2021-09-23

* Fixed “Resend “Abandoned Cart” if user have not enough contacts
* Send own domain when invite a friend

#### 2.8.0 – 2021-09-20

* Resend “Abandoned Cart” notifications to already contacted users
* Show “Invite a friend” alert only in dashboard

#### 2.7.4 – 2021-09-08

* Select up to 30 days for “Require a review” notification

#### 2.7.3 – 2021-09-06

* Fixed Floating Button Widget script

#### 2.7.2 – 2021-08-25

* Disable plugin auto updates from settings
* Improved order status notification conditions
* Updated elementor section image

#### 2.7.1 – 2021-08-17

* Improved elementor button
* Added nofollow to WA links

#### 2.7.0 – 2021-08-05

* Spoki WhatsApp Button element for Elementor
* Show statistics of Elementor buttons
* Fixed statistics for buttons with custom phone

#### 2.6.0 – 2021-07-28

* Shortcode WhatsApp Buttons
* Set days to wait before sending the “require a review” notification to customer
* Set Margin Left & Margin Right of buttons
* Send Abandoned Cart notification to seller only if sent to user too
* Show statistics of carts recovered with spoki only

#### 2.5.0 – 2021-07-21

* Chat widget for Floating Button
* Invite friends. Earn contacts.
* Fixed fab delays
* Fixed currency in overview

#### 2.4.0 – 2021-07-14

* Enable “Seller Notifications” for FREE
* Hide Floating Button in a specific page
* Admin phone number live validation to prevent bad telephones
* Added info tooltips
* Improved “Require a review” communication
* Removed “new” badge for abandoned cart
* UI fixes

#### 2.3.3 – 2021-07-07

* Earn with Spoki
* New “Send from your phone number” section
* Minor fixes on setting update

#### 2.3.2 – 2021-07-01

* Put Cart recovery notification in Seller Notifications section
* Minor fixes

#### 2.3.1 – 2021-06-30

* Allow Abandoned Carts feature for FREE
* Auto enable abandoned carts after wc onboarding
* Minor fixes

#### 2.3.0 – 2021-06-23

* Statistics in Dashboard
* Send Order Created notification to seller
* Website Buttons
* QR Code
* Put product WA button after buy now buttons if exists
* Attached Spoki in WooCommerce submenu
* Images in FAB settings for Label & badge
* Reorganized menu
* Added “What’s New” tab
* Minor fixes

#### 2.2.0 – 2021-06-16

* Review notification with external link after 5 days from order completation
* Label for Floating Button
* Badge for Floating Button

#### 2.1.0 – 2021-06-09

* Abandoned cart feature settings
* Number prefill in onboarding

#### 2.0.11 – 2021-05-31

* Fixed WhatsApp icon visibility in FAB on Safari
* Fixed “Test notifications” link for Portuguese

#### 2.0.10 – 2021-05-26

* Added French as template language
* Added prefix input for phone number
* Edit buttons font sizes
* Edit FAB size
* Hide FAB by resolutions (mobile, tablet, desktop)
* Hide FAB by pages (post, page, shop, product, cart, checkout)
* Added abandoned carts tab
* WA button icon as svg
* Updated privacy policy link
* Redirect to settings page after plugin activation

#### 2.0.9 – 2021-05-13

* Removed autoredirect after pluigin activation

#### 2.0.8 – 2021-05-12

* Hide WooCommerce checkout button in the cart page
* Change notifications language in order status tab
* Redirect to settings page after plugin activation
* Added example screenshot in the order status page
* Banner to Activate/Deactivate all status notifications
* Link to suggest messages for unsupported languages
* Support badge

#### 2.0.7 – 2021-05-05

* Fixed border style of cart button
* Added Spanish locales
* Added Portuguese as supported language for WooCommerce messages
* Added cron to check status of keys
* Added Feedback badge

#### 2.0.6 – 2021-04-28

* Customize chat buttons (color, position, border, margin)
* Shadowed buttons to prevent ui conflicts with themes
* Select the language for the WooCommerce messages
* Added Screenshots of the Website & Admin

#### 2.0.5 – 2021-04-22

* Updated plugin Title and Description

#### 2.0.4 – 2021-04-19

* Removed “Powered By” from all buttons

#### 2.0.3 – 2021-04-19

* Improved buttons styles to improve compatibility with themes

#### 2.0.2 – 2021-04-15

* Fixed Translation loading

#### 2.0.1 – 2021-04-15

* Updated Plugin description
* Fixed Account Overview

#### 2.0.0 – 2021-04-14

* WooCommerce notifications for order status
* WooCommerce tracking number notifications via order note
* Whatsapp Chat Buttons For WooCommerce Product Page
* Whatsapp Chat Buttons For WooCommerce Shop Page
* Whatsapp Chat Buttons For WooCommerce Cart Page
* Spoki Onboarding
* Dashboard with contacts overview
* Spoki keys handling
* Spoki Account info & Billing Data

#### 1.0.0 – 2021-03-31

* Initial Public Release

## Meta

* Version **2.15.16**
* Last updated **7 days ago**
* Active installations **800+**
* WordPress version **5.1 or higher**
* Tested up to **6.6.2**
* PHP version **7.2 or higher**
* Languages
  See all 2

  Close

  [English (US)](https://wordpress.org/plugins/spoki/) and [Italian](https://it.wordpress.org/plugins/spoki/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/spoki)
* Tags [abandoned carts](https://wordpress.org/plugins/tags/abandoned-carts/)[whatsapp](https://wordpress.org/plugins/tags/whatsapp/)[whatsapp button](https://wordpress.org/plugins/tags/whatsapp-button/)[whatsapp notification](https://wordpress.org/plugins/tags/whatsapp-notification/)[whatsapp woocommerce](https://wordpress.org/plugins/tags/whatsapp-woocommerce/)
* [Advanced View](https://wordpress.org/plugins/spoki/advanced/)

## Ratings

5 out of 5 stars.

* [11 5-star reviews
  5 stars

  11](https://wordpress.org/support/plugin/spoki/reviews/?filter=5)
* [0 4-star reviews
  4 stars

  0](https://wordpress.org/support/plugin/spoki/reviews/?filter=4)
* [0 3-star reviews
  3 stars

  0](https://wordpress.org/support/plugin/spoki/reviews/?filter=3)
* [0 2-star reviews
  2 stars

  0](https://wordpress.org/support/plugin/spoki/reviews/?filter=2)
* [0 1-star reviews
  1 star

  0](https://wordpress.org/support/plugin/spoki/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/spoki/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/spoki/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/6fb25f817b076aa276a4e4932604ec5ad1ebe355cb2e168541c5bf7a7efd6f75?s=32&d=mm&r=g) [spoki](https://profiles.wordpress.org/spoki/)
## Support

Got something to say? Need help?

[View support forum](https://wordpress.org/support/plugin/spoki/)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_20a57c1a_20250115_102923.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Spoki – Chat Buttons and WooCommerce Notifications <= 2.15.15 - Authenticated (Contributor+) Stored Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Spoki – Chat Buttons and WooCommerce Notifications <= 2.15.15 - Authenticated (Contributor+) Stored Cross-Site Scripting

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-11893](https://www.cve.org/CVERecord?id=CVE-2024-11893) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | December 19, 2024 |
| Last Updated | January 10, 2025 |
| Researcher | [theviper17y](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/theviper17y) |

### Description

The Spoki – Chat Buttons and WooCommerce Notifications plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the plugin's 'spoki\_button' shortcode in all versions up to, and including, 2.15.15 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers, with contributor-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/spoki/trunk/spoki.php#L1256)
* [wordpress.org](https://wordpress.org/plugins/spoki/)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3218903/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fspoki%2Fspoki-chat-buttons-and-woocommerce-notifications-21514-authenticated-contributor-stored-cross-site-scripting&t=Spoki%20%E2%80%93%20Chat%20Buttons%20and%20WooCommerce%20Notifications%20%3C%3D%202.15.15%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fspoki%2Fspoki-chat-buttons-and-woocommerce-notifications-21514-authenticated-contributor-stored-cross-site-scripting&text=Spoki%20%E2%80%93%20Chat%20Buttons%20and%20WooCommerce%20Notifications%20%3C%3D%202.15.15%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fspoki%2Fspoki-chat-buttons-and-woocommerce-notifications-21514-authenticated-contributor-stored-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for Spoki – Chat Buttons and WooCommerce Notifications

#### [Spoki – Chat Buttons and WooCommerce Notifications](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/spoki)

| Software Type | Plugin |
| --- | --- |
| Software Slug | spoki [(view on wordpress.org)](https://wordpress.org/plugins/spoki) |
| Patched? | Yes |
| Remediation | Update to version 2.15.16, or a newer patched version |
| Affected Version | * <= 2.15.15 |
| Patched Version | * 2.15.16 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_a0b1c1bd_20250115_102921.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fspoki%2Ftrunk%2Fspoki.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/spoki/trunk/spoki.php?rev=3218273 "Revision 3218273")
* Next Revision →
* [Blame](/browser/spoki/trunk/spoki.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/spoki/trunk/spoki.php)

---

# [source:](/browser?order=name "Go to repository root") [spoki](/browser/spoki?order=name "View spoki")/[trunk](/browser/spoki/trunk?order=name "View trunk")/[spoki.php](/browser/spoki/trunk/spoki.php?order=name "View spoki.php")

View diff against:

View revision:

| [Last change](/changeset/3218903/spoki/trunk/spoki.php "View differences") on this file was [3218903](/changeset/3218903/ "View changeset 3218903"), checked in by spoki, [7 days ago](/timeline?from=2025-01-08T10%3A32%3A20Z&precision=second "See timeline at 01/08/2025 10:32:20 AM") |
| --- |
| 2.15.16 |
| **File size:** 67.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* @wordpress-plugin |
| [3](#L3) | \* Plugin Name:       Spoki - Chat Buttons and WooCommerce Notifications |
| [4](#L4) | \* Description:       Integrate WhatsApp on your Business! Use Spoki to recover abandoned carts, add chat buttons and send order status notifications via WhatsApp. |
| [5](#L5) | \* Version:           2.15.16 |
| [6](#L6) | \* Author:            NextAI Srl |
| [7](#L7) | \* Author URI:        https://spoki.it |
| [8](#L8) | \* Text Domain:       spoki |
| [9](#L9) | \* Domain Path:       /languages |
| [10](#L10) | \* License:           GPLv2 |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | define('SPOKI\_PLUGIN\_FILE', \_\_FILE\_\_); |
| [14](#L14) | define('SPOKI\_BASE', plugin\_basename(SPOKI\_PLUGIN\_FILE)); |
| [15](#L15) | define('SPOKI\_DIR', plugin\_dir\_path(SPOKI\_PLUGIN\_FILE)); |
| [16](#L16) | define('SPOKI\_URL', plugins\_url('/', SPOKI\_PLUGIN\_FILE)); |
| [17](#L17) | define('SPOKI\_SETTING\_TABLE', 'spoki\_setting'); |
| [18](#L18) | define('SPOKI\_ABANDONMENT\_TABLE', 'spoki\_abandonment'); |
| [19](#L19) |  |
| [20](#L20) | include\_once SPOKI\_DIR . 'includes/constants.php'; |
| [21](#L21) | include\_once SPOKI\_DIR . 'includes/spoki-functions.php'; |
| [22](#L22) | include\_once SPOKI\_DIR . 'modules/abandoned-carts/spoki-abandoned-carts.php'; |
| [23](#L23) |  |
| [24](#L24) | add\_filter('cron\_schedules', 'add\_cron\_interval'); |
| [25](#L25) | add\_filter('http\_request\_timeout', 'extend\_http\_request\_timeout'); |
| [26](#L26) |  |
| [27](#L27) | function add\_cron\_interval($schedules) |
| [28](#L28) | { |
| [29](#L29) | $schedules['every\_day'] = array( |
| [30](#L30) | 'interval' => 86400, |
| [31](#L31) | 'display' => esc\_html\_\_('Every day'),); |
| [32](#L32) | return $schedules; |
| [33](#L33) | } |
| [34](#L34) |  |
| [35](#L35) |  |
| [36](#L36) | function extend\_http\_request\_timeout($timeout) |
| [37](#L37) | { |
| [38](#L38) | return 30; // seconds |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | add\_action('plugins\_loaded', function () { |
| [42](#L42) | /\*\* Init Spoki \*/ |
| [43](#L43) | Spoki(); |
| [44](#L44) | }, 9); |
| [45](#L45) |  |
| [46](#L46) |  |
| [47](#L47) | function Spoki() |
| [48](#L48) | { |
| [49](#L49) | return WpSpoki::instance(); |
| [50](#L50) | } |
| [51](#L51) |  |
| [52](#L52) | final class WpSpoki |
| [53](#L53) | { |
| [54](#L54) | protected static $\_instance = null; |
| [55](#L55) | public string $version = ''; |
| [56](#L56) | private string $langs = ''; |
| [57](#L57) | public array $shop = []; |
| [58](#L58) | public array $options = []; |
| [59](#L59) |  |
| [60](#L60) | public $api\_plan = SPOKI\_BASE\_API . "plan/"; |
| [61](#L61) | public $api\_status = SPOKI\_BASE\_API . "status/"; |
| [62](#L62) | public $api\_enable\_flex = SPOKI\_BASE\_API . "enable/"; |
| [63](#L63) | public $api\_account = SPOKI\_BASE\_API . "account/"; |
| [64](#L64) |  |
| [65](#L65) | public static function instance() |
| [66](#L66) | { |
| [67](#L67) | if (is\_null(self::$\_instance)) { |
| [68](#L68) | self::$\_instance = new self(); |
| [69](#L69) | } |
| [70](#L70) | return self::$\_instance; |
| [71](#L71) | } |
| [72](#L72) |  |
| [73](#L73) | private function \_\_construct() |
| [74](#L74) | { |
| [75](#L75) | $data = get\_file\_data(\_\_FILE\_\_, array('ver' => 'Version', 'langs' => 'Domain Path')); |
| [76](#L76) | $this->version = $data['ver']; |
| [77](#L77) | $this->langs = $data['langs']; |
| [78](#L78) | $this->options = get\_option(SPOKI\_OPTIONS) ? get\_option(SPOKI\_OPTIONS) : []; |
| [79](#L79) |  |
| [80](#L80) | $billing\_data = isset($this->options['billing\_data']) ? $this->options['billing\_data'] : []; |
| [81](#L81) | $has\_fixed\_support\_button = isset($this->options['buttons']['fixed\_support\_button\_check']) && $this->options['buttons']['fixed\_support\_button\_check'] == 1; |
| [82](#L82) | $has\_product\_item\_listing\_button = isset($this->options['woocommerce']['product\_item\_listing\_button\_check']) && $this->options['woocommerce']['product\_item\_listing\_button\_check'] == 1; |
| [83](#L83) | $has\_cart\_button = isset($this->options['woocommerce']['cart\_button\_check']) && $this->options['woocommerce']['cart\_button\_check'] == 1; |
| [84](#L84) | $has\_single\_product\_button = isset($this->options['woocommerce']['single\_product\_button\_check']) && $this->options['woocommerce']['single\_product\_button\_check'] == 1; |
| [85](#L85) | $has\_abandoned\_carts = isset($this->options['abandoned\_carts']['enable\_tracking']) && $this->options['abandoned\_carts']['enable\_tracking'] == 1; |
| [86](#L86) | $has\_order\_updated\_notification = (isset($this->options['woocommerce']['order\_updated']) && $this->options['woocommerce']['order\_updated'] == 1); |
| [87](#L87) | $has\_order\_created\_notification = (isset($this->options['woocommerce']['order\_created']) && $this->options['woocommerce']['order\_created'] == 1); |
| [88](#L88) | $has\_order\_deleted\_notification = (isset($this->options['woocommerce']['order\_deleted']) && $this->options['woocommerce']['order\_deleted'] == 1); |
| [89](#L89) | $has\_order\_note\_added\_notification = (isset($this->options['woocommerce']['order\_note\_added']) && $this->options['woocommerce']['order\_note\_added'] == 1); |
| [90](#L90) | $has\_leave\_review\_notification = (isset($this->options['woocommerce']['leave\_review']) && $this->options['woocommerce']['leave\_review'] == 1); |
| [91](#L91) | $has\_notifications = ( |
| [92](#L92) | $has\_order\_updated\_notification || |
| [93](#L93) | $has\_order\_created\_notification || |
| [94](#L94) | $has\_order\_deleted\_notification || |
| [95](#L95) | $has\_order\_note\_added\_notification || |
| [96](#L96) | $has\_leave\_review\_notification |
| [97](#L97) | ); |
| [98](#L98) | $has\_order\_created\_to\_seller\_notification = (isset($this->options['woocommerce']['order\_created\_to\_seller']) && $this->options['woocommerce']['order\_created\_to\_seller'] == 1); |
| [99](#L99) | $has\_cart\_recovered\_to\_seller\_notification = (isset($this->options['abandoned\_carts']['notify\_to\_admin']) && $this->options['abandoned\_carts']['notify\_to\_admin'] == 1); |
| [100](#L100) | $is\_auto\_update\_disabled = (isset($this->options['disable\_auto\_update']) && $this->options['disable\_auto\_update'] == 1); |
| [101](#L101) | $abandoned\_carts\_waiting\_minutes = (isset($this->options['abandoned\_carts']['waiting\_minutes'])) ? intval($this->options['abandoned\_carts']['waiting\_minutes']) : 15; |
| [102](#L102) |  |
| [103](#L103) | $this->shop = [ |
| [104](#L104) | "plugin\_version" => $this->version, |
| [105](#L105) | "name" => $this->options['shop\_name'] ?? get\_bloginfo('name'), |
| [106](#L106) | "url" => get\_bloginfo('url'), |
| [107](#L107) | "email" => $this->options['email'] ?? get\_bloginfo('admin\_email'), |
| [108](#L108) | "language" => $this->options['language'] ?? get\_bloginfo('language'), |
| [109](#L109) | "telephone" => ($this->options['prefix'] ?? '') . ($this->options['telephone'] ?? ''), |
| [110](#L110) | "contact\_link" => isset($this->options['contact\_link']) ? $this->options['contact\_link'] : null, |
| [111](#L111) | "default\_prefix" => isset($this->options['default\_prefix']) ? $this->options['default\_prefix'] : null, |
| [112](#L112) | "billing\_data" => $billing\_data, |
| [113](#L113) | "has\_fixed\_support\_button" => $has\_fixed\_support\_button, |
| [114](#L114) | "has\_product\_item\_listing\_button" => $has\_product\_item\_listing\_button, |
| [115](#L115) | "has\_cart\_button" => $has\_cart\_button, |
| [116](#L116) | "has\_single\_product\_button" => $has\_single\_product\_button, |
| [117](#L117) | "has\_abandoned\_carts" => $has\_abandoned\_carts, |
| [118](#L118) | "has\_order\_updated\_notification" => $has\_order\_updated\_notification, |
| [119](#L119) | "has\_order\_created\_notification" => $has\_order\_created\_notification, |
| [120](#L120) | "has\_order\_deleted\_notification" => $has\_order\_deleted\_notification, |
| [121](#L121) | "has\_order\_note\_added\_notification" => $has\_order\_note\_added\_notification, |
| [122](#L122) | "has\_leave\_review\_notification" => $has\_leave\_review\_notification, |
| [123](#L123) | "has\_notifications" => $has\_notifications, |
| [124](#L124) | "has\_order\_created\_to\_seller\_notification" => $has\_order\_created\_to\_seller\_notification, |
| [125](#L125) | "has\_cart\_recovered\_to\_seller\_notification" => $has\_cart\_recovered\_to\_seller\_notification, |
| [126](#L126) | "abandoned\_carts\_waiting\_minutes" => $abandoned\_carts\_waiting\_minutes, |
| [127](#L127) | "is\_auto\_update\_disabled" => $is\_auto\_update\_disabled, |
| [128](#L128) | ]; |
| [129](#L129) |  |
| [130](#L130) | register\_activation\_hook(SPOKI\_PLUGIN\_FILE, array($this, 'activation\_reset')); |
| [131](#L131) | register\_deactivation\_hook(SPOKI\_PLUGIN\_FILE, array($this, 'deactivation\_reset')); |
| [132](#L132) |  |
| [133](#L133) | add\_action('init', 'spoki\_update\_po\_file'); |
| [134](#L134) | add\_action('admin\_menu', array($this, 'add\_option\_menu')); |
| [135](#L135) | add\_action('admin\_menu', array($this, 'add\_submenu'), 99); |
| [136](#L136) | add\_filter("plugin\_action\_links\_" . plugin\_basename(\_\_FILE\_\_), array($this, 'plugin\_settings\_link')); |
| [137](#L137) | add\_action('wp\_enqueue\_scripts', array($this, 'add\_styles')); |
| [138](#L138) | add\_action('admin\_enqueue\_scripts', array($this, 'add\_admin\_styles')); |
| [139](#L139) | add\_action('admin\_enqueue\_scripts', array($this, 'add\_admin\_scripts')); |
| [140](#L140) | add\_action('updated\_option', array($this, 'on\_option\_added'), 10, 3); |
| [141](#L141) | add\_filter('auto\_update\_plugin', array($this, 'auto\_update\_plugin'), 10, 2); |
| [142](#L142) | add\_action('spoki\_cron\_hook', array($this, 'check\_secret\_status')); |
| [143](#L143) | if (!wp\_next\_scheduled('spoki\_cron\_hook')) { |
| [144](#L144) | $this->check\_secret\_status(); |
| [145](#L145) | wp\_schedule\_event(time(), 'every\_day', 'spoki\_cron\_hook'); |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | $this->includes(); |
| [149](#L149) | $this->render\_buttons(); |
| [150](#L150) | $this->handle\_woocommerce(); |
| [151](#L151) | $this->handle\_abandoned\_carts(); |
| [152](#L152) |  |
| [153](#L153) | add\_action('elementor/widgets/widgets\_registered', array($this, 'register\_elementor\_widgets')); |
| [154](#L154) |  |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | /\*\* |
| [158](#L158) | \* Include all Spoki required files |
| [159](#L159) | \*/ |
| [160](#L160) | private function includes() |
| [161](#L161) | { |
| [162](#L162) | require\_once SPOKI\_DIR . 'includes/spoki-functions.php'; |
| [163](#L163) | } |
| [164](#L164) |  |
| [165](#L165) | /\*\* |
| [166](#L166) | \* Get the setting link of the plugin |
| [167](#L167) | \* |
| [168](#L168) | \* @param $links |
| [169](#L169) | \* @return mixed |
| [170](#L170) | \*/ |
| [171](#L171) | public function plugin\_settings\_link($links) |
| [172](#L172) | { |
| [173](#L173) | $settings\_link = '<a href="admin.php?page=' . SPOKI\_PLUGIN\_NAME . '">' . \_\_('Settings', SPOKI\_PLUGIN\_NAME) . '</a>'; |
| [174](#L174) | array\_unshift($links, $settings\_link); |
| [175](#L175) | return $links; |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | /\*\* |
| [179](#L179) | \* Add the Spoki option to the menu |
| [180](#L180) | \*/ |
| [181](#L181) | public function add\_option\_menu() |
| [182](#L182) | { |
| [183](#L183) | add\_menu\_page( |
| [184](#L184) | 'Spoki Options', |
| [185](#L185) | "Spoki", |
| [186](#L186) | 'manage\_options', |
| [187](#L187) | 'spoki', |
| [188](#L188) | array($this, 'render\_setup\_page'), |
| [189](#L189) | plugins\_url() . '/' . SPOKI\_PLUGIN\_NAME . '/assets/images/logo.svg', |
| [190](#L190) | 98 |
| [191](#L191) | ); |
| [192](#L192) | add\_action('admin\_init', array($this, 'register\_option\_var')); |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | /\*\* |
| [196](#L196) | \* Add the Spoki option submenu |
| [197](#L197) | \*/ |
| [198](#L198) | function add\_submenu() |
| [199](#L199) | { |
| [200](#L200) | $has\_woocommerce = ('woocommerce/woocommerce.php'); |
| [201](#L201) | $is\_pro = isset($this->options['account\_info']['plan']['is\_pro']) && $this->options['account\_info']['plan']['is\_pro'] == true; |
| [202](#L202) |  |
| [203](#L203) | add\_submenu\_page('spoki', \_\_('Statistics', "spoki"), \_\_('Statistics', "spoki"), 'manage\_options', "admin.php?page=" . SPOKI\_PLUGIN\_NAME . "&tab=welcome"); |
| [204](#L204) | add\_submenu\_page('spoki', \_\_('Buttons', "spoki"), \_\_('Buttons', "spoki"), 'manage\_options', "admin.php?page=" . SPOKI\_PLUGIN\_NAME . "&tab=buttons"); |
| [205](#L205) | add\_submenu\_page('spoki', \_\_('Customer Notifications', "spoki"), \_\_('Customer Notifications', "spoki"), 'manage\_options', "admin.php?page=" . SPOKI\_PLUGIN\_NAME . "&tab=customer-notifications"); |
| [206](#L206) | add\_submenu\_page('spoki', \_\_('Seller Notifications', "spoki"), \_\_('Seller Notifications', "spoki"), 'manage\_options', "admin.php?page=" . SPOKI\_PLUGIN\_NAME . "&tab=seller-notifications"); |
| [207](#L207) | add\_submenu\_page('spoki', \_\_('Abandoned Carts', "spoki"), \_\_('Abandoned Carts', "spoki"), 'manage\_options', "admin.php?page=" . SPOKI\_PLUGIN\_NAME . "&tab=abandoned-carts"); |
| [208](#L208) | add\_submenu\_page('spoki', \_\_('Settings', "spoki"), \_\_('Settings', "spoki"), 'manage\_options', "admin.php?page=" . SPOKI\_PLUGIN\_NAME . "&tab=settings"); |
| [209](#L209) | add\_submenu\_page('spoki', \_\_('Invite a friend', "spoki"), \_\_('Invite a friend', "spoki"), 'manage\_options', "admin.php?page=" . SPOKI\_PLUGIN\_NAME . "&tab=invite-a-friend"); |
| [210](#L210) | if (!$is\_pro) { |
| [211](#L211) | add\_submenu\_page('spoki', \_\_('Upgrade', "spoki"), "<span class='color-spoki text-bold'>⇡ " . \_\_('Upgrade', "spoki") . "</span>", 'manage\_options', $this->get\_pro\_plan\_link()); |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | if ($has\_woocommerce) { |
| [215](#L215) | add\_submenu\_page( |
| [216](#L216) | 'woocommerce', |
| [217](#L217) | \_\_('Spoki', "spoki"), |
| [218](#L218) | \_\_('Spoki', "spoki"), |
| [219](#L219) | 'manage\_options', |
| [220](#L220) | "admin.php?page=" . SPOKI\_PLUGIN\_NAME . "&tab=welcome", |
| [221](#L221) | null, |
| [222](#L222) | 8 |
| [223](#L223) | ); |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) | } |
| [227](#L227) |  |
| [228](#L228) | /\*\* |
| [229](#L229) | \* Register the Spoki option |
| [230](#L230) | \*/ |
| [231](#L231) | public function register\_option\_var() |
| [232](#L232) | { |
| [233](#L233) | register\_setting('wp-spoki-option', SPOKI\_OPTIONS); |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Add website spoki styles |
| [238](#L238) | \*/ |
| [239](#L239) | public function add\_styles() |
| [240](#L240) | { |
| [241](#L241) | $styles = ['buttons']; |
| [242](#L242) | foreach ($styles as $style) { |
| [243](#L243) | echo "<style id='spoki-style-$style'>"; |
| [244](#L244) | include SPOKI\_DIR . "assets/css/$style.css"; |
| [245](#L245) | echo "</style>"; |
| [246](#L246) | } |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | /\*\* |
| [250](#L250) | \* Add admin spoki styles |
| [251](#L251) | \*/ |
| [252](#L252) | public function add\_admin\_styles() |
| [253](#L253) | { |
| [254](#L254) | $styles = ['admin.css', 'onboarding.css', 'account-overview.css', 'spoki-overview.css']; |
| [255](#L255) |  |
| [256](#L256) | foreach ($styles as $style) { |
| [257](#L257) | echo "<style>"; |
| [258](#L258) | include\_once SPOKI\_DIR . 'assets/css/' . $style; |
| [259](#L259) | echo "</style>"; |
| [260](#L260) | } |
| [261](#L261) |  |
| [262](#L262) | $this->add\_styles(); |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | /\*\* |
| [266](#L266) | \* Add admin spoki scripts |
| [267](#L267) | \*/ |
| [268](#L268) | public function add\_admin\_scripts() |
| [269](#L269) | { |
| [270](#L270) | $scripts = ['spoki-admin.js', 'spoki-shadowed-buttons.js']; |
| [271](#L271) |  |
| [272](#L272) | foreach ($scripts as $script) { |
| [273](#L273) | echo "<script>"; |
| [274](#L274) | include\_once SPOKI\_DIR . 'assets/js/' . $script; |
| [275](#L275) | echo "</script>"; |
| [276](#L276) | } |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | /\*\* |
| [280](#L280) | \* Enable plugin autoupdate |
| [281](#L281) | \*/ |
| [282](#L282) | function auto\_update\_plugin($update, $item) |
| [283](#L283) | { |
| [284](#L284) | $plugins = array('spoki'); |
| [285](#L285) | $is\_auto\_update\_disabled = (isset($this->options['disable\_auto\_update']) && $this->options['disable\_auto\_update'] == 1); |
| [286](#L286) | if (in\_array($item->slug, $plugins) && !$is\_auto\_update\_disabled) |
| [287](#L287) | return true; |
| [288](#L288) | else return $update; |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | /\*\* |
| [292](#L292) | \* Register widgets for Elementor |
| [293](#L293) | \*/ |
| [294](#L294) | public function register\_elementor\_widgets() |
| [295](#L295) | { |
| [296](#L296) | if (spoki\_has\_elementor()) { |
| [297](#L297) | include\_once SPOKI\_DIR . 'widgets/class-elementor-spoki-button.php'; |
| [298](#L298) | \Elementor\Plugin::instance()->widgets\_manager->register\_widget\_type(new \Elementor\_Spoki\_Button\_Widget()); |
| [299](#L299) | } |
| [300](#L300) | } |
| [301](#L301) |  |
| [302](#L302) | /\*\* |
| [303](#L303) | \* Handle option submit |
| [304](#L304) | \* |
| [305](#L305) | \* @param $option |
| [306](#L306) | \* @param $old\_value |
| [307](#L307) | \* @param $value |
| [308](#L308) | \*/ |
| [309](#L309) | public function on\_option\_added($option, $old\_value, $value) |
| [310](#L310) | { |
| [311](#L311) | if ($option == SPOKI\_OPTIONS) { |
| [312](#L312) |  |
| [313](#L313) | /\*\* Onboarding Without WooCommerce \*/ |
| [314](#L314) | if (isset($value['onboarding']['without\_wc'])) { |
| [315](#L315) | $this->update\_options($value, [ |
| [316](#L316) | "telephone" => $value['onboarding']['telephone'], |
| [317](#L317) | "prefix" => $value['onboarding']['prefix'], |
| [318](#L318) | "onboarding" => null, |
| [319](#L319) | ]); |
| [320](#L320) | $url = admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME . '&tab=buttons'); |
| [321](#L321) | header("Location: {$url}"); |
| [322](#L322) | exit; |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | /\*\* Onboarding With WooCommerce \*/ |
| [326](#L326) |  |
| [327](#L327) | if (isset($value['onboarding']['with\_wc'])) { |
| [328](#L328) | $response = array( |
| [329](#L329) | "secret" => $value['onboarding']['spoki\_onboarding\_secret'], |
| [330](#L330) | "delivery\_url" => $value['onboarding']['spoki\_onboarding\_delivery\_url'], |
| [331](#L331) | ); |
| [332](#L332) | if (isset($response['secret']) && isset($response['delivery\_url'])) { |
| [333](#L333) | $this->update\_options($value, [ |
| [334](#L334) | "telephone" => $value['onboarding']['telephone'], |
| [335](#L335) | "prefix" => $value['onboarding']['prefix'], |
| [336](#L336) | "email" => $value['onboarding']['email'], |
| [337](#L337) | "shop\_name" => $value['onboarding']['shop\_name'], |
| [338](#L338) | "secret" => $response['secret'], |
| [339](#L339) | "delivery\_url" => $response['delivery\_url'], |
| [340](#L340) | "onboarding" => null, |
| [341](#L341) | "woocommerce" => [ |
| [342](#L342) | "order\_created" => 0, |
| [343](#L343) | "order\_updated" => 0, |
| [344](#L344) | "order\_deleted" => 0, |
| [345](#L345) | "order\_note\_added" => 0, |
| [346](#L346) | "leave\_review" => 0, |
| [347](#L347) | "leave\_review\_days" => 5, |
| [348](#L348) | "order\_created\_to\_seller" => 0, |
| [349](#L349) | ], |
| [350](#L350) | "abandoned\_carts" => [ |
| [351](#L351) | "enable\_tracking" => 0, |
| [352](#L352) | "notify\_to\_admin" => 0, |
| [353](#L353) | ], |
| [354](#L354) | "secret\_status" => [ |
| [355](#L355) | 'secret' => $response['secret'], |
| [356](#L356) | 'delivery\_url' => $response['delivery\_url'], |
| [357](#L357) | 'code' => 200, |
| [358](#L358) | 'message' => '' |
| [359](#L359) | ] |
| [360](#L360) | ]); |
| [361](#L361) | $url = admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME . '&tab=customer-notifications'); |
| [362](#L362) | header("Location: {$url}"); |
| [363](#L363) | exit; |
| [364](#L364) | } |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) | if (isset($value['account\_info']['response\_json'])) { |
| [368](#L368) | $account\_info = json\_decode($value['account\_info']['response\_json'] ?? '{}', true); |
| [369](#L369) | if ($account\_info) { |
| [370](#L370) | $this->update\_options(get\_option(SPOKI\_OPTIONS), ["account\_info" => $account\_info]); |
| [371](#L371) | } |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | /\*\* Settings updated for registered account \*/ |
| [375](#L375) | if (isset($value['is\_settings'])) { |
| [376](#L376) | $keys\_changed = ($value['secret'] != $old\_value['secret']) || ($value['delivery\_url'] != $old\_value['delivery\_url']); |
| [377](#L377) | if ($keys\_changed) { |
| [378](#L378) | $url = admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME . '&tab=welcome'); |
| [379](#L379) | header("Location: {$url}"); |
| [380](#L380) | exit; |
| [381](#L381) | } |
| [382](#L382) | } |
| [383](#L383) |  |
| [384](#L384) | /\*\* Enable all notifications from dashboard \*/ |
| [385](#L385) | if (isset($value['enable\_notifications']) && $value['enable\_notifications'] == 1) { |
| [386](#L386) | $this->update\_options(get\_option(SPOKI\_OPTIONS), [ |
| [387](#L387) | "enable\_notifications" => 0, |
| [388](#L388) | "woocommerce" => [ |
| [389](#L389) | "order\_created" => 1, |
| [390](#L390) | "order\_updated" => 1, |
| [391](#L391) | "order\_deleted" => 1, |
| [392](#L392) | "order\_note\_added" => 1, |
| [393](#L393) | "leave\_review" => 1, |
| [394](#L394) | "leave\_review\_days" => 5, |
| [395](#L395) | ] |
| [396](#L396) | ]); |
| [397](#L397) | $url = admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME . '&tab=customer-notifications'); |
| [398](#L398) | header("Location: {$url}"); |
| [399](#L399) | exit; |
| [400](#L400) | } |
| [401](#L401) |  |
| [402](#L402) | /\*\* Enable order status notifications from dashboard \*/ |
| [403](#L403) | if (isset($value['enable\_order\_status\_notifications']) && $value['enable\_order\_status\_notifications'] == 1) { |
| [404](#L404) | $this->update\_options(get\_option(SPOKI\_OPTIONS), [ |
| [405](#L405) | "enable\_order\_status\_notifications" => 0, |
| [406](#L406) | "woocommerce" => [ |
| [407](#L407) | "order\_created" => 1, |
| [408](#L408) | "order\_updated" => 1, |
| [409](#L409) | "order\_deleted" => 1, |
| [410](#L410) | ] |
| [411](#L411) | ]); |
| [412](#L412) | $url = admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME . '&tab=customer-notifications'); |
| [413](#L413) | header("Location: {$url}"); |
| [414](#L414) | exit; |
| [415](#L415) | } |
| [416](#L416) |  |
| [417](#L417) | /\*\* Enable seller notifications from dashboard \*/ |
| [418](#L418) | if (isset($value['enable\_seller\_notifications']) && $value['enable\_seller\_notifications'] == 1) { |
| [419](#L419) | $this->update\_options(get\_option(SPOKI\_OPTIONS), [ |
| [420](#L420) | "enable\_seller\_notifications" => 0, |
| [421](#L421) | "woocommerce" => [ |
| [422](#L422) | "order\_created\_to\_seller" => 1, |
| [423](#L423) | ] |
| [424](#L424) | ]); |
| [425](#L425) | $url = admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME . '&tab=seller-notifications'); |
| [426](#L426) | header("Location: {$url}"); |
| [427](#L427) | exit; |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | /\*\* Enable leave review notification from dashboard \*/ |
| [431](#L431) | if (isset($value['enable\_leave\_review\_notification']) && $value['enable\_leave\_review\_notification'] == 1) { |
| [432](#L432) | $this->update\_options(get\_option(SPOKI\_OPTIONS), [ |
| [433](#L433) | "enable\_leave\_review\_notification" => 0, |
| [434](#L434) | "woocommerce" => [ |
| [435](#L435) | "leave\_review" => 1, |
| [436](#L436) | "leave\_review\_days" => 5, |
| [437](#L437) | ] |
| [438](#L438) | ]); |
| [439](#L439) | $url = admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME . '&tab=customer-notifications'); |
| [440](#L440) | header("Location: {$url}"); |
| [441](#L441) | exit; |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | /\*\* Enable enable order note added notification from dashboard \*/ |
| [445](#L445) | if (isset($value['enable\_order\_note\_added\_notification']) && $value['enable\_order\_note\_added\_notification'] == 1) { |
| [446](#L446) | $this->update\_options(get\_option(SPOKI\_OPTIONS), [ |
| [447](#L447) | "enable\_order\_note\_added\_notification" => 0, |
| [448](#L448) | "woocommerce" => [ |
| [449](#L449) | "order\_note\_added" => 1, |
| [450](#L450) | ] |
| [451](#L451) | ]); |
| [452](#L452) | $url = admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME . '&tab=customer-notifications'); |
| [453](#L453) | header("Location: {$url}"); |
| [454](#L454) | exit; |
| [455](#L455) | } |
| [456](#L456) | } |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | /\*\* |
| [460](#L460) | \* Handle WooCommerce features |
| [461](#L461) | \*/ |
| [462](#L462) | public function handle\_woocommerce() |
| [463](#L463) | { |
| [464](#L464) | if (isset($this->options['secret'])) { |
| [465](#L465) | include\_once(ABSPATH . 'wp-admin/includes/plugin.php'); |
| [466](#L466) | if (spoki\_has\_woocommerce()) { |
| [467](#L467) | add\_action('woocommerce\_checkout\_update\_order\_meta', array($this, 'send\_woocommerce\_order\_created\_alert'), 1, 3); |
| [468](#L468) | add\_action('woocommerce\_order\_status\_changed', array($this, 'send\_woocommerce\_order\_created\_or\_updated\_alert'), 1, 3); |
| [469](#L469) | add\_action('woocommerce\_cancelled\_order', array($this, 'send\_woocommerce\_order\_deleted\_alert'), 10, 3); |
| [470](#L470) | add\_action('woocommerce\_trash\_order', array($this, 'send\_woocommerce\_order\_deleted\_alert'), 10, 3); |
| [471](#L471) | add\_action('woocommerce\_order\_note\_added', array($this, 'send\_woocommerce\_note\_alert'), 10, 2); |
| [472](#L472) | add\_action('woocommerce\_order\_status\_completed', array($this, 'send\_woocommerce\_review\_alert'), 10, 2); |
| [473](#L473) |  |
| [474](#L474) | if (isset($this->options['woocommerce']['cart\_button\_hide\_checkout\_button\_check']) && $this->options['woocommerce']['cart\_button\_hide\_checkout\_button\_check'] == 1) { |
| [475](#L475) | add\_action('woocommerce\_proceed\_to\_checkout', array($this, 'disable\_checkout\_button'), 1); |
| [476](#L476) | } |
| [477](#L477) | } |
| [478](#L478) | } |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Handle WooCommerce abandoned carts feature |
| [483](#L483) | \*/ |
| [484](#L484) | public function handle\_abandoned\_carts() |
| [485](#L485) | { |
| [486](#L486) | $Abandonment = Spoki\_Abandoned\_Carts::instance(); |
| [487](#L487) | if (isset($this->options['abandoned\_carts']['enable\_tracking']) && $this->options['abandoned\_carts']['enable\_tracking'] == 1) { |
| [488](#L488) | $this->initialize\_cart\_abandonment\_tables(); |
| [489](#L489) | do\_action('spoki\_cartflow\_ca\_init'); |
| [490](#L490) | } elseif (wp\_next\_scheduled('spoki\_abandoned\_carts\_cron\_hook')) { |
| [491](#L491) | # Unschedule hook for versions <= v2.8.1 |
| [492](#L492) | $Abandonment->unschedule\_hook(); |
| [493](#L493) | } |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | /\*\* |
| [497](#L497) | \* Create new database tables for plugin updates. |
| [498](#L498) | \* |
| [499](#L499) | \* @return void |
| [500](#L500) | \*/ |
| [501](#L501) | public function initialize\_cart\_abandonment\_tables() |
| [502](#L502) | { |
| [503](#L503) | include\_once SPOKI\_DIR . 'modules/abandoned-carts/spoki-abandoned-carts-db.php'; |
| [504](#L504) | $db = Spoki\_Abandoned\_Carts\_Db::instance(); |
| [505](#L505) | $db->create\_tables(); |
| [506](#L506) | $db->init\_tables(); |
| [507](#L507) | } |
| [508](#L508) |  |
| [509](#L509) | /\*\* |
| [510](#L510) | \* Send the Spoki notification for order status created or updated |
| [511](#L511) | \* |
| [512](#L512) | \* @param $order\_get\_id |
| [513](#L513) | \* @param $from |
| [514](#L514) | \* @param $to |
| [515](#L515) | \*/ |
| [516](#L516) | public function send\_woocommerce\_order\_created\_alert($order\_get\_id) |
| [517](#L517) | { |
| [518](#L518) | $this->send\_woocommerce\_order\_alert($order\_get\_id, 'order.updated'); |
| [519](#L519) | } |
| [520](#L520) |  |
| [521](#L521) | /\*\* |
| [522](#L522) | \* Send the Spoki notification for order status created or updated |
| [523](#L523) | \* |
| [524](#L524) | \* @param $order\_get\_id |
| [525](#L525) | \* @param $from |
| [526](#L526) | \* @param $to |
| [527](#L527) | \*/ |
| [528](#L528) | public function send\_woocommerce\_order\_created\_or\_updated\_alert($order\_get\_id, $from, $to) |
| [529](#L529) | { |
| [530](#L530) | $this->send\_woocommerce\_order\_alert($order\_get\_id, 'order.updated', ["from\_status" => $from, "to\_status" => $to]); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | /\*\* |
| [534](#L534) | \* Send the Spoki notification for review |
| [535](#L535) | \* |
| [536](#L536) | \* @param $order\_get\_id |
| [537](#L537) | \*/ |
| [538](#L538) | public function send\_woocommerce\_review\_alert($order\_get\_id) |
| [539](#L539) | { |
| [540](#L540) | $review\_link = (isset($this->options['woocommerce']['leave\_review\_link']) && $this->options['woocommerce']['leave\_review\_link'] != "") ? $this->options['woocommerce']['leave\_review\_link'] : ""; |
| [541](#L541) | $review\_link\_days = (isset($this->options['woocommerce']['leave\_review\_days']) && $this->options['woocommerce']['leave\_review\_days'] != "") ? $this->options['woocommerce']['leave\_review\_days'] : 5; |
| [542](#L542) | $this->send\_woocommerce\_order\_alert($order\_get\_id, 'order.review', ["review\_link" => $review\_link, "delay" => intval($review\_link\_days) \* 24 \* 60 \* 60]); |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | /\*\* |
| [546](#L546) | \* Notify the Abandoned Cart Info Spoki notification |
| [547](#L547) | \* |
| [548](#L548) | \* @param $session\_id |
| [549](#L549) | \* @param $checkoutDetails |
| [550](#L550) | \* @param $topic |
| [551](#L551) | \* @return bool |
| [552](#L552) | \*/ |
| [553](#L553) | public function notify\_abandoned\_cart\_info($session\_id, $checkoutDetails, $topic): bool |
| [554](#L554) | { |
| [555](#L555) | $other\_fields = unserialize($checkoutDetails->other\_fields); |
| [556](#L556) | $parts = explode(',', $other\_fields['spoki\_location']); |
| [557](#L557) | $country = $parts[0]; |
| [558](#L558) |  |
| [559](#L559) | $phone = trim(sanitize\_text\_field($other\_fields['spoki\_phone\_number'])); |
| [560](#L560) | if ($phone != '' && $phone[0] != '+') { |
| [561](#L561) | $default\_prefix = isset($this->options['default\_prefix']) ? $this->options['default\_prefix'] : ''; |
| [562](#L562) | $phone = $default\_prefix . $phone; |
| [563](#L563) | } |
| [564](#L564) |  |
| [565](#L565) | $checkout\_base\_url = (isset($this->options['custom\_checkout\_url']) && $this->options['custom\_checkout\_url'] != "") ? $this->options['custom\_checkout\_url'] : wc\_get\_page\_permalink('checkout'); |
| [566](#L566) | $custom\_checkout\_session\_id\_param = (isset($this->options['custom\_checkout\_session\_id\_param']) && $this->options['custom\_checkout\_session\_id\_param'] != "") ? $this->options['custom\_checkout\_session\_id\_param'] : "session\_id"; |
| [567](#L567) |  |
| [568](#L568) | $data = [ |
| [569](#L569) | "customer" => [ |
| [570](#L570) | 'email' => $checkoutDetails->email, |
| [571](#L571) | 'phone' => $phone, |
| [572](#L572) | 'country' => sanitize\_text\_field($country), |
| [573](#L573) | 'first\_name' => sanitize\_text\_field($other\_fields['spoki\_first\_name']), |
| [574](#L574) | 'last\_name' => sanitize\_text\_field($other\_fields['spoki\_last\_name']), |
| [575](#L575) | 'name' => sanitize\_text\_field($other\_fields['spoki\_first\_name']) . ' ' . sanitize\_text\_field($other\_fields['spoki\_last\_name']), |
| [576](#L576) | ], |
| [577](#L577) | "checkout" => [ |
| [578](#L578) | "checkout\_url" => $checkout\_base\_url . '?' . $custom\_checkout\_session\_id\_param . '=' . $checkoutDetails->session\_id, |
| [579](#L579) | "checkout\_info" => $other\_fields, |
| [580](#L580) | "cart\_contacted\_url" => get\_bloginfo('url') . '/wp-json/api/v1/setCartAsContacted', |
| [581](#L581) | "total" => $checkoutDetails->cart\_total, |
| [582](#L582) | "currency" => get\_woocommerce\_currency(), |
| [583](#L583) | ], |
| [584](#L584) | "session\_id" => $session\_id, |
| [585](#L585) | ]; |
| [586](#L586) | return $this->spoki\_send($data, $topic); |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | /\*\* |
| [590](#L590) | \* Send the Spoki notification for order deleted |
| [591](#L591) | \* |
| [592](#L592) | \* @param $order\_get\_id |
| [593](#L593) | \*/ |
| [594](#L594) | public function send\_woocommerce\_order\_deleted\_alert($order\_get\_id) |
| [595](#L595) | { |
| [596](#L596) | $this->send\_woocommerce\_order\_alert($order\_get\_id, 'order.deleted'); |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | /\*\* |
| [600](#L600) | \* Send the Spoki notification for order status |
| [601](#L601) | \* |
| [602](#L602) | \* @param $order\_get\_id |
| [603](#L603) | \* @param $topic |
| [604](#L604) | \* @param $additional\_data |
| [605](#L605) | \*/ |
| [606](#L606) | public function send\_woocommerce\_order\_alert($order\_get\_id, $topic, $additional\_data = []) |
| [607](#L607) | { |
| [608](#L608) | $order = wc\_get\_order($order\_get\_id); |
| [609](#L609) |  |
| [610](#L610) | // Session Handling |
| [611](#L611) | $session = []; |
| [612](#L612) | try { |
| [613](#L613) | $session\_id = WC()->session ? WC()->session->get('spoki\_session\_id') : null; |
| [614](#L614) | if (!$session\_id && $this->shop['has\_abandoned\_carts']) { |
| [615](#L615) | $spoki\_abandoned\_carts = Spoki\_Abandoned\_Carts::instance(); |
| [616](#L616) | $checkout = $spoki\_abandoned\_carts->get\_order\_checkout\_details($order\_get\_id); |
| [617](#L617) | $other\_fields = unserialize($checkout->other\_fields); |
| [618](#L618) | $session\_id = $other\_fields['spoki\_session\_id']; |
| [619](#L619) | } |
| [620](#L620) | if ($session\_id) { |
| [621](#L621) | $session = ['session\_id' => $session\_id]; |
| [622](#L622) | } |
| [623](#L623) | } catch (Exception $e) { |
| [624](#L624) | // Can't set session\_id |
| [625](#L625) | } |
| [626](#L626) |  |
| [627](#L627) | $order\_data = array\_merge(((isset($order) && false != $order ? $order->get\_data() : ["id" => $order\_get\_id])), $additional\_data); |
| [628](#L628) | if (!isset($order\_data["to\_status"])) { |
| [629](#L629) | $order\_data["from\_status"] = $order\_data["status"]; |
| [630](#L630) | $order\_data["to\_status"] = $order\_data["status"]; |
| [631](#L631) | } |
| [632](#L632) |  |
| [633](#L633) | $parts = explode(',', isset($order\_data['billing']['country']) ? $order\_data['billing']['country'] : ''); |
| [634](#L634) | $country = $parts[0]; |
| [635](#L635) | $phone = trim(isset($order\_data['billing']['phone']) ? $order\_data['billing']['phone'] : ''); |
| [636](#L636) | if ($phone != '' && $phone[0] != '+') { |
| [637](#L637) | $default\_prefix = isset($this->options['default\_prefix']) ? $this->options['default\_prefix'] : ''; |
| [638](#L638) | $phone = $default\_prefix . $phone; |
| [639](#L639) | } |
| [640](#L640) | $customer = [ |
| [641](#L641) | 'email' => isset($order\_data['billing']['email']) ? $order\_data['billing']['email'] : '', |
| [642](#L642) | 'phone' => $phone, |
| [643](#L643) | 'country' => $country ?? '', |
| [644](#L644) | 'first\_name' => (isset($order\_data['billing']['first\_name']) ? $order\_data['billing']['first\_name'] : ''), |
| [645](#L645) | 'last\_name' => (isset($order\_data['billing']['last\_name']) ? $order\_data['billing']['last\_name'] : ''), |
| [646](#L646) | 'name' => (isset($order\_data['billing']['first\_name']) ? $order\_data['billing']['first\_name'] : '') . ' ' . (isset($order\_data['billing']['last\_name']) ? $order\_data['billing']['last\_name'] : ''), |
| [647](#L647) | ]; |
| [648](#L648) | $this->spoki\_send(array\_merge([ |
| [649](#L649) | "order" => $order\_data, |
| [650](#L650) | "customer" => $customer, |
| [651](#L651) | ], $session), $topic); |
| [652](#L652) | } |
| [653](#L653) |  |
| [654](#L654) | /\*\* |
| [655](#L655) | \* Send the Spoki notification for tracking number |
| [656](#L656) | \* |
| [657](#L657) | \* @param $id |
| [658](#L658) | \* @param $order |
| [659](#L659) | \*/ |
| [660](#L660) | public function send\_woocommerce\_note\_alert($id, $order) |
| [661](#L661) | { |
| [662](#L662) | $comment = get\_comment($id); |
| [663](#L663) | if (isset($comment->comment\_content)) { |
| [664](#L664) | $is\_gls\_tracking = substr(strtolower($comment->comment\_content), 0, 4) == '[gls'; |
| [665](#L665) | $is\_user\_tracking = substr(strtolower($comment->comment\_content), 0, 10) == '[tracking]'; |
| [666](#L666) |  |
| [667](#L667) | /\*\* Send the message only if it is a tracking order note \*/ |
| [668](#L668) | if ($comment->comment\_type == 'order\_note' && ($is\_gls\_tracking || $is\_user\_tracking)) { |
| [669](#L669) | $order\_data = $order->get\_data(); |
| [670](#L670) | $this->send\_woocommerce\_order\_alert($order\_data['id'], 'order.tracking', ["note" => $comment]); |
| [671](#L671) | } |
| [672](#L672) | } |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | /\*\* |
| [676](#L676) | \* Send the Spoki notification |
| [677](#L677) | \* |
| [678](#L678) | \* @param $data |
| [679](#L679) | \* @return bool |
| [680](#L680) | \*/ |
| [681](#L681) | public function spoki\_send($data, $topic): bool |
| [682](#L682) | { |
| [683](#L683) | $shop = ["shop" => $this->shop]; |
| [684](#L684) |  |
| [685](#L685) | $request\_params = array( |
| [686](#L686) | "headers" => array( |
| [687](#L687) | "Authorization" => $this->options['secret'], |
| [688](#L688) | "language" => $this->shop['language'], |
| [689](#L689) | "X-Wc-Webhook-Topic" => $topic, |
| [690](#L690) | ), |
| [691](#L691) | "body" => wp\_json\_encode(array\_merge($data, $shop)), |
| [692](#L692) | "sslverify" => false, |
| [693](#L693) | "timeout" => 60, |
| [694](#L694) | ); |
| [695](#L695) |  |
| [696](#L696) | $url = $this->options['delivery\_url']; |
| [697](#L697) | $response = wp\_remote\_post($url, $request\_params); |
| [698](#L698) | $code = wp\_remote\_retrieve\_response\_code($response); |
| [699](#L699) | return $code == 200; |
| [700](#L700) | } |
| [701](#L701) |  |
| [702](#L702) | /\*\* |
| [703](#L703) | \* Fetch and update the account\_info |
| [704](#L704) | \*/ |
| [705](#L705) | public function fetch\_account\_info() |
| [706](#L706) | { |
| [707](#L707) | $request\_params = [ |
| [708](#L708) | "headers" => [ |
| [709](#L709) | "Authorization" => $this->options['secret'], |
| [710](#L710) | "language" => $this->shop['language'] |
| [711](#L711) | ], |
| [712](#L712) | "sslverify" => false, |
| [713](#L713) | "timeout" => 60, |
| [714](#L714) | ]; |
| [715](#L715) | $response = wp\_remote\_get($this->api\_plan, $request\_params); |
| [716](#L716) | $account\_info = json\_decode(wp\_remote\_retrieve\_body($response), true); |
| [717](#L717) | $this->update\_options(get\_option(SPOKI\_OPTIONS), ["account\_info" => $account\_info]); |
| [718](#L718) | return $account\_info; |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | /\*\* |
| [722](#L722) | \* Check the status of the spoki keys |
| [723](#L723) | \* |
| [724](#L724) | \* @return array|WP\_Error |
| [725](#L725) | \*/ |
| [726](#L726) | public function check\_spoki\_status() |
| [727](#L727) | { |
| [728](#L728) | $secret = $this->options['secret'] ?? null; |
| [729](#L729) | $has\_woocommerce = spoki\_has\_woocommerce(); |
| [730](#L730) |  |
| [731](#L731) | $body = [ |
| [732](#L732) | "is\_plugin\_active" => true, |
| [733](#L733) | "plugin\_version" => $this->version, |
| [734](#L734) | "url" => $this->shop['url'], |
| [735](#L735) | "name" => $this->shop['name'], |
| [736](#L736) | "language" => $this->shop['language'], |
| [737](#L737) | "email" => $this->shop['email'], |
| [738](#L738) | "telephone" => $this->shop['telephone'], |
| [739](#L739) | "has\_woocommerce" => $has\_woocommerce, |
| [740](#L740) | "is\_widget\_fixed\_enabled" => $this->shop['has\_fixed\_support\_button'], |
| [741](#L741) | "is\_widget\_woo\_shop\_enabled" => $this->shop['has\_product\_item\_listing\_button'], |
| [742](#L742) | "is\_widget\_woo\_item\_enabled" => $this->shop['has\_single\_product\_button'], |
| [743](#L743) | "is\_widget\_woo\_cart\_enabled" => $this->shop['has\_cart\_button'], |
| [744](#L744) | "is\_widget\_woo\_checkout\_enabled" => $this->shop['has\_cart\_button'], |
| [745](#L745) | "is\_abandoned\_carts\_enabled" => $this->shop['has\_abandoned\_carts'], |
| [746](#L746) | "is\_woo\_send\_enabled" => $has\_woocommerce && $this->shop['has\_notifications'], |
| [747](#L747) | "is\_order\_updated\_notification\_enabled" => $this->shop['has\_order\_updated\_notification'], |
| [748](#L748) | "is\_order\_created\_notification\_enabled" => $this->shop['has\_order\_created\_notification'], |
| [749](#L749) | "is\_order\_deleted\_notification\_enabled" => $this->shop['has\_order\_deleted\_notification'], |
| [750](#L750) | "is\_order\_note\_added\_notification\_enabled" => $this->shop['has\_order\_note\_added\_notification'], |
| [751](#L751) | "is\_leave\_review\_notification\_enabled" => $this->shop['has\_leave\_review\_notification'], |
| [752](#L752) | "has\_cart\_recovered\_to\_seller\_notification" => $this->shop['has\_cart\_recovered\_to\_seller\_notification'], |
| [753](#L753) | "contact\_link" => $this->shop['contact\_link'] ?? '', |
| [754](#L754) | "default\_prefix" => $this->shop['default\_prefix'] ?? '', |
| [755](#L755) | "zip\_code" => $this->shop['billing\_data']['zip\_code'] ?? '', |
| [756](#L756) | "province" => $this->shop['billing\_data']['province'] ?? '', |
| [757](#L757) | "country" => $this->shop['billing\_data']['country'] ?? '', |
| [758](#L758) | "route" => $this->shop['billing\_data']['route'] ?? '', |
| [759](#L759) | "city" => $this->shop['billing\_data']['city'] ?? '', |
| [760](#L760) | "vat\_number" => $this->shop['billing\_data']['vat\_number'] ?? '', |
| [761](#L761) | "vat\_name" => $this->shop['billing\_data']['vat\_name'] ?? '', |
| [762](#L762) | "c\_f" => $this->shop['billing\_data']['c\_f'] ?? '', |
| [763](#L763) | "pec" => $this->shop['billing\_data']['pec'] ?? '', |
| [764](#L764) | "sid" => $this->shop['billing\_data']['sid'] ?? '', |
| [765](#L765) | ]; |
| [766](#L766) |  |
| [767](#L767) | if ($this->shop['has\_abandoned\_carts']) { |
| [768](#L768) | $spoki\_abandoned\_carts = Spoki\_Abandoned\_Carts::instance(); |
| [769](#L769) | $abandoned\_report = $spoki\_abandoned\_carts->get\_report\_by\_type(SPOKI\_CART\_ABANDONED\_ORDER); |
| [770](#L770) | $recovered\_report = $spoki\_abandoned\_carts->get\_report\_by\_type(SPOKI\_CART\_COMPLETED\_ORDER); |
| [771](#L771) | $body["abandoned\_carts\_reports"] = [ |
| [772](#L772) | "abandoned" => $abandoned\_report, |
| [773](#L773) | "recovered" => $recovered\_report, |
| [774](#L774) | ]; |
| [775](#L775) | } |
| [776](#L776) |  |
| [777](#L777) | $request\_params = [ |
| [778](#L778) | "headers" => [ |
| [779](#L779) | "Authorization" => $secret, |
| [780](#L780) | "language" => $this->shop['language'], |
| [781](#L781) | ], |
| [782](#L782) | "body" => $body, |
| [783](#L783) | "sslverify" => false, |
| [784](#L784) | "timeout" => 60, |
| [785](#L785) | ]; |
| [786](#L786) | return wp\_remote\_post($this->api\_status, $request\_params); |
| [787](#L787) | } |
| [788](#L788) |  |
| [789](#L789) | /\*\* |
| [790](#L790) | \* Render the admin setup page |
| [791](#L791) | \*/ |
| [792](#L792) | public function render\_setup\_page() |
| [793](#L793) | { |
| [794](#L794) | require\_once SPOKI\_DIR . 'includes/page-setup.php'; |
| [795](#L795) | $this->render\_components(); |
| [796](#L796) | } |
| [797](#L797) |  |
| [798](#L798) |  |
| [799](#L799) | /\*\* |
| [800](#L800) | \* Render the Spoki Components |
| [801](#L801) | \*/ |
| [802](#L802) | public function render\_components() |
| [803](#L803) | { |
| [804](#L804) | $components = ['abandoned-carts-info-dialog', 'customer-notifications-info-dialog', 'buttons-info-dialog']; |
| [805](#L805) | foreach ($components as $component) { |
| [806](#L806) | include\_once SPOKI\_DIR . "components/$component.php"; |
| [807](#L807) | } |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | /\*\* |
| [811](#L811) | \* Render the WhatsApp buttons in the website |
| [812](#L812) | \*/ |
| [813](#L813) | public function render\_buttons() |
| [814](#L814) | { |
| [815](#L815) | $has\_fixed\_support\_button = isset($this->options['buttons']['fixed\_support\_button\_check']) && $this->options['buttons']['fixed\_support\_button\_check'] == 1; |
| [816](#L816) | $has\_product\_item\_listing\_button = isset($this->options['woocommerce']['product\_item\_listing\_button\_check']) && $this->options['woocommerce']['product\_item\_listing\_button\_check'] == 1; |
| [817](#L817) | $has\_cart\_button = isset($this->options['woocommerce']['cart\_button\_check']) && $this->options['woocommerce']['cart\_button\_check'] == 1; |
| [818](#L818) | $has\_single\_product\_button = isset($this->options['woocommerce']['single\_product\_button\_check']) && $this->options['woocommerce']['single\_product\_button\_check'] == 1; |
| [819](#L819) |  |
| [820](#L820) | // Floating Button |
| [821](#L821) | if ($has\_fixed\_support\_button) { |
| [822](#L822) | add\_action('wp\_footer', array($this, 'render\_floating\_button'), 1); |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | // Product Item Listing Button |
| [826](#L826) | if ($has\_product\_item\_listing\_button) { |
| [827](#L827) | add\_action('woocommerce\_after\_shop\_loop\_item', array($this, 'render\_product\_item\_listing\_button'), 99); |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | // Cart Page Button |
| [831](#L831) | if ($has\_cart\_button) { |
| [832](#L832) | add\_action('woocommerce\_after\_cart\_totals', array($this, 'render\_cart\_button'), 99); |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | // Single Product Page Button |
| [836](#L836) | if ($has\_single\_product\_button) { |
| [837](#L837) | $position = isset($this->options['woocommerce']['single\_product\_button\_position']) ? $this->options['woocommerce']['single\_product\_button\_position'] : 'after\_atc'; |
| [838](#L838) | switch ($position) { |
| [839](#L839) | case 'under\_atc': |
| [840](#L840) | add\_action('woocommerce\_after\_add\_to\_cart\_form', array($this, 'render\_single\_product\_button'), 99); |
| [841](#L841) | break; |
| [842](#L842) | case 'after\_shortdesc': |
| [843](#L843) | add\_action('woocommerce\_before\_add\_to\_cart\_form', array($this, 'render\_single\_product\_button'), 99); |
| [844](#L844) | break; |
| [845](#L845) | case 'after\_atc': |
| [846](#L846) | default: |
| [847](#L847) | add\_action('woocommerce\_after\_add\_to\_cart\_button', array($this, 'render\_single\_product\_button'), 99); |
| [848](#L848) | break; |
| [849](#L849) | } |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | /\*\* |
| [853](#L853) | \* Render the spoki button wherever you want using the shortcode |
| [854](#L854) | \* @param $attrs |
| [855](#L855) | \* @param null $content |
| [856](#L856) | \*/ |
| [857](#L857) | function spoki\_button\_shortcode($attrs, $content = null) |
| [858](#L858) | { |
| [859](#L859) | $hide\_non\_working = isset($attrs['hide\_non\_working']) ? sanitize\_text\_field($attrs['hide\_non\_working']) : ''; |
| [860](#L860) | $working\_days\_times\_options = Spoki()->options['working\_days\_times']; |
| [861](#L861) | $is\_working\_days\_times\_enabled = isset($working\_days\_times\_options['enabled']) && $working\_days\_times\_options['enabled'] == 1; |
| [862](#L862) | $is\_non\_working\_day\_time = spoki\_is\_non\_working\_day\_time($working\_days\_times\_options); |
| [863](#L863) | if ($hide\_non\_working && $is\_working\_days\_times\_enabled && $is\_non\_working\_day\_time) { |
| [864](#L864) | return; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | $phone = isset($attrs['phone']) ? sanitize\_text\_field($attrs['phone']) : Spoki()->shop['telephone']; |
| [868](#L868) | $cta = isset($attrs['cta']) ? sanitize\_text\_field($attrs['cta']) : ''; |
| [869](#L869) | $title = isset($attrs['title']) ? sanitize\_text\_field($attrs['title']) : ''; |
| [870](#L870) |  |
| [871](#L871) | $message = isset($attrs['message']) ? sanitize\_text\_field($attrs['message']) : ''; |
| [872](#L872) | $non\_working\_message = isset($attrs['non\_working\_message']) ? sanitize\_text\_field($attrs['non\_working\_message']) : ''; |
| [873](#L873) | $is\_non\_working\_days\_times\_text\_enabled = isset($attrs['enable\_non\_working\_message']) ? sanitize\_text\_field($attrs['enable\_non\_working\_message']) : ''; |
| [874](#L874) |  |
| [875](#L875) | $final\_message = $message; |
| [876](#L876) | if ($is\_non\_working\_day\_time && $is\_non\_working\_days\_times\_text\_enabled == 1) { |
| [877](#L877) | $final\_message = $non\_working\_message; |
| [878](#L878) | } |
| [879](#L879) |  |
| [880](#L880) | $additional\_class = isset($attrs['additional\_class']) ? sanitize\_html\_class($attrs['additional\_class']) : ''; |
| [881](#L881) | $type = 5; |
| [882](#L882) | $color = isset($attrs['color']) ? sanitize\_hex\_color($attrs['color']) : '#23D366'; |
| [883](#L883) | $border\_type = isset($attrs['border\_type']) ? sanitize\_text\_field($attrs['border\_type']) : null; |
| [884](#L884) | $margin = [ |
| [885](#L885) | "top" => isset($attrs['margin\_top']) ? intval($attrs['margin\_top']) : 4, |
| [886](#L886) | "bottom" => isset($attrs['margin\_bottom']) ? intval($attrs['margin\_bottom']) : 4, |
| [887](#L887) | "left" => isset($attrs['margin\_left']) ? intval($attrs['margin\_left']) : 0, |
| [888](#L888) | "right" => isset($attrs['margin\_right']) ? intval($attrs['margin\_right']) : 0, |
| [889](#L889) | ]; |
| [890](#L890) | $padding = [ |
| [891](#L891) | "top" => isset($attrs['padding\_top']) ? intval($attrs['padding\_top']) : 8, |
| [892](#L892) | "bottom" => isset($attrs['padding\_bottom']) ? intval($attrs['padding\_bottom']) : 8, |
| [893](#L893) | "left" => isset($attrs['padding\_left']) ? intval($attrs['padding\_left']) : 14, |
| [894](#L894) | "right" => isset($attrs['padding\_right']) ? intval($attrs['padding\_right']) : 14, |
| [895](#L895) | ]; |
| [896](#L896) | $font\_size = isset($attrs['font\_size']) ? intval($attrs['font\_size']) : 12; |
| [897](#L897) | $id = isset($attrs['id']) ? sanitize\_html\_class($attrs['id']) : ''; |
| [898](#L898) | $class\_names = isset($attrs['class\_names']) ? sanitize\_html\_class($attrs['class\_names']) : ''; |
| [899](#L899) | $custom\_css = isset($attrs['custom\_css']) ? wp\_kses\_post($attrs['custom\_css']) : ''; |
| [900](#L900) |  |
| [901](#L901) | Spoki()->render\_relative\_button($phone, $cta, $title, $final\_message, $additional\_class, $type, $margin, $padding, $color, $border\_type, $font\_size, '', $id, $class\_names, $custom\_css); |
| [902](#L902) | } |
| [903](#L903) |  |
| [904](#L904) |  |
| [905](#L905) | add\_shortcode('spoki\_button', 'spoki\_button\_shortcode'); |
| [906](#L906) |  |
| [907](#L907) | add\_action('wp\_footer', array($this, 'render\_shadowed\_buttons')); |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) | public function disable\_checkout\_button() |
| [911](#L911) | { |
| [912](#L912) | remove\_action('woocommerce\_proceed\_to\_checkout', 'woocommerce\_button\_proceed\_to\_checkout', 20); |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | /\*\* |
| [916](#L916) | \* |
| [917](#L917) | \*/ |
| [918](#L918) | public function render\_shadowed\_buttons() |
| [919](#L919) | { |
| [920](#L920) | echo "<script>"; |
| [921](#L921) | include\_once SPOKI\_DIR . 'assets/js/spoki-shadowed-buttons.js'; |
| [922](#L922) | echo "</script>"; |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | /\*\* |
| [926](#L926) | \* Render the WhatsApp FAB on the website in every page |
| [927](#L927) | \*/ |
| [928](#L928) | public function render\_floating\_button() |
| [929](#L929) | { |
| [930](#L930) | if (isset($this->options['telephone']) && $this->options['telephone'] != '') { |
| [931](#L931) |  |
| [932](#L932) | /\*\* Check visibility conditions \*/ |
| [933](#L933) | $hide\_on\_posts = isset($this->options['buttons']['fixed\_support\_button\_hide\_post\_page']) && $this->options['buttons']['fixed\_support\_button\_hide\_post\_page'] == 1; |
| [934](#L934) | if ($hide\_on\_posts && is\_single() && 'post' == get\_post\_type()) { |
| [935](#L935) | return; |
| [936](#L936) | } |
| [937](#L937) | $hide\_on\_pages = isset($this->options['buttons']['fixed\_support\_button\_hide\_single\_page']) && $this->options['buttons']['fixed\_support\_button\_hide\_single\_page'] == 1; |
| [938](#L938) | if ($hide\_on\_pages && is\_page() && 'page' == get\_post\_type()) { |
| [939](#L939) | return; |
| [940](#L940) | } |
| [941](#L941) | $hide\_on\_shop = isset($this->options['buttons']['fixed\_support\_button\_hide\_shop\_page']) && $this->options['buttons']['fixed\_support\_button\_hide\_shop\_page'] == 1; |
| [942](#L942) | if ($hide\_on\_shop && is\_shop()) { |
| [943](#L943) | return; |
| [944](#L944) | } |
| [945](#L945) | $hide\_on\_product = isset($this->options['buttons']['fixed\_support\_button\_hide\_product\_page']) && $this->options['buttons']['fixed\_support\_button\_hide\_product\_page'] == 1; |
| [946](#L946) | if ($hide\_on\_product && is\_product()) { |
| [947](#L947) | return; |
| [948](#L948) | } |
| [949](#L949) | $hide\_on\_cart = isset($this->options['buttons']['fixed\_support\_button\_hide\_cart\_page']) && $this->options['buttons']['fixed\_support\_button\_hide\_cart\_page'] == 1; |
| [950](#L950) | if ($hide\_on\_cart && is\_cart()) { |
| [951](#L951) | return; |
| [952](#L952) | } |
| [953](#L953) | $hide\_on\_checkout = isset($this->options['buttons']['fixed\_support\_button\_hide\_checkout\_page']) && $this->options['buttons']['fixed\_support\_button\_hide\_checkout\_page'] == 1; |
| [954](#L954) | if ($hide\_on\_checkout && (is\_checkout() || is\_checkout\_pay\_page())) { |
| [955](#L955) | return; |
| [956](#L956) | } |
| [957](#L957) | $hide\_non\_working = isset($this->options['buttons']['fixed\_support\_button\_hide\_non\_working']) && $this->options['buttons']['fixed\_support\_button\_hide\_non\_working'] == 1; |
| [958](#L958) | $is\_working\_days\_times\_enabled = isset($this->options['working\_days\_times']['enabled']) && $this->options['working\_days\_times']['enabled'] == 1; |
| [959](#L959) | $is\_non\_working\_day\_time = isset($this->options['working\_days\_times']) && spoki\_is\_non\_working\_day\_time($this->options['working\_days\_times']);; |
| [960](#L960) | if ($hide\_non\_working && $is\_working\_days\_times\_enabled && $is\_non\_working\_day\_time) { |
| [961](#L961) | return; |
| [962](#L962) | } |
| [963](#L963) |  |
| [964](#L964) | /\*\* Can render, go on \*/ |
| [965](#L965) | $prefix = isset($this->options['prefix']) ? $this->options['prefix'] : ''; |
| [966](#L966) | $phone = $prefix . $this->options['telephone']; |
| [967](#L967) | $text = $this->options['buttons']['fixed\_support\_button\_text']; |
| [968](#L968) | $is\_non\_working\_days\_times\_text\_enabled = isset($this->options['buttons']['fixed\_support\_button\_non\_working\_text\_enabled']) && $this->options['buttons']['fixed\_support\_button\_non\_working\_text\_enabled'] == 1; |
| [969](#L969) | if ($is\_non\_working\_day\_time && $is\_non\_working\_days\_times\_text\_enabled) { |
| [970](#L970) | $text = isset($this->options['buttons']['fixed\_support\_button\_non\_working\_text']) ? $this->options['buttons']['fixed\_support\_button\_non\_working\_text'] : ""; |
| [971](#L971) | } |
| [972](#L972) | $position = $this->options['buttons']['fixed\_support\_button\_position'] == 'Left' ? 'left' : 'right'; |
| [973](#L973) | $border\_type = isset($this->options['buttons']['fixed\_support\_button\_border']) ? $this->options['buttons']['fixed\_support\_button\_border'] : 'circle'; |
| [974](#L974) | $size = isset($this->options['buttons']['fixed\_support\_button\_size']) ? $this->options['buttons']['fixed\_support\_button\_size'] : '50'; |
| [975](#L975) | $icon\_size = '65%'; |
| [976](#L976) | $border\_radius = '50%'; |
| [977](#L977) | if ($border\_type == 'squared') { |
| [978](#L978) | $border\_radius = '0'; |
| [979](#L979) | } elseif ($border\_type == 'rounded') { |
| [980](#L980) | $border\_radius = '8px'; |
| [981](#L981) | } |
| [982](#L982) | $color = isset($this->options['buttons']['fixed\_support\_button\_color']) ? $this->options['buttons']['fixed\_support\_button\_color'] : '#23D366'; |
| [983](#L983) | $bottom\_space = isset($this->options['buttons']['fixed\_support\_button\_bottom\_space']) ? $this->options['buttons']['fixed\_support\_button\_bottom\_space'] : '12'; |
| [984](#L984) | $side\_space = isset($this->options['buttons']['fixed\_support\_button\_side\_space']) ? $this->options['buttons']['fixed\_support\_button\_side\_space'] : '12'; |
| [985](#L985) | $furl = get\_bloginfo('url'); |
| [986](#L986) | $wa\_link = SPOKI\_BASE\_API\_BUTTONS . "?type=1&phone=$phone&text=" . urlencode($text) . "&furl=$furl"; |
| [987](#L987) |  |
| [988](#L988) | $spoki\_fixed\_btn\_label = ""; |
| [989](#L989) | $has\_label = isset($this->options['buttons']['fixed\_support\_button\_show\_label']) && $this->options['buttons']['fixed\_support\_button\_show\_label'] == 1; |
| [990](#L990) | if ($has\_label) { |
| [991](#L991) | $show\_on\_hover = (isset($this->options['buttons']['fixed\_support\_button\_show\_label\_on\_hover']) && $this->options['buttons']['fixed\_support\_button\_show\_label\_on\_hover'] == 1) ? 'hide-not-hover' : ''; |
| [992](#L992) | $label\_space = intval($size) + 12; |
| [993](#L993) | $label\_content = (isset($this->options['buttons']['fixed\_support\_button\_label\_content']) && $this->options['buttons']['fixed\_support\_button\_label\_content'] != "") ? $this->options['buttons']['fixed\_support\_button\_label\_content'] : \_\_('Chat with us 👋', "spoki"); |
| [994](#L994) | $label\_font\_size = (isset($this->options['buttons']['fixed\_support\_button\_label\_font\_size']) && $this->options['buttons']['fixed\_support\_button\_label\_font\_size'] != "") ? $this->options['buttons']['fixed\_support\_button\_label\_font\_size'] : '16'; |
| [995](#L995) | $label\_text\_color = isset($this->options['buttons']['fixed\_support\_button\_label\_text\_color']) ? $this->options['buttons']['fixed\_support\_button\_label\_text\_color'] : '#333333'; |
| [996](#L996) | $label\_background\_color = isset($this->options['buttons']['fixed\_support\_button\_label\_background\_color']) ? $this->options['buttons']['fixed\_support\_button\_label\_background\_color'] : '#FFFFFF'; |
| [997](#L997) | $label\_border\_radius = $border\_type == 'squared' ? '0' : '10'; |
| [998](#L998) | $label\_delay = (intval((isset($this->options['buttons']['fixed\_support\_button\_label\_delay']) && $this->options['buttons']['fixed\_support\_button\_label\_delay'] != "") ? $this->options['buttons']['fixed\_support\_button\_label\_delay'] : '0') \* 1000) + 1000; |
| [999](#L999) | $spoki\_fixed\_btn\_label = "<div class='spoki-fixed-btn-label $show\_on\_hover' style='display:none;$position:{$label\_space}px;font-size:{$label\_font\_size}px;color:$label\_text\_color;background-color:$label\_background\_color;border-radius:{$label\_border\_radius}px;'>$label\_content</div><script>(function (d) {setTimeout(function (){try {const shadowedButton = d.querySelector('#spoki-shadowed-fixed-button'); if (shadowedButton) {shadowedButton.shadowRoot.querySelector('.spoki-fixed-btn-label').style.display ='';}} catch (e) {console.log(e)}}, $label\_delay)})(document)</script>"; |
| [1000](#L1000) | } |
| [1001](#L1001) |  |
| [1002](#L1002) | $spoki\_fixed\_btn\_popup = ""; |
| [1003](#L1003) | $has\_popup = isset($this->options['buttons']['fixed\_support\_button\_show\_popup']) && $this->options['buttons']['fixed\_support\_button\_show\_popup'] == 1; |
| [1004](#L1004) | if ($has\_popup) { |
| [1005](#L1005) | $spoki\_fixed\_btn\_popup\_delay = (intval((isset($this->options['buttons']['fixed\_support\_button\_popup\_delay']) && $this->options['buttons']['fixed\_support\_button\_popup\_delay'] != "") ? $this->options['buttons']['fixed\_support\_button\_popup\_delay'] : '0') \* 1000) + 1000; |
| [1006](#L1006) | $spoki\_fixed\_btn\_popup = "<span class='spoki-fixed-btn-popup' style='display: none;'>1</span><script>(function (d) {setTimeout(function (){try {const shadowedButton = d.querySelector('#spoki-shadowed-fixed-button'); if (shadowedButton) {shadowedButton.shadowRoot.querySelector('.spoki-fixed-btn-popup').style.display ='';}} catch (e) {console.log(e)}}, $spoki\_fixed\_btn\_popup\_delay)})(document)</script>"; |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | $hidden\_mobile = isset($this->options['buttons']['fixed\_support\_button\_hide\_mobile']) && $this->options['buttons']['fixed\_support\_button\_hide\_mobile'] == 1 ? "hidden-mobile" : ""; |
| [1010](#L1010) | $hidden\_tablet = isset($this->options['buttons']['fixed\_support\_button\_hide\_tablet']) && $this->options['buttons']['fixed\_support\_button\_hide\_tablet'] == 1 ? "hidden-tablet" : ""; |
| [1011](#L1011) | $hidden\_desktop = isset($this->options['buttons']['fixed\_support\_button\_hide\_desktop']) && $this->options['buttons']['fixed\_support\_button\_hide\_desktop'] == 1 ? "hidden-desktop" : ""; |
| [1012](#L1012) | $class = "$hidden\_mobile $hidden\_tablet $hidden\_desktop"; |
| [1013](#L1013) |  |
| [1014](#L1014) | $chat\_widget = ""; |
| [1015](#L1015) | $has\_chat\_widget = isset($this->options['buttons']['fixed\_support\_button\_show\_chat\_widget']) && $this->options['buttons']['fixed\_support\_button\_show\_chat\_widget'] == 1; |
| [1016](#L1016) | if ($has\_chat\_widget) { |
| [1017](#L1017) | $background\_image\_url = plugins\_url() . '/' . SPOKI\_PLUGIN\_NAME . '/assets/images/wa-background.jpeg'; |
| [1018](#L1018) | $from\_message = $this->options['buttons']['fixed\_support\_button\_chat\_widget\_message']; |
| [1019](#L1019) | $send\_icon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>'; |
| [1020](#L1020) | $chat\_widget\_delay = intval((isset($this->options['buttons']['fixed\_support\_button\_chat\_widget\_delay']) && $this->options['buttons']['fixed\_support\_button\_chat\_widget\_delay'] != "") ? $this->options['buttons']['fixed\_support\_button\_chat\_widget\_delay'] : '0') \* 1000; |
| [1021](#L1021) | $chat\_widget\_delay\_script = ""; |
| [1022](#L1022) | if ($chat\_widget\_delay != 0) { |
| [1023](#L1023) | $chat\_widget\_delay = $chat\_widget\_delay + 1000; |
| [1024](#L1024) | $chat\_widget\_delay\_script = "<script>(function (d) {setTimeout(function (){try {const shadowedButton = d.querySelector('#spoki-shadowed-fixed-button'); if (shadowedButton) {shadowedButton.shadowRoot.querySelector('#spoki-chat-preview').classList.remove('hidden')}} catch (e) {console.log(e)}}, $chat\_widget\_delay)})(document)</script>"; |
| [1025](#L1025) | } |
| [1026](#L1026) | $chat\_widget\_script = "<script>(function (d) {setTimeout(function(){const shadowedButton = d.querySelector('#spoki-shadowed-fixed-button'); if (shadowedButton) {shadowedButton.shadowRoot.querySelector('#spoki-chat-link').addEventListener('click', function(e){e.preventDefault();document.querySelector('#spoki-shadowed-fixed-button').shadowRoot.querySelector('#spoki-chat-preview').classList.toggle('hidden')})}}, 1000)})(document)</script>$chat\_widget\_delay\_script"; |
| [1027](#L1027) | $link = SPOKI\_BASE\_API\_BUTTONS; |
| [1028](#L1028) | $furl = get\_bloginfo('url'); |
| [1029](#L1029) | $chat\_widget = "<div id='spoki-chat-preview' class='hidden' style='bottom:{$size}px;background-image: url(\"{$background\_image\_url}\")'><div class='spoki-chat-preview-chat-message'>{$from\_message}</div><div id='spoki-chat-preview-footer'><form method='get' target='\_blank' action='$link'><input type='hidden' name='phone' value='{$phone}'/><input type='hidden' name='furl' value='{$furl}'/><input type='hidden' name='type' value='1'/><input id='spoki-chat-preview-message' type='text' name='text' value='$text' /><button id='spoki-chat-preview-send' type='submit'>{$send\_icon}</button></form></div></div>$chat\_widget\_script"; |
| [1030](#L1030) | } |
| [1031](#L1031) |  |
| [1032](#L1032) | echo "<div id='spoki-shadowed-fixed-button' class='spoki-shadowed-button'><div id='spoki-fixed-btn' class='$class' style='$position:{$side\_space}px;bottom:{$bottom\_space}px;'>{$chat\_widget}{$spoki\_fixed\_btn\_label}{$spoki\_fixed\_btn\_popup}<a id='spoki-chat-link' style='background-color:{$color};border-radius:$border\_radius;height:{$size}px;width:{$size}px;' href='$wa\_link' target='\_blank' rel='nofollow'>" . spoki\_get\_wa\_logo($size) . "</a></div></div>"; |
| [1033](#L1033) | } |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) | /\*\* |
| [1037](#L1037) | \* Render the product button for every product in shop page |
| [1038](#L1038) | \*/ |
| [1039](#L1039) | public function render\_product\_item\_listing\_button() |
| [1040](#L1040) | { |
| [1041](#L1041) | global $product; |
| [1042](#L1042) | $hide\_non\_working = isset($this->options['woocommerce']['product\_item\_listing\_button\_hide\_non\_working']) && $this->options['woocommerce']['product\_item\_listing\_button\_hide\_non\_working'] == 1; |
| [1043](#L1043) | $is\_working\_days\_times\_enabled = isset($this->options['working\_days\_times']['enabled']) && $this->options['working\_days\_times']['enabled'] == 1; |
| [1044](#L1044) | $is\_non\_working\_day\_time = isset($this->options['working\_days\_times']) && spoki\_is\_non\_working\_day\_time($this->options['working\_days\_times']);; |
| [1045](#L1045) | if ($hide\_non\_working && $is\_working\_days\_times\_enabled && $is\_non\_working\_day\_time) { |
| [1046](#L1046) | return; |
| [1047](#L1047) | } |
| [1048](#L1048) |  |
| [1049](#L1049) | $prefix = isset($this->options['prefix']) ? $this->options['prefix'] : ''; |
| [1050](#L1050) | $phone = $prefix . $this->options['telephone']; |
| [1051](#L1051) | $cta = \_\_("Request support on WhatsApp", "spoki"); |
| [1052](#L1052) | if (isset($this->options['woocommerce']['product\_item\_listing\_button\_cta']) && !empty($this->options['woocommerce']['product\_item\_listing\_button\_cta'])) { |
| [1053](#L1053) | $cta = $this->options['woocommerce']['product\_item\_listing\_button\_cta']; |
| [1054](#L1054) | } |
| [1055](#L1055) | $message = \_\_("Hi, I want to buy:", "spoki"); |
| [1056](#L1056) | if (isset($this->options['woocommerce']['product\_item\_listing\_button\_text']) && !empty($this->options['woocommerce']['product\_item\_listing\_button\_text'])) { |
| [1057](#L1057) | $message = $this->options['woocommerce']['product\_item\_listing\_button\_text']; |
| [1058](#L1058) | } |
| [1059](#L1059) | $is\_non\_working\_days\_times\_text\_enabled = isset($this->options['woocommerce']['product\_item\_listing\_button\_non\_working\_text\_enabled']) && $this->options['woocommerce']['product\_item\_listing\_button\_non\_working\_text\_enabled'] == 1; |
| [1060](#L1060) | if ($is\_non\_working\_day\_time && $is\_non\_working\_days\_times\_text\_enabled) { |
| [1061](#L1061) | $message = isset($this->options['woocommerce']['product\_item\_listing\_button\_non\_working\_text']) ? $this->options['woocommerce']['product\_item\_listing\_button\_non\_working\_text'] : ""; |
| [1062](#L1062) | } |
| [1063](#L1063) | $color = isset($this->options['woocommerce']['product\_item\_listing\_button\_color']) ? $this->options['woocommerce']['product\_item\_listing\_button\_color'] : '#23D366'; |
| [1064](#L1064) | $font\_size = isset($this->options['woocommerce']['product\_item\_listing\_button\_font\_size']) ? $this->options['woocommerce']['product\_item\_listing\_button\_font\_size'] : '12'; |
| [1065](#L1065) | $border\_type = isset($this->options['woocommerce']['product\_item\_listing\_button\_border']) ? $this->options['woocommerce']['product\_item\_listing\_button\_border'] : 'rounded'; |
| [1066](#L1066) |  |
| [1067](#L1067) | $margin = [ |
| [1068](#L1068) | "top" => isset($this->options['woocommerce']['product\_item\_listing\_button\_margin\_top']) ? $this->options['woocommerce']['product\_item\_listing\_button\_margin\_top'] : '4', |
| [1069](#L1069) | "bottom" => isset($this->options['woocommerce']['product\_item\_listing\_button\_margin\_bottom']) ? $this->options['woocommerce']['product\_item\_listing\_button\_margin\_bottom'] : '4', |
| [1070](#L1070) | "left" => isset($this->options['woocommerce']['product\_item\_listing\_button\_margin\_left']) ? $this->options['woocommerce']['product\_item\_listing\_button\_margin\_left'] : '0', |
| [1071](#L1071) | "right" => isset($this->options['woocommerce']['product\_item\_listing\_button\_margin\_right']) ? $this->options['woocommerce']['product\_item\_listing\_button\_margin\_right'] : '0', |
| [1072](#L1072) | ]; |
| [1073](#L1073) |  |
| [1074](#L1074) | $padding = [ |
| [1075](#L1075) | "top" => isset($this->options['woocommerce']['product\_item\_listing\_button\_padding\_top']) ? $this->options['woocommerce']['product\_item\_listing\_button\_padding\_top'] : '8', |
| [1076](#L1076) | "bottom" => isset($this->options['woocommerce']['product\_item\_listing\_button\_padding\_bottom']) ? $this->options['woocommerce']['product\_item\_listing\_button\_padding\_bottom'] : '8', |
| [1077](#L1077) | "left" => isset($this->options['woocommerce']['product\_item\_listing\_button\_padding\_left']) ? $this->options['woocommerce']['product\_item\_listing\_button\_padding\_left'] : '14', |
| [1078](#L1078) | "right" => isset($this->options['woocommerce']['product\_item\_listing\_button\_padding\_right']) ? $this->options['woocommerce']['product\_item\_listing\_button\_padding\_right'] : '14', |
| [1079](#L1079) | ]; |
| [1080](#L1080) |  |
| [1081](#L1081) | $this->render\_product\_button($product, $phone, $cta, $message, $margin, $padding, $color, $border\_type, $font\_size, true); |
| [1082](#L1082) | } |
| [1083](#L1083) |  |
| [1084](#L1084) | /\*\* |
| [1085](#L1085) | \* Render the button in the cart page |
| [1086](#L1086) | \*/ |
| [1087](#L1087) | public function render\_cart\_button() |
| [1088](#L1088) | { |
| [1089](#L1089) | global $product; |
| [1090](#L1090) | $hide\_non\_working = isset($this->options['woocommerce']['cart\_button\_hide\_non\_working']) && $this->options['woocommerce']['cart\_button\_hide\_non\_working'] == 1; |
| [1091](#L1091) | $is\_working\_days\_times\_enabled = isset($this->options['working\_days\_times']['enabled']) && $this->options['working\_days\_times']['enabled'] == 1; |
| [1092](#L1092) | $is\_non\_working\_day\_time = isset($this->options['working\_days\_times']) && spoki\_is\_non\_working\_day\_time($this->options['working\_days\_times']);; |
| [1093](#L1093) | if ($hide\_non\_working && $is\_working\_days\_times\_enabled && $is\_non\_working\_day\_time) { |
| [1094](#L1094) | return; |
| [1095](#L1095) | } |
| [1096](#L1096) | $prefix = isset($this->options['prefix']) ? $this->options['prefix'] : ''; |
| [1097](#L1097) | $phone = $prefix . $this->options['telephone']; |
| [1098](#L1098) | $cta = \_\_("Order via WhatsApp", "spoki"); |
| [1099](#L1099) | if (isset($this->options['woocommerce']['cart\_button\_cta']) && !empty($this->options['woocommerce']['cart\_button\_cta'])) { |
| [1100](#L1100) | $cta = $this->options['woocommerce']['cart\_button\_cta']; |
| [1101](#L1101) | } |
| [1102](#L1102) | $message = \_\_("Hi, I want to buy:", "spoki"); |
| [1103](#L1103) | if (isset($this->options['woocommerce']['cart\_button\_text']) && !empty($this->options['woocommerce']['cart\_button\_text'])) { |
| [1104](#L1104) | $message = $this->options['woocommerce']['cart\_button\_text']; |
| [1105](#L1105) | } |
| [1106](#L1106) | $is\_non\_working\_days\_times\_text\_enabled = isset($this->options['woocommerce']['cart\_button\_non\_working\_text\_enabled']) && $this->options['woocommerce']['cart\_button\_non\_working\_text\_enabled'] == 1; |
| [1107](#L1107) | if ($is\_non\_working\_day\_time && $is\_non\_working\_days\_times\_text\_enabled) { |
| [1108](#L1108) | $message = isset($this->options['woocommerce']['cart\_button\_non\_working\_text']) ? $this->options['woocommerce']['cart\_button\_non\_working\_text'] : ""; |
| [1109](#L1109) | } |
| [1110](#L1110) | $color = isset($this->options['woocommerce']['cart\_button\_color']) ? $this->options['woocommerce']['cart\_button\_color'] : '#23D366'; |
| [1111](#L1111) | $font\_size = isset($this->options['woocommerce']['cart\_button\_font\_size']) ? $this->options['woocommerce']['cart\_button\_font\_size'] : '12'; |
| [1112](#L1112) | $icon\_size = intval($font\_size) < 16 ? 16 : $font\_size; |
| [1113](#L1113) | $final\_message = urlencode($message); |
| [1114](#L1114) | $products = WC()->cart->get\_cart(); |
| [1115](#L1115) |  |
| [1116](#L1116) | foreach ($products as $item) { |
| [1117](#L1117) | $product\_id = $item['product\_id']; |
| [1118](#L1118) | $qty = $item['quantity']; |
| [1119](#L1119) | $product = wc\_get\_product($product\_id); |
| [1120](#L1120) | $product\_url = $product->get\_permalink(); |
| [1121](#L1121) | $product\_title = $product->get\_name(); |
| [1122](#L1122) | $price = wp\_strip\_all\_tags(wc\_price(wc\_get\_price\_including\_tax($product))); |
| [1123](#L1123) | $encoded\_title = urlencode($product\_title); |
| [1124](#L1124) | $encoded\_product\_url = urlencode($product\_url); |
| [1125](#L1125) | $final\_message .= "%0D%0A%0D%0A\_(ID:%20$product\_id)\_%20\*$encoded\_title\*%20$price%20x$qty%0D%0A$encoded\_product\_url"; |
| [1126](#L1126) | } |
| [1127](#L1127) | $total = wp\_strip\_all\_tags(wc\_price(WC()->cart->get\_subtotal())); |
| [1128](#L1128) | $final\_message .= "%0D%0A%0D%0A\*" . \_\_("Total", "spoki") . "\*: %20$total%20"; |
| [1129](#L1129) |  |
| [1130](#L1130) | $furl = get\_bloginfo('url'); |
| [1131](#L1131) | $href = SPOKI\_BASE\_API\_BUTTONS . "?type=4&phone=$phone&text=$final\_message&furl=$furl"; |
| [1132](#L1132) | $title = "$cta"; |
| [1133](#L1133) | $class = 'button spoki-button size-4'; |
| [1134](#L1134) | $border\_type = isset($this->options['woocommerce']['cart\_button\_border']) ? $this->options['woocommerce']['cart\_button\_border'] : 'rounded'; |
| [1135](#L1135) |  |
| [1136](#L1136) | $border\_radius = '16px'; |
| [1137](#L1137) | if ($border\_type == 'squared') { |
| [1138](#L1138) | $border\_radius = '0'; |
| [1139](#L1139) | } |
| [1140](#L1140) |  |
| [1141](#L1141) | $margin = [ |
| [1142](#L1142) | "top" => isset($this->options['woocommerce']['cart\_button\_margin\_top']) ? $this->options['woocommerce']['cart\_button\_margin\_top'] : '4', |
| [1143](#L1143) | "bottom" => isset($this->options['woocommerce']['cart\_button\_margin\_bottom']) ? $this->options['woocommerce']['cart\_button\_margin\_bottom'] : '4', |
| [1144](#L1144) | "left" => isset($this->options['woocommerce']['cart\_button\_margin\_left']) ? $this->options['woocommerce']['cart\_button\_margin\_left'] : '0', |
| [1145](#L1145) | "right" => isset($this->options['woocommerce']['cart\_button\_margin\_right']) ? $this->options['woocommerce']['cart\_button\_margin\_right'] : '0', |
| [1146](#L1146) | ]; |
| [1147](#L1147) | $padding = [ |
| [1148](#L1148) | "top" => isset($this->options['woocommerce']['cart\_button\_padding\_top']) ? $this->options['woocommerce']['cart\_button\_padding\_top'] : '8', |
| [1149](#L1149) | "bottom" => isset($this->options['woocommerce']['cart\_button\_padding\_bottom']) ? $this->options['woocommerce']['cart\_button\_padding\_bottom'] : '8', |
| [1150](#L1150) | "left" => isset($this->options['woocommerce']['cart\_button\_padding\_left']) ? $this->options['woocommerce']['cart\_button\_padding\_left'] : '14', |
| [1151](#L1151) | "right" => isset($this->options['woocommerce']['cart\_button\_padding\_right']) ? $this->options['woocommerce']['cart\_button\_padding\_right'] : '14', |
| [1152](#L1152) | ]; |
| [1153](#L1153) |  |
| [1154](#L1154) | $margin\_style = "margin-top:{$margin['top']}px;margin-bottom:{$margin['bottom']}px;margin-left:{$margin['left']}px;margin-right:{$margin['right']}px;"; |
| [1155](#L1155) | $padding\_style = "padding-top:{$padding['top']}px;padding-bottom:{$padding['bottom']}px;padding-left:{$padding['left']}px;padding-right:{$padding['right']}px;"; |
| [1156](#L1156) |  |
| [1157](#L1157) | echo "<div class='spoki-shadowed-button'><div class='spoki-button-relative' style='{$margin\_style}'><a href='$href' target='\_blank' rel='nofollow' title='$title' class='$class' style='background-color:$color;border-radius:$border\_radius;font-size:{$font\_size}px;{$padding\_style}'>" . spoki\_get\_wa\_logo($icon\_size) . "<span>$cta</span></a></div></div>"; |
| [1158](#L1158) | } |
| [1159](#L1159) |  |
| [1160](#L1160) | /\*\* |
| [1161](#L1161) | \* Render the button in the product page |
| [1162](#L1162) | \*/ |
| [1163](#L1163) | public function render\_single\_product\_button() |
| [1164](#L1164) | { |
| [1165](#L1165) | global $product; |
| [1166](#L1166) | $hide\_non\_working = isset($this->options['woocommerce']['single\_product\_button\_hide\_non\_working']) && $this->options['woocommerce']['single\_product\_button\_hide\_non\_working'] == 1; |
| [1167](#L1167) | $is\_working\_days\_times\_enabled = isset($this->options['working\_days\_times']['enabled']) && $this->options['working\_days\_times']['enabled'] == 1; |
| [1168](#L1168) | $is\_non\_working\_day\_time = isset($this->options['working\_days\_times']) && spoki\_is\_non\_working\_day\_time($this->options['working\_days\_times']); |
| [1169](#L1169) | if ($hide\_non\_working && $is\_working\_days\_times\_enabled && $is\_non\_working\_day\_time) { |
| [1170](#L1170) | return; |
| [1171](#L1171) | } |
| [1172](#L1172) |  |
| [1173](#L1173) | $prefix = isset($this->options['prefix']) ? $this->options['prefix'] : ''; |
| [1174](#L1174) | $phone = $prefix . $this->options['telephone']; |
| [1175](#L1175) | $cta = \_\_("Request support on WhatsApp", "spoki"); |
| [1176](#L1176) | if (isset($this->options['woocommerce']['single\_product\_button\_cta']) && !empty($this->options['woocommerce']['single\_product\_button\_cta'])) { |
| [1177](#L1177) | $cta = $this->options['woocommerce']['single\_product\_button\_cta']; |
| [1178](#L1178) | } |
| [1179](#L1179) | $message = \_\_("Hi, I want to buy:", "spoki"); |
| [1180](#L1180) | if (isset($this->options['woocommerce']['single\_product\_button\_text']) && !empty($this->options['woocommerce']['single\_product\_button\_text'])) { |
| [1181](#L1181) | $message = $this->options['woocommerce']['single\_product\_button\_text']; |
| [1182](#L1182) | } |
| [1183](#L1183) | $is\_non\_working\_days\_times\_text\_enabled = isset($this->options['woocommerce']['single\_product\_button\_non\_working\_text\_enabled']) && $this->options['woocommerce']['single\_product\_button\_non\_working\_text\_enabled'] == 1; |
| [1184](#L1184) | if ($is\_non\_working\_day\_time && $is\_non\_working\_days\_times\_text\_enabled) { |
| [1185](#L1185) | $message = isset($this->options['woocommerce']['single\_product\_button\_non\_working\_text']) ? $this->options['woocommerce']['single\_product\_button\_non\_working\_text'] : ""; |
| [1186](#L1186) | } |
| [1187](#L1187) | $position = isset($this->options['woocommerce']['single\_product\_button\_position']) ? $this->options['woocommerce']['single\_product\_button\_position'] : 'after\_atc'; |
| [1188](#L1188) | $color = isset($this->options['woocommerce']['single\_product\_button\_color']) ? $this->options['woocommerce']['single\_product\_button\_color'] : '#23D366'; |
| [1189](#L1189) | $font\_size = isset($this->options['woocommerce']['single\_product\_button\_font\_size']) ? $this->options['woocommerce']['single\_product\_button\_font\_size'] : '12'; |
| [1190](#L1190) | $border\_type = isset($this->options['woocommerce']['single\_product\_button\_border']) ? $this->options['woocommerce']['single\_product\_button\_border'] : 'rounded'; |
| [1191](#L1191) |  |
| [1192](#L1192) | $margin = [ |
| [1193](#L1193) | "top" => isset($this->options['woocommerce']['single\_product\_button\_margin\_top']) ? $this->options['woocommerce']['single\_product\_button\_margin\_top'] : '4', |
| [1194](#L1194) | "bottom" => isset($this->options['woocommerce']['single\_product\_button\_margin\_bottom']) ? $this->options['woocommerce']['single\_product\_button\_margin\_bottom'] : '4', |
| [1195](#L1195) | "left" => isset($this->options['woocommerce']['single\_product\_button\_margin\_left']) ? $this->options['woocommerce']['single\_product\_button\_margin\_left'] : '0', |
| [1196](#L1196) | "right" => isset($this->options['woocommerce']['single\_product\_button\_margin\_right']) ? $this->options['woocommerce']['single\_product\_button\_margin\_right'] : '0', |
| [1197](#L1197) | ]; |
| [1198](#L1198) |  |
| [1199](#L1199) | $padding = [ |
| [1200](#L1200) | "top" => isset($this->options['woocommerce']['single\_product\_button\_padding\_top']) ? $this->options['woocommerce']['single\_product\_button\_padding\_top'] : '8', |
| [1201](#L1201) | "bottom" => isset($this->options['woocommerce']['single\_product\_button\_padding\_bottom']) ? $this->options['woocommerce']['single\_product\_button\_padding\_bottom'] : '8', |
| [1202](#L1202) | "left" => isset($this->options['woocommerce']['single\_product\_button\_padding\_left']) ? $this->options['woocommerce']['single\_product\_button\_padding\_left'] : '14', |
| [1203](#L1203) | "right" => isset($this->options['woocommerce']['single\_product\_button\_padding\_right']) ? $this->options['woocommerce']['single\_product\_button\_padding\_right'] : '14', |
| [1204](#L1204) | ]; |
| [1205](#L1205) |  |
| [1206](#L1206) | $this->render\_product\_button($product, $phone, $cta, $message, $margin, $padding, $color, $border\_type, $font\_size, false, $position); |
| [1207](#L1207) | } |
| [1208](#L1208) |  |
| [1209](#L1209) | /\*\* |
| [1210](#L1210) | \* Render the button of a product |
| [1211](#L1211) | \* |
| [1212](#L1212) | \* @param $product |
| [1213](#L1213) | \* @param $phone |
| [1214](#L1214) | \* @param $cta |
| [1215](#L1215) | \* @param $message |
| [1216](#L1216) | \* @param null $position |
| [1217](#L1217) | \*/ |
| [1218](#L1218) | public function render\_product\_button($product, $phone, $cta, $message, $margin, $padding, $color = '#23D366', $border\_type = 'rounded', $font\_size = '12', $is\_listing = false, $position = null) |
| [1219](#L1219) | { |
| [1220](#L1220) | $product\_url = $product->get\_permalink(); |
| [1221](#L1221) | $product\_title = $product->get\_name(); |
| [1222](#L1222) | $product\_id = $product->get\_id(); |
| [1223](#L1223) | $price = wp\_strip\_all\_tags(wc\_price(wc\_get\_price\_including\_tax($product))); |
| [1224](#L1224) | $encoded\_message = urlencode($message); |
| [1225](#L1225) | $encoded\_title = urlencode($product\_title); |
| [1226](#L1226) | $encoded\_product\_url = urlencode($product\_url); |
| [1227](#L1227) | $final\_message = "$encoded\_message%0D%0A%0D%0A(ID:%20$product\_id)%20\*$encoded\_title\*%20$price%0D%0A$encoded\_product\_url"; |
| [1228](#L1228) | $type = $is\_listing ? '2' : '3'; |
| [1229](#L1229) | $title = "$cta $product\_title"; |
| [1230](#L1230) | $additional\_class = sprintf('product\_type\_%s', $product->get\_type()); |
| [1231](#L1231) |  |
| [1232](#L1232) | $this->render\_relative\_button($phone, $cta, $title, $final\_message, $additional\_class, $type, $margin, $padding, $color, $border\_type, $font\_size, $position); |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | /\*\* |
| [1236](#L1236) | \* Render a relative button |
| [1237](#L1237) | \*/ |
| [1238](#L1238) | public function render\_relative\_button($phone, $cta, $title, $final\_message, $additional\_class, $type, $margin, $padding, $color = '#23D366', $border\_type = 'rounded', $font\_size = '12', $position = null, $id = '', $class\_names = '', $custom\_css = '') |
| [1239](#L1239) | { |
| [1240](#L1240) | $class = sprintf('button spoki-button %s', esc\_attr(sanitize\_html\_class($additional\_class))); |
| [1241](#L1241) | if (isset($position)) { |
| [1242](#L1242) | $class .= " size-2 $position"; |
| [1243](#L1243) | } else { |
| [1244](#L1244) | $class .= " size-4"; |
| [1245](#L1245) | } |
| [1246](#L1246) |  |
| [1247](#L1247) | $border\_radius = '16px'; |
| [1248](#L1248) | if ($border\_type == 'squared') { |
| [1249](#L1249) | $border\_radius = '0'; |
| [1250](#L1250) | } |
| [1251](#L1251) |  |
| [1252](#L1252) | $furl = get\_bloginfo('url'); |
| [1253](#L1253) | $href = SPOKI\_BASE\_API\_BUTTONS . "?type={$type}&phone=" . rawurlencode($phone) . "&text=" . rawurlencode($final\_message) . "&furl=" . rawurlencode($furl); |
| [1254](#L1254) | $icon\_size = intval($font\_size) < 16 ? 16 : $font\_size; |
| [1255](#L1255) |  |
| [1256](#L1256) | $margin\_style = "margin-top:" . esc\_attr($margin['top']) . "px;margin-bottom:" . esc\_attr($margin['bottom']) . "px;margin-left:" . esc\_attr($margin['left']) . "px;margin-right:" . esc\_attr($margin['right']) . "px;"; |
| [1257](#L1257) | $padding\_style = "padding-top:" . esc\_attr($padding['top']) . "px;padding-bottom:" . esc\_attr($padding['bottom']) . "px;padding-left:" . esc\_attr($padding['left']) . "px;padding-right:" . esc\_attr($padding['right']) . "px;"; |
| [1258](#L1258) |  |
| [1259](#L1259) | echo "<div class='spoki-shadowed-button'><div class='spoki-button-relative " . esc\_attr(sanitize\_html\_class($class\_names)) . "' id='" . esc\_attr(sanitize\_html\_class($id)) . "' style='{$margin\_style}'><a href='". esc\_url($href) ."' target='\_blank' rel='nofollow' title='" . esc\_attr($title) . "' class='{$class}' style='background-color:" . esc\_attr(sanitize\_hex\_color($color)) . ";border-radius:" . esc\_attr($border\_radius) . ";font-size:" . esc\_attr($font\_size) . "px;{$padding\_style}'>" . spoki\_get\_wa\_logo($icon\_size) . "<span>" . esc\_html($cta) . "</span></a><style>" . wp\_kses\_post($custom\_css) . "</style></div></div>"; |
| [1260](#L1260) | } |
| [1261](#L1261) |  |
| [1262](#L1262) | /\*\* |
| [1263](#L1263) | \* Get the link to change plan to pro |
| [1264](#L1264) | \* |
| [1265](#L1265) | \* @return string |
| [1266](#L1266) | \*/ |
| [1267](#L1267) | public function get\_pro\_plan\_link(): string |
| [1268](#L1268) | { |
| [1269](#L1269) | return 'https://spoki.it/upgrade-spoki-plugin/'; |
| [1270](#L1270) | } |
| [1271](#L1271) |  |
| [1272](#L1272) | /\*\* |
| [1273](#L1273) | \* Update Spoki options |
| [1274](#L1274) | \* |
| [1275](#L1275) | \* @param $current\_options |
| [1276](#L1276) | \* @param $new\_options |
| [1277](#L1277) | \*/ |
| [1278](#L1278) | private function update\_options($current\_options, $new\_options) |
| [1279](#L1279) | { |
| [1280](#L1280) | $c\_options = is\_array($current\_options) ? $current\_options : []; |
| [1281](#L1281) | if (isset($new\_options["woocommerce"])) { |
| [1282](#L1282) | $woocommerce = []; |
| [1283](#L1283) | if (isset($c\_options["abandoned\_carts"])) { |
| [1284](#L1284) | $woocommerce = array\_merge($c\_options["woocommerce"], $new\_options["woocommerce"]); |
| [1285](#L1285) | } else { |
| [1286](#L1286) | $woocommerce = $new\_options["woocommerce"]; |
| [1287](#L1287) | } |
| [1288](#L1288) | $new\_options["woocommerce"] = $woocommerce; |
| [1289](#L1289) | } |
| [1290](#L1290) | if (isset($new\_options["abandoned\_carts"])) { |
| [1291](#L1291) | $abandoned\_carts = []; |
| [1292](#L1292) | if (isset($c\_options["abandoned\_carts"])) { |
| [1293](#L1293) | $abandoned\_carts = array\_merge($c\_options["abandoned\_carts"], $new\_options["abandoned\_carts"]); |
| [1294](#L1294) | } else { |
| [1295](#L1295) | $abandoned\_carts = $new\_options["abandoned\_carts"]; |
| [1296](#L1296) | } |
| [1297](#L1297) | $new\_options["abandoned\_carts"] = $abandoned\_carts; |
| [1298](#L1298) | } |
| [1299](#L1299) | if (isset($new\_options["secret\_status"])) { |
| [1300](#L1300) | $secret\_status = []; |
| [1301](#L1301) | if (isset($c\_options["secret\_status"])) { |
| [1302](#L1302) | $secret\_status = array\_merge($c\_options["secret\_status"], $new\_options["secret\_status"]); |
| [1303](#L1303) | } else { |
| [1304](#L1304) | $secret\_status = $new\_options["secret\_status"]; |
| [1305](#L1305) | } |
| [1306](#L1306) | $new\_options["secret\_status"] = $secret\_status; |
| [1307](#L1307) | } |
| [1308](#L1308) | if (isset($new\_options["account\_info"])) { |
| [1309](#L1309) | $account\_info = []; |
| [1310](#L1310) | if (isset($c\_options["account\_info"])) { |
| [1311](#L1311) | $account\_info = array\_merge($c\_options["account\_info"], $new\_options["account\_info"]); |
| [1312](#L1312) | } else { |
| [1313](#L1313) | $account\_info = $new\_options["account\_info"]; |
| [1314](#L1314) | } |
| [1315](#L1315) | $new\_options["account\_info"] = $account\_info; |
| [1316](#L1316) | } |
| [1317](#L1317) | update\_option(SPOKI\_OPTIONS, array\_merge($c\_options, $new\_options)); |
| [1318](#L1318) | $this->options = get\_option(SPOKI\_OPTIONS); |
| [1319](#L1319) | } |
| [1320](#L1320) |  |
| [1321](#L1321) | /\*\* |
| [1322](#L1322) | \* Check the secret status periodically |
| [1323](#L1323) | \*/ |
| [1324](#L1324) | public function check\_secret\_status() |
| [1325](#L1325) | { |
| [1326](#L1326) | $this->fetch\_secret\_status(true); |
| [1327](#L1327) | } |
| [1328](#L1328) |  |
| [1329](#L1329) | /\*\* |
| [1330](#L1330) | \* Fetch the status of the Spoki keys |
| [1331](#L1331) | \*/ |
| [1332](#L1332) | public function fetch\_secret\_status($force\_checking = false) |
| [1333](#L1333) | { |
| [1334](#L1334) | $response = null; |
| [1335](#L1335) | if ($force\_checking) { |
| [1336](#L1336) | $response = $this->check\_spoki\_status(); |
| [1337](#L1337) | } |
| [1338](#L1338) |  |
| [1339](#L1339) | if (!isset($this->options['secret']) || $this->options['secret'] == '' || !isset($this->options['delivery\_url']) || $this->options['delivery\_url'] == '') { |
| [1340](#L1340) | $this->update\_options(get\_option(SPOKI\_OPTIONS), ["secret\_status" => [ |
| [1341](#L1341) | 'secret' => isset($this->options['secret']) ? $this->options['secret'] : '', |
| [1342](#L1342) | 'delivery\_url' => isset($this->options['delivery\_url']) ? $this->options['delivery\_url'] : '', |
| [1343](#L1343) | 'code' => 0, |
| [1344](#L1344) | 'message' => '' |
| [1345](#L1345) | ]]); |
| [1346](#L1346) | } else if (!isset($this->options['secret\_status']) || $this->options['secret\_status']['code'] != 200 || $this->options['secret'] != $this->options['secret\_status']['secret'] || $this->options['delivery\_url'] != $this->options['secret\_status']['delivery\_url']) { |
| [1347](#L1347) | if (!$force\_checking) { |
| [1348](#L1348) | $response = $this->check\_spoki\_status(); |
| [1349](#L1349) | } |
| [1350](#L1350) | $this->update\_options(get\_option(SPOKI\_OPTIONS), ["secret\_status" => [ |
| [1351](#L1351) | 'secret' => isset($this->options['secret']) ? $this->options['secret'] : '', |
| [1352](#L1352) | 'delivery\_url' => isset($this->options['delivery\_url']) ? $this->options['delivery\_url'] : '', |
| [1353](#L1353) | 'code' => wp\_remote\_retrieve\_response\_code($response), |
| [1354](#L1354) | 'message' => wp\_remote\_retrieve\_response\_message($response) |
| [1355](#L1355) | ]]); |
| [1356](#L1356) | } |
| [1357](#L1357) | return $response; |
| [1358](#L1358) | } |
| [1359](#L1359) |  |
| [1360](#L1360) | /\*\* |
| [1361](#L1361) | \* Activation Reset |
| [1362](#L1362) | \*/ |
| [1363](#L1363) | public function activation\_reset() |
| [1364](#L1364) | { |
| [1365](#L1365) | register\_uninstall\_hook(SPOKI\_PLUGIN\_FILE, array($this, 'uninstall\_plugin')); |
| [1366](#L1366) | if (!class\_exists('WooCommerce')) { |
| [1367](#L1367) | return; |
| [1368](#L1368) | } |
| [1369](#L1369) | $this->initialize\_cart\_abandonment\_tables(); |
| [1370](#L1370) | $Abandonment = Spoki\_Abandoned\_Carts::instance(); |
| [1371](#L1371) | $spokiDomain = $Abandonment->get\_spoki\_setting\_by\_meta("spoki\_domain"); |
| [1372](#L1372) | $Abandonment->set\_spoki\_setting\_by\_meta("plugin\_activated", "true"); |
| [1373](#L1373) | if ($spokiDomain != null || $spokiDomain != "") |
| [1374](#L1374) | $Abandonment->save\_webhook\_url($spokiDomain); |
| [1375](#L1375) | } |
| [1376](#L1376) |  |
| [1377](#L1377) | /\*\* |
| [1378](#L1378) | \* Deactivation Reset |
| [1379](#L1379) | \*/ |
| [1380](#L1380) | public function deactivation\_reset() |
| [1381](#L1381) | { |
| [1382](#L1382) | $Abandonment = Spoki\_Abandoned\_Carts::instance(); |
| [1383](#L1383) | # Unschedule hook for versions <= v2.8.1 |
| [1384](#L1384) | $Abandonment->unschedule\_hook(); |
| [1385](#L1385) | if (!class\_exists('WooCommerce')) { |
| [1386](#L1386) | return; |
| [1387](#L1387) | } |
| [1388](#L1388) | $spokiDomain = $Abandonment->get\_spoki\_setting\_by\_meta("spoki\_domain"); |
| [1389](#L1389) | $Abandonment->set\_spoki\_setting\_by\_meta("plugin\_activated", "false"); |
| [1390](#L1390) | if ($spokiDomain != null || $spokiDomain != "") |
| [1391](#L1391) | $Abandonment->disable\_webhook\_url($spokiDomain); |
| [1392](#L1392) | } |
| [1393](#L1393) |  |
| [1394](#L1394) | /\*\* |
| [1395](#L1395) | \* Uninstall Plugin |
| [1396](#L1396) | \*/ |
| [1397](#L1397) | public function uninstall\_plugin() |
| [1398](#L1398) | { |
| [1399](#L1399) | if (!class\_exists('WooCommerce')) { |
| [1400](#L1400) | return; |
| [1401](#L1401) | } |
| [1402](#L1402) | $Abandonment = Spoki\_Abandoned\_Carts::instance(); |
| [1403](#L1403) | $spokiDomain = $Abandonment->get\_spoki\_setting\_by\_meta("spoki\_domain"); |
| [1404](#L1404) | $Abandonment->set\_spoki\_setting\_by\_meta("plugin\_activated", "false"); |
| [1405](#L1405) | if ($spokiDomain != null || $spokiDomain != "") |
| [1406](#L1406) | $Abandonment->disable\_webhook\_url($spokiDomain); |
| [1407](#L1407) | } |
| [1408](#L1408) | } |
| [1409](#L1409) |  |
| [1410](#L1410) | /\*\* |
| [1411](#L1411) | \* Executed on activation of the plugin. |
| [1412](#L1412) | \* Redirects the user after plugin activation. |
| [1413](#L1413) | \*/ |
| [1414](#L1414) | function spoki\_activation() |
| [1415](#L1415) | { |
| [1416](#L1416) | if (!((isset($\_REQUEST['action']) && 'activate-selected' === $\_REQUEST['action']) && (isset($\_POST['checked']) && count($\_POST['checked']) > 1))) { |
| [1417](#L1417) | add\_option('spoki\_activation\_redirect', true); |
| [1418](#L1418) | } |
| [1419](#L1419) | } |
| [1420](#L1420) |  |
| [1421](#L1421) | /\*\* |
| [1422](#L1422) | \* Redirects the user after plugin activation. |
| [1423](#L1423) | \*/ |
| [1424](#L1424) | function spoki\_activation\_redirect() |
| [1425](#L1425) | { |
| [1426](#L1426) | if (get\_option('spoki\_activation\_redirect', false)) { |
| [1427](#L1427) | delete\_option('spoki\_activation\_redirect'); |
| [1428](#L1428) | exit(wp\_redirect(admin\_url('/admin.php?page=' . SPOKI\_PLUGIN\_NAME))); |
| [1429](#L1429) | } |
| [1430](#L1430) | } |
| [1431](#L1431) |  |
| [1432](#L1432) | /\*\* |
| [1433](#L1433) | \* Executed on deactivation of the plugin |
| [1434](#L1434) | \*/ |
| [1435](#L1435) | function spoki\_deactivation() |
| [1436](#L1436) | { |
| [1437](#L1437) | //      delete\_option(SPOKI\_OPTIONS); |
| [1438](#L1438) | $timestamp = wp\_next\_scheduled('spoki\_cron\_hook'); |
| [1439](#L1439) | wp\_unschedule\_event($timestamp, 'spoki\_cron\_hook'); |
| [1440](#L1440) | } |
| [1441](#L1441) |  |
| [1442](#L1442) | register\_deactivation\_hook(\_\_FILE\_\_, 'spoki\_deactivation'); |
| [1443](#L1443) | register\_activation\_hook(\_\_FILE\_\_, 'spoki\_activation'); |
| [1444](#L1444) | add\_action('admin\_init', 'spoki\_activation\_redirect'); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/spoki/trunk/spoki.php?format=txt)
* [Original Format](/export/3222766/spoki/trunk/spoki.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


