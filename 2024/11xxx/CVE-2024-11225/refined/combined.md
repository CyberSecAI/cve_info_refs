=== Content from plugins.trac.wordpress.org_3c99e659_20250114_215743.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwpdm-premium-packages%2Ftags%2F5.9.3%2Fincludes%2Flibs%2Ffunctions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?rev=3097018 "Revision 3097018")
* [Next Revision](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?rev=3195568 "Revision 3195568") →
* [Blame](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php)

---

# [source:](/browser?order=name "Go to repository root") [wpdm-premium-packages](/browser/wpdm-premium-packages?order=name "View wpdm-premium-packages")/[tags](/browser/wpdm-premium-packages/tags?order=name "View tags")/[5.9.3](/browser/wpdm-premium-packages/tags/5.9.3?order=name "View 5.9.3")/[includes](/browser/wpdm-premium-packages/tags/5.9.3/includes?order=name "View includes")/[libs](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs?order=name "View libs")/[functions.php](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php?order=name "View functions.php")

View diff against:

View revision:

| [Last change](/changeset/3134341/wpdm-premium-packages/trunk/includes/libs/functions.php "View differences") on this file was [3134341](/changeset/3134341/ "View changeset 3134341"), checked in by codename065, [5 months ago](/timeline?from=2024-08-12T15%3A38%3A35Z&precision=second "See timeline at 08/12/2024 03:38:35 PM") |
| --- |
| 5.9.0 - 2024.08.12  * Fixed an issue with the currency sign with the completed orders |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 57.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | // Exit if accessed directly |
| [3](#L3) | use WPDM\\_\_\Messages; |
| [4](#L4) | use WPDM\\_\_\Query; |
| [5](#L5) | use WPDM\\_\_\Session; |
| [6](#L6) | use WPDMPP\WPDMPremiumPackage; |
| [7](#L7) |  |
| [8](#L8) | if (!defined('ABSPATH')) { |
| [9](#L9) | exit; |
| [10](#L10) | } |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* @return WPDMPremiumPackage |
| [14](#L14) | \*/ |
| [15](#L15) | function WPDMPP() |
| [16](#L16) | { |
| [17](#L17) | global $wpdmpp; |
| [18](#L18) | return $wpdmpp; |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) | //number of total sales |
| [22](#L22) | function wpdmpp\_total\_purchase($pid = '') |
| [23](#L23) | { |
| [24](#L24) | global $wpdb; |
| [25](#L25) | if (!$pid) $pid = get\_the\_ID(); |
| [26](#L26) | $sales = $wpdb->get\_var("select count(\*) from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id and oi.pid='$pid' and  ( o.payment\_status='Completed' or o.payment\_status='Expired' )"); |
| [27](#L27) |  |
| [28](#L28) | return $sales; |
| [29](#L29) | } |
| [30](#L30) |  |
| [31](#L31) |  |
| [32](#L32) | //number of total sales |
| [33](#L33) | function wpdmpp\_total\_sales($uid = '', $pid = '', $sdate = '', $edate = '') |
| [34](#L34) | { |
| [35](#L35) | global $wpdb; |
| [36](#L36) |  |
| [37](#L37) | $pid\_cond = ($pid > 0) ? "and oi.pid='$pid'" : ""; |
| [38](#L38) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [39](#L39) |  |
| [40](#L40) | $sdate = $sdate == '' ? wp\_date("Y-m-01") : $sdate; |
| [41](#L41) | $edate = $edate == '' ? wp\_date("Y-m-d", strtotime("last day of this month")) : $edate; |
| [42](#L42) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : "and o.date >= '" . strtotime(wp\_date("Y-m-01")) . "'"; |
| [43](#L43) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : "and o.date <= '" . strtotime(wp\_date("Y-m-d", strtotime("last day of this month"))) . "'"; |
| [44](#L44) |  |
| [45](#L45) | if ($pid\_cond != '' || $uid\_cond != '') |
| [46](#L46) | $sales = $wpdb->get\_var("select sum(oi.price \* oi.quantity) from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id {$pid\_cond} {$uid\_cond} {$sdate\_cond} {$edate\_cond} and ( o.payment\_status='Completed' or o.payment\_status='Expired' )"); |
| [47](#L47) | else |
| [48](#L48) | $sales = $wpdb->get\_var("select sum(o.total) from {$wpdb->prefix}ahm\_orders o where  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) {$sdate\_cond} {$edate\_cond}"); |
| [49](#L49) |  |
| [50](#L50) | return number\_format($sales, 2, '.', ''); |
| [51](#L51) | } |
| [52](#L52) |  |
| [53](#L53) |  |
| [54](#L54) | function wpdmpp\_daily\_sales($uid = '', $pid = '', $sdate = '', $edate = '') |
| [55](#L55) | { |
| [56](#L56) | global $wpdb; |
| [57](#L57) |  |
| [58](#L58) | $pid\_cond = ($pid > 0) ? "and oi.pid='$pid'" : ""; |
| [59](#L59) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [60](#L60) | $sdate = $sdate == '' ? wp\_date("Y-m-01") : $sdate; |
| [61](#L61) | $edate = $edate == '' ? wp\_date("Y-m-d", strtotime("last day of this month")) : $edate; |
| [62](#L62) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : "and o.date >= '" . strtotime(wp\_date("Y-m-01")) . "'"; |
| [63](#L63) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : "and o.date <= '" . strtotime(wp\_date("Y-m-d", strtotime("last day of this month"))) . "'"; |
| [64](#L64) |  |
| [65](#L65) | $sales = $wpdb->get\_results("select sum(oi.price \* oi.quantity) as daily\_sale,  sum(oi.quantity) as quantities, oi.date, oi.year, oi.month, oi.day from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id {$pid\_cond} {$uid\_cond} {$sdate\_cond} {$edate\_cond} and  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) group by oi.date"); |
| [66](#L66) |  |
| [67](#L67) | $diff = date\_diff(date\_create($edate), date\_create($sdate))->days; |
| [68](#L68) | $sdata = array(); |
| [69](#L69) | $i = 0; |
| [70](#L70) | do { |
| [71](#L71) | $i++; |
| [72](#L72) | $sdata['sales'][$sdate] = 0; |
| [73](#L73) | $sdata['quantities'][$sdate] = 0; |
| [74](#L74) | $sdate = wp\_date('Y-m-d', strtotime('+1 day', strtotime($sdate))); |
| [75](#L75) | } while ($i <= $diff); |
| [76](#L76) |  |
| [77](#L77) | foreach ($sales as $sale) { |
| [78](#L78) | $sdata['sales'][$sale->date] = $sale->daily\_sale; |
| [79](#L79) | $sdata['quantities'][$sale->date] = $sale->quantities; |
| [80](#L80) | } |
| [81](#L81) |  |
| [82](#L82) | return $sdata; |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | function wpdmpp\_top\_sellings\_products($uid = '', $sdate = '', $edate = '', $s = 0, $e = 1000) |
| [86](#L86) | { |
| [87](#L87) | global $wpdb; |
| [88](#L88) |  |
| [89](#L89) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [90](#L90) | //$sdate = $sdate == ''?date("Y-m-01"):$sdate; |
| [91](#L91) | //$edate = $edate == ''?date("Y-m-31"):$edate; |
| [92](#L92) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : ""; |
| [93](#L93) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : ""; |
| [94](#L94) |  |
| [95](#L95) | $tsp = $wpdb->get\_results("select oi.pid, sum(oi.price) as sales,  sum(oi.quantity) as quantities, oi.date, oi.year, oi.month, oi.day from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id  {$uid\_cond} {$sdate\_cond} {$edate\_cond} and  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) group by oi.pid ORDER BY quantities DESC limit $s, $e"); |
| [96](#L96) | return $tsp; |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | function wpdmpp\_recent\_sales($uid = '', $count = 10) |
| [100](#L100) | { |
| [101](#L101) | global $wpdb; |
| [102](#L102) |  |
| [103](#L103) | $uid\_cond = ($uid > 0) ? "and {$wpdb->prefix}ahm\_order\_items.sid='$uid'" : ""; |
| [104](#L104) | $tsp = $wpdb->get\_results("select {$wpdb->prefix}ahm\_order\_items.pid as product\_id,{$wpdb->prefix}ahm\_order\_items.price, ({$wpdb->prefix}ahm\_order\_items.price \* {$wpdb->prefix}ahm\_order\_items.quantity) as total, {$wpdb->prefix}ahm\_orders.date as time\_stamp,  {$wpdb->prefix}ahm\_order\_items.date, {$wpdb->prefix}ahm\_order\_items.year, {$wpdb->prefix}ahm\_order\_items.month, {$wpdb->prefix}ahm\_order\_items.day from {$wpdb->prefix}ahm\_order\_items LEFT JOIN {$wpdb->prefix}ahm\_orders on {$wpdb->prefix}ahm\_order\_items.oid={$wpdb->prefix}ahm\_orders.order\_id  {$uid\_cond} and  ( {$wpdb->prefix}ahm\_orders.payment\_status='Completed' or {$wpdb->prefix}ahm\_orders.payment\_status='Expired' ) ORDER BY {$wpdb->prefix}ahm\_orders.date DESC limit 0, $count"); |
| [105](#L105) | foreach ($tsp as &$\_tsp) { |
| [106](#L106) | $\_tsp->post\_title = get\_the\_title($\_tsp->product\_id); |
| [107](#L107) | } |
| [108](#L108) | return $tsp; |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | function wpdmpp\_get\_licenses() |
| [112](#L112) | { |
| [113](#L113) | $pre\_licenses = get\_wpdmpp\_option('licenses', array( |
| [114](#L114) | 'single' => array('name' => 'Standard', 'description' => '', 'use' => 1), |
| [115](#L115) | 'extended' => array('name' => 'Extended', 'description' => '', 'use' => 5), |
| [116](#L116) | 'unlimited' => array('name' => 'Unlimited', 'description' => '', 'use' => 99), |
| [117](#L117) | )); |
| [118](#L118) | $pre\_licenses = maybe\_unserialize($pre\_licenses); |
| [119](#L119) | return $pre\_licenses; |
| [120](#L120) |  |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | function get\_wpdmpp\_option($name, $default = '', $validate = null) |
| [124](#L124) | { |
| [125](#L125) | global $wpdmpp\_settings; |
| [126](#L126) |  |
| [127](#L127) | $name = explode('/', $name); |
| [128](#L128) |  |
| [129](#L129) | if (!is\_array($wpdmpp\_settings)) return $default; |
| [130](#L130) |  |
| [131](#L131) | if (count($name) == 1) |
| [132](#L132) | $value = isset($wpdmpp\_settings[$name[0]]) ? $wpdmpp\_settings[$name[0]] : $default; |
| [133](#L133) | else if (count($name) == 2) |
| [134](#L134) | $value = isset($wpdmpp\_settings[$name[0]], $wpdmpp\_settings[$name[0]][$name[1]]) ? $wpdmpp\_settings[$name[0]][$name[1]] : $default; |
| [135](#L135) | else if (count($name) == 3) |
| [136](#L136) | $value = isset($wpdmpp\_settings[$name[0]], $wpdmpp\_settings[$name[0]][$name[1]], $wpdmpp\_settings[$name[0]][$name[1]][$name[2]]) ? $wpdmpp\_settings[$name[0]][$name[1]][$name[2]] : $default; |
| [137](#L137) | else |
| [138](#L138) | $value = $default; |
| [139](#L139) | if($validate !== null) |
| [140](#L140) | $value = wpdm\_sanitize\_var($value, $validate); |
| [141](#L141) |  |
| [142](#L142) | return $value; |
| [143](#L143) | } |
| [144](#L144) |  |
| [145](#L145) | function wpdmpp\_countries() |
| [146](#L146) | { |
| [147](#L147) | return array('AF' => 'AFGHANISTAN', 'AL' => 'ALBANIA', 'DZ' => 'ALGERIA', 'AS' => 'AMERICAN SAMOA', 'AD' => 'ANDORRA', 'AO' => 'ANGOLA', 'AI' => 'ANGUILLA', 'AQ' => 'ANTARCTICA', 'AG' => 'ANTIGUA AND BARBUDA', 'AR' => 'ARGENTINA', 'AM' => 'ARMENIA', 'AW' => 'ARUBA', 'AU' => 'AUSTRALIA', 'AT' => 'AUSTRIA', 'AZ' => 'AZERBAIJAN', 'BS' => 'BAHAMAS', 'BH' => 'BAHRAIN', 'BD' => 'BANGLADESH', 'BB' => 'BARBADOS', 'BY' => 'BELARUS', 'BE' => 'BELGIUM', 'BZ' => 'BELIZE', 'BJ' => 'BENIN', 'BM' => 'BERMUDA', 'BT' => 'BHUTAN', 'BO' => 'BOLIVIA', 'BA' => 'BOSNIA AND HERZEGOVINA', 'BW' => 'BOTSWANA', 'BV' => 'BOUVET ISLAND', 'BR' => 'BRAZIL', 'IO' => 'BRITISH INDIAN OCEAN TERRITORY', 'BN' => 'BRUNEI DARUSSALAM', 'BG' => 'BULGARIA', 'BF' => 'BURKINA FASO', 'BI' => 'BURUNDI', 'KH' => 'CAMBODIA', 'CM' => 'CAMEROON', 'CA' => 'CANADA', 'CV' => 'CAPE VERDE', 'KY' => 'CAYMAN ISLANDS', 'CF' => 'CENTRAL AFRICAN REPUBLIC', 'TD' => 'CHAD', 'CL' => 'CHILE', 'CN' => 'CHINA', 'CX' => 'CHRISTMAS ISLAND', 'CC' => 'COCOS (KEELING) ISLANDS', 'CO' => 'COLOMBIA', 'KM' => 'COMOROS', 'CG' => 'CONGO', 'CD' => 'CONGO, THE DEMOCRATIC REPUBLIC OF THE', 'CK' => 'COOK ISLANDS', 'CR' => 'COSTA RICA', 'CI' => 'COTE DIVOIRE', 'HR' => 'CROATIA', 'CU' => 'CUBA', 'CY' => 'CYPRUS', 'CZ' => 'CZECH REPUBLIC', 'DK' => 'DENMARK', 'DJ' => 'DJIBOUTI', 'DM' => 'DOMINICA', 'DO' => 'DOMINICAN REPUBLIC', 'EC' => 'ECUADOR', 'EG' => 'EGYPT', 'SV' => 'EL SALVADOR', 'GQ' => 'EQUATORIAL GUINEA', 'ER' => 'ERITREA', 'EE' => 'ESTONIA', 'ET' => 'ETHIOPIA', 'FK' => 'FALKLAND ISLANDS (MALVINAS)', 'FO' => 'FAROE ISLANDS', 'FJ' => 'FIJI', 'FI' => 'FINLAND', 'FR' => 'FRANCE', 'GF' => 'FRENCH GUIANA', 'PF' => 'FRENCH POLYNESIA', 'TF' => 'FRENCH SOUTHERN TERRITORIES', 'GA' => 'GABON', 'GM' => 'GAMBIA', 'GE' => 'GEORGIA', 'DE' => 'GERMANY', 'GH' => 'GHANA', 'GI' => 'GIBRALTAR', 'GR' => 'GREECE', 'GL' => 'GREENLAND', 'GD' => 'GRENADA', 'GP' => 'GUADELOUPE', 'GU' => 'GUAM', 'GT' => 'GUATEMALA', 'GN' => 'GUINEA', 'GW' => 'GUINEA-BISSAU', 'GY' => 'GUYANA', 'HT' => 'HAITI', 'HM' => 'HEARD ISLAND AND MCDONALD ISLANDS', 'VA' => 'HOLY SEE (VATICAN CITY STATE)', 'HN' => 'HONDURAS', 'HK' => 'HONG KONG', 'HU' => 'HUNGARY', 'IS' => 'ICELAND', 'IN' => 'INDIA', 'ID' => 'INDONESIA', 'IR' => 'IRAN, ISLAMIC REPUBLIC OF', 'IQ' => 'IRAQ', 'IE' => 'IRELAND', 'IL' => 'ISRAEL', 'IT' => 'ITALY', 'JM' => 'JAMAICA', 'JP' => 'JAPAN', 'JO' => 'JORDAN', 'KZ' => 'KAZAKHSTAN', 'KE' => 'KENYA', 'KI' => 'KIRIBATI', 'KP' => 'KOREA, DEMOCRATIC PEOPLE\'S REPUBLIC OF', 'KR' => 'KOREA, REPUBLIC OF', 'KW' => 'KUWAIT', 'KG' => 'KYRGYZSTAN', 'LA' => 'LAO PEOPLE\'S DEMOCRATIC REPUBLIC', 'LV' => 'LATVIA', 'LB' => 'LEBANON', 'LS' => 'LESOTHO', 'LR' => 'LIBERIA', 'LY' => 'LIBYAN ARAB JAMAHIRIYA', 'LI' => 'LIECHTENSTEIN', 'LT' => 'LITHUANIA', 'LU' => 'LUXEMBOURG', 'MO' => 'MACAO', 'MK' => 'MACEDONIA, THE FORMER YUGOSLAV REPUBLIC OF', 'MG' => 'MADAGASCAR', 'MW' => 'MALAWI', 'MY' => 'MALAYSIA', 'MV' => 'MALDIVES', 'ML' => 'MALI', 'MT' => 'MALTA', 'MH' => 'MARSHALL ISLANDS', 'MQ' => 'MARTINIQUE', 'MR' => 'MAURITANIA', 'MU' => 'MAURITIUS', 'YT' => 'MAYOTTE', 'MX' => 'MEXICO', 'FM' => 'MICRONESIA, FEDERATED STATES OF', 'MD' => 'MOLDOVA, REPUBLIC OF', 'MC' => 'MONACO', 'MN' => 'MONGOLIA', 'MS' => 'MONTSERRAT', 'MA' => 'MOROCCO', 'MZ' => 'MOZAMBIQUE', 'MM' => 'MYANMAR', 'NA' => 'NAMIBIA', 'NR' => 'NAURU', 'NP' => 'NEPAL', 'NL' => 'NETHERLANDS', 'AN' => 'NETHERLANDS ANTILLES', 'NC' => 'NEW CALEDONIA', 'NZ' => 'NEW ZEALAND', 'NI' => 'NICARAGUA', 'NE' => 'NIGER', 'NG' => 'NIGERIA', 'NU' => 'NIUE', 'NF' => 'NORFOLK ISLAND', 'MP' => 'NORTHERN MARIANA ISLANDS', 'NO' => 'NORWAY', 'OM' => 'OMAN', 'PK' => 'PAKISTAN', 'PW' => 'PALAU', 'PS' => 'PALESTINIAN TERRITORY, OCCUPIED', 'PA' => 'PANAMA', 'PG' => 'PAPUA NEW GUINEA', 'PY' => 'PARAGUAY', 'PE' => 'PERU', 'PH' => 'PHILIPPINES', 'PN' => 'PITCAIRN', 'PL' => 'POLAND', 'PT' => 'PORTUGAL', 'PR' => 'PUERTO RICO', 'QA' => 'QATAR', 'RE' => 'REUNION', 'RO' => 'ROMANIA', 'RU' => 'RUSSIAN FEDERATION', 'RW' => 'RWANDA', 'SH' => 'SAINT HELENA', 'KN' => 'SAINT KITTS AND NEVIS', 'LC' => 'SAINT LUCIA', 'PM' => 'SAINT PIERRE AND MIQUELON', 'VC' => 'SAINT VINCENT AND THE GRENADINES', 'WS' => 'SAMOA', 'SM' => 'SAN MARINO', 'ST' => 'SAO TOME AND PRINCIPE', 'SA' => 'SAUDI ARABIA', 'SN' => 'SENEGAL', 'CS' => 'SERBIA AND MONTENEGRO', 'SC' => 'SEYCHELLES', 'SL' => 'SIERRA LEONE', 'SG' => 'SINGAPORE', 'SK' => 'SLOVAKIA', 'SI' => 'SLOVENIA', 'SB' => 'SOLOMON ISLANDS', 'SO' => 'SOMALIA', 'ZA' => 'SOUTH AFRICA', 'GS' => 'SOUTH GEORGIA AND THE SOUTH SANDWICH ISLANDS', 'ES' => 'SPAIN', 'LK' => 'SRI LANKA', 'SD' => 'SUDAN', 'SR' => 'SURINAME', 'SJ' => 'SVALBARD AND JAN MAYEN', 'SZ' => 'SWAZILAND', 'SE' => 'SWEDEN', 'CH' => 'SWITZERLAND', 'SY' => 'SYRIAN ARAB REPUBLIC', 'TW' => 'TAIWAN, PROVINCE OF CHINA', 'TJ' => 'TAJIKISTAN', 'TZ' => 'TANZANIA, UNITED REPUBLIC OF', 'TH' => 'THAILAND', 'TL' => 'TIMOR-LESTE', 'TG' => 'TOGO', 'TK' => 'TOKELAU', 'TO' => 'TONGA', 'TT' => 'TRINIDAD AND TOBAGO', 'TN' => 'TUNISIA', 'TR' => 'TURKEY', 'TM' => 'TURKMENISTAN', 'TC' => 'TURKS AND CAICOS ISLANDS', 'TV' => 'TUVALU', 'UG' => 'UGANDA', 'UA' => 'UKRAINE', 'AE' => 'UNITED ARAB EMIRATES', 'GB' => 'UNITED KINGDOM', 'US' => 'UNITED STATES', 'UM' => 'UNITED STATES MINOR OUTLYING ISLANDS', 'UY' => 'URUGUAY', 'UZ' => 'UZBEKISTAN', 'VU' => 'VANUATU', 'VE' => 'VENEZUELA', 'VN' => 'VIET NAM', 'VG' => 'VIRGIN ISLANDS, BRITISH', 'VI' => 'VIRGIN ISLANDS, U.S.', 'WF' => 'WALLIS AND FUTUNA', 'EH' => 'WESTERN SAHARA', 'YE' => 'YEMEN', 'ZM' => 'ZAMBIA', 'ZW' => 'ZIMBABWE'); |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | function wpdmpp\_tax\_active() |
| [151](#L151) | { |
| [152](#L152) | global $wpdmpp\_settings; |
| [153](#L153) | return isset($wpdmpp\_settings['tax']) && isset($wpdmpp\_settings['tax']['enable']) ? true : false; |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | function wpdmpp\_show\_tax() |
| [157](#L157) | { |
| [158](#L158) | global $wpdmpp\_settings; |
| [159](#L159) | return isset($wpdmpp\_settings['tax']) && isset($wpdmpp\_settings['tax']['tax\_on\_cart']) ? true : false; |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) |  |
| [163](#L163) | //Send notification before delete product |
| [164](#L164) | add\_action('wp\_trash\_post', 'wpdmpp\_notify\_product\_rejected'); |
| [165](#L165) | function wpdmpp\_notify\_product\_rejected($post\_id) |
| [166](#L166) | { |
| [167](#L167) | global $post\_type; |
| [168](#L168) | if ($post\_type != 'wpdmpro') return; |
| [169](#L169) |  |
| [170](#L170) | $post = get\_post($post\_id); |
| [171](#L171) | $post\_meta = get\_post\_meta($post\_id, "\_z\_user\_review", true); |
| [172](#L172) |  |
| [173](#L173) | if ($post\_meta != ""): |
| [174](#L174) | $author = get\_userdata($post->post\_author); |
| [175](#L175) | $author\_email = $author->user\_email; |
| [176](#L176) | $email\_subject = "Your product has been rejected."; |
| [177](#L177) |  |
| [178](#L178) | ob\_start(); ?> |
| [179](#L179) | <html> |
| [180](#L180) | <head> |
| [181](#L181) | <title>New post at <?php bloginfo('name') ?></title> |
| [182](#L182) | </head> |
| [183](#L183) | <body> |
| [184](#L184) | <p> |
| [185](#L185) | Hi <?php echo $author->user\_firstname ?>, |
| [186](#L186) | </p> |
| [187](#L187) |  |
| [188](#L188) | <p> |
| [189](#L189) | Your product <?php the\_title() ?> has not been approved by team. |
| [190](#L190) | </p> |
| [191](#L191) | </body> |
| [192](#L192) | </html> |
| [193](#L193) | <?php |
| [194](#L194) | $message = ob\_get\_contents(); |
| [195](#L195) | ob\_end\_clean(); |
| [196](#L196) |  |
| [197](#L197) | wp\_mail($author\_email, $email\_subject, $message); |
| [198](#L198) | endif; |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | // Product accept notification email |
| [202](#L202) | function wpdmpp\_notify\_product\_accepted($post\_id) |
| [203](#L203) | { |
| [204](#L204) | global $post\_type; |
| [205](#L205) | if ($post\_type != 'wpdmpro') return; |
| [206](#L206) |  |
| [207](#L207) | if (($\_POST['post\_status'] == 'publish') && ($\_POST['original\_post\_status'] != 'publish')) { |
| [208](#L208) | $post = get\_post($post\_id); |
| [209](#L209) | $post\_meta = get\_post\_meta($post\_id, "\_z\_user\_review", TRUE); |
| [210](#L210) | if ($post\_meta != ""): |
| [211](#L211) |  |
| [212](#L212) | $author = get\_userdata($post->post\_author); |
| [213](#L213) | $author\_email = $author->user\_email; |
| [214](#L214) | $email\_subject = "Your post has been published."; |
| [215](#L215) |  |
| [216](#L216) | ob\_start(); ?> |
| [217](#L217) | <html> |
| [218](#L218) | <head> |
| [219](#L219) | <title>Your Product Status at <?php bloginfo('name') ?></title> |
| [220](#L220) | </head> |
| [221](#L221) | <body> |
| [222](#L222) | <p>Hi <?php echo $author->user\_firstname ?>,</p> |
| [223](#L223) | <p>Your product <a href="<?php echo get\_permalink($post->ID) ?>"><?php the\_title\_attribute() ?></a> has been |
| [224](#L224) | published.</p> |
| [225](#L225) | </body> |
| [226](#L226) | </html> |
| [227](#L227) | <?php |
| [228](#L228) | $message = ob\_get\_clean(); |
| [229](#L229) |  |
| [230](#L230) | wp\_mail($author\_email, $email\_subject, $message); |
| [231](#L231) | endif; |
| [232](#L232) | } |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Calculate pending balance and matured balance of the seller |
| [238](#L238) | \* |
| [239](#L239) | \* @return array $seller\_balances Array of balances. Access using `pending` and `matured` |
| [240](#L240) | \* @since 3.8.9 |
| [241](#L241) | \*/ |
| [242](#L242) | function wpdmpp\_seller\_balances() |
| [243](#L243) | { |
| [244](#L244) | global $wpdb, $current\_user; |
| [245](#L245) | $current\_user = wp\_get\_current\_user(); |
| [246](#L246) | $uid = $current\_user->ID; |
| [247](#L247) | $sql = "select sum(i.price\*i.quantity) from {$wpdb->prefix}ahm\_orders o, |
| [248](#L248) | {$wpdb->prefix}ahm\_order\_items i, |
| [249](#L249) | {$wpdb->prefix}posts p |
| [250](#L250) | where p.post\_author=$uid and |
| [251](#L251) | i.oid=o.order\_id and |
| [252](#L252) | i.pid=p.ID and |
| [253](#L253) | i.quantity > 0 and |
| [254](#L254) | o.payment\_status='Completed'"; |
| [255](#L255) |  |
| [256](#L256) | $total\_sales = $wpdb->get\_var($sql); |
| [257](#L257) | $commission = wpdmpp\_site\_commission(); |
| [258](#L258) | $total\_commission = $total\_sales \* $commission / 100; |
| [259](#L259) | $total\_earning = $total\_sales - $total\_commission; |
| [260](#L260) | $sql = "select sum(amount) from {$wpdb->prefix}ahm\_withdraws where uid=$uid"; |
| [261](#L261) | $total\_withdraws = $wpdb->get\_var($sql); |
| [262](#L262) | $balance = $total\_earning - $total\_withdraws; |
| [263](#L263) |  |
| [264](#L264) | //finding matured balance |
| [265](#L265) | $payout\_duration = get\_option("wpdmpp\_payout\_duration"); |
| [266](#L266) | $dt = $payout\_duration \* 24 \* 60 \* 60; |
| [267](#L267) | $sqlm = "select sum(i.price\*i.quantity) from {$wpdb->prefix}ahm\_orders o, |
| [268](#L268) | {$wpdb->prefix}ahm\_order\_items i, |
| [269](#L269) | {$wpdb->prefix}posts p |
| [270](#L270) | where p.post\_author=$uid and |
| [271](#L271) | i.oid=o.order\_id and |
| [272](#L272) | i.pid=p.ID and |
| [273](#L273) | i.quantity > 0 and |
| [274](#L274) | o.payment\_status='Completed' |
| [275](#L275) | and (o.date+($dt))<" . time() . ""; |
| [276](#L276) |  |
| [277](#L277) | $tempbalance = $wpdb->get\_var($sqlm); |
| [278](#L278) | $tempbalance = $tempbalance - ($tempbalance \* $commission / 100); |
| [279](#L279) | $matured\_balance = $tempbalance - $total\_withdraws; |
| [280](#L280) |  |
| [281](#L281) | //finding pending balance |
| [282](#L282) | $pending\_balance = $balance - $matured\_balance; |
| [283](#L283) |  |
| [284](#L284) | $seller\_balances = array(); |
| [285](#L285) | $seller\_balances['pending'] = $pending\_balance; |
| [286](#L286) | $seller\_balances['matured'] = $matured\_balance; |
| [287](#L287) |  |
| [288](#L288) | return $seller\_balances; |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | //for withdraw request |
| [292](#L292) | function wpdmpp\_withdraw\_request() |
| [293](#L293) | { |
| [294](#L294) | global $wpdb, $current\_user; |
| [295](#L295) |  |
| [296](#L296) | $current\_user = wp\_get\_current\_user(); |
| [297](#L297) |  |
| [298](#L298) | $uid = $current\_user->ID; |
| [299](#L299) |  |
| [300](#L300) | if (isset($\_POST['withdraw'], $\_POST['withdraw\_amount']) && $\_POST['withdraw'] == 1 && $\_POST['withdraw\_amount'] > 0) { |
| [301](#L301) |  |
| [302](#L302) | // Check if matured balance is greater than 0 |
| [303](#L303) | $seller\_balances = wpdmpp\_seller\_balances(); |
| [304](#L304) | if ($seller\_balances['matured'] <= 0) { |
| [305](#L305) | echo 'denied'; |
| [306](#L306) | die(); |
| [307](#L307) | } |
| [308](#L308) | $payout\_method = wpdm\_query\_var('payout\_method', 'txt'); |
| [309](#L309) | $payment\_account = wpdm\_valueof(WPDMPP()->withdraws->payoutAccounts($current\_user->ID), $payout\_method); |
| [310](#L310) | if(!$payment\_account || !$payout\_method) { |
| [311](#L311) | wp\_send\_json(['success' => false, 'msg' => \_\_("Withdrawal Request Failed. No payout option selected!", "wpdm-premium-packages")]); |
| [312](#L312) | } |
| [313](#L313) | $wpdb->insert( |
| [314](#L314) | "{$wpdb->prefix}ahm\_withdraws", |
| [315](#L315) | array( |
| [316](#L316) | 'uid' => $uid, |
| [317](#L317) | 'date' => time(), |
| [318](#L318) | 'amount' => absint($\_POST['withdraw\_amount']), |
| [319](#L319) | 'payment\_method' => $payout\_method, |
| [320](#L320) | 'payment\_account' => $payment\_account, |
| [321](#L321) | 'status' => 0 |
| [322](#L322) | ), |
| [323](#L323) | array( |
| [324](#L324) | '%d', |
| [325](#L325) | '%d', |
| [326](#L326) | '%f', |
| [327](#L327) | '%s', |
| [328](#L328) | '%s', |
| [329](#L329) | '%d' |
| [330](#L330) | ) |
| [331](#L331) | ); |
| [332](#L332) |  |
| [333](#L333) | if (wpdm\_is\_ajax()) { |
| [334](#L334) | wp\_send\_json(['success' => true, 'msg' => \_\_("Withdrawal Request Sent!", "wpdm-premium-packages")]); |
| [335](#L335) | } |
| [336](#L336) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [337](#L337) | header("Location: " . $return); |
| [338](#L338) | die(); |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | } |
| [342](#L342) |  |
| [343](#L343) | function wpdmpp\_redirect($url) |
| [344](#L344) | { |
| [345](#L345) | if (!headers\_sent()) |
| [346](#L346) | header("location: " . $url); |
| [347](#L347) | else |
| [348](#L348) | echo "<script>location.href='{$url}';</script>"; |
| [349](#L349) | die(); |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | function wpdmpp\_js\_redirect($url) |
| [353](#L353) | { |
| [354](#L354) | echo "&nbsp;Redirecting...<script>location.href='{$url}';</script>"; |
| [355](#L355) | die(); |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | function wpdmpp\_members\_page() |
| [359](#L359) | { |
| [360](#L360) | $settings = get\_option('\_wpdmpp\_settings'); |
| [361](#L361) | return isset($settings['members\_page\_id']) ? get\_permalink($settings['members\_page\_id']) : wpdm\_user\_dashboard\_url(array('udb\_page' => 'account-credits')); |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | function wpdmpp\_checkout\_return\_url($payment, $order\_id = '') { |
| [365](#L365) | $gop = wpdmpp\_guest\_order\_page(); |
| [366](#L366) | $opu = !is\_user\_logged\_in() && get\_wpdmpp\_option('guest\_download') == 1 && $gop != '' ? $gop : wpdmpp\_orders\_page($order\_id); |
| [367](#L367) | $url = get\_wpdmpp\_option("{$payment}/return\_url", $opu); |
| [368](#L368) | $url = str\_replace("{{download\_page}}", "", $url); |
| [369](#L369) | return $url; |
| [370](#L370) | } |
| [371](#L371) |  |
| [372](#L372) | function wpdmpp\_orders\_page($part = '') |
| [373](#L373) | { |
| [374](#L374) | global $wpdmpp\_settings; |
| [375](#L375) | $settings = $wpdmpp\_settings; |
| [376](#L376) |  |
| [377](#L377) | $url = get\_permalink($settings['orders\_page\_id']); |
| [378](#L378) | if ($part != '') { |
| [379](#L379) | if (strpos($url, '?')) $url .= "&" . $part; |
| [380](#L380) | else $url .= "?" . $part; |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) | $udbpage = get\_option('\_\_wpdm\_user\_dashboard', 0); |
| [384](#L384) | if ((int)$udbpage > 0 && (int)$settings['orders\_page\_id'] === (int)$udbpage) { |
| [385](#L385) |  |
| [386](#L386) | $udbpage = get\_permalink($udbpage); |
| [387](#L387) | $sap = strstr($udbpage, '?') ? "&udb\_page=" : "?udb\_page="; |
| [388](#L388) | $url = $udbpage . $sap . "purchases/orders/"; |
| [389](#L389) | if ($part != '') { |
| [390](#L390) | $part = explode("=", $part); |
| [391](#L391) | $url = $udbpage . $sap . "purchases/order/" . end($part) . "/"; |
| [392](#L392) | } |
| [393](#L393) | } |
| [394](#L394) | return $url; |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | function wpdmpp\_guest\_order\_page($part = '') |
| [398](#L398) | { |
| [399](#L399) | $settings = get\_option('\_wpdmpp\_settings'); |
| [400](#L400) | $url = get\_permalink($settings['guest\_order\_page\_id']); |
| [401](#L401) | if (!isset($settings['guest\_download']) || $settings['guest\_download'] == 0) return ''; |
| [402](#L402) | if ($part != '') { |
| [403](#L403) | if (strpos($url, '?')) $url .= "&" . $part; |
| [404](#L404) | else $url .= "?" . $part; |
| [405](#L405) | } |
| [406](#L406) | return $url; |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) | /\*\* |
| [410](#L410) | \* Returns cart page url |
| [411](#L411) | \* @param array $params |
| [412](#L412) | \* @return false|string |
| [413](#L413) | \*/ |
| [414](#L414) | function wpdmpp\_cart\_page($params = array()) |
| [415](#L415) | { |
| [416](#L416) | global $wpdmpp\_settings; |
| [417](#L417) | if (!$wpdmpp\_settings) |
| [418](#L418) | $wpdmpp\_settings = get\_option('\_wpdmpp\_settings'); |
| [419](#L419) |  |
| [420](#L420) | $url = get\_permalink($wpdmpp\_settings['page\_id']); |
| [421](#L421) |  |
| [422](#L422) | $url = add\_query\_arg($params, $url); |
| [423](#L423) |  |
| [424](#L424) | return $url; |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | function wpdmpp\_cart\_url($params = array()) |
| [428](#L428) | { |
| [429](#L429) | return wpdmpp\_cart\_page($params); |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | function wpdmpp\_checkout\_link($label = 'Checkout', $class = 'btn btn-info' ,$params = array()) |
| [433](#L433) | { |
| [434](#L434) | return "<a href='".wpdmpp\_cart\_page($params)."' class='{$class}'>{$label}</a>"; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | function wpdmpp\_is\_cart\_page($id = null) |
| [438](#L438) | { |
| [439](#L439) | $id = $id ?: get\_the\_ID(); |
| [440](#L440) | $cart\_page\_id = (int)get\_wpdmpp\_option('page\_id'); |
| [441](#L441) | return $cart\_page\_id === (int)$id ? $cart\_page\_id : false; |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) |  |
| [445](#L445) | function wpdmpp\_continue\_shopping\_url($args = []) |
| [446](#L446) | { |
| [447](#L447) | $settings = get\_option('\_wpdmpp\_settings'); |
| [448](#L448) | return add\_query\_arg($args, get\_wpdmpp\_option('continue\_shopping\_url', home\_url('/'))); |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) |  |
| [452](#L452) | function wpdmpp\_save\_billing\_info() |
| [453](#L453) | { |
| [454](#L454) | global $current\_user; |
| [455](#L455) | $current\_user = wp\_get\_current\_user(); |
| [456](#L456) | if (isset($\_POST['\_\_wpdm\_store\_owner'])) |
| [457](#L457) | $\_\_wpdm\_store\_owner = isset($\_POST['\_\_wpdm\_store\_owner']) ? 1 : 0; |
| [458](#L458) | update\_user\_meta($current\_user->ID, '\_\_wpdm\_store\_owner', $\_\_wpdm\_store\_owner); |
| [459](#L459) | if (isset($\_POST['\_\_wpdm\_store'])) { |
| [460](#L460) | $store\_data = wpdm\_sanitize\_array($\_POST['\_\_wpdm\_store']); |
| [461](#L461) | update\_user\_meta($current\_user->ID, '\_\_wpdm\_store', $store\_data); |
| [462](#L462) | } |
| [463](#L463) | if (isset($\_POST['checkout']) && isset($\_POST['checkout']['billing'])) { |
| [464](#L464) | $codata = wpdm\_sanitize\_array($\_POST['checkout']); |
| [465](#L465) | update\_user\_meta($current\_user->ID, 'user\_billing\_shipping', serialize($codata)); |
| [466](#L466) | } |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Get the list of purchased items of the current user |
| [471](#L471) | \*/ |
| [472](#L472) | function wpdmpp\_get\_purchased\_items() |
| [473](#L473) | { |
| [474](#L474) | if (!isset($\_GET['wpdmppaction']) || $\_GET['wpdmppaction'] != 'getpurchaseditems') return; |
| [475](#L475) | if (wpdm\_query\_var('user') != '') { |
| [476](#L476) | $user = wp\_signon(array('user\_login' => wpdm\_query\_var('user'), 'user\_password' => wpdm\_query\_var('pass'))); |
| [477](#L477) | if ($user->ID) wp\_set\_current\_user($user->ID); |
| [478](#L478) | } |
| [479](#L479) | if (wpdm\_query\_var('wpdm\_access\_token') != '') { |
| [480](#L480) | $at = wpdm\_query\_var('wpdm\_access\_token'); |
| [481](#L481) | if (!$at) die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [482](#L482) | $atx = explode("x", $at); |
| [483](#L483) | $uid = end($atx); |
| [484](#L484) | $uid = (int)$uid; |
| [485](#L485) | if (!$uid) die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [486](#L486) | $sat = get\_user\_meta($uid, '\_\_wpdm\_access\_token', true); |
| [487](#L487) | if ($sat === '') die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [488](#L488) | if ($sat === $at) |
| [489](#L489) | wp\_set\_current\_user($uid); |
| [490](#L490) | else |
| [491](#L491) | die(json\_encode(array('error' => "Invalid Access Token!"))); |
| [492](#L492) | } |
| [493](#L493) | if (is\_user\_logged\_in()) |
| [494](#L494) | wp\_send\_json(\WPDMPP\Libs\Order::getPurchasedItems()); |
| [495](#L495) | else |
| [496](#L496) | wp\_send\_json(array('error' => '<a href="https://www.wpdownloadmanager.com/user-dashboard/?redirect\_to=[redirect]">You need to login first!</a>')); |
| [497](#L497) | die(); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | /\*\* |
| [501](#L501) | \* Retrienve Site Commissions on User's Sales |
| [502](#L502) | \* @param null $uid |
| [503](#L503) | \* @return mixed |
| [504](#L504) | \*/ |
| [505](#L505) | function wpdmpp\_site\_commission($uid = null) |
| [506](#L506) | { |
| [507](#L507) | global $current\_user; |
| [508](#L508) | $current\_user = wp\_get\_current\_user(); |
| [509](#L509) | $user = $current\_user; |
| [510](#L510) | if ($uid) $user = get\_userdata($uid); |
| [511](#L511) | $role = array\_shift($user->roles); |
| [512](#L512) | $comission = get\_option("wpdmpp\_user\_comission"); |
| [513](#L513) | $comission = isset($comission[$role]) ? (double)$comission[$role] : 0; |
| [514](#L514) | return $comission; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | function wpdmpp\_get\_user\_earning() |
| [518](#L518) | { |
| [519](#L519) |  |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) |  |
| [523](#L523) | function wpdmpp\_product\_price($pid, $license = '') |
| [524](#L524) | { |
| [525](#L525) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [526](#L526) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [527](#L527) | $price = (double)($sales\_price) > 0 && $sales\_price < $base\_price ? (double)$sales\_price : (double)$base\_price; |
| [528](#L528) |  |
| [529](#L529) | if (floatval($price) == 0) return number\_format(0, 2, ".", ""); |
| [530](#L530) | return number\_format($price, 2, ".", ""); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | function wpdmpp\_is\_ajax() |
| [534](#L534) | { |
| [535](#L535) | if (!empty($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) && |
| [536](#L536) | strtolower($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) == 'xmlhttprequest' |
| [537](#L537) | ) return TRUE; |
| [538](#L538) | return false; |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) | //delete product from front-end |
| [542](#L542) | function wpdmpp\_delete\_product() |
| [543](#L543) | { |
| [544](#L544) | if (is\_user\_logged\_in() && isset($\_GET['dproduct'])) { |
| [545](#L545) | global $current\_user; |
| [546](#L546) | $current\_user = wp\_get\_current\_user(); |
| [547](#L547) | $pid = intval($\_GET['dproduct']); |
| [548](#L548) | $pro = get\_post($pid); |
| [549](#L549) |  |
| [550](#L550) | if ($current\_user->ID == $pro->post\_author) { |
| [551](#L551) | wp\_update\_post(array('ID' => $pid, 'post\_status' => 'trash')); |
| [552](#L552) | $settings = get\_option('\_wpdmpp\_settings'); |
| [553](#L553) | if ($settings['frontend\_product\_delete\_notify'] == 1) { |
| [554](#L554) | wp\_mail(get\_option('admin\_email'), "I had to delete a product", "Hi, Sorry, but I had to delete following product for some reason:<br/>{$pro->post\_title}", "From: {$current\_user->user\_email}\r\nContent-type: text/html\r\n\r\n"); |
| [555](#L555) | } |
| [556](#L556) | Session::set('dpmsg', \_\_('Product Deleted', 'wpdm-premium-packages')); |
| [557](#L557) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [558](#L558) | header("location: " . $return); |
| [559](#L559) | die(); |
| [560](#L560) | } |
| [561](#L561) | } |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | function wpdmpp\_order\_completed\_mail() |
| [565](#L565) | { |
| [566](#L566) |  |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | function wpdmpp\_head() |
| [570](#L570) | { |
| [571](#L571) | $wpdmpp\_txt = array( |
| [572](#L572) | 'cart\_button\_label' => get\_wpdmpp\_option('a2cbtn\_label', '<i class="fas fa-shopping-basket mr-2"></i>' . \_\_('Add To Cart', 'wpdm-premium-packages')), |
| [573](#L573) | 'pay\_now' => get\_wpdmpp\_option('cobtn\_label', \_\_('Complete Purchase', 'wpdm-premium-packages')), |
| [574](#L574) | 'checkout\_button\_label' => get\_wpdmpp\_option('cobtn\_label', \_\_('Complete Purchase', 'wpdm-premium-packages')), |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | ?> |
| [578](#L578) | <script> |
| [579](#L579) | var wpdmpp\_base\_url = '<?php echo plugins\_url('/wpdm-premium-packages/'); ?>'; |
| [580](#L580) | var wpdmpp\_currency\_sign = '<?php echo wpdmpp\_currency\_sign(); ?>'; |
| [581](#L581) | var wpdmpp\_csign\_before = '<?php echo wpdmpp\_currency\_sign\_position() == 'before' ? wpdmpp\_currency\_sign() : ''; ?>'; |
| [582](#L582) | var wpdmpp\_csign\_after = '<?php echo wpdmpp\_currency\_sign\_position() == 'after' ? wpdmpp\_currency\_sign() : ''; ?>'; |
| [583](#L583) | var wpdmpp\_currency\_code = '<?php echo wpdmpp\_currency\_code(); ?>'; |
| [584](#L584) | var wpdmpp\_cart\_url = '<?php echo wpdmpp\_cart\_page(); ?>'; |
| [585](#L585) |  |
| [586](#L586) | var wpdmpp\_txt = <?php echo json\_encode($wpdmpp\_txt); ?>; |
| [587](#L587) |  |
| [588](#L588) | </script> |
| [589](#L589) | <style>p.wpdmpp-notice { |
| [590](#L590) | margin: 5px; |
| [591](#L591) | } |
| [592](#L592) | .wpbtn-success { |
| [593](#L593) | color: var(--color-success) !important;border-color: var(--color-success ) !important; |
| [594](#L594) | background: rgba(var(--color-success-rgb),0.03) !important; |
| [595](#L595) | transition: all ease-in-out 300ms; |
| [596](#L596) | } |
| [597](#L597) | .wpbtn-success:active, |
| [598](#L598) | .wpbtn-success:hover { |
| [599](#L599) | color: var(--color-success-active) !important; |
| [600](#L600) | border-color: var(--color-success-active) !important; |
| [601](#L601) | background: rgba(var(--color-success-rgb),0.07) !important; |
| [602](#L602) | } |
| [603](#L603) | </style> |
| [604](#L604) | <?php |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | function wpdmpp\_admin\_footer() |
| [608](#L608) | { |
| [609](#L609) | global $pagenow; |
| [610](#L610) | if($pagenow !== 'edit.php' || wpdm\_query\_var('post\_type') !== 'wpdmpro') return; |
| [611](#L611) | ?> |
| [612](#L612) | <script> |
| [613](#L613) | jQuery(function ($) { |
| [614](#L614) | let $body = $('body'); |
| [615](#L615) |  |
| [616](#L616) | $('.page-title-action').after('<button data-toggle="modal" data-target="#modal-pay-link" type="button" class="page-title-action wpbtn-success wpbtn-pay-link"><?php echo \_\_('Create Pay Link', WPDM\_TEXT\_DOMAIN) ?></button>'); |
| [617](#L617) |  |
| [618](#L618) | $body.on('keyup', '.pla', function () { |
| [619](#L619) | let price = parseFloat($('#plprice').val()); |
| [620](#L620) | let title = $('#pltitle').val(); |
| [621](#L621) | let desc = $('#pldesc').val(); |
| [622](#L622) | let rec = $('#plrec').is(':checked') ? 1 : 0; |
| [623](#L623) | let plinnk = "<?= home\_url('/?addtocart=dynamic&price=') ?>" + price + '&name=' + title + '&desc=' + desc + '&recurring=0'; |
| [624](#L624) | $('#plink').val(plinnk); |
| [625](#L625) | }); |
| [626](#L626) |  |
| [627](#L627) | $body.on('submit', '#sendplink', function (e) { |
| [628](#L628) | e.preventDefault(); |
| [629](#L629) | let $plform = $(this); |
| [630](#L630) | WPDM.blockUI('#sendplink'); |
| [631](#L631) | $plform.ajaxSubmit({ |
| [632](#L632) | url: ajaxurl, |
| [633](#L633) | success: function ($) { |
| [634](#L634) | WPDM.notify('<?= \_\_('Payment link has been send successfully', WPDMPP\_TEXT\_DOMAIN) ?>', 'success', 'top-center', 6000); |
| [635](#L635) | WPDM.unblockUI('#sendplink'); |
| [636](#L636) | } |
| [637](#L637) | }); |
| [638](#L638) | }); |
| [639](#L639) |  |
| [640](#L640) |  |
| [641](#L641) | }); |
| [642](#L642) | </script> |
| [643](#L643) |  |
| [644](#L644) | <div class="w3eden"> |
| [645](#L645) | <div class="modal fade" tabindex="-1" role="dialog" id="modal-pay-link"> |
| [646](#L646) | <div class="modal-dialog" role="document" style="width: 400px"> |
| [647](#L647) | <form method="post" id="sendplink"> |
| [648](#L648) | <?php wp\_nonce\_field(WPDM\_PUB\_NONCE, 'plinknonce') ?> |
| [649](#L649) | <input type="hidden" name="action" value="wpdmpp\_email\_payment\_link" /> |
| [650](#L650) | <div class="modal-content"> |
| [651](#L651) | <div class="modal-header"> |
| [652](#L652) | <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> |
| [653](#L653) | <h4 class="modal-title"><?= \_\_('Create Payment Link', WPDMPP\_TEXT\_DOMAIN); ?></h4> |
| [654](#L654) | </div> |
| [655](#L655) | <div class="modal-body"> |
| [656](#L656) | <div class="panel panel-default"> |
| [657](#L657) | <div class="panel-heading"><?= \_\_('Payment Link Options', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [658](#L658) | <div class="panel-body"> |
| [659](#L659) | <div class="form-group"> |
| [660](#L660) | <label><?= \_\_('Price', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [661](#L661) | <input required="required" step="0.01" min="0" type="number" class="form-control pla" id="plprice" name="price" /> |
| [662](#L662) | </div> |
| [663](#L663) | <div class="form-group"> |
| [664](#L664) | <label><?= \_\_('Title', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [665](#L665) | <input required="required" type="text" placeholder="<?= \_\_('Reason form payment', WPDMPP\_TEXT\_DOMAIN) ?>" name="name" class="form-control pla" id="pltitle" /> |
| [666](#L666) | </div> |
| [667](#L667) | <div class="form-group"> |
| [668](#L668) | <label><?= \_\_('Description', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [669](#L669) | <input type="text" placeholder="<?= \_\_('You may add more details about this payment', WPDMPP\_TEXT\_DOMAIN) ?>" name="desc" class="form-control pla" id="pldesc" /> |
| [670](#L670) | </div> |
| [671](#L671) | <!--<div class="form-group"> |
| [672](#L672) | <label><input type="checkbox" value="1" id="plrec" /> <?/\*= \_\_('Recurring Payment', WPDMPP\_TEXT\_DOMAIN) \*/?></label> |
| [673](#L673) | </div>--> |
| [674](#L674) | </div> |
| [675](#L675) | </div> |
| [676](#L676) | <div class="form-group"> |
| [677](#L677) | <div class="panel panel-default"> |
| [678](#L678) | <div class="panel-heading"><?= \_\_('Generated Payment Link', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [679](#L679) | <div class="panel-body"> |
| [680](#L680) | <div class="input-group"> |
| [681](#L681) | <input type="text" readonly="readonly" class="form-control bg-white" id="plink" /> |
| [682](#L682) | <div class="input-group-btn"><button onclick="WPDM.copy('plink');" type="button" class="btn btn-info"><i class="fa fa-copy"></i></button></div> |
| [683](#L683) | </div> |
| [684](#L684) | </div> |
| [685](#L685) | </div> |
| [686](#L686) | </div> |
| [687](#L687) | <div class="form-group"> |
| [688](#L688) | <div class="panel panel-default"> |
| [689](#L689) | <div class="panel-heading"><?= \_\_('Email Payment Link', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [690](#L690) | <div class="panel-body"> |
| [691](#L691) | <div class="form-group"> |
| [692](#L692) | <label><?= \_\_('Note:', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [693](#L693) | <textarea placeholder="<?= esc\_attr\_\_('Write something about this payment request', WPDMPP\_TEXT\_DOMAIN) ?>" class="form-control" name="msg"></textarea> |
| [694](#L694) | </div> |
| [695](#L695) | <div class="input-group"> |
| [696](#L696) | <input name="emails" type="text" placeholder="<?= esc\_attr\_\_('Email(s)', WPDMPP\_TEXT\_DOMAIN) ?>" class="form-control" id="plink" /> |
| [697](#L697) | <div class="input-group-btn"><button type="submit" class="btn btn-info" id="send-plink"><i class="fa fa-paper-plane"></i> <?= \_\_('Send', WPDMPP\_TEXT\_DOMAIN); ?></button></div> |
| [698](#L698) | </div> |
| [699](#L699) | <em class="note"><?= \_\_('Multiple emails separate by comma', WPDMPP\_TEXT\_DOMAIN) ?></em> |
| [700](#L700) | </div> |
| [701](#L701) | </div> |
| [702](#L702) | </div> |
| [703](#L703) | </div> |
| [704](#L704) |  |
| [705](#L705) | </div><!-- /.modal-content --> |
| [706](#L706) | </form> |
| [707](#L707) | </div><!-- /.modal-dialog --> |
| [708](#L708) | </div><!-- /.modal --> |
| [709](#L709) | </div> |
| [710](#L710) |  |
| [711](#L711) | <?php |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) |  |
| [715](#L715) | function wpdmpp\_delete\_frontend\_order() |
| [716](#L716) | { |
| [717](#L717) | if (!wp\_verify\_nonce($\_REQUEST['nonce'], NONCE\_KEY)) { |
| [718](#L718) | exit("No naughty business please"); |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | $result['type'] = 'failed'; |
| [722](#L722) | global $wpdb; |
| [723](#L723) | $order\_id = sanitize\_text\_field(esc\_sql($\_REQUEST['order\_id'])); |
| [724](#L724) | $uid = get\_current\_user\_id(); |
| [725](#L725) | $ret = $wpdb->query($wpdb->prepare("DELETE FROM {$wpdb->prefix}ahm\_orders WHERE order\_id = %s and uid='$uid'", $order\_id)); |
| [726](#L726) |  |
| [727](#L727) | if ($ret) { |
| [728](#L728) | $ret = $wpdb->query($wpdb->prepare("DELETE FROM {$wpdb->prefix}ahm\_order\_items WHERE oid = %s", $order\_id)); |
| [729](#L729) |  |
| [730](#L730) | if ($ret) $result['type'] = 'success'; |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | if (!empty($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) && strtolower($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) == 'xmlhttprequest') { |
| [734](#L734) | $result = json\_encode($result); |
| [735](#L735) | echo $result; |
| [736](#L736) | } else { |
| [737](#L737) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [738](#L738) | header("Location: " . $return); |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | die(); |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) |  |
| [745](#L745) | /\*\* |
| [746](#L746) | \* Update Guest Billing Info |
| [747](#L747) | \*/ |
| [748](#L748) | function wpdmpp\_update\_guest\_billing() |
| [749](#L749) | { |
| [750](#L750) | $billinginfo = array |
| [751](#L751) | ( |
| [752](#L752) | 'first\_name' => '', |
| [753](#L753) | 'last\_name' => '', |
| [754](#L754) | 'company' => '', |
| [755](#L755) | 'address\_1' => '', |
| [756](#L756) | 'address\_2' => '', |
| [757](#L757) | 'city' => '', |
| [758](#L758) | 'postcode' => '', |
| [759](#L759) | 'country' => '', |
| [760](#L760) | 'state' => '', |
| [761](#L761) | 'order\_email' => '', |
| [762](#L762) | 'email' => '', |
| [763](#L763) | 'phone' => '', |
| [764](#L764) | 'taxid' => '' |
| [765](#L765) | ); |
| [766](#L766) | $sbillinginfo = wpdm\_sanitize\_array($\_POST['billing']); |
| [767](#L767) | $billinginfo = shortcode\_atts($billinginfo, $sbillinginfo); |
| [768](#L768) | $oid = \WPDM\\_\_\Crypt::decrypt(wpdm\_query\_var('oid')); |
| [769](#L769) | \WPDMPP\Libs\Order::Update(array('billing\_info' => maybe\_serialize($billinginfo)), $oid); |
| [770](#L770) | die(\_\_('Billing info saved successfully!', WPDMPP\_TEXT\_DOMAIN)); |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | function wpdmpp\_recalculate\_sales() |
| [774](#L774) | { |
| [775](#L775) | if (!isset($\_POST['id'])) return; |
| [776](#L776) | global $wpdb; |
| [777](#L777) | $id = (int)$\_POST['id']; |
| [778](#L778) | $sql = "select sum(quantity\*price) as sales\_amount, sum(quantity) as sales\_quantity from {$wpdb->prefix}ahm\_order\_items oi, {$wpdb->prefix}ahm\_orders o where oi.oid = o.order\_id and oi.pid = {$id} and o.order\_status IN ('Completed', 'Expired')"; |
| [779](#L779) | $data = $wpdb->get\_row($sql); |
| [780](#L780) |  |
| [781](#L781) | header('Content-type: application/json'); |
| [782](#L782) | update\_post\_meta($id, '\_\_wpdm\_sales\_amount', $data->sales\_amount); |
| [783](#L783) | update\_post\_meta($id, '\_\_wpdm\_sales\_count', $data->sales\_quantity); |
| [784](#L784) | $data->sales\_amount = wpdmpp\_currency\_sign() . floatval($data->sales\_amount); |
| [785](#L785) | $data->sales\_quantity = intval($data->sales\_quantity); |
| [786](#L786) | echo json\_encode($data); |
| [787](#L787) | die(); |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | function wpdmpp\_sales\_price($pid) |
| [791](#L791) | { |
| [792](#L792) | $sales\_price = get\_post\_meta($pid, "\_\_wpdm\_sales\_price", true); |
| [793](#L793) | $sales\_price\_expire = get\_post\_meta($pid, "\_\_wpdm\_sales\_price\_expire", true); |
| [794](#L794) | if ($sales\_price\_expire != '') { |
| [795](#L795) | $sales\_price\_expire = strtotime($sales\_price\_expire); |
| [796](#L796) | if (time() > $sales\_price\_expire && $sales\_price\_expire > 0) $sales\_price = 0; |
| [797](#L797) | } |
| [798](#L798) | return number\_format((double)$sales\_price, 2, ".", ""); |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | function wpdmpp\_sales\_price\_info($product\_id) |
| [802](#L802) | { |
| [803](#L803) | $sales\_price\_expire = get\_post\_meta($product\_id, '\_\_wpdm\_sales\_price\_expire', true); |
| [804](#L804) | if ($sales\_price\_expire != '') |
| [805](#L805) | $sales\_price\_expire = strtotime($sales\_price\_expire); |
| [806](#L806) | $sales\_price\_info = $sales\_price\_expire != '' ? sprintf(\_\_("Sales price will expire on %s", "wpdm-premium-packages"), wp\_date(get\_option("date\_format") . " H:i", $sales\_price\_expire)) : \_\_("This is a discounted price for a limited time", "wpdm-premium-packages"); |
| [807](#L807) | $sales\_price\_info = apply\_filters("wpdmpp\_sales\_price\_info", $sales\_price\_info, $product\_id, $sales\_price\_expire); |
| [808](#L808) | return $sales\_price\_info; |
| [809](#L809) |  |
| [810](#L810) | } |
| [811](#L811) |  |
| [812](#L812) | /\*\* |
| [813](#L813) | \* @param $pid |
| [814](#L814) | \* @return string |
| [815](#L815) | \*/ |
| [816](#L816) | function wpdmpp\_effective\_price($pid) |
| [817](#L817) | { |
| [818](#L818) | global $current\_user; |
| [819](#L819) | $current\_user = wp\_get\_current\_user(); |
| [820](#L820) | if (get\_post\_type($pid) != 'wpdmpro') return 0; |
| [821](#L821) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [822](#L822) | $base\_price = $base\_price ? (double)$base\_price : 0; |
| [823](#L823) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [824](#L824) | $price = (double)($sales\_price) > 0 ? $sales\_price : $base\_price; |
| [825](#L825) | $role = is\_user\_logged\_in() && is\_array($current\_user->roles) && isset($current\_user->roles[0]) ? $current\_user->roles[0] : 'guest'; |
| [826](#L826) | $discount = maybe\_unserialize(get\_post\_meta($pid, '\_\_wpdm\_discount', true)); |
| [827](#L827) | if (!is\_array($discount) || count($discount) == 0) return number\_format((float)$price, 2, ".", ""); |
| [828](#L828) |  |
| [829](#L829) | $discount[$role] = isset($discount[$role]) ? $discount[$role] : 0; |
| [830](#L830) | $discount[$role] = (double)$discount[$role]; |
| [831](#L831) | $user\_discount = (($price \* $discount[$role]) / 100); |
| [832](#L832) | $price -= $user\_discount; |
| [833](#L833) |  |
| [834](#L834) | if (!$price) $price = 0; |
| [835](#L835) | return number\_format($price, 2, ".", ""); |
| [836](#L836) | } |
| [837](#L837) |  |
| [838](#L838) | /\*\* |
| [839](#L839) | \* @param $pid |
| [840](#L840) | \* @return int|mixed |
| [841](#L841) | \*/ |
| [842](#L842) | function wpdmpp\_role\_discount($pid, $name = false) |
| [843](#L843) | { |
| [844](#L844) | global $current\_user, $wp\_roles; |
| [845](#L845) | $current\_user = wp\_get\_current\_user(); |
| [846](#L846) | $role\_discount = 0; |
| [847](#L847) | $role\_name = ''; |
| [848](#L848) | //$role = ?$current\_user->roles[0]:'guest'; |
| [849](#L849) | $discount = maybe\_unserialize(get\_post\_meta($pid, '\_\_wpdm\_discount', true)); |
| [850](#L850) |  |
| [851](#L851) | $roles = $wp\_roles->role\_names; |
| [852](#L852) |  |
| [853](#L853) |  |
| [854](#L854) | if (is\_user\_logged\_in() && is\_array($discount)) { |
| [855](#L855) | foreach ($current\_user->roles as $role) { |
| [856](#L856) | if (isset($discount[$role]) && $discount[$role] > $role\_discount) { |
| [857](#L857) | $role\_discount = $discount[$role]; |
| [858](#L858) | $role\_name = isset($roles[$role]) ? $roles[$role] : $role; |
| [859](#L859) | } |
| [860](#L860) | } |
| [861](#L861) | } |
| [862](#L862) | if (!is\_user\_logged\_in() && is\_array($discount) && isset($discount['guest'])) $role\_discount = $discount['guest']; |
| [863](#L863) | if (!is\_array($discount) || count($discount) == 0) return 0; |
| [864](#L864) |  |
| [865](#L865) | return $name ? $role\_name : $role\_discount; |
| [866](#L866) | } |
| [867](#L867) |  |
| [868](#L868) |  |
| [869](#L869) | function wpdmpp\_price\_range($pid) |
| [870](#L870) | { |
| [871](#L871) | $pre\_licenses = wpdmpp\_get\_licenses(); |
| [872](#L872) | $license\_infs = get\_post\_meta($pid, "\_\_wpdm\_license", true); |
| [873](#L873) | $license\_infs = maybe\_unserialize($license\_infs); |
| [874](#L874) | $licprices = array(); |
| [875](#L875) |  |
| [876](#L876) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [877](#L877) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [878](#L878) | $base\_price = intval($sales\_price) > 0 ? $sales\_price : $base\_price; |
| [879](#L879) |  |
| [880](#L880) | foreach ($pre\_licenses as $licid => $lic) { |
| [881](#L881) | if (isset($license\_infs[$licid]) && $license\_infs[$licid]['active'] == 1) { |
| [882](#L882) | $licprices[] = isset($license\_infs[$licid]['price']) ? $license\_infs[$licid]['price'] : $base\_price; |
| [883](#L883) | } |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | $price\_range = wpdmpp\_price\_format((float)$base\_price, true, true); |
| [887](#L887) |  |
| [888](#L888) | if (count($licprices) > 1 && get\_post\_meta($pid, "\_\_wpdm\_enable\_license", true) == 1) { |
| [889](#L889) | sort($licprices); |
| [890](#L890) | $fromprice = $licprices[0]; |
| [891](#L891) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [892](#L892) | if ($sales\_price < $fromprice && $sales\_price > 0) $fromprice = $sales\_price; |
| [893](#L893) | $price\_range = wpdmpp\_price\_format($fromprice, true, true) . " &mdash; " . wpdmpp\_price\_format(end($licprices), true, true); |
| [894](#L894) | } |
| [895](#L895) | return $price\_range; |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | function wpdmpp\_order\_id() |
| [899](#L899) | { |
| [900](#L900) | return Session::get('orderid'); |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | function wpdmpp\_currency\_sign() |
| [904](#L904) | { |
| [905](#L905) | $settings = get\_option('\_wpdmpp\_settings'); |
| [906](#L906) | $currency = isset($settings['currency']) ? $settings['currency'] : 'USD'; |
| [907](#L907) | $cdata = \WPDMPP\Libs\Currencies::GetCurrency($currency); |
| [908](#L908) | $sign = is\_array($cdata) ? $cdata['symbol'] : '$'; |
| [909](#L909) | $sign = apply\_filters("wpdmpp\_currency\_sign", $sign); |
| [910](#L910) | return $sign; |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | function wpdmpp\_currency\_sign\_position() |
| [914](#L914) | { |
| [915](#L915) | $settings = get\_option('\_wpdmpp\_settings'); |
| [916](#L916) | $currency\_position = isset($settings['currency\_position']) ? $settings['currency\_position'] : 'before'; |
| [917](#L917) | return $currency\_position; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | function wpdmpp\_currency\_code() |
| [921](#L921) | { |
| [922](#L922) | $settings = get\_option('\_wpdmpp\_settings'); |
| [923](#L923) | $currency = isset($settings['currency']) ? $settings['currency'] : 'USD'; |
| [924](#L924) | $currency = apply\_filters("wpdmpp\_currency\_code", $currency); |
| [925](#L925) | return $currency; |
| [926](#L926) | } |
| [927](#L927) |  |
| [928](#L928) | /\*\* |
| [929](#L929) | \* Validating download request using 'wpdm\_onstart\_download' WPDM hook |
| [930](#L930) | \* @param $package |
| [931](#L931) | \* @return mixed |
| [932](#L932) | \*/ |
| [933](#L933) | function wpdmpp\_validate\_download($package) |
| [934](#L934) | { |
| [935](#L935) |  |
| [936](#L936) | $price = wpdmpp\_effective\_price($package['ID']); |
| [937](#L937) | if (floatval($price) > 0) { |
| [938](#L938) |  |
| [939](#L939) | // Check The Master Key |
| [940](#L940) | if (wpdm\_query\_var('masterkey') !== '' && WPDMPremiumPackage::authorize\_masterkey()) return $package; |
| [941](#L941) |  |
| [942](#L942) | // Validate Download Key |
| [943](#L943) | //wpdmdd(is\_wpdmkey\_valid($package['ID'], wpdm\_query\_var('\_wpdmkey'))); |
| [944](#L944) | //wpdmdd(get\_wpdmpp\_option('authorize\_masterkey')); |
| [945](#L945) | if (is\_wpdmkey\_valid($package['ID'], wpdm\_query\_var('\_wpdmkey')) === 1 && (int)get\_wpdmpp\_option('authorize\_masterkey') === 1) return $package; |
| [946](#L946) |  |
| [947](#L947) | if ( (int) Session::get('\_\_wpdmpp\_authorized\_download') === 1) return $package; |
| [948](#L948) |  |
| [949](#L949) | Messages::error('You do not have permission to download this file', 1); |
| [950](#L950) |  |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | return $package; |
| [954](#L954) |  |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | /\*\* |
| [958](#L958) | \* Assign an order to specific user |
| [959](#L959) | \*/ |
| [960](#L960) | function wpdmpp\_assign\_user\_2order() |
| [961](#L961) | { |
| [962](#L962) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($\_REQUEST['\_\_nonce'], NONCE\_KEY)) { |
| [963](#L963) | Messages::error(\_\_('Unauthorized Operation!', 'wpdm-premium-packages'), 1); |
| [964](#L964) | } |
| [965](#L965) | $wpdmpp\_settings = get\_option('\_wpdmpp\_settings'); |
| [966](#L966) | if (isset($\_REQUEST['assignuser']) && isset($\_REQUEST['order'])) { |
| [967](#L967) | if (is\_email($\_REQUEST['assignuser'])) |
| [968](#L968) | $u = get\_user\_by('email', sanitize\_email($\_REQUEST['assignuser'])); |
| [969](#L969) | else |
| [970](#L970) | $u = get\_user\_by('login', sanitize\_text\_field($\_REQUEST['assignuser'])); |
| [971](#L971) | if (is\_object($u) && isset($u->ID)) { |
| [972](#L972) | $order = new \WPDMPP\Libs\Order(); |
| [973](#L973) | $oid = esc\_attr($\_REQUEST['order']); |
| [974](#L974) | $order->Update(array('uid' => $u->ID), sanitize\_text\_field($oid)); |
| [975](#L975) | $logo = isset($settings['logo\_url']) && $wpdmpp\_settings['logo\_url'] != "" ? "<img src='{$wpdmpp\_settings['logo\_url']}' alt='" . get\_bloginfo('name') . "'/>" : get\_bloginfo('name'); |
| [976](#L976) | $params = array( |
| [977](#L977) | 'date' => wp\_date(get\_option('date\_format'), time()), |
| [978](#L978) | 'homeurl' => home\_url('/'), |
| [979](#L979) | 'sitename' => get\_bloginfo('name'), |
| [980](#L980) | 'order\_link' => "<a href='" . wpdmpp\_orders\_page('id=' . $oid) . "'>" . wpdmpp\_orders\_page('id=' . $oid) . "</a>", |
| [981](#L981) | 'register\_link' => "<a href='" . wpdmpp\_orders\_page('orderid=' . $oid) . "'>" . wpdmpp\_orders\_page('orderid=' . $oid) . "</a>", |
| [982](#L982) | 'name' => $u->user\_login, |
| [983](#L983) | 'orderid' => $oid, |
| [984](#L984) | 'to\_email' => $u->user\_email, |
| [985](#L985) | 'order\_url' => wpdmpp\_orders\_page('id=' . $oid), |
| [986](#L986) | 'order\_url\_admin' => admin\_url('edit.php?post\_type=wpdmpro&page=orders&task=vieworder&id=' . $oid), |
| [987](#L987) | 'img\_logo' => $logo |
| [988](#L988) | ); |
| [989](#L989) | \WPDMPP\Libs\User::addCustomer($u); |
| [990](#L990) | \WPDM\\_\_\Email::send("purchase-confirmation", $params); |
| [991](#L991) | die('<div class="color-green" style="padding: 7px 15px;margin: 0;border-radius: 2px">Order Is Linked to ' . esc\_attr($\_REQUEST['assignuser']) . "</div>"); |
| [992](#L992) | } else |
| [993](#L993) | die('<div class="alert alert-danger" style="padding: 7px 15px;background: rgba(255,0,23,0.05);margin: 0;border-radius: 2px">' . \_\_('User Not Found!', 'wpdm-premium-packages') . '</div>'); |
| [994](#L994) | } |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) |  |
| [998](#L998) | function wpdmpp\_download\_order\_note\_attachment() |
| [999](#L999) | { |
| [1000](#L1000) | global $current\_user; |
| [1001](#L1001) | $current\_user = wp\_get\_current\_user(); |
| [1002](#L1002) | if (!isset($\_GET['\_atcdl']) || !is\_user\_logged\_in()) return false; |
| [1003](#L1003) | $key = \WPDM\\_\_\Crypt::Decrypt(esc\_attr($\_GET['\_atcdl'])); |
| [1004](#L1004) | $key = explode("|||", $key); |
| [1005](#L1005) | $order = new \WPDMPP\Libs\Order($key[0]); |
| [1006](#L1006) | if ($order->uid != $current\_user->ID && !current\_user\_can('manage\_options')) wp\_die('Unauthorized Access'); |
| [1007](#L1007) | $files = $order->order\_notes['messages'][$key[1]]['file']; |
| [1008](#L1008) | $filename = preg\_replace("/^[0-9]+?wpdm\_/", "", wpdm\_basename($key[2])); |
| [1009](#L1009) | if (in\_array($key[2], $files)) { |
| [1010](#L1010) | wpdm\_download\_file(UPLOAD\_DIR . $key[2], $filename); |
| [1011](#L1011) | die(); |
| [1012](#L1012) | } |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | /\*\* |
| [1016](#L1016) | \* Return array of country objects |
| [1017](#L1017) | \* @return array |
| [1018](#L1018) | \*/ |
| [1019](#L1019) | function wpdmpp\_get\_countries() |
| [1020](#L1020) | { |
| [1021](#L1021) | global $wpdb; |
| [1022](#L1022) | $countries = $wpdb->get\_results("select \* from {$wpdb->prefix}ahm\_country order by country\_name"); |
| [1023](#L1023) |  |
| [1024](#L1024) | return $countries; |
| [1025](#L1025) | } |
| [1026](#L1026) |  |
| [1027](#L1027) | /\*\* |
| [1028](#L1028) | \* Return Premium Package Template Directory |
| [1029](#L1029) | \* @return string |
| [1030](#L1030) | \*/ |
| [1031](#L1031) | function wpdmpp\_tpl\_dir() |
| [1032](#L1032) | { |
| [1033](#L1033) | return WPDMPP\_TPL\_DIR; |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) | function wpdmpp\_email\_template\_tags($tags) |
| [1037](#L1037) | { |
| [1038](#L1038) | $tags["{{orderid}}"] = array('value' => '', 'desc' => 'Order ID'); |
| [1039](#L1039) | $tags["{{items}}"] = array('value' => '', 'desc' => 'List of purchased items'); |
| [1040](#L1040) | $tags["{{order\_url}}"] = array('value' => '', 'desc' => 'Order URL'); |
| [1041](#L1041) | $tags["{{guest\_order\_url}}"] = array('value' => '', 'desc' => 'Guest Order URL'); |
| [1042](#L1042) | return $tags; |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) | function wpdmpp\_email\_templates($templates) |
| [1046](#L1046) | { |
| [1047](#L1047) | $templates['purchase-confirmation-guest'] = array( |
| [1048](#L1048) | 'label' => \_\_('Purchase Confirmation - Guest', 'wpdmpro'), |
| [1049](#L1049) | 'for' => 'customer', |
| [1050](#L1050) | 'plugin' => 'Premium Packages', |
| [1051](#L1051) | 'default' => array('subject' => \_\_('Thanks For Your Purchase', 'wpdmpro'), |
| [1052](#L1052) | 'from\_name' => get\_option('blogname'), |
| [1053](#L1053) | 'from\_email' => get\_option('admin\_email'), |
| [1054](#L1054) | 'message' => 'Hello ,<br/>Thanks for your order at [#sitename#].<br/>Your Order ID: [#orderid#]<br/>Purchased Items:<br/>[#items#]<br/>You need to create an account to access your order and to get future updates.<br/>Please click on the following link to create your account:<br/><a class="button green" style="display: block; text-align: center;" href="[#order\_url#]">Signup</a>If you already have account simply click the above url and login<br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1055](#L1055) | ) |
| [1056](#L1056) | ); |
| [1057](#L1057) |  |
| [1058](#L1058) | $templates['purchase-confirmation'] = array( |
| [1059](#L1059) | 'label' => \_\_('Purchase Confirmation', 'wpdmpro'), |
| [1060](#L1060) | 'for' => 'customer', |
| [1061](#L1061) | 'plugin' => 'Premium Packages', |
| [1062](#L1062) | 'default' => array('subject' => \_\_('Thanks For Your Purchase', 'wpdmpro'), |
| [1063](#L1063) | 'from\_name' => get\_option('blogname'), |
| [1064](#L1064) | 'from\_email' => get\_option('admin\_email'), |
| [1065](#L1065) | 'message' => 'Hello ,<br/>Thanks for your order at [#sitename#].<br/>Your Order ID: [#orderid#]<br/>Purchased Items:<br/>[#items#]<br/>You can download your purchased item(s) from the following link:<br/><a href="[#order\_url#]">[#order\_url#]</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1066](#L1066) | ) |
| [1067](#L1067) | ); |
| [1068](#L1068) |  |
| [1069](#L1069) | $templates['subscription-reminder'] = array( |
| [1070](#L1070) | 'label' => \_\_('Subscription Reminder', 'wpdmpro'), |
| [1071](#L1071) | 'for' => 'customer', |
| [1072](#L1072) | 'plugin' => 'Premium Packages', |
| [1073](#L1073) | 'default' => array('subject' => \_\_('[#sitename#] Subscription Reminder', 'wpdmpro'), |
| [1074](#L1074) | 'from\_name' => get\_option('blogname'), |
| [1075](#L1075) | 'from\_email' => get\_option('admin\_email'), |
| [1076](#L1076) | 'message' => 'Hello,<br/>Thanks for your continued support.<br/>We\'re sending this message to remind you that, as your subscription is active, your Order# [#orderid#] will be renewed automatically on [#expire\_date#]. <br/><br/><strong>Associated Items:</strong><hr/>[#items#]<hr/><br/> <a href="[#order\_url#]" style="display: block;text-align: center" class="button">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1077](#L1077) | ) |
| [1078](#L1078) | ); |
| [1079](#L1079) |  |
| [1080](#L1080) | $templates['renew-confirmation'] = array( |
| [1081](#L1081) | 'label' => \_\_('Order Renew Confirmation', 'wpdmpro'), |
| [1082](#L1082) | 'for' => 'customer', |
| [1083](#L1083) | 'plugin' => 'Premium Packages', |
| [1084](#L1084) | 'default' => array('subject' => \_\_('Order Renewed Successfully', 'wpdmpro'), |
| [1085](#L1085) | 'from\_name' => get\_option('blogname'), |
| [1086](#L1086) | 'from\_email' => get\_option('admin\_email'), |
| [1087](#L1087) | 'message' => 'Hello,<br/>Thanks for your continued support.<br/>Your Order# [#orderid#] is renewed successfully.<br/>As always, you can download the latest version from the following link:<br/><a href="[#order\_url#]">[#order\_url#]</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1088](#L1088) | ) |
| [1089](#L1089) | ); |
| [1090](#L1090) |  |
| [1091](#L1091) | $templates['sale-notification'] = array( |
| [1092](#L1092) | 'label' => \_\_('New Sale Notification', 'wpdmpro'), |
| [1093](#L1093) | 'for' => 'admin', |
| [1094](#L1094) | 'plugin' => 'Premium Packages', |
| [1095](#L1095) | 'default' => array('subject' => \_\_('Congratulations! You have a sale.', 'wpdmpro'), |
| [1096](#L1096) | 'from\_name' => get\_option('blogname'), |
| [1097](#L1097) | 'from\_email' => get\_option('admin\_email'), |
| [1098](#L1098) | 'to\_email' => get\_option('admin\_email'), |
| [1099](#L1099) | 'message' => 'Hello ,<br/>Congratulations! You have a sale just now.<br/>Order ID: [#orderid#]<br/>Sold Items:<br/>[#items#]<br/>Review Order: [#order\_url\_admin#]' |
| [1100](#L1100) | ) |
| [1101](#L1101) | ); |
| [1102](#L1102) |  |
| [1103](#L1103) | $templates['sale-notification-seller'] = array( |
| [1104](#L1104) | 'label' => \_\_('New Sale Notification', 'wpdmpro'), |
| [1105](#L1105) | 'for' => 'seller', |
| [1106](#L1106) | 'plugin' => 'Premium Packages', |
| [1107](#L1107) | 'default' => array('subject' => \_\_('Congratulations! You have a sale.', 'wpdmpro'), |
| [1108](#L1108) | 'from\_name' => get\_option('blogname'), |
| [1109](#L1109) | 'from\_email' => get\_option('admin\_email'), |
| [1110](#L1110) | 'to\_email' => get\_option('admin\_email'), |
| [1111](#L1111) | 'message' => 'Hello ,<br/>Congratulations! You have a sale just now.<br/>Order ID: [#orderid#]<br/>Sold Items:<br/>[#items#]<br/>Review Order: [#order\_url\_seller#]' |
| [1112](#L1112) | ) |
| [1113](#L1113) | ); |
| [1114](#L1114) |  |
| [1115](#L1115) | $templates['os-notification'] = array( |
| [1116](#L1116) | 'label' => \_\_('Order Status Notification', 'wpdmpro'), |
| [1117](#L1117) | 'for' => 'customer', |
| [1118](#L1118) | 'plugin' => 'Premium Packages', |
| [1119](#L1119) | 'default' => array('subject' => \_\_('Order ([#orderid#]) Status Changed', 'wpdmpro'), |
| [1120](#L1120) | 'from\_name' => get\_option('blogname'), |
| [1121](#L1121) | 'from\_email' => get\_option('admin\_email'), |
| [1122](#L1122) | 'message' => 'Hello ,<br/>The order <strong>[#orderid#]</strong> is changed to <strong>[#order\_status#]</strong><br/>Review Order: <a class="button button-green green" style="margin: 15px 0;display: block;text-align: center" href="[#order\_url#]">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1123](#L1123) | ) |
| [1124](#L1124) | ); |
| [1125](#L1125) |  |
| [1126](#L1126) | $templates['order-expire'] = array( |
| [1127](#L1127) | 'label' => \_\_('Order Expiry Notification', 'wpdmpro'), |
| [1128](#L1128) | 'for' => 'customer', |
| [1129](#L1129) | 'plugin' => 'Premium Packages', |
| [1130](#L1130) | 'default' => array('subject' => \_\_('Your order is about to expire', 'wpdmpro'), |
| [1131](#L1131) | 'from\_name' => get\_option('blogname'), |
| [1132](#L1132) | 'from\_email' => get\_option('admin\_email'), |
| [1133](#L1133) | 'message' => 'Hello [#name#],<br/>Your order is about to expire.<br/>Order# [#orderid#]<br/><br/>Purchased Items# [#order\_items#]<br/>Please renew your order to get continuous support and updates.<br/><a class="button" href="[#order\_url#]">Renew Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1134](#L1134) | ) |
| [1135](#L1135) | ); |
| [1136](#L1136) |  |
| [1137](#L1137) | /\*$templates['email-saved-cart'] = array( |
| [1138](#L1138) | 'label' => \_\_('Email Saved Cart', 'wpdm-premium-packages'), |
| [1139](#L1139) | 'for' => 'customer', |
| [1140](#L1140) | 'plugin' => 'Premium Packages', |
| [1141](#L1141) | 'default' => array( |
| [1142](#L1142) | 'subject' => \_\_('Someone sent you a cart!', 'wpdm-premium-packages'), |
| [1143](#L1143) | 'from\_name' => get\_option('blogname'), |
| [1144](#L1144) | 'from\_email' => get\_option('admin\_email'), |
| [1145](#L1145) | 'message' => 'Hello,<br/>Someone sent you a cart from [#sitename#]:<br/>View Cart & Checkout from here:<br/><b><a href="[#carturl#]">[#carturl#]</a></b><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1146](#L1146) | ) |
| [1147](#L1147) | );\*/ |
| [1148](#L1148) |  |
| [1149](#L1149) | $templates['recovered-order-confirmation'] = array( |
| [1150](#L1150) | 'label' => \_\_('Recovered Order Confirmation', 'wpdmpro'), |
| [1151](#L1151) | 'for' => 'admin', |
| [1152](#L1152) | 'plugin' => 'Premium Packages', |
| [1153](#L1153) | 'default' => array('subject' => \_\_('Congratulation! Order recovered successfully', 'wpdmpro'), |
| [1154](#L1154) | 'from\_name' => get\_option('blogname'), |
| [1155](#L1155) | 'from\_email' => get\_option('admin\_email'), |
| [1156](#L1156) | 'message' => '<strong>Congratulation!</strong><br/>The following order has been recovered successfully.<br/>Order# {{orderid}}<br/><br/>Purchased Items# {{items}}<br/>Keep up good works!<br/><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{order\_url}}">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>' |
| [1157](#L1157) | ) |
| [1158](#L1158) | ); |
| [1159](#L1159) |  |
| [1160](#L1160) | $acre\_count = get\_wpdmpp\_option('acre\_count', 0, 'int'); |
| [1161](#L1161) | $acre\_msg\_template = [ |
| [1162](#L1162) | 1 => 'Hello {{name}},<br/>It looks like you haven’t finished checking out yet. The good news? We saved your cart for you. Go on and complete your order now before your cart expires.<br/>Your cart:<br/>{{items}}<b><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{checkout\_url}}">Checkout Now!</a></b><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>', |
| [1163](#L1163) | 2 => 'Hello {{name}},<br/>Thought, you have missed my last email. The good news? We saved your cart for you. Go on and complete your order now before your cart expires.<br/>Your cart:<br/>{{items}}<b><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{checkout\_url}}">Checkout Now!</a></b><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>', |
| [1164](#L1164) | ]; |
| [1165](#L1165) | if($acre\_count > 0) { |
| [1166](#L1166) | for ($acre = 1; $acre <= $acre\_count; $acre++) { |
| [1167](#L1167) | $templates['order-recovery-email-'.$acre] = array( |
| [1168](#L1168) | 'label' => sprintf(\_\_('Abandoned Order Recovery Email %s', 'wpdm-premium-packages'), $acre), |
| [1169](#L1169) | 'for' => 'customer', |
| [1170](#L1170) | 'plugin' => 'Premium Packages', |
| [1171](#L1171) | 'default' => array( |
| [1172](#L1172) | 'subject' => \_\_('Your cart is waiting for you!', 'wpdm-premium-packages'), |
| [1173](#L1173) | 'from\_name' => get\_option('blogname'), |
| [1174](#L1174) | 'from\_email' => get\_option('admin\_email'), |
| [1175](#L1175) | 'message' => wpdm\_valueof($acre\_msg\_template, $acre, "Add your abandoned order recovery email content # {$acre}") |
| [1176](#L1176) | ) |
| [1177](#L1177) | ); |
| [1178](#L1178) | } |
| [1179](#L1179) | } |
| [1180](#L1180) |  |
| [1181](#L1181) | return $templates; |
| [1182](#L1182) | } |
| [1183](#L1183) |  |
| [1184](#L1184) | function wpdmpp\_reactivate() |
| [1185](#L1185) | { |
| [1186](#L1186) | return \_\_("Database error detected. Please try deactivate and then reactivating plugin.", "wpdm-premium-packages"); |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | function wpdmpp\_expiry\_check() |
| [1190](#L1190) | { |
| [1191](#L1191) | $order = new \WPDMPP\Libs\Order(); |
| [1192](#L1192) | $uid = get\_current\_user\_id(); |
| [1193](#L1193) | $orders = $order->getOrders($uid); |
| [1194](#L1194) | foreach ($orders as $\_order) { |
| [1195](#L1195) | $expire\_date = $\_order->expire\_date > 0 ? $\_order->expire\_date : $\_order->date + (get\_wpdmpp\_option('order\_validity\_period', 365) \* 86400); |
| [1196](#L1196) | if (time() > $expire\_date && $\_order->order\_status != 'Expired') { |
| [1197](#L1197) | $order->Update(array('order\_status' => 'Expired', 'payment\_status' => 'Expired', 'expire\_date' => $expire\_date), $\_order->order\_id); |
| [1198](#L1198) | } |
| [1199](#L1199) | } |
| [1200](#L1200) |  |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | function wpdmpp\_sanitize\_alphanum($id) |
| [1204](#L1204) | { |
| [1205](#L1205) | return preg\_replace('/[^a-zA-Z0-9 -]/', "", $id); |
| [1206](#L1206) | } |
| [1207](#L1207) |  |
| [1208](#L1208) | /\*\* |
| [1209](#L1209) | \* @usage Format price |
| [1210](#L1210) | \* @param $price |
| [1211](#L1211) | \* @return string |
| [1212](#L1212) | \*/ |
| [1213](#L1213) | function wpdmpp\_price\_format($price, $currency\_sign = true, $thousand\_separator = true) |
| [1214](#L1214) | { |
| [1215](#L1215) | $ts = $thousand\_separator ? get\_wpdmpp\_option('thousand\_separator') : ''; |
| [1216](#L1216) | $ds = $thousand\_separator ? get\_wpdmpp\_option('decimal\_separator') : '.'; |
| [1217](#L1217) | $dp = $thousand\_separator ? (int)get\_wpdmpp\_option('decimal\_points') : 2; |
| [1218](#L1218) | $currency\_sign = $currency\_sign === true ? wpdmpp\_currency\_sign() : $currency\_sign; |
| [1219](#L1219) | $price = (double)$price; |
| [1220](#L1220) | $price = number\_format($price, $dp, $ds, $ts); |
| [1221](#L1221) | return (get\_wpdmpp\_option('currency\_position', 'before') === 'before') ? $currency\_sign . $price : $price . $currency\_sign; |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | function wpdmppdl\_encode($content) { |
| [1225](#L1225) | $content = json\_encode($content); |
| [1226](#L1226) | $content = base64\_encode($content); |
| [1227](#L1227) | $content = trim($content, '='); |
| [1228](#L1228) | return $content; |
| [1229](#L1229) | } |
| [1230](#L1230) | function wpdmppdl\_decode($cyper) { |
| [1231](#L1231) | $jsonstr = base64\_decode($cyper); |
| [1232](#L1232) | $json = json\_decode($jsonstr, true); |
| [1233](#L1233) | return $json; |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | /\*\* |
| [1237](#L1237) | \* @usage Generate ordinal number |
| [1238](#L1238) | \* @param $number |
| [1239](#L1239) | \* @return string |
| [1240](#L1240) | \*/ |
| [1241](#L1241) | function wpdmpp\_ordinal($number) |
| [1242](#L1242) | { |
| [1243](#L1243) | $ends = array('th', 'st', 'nd', 'rd', 'th', 'th', 'th', 'th', 'th', 'th'); |
| [1244](#L1244) | if ((($number % 100) >= 11) && (($number % 100) <= 13)) |
| [1245](#L1245) | return $number . 'th'; |
| [1246](#L1246) | else |
| [1247](#L1247) | return $number . $ends[$number % 10]; |
| [1248](#L1248) | } |
| [1249](#L1249) |  |
| [1250](#L1250) | function wpdmpp\_forex\_rate($from, $to) |
| [1251](#L1251) | { |
| [1252](#L1252) | $rate = get\_option("wppm\_fx\_rate\_{$from}\_{$to}"); |
| [1253](#L1253) | if(is\_array($rate) && isset($rate['expire']) && $rate['expire'] > time()) |
| [1254](#L1254) | return $rate['rate']; |
| [1255](#L1255) |  |
| [1256](#L1256) | $curl = curl\_init(); |
| [1257](#L1257) |  |
| [1258](#L1258) | curl\_setopt\_array($curl, [ |
| [1259](#L1259) | CURLOPT\_URL => "https://v6.exchangerate-api.com/v6/e8767d62e2b5de59e1b9093c/pair/{$from}/{$to}", |
| [1260](#L1260) | CURLOPT\_RETURNTRANSFER => true, |
| [1261](#L1261) | CURLOPT\_FOLLOWLOCATION => true, |
| [1262](#L1262) | CURLOPT\_ENCODING => "", |
| [1263](#L1263) | CURLOPT\_MAXREDIRS => 10, |
| [1264](#L1264) | CURLOPT\_TIMEOUT => 30, |
| [1265](#L1265) | CURLOPT\_HTTP\_VERSION => CURL\_HTTP\_VERSION\_1\_1, |
| [1266](#L1266) | CURLOPT\_CUSTOMREQUEST => "GET" |
| [1267](#L1267) | ]); |
| [1268](#L1268) |  |
| [1269](#L1269) | $response = curl\_exec($curl); |
| [1270](#L1270) | $err = curl\_error($curl); |
| [1271](#L1271) |  |
| [1272](#L1272) | curl\_close($curl); |
| [1273](#L1273) | $response = json\_decode($response); |
| [1274](#L1274) | update\_option("wppm\_fx\_rate\_{$from}\_{$to}",  ['rate' => $response->conversion\_rate, 'expire' => time() + 28800]); |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) |  |
| [1278](#L1278) |  |
| [1279](#L1279) | function wpdmpp\_search\_products($keyword = '') |
| [1280](#L1280) | { |
| [1281](#L1281) | $keyword = wpdm\_query\_var('search') ? : $keyword; |
| [1282](#L1282) | if($keyword) { |
| [1283](#L1283) | $query = new Query(); |
| [1284](#L1284) | $query->search($keyword); |
| [1285](#L1285) | $query->meta('\_\_wpdm\_base\_price', 0, '>'); |
| [1286](#L1286) | $query->meta\_relation('AND'); |
| [1287](#L1287) | $query->process(); |
| [1288](#L1288) | $packages = $query->packages(); |
| [1289](#L1289) | foreach ($packages as &$package) { |
| [1290](#L1290) | $package->license = wpdmpp\_product\_license\_options($package->ID); |
| [1291](#L1291) | } |
| [1292](#L1292) | wp\_send\_json(['total' => $query->count, 'packages' => $query->packages(), 'q' => $query->params]); |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) |  |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php?format=txt)
* [Original Format](/export/3222484/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_eba44722_20250114_215748.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwpdm-premium-packages%2Ftags%2F5.9.3%2Fincludes%2Flibs%2Ffunctions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?rev=3097018 "Revision 3097018")
* [Next Revision](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?rev=3195568 "Revision 3195568") →
* [Blame](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php)

---

# [source:](/browser?order=name "Go to repository root") [wpdm-premium-packages](/browser/wpdm-premium-packages?order=name "View wpdm-premium-packages")/[tags](/browser/wpdm-premium-packages/tags?order=name "View tags")/[5.9.3](/browser/wpdm-premium-packages/tags/5.9.3?order=name "View 5.9.3")/[includes](/browser/wpdm-premium-packages/tags/5.9.3/includes?order=name "View includes")/[libs](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs?order=name "View libs")/[functions.php](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php?order=name "View functions.php")

View diff against:

View revision:

| [Last change](/changeset/3134341/wpdm-premium-packages/trunk/includes/libs/functions.php "View differences") on this file was [3134341](/changeset/3134341/ "View changeset 3134341"), checked in by codename065, [5 months ago](/timeline?from=2024-08-12T15%3A38%3A35Z&precision=second "See timeline at 08/12/2024 03:38:35 PM") |
| --- |
| 5.9.0 - 2024.08.12  * Fixed an issue with the currency sign with the completed orders |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 57.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | // Exit if accessed directly |
| [3](#L3) | use WPDM\\_\_\Messages; |
| [4](#L4) | use WPDM\\_\_\Query; |
| [5](#L5) | use WPDM\\_\_\Session; |
| [6](#L6) | use WPDMPP\WPDMPremiumPackage; |
| [7](#L7) |  |
| [8](#L8) | if (!defined('ABSPATH')) { |
| [9](#L9) | exit; |
| [10](#L10) | } |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* @return WPDMPremiumPackage |
| [14](#L14) | \*/ |
| [15](#L15) | function WPDMPP() |
| [16](#L16) | { |
| [17](#L17) | global $wpdmpp; |
| [18](#L18) | return $wpdmpp; |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) | //number of total sales |
| [22](#L22) | function wpdmpp\_total\_purchase($pid = '') |
| [23](#L23) | { |
| [24](#L24) | global $wpdb; |
| [25](#L25) | if (!$pid) $pid = get\_the\_ID(); |
| [26](#L26) | $sales = $wpdb->get\_var("select count(\*) from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id and oi.pid='$pid' and  ( o.payment\_status='Completed' or o.payment\_status='Expired' )"); |
| [27](#L27) |  |
| [28](#L28) | return $sales; |
| [29](#L29) | } |
| [30](#L30) |  |
| [31](#L31) |  |
| [32](#L32) | //number of total sales |
| [33](#L33) | function wpdmpp\_total\_sales($uid = '', $pid = '', $sdate = '', $edate = '') |
| [34](#L34) | { |
| [35](#L35) | global $wpdb; |
| [36](#L36) |  |
| [37](#L37) | $pid\_cond = ($pid > 0) ? "and oi.pid='$pid'" : ""; |
| [38](#L38) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [39](#L39) |  |
| [40](#L40) | $sdate = $sdate == '' ? wp\_date("Y-m-01") : $sdate; |
| [41](#L41) | $edate = $edate == '' ? wp\_date("Y-m-d", strtotime("last day of this month")) : $edate; |
| [42](#L42) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : "and o.date >= '" . strtotime(wp\_date("Y-m-01")) . "'"; |
| [43](#L43) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : "and o.date <= '" . strtotime(wp\_date("Y-m-d", strtotime("last day of this month"))) . "'"; |
| [44](#L44) |  |
| [45](#L45) | if ($pid\_cond != '' || $uid\_cond != '') |
| [46](#L46) | $sales = $wpdb->get\_var("select sum(oi.price \* oi.quantity) from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id {$pid\_cond} {$uid\_cond} {$sdate\_cond} {$edate\_cond} and ( o.payment\_status='Completed' or o.payment\_status='Expired' )"); |
| [47](#L47) | else |
| [48](#L48) | $sales = $wpdb->get\_var("select sum(o.total) from {$wpdb->prefix}ahm\_orders o where  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) {$sdate\_cond} {$edate\_cond}"); |
| [49](#L49) |  |
| [50](#L50) | return number\_format($sales, 2, '.', ''); |
| [51](#L51) | } |
| [52](#L52) |  |
| [53](#L53) |  |
| [54](#L54) | function wpdmpp\_daily\_sales($uid = '', $pid = '', $sdate = '', $edate = '') |
| [55](#L55) | { |
| [56](#L56) | global $wpdb; |
| [57](#L57) |  |
| [58](#L58) | $pid\_cond = ($pid > 0) ? "and oi.pid='$pid'" : ""; |
| [59](#L59) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [60](#L60) | $sdate = $sdate == '' ? wp\_date("Y-m-01") : $sdate; |
| [61](#L61) | $edate = $edate == '' ? wp\_date("Y-m-d", strtotime("last day of this month")) : $edate; |
| [62](#L62) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : "and o.date >= '" . strtotime(wp\_date("Y-m-01")) . "'"; |
| [63](#L63) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : "and o.date <= '" . strtotime(wp\_date("Y-m-d", strtotime("last day of this month"))) . "'"; |
| [64](#L64) |  |
| [65](#L65) | $sales = $wpdb->get\_results("select sum(oi.price \* oi.quantity) as daily\_sale,  sum(oi.quantity) as quantities, oi.date, oi.year, oi.month, oi.day from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id {$pid\_cond} {$uid\_cond} {$sdate\_cond} {$edate\_cond} and  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) group by oi.date"); |
| [66](#L66) |  |
| [67](#L67) | $diff = date\_diff(date\_create($edate), date\_create($sdate))->days; |
| [68](#L68) | $sdata = array(); |
| [69](#L69) | $i = 0; |
| [70](#L70) | do { |
| [71](#L71) | $i++; |
| [72](#L72) | $sdata['sales'][$sdate] = 0; |
| [73](#L73) | $sdata['quantities'][$sdate] = 0; |
| [74](#L74) | $sdate = wp\_date('Y-m-d', strtotime('+1 day', strtotime($sdate))); |
| [75](#L75) | } while ($i <= $diff); |
| [76](#L76) |  |
| [77](#L77) | foreach ($sales as $sale) { |
| [78](#L78) | $sdata['sales'][$sale->date] = $sale->daily\_sale; |
| [79](#L79) | $sdata['quantities'][$sale->date] = $sale->quantities; |
| [80](#L80) | } |
| [81](#L81) |  |
| [82](#L82) | return $sdata; |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | function wpdmpp\_top\_sellings\_products($uid = '', $sdate = '', $edate = '', $s = 0, $e = 1000) |
| [86](#L86) | { |
| [87](#L87) | global $wpdb; |
| [88](#L88) |  |
| [89](#L89) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [90](#L90) | //$sdate = $sdate == ''?date("Y-m-01"):$sdate; |
| [91](#L91) | //$edate = $edate == ''?date("Y-m-31"):$edate; |
| [92](#L92) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : ""; |
| [93](#L93) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : ""; |
| [94](#L94) |  |
| [95](#L95) | $tsp = $wpdb->get\_results("select oi.pid, sum(oi.price) as sales,  sum(oi.quantity) as quantities, oi.date, oi.year, oi.month, oi.day from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id  {$uid\_cond} {$sdate\_cond} {$edate\_cond} and  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) group by oi.pid ORDER BY quantities DESC limit $s, $e"); |
| [96](#L96) | return $tsp; |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | function wpdmpp\_recent\_sales($uid = '', $count = 10) |
| [100](#L100) | { |
| [101](#L101) | global $wpdb; |
| [102](#L102) |  |
| [103](#L103) | $uid\_cond = ($uid > 0) ? "and {$wpdb->prefix}ahm\_order\_items.sid='$uid'" : ""; |
| [104](#L104) | $tsp = $wpdb->get\_results("select {$wpdb->prefix}ahm\_order\_items.pid as product\_id,{$wpdb->prefix}ahm\_order\_items.price, ({$wpdb->prefix}ahm\_order\_items.price \* {$wpdb->prefix}ahm\_order\_items.quantity) as total, {$wpdb->prefix}ahm\_orders.date as time\_stamp,  {$wpdb->prefix}ahm\_order\_items.date, {$wpdb->prefix}ahm\_order\_items.year, {$wpdb->prefix}ahm\_order\_items.month, {$wpdb->prefix}ahm\_order\_items.day from {$wpdb->prefix}ahm\_order\_items LEFT JOIN {$wpdb->prefix}ahm\_orders on {$wpdb->prefix}ahm\_order\_items.oid={$wpdb->prefix}ahm\_orders.order\_id  {$uid\_cond} and  ( {$wpdb->prefix}ahm\_orders.payment\_status='Completed' or {$wpdb->prefix}ahm\_orders.payment\_status='Expired' ) ORDER BY {$wpdb->prefix}ahm\_orders.date DESC limit 0, $count"); |
| [105](#L105) | foreach ($tsp as &$\_tsp) { |
| [106](#L106) | $\_tsp->post\_title = get\_the\_title($\_tsp->product\_id); |
| [107](#L107) | } |
| [108](#L108) | return $tsp; |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | function wpdmpp\_get\_licenses() |
| [112](#L112) | { |
| [113](#L113) | $pre\_licenses = get\_wpdmpp\_option('licenses', array( |
| [114](#L114) | 'single' => array('name' => 'Standard', 'description' => '', 'use' => 1), |
| [115](#L115) | 'extended' => array('name' => 'Extended', 'description' => '', 'use' => 5), |
| [116](#L116) | 'unlimited' => array('name' => 'Unlimited', 'description' => '', 'use' => 99), |
| [117](#L117) | )); |
| [118](#L118) | $pre\_licenses = maybe\_unserialize($pre\_licenses); |
| [119](#L119) | return $pre\_licenses; |
| [120](#L120) |  |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | function get\_wpdmpp\_option($name, $default = '', $validate = null) |
| [124](#L124) | { |
| [125](#L125) | global $wpdmpp\_settings; |
| [126](#L126) |  |
| [127](#L127) | $name = explode('/', $name); |
| [128](#L128) |  |
| [129](#L129) | if (!is\_array($wpdmpp\_settings)) return $default; |
| [130](#L130) |  |
| [131](#L131) | if (count($name) == 1) |
| [132](#L132) | $value = isset($wpdmpp\_settings[$name[0]]) ? $wpdmpp\_settings[$name[0]] : $default; |
| [133](#L133) | else if (count($name) == 2) |
| [134](#L134) | $value = isset($wpdmpp\_settings[$name[0]], $wpdmpp\_settings[$name[0]][$name[1]]) ? $wpdmpp\_settings[$name[0]][$name[1]] : $default; |
| [135](#L135) | else if (count($name) == 3) |
| [136](#L136) | $value = isset($wpdmpp\_settings[$name[0]], $wpdmpp\_settings[$name[0]][$name[1]], $wpdmpp\_settings[$name[0]][$name[1]][$name[2]]) ? $wpdmpp\_settings[$name[0]][$name[1]][$name[2]] : $default; |
| [137](#L137) | else |
| [138](#L138) | $value = $default; |
| [139](#L139) | if($validate !== null) |
| [140](#L140) | $value = wpdm\_sanitize\_var($value, $validate); |
| [141](#L141) |  |
| [142](#L142) | return $value; |
| [143](#L143) | } |
| [144](#L144) |  |
| [145](#L145) | function wpdmpp\_countries() |
| [146](#L146) | { |
| [147](#L147) | return array('AF' => 'AFGHANISTAN', 'AL' => 'ALBANIA', 'DZ' => 'ALGERIA', 'AS' => 'AMERICAN SAMOA', 'AD' => 'ANDORRA', 'AO' => 'ANGOLA', 'AI' => 'ANGUILLA', 'AQ' => 'ANTARCTICA', 'AG' => 'ANTIGUA AND BARBUDA', 'AR' => 'ARGENTINA', 'AM' => 'ARMENIA', 'AW' => 'ARUBA', 'AU' => 'AUSTRALIA', 'AT' => 'AUSTRIA', 'AZ' => 'AZERBAIJAN', 'BS' => 'BAHAMAS', 'BH' => 'BAHRAIN', 'BD' => 'BANGLADESH', 'BB' => 'BARBADOS', 'BY' => 'BELARUS', 'BE' => 'BELGIUM', 'BZ' => 'BELIZE', 'BJ' => 'BENIN', 'BM' => 'BERMUDA', 'BT' => 'BHUTAN', 'BO' => 'BOLIVIA', 'BA' => 'BOSNIA AND HERZEGOVINA', 'BW' => 'BOTSWANA', 'BV' => 'BOUVET ISLAND', 'BR' => 'BRAZIL', 'IO' => 'BRITISH INDIAN OCEAN TERRITORY', 'BN' => 'BRUNEI DARUSSALAM', 'BG' => 'BULGARIA', 'BF' => 'BURKINA FASO', 'BI' => 'BURUNDI', 'KH' => 'CAMBODIA', 'CM' => 'CAMEROON', 'CA' => 'CANADA', 'CV' => 'CAPE VERDE', 'KY' => 'CAYMAN ISLANDS', 'CF' => 'CENTRAL AFRICAN REPUBLIC', 'TD' => 'CHAD', 'CL' => 'CHILE', 'CN' => 'CHINA', 'CX' => 'CHRISTMAS ISLAND', 'CC' => 'COCOS (KEELING) ISLANDS', 'CO' => 'COLOMBIA', 'KM' => 'COMOROS', 'CG' => 'CONGO', 'CD' => 'CONGO, THE DEMOCRATIC REPUBLIC OF THE', 'CK' => 'COOK ISLANDS', 'CR' => 'COSTA RICA', 'CI' => 'COTE DIVOIRE', 'HR' => 'CROATIA', 'CU' => 'CUBA', 'CY' => 'CYPRUS', 'CZ' => 'CZECH REPUBLIC', 'DK' => 'DENMARK', 'DJ' => 'DJIBOUTI', 'DM' => 'DOMINICA', 'DO' => 'DOMINICAN REPUBLIC', 'EC' => 'ECUADOR', 'EG' => 'EGYPT', 'SV' => 'EL SALVADOR', 'GQ' => 'EQUATORIAL GUINEA', 'ER' => 'ERITREA', 'EE' => 'ESTONIA', 'ET' => 'ETHIOPIA', 'FK' => 'FALKLAND ISLANDS (MALVINAS)', 'FO' => 'FAROE ISLANDS', 'FJ' => 'FIJI', 'FI' => 'FINLAND', 'FR' => 'FRANCE', 'GF' => 'FRENCH GUIANA', 'PF' => 'FRENCH POLYNESIA', 'TF' => 'FRENCH SOUTHERN TERRITORIES', 'GA' => 'GABON', 'GM' => 'GAMBIA', 'GE' => 'GEORGIA', 'DE' => 'GERMANY', 'GH' => 'GHANA', 'GI' => 'GIBRALTAR', 'GR' => 'GREECE', 'GL' => 'GREENLAND', 'GD' => 'GRENADA', 'GP' => 'GUADELOUPE', 'GU' => 'GUAM', 'GT' => 'GUATEMALA', 'GN' => 'GUINEA', 'GW' => 'GUINEA-BISSAU', 'GY' => 'GUYANA', 'HT' => 'HAITI', 'HM' => 'HEARD ISLAND AND MCDONALD ISLANDS', 'VA' => 'HOLY SEE (VATICAN CITY STATE)', 'HN' => 'HONDURAS', 'HK' => 'HONG KONG', 'HU' => 'HUNGARY', 'IS' => 'ICELAND', 'IN' => 'INDIA', 'ID' => 'INDONESIA', 'IR' => 'IRAN, ISLAMIC REPUBLIC OF', 'IQ' => 'IRAQ', 'IE' => 'IRELAND', 'IL' => 'ISRAEL', 'IT' => 'ITALY', 'JM' => 'JAMAICA', 'JP' => 'JAPAN', 'JO' => 'JORDAN', 'KZ' => 'KAZAKHSTAN', 'KE' => 'KENYA', 'KI' => 'KIRIBATI', 'KP' => 'KOREA, DEMOCRATIC PEOPLE\'S REPUBLIC OF', 'KR' => 'KOREA, REPUBLIC OF', 'KW' => 'KUWAIT', 'KG' => 'KYRGYZSTAN', 'LA' => 'LAO PEOPLE\'S DEMOCRATIC REPUBLIC', 'LV' => 'LATVIA', 'LB' => 'LEBANON', 'LS' => 'LESOTHO', 'LR' => 'LIBERIA', 'LY' => 'LIBYAN ARAB JAMAHIRIYA', 'LI' => 'LIECHTENSTEIN', 'LT' => 'LITHUANIA', 'LU' => 'LUXEMBOURG', 'MO' => 'MACAO', 'MK' => 'MACEDONIA, THE FORMER YUGOSLAV REPUBLIC OF', 'MG' => 'MADAGASCAR', 'MW' => 'MALAWI', 'MY' => 'MALAYSIA', 'MV' => 'MALDIVES', 'ML' => 'MALI', 'MT' => 'MALTA', 'MH' => 'MARSHALL ISLANDS', 'MQ' => 'MARTINIQUE', 'MR' => 'MAURITANIA', 'MU' => 'MAURITIUS', 'YT' => 'MAYOTTE', 'MX' => 'MEXICO', 'FM' => 'MICRONESIA, FEDERATED STATES OF', 'MD' => 'MOLDOVA, REPUBLIC OF', 'MC' => 'MONACO', 'MN' => 'MONGOLIA', 'MS' => 'MONTSERRAT', 'MA' => 'MOROCCO', 'MZ' => 'MOZAMBIQUE', 'MM' => 'MYANMAR', 'NA' => 'NAMIBIA', 'NR' => 'NAURU', 'NP' => 'NEPAL', 'NL' => 'NETHERLANDS', 'AN' => 'NETHERLANDS ANTILLES', 'NC' => 'NEW CALEDONIA', 'NZ' => 'NEW ZEALAND', 'NI' => 'NICARAGUA', 'NE' => 'NIGER', 'NG' => 'NIGERIA', 'NU' => 'NIUE', 'NF' => 'NORFOLK ISLAND', 'MP' => 'NORTHERN MARIANA ISLANDS', 'NO' => 'NORWAY', 'OM' => 'OMAN', 'PK' => 'PAKISTAN', 'PW' => 'PALAU', 'PS' => 'PALESTINIAN TERRITORY, OCCUPIED', 'PA' => 'PANAMA', 'PG' => 'PAPUA NEW GUINEA', 'PY' => 'PARAGUAY', 'PE' => 'PERU', 'PH' => 'PHILIPPINES', 'PN' => 'PITCAIRN', 'PL' => 'POLAND', 'PT' => 'PORTUGAL', 'PR' => 'PUERTO RICO', 'QA' => 'QATAR', 'RE' => 'REUNION', 'RO' => 'ROMANIA', 'RU' => 'RUSSIAN FEDERATION', 'RW' => 'RWANDA', 'SH' => 'SAINT HELENA', 'KN' => 'SAINT KITTS AND NEVIS', 'LC' => 'SAINT LUCIA', 'PM' => 'SAINT PIERRE AND MIQUELON', 'VC' => 'SAINT VINCENT AND THE GRENADINES', 'WS' => 'SAMOA', 'SM' => 'SAN MARINO', 'ST' => 'SAO TOME AND PRINCIPE', 'SA' => 'SAUDI ARABIA', 'SN' => 'SENEGAL', 'CS' => 'SERBIA AND MONTENEGRO', 'SC' => 'SEYCHELLES', 'SL' => 'SIERRA LEONE', 'SG' => 'SINGAPORE', 'SK' => 'SLOVAKIA', 'SI' => 'SLOVENIA', 'SB' => 'SOLOMON ISLANDS', 'SO' => 'SOMALIA', 'ZA' => 'SOUTH AFRICA', 'GS' => 'SOUTH GEORGIA AND THE SOUTH SANDWICH ISLANDS', 'ES' => 'SPAIN', 'LK' => 'SRI LANKA', 'SD' => 'SUDAN', 'SR' => 'SURINAME', 'SJ' => 'SVALBARD AND JAN MAYEN', 'SZ' => 'SWAZILAND', 'SE' => 'SWEDEN', 'CH' => 'SWITZERLAND', 'SY' => 'SYRIAN ARAB REPUBLIC', 'TW' => 'TAIWAN, PROVINCE OF CHINA', 'TJ' => 'TAJIKISTAN', 'TZ' => 'TANZANIA, UNITED REPUBLIC OF', 'TH' => 'THAILAND', 'TL' => 'TIMOR-LESTE', 'TG' => 'TOGO', 'TK' => 'TOKELAU', 'TO' => 'TONGA', 'TT' => 'TRINIDAD AND TOBAGO', 'TN' => 'TUNISIA', 'TR' => 'TURKEY', 'TM' => 'TURKMENISTAN', 'TC' => 'TURKS AND CAICOS ISLANDS', 'TV' => 'TUVALU', 'UG' => 'UGANDA', 'UA' => 'UKRAINE', 'AE' => 'UNITED ARAB EMIRATES', 'GB' => 'UNITED KINGDOM', 'US' => 'UNITED STATES', 'UM' => 'UNITED STATES MINOR OUTLYING ISLANDS', 'UY' => 'URUGUAY', 'UZ' => 'UZBEKISTAN', 'VU' => 'VANUATU', 'VE' => 'VENEZUELA', 'VN' => 'VIET NAM', 'VG' => 'VIRGIN ISLANDS, BRITISH', 'VI' => 'VIRGIN ISLANDS, U.S.', 'WF' => 'WALLIS AND FUTUNA', 'EH' => 'WESTERN SAHARA', 'YE' => 'YEMEN', 'ZM' => 'ZAMBIA', 'ZW' => 'ZIMBABWE'); |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | function wpdmpp\_tax\_active() |
| [151](#L151) | { |
| [152](#L152) | global $wpdmpp\_settings; |
| [153](#L153) | return isset($wpdmpp\_settings['tax']) && isset($wpdmpp\_settings['tax']['enable']) ? true : false; |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | function wpdmpp\_show\_tax() |
| [157](#L157) | { |
| [158](#L158) | global $wpdmpp\_settings; |
| [159](#L159) | return isset($wpdmpp\_settings['tax']) && isset($wpdmpp\_settings['tax']['tax\_on\_cart']) ? true : false; |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) |  |
| [163](#L163) | //Send notification before delete product |
| [164](#L164) | add\_action('wp\_trash\_post', 'wpdmpp\_notify\_product\_rejected'); |
| [165](#L165) | function wpdmpp\_notify\_product\_rejected($post\_id) |
| [166](#L166) | { |
| [167](#L167) | global $post\_type; |
| [168](#L168) | if ($post\_type != 'wpdmpro') return; |
| [169](#L169) |  |
| [170](#L170) | $post = get\_post($post\_id); |
| [171](#L171) | $post\_meta = get\_post\_meta($post\_id, "\_z\_user\_review", true); |
| [172](#L172) |  |
| [173](#L173) | if ($post\_meta != ""): |
| [174](#L174) | $author = get\_userdata($post->post\_author); |
| [175](#L175) | $author\_email = $author->user\_email; |
| [176](#L176) | $email\_subject = "Your product has been rejected."; |
| [177](#L177) |  |
| [178](#L178) | ob\_start(); ?> |
| [179](#L179) | <html> |
| [180](#L180) | <head> |
| [181](#L181) | <title>New post at <?php bloginfo('name') ?></title> |
| [182](#L182) | </head> |
| [183](#L183) | <body> |
| [184](#L184) | <p> |
| [185](#L185) | Hi <?php echo $author->user\_firstname ?>, |
| [186](#L186) | </p> |
| [187](#L187) |  |
| [188](#L188) | <p> |
| [189](#L189) | Your product <?php the\_title() ?> has not been approved by team. |
| [190](#L190) | </p> |
| [191](#L191) | </body> |
| [192](#L192) | </html> |
| [193](#L193) | <?php |
| [194](#L194) | $message = ob\_get\_contents(); |
| [195](#L195) | ob\_end\_clean(); |
| [196](#L196) |  |
| [197](#L197) | wp\_mail($author\_email, $email\_subject, $message); |
| [198](#L198) | endif; |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | // Product accept notification email |
| [202](#L202) | function wpdmpp\_notify\_product\_accepted($post\_id) |
| [203](#L203) | { |
| [204](#L204) | global $post\_type; |
| [205](#L205) | if ($post\_type != 'wpdmpro') return; |
| [206](#L206) |  |
| [207](#L207) | if (($\_POST['post\_status'] == 'publish') && ($\_POST['original\_post\_status'] != 'publish')) { |
| [208](#L208) | $post = get\_post($post\_id); |
| [209](#L209) | $post\_meta = get\_post\_meta($post\_id, "\_z\_user\_review", TRUE); |
| [210](#L210) | if ($post\_meta != ""): |
| [211](#L211) |  |
| [212](#L212) | $author = get\_userdata($post->post\_author); |
| [213](#L213) | $author\_email = $author->user\_email; |
| [214](#L214) | $email\_subject = "Your post has been published."; |
| [215](#L215) |  |
| [216](#L216) | ob\_start(); ?> |
| [217](#L217) | <html> |
| [218](#L218) | <head> |
| [219](#L219) | <title>Your Product Status at <?php bloginfo('name') ?></title> |
| [220](#L220) | </head> |
| [221](#L221) | <body> |
| [222](#L222) | <p>Hi <?php echo $author->user\_firstname ?>,</p> |
| [223](#L223) | <p>Your product <a href="<?php echo get\_permalink($post->ID) ?>"><?php the\_title\_attribute() ?></a> has been |
| [224](#L224) | published.</p> |
| [225](#L225) | </body> |
| [226](#L226) | </html> |
| [227](#L227) | <?php |
| [228](#L228) | $message = ob\_get\_clean(); |
| [229](#L229) |  |
| [230](#L230) | wp\_mail($author\_email, $email\_subject, $message); |
| [231](#L231) | endif; |
| [232](#L232) | } |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Calculate pending balance and matured balance of the seller |
| [238](#L238) | \* |
| [239](#L239) | \* @return array $seller\_balances Array of balances. Access using `pending` and `matured` |
| [240](#L240) | \* @since 3.8.9 |
| [241](#L241) | \*/ |
| [242](#L242) | function wpdmpp\_seller\_balances() |
| [243](#L243) | { |
| [244](#L244) | global $wpdb, $current\_user; |
| [245](#L245) | $current\_user = wp\_get\_current\_user(); |
| [246](#L246) | $uid = $current\_user->ID; |
| [247](#L247) | $sql = "select sum(i.price\*i.quantity) from {$wpdb->prefix}ahm\_orders o, |
| [248](#L248) | {$wpdb->prefix}ahm\_order\_items i, |
| [249](#L249) | {$wpdb->prefix}posts p |
| [250](#L250) | where p.post\_author=$uid and |
| [251](#L251) | i.oid=o.order\_id and |
| [252](#L252) | i.pid=p.ID and |
| [253](#L253) | i.quantity > 0 and |
| [254](#L254) | o.payment\_status='Completed'"; |
| [255](#L255) |  |
| [256](#L256) | $total\_sales = $wpdb->get\_var($sql); |
| [257](#L257) | $commission = wpdmpp\_site\_commission(); |
| [258](#L258) | $total\_commission = $total\_sales \* $commission / 100; |
| [259](#L259) | $total\_earning = $total\_sales - $total\_commission; |
| [260](#L260) | $sql = "select sum(amount) from {$wpdb->prefix}ahm\_withdraws where uid=$uid"; |
| [261](#L261) | $total\_withdraws = $wpdb->get\_var($sql); |
| [262](#L262) | $balance = $total\_earning - $total\_withdraws; |
| [263](#L263) |  |
| [264](#L264) | //finding matured balance |
| [265](#L265) | $payout\_duration = get\_option("wpdmpp\_payout\_duration"); |
| [266](#L266) | $dt = $payout\_duration \* 24 \* 60 \* 60; |
| [267](#L267) | $sqlm = "select sum(i.price\*i.quantity) from {$wpdb->prefix}ahm\_orders o, |
| [268](#L268) | {$wpdb->prefix}ahm\_order\_items i, |
| [269](#L269) | {$wpdb->prefix}posts p |
| [270](#L270) | where p.post\_author=$uid and |
| [271](#L271) | i.oid=o.order\_id and |
| [272](#L272) | i.pid=p.ID and |
| [273](#L273) | i.quantity > 0 and |
| [274](#L274) | o.payment\_status='Completed' |
| [275](#L275) | and (o.date+($dt))<" . time() . ""; |
| [276](#L276) |  |
| [277](#L277) | $tempbalance = $wpdb->get\_var($sqlm); |
| [278](#L278) | $tempbalance = $tempbalance - ($tempbalance \* $commission / 100); |
| [279](#L279) | $matured\_balance = $tempbalance - $total\_withdraws; |
| [280](#L280) |  |
| [281](#L281) | //finding pending balance |
| [282](#L282) | $pending\_balance = $balance - $matured\_balance; |
| [283](#L283) |  |
| [284](#L284) | $seller\_balances = array(); |
| [285](#L285) | $seller\_balances['pending'] = $pending\_balance; |
| [286](#L286) | $seller\_balances['matured'] = $matured\_balance; |
| [287](#L287) |  |
| [288](#L288) | return $seller\_balances; |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | //for withdraw request |
| [292](#L292) | function wpdmpp\_withdraw\_request() |
| [293](#L293) | { |
| [294](#L294) | global $wpdb, $current\_user; |
| [295](#L295) |  |
| [296](#L296) | $current\_user = wp\_get\_current\_user(); |
| [297](#L297) |  |
| [298](#L298) | $uid = $current\_user->ID; |
| [299](#L299) |  |
| [300](#L300) | if (isset($\_POST['withdraw'], $\_POST['withdraw\_amount']) && $\_POST['withdraw'] == 1 && $\_POST['withdraw\_amount'] > 0) { |
| [301](#L301) |  |
| [302](#L302) | // Check if matured balance is greater than 0 |
| [303](#L303) | $seller\_balances = wpdmpp\_seller\_balances(); |
| [304](#L304) | if ($seller\_balances['matured'] <= 0) { |
| [305](#L305) | echo 'denied'; |
| [306](#L306) | die(); |
| [307](#L307) | } |
| [308](#L308) | $payout\_method = wpdm\_query\_var('payout\_method', 'txt'); |
| [309](#L309) | $payment\_account = wpdm\_valueof(WPDMPP()->withdraws->payoutAccounts($current\_user->ID), $payout\_method); |
| [310](#L310) | if(!$payment\_account || !$payout\_method) { |
| [311](#L311) | wp\_send\_json(['success' => false, 'msg' => \_\_("Withdrawal Request Failed. No payout option selected!", "wpdm-premium-packages")]); |
| [312](#L312) | } |
| [313](#L313) | $wpdb->insert( |
| [314](#L314) | "{$wpdb->prefix}ahm\_withdraws", |
| [315](#L315) | array( |
| [316](#L316) | 'uid' => $uid, |
| [317](#L317) | 'date' => time(), |
| [318](#L318) | 'amount' => absint($\_POST['withdraw\_amount']), |
| [319](#L319) | 'payment\_method' => $payout\_method, |
| [320](#L320) | 'payment\_account' => $payment\_account, |
| [321](#L321) | 'status' => 0 |
| [322](#L322) | ), |
| [323](#L323) | array( |
| [324](#L324) | '%d', |
| [325](#L325) | '%d', |
| [326](#L326) | '%f', |
| [327](#L327) | '%s', |
| [328](#L328) | '%s', |
| [329](#L329) | '%d' |
| [330](#L330) | ) |
| [331](#L331) | ); |
| [332](#L332) |  |
| [333](#L333) | if (wpdm\_is\_ajax()) { |
| [334](#L334) | wp\_send\_json(['success' => true, 'msg' => \_\_("Withdrawal Request Sent!", "wpdm-premium-packages")]); |
| [335](#L335) | } |
| [336](#L336) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [337](#L337) | header("Location: " . $return); |
| [338](#L338) | die(); |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | } |
| [342](#L342) |  |
| [343](#L343) | function wpdmpp\_redirect($url) |
| [344](#L344) | { |
| [345](#L345) | if (!headers\_sent()) |
| [346](#L346) | header("location: " . $url); |
| [347](#L347) | else |
| [348](#L348) | echo "<script>location.href='{$url}';</script>"; |
| [349](#L349) | die(); |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | function wpdmpp\_js\_redirect($url) |
| [353](#L353) | { |
| [354](#L354) | echo "&nbsp;Redirecting...<script>location.href='{$url}';</script>"; |
| [355](#L355) | die(); |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | function wpdmpp\_members\_page() |
| [359](#L359) | { |
| [360](#L360) | $settings = get\_option('\_wpdmpp\_settings'); |
| [361](#L361) | return isset($settings['members\_page\_id']) ? get\_permalink($settings['members\_page\_id']) : wpdm\_user\_dashboard\_url(array('udb\_page' => 'account-credits')); |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | function wpdmpp\_checkout\_return\_url($payment, $order\_id = '') { |
| [365](#L365) | $gop = wpdmpp\_guest\_order\_page(); |
| [366](#L366) | $opu = !is\_user\_logged\_in() && get\_wpdmpp\_option('guest\_download') == 1 && $gop != '' ? $gop : wpdmpp\_orders\_page($order\_id); |
| [367](#L367) | $url = get\_wpdmpp\_option("{$payment}/return\_url", $opu); |
| [368](#L368) | $url = str\_replace("{{download\_page}}", "", $url); |
| [369](#L369) | return $url; |
| [370](#L370) | } |
| [371](#L371) |  |
| [372](#L372) | function wpdmpp\_orders\_page($part = '') |
| [373](#L373) | { |
| [374](#L374) | global $wpdmpp\_settings; |
| [375](#L375) | $settings = $wpdmpp\_settings; |
| [376](#L376) |  |
| [377](#L377) | $url = get\_permalink($settings['orders\_page\_id']); |
| [378](#L378) | if ($part != '') { |
| [379](#L379) | if (strpos($url, '?')) $url .= "&" . $part; |
| [380](#L380) | else $url .= "?" . $part; |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) | $udbpage = get\_option('\_\_wpdm\_user\_dashboard', 0); |
| [384](#L384) | if ((int)$udbpage > 0 && (int)$settings['orders\_page\_id'] === (int)$udbpage) { |
| [385](#L385) |  |
| [386](#L386) | $udbpage = get\_permalink($udbpage); |
| [387](#L387) | $sap = strstr($udbpage, '?') ? "&udb\_page=" : "?udb\_page="; |
| [388](#L388) | $url = $udbpage . $sap . "purchases/orders/"; |
| [389](#L389) | if ($part != '') { |
| [390](#L390) | $part = explode("=", $part); |
| [391](#L391) | $url = $udbpage . $sap . "purchases/order/" . end($part) . "/"; |
| [392](#L392) | } |
| [393](#L393) | } |
| [394](#L394) | return $url; |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | function wpdmpp\_guest\_order\_page($part = '') |
| [398](#L398) | { |
| [399](#L399) | $settings = get\_option('\_wpdmpp\_settings'); |
| [400](#L400) | $url = get\_permalink($settings['guest\_order\_page\_id']); |
| [401](#L401) | if (!isset($settings['guest\_download']) || $settings['guest\_download'] == 0) return ''; |
| [402](#L402) | if ($part != '') { |
| [403](#L403) | if (strpos($url, '?')) $url .= "&" . $part; |
| [404](#L404) | else $url .= "?" . $part; |
| [405](#L405) | } |
| [406](#L406) | return $url; |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) | /\*\* |
| [410](#L410) | \* Returns cart page url |
| [411](#L411) | \* @param array $params |
| [412](#L412) | \* @return false|string |
| [413](#L413) | \*/ |
| [414](#L414) | function wpdmpp\_cart\_page($params = array()) |
| [415](#L415) | { |
| [416](#L416) | global $wpdmpp\_settings; |
| [417](#L417) | if (!$wpdmpp\_settings) |
| [418](#L418) | $wpdmpp\_settings = get\_option('\_wpdmpp\_settings'); |
| [419](#L419) |  |
| [420](#L420) | $url = get\_permalink($wpdmpp\_settings['page\_id']); |
| [421](#L421) |  |
| [422](#L422) | $url = add\_query\_arg($params, $url); |
| [423](#L423) |  |
| [424](#L424) | return $url; |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | function wpdmpp\_cart\_url($params = array()) |
| [428](#L428) | { |
| [429](#L429) | return wpdmpp\_cart\_page($params); |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | function wpdmpp\_checkout\_link($label = 'Checkout', $class = 'btn btn-info' ,$params = array()) |
| [433](#L433) | { |
| [434](#L434) | return "<a href='".wpdmpp\_cart\_page($params)."' class='{$class}'>{$label}</a>"; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | function wpdmpp\_is\_cart\_page($id = null) |
| [438](#L438) | { |
| [439](#L439) | $id = $id ?: get\_the\_ID(); |
| [440](#L440) | $cart\_page\_id = (int)get\_wpdmpp\_option('page\_id'); |
| [441](#L441) | return $cart\_page\_id === (int)$id ? $cart\_page\_id : false; |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) |  |
| [445](#L445) | function wpdmpp\_continue\_shopping\_url($args = []) |
| [446](#L446) | { |
| [447](#L447) | $settings = get\_option('\_wpdmpp\_settings'); |
| [448](#L448) | return add\_query\_arg($args, get\_wpdmpp\_option('continue\_shopping\_url', home\_url('/'))); |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) |  |
| [452](#L452) | function wpdmpp\_save\_billing\_info() |
| [453](#L453) | { |
| [454](#L454) | global $current\_user; |
| [455](#L455) | $current\_user = wp\_get\_current\_user(); |
| [456](#L456) | if (isset($\_POST['\_\_wpdm\_store\_owner'])) |
| [457](#L457) | $\_\_wpdm\_store\_owner = isset($\_POST['\_\_wpdm\_store\_owner']) ? 1 : 0; |
| [458](#L458) | update\_user\_meta($current\_user->ID, '\_\_wpdm\_store\_owner', $\_\_wpdm\_store\_owner); |
| [459](#L459) | if (isset($\_POST['\_\_wpdm\_store'])) { |
| [460](#L460) | $store\_data = wpdm\_sanitize\_array($\_POST['\_\_wpdm\_store']); |
| [461](#L461) | update\_user\_meta($current\_user->ID, '\_\_wpdm\_store', $store\_data); |
| [462](#L462) | } |
| [463](#L463) | if (isset($\_POST['checkout']) && isset($\_POST['checkout']['billing'])) { |
| [464](#L464) | $codata = wpdm\_sanitize\_array($\_POST['checkout']); |
| [465](#L465) | update\_user\_meta($current\_user->ID, 'user\_billing\_shipping', serialize($codata)); |
| [466](#L466) | } |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Get the list of purchased items of the current user |
| [471](#L471) | \*/ |
| [472](#L472) | function wpdmpp\_get\_purchased\_items() |
| [473](#L473) | { |
| [474](#L474) | if (!isset($\_GET['wpdmppaction']) || $\_GET['wpdmppaction'] != 'getpurchaseditems') return; |
| [475](#L475) | if (wpdm\_query\_var('user') != '') { |
| [476](#L476) | $user = wp\_signon(array('user\_login' => wpdm\_query\_var('user'), 'user\_password' => wpdm\_query\_var('pass'))); |
| [477](#L477) | if ($user->ID) wp\_set\_current\_user($user->ID); |
| [478](#L478) | } |
| [479](#L479) | if (wpdm\_query\_var('wpdm\_access\_token') != '') { |
| [480](#L480) | $at = wpdm\_query\_var('wpdm\_access\_token'); |
| [481](#L481) | if (!$at) die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [482](#L482) | $atx = explode("x", $at); |
| [483](#L483) | $uid = end($atx); |
| [484](#L484) | $uid = (int)$uid; |
| [485](#L485) | if (!$uid) die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [486](#L486) | $sat = get\_user\_meta($uid, '\_\_wpdm\_access\_token', true); |
| [487](#L487) | if ($sat === '') die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [488](#L488) | if ($sat === $at) |
| [489](#L489) | wp\_set\_current\_user($uid); |
| [490](#L490) | else |
| [491](#L491) | die(json\_encode(array('error' => "Invalid Access Token!"))); |
| [492](#L492) | } |
| [493](#L493) | if (is\_user\_logged\_in()) |
| [494](#L494) | wp\_send\_json(\WPDMPP\Libs\Order::getPurchasedItems()); |
| [495](#L495) | else |
| [496](#L496) | wp\_send\_json(array('error' => '<a href="https://www.wpdownloadmanager.com/user-dashboard/?redirect\_to=[redirect]">You need to login first!</a>')); |
| [497](#L497) | die(); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | /\*\* |
| [501](#L501) | \* Retrienve Site Commissions on User's Sales |
| [502](#L502) | \* @param null $uid |
| [503](#L503) | \* @return mixed |
| [504](#L504) | \*/ |
| [505](#L505) | function wpdmpp\_site\_commission($uid = null) |
| [506](#L506) | { |
| [507](#L507) | global $current\_user; |
| [508](#L508) | $current\_user = wp\_get\_current\_user(); |
| [509](#L509) | $user = $current\_user; |
| [510](#L510) | if ($uid) $user = get\_userdata($uid); |
| [511](#L511) | $role = array\_shift($user->roles); |
| [512](#L512) | $comission = get\_option("wpdmpp\_user\_comission"); |
| [513](#L513) | $comission = isset($comission[$role]) ? (double)$comission[$role] : 0; |
| [514](#L514) | return $comission; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | function wpdmpp\_get\_user\_earning() |
| [518](#L518) | { |
| [519](#L519) |  |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) |  |
| [523](#L523) | function wpdmpp\_product\_price($pid, $license = '') |
| [524](#L524) | { |
| [525](#L525) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [526](#L526) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [527](#L527) | $price = (double)($sales\_price) > 0 && $sales\_price < $base\_price ? (double)$sales\_price : (double)$base\_price; |
| [528](#L528) |  |
| [529](#L529) | if (floatval($price) == 0) return number\_format(0, 2, ".", ""); |
| [530](#L530) | return number\_format($price, 2, ".", ""); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | function wpdmpp\_is\_ajax() |
| [534](#L534) | { |
| [535](#L535) | if (!empty($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) && |
| [536](#L536) | strtolower($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) == 'xmlhttprequest' |
| [537](#L537) | ) return TRUE; |
| [538](#L538) | return false; |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) | //delete product from front-end |
| [542](#L542) | function wpdmpp\_delete\_product() |
| [543](#L543) | { |
| [544](#L544) | if (is\_user\_logged\_in() && isset($\_GET['dproduct'])) { |
| [545](#L545) | global $current\_user; |
| [546](#L546) | $current\_user = wp\_get\_current\_user(); |
| [547](#L547) | $pid = intval($\_GET['dproduct']); |
| [548](#L548) | $pro = get\_post($pid); |
| [549](#L549) |  |
| [550](#L550) | if ($current\_user->ID == $pro->post\_author) { |
| [551](#L551) | wp\_update\_post(array('ID' => $pid, 'post\_status' => 'trash')); |
| [552](#L552) | $settings = get\_option('\_wpdmpp\_settings'); |
| [553](#L553) | if ($settings['frontend\_product\_delete\_notify'] == 1) { |
| [554](#L554) | wp\_mail(get\_option('admin\_email'), "I had to delete a product", "Hi, Sorry, but I had to delete following product for some reason:<br/>{$pro->post\_title}", "From: {$current\_user->user\_email}\r\nContent-type: text/html\r\n\r\n"); |
| [555](#L555) | } |
| [556](#L556) | Session::set('dpmsg', \_\_('Product Deleted', 'wpdm-premium-packages')); |
| [557](#L557) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [558](#L558) | header("location: " . $return); |
| [559](#L559) | die(); |
| [560](#L560) | } |
| [561](#L561) | } |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | function wpdmpp\_order\_completed\_mail() |
| [565](#L565) | { |
| [566](#L566) |  |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | function wpdmpp\_head() |
| [570](#L570) | { |
| [571](#L571) | $wpdmpp\_txt = array( |
| [572](#L572) | 'cart\_button\_label' => get\_wpdmpp\_option('a2cbtn\_label', '<i class="fas fa-shopping-basket mr-2"></i>' . \_\_('Add To Cart', 'wpdm-premium-packages')), |
| [573](#L573) | 'pay\_now' => get\_wpdmpp\_option('cobtn\_label', \_\_('Complete Purchase', 'wpdm-premium-packages')), |
| [574](#L574) | 'checkout\_button\_label' => get\_wpdmpp\_option('cobtn\_label', \_\_('Complete Purchase', 'wpdm-premium-packages')), |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | ?> |
| [578](#L578) | <script> |
| [579](#L579) | var wpdmpp\_base\_url = '<?php echo plugins\_url('/wpdm-premium-packages/'); ?>'; |
| [580](#L580) | var wpdmpp\_currency\_sign = '<?php echo wpdmpp\_currency\_sign(); ?>'; |
| [581](#L581) | var wpdmpp\_csign\_before = '<?php echo wpdmpp\_currency\_sign\_position() == 'before' ? wpdmpp\_currency\_sign() : ''; ?>'; |
| [582](#L582) | var wpdmpp\_csign\_after = '<?php echo wpdmpp\_currency\_sign\_position() == 'after' ? wpdmpp\_currency\_sign() : ''; ?>'; |
| [583](#L583) | var wpdmpp\_currency\_code = '<?php echo wpdmpp\_currency\_code(); ?>'; |
| [584](#L584) | var wpdmpp\_cart\_url = '<?php echo wpdmpp\_cart\_page(); ?>'; |
| [585](#L585) |  |
| [586](#L586) | var wpdmpp\_txt = <?php echo json\_encode($wpdmpp\_txt); ?>; |
| [587](#L587) |  |
| [588](#L588) | </script> |
| [589](#L589) | <style>p.wpdmpp-notice { |
| [590](#L590) | margin: 5px; |
| [591](#L591) | } |
| [592](#L592) | .wpbtn-success { |
| [593](#L593) | color: var(--color-success) !important;border-color: var(--color-success ) !important; |
| [594](#L594) | background: rgba(var(--color-success-rgb),0.03) !important; |
| [595](#L595) | transition: all ease-in-out 300ms; |
| [596](#L596) | } |
| [597](#L597) | .wpbtn-success:active, |
| [598](#L598) | .wpbtn-success:hover { |
| [599](#L599) | color: var(--color-success-active) !important; |
| [600](#L600) | border-color: var(--color-success-active) !important; |
| [601](#L601) | background: rgba(var(--color-success-rgb),0.07) !important; |
| [602](#L602) | } |
| [603](#L603) | </style> |
| [604](#L604) | <?php |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | function wpdmpp\_admin\_footer() |
| [608](#L608) | { |
| [609](#L609) | global $pagenow; |
| [610](#L610) | if($pagenow !== 'edit.php' || wpdm\_query\_var('post\_type') !== 'wpdmpro') return; |
| [611](#L611) | ?> |
| [612](#L612) | <script> |
| [613](#L613) | jQuery(function ($) { |
| [614](#L614) | let $body = $('body'); |
| [615](#L615) |  |
| [616](#L616) | $('.page-title-action').after('<button data-toggle="modal" data-target="#modal-pay-link" type="button" class="page-title-action wpbtn-success wpbtn-pay-link"><?php echo \_\_('Create Pay Link', WPDM\_TEXT\_DOMAIN) ?></button>'); |
| [617](#L617) |  |
| [618](#L618) | $body.on('keyup', '.pla', function () { |
| [619](#L619) | let price = parseFloat($('#plprice').val()); |
| [620](#L620) | let title = $('#pltitle').val(); |
| [621](#L621) | let desc = $('#pldesc').val(); |
| [622](#L622) | let rec = $('#plrec').is(':checked') ? 1 : 0; |
| [623](#L623) | let plinnk = "<?= home\_url('/?addtocart=dynamic&price=') ?>" + price + '&name=' + title + '&desc=' + desc + '&recurring=0'; |
| [624](#L624) | $('#plink').val(plinnk); |
| [625](#L625) | }); |
| [626](#L626) |  |
| [627](#L627) | $body.on('submit', '#sendplink', function (e) { |
| [628](#L628) | e.preventDefault(); |
| [629](#L629) | let $plform = $(this); |
| [630](#L630) | WPDM.blockUI('#sendplink'); |
| [631](#L631) | $plform.ajaxSubmit({ |
| [632](#L632) | url: ajaxurl, |
| [633](#L633) | success: function ($) { |
| [634](#L634) | WPDM.notify('<?= \_\_('Payment link has been send successfully', WPDMPP\_TEXT\_DOMAIN) ?>', 'success', 'top-center', 6000); |
| [635](#L635) | WPDM.unblockUI('#sendplink'); |
| [636](#L636) | } |
| [637](#L637) | }); |
| [638](#L638) | }); |
| [639](#L639) |  |
| [640](#L640) |  |
| [641](#L641) | }); |
| [642](#L642) | </script> |
| [643](#L643) |  |
| [644](#L644) | <div class="w3eden"> |
| [645](#L645) | <div class="modal fade" tabindex="-1" role="dialog" id="modal-pay-link"> |
| [646](#L646) | <div class="modal-dialog" role="document" style="width: 400px"> |
| [647](#L647) | <form method="post" id="sendplink"> |
| [648](#L648) | <?php wp\_nonce\_field(WPDM\_PUB\_NONCE, 'plinknonce') ?> |
| [649](#L649) | <input type="hidden" name="action" value="wpdmpp\_email\_payment\_link" /> |
| [650](#L650) | <div class="modal-content"> |
| [651](#L651) | <div class="modal-header"> |
| [652](#L652) | <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> |
| [653](#L653) | <h4 class="modal-title"><?= \_\_('Create Payment Link', WPDMPP\_TEXT\_DOMAIN); ?></h4> |
| [654](#L654) | </div> |
| [655](#L655) | <div class="modal-body"> |
| [656](#L656) | <div class="panel panel-default"> |
| [657](#L657) | <div class="panel-heading"><?= \_\_('Payment Link Options', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [658](#L658) | <div class="panel-body"> |
| [659](#L659) | <div class="form-group"> |
| [660](#L660) | <label><?= \_\_('Price', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [661](#L661) | <input required="required" step="0.01" min="0" type="number" class="form-control pla" id="plprice" name="price" /> |
| [662](#L662) | </div> |
| [663](#L663) | <div class="form-group"> |
| [664](#L664) | <label><?= \_\_('Title', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [665](#L665) | <input required="required" type="text" placeholder="<?= \_\_('Reason form payment', WPDMPP\_TEXT\_DOMAIN) ?>" name="name" class="form-control pla" id="pltitle" /> |
| [666](#L666) | </div> |
| [667](#L667) | <div class="form-group"> |
| [668](#L668) | <label><?= \_\_('Description', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [669](#L669) | <input type="text" placeholder="<?= \_\_('You may add more details about this payment', WPDMPP\_TEXT\_DOMAIN) ?>" name="desc" class="form-control pla" id="pldesc" /> |
| [670](#L670) | </div> |
| [671](#L671) | <!--<div class="form-group"> |
| [672](#L672) | <label><input type="checkbox" value="1" id="plrec" /> <?/\*= \_\_('Recurring Payment', WPDMPP\_TEXT\_DOMAIN) \*/?></label> |
| [673](#L673) | </div>--> |
| [674](#L674) | </div> |
| [675](#L675) | </div> |
| [676](#L676) | <div class="form-group"> |
| [677](#L677) | <div class="panel panel-default"> |
| [678](#L678) | <div class="panel-heading"><?= \_\_('Generated Payment Link', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [679](#L679) | <div class="panel-body"> |
| [680](#L680) | <div class="input-group"> |
| [681](#L681) | <input type="text" readonly="readonly" class="form-control bg-white" id="plink" /> |
| [682](#L682) | <div class="input-group-btn"><button onclick="WPDM.copy('plink');" type="button" class="btn btn-info"><i class="fa fa-copy"></i></button></div> |
| [683](#L683) | </div> |
| [684](#L684) | </div> |
| [685](#L685) | </div> |
| [686](#L686) | </div> |
| [687](#L687) | <div class="form-group"> |
| [688](#L688) | <div class="panel panel-default"> |
| [689](#L689) | <div class="panel-heading"><?= \_\_('Email Payment Link', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [690](#L690) | <div class="panel-body"> |
| [691](#L691) | <div class="form-group"> |
| [692](#L692) | <label><?= \_\_('Note:', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [693](#L693) | <textarea placeholder="<?= esc\_attr\_\_('Write something about this payment request', WPDMPP\_TEXT\_DOMAIN) ?>" class="form-control" name="msg"></textarea> |
| [694](#L694) | </div> |
| [695](#L695) | <div class="input-group"> |
| [696](#L696) | <input name="emails" type="text" placeholder="<?= esc\_attr\_\_('Email(s)', WPDMPP\_TEXT\_DOMAIN) ?>" class="form-control" id="plink" /> |
| [697](#L697) | <div class="input-group-btn"><button type="submit" class="btn btn-info" id="send-plink"><i class="fa fa-paper-plane"></i> <?= \_\_('Send', WPDMPP\_TEXT\_DOMAIN); ?></button></div> |
| [698](#L698) | </div> |
| [699](#L699) | <em class="note"><?= \_\_('Multiple emails separate by comma', WPDMPP\_TEXT\_DOMAIN) ?></em> |
| [700](#L700) | </div> |
| [701](#L701) | </div> |
| [702](#L702) | </div> |
| [703](#L703) | </div> |
| [704](#L704) |  |
| [705](#L705) | </div><!-- /.modal-content --> |
| [706](#L706) | </form> |
| [707](#L707) | </div><!-- /.modal-dialog --> |
| [708](#L708) | </div><!-- /.modal --> |
| [709](#L709) | </div> |
| [710](#L710) |  |
| [711](#L711) | <?php |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) |  |
| [715](#L715) | function wpdmpp\_delete\_frontend\_order() |
| [716](#L716) | { |
| [717](#L717) | if (!wp\_verify\_nonce($\_REQUEST['nonce'], NONCE\_KEY)) { |
| [718](#L718) | exit("No naughty business please"); |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | $result['type'] = 'failed'; |
| [722](#L722) | global $wpdb; |
| [723](#L723) | $order\_id = sanitize\_text\_field(esc\_sql($\_REQUEST['order\_id'])); |
| [724](#L724) | $uid = get\_current\_user\_id(); |
| [725](#L725) | $ret = $wpdb->query($wpdb->prepare("DELETE FROM {$wpdb->prefix}ahm\_orders WHERE order\_id = %s and uid='$uid'", $order\_id)); |
| [726](#L726) |  |
| [727](#L727) | if ($ret) { |
| [728](#L728) | $ret = $wpdb->query($wpdb->prepare("DELETE FROM {$wpdb->prefix}ahm\_order\_items WHERE oid = %s", $order\_id)); |
| [729](#L729) |  |
| [730](#L730) | if ($ret) $result['type'] = 'success'; |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | if (!empty($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) && strtolower($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) == 'xmlhttprequest') { |
| [734](#L734) | $result = json\_encode($result); |
| [735](#L735) | echo $result; |
| [736](#L736) | } else { |
| [737](#L737) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [738](#L738) | header("Location: " . $return); |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | die(); |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) |  |
| [745](#L745) | /\*\* |
| [746](#L746) | \* Update Guest Billing Info |
| [747](#L747) | \*/ |
| [748](#L748) | function wpdmpp\_update\_guest\_billing() |
| [749](#L749) | { |
| [750](#L750) | $billinginfo = array |
| [751](#L751) | ( |
| [752](#L752) | 'first\_name' => '', |
| [753](#L753) | 'last\_name' => '', |
| [754](#L754) | 'company' => '', |
| [755](#L755) | 'address\_1' => '', |
| [756](#L756) | 'address\_2' => '', |
| [757](#L757) | 'city' => '', |
| [758](#L758) | 'postcode' => '', |
| [759](#L759) | 'country' => '', |
| [760](#L760) | 'state' => '', |
| [761](#L761) | 'order\_email' => '', |
| [762](#L762) | 'email' => '', |
| [763](#L763) | 'phone' => '', |
| [764](#L764) | 'taxid' => '' |
| [765](#L765) | ); |
| [766](#L766) | $sbillinginfo = wpdm\_sanitize\_array($\_POST['billing']); |
| [767](#L767) | $billinginfo = shortcode\_atts($billinginfo, $sbillinginfo); |
| [768](#L768) | $oid = \WPDM\\_\_\Crypt::decrypt(wpdm\_query\_var('oid')); |
| [769](#L769) | \WPDMPP\Libs\Order::Update(array('billing\_info' => maybe\_serialize($billinginfo)), $oid); |
| [770](#L770) | die(\_\_('Billing info saved successfully!', WPDMPP\_TEXT\_DOMAIN)); |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | function wpdmpp\_recalculate\_sales() |
| [774](#L774) | { |
| [775](#L775) | if (!isset($\_POST['id'])) return; |
| [776](#L776) | global $wpdb; |
| [777](#L777) | $id = (int)$\_POST['id']; |
| [778](#L778) | $sql = "select sum(quantity\*price) as sales\_amount, sum(quantity) as sales\_quantity from {$wpdb->prefix}ahm\_order\_items oi, {$wpdb->prefix}ahm\_orders o where oi.oid = o.order\_id and oi.pid = {$id} and o.order\_status IN ('Completed', 'Expired')"; |
| [779](#L779) | $data = $wpdb->get\_row($sql); |
| [780](#L780) |  |
| [781](#L781) | header('Content-type: application/json'); |
| [782](#L782) | update\_post\_meta($id, '\_\_wpdm\_sales\_amount', $data->sales\_amount); |
| [783](#L783) | update\_post\_meta($id, '\_\_wpdm\_sales\_count', $data->sales\_quantity); |
| [784](#L784) | $data->sales\_amount = wpdmpp\_currency\_sign() . floatval($data->sales\_amount); |
| [785](#L785) | $data->sales\_quantity = intval($data->sales\_quantity); |
| [786](#L786) | echo json\_encode($data); |
| [787](#L787) | die(); |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | function wpdmpp\_sales\_price($pid) |
| [791](#L791) | { |
| [792](#L792) | $sales\_price = get\_post\_meta($pid, "\_\_wpdm\_sales\_price", true); |
| [793](#L793) | $sales\_price\_expire = get\_post\_meta($pid, "\_\_wpdm\_sales\_price\_expire", true); |
| [794](#L794) | if ($sales\_price\_expire != '') { |
| [795](#L795) | $sales\_price\_expire = strtotime($sales\_price\_expire); |
| [796](#L796) | if (time() > $sales\_price\_expire && $sales\_price\_expire > 0) $sales\_price = 0; |
| [797](#L797) | } |
| [798](#L798) | return number\_format((double)$sales\_price, 2, ".", ""); |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | function wpdmpp\_sales\_price\_info($product\_id) |
| [802](#L802) | { |
| [803](#L803) | $sales\_price\_expire = get\_post\_meta($product\_id, '\_\_wpdm\_sales\_price\_expire', true); |
| [804](#L804) | if ($sales\_price\_expire != '') |
| [805](#L805) | $sales\_price\_expire = strtotime($sales\_price\_expire); |
| [806](#L806) | $sales\_price\_info = $sales\_price\_expire != '' ? sprintf(\_\_("Sales price will expire on %s", "wpdm-premium-packages"), wp\_date(get\_option("date\_format") . " H:i", $sales\_price\_expire)) : \_\_("This is a discounted price for a limited time", "wpdm-premium-packages"); |
| [807](#L807) | $sales\_price\_info = apply\_filters("wpdmpp\_sales\_price\_info", $sales\_price\_info, $product\_id, $sales\_price\_expire); |
| [808](#L808) | return $sales\_price\_info; |
| [809](#L809) |  |
| [810](#L810) | } |
| [811](#L811) |  |
| [812](#L812) | /\*\* |
| [813](#L813) | \* @param $pid |
| [814](#L814) | \* @return string |
| [815](#L815) | \*/ |
| [816](#L816) | function wpdmpp\_effective\_price($pid) |
| [817](#L817) | { |
| [818](#L818) | global $current\_user; |
| [819](#L819) | $current\_user = wp\_get\_current\_user(); |
| [820](#L820) | if (get\_post\_type($pid) != 'wpdmpro') return 0; |
| [821](#L821) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [822](#L822) | $base\_price = $base\_price ? (double)$base\_price : 0; |
| [823](#L823) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [824](#L824) | $price = (double)($sales\_price) > 0 ? $sales\_price : $base\_price; |
| [825](#L825) | $role = is\_user\_logged\_in() && is\_array($current\_user->roles) && isset($current\_user->roles[0]) ? $current\_user->roles[0] : 'guest'; |
| [826](#L826) | $discount = maybe\_unserialize(get\_post\_meta($pid, '\_\_wpdm\_discount', true)); |
| [827](#L827) | if (!is\_array($discount) || count($discount) == 0) return number\_format((float)$price, 2, ".", ""); |
| [828](#L828) |  |
| [829](#L829) | $discount[$role] = isset($discount[$role]) ? $discount[$role] : 0; |
| [830](#L830) | $discount[$role] = (double)$discount[$role]; |
| [831](#L831) | $user\_discount = (($price \* $discount[$role]) / 100); |
| [832](#L832) | $price -= $user\_discount; |
| [833](#L833) |  |
| [834](#L834) | if (!$price) $price = 0; |
| [835](#L835) | return number\_format($price, 2, ".", ""); |
| [836](#L836) | } |
| [837](#L837) |  |
| [838](#L838) | /\*\* |
| [839](#L839) | \* @param $pid |
| [840](#L840) | \* @return int|mixed |
| [841](#L841) | \*/ |
| [842](#L842) | function wpdmpp\_role\_discount($pid, $name = false) |
| [843](#L843) | { |
| [844](#L844) | global $current\_user, $wp\_roles; |
| [845](#L845) | $current\_user = wp\_get\_current\_user(); |
| [846](#L846) | $role\_discount = 0; |
| [847](#L847) | $role\_name = ''; |
| [848](#L848) | //$role = ?$current\_user->roles[0]:'guest'; |
| [849](#L849) | $discount = maybe\_unserialize(get\_post\_meta($pid, '\_\_wpdm\_discount', true)); |
| [850](#L850) |  |
| [851](#L851) | $roles = $wp\_roles->role\_names; |
| [852](#L852) |  |
| [853](#L853) |  |
| [854](#L854) | if (is\_user\_logged\_in() && is\_array($discount)) { |
| [855](#L855) | foreach ($current\_user->roles as $role) { |
| [856](#L856) | if (isset($discount[$role]) && $discount[$role] > $role\_discount) { |
| [857](#L857) | $role\_discount = $discount[$role]; |
| [858](#L858) | $role\_name = isset($roles[$role]) ? $roles[$role] : $role; |
| [859](#L859) | } |
| [860](#L860) | } |
| [861](#L861) | } |
| [862](#L862) | if (!is\_user\_logged\_in() && is\_array($discount) && isset($discount['guest'])) $role\_discount = $discount['guest']; |
| [863](#L863) | if (!is\_array($discount) || count($discount) == 0) return 0; |
| [864](#L864) |  |
| [865](#L865) | return $name ? $role\_name : $role\_discount; |
| [866](#L866) | } |
| [867](#L867) |  |
| [868](#L868) |  |
| [869](#L869) | function wpdmpp\_price\_range($pid) |
| [870](#L870) | { |
| [871](#L871) | $pre\_licenses = wpdmpp\_get\_licenses(); |
| [872](#L872) | $license\_infs = get\_post\_meta($pid, "\_\_wpdm\_license", true); |
| [873](#L873) | $license\_infs = maybe\_unserialize($license\_infs); |
| [874](#L874) | $licprices = array(); |
| [875](#L875) |  |
| [876](#L876) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [877](#L877) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [878](#L878) | $base\_price = intval($sales\_price) > 0 ? $sales\_price : $base\_price; |
| [879](#L879) |  |
| [880](#L880) | foreach ($pre\_licenses as $licid => $lic) { |
| [881](#L881) | if (isset($license\_infs[$licid]) && $license\_infs[$licid]['active'] == 1) { |
| [882](#L882) | $licprices[] = isset($license\_infs[$licid]['price']) ? $license\_infs[$licid]['price'] : $base\_price; |
| [883](#L883) | } |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | $price\_range = wpdmpp\_price\_format((float)$base\_price, true, true); |
| [887](#L887) |  |
| [888](#L888) | if (count($licprices) > 1 && get\_post\_meta($pid, "\_\_wpdm\_enable\_license", true) == 1) { |
| [889](#L889) | sort($licprices); |
| [890](#L890) | $fromprice = $licprices[0]; |
| [891](#L891) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [892](#L892) | if ($sales\_price < $fromprice && $sales\_price > 0) $fromprice = $sales\_price; |
| [893](#L893) | $price\_range = wpdmpp\_price\_format($fromprice, true, true) . " &mdash; " . wpdmpp\_price\_format(end($licprices), true, true); |
| [894](#L894) | } |
| [895](#L895) | return $price\_range; |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | function wpdmpp\_order\_id() |
| [899](#L899) | { |
| [900](#L900) | return Session::get('orderid'); |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | function wpdmpp\_currency\_sign() |
| [904](#L904) | { |
| [905](#L905) | $settings = get\_option('\_wpdmpp\_settings'); |
| [906](#L906) | $currency = isset($settings['currency']) ? $settings['currency'] : 'USD'; |
| [907](#L907) | $cdata = \WPDMPP\Libs\Currencies::GetCurrency($currency); |
| [908](#L908) | $sign = is\_array($cdata) ? $cdata['symbol'] : '$'; |
| [909](#L909) | $sign = apply\_filters("wpdmpp\_currency\_sign", $sign); |
| [910](#L910) | return $sign; |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | function wpdmpp\_currency\_sign\_position() |
| [914](#L914) | { |
| [915](#L915) | $settings = get\_option('\_wpdmpp\_settings'); |
| [916](#L916) | $currency\_position = isset($settings['currency\_position']) ? $settings['currency\_position'] : 'before'; |
| [917](#L917) | return $currency\_position; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | function wpdmpp\_currency\_code() |
| [921](#L921) | { |
| [922](#L922) | $settings = get\_option('\_wpdmpp\_settings'); |
| [923](#L923) | $currency = isset($settings['currency']) ? $settings['currency'] : 'USD'; |
| [924](#L924) | $currency = apply\_filters("wpdmpp\_currency\_code", $currency); |
| [925](#L925) | return $currency; |
| [926](#L926) | } |
| [927](#L927) |  |
| [928](#L928) | /\*\* |
| [929](#L929) | \* Validating download request using 'wpdm\_onstart\_download' WPDM hook |
| [930](#L930) | \* @param $package |
| [931](#L931) | \* @return mixed |
| [932](#L932) | \*/ |
| [933](#L933) | function wpdmpp\_validate\_download($package) |
| [934](#L934) | { |
| [935](#L935) |  |
| [936](#L936) | $price = wpdmpp\_effective\_price($package['ID']); |
| [937](#L937) | if (floatval($price) > 0) { |
| [938](#L938) |  |
| [939](#L939) | // Check The Master Key |
| [940](#L940) | if (wpdm\_query\_var('masterkey') !== '' && WPDMPremiumPackage::authorize\_masterkey()) return $package; |
| [941](#L941) |  |
| [942](#L942) | // Validate Download Key |
| [943](#L943) | //wpdmdd(is\_wpdmkey\_valid($package['ID'], wpdm\_query\_var('\_wpdmkey'))); |
| [944](#L944) | //wpdmdd(get\_wpdmpp\_option('authorize\_masterkey')); |
| [945](#L945) | if (is\_wpdmkey\_valid($package['ID'], wpdm\_query\_var('\_wpdmkey')) === 1 && (int)get\_wpdmpp\_option('authorize\_masterkey') === 1) return $package; |
| [946](#L946) |  |
| [947](#L947) | if ( (int) Session::get('\_\_wpdmpp\_authorized\_download') === 1) return $package; |
| [948](#L948) |  |
| [949](#L949) | Messages::error('You do not have permission to download this file', 1); |
| [950](#L950) |  |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | return $package; |
| [954](#L954) |  |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | /\*\* |
| [958](#L958) | \* Assign an order to specific user |
| [959](#L959) | \*/ |
| [960](#L960) | function wpdmpp\_assign\_user\_2order() |
| [961](#L961) | { |
| [962](#L962) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($\_REQUEST['\_\_nonce'], NONCE\_KEY)) { |
| [963](#L963) | Messages::error(\_\_('Unauthorized Operation!', 'wpdm-premium-packages'), 1); |
| [964](#L964) | } |
| [965](#L965) | $wpdmpp\_settings = get\_option('\_wpdmpp\_settings'); |
| [966](#L966) | if (isset($\_REQUEST['assignuser']) && isset($\_REQUEST['order'])) { |
| [967](#L967) | if (is\_email($\_REQUEST['assignuser'])) |
| [968](#L968) | $u = get\_user\_by('email', sanitize\_email($\_REQUEST['assignuser'])); |
| [969](#L969) | else |
| [970](#L970) | $u = get\_user\_by('login', sanitize\_text\_field($\_REQUEST['assignuser'])); |
| [971](#L971) | if (is\_object($u) && isset($u->ID)) { |
| [972](#L972) | $order = new \WPDMPP\Libs\Order(); |
| [973](#L973) | $oid = esc\_attr($\_REQUEST['order']); |
| [974](#L974) | $order->Update(array('uid' => $u->ID), sanitize\_text\_field($oid)); |
| [975](#L975) | $logo = isset($settings['logo\_url']) && $wpdmpp\_settings['logo\_url'] != "" ? "<img src='{$wpdmpp\_settings['logo\_url']}' alt='" . get\_bloginfo('name') . "'/>" : get\_bloginfo('name'); |
| [976](#L976) | $params = array( |
| [977](#L977) | 'date' => wp\_date(get\_option('date\_format'), time()), |
| [978](#L978) | 'homeurl' => home\_url('/'), |
| [979](#L979) | 'sitename' => get\_bloginfo('name'), |
| [980](#L980) | 'order\_link' => "<a href='" . wpdmpp\_orders\_page('id=' . $oid) . "'>" . wpdmpp\_orders\_page('id=' . $oid) . "</a>", |
| [981](#L981) | 'register\_link' => "<a href='" . wpdmpp\_orders\_page('orderid=' . $oid) . "'>" . wpdmpp\_orders\_page('orderid=' . $oid) . "</a>", |
| [982](#L982) | 'name' => $u->user\_login, |
| [983](#L983) | 'orderid' => $oid, |
| [984](#L984) | 'to\_email' => $u->user\_email, |
| [985](#L985) | 'order\_url' => wpdmpp\_orders\_page('id=' . $oid), |
| [986](#L986) | 'order\_url\_admin' => admin\_url('edit.php?post\_type=wpdmpro&page=orders&task=vieworder&id=' . $oid), |
| [987](#L987) | 'img\_logo' => $logo |
| [988](#L988) | ); |
| [989](#L989) | \WPDMPP\Libs\User::addCustomer($u); |
| [990](#L990) | \WPDM\\_\_\Email::send("purchase-confirmation", $params); |
| [991](#L991) | die('<div class="color-green" style="padding: 7px 15px;margin: 0;border-radius: 2px">Order Is Linked to ' . esc\_attr($\_REQUEST['assignuser']) . "</div>"); |
| [992](#L992) | } else |
| [993](#L993) | die('<div class="alert alert-danger" style="padding: 7px 15px;background: rgba(255,0,23,0.05);margin: 0;border-radius: 2px">' . \_\_('User Not Found!', 'wpdm-premium-packages') . '</div>'); |
| [994](#L994) | } |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) |  |
| [998](#L998) | function wpdmpp\_download\_order\_note\_attachment() |
| [999](#L999) | { |
| [1000](#L1000) | global $current\_user; |
| [1001](#L1001) | $current\_user = wp\_get\_current\_user(); |
| [1002](#L1002) | if (!isset($\_GET['\_atcdl']) || !is\_user\_logged\_in()) return false; |
| [1003](#L1003) | $key = \WPDM\\_\_\Crypt::Decrypt(esc\_attr($\_GET['\_atcdl'])); |
| [1004](#L1004) | $key = explode("|||", $key); |
| [1005](#L1005) | $order = new \WPDMPP\Libs\Order($key[0]); |
| [1006](#L1006) | if ($order->uid != $current\_user->ID && !current\_user\_can('manage\_options')) wp\_die('Unauthorized Access'); |
| [1007](#L1007) | $files = $order->order\_notes['messages'][$key[1]]['file']; |
| [1008](#L1008) | $filename = preg\_replace("/^[0-9]+?wpdm\_/", "", wpdm\_basename($key[2])); |
| [1009](#L1009) | if (in\_array($key[2], $files)) { |
| [1010](#L1010) | wpdm\_download\_file(UPLOAD\_DIR . $key[2], $filename); |
| [1011](#L1011) | die(); |
| [1012](#L1012) | } |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | /\*\* |
| [1016](#L1016) | \* Return array of country objects |
| [1017](#L1017) | \* @return array |
| [1018](#L1018) | \*/ |
| [1019](#L1019) | function wpdmpp\_get\_countries() |
| [1020](#L1020) | { |
| [1021](#L1021) | global $wpdb; |
| [1022](#L1022) | $countries = $wpdb->get\_results("select \* from {$wpdb->prefix}ahm\_country order by country\_name"); |
| [1023](#L1023) |  |
| [1024](#L1024) | return $countries; |
| [1025](#L1025) | } |
| [1026](#L1026) |  |
| [1027](#L1027) | /\*\* |
| [1028](#L1028) | \* Return Premium Package Template Directory |
| [1029](#L1029) | \* @return string |
| [1030](#L1030) | \*/ |
| [1031](#L1031) | function wpdmpp\_tpl\_dir() |
| [1032](#L1032) | { |
| [1033](#L1033) | return WPDMPP\_TPL\_DIR; |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) | function wpdmpp\_email\_template\_tags($tags) |
| [1037](#L1037) | { |
| [1038](#L1038) | $tags["{{orderid}}"] = array('value' => '', 'desc' => 'Order ID'); |
| [1039](#L1039) | $tags["{{items}}"] = array('value' => '', 'desc' => 'List of purchased items'); |
| [1040](#L1040) | $tags["{{order\_url}}"] = array('value' => '', 'desc' => 'Order URL'); |
| [1041](#L1041) | $tags["{{guest\_order\_url}}"] = array('value' => '', 'desc' => 'Guest Order URL'); |
| [1042](#L1042) | return $tags; |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) | function wpdmpp\_email\_templates($templates) |
| [1046](#L1046) | { |
| [1047](#L1047) | $templates['purchase-confirmation-guest'] = array( |
| [1048](#L1048) | 'label' => \_\_('Purchase Confirmation - Guest', 'wpdmpro'), |
| [1049](#L1049) | 'for' => 'customer', |
| [1050](#L1050) | 'plugin' => 'Premium Packages', |
| [1051](#L1051) | 'default' => array('subject' => \_\_('Thanks For Your Purchase', 'wpdmpro'), |
| [1052](#L1052) | 'from\_name' => get\_option('blogname'), |
| [1053](#L1053) | 'from\_email' => get\_option('admin\_email'), |
| [1054](#L1054) | 'message' => 'Hello ,<br/>Thanks for your order at [#sitename#].<br/>Your Order ID: [#orderid#]<br/>Purchased Items:<br/>[#items#]<br/>You need to create an account to access your order and to get future updates.<br/>Please click on the following link to create your account:<br/><a class="button green" style="display: block; text-align: center;" href="[#order\_url#]">Signup</a>If you already have account simply click the above url and login<br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1055](#L1055) | ) |
| [1056](#L1056) | ); |
| [1057](#L1057) |  |
| [1058](#L1058) | $templates['purchase-confirmation'] = array( |
| [1059](#L1059) | 'label' => \_\_('Purchase Confirmation', 'wpdmpro'), |
| [1060](#L1060) | 'for' => 'customer', |
| [1061](#L1061) | 'plugin' => 'Premium Packages', |
| [1062](#L1062) | 'default' => array('subject' => \_\_('Thanks For Your Purchase', 'wpdmpro'), |
| [1063](#L1063) | 'from\_name' => get\_option('blogname'), |
| [1064](#L1064) | 'from\_email' => get\_option('admin\_email'), |
| [1065](#L1065) | 'message' => 'Hello ,<br/>Thanks for your order at [#sitename#].<br/>Your Order ID: [#orderid#]<br/>Purchased Items:<br/>[#items#]<br/>You can download your purchased item(s) from the following link:<br/><a href="[#order\_url#]">[#order\_url#]</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1066](#L1066) | ) |
| [1067](#L1067) | ); |
| [1068](#L1068) |  |
| [1069](#L1069) | $templates['subscription-reminder'] = array( |
| [1070](#L1070) | 'label' => \_\_('Subscription Reminder', 'wpdmpro'), |
| [1071](#L1071) | 'for' => 'customer', |
| [1072](#L1072) | 'plugin' => 'Premium Packages', |
| [1073](#L1073) | 'default' => array('subject' => \_\_('[#sitename#] Subscription Reminder', 'wpdmpro'), |
| [1074](#L1074) | 'from\_name' => get\_option('blogname'), |
| [1075](#L1075) | 'from\_email' => get\_option('admin\_email'), |
| [1076](#L1076) | 'message' => 'Hello,<br/>Thanks for your continued support.<br/>We\'re sending this message to remind you that, as your subscription is active, your Order# [#orderid#] will be renewed automatically on [#expire\_date#]. <br/><br/><strong>Associated Items:</strong><hr/>[#items#]<hr/><br/> <a href="[#order\_url#]" style="display: block;text-align: center" class="button">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1077](#L1077) | ) |
| [1078](#L1078) | ); |
| [1079](#L1079) |  |
| [1080](#L1080) | $templates['renew-confirmation'] = array( |
| [1081](#L1081) | 'label' => \_\_('Order Renew Confirmation', 'wpdmpro'), |
| [1082](#L1082) | 'for' => 'customer', |
| [1083](#L1083) | 'plugin' => 'Premium Packages', |
| [1084](#L1084) | 'default' => array('subject' => \_\_('Order Renewed Successfully', 'wpdmpro'), |
| [1085](#L1085) | 'from\_name' => get\_option('blogname'), |
| [1086](#L1086) | 'from\_email' => get\_option('admin\_email'), |
| [1087](#L1087) | 'message' => 'Hello,<br/>Thanks for your continued support.<br/>Your Order# [#orderid#] is renewed successfully.<br/>As always, you can download the latest version from the following link:<br/><a href="[#order\_url#]">[#order\_url#]</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1088](#L1088) | ) |
| [1089](#L1089) | ); |
| [1090](#L1090) |  |
| [1091](#L1091) | $templates['sale-notification'] = array( |
| [1092](#L1092) | 'label' => \_\_('New Sale Notification', 'wpdmpro'), |
| [1093](#L1093) | 'for' => 'admin', |
| [1094](#L1094) | 'plugin' => 'Premium Packages', |
| [1095](#L1095) | 'default' => array('subject' => \_\_('Congratulations! You have a sale.', 'wpdmpro'), |
| [1096](#L1096) | 'from\_name' => get\_option('blogname'), |
| [1097](#L1097) | 'from\_email' => get\_option('admin\_email'), |
| [1098](#L1098) | 'to\_email' => get\_option('admin\_email'), |
| [1099](#L1099) | 'message' => 'Hello ,<br/>Congratulations! You have a sale just now.<br/>Order ID: [#orderid#]<br/>Sold Items:<br/>[#items#]<br/>Review Order: [#order\_url\_admin#]' |
| [1100](#L1100) | ) |
| [1101](#L1101) | ); |
| [1102](#L1102) |  |
| [1103](#L1103) | $templates['sale-notification-seller'] = array( |
| [1104](#L1104) | 'label' => \_\_('New Sale Notification', 'wpdmpro'), |
| [1105](#L1105) | 'for' => 'seller', |
| [1106](#L1106) | 'plugin' => 'Premium Packages', |
| [1107](#L1107) | 'default' => array('subject' => \_\_('Congratulations! You have a sale.', 'wpdmpro'), |
| [1108](#L1108) | 'from\_name' => get\_option('blogname'), |
| [1109](#L1109) | 'from\_email' => get\_option('admin\_email'), |
| [1110](#L1110) | 'to\_email' => get\_option('admin\_email'), |
| [1111](#L1111) | 'message' => 'Hello ,<br/>Congratulations! You have a sale just now.<br/>Order ID: [#orderid#]<br/>Sold Items:<br/>[#items#]<br/>Review Order: [#order\_url\_seller#]' |
| [1112](#L1112) | ) |
| [1113](#L1113) | ); |
| [1114](#L1114) |  |
| [1115](#L1115) | $templates['os-notification'] = array( |
| [1116](#L1116) | 'label' => \_\_('Order Status Notification', 'wpdmpro'), |
| [1117](#L1117) | 'for' => 'customer', |
| [1118](#L1118) | 'plugin' => 'Premium Packages', |
| [1119](#L1119) | 'default' => array('subject' => \_\_('Order ([#orderid#]) Status Changed', 'wpdmpro'), |
| [1120](#L1120) | 'from\_name' => get\_option('blogname'), |
| [1121](#L1121) | 'from\_email' => get\_option('admin\_email'), |
| [1122](#L1122) | 'message' => 'Hello ,<br/>The order <strong>[#orderid#]</strong> is changed to <strong>[#order\_status#]</strong><br/>Review Order: <a class="button button-green green" style="margin: 15px 0;display: block;text-align: center" href="[#order\_url#]">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1123](#L1123) | ) |
| [1124](#L1124) | ); |
| [1125](#L1125) |  |
| [1126](#L1126) | $templates['order-expire'] = array( |
| [1127](#L1127) | 'label' => \_\_('Order Expiry Notification', 'wpdmpro'), |
| [1128](#L1128) | 'for' => 'customer', |
| [1129](#L1129) | 'plugin' => 'Premium Packages', |
| [1130](#L1130) | 'default' => array('subject' => \_\_('Your order is about to expire', 'wpdmpro'), |
| [1131](#L1131) | 'from\_name' => get\_option('blogname'), |
| [1132](#L1132) | 'from\_email' => get\_option('admin\_email'), |
| [1133](#L1133) | 'message' => 'Hello [#name#],<br/>Your order is about to expire.<br/>Order# [#orderid#]<br/><br/>Purchased Items# [#order\_items#]<br/>Please renew your order to get continuous support and updates.<br/><a class="button" href="[#order\_url#]">Renew Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1134](#L1134) | ) |
| [1135](#L1135) | ); |
| [1136](#L1136) |  |
| [1137](#L1137) | /\*$templates['email-saved-cart'] = array( |
| [1138](#L1138) | 'label' => \_\_('Email Saved Cart', 'wpdm-premium-packages'), |
| [1139](#L1139) | 'for' => 'customer', |
| [1140](#L1140) | 'plugin' => 'Premium Packages', |
| [1141](#L1141) | 'default' => array( |
| [1142](#L1142) | 'subject' => \_\_('Someone sent you a cart!', 'wpdm-premium-packages'), |
| [1143](#L1143) | 'from\_name' => get\_option('blogname'), |
| [1144](#L1144) | 'from\_email' => get\_option('admin\_email'), |
| [1145](#L1145) | 'message' => 'Hello,<br/>Someone sent you a cart from [#sitename#]:<br/>View Cart & Checkout from here:<br/><b><a href="[#carturl#]">[#carturl#]</a></b><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1146](#L1146) | ) |
| [1147](#L1147) | );\*/ |
| [1148](#L1148) |  |
| [1149](#L1149) | $templates['recovered-order-confirmation'] = array( |
| [1150](#L1150) | 'label' => \_\_('Recovered Order Confirmation', 'wpdmpro'), |
| [1151](#L1151) | 'for' => 'admin', |
| [1152](#L1152) | 'plugin' => 'Premium Packages', |
| [1153](#L1153) | 'default' => array('subject' => \_\_('Congratulation! Order recovered successfully', 'wpdmpro'), |
| [1154](#L1154) | 'from\_name' => get\_option('blogname'), |
| [1155](#L1155) | 'from\_email' => get\_option('admin\_email'), |
| [1156](#L1156) | 'message' => '<strong>Congratulation!</strong><br/>The following order has been recovered successfully.<br/>Order# {{orderid}}<br/><br/>Purchased Items# {{items}}<br/>Keep up good works!<br/><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{order\_url}}">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>' |
| [1157](#L1157) | ) |
| [1158](#L1158) | ); |
| [1159](#L1159) |  |
| [1160](#L1160) | $acre\_count = get\_wpdmpp\_option('acre\_count', 0, 'int'); |
| [1161](#L1161) | $acre\_msg\_template = [ |
| [1162](#L1162) | 1 => 'Hello {{name}},<br/>It looks like you haven’t finished checking out yet. The good news? We saved your cart for you. Go on and complete your order now before your cart expires.<br/>Your cart:<br/>{{items}}<b><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{checkout\_url}}">Checkout Now!</a></b><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>', |
| [1163](#L1163) | 2 => 'Hello {{name}},<br/>Thought, you have missed my last email. The good news? We saved your cart for you. Go on and complete your order now before your cart expires.<br/>Your cart:<br/>{{items}}<b><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{checkout\_url}}">Checkout Now!</a></b><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>', |
| [1164](#L1164) | ]; |
| [1165](#L1165) | if($acre\_count > 0) { |
| [1166](#L1166) | for ($acre = 1; $acre <= $acre\_count; $acre++) { |
| [1167](#L1167) | $templates['order-recovery-email-'.$acre] = array( |
| [1168](#L1168) | 'label' => sprintf(\_\_('Abandoned Order Recovery Email %s', 'wpdm-premium-packages'), $acre), |
| [1169](#L1169) | 'for' => 'customer', |
| [1170](#L1170) | 'plugin' => 'Premium Packages', |
| [1171](#L1171) | 'default' => array( |
| [1172](#L1172) | 'subject' => \_\_('Your cart is waiting for you!', 'wpdm-premium-packages'), |
| [1173](#L1173) | 'from\_name' => get\_option('blogname'), |
| [1174](#L1174) | 'from\_email' => get\_option('admin\_email'), |
| [1175](#L1175) | 'message' => wpdm\_valueof($acre\_msg\_template, $acre, "Add your abandoned order recovery email content # {$acre}") |
| [1176](#L1176) | ) |
| [1177](#L1177) | ); |
| [1178](#L1178) | } |
| [1179](#L1179) | } |
| [1180](#L1180) |  |
| [1181](#L1181) | return $templates; |
| [1182](#L1182) | } |
| [1183](#L1183) |  |
| [1184](#L1184) | function wpdmpp\_reactivate() |
| [1185](#L1185) | { |
| [1186](#L1186) | return \_\_("Database error detected. Please try deactivate and then reactivating plugin.", "wpdm-premium-packages"); |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | function wpdmpp\_expiry\_check() |
| [1190](#L1190) | { |
| [1191](#L1191) | $order = new \WPDMPP\Libs\Order(); |
| [1192](#L1192) | $uid = get\_current\_user\_id(); |
| [1193](#L1193) | $orders = $order->getOrders($uid); |
| [1194](#L1194) | foreach ($orders as $\_order) { |
| [1195](#L1195) | $expire\_date = $\_order->expire\_date > 0 ? $\_order->expire\_date : $\_order->date + (get\_wpdmpp\_option('order\_validity\_period', 365) \* 86400); |
| [1196](#L1196) | if (time() > $expire\_date && $\_order->order\_status != 'Expired') { |
| [1197](#L1197) | $order->Update(array('order\_status' => 'Expired', 'payment\_status' => 'Expired', 'expire\_date' => $expire\_date), $\_order->order\_id); |
| [1198](#L1198) | } |
| [1199](#L1199) | } |
| [1200](#L1200) |  |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | function wpdmpp\_sanitize\_alphanum($id) |
| [1204](#L1204) | { |
| [1205](#L1205) | return preg\_replace('/[^a-zA-Z0-9 -]/', "", $id); |
| [1206](#L1206) | } |
| [1207](#L1207) |  |
| [1208](#L1208) | /\*\* |
| [1209](#L1209) | \* @usage Format price |
| [1210](#L1210) | \* @param $price |
| [1211](#L1211) | \* @return string |
| [1212](#L1212) | \*/ |
| [1213](#L1213) | function wpdmpp\_price\_format($price, $currency\_sign = true, $thousand\_separator = true) |
| [1214](#L1214) | { |
| [1215](#L1215) | $ts = $thousand\_separator ? get\_wpdmpp\_option('thousand\_separator') : ''; |
| [1216](#L1216) | $ds = $thousand\_separator ? get\_wpdmpp\_option('decimal\_separator') : '.'; |
| [1217](#L1217) | $dp = $thousand\_separator ? (int)get\_wpdmpp\_option('decimal\_points') : 2; |
| [1218](#L1218) | $currency\_sign = $currency\_sign === true ? wpdmpp\_currency\_sign() : $currency\_sign; |
| [1219](#L1219) | $price = (double)$price; |
| [1220](#L1220) | $price = number\_format($price, $dp, $ds, $ts); |
| [1221](#L1221) | return (get\_wpdmpp\_option('currency\_position', 'before') === 'before') ? $currency\_sign . $price : $price . $currency\_sign; |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | function wpdmppdl\_encode($content) { |
| [1225](#L1225) | $content = json\_encode($content); |
| [1226](#L1226) | $content = base64\_encode($content); |
| [1227](#L1227) | $content = trim($content, '='); |
| [1228](#L1228) | return $content; |
| [1229](#L1229) | } |
| [1230](#L1230) | function wpdmppdl\_decode($cyper) { |
| [1231](#L1231) | $jsonstr = base64\_decode($cyper); |
| [1232](#L1232) | $json = json\_decode($jsonstr, true); |
| [1233](#L1233) | return $json; |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | /\*\* |
| [1237](#L1237) | \* @usage Generate ordinal number |
| [1238](#L1238) | \* @param $number |
| [1239](#L1239) | \* @return string |
| [1240](#L1240) | \*/ |
| [1241](#L1241) | function wpdmpp\_ordinal($number) |
| [1242](#L1242) | { |
| [1243](#L1243) | $ends = array('th', 'st', 'nd', 'rd', 'th', 'th', 'th', 'th', 'th', 'th'); |
| [1244](#L1244) | if ((($number % 100) >= 11) && (($number % 100) <= 13)) |
| [1245](#L1245) | return $number . 'th'; |
| [1246](#L1246) | else |
| [1247](#L1247) | return $number . $ends[$number % 10]; |
| [1248](#L1248) | } |
| [1249](#L1249) |  |
| [1250](#L1250) | function wpdmpp\_forex\_rate($from, $to) |
| [1251](#L1251) | { |
| [1252](#L1252) | $rate = get\_option("wppm\_fx\_rate\_{$from}\_{$to}"); |
| [1253](#L1253) | if(is\_array($rate) && isset($rate['expire']) && $rate['expire'] > time()) |
| [1254](#L1254) | return $rate['rate']; |
| [1255](#L1255) |  |
| [1256](#L1256) | $curl = curl\_init(); |
| [1257](#L1257) |  |
| [1258](#L1258) | curl\_setopt\_array($curl, [ |
| [1259](#L1259) | CURLOPT\_URL => "https://v6.exchangerate-api.com/v6/e8767d62e2b5de59e1b9093c/pair/{$from}/{$to}", |
| [1260](#L1260) | CURLOPT\_RETURNTRANSFER => true, |
| [1261](#L1261) | CURLOPT\_FOLLOWLOCATION => true, |
| [1262](#L1262) | CURLOPT\_ENCODING => "", |
| [1263](#L1263) | CURLOPT\_MAXREDIRS => 10, |
| [1264](#L1264) | CURLOPT\_TIMEOUT => 30, |
| [1265](#L1265) | CURLOPT\_HTTP\_VERSION => CURL\_HTTP\_VERSION\_1\_1, |
| [1266](#L1266) | CURLOPT\_CUSTOMREQUEST => "GET" |
| [1267](#L1267) | ]); |
| [1268](#L1268) |  |
| [1269](#L1269) | $response = curl\_exec($curl); |
| [1270](#L1270) | $err = curl\_error($curl); |
| [1271](#L1271) |  |
| [1272](#L1272) | curl\_close($curl); |
| [1273](#L1273) | $response = json\_decode($response); |
| [1274](#L1274) | update\_option("wppm\_fx\_rate\_{$from}\_{$to}",  ['rate' => $response->conversion\_rate, 'expire' => time() + 28800]); |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) |  |
| [1278](#L1278) |  |
| [1279](#L1279) | function wpdmpp\_search\_products($keyword = '') |
| [1280](#L1280) | { |
| [1281](#L1281) | $keyword = wpdm\_query\_var('search') ? : $keyword; |
| [1282](#L1282) | if($keyword) { |
| [1283](#L1283) | $query = new Query(); |
| [1284](#L1284) | $query->search($keyword); |
| [1285](#L1285) | $query->meta('\_\_wpdm\_base\_price', 0, '>'); |
| [1286](#L1286) | $query->meta\_relation('AND'); |
| [1287](#L1287) | $query->process(); |
| [1288](#L1288) | $packages = $query->packages(); |
| [1289](#L1289) | foreach ($packages as &$package) { |
| [1290](#L1290) | $package->license = wpdmpp\_product\_license\_options($package->ID); |
| [1291](#L1291) | } |
| [1292](#L1292) | wp\_send\_json(['total' => $query->count, 'packages' => $query->packages(), 'q' => $query->params]); |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) |  |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php?format=txt)
* [Original Format](/export/3222484/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_981eeb20_20250114_215735.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwpdm-premium-packages%2Ftags%2F5.9.3%2Fincludes%2Flibs%2Ffunctions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?rev=3097018 "Revision 3097018")
* [Next Revision](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?rev=3195568 "Revision 3195568") →
* [Blame](/browser/wpdm-premium-packages/trunk/includes/libs/functions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php)

---

# [source:](/browser?order=name "Go to repository root") [wpdm-premium-packages](/browser/wpdm-premium-packages?order=name "View wpdm-premium-packages")/[tags](/browser/wpdm-premium-packages/tags?order=name "View tags")/[5.9.3](/browser/wpdm-premium-packages/tags/5.9.3?order=name "View 5.9.3")/[includes](/browser/wpdm-premium-packages/tags/5.9.3/includes?order=name "View includes")/[libs](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs?order=name "View libs")/[functions.php](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php?order=name "View functions.php")

View diff against:

View revision:

| [Last change](/changeset/3134341/wpdm-premium-packages/trunk/includes/libs/functions.php "View differences") on this file was [3134341](/changeset/3134341/ "View changeset 3134341"), checked in by codename065, [5 months ago](/timeline?from=2024-08-12T15%3A38%3A35Z&precision=second "See timeline at 08/12/2024 03:38:35 PM") |
| --- |
| 5.9.0 - 2024.08.12  * Fixed an issue with the currency sign with the completed orders |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 57.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | // Exit if accessed directly |
| [3](#L3) | use WPDM\\_\_\Messages; |
| [4](#L4) | use WPDM\\_\_\Query; |
| [5](#L5) | use WPDM\\_\_\Session; |
| [6](#L6) | use WPDMPP\WPDMPremiumPackage; |
| [7](#L7) |  |
| [8](#L8) | if (!defined('ABSPATH')) { |
| [9](#L9) | exit; |
| [10](#L10) | } |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* @return WPDMPremiumPackage |
| [14](#L14) | \*/ |
| [15](#L15) | function WPDMPP() |
| [16](#L16) | { |
| [17](#L17) | global $wpdmpp; |
| [18](#L18) | return $wpdmpp; |
| [19](#L19) | } |
| [20](#L20) |  |
| [21](#L21) | //number of total sales |
| [22](#L22) | function wpdmpp\_total\_purchase($pid = '') |
| [23](#L23) | { |
| [24](#L24) | global $wpdb; |
| [25](#L25) | if (!$pid) $pid = get\_the\_ID(); |
| [26](#L26) | $sales = $wpdb->get\_var("select count(\*) from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id and oi.pid='$pid' and  ( o.payment\_status='Completed' or o.payment\_status='Expired' )"); |
| [27](#L27) |  |
| [28](#L28) | return $sales; |
| [29](#L29) | } |
| [30](#L30) |  |
| [31](#L31) |  |
| [32](#L32) | //number of total sales |
| [33](#L33) | function wpdmpp\_total\_sales($uid = '', $pid = '', $sdate = '', $edate = '') |
| [34](#L34) | { |
| [35](#L35) | global $wpdb; |
| [36](#L36) |  |
| [37](#L37) | $pid\_cond = ($pid > 0) ? "and oi.pid='$pid'" : ""; |
| [38](#L38) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [39](#L39) |  |
| [40](#L40) | $sdate = $sdate == '' ? wp\_date("Y-m-01") : $sdate; |
| [41](#L41) | $edate = $edate == '' ? wp\_date("Y-m-d", strtotime("last day of this month")) : $edate; |
| [42](#L42) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : "and o.date >= '" . strtotime(wp\_date("Y-m-01")) . "'"; |
| [43](#L43) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : "and o.date <= '" . strtotime(wp\_date("Y-m-d", strtotime("last day of this month"))) . "'"; |
| [44](#L44) |  |
| [45](#L45) | if ($pid\_cond != '' || $uid\_cond != '') |
| [46](#L46) | $sales = $wpdb->get\_var("select sum(oi.price \* oi.quantity) from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id {$pid\_cond} {$uid\_cond} {$sdate\_cond} {$edate\_cond} and ( o.payment\_status='Completed' or o.payment\_status='Expired' )"); |
| [47](#L47) | else |
| [48](#L48) | $sales = $wpdb->get\_var("select sum(o.total) from {$wpdb->prefix}ahm\_orders o where  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) {$sdate\_cond} {$edate\_cond}"); |
| [49](#L49) |  |
| [50](#L50) | return number\_format($sales, 2, '.', ''); |
| [51](#L51) | } |
| [52](#L52) |  |
| [53](#L53) |  |
| [54](#L54) | function wpdmpp\_daily\_sales($uid = '', $pid = '', $sdate = '', $edate = '') |
| [55](#L55) | { |
| [56](#L56) | global $wpdb; |
| [57](#L57) |  |
| [58](#L58) | $pid\_cond = ($pid > 0) ? "and oi.pid='$pid'" : ""; |
| [59](#L59) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [60](#L60) | $sdate = $sdate == '' ? wp\_date("Y-m-01") : $sdate; |
| [61](#L61) | $edate = $edate == '' ? wp\_date("Y-m-d", strtotime("last day of this month")) : $edate; |
| [62](#L62) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : "and o.date >= '" . strtotime(wp\_date("Y-m-01")) . "'"; |
| [63](#L63) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : "and o.date <= '" . strtotime(wp\_date("Y-m-d", strtotime("last day of this month"))) . "'"; |
| [64](#L64) |  |
| [65](#L65) | $sales = $wpdb->get\_results("select sum(oi.price \* oi.quantity) as daily\_sale,  sum(oi.quantity) as quantities, oi.date, oi.year, oi.month, oi.day from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id {$pid\_cond} {$uid\_cond} {$sdate\_cond} {$edate\_cond} and  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) group by oi.date"); |
| [66](#L66) |  |
| [67](#L67) | $diff = date\_diff(date\_create($edate), date\_create($sdate))->days; |
| [68](#L68) | $sdata = array(); |
| [69](#L69) | $i = 0; |
| [70](#L70) | do { |
| [71](#L71) | $i++; |
| [72](#L72) | $sdata['sales'][$sdate] = 0; |
| [73](#L73) | $sdata['quantities'][$sdate] = 0; |
| [74](#L74) | $sdate = wp\_date('Y-m-d', strtotime('+1 day', strtotime($sdate))); |
| [75](#L75) | } while ($i <= $diff); |
| [76](#L76) |  |
| [77](#L77) | foreach ($sales as $sale) { |
| [78](#L78) | $sdata['sales'][$sale->date] = $sale->daily\_sale; |
| [79](#L79) | $sdata['quantities'][$sale->date] = $sale->quantities; |
| [80](#L80) | } |
| [81](#L81) |  |
| [82](#L82) | return $sdata; |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | function wpdmpp\_top\_sellings\_products($uid = '', $sdate = '', $edate = '', $s = 0, $e = 1000) |
| [86](#L86) | { |
| [87](#L87) | global $wpdb; |
| [88](#L88) |  |
| [89](#L89) | $uid\_cond = ($uid > 0) ? "and oi.sid='$uid'" : ""; |
| [90](#L90) | //$sdate = $sdate == ''?date("Y-m-01"):$sdate; |
| [91](#L91) | //$edate = $edate == ''?date("Y-m-31"):$edate; |
| [92](#L92) | $sdate\_cond = $sdate != '' ? " and o.date >= '" . strtotime($sdate) . "'" : ""; |
| [93](#L93) | $edate\_cond = $sdate != '' ? " and o.date <= '" . strtotime($edate) . "'" : ""; |
| [94](#L94) |  |
| [95](#L95) | $tsp = $wpdb->get\_results("select oi.pid, sum(oi.price) as sales,  sum(oi.quantity) as quantities, oi.date, oi.year, oi.month, oi.day from {$wpdb->prefix}ahm\_orders o, {$wpdb->prefix}ahm\_order\_items oi where oi.oid=o.order\_id  {$uid\_cond} {$sdate\_cond} {$edate\_cond} and  ( o.payment\_status='Completed' or o.payment\_status='Expired' ) group by oi.pid ORDER BY quantities DESC limit $s, $e"); |
| [96](#L96) | return $tsp; |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | function wpdmpp\_recent\_sales($uid = '', $count = 10) |
| [100](#L100) | { |
| [101](#L101) | global $wpdb; |
| [102](#L102) |  |
| [103](#L103) | $uid\_cond = ($uid > 0) ? "and {$wpdb->prefix}ahm\_order\_items.sid='$uid'" : ""; |
| [104](#L104) | $tsp = $wpdb->get\_results("select {$wpdb->prefix}ahm\_order\_items.pid as product\_id,{$wpdb->prefix}ahm\_order\_items.price, ({$wpdb->prefix}ahm\_order\_items.price \* {$wpdb->prefix}ahm\_order\_items.quantity) as total, {$wpdb->prefix}ahm\_orders.date as time\_stamp,  {$wpdb->prefix}ahm\_order\_items.date, {$wpdb->prefix}ahm\_order\_items.year, {$wpdb->prefix}ahm\_order\_items.month, {$wpdb->prefix}ahm\_order\_items.day from {$wpdb->prefix}ahm\_order\_items LEFT JOIN {$wpdb->prefix}ahm\_orders on {$wpdb->prefix}ahm\_order\_items.oid={$wpdb->prefix}ahm\_orders.order\_id  {$uid\_cond} and  ( {$wpdb->prefix}ahm\_orders.payment\_status='Completed' or {$wpdb->prefix}ahm\_orders.payment\_status='Expired' ) ORDER BY {$wpdb->prefix}ahm\_orders.date DESC limit 0, $count"); |
| [105](#L105) | foreach ($tsp as &$\_tsp) { |
| [106](#L106) | $\_tsp->post\_title = get\_the\_title($\_tsp->product\_id); |
| [107](#L107) | } |
| [108](#L108) | return $tsp; |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | function wpdmpp\_get\_licenses() |
| [112](#L112) | { |
| [113](#L113) | $pre\_licenses = get\_wpdmpp\_option('licenses', array( |
| [114](#L114) | 'single' => array('name' => 'Standard', 'description' => '', 'use' => 1), |
| [115](#L115) | 'extended' => array('name' => 'Extended', 'description' => '', 'use' => 5), |
| [116](#L116) | 'unlimited' => array('name' => 'Unlimited', 'description' => '', 'use' => 99), |
| [117](#L117) | )); |
| [118](#L118) | $pre\_licenses = maybe\_unserialize($pre\_licenses); |
| [119](#L119) | return $pre\_licenses; |
| [120](#L120) |  |
| [121](#L121) | } |
| [122](#L122) |  |
| [123](#L123) | function get\_wpdmpp\_option($name, $default = '', $validate = null) |
| [124](#L124) | { |
| [125](#L125) | global $wpdmpp\_settings; |
| [126](#L126) |  |
| [127](#L127) | $name = explode('/', $name); |
| [128](#L128) |  |
| [129](#L129) | if (!is\_array($wpdmpp\_settings)) return $default; |
| [130](#L130) |  |
| [131](#L131) | if (count($name) == 1) |
| [132](#L132) | $value = isset($wpdmpp\_settings[$name[0]]) ? $wpdmpp\_settings[$name[0]] : $default; |
| [133](#L133) | else if (count($name) == 2) |
| [134](#L134) | $value = isset($wpdmpp\_settings[$name[0]], $wpdmpp\_settings[$name[0]][$name[1]]) ? $wpdmpp\_settings[$name[0]][$name[1]] : $default; |
| [135](#L135) | else if (count($name) == 3) |
| [136](#L136) | $value = isset($wpdmpp\_settings[$name[0]], $wpdmpp\_settings[$name[0]][$name[1]], $wpdmpp\_settings[$name[0]][$name[1]][$name[2]]) ? $wpdmpp\_settings[$name[0]][$name[1]][$name[2]] : $default; |
| [137](#L137) | else |
| [138](#L138) | $value = $default; |
| [139](#L139) | if($validate !== null) |
| [140](#L140) | $value = wpdm\_sanitize\_var($value, $validate); |
| [141](#L141) |  |
| [142](#L142) | return $value; |
| [143](#L143) | } |
| [144](#L144) |  |
| [145](#L145) | function wpdmpp\_countries() |
| [146](#L146) | { |
| [147](#L147) | return array('AF' => 'AFGHANISTAN', 'AL' => 'ALBANIA', 'DZ' => 'ALGERIA', 'AS' => 'AMERICAN SAMOA', 'AD' => 'ANDORRA', 'AO' => 'ANGOLA', 'AI' => 'ANGUILLA', 'AQ' => 'ANTARCTICA', 'AG' => 'ANTIGUA AND BARBUDA', 'AR' => 'ARGENTINA', 'AM' => 'ARMENIA', 'AW' => 'ARUBA', 'AU' => 'AUSTRALIA', 'AT' => 'AUSTRIA', 'AZ' => 'AZERBAIJAN', 'BS' => 'BAHAMAS', 'BH' => 'BAHRAIN', 'BD' => 'BANGLADESH', 'BB' => 'BARBADOS', 'BY' => 'BELARUS', 'BE' => 'BELGIUM', 'BZ' => 'BELIZE', 'BJ' => 'BENIN', 'BM' => 'BERMUDA', 'BT' => 'BHUTAN', 'BO' => 'BOLIVIA', 'BA' => 'BOSNIA AND HERZEGOVINA', 'BW' => 'BOTSWANA', 'BV' => 'BOUVET ISLAND', 'BR' => 'BRAZIL', 'IO' => 'BRITISH INDIAN OCEAN TERRITORY', 'BN' => 'BRUNEI DARUSSALAM', 'BG' => 'BULGARIA', 'BF' => 'BURKINA FASO', 'BI' => 'BURUNDI', 'KH' => 'CAMBODIA', 'CM' => 'CAMEROON', 'CA' => 'CANADA', 'CV' => 'CAPE VERDE', 'KY' => 'CAYMAN ISLANDS', 'CF' => 'CENTRAL AFRICAN REPUBLIC', 'TD' => 'CHAD', 'CL' => 'CHILE', 'CN' => 'CHINA', 'CX' => 'CHRISTMAS ISLAND', 'CC' => 'COCOS (KEELING) ISLANDS', 'CO' => 'COLOMBIA', 'KM' => 'COMOROS', 'CG' => 'CONGO', 'CD' => 'CONGO, THE DEMOCRATIC REPUBLIC OF THE', 'CK' => 'COOK ISLANDS', 'CR' => 'COSTA RICA', 'CI' => 'COTE DIVOIRE', 'HR' => 'CROATIA', 'CU' => 'CUBA', 'CY' => 'CYPRUS', 'CZ' => 'CZECH REPUBLIC', 'DK' => 'DENMARK', 'DJ' => 'DJIBOUTI', 'DM' => 'DOMINICA', 'DO' => 'DOMINICAN REPUBLIC', 'EC' => 'ECUADOR', 'EG' => 'EGYPT', 'SV' => 'EL SALVADOR', 'GQ' => 'EQUATORIAL GUINEA', 'ER' => 'ERITREA', 'EE' => 'ESTONIA', 'ET' => 'ETHIOPIA', 'FK' => 'FALKLAND ISLANDS (MALVINAS)', 'FO' => 'FAROE ISLANDS', 'FJ' => 'FIJI', 'FI' => 'FINLAND', 'FR' => 'FRANCE', 'GF' => 'FRENCH GUIANA', 'PF' => 'FRENCH POLYNESIA', 'TF' => 'FRENCH SOUTHERN TERRITORIES', 'GA' => 'GABON', 'GM' => 'GAMBIA', 'GE' => 'GEORGIA', 'DE' => 'GERMANY', 'GH' => 'GHANA', 'GI' => 'GIBRALTAR', 'GR' => 'GREECE', 'GL' => 'GREENLAND', 'GD' => 'GRENADA', 'GP' => 'GUADELOUPE', 'GU' => 'GUAM', 'GT' => 'GUATEMALA', 'GN' => 'GUINEA', 'GW' => 'GUINEA-BISSAU', 'GY' => 'GUYANA', 'HT' => 'HAITI', 'HM' => 'HEARD ISLAND AND MCDONALD ISLANDS', 'VA' => 'HOLY SEE (VATICAN CITY STATE)', 'HN' => 'HONDURAS', 'HK' => 'HONG KONG', 'HU' => 'HUNGARY', 'IS' => 'ICELAND', 'IN' => 'INDIA', 'ID' => 'INDONESIA', 'IR' => 'IRAN, ISLAMIC REPUBLIC OF', 'IQ' => 'IRAQ', 'IE' => 'IRELAND', 'IL' => 'ISRAEL', 'IT' => 'ITALY', 'JM' => 'JAMAICA', 'JP' => 'JAPAN', 'JO' => 'JORDAN', 'KZ' => 'KAZAKHSTAN', 'KE' => 'KENYA', 'KI' => 'KIRIBATI', 'KP' => 'KOREA, DEMOCRATIC PEOPLE\'S REPUBLIC OF', 'KR' => 'KOREA, REPUBLIC OF', 'KW' => 'KUWAIT', 'KG' => 'KYRGYZSTAN', 'LA' => 'LAO PEOPLE\'S DEMOCRATIC REPUBLIC', 'LV' => 'LATVIA', 'LB' => 'LEBANON', 'LS' => 'LESOTHO', 'LR' => 'LIBERIA', 'LY' => 'LIBYAN ARAB JAMAHIRIYA', 'LI' => 'LIECHTENSTEIN', 'LT' => 'LITHUANIA', 'LU' => 'LUXEMBOURG', 'MO' => 'MACAO', 'MK' => 'MACEDONIA, THE FORMER YUGOSLAV REPUBLIC OF', 'MG' => 'MADAGASCAR', 'MW' => 'MALAWI', 'MY' => 'MALAYSIA', 'MV' => 'MALDIVES', 'ML' => 'MALI', 'MT' => 'MALTA', 'MH' => 'MARSHALL ISLANDS', 'MQ' => 'MARTINIQUE', 'MR' => 'MAURITANIA', 'MU' => 'MAURITIUS', 'YT' => 'MAYOTTE', 'MX' => 'MEXICO', 'FM' => 'MICRONESIA, FEDERATED STATES OF', 'MD' => 'MOLDOVA, REPUBLIC OF', 'MC' => 'MONACO', 'MN' => 'MONGOLIA', 'MS' => 'MONTSERRAT', 'MA' => 'MOROCCO', 'MZ' => 'MOZAMBIQUE', 'MM' => 'MYANMAR', 'NA' => 'NAMIBIA', 'NR' => 'NAURU', 'NP' => 'NEPAL', 'NL' => 'NETHERLANDS', 'AN' => 'NETHERLANDS ANTILLES', 'NC' => 'NEW CALEDONIA', 'NZ' => 'NEW ZEALAND', 'NI' => 'NICARAGUA', 'NE' => 'NIGER', 'NG' => 'NIGERIA', 'NU' => 'NIUE', 'NF' => 'NORFOLK ISLAND', 'MP' => 'NORTHERN MARIANA ISLANDS', 'NO' => 'NORWAY', 'OM' => 'OMAN', 'PK' => 'PAKISTAN', 'PW' => 'PALAU', 'PS' => 'PALESTINIAN TERRITORY, OCCUPIED', 'PA' => 'PANAMA', 'PG' => 'PAPUA NEW GUINEA', 'PY' => 'PARAGUAY', 'PE' => 'PERU', 'PH' => 'PHILIPPINES', 'PN' => 'PITCAIRN', 'PL' => 'POLAND', 'PT' => 'PORTUGAL', 'PR' => 'PUERTO RICO', 'QA' => 'QATAR', 'RE' => 'REUNION', 'RO' => 'ROMANIA', 'RU' => 'RUSSIAN FEDERATION', 'RW' => 'RWANDA', 'SH' => 'SAINT HELENA', 'KN' => 'SAINT KITTS AND NEVIS', 'LC' => 'SAINT LUCIA', 'PM' => 'SAINT PIERRE AND MIQUELON', 'VC' => 'SAINT VINCENT AND THE GRENADINES', 'WS' => 'SAMOA', 'SM' => 'SAN MARINO', 'ST' => 'SAO TOME AND PRINCIPE', 'SA' => 'SAUDI ARABIA', 'SN' => 'SENEGAL', 'CS' => 'SERBIA AND MONTENEGRO', 'SC' => 'SEYCHELLES', 'SL' => 'SIERRA LEONE', 'SG' => 'SINGAPORE', 'SK' => 'SLOVAKIA', 'SI' => 'SLOVENIA', 'SB' => 'SOLOMON ISLANDS', 'SO' => 'SOMALIA', 'ZA' => 'SOUTH AFRICA', 'GS' => 'SOUTH GEORGIA AND THE SOUTH SANDWICH ISLANDS', 'ES' => 'SPAIN', 'LK' => 'SRI LANKA', 'SD' => 'SUDAN', 'SR' => 'SURINAME', 'SJ' => 'SVALBARD AND JAN MAYEN', 'SZ' => 'SWAZILAND', 'SE' => 'SWEDEN', 'CH' => 'SWITZERLAND', 'SY' => 'SYRIAN ARAB REPUBLIC', 'TW' => 'TAIWAN, PROVINCE OF CHINA', 'TJ' => 'TAJIKISTAN', 'TZ' => 'TANZANIA, UNITED REPUBLIC OF', 'TH' => 'THAILAND', 'TL' => 'TIMOR-LESTE', 'TG' => 'TOGO', 'TK' => 'TOKELAU', 'TO' => 'TONGA', 'TT' => 'TRINIDAD AND TOBAGO', 'TN' => 'TUNISIA', 'TR' => 'TURKEY', 'TM' => 'TURKMENISTAN', 'TC' => 'TURKS AND CAICOS ISLANDS', 'TV' => 'TUVALU', 'UG' => 'UGANDA', 'UA' => 'UKRAINE', 'AE' => 'UNITED ARAB EMIRATES', 'GB' => 'UNITED KINGDOM', 'US' => 'UNITED STATES', 'UM' => 'UNITED STATES MINOR OUTLYING ISLANDS', 'UY' => 'URUGUAY', 'UZ' => 'UZBEKISTAN', 'VU' => 'VANUATU', 'VE' => 'VENEZUELA', 'VN' => 'VIET NAM', 'VG' => 'VIRGIN ISLANDS, BRITISH', 'VI' => 'VIRGIN ISLANDS, U.S.', 'WF' => 'WALLIS AND FUTUNA', 'EH' => 'WESTERN SAHARA', 'YE' => 'YEMEN', 'ZM' => 'ZAMBIA', 'ZW' => 'ZIMBABWE'); |
| [148](#L148) | } |
| [149](#L149) |  |
| [150](#L150) | function wpdmpp\_tax\_active() |
| [151](#L151) | { |
| [152](#L152) | global $wpdmpp\_settings; |
| [153](#L153) | return isset($wpdmpp\_settings['tax']) && isset($wpdmpp\_settings['tax']['enable']) ? true : false; |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | function wpdmpp\_show\_tax() |
| [157](#L157) | { |
| [158](#L158) | global $wpdmpp\_settings; |
| [159](#L159) | return isset($wpdmpp\_settings['tax']) && isset($wpdmpp\_settings['tax']['tax\_on\_cart']) ? true : false; |
| [160](#L160) | } |
| [161](#L161) |  |
| [162](#L162) |  |
| [163](#L163) | //Send notification before delete product |
| [164](#L164) | add\_action('wp\_trash\_post', 'wpdmpp\_notify\_product\_rejected'); |
| [165](#L165) | function wpdmpp\_notify\_product\_rejected($post\_id) |
| [166](#L166) | { |
| [167](#L167) | global $post\_type; |
| [168](#L168) | if ($post\_type != 'wpdmpro') return; |
| [169](#L169) |  |
| [170](#L170) | $post = get\_post($post\_id); |
| [171](#L171) | $post\_meta = get\_post\_meta($post\_id, "\_z\_user\_review", true); |
| [172](#L172) |  |
| [173](#L173) | if ($post\_meta != ""): |
| [174](#L174) | $author = get\_userdata($post->post\_author); |
| [175](#L175) | $author\_email = $author->user\_email; |
| [176](#L176) | $email\_subject = "Your product has been rejected."; |
| [177](#L177) |  |
| [178](#L178) | ob\_start(); ?> |
| [179](#L179) | <html> |
| [180](#L180) | <head> |
| [181](#L181) | <title>New post at <?php bloginfo('name') ?></title> |
| [182](#L182) | </head> |
| [183](#L183) | <body> |
| [184](#L184) | <p> |
| [185](#L185) | Hi <?php echo $author->user\_firstname ?>, |
| [186](#L186) | </p> |
| [187](#L187) |  |
| [188](#L188) | <p> |
| [189](#L189) | Your product <?php the\_title() ?> has not been approved by team. |
| [190](#L190) | </p> |
| [191](#L191) | </body> |
| [192](#L192) | </html> |
| [193](#L193) | <?php |
| [194](#L194) | $message = ob\_get\_contents(); |
| [195](#L195) | ob\_end\_clean(); |
| [196](#L196) |  |
| [197](#L197) | wp\_mail($author\_email, $email\_subject, $message); |
| [198](#L198) | endif; |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | // Product accept notification email |
| [202](#L202) | function wpdmpp\_notify\_product\_accepted($post\_id) |
| [203](#L203) | { |
| [204](#L204) | global $post\_type; |
| [205](#L205) | if ($post\_type != 'wpdmpro') return; |
| [206](#L206) |  |
| [207](#L207) | if (($\_POST['post\_status'] == 'publish') && ($\_POST['original\_post\_status'] != 'publish')) { |
| [208](#L208) | $post = get\_post($post\_id); |
| [209](#L209) | $post\_meta = get\_post\_meta($post\_id, "\_z\_user\_review", TRUE); |
| [210](#L210) | if ($post\_meta != ""): |
| [211](#L211) |  |
| [212](#L212) | $author = get\_userdata($post->post\_author); |
| [213](#L213) | $author\_email = $author->user\_email; |
| [214](#L214) | $email\_subject = "Your post has been published."; |
| [215](#L215) |  |
| [216](#L216) | ob\_start(); ?> |
| [217](#L217) | <html> |
| [218](#L218) | <head> |
| [219](#L219) | <title>Your Product Status at <?php bloginfo('name') ?></title> |
| [220](#L220) | </head> |
| [221](#L221) | <body> |
| [222](#L222) | <p>Hi <?php echo $author->user\_firstname ?>,</p> |
| [223](#L223) | <p>Your product <a href="<?php echo get\_permalink($post->ID) ?>"><?php the\_title\_attribute() ?></a> has been |
| [224](#L224) | published.</p> |
| [225](#L225) | </body> |
| [226](#L226) | </html> |
| [227](#L227) | <?php |
| [228](#L228) | $message = ob\_get\_clean(); |
| [229](#L229) |  |
| [230](#L230) | wp\_mail($author\_email, $email\_subject, $message); |
| [231](#L231) | endif; |
| [232](#L232) | } |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Calculate pending balance and matured balance of the seller |
| [238](#L238) | \* |
| [239](#L239) | \* @return array $seller\_balances Array of balances. Access using `pending` and `matured` |
| [240](#L240) | \* @since 3.8.9 |
| [241](#L241) | \*/ |
| [242](#L242) | function wpdmpp\_seller\_balances() |
| [243](#L243) | { |
| [244](#L244) | global $wpdb, $current\_user; |
| [245](#L245) | $current\_user = wp\_get\_current\_user(); |
| [246](#L246) | $uid = $current\_user->ID; |
| [247](#L247) | $sql = "select sum(i.price\*i.quantity) from {$wpdb->prefix}ahm\_orders o, |
| [248](#L248) | {$wpdb->prefix}ahm\_order\_items i, |
| [249](#L249) | {$wpdb->prefix}posts p |
| [250](#L250) | where p.post\_author=$uid and |
| [251](#L251) | i.oid=o.order\_id and |
| [252](#L252) | i.pid=p.ID and |
| [253](#L253) | i.quantity > 0 and |
| [254](#L254) | o.payment\_status='Completed'"; |
| [255](#L255) |  |
| [256](#L256) | $total\_sales = $wpdb->get\_var($sql); |
| [257](#L257) | $commission = wpdmpp\_site\_commission(); |
| [258](#L258) | $total\_commission = $total\_sales \* $commission / 100; |
| [259](#L259) | $total\_earning = $total\_sales - $total\_commission; |
| [260](#L260) | $sql = "select sum(amount) from {$wpdb->prefix}ahm\_withdraws where uid=$uid"; |
| [261](#L261) | $total\_withdraws = $wpdb->get\_var($sql); |
| [262](#L262) | $balance = $total\_earning - $total\_withdraws; |
| [263](#L263) |  |
| [264](#L264) | //finding matured balance |
| [265](#L265) | $payout\_duration = get\_option("wpdmpp\_payout\_duration"); |
| [266](#L266) | $dt = $payout\_duration \* 24 \* 60 \* 60; |
| [267](#L267) | $sqlm = "select sum(i.price\*i.quantity) from {$wpdb->prefix}ahm\_orders o, |
| [268](#L268) | {$wpdb->prefix}ahm\_order\_items i, |
| [269](#L269) | {$wpdb->prefix}posts p |
| [270](#L270) | where p.post\_author=$uid and |
| [271](#L271) | i.oid=o.order\_id and |
| [272](#L272) | i.pid=p.ID and |
| [273](#L273) | i.quantity > 0 and |
| [274](#L274) | o.payment\_status='Completed' |
| [275](#L275) | and (o.date+($dt))<" . time() . ""; |
| [276](#L276) |  |
| [277](#L277) | $tempbalance = $wpdb->get\_var($sqlm); |
| [278](#L278) | $tempbalance = $tempbalance - ($tempbalance \* $commission / 100); |
| [279](#L279) | $matured\_balance = $tempbalance - $total\_withdraws; |
| [280](#L280) |  |
| [281](#L281) | //finding pending balance |
| [282](#L282) | $pending\_balance = $balance - $matured\_balance; |
| [283](#L283) |  |
| [284](#L284) | $seller\_balances = array(); |
| [285](#L285) | $seller\_balances['pending'] = $pending\_balance; |
| [286](#L286) | $seller\_balances['matured'] = $matured\_balance; |
| [287](#L287) |  |
| [288](#L288) | return $seller\_balances; |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | //for withdraw request |
| [292](#L292) | function wpdmpp\_withdraw\_request() |
| [293](#L293) | { |
| [294](#L294) | global $wpdb, $current\_user; |
| [295](#L295) |  |
| [296](#L296) | $current\_user = wp\_get\_current\_user(); |
| [297](#L297) |  |
| [298](#L298) | $uid = $current\_user->ID; |
| [299](#L299) |  |
| [300](#L300) | if (isset($\_POST['withdraw'], $\_POST['withdraw\_amount']) && $\_POST['withdraw'] == 1 && $\_POST['withdraw\_amount'] > 0) { |
| [301](#L301) |  |
| [302](#L302) | // Check if matured balance is greater than 0 |
| [303](#L303) | $seller\_balances = wpdmpp\_seller\_balances(); |
| [304](#L304) | if ($seller\_balances['matured'] <= 0) { |
| [305](#L305) | echo 'denied'; |
| [306](#L306) | die(); |
| [307](#L307) | } |
| [308](#L308) | $payout\_method = wpdm\_query\_var('payout\_method', 'txt'); |
| [309](#L309) | $payment\_account = wpdm\_valueof(WPDMPP()->withdraws->payoutAccounts($current\_user->ID), $payout\_method); |
| [310](#L310) | if(!$payment\_account || !$payout\_method) { |
| [311](#L311) | wp\_send\_json(['success' => false, 'msg' => \_\_("Withdrawal Request Failed. No payout option selected!", "wpdm-premium-packages")]); |
| [312](#L312) | } |
| [313](#L313) | $wpdb->insert( |
| [314](#L314) | "{$wpdb->prefix}ahm\_withdraws", |
| [315](#L315) | array( |
| [316](#L316) | 'uid' => $uid, |
| [317](#L317) | 'date' => time(), |
| [318](#L318) | 'amount' => absint($\_POST['withdraw\_amount']), |
| [319](#L319) | 'payment\_method' => $payout\_method, |
| [320](#L320) | 'payment\_account' => $payment\_account, |
| [321](#L321) | 'status' => 0 |
| [322](#L322) | ), |
| [323](#L323) | array( |
| [324](#L324) | '%d', |
| [325](#L325) | '%d', |
| [326](#L326) | '%f', |
| [327](#L327) | '%s', |
| [328](#L328) | '%s', |
| [329](#L329) | '%d' |
| [330](#L330) | ) |
| [331](#L331) | ); |
| [332](#L332) |  |
| [333](#L333) | if (wpdm\_is\_ajax()) { |
| [334](#L334) | wp\_send\_json(['success' => true, 'msg' => \_\_("Withdrawal Request Sent!", "wpdm-premium-packages")]); |
| [335](#L335) | } |
| [336](#L336) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [337](#L337) | header("Location: " . $return); |
| [338](#L338) | die(); |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | } |
| [342](#L342) |  |
| [343](#L343) | function wpdmpp\_redirect($url) |
| [344](#L344) | { |
| [345](#L345) | if (!headers\_sent()) |
| [346](#L346) | header("location: " . $url); |
| [347](#L347) | else |
| [348](#L348) | echo "<script>location.href='{$url}';</script>"; |
| [349](#L349) | die(); |
| [350](#L350) | } |
| [351](#L351) |  |
| [352](#L352) | function wpdmpp\_js\_redirect($url) |
| [353](#L353) | { |
| [354](#L354) | echo "&nbsp;Redirecting...<script>location.href='{$url}';</script>"; |
| [355](#L355) | die(); |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | function wpdmpp\_members\_page() |
| [359](#L359) | { |
| [360](#L360) | $settings = get\_option('\_wpdmpp\_settings'); |
| [361](#L361) | return isset($settings['members\_page\_id']) ? get\_permalink($settings['members\_page\_id']) : wpdm\_user\_dashboard\_url(array('udb\_page' => 'account-credits')); |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | function wpdmpp\_checkout\_return\_url($payment, $order\_id = '') { |
| [365](#L365) | $gop = wpdmpp\_guest\_order\_page(); |
| [366](#L366) | $opu = !is\_user\_logged\_in() && get\_wpdmpp\_option('guest\_download') == 1 && $gop != '' ? $gop : wpdmpp\_orders\_page($order\_id); |
| [367](#L367) | $url = get\_wpdmpp\_option("{$payment}/return\_url", $opu); |
| [368](#L368) | $url = str\_replace("{{download\_page}}", "", $url); |
| [369](#L369) | return $url; |
| [370](#L370) | } |
| [371](#L371) |  |
| [372](#L372) | function wpdmpp\_orders\_page($part = '') |
| [373](#L373) | { |
| [374](#L374) | global $wpdmpp\_settings; |
| [375](#L375) | $settings = $wpdmpp\_settings; |
| [376](#L376) |  |
| [377](#L377) | $url = get\_permalink($settings['orders\_page\_id']); |
| [378](#L378) | if ($part != '') { |
| [379](#L379) | if (strpos($url, '?')) $url .= "&" . $part; |
| [380](#L380) | else $url .= "?" . $part; |
| [381](#L381) | } |
| [382](#L382) |  |
| [383](#L383) | $udbpage = get\_option('\_\_wpdm\_user\_dashboard', 0); |
| [384](#L384) | if ((int)$udbpage > 0 && (int)$settings['orders\_page\_id'] === (int)$udbpage) { |
| [385](#L385) |  |
| [386](#L386) | $udbpage = get\_permalink($udbpage); |
| [387](#L387) | $sap = strstr($udbpage, '?') ? "&udb\_page=" : "?udb\_page="; |
| [388](#L388) | $url = $udbpage . $sap . "purchases/orders/"; |
| [389](#L389) | if ($part != '') { |
| [390](#L390) | $part = explode("=", $part); |
| [391](#L391) | $url = $udbpage . $sap . "purchases/order/" . end($part) . "/"; |
| [392](#L392) | } |
| [393](#L393) | } |
| [394](#L394) | return $url; |
| [395](#L395) | } |
| [396](#L396) |  |
| [397](#L397) | function wpdmpp\_guest\_order\_page($part = '') |
| [398](#L398) | { |
| [399](#L399) | $settings = get\_option('\_wpdmpp\_settings'); |
| [400](#L400) | $url = get\_permalink($settings['guest\_order\_page\_id']); |
| [401](#L401) | if (!isset($settings['guest\_download']) || $settings['guest\_download'] == 0) return ''; |
| [402](#L402) | if ($part != '') { |
| [403](#L403) | if (strpos($url, '?')) $url .= "&" . $part; |
| [404](#L404) | else $url .= "?" . $part; |
| [405](#L405) | } |
| [406](#L406) | return $url; |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) | /\*\* |
| [410](#L410) | \* Returns cart page url |
| [411](#L411) | \* @param array $params |
| [412](#L412) | \* @return false|string |
| [413](#L413) | \*/ |
| [414](#L414) | function wpdmpp\_cart\_page($params = array()) |
| [415](#L415) | { |
| [416](#L416) | global $wpdmpp\_settings; |
| [417](#L417) | if (!$wpdmpp\_settings) |
| [418](#L418) | $wpdmpp\_settings = get\_option('\_wpdmpp\_settings'); |
| [419](#L419) |  |
| [420](#L420) | $url = get\_permalink($wpdmpp\_settings['page\_id']); |
| [421](#L421) |  |
| [422](#L422) | $url = add\_query\_arg($params, $url); |
| [423](#L423) |  |
| [424](#L424) | return $url; |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | function wpdmpp\_cart\_url($params = array()) |
| [428](#L428) | { |
| [429](#L429) | return wpdmpp\_cart\_page($params); |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | function wpdmpp\_checkout\_link($label = 'Checkout', $class = 'btn btn-info' ,$params = array()) |
| [433](#L433) | { |
| [434](#L434) | return "<a href='".wpdmpp\_cart\_page($params)."' class='{$class}'>{$label}</a>"; |
| [435](#L435) | } |
| [436](#L436) |  |
| [437](#L437) | function wpdmpp\_is\_cart\_page($id = null) |
| [438](#L438) | { |
| [439](#L439) | $id = $id ?: get\_the\_ID(); |
| [440](#L440) | $cart\_page\_id = (int)get\_wpdmpp\_option('page\_id'); |
| [441](#L441) | return $cart\_page\_id === (int)$id ? $cart\_page\_id : false; |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) |  |
| [445](#L445) | function wpdmpp\_continue\_shopping\_url($args = []) |
| [446](#L446) | { |
| [447](#L447) | $settings = get\_option('\_wpdmpp\_settings'); |
| [448](#L448) | return add\_query\_arg($args, get\_wpdmpp\_option('continue\_shopping\_url', home\_url('/'))); |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) |  |
| [452](#L452) | function wpdmpp\_save\_billing\_info() |
| [453](#L453) | { |
| [454](#L454) | global $current\_user; |
| [455](#L455) | $current\_user = wp\_get\_current\_user(); |
| [456](#L456) | if (isset($\_POST['\_\_wpdm\_store\_owner'])) |
| [457](#L457) | $\_\_wpdm\_store\_owner = isset($\_POST['\_\_wpdm\_store\_owner']) ? 1 : 0; |
| [458](#L458) | update\_user\_meta($current\_user->ID, '\_\_wpdm\_store\_owner', $\_\_wpdm\_store\_owner); |
| [459](#L459) | if (isset($\_POST['\_\_wpdm\_store'])) { |
| [460](#L460) | $store\_data = wpdm\_sanitize\_array($\_POST['\_\_wpdm\_store']); |
| [461](#L461) | update\_user\_meta($current\_user->ID, '\_\_wpdm\_store', $store\_data); |
| [462](#L462) | } |
| [463](#L463) | if (isset($\_POST['checkout']) && isset($\_POST['checkout']['billing'])) { |
| [464](#L464) | $codata = wpdm\_sanitize\_array($\_POST['checkout']); |
| [465](#L465) | update\_user\_meta($current\_user->ID, 'user\_billing\_shipping', serialize($codata)); |
| [466](#L466) | } |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | /\*\* |
| [470](#L470) | \* Get the list of purchased items of the current user |
| [471](#L471) | \*/ |
| [472](#L472) | function wpdmpp\_get\_purchased\_items() |
| [473](#L473) | { |
| [474](#L474) | if (!isset($\_GET['wpdmppaction']) || $\_GET['wpdmppaction'] != 'getpurchaseditems') return; |
| [475](#L475) | if (wpdm\_query\_var('user') != '') { |
| [476](#L476) | $user = wp\_signon(array('user\_login' => wpdm\_query\_var('user'), 'user\_password' => wpdm\_query\_var('pass'))); |
| [477](#L477) | if ($user->ID) wp\_set\_current\_user($user->ID); |
| [478](#L478) | } |
| [479](#L479) | if (wpdm\_query\_var('wpdm\_access\_token') != '') { |
| [480](#L480) | $at = wpdm\_query\_var('wpdm\_access\_token'); |
| [481](#L481) | if (!$at) die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [482](#L482) | $atx = explode("x", $at); |
| [483](#L483) | $uid = end($atx); |
| [484](#L484) | $uid = (int)$uid; |
| [485](#L485) | if (!$uid) die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [486](#L486) | $sat = get\_user\_meta($uid, '\_\_wpdm\_access\_token', true); |
| [487](#L487) | if ($sat === '') die(json\_encode(array('error' => 'Invalid Access Token!'))); |
| [488](#L488) | if ($sat === $at) |
| [489](#L489) | wp\_set\_current\_user($uid); |
| [490](#L490) | else |
| [491](#L491) | die(json\_encode(array('error' => "Invalid Access Token!"))); |
| [492](#L492) | } |
| [493](#L493) | if (is\_user\_logged\_in()) |
| [494](#L494) | wp\_send\_json(\WPDMPP\Libs\Order::getPurchasedItems()); |
| [495](#L495) | else |
| [496](#L496) | wp\_send\_json(array('error' => '<a href="https://www.wpdownloadmanager.com/user-dashboard/?redirect\_to=[redirect]">You need to login first!</a>')); |
| [497](#L497) | die(); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | /\*\* |
| [501](#L501) | \* Retrienve Site Commissions on User's Sales |
| [502](#L502) | \* @param null $uid |
| [503](#L503) | \* @return mixed |
| [504](#L504) | \*/ |
| [505](#L505) | function wpdmpp\_site\_commission($uid = null) |
| [506](#L506) | { |
| [507](#L507) | global $current\_user; |
| [508](#L508) | $current\_user = wp\_get\_current\_user(); |
| [509](#L509) | $user = $current\_user; |
| [510](#L510) | if ($uid) $user = get\_userdata($uid); |
| [511](#L511) | $role = array\_shift($user->roles); |
| [512](#L512) | $comission = get\_option("wpdmpp\_user\_comission"); |
| [513](#L513) | $comission = isset($comission[$role]) ? (double)$comission[$role] : 0; |
| [514](#L514) | return $comission; |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | function wpdmpp\_get\_user\_earning() |
| [518](#L518) | { |
| [519](#L519) |  |
| [520](#L520) | } |
| [521](#L521) |  |
| [522](#L522) |  |
| [523](#L523) | function wpdmpp\_product\_price($pid, $license = '') |
| [524](#L524) | { |
| [525](#L525) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [526](#L526) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [527](#L527) | $price = (double)($sales\_price) > 0 && $sales\_price < $base\_price ? (double)$sales\_price : (double)$base\_price; |
| [528](#L528) |  |
| [529](#L529) | if (floatval($price) == 0) return number\_format(0, 2, ".", ""); |
| [530](#L530) | return number\_format($price, 2, ".", ""); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | function wpdmpp\_is\_ajax() |
| [534](#L534) | { |
| [535](#L535) | if (!empty($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) && |
| [536](#L536) | strtolower($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) == 'xmlhttprequest' |
| [537](#L537) | ) return TRUE; |
| [538](#L538) | return false; |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) | //delete product from front-end |
| [542](#L542) | function wpdmpp\_delete\_product() |
| [543](#L543) | { |
| [544](#L544) | if (is\_user\_logged\_in() && isset($\_GET['dproduct'])) { |
| [545](#L545) | global $current\_user; |
| [546](#L546) | $current\_user = wp\_get\_current\_user(); |
| [547](#L547) | $pid = intval($\_GET['dproduct']); |
| [548](#L548) | $pro = get\_post($pid); |
| [549](#L549) |  |
| [550](#L550) | if ($current\_user->ID == $pro->post\_author) { |
| [551](#L551) | wp\_update\_post(array('ID' => $pid, 'post\_status' => 'trash')); |
| [552](#L552) | $settings = get\_option('\_wpdmpp\_settings'); |
| [553](#L553) | if ($settings['frontend\_product\_delete\_notify'] == 1) { |
| [554](#L554) | wp\_mail(get\_option('admin\_email'), "I had to delete a product", "Hi, Sorry, but I had to delete following product for some reason:<br/>{$pro->post\_title}", "From: {$current\_user->user\_email}\r\nContent-type: text/html\r\n\r\n"); |
| [555](#L555) | } |
| [556](#L556) | Session::set('dpmsg', \_\_('Product Deleted', 'wpdm-premium-packages')); |
| [557](#L557) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [558](#L558) | header("location: " . $return); |
| [559](#L559) | die(); |
| [560](#L560) | } |
| [561](#L561) | } |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | function wpdmpp\_order\_completed\_mail() |
| [565](#L565) | { |
| [566](#L566) |  |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | function wpdmpp\_head() |
| [570](#L570) | { |
| [571](#L571) | $wpdmpp\_txt = array( |
| [572](#L572) | 'cart\_button\_label' => get\_wpdmpp\_option('a2cbtn\_label', '<i class="fas fa-shopping-basket mr-2"></i>' . \_\_('Add To Cart', 'wpdm-premium-packages')), |
| [573](#L573) | 'pay\_now' => get\_wpdmpp\_option('cobtn\_label', \_\_('Complete Purchase', 'wpdm-premium-packages')), |
| [574](#L574) | 'checkout\_button\_label' => get\_wpdmpp\_option('cobtn\_label', \_\_('Complete Purchase', 'wpdm-premium-packages')), |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | ?> |
| [578](#L578) | <script> |
| [579](#L579) | var wpdmpp\_base\_url = '<?php echo plugins\_url('/wpdm-premium-packages/'); ?>'; |
| [580](#L580) | var wpdmpp\_currency\_sign = '<?php echo wpdmpp\_currency\_sign(); ?>'; |
| [581](#L581) | var wpdmpp\_csign\_before = '<?php echo wpdmpp\_currency\_sign\_position() == 'before' ? wpdmpp\_currency\_sign() : ''; ?>'; |
| [582](#L582) | var wpdmpp\_csign\_after = '<?php echo wpdmpp\_currency\_sign\_position() == 'after' ? wpdmpp\_currency\_sign() : ''; ?>'; |
| [583](#L583) | var wpdmpp\_currency\_code = '<?php echo wpdmpp\_currency\_code(); ?>'; |
| [584](#L584) | var wpdmpp\_cart\_url = '<?php echo wpdmpp\_cart\_page(); ?>'; |
| [585](#L585) |  |
| [586](#L586) | var wpdmpp\_txt = <?php echo json\_encode($wpdmpp\_txt); ?>; |
| [587](#L587) |  |
| [588](#L588) | </script> |
| [589](#L589) | <style>p.wpdmpp-notice { |
| [590](#L590) | margin: 5px; |
| [591](#L591) | } |
| [592](#L592) | .wpbtn-success { |
| [593](#L593) | color: var(--color-success) !important;border-color: var(--color-success ) !important; |
| [594](#L594) | background: rgba(var(--color-success-rgb),0.03) !important; |
| [595](#L595) | transition: all ease-in-out 300ms; |
| [596](#L596) | } |
| [597](#L597) | .wpbtn-success:active, |
| [598](#L598) | .wpbtn-success:hover { |
| [599](#L599) | color: var(--color-success-active) !important; |
| [600](#L600) | border-color: var(--color-success-active) !important; |
| [601](#L601) | background: rgba(var(--color-success-rgb),0.07) !important; |
| [602](#L602) | } |
| [603](#L603) | </style> |
| [604](#L604) | <?php |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | function wpdmpp\_admin\_footer() |
| [608](#L608) | { |
| [609](#L609) | global $pagenow; |
| [610](#L610) | if($pagenow !== 'edit.php' || wpdm\_query\_var('post\_type') !== 'wpdmpro') return; |
| [611](#L611) | ?> |
| [612](#L612) | <script> |
| [613](#L613) | jQuery(function ($) { |
| [614](#L614) | let $body = $('body'); |
| [615](#L615) |  |
| [616](#L616) | $('.page-title-action').after('<button data-toggle="modal" data-target="#modal-pay-link" type="button" class="page-title-action wpbtn-success wpbtn-pay-link"><?php echo \_\_('Create Pay Link', WPDM\_TEXT\_DOMAIN) ?></button>'); |
| [617](#L617) |  |
| [618](#L618) | $body.on('keyup', '.pla', function () { |
| [619](#L619) | let price = parseFloat($('#plprice').val()); |
| [620](#L620) | let title = $('#pltitle').val(); |
| [621](#L621) | let desc = $('#pldesc').val(); |
| [622](#L622) | let rec = $('#plrec').is(':checked') ? 1 : 0; |
| [623](#L623) | let plinnk = "<?= home\_url('/?addtocart=dynamic&price=') ?>" + price + '&name=' + title + '&desc=' + desc + '&recurring=0'; |
| [624](#L624) | $('#plink').val(plinnk); |
| [625](#L625) | }); |
| [626](#L626) |  |
| [627](#L627) | $body.on('submit', '#sendplink', function (e) { |
| [628](#L628) | e.preventDefault(); |
| [629](#L629) | let $plform = $(this); |
| [630](#L630) | WPDM.blockUI('#sendplink'); |
| [631](#L631) | $plform.ajaxSubmit({ |
| [632](#L632) | url: ajaxurl, |
| [633](#L633) | success: function ($) { |
| [634](#L634) | WPDM.notify('<?= \_\_('Payment link has been send successfully', WPDMPP\_TEXT\_DOMAIN) ?>', 'success', 'top-center', 6000); |
| [635](#L635) | WPDM.unblockUI('#sendplink'); |
| [636](#L636) | } |
| [637](#L637) | }); |
| [638](#L638) | }); |
| [639](#L639) |  |
| [640](#L640) |  |
| [641](#L641) | }); |
| [642](#L642) | </script> |
| [643](#L643) |  |
| [644](#L644) | <div class="w3eden"> |
| [645](#L645) | <div class="modal fade" tabindex="-1" role="dialog" id="modal-pay-link"> |
| [646](#L646) | <div class="modal-dialog" role="document" style="width: 400px"> |
| [647](#L647) | <form method="post" id="sendplink"> |
| [648](#L648) | <?php wp\_nonce\_field(WPDM\_PUB\_NONCE, 'plinknonce') ?> |
| [649](#L649) | <input type="hidden" name="action" value="wpdmpp\_email\_payment\_link" /> |
| [650](#L650) | <div class="modal-content"> |
| [651](#L651) | <div class="modal-header"> |
| [652](#L652) | <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> |
| [653](#L653) | <h4 class="modal-title"><?= \_\_('Create Payment Link', WPDMPP\_TEXT\_DOMAIN); ?></h4> |
| [654](#L654) | </div> |
| [655](#L655) | <div class="modal-body"> |
| [656](#L656) | <div class="panel panel-default"> |
| [657](#L657) | <div class="panel-heading"><?= \_\_('Payment Link Options', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [658](#L658) | <div class="panel-body"> |
| [659](#L659) | <div class="form-group"> |
| [660](#L660) | <label><?= \_\_('Price', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [661](#L661) | <input required="required" step="0.01" min="0" type="number" class="form-control pla" id="plprice" name="price" /> |
| [662](#L662) | </div> |
| [663](#L663) | <div class="form-group"> |
| [664](#L664) | <label><?= \_\_('Title', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [665](#L665) | <input required="required" type="text" placeholder="<?= \_\_('Reason form payment', WPDMPP\_TEXT\_DOMAIN) ?>" name="name" class="form-control pla" id="pltitle" /> |
| [666](#L666) | </div> |
| [667](#L667) | <div class="form-group"> |
| [668](#L668) | <label><?= \_\_('Description', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [669](#L669) | <input type="text" placeholder="<?= \_\_('You may add more details about this payment', WPDMPP\_TEXT\_DOMAIN) ?>" name="desc" class="form-control pla" id="pldesc" /> |
| [670](#L670) | </div> |
| [671](#L671) | <!--<div class="form-group"> |
| [672](#L672) | <label><input type="checkbox" value="1" id="plrec" /> <?/\*= \_\_('Recurring Payment', WPDMPP\_TEXT\_DOMAIN) \*/?></label> |
| [673](#L673) | </div>--> |
| [674](#L674) | </div> |
| [675](#L675) | </div> |
| [676](#L676) | <div class="form-group"> |
| [677](#L677) | <div class="panel panel-default"> |
| [678](#L678) | <div class="panel-heading"><?= \_\_('Generated Payment Link', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [679](#L679) | <div class="panel-body"> |
| [680](#L680) | <div class="input-group"> |
| [681](#L681) | <input type="text" readonly="readonly" class="form-control bg-white" id="plink" /> |
| [682](#L682) | <div class="input-group-btn"><button onclick="WPDM.copy('plink');" type="button" class="btn btn-info"><i class="fa fa-copy"></i></button></div> |
| [683](#L683) | </div> |
| [684](#L684) | </div> |
| [685](#L685) | </div> |
| [686](#L686) | </div> |
| [687](#L687) | <div class="form-group"> |
| [688](#L688) | <div class="panel panel-default"> |
| [689](#L689) | <div class="panel-heading"><?= \_\_('Email Payment Link', WPDMPP\_TEXT\_DOMAIN) ?></div> |
| [690](#L690) | <div class="panel-body"> |
| [691](#L691) | <div class="form-group"> |
| [692](#L692) | <label><?= \_\_('Note:', WPDMPP\_TEXT\_DOMAIN) ?></label> |
| [693](#L693) | <textarea placeholder="<?= esc\_attr\_\_('Write something about this payment request', WPDMPP\_TEXT\_DOMAIN) ?>" class="form-control" name="msg"></textarea> |
| [694](#L694) | </div> |
| [695](#L695) | <div class="input-group"> |
| [696](#L696) | <input name="emails" type="text" placeholder="<?= esc\_attr\_\_('Email(s)', WPDMPP\_TEXT\_DOMAIN) ?>" class="form-control" id="plink" /> |
| [697](#L697) | <div class="input-group-btn"><button type="submit" class="btn btn-info" id="send-plink"><i class="fa fa-paper-plane"></i> <?= \_\_('Send', WPDMPP\_TEXT\_DOMAIN); ?></button></div> |
| [698](#L698) | </div> |
| [699](#L699) | <em class="note"><?= \_\_('Multiple emails separate by comma', WPDMPP\_TEXT\_DOMAIN) ?></em> |
| [700](#L700) | </div> |
| [701](#L701) | </div> |
| [702](#L702) | </div> |
| [703](#L703) | </div> |
| [704](#L704) |  |
| [705](#L705) | </div><!-- /.modal-content --> |
| [706](#L706) | </form> |
| [707](#L707) | </div><!-- /.modal-dialog --> |
| [708](#L708) | </div><!-- /.modal --> |
| [709](#L709) | </div> |
| [710](#L710) |  |
| [711](#L711) | <?php |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) |  |
| [715](#L715) | function wpdmpp\_delete\_frontend\_order() |
| [716](#L716) | { |
| [717](#L717) | if (!wp\_verify\_nonce($\_REQUEST['nonce'], NONCE\_KEY)) { |
| [718](#L718) | exit("No naughty business please"); |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | $result['type'] = 'failed'; |
| [722](#L722) | global $wpdb; |
| [723](#L723) | $order\_id = sanitize\_text\_field(esc\_sql($\_REQUEST['order\_id'])); |
| [724](#L724) | $uid = get\_current\_user\_id(); |
| [725](#L725) | $ret = $wpdb->query($wpdb->prepare("DELETE FROM {$wpdb->prefix}ahm\_orders WHERE order\_id = %s and uid='$uid'", $order\_id)); |
| [726](#L726) |  |
| [727](#L727) | if ($ret) { |
| [728](#L728) | $ret = $wpdb->query($wpdb->prepare("DELETE FROM {$wpdb->prefix}ahm\_order\_items WHERE oid = %s", $order\_id)); |
| [729](#L729) |  |
| [730](#L730) | if ($ret) $result['type'] = 'success'; |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | if (!empty($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) && strtolower($\_SERVER['HTTP\_X\_REQUESTED\_WITH']) == 'xmlhttprequest') { |
| [734](#L734) | $result = json\_encode($result); |
| [735](#L735) | echo $result; |
| [736](#L736) | } else { |
| [737](#L737) | $return = isset($\_SERVER['HTTP\_REFERER']) ? $\_SERVER['HTTP\_REFERER'] : home\_url('/'); |
| [738](#L738) | header("Location: " . $return); |
| [739](#L739) | } |
| [740](#L740) |  |
| [741](#L741) | die(); |
| [742](#L742) | } |
| [743](#L743) |  |
| [744](#L744) |  |
| [745](#L745) | /\*\* |
| [746](#L746) | \* Update Guest Billing Info |
| [747](#L747) | \*/ |
| [748](#L748) | function wpdmpp\_update\_guest\_billing() |
| [749](#L749) | { |
| [750](#L750) | $billinginfo = array |
| [751](#L751) | ( |
| [752](#L752) | 'first\_name' => '', |
| [753](#L753) | 'last\_name' => '', |
| [754](#L754) | 'company' => '', |
| [755](#L755) | 'address\_1' => '', |
| [756](#L756) | 'address\_2' => '', |
| [757](#L757) | 'city' => '', |
| [758](#L758) | 'postcode' => '', |
| [759](#L759) | 'country' => '', |
| [760](#L760) | 'state' => '', |
| [761](#L761) | 'order\_email' => '', |
| [762](#L762) | 'email' => '', |
| [763](#L763) | 'phone' => '', |
| [764](#L764) | 'taxid' => '' |
| [765](#L765) | ); |
| [766](#L766) | $sbillinginfo = wpdm\_sanitize\_array($\_POST['billing']); |
| [767](#L767) | $billinginfo = shortcode\_atts($billinginfo, $sbillinginfo); |
| [768](#L768) | $oid = \WPDM\\_\_\Crypt::decrypt(wpdm\_query\_var('oid')); |
| [769](#L769) | \WPDMPP\Libs\Order::Update(array('billing\_info' => maybe\_serialize($billinginfo)), $oid); |
| [770](#L770) | die(\_\_('Billing info saved successfully!', WPDMPP\_TEXT\_DOMAIN)); |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | function wpdmpp\_recalculate\_sales() |
| [774](#L774) | { |
| [775](#L775) | if (!isset($\_POST['id'])) return; |
| [776](#L776) | global $wpdb; |
| [777](#L777) | $id = (int)$\_POST['id']; |
| [778](#L778) | $sql = "select sum(quantity\*price) as sales\_amount, sum(quantity) as sales\_quantity from {$wpdb->prefix}ahm\_order\_items oi, {$wpdb->prefix}ahm\_orders o where oi.oid = o.order\_id and oi.pid = {$id} and o.order\_status IN ('Completed', 'Expired')"; |
| [779](#L779) | $data = $wpdb->get\_row($sql); |
| [780](#L780) |  |
| [781](#L781) | header('Content-type: application/json'); |
| [782](#L782) | update\_post\_meta($id, '\_\_wpdm\_sales\_amount', $data->sales\_amount); |
| [783](#L783) | update\_post\_meta($id, '\_\_wpdm\_sales\_count', $data->sales\_quantity); |
| [784](#L784) | $data->sales\_amount = wpdmpp\_currency\_sign() . floatval($data->sales\_amount); |
| [785](#L785) | $data->sales\_quantity = intval($data->sales\_quantity); |
| [786](#L786) | echo json\_encode($data); |
| [787](#L787) | die(); |
| [788](#L788) | } |
| [789](#L789) |  |
| [790](#L790) | function wpdmpp\_sales\_price($pid) |
| [791](#L791) | { |
| [792](#L792) | $sales\_price = get\_post\_meta($pid, "\_\_wpdm\_sales\_price", true); |
| [793](#L793) | $sales\_price\_expire = get\_post\_meta($pid, "\_\_wpdm\_sales\_price\_expire", true); |
| [794](#L794) | if ($sales\_price\_expire != '') { |
| [795](#L795) | $sales\_price\_expire = strtotime($sales\_price\_expire); |
| [796](#L796) | if (time() > $sales\_price\_expire && $sales\_price\_expire > 0) $sales\_price = 0; |
| [797](#L797) | } |
| [798](#L798) | return number\_format((double)$sales\_price, 2, ".", ""); |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | function wpdmpp\_sales\_price\_info($product\_id) |
| [802](#L802) | { |
| [803](#L803) | $sales\_price\_expire = get\_post\_meta($product\_id, '\_\_wpdm\_sales\_price\_expire', true); |
| [804](#L804) | if ($sales\_price\_expire != '') |
| [805](#L805) | $sales\_price\_expire = strtotime($sales\_price\_expire); |
| [806](#L806) | $sales\_price\_info = $sales\_price\_expire != '' ? sprintf(\_\_("Sales price will expire on %s", "wpdm-premium-packages"), wp\_date(get\_option("date\_format") . " H:i", $sales\_price\_expire)) : \_\_("This is a discounted price for a limited time", "wpdm-premium-packages"); |
| [807](#L807) | $sales\_price\_info = apply\_filters("wpdmpp\_sales\_price\_info", $sales\_price\_info, $product\_id, $sales\_price\_expire); |
| [808](#L808) | return $sales\_price\_info; |
| [809](#L809) |  |
| [810](#L810) | } |
| [811](#L811) |  |
| [812](#L812) | /\*\* |
| [813](#L813) | \* @param $pid |
| [814](#L814) | \* @return string |
| [815](#L815) | \*/ |
| [816](#L816) | function wpdmpp\_effective\_price($pid) |
| [817](#L817) | { |
| [818](#L818) | global $current\_user; |
| [819](#L819) | $current\_user = wp\_get\_current\_user(); |
| [820](#L820) | if (get\_post\_type($pid) != 'wpdmpro') return 0; |
| [821](#L821) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [822](#L822) | $base\_price = $base\_price ? (double)$base\_price : 0; |
| [823](#L823) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [824](#L824) | $price = (double)($sales\_price) > 0 ? $sales\_price : $base\_price; |
| [825](#L825) | $role = is\_user\_logged\_in() && is\_array($current\_user->roles) && isset($current\_user->roles[0]) ? $current\_user->roles[0] : 'guest'; |
| [826](#L826) | $discount = maybe\_unserialize(get\_post\_meta($pid, '\_\_wpdm\_discount', true)); |
| [827](#L827) | if (!is\_array($discount) || count($discount) == 0) return number\_format((float)$price, 2, ".", ""); |
| [828](#L828) |  |
| [829](#L829) | $discount[$role] = isset($discount[$role]) ? $discount[$role] : 0; |
| [830](#L830) | $discount[$role] = (double)$discount[$role]; |
| [831](#L831) | $user\_discount = (($price \* $discount[$role]) / 100); |
| [832](#L832) | $price -= $user\_discount; |
| [833](#L833) |  |
| [834](#L834) | if (!$price) $price = 0; |
| [835](#L835) | return number\_format($price, 2, ".", ""); |
| [836](#L836) | } |
| [837](#L837) |  |
| [838](#L838) | /\*\* |
| [839](#L839) | \* @param $pid |
| [840](#L840) | \* @return int|mixed |
| [841](#L841) | \*/ |
| [842](#L842) | function wpdmpp\_role\_discount($pid, $name = false) |
| [843](#L843) | { |
| [844](#L844) | global $current\_user, $wp\_roles; |
| [845](#L845) | $current\_user = wp\_get\_current\_user(); |
| [846](#L846) | $role\_discount = 0; |
| [847](#L847) | $role\_name = ''; |
| [848](#L848) | //$role = ?$current\_user->roles[0]:'guest'; |
| [849](#L849) | $discount = maybe\_unserialize(get\_post\_meta($pid, '\_\_wpdm\_discount', true)); |
| [850](#L850) |  |
| [851](#L851) | $roles = $wp\_roles->role\_names; |
| [852](#L852) |  |
| [853](#L853) |  |
| [854](#L854) | if (is\_user\_logged\_in() && is\_array($discount)) { |
| [855](#L855) | foreach ($current\_user->roles as $role) { |
| [856](#L856) | if (isset($discount[$role]) && $discount[$role] > $role\_discount) { |
| [857](#L857) | $role\_discount = $discount[$role]; |
| [858](#L858) | $role\_name = isset($roles[$role]) ? $roles[$role] : $role; |
| [859](#L859) | } |
| [860](#L860) | } |
| [861](#L861) | } |
| [862](#L862) | if (!is\_user\_logged\_in() && is\_array($discount) && isset($discount['guest'])) $role\_discount = $discount['guest']; |
| [863](#L863) | if (!is\_array($discount) || count($discount) == 0) return 0; |
| [864](#L864) |  |
| [865](#L865) | return $name ? $role\_name : $role\_discount; |
| [866](#L866) | } |
| [867](#L867) |  |
| [868](#L868) |  |
| [869](#L869) | function wpdmpp\_price\_range($pid) |
| [870](#L870) | { |
| [871](#L871) | $pre\_licenses = wpdmpp\_get\_licenses(); |
| [872](#L872) | $license\_infs = get\_post\_meta($pid, "\_\_wpdm\_license", true); |
| [873](#L873) | $license\_infs = maybe\_unserialize($license\_infs); |
| [874](#L874) | $licprices = array(); |
| [875](#L875) |  |
| [876](#L876) | $base\_price = get\_post\_meta($pid, "\_\_wpdm\_base\_price", true); |
| [877](#L877) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [878](#L878) | $base\_price = intval($sales\_price) > 0 ? $sales\_price : $base\_price; |
| [879](#L879) |  |
| [880](#L880) | foreach ($pre\_licenses as $licid => $lic) { |
| [881](#L881) | if (isset($license\_infs[$licid]) && $license\_infs[$licid]['active'] == 1) { |
| [882](#L882) | $licprices[] = isset($license\_infs[$licid]['price']) ? $license\_infs[$licid]['price'] : $base\_price; |
| [883](#L883) | } |
| [884](#L884) | } |
| [885](#L885) |  |
| [886](#L886) | $price\_range = wpdmpp\_price\_format((float)$base\_price, true, true); |
| [887](#L887) |  |
| [888](#L888) | if (count($licprices) > 1 && get\_post\_meta($pid, "\_\_wpdm\_enable\_license", true) == 1) { |
| [889](#L889) | sort($licprices); |
| [890](#L890) | $fromprice = $licprices[0]; |
| [891](#L891) | $sales\_price = wpdmpp\_sales\_price($pid); |
| [892](#L892) | if ($sales\_price < $fromprice && $sales\_price > 0) $fromprice = $sales\_price; |
| [893](#L893) | $price\_range = wpdmpp\_price\_format($fromprice, true, true) . " &mdash; " . wpdmpp\_price\_format(end($licprices), true, true); |
| [894](#L894) | } |
| [895](#L895) | return $price\_range; |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | function wpdmpp\_order\_id() |
| [899](#L899) | { |
| [900](#L900) | return Session::get('orderid'); |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | function wpdmpp\_currency\_sign() |
| [904](#L904) | { |
| [905](#L905) | $settings = get\_option('\_wpdmpp\_settings'); |
| [906](#L906) | $currency = isset($settings['currency']) ? $settings['currency'] : 'USD'; |
| [907](#L907) | $cdata = \WPDMPP\Libs\Currencies::GetCurrency($currency); |
| [908](#L908) | $sign = is\_array($cdata) ? $cdata['symbol'] : '$'; |
| [909](#L909) | $sign = apply\_filters("wpdmpp\_currency\_sign", $sign); |
| [910](#L910) | return $sign; |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | function wpdmpp\_currency\_sign\_position() |
| [914](#L914) | { |
| [915](#L915) | $settings = get\_option('\_wpdmpp\_settings'); |
| [916](#L916) | $currency\_position = isset($settings['currency\_position']) ? $settings['currency\_position'] : 'before'; |
| [917](#L917) | return $currency\_position; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | function wpdmpp\_currency\_code() |
| [921](#L921) | { |
| [922](#L922) | $settings = get\_option('\_wpdmpp\_settings'); |
| [923](#L923) | $currency = isset($settings['currency']) ? $settings['currency'] : 'USD'; |
| [924](#L924) | $currency = apply\_filters("wpdmpp\_currency\_code", $currency); |
| [925](#L925) | return $currency; |
| [926](#L926) | } |
| [927](#L927) |  |
| [928](#L928) | /\*\* |
| [929](#L929) | \* Validating download request using 'wpdm\_onstart\_download' WPDM hook |
| [930](#L930) | \* @param $package |
| [931](#L931) | \* @return mixed |
| [932](#L932) | \*/ |
| [933](#L933) | function wpdmpp\_validate\_download($package) |
| [934](#L934) | { |
| [935](#L935) |  |
| [936](#L936) | $price = wpdmpp\_effective\_price($package['ID']); |
| [937](#L937) | if (floatval($price) > 0) { |
| [938](#L938) |  |
| [939](#L939) | // Check The Master Key |
| [940](#L940) | if (wpdm\_query\_var('masterkey') !== '' && WPDMPremiumPackage::authorize\_masterkey()) return $package; |
| [941](#L941) |  |
| [942](#L942) | // Validate Download Key |
| [943](#L943) | //wpdmdd(is\_wpdmkey\_valid($package['ID'], wpdm\_query\_var('\_wpdmkey'))); |
| [944](#L944) | //wpdmdd(get\_wpdmpp\_option('authorize\_masterkey')); |
| [945](#L945) | if (is\_wpdmkey\_valid($package['ID'], wpdm\_query\_var('\_wpdmkey')) === 1 && (int)get\_wpdmpp\_option('authorize\_masterkey') === 1) return $package; |
| [946](#L946) |  |
| [947](#L947) | if ( (int) Session::get('\_\_wpdmpp\_authorized\_download') === 1) return $package; |
| [948](#L948) |  |
| [949](#L949) | Messages::error('You do not have permission to download this file', 1); |
| [950](#L950) |  |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) | return $package; |
| [954](#L954) |  |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | /\*\* |
| [958](#L958) | \* Assign an order to specific user |
| [959](#L959) | \*/ |
| [960](#L960) | function wpdmpp\_assign\_user\_2order() |
| [961](#L961) | { |
| [962](#L962) | if (!current\_user\_can('manage\_options') || !wp\_verify\_nonce($\_REQUEST['\_\_nonce'], NONCE\_KEY)) { |
| [963](#L963) | Messages::error(\_\_('Unauthorized Operation!', 'wpdm-premium-packages'), 1); |
| [964](#L964) | } |
| [965](#L965) | $wpdmpp\_settings = get\_option('\_wpdmpp\_settings'); |
| [966](#L966) | if (isset($\_REQUEST['assignuser']) && isset($\_REQUEST['order'])) { |
| [967](#L967) | if (is\_email($\_REQUEST['assignuser'])) |
| [968](#L968) | $u = get\_user\_by('email', sanitize\_email($\_REQUEST['assignuser'])); |
| [969](#L969) | else |
| [970](#L970) | $u = get\_user\_by('login', sanitize\_text\_field($\_REQUEST['assignuser'])); |
| [971](#L971) | if (is\_object($u) && isset($u->ID)) { |
| [972](#L972) | $order = new \WPDMPP\Libs\Order(); |
| [973](#L973) | $oid = esc\_attr($\_REQUEST['order']); |
| [974](#L974) | $order->Update(array('uid' => $u->ID), sanitize\_text\_field($oid)); |
| [975](#L975) | $logo = isset($settings['logo\_url']) && $wpdmpp\_settings['logo\_url'] != "" ? "<img src='{$wpdmpp\_settings['logo\_url']}' alt='" . get\_bloginfo('name') . "'/>" : get\_bloginfo('name'); |
| [976](#L976) | $params = array( |
| [977](#L977) | 'date' => wp\_date(get\_option('date\_format'), time()), |
| [978](#L978) | 'homeurl' => home\_url('/'), |
| [979](#L979) | 'sitename' => get\_bloginfo('name'), |
| [980](#L980) | 'order\_link' => "<a href='" . wpdmpp\_orders\_page('id=' . $oid) . "'>" . wpdmpp\_orders\_page('id=' . $oid) . "</a>", |
| [981](#L981) | 'register\_link' => "<a href='" . wpdmpp\_orders\_page('orderid=' . $oid) . "'>" . wpdmpp\_orders\_page('orderid=' . $oid) . "</a>", |
| [982](#L982) | 'name' => $u->user\_login, |
| [983](#L983) | 'orderid' => $oid, |
| [984](#L984) | 'to\_email' => $u->user\_email, |
| [985](#L985) | 'order\_url' => wpdmpp\_orders\_page('id=' . $oid), |
| [986](#L986) | 'order\_url\_admin' => admin\_url('edit.php?post\_type=wpdmpro&page=orders&task=vieworder&id=' . $oid), |
| [987](#L987) | 'img\_logo' => $logo |
| [988](#L988) | ); |
| [989](#L989) | \WPDMPP\Libs\User::addCustomer($u); |
| [990](#L990) | \WPDM\\_\_\Email::send("purchase-confirmation", $params); |
| [991](#L991) | die('<div class="color-green" style="padding: 7px 15px;margin: 0;border-radius: 2px">Order Is Linked to ' . esc\_attr($\_REQUEST['assignuser']) . "</div>"); |
| [992](#L992) | } else |
| [993](#L993) | die('<div class="alert alert-danger" style="padding: 7px 15px;background: rgba(255,0,23,0.05);margin: 0;border-radius: 2px">' . \_\_('User Not Found!', 'wpdm-premium-packages') . '</div>'); |
| [994](#L994) | } |
| [995](#L995) | } |
| [996](#L996) |  |
| [997](#L997) |  |
| [998](#L998) | function wpdmpp\_download\_order\_note\_attachment() |
| [999](#L999) | { |
| [1000](#L1000) | global $current\_user; |
| [1001](#L1001) | $current\_user = wp\_get\_current\_user(); |
| [1002](#L1002) | if (!isset($\_GET['\_atcdl']) || !is\_user\_logged\_in()) return false; |
| [1003](#L1003) | $key = \WPDM\\_\_\Crypt::Decrypt(esc\_attr($\_GET['\_atcdl'])); |
| [1004](#L1004) | $key = explode("|||", $key); |
| [1005](#L1005) | $order = new \WPDMPP\Libs\Order($key[0]); |
| [1006](#L1006) | if ($order->uid != $current\_user->ID && !current\_user\_can('manage\_options')) wp\_die('Unauthorized Access'); |
| [1007](#L1007) | $files = $order->order\_notes['messages'][$key[1]]['file']; |
| [1008](#L1008) | $filename = preg\_replace("/^[0-9]+?wpdm\_/", "", wpdm\_basename($key[2])); |
| [1009](#L1009) | if (in\_array($key[2], $files)) { |
| [1010](#L1010) | wpdm\_download\_file(UPLOAD\_DIR . $key[2], $filename); |
| [1011](#L1011) | die(); |
| [1012](#L1012) | } |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | /\*\* |
| [1016](#L1016) | \* Return array of country objects |
| [1017](#L1017) | \* @return array |
| [1018](#L1018) | \*/ |
| [1019](#L1019) | function wpdmpp\_get\_countries() |
| [1020](#L1020) | { |
| [1021](#L1021) | global $wpdb; |
| [1022](#L1022) | $countries = $wpdb->get\_results("select \* from {$wpdb->prefix}ahm\_country order by country\_name"); |
| [1023](#L1023) |  |
| [1024](#L1024) | return $countries; |
| [1025](#L1025) | } |
| [1026](#L1026) |  |
| [1027](#L1027) | /\*\* |
| [1028](#L1028) | \* Return Premium Package Template Directory |
| [1029](#L1029) | \* @return string |
| [1030](#L1030) | \*/ |
| [1031](#L1031) | function wpdmpp\_tpl\_dir() |
| [1032](#L1032) | { |
| [1033](#L1033) | return WPDMPP\_TPL\_DIR; |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) | function wpdmpp\_email\_template\_tags($tags) |
| [1037](#L1037) | { |
| [1038](#L1038) | $tags["{{orderid}}"] = array('value' => '', 'desc' => 'Order ID'); |
| [1039](#L1039) | $tags["{{items}}"] = array('value' => '', 'desc' => 'List of purchased items'); |
| [1040](#L1040) | $tags["{{order\_url}}"] = array('value' => '', 'desc' => 'Order URL'); |
| [1041](#L1041) | $tags["{{guest\_order\_url}}"] = array('value' => '', 'desc' => 'Guest Order URL'); |
| [1042](#L1042) | return $tags; |
| [1043](#L1043) | } |
| [1044](#L1044) |  |
| [1045](#L1045) | function wpdmpp\_email\_templates($templates) |
| [1046](#L1046) | { |
| [1047](#L1047) | $templates['purchase-confirmation-guest'] = array( |
| [1048](#L1048) | 'label' => \_\_('Purchase Confirmation - Guest', 'wpdmpro'), |
| [1049](#L1049) | 'for' => 'customer', |
| [1050](#L1050) | 'plugin' => 'Premium Packages', |
| [1051](#L1051) | 'default' => array('subject' => \_\_('Thanks For Your Purchase', 'wpdmpro'), |
| [1052](#L1052) | 'from\_name' => get\_option('blogname'), |
| [1053](#L1053) | 'from\_email' => get\_option('admin\_email'), |
| [1054](#L1054) | 'message' => 'Hello ,<br/>Thanks for your order at [#sitename#].<br/>Your Order ID: [#orderid#]<br/>Purchased Items:<br/>[#items#]<br/>You need to create an account to access your order and to get future updates.<br/>Please click on the following link to create your account:<br/><a class="button green" style="display: block; text-align: center;" href="[#order\_url#]">Signup</a>If you already have account simply click the above url and login<br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1055](#L1055) | ) |
| [1056](#L1056) | ); |
| [1057](#L1057) |  |
| [1058](#L1058) | $templates['purchase-confirmation'] = array( |
| [1059](#L1059) | 'label' => \_\_('Purchase Confirmation', 'wpdmpro'), |
| [1060](#L1060) | 'for' => 'customer', |
| [1061](#L1061) | 'plugin' => 'Premium Packages', |
| [1062](#L1062) | 'default' => array('subject' => \_\_('Thanks For Your Purchase', 'wpdmpro'), |
| [1063](#L1063) | 'from\_name' => get\_option('blogname'), |
| [1064](#L1064) | 'from\_email' => get\_option('admin\_email'), |
| [1065](#L1065) | 'message' => 'Hello ,<br/>Thanks for your order at [#sitename#].<br/>Your Order ID: [#orderid#]<br/>Purchased Items:<br/>[#items#]<br/>You can download your purchased item(s) from the following link:<br/><a href="[#order\_url#]">[#order\_url#]</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1066](#L1066) | ) |
| [1067](#L1067) | ); |
| [1068](#L1068) |  |
| [1069](#L1069) | $templates['subscription-reminder'] = array( |
| [1070](#L1070) | 'label' => \_\_('Subscription Reminder', 'wpdmpro'), |
| [1071](#L1071) | 'for' => 'customer', |
| [1072](#L1072) | 'plugin' => 'Premium Packages', |
| [1073](#L1073) | 'default' => array('subject' => \_\_('[#sitename#] Subscription Reminder', 'wpdmpro'), |
| [1074](#L1074) | 'from\_name' => get\_option('blogname'), |
| [1075](#L1075) | 'from\_email' => get\_option('admin\_email'), |
| [1076](#L1076) | 'message' => 'Hello,<br/>Thanks for your continued support.<br/>We\'re sending this message to remind you that, as your subscription is active, your Order# [#orderid#] will be renewed automatically on [#expire\_date#]. <br/><br/><strong>Associated Items:</strong><hr/>[#items#]<hr/><br/> <a href="[#order\_url#]" style="display: block;text-align: center" class="button">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1077](#L1077) | ) |
| [1078](#L1078) | ); |
| [1079](#L1079) |  |
| [1080](#L1080) | $templates['renew-confirmation'] = array( |
| [1081](#L1081) | 'label' => \_\_('Order Renew Confirmation', 'wpdmpro'), |
| [1082](#L1082) | 'for' => 'customer', |
| [1083](#L1083) | 'plugin' => 'Premium Packages', |
| [1084](#L1084) | 'default' => array('subject' => \_\_('Order Renewed Successfully', 'wpdmpro'), |
| [1085](#L1085) | 'from\_name' => get\_option('blogname'), |
| [1086](#L1086) | 'from\_email' => get\_option('admin\_email'), |
| [1087](#L1087) | 'message' => 'Hello,<br/>Thanks for your continued support.<br/>Your Order# [#orderid#] is renewed successfully.<br/>As always, you can download the latest version from the following link:<br/><a href="[#order\_url#]">[#order\_url#]</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1088](#L1088) | ) |
| [1089](#L1089) | ); |
| [1090](#L1090) |  |
| [1091](#L1091) | $templates['sale-notification'] = array( |
| [1092](#L1092) | 'label' => \_\_('New Sale Notification', 'wpdmpro'), |
| [1093](#L1093) | 'for' => 'admin', |
| [1094](#L1094) | 'plugin' => 'Premium Packages', |
| [1095](#L1095) | 'default' => array('subject' => \_\_('Congratulations! You have a sale.', 'wpdmpro'), |
| [1096](#L1096) | 'from\_name' => get\_option('blogname'), |
| [1097](#L1097) | 'from\_email' => get\_option('admin\_email'), |
| [1098](#L1098) | 'to\_email' => get\_option('admin\_email'), |
| [1099](#L1099) | 'message' => 'Hello ,<br/>Congratulations! You have a sale just now.<br/>Order ID: [#orderid#]<br/>Sold Items:<br/>[#items#]<br/>Review Order: [#order\_url\_admin#]' |
| [1100](#L1100) | ) |
| [1101](#L1101) | ); |
| [1102](#L1102) |  |
| [1103](#L1103) | $templates['sale-notification-seller'] = array( |
| [1104](#L1104) | 'label' => \_\_('New Sale Notification', 'wpdmpro'), |
| [1105](#L1105) | 'for' => 'seller', |
| [1106](#L1106) | 'plugin' => 'Premium Packages', |
| [1107](#L1107) | 'default' => array('subject' => \_\_('Congratulations! You have a sale.', 'wpdmpro'), |
| [1108](#L1108) | 'from\_name' => get\_option('blogname'), |
| [1109](#L1109) | 'from\_email' => get\_option('admin\_email'), |
| [1110](#L1110) | 'to\_email' => get\_option('admin\_email'), |
| [1111](#L1111) | 'message' => 'Hello ,<br/>Congratulations! You have a sale just now.<br/>Order ID: [#orderid#]<br/>Sold Items:<br/>[#items#]<br/>Review Order: [#order\_url\_seller#]' |
| [1112](#L1112) | ) |
| [1113](#L1113) | ); |
| [1114](#L1114) |  |
| [1115](#L1115) | $templates['os-notification'] = array( |
| [1116](#L1116) | 'label' => \_\_('Order Status Notification', 'wpdmpro'), |
| [1117](#L1117) | 'for' => 'customer', |
| [1118](#L1118) | 'plugin' => 'Premium Packages', |
| [1119](#L1119) | 'default' => array('subject' => \_\_('Order ([#orderid#]) Status Changed', 'wpdmpro'), |
| [1120](#L1120) | 'from\_name' => get\_option('blogname'), |
| [1121](#L1121) | 'from\_email' => get\_option('admin\_email'), |
| [1122](#L1122) | 'message' => 'Hello ,<br/>The order <strong>[#orderid#]</strong> is changed to <strong>[#order\_status#]</strong><br/>Review Order: <a class="button button-green green" style="margin: 15px 0;display: block;text-align: center" href="[#order\_url#]">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1123](#L1123) | ) |
| [1124](#L1124) | ); |
| [1125](#L1125) |  |
| [1126](#L1126) | $templates['order-expire'] = array( |
| [1127](#L1127) | 'label' => \_\_('Order Expiry Notification', 'wpdmpro'), |
| [1128](#L1128) | 'for' => 'customer', |
| [1129](#L1129) | 'plugin' => 'Premium Packages', |
| [1130](#L1130) | 'default' => array('subject' => \_\_('Your order is about to expire', 'wpdmpro'), |
| [1131](#L1131) | 'from\_name' => get\_option('blogname'), |
| [1132](#L1132) | 'from\_email' => get\_option('admin\_email'), |
| [1133](#L1133) | 'message' => 'Hello [#name#],<br/>Your order is about to expire.<br/>Order# [#orderid#]<br/><br/>Purchased Items# [#order\_items#]<br/>Please renew your order to get continuous support and updates.<br/><a class="button" href="[#order\_url#]">Renew Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1134](#L1134) | ) |
| [1135](#L1135) | ); |
| [1136](#L1136) |  |
| [1137](#L1137) | /\*$templates['email-saved-cart'] = array( |
| [1138](#L1138) | 'label' => \_\_('Email Saved Cart', 'wpdm-premium-packages'), |
| [1139](#L1139) | 'for' => 'customer', |
| [1140](#L1140) | 'plugin' => 'Premium Packages', |
| [1141](#L1141) | 'default' => array( |
| [1142](#L1142) | 'subject' => \_\_('Someone sent you a cart!', 'wpdm-premium-packages'), |
| [1143](#L1143) | 'from\_name' => get\_option('blogname'), |
| [1144](#L1144) | 'from\_email' => get\_option('admin\_email'), |
| [1145](#L1145) | 'message' => 'Hello,<br/>Someone sent you a cart from [#sitename#]:<br/>View Cart & Checkout from here:<br/><b><a href="[#carturl#]">[#carturl#]</a></b><br/>Best Regards,<br/>Sales Team<br/><b>[#sitename#]</b>' |
| [1146](#L1146) | ) |
| [1147](#L1147) | );\*/ |
| [1148](#L1148) |  |
| [1149](#L1149) | $templates['recovered-order-confirmation'] = array( |
| [1150](#L1150) | 'label' => \_\_('Recovered Order Confirmation', 'wpdmpro'), |
| [1151](#L1151) | 'for' => 'admin', |
| [1152](#L1152) | 'plugin' => 'Premium Packages', |
| [1153](#L1153) | 'default' => array('subject' => \_\_('Congratulation! Order recovered successfully', 'wpdmpro'), |
| [1154](#L1154) | 'from\_name' => get\_option('blogname'), |
| [1155](#L1155) | 'from\_email' => get\_option('admin\_email'), |
| [1156](#L1156) | 'message' => '<strong>Congratulation!</strong><br/>The following order has been recovered successfully.<br/>Order# {{orderid}}<br/><br/>Purchased Items# {{items}}<br/>Keep up good works!<br/><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{order\_url}}">Review Order</a><br/><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>' |
| [1157](#L1157) | ) |
| [1158](#L1158) | ); |
| [1159](#L1159) |  |
| [1160](#L1160) | $acre\_count = get\_wpdmpp\_option('acre\_count', 0, 'int'); |
| [1161](#L1161) | $acre\_msg\_template = [ |
| [1162](#L1162) | 1 => 'Hello {{name}},<br/>It looks like you haven’t finished checking out yet. The good news? We saved your cart for you. Go on and complete your order now before your cart expires.<br/>Your cart:<br/>{{items}}<b><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{checkout\_url}}">Checkout Now!</a></b><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>', |
| [1163](#L1163) | 2 => 'Hello {{name}},<br/>Thought, you have missed my last email. The good news? We saved your cart for you. Go on and complete your order now before your cart expires.<br/>Your cart:<br/>{{items}}<b><a style="display:block;text-align: center;margin-top: 15px;" class="button btn button-green" href="{{checkout\_url}}">Checkout Now!</a></b><br/>Best Regards,<br/>Sales Team<br/><b>{{sitename}}</b>', |
| [1164](#L1164) | ]; |
| [1165](#L1165) | if($acre\_count > 0) { |
| [1166](#L1166) | for ($acre = 1; $acre <= $acre\_count; $acre++) { |
| [1167](#L1167) | $templates['order-recovery-email-'.$acre] = array( |
| [1168](#L1168) | 'label' => sprintf(\_\_('Abandoned Order Recovery Email %s', 'wpdm-premium-packages'), $acre), |
| [1169](#L1169) | 'for' => 'customer', |
| [1170](#L1170) | 'plugin' => 'Premium Packages', |
| [1171](#L1171) | 'default' => array( |
| [1172](#L1172) | 'subject' => \_\_('Your cart is waiting for you!', 'wpdm-premium-packages'), |
| [1173](#L1173) | 'from\_name' => get\_option('blogname'), |
| [1174](#L1174) | 'from\_email' => get\_option('admin\_email'), |
| [1175](#L1175) | 'message' => wpdm\_valueof($acre\_msg\_template, $acre, "Add your abandoned order recovery email content # {$acre}") |
| [1176](#L1176) | ) |
| [1177](#L1177) | ); |
| [1178](#L1178) | } |
| [1179](#L1179) | } |
| [1180](#L1180) |  |
| [1181](#L1181) | return $templates; |
| [1182](#L1182) | } |
| [1183](#L1183) |  |
| [1184](#L1184) | function wpdmpp\_reactivate() |
| [1185](#L1185) | { |
| [1186](#L1186) | return \_\_("Database error detected. Please try deactivate and then reactivating plugin.", "wpdm-premium-packages"); |
| [1187](#L1187) | } |
| [1188](#L1188) |  |
| [1189](#L1189) | function wpdmpp\_expiry\_check() |
| [1190](#L1190) | { |
| [1191](#L1191) | $order = new \WPDMPP\Libs\Order(); |
| [1192](#L1192) | $uid = get\_current\_user\_id(); |
| [1193](#L1193) | $orders = $order->getOrders($uid); |
| [1194](#L1194) | foreach ($orders as $\_order) { |
| [1195](#L1195) | $expire\_date = $\_order->expire\_date > 0 ? $\_order->expire\_date : $\_order->date + (get\_wpdmpp\_option('order\_validity\_period', 365) \* 86400); |
| [1196](#L1196) | if (time() > $expire\_date && $\_order->order\_status != 'Expired') { |
| [1197](#L1197) | $order->Update(array('order\_status' => 'Expired', 'payment\_status' => 'Expired', 'expire\_date' => $expire\_date), $\_order->order\_id); |
| [1198](#L1198) | } |
| [1199](#L1199) | } |
| [1200](#L1200) |  |
| [1201](#L1201) | } |
| [1202](#L1202) |  |
| [1203](#L1203) | function wpdmpp\_sanitize\_alphanum($id) |
| [1204](#L1204) | { |
| [1205](#L1205) | return preg\_replace('/[^a-zA-Z0-9 -]/', "", $id); |
| [1206](#L1206) | } |
| [1207](#L1207) |  |
| [1208](#L1208) | /\*\* |
| [1209](#L1209) | \* @usage Format price |
| [1210](#L1210) | \* @param $price |
| [1211](#L1211) | \* @return string |
| [1212](#L1212) | \*/ |
| [1213](#L1213) | function wpdmpp\_price\_format($price, $currency\_sign = true, $thousand\_separator = true) |
| [1214](#L1214) | { |
| [1215](#L1215) | $ts = $thousand\_separator ? get\_wpdmpp\_option('thousand\_separator') : ''; |
| [1216](#L1216) | $ds = $thousand\_separator ? get\_wpdmpp\_option('decimal\_separator') : '.'; |
| [1217](#L1217) | $dp = $thousand\_separator ? (int)get\_wpdmpp\_option('decimal\_points') : 2; |
| [1218](#L1218) | $currency\_sign = $currency\_sign === true ? wpdmpp\_currency\_sign() : $currency\_sign; |
| [1219](#L1219) | $price = (double)$price; |
| [1220](#L1220) | $price = number\_format($price, $dp, $ds, $ts); |
| [1221](#L1221) | return (get\_wpdmpp\_option('currency\_position', 'before') === 'before') ? $currency\_sign . $price : $price . $currency\_sign; |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | function wpdmppdl\_encode($content) { |
| [1225](#L1225) | $content = json\_encode($content); |
| [1226](#L1226) | $content = base64\_encode($content); |
| [1227](#L1227) | $content = trim($content, '='); |
| [1228](#L1228) | return $content; |
| [1229](#L1229) | } |
| [1230](#L1230) | function wpdmppdl\_decode($cyper) { |
| [1231](#L1231) | $jsonstr = base64\_decode($cyper); |
| [1232](#L1232) | $json = json\_decode($jsonstr, true); |
| [1233](#L1233) | return $json; |
| [1234](#L1234) | } |
| [1235](#L1235) |  |
| [1236](#L1236) | /\*\* |
| [1237](#L1237) | \* @usage Generate ordinal number |
| [1238](#L1238) | \* @param $number |
| [1239](#L1239) | \* @return string |
| [1240](#L1240) | \*/ |
| [1241](#L1241) | function wpdmpp\_ordinal($number) |
| [1242](#L1242) | { |
| [1243](#L1243) | $ends = array('th', 'st', 'nd', 'rd', 'th', 'th', 'th', 'th', 'th', 'th'); |
| [1244](#L1244) | if ((($number % 100) >= 11) && (($number % 100) <= 13)) |
| [1245](#L1245) | return $number . 'th'; |
| [1246](#L1246) | else |
| [1247](#L1247) | return $number . $ends[$number % 10]; |
| [1248](#L1248) | } |
| [1249](#L1249) |  |
| [1250](#L1250) | function wpdmpp\_forex\_rate($from, $to) |
| [1251](#L1251) | { |
| [1252](#L1252) | $rate = get\_option("wppm\_fx\_rate\_{$from}\_{$to}"); |
| [1253](#L1253) | if(is\_array($rate) && isset($rate['expire']) && $rate['expire'] > time()) |
| [1254](#L1254) | return $rate['rate']; |
| [1255](#L1255) |  |
| [1256](#L1256) | $curl = curl\_init(); |
| [1257](#L1257) |  |
| [1258](#L1258) | curl\_setopt\_array($curl, [ |
| [1259](#L1259) | CURLOPT\_URL => "https://v6.exchangerate-api.com/v6/e8767d62e2b5de59e1b9093c/pair/{$from}/{$to}", |
| [1260](#L1260) | CURLOPT\_RETURNTRANSFER => true, |
| [1261](#L1261) | CURLOPT\_FOLLOWLOCATION => true, |
| [1262](#L1262) | CURLOPT\_ENCODING => "", |
| [1263](#L1263) | CURLOPT\_MAXREDIRS => 10, |
| [1264](#L1264) | CURLOPT\_TIMEOUT => 30, |
| [1265](#L1265) | CURLOPT\_HTTP\_VERSION => CURL\_HTTP\_VERSION\_1\_1, |
| [1266](#L1266) | CURLOPT\_CUSTOMREQUEST => "GET" |
| [1267](#L1267) | ]); |
| [1268](#L1268) |  |
| [1269](#L1269) | $response = curl\_exec($curl); |
| [1270](#L1270) | $err = curl\_error($curl); |
| [1271](#L1271) |  |
| [1272](#L1272) | curl\_close($curl); |
| [1273](#L1273) | $response = json\_decode($response); |
| [1274](#L1274) | update\_option("wppm\_fx\_rate\_{$from}\_{$to}",  ['rate' => $response->conversion\_rate, 'expire' => time() + 28800]); |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) |  |
| [1278](#L1278) |  |
| [1279](#L1279) | function wpdmpp\_search\_products($keyword = '') |
| [1280](#L1280) | { |
| [1281](#L1281) | $keyword = wpdm\_query\_var('search') ? : $keyword; |
| [1282](#L1282) | if($keyword) { |
| [1283](#L1283) | $query = new Query(); |
| [1284](#L1284) | $query->search($keyword); |
| [1285](#L1285) | $query->meta('\_\_wpdm\_base\_price', 0, '>'); |
| [1286](#L1286) | $query->meta\_relation('AND'); |
| [1287](#L1287) | $query->process(); |
| [1288](#L1288) | $packages = $query->packages(); |
| [1289](#L1289) | foreach ($packages as &$package) { |
| [1290](#L1290) | $package->license = wpdmpp\_product\_license\_options($package->ID); |
| [1291](#L1291) | } |
| [1292](#L1292) | wp\_send\_json(['total' => $query->count, 'packages' => $query->packages(), 'q' => $query->params]); |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) |  |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php?format=txt)
* [Original Format](/export/3222484/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_da91fd93_20250114_215755.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Premium Packages – Sell Digital Products Securely <= 5.9.3 - Reflected Cross-Site Scripting via add\_query\_arg

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Premium Packages – Sell Digital Products Securely <= 5.9.3 - Reflected Cross-Site Scripting via add\_query\_arg

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-11225](https://www.cve.org/CVERecord?id=CVE-2024-11225) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | November 21, 2024 |
| Last Updated | November 25, 2024 |
| Researcher | [Peter Thaleikis](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/spek) |

### Description

The Premium Packages – Sell Digital Products Securely plugin for WordPress is vulnerable to Reflected Cross-Site Scripting due to the use of add\_query\_arg without appropriate escaping on the URL in all versions up to, and including, 5.9.3. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php#L584)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php#L420)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wpdm-premium-packages/tags/5.9.3/includes/libs/functions.php#L422)
* [wordpress.org](https://wordpress.org/plugins/wpdm-premium-packages/#developers)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3195568/wpdm-premium-packages/trunk/includes/libs/functions.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdm-premium-packages%2Fpremium-packages-sell-digital-products-securely-593-reflected-cross-site-scripting-via-add-query-arg&t=Premium%20Packages%20%E2%80%93%20Sell%20Digital%20Products%20Securely%20%3C%3D%205.9.3%20-%20Reflected%20Cross-Site%20Scripting%20via%20add_query_arg "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdm-premium-packages%2Fpremium-packages-sell-digital-products-securely-593-reflected-cross-site-scripting-via-add-query-arg&text=Premium%20Packages%20%E2%80%93%20Sell%20Digital%20Products%20Securely%20%3C%3D%205.9.3%20-%20Reflected%20Cross-Site%20Scripting%20via%20add_query_arg "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwpdm-premium-packages%2Fpremium-packages-sell-digital-products-securely-593-reflected-cross-site-scripting-via-add-query-arg "LinkedIn")
Email

## Vulnerability Details for Premium Packages – Sell Digital Products Securely

#### [Premium Packages – Sell Digital Products Securely](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wpdm-premium-packages)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wpdm-premium-packages [(view on wordpress.org)](https://wordpress.org/plugins/wpdm-premium-packages) |
| Patched? | Yes |
| Remediation | Update to version 5.9.4, or a newer patched version |
| Affected Version | * <= 5.9.3 |
| Patched Version | * 5.9.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from wordpress.org_4c678f85_20250114_215752.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

Premium Packages – Sell Digital Products Securely

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fwpdm-premium-packages&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fwpdm-premium-packages&locale=en_US)

Search plugins

![](https://ps.w.org/wpdm-premium-packages/assets/banner-772x250.png?rev=2801020)
![](https://ps.w.org/wpdm-premium-packages/assets/icon-256x256.png?rev=1989885)
# Premium Packages – Sell Digital Products Securely

By [WordPress Download Manager](https://www.wpdownloadmanager.com/)

[Download](https://downloads.wordpress.org/plugin/wpdm-premium-packages.5.9.7.zip)

* [Details](https://wordpress.org/plugins/wpdm-premium-packages/#description)
* [Reviews](https://wordpress.org/plugins/wpdm-premium-packages/#reviews)
* [Development](https://wordpress.org/plugins/wpdm-premium-packages/#developers)

[Support](https://wordpress.org/support/plugin/wpdm-premium-packages/)

## Description

Use WPDM – Premium Packages plugin to convert your [Download Manager](https://wordpress.org/plugins/download-manager/) into a complete e-Commerce Solution for selling digital products. Simply put a price when you need to sell a digital item. You also may use license ( ex: Simple, Extended, Unlimited ) based prices for a product. Users can directly download free items and when an item has a price user will have to go through cart & checkout. WordPress Download Manager has the easiest checkout option to give the user better experience in purchasing an item and which always increase the probability of successful completion of an order.

#### Features

WordPress Download Manager & Premium Package Add-on gives you the perfect WordPress Digital Store Solution to convert your site into a digital store just in a few clicks:

#### Shopping Cart

Full featured shopping cart with integrated PayPal payment system to sell your packages/products.

Full-featured order management system to manage orders for premium packages. (premium package add-on)

#### Order & Invoice Management

Extended order and invoice management options, multiple invoice templates with customization options.

WordPress Download Manager Sales Report

#### Sales Report

A full detailed report on sale and orders. Generate custom chart or graph report for site-wide sales or shop specific or product specific sale easily.

WordPress Download Manager Mobile App

#### Mobile Apps

Yes, get everything in your pocket, check sales report from your mobile, get notifications on each sale directly on your mobile.

#### Coupon Management

The Plugin includes an extensive range of coupon management. You can create product specific coupons or global coupons for different levels of discount.

#### Role-Based Discount

Sometimes you may need to apply different discounts based on user roles, like editors and authors may have different percents of discounts.

#### Product & Price Variation

Unlimited Product Variations. Create single or multiple variations ( i.e. licenses types ) with increments or decrements of the base price. Also, sale individual or selective files from a package, like selling single or selective music from an album. FYI, only wpdm v4

#### Get Free or Pay As You Want / Donate

You can sell a product with “As you want to pay” option, you also can set a minimum amount to pay or simply put 0 for a minimum price if you want to keep the minimum price optional ( allow users to download even for free ).

#### Accept Payment Without Creating Product

We know, sometimes you need to request/accept payment from someone, and you want to keep track of this inside your site, and creating a product may feel too much of work, so you can simply create a dynamic pay link or use shortocde `[wpdmpp_pay_link price="59" name="Reason for payment" desc="You may add more details" cssclass="btn btn-primary" recurring=0]`

#### Sell Extra Gigs

You may offer additional services like installation, priority support & maintenance for additional fees like extra gigs with your main products, a customer may select one or more gigs with main product and the extra price will be added with the main product price.

#### The Simplest Checkout Option

Premium Package Add-on introduced the simplest checkout system ever, no complex steps, both guests’ and members’ checkout just exactly in 2 clicks.

#### Abandoned Cart/Order Recovery

Premium Package Add-on has an easy-to-use feature to recover abandoned carts/orders, you can configure this feature to send upto 5 emails to the potential customer at different intervals. It also can add dynamic coupon at the end to inspire the customer to complete the checkout as last attempt.

#### Save & Email Cart

Add items to your cart, you can save it to complete the purchase later or email the saved cart to someone you want to pay for the items.

#### Dynamic Product

Need to accept quick payment through your site? Now, you even don’t have to create a product anymore, Premium Package’s dynamic product feature enables you to accept any one time or recurring payment just on the fly.

#### Software Licensing

Integrated Software Licensing option with this Digital Store add-on gives you a complete license key generation, key activation, and verification system.

#### Automatic Order Expiration

Premium Package Add-on has an option to set up a custom access period for the purchased items. Like if you provide 1-year free update of your software after someone purchases your digital item, you can set order expiration period 365 days and after 1 year ( 365 days ) customer will not be able to access his purchase, the order status will be expired, and he will have a “renew order” option in order details page.

#### Automatic Order Renew

As you already read, Premium Package has an “Automatic Order Expiration” option, probably you are wondering where is “Automatic Order Renew”. Good news is, Premium Package has this feature too. If you enable the auto-renewal feature, on checkout the payment will be like a subscription/recurring payment and order will be renewed automatically at the end of each expiration period ( subscription-based pricing model ). Of course, you also can enable an order expiration and auto-renewal notification email for customers before you charge them.

#### Easy Tax Option

We have made the tax calculation is easier for you. From premium package settings, you can easily set up tax for different countries/states/cities just in few clicks.

#### At A Glance

* Sell Digital Products Securely
* Accept payment without creating product using shortcode `[wpdmpp_pay_link]`
* Easy Administration
* PayPal Integrated
* User-role Based Discount Management
* Coupon Management
* Sales Tax
* Save Cart and Checkout Later
* Email Saved Cart
* Product & Price Variations ( License Based Pricing / Sell Extra Gigs with Product )
* Promotional Pricing for Your Digital Products
* Abandoned Cart Recovery
* “Pay As You Want” pricing
* Invoice Generation
* The Easiest Checkout System
* Guest Checkout and Guest Download
* Order expiration option ( Like 1 year support & update access, then expire )
* Auto-renew order option ( Accept Recurring Payment for Orders )
* Easy Order Management
* Sales Notifications via Email
* Sales Notification Directly in Your Mobile with Push Message
* Very Detailed Sales Reports
* Manual order creation
* Order Notes & Messaging System
* Extended Product Licensing System
* License Level Pricing
* Easy to implement license API for license system integration

#### Need More Features?

* Full-featured Digital Products Marketplace with Front-end product submission & payout management ( This Feature Requires WPDM v4+ )
* Sell individual files ( like a single song from an album ) ( This Feature Requires WPDM v4+ )
* and [much more…](https://www.wpdownloadmanager.com/downloads/ecommerce-add-ons/)

## Reviews

![](https://secure.gravatar.com/avatar/bc3861faad695bb8a664b0eace57864d75ff64eafb12fa8f8d8089ecfff69782?s=60&d=retro&r=g)
### [Avoid. Didn’t Work.](https://wordpress.org/support/topic/avoid-didnt-work/)

[Gascone](https://profiles.wordpress.org/gascone/ "Posts by Gascone")
August 9, 2023
1 reply

Didn’t work. People end up downloading my content for FREE!

![](https://secure.gravatar.com/avatar/4002be55809fd7f71fcd90928a585535e5c1fcbf06a628adf4ea18242f569c77?s=60&d=retro&r=g)
### [Surprisingly simple and good.](https://wordpress.org/support/topic/surprisingly-simple-and-good/)

[jdh1178](https://profiles.wordpress.org/jhinden/ "Posts by jdh1178")
March 8, 2023

Does the job with little fuss and easy to modify. Very fast and responsive support.

![](https://secure.gravatar.com/avatar/ce6b7e0d7de7cfc96023a6741ce733303d20e0fc89b03842b39a0cd57b6474a6?s=60&d=retro&r=g)
### [If you’re wondering..](https://wordpress.org/support/topic/if-youre-wondering/)

[Shafaet Alam](https://profiles.wordpress.org/shafayat-alam/ "Posts by Shafaet Alam")
July 15, 2021

Why no reviews?
It is because, actually almost no users visit this page, they directly install it from Download Manager ( https://wordpress.org/plugins/download-manager/ ) when they need to activate digital e-commerce feature :).

![](https://secure.gravatar.com/avatar/d21ae201fac46afb930af5d7d1cf0b5e71fbc523537044f86d07b2019ac7ccc6?s=60&d=retro&r=g)
### [Why no reviews?](https://wordpress.org/support/topic/why-no-reviews/)

[grumblenz](https://profiles.wordpress.org/grumblenz/ "Posts by grumblenz")
June 24, 2021
1 reply

5000 downloads and not one review?

[Read all 4 reviews](https://wordpress.org/support/plugin/wpdm-premium-packages/reviews/)
## Contributors & Developers

“Premium Packages – Sell Digital Products Securely” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/e3fae3fbd6e6d514e5ffbc7ed5b640c3261bdd2a6269a06d6cebc847607c3c20?s=32&d=mm&r=g) [W3 Eden, Inc.](https://profiles.wordpress.org/w3eden/)
* ![](https://secure.gravatar.com/avatar/e5565bca12cd4b8369a438777bff4946745e1c368d2b6004058f17d34c50363b?s=32&d=mm&r=g) [Shahjada](https://profiles.wordpress.org/codename065/)
* ![](https://secure.gravatar.com/avatar/1b231364b6cf6cf9aa841c2e163dd4c430ea89882f40f407d2f491e7f9522bf1?s=32&d=mm&r=g) [Shahriar Alam](https://profiles.wordpress.org/shahriar0822/)
* ![](https://secure.gravatar.com/avatar/ce6b7e0d7de7cfc96023a6741ce733303d20e0fc89b03842b39a0cd57b6474a6?s=32&d=mm&r=g) [Shafaet Alam](https://profiles.wordpress.org/shafayat-alam/)
* ![](https://secure.gravatar.com/avatar/3b4e4a4a0d6dfa6e8a8a54be7e22d448439caabada2ca59965a5c5c809053b6d?s=32&d=mm&r=g) [Razia Sultana](https://profiles.wordpress.org/shimo16ab/)

[Translate “Premium Packages – Sell Digital Products Securely” into your language.](https://translate.wordpress.org/projects/wp-plugins/wpdm-premium-packages)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/wpdm-premium-packages/), check out the [SVN repository](https://plugins.svn.wordpress.org/wpdm-premium-packages/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/wpdm-premium-packages/) by [RSS](https://plugins.trac.wordpress.org/log/wpdm-premium-packages/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 5.9.7 – 2024.12.31

* Fixed an issue with the `orderby` option on the admin orders page ( reported by patchstack )

#### 5.9.6 – 2024.12.12

* Fixed an issue with the currency symbol on the customer profile page

#### 5.9.5 – 2024.11.23

* Fixed an issue with `wpdmpp_cart_page` function ( reported by Wordfence )

#### 5.9.4 – 2024.11.20

* Fixed a shortcode parameter sanitization issue with the shortcode `[wpdmpp_pay_link]`
* Improved checkout page

#### 5.9.3 – 2024.10.12

* Improved payment options
* Added a new checkout page layout for a better user experience

#### 5.9.2 – 2024.09.24

* Fixed a nonce key verification issue with refund option with admin order details ( Reported by Wordfence )

#### 5.9.1 – 2024.08.25

* Fixed an issue with the tax rate calculation for states

#### 5.9.0 – 2024.08.12

* Fixed an issue with the currency sign with the completed orders

#### 5.8.9 – 2024.08.05

* Enhanced System Optimization and Compatibility Assurance Update

#### 5.8.8 – 2024.07.28

* Fixed an issue with PayPal payment method

#### 5.8.7 – 2024.06.15

* Fixed an issue with the list orders page
* Added new tab to review recently renewed orders easily

#### 5.8.6 – 2024.06.05

* Improved admin orders page
* Fixed an issue with the installer class

#### 5.8.5 – 2024.06.04

* Improved admin settings options
* Improved order/sales stats

#### 5.8.4 – 2024.01.29

* Fixed an issue with the buy now button style

#### 5.8.3 – 2024.01.23

* Fixed an XSS bug with license manager window

#### 5.8.2 – 2023.12.24

* Fixed an issue with the auto-delete incomplete order option

#### 5.8.1 – 2023.11.25

* Fixed an issue with coupon code discount calculation after removing an item from cart

#### 5.8.0 – 2023.11.17

* Fixed an issue with resending order confirmation email

#### 5.7.9 – 2023.11.15

* Fixed an issue with the guest download page
* Improved role assignment option for packages

#### 5.7.8 – 2023.10.24

* Fixed an issue with the decimal points in price format
* Improved invoice template

#### 5.7.7 – 2023.10.03

* Fixed an issue with the subscription renewal reminder email

#### 5.7.6 – 2023.08.30

* Improved admin order customization options

#### 5.7.5 – 2023.08.11

* Fixed a PHP 8.2 compatibility issue
* Fixed an arbitrary user meta update vulnerability issue, reported by Wordfance

#### 5.7.4 – 2023.08.08

* Added option to resend order confirmation email
* Improved admin order details page

#### 5.7.3 – 2023.07.31

* Compatibility update for WordPres 6.3
* Improved order notes
* Improved invoice template

#### 5.7.2 – 2023.05.15

* Improved manual order renewal option
* Fixed an issue with admin order details page for non-existent order id

#### 5.7.1 – 2023.05.06

* Fixed an issue with auto-renewal activation and deactivation option

#### 5.7.0 – 2023.05.05

* Improved manual order renewal option, you can now enable it for individual orders too

#### 5.6.9 – 2023.05.02

* Added option to disable manual renewal of expired orders, when disabled, customer can clone the order in a single click to create new one and checkout

#### 5.6.8 – 2023.05.01

* Improved manual order renewal option
* Fixed an undefined variable notice in Cart class

#### 5.6.7 – 2023.04.14

* Improved custom order creation option
* Added new hook `wpdmpp_before_addtocart` to manipulate product info before it is being added to cart
* Fixed a notice with server http referer variable

#### 5.6.6 – 2023.03.29

* Fixed an undefined variable issue with method `WPDMPP()->order->updateOrderItems()`
* Improved payment method handling class

#### 5.6.5 – 2023.03.27

* Added several 4 new action hooks on admin order details page ( `/includes/menus/templates/orders/view-order.php` )
* Added filter hook `wpdmpp_update_order` to modify order data before update
* Added action hook `wpdmpp_order_updated` after order has been updated

#### 5.6.4 – 2023.03.09

* Improved/Redesigned payout option
* Added support for multiple payout methods
* Fixed an issue with the new order function with empty coupon code

#### 5.6.3 – 2023.01.28

* Improved coupon option, product specific coupon code can be handled using global cart coupon field
* Improved invoice options

#### 5.6.2 – 2023.01.27

* Improved payment options

#### 5.6.1 – 2023.01.27

* Fixed an issue with the guest order billing info update

#### 5.6.0 – 2023.01.27

* Added new option for admin only activation of payment methods
* Fixed an issue with the country and state selection dropdown

#### 5.5.9 – 2023.01.11

* Improved buy now option

#### 5.5.8 – 2023.01.05

* Fixed an issue with the auto-applicable coupon code

#### 5.5.7 – 2022.11.28

* Fixed a compatibility issue with the older version of wpdm

#### 5.5.6 – 2022.11.28

* Fixed an issue with the auto-apply coupon code option

#### 5.5.5 – 2022.11.21

* Improved admin order details
* Fixed a js issue with pay now option for the processing/pending order in user dashboard

#### 5.5.4 – 2022.11.18

* Fixed a js issue with the billing form validation

#### 5.5.3 – 2022.11.14

* Fixed an issue with the directory attachment for premium packages

#### 5.5.2 – 2022.11.14

* Improved coupon features
* Fixed an issue with the sales price

#### 5.5.1 – 2022.11.08

* Fixed an issue with abandoned order recovery email

#### 5.5.0 – 2022.11.01

* Fixed an issue with order date display
* Improved dynamic product option

#### 5.4.9 – 2022.10.15

* Added new option for abandoned order recovery

#### 5.4.8 – 2022.10.12

* Improved coupon code section, now you can review all orders which used any specific coupon code from coupons page

#### 5.4.7 – 2022.10.10

* Improved “Buy Now” option for the quickest and easiest checkout

#### 5.4.6 – 2022.10.06

* Fixed an issue with the sales confirmation email to seller

#### 5.4.5 – 2022.10.05

* Improved dynamic product and payment link option to accept both recurring and one-time payment

#### 5.4.4 – 2022.10.04

* Fixed a UI issue with the settings tabs

#### 5.4.3 – 2022.09.16

* Added option to create custom order note templates

#### 5.4.2 – 2022.09.13

* Improved payment request option
* Improved coupon code option, now you can auto-apply a coupon on checkout

#### 5.4.1 – 2022.09.04

* Fixed an issue with the dynamic product and cart locking

#### 5.4.0 – 2022.08.12

* Fixed a UI issue with the payment link form

#### 5.3.9 – 2022.08.09

* Fixed an issue with the remove cart item option

#### 5.3.8 – 2022.08.08

* Added new shortcode `wpdmpp_pay_link` to generate payment link without creating new product

#### 5.3.7 – 2022.07.25

* Added new option to auto-delete incomplete orders after specific days

#### 5.3.6 – 2022.06.02

* Compatibility update for WordPress 6.0
* Added new option to recalculate customers value
* Optimized admin orders list page

#### 5.3.5 – 2022.03.31

* Fixed a css issue with invoice template

#### 5.3.4 – 2022.03.23

* Fixed an issue with the billing info form template path

#### 5.3.3 – 2022.03.19

* Added new option to update order expiry date

#### 5.3.2 – 2022.03.17

* Fixed an issue with tpl dir path
* Improved admin order details page view

#### 5.3.1 – 2022.03.05

* Added new options to customize existing orders

#### 5.3.0 – 2022.02.24

* Fixed an issue with the auto-renewal option setup for new orders

#### 5.2.9 – 2022.02.24

* Improved order management
* Fixed an issue with the manual order renewal option

#### 5.2.8 – 2022.02.17

* Fixed an issue with frontend users orders page

#### 5.2.7 – 2022.01.11

* Fixed an undefined index notice on order details page

#### 5.2.6 – 2021.12.23

* Improved master key validation option for premium file download

#### 5.2.5 – 2021.12.06

* Compatibility update for WPDM

#### 5.2.4 – 2021.11.15

* Fixed an issue with the guest order page

#### 5.2.3 – 2021.11.12

* Fixed an issue with the coupon code and paypal checkout

#### 5.2.2 – 2021.11.02

* Improved order detail page
* Re-added product description parameter with PayPal smart button

#### 5.2.1 – 2021.10.29

* Fixed the currency code issue with PayPal

#### 5.2.0 – 2021.10.25

* Updated paypal api version

#### 5.1.9 – 2021.10.18

* Fixed an issue with the add to cart function throwing when role discount is empty
* Improved user orders list page

#### 5.1.8 – 2021.10.10

* Fixed an issue with the purchased file download

#### 5.1.7 – 2021.10.04

* Fixed an issue with the selective file purchase

#### 5.1.6 – 2021.09.13

* Fixed an issue with the role based discount calculation on order detail page

#### 5.1.5 – 2021.09.12

* Fixed an issue with the role based discount

#### 5.1.4 – 2021.09.12

* Fixed an issue with cart ( global ) coupon code

#### 5.1.3 – 2021.08.30

* Fixed an issue with the coupon discount calculation on admin order detail page

#### 5.1.2 – 2021.08.29

* Fixed an issue with the `[wpdmpp_purchases]` shortcode

#### 5.1.1 – 2021.08.22

* Removed some console log from front-end

#### 5.1.0 – 2021.08.22

* Fixed an issue with the remove cart item option

#### 5.0.9 – 2021.08.18

* Fixed an issue with the product specific coupon

#### 5.0.8 – 2021.08.15

* Fixed tax calculation issue with paypal when smart button is active
* Fixed an issue with the premium download url

#### 5.0.7 – 2021.08.14

* Fixed an issue with the pay as you want option
* Fixed an issue with the cart redirection option

#### 5.0.6 – 2021.08.14

* Added support for dynamic product
* Improved add to cart functions

#### 5.0.5 – 2021.08.04

* Improved product seach option with new order / coupon / license
* Compatibility adjustment for the WPDM 3.2.13

#### 5.0.4 – 2021.07.25

* Reinstated `[base_price]` and `[sales_price]` tag, they will show formatted price now.
* Fixed an issue with the text domain constant

#### 5.0.3 – 2021.07.07

* Optimized individual file selling option

#### 5.0.2 – 2021.07.06

* Fixed an issue with the purchased item download

#### 5.0.1 – 2021.07.05

* Fixed a compatibility issue with checkout login/register form

#### 5.0.0 – 2021.07.04

* Fixed session issue for ipv6
* Compatibility update for Download Manager v6.0 and v3.2

#### 4.7.2 – 2021.02.03

* Fixed and issue with customer profile page for deleted customers

#### 4.7.1 – 2021.02.03

* Added custom profile page with purchase history

#### 4.7.0 – 2021.01.12

* Added payment gateway credential validation check option.
* Fixed the individual file download issue for license specific files with purchased items

#### 4.6.9 – 2020.11.24

* Fixed the billing info update issue with the paypal checkout

#### 4.6.8 – 2020.11.21

* Fixed a js issue with extra gigs selection checkbox

#### 4.6.7 – 2020.10.24

* Fixed an issue with the license validation for any package with no file attached

#### 4.6.6 – 2020.10.01

* Improved UI
* Added filter hook `wpdmpp_before_save_settings`
* Added action hook `wpdmpp_after_save_settings`

#### 4.6.5 – 2020.09.10

* Fixed an issue with license specific file selection option

#### 4.6.4 – 2020.09.02

* Fixed an issue with the download key decryption

#### 4.6.3 – 2020.09.02

* Fixed an issue with billing address update

#### 4.6.2 – 2020.08.28

* Fixed an issue with license pack download

#### 4.6.1 – 2020.08.28

* Fixed an warning with user order details page
* Added option to disable multi-file download for purchased items

#### 4.6.0 – 2020.08.28

* Compatibility update for WordPress 5.5
* Improved cart page
* Added license based file selection option

#### 4.5.9 – 2020.07.20

* Fixed an issue with user order details page

#### 4.5.8 – 2020.07.20

* Improved checkout page
* Fixed an issue with the billing info

#### 4.5.7 – 2020.05.22

* Updated order details page ( customer view )

#### 4.5.6 – 2020.05.16

* Recoded checkout option for a better experience

#### 4.5.5 – 2020.05.13

* Updated default value for order validity period ( 365 days )

#### 4.5.4 – 2020.05.13

* Fixed an issue with order renewal notice on order details page

#### 4.5.3 – 2020.05.12

* Fixed an issue with paypal gateway update from admin order details page
* Updated order renewal feature, improved manual order renewal experience

#### 4.5.2 – 2020.05.11

* Fixed an issue with the save cart function

#### 4.5.1 – 2020.05.11

* Fixed an issue with the extra gigs price format
* Improved admin UI

#### 4.5.0 – 2020.05.04

* Added new option to change payment method
* Added new option to handle partial refunds
* Added new option to change checkout button style

#### 4.4.9 – 2020.05.01

* Improved cart functions
* Fixed an issue with cart button label

#### 4.4.8 – 2020.04.28

* Fixed order title issue with paypal

#### 4.4.7 – 2020.04.28

* Fixed CSS class issue with the add to cart button

#### 4.4.6 – 2020.04.27

* Fixed order confirmation email issue with PayPal
* Fixed the price update issue with the buy now button

#### 4.4.5 – 2020.04.16

* Fixed variable replacement issue with order title
* Fixed an warning with the guest order billing info
* Improved internal codebase and API

#### 4.4.4 – 2020.02.20

* Added new option to change linked customer
* Improved order details page view for admin

#### 4.4.3 – 2020.02.09

* Fixed an issue with free download option

#### 4.4.2 – 2020.01.17

* Fixed an issue with license validation

#### 4.4.1 – 2020.01.15

* Added filters `wpdmpp_currency_sign` and `wpdmpp_currency_code` to change active currency dynamically
* Fixed an issue with order confirmation email

#### 4.4.0 – 2020.01.08

* Added new filter hook `wpdmpp_currencies` to modify currency list
* Fixed an issue with decimal points
* Fixed an issue with the free download button

#### 4.3.9 – 2019.12.03

* Added status message on checkout page for PayPal smart button while verifying payment
* Fixed an issue with the payment gateway list priority

#### 4.3.8 – 2019.11.25

* Compatibility update for WPDM v3.0.5

#### 4.3.7 – 2019.11.22

* Fixed an issue with the PayPal buy bow button

#### 4.3.6 – 2019.11.20

* Compatibility update for WPDM v5.0.3 and v3.0.4

#### 4.3.5 – 2019.11.15

* Compatibility update for WordPress 5.3
* Fixed an issue with the PayPal recurring payment

#### 4.3.4 – 2019.10.02

* Fixed guest order issue with the PayPal checkout button

#### 4.3.3 – 2019.09.30

* Fixed an issue with admin orders

#### 4.3.2 – 2019.09.30

* Fixed an issue with the order renewal notification

#### 4.3.1 – 2019.09.13

* Improved order renewal notification
* Improved front-end UI
* Added new option to disable order notes

#### 4.3.0 – 2019.09.07

* Added order status option for cash and check payment
* Added new option to set custom redirect url for Cash and Check payment gateway

#### 4.2.9 – 2019.09.03

* Fixed order completion issue with Cash payment method
* Fixed a notice on order details page at front-end
* Fixed an issue with front-end style enable/disable

#### 4.2.8 – 2019.09.02

* Improved auto-renewal option for orders
* Fixed an issue with the guest order and download

#### 4.2.7 – 2019.07.16

* Fixed an issue with invoice for admin

#### 4.2.6 – 2019.07.15

* Fixed an issue with “top selling item” widget on dashboard
* Fixed an issue with “Pay as you want”

#### 4.2.5 – 2019.07.08

* Improved invoice generation option

#### 4.2.4 – 2019.06.26

* Fixed an issue with tax calculation on the load of the checkout page
* Fixed an issue with the download function

#### 4.2.3 – 2019.06.18

* Added a new option to remove licensed domains from front-end

#### 4.2.2 – 2019.06.18

* Fixed an issue with license key validation function
* Improved order search

#### 4.2.1 – 2019.05.25

* Fixed an issue with auto-renew selection option

#### 4.2.0 – 2019.04.17

* Added a new option to enable/disable role based discount
* Added a new option to enable/disable product specific coupon
* Improved session management

#### 4.1.3 – 2019.03.22

* Added cron for order expiry notification
* Fixed issue with the automatic order linking after guest checkout

#### 4.1.2 – 2019.03.05

* Improved order search feature

#### 4.1.1 – 2019.02.25

* Improved admin orders page
* Fixed an issue with master key download override
* Fixed an issue with order note attachment

#### 4.1.0 – 2019.01.02

* Added “Buy Now” option
* Improved checkout page
* Improved currency configuration option

#### 4.0.8 – 2018.12.18

* Fixed an issue with customer role assignment

#### 4.0.8 – 2018.12.08

* Removed hardcoded PayPal sandbox api url and keys

#### 4.0.7 – 2018.12.08

* Fixed an issue with manual order creation
* Fixed an issue with PayPal API call

#### 4.0.6 – 2018.12.07

* Compatibility update for WordPress 5
* Improved checkout option
* Improved UI

#### 4.0.5 – 2018.11.25

* Upgraded PayPal payment option
* Optimized order details page
* Upgraded email settings
* Upgraded product licensing option
* Fixed coupon linking issue with saved cart
* Added new role “Customer” for customers

#### 4.0.4 – 2018.10.05

* Option added to send an order expiration notification to customers
* Updated order confirmation email
* Fixed an issue with guest order search form

#### 4.0.3 – 2018.09.04

* Improved add to cart button
* Added support for a custom prefix with order ID

#### 4.0.2 – 2018.08.12

* Fixed 2 input validation issues ( /includes/libs/cart.php )

#### 4.0.1 – 2018.08.11

* Fixed an issue with email cart option
* Fixed an issue with update profile option
* Fixed an issue with save settings function

#### 4.0.0 – 2018.07.27

* Rebuilt purchased items download page for the customers
* Fixed an issue with tax and billing address

#### 3.9.9 – 2018.07.12

* Added download history in order details page
* Fixed issue with empty transaction ID when auto-renew an order
* Fixed and issue with payout option

#### 3.9.8 – 2018.07.05

* Improved order auto-renew function
* Added new option to create an order manually from admin side

#### 3.9.7 – 2018.06.12

* Fixed the issue with coupon add/update

#### 3.9.6 – 2018.06.05

* Improved user orders listing at frontend
* Added new option to search expiring orders for specified time period
* Fixed an issue with order expiration

#### 3.9.5 – 2018.05.29

* Improved payment settings
* Added a new option to enable/disable privacy policy check on checkout page

#### 3.9.4 – 2018.05.24

* Fixed issue with add coupon
* Updated Font Awesome (v5)
* Updated “Pay As You Want” option, now also have support for minimum price 0.00

#### 3.9.3 – 2018.05.16

* Fixed issue with the guest download

#### 3.9.2 – 2018.05.13

* Added wpdm requirement notice

#### 3.9.1 – 2018.05.13

* Sanitized all missing input data

#### 3.8.9

* Template Optimization, you can personalize templates more easily now
* Fixed JS issue in frontend add new page
* Added currency symbol position ( before and after amount ) option
* Fixed save cart error

#### 3.8.6

* Added “As You Want To Pay” option
* Fixed issue with cart discount calculation after deleting a cart item

#### 3.8.5

* Added a new option to add global coupon code
* Added a separate page to manage all coupons

#### 3.8.4

* Added new option for coupon code expire date
* Improved free download option for premium packages

#### 3.8.3

* Fixed issue with installation function

#### 3.8.1

* Fixed issue with role discount
* Fixed issue with individual file download for purchased packages

#### 3.5.8

* 100% Translation ready
* Fixed a bug that shows wrong Net Subtotal of License variation in Invoice
* Fixed a bug that shows wrong Customer Billing Address in Invoice
* Added Premium Package template tags in Dashboard >> Downloads >> Template Editor screen
* Fixed currency sign of total sales in admin orders screen

#### 3.5.7

* Fixed issue with Save Cart feature in cart page
* Fixed Frontend uploader metabox issue ( Not loading Premium Package Data like price, variations etc )

#### 3.5.6

* Fixed issue decimal point in order total
* Fixed issue with country dropdown in billing address
* Fixed issue with default payment method integration

## Meta

* Version **5.9.7**
* Last updated **2 weeks ago**
* Active installations **4,000+**
* WordPress version **5.3 or higher**
* Tested up to **6.7.1**
* Tags [digital store](https://wordpress.org/plugins/tags/digital-store/)[online shop](https://wordpress.org/plugins/tags/online-shop/)[sell digital product](https://wordpress.org/plugins/tags/sell-digital-product/)[shopping cart](https://wordpress.org/plugins/tags/shopping-cart/)[wordpress ecommerce](https://wordpress.org/plugins/tags/wordpress-ecommerce/)
* [Advanced View](https://wordpress.org/plugins/wpdm-premium-packages/advanced/)

## Ratings

3.8 out of 5 stars.

* [2 5-star reviews
  5 stars

  2](https://wordpress.org/support/plugin/wpdm-premium-packages/reviews/?filter=5)
* [1 4-star review
  4 stars

  1](https://wordpress.org/support/plugin/wpdm-premium-packages/reviews/?filter=4)
* [0 3-star reviews
  3 stars

  0](https://wordpress.org/support/plugin/wpdm-premium-packages/reviews/?filter=3)
* [0 2-star reviews
  2 stars

  0](https://wordpress.org/support/plugin/wpdm-premium-packages/reviews/?filter=2)
* [1 1-star review
  1 star

  1](https://wordpress.org/support/plugin/wpdm-premium-packages/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/wpdm-premium-packages/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/wpdm-premium-packages/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/e3fae3fbd6e6d514e5ffbc7ed5b640c3261bdd2a6269a06d6cebc847607c3c20?s=32&d=mm&r=g) [W3 Eden, Inc.](https://profiles.wordpress.org/w3eden/)
* ![](https://secure.gravatar.com/avatar/e5565bca12cd4b8369a438777bff4946745e1c368d2b6004058f17d34c50363b?s=32&d=mm&r=g) [Shahjada](https://profiles.wordpress.org/codename065/)
* ![](https://secure.gravatar.com/avatar/1b231364b6cf6cf9aa841c2e163dd4c430ea89882f40f407d2f491e7f9522bf1?s=32&d=mm&r=g) [Shahriar Alam](https://profiles.wordpress.org/shahriar0822/)
* ![](https://secure.gravatar.com/avatar/ce6b7e0d7de7cfc96023a6741ce733303d20e0fc89b03842b39a0cd57b6474a6?s=32&d=mm&r=g) [Shafaet Alam](https://profiles.wordpress.org/shafayat-alam/)
* ![](https://secure.gravatar.com/avatar/3b4e4a4a0d6dfa6e8a8a54be7e22d448439caabada2ca59965a5c5c809053b6d?s=32&d=mm&r=g) [Razia Sultana](https://profiles.wordpress.org/shimo16ab/)
## Support

Issues resolved in last two months:

0 out of 1

[View support forum](https://wordpress.org/support/plugin/wpdm-premium-packages/)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


