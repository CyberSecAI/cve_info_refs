=== Content from www.wordfence.com_ae4e607e_20250114_223718.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# CLUEVO LMS, E-Learning Platform <= 1.13.2 - Cross-Site Request Forgery to Module Deletion

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   CLUEVO LMS, E-Learning Platform <= 1.13.2 - Cross-Site Request Forgery to Module Deletion

4.3

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-11444](https://www.cve.org/CVERecord?id=CVE-2024-11444) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | December 5, 2024 |
| Last Updated | December 6, 2024 |
| Researcher | [Peter Thaleikis](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/spek) |

### Description

The CLUEVO LMS, E-Learning Platform plugin for WordPress is vulnerable to Cross-Site Request Forgery in all versions up to, and including, 1.13.2. This is due to missing or incorrect nonce validation on the cluevo\_render\_module\_ui() function. This makes it possible for unauthenticated attackers to delete modules via a forged request granted they can trick a site administrator into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php#L925)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php#L928)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcluevo-lms%2Fcluevo-lms-e-learning-platform-1132-cross-site-request-forgery-to-module-deletion&t=CLUEVO%20LMS%2C%20E-Learning%20Platform%20%3C%3D%201.13.2%20-%20Cross-Site%20Request%20Forgery%20to%20Module%20Deletion "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcluevo-lms%2Fcluevo-lms-e-learning-platform-1132-cross-site-request-forgery-to-module-deletion&text=CLUEVO%20LMS%2C%20E-Learning%20Platform%20%3C%3D%201.13.2%20-%20Cross-Site%20Request%20Forgery%20to%20Module%20Deletion "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fcluevo-lms%2Fcluevo-lms-e-learning-platform-1132-cross-site-request-forgery-to-module-deletion "LinkedIn")
Email

## Vulnerability Details for CLUEVO LMS, E-Learning Platform

#### [CLUEVO LMS, E-Learning Platform](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/cluevo-lms)

| Software Type | Plugin |
| --- | --- |
| Software Slug | cluevo-lms [(view on wordpress.org)](https://wordpress.org/plugins/cluevo-lms) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 1.13.2 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_4ce1b1c9_20250114_223715.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcluevo-lms%2Ftags%2F1.13.2%2Ffunctions%2Ffunctions.module-management.inc.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/cluevo-lms/trunk/functions/functions.module-management.inc.php?rev=3043019 "Revision 3043019")
* [Next Revision](/browser/cluevo-lms/trunk/functions/functions.module-management.inc.php?rev=3221008 "Revision 3221008") →
* [Blame](/browser/cluevo-lms/trunk/functions/functions.module-management.inc.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php)

---

# [source:](/browser?order=name "Go to repository root") [cluevo-lms](/browser/cluevo-lms?order=name "View cluevo-lms")/[tags](/browser/cluevo-lms/tags?order=name "View tags")/[1.13.2](/browser/cluevo-lms/tags/1.13.2?order=name "View 1.13.2")/[functions](/browser/cluevo-lms/tags/1.13.2/functions?order=name "View functions")/[functions.module-management.inc.php](/browser/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php?order=name "View functions.module-management.inc.php")

View diff against:

View revision:

| [Last change](/changeset/3065235/cluevo-lms/trunk/functions/functions.module-management.inc.php "View differences") on this file was [3065235](/changeset/3065235/ "View changeset 3065235"), checked in by cluevo, [9 months ago](/timeline?from=2024-04-05T07%3A05%3A31Z&precision=second "See timeline at 04/05/2024 07:05:31 AM") |
| --- |
| Fixed tree item sort order, display mode, added fileinfo checks |
| **File size:** 93.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (!defined("CLUEVO\_ACTIVE")) exit; |
| [3](#L3) |  |
| [4](#L4) | /\*\* |
| [5](#L5) | \* Retrieves a module id by it's name from the database |
| [6](#L6) | \* |
| [7](#L7) | \* @param string $strName |
| [8](#L8) | \* |
| [9](#L9) | \* @return int|null |
| [10](#L10) | \*/ |
| [11](#L11) | function cluevo\_get\_module\_id\_by\_name($strName) |
| [12](#L12) | { |
| [13](#L13) | global $wpdb; |
| [14](#L14) | $sql = "SELECT module\_id FROM " . $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES . " WHERE module\_name = %s"; |
| [15](#L15) | $result = $wpdb->get\_var($wpdb->prepare($sql, [$strName])); |
| [16](#L16) |  |
| [17](#L17) | return (!empty($result)) ? (int)$result : null; |
| [18](#L18) | } |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Removes a module from the database |
| [22](#L22) | \* |
| [23](#L23) | \* @param int $intId |
| [24](#L24) | \* |
| [25](#L25) | \* @return int|false |
| [26](#L26) | \*/ |
| [27](#L27) | function cluevo\_remove\_module($intId) |
| [28](#L28) | { |
| [29](#L29) | $module = cluevo\_get\_module($intId); |
| [30](#L30) | if (!empty($module)) { |
| [31](#L31) | $delModule = $module->module\_dir; |
| [32](#L32) | $delPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') . $delModule; |
| [33](#L33) | $delZip = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . $module->module\_zip; |
| [34](#L34) | if (!empty($module->module\_dir) && file\_exists($delPath) && !empty($delPath)) { |
| [35](#L35) | if (!empty($delModule)) { |
| [36](#L36) | cluevo\_delete\_directory($delPath); |
| [37](#L37) | } |
| [38](#L38) | if (!empty($module->module\_zip) && file\_exists($delZip) && !empty($delZip)) |
| [39](#L39) | @unlink($delZip); |
| [40](#L40) | } |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | global $wpdb; |
| [44](#L44) | $tables = [ |
| [45](#L45) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES, |
| [46](#L46) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_TREE\_MODULES, |
| [47](#L47) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_TREE\_MODULE\_DEPENDENCIES, |
| [48](#L48) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES\_PROGRESS, |
| [49](#L49) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES\_COMPETENCES, |
| [50](#L50) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULE\_PARMS |
| [51](#L51) | ]; |
| [52](#L52) | $results = []; |
| [53](#L53) | foreach ($tables as $table) { |
| [54](#L54) | $sql = "DELETE FROM $table WHERE module\_id = %d"; |
| [55](#L55) | $results[] = $wpdb->query($wpdb->prepare($sql, [$intId])); |
| [56](#L56) | } |
| [57](#L57) | $result = (!empty($results[0])) ? $results[0] : false; |
| [58](#L58) | if ($result !== false) { |
| [59](#L59) | $metaId = cluevo\_get\_metadata\_id\_from\_module\_id($intId); |
| [60](#L60) | if (!empty($metaId)) { |
| [61](#L61) | wp\_delete\_post($metaId, true); |
| [62](#L62) | } |
| [63](#L63) | } |
| [64](#L64) | return $results; |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Returns the metadata page id of a module |
| [69](#L69) | \* |
| [70](#L70) | \* @param int $intModuleId |
| [71](#L71) | \* |
| [72](#L72) | \* @return int|false |
| [73](#L73) | \*/ |
| [74](#L74) | function cluevo\_get\_metadata\_id\_from\_module\_id($intModuleId) |
| [75](#L75) | { |
| [76](#L76) | global $wpdb; |
| [77](#L77) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [78](#L78) | $sql = "SELECT metadata\_id FROM $table WHERE module\_id = %d"; |
| [79](#L79) | $result = $wpdb->get\_var( |
| [80](#L80) | $wpdb->prepare( |
| [81](#L81) | $sql, |
| [82](#L82) | [$intModuleId] |
| [83](#L83) | ) |
| [84](#L84) | ); |
| [85](#L85) |  |
| [86](#L86) | return (!empty($result)) ? (int)$result : false; |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) | /\*\* |
| [90](#L90) | \* Creates or updates a module's database entry |
| [91](#L91) | \* |
| [92](#L92) | \* @param int $strModule |
| [93](#L93) | \* @param int $intMetadataId |
| [94](#L94) | \* @param string $strDir |
| [95](#L95) | \* @param string $strZipFile |
| [96](#L96) | \* @param string $strIndex |
| [97](#L97) | \* |
| [98](#L98) | \* @return int|false |
| [99](#L99) | \*/ |
| [100](#L100) | function cluevo\_create\_module($strModule, $intType, $intMetadataId, $strDir, $strZipFile, $strIndex, $strLang = null, $intParentId = null, $strScormVersion = null) |
| [101](#L101) | { |
| [102](#L102) | global $wpdb; |
| [103](#L103) | $sql = "REPLACE INTO " . $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES . " SET module\_name = %s, metadata\_id = %d, module\_dir = %s, module\_zip = %s, module\_index = %s, lang\_code = %s, type\_id = %d, scorm\_version = %s"; |
| [104](#L104) | $parms = [$strModule, $intMetadataId, $strDir, $strZipFile, $strIndex, $strLang, $intType, $strScormVersion]; |
| [105](#L105) |  |
| [106](#L106) | if (!empty($intParentId)) { |
| [107](#L107) | $sql .= ", module\_id = %d"; |
| [108](#L108) | $parms[] = $intParentId; |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | $result = $wpdb->query($wpdb->prepare($sql, $parms)); |
| [112](#L112) | cluevo\_clear\_turbo\_cache(); |
| [113](#L113) | return $result; |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | function cluevo\_module\_name\_exists($strName) |
| [117](#L117) | { |
| [118](#L118) | global $wpdb; |
| [119](#L119) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [120](#L120) | $sql = "SELECT COUNT(\*) AS count FROM {$table} WHERE module\_name = %s"; |
| [121](#L121) | $result = $wpdb->get\_var($wpdb->prepare($sql, [$strName])); |
| [122](#L122) | return (int)$result > 0; |
| [123](#L123) | } |
| [124](#L124) |  |
| [125](#L125) | function cluevo\_set\_module\_language($intModuleId, $strLangCodeOld, $strLangCodeNew) |
| [126](#L126) | { |
| [127](#L127) | global $wpdb; |
| [128](#L128) | $moduleTable = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [129](#L129) |  |
| [130](#L130) | //if (!cluevo\_module\_language\_exists($intModuleId, $strLangCodeNew)) { |
| [131](#L131) | $sql = "UPDATE IGNORE $moduleTable SET lang\_code = %s WHERE module\_id = %d AND lang\_code = %s"; |
| [132](#L132) |  |
| [133](#L133) | $result = $wpdb->query( |
| [134](#L134) | $wpdb->prepare($sql, [sanitize\_key($strLangCodeNew), $intModuleId, sanitize\_key($strLangCodeOld)]) |
| [135](#L135) | ); |
| [136](#L136) |  |
| [137](#L137) | return ($result !== false && is\_numeric($result) && $result > 0); |
| [138](#L138) | //} |
| [139](#L139) |  |
| [140](#L140) | //return false; |
| [141](#L141) | } |
| [142](#L142) |  |
| [143](#L143) | function cluevo\_module\_language\_exists($intModuleId, $strLangCode) |
| [144](#L144) | { |
| [145](#L145) | global $wpdb; |
| [146](#L146) | $moduleTable = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [147](#L147) |  |
| [148](#L148) | $sql = "SELECT COUNT(\*) FROM $moduleTable  WHERE module\_id = %d AND lang\_code = %s"; |
| [149](#L149) |  |
| [150](#L150) | $result = $wpdb->get\_var( |
| [151](#L151) | $wpdb->prepare($sql, [$intModuleId, $strLangCode]) |
| [152](#L152) | ); |
| [153](#L153) |  |
| [154](#L154) | return ((int)$result == 0); |
| [155](#L155) | } |
| [156](#L156) | /\*\* |
| [157](#L157) | \* Handles the module upload |
| [158](#L158) | \* |
| [159](#L159) | \* Unpacks files, creates db entries and metadata posts |
| [160](#L160) | \*/ |
| [161](#L161) | function cluevo\_handle\_module\_upload(&$errors, &$messages, &$handled, &$result = null) |
| [162](#L162) | { |
| [163](#L163) | $messages[] = \_\_("Handling module upload", "cluevo"); |
| [164](#L164) | if (!empty($result) && is\_numeric($result)) { |
| [165](#L165) | $messages[] = \_\_("Attempting to update module", "cluevo"); |
| [166](#L166) | $oldModule = cluevo\_get\_module((int)$result); |
| [167](#L167) | $moduleDir = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), $oldModule->module\_dir); |
| [168](#L168) | $messages[] = esc\_html(sprintf(\_\_("Existing module found: %s", "cluevo"), $oldModule->module\_name)); |
| [169](#L169) | $archivePath = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH'), $oldModule->module\_zip); |
| [170](#L170) | $file = sanitize\_text\_field($\_FILES['module-file']['tmp\_name']); |
| [171](#L171) | $finfo = finfo\_open(FILEINFO\_MIME\_TYPE); |
| [172](#L172) | $mime = sanitize\_mime\_type(finfo\_file($finfo, $file)); |
| [173](#L173) | finfo\_close($finfo); |
| [174](#L174) | $tmp = uniqid(); |
| [175](#L175) | if ($mime === 'application/zip' && cluevo\_is\_scorm\_zip($file)) { |
| [176](#L176) | $handled = true; |
| [177](#L177) | $messages[] = \_\_("SCORM file detected", "cluevo"); |
| [178](#L178) |  |
| [179](#L179) | if (!empty($oldModule->module\_zip) && $archivePath !== cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') && file\_exists($archivePath)) { |
| [180](#L180) | $messages[] = esc\_html(sprintf(\_\_("Backing up zip: %s", "cluevo"), $archivePath)); |
| [181](#L181) | @rename($archivePath, $archivePath . $tmp); |
| [182](#L182) | } |
| [183](#L183) | if (empty($oldModule->module\_zip)) { |
| [184](#L184) | $filename = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_FILENAME)); |
| [185](#L185) | $ext = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_EXTENSION)); |
| [186](#L186) | $type = sanitize\_file\_name(strtolower(cluevo\_get\_module\_type\_name\_from\_mime\_type($mime))); |
| [187](#L187) |  |
| [188](#L188) | $blacklistExt = cluevo\_get\_blacklisted\_extensions(); |
| [189](#L189) | $blacklistNames = cluevo\_get\_blacklisted\_filenames(); |
| [190](#L190) | if (in\_array($ext, $blacklistExt) || in\_array($filename, $blacklistNames)) { |
| [191](#L191) | $errors[] = \_\_("This type of file is not allowed", "cluevo"); |
| [192](#L192) | return; |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | $archivePath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower($type . '/' . sanitize\_file\_name($\_FILES["module-file"]['name'])); |
| [196](#L196) | } |
| [197](#L197) | if (move\_uploaded\_file($file, $archivePath)) { |
| [198](#L198) | $backedUp = false; |
| [199](#L199) | if (file\_exists($moduleDir)) { |
| [200](#L200) | $messages[] = esc\_html(sprintf(\_\_("Backing up: %s", "cluevo"), $moduleDir)); |
| [201](#L201) | $backedUp = rename($moduleDir, $moduleDir . $tmp); |
| [202](#L202) | } |
| [203](#L203) | if ($backedUp) { |
| [204](#L204) | cluevo\_extract\_scorm\_module($archivePath, $moduleDir); |
| [205](#L205) | $href = cluevo\_find\_module\_index($moduleDir, false); |
| [206](#L206) | $scormVersion = cluevo\_get\_scorm\_version\_from\_manifest($moduleDir); |
| [207](#L207) | cluevo\_create\_module( |
| [208](#L208) | $oldModule->module\_name, |
| [209](#L209) | $oldModule->type\_id, |
| [210](#L210) | $oldModule->metadata\_id, |
| [211](#L211) | $oldModule->module\_dir, |
| [212](#L212) | $oldModule->module\_zip, |
| [213](#L213) | $href, |
| [214](#L214) | $oldModule->lang\_code, |
| [215](#L215) | $oldModule->module\_id, |
| [216](#L216) | $scormVersion |
| [217](#L217) | ); |
| [218](#L218) | $messages[] = \_\_("Cleaning up", "cluevo"); |
| [219](#L219) | if (file\_exists($archivePath . $tmp)) { |
| [220](#L220) | unlink($archivePath . $tmp); |
| [221](#L221) | } |
| [222](#L222) | if (file\_exists($moduleDir . $tmp)) { |
| [223](#L223) | cluevo\_delete\_directory($moduleDir . $tmp); |
| [224](#L224) | } |
| [225](#L225) | $messages[] = \_\_("Module extracted", "cluevo"); |
| [226](#L226) | } |
| [227](#L227) | } |
| [228](#L228) | } else { |
| [229](#L229) | if ($mime !== 'application/zip') { |
| [230](#L230) | if (file\_exists($archivePath)) { |
| [231](#L231) | $messages[] = esc\_html(sprintf(\_\_("Backing up zip: %s", "cluevo"), $archivePath)); |
| [232](#L232) | @rename($archivePath, $archivePath . $tmp); |
| [233](#L233) | } |
| [234](#L234) | if (move\_uploaded\_file($file, $archivePath)) { |
| [235](#L235) | if (file\_exists($moduleDir)) { |
| [236](#L236) | $messages[] = esc\_html(sprintf(\_\_("Backing up: %s", "cluevo"), $moduleDir)); |
| [237](#L237) | $backedUp = rename($moduleDir, $moduleDir . $tmp); |
| [238](#L238) | } |
| [239](#L239) | $handled = false; |
| [240](#L240) | $result = null; |
| [241](#L241) | do\_action('cluevo\_activate\_module', [ |
| [242](#L242) | "module" => $archivePath, |
| [243](#L243) | "mime" => $mime, |
| [244](#L244) | "messages" => &$messages, |
| [245](#L245) | "errors" => &$errors, |
| [246](#L246) | "parentModuleId" => $oldModule->module\_id, |
| [247](#L247) | "lang" => $oldModule->lang\_code, |
| [248](#L248) | "handled" => &$handled, |
| [249](#L249) | "result" => &$result |
| [250](#L250) | ]); |
| [251](#L251) | } |
| [252](#L252) | if ($handled) { |
| [253](#L253) | $messages[] = \_\_("Cleaning up", "cluevo"); |
| [254](#L254) | if (file\_exists($archivePath . $tmp)) { |
| [255](#L255) | unlink($archivePath . $tmp); |
| [256](#L256) | } |
| [257](#L257) | if (file\_exists($moduleDir . $tmp)) { |
| [258](#L258) | cluevo\_delete\_directory($moduleDir . $tmp); |
| [259](#L259) | } |
| [260](#L260) | $messages[] = \_\_("Module extracted", "cluevo"); |
| [261](#L261) | } else { |
| [262](#L262) | $errors[] = \_\_("No handler for this content type could be found.", "cluevo"); |
| [263](#L263) | unlink($archivePath); |
| [264](#L264) | } |
| [265](#L265) | } |
| [266](#L266) | } |
| [267](#L267) | return; |
| [268](#L268) | } |
| [269](#L269) | if (!empty($\_FILES["module-file"]["name"])) { |
| [270](#L270) | $file = sanitize\_text\_field($\_FILES['module-file']['tmp\_name']); |
| [271](#L271) | $filename = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_FILENAME)); |
| [272](#L272) | $ext = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_EXTENSION)); |
| [273](#L273) |  |
| [274](#L274) | $blacklistExt = cluevo\_get\_blacklisted\_extensions(); |
| [275](#L275) | $blacklistNames = cluevo\_get\_blacklisted\_filenames(); |
| [276](#L276) | if (in\_array($ext, $blacklistExt) || in\_array($filename, $blacklistNames)) { |
| [277](#L277) | $errors[] = \_\_("This type of file is not allowed", "cluevo"); |
| [278](#L278) | return; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | $finfo = finfo\_open(FILEINFO\_MIME\_TYPE); |
| [282](#L282) | $mime = sanitize\_mime\_type(finfo\_file($finfo, $file)); |
| [283](#L283) | $type = sanitize\_key(strtolower(cluevo\_get\_module\_type\_name\_from\_mime\_type($mime))); |
| [284](#L284) |  |
| [285](#L285) | if (!file\_exists(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH'))) { |
| [286](#L286) | mkdir(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH'), 0755, true); |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | $targetDirExists = true; |
| [290](#L290) | if (!file\_exists(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . "$type/")) { |
| [291](#L291) | $targetDirExists = @mkdir(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . "$type/", 0755, true); |
| [292](#L292) | } |
| [293](#L293) | $archivePath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower($type . '/' . sanitize\_file\_name($\_FILES["module-file"]['name'])); |
| [294](#L294) | $zipFile = strtolower(sanitize\_file\_name($\_FILES["module-file"]['name'])); |
| [295](#L295) | $realPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') . $filename . '/'; |
| [296](#L296) | $overwrite = false; |
| [297](#L297) |  |
| [298](#L298) | $lang = (!empty($\_POST["language"]) && ctype\_alpha($\_POST["language"])) ? sanitize\_text\_field($\_POST["language"]) : null; |
| [299](#L299) | $parentModule = null; |
| [300](#L300) | $parentModuleId = null; |
| [301](#L301) | $tmp\_pid = (!empty($\_POST["parent-module-id"]) && is\_numeric($\_POST["parent-module-id"])) ? (int)$\_POST["parent-module-id"] : null; |
| [302](#L302) | if (!empty($tmp\_pid)) { |
| [303](#L303) | $parentModule = cluevo\_get\_module($tmp\_pid); |
| [304](#L304) | $parentModuleId = $parentModule->module\_id; |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | if (move\_uploaded\_file($file, $archivePath)) { |
| [308](#L308) | $handled = false; |
| [309](#L309) | do\_action('cluevo\_activate\_module', [ |
| [310](#L310) | "module" => $archivePath, |
| [311](#L311) | "mime" => $mime, |
| [312](#L312) | "messages" => &$messages, |
| [313](#L313) | "errors" => &$errors, |
| [314](#L314) | "parentModuleId" => $parentModuleId, |
| [315](#L315) | "lang" => $lang, |
| [316](#L316) | "handled" => &$handled, |
| [317](#L317) | "result" => &$result |
| [318](#L318) | ]); |
| [319](#L319) | if (!$handled) { |
| [320](#L320) | $errors[] = \_\_("No handler for this content type could be found.", "cluevo"); |
| [321](#L321) | unlink($archivePath); |
| [322](#L322) | } |
| [323](#L323) | } else { |
| [324](#L324) | $errors[] = \_\_("Failed to move uploaded file.", "cluevo"); |
| [325](#L325) | } |
| [326](#L326) | } |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | function cluevo\_url\_exists($strUrl) |
| [330](#L330) | { |
| [331](#L331) | $headers = @get\_headers($strUrl); |
| [332](#L332) | foreach ($headers as $h) { |
| [333](#L333) | if (!$h || strpos($h, "200")) { |
| [334](#L334) | return true; |
| [335](#L335) | } |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | return false; |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | function cluevo\_handle\_module\_download($strUrl, &$errors, &$messages, &$handled, &$result = null) |
| [342](#L342) | { |
| [343](#L343) | if (empty($strUrl)) { |
| [344](#L344) | $errors[] = \_\_("URL should not be empty", "cluevo"); |
| [345](#L345) | return; |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | $url = esc\_url\_raw($strUrl, ['http', 'https', 'ftp']); |
| [349](#L349) | $path = parse\_url(urldecode($url), PHP\_URL\_PATH); |
| [350](#L350) | $ext = strtolower(pathinfo($path, PATHINFO\_EXTENSION)); |
| [351](#L351) | $validExtensions = ["zip", "mp3", "wav", "mp4", "webm"]; |
| [352](#L352) | $handled = false; |
| [353](#L353) | if (in\_array($ext, $validExtensions)) { |
| [354](#L354) | $title = sanitize\_text\_field(pathinfo($path, PATHINFO\_FILENAME)); |
| [355](#L355) | $filename = strtolower(pathinfo(sanitize\_file\_name(trim(basename($path), '/')),  PATHINFO\_FILENAME)) . ".$ext"; |
| [356](#L356) | $tmpPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower('tmp/' . $filename); |
| [357](#L357) | $res = @fopen($url, 'r'); |
| [358](#L358) | if ($res !== false) { |
| [359](#L359) | file\_put\_contents($tmpPath, $res); |
| [360](#L360) | $finfo = finfo\_open(FILEINFO\_MIME\_TYPE); |
| [361](#L361) | $mime = finfo\_file($finfo, $tmpPath); |
| [362](#L362) | $type = sanitize\_file\_name(strtolower(cluevo\_get\_module\_type\_name\_from\_mime\_type($mime))); |
| [363](#L363) |  |
| [364](#L364) | // handle updates |
| [365](#L365) | if (!empty($result) && is\_numeric($result)) { |
| [366](#L366) | $messages[] = \_\_("Attempting to update module", "cluevo"); |
| [367](#L367) | $oldModule = cluevo\_get\_module((int)$result); |
| [368](#L368) | $moduleDir = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), $oldModule->module\_dir); |
| [369](#L369) | $messages[] = esc\_html(sprintf(\_\_("Existing module found: %s", "cluevo"), $oldModule->module\_name)); |
| [370](#L370) | $archivePath = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH'), $oldModule->module\_zip); |
| [371](#L371) | $tmp = uniqid(); |
| [372](#L372) | if ($mime === 'application/zip' && cluevo\_is\_scorm\_zip($tmpPath)) { |
| [373](#L373) | $handled = true; |
| [374](#L374) | $messages[] = \_\_("SCORM file detected", "cluevo"); |
| [375](#L375) |  |
| [376](#L376) | if (!empty($oldModule->module\_zip) && $archivePath !== cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') && file\_exists($archivePath)) { |
| [377](#L377) | $messages[] = esc\_html(sprintf(\_\_("Backing up zip: %s", "cluevo"), $archivePath)); |
| [378](#L378) | @rename($archivePath, $archivePath . $tmp); |
| [379](#L379) | } |
| [380](#L380) | if (empty($oldModule->module\_zip)) { |
| [381](#L381) | $filename = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_FILENAME)); |
| [382](#L382) | $ext = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_EXTENSION)); |
| [383](#L383) | $type = sanitize\_file\_name(strtolower(cluevo\_get\_module\_type\_name\_from\_mime\_type($mime))); |
| [384](#L384) |  |
| [385](#L385) | $blacklistExt = cluevo\_get\_blacklisted\_extensions(); |
| [386](#L386) | $blacklistNames = cluevo\_get\_blacklisted\_filenames(); |
| [387](#L387) | if (in\_array($ext, $blacklistExt) || in\_array($filename, $blacklistNames)) { |
| [388](#L388) | $errors[] = \_\_("This type of file is not allowed", "cluevo"); |
| [389](#L389) | return; |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | $archivePath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower($type . '/' . sanitize\_file\_name($\_FILES["module-file"]['name'])); |
| [393](#L393) | } |
| [394](#L394) | $backedUp = false; |
| [395](#L395) | if (file\_exists($moduleDir)) { |
| [396](#L396) | $messages[] = esc\_html(sprintf(\_\_("Backing up: %s", "cluevo"), $moduleDir)); |
| [397](#L397) | $backedUp = rename($moduleDir, $moduleDir . $tmp); |
| [398](#L398) | } |
| [399](#L399) | if ($backedUp) { |
| [400](#L400) | cluevo\_extract\_scorm\_module($tmpPath, $moduleDir); |
| [401](#L401) | $href = cluevo\_find\_module\_index($moduleDir, false); |
| [402](#L402) | $scormVersion = cluevo\_get\_scorm\_version\_from\_manifest($moduleDir); |
| [403](#L403) | $messages[] = esc\_html(sprintf(\_\_("Updating module data. Index: %s, version: %s", "cluevo"), $href, $scormVersion)); |
| [404](#L404) | cluevo\_create\_module( |
| [405](#L405) | $oldModule->module\_name, |
| [406](#L406) | $oldModule->type\_id, |
| [407](#L407) | $oldModule->metadata\_id, |
| [408](#L408) | $oldModule->module\_dir, |
| [409](#L409) | $oldModule->module\_zip, |
| [410](#L410) | $href, |
| [411](#L411) | $oldModule->lang\_code, |
| [412](#L412) | $oldModule->module\_id, |
| [413](#L413) | $scormVersion |
| [414](#L414) | ); |
| [415](#L415) | $messages[] = \_\_("Cleaning up", "cluevo"); |
| [416](#L416) | if (file\_exists($archivePath . $tmp)) { |
| [417](#L417) | unlink($archivePath . $tmp); |
| [418](#L418) | } |
| [419](#L419) | if (file\_exists($moduleDir . $tmp)) { |
| [420](#L420) | cluevo\_delete\_directory($moduleDir . $tmp); |
| [421](#L421) | } |
| [422](#L422) | $messages[] = \_\_("Module extracted", "cluevo"); |
| [423](#L423) | } |
| [424](#L424) | } else { |
| [425](#L425) | if ($mime !== 'application/zip') { |
| [426](#L426) | if (file\_exists($archivePath)) { |
| [427](#L427) | $messages[] = esc\_html(sprintf(\_\_("Backing up zip: %s", "cluevo"), $archivePath)); |
| [428](#L428) | @rename($archivePath, $archivePath . $tmp); |
| [429](#L429) | } |
| [430](#L430) | if (move\_uploaded\_file($tmpPath, $archivePath)) { |
| [431](#L431) | if (file\_exists($moduleDir)) { |
| [432](#L432) | $messages[] = esc\_html(sprintf(\_\_("Backing up: %s", "cluevo"), $moduleDir)); |
| [433](#L433) | $backedUp = rename($moduleDir, $moduleDir . $tmp); |
| [434](#L434) | } |
| [435](#L435) | $handled = false; |
| [436](#L436) | $result = null; |
| [437](#L437) | do\_action('cluevo\_activate\_module', [ |
| [438](#L438) | "module" => $archivePath, |
| [439](#L439) | "mime" => $mime, |
| [440](#L440) | "messages" => &$messages, |
| [441](#L441) | "errors" => &$errors, |
| [442](#L442) | "parentModuleId" => $oldModule->module\_id, |
| [443](#L443) | "lang" => $oldModule->lang\_code, |
| [444](#L444) | "handled" => &$handled, |
| [445](#L445) | "result" => &$result |
| [446](#L446) | ]); |
| [447](#L447) | } |
| [448](#L448) | if ($handled) { |
| [449](#L449) | $messages[] = \_\_("Cleaning up", "cluevo"); |
| [450](#L450) | if (file\_exists($archivePath . $tmp)) { |
| [451](#L451) | unlink($archivePath . $tmp); |
| [452](#L452) | } |
| [453](#L453) | if (file\_exists($moduleDir . $tmp)) { |
| [454](#L454) | cluevo\_delete\_directory($moduleDir . $tmp); |
| [455](#L455) | } |
| [456](#L456) | $messages[] = \_\_("Module extracted", "cluevo"); |
| [457](#L457) | } else { |
| [458](#L458) | $errors[] = \_\_("No handler for this content type could be found.", "cluevo"); |
| [459](#L459) | unlink($archivePath); |
| [460](#L460) | } |
| [461](#L461) | } |
| [462](#L462) | } |
| [463](#L463) | return; |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | $targetDirExists = true; |
| [467](#L467) | if (!file\_exists(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . "$type/")) { |
| [468](#L468) | $targetDirExists = @mkdir(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . "$type/", 0755, true); |
| [469](#L469) | } |
| [470](#L470) | $archivePath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower("$type/" . $filename); |
| [471](#L471) | if ($targetDirExists && @rename($tmpPath, $archivePath)) { |
| [472](#L472) | $result = []; |
| [473](#L473) | $module = null; |
| [474](#L474) | do\_action('cluevo\_activate\_module', [ |
| [475](#L475) | "module" => $archivePath, |
| [476](#L476) | "title" => $title, |
| [477](#L477) | "mime" => $mime, |
| [478](#L478) | "messages" => &$messages, |
| [479](#L479) | "errors" => &$errors, |
| [480](#L480) | "parentModuleId" => null, |
| [481](#L481) | "lang" => null, |
| [482](#L482) | "handled" => &$handled, |
| [483](#L483) | "result" => &$result |
| [484](#L484) | ]); |
| [485](#L485) | if ($handled) { |
| [486](#L486) | return $result; |
| [487](#L487) | } |
| [488](#L488) | } else { |
| [489](#L489) | $errors[] = \_\_("An error occurred while moving the file to the target directory.", "cluevo"); |
| [490](#L490) | } |
| [491](#L491) | } else { |
| [492](#L492) | $errors[] = \_\_("File does not exist.", "cluevo"); |
| [493](#L493) | } |
| [494](#L494) | } else { |
| [495](#L495) | $result = []; |
| [496](#L496) | do\_action('cluevo\_handle\_module\_url\_install', [ |
| [497](#L497) | 'url' => $url, |
| [498](#L498) | "messages" => &$messages, |
| [499](#L499) | "errors" => &$errors, |
| [500](#L500) | "parentModuleId" => null, |
| [501](#L501) | "lang" => null, |
| [502](#L502) | "handled" => &$handled, |
| [503](#L503) | "result" => &$result, |
| [504](#L504) | "module" => &$module |
| [505](#L505) | ]); |
| [506](#L506) | if ($handled) { |
| [507](#L507) | return $result; |
| [508](#L508) | } else { |
| [509](#L509) | do\_action('cluevo\_handle\_misc\_module\_url\_input', [ |
| [510](#L510) | "input" => $url, |
| [511](#L511) | "messages" => &$messages, |
| [512](#L512) | "errors" => &$errors, |
| [513](#L513) | "handled" => &$handled, |
| [514](#L514) | "result" => &$result, |
| [515](#L515) | "module" => &$module |
| [516](#L516) | ]); |
| [517](#L517) | } |
| [518](#L518) | } |
| [519](#L519) | if (!$handled) { |
| [520](#L520) | $errors[] = \_\_("The module failed to install.", "cluevo"); |
| [521](#L521) | } |
| [522](#L522) | } |
| [523](#L523) |  |
| [524](#L524) | /\*\* |
| [525](#L525) | \* Recursively creates metadata posts of a given item |
| [526](#L526) | \* |
| [527](#L527) | \* Recursively creates parent's posts if necessary |
| [528](#L528) | \* |
| [529](#L529) | \* @param mixed $item |
| [530](#L530) | \* @param mixed $intParentId |
| [531](#L531) | \* @param mixed $tree |
| [532](#L532) | \*/ |
| [533](#L533) | function cluevo\_create\_metadata\_post($item, $intParentId, &$tree) |
| [534](#L534) | { |
| [535](#L535) | $parentPostId = $intParentId; |
| [536](#L536) |  |
| [537](#L537) | if (!empty($item->parent\_id)) { // if the item has a parent we need to have the parent post first before we can create the item's post |
| [538](#L538) |  |
| [539](#L539) | if ($item->new) { |
| [540](#L540) | if (array\_key\_exists($item->parent\_id, $tree)) { |
| [541](#L541) | $parentItem = $tree[$item->parent\_id]; |
| [542](#L542) | } else { |
| [543](#L543) | $parentItem = cluevo\_get\_learning\_structure\_item($item->tree\_id); |
| [544](#L544) | } |
| [545](#L545) | } else { |
| [546](#L546) | $parentItem = cluevo\_get\_learning\_structure\_item($item->parent\_id); |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | $parentPostId = $parentItem->metadata\_id; |
| [550](#L550) | $post = get\_post($parentPostId); |
| [551](#L551) | if (empty($post) || empty($parentPostId)) { // check if post exists or metadata id is empty |
| [552](#L552) | if (!empty($post)) { |
| [553](#L553) | $parentPostId = $post->ID; |
| [554](#L554) | } |
| [555](#L555) | if (!array\_key\_exists($item->parent\_id, $tree)) { |
| [556](#L556) | $tree[$item->parent\_id] = cluevo\_get\_learning\_structure\_item($item->parent\_id); |
| [557](#L557) | } |
| [558](#L558) | $parentPostId = cluevo\_create\_metadata\_post($tree[$item->parent\_id], $parentPostId, $tree); |
| [559](#L559) | } |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) | if (get\_post($item->metadata\_id) === null || empty($item->metadata\_id)) { |
| [563](#L563) | $id = cluevo\_create\_metadata\_page($item, $parentPostId); |
| [564](#L564) | $tree[$item->item\_id]->metadata\_id = $id; |
| [565](#L565) | } else { |
| [566](#L566) | cluevo\_update\_metadata\_page($item, $parentPostId); |
| [567](#L567) | $id = $item->metadata\_id; |
| [568](#L568) | } |
| [569](#L569) | return $id; |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | /\*\* |
| [573](#L573) | \* Returns a textbox and dropdown containing the selected modules as options |
| [574](#L574) | \* |
| [575](#L575) | \* @param mixed $name |
| [576](#L576) | \* @param mixed $modules |
| [577](#L577) | \* @param mixed $intSelected |
| [578](#L578) | \*/ |
| [579](#L579) | function cluevo\_render\_module\_list($name, $modules, $intSelected = null, $boolHideButton = false) |
| [580](#L580) | { |
| [581](#L581) | $out = "<input type=\"text\" data-target=\"name\" class=\"module-name sortable-name\" value=\"" . esc\_attr($name) . "\" /> "; |
| [582](#L582) | $labelVisible = 'hidden'; |
| [583](#L583) | $buttonVisible = 'hidden'; |
| [584](#L584) | $id = ''; |
| [585](#L585) | $name = ''; |
| [586](#L586) | if (!empty($intSelected)) { |
| [587](#L587) | $selected = null; |
| [588](#L588) | foreach ($modules as $module) { |
| [589](#L589) | if ($module->module\_id == $intSelected) { |
| [590](#L590) | $selected = $module; |
| [591](#L591) | break; |
| [592](#L592) | } |
| [593](#L593) | } |
| [594](#L594) | $labelVisible = ''; |
| [595](#L595) | if (!empty($selected)) { |
| [596](#L596) | $id = $selected->module\_id; |
| [597](#L597) | $name = $selected->module\_name; |
| [598](#L598) | } |
| [599](#L599) | } else { |
| [600](#L600) | $buttonVisible = ''; |
| [601](#L601) | } |
| [602](#L602) | $buttonVisible = ($boolHideButton) ? 'hidden' : $buttonVisible; |
| [603](#L603) | $out .= "<div class=\"module-name-label $labelVisible\" data-value=\"" . esc\_attr($id) . "\" data-target=\"module-id\"> |
| [604](#L604) | <div class=\"dashicons dashicons-welcome-learn-more label-icon\"></div> |
| [605](#L605) | <div class=\"content\">" . esc\_attr($name) . "</div> |
| [606](#L606) | <div class=\"dashicons dashicons-edit cluevo-edit-module label-icon-right\"></div> |
| [607](#L607) | <div class=\"dashicons dashicons-dismiss remove-module label-icon-right\"></div> |
| [608](#L608) | </div>"; |
| [609](#L609) | $out .= "<div class=\"cluevo-btn cluevo-make-module " . esc\_attr($buttonVisible) . "\">" . esc\_html\_\_("Insert Module", "cluevo") . "</div>"; |
| [610](#L610) | $allowed = wp\_kses\_allowed\_html("post"); |
| [611](#L611) | $allowed["input"] = ["type" => 1, "data-\*" => 1, "class" => 1, "value" => 1]; |
| [612](#L612) | return wp\_kses($out, $allowed);; |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | /\*\* |
| [616](#L616) | \* Callback to handle creation of new course groups |
| [617](#L617) | \* |
| [618](#L618) | \* Creates the database entries and metadata pages for tree items |
| [619](#L619) | \* |
| [620](#L620) | \* @param mixed $name |
| [621](#L621) | \*/ |
| [622](#L622) | function cluevo\_handle\_create\_learning\_structure($name) |
| [623](#L623) | { |
| [624](#L624) | $treeMetadataId = wp\_insert\_post(["post\_title" => sanitize\_title($name), "post\_status" => "publish", 'post\_type' => CLUEVO\_METADATA\_POST\_TYPE]); |
| [625](#L625) | $terms = get\_terms(['taxonomy' => CLUEVO\_TAXONOMY, 'hide\_empty' => false]); |
| [626](#L626) | if (is\_array($terms)) { |
| [627](#L627) | foreach ($terms as $term) { |
| [628](#L628) | if ($term->name == \_\_("Course Group", "cluevo")) { |
| [629](#L629) | wp\_set\_post\_terms($treeMetadataId, [$term->term\_id], CLUEVO\_TAXONOMY); |
| [630](#L630) | break; |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) | } |
| [634](#L634) | $treeIndex = cluevo\_create\_learning\_structure($name, $treeMetadataId); |
| [635](#L635) | update\_option("cluevo-selected-course-group", $treeIndex); |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | /\*\* |
| [639](#L639) | \* Creates the metadata post for a module |
| [640](#L640) | \* |
| [641](#L641) | \* Returns the new post id on success |
| [642](#L642) | \* |
| [643](#L643) | \* @param string $strFilename |
| [644](#L644) | \* |
| [645](#L645) | \* @return int|WP\_Error |
| [646](#L646) | \*/ |
| [647](#L647) | function cluevo\_create\_module\_metadata\_post($strFilename) |
| [648](#L648) | { |
| [649](#L649) | $id = wp\_insert\_post( |
| [650](#L650) | [ |
| [651](#L651) | "post\_title" => sanitize\_title($strFilename), |
| [652](#L652) | "post\_status" => "publish", |
| [653](#L653) | "post\_type" => CLUEVO\_METADATA\_POST\_TYPE\_SCORM\_MODULE |
| [654](#L654) | ] |
| [655](#L655) | ); |
| [656](#L656) | $terms = get\_terms(['taxonomy' => 'CLUEVO', 'hide\_empty' => false]); |
| [657](#L657) | if (is\_array($terms)) { |
| [658](#L658) | foreach ($terms as $term) { |
| [659](#L659) | if ($term->name == \_\_("SCORM Module", "cluevo")) { |
| [660](#L660) | wp\_set\_post\_terms($id, [$term->term\_id], \_\_("SCORM MODULE", "cluevo")); |
| [661](#L661) | break; |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | return $id; |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | /\*\* |
| [670](#L670) | \* Renders an item recursively |
| [671](#L671) | \* |
| [672](#L672) | \* @param mixed $item |
| [673](#L673) | \* @param array $modules |
| [674](#L674) | \* @param mixed $forceId |
| [675](#L675) | \*/ |
| [676](#L676) | function cluevo\_render\_courses($item, $modules = array(), $forceId = null) |
| [677](#L677) | { |
| [678](#L678) | if (empty($item)) return; |
| [679](#L679) | // these variables contain learn unit information. TODO: develop a system of storing and retrieving this information to make it easily extensible. Maybe create an interface or include php files |
| [680](#L680) | $url = remove\_query\_arg(['create-metadata-page']); |
| [681](#L681) | if (get\_class($item) === 'CluevoItem') $item->load\_settings(); |
| [682](#L682) | $name = (!empty($item->name)) ? $item->name : ''; |
| [683](#L683) | $level = (!empty($item->level)) ? $item->level : 0; |
| [684](#L684) | $pointsNeeded = (!empty($item->points\_required)) ? $item->points\_required : 0; |
| [685](#L685) | $pointsWorth = (is\_numeric($item->points\_worth)) ? (int)$item->points\_worth : 0; |
| [686](#L686) | $levelRequired = (!empty($item->level\_required)) ? $item->level\_required : 0; |
| [687](#L687) | $dependencies = (!empty($item->dependencies)) ? $item->dependencies : ['modules' => ['normal' => [], 'blocked' => [], 'inherited' => []], 'other' => ['normal' => [], 'blocked' => [], 'inherited' => []]]; |
| [688](#L688) | $repeatInterval = (!empty($item->repeat\_interval)) ? $item->repeat\_interval : 0; |
| [689](#L689) | $repeatIntervalType = (!empty($item->repeat\_interval\_type)) ? $item->repeat\_interval\_type : 'day'; |
| [690](#L690) | $moduleId = (!empty($item->module\_id)) ? ' data-module-id="' . esc\_attr($item->module\_id) . '"' : ''; |
| [691](#L691) | $displayMode = ($item->type == "module") ? ' data-display-mode="' . esc\_attr($item->display\_mode) . '"' : ''; |
| [692](#L692) | $defaultDisplayMode = strtolower(get\_option('cluevo-modules-display-mode')); |
| [693](#L693) | $link = $item->get\_setting("item-is-link"); |
| [694](#L694) | $isLink = false; |
| [695](#L695) | if (!empty($link) && is\_string($link)) { |
| [696](#L696) | $isLink = (trim($link) !== "") ? true : false; |
| [697](#L697) | } |
| [698](#L698) | //$moduleId = 0; |
| [699](#L699) | $metadataId = 0; |
| [700](#L700) | if (!empty($item)) { |
| [701](#L701) | $item->id = (empty($item->id)) ? 0 : $item->id; |
| [702](#L702) | $item->id = (empty($item->item\_id)) ? $item->id : $item->item\_id; |
| [703](#L703) | $id = 'item-' . $item->id; |
| [704](#L704) | $id = (!empty($forceId)) ? $forceId : $id; |
| [705](#L705) | $metadataId = $item->metadata\_id; |
| [706](#L706) | } else { |
| [707](#L707) | $id = (!empty($forceId)) ? $forceId : 0; |
| [708](#L708) | } |
| [709](#L709) |  |
| [710](#L710) | $hasDependencies = false; |
| [711](#L711) | foreach ($dependencies as $depType => $deps) { |
| [712](#L712) | foreach ($deps as $dep) { |
| [713](#L713) | if (!empty($dep)) { |
| [714](#L714) | $hasDependencies = true; |
| [715](#L715) | break; |
| [716](#L716) | } |
| [717](#L717) | } |
| [718](#L718) | if ($hasDependencies) break; |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) |  |
| [722](#L722) | $classes = []; |
| [723](#L723) | $classes[] = ($item->published) ? "published" : "draft"; |
| [724](#L724) | if (!empty($item->module\_id) && (int)$item->module\_id > 0) $classes[] = "module-assigned"; |
| [725](#L725) | if ($hasDependencies) $classes[] = "has-dependencies"; |
| [726](#L726) | if ($isLink) $classes[] = "is-link"; |
| [727](#L727) | $classes = implode(" ", $classes); |
| [728](#L728) |  |
| [729](#L729) | echo '<li id="' . esc\_attr($id) . '" |
| [730](#L730) | class="lms-tree-item ' . esc\_attr($classes) . '" |
| [731](#L731) | data-item-id="' . esc\_attr($item->item\_id) . '" |
| [732](#L732) | data-name="' . esc\_attr($item->name) . '" |
| [733](#L733) | data-id="' . esc\_attr($item->id) . '" |
| [734](#L734) | data-module-id="' . esc\_attr($item->module\_id) . '" |
| [735](#L735) | data-level="' . esc\_attr($item->level) . '" |
| [736](#L736) | data-type="' . esc\_attr(CLUEVO\_LEARNING\_STRUCTURE\_LEVELS[$item->level]) . '" |
| [737](#L737) | data-dependencies=\'' . json\_encode($item->dependencies) . '\' |
| [738](#L738) | data-repeat-interval="' . esc\_attr($item->repeat\_interval) . '" |
| [739](#L739) | data-repeat-interval-type="' . esc\_attr($item->repeat\_interval\_type)  . '" |
| [740](#L740) | data-metadata-id="' . esc\_attr($item->metadata\_id) . '" |
| [741](#L741) | data-published="' . esc\_attr($item->published) . '" |
| [742](#L742) | data-item-is-link="' . esc\_attr($isLink) . '" |
| [743](#L743) | data-login-required="' . esc\_attr($item->login\_required) . '"' . $displayMode . '>'; |
| [744](#L744) | ?> |
| [745](#L745) | <div class="handle"> |
| [746](#L746) | <div class="move-container"> |
| [747](#L747) | <div class="up"><span class="dashicons dashicons-arrow-up-alt"></span></div> |
| [748](#L748) | <div class="down"><span class="dashicons dashicons-arrow-down-alt"></span></div> |
| [749](#L749) | </div> |
| [750](#L750) | <span class="title"> |
| [751](#L751) | <?php echo cluevo\_render\_module\_list($name, $modules, (!empty($item->module) && $item->module > 0) ? $item->module : null, (empty($item->children) ? false : true)); ?> |
| [752](#L752) | <span class="type fade"> |
| [753](#L753) | <?php |
| [754](#L754) | $nextItemType = 'element'; |
| [755](#L755) | switch ($item->type) { |
| [756](#L756) | case "course": |
| [757](#L757) | echo \_\_("Course", "cluevo"); |
| [758](#L758) | $nextItemType = \_\_("Chapter", "cluevo"); |
| [759](#L759) | break; |
| [760](#L760) | case "chapter": |
| [761](#L761) | echo \_\_("Chapter", "cluevo"); |
| [762](#L762) | $nextItemType = \_\_("Module", "cluevo"); |
| [763](#L763) | break; |
| [764](#L764) | case "module": |
| [765](#L765) | echo \_\_("Module", "cluevo"); |
| [766](#L766) | break; |
| [767](#L767) | default: |
| [768](#L768) | echo ""; |
| [769](#L769) | } |
| [770](#L770) | ?> |
| [771](#L771) | </span> |
| [772](#L772) | <span class="tree-item-id fade shortcode copy-shortcode" title="<?php esc\_attr\_e("Copy Shortcode", "cluevo"); ?>">[<?php echo (!empty($item)) ? esc\_attr($item->id) : ""; ?>]</span> |
| [773](#L773) | </span> |
| [774](#L774) | <div class="buttons"> |
| [775](#L775) | <span class="cluevo-item-is-link dashicons dashicons-admin-links"></span> |
| [776](#L776) | <img class="has-dependencies-icon" alt="<?php esc\_attr\_e("This item has dependencies", "cluevo"); ?>" title="<?php esc\_attr\_e("This item has dependencies", "cluevo"); ?>" src="<?php echo plugins\_url("/images/icon-dependency-neg.svg", plugin\_dir\_path(\_\_FILE\_\_)); ?>" /> |
| [777](#L777) | <?php do\_action("cluevo\_lms\_item\_handle\_tools", $item); ?> |
| [778](#L778) | <div class="publish cluevo-btn cluevo-btn-square cluevo-button-primary" title="<?php ($item->published) ? esc\_attr\_e("Published", "cluevo") : esc\_attr\_e('Draft', "cluevo"); ?>"> |
| [779](#L779) | <?php if ($item->published) { ?><span class="dashicons dashicons-visibility"></span> |
| [780](#L780) | <?php } else { ?><span class="dashicons dashicons-hidden"></span><?php } ?> |
| [781](#L781) | </div> |
| [782](#L782) | <?php if ($item->level < 3) { ?> |
| [783](#L783) | <div class="add cluevo-btn cluevo-btn-square cluevo-button-primary" <?php echo (!empty($item->module\_id) && $item->module\_id > 0) ? 'disabled="disabled"' : ''; ?> title="<?php esc\_attr\_e(sprintf(\_\_("Add %s to this item", "cluevo"), $nextItemType)); ?>"><img class="plugin-logo" src="<?php echo plugins\_url("/images/icon-add-child.svg", plugin\_dir\_path(\_\_FILE\_\_)); ?>" /></div> |
| [784](#L784) | <?php } ?> |
| [785](#L785) | <?php if (get\_post($metadataId) !== null) { ?> |
| [786](#L786) | <a class="metadata cluevo-btn cluevo-btn-square metadata-edit-link" title="<?php \_e("Open this elements post", "cluevo"); ?>" href="<?php echo get\_edit\_post\_link($metadataId); ?>" target="\_blank"><span class="dashicons dashicons-wordpress"></span></a> |
| [787](#L787) | <?php } else { ?> |
| [788](#L788) | <a class="cluevo-btn cluevo-btn-square cluevo-btn-primary" title="<?php esc\_attr\_e("Create item page", "cluevo"); ?>" href="<?php echo add\_query\_arg('create-metadata-page', $item->id, $url); ?>"><span class="dashicons dashicons-wordpress"></span></a> |
| [789](#L789) | <?php } ?> |
| [790](#L790) | <div class="shortcode cluevo-btn cluevo-btn-square copy-shortcode" title="<?php \_e("Copy Shortcode", "cluevo"); ?>">[s]</div> |
| [791](#L791) | <div class="meta-toggle cluevo-btn cluevo-btn-square" title="<?php \_e("Element Settings", "cluevo"); ?>"><span class="dashicons dashicons-admin-generic"></span></div> |
| [792](#L792) | <div class="remove cluevo-btn cluevo-btn-square" title="<?php \_e("Delete Element", "cluevo"); ?>"><span class="dashicons dashicons-trash"></span></div> |
| [793](#L793) | <div class="expand cluevo-btn cluevo-btn-square <?php if ($item->level > 2) echo "disabled"; ?>"><span class="dashicons dashicons-arrow-down"></span></div> |
| [794](#L794) | </div> |
| [795](#L795) | </div> |
| [796](#L796) |  |
| [797](#L797) | <div class="meta"> |
| [798](#L798) |  |
| [799](#L799) | <div class="meta-content-container"> |
| [800](#L800) | <h2><?php echo \_\_("Settings", "cluevo"); ?></h2> |
| [801](#L801) |  |
| [802](#L802) | <?php do\_action('cluevo\_tree\_item\_settings', $item); ?> |
| [803](#L803) |  |
| [804](#L804) | <div class="meta-container points global"> |
| [805](#L805) | <details> |
| [806](#L806) | <summary class="label"><?php \_e("Points", "cluevo"); ?> |
| [807](#L807) |  |
| [808](#L808) | <p class="help"> |
| [809](#L809) | <?php \_e("Defines the worth in points of an item or respectively how many points a user has to have to gain access.", "cluevo"); ?> |
| [810](#L810) | </p> |
| [811](#L811) | </summary> |
| [812](#L812) |  |
| [813](#L813) | <div class="point-wrap input-list-container inline"> |
| [814](#L814) | <div class="points-container points-worth input-container"> |
| [815](#L815) | <label><?php \_e("Worth", "cluevo"); ?></label> |
| [816](#L816) | <input type="number" min="0" value="<?php echo esc\_attr($pointsWorth); ?>" data-target="points-worth" /> |
| [817](#L817) | </div> |
| [818](#L818) |  |
| [819](#L819) | <div class="points-container practice-points input-container"> |
| [820](#L820) | <label><?php \_e("Practice points", "cluevo"); ?></label> |
| [821](#L821) | <input type="number" min="0" value="<?php echo esc\_attr($item->practice\_points); ?>" data-target="practice-points" /> |
| [822](#L822) | </div> |
| [823](#L823) |  |
| [824](#L824) | <div class="points-container points-required input-container"> |
| [825](#L825) | <label><?php \_e("Required", "cluevo"); ?></label> |
| [826](#L826) | <input type="number" min="0" value="<?php echo esc\_attr($pointsNeeded); ?>" data-target="points-required" /> |
| [827](#L827) | </div> |
| [828](#L828) | </div> |
| [829](#L829) | </details> |
| [830](#L830) | </div> |
| [831](#L831) |  |
| [832](#L832) | <div class="meta-container level global"> |
| [833](#L833) | <details> |
| [834](#L834) | <summary class="label"><?php \_e("Required level", "cluevo"); ?> |
| [835](#L835) | <p class="help"> |
| [836](#L836) | <?php \_e("Defines the level a user has to have reached to access an item.", "cluevo"); ?> |
| [837](#L837) | </p> |
| [838](#L838) | </summary> |
| [839](#L839) | <div class="input-list-container inline"> |
| [840](#L840) | <div class="input-container"> |
| [841](#L841) | <label><?php echo \_\_("Level", "cluevo"); ?></label> |
| [842](#L842) | <input type="number" min="0" value="<?php echo esc\_attr((int)$levelRequired); ?>" data-target="level-required" /> |
| [843](#L843) | </div> |
| [844](#L844) | </div> |
| [845](#L845) | </details> |
| [846](#L846) | </div> |
| [847](#L847) |  |
| [848](#L848) | <div class="meta-container dependency-container"> |
| [849](#L849) | <div class="label"><?php \_e("Requirements", "cluevo"); ?></div> |
| [850](#L850) | <p class="help"> |
| [851](#L851) | <?php \_e("Defines the requirements users have to fulfill to access this element.", "cluevo"); ?> |
| [852](#L852) | </p> |
| [853](#L853) | <div class="dep-checkbox-container" data-target="dependencies"> |
| [854](#L854) | </div> |
| [855](#L855) | </div> |
| [856](#L856) |  |
| [857](#L857) | <?php if ($level == count(CLUEVO\_LEARNING\_STRUCTURE\_LEVELS) - 1) { ?> |
| [858](#L858) | <!-- <div class="meta-container repeating global"> |
| [859](#L859) | <div class="label"><?php \_e("Module must be repeated periodically", "cluevo"); ?></div> |
| [860](#L860) | <p class="help"> |
| [861](#L861) | <?php \_e("Defines the interval in which a module has to be repeated.", "cluevo"); ?> |
| [862](#L862) | </p> |
| [863](#L863) | <div class="meta-input-fields-container"> |
| [864](#L864) | <input type="number" min="0" value="<?php echo esc\_attr($repeatInterval); ?>" data-target="repeat-interval"/> |
| [865](#L865) | <select class="repeat-interval-type" data-target="repeat-interval-type"> |
| [866](#L866) | <?php foreach (CLUEVO\_REPEAT\_INTERVAL\_TYPES as $key => $value) { ?> |
| [867](#L867) | <option value="<?php echo esc\_attr($key); ?>"<?php if ($repeatIntervalType === $key) echo ' selected="selected"'; ?>><?php echo esc\_attr($value); ?></option> |
| [868](#L868) | <?php } ?> |
| [869](#L869) | </select> |
| [870](#L870) | </div> |
| [871](#L871) | </div> --> |
| [872](#L872) | <?php } ?> |
| [873](#L873) |  |
| [874](#L874) | </div> |
| [875](#L875) | </div> |
| [876](#L876) |  |
| [877](#L877) | <?php |
| [878](#L878) | // render children of the current item |
| [879](#L879) | $nextLevel = $level + 1; |
| [880](#L880) | echo "<ol id=\"level-$nextLevel\" data-level=\"$nextLevel\">\n"; |
| [881](#L881) | if (!empty($item->children)) { |
| [882](#L882) | foreach ($item->children as $key => $child) { |
| [883](#L883) | cluevo\_render\_courses($child, $modules); |
| [884](#L884) | } |
| [885](#L885) | } |
| [886](#L886) | echo "</ol>\n"; |
| [887](#L887) | echo "\t</li>\n"; |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) | /\*\* |
| [891](#L891) | \* Outputs the module ui and handles deletion of modules |
| [892](#L892) | \* |
| [893](#L893) | \*/ |
| [894](#L894) | function cluevo\_render\_module\_ui($errors = [], $messages = []) |
| [895](#L895) | { |
| [896](#L896) | $pending = cluevo\_find\_pending\_modules(); |
| [897](#L897) | $tab = (!empty($\_GET["tab"]) && ctype\_alpha($\_GET["tab"])) ? cluevo\_strip\_non\_alpha($\_GET["tab"]) : CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE; |
| [898](#L898) |  |
| [899](#L899) | $plugin\_dir = plugin\_dir\_path(\_\_DIR\_\_); |
| [900](#L900) | $scorm\_dir = $plugin\_dir . "scorm-modules"; |
| [901](#L901) | $archive\_dir = $plugin\_dir . "scorm-modules-archive/"; |
| [902](#L902) |  |
| [903](#L903) | if (file\_exists($scorm\_dir) || file\_exists($archive\_dir)) { |
| [904](#L904) | $messages[] = \_\_("There are modules inside the old module Directory. Click here to start the migration: ", "cluevo") . " <a href=\"" . add\_query\_arg("migrate", "true") . "\">[" . \_\_("migrate modules", "cluevo") . "]</a>"; |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | // handle module deletion |
| [908](#L908) | $deleted = false; |
| [909](#L909) | $del\_module = (!empty($\_GET["delete-module"]) && is\_numeric($\_GET["delete-module"])) ? (int)$\_GET["delete-module"] : null; |
| [910](#L910) | if (!empty($del\_module)) { |
| [911](#L911) | // check if modules exists in database, delete module and archive zip and remove from database |
| [912](#L912) | $modules = cluevo\_get\_modules(); |
| [913](#L913) | $moduleId = $del\_module; |
| [914](#L914) | $module = cluevo\_get\_module($moduleId); |
| [915](#L915) | if (!empty($module)) { |
| [916](#L916) | $delModule = $module->module\_dir; |
| [917](#L917) | $delPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') . $delModule; |
| [918](#L918) | $delZip = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . $module->module\_zip; |
| [919](#L919) | if (!empty($module->module\_dir) && file\_exists($delPath) && !empty($delPath)) { |
| [920](#L920) | if (!empty($delModule)) { |
| [921](#L921) | cluevo\_delete\_directory($delPath); |
| [922](#L922) | } |
| [923](#L923) | if (!empty($module->module\_zip) && file\_exists($delZip) && !empty($delZip)) |
| [924](#L924) | unlink($delZip); |
| [925](#L925) | cluevo\_remove\_module($moduleId); |
| [926](#L926) | $deleted = true; |
| [927](#L927) | } else { |
| [928](#L928) | cluevo\_remove\_module($moduleId); |
| [929](#L929) | $deleted = true; |
| [930](#L930) | } |
| [931](#L931) | } |
| [932](#L932) | do\_action("cluevo\_module\_deleted", $moduleId); |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | // create metadata page |
| [936](#L936) | $pageCreated = false; |
| [937](#L937) | $create\_page = (!empty($\_GET["create-metadata-page"]) && is\_numeric($\_GET["create-metadata-page"])) ? (int)$\_GET["create-metadata-page"] : null; |
| [938](#L938) | if (!empty($create\_page)) { |
| [939](#L939) | $moduleId = $create\_page; |
| [940](#L940) | if (!cluevo\_get\_module\_metadata\_page($moduleId)) { // create metadata page for the uploaded module if the page doesn't yet exist |
| [941](#L941) | $module = cluevo\_get\_module($moduleId); |
| [942](#L942) | if (!empty($module)) { |
| [943](#L943) | $id = wp\_insert\_post( |
| [944](#L944) | [ |
| [945](#L945) | "post\_title" => sanitize\_title($module->module\_name), |
| [946](#L946) | "post\_status" => "publish", |
| [947](#L947) | "post\_type" => CLUEVO\_METADATA\_POST\_TYPE\_SCORM\_MODULE |
| [948](#L948) | ] |
| [949](#L949) | ); |
| [950](#L950) | $terms = get\_terms(['taxonomy' => CLUEVO\_TAXONOMY, 'hide\_empty' => false]); |
| [951](#L951) | if (is\_array($terms)) { |
| [952](#L952) | foreach ($terms as $term) { |
| [953](#L953) | if ($term->name == \_\_("SCORM Module", "cluevo")) { |
| [954](#L954) | wp\_set\_post\_terms($id, [$term->term\_id], \_\_('SCORM Module', "cluevo")); |
| [955](#L955) | break; |
| [956](#L956) | } |
| [957](#L957) | } |
| [958](#L958) | } |
| [959](#L959) | cluevo\_update\_module\_metadata\_id($moduleId, $id); |
| [960](#L960) | $pageCreated = true; |
| [961](#L961) | } |
| [962](#L962) | } |
| [963](#L963) | } |
| [964](#L964) |  |
| [965](#L965) | $url = remove\_query\_arg(['create-metadata-page', 'delete-module']); |
| [966](#L966) | $modules = cluevo\_get\_modules(); |
| [967](#L967) | $page = CLUEVO\_ADMIN\_PAGE\_LMS; |
| [968](#L968) |  |
| [969](#L969) | $moduleTypes = []; |
| [970](#L970) | do\_action('cluevo\_register\_module\_types', ["types" => &$moduleTypes]); |
| [971](#L971) | $execTime = ini\_get('max\_execution\_time'); |
| [972](#L972) |  |
| [973](#L973) | cluevo\_display\_notice( |
| [974](#L974) | \_\_("Info", "cluevo"), |
| [975](#L975) | sprintf(\_\_("Depending on the size of your modules installation can take quite a bit of time. On most hosts the time available for scripts is limited, on your server it seems to be limited to %s seconds. The bigger your modules are the longer the installation process takes and the bigger your max. execution time needs to be. We will attempt to increase this value during module instalaltion but not all hosts support this. If larger modules fail to install you should ask your hosting provider to increase your max. execution time.", "cluevo"), $execTime), |
| [976](#L976) | "warning", |
| [977](#L977) | "cluevo-max-exec-time-info" |
| [978](#L978) | ); |
| [979](#L979) | if (!class\_exists('ZipArchive')) { |
| [980](#L980) | cluevo\_display\_notice( |
| [981](#L981) | \_\_("Missing PHP Extension", "cluevo"), |
| [982](#L982) | \_\_("CLUEVO LMS requires the ZipArchive class from the PHP zip extension. You won't be able to upload zipped modules until zip support is enabled. ZipArchive is required because CLUEVO LMS does some checks before extracting modules to protect you from malicious zip files. Please contact your hosting provider to enable this extension.", "cluevo"), |
| [983](#L983) | "warning" |
| [984](#L984) | ); |
| [985](#L985) | } |
| [986](#L986) | if (!extension\_loaded('fileinfo')) { |
| [987](#L987) | cluevo\_display\_notice( |
| [988](#L988) | \_\_("Missing PHP Extension", "cluevo"), |
| [989](#L989) | \_\_("CLUEVO LMS requires the fileinfo\_\* functions from the PHP FileInfo module. You won't be able to install some module types without this extension. Please contact your hosting provider to enable this module.", "cluevo"), |
| [990](#L990) | "warning" |
| [991](#L991) | ); |
| [992](#L992) | } |
| [993](#L993) | ?> |
| [994](#L994) | <?php if (!empty($moduleTypes) && is\_array($moduleTypes)) { ?> |
| [995](#L995) | <div class="cluevo-add-module-overlay" id="cluevo-add-module-overlay" data-max-upload-size="<?php echo esc\_attr(wp\_max\_upload\_size()); ?>"> |
| [996](#L996) | <div class="modal-mask"> |
| [997](#L997) | <div class="modal-wrapper"> |
| [998](#L998) | <div class="modal-container"> |
| [999](#L999) | <div class="modal-header"> |
| [1000](#L1000) | <h3><?php esc\_html\_e('Add Module', 'cluevo'); ?></h3> |
| [1001](#L1001) | <button class="close"><span class="dashicons dashicons-no-alt"></span></button> |
| [1002](#L1002) | </div> |
| [1003](#L1003) | <div class="modal-body"> |
| [1004](#L1004) | <div class="cluevo-add-module-content-container module-type cluevo-update-module-content-container"> |
| [1005](#L1005) | <div class="cluevo-notice cluevo-notice-warning"> |
| [1006](#L1006) | <p><?php esc\_html\_e("Please make sure the module update you are uploading is of the same type as the existing module. Changing SCORM versions is fine but going from e.g. SCORM to PDF will not work and will probably have unforseen consequences.", "cluevo"); ?> |
| [1007](#L1007) | </div> |
| [1008](#L1008) | <form method="post" enctype="multipart/form-data" class="cluevo-module-form" action="<?php echo esc\_url(admin\_url("admin.php?page=$page&tab=$tab"), ['http', 'https']); ?>"> |
| [1009](#L1009) | <div class="input-switch"> |
| [1010](#L1010) | <input type="text" name="module-dl-url" placeholder="https://" /> |
| [1011](#L1011) | <label class="cluevo cluevo-module-install-type-file"> |
| [1012](#L1012) | <div class="cluevo-btn"><?php esc\_html\_e("Browse...", "cluevo"); ?></div> |
| [1013](#L1013) | <input type="file" name="module-file" value="" /> |
| [1014](#L1014) | </label> |
| [1015](#L1015) | </div> |
| [1016](#L1016) | <input type="submit" class="cluevo-btn auto cluevo-btn-primary disabled" value="<?php echo \_\_("Install Module", "cluevo"); ?>" disabled /> |
| [1017](#L1017) | </form> |
| [1018](#L1018) | <p><?php \_e("Max. Filesize: ", "cluevo") . esc\_html\_e(cluevo\_human\_filesize(wp\_max\_upload\_size())); ?></p> |
| [1019](#L1019) | <div class="cluevo-notice cluevo-notice-error cluevo-filesize hidden"> |
| [1020](#L1020) | <p><?php esc\_html\_e(sprintf(\_\_("The file you are trying to upload is too big. The maximum upload size is %s", "cluevo"), cluevo\_human\_filesize(wp\_max\_upload\_size()))); ?> |
| [1021](#L1021) | </div> |
| [1022](#L1022) | </div> |
| [1023](#L1023) | <div class="upload-progress"> |
| [1024](#L1024) | <h2 class="progress-text"><?php esc\_html\_e("The module is being uploaded, one moment please...", "cluevo"); ?></h2> |
| [1025](#L1025) | <div class="cluevo-progress-container"> |
| [1026](#L1026) | <span class="cluevo-progress" data-value="" data-max="100"></span> |
| [1027](#L1027) | </div> |
| [1028](#L1028) | <div class="result-container"></div> |
| [1029](#L1029) | <div class="cluevo-btn continue"><?php esc\_html\_e("Continue", "cluevo"); ?></div> |
| [1030](#L1030) | <div class="cluevo-btn force"><?php esc\_html\_e("Try to install anyway", "cluevo"); ?></div> |
| [1031](#L1031) | </div> |
| [1032](#L1032) | <div class="cluevo-add-module-content-container"> |
| [1033](#L1033) | <div class="module-type-selection"> |
| [1034](#L1034) | <div class="add-module-text"><?php esc\_html\_e('You can add new modules to your LMS here.', 'cluevo'); ?></div> |
| [1035](#L1035) | <h2><?php esc\_html\_e('The following module types are currently available', 'cluevo'); ?></h2> |
| [1036](#L1036) | <div class="module-list"> |
| [1037](#L1037) | <?php foreach ($moduleTypes as $key => $type) { ?> |
| [1038](#L1038) | <div class="module-type <?php if (!empty($type["alt-icon-class"])) { |
| [1039](#L1039) | echo esc\_attr($type["alt-icon-class"]); |
| [1040](#L1040) | } ?>" data-module-index="<?php echo esc\_attr($key); ?>"> |
| [1041](#L1041) | <?php if (!empty($type['icon'])) { ?><div class="module-icon"><img src="<?php echo esc\_attr($type['icon']); ?>" /></div><?php } ?> |
| [1042](#L1042) | <?php if (!empty($type["name"])) { ?> |
| [1043](#L1043) | <div class="module-type-name"><?php echo esc\_html($type['name']); ?></div> |
| [1044](#L1044) | <?php } ?> |
| [1045](#L1045) | </div> |
| [1046](#L1046) | <?php } ?> |
| [1047](#L1047) | </div> |
| [1048](#L1048) | </div> |
| [1049](#L1049) | <div class="module-description-container"> |
| [1050](#L1050) | <div class="module-type hint"> |
| [1051](#L1051) | <p><?php esc\_html\_e('Select a module type to display further information.', 'cluevo'); ?></p> |
| [1052](#L1052) | </div> |
| [1053](#L1053) | <?php foreach ($moduleTypes as $key => $type) { ?> |
| [1054](#L1054) | <div class="module-type <?php if (!empty($type["alt-icon-class"])) { |
| [1055](#L1055) | echo esc\_attr($type["alt-icon-class"]); |
| [1056](#L1056) | } ?>" data-module-index="<?php echo esc\_attr($key); ?>" data-module-type="<?php echo esc\_attr($type['key']); ?>"> |
| [1057](#L1057) | <div class="description-container"> |
| [1058](#L1058) | <?php if (!empty($type['icon'])) { ?><div class="module-icon"><img src="<?php echo esc\_attr($type['icon']); ?>" /></div><?php } ?> |
| [1059](#L1059) | <div> |
| [1060](#L1060) | <h3><?php echo esc\_html($type['name']); ?></h3> |
| [1061](#L1061) | <p><?php echo esc\_html($type['description']); ?></p> |
| [1062](#L1062) | </div> |
| [1063](#L1063) | </div> |
| [1064](#L1064) | <?php if (!empty($type["field"])) { ?> |
| [1065](#L1065) | <form method="post" enctype="multipart/form-data" class="cluevo-module-form <?php if (!empty($type['form-class'])) echo esc\_attr($type["form-class"]); ?>" action="<?php echo esc\_url(admin\_url("admin.php?page=$page&tab=$tab"), ['http', 'https']); ?>" data-type="<?php echo esc\_attr($type["name"]); ?>"> |
| [1066](#L1066) | <?php if (!empty($type["field"]) && $type["field"] == "text") { ?> |
| [1067](#L1067) | <input type="text" name="module-dl-url" placeholder="<?php echo esc\_attr($type['field-placeholder']); ?>" /> |
| [1068](#L1068) | <?php } ?> |
| [1069](#L1069) | <?php if (!empty($type["field"]) && $type["field"] == "file") { ?> |
| [1070](#L1070) | <input type="file" name="module-file" placeholder="<?php echo esc\_attr($type['field-placeholder']); ?>" /> |
| [1071](#L1071) | <?php } ?> |
| [1072](#L1072) | <?php if (!empty($type["field"]) && $type["field"] == "mixed") { ?> |
| [1073](#L1073) | <div class="input-switch"> |
| [1074](#L1074) | <input type="text" name="module-dl-url" placeholder="https://" /> |
| [1075](#L1075) | <label class="cluevo cluevo-module-install-type-file"> |
| [1076](#L1076) | <div class="button"><?php echo esc\_html($type["button-label"]); ?></div> |
| [1077](#L1077) | <input type="file" name="module-file" value="" <?php if (!empty($type['filter'])) echo 'accept="' . $type['filter'] . '"'; ?> /> |
| [1078](#L1078) | </label> |
| [1079](#L1079) | </div> |
| [1080](#L1080) | <?php } ?> |
| [1081](#L1081) | <?php if (!empty($type["field"]) && $type["field"] == "textarea") { ?> |
| [1082](#L1082) | <textarea name="module-dl-url" placeholder="<?php echo esc\_attr($type['field-placeholder']); ?>"></textarea> |
| [1083](#L1083) | <?php } ?> |
| [1084](#L1084) | <input type="submit" class="button auto button-primary disabled" value="<?php echo \_\_("Install Module", "cluevo"); ?>" disabled /> |
| [1085](#L1085) | </form> |
| [1086](#L1086) | <?php if (!empty($type["field"]) && ($type["field"] == "file" || $type["field"] == 'mixed')) { ?> |
| [1087](#L1087) | <p><?php \_e("Max. Filesize: ", "cluevo") . esc\_html\_e(cluevo\_human\_filesize(wp\_max\_upload\_size())); ?></p> |
| [1088](#L1088) | <?php cluevo\_display\_notice(\_\_('Attention', "cluevo"), \_\_("CLUEVO LMS has no influence on the max. filesize. This limit has to be adjusted server side either by you or your hosting provider", "cluevo"), 'warning', 'module-upload-size-warning'); ?> |
| [1089](#L1089) | <div class="cluevo-notice cluevo-notice-error cluevo-filesize hidden"> |
| [1090](#L1090) | <p><?php esc\_html\_e(sprintf(\_\_("The file you are trying to upload is too big. The maximum upload size is %s", "cluevo"), cluevo\_human\_filesize(wp\_max\_upload\_size()))); ?> |
| [1091](#L1091) | </div> |
| [1092](#L1092) | <?php } ?> |
| [1093](#L1093) | <?php } elseif (!empty($type["alt-content"])) { ?> |
| [1094](#L1094) | <div class="cluevo-add-module-alt-content"> |
| [1095](#L1095) | <?php echo wp\_kses( |
| [1096](#L1096) | $type["alt-content"], |
| [1097](#L1097) | [ |
| [1098](#L1098) | 'a' => [ |
| [1099](#L1099) | "href" => true, |
| [1100](#L1100) | "title" => true, |
| [1101](#L1101) | "class" => true |
| [1102](#L1102) | ], |
| [1103](#L1103) | 'p' => [ |
| [1104](#L1104) | "class" => true |
| [1105](#L1105) | ], |
| [1106](#L1106) | 'span' => [ |
| [1107](#L1107) | "class" => true |
| [1108](#L1108) | ], |
| [1109](#L1109) | 'div' => [ |
| [1110](#L1110) | "class" => true |
| [1111](#L1111) | ], |
| [1112](#L1112) | 'details' => [ |
| [1113](#L1113) | "class" => true |
| [1114](#L1114) | ], |
| [1115](#L1115) | 'summary' => [ |
| [1116](#L1116) | "class" => true |
| [1117](#L1117) | ], |
| [1118](#L1118) | 'ul' => [ |
| [1119](#L1119) | "class" => true |
| [1120](#L1120) | ], |
| [1121](#L1121) | 'ol' => [ |
| [1122](#L1122) | "class" => true |
| [1123](#L1123) | ], |
| [1124](#L1124) | 'li' => [ |
| [1125](#L1125) | "class" => true |
| [1126](#L1126) | ], |
| [1127](#L1127) | 'img' => [ |
| [1128](#L1128) | 'src' => true, |
| [1129](#L1129) | 'alt' => true, |
| [1130](#L1130) | 'class' => true, |
| [1131](#L1131) | 'width' => true, |
| [1132](#L1132) | 'height' => true |
| [1133](#L1133) | ], |
| [1134](#L1134) | 'button' => [ |
| [1135](#L1135) | "type" => true |
| [1136](#L1136) | ] |
| [1137](#L1137) | ] |
| [1138](#L1138) | ); ?> |
| [1139](#L1139) | </div> |
| [1140](#L1140) | <?php } ?> |
| [1141](#L1141) | </div> |
| [1142](#L1142) | <?php } ?> |
| [1143](#L1143) | <div class="button select-type"><?php esc\_html\_e('Select another module type', 'cluevo'); ?></div> |
| [1144](#L1144) | </div> |
| [1145](#L1145) | </div> |
| [1146](#L1146) | </div> |
| [1147](#L1147) | </div> |
| [1148](#L1148) | </div> |
| [1149](#L1149) | </div> |
| [1150](#L1150) | </div> |
| [1151](#L1151) | <?php } ?> |
| [1152](#L1152) | <?php if ($deleted) cluevo\_display\_notice("Hinweis", \_\_("Module deleted.", "cluevo")); ?> |
| [1153](#L1153) | <form method="post" enctype="multipart/form-data" id="add-module-form" class="cluevo-module-form" action="<?php echo esc\_url(admin\_url("admin.php?page=$page&tab=$tab"), ['http', 'https']); ?>"> |
| [1154](#L1154) | <div class="button button-primary add-module"><?php \_e('Add Module', 'cluevo'); ?></div> |
| [1155](#L1155) | <input type="hidden" name="page" value="<?php echo esc\_attr($page); ?>" /> |
| [1156](#L1156) | <input type="hidden" name="tab" value="<?php echo esc\_attr($tab); ?>" /> |
| [1157](#L1157) | </form> |
| [1158](#L1158) | <?php if (!empty($modules)) { ?> |
| [1159](#L1159) | <h2><?php esc\_html\_e("Modules", "cluevo"); ?></h2> |
| [1160](#L1160) | <?php if ($pageCreated) echo "<p>" . esc\_html\_e("Module metadata post created.", "cluevo") . "</p>"; ?> |
| [1161](#L1161) | <div id="module-lang-overlay" class="module-lang-overlay" data-module-id=""> |
| [1162](#L1162) | <div class="module-lang-select-container"> |
| [1163](#L1163) | <div class="module-lang-select" id="module-lang-select"> |
| [1164](#L1164) | <h3><?php echo \_\_("Select Language", "cluevo"); ?></h3> |
| [1165](#L1165) | <ul> |
| [1166](#L1166) | <?php |
| [1167](#L1167) | $langs = cluevo\_get\_languages(); |
| [1168](#L1168) | foreach ($langs as $lang) { |
| [1169](#L1169) | echo "<li><label><input type=\"radio\" name=\"module-lang\" value=\"$lang->lang\_code\" class=\"module-lang-radio\"> $lang->lang\_name</label></li>"; |
| [1170](#L1170) | } |
| [1171](#L1171) | ?> |
| [1172](#L1172) | </ul> |
| [1173](#L1173) | </div> |
| [1174](#L1174) | </div> |
| [1175](#L1175) | </div> |
| [1176](#L1176) | <?php |
| [1177](#L1177) | if (!empty($errors)) { |
| [1178](#L1178) | foreach ($errors as $err) { |
| [1179](#L1179) | cluevo\_display\_notice(\_\_("Error", "cluevo"), $err, 'error'); |
| [1180](#L1180) | } |
| [1181](#L1181) | } |
| [1182](#L1182) | if (!empty($messages)) { |
| [1183](#L1183) | foreach ($messages as $msg) { |
| [1184](#L1184) | cluevo\_display\_notice(\_\_("Notice", "cluevo"), $msg); |
| [1185](#L1185) | } |
| [1186](#L1186) | } |
| [1187](#L1187) | ?> |
| [1188](#L1188) | <table class="cluevo-scorm-modules wp-list-table widefat striped"> |
| [1189](#L1189) | <thead> |
| [1190](#L1190) | <tr> |
| [1191](#L1191) | <th class="check-column module-id"></th> |
| [1192](#L1192) | <th class="module-name left"><?php esc\_html\_e("Module", "cluevo"); ?></th> |
| [1193](#L1193) | <th class="module-type left"><?php esc\_html\_e("Type", "cluevo"); ?></th> |
| [1194](#L1194) | <th class="module-rating left"><?php esc\_html\_e("User Ratings", "cluevo"); ?></th> |
| [1195](#L1195) | </tr> |
| [1196](#L1196) | </thead> |
| [1197](#L1197) | <?php |
| [1198](#L1198) | $tmpId = null; |
| [1199](#L1199) | $border = false; |
| [1200](#L1200) | ?> |
| [1201](#L1201) | <tbody> |
| [1202](#L1202) | <?php foreach ($modules as $key => $m) { ?> |
| [1203](#L1203) | <?php |
| [1204](#L1204) | if ($tmpId !== $m->module\_id && $tmpId !== null) { |
| [1205](#L1205) | $border = true; |
| [1206](#L1206) | } |
| [1207](#L1207) | $tmpId = $m->module\_id; |
| [1208](#L1208) | $border = false; |
| [1209](#L1209) | ?> |
| [1210](#L1210) | <?php $link = get\_edit\_post\_link($m->metadata\_id, "module"); ?> |
| [1211](#L1211) | <tr <?php if ($border) echo 'class="bordered" '; ?> data-module-id="<?php echo esc\_attr($m->module\_id); ?>"> |
| [1212](#L1212) | <td class="cluevo-nowrap"><?php echo esc\_html($m->module\_id); ?></td> |
| [1213](#L1213) | <td class="title left column-title has-row-actions column-primary" data-id="<?php echo esc\_attr($m->module\_id); ?>"> |
| [1214](#L1214) | <div class="cluevo-module-name"> |
| [1215](#L1215) | <?php echo esc\_html($m->module\_name); ?> |
| [1216](#L1216) | </div> |
| [1217](#L1217) | <div class="cluevo-module-tags"> |
| [1218](#L1218) | <?php if (!empty($m->tags)) { |
| [1219](#L1219) | echo esc\_html(implode(', ', $m->tags)); |
| [1220](#L1220) | } ?> |
| [1221](#L1221) | </div> |
| [1222](#L1222) | <div class="row-actions"> |
| [1223](#L1223) | <span class="edit-name"><a class="edit-module-name" title="<?php esc\_attr\_e("Change Name", "cluevo"); ?>" href="#" data-id="<?php echo esc\_attr($m->module\_id); ?>"><?php esc\_html\_e("Rename Module", "cluevo"); ?></a></span> | |
| [1224](#L1224) | <span class="tags"><a class="cluevo-edit-module-tags" href="#" data-id="<?php echo esc\_attr($m->module\_id); ?>"><?php esc\_html\_e("Edit Tags", "cluevo"); ?></a></span> | |
| [1225](#L1225) | <?php if (!empty($link)) { ?> |
| [1226](#L1226) | <span class="edit-module-page"><a class="" href="<?php echo esc\_url($link); ?>" target="\_blank"><?php esc\_html\_e("Edit Module Page", "cluevo"); ?></a></span> | |
| [1227](#L1227) | <?php } else { ?> |
| [1228](#L1228) | <span class="create-module-page"><a class="" href="<?php echo add\_query\_arg('create-metadata-page', $m->module\_id, $url); ?>"><?php esc\_html\_e("Create Module Page", "cluevo"); ?></a></span> | |
| [1229](#L1229) | <?php } ?> |
| [1230](#L1230) | <span class="delete"><a class="del-module" href="<?php echo add\_query\_arg('delete-module', $m->module\_id, $url); ?>"><?php esc\_html\_e("Delete Module", "cluevo"); ?></a></span> | |
| [1231](#L1231) | <span class="update"><a class="update-module" href="#"><?php esc\_html\_e("Update Module", "cluevo"); ?></a></span> | |
| [1232](#L1232) | <?php if (strpos($m->type\_name, 'scorm') !== false) { ?> |
| [1233](#L1233) | <span class="scorm-parameters"><a class="" href="<?php echo admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_REPORTS . "&tab=" . CLUEVO\_ADMIN\_TAB\_REPORTS\_SCORM\_PARMS . "&module=" . $m->module\_id); ?>"><?php esc\_html\_e("Browse SCORM Parameters", "cluevo"); ?></a></span> | |
| [1234](#L1234) | <?php } ?> |
| [1235](#L1235) | <span class="reports"><a class="" href="<?php echo admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_REPORTS . "&tab=" . CLUEVO\_ADMIN\_TAB\_REPORTS\_PROGRESS . "&module=" . $m->module\_id); ?>"><?php esc\_html\_e("Browse Reports", "cluevo"); ?></a></span> | |
| [1236](#L1236) | <span class="dl"><a class="" title="" href="<?php if (!empty($m->module\_zip)) { |
| [1237](#L1237) | echo admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_LMS . "&tab=" . CLUEVO\_ADMIN\_TAB\_LMS\_MODULES . "&dl=" . $m->module\_id); |
| [1238](#L1238) | } else { |
| [1239](#L1239) | echo admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_LMS . "&tab=" . CLUEVO\_ADMIN\_TAB\_LMS\_MODULES . "&zip=" . $m->module\_id); |
| [1240](#L1240) | } ?>"><?php (!empty($m->module\_zip)) ? esc\_attr\_e("Download Module", "cluevo") : esc\_attr\_e("Archive Module", "cluevo"); ?></a></span> |
| [1241](#L1241) | <?php if (!empty($m->module\_zip)) { ?> |
| [1242](#L1242) | | <span class="delete"><a class="" href="<?php echo add\_query\_arg('del-zip', $m->module\_id); ?>"> |
| [1243](#L1243) | <?php esc\_attr\_e("Delete ZIP", "cluevo"); ?> |
| [1244](#L1244) | </a></span> |
| [1245](#L1245) | <?php } ?> |
| [1246](#L1246) | </div> |
| [1247](#L1247) | </td> |
| [1248](#L1248) | <td class="type left "><?php echo (!empty($m->type\_name)) ? esc\_html(apply\_filters('cluevo\_output\_module\_type', $m)) : esc\_html\_\_('Unknown', "cluevo"); ?></td> |
| [1249](#L1249) | <td class="rating"><?php echo (!empty($m->rating\_avg)) ? apply\_filters('cluevo\_output\_module\_rating', $m) : cluevo\_output\_empty\_admin\_module\_rating(); ?></td> |
| [1250](#L1250) | </tr> |
| [1251](#L1251) | <?php $border = false; ?> |
| [1252](#L1252) | <?php } ?> |
| [1253](#L1253) | </tbody> |
| [1254](#L1254) | </table> |
| [1255](#L1255) | <?php if (!empty($pending)) { |
| [1256](#L1256) | $table = '<p>' . esc\_html\_\_('Pending modules found. You can add these modules by clicking the install button of any module you wish to add.', 'cluevo') . '</p>'; |
| [1257](#L1257) | $table .= '<table class="wp-list-table striped widefat">'; |
| [1258](#L1258) | $table .= '<thead>'; |
| [1259](#L1259) | $table .= '<tr><th class="left">' . esc\_html('Module', 'cluevo') . '</th><th></th></tr>'; |
| [1260](#L1260) | $table .= '</thead>'; |
| [1261](#L1261) | $table .= '<tbody>'; |
| [1262](#L1262) | foreach ($pending as $m) { |
| [1263](#L1263) | $table .= "<tr><td class=\"left\">" . esc\_html($m["module"]) . "</td>"; |
| [1264](#L1264) | $table .= '<td><div class="cluevo-buttons">'; |
| [1265](#L1265) | $table .= '<span class="dashicons dashicons-trash cluevo-pending-module-delete" data-module="' . esc\_attr($m["module"]) . '"></span>'; |
| [1266](#L1266) | if ($m["installable"]) { |
| [1267](#L1267) | $table .= '<span class="dashicons dashicons-plus cluevo-pending-module" data-module="' . esc\_attr($m["module"]) . '"></span>'; |
| [1268](#L1268) | } else { |
| [1269](#L1269) | $table .= esc\_html\_\_('No install handler found', 'cluevo'); |
| [1270](#L1270) | } |
| [1271](#L1271) | $table .= '</tr>'; |
| [1272](#L1272) | $table .= '</div></td>'; |
| [1273](#L1273) | } |
| [1274](#L1274) | $table .= '</tbody>'; |
| [1275](#L1275) | $table .= '</table>'; |
| [1276](#L1276) | cluevo\_display\_notice\_html(\_\_('Information', 'cluevo'), $table, 'info'); |
| [1277](#L1277) | } |
| [1278](#L1278) | ?> |
| [1279](#L1279) | </div> |
| [1280](#L1280) | <?php |
| [1281](#L1281) | } else { |
| [1282](#L1282) | cluevo\_display\_notice\_html( |
| [1283](#L1283) | \_\_("Notice", "cluevo"), |
| [1284](#L1284) | \_\_("No modules have been added yet.", "cluevo"), |
| [1285](#L1285) | "info" |
| [1286](#L1286) | ); |
| [1287](#L1287) | } |
| [1288](#L1288) | } |
| [1289](#L1289) |  |
| [1290](#L1290) | function cluevo\_render\_lms\_structure\_tab($tab) |
| [1291](#L1291) | { |
| [1292](#L1292) | $tabClass = ($tab == CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE) ? 'nav-tab-active' : ''; |
| [1293](#L1293) | echo '<a href="' . admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_LMS . "&tab=" . CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE) . "\" class=\"nav-tab $tabClass\">" . esc\_html\_\_("Learning tree", "cluevo") . "</a>"; |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) | function cluevo\_render\_lms\_module\_ui\_tab($tab) |
| [1297](#L1297) | { |
| [1298](#L1298) | $tabClass = ($tab == CLUEVO\_ADMIN\_TAB\_LMS\_MODULES) ? 'nav-tab-active' : ''; |
| [1299](#L1299) | echo "<a href=\"" . admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_LMS . "&tab=" . CLUEVO\_ADMIN\_TAB\_LMS\_MODULES) . "\" class=\"nav-tab $tabClass\">" .  esc\_html\_\_("Modules", "cluevo") . "</a>"; |
| [1300](#L1300) | } |
| [1301](#L1301) |  |
| [1302](#L1302) | function cluevo\_render\_lms\_page() |
| [1303](#L1303) | { |
| [1304](#L1304) | $active\_tab = (!empty($\_GET["tab"]) && ctype\_alpha($\_GET["tab"])) ? cluevo\_strip\_non\_alpha($\_GET["tab"]) : CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE; |
| [1305](#L1305) | do\_action('cluevo\_init\_admin\_page'); |
| [1306](#L1306) | ?> |
| [1307](#L1307) | <div class="wrap cluevo-admin-page-container"> |
| [1308](#L1308) | <h1 class="cluevo-admin-page-title-container"> |
| [1309](#L1309) | <div><?php esc\_html\_e("Learning Management", "cluevo"); ?></div> |
| [1310](#L1310) | <img class="plugin-logo" src="<?php echo plugins\_url("/assets/logo.png", plugin\_dir\_path(\_\_FILE\_\_)); ?>" /> |
| [1311](#L1311) | </h1> |
| [1312](#L1312) | <div class="cluevo-admin-page-content-container"> |
| [1313](#L1313) | <h2 class="nav-tab-wrapper cluevo"><?php do\_action('cluevo\_render\_lms\_page\_tabs', $active\_tab); ?></h2> |
| [1314](#L1314) | <?php |
| [1315](#L1315) | switch ($active\_tab) { |
| [1316](#L1316) | case CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE: |
| [1317](#L1317) | do\_action('cluevo\_enqueue\_lms\_structure\_js'); |
| [1318](#L1318) | do\_action('cluevo\_render\_learning\_structure\_ui'); |
| [1319](#L1319) | break; |
| [1320](#L1320) | case CLUEVO\_ADMIN\_TAB\_LMS\_MODULES: |
| [1321](#L1321) | $errors = []; |
| [1322](#L1322) | $messages = []; |
| [1323](#L1323) | if (!empty($errors)) { |
| [1324](#L1324) | foreach ($errors as $err) { |
| [1325](#L1325) | cluevo\_display\_notice(\_\_("Error", "cluevo"), $err, 'error', true); |
| [1326](#L1326) | } |
| [1327](#L1327) | } |
| [1328](#L1328) | if (!empty($messages)) { |
| [1329](#L1329) | foreach ($messages as $msg) { |
| [1330](#L1330) | cluevo\_display\_notice(\_\_("Notice", "cluevo"), $msg); |
| [1331](#L1331) | } |
| [1332](#L1332) | } |
| [1333](#L1333) | do\_action('cluevo\_enqueue\_lms\_modules\_ui\_js'); |
| [1334](#L1334) | do\_action('cluevo\_render\_lms\_modules\_ui'); |
| [1335](#L1335) | break; |
| [1336](#L1336) | default: |
| [1337](#L1337) | do\_action('cluevo\_enqueue\_lms\_structure\_js'); |
| [1338](#L1338) | do\_action('cluevo\_render\_learning\_structure\_ui'); |
| [1339](#L1339) | break; |
| [1340](#L1340) | } |
| [1341](#L1341) | ?> |
| [1342](#L1342) | </div> |
| [1343](#L1343) | </div> |
| [1344](#L1344) | <?php |
| [1345](#L1345) | } |
| [1346](#L1346) |  |
| [1347](#L1347) | function cluevo\_enqueue\_lms\_structure\_js() |
| [1348](#L1348) | { |
| [1349](#L1349) |  |
| [1350](#L1350) | // development version |
| [1351](#L1351) | //wp\_register\_script( |
| [1352](#L1352) | //"vue-js", |
| [1353](#L1353) | //"https://cdn.jsdelivr.net/npm/vue/dist/vue.js", |
| [1354](#L1354) | //"", |
| [1355](#L1355) | //"", |
| [1356](#L1356) | //true |
| [1357](#L1357) | //); |
| [1358](#L1358) |  |
| [1359](#L1359) | // production version |
| [1360](#L1360) | wp\_register\_script( |
| [1361](#L1361) | "vue-js", |
| [1362](#L1362) | plugins\_url("/js/vue.min.js", plugin\_dir\_path(\_\_FILE\_\_)), |
| [1363](#L1363) | "", |
| [1364](#L1364) | CLUEVO\_VERSION, |
| [1365](#L1365) | true |
| [1366](#L1366) | ); |
| [1367](#L1367) |  |
| [1368](#L1368) | wp\_enqueue\_script('vue-js'); |
| [1369](#L1369) |  |
| [1370](#L1370) | wp\_register\_script('nested-sortable-js', plugins\_url('/js/jquery.mjs.nestedSortable.js', plugin\_dir\_path(\_\_FILE\_\_)), array('jquery', 'jquery-ui-core', 'jquery-ui-sortable', 'jquery-ui-selectmenu'), CLUEVO\_VERSION, false);  // provides drag'n'drop tree |
| [1371](#L1371) | wp\_register\_script('lodash-js', plugins\_url('/js/lodash.min.js', plugin\_dir\_path(\_\_FILE\_\_)), null, false, false);  // utilities |
| [1372](#L1372) | wp\_register\_script( |
| [1373](#L1373) | 'scorm-plugin-js', |
| [1374](#L1374) | plugins\_url('/js/module-nav.js', plugin\_dir\_path(\_\_FILE\_\_)), |
| [1375](#L1375) | array('nested-sortable-js', 'lodash-js', 'vue-js'), |
| [1376](#L1376) | CLUEVO\_VERSION, |
| [1377](#L1377) | false |
| [1378](#L1378) | );  // tree management |
| [1379](#L1379) | wp\_add\_inline\_script('lodash-js', 'window.lodash = \_.noConflict();', 'after'); // gutenberg compatibility |
| [1380](#L1380) | wp\_localize\_script('scorm-plugin-js', 'cluevoWpApiSettings', array('root' => esc\_url\_raw(rest\_url()), 'nonce' => wp\_create\_nonce('wp\_rest')));  // needed for ajax requests |
| [1381](#L1381) | wp\_enqueue\_script('nested-sortable-js'); |
| [1382](#L1382) | wp\_enqueue\_script('scorm-plugin-js'); |
| [1383](#L1383) |  |
| [1384](#L1384) | wp\_localize\_script( |
| [1385](#L1385) | 'scorm-plugin-js', |
| [1386](#L1386) | 'strings', |
| [1387](#L1387) | array( |
| [1388](#L1388) | 'new\_course' => \_\_('New Course', "cluevo"), |
| [1389](#L1389) | 'new\_chapter' => \_\_('New Chapter', "cluevo"), |
| [1390](#L1390) | 'new\_module' => \_\_('New Module', "cluevo"), |
| [1391](#L1391) | 'course' => \_\_('Course', "cluevo"), |
| [1392](#L1392) | 'chapter' => \_\_('Chapter', "cluevo"), |
| [1393](#L1393) | 'module' => \_\_('Module', "cluevo"), |
| [1394](#L1394) | 'without\_module' => \_\_('Without Module', "cluevo"), |
| [1395](#L1395) | 'delete\_item' => \_\_('Really delete this element?', "cluevo"), |
| [1396](#L1396) | 'shortcode\_copied' => \_\_('Shortcode copied!', "cluevo"), |
| [1397](#L1397) | 'msg\_install\_demos' => \_\_("Install demo course and modules? The modules will be downloaded from our homepage and installed to your LMS.", "cluevo"), |
| [1398](#L1398) | 'published' => \_\_("Published", "cluevo"), |
| [1399](#L1399) | 'draft' => \_\_("Draft", "cluevo"), |
| [1400](#L1400) | 'tree\_rebuild\_warning' => \_\_("It looks like your learning tree needs to be rebuilt. If you save now you will overwrite your current learning tree with this empty one.\nAre you sure you want to save?", "cluevo"), |
| [1401](#L1401) | 'course\_group\_name\_cant\_be\_empty' => \_\_("The name of the course group must not be empty.", "cluevo"), |
| [1402](#L1402) | 'filter\_placeholder' => \_\_("'Search Query' or '!Search Query' / '-Seach Query'", "cluevo"), |
| [1403](#L1403) | 'results' => \_\_("Results: ", "cluevo"), |
| [1404](#L1404) | 'tags' => \_\_("Tags", "cluevo"), |
| [1405](#L1405) | 'tag' => \_\_("Tag", "cluevo"), |
| [1406](#L1406) | 'with\_tag' => \_\_("With Tag", "cluevo"), |
| [1407](#L1407) | 'without\_tag' => \_\_("Without Tag", "cluevo"), |
| [1408](#L1408) | 'get\_cert\_extension' => \_\_("Get the Certificates Extension to issue certificates", "cluevo"), |
| [1409](#L1409) | ) |
| [1410](#L1410) | ); |
| [1411](#L1411) |  |
| [1412](#L1412) | wp\_register\_script( |
| [1413](#L1413) | 'cluevo-module-selector', |
| [1414](#L1414) | plugins\_url('/js/module-selector.admin.js', plugin\_dir\_path(\_\_FILE\_\_)), |
| [1415](#L1415) | ['scorm-plugin-js'], |
| [1416](#L1416) | CLUEVO\_VERSION, |
| [1417](#L1417) | true |
| [1418](#L1418) | ); |
| [1419](#L1419) | wp\_localize\_script( |
| [1420](#L1420) | 'cluevo-module-selector', |
| [1421](#L1421) | 'cluevoApiSettings', |
| [1422](#L1422) | array( |
| [1423](#L1423) | 'root' => esc\_url\_raw(rest\_url()), |
| [1424](#L1424) | 'nonce' => wp\_create\_nonce('wp\_rest') |
| [1425](#L1425) | ) |
| [1426](#L1426) | ); |
| [1427](#L1427) | wp\_localize\_script( |
| [1428](#L1428) | 'cluevo-module-selector', |
| [1429](#L1429) | 'lang\_strings', |
| [1430](#L1430) | array( |
| [1431](#L1431) | "insert\_module" => \_\_("Insert Module", "cluevo"), |
| [1432](#L1432) | "label\_search" => \_\_("Search", "cluevo"), |
| [1433](#L1433) | "placeholder\_modulename" => \_\_("Search term", "cluevo"), |
| [1434](#L1434) | "module\_search\_result\_count" => \_\_("Modules", "cluevo"), |
| [1435](#L1435) | "filter\_tile\_all" => \_\_("All", "cluevo") |
| [1436](#L1436) | ) |
| [1437](#L1437) | ); |
| [1438](#L1438) | wp\_enqueue\_script('cluevo-module-selector'); |
| [1439](#L1439) | } |
| [1440](#L1440) |  |
| [1441](#L1441) | function cluevo\_enqueue\_lms\_modules\_ui\_js() |
| [1442](#L1442) | { |
| [1443](#L1443) | wp\_register\_script('cluevo-admin-module-page', plugins\_url('/js/module-admin-page.js', plugin\_dir\_path(\_\_FILE\_\_)), array(), CLUEVO\_VERSION, true); |
| [1444](#L1444) | wp\_enqueue\_script("cluevo-admin-module-page"); |
| [1445](#L1445) | wp\_localize\_script( |
| [1446](#L1446) | 'cluevo-admin-module-page', |
| [1447](#L1447) | 'moduleApiSettings', |
| [1448](#L1448) | array( |
| [1449](#L1449) | 'root' => esc\_url\_raw(rest\_url()), |
| [1450](#L1450) | 'nonce' => wp\_create\_nonce('wp\_rest') |
| [1451](#L1451) | ) |
| [1452](#L1452) | ); |
| [1453](#L1453) | wp\_localize\_script( |
| [1454](#L1454) | 'cluevo-admin-module-page', |
| [1455](#L1455) | 'strings', |
| [1456](#L1456) | array( |
| [1457](#L1457) | 'confirm\_module\_delete' => \_\_("Really delete this module? This action can't be undone.", "cluevo"), |
| [1458](#L1458) | 'toggle\_install\_type\_file' => \_\_('Install module from URL', "cluevo"), |
| [1459](#L1459) | 'toggle\_install\_type\_url' => \_\_('Upload module file', "cluevo"), |
| [1460](#L1460) | 'msg\_install\_demos' => \_\_("Install demo course and modules. The modules will be downloaded from our homepage and installed to your LMS", "cluevo"), |
| [1461](#L1461) | 'rename\_module\_prompt' => \_\_("New Name", "cluevo"), |
| [1462](#L1462) | 'rename\_module\_error' => \_\_("The module could not be renamed. A module with the same name may already exist or the module is no longer available.", "cluevo"), |
| [1463](#L1463) | "upload\_success" => \_\_("The module has been uploaded. One moment please while it is being installed.", "cluevo"), |
| [1464](#L1464) | "module\_upload\_finished" => \_\_("Installation completed.", "cluevo"), |
| [1465](#L1465) | "refresh\_to\_enable" => \_\_("Module uploaded. Refresh the page to enable the tools.", "cluevo"), |
| [1466](#L1466) | "module\_upload\_failed" => \_\_("Installation failed.", "cluevo"), |
| [1467](#L1467) | "upload\_error" => \_\_("Upload failed.", "cluevo"), |
| [1468](#L1468) | "pending\_install\_error" => \_\_("Installation failed.", "cluevo"), |
| [1469](#L1469) | "pending\_delete\_error" => \_\_("Removal failed.", "cluevo"), |
| [1470](#L1470) | "update\_module" => \_\_("Update Module", "cluevo"), |
| [1471](#L1471) | "update\_module\_description" => \_\_("Please select a module or enter a URL", "cluevo") |
| [1472](#L1472) | ) |
| [1473](#L1473) | ); |
| [1474](#L1474) | wp\_localize\_script('cluevo-admin-module-page', 'cluevoWpApiSettings', [ |
| [1475](#L1475) | 'root' => esc\_url\_raw(rest\_url()), |
| [1476](#L1476) | 'nonce' => wp\_create\_nonce('wp\_rest'), |
| [1477](#L1477) | 'pendingModuleNonce' => wp\_create\_nonce('##cluevo-install-pending-module'), |
| [1478](#L1478) | 'deletePendingModuleNonce' => wp\_create\_nonce('##cluevo-delete-pending-module') |
| [1479](#L1479) | ]);  // needed for ajax requests |
| [1480](#L1480) | } |
| [1481](#L1481) |  |
| [1482](#L1482) | function cluevo\_update\_module\_name($intModuleId, $strNewName) |
| [1483](#L1483) | { |
| [1484](#L1484) | global $wpdb; |
| [1485](#L1485) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [1486](#L1486) | $result = $wpdb->query( |
| [1487](#L1487) | $wpdb->prepare("UPDATE $table SET module\_name = %s WHERE module\_id = %d", [sanitize\_text\_field($strNewName), $intModuleId]) |
| [1488](#L1488) | ); |
| [1489](#L1489) | return ($result !== false); |
| [1490](#L1490) | } |
| [1491](#L1491) |  |
| [1492](#L1492) | function cluevo\_update\_module\_tags($intModuleId, $mixedTags = []) |
| [1493](#L1493) | { |
| [1494](#L1494) | $tags = cluevo\_create\_tag\_string($mixedTags); |
| [1495](#L1495) | global $wpdb; |
| [1496](#L1496) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [1497](#L1497) | $result = $wpdb->query( |
| [1498](#L1498) | $wpdb->prepare("UPDATE $table SET tags = %s WHERE module\_id = %d", [sanitize\_text\_field($tags), $intModuleId]) |
| [1499](#L1499) | ); |
| [1500](#L1500) | return ($result !== false); |
| [1501](#L1501) | } |
| [1502](#L1502) |  |
| [1503](#L1503) | function cluevo\_search\_modules($strName) |
| [1504](#L1504) | { |
| [1505](#L1505) | global $wpdb; |
| [1506](#L1506) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [1507](#L1507) | $results = $wpdb->get\_results( |
| [1508](#L1508) | $wpdb->prepare("SELECT module\_id, module\_name FROM {$table} WHERE module\_name LIKE CONCAT('%', %s, '%')", [$strName]) |
| [1509](#L1509) | ); |
| [1510](#L1510) | return $results; |
| [1511](#L1511) | } |
| [1512](#L1512) |  |
| [1513](#L1513) | function cluevo\_output\_empty\_admin\_module\_rating() |
| [1514](#L1514) | { |
| [1515](#L1515) | $out = '<div class="cluevo-module-rating-container cluevo-unrated">'; |
| [1516](#L1516) | $out .= '<div class="cluevo-module-stars">'; |
| [1517](#L1517) | for ($i = 1; $i < 6; $i++) { |
| [1518](#L1518) | $out .= '<div class="cluevo-module-rating"></div>'; |
| [1519](#L1519) | } |
| [1520](#L1520) | $out .= '</div>'; |
| [1521](#L1521) | $out .= '</div>'; |
| [1522](#L1522) | return $out; |
| [1523](#L1523) | } |
| [1524](#L1524) |  |
| [1525](#L1525) | function cluevo\_output\_admin\_module\_rating($module) |
| [1526](#L1526) | { |
| [1527](#L1527) | if (empty($module)) return ''; |
| [1528](#L1528) | if (empty($module->rating\_avg)) return ''; |
| [1529](#L1529) | if (empty($module->rating\_avg["value"])) return ''; |
| [1530](#L1530) | $rating = $module->rating\_avg["value"]; |
| [1531](#L1531) | $out = '<a href="' . add\_query\_arg('module\_id', $module->module\_id, admin\_url("admin.php?page=cluevo-module-ratings")) . '" class="cluevo-module-rating-container">'; |
| [1532](#L1532) | $out .= '<div class="cluevo-module-stars">'; |
| [1533](#L1533) | for ($i = 1; $i < 6; $i++) { |
| [1534](#L1534) | $out .= '<div class="cluevo-module-rating'; |
| [1535](#L1535) | $out .= ($rating >= $i) ? ' filled' : ''; |
| [1536](#L1536) | $out .= '"></div>'; |
| [1537](#L1537) | } |
| [1538](#L1538) | $out .= '</div>'; |
| [1539](#L1539) | $out .= '<div class="cluevo-rating-stats">'; |
| [1540](#L1540) | $out .= '<div class="cluevo-rating-count">' . $module->rating\_avg["count"] . ' ' . esc\_html\_\_("Ratings", "cluevo") . '</div>'; |
| [1541](#L1541) | $out .= '<div class="cluevo-rating-value">' . number\_format($module->rating\_avg["value"], 2) . '</div>'; |
| [1542](#L1542) | $out .= '</div>'; |
| [1543](#L1543) | $out .= '</a>'; |
| [1544](#L1544) | return $out; |
| [1545](#L1545) | } |
| [1546](#L1546) |  |
| [1547](#L1547) | function cluevo\_find\_pending\_modules() |
| [1548](#L1548) | { |
| [1549](#L1549) | $baseDir = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'); |
| [1550](#L1550) | $baseIterator = new DirectoryIterator($baseDir); |
| [1551](#L1551) | if (!is\_dir($baseDir)) return []; |
| [1552](#L1552) | $modules = cluevo\_get\_modules(); |
| [1553](#L1553) | $existing = array\_map(function ($module) use ($baseDir) { |
| [1554](#L1554) | return cluevo\_path\_join($baseDir, $module->module\_dir); |
| [1555](#L1555) | }, $modules); |
| [1556](#L1556) | $pending = []; |
| [1557](#L1557) | foreach ($baseIterator as $type) { |
| [1558](#L1558) | if ($type->isDot()) continue; |
| [1559](#L1559) | $typePath = cluevo\_path\_join($baseDir, $type->getFilename()); |
| [1560](#L1560) | if (!is\_dir($typePath)) continue; |
| [1561](#L1561) | $typeIterator = new DirectoryIterator($typePath); |
| [1562](#L1562) | foreach ($typeIterator as $module) { |
| [1563](#L1563) | if ($module->isDot()) continue; |
| [1564](#L1564) | if (!$module->isDir()) continue; |
| [1565](#L1565) | $modulePath = cluevo\_path\_join($typePath, $module->getFilename()); |
| [1566](#L1566) | if (!in\_array($modulePath, $existing)) { |
| [1567](#L1567) | $pending[] = [ |
| [1568](#L1568) | "module" => cluevo\_path\_join($type->getFilename(), $module->getFilename()), |
| [1569](#L1569) | "installable" => has\_action("cluevo\_install\_pending\_module\_{$type->getFilename()}") > 0, |
| [1570](#L1570) | ]; |
| [1571](#L1571) | } |
| [1572](#L1572) | } |
| [1573](#L1573) | } |
| [1574](#L1574) | return $pending; |
| [1575](#L1575) | } |
| [1576](#L1576) |  |
| [1577](#L1577) | function cluevo\_ajax\_delete\_pending\_module() |
| [1578](#L1578) | { |
| [1579](#L1579) | $nonce\_name = isset($\_POST["cluevo-pending-module-nonce"]) ? sanitize\_text\_field($\_POST["cluevo-pending-module-nonce"]) : ""; |
| [1580](#L1580) | $nonce\_action = "##cluevo-delete-pending-module"; |
| [1581](#L1581) |  |
| [1582](#L1582) | if (!wp\_verify\_nonce($nonce\_name, $nonce\_action)) return; |
| [1583](#L1583) | if (!current\_user\_can("administrator")) return; |
| [1584](#L1584) |  |
| [1585](#L1585) | $moduleInput = sanitize\_text\_field($\_POST["cluevo-pending-module"]); |
| [1586](#L1586) | $parts = explode('/', $moduleInput); |
| [1587](#L1587) | if (empty($parts)) wp\_send\_json\_error(false); |
| [1588](#L1588) | $modulePathParts = array\_map(function ($el) { |
| [1589](#L1589) | return sanitize\_file\_name($el); |
| [1590](#L1590) | }, $parts); |
| [1591](#L1591) | if (empty($modulePathParts)) wp\_send\_json\_error(false); |
| [1592](#L1592) | $module = implode('/', $modulePathParts); |
| [1593](#L1593) |  |
| [1594](#L1594) | $pending = cluevo\_find\_pending\_modules(); |
| [1595](#L1595) | $list = array\_map(function ($item) { |
| [1596](#L1596) | return $item["module"]; |
| [1597](#L1597) | }, $pending); |
| [1598](#L1598) | if (!in\_array($module, $list)) return; |
| [1599](#L1599) |  |
| [1600](#L1600) | $path = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), $module); |
| [1601](#L1601) | if (is\_dir($path) && $path != cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') && stripos($path, cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH')) === 0) { |
| [1602](#L1602) | cluevo\_delete\_directory($path); |
| [1603](#L1603) | wp\_send\_json\_success(true); |
| [1604](#L1604) | } else { |
| [1605](#L1605) | wp\_send\_json\_error(false); |
| [1606](#L1606) | } |
| [1607](#L1607) | } |
| [1608](#L1608) |  |
| [1609](#L1609) | function cluevo\_ajax\_install\_pending\_module() |
| [1610](#L1610) | { |
| [1611](#L1611) | $nonce\_name = isset($\_POST["cluevo-pending-module-nonce"]) ? sanitize\_text\_field($\_POST["cluevo-pending-module-nonce"]) : ""; |
| [1612](#L1612) | $nonce\_action = "##cluevo-install-pending-module"; |
| [1613](#L1613) |  |
| [1614](#L1614) | if (!wp\_verify\_nonce($nonce\_name, $nonce\_action)) return; |
| [1615](#L1615) | if (!current\_user\_can("administrator")) return; |
| [1616](#L1616) |  |
| [1617](#L1617) | $moduleInput = sanitize\_text\_field($\_POST["cluevo-pending-module"]); |
| [1618](#L1618) | $parts = explode('/', $moduleInput); |
| [1619](#L1619) | $parts = array\_values(array\_filter($parts, function ($value) { |
| [1620](#L1620) | return !empty($value); |
| [1621](#L1621) | })); |
| [1622](#L1622) | if (empty($parts)) wp\_send\_json\_error(false); |
| [1623](#L1623) | $modulePathParts = array\_map(function ($el) { |
| [1624](#L1624) | return sanitize\_key($el); |
| [1625](#L1625) | }, $parts); |
| [1626](#L1626) | if (empty($modulePathParts)) wp\_send\_json\_error(false); |
| [1627](#L1627) | $module = cluevo\_path\_join($modulePathParts); |
| [1628](#L1628) |  |
| [1629](#L1629) | $pending = cluevo\_find\_pending\_modules(); |
| [1630](#L1630) | $list = array\_map(function ($item) { |
| [1631](#L1631) | return $item["module"]; |
| [1632](#L1632) | }, $pending); |
| [1633](#L1633) | if (!in\_array($module, $list)) return; |
| [1634](#L1634) | $module = trim($module, '/'); |
| [1635](#L1635) |  |
| [1636](#L1636) | $parts = explode('/', $module); |
| [1637](#L1637) | if (count($parts) !== 2) return; |
| [1638](#L1638) | $type = sanitize\_key($parts[0]); |
| [1639](#L1639) |  |
| [1640](#L1640) | do\_action("cluevo\_install\_pending\_module\_{$type}", $parts[1]); |
| [1641](#L1641) | } |
| [1642](#L1642) |  |
| [1643](#L1643) | function cluevo\_install\_pending\_scorm\_module($strName) |
| [1644](#L1644) | { |
| [1645](#L1645) | $realPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') . cluevo\_path\_join("scorm2004", $strName) . "/"; |
| [1646](#L1646) | $moduleType = CLUEVO\_SCORM\_MODULE\_TYPE\_ID; // module\_type = scorm |
| [1647](#L1647) | $href = cluevo\_find\_module\_index($realPath, false); |
| [1648](#L1648) | $scormVersion = cluevo\_get\_scorm\_version\_from\_manifest($realPath); |
| [1649](#L1649) | $id = cluevo\_create\_module\_metadata\_post($strName); |
| [1650](#L1650) | $result = cluevo\_create\_module($strName, $moduleType, $id, cluevo\_path\_join('scorm2004', $strName), null, $href, null, 0, $scormVersion); |
| [1651](#L1651) | wp\_die($result); |
| [1652](#L1652) | } |
| [1653](#L1653) |  |
| [1654](#L1654) | function cluevo\_install\_pending\_audio\_module($strName) |
| [1655](#L1655) | { |
| [1656](#L1656) | $validExtensions = ["mp3", "wav", "m4a"]; |
| [1657](#L1657) | $path = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), 'audio', $strName); |
| [1658](#L1658) | if (!file\_exists($path)) wp\_die(false); |
| [1659](#L1659) | $dirIterator = new DirectoryIterator($path); |
| [1660](#L1660) | $file = null; |
| [1661](#L1661) | foreach ($dirIterator as $file) { |
| [1662](#L1662) | if ($file->isDot()) continue; |
| [1663](#L1663) | if ($file->isDir()) continue; |
| [1664](#L1664) | if (!in\_array($file->getExtension(), $validExtensions)) continue; |
| [1665](#L1665) | $file = $file->getFilename(); |
| [1666](#L1666) | break; |
| [1667](#L1667) | } |
| [1668](#L1668) | if (empty($file)) { |
| [1669](#L1669) | wp\_die(false); |
| [1670](#L1670) | } |
| [1671](#L1671) | $moduleType = CLUEVO\_AUDIO\_MODULE\_TYPE\_ID; // module\_type = audio |
| [1672](#L1672) | $id = cluevo\_create\_module\_metadata\_post($strName); |
| [1673](#L1673) | $result = cluevo\_create\_module( |
| [1674](#L1674) | basename($file), |
| [1675](#L1675) | $moduleType, |
| [1676](#L1676) | $id, |
| [1677](#L1677) | "audio/{$strName}", |
| [1678](#L1678) | null, |
| [1679](#L1679) | basename($file), |
| [1680](#L1680) | null, |
| [1681](#L1681) | 0, |
| [1682](#L1682) | null |
| [1683](#L1683) | ); |
| [1684](#L1684) | wp\_die($result); |
| [1685](#L1685) | } |
| [1686](#L1686) |  |
| [1687](#L1687) | function cluevo\_install\_pending\_video\_module($strName) |
| [1688](#L1688) | { |
| [1689](#L1689) | $validExtensions = ["mp4", "webm", "mpeg"]; |
| [1690](#L1690) | $path = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), 'video', $strName); |
| [1691](#L1691) | if (!file\_exists($path)) wp\_die(false); |
| [1692](#L1692) | $dirIterator = new DirectoryIterator($path); |
| [1693](#L1693) | $file = null; |
| [1694](#L1694) | foreach ($dirIterator as $file) { |
| [1695](#L1695) | if ($file->isDot()) continue; |
| [1696](#L1696) | if ($file->isDir()) continue; |
| [1697](#L1697) | if (!in\_array($file->getExtension(), $validExtensions)) continue; |
| [1698](#L1698) | $file = $file->getFilename(); |
| [1699](#L1699) | break; |
| [1700](#L1700) | } |
| [1701](#L1701) | if (empty($file)) { |
| [1702](#L1702) | wp\_die(false); |
| [1703](#L1703) | } |
| [1704](#L1704) | $moduleType = CLUEVO\_VIDEO\_MODULE\_TYPE\_ID; // module\_type = video |
| [1705](#L1705) | $id = cluevo\_create\_module\_metadata\_post($strName); |
| [1706](#L1706) | $result = cluevo\_create\_module( |
| [1707](#L1707) | basename($file), |
| [1708](#L1708) | $moduleType, |
| [1709](#L1709) | $id, |
| [1710](#L1710) | "video/{$strName}", |
| [1711](#L1711) | null, |
| [1712](#L1712) | basename($file), |
| [1713](#L1713) | null, |
| [1714](#L1714) | 0, |
| [1715](#L1715) | null |
| [1716](#L1716) | ); |
| [1717](#L1717) | wp\_die($result); |
| [1718](#L1718) | } |
| [1719](#L1719) |  |
| [1720](#L1720) | function cluevo\_install\_pending\_pdf\_module($strName) |
| [1721](#L1721) | { |
| [1722](#L1722) | $validExtensions = ["pdf"]; |
| [1723](#L1723) | $path = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), 'pdf', $strName); |
| [1724](#L1724) | if (!file\_exists($path)) wp\_die(false); |
| [1725](#L1725) | $dirIterator = new DirectoryIterator($path); |
| [1726](#L1726) | $file = null; |
| [1727](#L1727) | foreach ($dirIterator as $file) { |
| [1728](#L1728) | if ($file->isDot()) continue; |
| [1729](#L1729) | if ($file->isDir()) continue; |
| [1730](#L1730) | if (!in\_array($file->getExtension(), $validExtensions)) continue; |
| [1731](#L1731) | $file = $file->getFilename(); |
| [1732](#L1732) | break; |
| [1733](#L1733) | } |
| [1734](#L1734) | if (empty($file)) { |
| [1735](#L1735) | wp\_die(false); |
| [1736](#L1736) | } |
| [1737](#L1737) | $moduleType = CLUEVO\_PDF\_MODULE\_TYPE\_ID; // module\_type = video |
| [1738](#L1738) | $id = cluevo\_create\_module\_metadata\_post($strName); |
| [1739](#L1739) | $result = cluevo\_create\_module( |
| [1740](#L1740) | basename($file), |
| [1741](#L1741) | $moduleType, |
| [1742](#L1742) | $id, |
| [1743](#L1743) | "pdf/{$strName}", |
| [1744](#L1744) | null, |
| [1745](#L1745) | basename($file), |
| [1746](#L1746) | null, |
| [1747](#L1747) | 0, |
| [1748](#L1748) | null |
| [1749](#L1749) | ); |
| [1750](#L1750) | wp\_die($result); |
| [1751](#L1751) | } |
| [1752](#L1752) |  |
| [1753](#L1753) | function cluevo\_add\_tree\_item\_close\_button\_setting($item) |
| [1754](#L1754) | { |
| [1755](#L1755) | if ($item->type === "module" || (!empty($item->module\_id) && (int)$item->module\_id > 0)) { |
| [1756](#L1756) | ?> |
| [1757](#L1757) | <div class="meta-container hide-lightbox-close-button"> |
| [1758](#L1758) | <details> |
| [1759](#L1759) | <summary class="label"><?php \_e("Lightbox Settings", "cluevo"); ?> |
| [1760](#L1760) | <p class="help"> |
| [1761](#L1761) | <?php \_e("These settings configure the lightbox.", "cluevo"); ?> |
| [1762](#L1762) | </p> |
| [1763](#L1763) | </summary> |
| [1764](#L1764) | <div class="label sub">Schließen Button</div> |
| [1765](#L1765) | <table class="cluevo-meta-settings-group"> |
| [1766](#L1766) | <tr> |
| [1767](#L1767) | <td> |
| [1768](#L1768) | <label><?php \_e("Hide Button", "cluevo"); ?></label> |
| [1769](#L1769) | </td> |
| [1770](#L1770) | <td> |
| [1771](#L1771) | <input type="checkbox" value="1" class="setting" data-target="hide-lightbox-close-button" <?php echo esc\_attr($item->get\_setting('hide-lightbox-close-button') ? 'checked' : ''); ?> /> |
| [1772](#L1772) | </td> |
| [1773](#L1773) | </tr> |
| [1774](#L1774) | <tr> |
| [1775](#L1775) | <td> |
| [1776](#L1776) | <label><?php \_e("Button Text", "cluevo"); ?></label> |
| [1777](#L1777) | </td> |
| [1778](#L1778) | <td> |
| [1779](#L1779) | <input placeholder="&times;" type="text" value="<?php echo esc\_attr($item->get\_setting('lightbox-close-button-text')); ?>" class="setting" data-target="lightbox-close-button-text" /> |
| [1780](#L1780) | </td> |
| [1781](#L1781) | </tr> |
| [1782](#L1782) | <tr> |
| [1783](#L1783) | <td> |
| [1784](#L1784) | <label><?php \_e("Button Position", "cluevo"); ?></label> |
| [1785](#L1785) | </td> |
| [1786](#L1786) | <td> |
| [1787](#L1787) | <select size="1" name="lightbox-close-button-position" class="setting" data-target="lightbox-close-button-position"> |
| [1788](#L1788) | <option value=""><?php esc\_html\_e("Default", "cluevo"); ?></option> |
| [1789](#L1789) | <option value="top-left" <?php if ($item->get\_setting('lightbox-close-button-position') == "top-left") echo "selected"; ?>><?php esc\_html\_e("top left", "cluevo"); ?></option> |
| [1790](#L1790) | <option value="top-center" <?php if ($item->get\_setting('lightbox-close-button-position') == "top-center") echo "selected"; ?>><?php esc\_html\_e("top center", "cluevo"); ?></option> |
| [1791](#L1791) | <option value="top-right" <?php if ($item->get\_setting('lightbox-close-button-position') == "top-right") echo "selected"; ?>><?php esc\_html\_e("top right", "cluevo"); ?></option> |
| [1792](#L1792) | <option value="bottom-left" <?php if ($item->get\_setting('lightbox-close-button-position') == "bottom-left") echo "selected"; ?>><?php esc\_html\_e("bottom left", "cluevo"); ?></option> |
| [1793](#L1793) | <option value="bottom-center" <?php if ($item->get\_setting('lightbox-close-button-position') == "bottom-center") echo "selected"; ?>><?php esc\_html\_e("bottom center", "cluevo"); ?></option> |
| [1794](#L1794) | <option value="bottom-right" <?php if ($item->get\_setting('lightbox-close-button-position') == "bottom-right") echo "selected"; ?>><?php esc\_html\_e("bottom right", "cluevo"); ?></option> |
| [1795](#L1795) | </select> |
| [1796](#L1796) | </td> |
| [1797](#L1797) | </tr> |
| [1798](#L1798) | </table> |
| [1799](#L1799) | </details> |
| [1800](#L1800) | </div> |
| [1801](#L1801) | <?php } |
| [1802](#L1802) | } |
| [1803](#L1803) |  |
| [1804](#L1804) | function cluevo\_add\_tree\_empty\_setting($item) |
| [1805](#L1805) | { |
| [1806](#L1806) | ?> |
| [1807](#L1807) | <div class="meta-container info-box-settings"> |
| [1808](#L1808) | <details> |
| [1809](#L1809) | <summary class="label"><?php \_e("Info Box Settings", "cluevo"); ?> |
| [1810](#L1810) | <p class="help"> |
| [1811](#L1811) | <?php \_e("Customize the messages that are displayed if an element is empty or permissions are required.", "cluevo"); ?> |
| [1812](#L1812) | </p> |
| [1813](#L1813) | </summary> |
| [1814](#L1814) | <table class="cluevo-meta-settings-group"> |
| [1815](#L1815) | <?php if ($item->type != "module") { ?> |
| [1816](#L1816) | <tr> |
| [1817](#L1817) | <td><?php esc\_html\_e("Hide Info Box", "cluevo"); ?></td> |
| [1818](#L1818) | <td> |
| [1819](#L1819) | <input type="checkbox" name="hide-info-box" <?php if ($item->get\_setting("hide-info-box")) echo esc\_attr("checked"); ?> data-target="hide-info-box" class="setting" /> |
| [1820](#L1820) | </td> |
| [1821](#L1821) | </tr> |
| [1822](#L1822) | <tr> |
| [1823](#L1823) | <td><?php esc\_html\_e("Element is empty text", "cluevo"); ?></td> |
| [1824](#L1824) | <td> |
| [1825](#L1825) | <input type="text" name="element-is-empty-text" value="<?php echo esc\_attr($item->get\_setting("element-is-empty-text")); ?>" data-target="element-is-empty-text" class="setting" /> |
| [1826](#L1826) | </td> |
| [1827](#L1827) | </tr> |
| [1828](#L1828) | <?php } ?> |
| [1829](#L1829) | <tr> |
| [1830](#L1830) | <td><?php esc\_html\_e("Hide access denied box", "cluevo"); ?></td> |
| [1831](#L1831) | <td> |
| [1832](#L1832) | <input type="checkbox" name="hide-access-denied-box" <?php if ($item->get\_setting("hide-access-denied-box")) echo esc\_attr("checked"); ?> data-target="hide-access-denied-box" class="setting" /> |
| [1833](#L1833) | </td> |
| [1834](#L1834) | </tr> |
| [1835](#L1835) | <tr> |
| [1836](#L1836) | <td><?php esc\_html\_e("Access denied text", "cluevo"); ?></td> |
| [1837](#L1837) | <td> |
| [1838](#L1838) | <input type="text" name="access-denied-text" value="<?php echo esc\_attr($item->get\_setting("access-denied-text")); ?>" data-target="access-denied-text" class="setting" /> |
| [1839](#L1839) | </td> |
| [1840](#L1840) | </tr> |
| [1841](#L1841) | </table> |
| [1842](#L1842) | </details> |
| [1843](#L1843) | </div> |
| [1844](#L1844) |  |
| [1845](#L1845) | <?php } |
| [1846](#L1846) |  |
| [1847](#L1847) | function cluevo\_add\_item\_display\_mode\_setting($item) |
| [1848](#L1848) | { |
| [1849](#L1849) | $defaultDisplayMode = strtolower(get\_option('cluevo-modules-display-mode')); |
| [1850](#L1850) | ?> |
| [1851](#L1851) | <?php if ($item->type == "module" || (!empty($item->module\_id) && (int)$item->module\_id > 0)) { ?> |
| [1852](#L1852) | <?php $tmpMode = (!empty($item->get\_setting('display-mode'))) ? $item->get\_setting('display-mode') : ""; ?> |
| [1853](#L1853) | <?php $iframePosition = $item->get\_setting('iframe-position'); ?> |
| [1854](#L1854) | <div class="meta-container display-mode"> |
| [1855](#L1855) | <details> |
| [1856](#L1856) | <summary class="label"><?php \_e("Display Mode", "cluevo"); ?> |
| [1857](#L1857) | <p class="help"> |
| [1858](#L1858) | <?php \_e("Determines how modules are displayed.", "cluevo"); ?> |
| [1859](#L1859) | </p> |
| [1860](#L1860) | </summary> |
| [1861](#L1861) | <div class="display-mode-container display-mode input-container"> |
| [1862](#L1862) | <label><?php \_e("Mode", "cluevo"); ?></label> |
| [1863](#L1863) | <select data-target="display-mode" class="setting"> |
| [1864](#L1864) | <option value="">Standard</option> |
| [1865](#L1865) | <option value="iframe" <?php if ($tmpMode == "iframe") echo "selected"; ?>><?php esc\_html\_e("Display on Page (Iframe)", "cluevo"); ?></option> |
| [1866](#L1866) | <option value="popup" <?php if ($tmpMode == "popup") echo "selected"; ?>><?php esc\_html\_e("Pop-Up", "cluevo"); ?></option> |
| [1867](#L1867) | <option value="lightbox" <?php if ($tmpMode == "lightbox") echo "selected"; ?>><?php esc\_html\_e("Lightbox", "cluevo"); ?> <?php esc\_html\_e("(Recommended)", "cluevo"); ?></option> |
| [1868](#L1868) | </select> |
| [1869](#L1869) | </div> |
| [1870](#L1870) | <div class="iframe-position input-container <?php if ($tmpMode === "iframe" || $defaultDisplayMode === 'iframe') echo "visible"; ?> <?php if ($defaultDisplayMode === "iframe") echo "forced"; ?>"> |
| [1871](#L1871) | <label><?php \_e("Position", "cluevo"); ?></label> |
| [1872](#L1872) | <select data-target="iframe-position" class="setting"> |
| [1873](#L1873) | <option value="start" <?php if ($iframePosition == "start") echo "selected"; ?>><?php esc\_html\_e('Top of the page', "cluevo"); ?></option> |
| [1874](#L1874) | <option value="end" <?php if ($iframePosition == "end") echo "selected"; ?>><?php esc\_html\_e('Bottom of the page', 'cluevo'); ?></option> |
| [1875](#L1875) | </select> |
| [1876](#L1876) | </div> |
| [1877](#L1877) | </details> |
| [1878](#L1878) | </div> |
| [1879](#L1879) | <?php } ?> |
| [1880](#L1880) |  |
| [1881](#L1881) | <?php } |
| [1882](#L1882) |  |
| [1883](#L1883) | function cluevo\_add\_tree\_item\_limited\_attempts($item) |
| [1884](#L1884) | { |
| [1885](#L1885) | $max = $item->get\_setting("max-attempts"); |
| [1886](#L1886) | $valid = true; |
| [1887](#L1887) | if (empty($item->module)) { |
| [1888](#L1888) | $max = null; |
| [1889](#L1889) | $valid = false; |
| [1890](#L1890) | }; |
| [1891](#L1891) | $hidden = empty($item->module); |
| [1892](#L1892) | ?> |
| [1893](#L1893) | <div class="meta-container info-box-settings <?php if ($hidden) echo esc\_attr('hidden'); ?>" data-module-only> |
| [1894](#L1894) | <details> |
| [1895](#L1895) | <summary class="label"><?php \_e("Max. Number of Attempts", "cluevo"); ?> |
| [1896](#L1896) | <p class="help"> |
| [1897](#L1897) | <?php \_e("You can customize how many times a user can attempt a module", "cluevo"); ?> |
| [1898](#L1898) | </p> |
| [1899](#L1899) | </summary> |
| [1900](#L1900) | <table class="cluevo-meta-settings-group"> |
| [1901](#L1901) | <tr> |
| [1902](#L1902) | <td><?php esc\_html\_e("Attempts", "cluevo"); ?></td> |
| [1903](#L1903) | <td> |
| [1904](#L1904) | <input type="number" name="max-attempts" value="<?php echo esc\_attr($max); ?>" data-target="max-attempts" class="setting" <?php if (!$valid) echo "disabled"; ?> /> |
| [1905](#L1905) | </td> |
| [1906](#L1906) | </tr> |
| [1907](#L1907) | </table> |
| [1908](#L1908) | </details> |
| [1909](#L1909) | </div> |
| [1910](#L1910) |  |
| [1911](#L1911) | <?php } |
| [1912](#L1912) |  |
| [1913](#L1913) | function cluevo\_add\_tree\_item\_tags($item) |
| [1914](#L1914) | { |
| [1915](#L1915) | $tags = $item->get\_setting("tags"); |
| [1916](#L1916) | ?> |
| [1917](#L1917) | <div class="meta-container info-box-settings"> |
| [1918](#L1918) | <details> |
| [1919](#L1919) | <summary class="label"><?php \_e("Tags", "cluevo"); ?> |
| [1920](#L1920) | <p class="help"> |
| [1921](#L1921) | <?php \_e("Tags help to organize your learning tree elements", "cluevo"); ?> |
| [1922](#L1922) | </p> |
| [1923](#L1923) | </summary> |
| [1924](#L1924) | <table class="cluevo-meta-settings-group"> |
| [1925](#L1925) | <tr> |
| [1926](#L1926) | <td><?php esc\_html\_e("Tags", "cluevo"); ?></td> |
| [1927](#L1927) | <td> |
| [1928](#L1928) | <input type="text" name="tags" value="<?php echo esc\_attr($tags); ?>" data-target="tags" class="setting tags" /> |
| [1929](#L1929) | </td> |
| [1930](#L1930) | </tr> |
| [1931](#L1931) | </table> |
| [1932](#L1932) | </details> |
| [1933](#L1933) | </div> |
| [1934](#L1934) |  |
| [1935](#L1935) | <?php } |
| [1936](#L1936) |  |
| [1937](#L1937) | function cluevo\_add\_tree\_item\_complete\_notifications($item) |
| [1938](#L1938) | { |
| [1939](#L1939) | $enabled = $item->get\_setting("notifications-enabled"); |
| [1940](#L1940) | $recipients = $item->get\_setting("notification-recipients"); |
| [1941](#L1941) | $hidden = empty($item->module); |
| [1942](#L1942) | ?> |
| [1943](#L1943) | <div class="meta-container info-box-settings <?php if ($hidden) echo esc\_attr('hidden'); ?>" data-module-only> |
| [1944](#L1944) | <details> |
| [1945](#L1945) | <summary class="label"> |
| [1946](#L1946) | <?php \_e("Notifications", "cluevo"); ?> |
| [1947](#L1947) | <p class="help"> |
| [1948](#L1948) | <?php \_e("Set up notifications for when users complete content", "cluevo"); ?> |
| [1949](#L1949) | </p> |
| [1950](#L1950) | </summary> |
| [1951](#L1951) | <table class="cluevo-meta-settings-group"> |
| [1952](#L1952) | <tr> |
| [1953](#L1953) | <td><?php esc\_html\_e("Enabled", "cluevo"); ?></td> |
| [1954](#L1954) | <td> |
| [1955](#L1955) | <input type="checkbox" value="success" name="notifications-enabled" <?php if ($enabled && !empty($item->module)) echo esc\_attr("checked"); ?> data-target="notifications-enabled" class="setting notifications-enabled" /> |
| [1956](#L1956) | </td> |
| [1957](#L1957) | </tr> |
| [1958](#L1958) | <tr> |
| [1959](#L1959) | <td><?php esc\_html\_e("Recipients", "cluevo"); ?></td> |
| [1960](#L1960) | <td> |
| [1961](#L1961) | <input type="text" name="notification-recipients" value="<?php esc\_attr\_e($recipients); ?>" data-target="notification-recipients" class="setting notification-recipients" /> |
| [1962](#L1962) | <?php esc\_html\_e("You can add multiple recipients by entering e-mail addresses separated by commas.", "cluevo"); ?> |
| [1963](#L1963) | </td> |
| [1964](#L1964) | </tr> |
| [1965](#L1965) | </table> |
| [1966](#L1966) | </details> |
| [1967](#L1967) | </div> |
| [1968](#L1968) |  |
| [1969](#L1969) | <?php } |
| [1970](#L1970) |  |
| [1971](#L1971) | function cluevo\_add\_tree\_item\_allow\_pdf\_download($item) |
| [1972](#L1972) | { |
| [1973](#L1973) | $checked = $item->get\_setting("allow-pdf-download"); |
| [1974](#L1974) | $valid = false; |
| [1975](#L1975) | if (!empty($item->module)) { |
| [1976](#L1976) | $module = cluevo\_get\_module($item->module); |
| [1977](#L1977) | if (!empty($module) && $module->type\_name === 'pdf') { |
| [1978](#L1978) | $valid = true; |
| [1979](#L1979) | } else { |
| [1980](#L1980) | $checked = false; |
| [1981](#L1981) | } |
| [1982](#L1982) | } else { |
| [1983](#L1983) | $checked = false; |
| [1984](#L1984) | } |
| [1985](#L1985) | $hidden = empty($item->module); |
| [1986](#L1986) | ?> |
| [1987](#L1987) | <div class="meta-container info-box-settings <?php if ($hidden) echo esc\_attr('hidden'); ?>" data-module-only> |
| [1988](#L1988) | <details> |
| [1989](#L1989) | <summary class="label"><?php \_e("Allow download of PDF file", "cluevo"); ?> |
| [1990](#L1990) | <p class="help"> |
| [1991](#L1991) | <?php \_e("Adds a download button to allow downloading the source PDF file", "cluevo"); ?> |
| [1992](#L1992) | </p> |
| [1993](#L1993) | </summary> |
| [1994](#L1994) | <table class="cluevo-meta-settings-group"> |
| [1995](#L1995) | <tr> |
| [1996](#L1996) | <td><?php esc\_html\_e("Enable", "cluevo"); ?></td> |
| [1997](#L1997) | <td> |
| [1998](#L1998) | <input type="checkbox" name="allow-pdf-download" value="1" data-target="allow-pdf-download" class="setting" <?php if (!$valid) echo "disabled"; ?> <?php if ($checked) echo "checked"; ?> /> |
| [1999](#L1999) | </td> |
| [2000](#L2000) | </tr> |
| [2001](#L2001) | </table> |
| [2002](#L2002) | </details> |
| [2003](#L2003) | </div> |
| [2004](#L2004) |  |
| [2005](#L2005) | <?php } |
| [2006](#L2006) |  |
| [2007](#L2007) | function cluevo\_check\_item\_access($item) |
| [2008](#L2008) | { |
| [2009](#L2009) | if (empty($item->module)) return $item; |
| [2010](#L2010) | $uid = get\_current\_user\_id(); |
| [2011](#L2011) | $item->load\_settings(); |
| [2012](#L2012) | $max = (!empty($item->settings["max-attempts"])) ? (int)$item->settings["max-attempts"] : 0; |
| [2013](#L2013) | if (empty($max)) return $item; |
| [2014](#L2014) | $curCount = (int)cluevo\_get\_users\_attempt\_count($uid, $item->module); |
| [2015](#L2015) | $item->attempt\_count = $curCount; |
| [2016](#L2016) | $attemptAccess = (!empty($max) && $curCount >= $max) ? 0 :  1; |
| [2017](#L2017) | $item->access\_status["attempts"] = $attemptAccess; |
| [2018](#L2018) | $access = true; |
| [2019](#L2019) | foreach ($item->access\_status as $type => $value) { |
| [2020](#L2020) | if ($value == false) { |
| [2021](#L2021) | $access = false; |
| [2022](#L2022) | break; |
| [2023](#L2023) | } |
| [2024](#L2024) | } |
| [2025](#L2025) | $item->access = $access || current\_user\_can("administrator"); |
| [2026](#L2026) | return $item; |
| [2027](#L2027) | } |
| [2028](#L2028) |  |
| [2029](#L2029) | function cluevo\_add\_completed\_module\_to\_list($args) |
| [2030](#L2030) | { |
| [2031](#L2031) | if (empty($args["state"])) return; |
| [2032](#L2032) | if (empty($args["module\_id"])) return; |
| [2033](#L2033) | cluevo\_clear\_turbo\_cache(); |
| [2034](#L2034) | $modules = cluevo\_turbo\_get\_users\_completed\_modules($args["user\_id"], false); |
| [2035](#L2035) | $GLOBALS["cluevo-users-completed-modules"] = $modules; |
| [2036](#L2036) | } |
| [2037](#L2037) |  |
| [2038](#L2038) | function cluevo\_add\_tree\_item\_is\_link\_setting($item) |
| [2039](#L2039) | { |
| [2040](#L2040) | $link = $item->get\_setting("item-is-link"); |
| [2041](#L2041) | ?> |
| [2042](#L2042) | <div class="meta-container item-is-link"> |
| [2043](#L2043) | <details> |
| [2044](#L2044) | <summary class="label"><?php \_e("Item is a link", "cluevo"); ?> |
| [2045](#L2045) | <p class="help"> |
| [2046](#L2046) | <?php \_e("This item links to some other content. Assigned modules won't start, users will be sent the entered link instead.", "cluevo"); ?> |
| [2047](#L2047) | </p> |
| [2048](#L2048) | </summary> |
| [2049](#L2049) | <input type="url" name="item-is-link" value="<?php echo esc\_attr($link); ?>" data-target="item-is-link" class="setting" placeholder="https://" /> |
| [2050](#L2050) | <label> |
| [2051](#L2051) | <input type="checkbox" name="open-link-in-new-window" <?php if ($item->get\_setting("open-link-in-new-window")) echo esc\_attr("checked"); ?> data-target="open-link-in-new-window" class="setting" /> |
| [2052](#L2052) | <?php esc\_html\_e("Open link in new window", "cluevo"); ?> |
| [2053](#L2053) | </label> |
| [2054](#L2054) | </details> |
| [2055](#L2055) | </div> |
| [2056](#L2056) | <?php } |
| [2057](#L2057) |  |
| [2058](#L2058) | function cluevo\_register\_default\_module\_types($args) |
| [2059](#L2059) | { |
| [2060](#L2060) |  |
| [2061](#L2061) | $scorm12 = [ |
| [2062](#L2062) | 'name' => \_\_('SCORM 1.2', 'cluevo'), |
| [2063](#L2063) | 'key' => 'scorm', |
| [2064](#L2064) | 'icon' => plugins\_url("/images/icon-module-ui-scorm-1-2\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2065](#L2065) | 'description' => \_\_('Upload a SCORM module or enter a link to a SCORM module file.', 'cluevo'), |
| [2066](#L2066) | 'field' => 'mixed', |
| [2067](#L2067) | 'filter' => '.zip', |
| [2068](#L2068) | 'field-placeholder' => \_\_('https://', 'cluevo'), |
| [2069](#L2069) | 'button-label' => \_\_('select file', 'cluevo') |
| [2070](#L2070) | ]; |
| [2071](#L2071) |  |
| [2072](#L2072) | $scorm2004 = [ |
| [2073](#L2073) | 'name' => \_\_('SCORM 2004', 'cluevo'), |
| [2074](#L2074) | 'key' => 'scorm', |
| [2075](#L2075) | 'icon' => plugins\_url("/images/icon-module-ui-scorm-2004\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2076](#L2076) | 'description' => \_\_('Upload a SCORM module or enter a link to a SCORM module file.', 'cluevo'), |
| [2077](#L2077) | 'field' => 'mixed', |
| [2078](#L2078) | 'filter' => '.zip', |
| [2079](#L2079) | 'field-placeholder' => \_\_('https://', 'cluevo'), |
| [2080](#L2080) | 'button-label' => \_\_('select file', 'cluevo') |
| [2081](#L2081) | ]; |
| [2082](#L2082) |  |
| [2083](#L2083) | $audio = [ |
| [2084](#L2084) | 'name' => \_\_('Audio File', 'cluevo'), |
| [2085](#L2085) | 'key' => 'audio', |
| [2086](#L2086) | 'icon' => plugins\_url("/images/icon-module-ui-audio\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2087](#L2087) | 'description' => \_\_('Upload a audio file or enter a link to a audio file.', 'cluevo'), |
| [2088](#L2088) | 'field' => 'mixed', |
| [2089](#L2089) | 'filter' => '.mp3,.wav,.webm', |
| [2090](#L2090) | 'field-placeholder' => \_\_('', 'cluevo'), |
| [2091](#L2091) | 'button-label' => \_\_('select audio file', 'cluevo') |
| [2092](#L2092) | ]; |
| [2093](#L2093) |  |
| [2094](#L2094) | $video = [ |
| [2095](#L2095) | 'name' => \_\_('Video File', 'cluevo'), |
| [2096](#L2096) | 'key' => 'video', |
| [2097](#L2097) | 'icon' => plugins\_url("/images/icon-module-ui-video\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2098](#L2098) | 'description' => \_\_('Upload a video file or enter a link to a video file.', 'cluevo'), |
| [2099](#L2099) | 'field' => 'mixed', |
| [2100](#L2100) | 'filter' => '.mp4,.webm,.mpeg', |
| [2101](#L2101) | 'field-placeholder' => \_\_('https://', 'cluevo'), |
| [2102](#L2102) | 'button-label' => \_\_('select video file', 'cluevo') |
| [2103](#L2103) | ]; |
| [2104](#L2104) |  |
| [2105](#L2105) | $pdf = [ |
| [2106](#L2106) | 'name' => \_\_('PDF Document', 'cluevo'), |
| [2107](#L2107) | 'key' => 'pdf', |
| [2108](#L2108) | 'icon' => plugins\_url("/images/icon-module-ui-pdf\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2109](#L2109) | 'description' => \_\_('Upload a PDF document', 'cluevo'), |
| [2110](#L2110) | 'field' => 'mixed', |
| [2111](#L2111) | 'filter' => '.pdf', |
| [2112](#L2112) | 'field-placeholder' => \_\_('https://', 'cluevo'), |
| [2113](#L2113) | 'button-label' => \_\_('select PDF document', 'cluevo') |
| [2114](#L2114) | ]; |
| [2115](#L2115) |  |
| [2116](#L2116) | $oembed = [ |
| [2117](#L2117) | 'name' => \_\_('YouTube, Vimeo, etc.', 'cluevo'), |
| [2118](#L2118) | 'key' => 'oembed', |
| [2119](#L2119) | 'icon' => plugins\_url("/images/icon\_module-ui-oembed\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2120](#L2120) | 'description' => \_\_('Install the CLUEVO Video Tutorial Manager extension to embed content from YouTube and many other sites.', 'cluevo'), |
| [2121](#L2121) | 'field' => null, |
| [2122](#L2122) | 'filter' => null, |
| [2123](#L2123) | 'field-placeholder' => null, |
| [2124](#L2124) | 'button-label' => null, |
| [2125](#L2125) | 'alt-type' => "cluevo-lms-extension-oembed", |
| [2126](#L2126) | 'alt-icon-class' => "extension", |
| [2127](#L2127) | 'alt-content' => '<p><a class="button button-primary cluevo-btn-install-type" href="' . esc\_attr(admin\_url('plugin-install.php?s=cluevo&tab=search&type=term')) . '">' . esc\_html\_\_("Install CLUEVO oEmbed extension", "cluevo") . '</a></p>' |
| [2128](#L2128) | ]; |
| [2129](#L2129) |  |
| [2130](#L2130) | $gdocs = [ |
| [2131](#L2131) | 'name' => \_\_('Google Documents', 'cluevo'), |
| [2132](#L2132) | 'key' => 'gdocs', |
| [2133](#L2133) | 'icon' => plugins\_url("/images/icon-module-ui-gdocs\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2134](#L2134) | 'description' => \_\_('Install the CLUEVO Google Documents extension to use your Google Documents as modules in your LMS.', 'cluevo'), |
| [2135](#L2135) | 'field' => null, |
| [2136](#L2136) | 'filter' => null, |
| [2137](#L2137) | 'field-placeholder' => null, |
| [2138](#L2138) | 'button-label' => null, |
| [2139](#L2139) | 'alt-type' => "cluevo-lms-extension-gdocs", |
| [2140](#L2140) | 'alt-icon-class' => "extension", |
| [2141](#L2141) | 'alt-content' => '<p><a class="button button-primary cluevo-btn-install-type" href="' . esc\_attr(admin\_url('plugin-install.php?s=cluevo&tab=search&type=term')) . '">' . esc\_html\_\_("Install CLUEVO Google Docs extension", "cluevo") . '</a></p>' |
| [2142](#L2142) | ]; |
| [2143](#L2143) |  |
| [2144](#L2144) | $args["types"][] = $scorm12; |
| [2145](#L2145) | $args["types"][] = $scorm2004; |
| [2146](#L2146) | $args["types"][] = $audio; |
| [2147](#L2147) | $args["types"][] = $video; |
| [2148](#L2148) | $args["types"][] = $pdf; |
| [2149](#L2149) | $args["types"][] = $oembed; |
| [2150](#L2150) | $args["types"][] = $gdocs; |
| [2151](#L2151) | } |
| [2152](#L2152) |  |
| [2153](#L2153) | add\_action('cluevo\_register\_module\_types', 'cluevo\_register\_default\_module\_types', 0); |
| [2154](#L2154) | add\_action('cluevo\_lms\_item\_handle\_tools', function ($item) { |
| [2155](#L2155) | if (!is\_plugin\_active('cluevo-lms-extension-certificates/cluevo-lms-extension-certificates.php')) { ?> |
| [2156](#L2156) | <div class="cluevo-ext-tease cluevo-btn cluevo-btn-square" title="<?php esc\_attr\_e("Get the Certificates Extension", "cluevo"); ?>"><img class="plugin-logo" src="<?php echo plugins\_url("/images/cert.svg", \_\_DIR\_\_); ?>" /></div> |
| [2157](#L2157) | <?php |
| [2158](#L2158) | } |
| [2159](#L2159) | }); |
| [2160](#L2160) |  |
| [2161](#L2161) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php?format=txt)
* [Original Format](/export/3222497/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_96df4002_20250114_223704.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fcluevo-lms%2Ftags%2F1.13.2%2Ffunctions%2Ffunctions.module-management.inc.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/cluevo-lms/trunk/functions/functions.module-management.inc.php?rev=3043019 "Revision 3043019")
* [Next Revision](/browser/cluevo-lms/trunk/functions/functions.module-management.inc.php?rev=3221008 "Revision 3221008") →
* [Blame](/browser/cluevo-lms/trunk/functions/functions.module-management.inc.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php)

---

# [source:](/browser?order=name "Go to repository root") [cluevo-lms](/browser/cluevo-lms?order=name "View cluevo-lms")/[tags](/browser/cluevo-lms/tags?order=name "View tags")/[1.13.2](/browser/cluevo-lms/tags/1.13.2?order=name "View 1.13.2")/[functions](/browser/cluevo-lms/tags/1.13.2/functions?order=name "View functions")/[functions.module-management.inc.php](/browser/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php?order=name "View functions.module-management.inc.php")

View diff against:

View revision:

| [Last change](/changeset/3065235/cluevo-lms/trunk/functions/functions.module-management.inc.php "View differences") on this file was [3065235](/changeset/3065235/ "View changeset 3065235"), checked in by cluevo, [9 months ago](/timeline?from=2024-04-05T07%3A05%3A31Z&precision=second "See timeline at 04/05/2024 07:05:31 AM") |
| --- |
| Fixed tree item sort order, display mode, added fileinfo checks |
| **File size:** 93.9 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | if (!defined("CLUEVO\_ACTIVE")) exit; |
| [3](#L3) |  |
| [4](#L4) | /\*\* |
| [5](#L5) | \* Retrieves a module id by it's name from the database |
| [6](#L6) | \* |
| [7](#L7) | \* @param string $strName |
| [8](#L8) | \* |
| [9](#L9) | \* @return int|null |
| [10](#L10) | \*/ |
| [11](#L11) | function cluevo\_get\_module\_id\_by\_name($strName) |
| [12](#L12) | { |
| [13](#L13) | global $wpdb; |
| [14](#L14) | $sql = "SELECT module\_id FROM " . $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES . " WHERE module\_name = %s"; |
| [15](#L15) | $result = $wpdb->get\_var($wpdb->prepare($sql, [$strName])); |
| [16](#L16) |  |
| [17](#L17) | return (!empty($result)) ? (int)$result : null; |
| [18](#L18) | } |
| [19](#L19) |  |
| [20](#L20) | /\*\* |
| [21](#L21) | \* Removes a module from the database |
| [22](#L22) | \* |
| [23](#L23) | \* @param int $intId |
| [24](#L24) | \* |
| [25](#L25) | \* @return int|false |
| [26](#L26) | \*/ |
| [27](#L27) | function cluevo\_remove\_module($intId) |
| [28](#L28) | { |
| [29](#L29) | $module = cluevo\_get\_module($intId); |
| [30](#L30) | if (!empty($module)) { |
| [31](#L31) | $delModule = $module->module\_dir; |
| [32](#L32) | $delPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') . $delModule; |
| [33](#L33) | $delZip = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . $module->module\_zip; |
| [34](#L34) | if (!empty($module->module\_dir) && file\_exists($delPath) && !empty($delPath)) { |
| [35](#L35) | if (!empty($delModule)) { |
| [36](#L36) | cluevo\_delete\_directory($delPath); |
| [37](#L37) | } |
| [38](#L38) | if (!empty($module->module\_zip) && file\_exists($delZip) && !empty($delZip)) |
| [39](#L39) | @unlink($delZip); |
| [40](#L40) | } |
| [41](#L41) | } |
| [42](#L42) |  |
| [43](#L43) | global $wpdb; |
| [44](#L44) | $tables = [ |
| [45](#L45) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES, |
| [46](#L46) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_TREE\_MODULES, |
| [47](#L47) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_TREE\_MODULE\_DEPENDENCIES, |
| [48](#L48) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES\_PROGRESS, |
| [49](#L49) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES\_COMPETENCES, |
| [50](#L50) | $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULE\_PARMS |
| [51](#L51) | ]; |
| [52](#L52) | $results = []; |
| [53](#L53) | foreach ($tables as $table) { |
| [54](#L54) | $sql = "DELETE FROM $table WHERE module\_id = %d"; |
| [55](#L55) | $results[] = $wpdb->query($wpdb->prepare($sql, [$intId])); |
| [56](#L56) | } |
| [57](#L57) | $result = (!empty($results[0])) ? $results[0] : false; |
| [58](#L58) | if ($result !== false) { |
| [59](#L59) | $metaId = cluevo\_get\_metadata\_id\_from\_module\_id($intId); |
| [60](#L60) | if (!empty($metaId)) { |
| [61](#L61) | wp\_delete\_post($metaId, true); |
| [62](#L62) | } |
| [63](#L63) | } |
| [64](#L64) | return $results; |
| [65](#L65) | } |
| [66](#L66) |  |
| [67](#L67) | /\*\* |
| [68](#L68) | \* Returns the metadata page id of a module |
| [69](#L69) | \* |
| [70](#L70) | \* @param int $intModuleId |
| [71](#L71) | \* |
| [72](#L72) | \* @return int|false |
| [73](#L73) | \*/ |
| [74](#L74) | function cluevo\_get\_metadata\_id\_from\_module\_id($intModuleId) |
| [75](#L75) | { |
| [76](#L76) | global $wpdb; |
| [77](#L77) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [78](#L78) | $sql = "SELECT metadata\_id FROM $table WHERE module\_id = %d"; |
| [79](#L79) | $result = $wpdb->get\_var( |
| [80](#L80) | $wpdb->prepare( |
| [81](#L81) | $sql, |
| [82](#L82) | [$intModuleId] |
| [83](#L83) | ) |
| [84](#L84) | ); |
| [85](#L85) |  |
| [86](#L86) | return (!empty($result)) ? (int)$result : false; |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) | /\*\* |
| [90](#L90) | \* Creates or updates a module's database entry |
| [91](#L91) | \* |
| [92](#L92) | \* @param int $strModule |
| [93](#L93) | \* @param int $intMetadataId |
| [94](#L94) | \* @param string $strDir |
| [95](#L95) | \* @param string $strZipFile |
| [96](#L96) | \* @param string $strIndex |
| [97](#L97) | \* |
| [98](#L98) | \* @return int|false |
| [99](#L99) | \*/ |
| [100](#L100) | function cluevo\_create\_module($strModule, $intType, $intMetadataId, $strDir, $strZipFile, $strIndex, $strLang = null, $intParentId = null, $strScormVersion = null) |
| [101](#L101) | { |
| [102](#L102) | global $wpdb; |
| [103](#L103) | $sql = "REPLACE INTO " . $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES . " SET module\_name = %s, metadata\_id = %d, module\_dir = %s, module\_zip = %s, module\_index = %s, lang\_code = %s, type\_id = %d, scorm\_version = %s"; |
| [104](#L104) | $parms = [$strModule, $intMetadataId, $strDir, $strZipFile, $strIndex, $strLang, $intType, $strScormVersion]; |
| [105](#L105) |  |
| [106](#L106) | if (!empty($intParentId)) { |
| [107](#L107) | $sql .= ", module\_id = %d"; |
| [108](#L108) | $parms[] = $intParentId; |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | $result = $wpdb->query($wpdb->prepare($sql, $parms)); |
| [112](#L112) | cluevo\_clear\_turbo\_cache(); |
| [113](#L113) | return $result; |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | function cluevo\_module\_name\_exists($strName) |
| [117](#L117) | { |
| [118](#L118) | global $wpdb; |
| [119](#L119) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [120](#L120) | $sql = "SELECT COUNT(\*) AS count FROM {$table} WHERE module\_name = %s"; |
| [121](#L121) | $result = $wpdb->get\_var($wpdb->prepare($sql, [$strName])); |
| [122](#L122) | return (int)$result > 0; |
| [123](#L123) | } |
| [124](#L124) |  |
| [125](#L125) | function cluevo\_set\_module\_language($intModuleId, $strLangCodeOld, $strLangCodeNew) |
| [126](#L126) | { |
| [127](#L127) | global $wpdb; |
| [128](#L128) | $moduleTable = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [129](#L129) |  |
| [130](#L130) | //if (!cluevo\_module\_language\_exists($intModuleId, $strLangCodeNew)) { |
| [131](#L131) | $sql = "UPDATE IGNORE $moduleTable SET lang\_code = %s WHERE module\_id = %d AND lang\_code = %s"; |
| [132](#L132) |  |
| [133](#L133) | $result = $wpdb->query( |
| [134](#L134) | $wpdb->prepare($sql, [sanitize\_key($strLangCodeNew), $intModuleId, sanitize\_key($strLangCodeOld)]) |
| [135](#L135) | ); |
| [136](#L136) |  |
| [137](#L137) | return ($result !== false && is\_numeric($result) && $result > 0); |
| [138](#L138) | //} |
| [139](#L139) |  |
| [140](#L140) | //return false; |
| [141](#L141) | } |
| [142](#L142) |  |
| [143](#L143) | function cluevo\_module\_language\_exists($intModuleId, $strLangCode) |
| [144](#L144) | { |
| [145](#L145) | global $wpdb; |
| [146](#L146) | $moduleTable = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [147](#L147) |  |
| [148](#L148) | $sql = "SELECT COUNT(\*) FROM $moduleTable  WHERE module\_id = %d AND lang\_code = %s"; |
| [149](#L149) |  |
| [150](#L150) | $result = $wpdb->get\_var( |
| [151](#L151) | $wpdb->prepare($sql, [$intModuleId, $strLangCode]) |
| [152](#L152) | ); |
| [153](#L153) |  |
| [154](#L154) | return ((int)$result == 0); |
| [155](#L155) | } |
| [156](#L156) | /\*\* |
| [157](#L157) | \* Handles the module upload |
| [158](#L158) | \* |
| [159](#L159) | \* Unpacks files, creates db entries and metadata posts |
| [160](#L160) | \*/ |
| [161](#L161) | function cluevo\_handle\_module\_upload(&$errors, &$messages, &$handled, &$result = null) |
| [162](#L162) | { |
| [163](#L163) | $messages[] = \_\_("Handling module upload", "cluevo"); |
| [164](#L164) | if (!empty($result) && is\_numeric($result)) { |
| [165](#L165) | $messages[] = \_\_("Attempting to update module", "cluevo"); |
| [166](#L166) | $oldModule = cluevo\_get\_module((int)$result); |
| [167](#L167) | $moduleDir = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), $oldModule->module\_dir); |
| [168](#L168) | $messages[] = esc\_html(sprintf(\_\_("Existing module found: %s", "cluevo"), $oldModule->module\_name)); |
| [169](#L169) | $archivePath = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH'), $oldModule->module\_zip); |
| [170](#L170) | $file = sanitize\_text\_field($\_FILES['module-file']['tmp\_name']); |
| [171](#L171) | $finfo = finfo\_open(FILEINFO\_MIME\_TYPE); |
| [172](#L172) | $mime = sanitize\_mime\_type(finfo\_file($finfo, $file)); |
| [173](#L173) | finfo\_close($finfo); |
| [174](#L174) | $tmp = uniqid(); |
| [175](#L175) | if ($mime === 'application/zip' && cluevo\_is\_scorm\_zip($file)) { |
| [176](#L176) | $handled = true; |
| [177](#L177) | $messages[] = \_\_("SCORM file detected", "cluevo"); |
| [178](#L178) |  |
| [179](#L179) | if (!empty($oldModule->module\_zip) && $archivePath !== cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') && file\_exists($archivePath)) { |
| [180](#L180) | $messages[] = esc\_html(sprintf(\_\_("Backing up zip: %s", "cluevo"), $archivePath)); |
| [181](#L181) | @rename($archivePath, $archivePath . $tmp); |
| [182](#L182) | } |
| [183](#L183) | if (empty($oldModule->module\_zip)) { |
| [184](#L184) | $filename = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_FILENAME)); |
| [185](#L185) | $ext = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_EXTENSION)); |
| [186](#L186) | $type = sanitize\_file\_name(strtolower(cluevo\_get\_module\_type\_name\_from\_mime\_type($mime))); |
| [187](#L187) |  |
| [188](#L188) | $blacklistExt = cluevo\_get\_blacklisted\_extensions(); |
| [189](#L189) | $blacklistNames = cluevo\_get\_blacklisted\_filenames(); |
| [190](#L190) | if (in\_array($ext, $blacklistExt) || in\_array($filename, $blacklistNames)) { |
| [191](#L191) | $errors[] = \_\_("This type of file is not allowed", "cluevo"); |
| [192](#L192) | return; |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | $archivePath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower($type . '/' . sanitize\_file\_name($\_FILES["module-file"]['name'])); |
| [196](#L196) | } |
| [197](#L197) | if (move\_uploaded\_file($file, $archivePath)) { |
| [198](#L198) | $backedUp = false; |
| [199](#L199) | if (file\_exists($moduleDir)) { |
| [200](#L200) | $messages[] = esc\_html(sprintf(\_\_("Backing up: %s", "cluevo"), $moduleDir)); |
| [201](#L201) | $backedUp = rename($moduleDir, $moduleDir . $tmp); |
| [202](#L202) | } |
| [203](#L203) | if ($backedUp) { |
| [204](#L204) | cluevo\_extract\_scorm\_module($archivePath, $moduleDir); |
| [205](#L205) | $href = cluevo\_find\_module\_index($moduleDir, false); |
| [206](#L206) | $scormVersion = cluevo\_get\_scorm\_version\_from\_manifest($moduleDir); |
| [207](#L207) | cluevo\_create\_module( |
| [208](#L208) | $oldModule->module\_name, |
| [209](#L209) | $oldModule->type\_id, |
| [210](#L210) | $oldModule->metadata\_id, |
| [211](#L211) | $oldModule->module\_dir, |
| [212](#L212) | $oldModule->module\_zip, |
| [213](#L213) | $href, |
| [214](#L214) | $oldModule->lang\_code, |
| [215](#L215) | $oldModule->module\_id, |
| [216](#L216) | $scormVersion |
| [217](#L217) | ); |
| [218](#L218) | $messages[] = \_\_("Cleaning up", "cluevo"); |
| [219](#L219) | if (file\_exists($archivePath . $tmp)) { |
| [220](#L220) | unlink($archivePath . $tmp); |
| [221](#L221) | } |
| [222](#L222) | if (file\_exists($moduleDir . $tmp)) { |
| [223](#L223) | cluevo\_delete\_directory($moduleDir . $tmp); |
| [224](#L224) | } |
| [225](#L225) | $messages[] = \_\_("Module extracted", "cluevo"); |
| [226](#L226) | } |
| [227](#L227) | } |
| [228](#L228) | } else { |
| [229](#L229) | if ($mime !== 'application/zip') { |
| [230](#L230) | if (file\_exists($archivePath)) { |
| [231](#L231) | $messages[] = esc\_html(sprintf(\_\_("Backing up zip: %s", "cluevo"), $archivePath)); |
| [232](#L232) | @rename($archivePath, $archivePath . $tmp); |
| [233](#L233) | } |
| [234](#L234) | if (move\_uploaded\_file($file, $archivePath)) { |
| [235](#L235) | if (file\_exists($moduleDir)) { |
| [236](#L236) | $messages[] = esc\_html(sprintf(\_\_("Backing up: %s", "cluevo"), $moduleDir)); |
| [237](#L237) | $backedUp = rename($moduleDir, $moduleDir . $tmp); |
| [238](#L238) | } |
| [239](#L239) | $handled = false; |
| [240](#L240) | $result = null; |
| [241](#L241) | do\_action('cluevo\_activate\_module', [ |
| [242](#L242) | "module" => $archivePath, |
| [243](#L243) | "mime" => $mime, |
| [244](#L244) | "messages" => &$messages, |
| [245](#L245) | "errors" => &$errors, |
| [246](#L246) | "parentModuleId" => $oldModule->module\_id, |
| [247](#L247) | "lang" => $oldModule->lang\_code, |
| [248](#L248) | "handled" => &$handled, |
| [249](#L249) | "result" => &$result |
| [250](#L250) | ]); |
| [251](#L251) | } |
| [252](#L252) | if ($handled) { |
| [253](#L253) | $messages[] = \_\_("Cleaning up", "cluevo"); |
| [254](#L254) | if (file\_exists($archivePath . $tmp)) { |
| [255](#L255) | unlink($archivePath . $tmp); |
| [256](#L256) | } |
| [257](#L257) | if (file\_exists($moduleDir . $tmp)) { |
| [258](#L258) | cluevo\_delete\_directory($moduleDir . $tmp); |
| [259](#L259) | } |
| [260](#L260) | $messages[] = \_\_("Module extracted", "cluevo"); |
| [261](#L261) | } else { |
| [262](#L262) | $errors[] = \_\_("No handler for this content type could be found.", "cluevo"); |
| [263](#L263) | unlink($archivePath); |
| [264](#L264) | } |
| [265](#L265) | } |
| [266](#L266) | } |
| [267](#L267) | return; |
| [268](#L268) | } |
| [269](#L269) | if (!empty($\_FILES["module-file"]["name"])) { |
| [270](#L270) | $file = sanitize\_text\_field($\_FILES['module-file']['tmp\_name']); |
| [271](#L271) | $filename = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_FILENAME)); |
| [272](#L272) | $ext = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_EXTENSION)); |
| [273](#L273) |  |
| [274](#L274) | $blacklistExt = cluevo\_get\_blacklisted\_extensions(); |
| [275](#L275) | $blacklistNames = cluevo\_get\_blacklisted\_filenames(); |
| [276](#L276) | if (in\_array($ext, $blacklistExt) || in\_array($filename, $blacklistNames)) { |
| [277](#L277) | $errors[] = \_\_("This type of file is not allowed", "cluevo"); |
| [278](#L278) | return; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | $finfo = finfo\_open(FILEINFO\_MIME\_TYPE); |
| [282](#L282) | $mime = sanitize\_mime\_type(finfo\_file($finfo, $file)); |
| [283](#L283) | $type = sanitize\_key(strtolower(cluevo\_get\_module\_type\_name\_from\_mime\_type($mime))); |
| [284](#L284) |  |
| [285](#L285) | if (!file\_exists(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH'))) { |
| [286](#L286) | mkdir(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH'), 0755, true); |
| [287](#L287) | } |
| [288](#L288) |  |
| [289](#L289) | $targetDirExists = true; |
| [290](#L290) | if (!file\_exists(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . "$type/")) { |
| [291](#L291) | $targetDirExists = @mkdir(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . "$type/", 0755, true); |
| [292](#L292) | } |
| [293](#L293) | $archivePath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower($type . '/' . sanitize\_file\_name($\_FILES["module-file"]['name'])); |
| [294](#L294) | $zipFile = strtolower(sanitize\_file\_name($\_FILES["module-file"]['name'])); |
| [295](#L295) | $realPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') . $filename . '/'; |
| [296](#L296) | $overwrite = false; |
| [297](#L297) |  |
| [298](#L298) | $lang = (!empty($\_POST["language"]) && ctype\_alpha($\_POST["language"])) ? sanitize\_text\_field($\_POST["language"]) : null; |
| [299](#L299) | $parentModule = null; |
| [300](#L300) | $parentModuleId = null; |
| [301](#L301) | $tmp\_pid = (!empty($\_POST["parent-module-id"]) && is\_numeric($\_POST["parent-module-id"])) ? (int)$\_POST["parent-module-id"] : null; |
| [302](#L302) | if (!empty($tmp\_pid)) { |
| [303](#L303) | $parentModule = cluevo\_get\_module($tmp\_pid); |
| [304](#L304) | $parentModuleId = $parentModule->module\_id; |
| [305](#L305) | } |
| [306](#L306) |  |
| [307](#L307) | if (move\_uploaded\_file($file, $archivePath)) { |
| [308](#L308) | $handled = false; |
| [309](#L309) | do\_action('cluevo\_activate\_module', [ |
| [310](#L310) | "module" => $archivePath, |
| [311](#L311) | "mime" => $mime, |
| [312](#L312) | "messages" => &$messages, |
| [313](#L313) | "errors" => &$errors, |
| [314](#L314) | "parentModuleId" => $parentModuleId, |
| [315](#L315) | "lang" => $lang, |
| [316](#L316) | "handled" => &$handled, |
| [317](#L317) | "result" => &$result |
| [318](#L318) | ]); |
| [319](#L319) | if (!$handled) { |
| [320](#L320) | $errors[] = \_\_("No handler for this content type could be found.", "cluevo"); |
| [321](#L321) | unlink($archivePath); |
| [322](#L322) | } |
| [323](#L323) | } else { |
| [324](#L324) | $errors[] = \_\_("Failed to move uploaded file.", "cluevo"); |
| [325](#L325) | } |
| [326](#L326) | } |
| [327](#L327) | } |
| [328](#L328) |  |
| [329](#L329) | function cluevo\_url\_exists($strUrl) |
| [330](#L330) | { |
| [331](#L331) | $headers = @get\_headers($strUrl); |
| [332](#L332) | foreach ($headers as $h) { |
| [333](#L333) | if (!$h || strpos($h, "200")) { |
| [334](#L334) | return true; |
| [335](#L335) | } |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | return false; |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | function cluevo\_handle\_module\_download($strUrl, &$errors, &$messages, &$handled, &$result = null) |
| [342](#L342) | { |
| [343](#L343) | if (empty($strUrl)) { |
| [344](#L344) | $errors[] = \_\_("URL should not be empty", "cluevo"); |
| [345](#L345) | return; |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | $url = esc\_url\_raw($strUrl, ['http', 'https', 'ftp']); |
| [349](#L349) | $path = parse\_url(urldecode($url), PHP\_URL\_PATH); |
| [350](#L350) | $ext = strtolower(pathinfo($path, PATHINFO\_EXTENSION)); |
| [351](#L351) | $validExtensions = ["zip", "mp3", "wav", "mp4", "webm"]; |
| [352](#L352) | $handled = false; |
| [353](#L353) | if (in\_array($ext, $validExtensions)) { |
| [354](#L354) | $title = sanitize\_text\_field(pathinfo($path, PATHINFO\_FILENAME)); |
| [355](#L355) | $filename = strtolower(pathinfo(sanitize\_file\_name(trim(basename($path), '/')),  PATHINFO\_FILENAME)) . ".$ext"; |
| [356](#L356) | $tmpPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower('tmp/' . $filename); |
| [357](#L357) | $res = @fopen($url, 'r'); |
| [358](#L358) | if ($res !== false) { |
| [359](#L359) | file\_put\_contents($tmpPath, $res); |
| [360](#L360) | $finfo = finfo\_open(FILEINFO\_MIME\_TYPE); |
| [361](#L361) | $mime = finfo\_file($finfo, $tmpPath); |
| [362](#L362) | $type = sanitize\_file\_name(strtolower(cluevo\_get\_module\_type\_name\_from\_mime\_type($mime))); |
| [363](#L363) |  |
| [364](#L364) | // handle updates |
| [365](#L365) | if (!empty($result) && is\_numeric($result)) { |
| [366](#L366) | $messages[] = \_\_("Attempting to update module", "cluevo"); |
| [367](#L367) | $oldModule = cluevo\_get\_module((int)$result); |
| [368](#L368) | $moduleDir = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), $oldModule->module\_dir); |
| [369](#L369) | $messages[] = esc\_html(sprintf(\_\_("Existing module found: %s", "cluevo"), $oldModule->module\_name)); |
| [370](#L370) | $archivePath = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH'), $oldModule->module\_zip); |
| [371](#L371) | $tmp = uniqid(); |
| [372](#L372) | if ($mime === 'application/zip' && cluevo\_is\_scorm\_zip($tmpPath)) { |
| [373](#L373) | $handled = true; |
| [374](#L374) | $messages[] = \_\_("SCORM file detected", "cluevo"); |
| [375](#L375) |  |
| [376](#L376) | if (!empty($oldModule->module\_zip) && $archivePath !== cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') && file\_exists($archivePath)) { |
| [377](#L377) | $messages[] = esc\_html(sprintf(\_\_("Backing up zip: %s", "cluevo"), $archivePath)); |
| [378](#L378) | @rename($archivePath, $archivePath . $tmp); |
| [379](#L379) | } |
| [380](#L380) | if (empty($oldModule->module\_zip)) { |
| [381](#L381) | $filename = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_FILENAME)); |
| [382](#L382) | $ext = strtolower(pathinfo(sanitize\_file\_name($\_FILES["module-file"]['name']),  PATHINFO\_EXTENSION)); |
| [383](#L383) | $type = sanitize\_file\_name(strtolower(cluevo\_get\_module\_type\_name\_from\_mime\_type($mime))); |
| [384](#L384) |  |
| [385](#L385) | $blacklistExt = cluevo\_get\_blacklisted\_extensions(); |
| [386](#L386) | $blacklistNames = cluevo\_get\_blacklisted\_filenames(); |
| [387](#L387) | if (in\_array($ext, $blacklistExt) || in\_array($filename, $blacklistNames)) { |
| [388](#L388) | $errors[] = \_\_("This type of file is not allowed", "cluevo"); |
| [389](#L389) | return; |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | $archivePath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower($type . '/' . sanitize\_file\_name($\_FILES["module-file"]['name'])); |
| [393](#L393) | } |
| [394](#L394) | $backedUp = false; |
| [395](#L395) | if (file\_exists($moduleDir)) { |
| [396](#L396) | $messages[] = esc\_html(sprintf(\_\_("Backing up: %s", "cluevo"), $moduleDir)); |
| [397](#L397) | $backedUp = rename($moduleDir, $moduleDir . $tmp); |
| [398](#L398) | } |
| [399](#L399) | if ($backedUp) { |
| [400](#L400) | cluevo\_extract\_scorm\_module($tmpPath, $moduleDir); |
| [401](#L401) | $href = cluevo\_find\_module\_index($moduleDir, false); |
| [402](#L402) | $scormVersion = cluevo\_get\_scorm\_version\_from\_manifest($moduleDir); |
| [403](#L403) | $messages[] = esc\_html(sprintf(\_\_("Updating module data. Index: %s, version: %s", "cluevo"), $href, $scormVersion)); |
| [404](#L404) | cluevo\_create\_module( |
| [405](#L405) | $oldModule->module\_name, |
| [406](#L406) | $oldModule->type\_id, |
| [407](#L407) | $oldModule->metadata\_id, |
| [408](#L408) | $oldModule->module\_dir, |
| [409](#L409) | $oldModule->module\_zip, |
| [410](#L410) | $href, |
| [411](#L411) | $oldModule->lang\_code, |
| [412](#L412) | $oldModule->module\_id, |
| [413](#L413) | $scormVersion |
| [414](#L414) | ); |
| [415](#L415) | $messages[] = \_\_("Cleaning up", "cluevo"); |
| [416](#L416) | if (file\_exists($archivePath . $tmp)) { |
| [417](#L417) | unlink($archivePath . $tmp); |
| [418](#L418) | } |
| [419](#L419) | if (file\_exists($moduleDir . $tmp)) { |
| [420](#L420) | cluevo\_delete\_directory($moduleDir . $tmp); |
| [421](#L421) | } |
| [422](#L422) | $messages[] = \_\_("Module extracted", "cluevo"); |
| [423](#L423) | } |
| [424](#L424) | } else { |
| [425](#L425) | if ($mime !== 'application/zip') { |
| [426](#L426) | if (file\_exists($archivePath)) { |
| [427](#L427) | $messages[] = esc\_html(sprintf(\_\_("Backing up zip: %s", "cluevo"), $archivePath)); |
| [428](#L428) | @rename($archivePath, $archivePath . $tmp); |
| [429](#L429) | } |
| [430](#L430) | if (move\_uploaded\_file($tmpPath, $archivePath)) { |
| [431](#L431) | if (file\_exists($moduleDir)) { |
| [432](#L432) | $messages[] = esc\_html(sprintf(\_\_("Backing up: %s", "cluevo"), $moduleDir)); |
| [433](#L433) | $backedUp = rename($moduleDir, $moduleDir . $tmp); |
| [434](#L434) | } |
| [435](#L435) | $handled = false; |
| [436](#L436) | $result = null; |
| [437](#L437) | do\_action('cluevo\_activate\_module', [ |
| [438](#L438) | "module" => $archivePath, |
| [439](#L439) | "mime" => $mime, |
| [440](#L440) | "messages" => &$messages, |
| [441](#L441) | "errors" => &$errors, |
| [442](#L442) | "parentModuleId" => $oldModule->module\_id, |
| [443](#L443) | "lang" => $oldModule->lang\_code, |
| [444](#L444) | "handled" => &$handled, |
| [445](#L445) | "result" => &$result |
| [446](#L446) | ]); |
| [447](#L447) | } |
| [448](#L448) | if ($handled) { |
| [449](#L449) | $messages[] = \_\_("Cleaning up", "cluevo"); |
| [450](#L450) | if (file\_exists($archivePath . $tmp)) { |
| [451](#L451) | unlink($archivePath . $tmp); |
| [452](#L452) | } |
| [453](#L453) | if (file\_exists($moduleDir . $tmp)) { |
| [454](#L454) | cluevo\_delete\_directory($moduleDir . $tmp); |
| [455](#L455) | } |
| [456](#L456) | $messages[] = \_\_("Module extracted", "cluevo"); |
| [457](#L457) | } else { |
| [458](#L458) | $errors[] = \_\_("No handler for this content type could be found.", "cluevo"); |
| [459](#L459) | unlink($archivePath); |
| [460](#L460) | } |
| [461](#L461) | } |
| [462](#L462) | } |
| [463](#L463) | return; |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | $targetDirExists = true; |
| [467](#L467) | if (!file\_exists(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . "$type/")) { |
| [468](#L468) | $targetDirExists = @mkdir(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . "$type/", 0755, true); |
| [469](#L469) | } |
| [470](#L470) | $archivePath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . strtolower("$type/" . $filename); |
| [471](#L471) | if ($targetDirExists && @rename($tmpPath, $archivePath)) { |
| [472](#L472) | $result = []; |
| [473](#L473) | $module = null; |
| [474](#L474) | do\_action('cluevo\_activate\_module', [ |
| [475](#L475) | "module" => $archivePath, |
| [476](#L476) | "title" => $title, |
| [477](#L477) | "mime" => $mime, |
| [478](#L478) | "messages" => &$messages, |
| [479](#L479) | "errors" => &$errors, |
| [480](#L480) | "parentModuleId" => null, |
| [481](#L481) | "lang" => null, |
| [482](#L482) | "handled" => &$handled, |
| [483](#L483) | "result" => &$result |
| [484](#L484) | ]); |
| [485](#L485) | if ($handled) { |
| [486](#L486) | return $result; |
| [487](#L487) | } |
| [488](#L488) | } else { |
| [489](#L489) | $errors[] = \_\_("An error occurred while moving the file to the target directory.", "cluevo"); |
| [490](#L490) | } |
| [491](#L491) | } else { |
| [492](#L492) | $errors[] = \_\_("File does not exist.", "cluevo"); |
| [493](#L493) | } |
| [494](#L494) | } else { |
| [495](#L495) | $result = []; |
| [496](#L496) | do\_action('cluevo\_handle\_module\_url\_install', [ |
| [497](#L497) | 'url' => $url, |
| [498](#L498) | "messages" => &$messages, |
| [499](#L499) | "errors" => &$errors, |
| [500](#L500) | "parentModuleId" => null, |
| [501](#L501) | "lang" => null, |
| [502](#L502) | "handled" => &$handled, |
| [503](#L503) | "result" => &$result, |
| [504](#L504) | "module" => &$module |
| [505](#L505) | ]); |
| [506](#L506) | if ($handled) { |
| [507](#L507) | return $result; |
| [508](#L508) | } else { |
| [509](#L509) | do\_action('cluevo\_handle\_misc\_module\_url\_input', [ |
| [510](#L510) | "input" => $url, |
| [511](#L511) | "messages" => &$messages, |
| [512](#L512) | "errors" => &$errors, |
| [513](#L513) | "handled" => &$handled, |
| [514](#L514) | "result" => &$result, |
| [515](#L515) | "module" => &$module |
| [516](#L516) | ]); |
| [517](#L517) | } |
| [518](#L518) | } |
| [519](#L519) | if (!$handled) { |
| [520](#L520) | $errors[] = \_\_("The module failed to install.", "cluevo"); |
| [521](#L521) | } |
| [522](#L522) | } |
| [523](#L523) |  |
| [524](#L524) | /\*\* |
| [525](#L525) | \* Recursively creates metadata posts of a given item |
| [526](#L526) | \* |
| [527](#L527) | \* Recursively creates parent's posts if necessary |
| [528](#L528) | \* |
| [529](#L529) | \* @param mixed $item |
| [530](#L530) | \* @param mixed $intParentId |
| [531](#L531) | \* @param mixed $tree |
| [532](#L532) | \*/ |
| [533](#L533) | function cluevo\_create\_metadata\_post($item, $intParentId, &$tree) |
| [534](#L534) | { |
| [535](#L535) | $parentPostId = $intParentId; |
| [536](#L536) |  |
| [537](#L537) | if (!empty($item->parent\_id)) { // if the item has a parent we need to have the parent post first before we can create the item's post |
| [538](#L538) |  |
| [539](#L539) | if ($item->new) { |
| [540](#L540) | if (array\_key\_exists($item->parent\_id, $tree)) { |
| [541](#L541) | $parentItem = $tree[$item->parent\_id]; |
| [542](#L542) | } else { |
| [543](#L543) | $parentItem = cluevo\_get\_learning\_structure\_item($item->tree\_id); |
| [544](#L544) | } |
| [545](#L545) | } else { |
| [546](#L546) | $parentItem = cluevo\_get\_learning\_structure\_item($item->parent\_id); |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | $parentPostId = $parentItem->metadata\_id; |
| [550](#L550) | $post = get\_post($parentPostId); |
| [551](#L551) | if (empty($post) || empty($parentPostId)) { // check if post exists or metadata id is empty |
| [552](#L552) | if (!empty($post)) { |
| [553](#L553) | $parentPostId = $post->ID; |
| [554](#L554) | } |
| [555](#L555) | if (!array\_key\_exists($item->parent\_id, $tree)) { |
| [556](#L556) | $tree[$item->parent\_id] = cluevo\_get\_learning\_structure\_item($item->parent\_id); |
| [557](#L557) | } |
| [558](#L558) | $parentPostId = cluevo\_create\_metadata\_post($tree[$item->parent\_id], $parentPostId, $tree); |
| [559](#L559) | } |
| [560](#L560) | } |
| [561](#L561) |  |
| [562](#L562) | if (get\_post($item->metadata\_id) === null || empty($item->metadata\_id)) { |
| [563](#L563) | $id = cluevo\_create\_metadata\_page($item, $parentPostId); |
| [564](#L564) | $tree[$item->item\_id]->metadata\_id = $id; |
| [565](#L565) | } else { |
| [566](#L566) | cluevo\_update\_metadata\_page($item, $parentPostId); |
| [567](#L567) | $id = $item->metadata\_id; |
| [568](#L568) | } |
| [569](#L569) | return $id; |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | /\*\* |
| [573](#L573) | \* Returns a textbox and dropdown containing the selected modules as options |
| [574](#L574) | \* |
| [575](#L575) | \* @param mixed $name |
| [576](#L576) | \* @param mixed $modules |
| [577](#L577) | \* @param mixed $intSelected |
| [578](#L578) | \*/ |
| [579](#L579) | function cluevo\_render\_module\_list($name, $modules, $intSelected = null, $boolHideButton = false) |
| [580](#L580) | { |
| [581](#L581) | $out = "<input type=\"text\" data-target=\"name\" class=\"module-name sortable-name\" value=\"" . esc\_attr($name) . "\" /> "; |
| [582](#L582) | $labelVisible = 'hidden'; |
| [583](#L583) | $buttonVisible = 'hidden'; |
| [584](#L584) | $id = ''; |
| [585](#L585) | $name = ''; |
| [586](#L586) | if (!empty($intSelected)) { |
| [587](#L587) | $selected = null; |
| [588](#L588) | foreach ($modules as $module) { |
| [589](#L589) | if ($module->module\_id == $intSelected) { |
| [590](#L590) | $selected = $module; |
| [591](#L591) | break; |
| [592](#L592) | } |
| [593](#L593) | } |
| [594](#L594) | $labelVisible = ''; |
| [595](#L595) | if (!empty($selected)) { |
| [596](#L596) | $id = $selected->module\_id; |
| [597](#L597) | $name = $selected->module\_name; |
| [598](#L598) | } |
| [599](#L599) | } else { |
| [600](#L600) | $buttonVisible = ''; |
| [601](#L601) | } |
| [602](#L602) | $buttonVisible = ($boolHideButton) ? 'hidden' : $buttonVisible; |
| [603](#L603) | $out .= "<div class=\"module-name-label $labelVisible\" data-value=\"" . esc\_attr($id) . "\" data-target=\"module-id\"> |
| [604](#L604) | <div class=\"dashicons dashicons-welcome-learn-more label-icon\"></div> |
| [605](#L605) | <div class=\"content\">" . esc\_attr($name) . "</div> |
| [606](#L606) | <div class=\"dashicons dashicons-edit cluevo-edit-module label-icon-right\"></div> |
| [607](#L607) | <div class=\"dashicons dashicons-dismiss remove-module label-icon-right\"></div> |
| [608](#L608) | </div>"; |
| [609](#L609) | $out .= "<div class=\"cluevo-btn cluevo-make-module " . esc\_attr($buttonVisible) . "\">" . esc\_html\_\_("Insert Module", "cluevo") . "</div>"; |
| [610](#L610) | $allowed = wp\_kses\_allowed\_html("post"); |
| [611](#L611) | $allowed["input"] = ["type" => 1, "data-\*" => 1, "class" => 1, "value" => 1]; |
| [612](#L612) | return wp\_kses($out, $allowed);; |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | /\*\* |
| [616](#L616) | \* Callback to handle creation of new course groups |
| [617](#L617) | \* |
| [618](#L618) | \* Creates the database entries and metadata pages for tree items |
| [619](#L619) | \* |
| [620](#L620) | \* @param mixed $name |
| [621](#L621) | \*/ |
| [622](#L622) | function cluevo\_handle\_create\_learning\_structure($name) |
| [623](#L623) | { |
| [624](#L624) | $treeMetadataId = wp\_insert\_post(["post\_title" => sanitize\_title($name), "post\_status" => "publish", 'post\_type' => CLUEVO\_METADATA\_POST\_TYPE]); |
| [625](#L625) | $terms = get\_terms(['taxonomy' => CLUEVO\_TAXONOMY, 'hide\_empty' => false]); |
| [626](#L626) | if (is\_array($terms)) { |
| [627](#L627) | foreach ($terms as $term) { |
| [628](#L628) | if ($term->name == \_\_("Course Group", "cluevo")) { |
| [629](#L629) | wp\_set\_post\_terms($treeMetadataId, [$term->term\_id], CLUEVO\_TAXONOMY); |
| [630](#L630) | break; |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) | } |
| [634](#L634) | $treeIndex = cluevo\_create\_learning\_structure($name, $treeMetadataId); |
| [635](#L635) | update\_option("cluevo-selected-course-group", $treeIndex); |
| [636](#L636) | } |
| [637](#L637) |  |
| [638](#L638) | /\*\* |
| [639](#L639) | \* Creates the metadata post for a module |
| [640](#L640) | \* |
| [641](#L641) | \* Returns the new post id on success |
| [642](#L642) | \* |
| [643](#L643) | \* @param string $strFilename |
| [644](#L644) | \* |
| [645](#L645) | \* @return int|WP\_Error |
| [646](#L646) | \*/ |
| [647](#L647) | function cluevo\_create\_module\_metadata\_post($strFilename) |
| [648](#L648) | { |
| [649](#L649) | $id = wp\_insert\_post( |
| [650](#L650) | [ |
| [651](#L651) | "post\_title" => sanitize\_title($strFilename), |
| [652](#L652) | "post\_status" => "publish", |
| [653](#L653) | "post\_type" => CLUEVO\_METADATA\_POST\_TYPE\_SCORM\_MODULE |
| [654](#L654) | ] |
| [655](#L655) | ); |
| [656](#L656) | $terms = get\_terms(['taxonomy' => 'CLUEVO', 'hide\_empty' => false]); |
| [657](#L657) | if (is\_array($terms)) { |
| [658](#L658) | foreach ($terms as $term) { |
| [659](#L659) | if ($term->name == \_\_("SCORM Module", "cluevo")) { |
| [660](#L660) | wp\_set\_post\_terms($id, [$term->term\_id], \_\_("SCORM MODULE", "cluevo")); |
| [661](#L661) | break; |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) | } |
| [665](#L665) |  |
| [666](#L666) | return $id; |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | /\*\* |
| [670](#L670) | \* Renders an item recursively |
| [671](#L671) | \* |
| [672](#L672) | \* @param mixed $item |
| [673](#L673) | \* @param array $modules |
| [674](#L674) | \* @param mixed $forceId |
| [675](#L675) | \*/ |
| [676](#L676) | function cluevo\_render\_courses($item, $modules = array(), $forceId = null) |
| [677](#L677) | { |
| [678](#L678) | if (empty($item)) return; |
| [679](#L679) | // these variables contain learn unit information. TODO: develop a system of storing and retrieving this information to make it easily extensible. Maybe create an interface or include php files |
| [680](#L680) | $url = remove\_query\_arg(['create-metadata-page']); |
| [681](#L681) | if (get\_class($item) === 'CluevoItem') $item->load\_settings(); |
| [682](#L682) | $name = (!empty($item->name)) ? $item->name : ''; |
| [683](#L683) | $level = (!empty($item->level)) ? $item->level : 0; |
| [684](#L684) | $pointsNeeded = (!empty($item->points\_required)) ? $item->points\_required : 0; |
| [685](#L685) | $pointsWorth = (is\_numeric($item->points\_worth)) ? (int)$item->points\_worth : 0; |
| [686](#L686) | $levelRequired = (!empty($item->level\_required)) ? $item->level\_required : 0; |
| [687](#L687) | $dependencies = (!empty($item->dependencies)) ? $item->dependencies : ['modules' => ['normal' => [], 'blocked' => [], 'inherited' => []], 'other' => ['normal' => [], 'blocked' => [], 'inherited' => []]]; |
| [688](#L688) | $repeatInterval = (!empty($item->repeat\_interval)) ? $item->repeat\_interval : 0; |
| [689](#L689) | $repeatIntervalType = (!empty($item->repeat\_interval\_type)) ? $item->repeat\_interval\_type : 'day'; |
| [690](#L690) | $moduleId = (!empty($item->module\_id)) ? ' data-module-id="' . esc\_attr($item->module\_id) . '"' : ''; |
| [691](#L691) | $displayMode = ($item->type == "module") ? ' data-display-mode="' . esc\_attr($item->display\_mode) . '"' : ''; |
| [692](#L692) | $defaultDisplayMode = strtolower(get\_option('cluevo-modules-display-mode')); |
| [693](#L693) | $link = $item->get\_setting("item-is-link"); |
| [694](#L694) | $isLink = false; |
| [695](#L695) | if (!empty($link) && is\_string($link)) { |
| [696](#L696) | $isLink = (trim($link) !== "") ? true : false; |
| [697](#L697) | } |
| [698](#L698) | //$moduleId = 0; |
| [699](#L699) | $metadataId = 0; |
| [700](#L700) | if (!empty($item)) { |
| [701](#L701) | $item->id = (empty($item->id)) ? 0 : $item->id; |
| [702](#L702) | $item->id = (empty($item->item\_id)) ? $item->id : $item->item\_id; |
| [703](#L703) | $id = 'item-' . $item->id; |
| [704](#L704) | $id = (!empty($forceId)) ? $forceId : $id; |
| [705](#L705) | $metadataId = $item->metadata\_id; |
| [706](#L706) | } else { |
| [707](#L707) | $id = (!empty($forceId)) ? $forceId : 0; |
| [708](#L708) | } |
| [709](#L709) |  |
| [710](#L710) | $hasDependencies = false; |
| [711](#L711) | foreach ($dependencies as $depType => $deps) { |
| [712](#L712) | foreach ($deps as $dep) { |
| [713](#L713) | if (!empty($dep)) { |
| [714](#L714) | $hasDependencies = true; |
| [715](#L715) | break; |
| [716](#L716) | } |
| [717](#L717) | } |
| [718](#L718) | if ($hasDependencies) break; |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) |  |
| [722](#L722) | $classes = []; |
| [723](#L723) | $classes[] = ($item->published) ? "published" : "draft"; |
| [724](#L724) | if (!empty($item->module\_id) && (int)$item->module\_id > 0) $classes[] = "module-assigned"; |
| [725](#L725) | if ($hasDependencies) $classes[] = "has-dependencies"; |
| [726](#L726) | if ($isLink) $classes[] = "is-link"; |
| [727](#L727) | $classes = implode(" ", $classes); |
| [728](#L728) |  |
| [729](#L729) | echo '<li id="' . esc\_attr($id) . '" |
| [730](#L730) | class="lms-tree-item ' . esc\_attr($classes) . '" |
| [731](#L731) | data-item-id="' . esc\_attr($item->item\_id) . '" |
| [732](#L732) | data-name="' . esc\_attr($item->name) . '" |
| [733](#L733) | data-id="' . esc\_attr($item->id) . '" |
| [734](#L734) | data-module-id="' . esc\_attr($item->module\_id) . '" |
| [735](#L735) | data-level="' . esc\_attr($item->level) . '" |
| [736](#L736) | data-type="' . esc\_attr(CLUEVO\_LEARNING\_STRUCTURE\_LEVELS[$item->level]) . '" |
| [737](#L737) | data-dependencies=\'' . json\_encode($item->dependencies) . '\' |
| [738](#L738) | data-repeat-interval="' . esc\_attr($item->repeat\_interval) . '" |
| [739](#L739) | data-repeat-interval-type="' . esc\_attr($item->repeat\_interval\_type)  . '" |
| [740](#L740) | data-metadata-id="' . esc\_attr($item->metadata\_id) . '" |
| [741](#L741) | data-published="' . esc\_attr($item->published) . '" |
| [742](#L742) | data-item-is-link="' . esc\_attr($isLink) . '" |
| [743](#L743) | data-login-required="' . esc\_attr($item->login\_required) . '"' . $displayMode . '>'; |
| [744](#L744) | ?> |
| [745](#L745) | <div class="handle"> |
| [746](#L746) | <div class="move-container"> |
| [747](#L747) | <div class="up"><span class="dashicons dashicons-arrow-up-alt"></span></div> |
| [748](#L748) | <div class="down"><span class="dashicons dashicons-arrow-down-alt"></span></div> |
| [749](#L749) | </div> |
| [750](#L750) | <span class="title"> |
| [751](#L751) | <?php echo cluevo\_render\_module\_list($name, $modules, (!empty($item->module) && $item->module > 0) ? $item->module : null, (empty($item->children) ? false : true)); ?> |
| [752](#L752) | <span class="type fade"> |
| [753](#L753) | <?php |
| [754](#L754) | $nextItemType = 'element'; |
| [755](#L755) | switch ($item->type) { |
| [756](#L756) | case "course": |
| [757](#L757) | echo \_\_("Course", "cluevo"); |
| [758](#L758) | $nextItemType = \_\_("Chapter", "cluevo"); |
| [759](#L759) | break; |
| [760](#L760) | case "chapter": |
| [761](#L761) | echo \_\_("Chapter", "cluevo"); |
| [762](#L762) | $nextItemType = \_\_("Module", "cluevo"); |
| [763](#L763) | break; |
| [764](#L764) | case "module": |
| [765](#L765) | echo \_\_("Module", "cluevo"); |
| [766](#L766) | break; |
| [767](#L767) | default: |
| [768](#L768) | echo ""; |
| [769](#L769) | } |
| [770](#L770) | ?> |
| [771](#L771) | </span> |
| [772](#L772) | <span class="tree-item-id fade shortcode copy-shortcode" title="<?php esc\_attr\_e("Copy Shortcode", "cluevo"); ?>">[<?php echo (!empty($item)) ? esc\_attr($item->id) : ""; ?>]</span> |
| [773](#L773) | </span> |
| [774](#L774) | <div class="buttons"> |
| [775](#L775) | <span class="cluevo-item-is-link dashicons dashicons-admin-links"></span> |
| [776](#L776) | <img class="has-dependencies-icon" alt="<?php esc\_attr\_e("This item has dependencies", "cluevo"); ?>" title="<?php esc\_attr\_e("This item has dependencies", "cluevo"); ?>" src="<?php echo plugins\_url("/images/icon-dependency-neg.svg", plugin\_dir\_path(\_\_FILE\_\_)); ?>" /> |
| [777](#L777) | <?php do\_action("cluevo\_lms\_item\_handle\_tools", $item); ?> |
| [778](#L778) | <div class="publish cluevo-btn cluevo-btn-square cluevo-button-primary" title="<?php ($item->published) ? esc\_attr\_e("Published", "cluevo") : esc\_attr\_e('Draft', "cluevo"); ?>"> |
| [779](#L779) | <?php if ($item->published) { ?><span class="dashicons dashicons-visibility"></span> |
| [780](#L780) | <?php } else { ?><span class="dashicons dashicons-hidden"></span><?php } ?> |
| [781](#L781) | </div> |
| [782](#L782) | <?php if ($item->level < 3) { ?> |
| [783](#L783) | <div class="add cluevo-btn cluevo-btn-square cluevo-button-primary" <?php echo (!empty($item->module\_id) && $item->module\_id > 0) ? 'disabled="disabled"' : ''; ?> title="<?php esc\_attr\_e(sprintf(\_\_("Add %s to this item", "cluevo"), $nextItemType)); ?>"><img class="plugin-logo" src="<?php echo plugins\_url("/images/icon-add-child.svg", plugin\_dir\_path(\_\_FILE\_\_)); ?>" /></div> |
| [784](#L784) | <?php } ?> |
| [785](#L785) | <?php if (get\_post($metadataId) !== null) { ?> |
| [786](#L786) | <a class="metadata cluevo-btn cluevo-btn-square metadata-edit-link" title="<?php \_e("Open this elements post", "cluevo"); ?>" href="<?php echo get\_edit\_post\_link($metadataId); ?>" target="\_blank"><span class="dashicons dashicons-wordpress"></span></a> |
| [787](#L787) | <?php } else { ?> |
| [788](#L788) | <a class="cluevo-btn cluevo-btn-square cluevo-btn-primary" title="<?php esc\_attr\_e("Create item page", "cluevo"); ?>" href="<?php echo add\_query\_arg('create-metadata-page', $item->id, $url); ?>"><span class="dashicons dashicons-wordpress"></span></a> |
| [789](#L789) | <?php } ?> |
| [790](#L790) | <div class="shortcode cluevo-btn cluevo-btn-square copy-shortcode" title="<?php \_e("Copy Shortcode", "cluevo"); ?>">[s]</div> |
| [791](#L791) | <div class="meta-toggle cluevo-btn cluevo-btn-square" title="<?php \_e("Element Settings", "cluevo"); ?>"><span class="dashicons dashicons-admin-generic"></span></div> |
| [792](#L792) | <div class="remove cluevo-btn cluevo-btn-square" title="<?php \_e("Delete Element", "cluevo"); ?>"><span class="dashicons dashicons-trash"></span></div> |
| [793](#L793) | <div class="expand cluevo-btn cluevo-btn-square <?php if ($item->level > 2) echo "disabled"; ?>"><span class="dashicons dashicons-arrow-down"></span></div> |
| [794](#L794) | </div> |
| [795](#L795) | </div> |
| [796](#L796) |  |
| [797](#L797) | <div class="meta"> |
| [798](#L798) |  |
| [799](#L799) | <div class="meta-content-container"> |
| [800](#L800) | <h2><?php echo \_\_("Settings", "cluevo"); ?></h2> |
| [801](#L801) |  |
| [802](#L802) | <?php do\_action('cluevo\_tree\_item\_settings', $item); ?> |
| [803](#L803) |  |
| [804](#L804) | <div class="meta-container points global"> |
| [805](#L805) | <details> |
| [806](#L806) | <summary class="label"><?php \_e("Points", "cluevo"); ?> |
| [807](#L807) |  |
| [808](#L808) | <p class="help"> |
| [809](#L809) | <?php \_e("Defines the worth in points of an item or respectively how many points a user has to have to gain access.", "cluevo"); ?> |
| [810](#L810) | </p> |
| [811](#L811) | </summary> |
| [812](#L812) |  |
| [813](#L813) | <div class="point-wrap input-list-container inline"> |
| [814](#L814) | <div class="points-container points-worth input-container"> |
| [815](#L815) | <label><?php \_e("Worth", "cluevo"); ?></label> |
| [816](#L816) | <input type="number" min="0" value="<?php echo esc\_attr($pointsWorth); ?>" data-target="points-worth" /> |
| [817](#L817) | </div> |
| [818](#L818) |  |
| [819](#L819) | <div class="points-container practice-points input-container"> |
| [820](#L820) | <label><?php \_e("Practice points", "cluevo"); ?></label> |
| [821](#L821) | <input type="number" min="0" value="<?php echo esc\_attr($item->practice\_points); ?>" data-target="practice-points" /> |
| [822](#L822) | </div> |
| [823](#L823) |  |
| [824](#L824) | <div class="points-container points-required input-container"> |
| [825](#L825) | <label><?php \_e("Required", "cluevo"); ?></label> |
| [826](#L826) | <input type="number" min="0" value="<?php echo esc\_attr($pointsNeeded); ?>" data-target="points-required" /> |
| [827](#L827) | </div> |
| [828](#L828) | </div> |
| [829](#L829) | </details> |
| [830](#L830) | </div> |
| [831](#L831) |  |
| [832](#L832) | <div class="meta-container level global"> |
| [833](#L833) | <details> |
| [834](#L834) | <summary class="label"><?php \_e("Required level", "cluevo"); ?> |
| [835](#L835) | <p class="help"> |
| [836](#L836) | <?php \_e("Defines the level a user has to have reached to access an item.", "cluevo"); ?> |
| [837](#L837) | </p> |
| [838](#L838) | </summary> |
| [839](#L839) | <div class="input-list-container inline"> |
| [840](#L840) | <div class="input-container"> |
| [841](#L841) | <label><?php echo \_\_("Level", "cluevo"); ?></label> |
| [842](#L842) | <input type="number" min="0" value="<?php echo esc\_attr((int)$levelRequired); ?>" data-target="level-required" /> |
| [843](#L843) | </div> |
| [844](#L844) | </div> |
| [845](#L845) | </details> |
| [846](#L846) | </div> |
| [847](#L847) |  |
| [848](#L848) | <div class="meta-container dependency-container"> |
| [849](#L849) | <div class="label"><?php \_e("Requirements", "cluevo"); ?></div> |
| [850](#L850) | <p class="help"> |
| [851](#L851) | <?php \_e("Defines the requirements users have to fulfill to access this element.", "cluevo"); ?> |
| [852](#L852) | </p> |
| [853](#L853) | <div class="dep-checkbox-container" data-target="dependencies"> |
| [854](#L854) | </div> |
| [855](#L855) | </div> |
| [856](#L856) |  |
| [857](#L857) | <?php if ($level == count(CLUEVO\_LEARNING\_STRUCTURE\_LEVELS) - 1) { ?> |
| [858](#L858) | <!-- <div class="meta-container repeating global"> |
| [859](#L859) | <div class="label"><?php \_e("Module must be repeated periodically", "cluevo"); ?></div> |
| [860](#L860) | <p class="help"> |
| [861](#L861) | <?php \_e("Defines the interval in which a module has to be repeated.", "cluevo"); ?> |
| [862](#L862) | </p> |
| [863](#L863) | <div class="meta-input-fields-container"> |
| [864](#L864) | <input type="number" min="0" value="<?php echo esc\_attr($repeatInterval); ?>" data-target="repeat-interval"/> |
| [865](#L865) | <select class="repeat-interval-type" data-target="repeat-interval-type"> |
| [866](#L866) | <?php foreach (CLUEVO\_REPEAT\_INTERVAL\_TYPES as $key => $value) { ?> |
| [867](#L867) | <option value="<?php echo esc\_attr($key); ?>"<?php if ($repeatIntervalType === $key) echo ' selected="selected"'; ?>><?php echo esc\_attr($value); ?></option> |
| [868](#L868) | <?php } ?> |
| [869](#L869) | </select> |
| [870](#L870) | </div> |
| [871](#L871) | </div> --> |
| [872](#L872) | <?php } ?> |
| [873](#L873) |  |
| [874](#L874) | </div> |
| [875](#L875) | </div> |
| [876](#L876) |  |
| [877](#L877) | <?php |
| [878](#L878) | // render children of the current item |
| [879](#L879) | $nextLevel = $level + 1; |
| [880](#L880) | echo "<ol id=\"level-$nextLevel\" data-level=\"$nextLevel\">\n"; |
| [881](#L881) | if (!empty($item->children)) { |
| [882](#L882) | foreach ($item->children as $key => $child) { |
| [883](#L883) | cluevo\_render\_courses($child, $modules); |
| [884](#L884) | } |
| [885](#L885) | } |
| [886](#L886) | echo "</ol>\n"; |
| [887](#L887) | echo "\t</li>\n"; |
| [888](#L888) | } |
| [889](#L889) |  |
| [890](#L890) | /\*\* |
| [891](#L891) | \* Outputs the module ui and handles deletion of modules |
| [892](#L892) | \* |
| [893](#L893) | \*/ |
| [894](#L894) | function cluevo\_render\_module\_ui($errors = [], $messages = []) |
| [895](#L895) | { |
| [896](#L896) | $pending = cluevo\_find\_pending\_modules(); |
| [897](#L897) | $tab = (!empty($\_GET["tab"]) && ctype\_alpha($\_GET["tab"])) ? cluevo\_strip\_non\_alpha($\_GET["tab"]) : CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE; |
| [898](#L898) |  |
| [899](#L899) | $plugin\_dir = plugin\_dir\_path(\_\_DIR\_\_); |
| [900](#L900) | $scorm\_dir = $plugin\_dir . "scorm-modules"; |
| [901](#L901) | $archive\_dir = $plugin\_dir . "scorm-modules-archive/"; |
| [902](#L902) |  |
| [903](#L903) | if (file\_exists($scorm\_dir) || file\_exists($archive\_dir)) { |
| [904](#L904) | $messages[] = \_\_("There are modules inside the old module Directory. Click here to start the migration: ", "cluevo") . " <a href=\"" . add\_query\_arg("migrate", "true") . "\">[" . \_\_("migrate modules", "cluevo") . "]</a>"; |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | // handle module deletion |
| [908](#L908) | $deleted = false; |
| [909](#L909) | $del\_module = (!empty($\_GET["delete-module"]) && is\_numeric($\_GET["delete-module"])) ? (int)$\_GET["delete-module"] : null; |
| [910](#L910) | if (!empty($del\_module)) { |
| [911](#L911) | // check if modules exists in database, delete module and archive zip and remove from database |
| [912](#L912) | $modules = cluevo\_get\_modules(); |
| [913](#L913) | $moduleId = $del\_module; |
| [914](#L914) | $module = cluevo\_get\_module($moduleId); |
| [915](#L915) | if (!empty($module)) { |
| [916](#L916) | $delModule = $module->module\_dir; |
| [917](#L917) | $delPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') . $delModule; |
| [918](#L918) | $delZip = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_ARCHIVE\_PATH') . $module->module\_zip; |
| [919](#L919) | if (!empty($module->module\_dir) && file\_exists($delPath) && !empty($delPath)) { |
| [920](#L920) | if (!empty($delModule)) { |
| [921](#L921) | cluevo\_delete\_directory($delPath); |
| [922](#L922) | } |
| [923](#L923) | if (!empty($module->module\_zip) && file\_exists($delZip) && !empty($delZip)) |
| [924](#L924) | unlink($delZip); |
| [925](#L925) | cluevo\_remove\_module($moduleId); |
| [926](#L926) | $deleted = true; |
| [927](#L927) | } else { |
| [928](#L928) | cluevo\_remove\_module($moduleId); |
| [929](#L929) | $deleted = true; |
| [930](#L930) | } |
| [931](#L931) | } |
| [932](#L932) | do\_action("cluevo\_module\_deleted", $moduleId); |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | // create metadata page |
| [936](#L936) | $pageCreated = false; |
| [937](#L937) | $create\_page = (!empty($\_GET["create-metadata-page"]) && is\_numeric($\_GET["create-metadata-page"])) ? (int)$\_GET["create-metadata-page"] : null; |
| [938](#L938) | if (!empty($create\_page)) { |
| [939](#L939) | $moduleId = $create\_page; |
| [940](#L940) | if (!cluevo\_get\_module\_metadata\_page($moduleId)) { // create metadata page for the uploaded module if the page doesn't yet exist |
| [941](#L941) | $module = cluevo\_get\_module($moduleId); |
| [942](#L942) | if (!empty($module)) { |
| [943](#L943) | $id = wp\_insert\_post( |
| [944](#L944) | [ |
| [945](#L945) | "post\_title" => sanitize\_title($module->module\_name), |
| [946](#L946) | "post\_status" => "publish", |
| [947](#L947) | "post\_type" => CLUEVO\_METADATA\_POST\_TYPE\_SCORM\_MODULE |
| [948](#L948) | ] |
| [949](#L949) | ); |
| [950](#L950) | $terms = get\_terms(['taxonomy' => CLUEVO\_TAXONOMY, 'hide\_empty' => false]); |
| [951](#L951) | if (is\_array($terms)) { |
| [952](#L952) | foreach ($terms as $term) { |
| [953](#L953) | if ($term->name == \_\_("SCORM Module", "cluevo")) { |
| [954](#L954) | wp\_set\_post\_terms($id, [$term->term\_id], \_\_('SCORM Module', "cluevo")); |
| [955](#L955) | break; |
| [956](#L956) | } |
| [957](#L957) | } |
| [958](#L958) | } |
| [959](#L959) | cluevo\_update\_module\_metadata\_id($moduleId, $id); |
| [960](#L960) | $pageCreated = true; |
| [961](#L961) | } |
| [962](#L962) | } |
| [963](#L963) | } |
| [964](#L964) |  |
| [965](#L965) | $url = remove\_query\_arg(['create-metadata-page', 'delete-module']); |
| [966](#L966) | $modules = cluevo\_get\_modules(); |
| [967](#L967) | $page = CLUEVO\_ADMIN\_PAGE\_LMS; |
| [968](#L968) |  |
| [969](#L969) | $moduleTypes = []; |
| [970](#L970) | do\_action('cluevo\_register\_module\_types', ["types" => &$moduleTypes]); |
| [971](#L971) | $execTime = ini\_get('max\_execution\_time'); |
| [972](#L972) |  |
| [973](#L973) | cluevo\_display\_notice( |
| [974](#L974) | \_\_("Info", "cluevo"), |
| [975](#L975) | sprintf(\_\_("Depending on the size of your modules installation can take quite a bit of time. On most hosts the time available for scripts is limited, on your server it seems to be limited to %s seconds. The bigger your modules are the longer the installation process takes and the bigger your max. execution time needs to be. We will attempt to increase this value during module instalaltion but not all hosts support this. If larger modules fail to install you should ask your hosting provider to increase your max. execution time.", "cluevo"), $execTime), |
| [976](#L976) | "warning", |
| [977](#L977) | "cluevo-max-exec-time-info" |
| [978](#L978) | ); |
| [979](#L979) | if (!class\_exists('ZipArchive')) { |
| [980](#L980) | cluevo\_display\_notice( |
| [981](#L981) | \_\_("Missing PHP Extension", "cluevo"), |
| [982](#L982) | \_\_("CLUEVO LMS requires the ZipArchive class from the PHP zip extension. You won't be able to upload zipped modules until zip support is enabled. ZipArchive is required because CLUEVO LMS does some checks before extracting modules to protect you from malicious zip files. Please contact your hosting provider to enable this extension.", "cluevo"), |
| [983](#L983) | "warning" |
| [984](#L984) | ); |
| [985](#L985) | } |
| [986](#L986) | if (!extension\_loaded('fileinfo')) { |
| [987](#L987) | cluevo\_display\_notice( |
| [988](#L988) | \_\_("Missing PHP Extension", "cluevo"), |
| [989](#L989) | \_\_("CLUEVO LMS requires the fileinfo\_\* functions from the PHP FileInfo module. You won't be able to install some module types without this extension. Please contact your hosting provider to enable this module.", "cluevo"), |
| [990](#L990) | "warning" |
| [991](#L991) | ); |
| [992](#L992) | } |
| [993](#L993) | ?> |
| [994](#L994) | <?php if (!empty($moduleTypes) && is\_array($moduleTypes)) { ?> |
| [995](#L995) | <div class="cluevo-add-module-overlay" id="cluevo-add-module-overlay" data-max-upload-size="<?php echo esc\_attr(wp\_max\_upload\_size()); ?>"> |
| [996](#L996) | <div class="modal-mask"> |
| [997](#L997) | <div class="modal-wrapper"> |
| [998](#L998) | <div class="modal-container"> |
| [999](#L999) | <div class="modal-header"> |
| [1000](#L1000) | <h3><?php esc\_html\_e('Add Module', 'cluevo'); ?></h3> |
| [1001](#L1001) | <button class="close"><span class="dashicons dashicons-no-alt"></span></button> |
| [1002](#L1002) | </div> |
| [1003](#L1003) | <div class="modal-body"> |
| [1004](#L1004) | <div class="cluevo-add-module-content-container module-type cluevo-update-module-content-container"> |
| [1005](#L1005) | <div class="cluevo-notice cluevo-notice-warning"> |
| [1006](#L1006) | <p><?php esc\_html\_e("Please make sure the module update you are uploading is of the same type as the existing module. Changing SCORM versions is fine but going from e.g. SCORM to PDF will not work and will probably have unforseen consequences.", "cluevo"); ?> |
| [1007](#L1007) | </div> |
| [1008](#L1008) | <form method="post" enctype="multipart/form-data" class="cluevo-module-form" action="<?php echo esc\_url(admin\_url("admin.php?page=$page&tab=$tab"), ['http', 'https']); ?>"> |
| [1009](#L1009) | <div class="input-switch"> |
| [1010](#L1010) | <input type="text" name="module-dl-url" placeholder="https://" /> |
| [1011](#L1011) | <label class="cluevo cluevo-module-install-type-file"> |
| [1012](#L1012) | <div class="cluevo-btn"><?php esc\_html\_e("Browse...", "cluevo"); ?></div> |
| [1013](#L1013) | <input type="file" name="module-file" value="" /> |
| [1014](#L1014) | </label> |
| [1015](#L1015) | </div> |
| [1016](#L1016) | <input type="submit" class="cluevo-btn auto cluevo-btn-primary disabled" value="<?php echo \_\_("Install Module", "cluevo"); ?>" disabled /> |
| [1017](#L1017) | </form> |
| [1018](#L1018) | <p><?php \_e("Max. Filesize: ", "cluevo") . esc\_html\_e(cluevo\_human\_filesize(wp\_max\_upload\_size())); ?></p> |
| [1019](#L1019) | <div class="cluevo-notice cluevo-notice-error cluevo-filesize hidden"> |
| [1020](#L1020) | <p><?php esc\_html\_e(sprintf(\_\_("The file you are trying to upload is too big. The maximum upload size is %s", "cluevo"), cluevo\_human\_filesize(wp\_max\_upload\_size()))); ?> |
| [1021](#L1021) | </div> |
| [1022](#L1022) | </div> |
| [1023](#L1023) | <div class="upload-progress"> |
| [1024](#L1024) | <h2 class="progress-text"><?php esc\_html\_e("The module is being uploaded, one moment please...", "cluevo"); ?></h2> |
| [1025](#L1025) | <div class="cluevo-progress-container"> |
| [1026](#L1026) | <span class="cluevo-progress" data-value="" data-max="100"></span> |
| [1027](#L1027) | </div> |
| [1028](#L1028) | <div class="result-container"></div> |
| [1029](#L1029) | <div class="cluevo-btn continue"><?php esc\_html\_e("Continue", "cluevo"); ?></div> |
| [1030](#L1030) | <div class="cluevo-btn force"><?php esc\_html\_e("Try to install anyway", "cluevo"); ?></div> |
| [1031](#L1031) | </div> |
| [1032](#L1032) | <div class="cluevo-add-module-content-container"> |
| [1033](#L1033) | <div class="module-type-selection"> |
| [1034](#L1034) | <div class="add-module-text"><?php esc\_html\_e('You can add new modules to your LMS here.', 'cluevo'); ?></div> |
| [1035](#L1035) | <h2><?php esc\_html\_e('The following module types are currently available', 'cluevo'); ?></h2> |
| [1036](#L1036) | <div class="module-list"> |
| [1037](#L1037) | <?php foreach ($moduleTypes as $key => $type) { ?> |
| [1038](#L1038) | <div class="module-type <?php if (!empty($type["alt-icon-class"])) { |
| [1039](#L1039) | echo esc\_attr($type["alt-icon-class"]); |
| [1040](#L1040) | } ?>" data-module-index="<?php echo esc\_attr($key); ?>"> |
| [1041](#L1041) | <?php if (!empty($type['icon'])) { ?><div class="module-icon"><img src="<?php echo esc\_attr($type['icon']); ?>" /></div><?php } ?> |
| [1042](#L1042) | <?php if (!empty($type["name"])) { ?> |
| [1043](#L1043) | <div class="module-type-name"><?php echo esc\_html($type['name']); ?></div> |
| [1044](#L1044) | <?php } ?> |
| [1045](#L1045) | </div> |
| [1046](#L1046) | <?php } ?> |
| [1047](#L1047) | </div> |
| [1048](#L1048) | </div> |
| [1049](#L1049) | <div class="module-description-container"> |
| [1050](#L1050) | <div class="module-type hint"> |
| [1051](#L1051) | <p><?php esc\_html\_e('Select a module type to display further information.', 'cluevo'); ?></p> |
| [1052](#L1052) | </div> |
| [1053](#L1053) | <?php foreach ($moduleTypes as $key => $type) { ?> |
| [1054](#L1054) | <div class="module-type <?php if (!empty($type["alt-icon-class"])) { |
| [1055](#L1055) | echo esc\_attr($type["alt-icon-class"]); |
| [1056](#L1056) | } ?>" data-module-index="<?php echo esc\_attr($key); ?>" data-module-type="<?php echo esc\_attr($type['key']); ?>"> |
| [1057](#L1057) | <div class="description-container"> |
| [1058](#L1058) | <?php if (!empty($type['icon'])) { ?><div class="module-icon"><img src="<?php echo esc\_attr($type['icon']); ?>" /></div><?php } ?> |
| [1059](#L1059) | <div> |
| [1060](#L1060) | <h3><?php echo esc\_html($type['name']); ?></h3> |
| [1061](#L1061) | <p><?php echo esc\_html($type['description']); ?></p> |
| [1062](#L1062) | </div> |
| [1063](#L1063) | </div> |
| [1064](#L1064) | <?php if (!empty($type["field"])) { ?> |
| [1065](#L1065) | <form method="post" enctype="multipart/form-data" class="cluevo-module-form <?php if (!empty($type['form-class'])) echo esc\_attr($type["form-class"]); ?>" action="<?php echo esc\_url(admin\_url("admin.php?page=$page&tab=$tab"), ['http', 'https']); ?>" data-type="<?php echo esc\_attr($type["name"]); ?>"> |
| [1066](#L1066) | <?php if (!empty($type["field"]) && $type["field"] == "text") { ?> |
| [1067](#L1067) | <input type="text" name="module-dl-url" placeholder="<?php echo esc\_attr($type['field-placeholder']); ?>" /> |
| [1068](#L1068) | <?php } ?> |
| [1069](#L1069) | <?php if (!empty($type["field"]) && $type["field"] == "file") { ?> |
| [1070](#L1070) | <input type="file" name="module-file" placeholder="<?php echo esc\_attr($type['field-placeholder']); ?>" /> |
| [1071](#L1071) | <?php } ?> |
| [1072](#L1072) | <?php if (!empty($type["field"]) && $type["field"] == "mixed") { ?> |
| [1073](#L1073) | <div class="input-switch"> |
| [1074](#L1074) | <input type="text" name="module-dl-url" placeholder="https://" /> |
| [1075](#L1075) | <label class="cluevo cluevo-module-install-type-file"> |
| [1076](#L1076) | <div class="button"><?php echo esc\_html($type["button-label"]); ?></div> |
| [1077](#L1077) | <input type="file" name="module-file" value="" <?php if (!empty($type['filter'])) echo 'accept="' . $type['filter'] . '"'; ?> /> |
| [1078](#L1078) | </label> |
| [1079](#L1079) | </div> |
| [1080](#L1080) | <?php } ?> |
| [1081](#L1081) | <?php if (!empty($type["field"]) && $type["field"] == "textarea") { ?> |
| [1082](#L1082) | <textarea name="module-dl-url" placeholder="<?php echo esc\_attr($type['field-placeholder']); ?>"></textarea> |
| [1083](#L1083) | <?php } ?> |
| [1084](#L1084) | <input type="submit" class="button auto button-primary disabled" value="<?php echo \_\_("Install Module", "cluevo"); ?>" disabled /> |
| [1085](#L1085) | </form> |
| [1086](#L1086) | <?php if (!empty($type["field"]) && ($type["field"] == "file" || $type["field"] == 'mixed')) { ?> |
| [1087](#L1087) | <p><?php \_e("Max. Filesize: ", "cluevo") . esc\_html\_e(cluevo\_human\_filesize(wp\_max\_upload\_size())); ?></p> |
| [1088](#L1088) | <?php cluevo\_display\_notice(\_\_('Attention', "cluevo"), \_\_("CLUEVO LMS has no influence on the max. filesize. This limit has to be adjusted server side either by you or your hosting provider", "cluevo"), 'warning', 'module-upload-size-warning'); ?> |
| [1089](#L1089) | <div class="cluevo-notice cluevo-notice-error cluevo-filesize hidden"> |
| [1090](#L1090) | <p><?php esc\_html\_e(sprintf(\_\_("The file you are trying to upload is too big. The maximum upload size is %s", "cluevo"), cluevo\_human\_filesize(wp\_max\_upload\_size()))); ?> |
| [1091](#L1091) | </div> |
| [1092](#L1092) | <?php } ?> |
| [1093](#L1093) | <?php } elseif (!empty($type["alt-content"])) { ?> |
| [1094](#L1094) | <div class="cluevo-add-module-alt-content"> |
| [1095](#L1095) | <?php echo wp\_kses( |
| [1096](#L1096) | $type["alt-content"], |
| [1097](#L1097) | [ |
| [1098](#L1098) | 'a' => [ |
| [1099](#L1099) | "href" => true, |
| [1100](#L1100) | "title" => true, |
| [1101](#L1101) | "class" => true |
| [1102](#L1102) | ], |
| [1103](#L1103) | 'p' => [ |
| [1104](#L1104) | "class" => true |
| [1105](#L1105) | ], |
| [1106](#L1106) | 'span' => [ |
| [1107](#L1107) | "class" => true |
| [1108](#L1108) | ], |
| [1109](#L1109) | 'div' => [ |
| [1110](#L1110) | "class" => true |
| [1111](#L1111) | ], |
| [1112](#L1112) | 'details' => [ |
| [1113](#L1113) | "class" => true |
| [1114](#L1114) | ], |
| [1115](#L1115) | 'summary' => [ |
| [1116](#L1116) | "class" => true |
| [1117](#L1117) | ], |
| [1118](#L1118) | 'ul' => [ |
| [1119](#L1119) | "class" => true |
| [1120](#L1120) | ], |
| [1121](#L1121) | 'ol' => [ |
| [1122](#L1122) | "class" => true |
| [1123](#L1123) | ], |
| [1124](#L1124) | 'li' => [ |
| [1125](#L1125) | "class" => true |
| [1126](#L1126) | ], |
| [1127](#L1127) | 'img' => [ |
| [1128](#L1128) | 'src' => true, |
| [1129](#L1129) | 'alt' => true, |
| [1130](#L1130) | 'class' => true, |
| [1131](#L1131) | 'width' => true, |
| [1132](#L1132) | 'height' => true |
| [1133](#L1133) | ], |
| [1134](#L1134) | 'button' => [ |
| [1135](#L1135) | "type" => true |
| [1136](#L1136) | ] |
| [1137](#L1137) | ] |
| [1138](#L1138) | ); ?> |
| [1139](#L1139) | </div> |
| [1140](#L1140) | <?php } ?> |
| [1141](#L1141) | </div> |
| [1142](#L1142) | <?php } ?> |
| [1143](#L1143) | <div class="button select-type"><?php esc\_html\_e('Select another module type', 'cluevo'); ?></div> |
| [1144](#L1144) | </div> |
| [1145](#L1145) | </div> |
| [1146](#L1146) | </div> |
| [1147](#L1147) | </div> |
| [1148](#L1148) | </div> |
| [1149](#L1149) | </div> |
| [1150](#L1150) | </div> |
| [1151](#L1151) | <?php } ?> |
| [1152](#L1152) | <?php if ($deleted) cluevo\_display\_notice("Hinweis", \_\_("Module deleted.", "cluevo")); ?> |
| [1153](#L1153) | <form method="post" enctype="multipart/form-data" id="add-module-form" class="cluevo-module-form" action="<?php echo esc\_url(admin\_url("admin.php?page=$page&tab=$tab"), ['http', 'https']); ?>"> |
| [1154](#L1154) | <div class="button button-primary add-module"><?php \_e('Add Module', 'cluevo'); ?></div> |
| [1155](#L1155) | <input type="hidden" name="page" value="<?php echo esc\_attr($page); ?>" /> |
| [1156](#L1156) | <input type="hidden" name="tab" value="<?php echo esc\_attr($tab); ?>" /> |
| [1157](#L1157) | </form> |
| [1158](#L1158) | <?php if (!empty($modules)) { ?> |
| [1159](#L1159) | <h2><?php esc\_html\_e("Modules", "cluevo"); ?></h2> |
| [1160](#L1160) | <?php if ($pageCreated) echo "<p>" . esc\_html\_e("Module metadata post created.", "cluevo") . "</p>"; ?> |
| [1161](#L1161) | <div id="module-lang-overlay" class="module-lang-overlay" data-module-id=""> |
| [1162](#L1162) | <div class="module-lang-select-container"> |
| [1163](#L1163) | <div class="module-lang-select" id="module-lang-select"> |
| [1164](#L1164) | <h3><?php echo \_\_("Select Language", "cluevo"); ?></h3> |
| [1165](#L1165) | <ul> |
| [1166](#L1166) | <?php |
| [1167](#L1167) | $langs = cluevo\_get\_languages(); |
| [1168](#L1168) | foreach ($langs as $lang) { |
| [1169](#L1169) | echo "<li><label><input type=\"radio\" name=\"module-lang\" value=\"$lang->lang\_code\" class=\"module-lang-radio\"> $lang->lang\_name</label></li>"; |
| [1170](#L1170) | } |
| [1171](#L1171) | ?> |
| [1172](#L1172) | </ul> |
| [1173](#L1173) | </div> |
| [1174](#L1174) | </div> |
| [1175](#L1175) | </div> |
| [1176](#L1176) | <?php |
| [1177](#L1177) | if (!empty($errors)) { |
| [1178](#L1178) | foreach ($errors as $err) { |
| [1179](#L1179) | cluevo\_display\_notice(\_\_("Error", "cluevo"), $err, 'error'); |
| [1180](#L1180) | } |
| [1181](#L1181) | } |
| [1182](#L1182) | if (!empty($messages)) { |
| [1183](#L1183) | foreach ($messages as $msg) { |
| [1184](#L1184) | cluevo\_display\_notice(\_\_("Notice", "cluevo"), $msg); |
| [1185](#L1185) | } |
| [1186](#L1186) | } |
| [1187](#L1187) | ?> |
| [1188](#L1188) | <table class="cluevo-scorm-modules wp-list-table widefat striped"> |
| [1189](#L1189) | <thead> |
| [1190](#L1190) | <tr> |
| [1191](#L1191) | <th class="check-column module-id"></th> |
| [1192](#L1192) | <th class="module-name left"><?php esc\_html\_e("Module", "cluevo"); ?></th> |
| [1193](#L1193) | <th class="module-type left"><?php esc\_html\_e("Type", "cluevo"); ?></th> |
| [1194](#L1194) | <th class="module-rating left"><?php esc\_html\_e("User Ratings", "cluevo"); ?></th> |
| [1195](#L1195) | </tr> |
| [1196](#L1196) | </thead> |
| [1197](#L1197) | <?php |
| [1198](#L1198) | $tmpId = null; |
| [1199](#L1199) | $border = false; |
| [1200](#L1200) | ?> |
| [1201](#L1201) | <tbody> |
| [1202](#L1202) | <?php foreach ($modules as $key => $m) { ?> |
| [1203](#L1203) | <?php |
| [1204](#L1204) | if ($tmpId !== $m->module\_id && $tmpId !== null) { |
| [1205](#L1205) | $border = true; |
| [1206](#L1206) | } |
| [1207](#L1207) | $tmpId = $m->module\_id; |
| [1208](#L1208) | $border = false; |
| [1209](#L1209) | ?> |
| [1210](#L1210) | <?php $link = get\_edit\_post\_link($m->metadata\_id, "module"); ?> |
| [1211](#L1211) | <tr <?php if ($border) echo 'class="bordered" '; ?> data-module-id="<?php echo esc\_attr($m->module\_id); ?>"> |
| [1212](#L1212) | <td class="cluevo-nowrap"><?php echo esc\_html($m->module\_id); ?></td> |
| [1213](#L1213) | <td class="title left column-title has-row-actions column-primary" data-id="<?php echo esc\_attr($m->module\_id); ?>"> |
| [1214](#L1214) | <div class="cluevo-module-name"> |
| [1215](#L1215) | <?php echo esc\_html($m->module\_name); ?> |
| [1216](#L1216) | </div> |
| [1217](#L1217) | <div class="cluevo-module-tags"> |
| [1218](#L1218) | <?php if (!empty($m->tags)) { |
| [1219](#L1219) | echo esc\_html(implode(', ', $m->tags)); |
| [1220](#L1220) | } ?> |
| [1221](#L1221) | </div> |
| [1222](#L1222) | <div class="row-actions"> |
| [1223](#L1223) | <span class="edit-name"><a class="edit-module-name" title="<?php esc\_attr\_e("Change Name", "cluevo"); ?>" href="#" data-id="<?php echo esc\_attr($m->module\_id); ?>"><?php esc\_html\_e("Rename Module", "cluevo"); ?></a></span> | |
| [1224](#L1224) | <span class="tags"><a class="cluevo-edit-module-tags" href="#" data-id="<?php echo esc\_attr($m->module\_id); ?>"><?php esc\_html\_e("Edit Tags", "cluevo"); ?></a></span> | |
| [1225](#L1225) | <?php if (!empty($link)) { ?> |
| [1226](#L1226) | <span class="edit-module-page"><a class="" href="<?php echo esc\_url($link); ?>" target="\_blank"><?php esc\_html\_e("Edit Module Page", "cluevo"); ?></a></span> | |
| [1227](#L1227) | <?php } else { ?> |
| [1228](#L1228) | <span class="create-module-page"><a class="" href="<?php echo add\_query\_arg('create-metadata-page', $m->module\_id, $url); ?>"><?php esc\_html\_e("Create Module Page", "cluevo"); ?></a></span> | |
| [1229](#L1229) | <?php } ?> |
| [1230](#L1230) | <span class="delete"><a class="del-module" href="<?php echo add\_query\_arg('delete-module', $m->module\_id, $url); ?>"><?php esc\_html\_e("Delete Module", "cluevo"); ?></a></span> | |
| [1231](#L1231) | <span class="update"><a class="update-module" href="#"><?php esc\_html\_e("Update Module", "cluevo"); ?></a></span> | |
| [1232](#L1232) | <?php if (strpos($m->type\_name, 'scorm') !== false) { ?> |
| [1233](#L1233) | <span class="scorm-parameters"><a class="" href="<?php echo admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_REPORTS . "&tab=" . CLUEVO\_ADMIN\_TAB\_REPORTS\_SCORM\_PARMS . "&module=" . $m->module\_id); ?>"><?php esc\_html\_e("Browse SCORM Parameters", "cluevo"); ?></a></span> | |
| [1234](#L1234) | <?php } ?> |
| [1235](#L1235) | <span class="reports"><a class="" href="<?php echo admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_REPORTS . "&tab=" . CLUEVO\_ADMIN\_TAB\_REPORTS\_PROGRESS . "&module=" . $m->module\_id); ?>"><?php esc\_html\_e("Browse Reports", "cluevo"); ?></a></span> | |
| [1236](#L1236) | <span class="dl"><a class="" title="" href="<?php if (!empty($m->module\_zip)) { |
| [1237](#L1237) | echo admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_LMS . "&tab=" . CLUEVO\_ADMIN\_TAB\_LMS\_MODULES . "&dl=" . $m->module\_id); |
| [1238](#L1238) | } else { |
| [1239](#L1239) | echo admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_LMS . "&tab=" . CLUEVO\_ADMIN\_TAB\_LMS\_MODULES . "&zip=" . $m->module\_id); |
| [1240](#L1240) | } ?>"><?php (!empty($m->module\_zip)) ? esc\_attr\_e("Download Module", "cluevo") : esc\_attr\_e("Archive Module", "cluevo"); ?></a></span> |
| [1241](#L1241) | <?php if (!empty($m->module\_zip)) { ?> |
| [1242](#L1242) | | <span class="delete"><a class="" href="<?php echo add\_query\_arg('del-zip', $m->module\_id); ?>"> |
| [1243](#L1243) | <?php esc\_attr\_e("Delete ZIP", "cluevo"); ?> |
| [1244](#L1244) | </a></span> |
| [1245](#L1245) | <?php } ?> |
| [1246](#L1246) | </div> |
| [1247](#L1247) | </td> |
| [1248](#L1248) | <td class="type left "><?php echo (!empty($m->type\_name)) ? esc\_html(apply\_filters('cluevo\_output\_module\_type', $m)) : esc\_html\_\_('Unknown', "cluevo"); ?></td> |
| [1249](#L1249) | <td class="rating"><?php echo (!empty($m->rating\_avg)) ? apply\_filters('cluevo\_output\_module\_rating', $m) : cluevo\_output\_empty\_admin\_module\_rating(); ?></td> |
| [1250](#L1250) | </tr> |
| [1251](#L1251) | <?php $border = false; ?> |
| [1252](#L1252) | <?php } ?> |
| [1253](#L1253) | </tbody> |
| [1254](#L1254) | </table> |
| [1255](#L1255) | <?php if (!empty($pending)) { |
| [1256](#L1256) | $table = '<p>' . esc\_html\_\_('Pending modules found. You can add these modules by clicking the install button of any module you wish to add.', 'cluevo') . '</p>'; |
| [1257](#L1257) | $table .= '<table class="wp-list-table striped widefat">'; |
| [1258](#L1258) | $table .= '<thead>'; |
| [1259](#L1259) | $table .= '<tr><th class="left">' . esc\_html('Module', 'cluevo') . '</th><th></th></tr>'; |
| [1260](#L1260) | $table .= '</thead>'; |
| [1261](#L1261) | $table .= '<tbody>'; |
| [1262](#L1262) | foreach ($pending as $m) { |
| [1263](#L1263) | $table .= "<tr><td class=\"left\">" . esc\_html($m["module"]) . "</td>"; |
| [1264](#L1264) | $table .= '<td><div class="cluevo-buttons">'; |
| [1265](#L1265) | $table .= '<span class="dashicons dashicons-trash cluevo-pending-module-delete" data-module="' . esc\_attr($m["module"]) . '"></span>'; |
| [1266](#L1266) | if ($m["installable"]) { |
| [1267](#L1267) | $table .= '<span class="dashicons dashicons-plus cluevo-pending-module" data-module="' . esc\_attr($m["module"]) . '"></span>'; |
| [1268](#L1268) | } else { |
| [1269](#L1269) | $table .= esc\_html\_\_('No install handler found', 'cluevo'); |
| [1270](#L1270) | } |
| [1271](#L1271) | $table .= '</tr>'; |
| [1272](#L1272) | $table .= '</div></td>'; |
| [1273](#L1273) | } |
| [1274](#L1274) | $table .= '</tbody>'; |
| [1275](#L1275) | $table .= '</table>'; |
| [1276](#L1276) | cluevo\_display\_notice\_html(\_\_('Information', 'cluevo'), $table, 'info'); |
| [1277](#L1277) | } |
| [1278](#L1278) | ?> |
| [1279](#L1279) | </div> |
| [1280](#L1280) | <?php |
| [1281](#L1281) | } else { |
| [1282](#L1282) | cluevo\_display\_notice\_html( |
| [1283](#L1283) | \_\_("Notice", "cluevo"), |
| [1284](#L1284) | \_\_("No modules have been added yet.", "cluevo"), |
| [1285](#L1285) | "info" |
| [1286](#L1286) | ); |
| [1287](#L1287) | } |
| [1288](#L1288) | } |
| [1289](#L1289) |  |
| [1290](#L1290) | function cluevo\_render\_lms\_structure\_tab($tab) |
| [1291](#L1291) | { |
| [1292](#L1292) | $tabClass = ($tab == CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE) ? 'nav-tab-active' : ''; |
| [1293](#L1293) | echo '<a href="' . admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_LMS . "&tab=" . CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE) . "\" class=\"nav-tab $tabClass\">" . esc\_html\_\_("Learning tree", "cluevo") . "</a>"; |
| [1294](#L1294) | } |
| [1295](#L1295) |  |
| [1296](#L1296) | function cluevo\_render\_lms\_module\_ui\_tab($tab) |
| [1297](#L1297) | { |
| [1298](#L1298) | $tabClass = ($tab == CLUEVO\_ADMIN\_TAB\_LMS\_MODULES) ? 'nav-tab-active' : ''; |
| [1299](#L1299) | echo "<a href=\"" . admin\_url("admin.php?page=" . CLUEVO\_ADMIN\_PAGE\_LMS . "&tab=" . CLUEVO\_ADMIN\_TAB\_LMS\_MODULES) . "\" class=\"nav-tab $tabClass\">" .  esc\_html\_\_("Modules", "cluevo") . "</a>"; |
| [1300](#L1300) | } |
| [1301](#L1301) |  |
| [1302](#L1302) | function cluevo\_render\_lms\_page() |
| [1303](#L1303) | { |
| [1304](#L1304) | $active\_tab = (!empty($\_GET["tab"]) && ctype\_alpha($\_GET["tab"])) ? cluevo\_strip\_non\_alpha($\_GET["tab"]) : CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE; |
| [1305](#L1305) | do\_action('cluevo\_init\_admin\_page'); |
| [1306](#L1306) | ?> |
| [1307](#L1307) | <div class="wrap cluevo-admin-page-container"> |
| [1308](#L1308) | <h1 class="cluevo-admin-page-title-container"> |
| [1309](#L1309) | <div><?php esc\_html\_e("Learning Management", "cluevo"); ?></div> |
| [1310](#L1310) | <img class="plugin-logo" src="<?php echo plugins\_url("/assets/logo.png", plugin\_dir\_path(\_\_FILE\_\_)); ?>" /> |
| [1311](#L1311) | </h1> |
| [1312](#L1312) | <div class="cluevo-admin-page-content-container"> |
| [1313](#L1313) | <h2 class="nav-tab-wrapper cluevo"><?php do\_action('cluevo\_render\_lms\_page\_tabs', $active\_tab); ?></h2> |
| [1314](#L1314) | <?php |
| [1315](#L1315) | switch ($active\_tab) { |
| [1316](#L1316) | case CLUEVO\_ADMIN\_TAB\_LMS\_STRUCTURE: |
| [1317](#L1317) | do\_action('cluevo\_enqueue\_lms\_structure\_js'); |
| [1318](#L1318) | do\_action('cluevo\_render\_learning\_structure\_ui'); |
| [1319](#L1319) | break; |
| [1320](#L1320) | case CLUEVO\_ADMIN\_TAB\_LMS\_MODULES: |
| [1321](#L1321) | $errors = []; |
| [1322](#L1322) | $messages = []; |
| [1323](#L1323) | if (!empty($errors)) { |
| [1324](#L1324) | foreach ($errors as $err) { |
| [1325](#L1325) | cluevo\_display\_notice(\_\_("Error", "cluevo"), $err, 'error', true); |
| [1326](#L1326) | } |
| [1327](#L1327) | } |
| [1328](#L1328) | if (!empty($messages)) { |
| [1329](#L1329) | foreach ($messages as $msg) { |
| [1330](#L1330) | cluevo\_display\_notice(\_\_("Notice", "cluevo"), $msg); |
| [1331](#L1331) | } |
| [1332](#L1332) | } |
| [1333](#L1333) | do\_action('cluevo\_enqueue\_lms\_modules\_ui\_js'); |
| [1334](#L1334) | do\_action('cluevo\_render\_lms\_modules\_ui'); |
| [1335](#L1335) | break; |
| [1336](#L1336) | default: |
| [1337](#L1337) | do\_action('cluevo\_enqueue\_lms\_structure\_js'); |
| [1338](#L1338) | do\_action('cluevo\_render\_learning\_structure\_ui'); |
| [1339](#L1339) | break; |
| [1340](#L1340) | } |
| [1341](#L1341) | ?> |
| [1342](#L1342) | </div> |
| [1343](#L1343) | </div> |
| [1344](#L1344) | <?php |
| [1345](#L1345) | } |
| [1346](#L1346) |  |
| [1347](#L1347) | function cluevo\_enqueue\_lms\_structure\_js() |
| [1348](#L1348) | { |
| [1349](#L1349) |  |
| [1350](#L1350) | // development version |
| [1351](#L1351) | //wp\_register\_script( |
| [1352](#L1352) | //"vue-js", |
| [1353](#L1353) | //"https://cdn.jsdelivr.net/npm/vue/dist/vue.js", |
| [1354](#L1354) | //"", |
| [1355](#L1355) | //"", |
| [1356](#L1356) | //true |
| [1357](#L1357) | //); |
| [1358](#L1358) |  |
| [1359](#L1359) | // production version |
| [1360](#L1360) | wp\_register\_script( |
| [1361](#L1361) | "vue-js", |
| [1362](#L1362) | plugins\_url("/js/vue.min.js", plugin\_dir\_path(\_\_FILE\_\_)), |
| [1363](#L1363) | "", |
| [1364](#L1364) | CLUEVO\_VERSION, |
| [1365](#L1365) | true |
| [1366](#L1366) | ); |
| [1367](#L1367) |  |
| [1368](#L1368) | wp\_enqueue\_script('vue-js'); |
| [1369](#L1369) |  |
| [1370](#L1370) | wp\_register\_script('nested-sortable-js', plugins\_url('/js/jquery.mjs.nestedSortable.js', plugin\_dir\_path(\_\_FILE\_\_)), array('jquery', 'jquery-ui-core', 'jquery-ui-sortable', 'jquery-ui-selectmenu'), CLUEVO\_VERSION, false);  // provides drag'n'drop tree |
| [1371](#L1371) | wp\_register\_script('lodash-js', plugins\_url('/js/lodash.min.js', plugin\_dir\_path(\_\_FILE\_\_)), null, false, false);  // utilities |
| [1372](#L1372) | wp\_register\_script( |
| [1373](#L1373) | 'scorm-plugin-js', |
| [1374](#L1374) | plugins\_url('/js/module-nav.js', plugin\_dir\_path(\_\_FILE\_\_)), |
| [1375](#L1375) | array('nested-sortable-js', 'lodash-js', 'vue-js'), |
| [1376](#L1376) | CLUEVO\_VERSION, |
| [1377](#L1377) | false |
| [1378](#L1378) | );  // tree management |
| [1379](#L1379) | wp\_add\_inline\_script('lodash-js', 'window.lodash = \_.noConflict();', 'after'); // gutenberg compatibility |
| [1380](#L1380) | wp\_localize\_script('scorm-plugin-js', 'cluevoWpApiSettings', array('root' => esc\_url\_raw(rest\_url()), 'nonce' => wp\_create\_nonce('wp\_rest')));  // needed for ajax requests |
| [1381](#L1381) | wp\_enqueue\_script('nested-sortable-js'); |
| [1382](#L1382) | wp\_enqueue\_script('scorm-plugin-js'); |
| [1383](#L1383) |  |
| [1384](#L1384) | wp\_localize\_script( |
| [1385](#L1385) | 'scorm-plugin-js', |
| [1386](#L1386) | 'strings', |
| [1387](#L1387) | array( |
| [1388](#L1388) | 'new\_course' => \_\_('New Course', "cluevo"), |
| [1389](#L1389) | 'new\_chapter' => \_\_('New Chapter', "cluevo"), |
| [1390](#L1390) | 'new\_module' => \_\_('New Module', "cluevo"), |
| [1391](#L1391) | 'course' => \_\_('Course', "cluevo"), |
| [1392](#L1392) | 'chapter' => \_\_('Chapter', "cluevo"), |
| [1393](#L1393) | 'module' => \_\_('Module', "cluevo"), |
| [1394](#L1394) | 'without\_module' => \_\_('Without Module', "cluevo"), |
| [1395](#L1395) | 'delete\_item' => \_\_('Really delete this element?', "cluevo"), |
| [1396](#L1396) | 'shortcode\_copied' => \_\_('Shortcode copied!', "cluevo"), |
| [1397](#L1397) | 'msg\_install\_demos' => \_\_("Install demo course and modules? The modules will be downloaded from our homepage and installed to your LMS.", "cluevo"), |
| [1398](#L1398) | 'published' => \_\_("Published", "cluevo"), |
| [1399](#L1399) | 'draft' => \_\_("Draft", "cluevo"), |
| [1400](#L1400) | 'tree\_rebuild\_warning' => \_\_("It looks like your learning tree needs to be rebuilt. If you save now you will overwrite your current learning tree with this empty one.\nAre you sure you want to save?", "cluevo"), |
| [1401](#L1401) | 'course\_group\_name\_cant\_be\_empty' => \_\_("The name of the course group must not be empty.", "cluevo"), |
| [1402](#L1402) | 'filter\_placeholder' => \_\_("'Search Query' or '!Search Query' / '-Seach Query'", "cluevo"), |
| [1403](#L1403) | 'results' => \_\_("Results: ", "cluevo"), |
| [1404](#L1404) | 'tags' => \_\_("Tags", "cluevo"), |
| [1405](#L1405) | 'tag' => \_\_("Tag", "cluevo"), |
| [1406](#L1406) | 'with\_tag' => \_\_("With Tag", "cluevo"), |
| [1407](#L1407) | 'without\_tag' => \_\_("Without Tag", "cluevo"), |
| [1408](#L1408) | 'get\_cert\_extension' => \_\_("Get the Certificates Extension to issue certificates", "cluevo"), |
| [1409](#L1409) | ) |
| [1410](#L1410) | ); |
| [1411](#L1411) |  |
| [1412](#L1412) | wp\_register\_script( |
| [1413](#L1413) | 'cluevo-module-selector', |
| [1414](#L1414) | plugins\_url('/js/module-selector.admin.js', plugin\_dir\_path(\_\_FILE\_\_)), |
| [1415](#L1415) | ['scorm-plugin-js'], |
| [1416](#L1416) | CLUEVO\_VERSION, |
| [1417](#L1417) | true |
| [1418](#L1418) | ); |
| [1419](#L1419) | wp\_localize\_script( |
| [1420](#L1420) | 'cluevo-module-selector', |
| [1421](#L1421) | 'cluevoApiSettings', |
| [1422](#L1422) | array( |
| [1423](#L1423) | 'root' => esc\_url\_raw(rest\_url()), |
| [1424](#L1424) | 'nonce' => wp\_create\_nonce('wp\_rest') |
| [1425](#L1425) | ) |
| [1426](#L1426) | ); |
| [1427](#L1427) | wp\_localize\_script( |
| [1428](#L1428) | 'cluevo-module-selector', |
| [1429](#L1429) | 'lang\_strings', |
| [1430](#L1430) | array( |
| [1431](#L1431) | "insert\_module" => \_\_("Insert Module", "cluevo"), |
| [1432](#L1432) | "label\_search" => \_\_("Search", "cluevo"), |
| [1433](#L1433) | "placeholder\_modulename" => \_\_("Search term", "cluevo"), |
| [1434](#L1434) | "module\_search\_result\_count" => \_\_("Modules", "cluevo"), |
| [1435](#L1435) | "filter\_tile\_all" => \_\_("All", "cluevo") |
| [1436](#L1436) | ) |
| [1437](#L1437) | ); |
| [1438](#L1438) | wp\_enqueue\_script('cluevo-module-selector'); |
| [1439](#L1439) | } |
| [1440](#L1440) |  |
| [1441](#L1441) | function cluevo\_enqueue\_lms\_modules\_ui\_js() |
| [1442](#L1442) | { |
| [1443](#L1443) | wp\_register\_script('cluevo-admin-module-page', plugins\_url('/js/module-admin-page.js', plugin\_dir\_path(\_\_FILE\_\_)), array(), CLUEVO\_VERSION, true); |
| [1444](#L1444) | wp\_enqueue\_script("cluevo-admin-module-page"); |
| [1445](#L1445) | wp\_localize\_script( |
| [1446](#L1446) | 'cluevo-admin-module-page', |
| [1447](#L1447) | 'moduleApiSettings', |
| [1448](#L1448) | array( |
| [1449](#L1449) | 'root' => esc\_url\_raw(rest\_url()), |
| [1450](#L1450) | 'nonce' => wp\_create\_nonce('wp\_rest') |
| [1451](#L1451) | ) |
| [1452](#L1452) | ); |
| [1453](#L1453) | wp\_localize\_script( |
| [1454](#L1454) | 'cluevo-admin-module-page', |
| [1455](#L1455) | 'strings', |
| [1456](#L1456) | array( |
| [1457](#L1457) | 'confirm\_module\_delete' => \_\_("Really delete this module? This action can't be undone.", "cluevo"), |
| [1458](#L1458) | 'toggle\_install\_type\_file' => \_\_('Install module from URL', "cluevo"), |
| [1459](#L1459) | 'toggle\_install\_type\_url' => \_\_('Upload module file', "cluevo"), |
| [1460](#L1460) | 'msg\_install\_demos' => \_\_("Install demo course and modules. The modules will be downloaded from our homepage and installed to your LMS", "cluevo"), |
| [1461](#L1461) | 'rename\_module\_prompt' => \_\_("New Name", "cluevo"), |
| [1462](#L1462) | 'rename\_module\_error' => \_\_("The module could not be renamed. A module with the same name may already exist or the module is no longer available.", "cluevo"), |
| [1463](#L1463) | "upload\_success" => \_\_("The module has been uploaded. One moment please while it is being installed.", "cluevo"), |
| [1464](#L1464) | "module\_upload\_finished" => \_\_("Installation completed.", "cluevo"), |
| [1465](#L1465) | "refresh\_to\_enable" => \_\_("Module uploaded. Refresh the page to enable the tools.", "cluevo"), |
| [1466](#L1466) | "module\_upload\_failed" => \_\_("Installation failed.", "cluevo"), |
| [1467](#L1467) | "upload\_error" => \_\_("Upload failed.", "cluevo"), |
| [1468](#L1468) | "pending\_install\_error" => \_\_("Installation failed.", "cluevo"), |
| [1469](#L1469) | "pending\_delete\_error" => \_\_("Removal failed.", "cluevo"), |
| [1470](#L1470) | "update\_module" => \_\_("Update Module", "cluevo"), |
| [1471](#L1471) | "update\_module\_description" => \_\_("Please select a module or enter a URL", "cluevo") |
| [1472](#L1472) | ) |
| [1473](#L1473) | ); |
| [1474](#L1474) | wp\_localize\_script('cluevo-admin-module-page', 'cluevoWpApiSettings', [ |
| [1475](#L1475) | 'root' => esc\_url\_raw(rest\_url()), |
| [1476](#L1476) | 'nonce' => wp\_create\_nonce('wp\_rest'), |
| [1477](#L1477) | 'pendingModuleNonce' => wp\_create\_nonce('##cluevo-install-pending-module'), |
| [1478](#L1478) | 'deletePendingModuleNonce' => wp\_create\_nonce('##cluevo-delete-pending-module') |
| [1479](#L1479) | ]);  // needed for ajax requests |
| [1480](#L1480) | } |
| [1481](#L1481) |  |
| [1482](#L1482) | function cluevo\_update\_module\_name($intModuleId, $strNewName) |
| [1483](#L1483) | { |
| [1484](#L1484) | global $wpdb; |
| [1485](#L1485) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [1486](#L1486) | $result = $wpdb->query( |
| [1487](#L1487) | $wpdb->prepare("UPDATE $table SET module\_name = %s WHERE module\_id = %d", [sanitize\_text\_field($strNewName), $intModuleId]) |
| [1488](#L1488) | ); |
| [1489](#L1489) | return ($result !== false); |
| [1490](#L1490) | } |
| [1491](#L1491) |  |
| [1492](#L1492) | function cluevo\_update\_module\_tags($intModuleId, $mixedTags = []) |
| [1493](#L1493) | { |
| [1494](#L1494) | $tags = cluevo\_create\_tag\_string($mixedTags); |
| [1495](#L1495) | global $wpdb; |
| [1496](#L1496) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [1497](#L1497) | $result = $wpdb->query( |
| [1498](#L1498) | $wpdb->prepare("UPDATE $table SET tags = %s WHERE module\_id = %d", [sanitize\_text\_field($tags), $intModuleId]) |
| [1499](#L1499) | ); |
| [1500](#L1500) | return ($result !== false); |
| [1501](#L1501) | } |
| [1502](#L1502) |  |
| [1503](#L1503) | function cluevo\_search\_modules($strName) |
| [1504](#L1504) | { |
| [1505](#L1505) | global $wpdb; |
| [1506](#L1506) | $table = $wpdb->prefix . CLUEVO\_DB\_TABLE\_MODULES; |
| [1507](#L1507) | $results = $wpdb->get\_results( |
| [1508](#L1508) | $wpdb->prepare("SELECT module\_id, module\_name FROM {$table} WHERE module\_name LIKE CONCAT('%', %s, '%')", [$strName]) |
| [1509](#L1509) | ); |
| [1510](#L1510) | return $results; |
| [1511](#L1511) | } |
| [1512](#L1512) |  |
| [1513](#L1513) | function cluevo\_output\_empty\_admin\_module\_rating() |
| [1514](#L1514) | { |
| [1515](#L1515) | $out = '<div class="cluevo-module-rating-container cluevo-unrated">'; |
| [1516](#L1516) | $out .= '<div class="cluevo-module-stars">'; |
| [1517](#L1517) | for ($i = 1; $i < 6; $i++) { |
| [1518](#L1518) | $out .= '<div class="cluevo-module-rating"></div>'; |
| [1519](#L1519) | } |
| [1520](#L1520) | $out .= '</div>'; |
| [1521](#L1521) | $out .= '</div>'; |
| [1522](#L1522) | return $out; |
| [1523](#L1523) | } |
| [1524](#L1524) |  |
| [1525](#L1525) | function cluevo\_output\_admin\_module\_rating($module) |
| [1526](#L1526) | { |
| [1527](#L1527) | if (empty($module)) return ''; |
| [1528](#L1528) | if (empty($module->rating\_avg)) return ''; |
| [1529](#L1529) | if (empty($module->rating\_avg["value"])) return ''; |
| [1530](#L1530) | $rating = $module->rating\_avg["value"]; |
| [1531](#L1531) | $out = '<a href="' . add\_query\_arg('module\_id', $module->module\_id, admin\_url("admin.php?page=cluevo-module-ratings")) . '" class="cluevo-module-rating-container">'; |
| [1532](#L1532) | $out .= '<div class="cluevo-module-stars">'; |
| [1533](#L1533) | for ($i = 1; $i < 6; $i++) { |
| [1534](#L1534) | $out .= '<div class="cluevo-module-rating'; |
| [1535](#L1535) | $out .= ($rating >= $i) ? ' filled' : ''; |
| [1536](#L1536) | $out .= '"></div>'; |
| [1537](#L1537) | } |
| [1538](#L1538) | $out .= '</div>'; |
| [1539](#L1539) | $out .= '<div class="cluevo-rating-stats">'; |
| [1540](#L1540) | $out .= '<div class="cluevo-rating-count">' . $module->rating\_avg["count"] . ' ' . esc\_html\_\_("Ratings", "cluevo") . '</div>'; |
| [1541](#L1541) | $out .= '<div class="cluevo-rating-value">' . number\_format($module->rating\_avg["value"], 2) . '</div>'; |
| [1542](#L1542) | $out .= '</div>'; |
| [1543](#L1543) | $out .= '</a>'; |
| [1544](#L1544) | return $out; |
| [1545](#L1545) | } |
| [1546](#L1546) |  |
| [1547](#L1547) | function cluevo\_find\_pending\_modules() |
| [1548](#L1548) | { |
| [1549](#L1549) | $baseDir = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'); |
| [1550](#L1550) | $baseIterator = new DirectoryIterator($baseDir); |
| [1551](#L1551) | if (!is\_dir($baseDir)) return []; |
| [1552](#L1552) | $modules = cluevo\_get\_modules(); |
| [1553](#L1553) | $existing = array\_map(function ($module) use ($baseDir) { |
| [1554](#L1554) | return cluevo\_path\_join($baseDir, $module->module\_dir); |
| [1555](#L1555) | }, $modules); |
| [1556](#L1556) | $pending = []; |
| [1557](#L1557) | foreach ($baseIterator as $type) { |
| [1558](#L1558) | if ($type->isDot()) continue; |
| [1559](#L1559) | $typePath = cluevo\_path\_join($baseDir, $type->getFilename()); |
| [1560](#L1560) | if (!is\_dir($typePath)) continue; |
| [1561](#L1561) | $typeIterator = new DirectoryIterator($typePath); |
| [1562](#L1562) | foreach ($typeIterator as $module) { |
| [1563](#L1563) | if ($module->isDot()) continue; |
| [1564](#L1564) | if (!$module->isDir()) continue; |
| [1565](#L1565) | $modulePath = cluevo\_path\_join($typePath, $module->getFilename()); |
| [1566](#L1566) | if (!in\_array($modulePath, $existing)) { |
| [1567](#L1567) | $pending[] = [ |
| [1568](#L1568) | "module" => cluevo\_path\_join($type->getFilename(), $module->getFilename()), |
| [1569](#L1569) | "installable" => has\_action("cluevo\_install\_pending\_module\_{$type->getFilename()}") > 0, |
| [1570](#L1570) | ]; |
| [1571](#L1571) | } |
| [1572](#L1572) | } |
| [1573](#L1573) | } |
| [1574](#L1574) | return $pending; |
| [1575](#L1575) | } |
| [1576](#L1576) |  |
| [1577](#L1577) | function cluevo\_ajax\_delete\_pending\_module() |
| [1578](#L1578) | { |
| [1579](#L1579) | $nonce\_name = isset($\_POST["cluevo-pending-module-nonce"]) ? sanitize\_text\_field($\_POST["cluevo-pending-module-nonce"]) : ""; |
| [1580](#L1580) | $nonce\_action = "##cluevo-delete-pending-module"; |
| [1581](#L1581) |  |
| [1582](#L1582) | if (!wp\_verify\_nonce($nonce\_name, $nonce\_action)) return; |
| [1583](#L1583) | if (!current\_user\_can("administrator")) return; |
| [1584](#L1584) |  |
| [1585](#L1585) | $moduleInput = sanitize\_text\_field($\_POST["cluevo-pending-module"]); |
| [1586](#L1586) | $parts = explode('/', $moduleInput); |
| [1587](#L1587) | if (empty($parts)) wp\_send\_json\_error(false); |
| [1588](#L1588) | $modulePathParts = array\_map(function ($el) { |
| [1589](#L1589) | return sanitize\_file\_name($el); |
| [1590](#L1590) | }, $parts); |
| [1591](#L1591) | if (empty($modulePathParts)) wp\_send\_json\_error(false); |
| [1592](#L1592) | $module = implode('/', $modulePathParts); |
| [1593](#L1593) |  |
| [1594](#L1594) | $pending = cluevo\_find\_pending\_modules(); |
| [1595](#L1595) | $list = array\_map(function ($item) { |
| [1596](#L1596) | return $item["module"]; |
| [1597](#L1597) | }, $pending); |
| [1598](#L1598) | if (!in\_array($module, $list)) return; |
| [1599](#L1599) |  |
| [1600](#L1600) | $path = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), $module); |
| [1601](#L1601) | if (is\_dir($path) && $path != cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') && stripos($path, cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH')) === 0) { |
| [1602](#L1602) | cluevo\_delete\_directory($path); |
| [1603](#L1603) | wp\_send\_json\_success(true); |
| [1604](#L1604) | } else { |
| [1605](#L1605) | wp\_send\_json\_error(false); |
| [1606](#L1606) | } |
| [1607](#L1607) | } |
| [1608](#L1608) |  |
| [1609](#L1609) | function cluevo\_ajax\_install\_pending\_module() |
| [1610](#L1610) | { |
| [1611](#L1611) | $nonce\_name = isset($\_POST["cluevo-pending-module-nonce"]) ? sanitize\_text\_field($\_POST["cluevo-pending-module-nonce"]) : ""; |
| [1612](#L1612) | $nonce\_action = "##cluevo-install-pending-module"; |
| [1613](#L1613) |  |
| [1614](#L1614) | if (!wp\_verify\_nonce($nonce\_name, $nonce\_action)) return; |
| [1615](#L1615) | if (!current\_user\_can("administrator")) return; |
| [1616](#L1616) |  |
| [1617](#L1617) | $moduleInput = sanitize\_text\_field($\_POST["cluevo-pending-module"]); |
| [1618](#L1618) | $parts = explode('/', $moduleInput); |
| [1619](#L1619) | $parts = array\_values(array\_filter($parts, function ($value) { |
| [1620](#L1620) | return !empty($value); |
| [1621](#L1621) | })); |
| [1622](#L1622) | if (empty($parts)) wp\_send\_json\_error(false); |
| [1623](#L1623) | $modulePathParts = array\_map(function ($el) { |
| [1624](#L1624) | return sanitize\_key($el); |
| [1625](#L1625) | }, $parts); |
| [1626](#L1626) | if (empty($modulePathParts)) wp\_send\_json\_error(false); |
| [1627](#L1627) | $module = cluevo\_path\_join($modulePathParts); |
| [1628](#L1628) |  |
| [1629](#L1629) | $pending = cluevo\_find\_pending\_modules(); |
| [1630](#L1630) | $list = array\_map(function ($item) { |
| [1631](#L1631) | return $item["module"]; |
| [1632](#L1632) | }, $pending); |
| [1633](#L1633) | if (!in\_array($module, $list)) return; |
| [1634](#L1634) | $module = trim($module, '/'); |
| [1635](#L1635) |  |
| [1636](#L1636) | $parts = explode('/', $module); |
| [1637](#L1637) | if (count($parts) !== 2) return; |
| [1638](#L1638) | $type = sanitize\_key($parts[0]); |
| [1639](#L1639) |  |
| [1640](#L1640) | do\_action("cluevo\_install\_pending\_module\_{$type}", $parts[1]); |
| [1641](#L1641) | } |
| [1642](#L1642) |  |
| [1643](#L1643) | function cluevo\_install\_pending\_scorm\_module($strName) |
| [1644](#L1644) | { |
| [1645](#L1645) | $realPath = cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH') . cluevo\_path\_join("scorm2004", $strName) . "/"; |
| [1646](#L1646) | $moduleType = CLUEVO\_SCORM\_MODULE\_TYPE\_ID; // module\_type = scorm |
| [1647](#L1647) | $href = cluevo\_find\_module\_index($realPath, false); |
| [1648](#L1648) | $scormVersion = cluevo\_get\_scorm\_version\_from\_manifest($realPath); |
| [1649](#L1649) | $id = cluevo\_create\_module\_metadata\_post($strName); |
| [1650](#L1650) | $result = cluevo\_create\_module($strName, $moduleType, $id, cluevo\_path\_join('scorm2004', $strName), null, $href, null, 0, $scormVersion); |
| [1651](#L1651) | wp\_die($result); |
| [1652](#L1652) | } |
| [1653](#L1653) |  |
| [1654](#L1654) | function cluevo\_install\_pending\_audio\_module($strName) |
| [1655](#L1655) | { |
| [1656](#L1656) | $validExtensions = ["mp3", "wav", "m4a"]; |
| [1657](#L1657) | $path = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), 'audio', $strName); |
| [1658](#L1658) | if (!file\_exists($path)) wp\_die(false); |
| [1659](#L1659) | $dirIterator = new DirectoryIterator($path); |
| [1660](#L1660) | $file = null; |
| [1661](#L1661) | foreach ($dirIterator as $file) { |
| [1662](#L1662) | if ($file->isDot()) continue; |
| [1663](#L1663) | if ($file->isDir()) continue; |
| [1664](#L1664) | if (!in\_array($file->getExtension(), $validExtensions)) continue; |
| [1665](#L1665) | $file = $file->getFilename(); |
| [1666](#L1666) | break; |
| [1667](#L1667) | } |
| [1668](#L1668) | if (empty($file)) { |
| [1669](#L1669) | wp\_die(false); |
| [1670](#L1670) | } |
| [1671](#L1671) | $moduleType = CLUEVO\_AUDIO\_MODULE\_TYPE\_ID; // module\_type = audio |
| [1672](#L1672) | $id = cluevo\_create\_module\_metadata\_post($strName); |
| [1673](#L1673) | $result = cluevo\_create\_module( |
| [1674](#L1674) | basename($file), |
| [1675](#L1675) | $moduleType, |
| [1676](#L1676) | $id, |
| [1677](#L1677) | "audio/{$strName}", |
| [1678](#L1678) | null, |
| [1679](#L1679) | basename($file), |
| [1680](#L1680) | null, |
| [1681](#L1681) | 0, |
| [1682](#L1682) | null |
| [1683](#L1683) | ); |
| [1684](#L1684) | wp\_die($result); |
| [1685](#L1685) | } |
| [1686](#L1686) |  |
| [1687](#L1687) | function cluevo\_install\_pending\_video\_module($strName) |
| [1688](#L1688) | { |
| [1689](#L1689) | $validExtensions = ["mp4", "webm", "mpeg"]; |
| [1690](#L1690) | $path = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), 'video', $strName); |
| [1691](#L1691) | if (!file\_exists($path)) wp\_die(false); |
| [1692](#L1692) | $dirIterator = new DirectoryIterator($path); |
| [1693](#L1693) | $file = null; |
| [1694](#L1694) | foreach ($dirIterator as $file) { |
| [1695](#L1695) | if ($file->isDot()) continue; |
| [1696](#L1696) | if ($file->isDir()) continue; |
| [1697](#L1697) | if (!in\_array($file->getExtension(), $validExtensions)) continue; |
| [1698](#L1698) | $file = $file->getFilename(); |
| [1699](#L1699) | break; |
| [1700](#L1700) | } |
| [1701](#L1701) | if (empty($file)) { |
| [1702](#L1702) | wp\_die(false); |
| [1703](#L1703) | } |
| [1704](#L1704) | $moduleType = CLUEVO\_VIDEO\_MODULE\_TYPE\_ID; // module\_type = video |
| [1705](#L1705) | $id = cluevo\_create\_module\_metadata\_post($strName); |
| [1706](#L1706) | $result = cluevo\_create\_module( |
| [1707](#L1707) | basename($file), |
| [1708](#L1708) | $moduleType, |
| [1709](#L1709) | $id, |
| [1710](#L1710) | "video/{$strName}", |
| [1711](#L1711) | null, |
| [1712](#L1712) | basename($file), |
| [1713](#L1713) | null, |
| [1714](#L1714) | 0, |
| [1715](#L1715) | null |
| [1716](#L1716) | ); |
| [1717](#L1717) | wp\_die($result); |
| [1718](#L1718) | } |
| [1719](#L1719) |  |
| [1720](#L1720) | function cluevo\_install\_pending\_pdf\_module($strName) |
| [1721](#L1721) | { |
| [1722](#L1722) | $validExtensions = ["pdf"]; |
| [1723](#L1723) | $path = cluevo\_path\_join(cluevo\_get\_conf\_const('CLUEVO\_ABS\_MODULE\_PATH'), 'pdf', $strName); |
| [1724](#L1724) | if (!file\_exists($path)) wp\_die(false); |
| [1725](#L1725) | $dirIterator = new DirectoryIterator($path); |
| [1726](#L1726) | $file = null; |
| [1727](#L1727) | foreach ($dirIterator as $file) { |
| [1728](#L1728) | if ($file->isDot()) continue; |
| [1729](#L1729) | if ($file->isDir()) continue; |
| [1730](#L1730) | if (!in\_array($file->getExtension(), $validExtensions)) continue; |
| [1731](#L1731) | $file = $file->getFilename(); |
| [1732](#L1732) | break; |
| [1733](#L1733) | } |
| [1734](#L1734) | if (empty($file)) { |
| [1735](#L1735) | wp\_die(false); |
| [1736](#L1736) | } |
| [1737](#L1737) | $moduleType = CLUEVO\_PDF\_MODULE\_TYPE\_ID; // module\_type = video |
| [1738](#L1738) | $id = cluevo\_create\_module\_metadata\_post($strName); |
| [1739](#L1739) | $result = cluevo\_create\_module( |
| [1740](#L1740) | basename($file), |
| [1741](#L1741) | $moduleType, |
| [1742](#L1742) | $id, |
| [1743](#L1743) | "pdf/{$strName}", |
| [1744](#L1744) | null, |
| [1745](#L1745) | basename($file), |
| [1746](#L1746) | null, |
| [1747](#L1747) | 0, |
| [1748](#L1748) | null |
| [1749](#L1749) | ); |
| [1750](#L1750) | wp\_die($result); |
| [1751](#L1751) | } |
| [1752](#L1752) |  |
| [1753](#L1753) | function cluevo\_add\_tree\_item\_close\_button\_setting($item) |
| [1754](#L1754) | { |
| [1755](#L1755) | if ($item->type === "module" || (!empty($item->module\_id) && (int)$item->module\_id > 0)) { |
| [1756](#L1756) | ?> |
| [1757](#L1757) | <div class="meta-container hide-lightbox-close-button"> |
| [1758](#L1758) | <details> |
| [1759](#L1759) | <summary class="label"><?php \_e("Lightbox Settings", "cluevo"); ?> |
| [1760](#L1760) | <p class="help"> |
| [1761](#L1761) | <?php \_e("These settings configure the lightbox.", "cluevo"); ?> |
| [1762](#L1762) | </p> |
| [1763](#L1763) | </summary> |
| [1764](#L1764) | <div class="label sub">Schließen Button</div> |
| [1765](#L1765) | <table class="cluevo-meta-settings-group"> |
| [1766](#L1766) | <tr> |
| [1767](#L1767) | <td> |
| [1768](#L1768) | <label><?php \_e("Hide Button", "cluevo"); ?></label> |
| [1769](#L1769) | </td> |
| [1770](#L1770) | <td> |
| [1771](#L1771) | <input type="checkbox" value="1" class="setting" data-target="hide-lightbox-close-button" <?php echo esc\_attr($item->get\_setting('hide-lightbox-close-button') ? 'checked' : ''); ?> /> |
| [1772](#L1772) | </td> |
| [1773](#L1773) | </tr> |
| [1774](#L1774) | <tr> |
| [1775](#L1775) | <td> |
| [1776](#L1776) | <label><?php \_e("Button Text", "cluevo"); ?></label> |
| [1777](#L1777) | </td> |
| [1778](#L1778) | <td> |
| [1779](#L1779) | <input placeholder="&times;" type="text" value="<?php echo esc\_attr($item->get\_setting('lightbox-close-button-text')); ?>" class="setting" data-target="lightbox-close-button-text" /> |
| [1780](#L1780) | </td> |
| [1781](#L1781) | </tr> |
| [1782](#L1782) | <tr> |
| [1783](#L1783) | <td> |
| [1784](#L1784) | <label><?php \_e("Button Position", "cluevo"); ?></label> |
| [1785](#L1785) | </td> |
| [1786](#L1786) | <td> |
| [1787](#L1787) | <select size="1" name="lightbox-close-button-position" class="setting" data-target="lightbox-close-button-position"> |
| [1788](#L1788) | <option value=""><?php esc\_html\_e("Default", "cluevo"); ?></option> |
| [1789](#L1789) | <option value="top-left" <?php if ($item->get\_setting('lightbox-close-button-position') == "top-left") echo "selected"; ?>><?php esc\_html\_e("top left", "cluevo"); ?></option> |
| [1790](#L1790) | <option value="top-center" <?php if ($item->get\_setting('lightbox-close-button-position') == "top-center") echo "selected"; ?>><?php esc\_html\_e("top center", "cluevo"); ?></option> |
| [1791](#L1791) | <option value="top-right" <?php if ($item->get\_setting('lightbox-close-button-position') == "top-right") echo "selected"; ?>><?php esc\_html\_e("top right", "cluevo"); ?></option> |
| [1792](#L1792) | <option value="bottom-left" <?php if ($item->get\_setting('lightbox-close-button-position') == "bottom-left") echo "selected"; ?>><?php esc\_html\_e("bottom left", "cluevo"); ?></option> |
| [1793](#L1793) | <option value="bottom-center" <?php if ($item->get\_setting('lightbox-close-button-position') == "bottom-center") echo "selected"; ?>><?php esc\_html\_e("bottom center", "cluevo"); ?></option> |
| [1794](#L1794) | <option value="bottom-right" <?php if ($item->get\_setting('lightbox-close-button-position') == "bottom-right") echo "selected"; ?>><?php esc\_html\_e("bottom right", "cluevo"); ?></option> |
| [1795](#L1795) | </select> |
| [1796](#L1796) | </td> |
| [1797](#L1797) | </tr> |
| [1798](#L1798) | </table> |
| [1799](#L1799) | </details> |
| [1800](#L1800) | </div> |
| [1801](#L1801) | <?php } |
| [1802](#L1802) | } |
| [1803](#L1803) |  |
| [1804](#L1804) | function cluevo\_add\_tree\_empty\_setting($item) |
| [1805](#L1805) | { |
| [1806](#L1806) | ?> |
| [1807](#L1807) | <div class="meta-container info-box-settings"> |
| [1808](#L1808) | <details> |
| [1809](#L1809) | <summary class="label"><?php \_e("Info Box Settings", "cluevo"); ?> |
| [1810](#L1810) | <p class="help"> |
| [1811](#L1811) | <?php \_e("Customize the messages that are displayed if an element is empty or permissions are required.", "cluevo"); ?> |
| [1812](#L1812) | </p> |
| [1813](#L1813) | </summary> |
| [1814](#L1814) | <table class="cluevo-meta-settings-group"> |
| [1815](#L1815) | <?php if ($item->type != "module") { ?> |
| [1816](#L1816) | <tr> |
| [1817](#L1817) | <td><?php esc\_html\_e("Hide Info Box", "cluevo"); ?></td> |
| [1818](#L1818) | <td> |
| [1819](#L1819) | <input type="checkbox" name="hide-info-box" <?php if ($item->get\_setting("hide-info-box")) echo esc\_attr("checked"); ?> data-target="hide-info-box" class="setting" /> |
| [1820](#L1820) | </td> |
| [1821](#L1821) | </tr> |
| [1822](#L1822) | <tr> |
| [1823](#L1823) | <td><?php esc\_html\_e("Element is empty text", "cluevo"); ?></td> |
| [1824](#L1824) | <td> |
| [1825](#L1825) | <input type="text" name="element-is-empty-text" value="<?php echo esc\_attr($item->get\_setting("element-is-empty-text")); ?>" data-target="element-is-empty-text" class="setting" /> |
| [1826](#L1826) | </td> |
| [1827](#L1827) | </tr> |
| [1828](#L1828) | <?php } ?> |
| [1829](#L1829) | <tr> |
| [1830](#L1830) | <td><?php esc\_html\_e("Hide access denied box", "cluevo"); ?></td> |
| [1831](#L1831) | <td> |
| [1832](#L1832) | <input type="checkbox" name="hide-access-denied-box" <?php if ($item->get\_setting("hide-access-denied-box")) echo esc\_attr("checked"); ?> data-target="hide-access-denied-box" class="setting" /> |
| [1833](#L1833) | </td> |
| [1834](#L1834) | </tr> |
| [1835](#L1835) | <tr> |
| [1836](#L1836) | <td><?php esc\_html\_e("Access denied text", "cluevo"); ?></td> |
| [1837](#L1837) | <td> |
| [1838](#L1838) | <input type="text" name="access-denied-text" value="<?php echo esc\_attr($item->get\_setting("access-denied-text")); ?>" data-target="access-denied-text" class="setting" /> |
| [1839](#L1839) | </td> |
| [1840](#L1840) | </tr> |
| [1841](#L1841) | </table> |
| [1842](#L1842) | </details> |
| [1843](#L1843) | </div> |
| [1844](#L1844) |  |
| [1845](#L1845) | <?php } |
| [1846](#L1846) |  |
| [1847](#L1847) | function cluevo\_add\_item\_display\_mode\_setting($item) |
| [1848](#L1848) | { |
| [1849](#L1849) | $defaultDisplayMode = strtolower(get\_option('cluevo-modules-display-mode')); |
| [1850](#L1850) | ?> |
| [1851](#L1851) | <?php if ($item->type == "module" || (!empty($item->module\_id) && (int)$item->module\_id > 0)) { ?> |
| [1852](#L1852) | <?php $tmpMode = (!empty($item->get\_setting('display-mode'))) ? $item->get\_setting('display-mode') : ""; ?> |
| [1853](#L1853) | <?php $iframePosition = $item->get\_setting('iframe-position'); ?> |
| [1854](#L1854) | <div class="meta-container display-mode"> |
| [1855](#L1855) | <details> |
| [1856](#L1856) | <summary class="label"><?php \_e("Display Mode", "cluevo"); ?> |
| [1857](#L1857) | <p class="help"> |
| [1858](#L1858) | <?php \_e("Determines how modules are displayed.", "cluevo"); ?> |
| [1859](#L1859) | </p> |
| [1860](#L1860) | </summary> |
| [1861](#L1861) | <div class="display-mode-container display-mode input-container"> |
| [1862](#L1862) | <label><?php \_e("Mode", "cluevo"); ?></label> |
| [1863](#L1863) | <select data-target="display-mode" class="setting"> |
| [1864](#L1864) | <option value="">Standard</option> |
| [1865](#L1865) | <option value="iframe" <?php if ($tmpMode == "iframe") echo "selected"; ?>><?php esc\_html\_e("Display on Page (Iframe)", "cluevo"); ?></option> |
| [1866](#L1866) | <option value="popup" <?php if ($tmpMode == "popup") echo "selected"; ?>><?php esc\_html\_e("Pop-Up", "cluevo"); ?></option> |
| [1867](#L1867) | <option value="lightbox" <?php if ($tmpMode == "lightbox") echo "selected"; ?>><?php esc\_html\_e("Lightbox", "cluevo"); ?> <?php esc\_html\_e("(Recommended)", "cluevo"); ?></option> |
| [1868](#L1868) | </select> |
| [1869](#L1869) | </div> |
| [1870](#L1870) | <div class="iframe-position input-container <?php if ($tmpMode === "iframe" || $defaultDisplayMode === 'iframe') echo "visible"; ?> <?php if ($defaultDisplayMode === "iframe") echo "forced"; ?>"> |
| [1871](#L1871) | <label><?php \_e("Position", "cluevo"); ?></label> |
| [1872](#L1872) | <select data-target="iframe-position" class="setting"> |
| [1873](#L1873) | <option value="start" <?php if ($iframePosition == "start") echo "selected"; ?>><?php esc\_html\_e('Top of the page', "cluevo"); ?></option> |
| [1874](#L1874) | <option value="end" <?php if ($iframePosition == "end") echo "selected"; ?>><?php esc\_html\_e('Bottom of the page', 'cluevo'); ?></option> |
| [1875](#L1875) | </select> |
| [1876](#L1876) | </div> |
| [1877](#L1877) | </details> |
| [1878](#L1878) | </div> |
| [1879](#L1879) | <?php } ?> |
| [1880](#L1880) |  |
| [1881](#L1881) | <?php } |
| [1882](#L1882) |  |
| [1883](#L1883) | function cluevo\_add\_tree\_item\_limited\_attempts($item) |
| [1884](#L1884) | { |
| [1885](#L1885) | $max = $item->get\_setting("max-attempts"); |
| [1886](#L1886) | $valid = true; |
| [1887](#L1887) | if (empty($item->module)) { |
| [1888](#L1888) | $max = null; |
| [1889](#L1889) | $valid = false; |
| [1890](#L1890) | }; |
| [1891](#L1891) | $hidden = empty($item->module); |
| [1892](#L1892) | ?> |
| [1893](#L1893) | <div class="meta-container info-box-settings <?php if ($hidden) echo esc\_attr('hidden'); ?>" data-module-only> |
| [1894](#L1894) | <details> |
| [1895](#L1895) | <summary class="label"><?php \_e("Max. Number of Attempts", "cluevo"); ?> |
| [1896](#L1896) | <p class="help"> |
| [1897](#L1897) | <?php \_e("You can customize how many times a user can attempt a module", "cluevo"); ?> |
| [1898](#L1898) | </p> |
| [1899](#L1899) | </summary> |
| [1900](#L1900) | <table class="cluevo-meta-settings-group"> |
| [1901](#L1901) | <tr> |
| [1902](#L1902) | <td><?php esc\_html\_e("Attempts", "cluevo"); ?></td> |
| [1903](#L1903) | <td> |
| [1904](#L1904) | <input type="number" name="max-attempts" value="<?php echo esc\_attr($max); ?>" data-target="max-attempts" class="setting" <?php if (!$valid) echo "disabled"; ?> /> |
| [1905](#L1905) | </td> |
| [1906](#L1906) | </tr> |
| [1907](#L1907) | </table> |
| [1908](#L1908) | </details> |
| [1909](#L1909) | </div> |
| [1910](#L1910) |  |
| [1911](#L1911) | <?php } |
| [1912](#L1912) |  |
| [1913](#L1913) | function cluevo\_add\_tree\_item\_tags($item) |
| [1914](#L1914) | { |
| [1915](#L1915) | $tags = $item->get\_setting("tags"); |
| [1916](#L1916) | ?> |
| [1917](#L1917) | <div class="meta-container info-box-settings"> |
| [1918](#L1918) | <details> |
| [1919](#L1919) | <summary class="label"><?php \_e("Tags", "cluevo"); ?> |
| [1920](#L1920) | <p class="help"> |
| [1921](#L1921) | <?php \_e("Tags help to organize your learning tree elements", "cluevo"); ?> |
| [1922](#L1922) | </p> |
| [1923](#L1923) | </summary> |
| [1924](#L1924) | <table class="cluevo-meta-settings-group"> |
| [1925](#L1925) | <tr> |
| [1926](#L1926) | <td><?php esc\_html\_e("Tags", "cluevo"); ?></td> |
| [1927](#L1927) | <td> |
| [1928](#L1928) | <input type="text" name="tags" value="<?php echo esc\_attr($tags); ?>" data-target="tags" class="setting tags" /> |
| [1929](#L1929) | </td> |
| [1930](#L1930) | </tr> |
| [1931](#L1931) | </table> |
| [1932](#L1932) | </details> |
| [1933](#L1933) | </div> |
| [1934](#L1934) |  |
| [1935](#L1935) | <?php } |
| [1936](#L1936) |  |
| [1937](#L1937) | function cluevo\_add\_tree\_item\_complete\_notifications($item) |
| [1938](#L1938) | { |
| [1939](#L1939) | $enabled = $item->get\_setting("notifications-enabled"); |
| [1940](#L1940) | $recipients = $item->get\_setting("notification-recipients"); |
| [1941](#L1941) | $hidden = empty($item->module); |
| [1942](#L1942) | ?> |
| [1943](#L1943) | <div class="meta-container info-box-settings <?php if ($hidden) echo esc\_attr('hidden'); ?>" data-module-only> |
| [1944](#L1944) | <details> |
| [1945](#L1945) | <summary class="label"> |
| [1946](#L1946) | <?php \_e("Notifications", "cluevo"); ?> |
| [1947](#L1947) | <p class="help"> |
| [1948](#L1948) | <?php \_e("Set up notifications for when users complete content", "cluevo"); ?> |
| [1949](#L1949) | </p> |
| [1950](#L1950) | </summary> |
| [1951](#L1951) | <table class="cluevo-meta-settings-group"> |
| [1952](#L1952) | <tr> |
| [1953](#L1953) | <td><?php esc\_html\_e("Enabled", "cluevo"); ?></td> |
| [1954](#L1954) | <td> |
| [1955](#L1955) | <input type="checkbox" value="success" name="notifications-enabled" <?php if ($enabled && !empty($item->module)) echo esc\_attr("checked"); ?> data-target="notifications-enabled" class="setting notifications-enabled" /> |
| [1956](#L1956) | </td> |
| [1957](#L1957) | </tr> |
| [1958](#L1958) | <tr> |
| [1959](#L1959) | <td><?php esc\_html\_e("Recipients", "cluevo"); ?></td> |
| [1960](#L1960) | <td> |
| [1961](#L1961) | <input type="text" name="notification-recipients" value="<?php esc\_attr\_e($recipients); ?>" data-target="notification-recipients" class="setting notification-recipients" /> |
| [1962](#L1962) | <?php esc\_html\_e("You can add multiple recipients by entering e-mail addresses separated by commas.", "cluevo"); ?> |
| [1963](#L1963) | </td> |
| [1964](#L1964) | </tr> |
| [1965](#L1965) | </table> |
| [1966](#L1966) | </details> |
| [1967](#L1967) | </div> |
| [1968](#L1968) |  |
| [1969](#L1969) | <?php } |
| [1970](#L1970) |  |
| [1971](#L1971) | function cluevo\_add\_tree\_item\_allow\_pdf\_download($item) |
| [1972](#L1972) | { |
| [1973](#L1973) | $checked = $item->get\_setting("allow-pdf-download"); |
| [1974](#L1974) | $valid = false; |
| [1975](#L1975) | if (!empty($item->module)) { |
| [1976](#L1976) | $module = cluevo\_get\_module($item->module); |
| [1977](#L1977) | if (!empty($module) && $module->type\_name === 'pdf') { |
| [1978](#L1978) | $valid = true; |
| [1979](#L1979) | } else { |
| [1980](#L1980) | $checked = false; |
| [1981](#L1981) | } |
| [1982](#L1982) | } else { |
| [1983](#L1983) | $checked = false; |
| [1984](#L1984) | } |
| [1985](#L1985) | $hidden = empty($item->module); |
| [1986](#L1986) | ?> |
| [1987](#L1987) | <div class="meta-container info-box-settings <?php if ($hidden) echo esc\_attr('hidden'); ?>" data-module-only> |
| [1988](#L1988) | <details> |
| [1989](#L1989) | <summary class="label"><?php \_e("Allow download of PDF file", "cluevo"); ?> |
| [1990](#L1990) | <p class="help"> |
| [1991](#L1991) | <?php \_e("Adds a download button to allow downloading the source PDF file", "cluevo"); ?> |
| [1992](#L1992) | </p> |
| [1993](#L1993) | </summary> |
| [1994](#L1994) | <table class="cluevo-meta-settings-group"> |
| [1995](#L1995) | <tr> |
| [1996](#L1996) | <td><?php esc\_html\_e("Enable", "cluevo"); ?></td> |
| [1997](#L1997) | <td> |
| [1998](#L1998) | <input type="checkbox" name="allow-pdf-download" value="1" data-target="allow-pdf-download" class="setting" <?php if (!$valid) echo "disabled"; ?> <?php if ($checked) echo "checked"; ?> /> |
| [1999](#L1999) | </td> |
| [2000](#L2000) | </tr> |
| [2001](#L2001) | </table> |
| [2002](#L2002) | </details> |
| [2003](#L2003) | </div> |
| [2004](#L2004) |  |
| [2005](#L2005) | <?php } |
| [2006](#L2006) |  |
| [2007](#L2007) | function cluevo\_check\_item\_access($item) |
| [2008](#L2008) | { |
| [2009](#L2009) | if (empty($item->module)) return $item; |
| [2010](#L2010) | $uid = get\_current\_user\_id(); |
| [2011](#L2011) | $item->load\_settings(); |
| [2012](#L2012) | $max = (!empty($item->settings["max-attempts"])) ? (int)$item->settings["max-attempts"] : 0; |
| [2013](#L2013) | if (empty($max)) return $item; |
| [2014](#L2014) | $curCount = (int)cluevo\_get\_users\_attempt\_count($uid, $item->module); |
| [2015](#L2015) | $item->attempt\_count = $curCount; |
| [2016](#L2016) | $attemptAccess = (!empty($max) && $curCount >= $max) ? 0 :  1; |
| [2017](#L2017) | $item->access\_status["attempts"] = $attemptAccess; |
| [2018](#L2018) | $access = true; |
| [2019](#L2019) | foreach ($item->access\_status as $type => $value) { |
| [2020](#L2020) | if ($value == false) { |
| [2021](#L2021) | $access = false; |
| [2022](#L2022) | break; |
| [2023](#L2023) | } |
| [2024](#L2024) | } |
| [2025](#L2025) | $item->access = $access || current\_user\_can("administrator"); |
| [2026](#L2026) | return $item; |
| [2027](#L2027) | } |
| [2028](#L2028) |  |
| [2029](#L2029) | function cluevo\_add\_completed\_module\_to\_list($args) |
| [2030](#L2030) | { |
| [2031](#L2031) | if (empty($args["state"])) return; |
| [2032](#L2032) | if (empty($args["module\_id"])) return; |
| [2033](#L2033) | cluevo\_clear\_turbo\_cache(); |
| [2034](#L2034) | $modules = cluevo\_turbo\_get\_users\_completed\_modules($args["user\_id"], false); |
| [2035](#L2035) | $GLOBALS["cluevo-users-completed-modules"] = $modules; |
| [2036](#L2036) | } |
| [2037](#L2037) |  |
| [2038](#L2038) | function cluevo\_add\_tree\_item\_is\_link\_setting($item) |
| [2039](#L2039) | { |
| [2040](#L2040) | $link = $item->get\_setting("item-is-link"); |
| [2041](#L2041) | ?> |
| [2042](#L2042) | <div class="meta-container item-is-link"> |
| [2043](#L2043) | <details> |
| [2044](#L2044) | <summary class="label"><?php \_e("Item is a link", "cluevo"); ?> |
| [2045](#L2045) | <p class="help"> |
| [2046](#L2046) | <?php \_e("This item links to some other content. Assigned modules won't start, users will be sent the entered link instead.", "cluevo"); ?> |
| [2047](#L2047) | </p> |
| [2048](#L2048) | </summary> |
| [2049](#L2049) | <input type="url" name="item-is-link" value="<?php echo esc\_attr($link); ?>" data-target="item-is-link" class="setting" placeholder="https://" /> |
| [2050](#L2050) | <label> |
| [2051](#L2051) | <input type="checkbox" name="open-link-in-new-window" <?php if ($item->get\_setting("open-link-in-new-window")) echo esc\_attr("checked"); ?> data-target="open-link-in-new-window" class="setting" /> |
| [2052](#L2052) | <?php esc\_html\_e("Open link in new window", "cluevo"); ?> |
| [2053](#L2053) | </label> |
| [2054](#L2054) | </details> |
| [2055](#L2055) | </div> |
| [2056](#L2056) | <?php } |
| [2057](#L2057) |  |
| [2058](#L2058) | function cluevo\_register\_default\_module\_types($args) |
| [2059](#L2059) | { |
| [2060](#L2060) |  |
| [2061](#L2061) | $scorm12 = [ |
| [2062](#L2062) | 'name' => \_\_('SCORM 1.2', 'cluevo'), |
| [2063](#L2063) | 'key' => 'scorm', |
| [2064](#L2064) | 'icon' => plugins\_url("/images/icon-module-ui-scorm-1-2\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2065](#L2065) | 'description' => \_\_('Upload a SCORM module or enter a link to a SCORM module file.', 'cluevo'), |
| [2066](#L2066) | 'field' => 'mixed', |
| [2067](#L2067) | 'filter' => '.zip', |
| [2068](#L2068) | 'field-placeholder' => \_\_('https://', 'cluevo'), |
| [2069](#L2069) | 'button-label' => \_\_('select file', 'cluevo') |
| [2070](#L2070) | ]; |
| [2071](#L2071) |  |
| [2072](#L2072) | $scorm2004 = [ |
| [2073](#L2073) | 'name' => \_\_('SCORM 2004', 'cluevo'), |
| [2074](#L2074) | 'key' => 'scorm', |
| [2075](#L2075) | 'icon' => plugins\_url("/images/icon-module-ui-scorm-2004\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2076](#L2076) | 'description' => \_\_('Upload a SCORM module or enter a link to a SCORM module file.', 'cluevo'), |
| [2077](#L2077) | 'field' => 'mixed', |
| [2078](#L2078) | 'filter' => '.zip', |
| [2079](#L2079) | 'field-placeholder' => \_\_('https://', 'cluevo'), |
| [2080](#L2080) | 'button-label' => \_\_('select file', 'cluevo') |
| [2081](#L2081) | ]; |
| [2082](#L2082) |  |
| [2083](#L2083) | $audio = [ |
| [2084](#L2084) | 'name' => \_\_('Audio File', 'cluevo'), |
| [2085](#L2085) | 'key' => 'audio', |
| [2086](#L2086) | 'icon' => plugins\_url("/images/icon-module-ui-audio\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2087](#L2087) | 'description' => \_\_('Upload a audio file or enter a link to a audio file.', 'cluevo'), |
| [2088](#L2088) | 'field' => 'mixed', |
| [2089](#L2089) | 'filter' => '.mp3,.wav,.webm', |
| [2090](#L2090) | 'field-placeholder' => \_\_('', 'cluevo'), |
| [2091](#L2091) | 'button-label' => \_\_('select audio file', 'cluevo') |
| [2092](#L2092) | ]; |
| [2093](#L2093) |  |
| [2094](#L2094) | $video = [ |
| [2095](#L2095) | 'name' => \_\_('Video File', 'cluevo'), |
| [2096](#L2096) | 'key' => 'video', |
| [2097](#L2097) | 'icon' => plugins\_url("/images/icon-module-ui-video\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2098](#L2098) | 'description' => \_\_('Upload a video file or enter a link to a video file.', 'cluevo'), |
| [2099](#L2099) | 'field' => 'mixed', |
| [2100](#L2100) | 'filter' => '.mp4,.webm,.mpeg', |
| [2101](#L2101) | 'field-placeholder' => \_\_('https://', 'cluevo'), |
| [2102](#L2102) | 'button-label' => \_\_('select video file', 'cluevo') |
| [2103](#L2103) | ]; |
| [2104](#L2104) |  |
| [2105](#L2105) | $pdf = [ |
| [2106](#L2106) | 'name' => \_\_('PDF Document', 'cluevo'), |
| [2107](#L2107) | 'key' => 'pdf', |
| [2108](#L2108) | 'icon' => plugins\_url("/images/icon-module-ui-pdf\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2109](#L2109) | 'description' => \_\_('Upload a PDF document', 'cluevo'), |
| [2110](#L2110) | 'field' => 'mixed', |
| [2111](#L2111) | 'filter' => '.pdf', |
| [2112](#L2112) | 'field-placeholder' => \_\_('https://', 'cluevo'), |
| [2113](#L2113) | 'button-label' => \_\_('select PDF document', 'cluevo') |
| [2114](#L2114) | ]; |
| [2115](#L2115) |  |
| [2116](#L2116) | $oembed = [ |
| [2117](#L2117) | 'name' => \_\_('YouTube, Vimeo, etc.', 'cluevo'), |
| [2118](#L2118) | 'key' => 'oembed', |
| [2119](#L2119) | 'icon' => plugins\_url("/images/icon\_module-ui-oembed\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2120](#L2120) | 'description' => \_\_('Install the CLUEVO Video Tutorial Manager extension to embed content from YouTube and many other sites.', 'cluevo'), |
| [2121](#L2121) | 'field' => null, |
| [2122](#L2122) | 'filter' => null, |
| [2123](#L2123) | 'field-placeholder' => null, |
| [2124](#L2124) | 'button-label' => null, |
| [2125](#L2125) | 'alt-type' => "cluevo-lms-extension-oembed", |
| [2126](#L2126) | 'alt-icon-class' => "extension", |
| [2127](#L2127) | 'alt-content' => '<p><a class="button button-primary cluevo-btn-install-type" href="' . esc\_attr(admin\_url('plugin-install.php?s=cluevo&tab=search&type=term')) . '">' . esc\_html\_\_("Install CLUEVO oEmbed extension", "cluevo") . '</a></p>' |
| [2128](#L2128) | ]; |
| [2129](#L2129) |  |
| [2130](#L2130) | $gdocs = [ |
| [2131](#L2131) | 'name' => \_\_('Google Documents', 'cluevo'), |
| [2132](#L2132) | 'key' => 'gdocs', |
| [2133](#L2133) | 'icon' => plugins\_url("/images/icon-module-ui-gdocs\_256x256.png", plugin\_dir\_path(\_\_FILE\_\_)), |
| [2134](#L2134) | 'description' => \_\_('Install the CLUEVO Google Documents extension to use your Google Documents as modules in your LMS.', 'cluevo'), |
| [2135](#L2135) | 'field' => null, |
| [2136](#L2136) | 'filter' => null, |
| [2137](#L2137) | 'field-placeholder' => null, |
| [2138](#L2138) | 'button-label' => null, |
| [2139](#L2139) | 'alt-type' => "cluevo-lms-extension-gdocs", |
| [2140](#L2140) | 'alt-icon-class' => "extension", |
| [2141](#L2141) | 'alt-content' => '<p><a class="button button-primary cluevo-btn-install-type" href="' . esc\_attr(admin\_url('plugin-install.php?s=cluevo&tab=search&type=term')) . '">' . esc\_html\_\_("Install CLUEVO Google Docs extension", "cluevo") . '</a></p>' |
| [2142](#L2142) | ]; |
| [2143](#L2143) |  |
| [2144](#L2144) | $args["types"][] = $scorm12; |
| [2145](#L2145) | $args["types"][] = $scorm2004; |
| [2146](#L2146) | $args["types"][] = $audio; |
| [2147](#L2147) | $args["types"][] = $video; |
| [2148](#L2148) | $args["types"][] = $pdf; |
| [2149](#L2149) | $args["types"][] = $oembed; |
| [2150](#L2150) | $args["types"][] = $gdocs; |
| [2151](#L2151) | } |
| [2152](#L2152) |  |
| [2153](#L2153) | add\_action('cluevo\_register\_module\_types', 'cluevo\_register\_default\_module\_types', 0); |
| [2154](#L2154) | add\_action('cluevo\_lms\_item\_handle\_tools', function ($item) { |
| [2155](#L2155) | if (!is\_plugin\_active('cluevo-lms-extension-certificates/cluevo-lms-extension-certificates.php')) { ?> |
| [2156](#L2156) | <div class="cluevo-ext-tease cluevo-btn cluevo-btn-square" title="<?php esc\_attr\_e("Get the Certificates Extension", "cluevo"); ?>"><img class="plugin-logo" src="<?php echo plugins\_url("/images/cert.svg", \_\_DIR\_\_); ?>" /></div> |
| [2157](#L2157) | <?php |
| [2158](#L2158) | } |
| [2159](#L2159) | }); |
| [2160](#L2160) |  |
| [2161](#L2161) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php?format=txt)
* [Original Format](/export/3222497/cluevo-lms/tags/1.13.2/functions/functions.module-management.inc.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


