=== Content from www.wordfence.com_56a43bda_20250115_100351.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# kvCORE IDX <= 2.3.35 - Reflected Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   kvCORE IDX <= 2.3.35 - Reflected Cross-Site Scripting

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-11723](https://www.cve.org/CVERecord?id=CVE-2024-11723) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | December 11, 2024 |
| Last Updated | December 12, 2024 |
| Researcher | [vgo0](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/dale-mavers) |

### Description

The kvCORE IDX plugin for WordPress is vulnerable to Reflected Cross-Site Scripting via any parameter on pages with the kvcoreidx\_listings\_sitemap\_ranges, kvcoreidx\_listings\_sitemap\_page, kvcoreidx\_agent\_profile\_sitemap, or kvcoreidx\_agent\_profile shortcode present in all versions up to, and including, 2.3.35 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/kvcore-idx/includes/kvcore/class-actions.php#L1170)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkvcore-idx%2Fkvcore-idx-2335-reflected-cross-site-scripting&t=kvCORE%20IDX%20%3C%3D%202.3.35%20-%20Reflected%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkvcore-idx%2Fkvcore-idx-2335-reflected-cross-site-scripting&text=kvCORE%20IDX%20%3C%3D%202.3.35%20-%20Reflected%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fkvcore-idx%2Fkvcore-idx-2335-reflected-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for kvCORE IDX

#### [kvCORE IDX](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/kvcore-idx)

| Software Type | Plugin |
| --- | --- |
| Software Slug | kvcore-idx [(view on wordpress.org)](https://wordpress.org/plugins/kvcore-idx) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 2.3.35 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_aa46220d_20250115_100350.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fkvcore-idx%2Fincludes%2Fkvcore%2Fclass-actions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/kvcore-idx/includes/kvcore/class-actions.php?rev=2416165 "Revision 2416165")
* Next Revision →
* [Blame](/browser/kvcore-idx/includes/kvcore/class-actions.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/kvcore-idx/includes/kvcore/class-actions.php)

---

# [source:](/browser?order=name "Go to repository root") [kvcore-idx](/browser/kvcore-idx?order=name "View kvcore-idx")/[includes](/browser/kvcore-idx/includes?order=name "View includes")/[kvcore](/browser/kvcore-idx/includes/kvcore?order=name "View kvcore")/[class-actions.php](/browser/kvcore-idx/includes/kvcore/class-actions.php?order=name "View class-actions.php")

View diff against:

View revision:

| [Last change](/changeset/3042241/kvcore-idx/includes/kvcore/class-actions.php "View differences") on this file was [3042241](/changeset/3042241/ "View changeset 3042241"), checked in by insiderealestate, [11 months ago](/timeline?from=2024-02-27T23%3A40%3A55Z&precision=second "See timeline at 02/27/2024 11:40:55 PM") |
| --- |
| Version 2.3.33 |
| **File size:** 45.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | declare( strict\_types=1 ); |
| [3](#L3) |  |
| [4](#L4) | namespace kvCORE; |
| [5](#L5) |  |
| [6](#L6) | use kvCORE; |
| [7](#L7) |  |
| [8](#L8) | class Actions extends kvCORE\Instantiator { |
| [9](#L9) | protected static $instance       = null; |
| [10](#L10) | protected $mls                   = ''; |
| [11](#L11) | protected $mlsid                 = ''; |
| [12](#L12) | protected $listing               = ''; |
| [13](#L13) | protected $agent                 = null; |
| [14](#L14) | protected $isAgentProfileRequest = null; |
| [15](#L15) | protected $detailsPageId; |
| [16](#L16) | protected $contactFormPageId; |
| [17](#L17) | protected $marketReportPageId; |
| [18](#L18) | protected $propertiesPageId; |
| [19](#L19) |  |
| [20](#L20) | public function \_\_construct() { |
| [21](#L21) | add\_action( 'template\_redirect', array( $this, 'pre\_process\_sitemap\_shortcode' ), 100 ); |
| [22](#L22) | add\_action( |
| [23](#L23) | 'kvcoreidx/activate', |
| [24](#L24) | function ( $new\_version, $old\_version = null ) { |
| [25](#L25) | // plugin was activated |
| [26](#L26) | // update or create areas table if not already done |
| [27](#L27) | kvCORE\Areas\_Table::maybe\_create\_or\_update\_database(); |
| [28](#L28) | }, |
| [29](#L29) | 10, |
| [30](#L30) | 2 |
| [31](#L31) | ); |
| [32](#L32) |  |
| [33](#L33) | add\_action( |
| [34](#L34) | 'kvcoreidx/deactivate', |
| [35](#L35) | function ( $new\_version, $old\_version = null ) { |
| [36](#L36) | // plugin was deactivated |
| [37](#L37) | }, |
| [38](#L38) | 10, |
| [39](#L39) | 2 |
| [40](#L40) | ); |
| [41](#L41) |  |
| [42](#L42) | add\_action( |
| [43](#L43) | 'kvcoreidx/update', |
| [44](#L44) | function ( $new\_version, $old\_version = null ) { |
| [45](#L45) | // plugin was updated |
| [46](#L46) | // update or create areas table if not already done |
| [47](#L47) | kvCORE\Areas\_Table::maybe\_create\_or\_update\_database(); |
| [48](#L48) | }, |
| [49](#L49) | 10, |
| [50](#L50) | 2 |
| [51](#L51) | ); |
| [52](#L52) |  |
| [53](#L53) | add\_action( 'init', array( 'kvCORE\Activation', 'maybe\_update' ), 5, 0 ); |
| [54](#L54) | add\_action( 'init', array( $this, 'initialize\_admin' ) ); |
| [55](#L55) | add\_action( 'init', array( $this, 'register\_rewrites' ), 10, 0 ); |
| [56](#L56) | add\_action( 'init', array( $this, 'update\_permalinks' ) ); |
| [57](#L57) |  |
| [58](#L58) | add\_action( 'rest\_api\_init', array( $this, 'register\_rest\_api\_endpoints' ) ); |
| [59](#L59) | add\_action( 'rest\_api\_init', array( $this, 'settings\_info' ) ); |
| [60](#L60) |  |
| [61](#L61) | add\_action( 'wp\_enqueue\_scripts', array( 'kvCORE\Settings', 'output\_brand\_css' ), 50 ); |
| [62](#L62) | add\_action( 'wp\_enqueue\_scripts', array( 'kvCORE\Settings\Custom\_Templates', 'output\_custom\_templates\_js' ), 50 ); |
| [63](#L63) | add\_action( 'wp\_head', array( $this, 'maybe\_output\_share\_meta' ) ); |
| [64](#L64) | add\_action( 'wp\_head', array( $this, 'set\_listing\_data\_meta' ), -5 ); |
| [65](#L65) | add\_action( 'widgets\_init', array( $this, 'listing\_detail\_sidebar' ) ); |
| [66](#L66) | add\_action( 'wp\_head', array( $this, 'set\_homepage\_json' ), -5 ); |
| [67](#L67) |  |
| [68](#L68) | add\_action( 'wp\_head', array( $this, 'set\_agent\_meta\_data' ), -5 ); |
| [69](#L69) | add\_action( 'wp\_head', array( $this, 'set\_sitemap\_canonical' ), -5 ); |
| [70](#L70) |  |
| [71](#L71) | // This \*should\* over-ride yoast seo meta stuff - ZF: It does. |
| [72](#L72) | add\_filter( 'wpseo\_title', array( $this, 'set\_meta\_title\_yoast' ) ); |
| [73](#L73) | add\_filter( 'wpseo\_opengraph\_image', array( $this, 'set\_agent\_meta\_image' ) ); |
| [74](#L74) | add\_filter( 'wpseo\_opengraph\_image', array( $this, 'set\_listing\_image' ) ); |
| [75](#L75) | add\_filter( 'wpseo\_metakey', array( $this, 'set\_agent\_keywords' ) ); |
| [76](#L76) | add\_filter( 'wpseo\_canonical', array( $this, 'yoast\_remove\_canonical\_items' ) ); |
| [77](#L77) | add\_filter( 'wpseo\_opengraph\_url', array( $this, 'set\_listing\_url' ) ); |
| [78](#L78) | add\_filter( 'wpseo\_opengraph\_desc', array( $this, 'set\_listing\_description' ) ); |
| [79](#L79) | add\_action( 'wpseo\_add\_opengraph\_additional\_images', array( $this, 'default\_og\_image' ) ); // ZF: workaround, see function. |
| [80](#L80) |  |
| [81](#L81) | add\_filter( 'document\_title\_parts', array( $this, 'set\_page\_titles' ) ); |
| [82](#L82) | add\_action( 'wp\_head', array( $this, 'remove\_header\_links' ), 2 ); |
| [83](#L83) |  |
| [84](#L84) | add\_action( 'init', array( $this, 'maybe\_flush\_rewrite\_rules' ) ); |
| [85](#L85) | add\_action( 'save\_post', array( $this, 'save\_post' ) ); |
| [86](#L86) | add\_action( 'template\_redirect', array( $this, 'handle\_contact\_and\_marketreport\_urls' ) ); |
| [87](#L87) |  |
| [88](#L88) | add\_filter( 'jetpack\_photon\_skip\_image', array( $this, 'disable\_photon\_cdn' ), 10, 3 ); |
| [89](#L89) | add\_action( 'wp\_head', array( $this, 'prefetch\_img\_kvcore\_com' ), 0 ); |
| [90](#L90) |  |
| [91](#L91) |  |
| [92](#L92) |  |
| [93](#L93) | new Shortcode\Search(); |
| [94](#L94) | new Shortcode\Prequalify(); |
| [95](#L95) | new Shortcode\Properties(); |
| [96](#L96) | new Shortcode\Display\_Properties(); |
| [97](#L97) | new Shortcode\Offices(); |
| [98](#L98) | new Shortcode\Team(); |
| [99](#L99) | new Shortcode\Agent\_Profile(); |
| [100](#L100) | new Shortcode\Agent\_Search(); |
| [101](#L101) | new Shortcode\User\_Profile(); |
| [102](#L102) | new Shortcode\Mls\_Disclaimer(); |
| [103](#L103) | new Shortcode\Mortgage\_Calculator(); |
| [104](#L104) | new Shortcode\Market\_Report(); |
| [105](#L105) | new Shortcode\Site\_Map\_Index(); |
| [106](#L106) | new Shortcode\Market\_Report\_Search(); |
| [107](#L107) | new Shortcode\Valuation\_Report(); |
| [108](#L108) | new Shortcode\Valuation\_Pdf\_Search(); |
| [109](#L109) | new Shortcode\Valuation\_Pdf(); |
| [110](#L110) | new Shortcode\Contact\_Form(); |
| [111](#L111) | new Shortcode\Properties\_Crawlable(); |
| [112](#L112) | new Shortcode\Listings\_Sitemap(); |
| [113](#L113) | new Shortcode\Agent\_Profile\_Sitemap(); |
| [114](#L114) | new Shortcode\Listing\_Sitemap\_Base(); |
| [115](#L115) |  |
| [116](#L116) | new Shortcode\Listing\_Detail(); |
| [117](#L117) | new Shortcode\Listing\_Detail\Header(); |
| [118](#L118) | new Shortcode\Listing\_Detail\Header\Slider(); |
| [119](#L119) | new Shortcode\Listing\_Detail\Header\Detail(); |
| [120](#L120) | new Shortcode\Listing\_Detail\Details(); |
| [121](#L121) | new Shortcode\Listing\_Detail\Details\Home\_Details(); |
| [122](#L122) | new Shortcode\Listing\_Detail\Details\Property\_Location(); |
| [123](#L123) | new Shortcode\Listing\_Detail\Details\Similar\_Properties(); |
| [124](#L124) | new Shortcode\Listing\_Detail\Details\Listing\_Agent(); |
| [125](#L125) |  |
| [126](#L126) | new Shortcode\Partial(); |
| [127](#L127) |  |
| [128](#L128) | new Shortcode\Area(); |
| [129](#L129) | new Widget\Login(); |
| [130](#L130) | } |
| [131](#L131) |  |
| [132](#L132) | public function prefetch\_img\_kvcore\_com() { |
| [133](#L133) | echo '<meta http-equiv="x-dns-prefetch-control" content="on">'; |
| [134](#L134) | echo "\r\n"; |
| [135](#L135) | echo '<link rel="dns-prefetch" href="//img.kvcore.com" />'; |
| [136](#L136) | echo "\r\n"; |
| [137](#L137) | } |
| [138](#L138) |  |
| [139](#L139) | /\*\* |
| [140](#L140) | \* Disable Photon CDN (img.kvcore.com is already a CDN) |
| [141](#L141) | \* |
| [142](#L142) | \* @see https://developer.jetpack.com/hooks/jetpack\_photon\_skip\_image/ |
| [143](#L143) | \* |
| [144](#L144) | \* @param bool $val   Should Photon ignore this image. Default to false. |
| [145](#L145) | \* @param string $src Image URL. |
| [146](#L146) | \* @param string $tag Image Tag (Image HTML output). |
| [147](#L147) | \* |
| [148](#L148) | \* @return bool       True if source is img-kvcore.com |
| [149](#L149) | \*/ |
| [150](#L150) | public function disable\_photon\_cdn ( $val, $src, $tag ) { // phpcs:ignore Generic.CodeAnalysis.UnusedFunctionParameter.FoundInExtendedClassAfterLastUsed |
| [151](#L151) | $parse = parse\_url( $src ); |
| [152](#L152) | $img\_domain = $parse[ 'host' ]; |
| [153](#L153) |  |
| [154](#L154) | if ( $img\_domain == 'img.kvcore.com' ) { |
| [155](#L155) | return true; |
| [156](#L156) | } |
| [157](#L157) |  |
| [158](#L158) | return $val; |
| [159](#L159) | } |
| [160](#L160) |  |
| [161](#L161) | /\*\* |
| [162](#L162) | \* Purpose: This will send urls like contact.php and market-report.php to the WordPress pages for those |
| [163](#L163) | \*/ |
| [164](#L164) | public function handle\_contact\_and\_marketreport\_urls() { |
| [165](#L165) | if ( is\_404() ) { |
| [166](#L166) | $urlCheck    = $\_SERVER['REQUEST\_URI']; |
| [167](#L167) | $queryString = $\_SERVER['QUERY\_STRING'] ? '?' . $\_SERVER['QUERY\_STRING'] : ''; |
| [168](#L168) | if ( strpos( $urlCheck, 'contact.php' ) !== false ) { |
| [169](#L169) | $contact\_page\_url = trailingslashit( get\_permalink( $this->contactFormPageId ) ); |
| [170](#L170) | wp\_redirect( $contact\_page\_url . $queryString, 301 ); |
| [171](#L171) | } |
| [172](#L172) | if ( strpos( $urlCheck, 'market-report.php' ) !== false ) { |
| [173](#L173) | $market\_report\_page\_url = trailingslashit( get\_permalink( $this->marketReportPageId ) ); |
| [174](#L174) | wp\_redirect( $market\_report\_page\_url . $queryString, 301 ); |
| [175](#L175) | } |
| [176](#L176) | } |
| [177](#L177) | } |
| [178](#L178) |  |
| [179](#L179) | /\*\* |
| [180](#L180) | \* Purpose: This will pre process the sitemap shortcode to redirect to the S3 bucket where the sitemap is located. |
| [181](#L181) | \*/ |
| [182](#L182) | function pre\_process\_sitemap\_shortcode() { |
| [183](#L183) | if ( ! is\_singular() ) { |
| [184](#L184) | return; |
| [185](#L185) | } |
| [186](#L186) | if ( $this->check\_for\_shortcodes( array( 'kvcoreidx\_site\_map\_index' ) ) ) { |
| [187](#L187) |  |
| [188](#L188) | // We need website domain from this endpoint. |
| [189](#L189) | $response = Api::request( 'POST', 'public/domain' ); |
| [190](#L190) |  |
| [191](#L191) | // Permanent redirect to S3 bucket. |
| [192](#L192) | header( 'Location: ' . "https://s3.amazonaws.com/kunversion-frontend-sitemaps/{$response->domain}/sitemap-index.xml", true, 301 ); |
| [193](#L193) | die(); |
| [194](#L194) | } |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | public function maybe\_update() { |
| [198](#L198) | if ( KVCORE\_IDX\_PLUGIN\_VERSION !== Settings::get\_plugin\_version() ) { |
| [199](#L199) | Settings::update\_plugin\_version( KVCORE\_IDX\_PLUGIN\_VERSION ); |
| [200](#L200) | } |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | public function initialize\_admin() { |
| [204](#L204) | if ( is\_admin() ) { |
| [205](#L205) | new Admin\Page\Settings(); |
| [206](#L206) |  |
| [207](#L207) | if ( Admin::allow\_custom\_templates() ) { |
| [208](#L208) | new Admin\Page\Settings\Custom\_Templates(); |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | new Admin\Page\Settings\Hotsheets(); |
| [212](#L212) |  |
| [213](#L213) | add\_action( 'admin\_enqueue\_scripts', array( 'kvCORE\Admin', 'enqueue\_scripts' ) ); |
| [214](#L214) | add\_action( 'admin\_enqueue\_scripts', array( 'kvCORE\Admin', 'enqueue\_styles' ) ); |
| [215](#L215) | } |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | public function register\_rewrites() { |
| [219](#L219) | $details\_page\_id              = Settings::get\_setting( 'listing\_detail\_page' ); |
| [220](#L220) | $this->detailsPageId          = $details\_page\_id; |
| [221](#L221) | $properties\_page\_id           = Settings::get\_setting( 'properties\_page' ); |
| [222](#L222) | $contact\_form\_page\_id         = Settings::get\_setting( 'contact\_form\_page' ); |
| [223](#L223) | $this->contactFormPageId      = $contact\_form\_page\_id; |
| [224](#L224) | $market\_report\_page\_id        = Settings::get\_setting( 'market\_report\_page' ); |
| [225](#L225) | $this->marketReportPageId     = $market\_report\_page\_id; |
| [226](#L226) | $this->propertiesPageId       = $properties\_page\_id; |
| [227](#L227) | $agent\_page\_id                = Settings::get\_setting( 'agent\_profile\_page' ); |
| [228](#L228) | $this->agentPageId            = $agent\_page\_id; |
| [229](#L229) | $exclusives\_page\_id           = Settings::get\_setting( 'exclusives\_page' ); |
| [230](#L230) | $exclusive\_detail\_page\_id     = Settings::get\_setting( 'exclusive\_detail\_page' ); |
| [231](#L231) | $sell\_page\_id                 = Settings::get\_setting( 'valuation\_pdf\_page' ); |
| [232](#L232) | $profile\_page\_id              = Settings::get\_setting( 'user\_profile\_page' ); |
| [233](#L233) | $listing\_sitemap\_base\_page\_id = Settings::get\_setting( 'listings\_sitemap\_ranges\_page' ); |
| [234](#L234) | $listing\_sitemap\_page\_id      = Settings::get\_setting( 'listings\_sitemap\_page' ); |
| [235](#L235) | $agent\_sitemap\_page           = Settings::get\_setting( 'agents\_sitemap\_page' ); |
| [236](#L236) | $area\_page                    = Settings::get\_setting( 'area\_page' ); |
| [237](#L237) |  |
| [238](#L238) | $details\_page\_slug          = get\_post\_field( 'post\_name', $details\_page\_id ); |
| [239](#L239) | $properties\_page\_slug       = get\_post\_field( 'post\_name', $properties\_page\_id ); |
| [240](#L240) | $agent\_page\_slug            = get\_post\_field( 'post\_name', $agent\_page\_id ); |
| [241](#L241) | $exclusives\_page\_slug       = get\_post\_field( 'post\_name', $exclusives\_page\_id ); |
| [242](#L242) | $exclusive\_detail\_page\_slug = get\_post\_field( 'post\_name', $exclusive\_detail\_page\_id ); |
| [243](#L243) | $area\_page\_slug             = get\_post\_field( 'post\_name', $area\_page ); |
| [244](#L244) |  |
| [245](#L245) | add\_rewrite\_tag( '%by-mls%', '([0-9]+)' ); |
| [246](#L246) | add\_rewrite\_tag( '%mls%', '([0-9]+)' ); |
| [247](#L247) | add\_rewrite\_tag( '%by-mlsid%', '([0-9]+)' ); |
| [248](#L248) | add\_rewrite\_tag( '%mlsid%', '([0-9]+)' ); |
| [249](#L249) | add\_rewrite\_tag( '%team-member%', '([0-9]+)' ); |
| [250](#L250) | add\_rewrite\_tag( '%area%', '([^/]+)' ); |
| [251](#L251) | add\_rewrite\_tag( '%areas%', '([^/]+)' ); |
| [252](#L252) | add\_rewrite\_tag( '%pak%', '([^/]+)' ); |
| [253](#L253) | add\_rewrite\_tag( '%polygonKey%', '([^/]+)' ); |
| [254](#L254) | add\_rewrite\_tag( '%listings-exclusives%', '([^/]+)' ); |
| [255](#L255) | add\_rewrite\_tag( '%exclusive-listing-id%', '([0-9]+)' ); |
| [256](#L256) | add\_rewrite\_tag( '%priceMin%', '([0-9]+)' ); |
| [257](#L257) | add\_rewrite\_tag( '%min%', '([0-9]+)' ); |
| [258](#L258) | add\_rewrite\_tag( '%max%', '([0-9]+)' ); |
| [259](#L259) | add\_rewrite\_tag( '%priceMax%', '([0-9]+)' ); |
| [260](#L260) | add\_rewrite\_tag( '%beds%', '([0-9]+)' ); |
| [261](#L261) | add\_rewrite\_tag( '%baths%', '([0-9]+)' ); |
| [262](#L262) | add\_rewrite\_tag( '%minacres%', '([0-9]+)' ); |
| [263](#L263) | add\_rewrite\_tag( '%maxacres%', '([0-9]+)' ); |
| [264](#L264) | add\_rewrite\_tag( '%acresMin%', '([0-9]+)' ); |
| [265](#L265) | add\_rewrite\_tag( '%acresMax%', '([0-9]+)' ); |
| [266](#L266) | add\_rewrite\_tag( '%minfootage%', '([0-9]+)' ); |
| [267](#L267) | add\_rewrite\_tag( '%maxfootage%', '([0-9]+)' ); |
| [268](#L268) | add\_rewrite\_tag( '%footageMax%', '([0-9]+)' ); |
| [269](#L269) | add\_rewrite\_tag( '%footageMin%', '([0-9]+)' ); |
| [270](#L270) | add\_rewrite\_tag( '%disable\_reg%', '([0-9]+)' ); |
| [271](#L271) | add\_rewrite\_tag( '%noreg%', '([0-9]+)' ); |
| [272](#L272) | add\_rewrite\_tag( '%vowKey%', '([0-9]+)' ); |
| [273](#L273) | add\_rewrite\_tag( '%view\_timing%', '([0-9]+)' ); |
| [274](#L274) | add\_rewrite\_tag( '%searchtype%', '([^/]+)' ); |
| [275](#L275) | add\_rewrite\_tag( '%ourListings%', '([0-9]+)' ); |
| [276](#L276) | add\_rewrite\_tag( '%types%', '([0-9]+)' ); |
| [277](#L277) | add\_rewrite\_tag( '%paginate%', '([0-9]+)' ); |
| [278](#L278) | add\_rewrite\_tag( '%type%', '[^/]+)' ); |
| [279](#L279) | add\_rewrite\_tag( '%propertyTypes%', '([0-9]+)' ); |
| [280](#L280) | add\_rewrite\_tag( '%paginate%', '([0-9]+)' ); |
| [281](#L281) | add\_rewrite\_tag( '%key%', '([^/]+)' ); |
| [282](#L282) | add\_rewrite\_tag( '%styles%', '([^/]+)' ); |
| [283](#L283) | add\_rewrite\_tag( '%options%', '([^/]+)' ); |
| [284](#L284) | add\_rewrite\_tag( '%mlsids%', '([^/]+)' ); |
| [285](#L285) | add\_rewrite\_tag( '%subType%', '([0-9]+)' ); |
| [286](#L286) | add\_rewrite\_tag( '%polygons%', '([^/]+)' ); |
| [287](#L287) | add\_rewrite\_tag( '%sub%', '([0,1])' ); |
| [288](#L288) | add\_rewrite\_tag( '%showalerts%', '([1,2])' ); |
| [289](#L289) | add\_rewrite\_tag( '%pass%', '([1,2])' ); |
| [290](#L290) | add\_rewrite\_tag( '%filter%', '([^/]+)' ); |
| [291](#L291) | add\_rewrite\_tag( '%entityName%', '([^/]+)' ); |
| [292](#L292) | add\_rewrite\_tag( '%entity%', '([^/]+)' ); |
| [293](#L293) | add\_rewrite\_tag( '%buildingStyles%', '([^/]+)' ); |
| [294](#L294) | add\_rewrite\_tag( '%keywords%', '([^/]+)' ); |
| [295](#L295) |  |
| [296](#L296) | add\_rewrite\_tag( '%areaslug%', '([^/]+)' ); |
| [297](#L297) |  |
| [298](#L298) | add\_rewrite\_rule( '^' . $details\_page\_slug . '/([^\-]+)-([^\-]+)-?(.+)?/?', 'index.php?page\_id=' . $details\_page\_id . '&action=get-details&by-mls=$matches[1]&by-mlsid=$matches[2]', 'top' ); |
| [299](#L299) |  |
| [300](#L300) | add\_rewrite\_rule( '^' . $properties\_page\_slug . '/([^/]+)/([^/]+)/?', 'index.php?page\_id=' . $properties\_page\_id . '&area=$matches[1]|$matches[2]', 'top' ); |
| [301](#L301) |  |
| [302](#L302) | add\_rewrite\_rule( '^' . $agent\_page\_slug . '/([0-9]+)-([^/\.]+)/?', 'index.php?page\_id=' . $agent\_page\_id . '&team-member=$matches[1]', 'top' ); |
| [303](#L303) |  |
| [304](#L304) | add\_rewrite\_rule( '^' . $exclusives\_page\_slug . '/([^/]+)/?', 'index.php?page\_id=' . $exclusives\_page\_id . '&listings-exclusives=$matches[1]', 'top' ); |
| [305](#L305) |  |
| [306](#L306) | add\_rewrite\_rule( '^' . $exclusive\_detail\_page\_slug . '/([0-9]+)-([^/\.]+)/?', 'index.php?page\_id=' . $exclusive\_detail\_page\_id . '&exclusive-listing-id=$matches[1]', 'top' ); |
| [307](#L307) |  |
| [308](#L308) | add\_rewrite\_rule( '^details' . '/([^\-]+)-([^\-]+)-?(.+)?/?', 'index.php?page\_id=' . $details\_page\_id . '&action=get-details&by-mls=$matches[1]&by-mlsid=$matches[2]', 'top' ); |
| [309](#L309) |  |
| [310](#L310) | add\_rewrite\_rule( '^settings', 'index.php?page\_id=' . $profile\_page\_id, 'top' ); |
| [311](#L311) |  |
| [312](#L312) | add\_rewrite\_rule( '^sell/', 'index.php?page\_id=' . $sell\_page\_id, 'top' ); |
| [313](#L313) |  |
| [314](#L314) | add\_rewrite\_rule( '^index', 'index.php?page\_id=' . $properties\_page\_id, 'top' ); |
| [315](#L315) |  |
| [316](#L316) | add\_rewrite\_rule( '^details', 'index.php?page\_id=' . $details\_page\_id, 'top' ); |
| [317](#L317) |  |
| [318](#L318) | add\_rewrite\_rule( '^listings-sitemap/homes-in-([^\-]+)-from-([0-9]+)-to-([0-9]+)', 'index.php?page\_id=' . $listing\_sitemap\_page\_id . '&min=$matches[2]&max=$matches[3]&filter=$matches[1]', 'top' ); |
| [319](#L319) | add\_rewrite\_rule( '^listings-sitemap/homes-in-([^\-]+)-from-([0-9]+)', 'index.php?page\_id=' . $listing\_sitemap\_page\_id . '&filter=$matches[1]&min=$matches[2]', 'top' ); |
| [320](#L320) | add\_rewrite\_rule( '^listings-sitemap/homes-in-([^\-]+)', 'index.php?page\_id=' . $listing\_sitemap\_base\_page\_id . '&pass=3&filter=$matches[1]', 'top' ); |
| [321](#L321) | add\_rewrite\_rule( '^listings-sitemap/([^\-]+)', 'index.php?page\_id=' . $listing\_sitemap\_base\_page\_id . '&pass=2&filter=$matches[1]', 'top' ); |
| [322](#L322) | add\_rewrite\_rule( '^listings-sitemap/', 'index.php?page\_id=' . $listing\_sitemap\_base\_page\_id, 'top' ); |
| [323](#L323) |  |
| [324](#L324) | add\_rewrite\_rule( '^agents-sitemap/agents-in-([^\-]+)', 'index.php?page\_id=' . $agent\_sitemap\_page . 'pass=2&entityName=$matches[1]', 'top' ); |
| [325](#L325) | add\_rewrite\_rule( '^agents-sitemap/', 'index.php?page\_id=' . $agent\_sitemap\_page, 'top' ); |
| [326](#L326) |  |
| [327](#L327) | if ( $area\_page\_slug && KVCORE\_IDX\_ENABLE\_AREA\_PAGES ) { |
| [328](#L328) | add\_rewrite\_rule( '^' . $area\_page\_slug . '/([^/]+)', 'index.php?page\_id=' . $area\_page . '&areaslug=$matches[1]', 'top' ); |
| [329](#L329) | } |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | public function register\_rest\_api\_endpoints() { |
| [333](#L333) | Rest\v1\Add\_Hotsheet::init(); |
| [334](#L334) | Rest\v1\Area\_Page::init(); |
| [335](#L335) | Rest\v1\Create\_Required\_Pages::init(); |
| [336](#L336) | Rest\v1\Get\_Lat\_Lng\_From\_Address::init(); |
| [337](#L337) | Rest\v1\kvCORE\_API\_Proxy::init(); |
| [338](#L338) | Rest\v1\Save\_Hotsheets::init(); |
| [339](#L339) | Rest\v1\Social\_Login::init(); |
| [340](#L340) | Rest\v1\Zillow\_Valuation::init(); |
| [341](#L341) | Rest\v1\Area\_Pages::init(); |
| [342](#L342) | } |
| [343](#L343) |  |
| [344](#L344) | public function settings\_info() { |
| [345](#L345) | register\_rest\_route( |
| [346](#L346) | 'idx', |
| [347](#L347) | 'meta', |
| [348](#L348) | array( |
| [349](#L349) | 'methods'             => 'GET', |
| [350](#L350) | 'callback'            => array( $this, 'idx\_settings\_response' ), |
| [351](#L351) | 'permission\_callback' => array( $this, 'auth\_callback' ), |
| [352](#L352) | ) |
| [353](#L353) | ); |
| [354](#L354) | } |
| [355](#L355) |  |
| [356](#L356) | public function auth\_callback( \WP\_REST\_Request $request ) { |
| [357](#L357) | if ( function\_exists( 'apache\_request\_headers' ) ) { |
| [358](#L358) | $bearerToken = apache\_request\_headers()['Authorization'] ?? ''; |
| [359](#L359) | $bearerToken = explode( ' ', $bearerToken ); |
| [360](#L360) | return count( $bearerToken ) === 2 && $bearerToken[1] === Settings::get\_api\_key(); |
| [361](#L361) | } |
| [362](#L362) | return false; |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | public function idx\_settings\_response() { |
| [366](#L366) | $settings                   = Settings::get\_settings(); |
| [367](#L367) | $settings['plugin\_version'] = KVCORE\_IDX\_PLUGIN\_VERSION; |
| [368](#L368) | $settings['php\_version']    = phpversion(); |
| [369](#L369) | return rest\_ensure\_response( $settings ); |
| [370](#L370) | } |
| [371](#L371) |  |
| [372](#L372) | /\*\* |
| [373](#L373) | \* This function will properly modify the title tag for certain pages for better seo, way we had it before created two title tags. |
| [374](#L374) | \*/ |
| [375](#L375) | public function set\_page\_titles( $title\_parts\_array ) { |
| [376](#L376) | $siteName = get\_bloginfo( 'name' ); |
| [377](#L377) |  |
| [378](#L378) | if ( $this->detailsPageId == get\_the\_ID() ) { |
| [379](#L379) | $listing                    = $this->listing; |
| [380](#L380) | $address = isset($listing['address']) ? $listing['address'] : ""; |
| [381](#L381) | $city = isset($listing['city']) ? $listing['city'] : ""; |
| [382](#L382) | $state = isset($listing['state']) ? $listing['state'] : ""; |
| [383](#L383) | $zip = isset($listing['zip']) ? $listing['zip'] : ""; |
| [384](#L384) | $mlsid = isset($listing['mlsid']) ? $listing['mlsid'] : ""; |
| [385](#L385) | $fullAddress                = "{$address}, {$city}, {$state} {$zip}"; |
| [386](#L386) | $title\_parts\_array['title'] = "{$fullAddress} | MLS# {$mlsid} "; |
| [387](#L387) | $title\_parts\_array['site']  = "{$siteName}"; |
| [388](#L388) | return $title\_parts\_array; |
| [389](#L389) | } |
| [390](#L390) |  |
| [391](#L391) | if ( $this->agentPageId == get\_the\_ID() ) { |
| [392](#L392) | $agent                      = $this->agent; |
| [393](#L393) | $title\_parts\_array['title'] = ! empty( $agent->office->data ) |
| [394](#L394) | ? "{$agent->first\_name} {$agent->last\_name}, {$agent->office->data->name} Real Estate Agent | {$siteName}" |
| [395](#L395) | : "{$agent->first\_name} {$agent->last\_name}, Real Estate Agent | {$siteName}"; |
| [396](#L396) | $title\_parts\_array['site']  = ''; // has to be set this way for the | above |
| [397](#L397) | return $title\_parts\_array; |
| [398](#L398) | } |
| [399](#L399) | return $title\_parts\_array; |
| [400](#L400) |  |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | public function set\_homepage\_json() { |
| [404](#L404) | $url  = empty( $\_SERVER['HTTPS'] ) || $\_SERVER['HTTPS'] == 'off' ? 'http' : 'https'; |
| [405](#L405) | $url .= '://' . $\_SERVER['HTTP\_HOST']; |
| [406](#L406) |  |
| [407](#L407) | if ( is\_front\_page() ) { |
| [408](#L408) |  |
| [409](#L409) | $data        = Api::request( 'GET', 'public/company/', array() ); |
| [410](#L410) | $companyData = $data->data; |
| [411](#L411) |  |
| [412](#L412) | $content             = array(); |
| [413](#L413) | $content['@context'] = 'https://schema.org'; |
| [414](#L414) | $content['@type']    = 'RealEstateAgent'; |
| [415](#L415) |  |
| [416](#L416) | $content2             = array(); |
| [417](#L417) | $content2['@context'] = 'https://schema.org'; |
| [418](#L418) | $content2['@type']    = 'Organization'; |
| [419](#L419) |  |
| [420](#L420) | if ( $companyData->name ) { |
| [421](#L421) | $content['name'] = $companyData->name; |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | $content['address'] = array( |
| [425](#L425) | '@type' => 'PostalAddress', |
| [426](#L426) | ); |
| [427](#L427) |  |
| [428](#L428) | if ( $companyData->address ) { |
| [429](#L429) | $content['address']['streetAddress'] = $companyData->address; |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | if ( $companyData->city ) { |
| [433](#L433) | $content['address']['addressLocality'] = $companyData->city; |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | if ( $companyData->state ) { |
| [437](#L437) | $content['address']['addressRegion'] = $companyData->state; |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | if ( $companyData->zip ) { |
| [441](#L441) | $content['address']['postalCode'] = $companyData->zip; |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | if ( $companyData->photo ) { |
| [445](#L445) | $content['image'] = $companyData->photo; |
| [446](#L446) | $content2['logo'] = $companyData->photo; |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | if ( $companyData->email ) { |
| [450](#L450) | $content['email'] = $companyData->email; |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | if ( $companyData->phone ) { |
| [454](#L454) | $content['telePhone'] = $companyData->phone; |
| [455](#L455) | } |
| [456](#L456) |  |
| [457](#L457) | if ( $companyData->fax ) { |
| [458](#L458) | $content['faxNumber'] = $companyData->fax; |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | if ( $url ) { |
| [462](#L462) | $content['url']  = $url; |
| [463](#L463) | $content2['url'] = $url; |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | if ( $companyData->lat && $companyData->lng ) { |
| [467](#L467) | $content['geo'] = array( |
| [468](#L468) | '@type'     => 'GeoCoordinates', |
| [469](#L469) | 'latitude'  => $companyData->lat, |
| [470](#L470) | 'longitude' => $companyData->lng, |
| [471](#L471) | ); |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | echo '<script type="application/ld+json">' . json\_encode( $content, JSON\_UNESCAPED\_SLASHES ) . '</script>'; |
| [475](#L475) | echo '<script type="application/ld+json">' . json\_encode( $content2, JSON\_UNESCAPED\_SLASHES ) . '</script>'; |
| [476](#L476) | } |
| [477](#L477) | } |
| [478](#L478) |  |
| [479](#L479) | /\*\* |
| [480](#L480) | \* Fix for when we don't have a default OG image defined in Yoast SEO |
| [481](#L481) | \* |
| [482](#L482) | \* Either a bug or a feature, depending on interpretation... |
| [483](#L483) | \* |
| [484](#L484) | \* @see https://github.com/Yoast/wordpress-seo/issues/392#issuecomment-146634436 |
| [485](#L485) | \* |
| [486](#L486) | \* @param object $image |
| [487](#L487) | \* |
| [488](#L488) | \* @return void |
| [489](#L489) | \*/ |
| [490](#L490) | public function default\_og\_image( $image ) { |
| [491](#L491) |  |
| [492](#L492) | if ( ! $image->has\_images() ) { |
| [493](#L493) | $image->add\_image( 'default' ); // this can be whatever you want it to be as long as it isn't falsey |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | /\*\* |
| [499](#L499) | \* Fire the Yoast SEO hook to change the og:url link for a property |
| [500](#L500) | \* |
| [501](#L501) | \* @see https://gist.github.com/amboutwe/811e92b11e5277977047d44ea81ee9d4#file-yoast\_seo\_opengraph\_change\_protocol-php. |
| [502](#L502) | \* |
| [503](#L503) | \* @param string $url As generated by Yoast. |
| [504](#L504) | \* |
| [505](#L505) | \* @return sring      Fixed URL. |
| [506](#L506) | \*/ |
| [507](#L507) | public function set\_listing\_url( $url ) { |
| [508](#L508) |  |
| [509](#L509) | if ( ! $this->check\_for\_listing\_detail() ) { |
| [510](#L510) | return $url; |
| [511](#L511) | } |
| [512](#L512) |  |
| [513](#L513) | $this->set\_listing(); |
| [514](#L514) |  |
| [515](#L515) | $listing            = $this->listing; |
| [516](#L516) | $detail\_page\_url    = trailingslashit( get\_permalink( $this->detailsPageId ) ); |
| [517](#L517) | $listing\_detail\_url = $detail\_page\_url . $listing['mls'] . '-' . $listing['mlsid'] . '-' . $this->get\_slug( $listing['address'] ) . '-' . $this->get\_slug( $listing['city'] ) . '-' . $listing['state'] . '-' . $listing['zip']; |
| [518](#L518) |  |
| [519](#L519) | return $listing\_detail\_url; |
| [520](#L520) |  |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | /\*\* |
| [524](#L524) | \* Fire the Yoast SEO hook to change the og:image url for a property |
| [525](#L525) | \* |
| [526](#L526) | \* @see https://gist.github.com/amboutwe/811e92b11e5277977047d44ea81ee9d4#file-yoast\_seo\_opengraph\_change\_protocol-php. |
| [527](#L527) | \* |
| [528](#L528) | \* @param string $url As generated by Yoast. |
| [529](#L529) | \* |
| [530](#L530) | \* @return sring      Fixed URL. |
| [531](#L531) | \*/ |
| [532](#L532) | public function set\_listing\_image( $url ) { |
| [533](#L533) |  |
| [534](#L534) | if ( ! $this->check\_for\_listing\_detail() ) { |
| [535](#L535) | return $url; |
| [536](#L536) | } |
| [537](#L537) |  |
| [538](#L538) | $this->set\_listing(); |
| [539](#L539) |  |
| [540](#L540) | $listing   = $this->listing; |
| [541](#L541) | $meta\_image = $listing['photos']['data'][0]['url'] ?? ''; |
| [542](#L542) |  |
| [543](#L543) | return $meta\_image ?? $url; |
| [544](#L544) |  |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | /\*\* |
| [548](#L548) | \* Fire the Yoast SEO hook to change the og:description for a property |
| [549](#L549) | \* |
| [550](#L550) | \* @param string $description As generated by Yoast. |
| [551](#L551) | \* |
| [552](#L552) | \* @return sring              Fixed description. |
| [553](#L553) | \*/ |
| [554](#L554) | public function set\_listing\_description( $description ) { |
| [555](#L555) |  |
| [556](#L556) | if ( ! $this->check\_for\_listing\_detail() ) { |
| [557](#L557) | return $description; |
| [558](#L558) | } |
| [559](#L559) |  |
| [560](#L560) | $this->set\_listing(); |
| [561](#L561) |  |
| [562](#L562) | $listing = $this->listing; |
| [563](#L563) |  |
| [564](#L564) | $neighborhood    = ! empty( $listing['neighborhood'] ) ? " in the beautiful neighborhood of {$listing['neighborhood']}." : '.'; |
| [565](#L565) | $full\_address     = "{$listing['address']}, {$listing['city']}, {$listing['state']} {$listing['zip']}"; |
| [566](#L566) | $meta\_description = sprintf( |
| [567](#L567) | '%s beds, %s baths in this %s located at %s%s Priced at $%s. See photos, schedule a showing, and request information for this beautiful listing.', |
| [568](#L568) | (string) $listing['beds'], |
| [569](#L569) | (string) $listing['baths'], |
| [570](#L570) | $listing['style'], |
| [571](#L571) | $full\_address, |
| [572](#L572) | $neighborhood, |
| [573](#L573) | (string) $listing['price'] |
| [574](#L574) | ); |
| [575](#L575) |  |
| [576](#L576) | return $meta\_description ?? $description; |
| [577](#L577) |  |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | public function set\_listing\_data\_meta() { |
| [581](#L581) |  |
| [582](#L582) | if ( ! $this->check\_for\_listing\_detail() ) { |
| [583](#L583) | return; |
| [584](#L584) | } |
| [585](#L585) |  |
| [586](#L586) | $this->set\_listing(); |
| [587](#L587) |  |
| [588](#L588) | if ( empty( $this->listing ) ) { |
| [589](#L589) | status\_header( 404 ); |
| [590](#L590) | return; |
| [591](#L591) | } |
| [592](#L592) |  |
| [593](#L593) | $listing     = $this->listing; |
| [594](#L594) | $fullAddress = "{$listing['address']}, {$listing['city']}, {$listing['state']} {$listing['zip']}"; |
| [595](#L595) |  |
| [596](#L596) | if ( ! empty( $listing['openHouses']['data'] ) ) { |
| [597](#L597) | $openHouseData = $listing['openHouses']['data']; |
| [598](#L598) |  |
| [599](#L599) | foreach ( $openHouseData as $key => $openhouse ) { |
| [600](#L600) | $timeWithNoSpaces = str\_replace(' ', '', $openHouseData[$key]['time']); |
| [601](#L601) | $bothTimes = explode("-", $timeWithNoSpaces); |
| [602](#L602) | // certain values causing issues here adding extra check that it generates integer |
| [603](#L603) | if ( is\_int( strtotime( $bothTimes[0] ) ) ) { |
| [604](#L604) | $startTime = date( 'H:i', strtotime( $bothTimes[0] ) ); |
| [605](#L605) | } |
| [606](#L606) | if ( is\_int( strtotime( $bothTimes[1] ) ) ) { |
| [607](#L607) | $endTime = date( 'H:i', strtotime( $bothTimes[1] ) ); |
| [608](#L608) | } |
| [609](#L609) | $startDate           = "{$openHouseData[$key]->year}-{$openHouseData[$key]->month}-{$openHouseData[$key]->day}T" . $startTime; |
| [610](#L610) | $endDate             = "{$openHouseData[$key]->year}-{$openHouseData[$key]->month}-{$openHouseData[$key]->day}T" . $endTime; |
| [611](#L611) | $startTime           = $openHouseData[ $key ]->time; |
| [612](#L612) | $content             = array(); |
| [613](#L613) | $content['@context'] = 'https://schema.org'; |
| [614](#L614) | $content['@type']    = 'Event'; |
| [615](#L615) | if ( $listing['address'] ) { |
| [616](#L616) | $content['name'] = 'Open House at ' . $listing['address']; |
| [617](#L617) | } |
| [618](#L618) | if ( $listing['remarks'] ) { |
| [619](#L619) | $content['description'] = $listing['remarks']; |
| [620](#L620) | } |
| [621](#L621) | if ( $listing['photos']['data'][$key]['url'] ) { |
| [622](#L622) | $content['image'] = $listing['photos']['data'][0]['url']; |
| [623](#L623) | } |
| [624](#L624) | if ( $startDate ) { |
| [625](#L625) | $content['startDate'] = $startDate; |
| [626](#L626) | } |
| [627](#L627) | if ( $endDate ) { |
| [628](#L628) | $content['endDate'] = $endDate; |
| [629](#L629) | } |
| [630](#L630) | $content['location']['@type'] = 'Place'; |
| [631](#L631) |  |
| [632](#L632) | if ( $listing['address'] ) { |
| [633](#L633) | $content['location']['name'] = $fullAddress ?? 'Unknown'; |
| [634](#L634) | } |
| [635](#L635) | if ( $listing['address'] ) { |
| [636](#L636) | $content['location']['address']['@type']         = 'PostalAddress'; |
| [637](#L637) | $content['location']['address']['streetAddress'] = $listing['address'] ?? 'Unknown'; |
| [638](#L638) | } |
| [639](#L639) | if ( $listing['city'] ) { |
| [640](#L640) | $content['location']['address']['addressLocality'] = $listing['city'] ?? 'Unknown'; |
| [641](#L641) | } |
| [642](#L642) | if ( $listing['zip'] ) { |
| [643](#L643) | $content['location']['address']['postalCode'] = $listing['zip'] ?? 'Unknown'; |
| [644](#L644) | } |
| [645](#L645) | $content['location']['address']['addressCountry'] = Settings::get\_setting( 'optimize\_for\_canada' ) ? 'CA' : 'US'; |
| [646](#L646) |  |
| [647](#L647) | echo '<script type="application/ld+json">' . json\_encode( $content, JSON\_UNESCAPED\_SLASHES ) . '</script>'; |
| [648](#L648) | } |
| [649](#L649) | } |
| [650](#L650) |  |
| [651](#L651) | $detail\_page\_url  = trailingslashit( get\_permalink( $this->detailsPageId ) ); |
| [652](#L652) | $site\_url         = get\_site\_url(); |
| [653](#L653) | $listingDetailUrl = $detail\_page\_url . $listing['mls'] . '-' . $listing['mlsid'] . '-' . $this->get\_slug( $listing['address'] ) . '-' . $this->get\_slug( $listing['city'] ) . '-' . $listing['state'] . '-' . $listing['zip']; |
| [654](#L654) | $listingCity      = $listing['city'] ? $listing['city'] : 'No City'; |
| [655](#L655) | $listingAddress   = $listing['address'] ? $listing['address'] : 'No Address'; |
| [656](#L656) | echo '<script type="application/ld+json"> |
| [657](#L657) | { |
| [658](#L658) | "@context": "https://schema.org", |
| [659](#L659) | "@type": "BreadcrumbList", |
| [660](#L660) | "itemListElement": [{ |
| [661](#L661) | "@type": "ListItem", |
| [662](#L662) | "position": 1, |
| [663](#L663) | "name": "Listings", |
| [664](#L664) | "item": "' . $site\_url . '/listings-sitemap/" |
| [665](#L665) | },{ |
| [666](#L666) | "@type": "ListItem", |
| [667](#L667) | "position": 2, |
| [668](#L668) | "name": "' . $listing['county'] . '", |
| [669](#L669) | "item": "' . $site\_url . '/listings-sitemap/homes-in-' . $listing['county'] . '?type=county" |
| [670](#L670) | },{ |
| [671](#L671) | "@type": "ListItem", |
| [672](#L672) | "position": 3, |
| [673](#L673) | "name": "' . $listingCity . '", |
| [674](#L674) | "item": "' . $site\_url . '/listings-sitemap/homes-in-' . $listing['city'] . '?type=city" |
| [675](#L675) | },{ |
| [676](#L676) | "@type": "ListItem", |
| [677](#L677) | "position": 4, |
| [678](#L678) | "name": "' . $listingAddress . '", |
| [679](#L679) | "item": "' . $listingDetailUrl . '" |
| [680](#L680) | }] |
| [681](#L681) | } |
| [682](#L682) | </script>'; |
| [683](#L683) |  |
| [684](#L684) |  |
| [685](#L685) | $neighborhood = ! empty( $listing['neighborhood'] ) ? " in the beautiful neighborhood of {$listing['neighborhood']}." : '.'; |
| [686](#L686) |  |
| [687](#L687) | $metaDescription = sprintf( |
| [688](#L688) | '%s beds, %s baths in this %s located at %s%s Priced at $%s. See photos, schedule a showing, and request information for this beautiful listing.', |
| [689](#L689) | (string) $listing['beds'], |
| [690](#L690) | (string) $listing['baths'], |
| [691](#L691) | $listing['style'], |
| [692](#L692) | $fullAddress, |
| [693](#L693) | $neighborhood, |
| [694](#L694) | (string) $listing['price'] |
| [695](#L695) | ); |
| [696](#L696) | $metaKeyWords    = sprintf( |
| [697](#L697) | 'mls listing id %s, %s, %s, homes, %s, homes for sale, %s real estate, houses, houses in %s, properties, properties in %s, property near %s, %s, %s, %s', |
| [698](#L698) | (string) $listing['mlsid'], |
| [699](#L699) | $listing['address'], |
| [700](#L700) | (string) $listing['zip'], |
| [701](#L701) | $listing['city'], |
| [702](#L702) | $listing['city'], |
| [703](#L703) | $listing['county'], |
| [704](#L704) | (string) $listing['zip'], |
| [705](#L705) | (string) $listing['zip'], |
| [706](#L706) | $listing['state'], |
| [707](#L707) | $listing['style'], |
| [708](#L708) | $listing['typeName'] |
| [709](#L709) | ); |
| [710](#L710) |  |
| [711](#L711) | $metaImage = $listing['photos']['data'][0]['url'] ?? ''; |
| [712](#L712) |  |
| [713](#L713) | $siteName = get\_bloginfo( 'name' ); |
| [714](#L714) |  |
| [715](#L715) | $companyData = Api::request( 'GET', 'public/company/', array() ); |
| [716](#L716) | $companyName = $companyData->data->name; |
| [717](#L717) |  |
| [718](#L718) | $listingVideo = ! empty( $this->listing->enhancements->data->virtualoh ) ? $this->listing->enhancements->data->virtualoh : ( ! empty( $this->listing->enhancements->data->virtualtour ) ? $this->listing->enhancements->data->virtualtour : false ); |
| [719](#L719) | echo "\r\n<link rel='canonical' href=\"$listingDetailUrl/\" />"; |
| [720](#L720) | echo "\r\n<meta name=\"description\" content=\"{$metaDescription}\" />"; |
| [721](#L721) | echo "\r\n<meta name=\"keywords\" content=\"{$metaKeyWords}\" />"; |
| [722](#L722) |  |
| [723](#L723) | if ( ! empty( $metaImage ) ) { |
| [724](#L724) | echo "\r\n<meta name=\"image\" content=\"{$metaImage}\" />"; |
| [725](#L725) | } |
| [726](#L726) |  |
| [727](#L727) | if ( $listingVideo ) { |
| [728](#L728) | echo "\r\n\t<meta property=\"og:video\" content=\"{$listingVideo}\" />"; |
| [729](#L729) | } |
| [730](#L730) |  |
| [731](#L731) | if ( ! defined( 'WPSEO\_VERSION' ) ) { |
| [732](#L732) | echo "\r\n\r\n\t<!-- OpenGraph Tags -->"; |
| [733](#L733) | $siteName = get\_bloginfo( 'name' ); |
| [734](#L734) | echo "\r\n\t<meta property=\"og:locale\" content=\"en\_US\" />"; |
| [735](#L735) | echo "\r\n\t<meta property=\"og:type\" content=\"place\" />"; |
| [736](#L736) | echo "\r\n\t<meta property=\"og:title\" content=\"{$fullAddress} - {$companyName}\" />"; |
| [737](#L737) | echo "\r\n\t<meta property=\"og:description\" content=\"{$metaDescription}\" />"; |
| [738](#L738) | echo "\r\n\t<meta property=\"og:url\" content=\"{$listingDetailUrl}\" />"; |
| [739](#L739) | echo "\r\n\t<meta property=\"og:site\_name\" content=\"{$siteName}\" />"; |
| [740](#L740) | if ( ! empty( $metaImage ) ) { |
| [741](#L741) | echo "\r\n\t<meta property=\"og:image\" content=\"{$metaImage}\" />"; |
| [742](#L742) | } |
| [743](#L743) | echo "\r\n\t<!-- / OpenGraph -->\r\n"; |
| [744](#L744) | } |
| [745](#L745) |  |
| [746](#L746) | echo "\r\n<meta property=\"place:location:latitude\" content=\"{$listing['lat']}\" />"; |
| [747](#L747) | echo "\r\n<meta property=\"place:location:longitude\" content=\"{$listing['long']}\" />"; |
| [748](#L748) |  |
| [749](#L749) |  |
| [750](#L750) | $sqft = isset($listing['sqft']) ? $listing['sqft'] : ''; |
| [751](#L751) | $totalrooms = isset($listing['totalrooms']) ? $listing['totalrooms'] : ''; |
| [752](#L752) | $baths = isset($listing['baths']) ? $listing['baths'] : ''; |
| [753](#L753) | $halfbaths = isset($listing['halfbaths']) ? $listing['halfbaths'] : ''; |
| [754](#L754) | $address = isset($listing['address']) ? $listing['address'] : ''; |
| [755](#L755) | $city = isset($listing['city']) ? $listing['city'] : ''; |
| [756](#L756) | $state = isset($listing['state']) ? $listing['state'] : ''; |
| [757](#L757) | $zip = isset($listing['zip']) ? $listing['zip'] : ''; |
| [758](#L758) | $lat = isset($listing['lat']) ? $listing['lat'] : ''; |
| [759](#L759) | $long = isset($listing['long']) ? $listing['long'] : ''; |
| [760](#L760) | $price = isset($listing['price']) ? $listing['price'] : ''; |
| [761](#L761) | $beds = isset($listing['beds']) ? $listing['beds'] : ''; |
| [762](#L762) | $bath = isset($listing['bath']) ? $listing['bath'] : ''; |
| [763](#L763) |  |
| [764](#L764) | $singleFamilyHomeSchema = array( |
| [765](#L765) | '@type'                    => 'SingleFamilyResidence', |
| [766](#L766) | '@context'                 => 'http://schema.org', |
| [767](#L767) | 'name'                     => $fullAddress, |
| [768](#L768) | 'floorSize'                => array( |
| [769](#L769) | '@type'    => 'QuantitativeValue', |
| [770](#L770) | '@context' => 'http://schema.org', |
| [771](#L771) | 'value'    => $sqft, |
| [772](#L772) | ), |
| [773](#L773) | 'numberOfRooms'            => $totalrooms, |
| [774](#L774) | 'numberOfBedrooms'         => $totalrooms, |
| [775](#L775) | 'numberOfFullBathrooms'    => $baths, |
| [776](#L776) | 'numberOfPartialBathrooms' => $halfbaths, |
| [777](#L777) | 'address'                  => array( |
| [778](#L778) | '@type'           => 'PostalAddress', |
| [779](#L779) | '@context'        => 'http://schema.org', |
| [780](#L780) | 'streetAddress'   => $address, |
| [781](#L781) | 'addressLocality' => $city, |
| [782](#L782) | 'addressRegion'   => $state, |
| [783](#L783) | 'postalCode'      => $zip, |
| [784](#L784) | ), |
| [785](#L785) | 'geo'                      => array( |
| [786](#L786) | '@type'     => 'GeoCoordinates', |
| [787](#L787) | '@context'  => 'http://schema.org', |
| [788](#L788) | 'latitude'  => $lat, |
| [789](#L789) | 'longitude' => $long, |
| [790](#L790) | ), |
| [791](#L791) | 'url'                      => $listingDetailUrl, |
| [792](#L792) | ); |
| [793](#L793) | echo "\r\n"; |
| [794](#L794) | echo '<script type="application/ld+json">' . json\_encode( $singleFamilyHomeSchema, JSON\_UNESCAPED\_SLASHES ) . '</script>'; |
| [795](#L795) |  |
| [796](#L796) | $productSchema = array( |
| [797](#L797) | '@type'       => 'Product', |
| [798](#L798) | '@context'    => 'http://schema.org', |
| [799](#L799) | 'offers'      => array( |
| [800](#L800) | '@type'         => 'Offer', |
| [801](#L801) | '@context'      => 'http://schema.org', |
| [802](#L802) | 'price'         => $price, |
| [803](#L803) | 'priceCurrency' => Settings::get\_setting( 'optimize\_for\_canada' ) ? 'CAD' : 'USD', |
| [804](#L804) | 'availability'  => 'http://schema.org/InStock', |
| [805](#L805) | 'url'           => $listingDetailUrl, |
| [806](#L806) | ), |
| [807](#L807) | 'name'        => $fullAddress, |
| [808](#L808) | 'description' => $beds . ' bed, ' . $bath . ' bath, ' . $sqft . ' sqft in ' . $city, |
| [809](#L809) | 'image'       => $metaImage, |
| [810](#L810) | ); |
| [811](#L811) | echo "\r\n"; |
| [812](#L812) | echo '<script type="application/ld+json">' . json\_encode( $productSchema, JSON\_UNESCAPED\_SLASHES ) . '</script>'; |
| [813](#L813) | echo "\r\n"; |
| [814](#L814) |  |
| [815](#L815) | } |
| [816](#L816) |  |
| [817](#L817) | /\*\* |
| [818](#L818) | \* This function will check if a WordPress plugin is active |
| [819](#L819) | \*/ |
| [820](#L820) | public function is\_plugin\_active( $plugin ) { |
| [821](#L821) | return in\_array( $plugin, (array) get\_option( 'active\_plugins', array() ) ); |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | /\*\* |
| [825](#L825) | \* This function will check if the request is for an agent detail page, get agent id, get agent info and set transient, then echo meta data. |
| [826](#L826) | \*/ |
| [827](#L827) | public function set\_agent\_meta\_data() { |
| [828](#L828) | $this->isAgentProfileRequest = $this->check\_for\_agent\_detail(); |
| [829](#L829) | if ( ! $this->isAgentProfileRequest ) { |
| [830](#L830) | return; |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | $agentId = $this->get\_agent\_id(); |
| [834](#L834) | $this->set\_agent\_transient( $agentId ); |
| [835](#L835) | if ( empty( $this->agent ) ) { |
| [836](#L836) | return; |
| [837](#L837) | } |
| [838](#L838) |  |
| [839](#L839) | $siteName = get\_bloginfo( 'name' ); |
| [840](#L840) |  |
| [841](#L841) | $this->agent->bio !== null ? $strippedBio = strip\_tags( $this->agent->bio ) : $strippedBio = ''; |
| [842](#L842) | $metaKeyWords                             = "real estate, real estate agent, {$this->agent->first\_name} {$this->agent->last\_name}, $siteName"; |
| [843](#L843) | $metaDescription                          = ! empty( $this->agent->office->data ) |
| [844](#L844) | ? "{$this->agent->first\_name} {$this->agent->last\_name}, Real Estate Agent in {$this->agent->office->data->name}, {$strippedBio}" |
| [845](#L845) | : "{$this->agent->first\_name} {$this->agent->last\_name}, {$strippedBio}"; |
| [846](#L846) |  |
| [847](#L847) | if ( empty( $this->agent->bio ) ) { |
| [848](#L848) | $metaDescription = "Looking to buy or sell a home? Choose {$this->agent->first\_name} {$this->agent->last\_name}, a licensed and professional real estate agent."; |
| [849](#L849) | } |
| [850](#L850) |  |
| [851](#L851) | if ( strlen( $metaDescription ) > 120 ) { |
| [852](#L852) | $metaDescription = substr( $metaDescription, 0, 117 ) . '...'; |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) | echo "<meta name=\"description\" content=\"{$metaDescription}\" />"; |
| [856](#L856) | echo "<meta property=\"og:description\" content=\"{$metaDescription}\" />"; |
| [857](#L857) | echo "<meta name=\"keywords\" content=\"{$metaKeyWords}\" />"; |
| [858](#L858) | if ( ! empty( $this->agent->photo ) ) { |
| [859](#L859) | echo "<meta name=\"image\" content=\"{$this->agent->photo}\" />"; |
| [860](#L860) | echo "<meta property=\"og:image\" content=\"{$this->agent->photo}\" />"; |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | $agent\_first\_name = is\_string( $this->agent->first\_name ) ? strtolower( $this->agent->first\_name ) : ''; |
| [864](#L864) | $agent\_last\_name  = is\_string( $this->agent->last\_name ) ? strtolower( $this->agent->last\_name ) : ''; |
| [865](#L865) | $url\_suffix       = ( '' !== ( $agent\_first\_name . $agent\_last\_name ) ) ? '-' . $agent\_first\_name . '-' . $agent\_last\_name : ''; |
| [866](#L866) |  |
| [867](#L867) | $agentUrl = get\_permalink( $this->agentPageId ) . $agentId . $url\_suffix; |
| [868](#L868) | $site\_url = get\_site\_url(); |
| [869](#L869) | $agentOfficeName = $this->agent->office->data->name ?? ''; |
| [870](#L870) | $agentOfficeId = $this->agent->office->data->id ?? ''; |
| [871](#L871) | echo ' |
| [872](#L872) | <script type="application/ld+json"> |
| [873](#L873) | { |
| [874](#L874) | "@context": "https://schema.org", |
| [875](#L875) | "@type": "BreadcrumbList", |
| [876](#L876) | "itemListElement": [{ |
| [877](#L877) | "@type": "ListItem", |
| [878](#L878) | "position": 1, |
| [879](#L879) | "name": "' . $agentOfficeName . '", |
| [880](#L880) | "item": "' . $site\_url . '/agents-sitemap/agents-in-' . $agentOfficeName . '?pass=2&entity=' . $agentOfficeId . '" |
| [881](#L881) | },{ |
| [882](#L882) | "@type": "ListItem", |
| [883](#L883) | "position": 2, |
| [884](#L884) | "name": "' . $this->agent->full\_name . '", |
| [885](#L885) | "item": "' . $agentUrl . '" |
| [886](#L886) | }] |
| [887](#L887) | } |
| [888](#L888) | </script> |
| [889](#L889) | '; |
| [890](#L890) | } |
| [891](#L891) |  |
| [892](#L892) | public function set\_meta\_title\_yoast( $value ) { |
| [893](#L893) | $this->isAgentProfileRequest = $this->check\_for\_agent\_detail(); |
| [894](#L894) |  |
| [895](#L895) | $siteName = get\_bloginfo( 'name' ); |
| [896](#L896) |  |
| [897](#L897) | if ( $this->detailsPageId == get\_the\_ID() ) { |
| [898](#L898) | $listing     = $this->listing; |
| [899](#L899) | $fullAddress = "{$listing['address']}, {$listing['city']}, {$listing['state']} {$listing['zip']}"; |
| [900](#L900) | $metaTitle   = "{$fullAddress} | MLS# {$listing['mlsid']} | {$siteName}"; |
| [901](#L901) | return $metaTitle; |
| [902](#L902) | } |
| [903](#L903) |  |
| [904](#L904) | if ( $this->isAgentProfileRequest ) { |
| [905](#L905) | $agentId = $this->get\_agent\_id(); |
| [906](#L906) | $this->set\_agent\_transient( $agentId ); |
| [907](#L907) |  |
| [908](#L908) | if ( empty( $this->agent ) ) { |
| [909](#L909) | status\_header( 404 ); |
| [910](#L910) | return $value; |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) | $metaTitle = ! empty( $this->agent->office->data ) |
| [914](#L914) | ? "{$this->agent->first\_name} {$this->agent->last\_name}, {$this->agent->office->data->name} Real Estate Agent | $siteName" |
| [915](#L915) | : "{$this->agent->first\_name} {$this->agent->last\_name}, Real Estate Agent | $siteName"; |
| [916](#L916) | return $metaTitle; |
| [917](#L917) | } |
| [918](#L918) | // other pages should return normally |
| [919](#L919) | return $value; |
| [920](#L920) | } |
| [921](#L921) |  |
| [922](#L922) | // public function set\_agent\_meta\_description($value) |
| [923](#L923) | // { |
| [924](#L924) | // $this->isAgentProfileRequest = $this->check\_for\_agent\_detail(); |
| [925](#L925) | // if(!$this->isAgentProfileRequest) |
| [926](#L926) | // return $value; |
| [927](#L927) | // |
| [928](#L928) | // $agentId = $this->get\_agent\_id(); |
| [929](#L929) | // $this->set\_agent\_transient($agentId); |
| [930](#L930) | // if(empty($this->agent)) |
| [931](#L931) | // return $value; |
| [932](#L932) | // |
| [933](#L933) | // $metaDescription = "Looking to buy or sell a home? Choose {$this->agent->first\_name} {$this->agent->last\_name}, a licensed and professional real estate agent."; |
| [934](#L934) | // |
| [935](#L935) | // return $metaDescription; |
| [936](#L936) | // } |
| [937](#L937) |  |
| [938](#L938) | public function set\_agent\_meta\_image( $value ) { |
| [939](#L939) | $this->isAgentProfileRequest = $this->check\_for\_agent\_detail(); |
| [940](#L940) | if ( ! $this->isAgentProfileRequest ) { |
| [941](#L941) | return $value; |
| [942](#L942) | } |
| [943](#L943) |  |
| [944](#L944) | $agentId = $this->get\_agent\_id(); |
| [945](#L945) | $this->set\_agent\_transient( $agentId ); |
| [946](#L946) | if ( empty( $this->agent ) ) { |
| [947](#L947) | return $value; |
| [948](#L948) | } |
| [949](#L949) |  |
| [950](#L950) | if ( ! empty( $this->agent->photo ) ) { |
| [951](#L951) | return $this->agent->photo; |
| [952](#L952) | } |
| [953](#L953) | return $value; |
| [954](#L954) | } |
| [955](#L955) |  |
| [956](#L956) | public function set\_agent\_keywords( $value ) { |
| [957](#L957) | $this->isAgentProfileRequest = $this->check\_for\_agent\_detail(); |
| [958](#L958) | if ( ! $this->isAgentProfileRequest ) { |
| [959](#L959) | return $value; |
| [960](#L960) | } |
| [961](#L961) |  |
| [962](#L962) | $agentId = $this->get\_agent\_id(); |
| [963](#L963) | $this->set\_agent\_transient( $agentId ); |
| [964](#L964) | if ( empty( $this->agent ) ) { |
| [965](#L965) | return $value; |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | $siteName = get\_bloginfo( 'name' ); |
| [969](#L969) |  |
| [970](#L970) | $metaKeyWords = "real estate, real estate agent, {$this->agent->first\_name} {$this->agent->last\_name}, $siteName"; |
| [971](#L971) |  |
| [972](#L972) | return $metaKeyWords; |
| [973](#L973) |  |
| [974](#L974) | } |
| [975](#L975) |  |
| [976](#L976) | /\*\* |
| [977](#L977) | \* Check if the current page is an agent detail page. |
| [978](#L978) | \* |
| [979](#L979) | \* @return bool |
| [980](#L980) | \*/ |
| [981](#L981) | private function check\_for\_agent\_detail() { |
| [982](#L982) | if ( $this->isAgentProfileRequest === false ) { |
| [983](#L983) | return false; |
| [984](#L984) | } |
| [985](#L985) |  |
| [986](#L986) | if ( ! is\_singular() ) { |
| [987](#L987) | return false; |
| [988](#L988) | } |
| [989](#L989) | global $post; |
| [990](#L990) | if ( ! empty( $post->post\_content ) ) { |
| [991](#L991) | // Get regex pattern |
| [992](#L992) | $regex = get\_shortcode\_regex( array( 'kvcoreidx\_agent\_profile' ) ); |
| [993](#L993) |  |
| [994](#L994) | // Run regex on the post content. (Expected [kvcoreidx\_agent\_profile]) |
| [995](#L995) | preg\_match\_all( '/' . $regex . '/', $post->post\_content, $matches ); |
| [996](#L996) |  |
| [997](#L997) | // The result, if correct, will be in $matches[2]. |
| [998](#L998) | if ( ! empty( $matches[2] ) && in\_array( 'kvcoreidx\_agent\_profile', $matches[2] ) ) { |
| [999](#L999) | return true; |
| [1000](#L1000) | } |
| [1001](#L1001) | } |
| [1002](#L1002) | return false; |
| [1003](#L1003) |  |
| [1004](#L1004) | } |
| [1005](#L1005) |  |
| [1006](#L1006) | private function check\_for\_listing\_detail() { |
| [1007](#L1007) | $this->mls   = get\_query\_var( 'by-mls' ); |
| [1008](#L1008) | $this->mlsid = get\_query\_var( 'by-mlsid' ); |
| [1009](#L1009) |  |
| [1010](#L1010) | if ( empty( $this->mls ) && empty( $this->mlsid ) ) { |
| [1011](#L1011) | $this->mls   = get\_query\_var( 'mls' ); |
| [1012](#L1012) | $this->mlsid = get\_query\_var( 'mlsid' ); |
| [1013](#L1013) | } |
| [1014](#L1014) |  |
| [1015](#L1015) | if ( empty( $this->mls ) || empty( $this->mlsid ) ) { |
| [1016](#L1016) | return false; |
| [1017](#L1017) | } |
| [1018](#L1018) |  |
| [1019](#L1019) | return true; |
| [1020](#L1020) | } |
| [1021](#L1021) |  |
| [1022](#L1022) | private function set\_listing() { |
| [1023](#L1023) | if ( ! $this->listing ) { |
| [1024](#L1024) | $this->listing = get\_transient( "kv\_listing\_detail\_info\_{$this->mls}\_{$this->mlsid}" ); |
| [1025](#L1025) |  |
| [1026](#L1026) | if ( empty( $this->listing ) ) { |
| [1027](#L1027) | $listingObj    = new Listing( $this->mls, $this->mlsid ); |
| [1028](#L1028) | $this->listing = $listingObj->get\_data(); |
| [1029](#L1029) | if ( ! empty( $this->listing ) ) { |
| [1030](#L1030) | set\_transient( "kv\_listing\_detail\_info\_{$this->mls}\_{$this->mlsid}", $this->listing, DAY\_IN\_SECONDS ); |
| [1031](#L1031) | } |
| [1032](#L1032) | } |
| [1033](#L1033) | } |
| [1034](#L1034) | } |
| [1035](#L1035) |  |
| [1036](#L1036) | /\*\* |
| [1037](#L1037) | \* Get agent id |
| [1038](#L1038) | \* |
| [1039](#L1039) | \* @return string |
| [1040](#L1040) | \*/ |
| [1041](#L1041) | private function get\_agent\_id() { |
| [1042](#L1042) | global $wp\_query; |
| [1043](#L1043) | $agentId = $wp\_query->query\_vars['team-member']; |
| [1044](#L1044) | if ( empty( $agentId ) ) { |
| [1045](#L1045) | global $wp; |
| [1046](#L1046) | preg\_match\_all( '/\/([0-9]+)-/m', $wp->request, $matches, PREG\_SET\_ORDER ); |
| [1047](#L1047) | $agentId = $matches[0][1] ?? ''; |
| [1048](#L1048) | } |
| [1049](#L1049) |  |
| [1050](#L1050) | return $agentId; |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | /\*\* |
| [1054](#L1054) | \* Get agent data from kvcore then set agent transient |
| [1055](#L1055) | \* |
| [1056](#L1056) | \* @param $agentId |
| [1057](#L1057) | \*/ |
| [1058](#L1058) | private function set\_agent\_transient( $agentId ) { |
| [1059](#L1059) | if ( empty( $this->agent ) ) { |
| [1060](#L1060) | $data = Api::request( 'GET', 'public/members/' . $agentId, array() ); |
| [1061](#L1061) | if ( ! empty( $data->data ) ) { |
| [1062](#L1062) | $agentTransient = $data->data; |
| [1063](#L1063) | set\_transient( "agent\_profile\_{$agentId}", $agentTransient, DAY\_IN\_SECONDS ); |
| [1064](#L1064) | $this->agent = $agentTransient; |
| [1065](#L1065) | } |
| [1066](#L1066) | } |
| [1067](#L1067) | } |
| [1068](#L1068) |  |
| [1069](#L1069) |  |
| [1070](#L1070) |  |
| [1071](#L1071) | public function maybe\_output\_share\_meta() { |
| [1072](#L1072) | $user\_agent = isset( $\_SERVER['HTTP\_USER\_AGENT'] ) ? $\_SERVER['HTTP\_USER\_AGENT'] : ''; |
| [1073](#L1073) |  |
| [1074](#L1074) | if ( empty( $user\_agent ) || ! is\_string( $user\_agent ) ) { |
| [1075](#L1075) | return; |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | $user\_agent = strtolower( $user\_agent ); |
| [1079](#L1079) |  |
| [1080](#L1080) | $is\_twitter  = false !== strpos( $user\_agent, 'twitter' ); |
| [1081](#L1081) | $is\_facebook = false !== strpos( $user\_agent, 'facebook' ); |
| [1082](#L1082) |  |
| [1083](#L1083) | if ( $is\_twitter ) { |
| [1084](#L1084) | $meta\_type = 'twitter'; |
| [1085](#L1085) | } elseif ( $is\_facebook ) { |
| [1086](#L1086) | $meta\_type = 'facebook'; |
| [1087](#L1087) | } else { |
| [1088](#L1088) | return; |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | $mls    = get\_query\_var( 'by-mls' ); |
| [1092](#L1092) | $mls\_id = get\_query\_var( 'by-mlsid' ); |
| [1093](#L1093) |  |
| [1094](#L1094) | if ( empty( $mls ) && empty( $mls\_id ) ) { |
| [1095](#L1095) | $mls    = get\_query\_var( 'mls' ); |
| [1096](#L1096) | $mls\_id = get\_query\_var( 'mlsid' ); |
| [1097](#L1097) | } |
| [1098](#L1098) |  |
| [1099](#L1099) | $team\_member\_id = get\_query\_var( 'team-member' ); |
| [1100](#L1100) |  |
| [1101](#L1101) | if ( ! empty( $mls ) && ! empty( $mls\_id ) ) { |
| [1102](#L1102) | $meta\_source = new Listing( $mls, $mls\_id ); |
| [1103](#L1103) | } elseif ( ! empty( $team\_member\_id ) ) { |
| [1104](#L1104) | $meta\_source = new Agent( $team\_member\_id ); |
| [1105](#L1105) | } else { |
| [1106](#L1106) | return; |
| [1107](#L1107) | } |
| [1108](#L1108) |  |
| [1109](#L1109) | if ( $meta\_source->print\_meta\_init( $meta\_type ) ) { |
| [1110](#L1110) | $meta\_source->print\_meta\_title(); |
| [1111](#L1111) | $meta\_source->print\_meta\_image(); |
| [1112](#L1112) | $meta\_source->print\_meta\_description(); |
| [1113](#L1113) | } |
| [1114](#L1114) | } |
| [1115](#L1115) |  |
| [1116](#L1116) | /\*\* |
| [1117](#L1117) | \* @return void |
| [1118](#L1118) | \*/ |
| [1119](#L1119) | public function listing\_detail\_sidebar() { |
| [1120](#L1120) | $sidebars = kvCORE\Settings::get\_setting( 'sidebars' ); |
| [1121](#L1121) |  |
| [1122](#L1122) | if ( ! is\_array( $sidebars ) || count( $sidebars ) === 0 ) { |
| [1123](#L1123) | return; |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | foreach ( $sidebars as $sidebar ) { |
| [1127](#L1127) | register\_sidebar( |
| [1128](#L1128) | array( |
| [1129](#L1129) | 'id'   => $sidebar['id'], |
| [1130](#L1130) | 'name' => $sidebar['name'], |
| [1131](#L1131) | ) |
| [1132](#L1132) | ); |
| [1133](#L1133) | } |
| [1134](#L1134) | } |
| [1135](#L1135) |  |
| [1136](#L1136) | /\*\* |
| [1137](#L1137) | \* @return void |
| [1138](#L1138) | \*/ |
| [1139](#L1139) | public function update\_permalinks() { |
| [1140](#L1140) | $should\_update\_permalinks = Settings::get\_setting( 'should\_update\_permalinks' ); |
| [1141](#L1141) |  |
| [1142](#L1142) | if ( $should\_update\_permalinks ) { |
| [1143](#L1143) | global $wp\_rewrite; |
| [1144](#L1144) |  |
| [1145](#L1145) | $wp\_rewrite->set\_permalink\_structure( '/%postname%/' ); |
| [1146](#L1146) | $wp\_rewrite->flush\_rules(); |
| [1147](#L1147) |  |
| [1148](#L1148) | if ( function\_exists( 'flush\_rewrite\_rules' ) ) { |
| [1149](#L1149) | flush\_rewrite\_rules( true ); |
| [1150](#L1150) | } |
| [1151](#L1151) |  |
| [1152](#L1152) | kvCORE\Admin\Page\Settings::update\_setting( 'should\_update\_permalinks', false ); |
| [1153](#L1153) | } |
| [1154](#L1154) | } |
| [1155](#L1155) |  |
| [1156](#L1156) | public function set\_sitemap\_canonical() { |
| [1157](#L1157) | if ( ! $this->check\_for\_shortcodes( array( 'kvcoreidx\_listings\_sitemap\_ranges', 'kvcoreidx\_listings\_sitemap\_page', 'kvcoreidx\_agent\_profile\_sitemap', 'kvcoreidx\_agent\_profile' ) ) ) { |
| [1158](#L1158) | return; |
| [1159](#L1159) | } |
| [1160](#L1160) | global $wp; |
| [1161](#L1161) | $link  = home\_url( $wp->request ); |
| [1162](#L1162) | $count = 0; |
| [1163](#L1163) | foreach ( $\_REQUEST as $key => $value ) { |
| [1164](#L1164) | if ( $count++ === 0 ) { |
| [1165](#L1165) | $link .= "/?{$key}={$value}"; |
| [1166](#L1166) | continue; |
| [1167](#L1167) | } |
| [1168](#L1168) | $link .= "&{$key}={$value}"; |
| [1169](#L1169) | } |
| [1170](#L1170) | echo "<link rel='canonical' href=\"{$link}\" />"; |
| [1171](#L1171) | } |
| [1172](#L1172) |  |
| [1173](#L1173) | public function yoast\_remove\_canonical\_items( $canonical ) { |
| [1174](#L1174) | if ( ! is\_singular() ) { |
| [1175](#L1175) | return $canonical; |
| [1176](#L1176) | } |
| [1177](#L1177) | if ( $this->check\_for\_shortcodes( array( 'kvcoreidx\_listings', 'kvcoreidx\_listing\_detail\_page', 'kvcoreidx\_listings\_sitemap\_ranges', 'kvcoreidx\_listings\_sitemap\_page', 'kvcoreidx\_agent\_profile\_sitemap' ) ) ) { |
| [1178](#L1178) | return false; |
| [1179](#L1179) | } |
| [1180](#L1180) |  |
| [1181](#L1181) | return $canonical; |
| [1182](#L1182) | } |
| [1183](#L1183) |  |
| [1184](#L1184) | public function check\_for\_shortcodes( $shortCodes ) { |
| [1185](#L1185) | global $post; |
| [1186](#L1186) |  |
| [1187](#L1187) | $post\_content = $post->post\_content ?? null; |
| [1188](#L1188) | if ( ! empty( $post\_content ) ) { |
| [1189](#L1189) | foreach ( $shortCodes as $shortCode ) { |
| [1190](#L1190) | // Get regex pattern |
| [1191](#L1191) | $regex = get\_shortcode\_regex( array( $shortCode ) ); |
| [1192](#L1192) |  |
| [1193](#L1193) | // Run regex on the post content. |
| [1194](#L1194) | preg\_match\_all( '/' . $regex . '/', $post\_content, $matches ); |
| [1195](#L1195) |  |
| [1196](#L1196) | // The result, if correct, will be in $matches[2]. |
| [1197](#L1197) | if ( ! empty( $matches[2] ) && in\_array( $shortCode, $matches[2] ) ) { |
| [1198](#L1198) | return true; |
| [1199](#L1199) | } |
| [1200](#L1200) | } |
| [1201](#L1201) | } |
| [1202](#L1202) | if ( 'spark\_page' === get\_post\_meta( $post->ID, 'afe\_element\_id', true ) ) { |
| [1203](#L1203) | $afe\_values   = get\_post\_meta( $post->ID, 'afe\_values', true ); |
| [1204](#L1204) | $post\_content = json\_encode( $afe\_values ); |
| [1205](#L1205) | foreach ( $shortCodes as $shortCode ) { |
| [1206](#L1206) | // Get regex pattern |
| [1207](#L1207) | $regex = get\_shortcode\_regex( array( $shortCode ) ); |
| [1208](#L1208) |  |
| [1209](#L1209) | // Run regex on the post content. |
| [1210](#L1210) | preg\_match\_all( '/' . $regex . '/', $post\_content, $matches ); |
| [1211](#L1211) |  |
| [1212](#L1212) | // The result, if correct, will be in $matches[2]. |
| [1213](#L1213) | if ( ! empty( $matches[2] ) && in\_array( $shortCode, $matches[2] ) ) { |
| [1214](#L1214) | return true; |
| [1215](#L1215) | } |
| [1216](#L1216) | } |
| [1217](#L1217) | } |
| [1218](#L1218) | return false; |
| [1219](#L1219) | } |
| [1220](#L1220) |  |
| [1221](#L1221) | protected function get\_slug( $string ) { |
| [1222](#L1222) |  |
| [1223](#L1223) | if ( ! is\_string( $string ) ) { |
| [1224](#L1224) | return ''; |
| [1225](#L1225) | } |
| [1226](#L1226) |  |
| [1227](#L1227) | $result = strtolower( $string ); |
| [1228](#L1228) |  |
| [1229](#L1229) | $result = preg\_replace( '/[^a-z0-9\s-]/', '', $result ); |
| [1230](#L1230) | $result = trim( preg\_replace( '/[\s-]+/', ' ', $result ) ); |
| [1231](#L1231) | $result = ucwords( $result ); |
| [1232](#L1232) | $result = preg\_replace( '/\s/', '-', $result ); |
| [1233](#L1233) |  |
| [1234](#L1234) | return $result; |
| [1235](#L1235) | } |
| [1236](#L1236) |  |
| [1237](#L1237) | public function remove\_header\_links() { |
| [1238](#L1238) | if ( ! $this->check\_for\_shortcodes( array( 'kvcoreidx\_listings', 'kvcoreidx\_listing\_detail\_page', 'kvcoreidx\_agent\_profile' ) ) ) { |
| [1239](#L1239) | return; |
| [1240](#L1240) | } |
| [1241](#L1241) |  |
| [1242](#L1242) | remove\_action( 'wp\_head', 'wp\_shortlink\_wp\_head', 10 ); |
| [1243](#L1243) | remove\_action( 'wp\_head', 'wp\_shortl', 10 ); |
| [1244](#L1244) | remove\_action( 'template\_redirect', 'wp\_shortlink\_header', 11 ); |
| [1245](#L1245) |  |
| [1246](#L1246) | remove\_action( 'wp\_head', 'rest\_output\_link\_wp\_head', 10 ); |
| [1247](#L1247) | remove\_action( 'wp\_head', 'wp\_oembed\_add\_discovery\_links', 10 ); |
| [1248](#L1248) |  |
| [1249](#L1249) | add\_action( 'feed\_links\_show\_posts\_feed', '\_\_return\_false', -1 ); |
| [1250](#L1250) | add\_action( 'feed\_links\_show\_comments\_feed', '\_\_return\_false', -1 ); |
| [1251](#L1251) | remove\_action( 'wp\_head', 'feed\_links', 2 ); // Display the links to the general feeds: Post and Comment Feed |
| [1252](#L1252) | remove\_action( 'wp\_head', 'feed\_links\_extra', 3 ); // Display the links to the extra feeds such as category feeds |
| [1253](#L1253) | } |
| [1254](#L1254) |  |
| [1255](#L1255) | public function maybe\_flush\_rewrite\_rules() { |
| [1256](#L1256) | if ( get\_option( 'kvcoreidx\_flush\_rewrite\_rules', 1 ) ) { |
| [1257](#L1257) | flush\_rewrite\_rules(); |
| [1258](#L1258) | update\_option( 'kvcoreidx\_flush\_rewrite\_rules', 0 ); |
| [1259](#L1259) | } |
| [1260](#L1260) | } |
| [1261](#L1261) |  |
| [1262](#L1262) | // flush rewrite rules when page is saved if saved page is |
| [1263](#L1263) | // one of the pages used by IDX (ie: updating url) |
| [1264](#L1264) | public function save\_post( $id ) { |
| [1265](#L1265) | $idx\_page\_ids = array( |
| [1266](#L1266) | Settings::get\_setting( 'listing\_detail\_page' ), |
| [1267](#L1267) | Settings::get\_setting( 'properties\_page' ), |
| [1268](#L1268) | Settings::get\_setting( 'agent\_profile\_page' ), |
| [1269](#L1269) | Settings::get\_setting( 'exclusives\_page' ), |
| [1270](#L1270) | Settings::get\_setting( 'exclusive\_detail\_page' ), |
| [1271](#L1271) | Settings::get\_setting( 'valuation\_pdf\_page' ), |
| [1272](#L1272) | Settings::get\_setting( 'user\_profile\_page' ), |
| [1273](#L1273) | Settings::get\_setting( 'listings\_sitemap\_ranges\_page' ), |
| [1274](#L1274) | Settings::get\_setting( 'listings\_sitemap\_page' ), |
| [1275](#L1275) | Settings::get\_setting( 'agents\_sitemap\_page' ), |
| [1276](#L1276) | Settings::get\_setting( 'area\_page' ), |
| [1277](#L1277) | ); |
| [1278](#L1278) |  |
| [1279](#L1279) | update\_option( 'kvcoreidx\_flush\_rewrite\_rules', 1 ); |
| [1280](#L1280) | } |
| [1281](#L1281) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/kvcore-idx/includes/kvcore/class-actions.php?format=txt)
* [Original Format](/export/3222752/kvcore-idx/includes/kvcore/class-actions.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


