=== Content from ftp.openbsd.org_780f30dc_20250114_212734.html ===
untrusted comment: verify with openbsd-74-base.pub
RWRoyQmAD08ajfhE3n3+C7wEVHk7urK0MrIoBIrcnxZYFAqJi1DkZWgRT9Qa+RHOE19TMmHtjO1atS0BmFcLPHBHx5KMXtdvgwE=
OpenBSD 7.4 errata 006, November 21, 2023:
httpd(8): Avoid a NULL dereference when handling a malformed fastcgi request.
Apply by doing:
signify -Vep /etc/signify/openbsd-74-base.pub -x 006\_httpd.patch.sig \
-m - | (cd /usr/src && patch -p0)
And then rebuild and install httpd(8):
cd /usr/src/usr.sbin/httpd
make obj
make
make install
Index: usr.sbin/httpd/httpd.h
===================================================================
RCS file: /cvs/src/usr.sbin/httpd/httpd.h,v
diff -u -p -r1.163 httpd.h
--- usr.sbin/httpd/httpd.h 12 Jul 2023 12:37:27 -0000 1.163
+++ usr.sbin/httpd/httpd.h 16 Nov 2023 17:28:00 -0000
@@ -350,6 +350,7 @@ struct client {
int clt\_done;
int clt\_chunk;
int clt\_inflight;
+ int clt\_fcgi\_count;
struct range\_data clt\_ranges;
struct fcgi\_data clt\_fcgi;
const char \*clt\_fcgi\_error;
Index: usr.sbin/httpd/server.c
===================================================================
RCS file: /cvs/src/usr.sbin/httpd/server.c,v
diff -u -p -r1.128 server.c
--- usr.sbin/httpd/server.c 3 Sep 2023 10:18:18 -0000 1.128
+++ usr.sbin/httpd/server.c 16 Nov 2023 17:28:00 -0000
@@ -1300,7 +1300,7 @@ server\_close(struct client \*clt, const c
{
struct server \*srv = clt->clt\_srv;
- if (clt->clt\_fcgi\_error != NULL) {
+ if (clt->clt\_fcgi\_count-- > 0) {
clt->clt\_fcgi\_error = msg;
return;
}
Index: usr.sbin/httpd/server\_fcgi.c
===================================================================
RCS file: /cvs/src/usr.sbin/httpd/server\_fcgi.c,v
diff -u -p -r1.96 server\_fcgi.c
--- usr.sbin/httpd/server\_fcgi.c 12 Jul 2023 12:37:28 -0000 1.96
+++ usr.sbin/httpd/server\_fcgi.c 16 Nov 2023 17:28:00 -0000
@@ -374,16 +374,15 @@ server\_fcgi(struct httpd \*env, struct cl
if (clt->clt\_toread != 0) {
/\*
\* XXX - Work around UAF: server\_read\_httpcontent() can call
- \* server\_close(), normally freeing clt. If clt->clt\_fcgi\_error
- \* changed, call server\_close() via server\_abort\_http().
+ \* server\_close(), normally freeing clt. If clt->clt\_fcgi\_count
+ \* reaches 0, call server\_close() via server\_abort\_http().
\*/
- clt->clt\_fcgi\_error = "";
+ clt->clt\_fcgi\_count++;
server\_read\_httpcontent(clt->clt\_bev, clt);
- errstr = clt->clt\_fcgi\_error;
- clt->clt\_fcgi\_error = NULL;
- if (errstr[0] != '\0')
+ if (clt->clt\_fcgi\_count-- <= 0) {
+ errstr = clt->clt\_fcgi\_error;
goto fail;
- errstr = NULL;
+ }
bufferevent\_enable(clt->clt\_bev, EV\_READ);
} else {
bufferevent\_disable(clt->clt\_bev, EV\_READ);


=== Content from ftp.openbsd.org_6f8b4183_20250114_212734.html ===
untrusted comment: verify with openbsd-73-base.pub
RWQS90bYzZ4XFo2OhNt1jQftAbT6juHXcOTtWw3fKl3xVqOdLo+2eQBttm6xbIzaXJLUE5uL7PBvp8Zqy2W3/KL/xVW0LybmcQs=
OpenBSD 7.3 errata 020, November 21, 2023:
httpd(8): Avoid a NULL dereference when handling a malformed fastcgi request.
Apply by doing:
signify -Vep /etc/signify/openbsd-73-base.pub -x 020\_httpd.patch.sig \
-m - | (cd /usr/src && patch -p0)
And then rebuild and install httpd(8):
cd /usr/src/usr.sbin/httpd
make obj
make
make install
Index: usr.sbin/httpd/httpd.h
===================================================================
RCS file: /cvs/src/usr.sbin/httpd/httpd.h,v
diff -u -p -r1.162.4.1 httpd.h
--- usr.sbin/httpd/httpd.h 12 Jul 2023 12:46:01 -0000 1.162.4.1
+++ usr.sbin/httpd/httpd.h 16 Nov 2023 17:33:15 -0000
@@ -350,6 +350,7 @@ struct client {
int clt\_done;
int clt\_chunk;
int clt\_inflight;
+ int clt\_fcgi\_count;
struct range\_data clt\_ranges;
struct fcgi\_data clt\_fcgi;
const char \*clt\_fcgi\_error;
Index: usr.sbin/httpd/server.c
===================================================================
RCS file: /cvs/src/usr.sbin/httpd/server.c,v
diff -u -p -r1.126.10.1 server.c
--- usr.sbin/httpd/server.c 12 Jul 2023 12:46:01 -0000 1.126.10.1
+++ usr.sbin/httpd/server.c 16 Nov 2023 17:33:15 -0000
@@ -1300,7 +1300,7 @@ server\_close(struct client \*clt, const c
{
struct server \*srv = clt->clt\_srv;
- if (clt->clt\_fcgi\_error != NULL) {
+ if (clt->clt\_fcgi\_count-- > 0) {
clt->clt\_fcgi\_error = msg;
return;
}
Index: usr.sbin/httpd/server\_fcgi.c
===================================================================
RCS file: /cvs/src/usr.sbin/httpd/server\_fcgi.c,v
diff -u -p -r1.95.6.1 server\_fcgi.c
--- usr.sbin/httpd/server\_fcgi.c 12 Jul 2023 12:46:01 -0000 1.95.6.1
+++ usr.sbin/httpd/server\_fcgi.c 16 Nov 2023 17:37:11 -0000
@@ -374,16 +374,15 @@ server\_fcgi(struct httpd \*env, struct cl
if (clt->clt\_toread != 0) {
/\*
\* XXX - Work around UAF: server\_read\_httpcontent() can call
- \* server\_close(), normally freeing clt. If clt->clt\_fcgi\_error
- \* changed, call server\_close() via server\_abort\_http().
+ \* server\_close(), normally freeing clt. If clt->clt\_fcgi\_count
+ \* reaches 0, call server\_close() via server\_abort\_http().
\*/
- clt->clt\_fcgi\_error = "";
+ clt->clt\_fcgi\_count++;
server\_read\_httpcontent(clt->clt\_bev, clt);
- errstr = clt->clt\_fcgi\_error;
- clt->clt\_fcgi\_error = NULL;
- if (errstr == NULL || errstr[0] != '\0')
+ if (clt->clt\_fcgi\_count-- <= 0) {
+ errstr = clt->clt\_fcgi\_error;
goto fail;
- errstr = NULL;
+ }
bufferevent\_enable(clt->clt\_bev, EV\_READ);
} else {
bufferevent\_disable(clt->clt\_bev, EV\_READ);

