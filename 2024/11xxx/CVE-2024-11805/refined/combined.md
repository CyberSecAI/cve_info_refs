=== Content from www.wordfence.com_93032886_20250114_225715.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Quick License Manager – WooCommerce Plugin <= 2.4.17 - Reflected Cross-Site Scripting

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Quick License Manager – WooCommerce Plugin <= 2.4.17 - Reflected Cross-Site Scripting

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-11805](https://www.cve.org/CVERecord?id=CVE-2024-11805) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | December 2, 2024 |
| Last Updated | December 3, 2024 |
| Researcher | [vgo0](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/dale-mavers) |

### Description

The Quick License Manager – WooCommerce Plugin plugin for WordPress is vulnerable to Reflected Cross-Site Scripting via the 'submit\_qlm\_products' parameter in all versions up to, and including, 2.4.17 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3198437/quick-license-manager/trunk?contextall=1&old=3198391&old_path=%2Fquick-license-manager%2Ftrunk)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fquick-license-manager%2Fquick-license-manager-woocommerce-plugin-2415-reflected-cross-site-scripting&t=Quick%20License%20Manager%20%E2%80%93%20WooCommerce%20Plugin%20%3C%3D%202.4.17%20-%20Reflected%20Cross-Site%20Scripting "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fquick-license-manager%2Fquick-license-manager-woocommerce-plugin-2415-reflected-cross-site-scripting&text=Quick%20License%20Manager%20%E2%80%93%20WooCommerce%20Plugin%20%3C%3D%202.4.17%20-%20Reflected%20Cross-Site%20Scripting "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fquick-license-manager%2Fquick-license-manager-woocommerce-plugin-2415-reflected-cross-site-scripting "LinkedIn")
Email

## Vulnerability Details for Quick License Manager – WooCommerce Plugin

#### [Quick License Manager – WooCommerce Plugin](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/quick-license-manager)

| Software Type | Plugin |
| --- | --- |
| Software Slug | quick-license-manager [(view on wordpress.org)](https://wordpress.org/plugins/quick-license-manager) |
| Patched? | Yes |
| Remediation | Update to version 2.4.18, or a newer patched version |
| Affected Version | * <= 2.4.17 |
| Patched Version | * 2.4.18 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_afb0ad01_20250114_225714.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3198437%2Fquick-license-manager%2Ftrunk%3Fcontextall%3D1%26old%3D3198391%26old_path%3D%252Fquick-license-manager%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3198391/quick-license-manager/trunk?old=3198437&old_path=%2Fquick-license-manager%2Ftrunk)

---

# Changes in [quick-license-manager/trunk](/browser/quick-license-manager/trunk?rev=3198437 "Show entry in browser") [[3198391:3198437]](/log/quick-license-manager/trunk?rev=3198437&stop_rev=3198391 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[quick-license-manager/trunk](/browser/quick-license-manager/trunk?rev=3198437)
Files:

3 edited

* [Readme.txt](/browser/quick-license-manager/trunk/Readme.txt?rev=3198437 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [classes/qlm\_emails.php](/browser/quick-license-manager/trunk/classes/qlm_emails.php?rev=3198437 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [wc\_qlm.php](/browser/quick-license-manager/trunk/wc_qlm.php?rev=3198437 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [quick-license-manager/trunk/Readme.txt](/changeset/3198437/quick-license-manager/trunk/Readme.txt?old=3198391&old_path=quick-license-manager%2Ftrunk%2FReadme.txt "Show the [3198391:3198437] differences restricted to quick-license-manager/trunk/Readme.txt")

  | [r3198391](/browser/quick-license-manager/trunk/Readme.txt?rev=3198391#L1 "Show revision 3198391 of this file in browser") | [r3198437](/browser/quick-license-manager/trunk/Readme.txt?rev=3198437#L1 "Show revision 3198437 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === Quick License Manager - WooCommerce Plugin === |
  | 2 | 2 | Contributors: Soraco Technologies |
  | 3 | 3 | Tags: quick license manager, software protection, ecommerce |
  | 4 | 4 | Requires at least: 4.2 |
  | 5 | 5 | Tested up to: 6.7.1 |
  | 6 |  | Stable tag: 2.4.1~~7~~ |
  |  | 6 | Stable tag: 2.4.18 |
  | 7 | 7 | License: GPLv2 |
  | 8 | 8 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | 9 | 9 |  |
  | 10 | 10 | Integrates QLM with WooCommerce |
  | 11 | 11 |  |
  | 12 | 12 | == Description == |
  | 13 | 13 |  |
  | 14 | 14 | Integrates QLM with WooCommerce |
  | 15 | 15 |  |
  | 16 | 16 | == Installation == |
  | 17 | 17 |  |
  | 18 | 18 | = Minimum Requirements = |
  | 19 | 19 |  |
  | 20 | 20 | \* WordPress 4.2 or greater |
  | 21 | 21 | \* PHP version 5.4.24 or greater |
  | 22 | 22 | \* MySQL version 5.5 or greater |
  | 23 | 23 | \* WooCommerce 2.3.13 or greater |
  | 24 | 24 |  |
  | 25 | 25 | = Automatic installation = |
  | 26 | 26 |  |
  | 27 | 27 | Automatic installation is the easiest option as WordPress handles the file transfers itself and you don�t even need to leave your web browser. To do an automatic install of WooCommerce, log in to your WordPress admin panel, navigate to the Plugins menu and click Add New. |
  | 28 | 28 |  |
  | 29 | 29 | In the search field type �Quick License Manager� and click Search Plugins. Once you�ve found our plugin you can view details about it such as the the point release, rating and description. Most importantly of course, you can install it by simply clicking Install Now. After clicking that link you will be asked if you�re sure you want to install the plugin. Click yes and WordPress will automatically complete the installation. |
  | 30 | 30 |  |
  | 31 | 31 | = Manual installation = |
  | 32 | 32 |  |
  | 33 | 33 | The manual installation method involves downloading our plugin and uploading it to your webserver via your favourite FTP application. |
  | 34 | 34 |  |
  | 35 | 35 | 1. Download the plugin file to your computer and unzip it |
  | 36 | 36 | 2. Using an FTP program, or your hosting control panel, upload the unzipped plugin folder to your WordPress installation�s wp-content/plugins/ directory. |
  | 37 | 37 | 3. Activate the plugin from the Plugins menu within the WordPress admin. |
  | 38 | 38 |  |
  | 39 | 39 | == Frequently Asked Questions == |
  | 40 | 40 |  |
  | 41 | 41 | == Changelog == |
  | 42 | 42 |  |
  | 43 |  | = 2.4.17 - 11/27/2024 = |
  |  | 43 | = 2.4.18 - 11/27/2024 = |
  |  | 44 | Resolved vulnerability issue |
  | 44 | 45 | Tested with latest versions of WP and WooCommerce |
  | 45 |  |  |
  | 46 |  | ~~= 2.4.16 - 11/27/2024 =~~ |
  | 47 |  | ~~Resolved vulnerability issue.~~ |
  | 48 | 46 |  |
  | 49 | 47 | = 2.4.15 - 09/25/2023 = |
  | 50 | 48 | Automatically detect if WooCommerce Custom Product Add-ons is active. |
  | 51 | 49 |  |
  | 52 | 50 | = 2.4.14 - 09/25/2023 = |
  | 53 | 51 | Minor fixes. |
  | 54 | 52 |  |
  | 55 | 53 | = 2.4.12 - 03/14/2023 = |
  | 56 | 54 | The QLM Engine version can now be specified per product by setting the is\_qlmversion custom field. |
  | 57 | 55 |  |
  | 58 | 56 | = 2.4.11 - 02/26/2023 = |
  | 59 | 57 | Fixed benign warning messages displayed when saving the QLM Settings |
  | 60 | 58 |  |
  | 61 | 59 | = 2.4.10 - 01/16/2023 = |
  | 62 | 60 | Fixed a regression issue in the last update that caused an exception when adding items to a cart without being logged in. |
  | 63 | 61 |  |
  | 64 | 62 | = 2.4.9 - 01/08/2023 = |
  | 65 | 63 | Fixed a regression issue in the last update that caused an exception when accessing the QLM settings |
  | 66 | 64 |  |
  | 67 | 65 | = 2.4.8 - 01/06/2023 = |
  | 68 | 66 | Added support for passing and setting the &is\_userdata1 argument when placing an order. |
  | 69 | 67 |  |
  | 70 | 68 |  |
  | 71 | 69 | = 2.4.7 - 10/17/2022 = |
  | 72 | 70 | Tested compatibility with WooCommerce 7.0.0 |
  | 73 | 71 | Fixed an issue that caused an incompatibiliy with the WooCommerce Invoice plugin. |
  | 74 | 72 |  |
  | 75 | 73 | = 2.4.6 - 07/28/2022 = |
  | 76 | 74 | Tested compatibility with WordPress 6.0.1 |
  | 77 | 75 | Configured some fields on the settings page as password fields to hide their content. |
  | 78 | 76 |  |
  | 79 | 77 | = 2.4.5 - 06/21/2021 = |
  | 80 | 78 | Fixed an issue when processing an upgrade of a license. |
  | 81 | 79 |  |
  | 82 | 80 | = 2.4.4 - 05/18/2021 = |
  | 83 | 81 | Fixed issue when there's a mix of QLM and non QLM products in a shopping cart, the License Key was not added as metadata to the order. |
  | 84 | 82 | Added support for automatically creating a pending order for a subscription via a webhook that can be triggered by QLM v15 Webhooks Notifications. |
  | 85 | 83 | This is useful for customers who use a Manual Renewal payment method. |
  | 86 | 84 | When the pending order is created, the customer receives an invoice prior to the actual expiry of the subscription. |
  | 87 | 85 | This gives customers enough lead time to make their payment prior to the actual expiry of the license. |
  | 88 | 86 |  |
  | 89 | 87 | = 2.3.2 - 04/23/2021 = |
  | 90 | 88 | Fixed issue with QLM emails not being sent. |
  | 91 | 89 |  |
  | 92 | 90 | = 2.3.1 - 02/27/2021 = |
  | 93 | 91 | Fixed date parsing issue when manually processing a subscription payment. |
  | 94 | 92 | Added new option to enable order processing when the order status is completed, to be used only in very special cases. |
  | 95 | 93 | If you have created a Maintenance Plan attribute to allow customers to opt-in/out of purchasing a maintenance plan, a new option allows you to specify the label that you used for the maintenance plan attribute. QLM uses this identifier to associate this attribute to the QLM Maintenance Plan feature. |
  | 96 | 94 |  |
  | 97 | 95 |  |
  | 98 | 96 | = 2.3.0 - 02/17/2021 = |
  | 99 | 97 | Added support for early renewals of subscriptions. To support early renewals, you must enable the new QLM setting "Next Payment Date based on schedule". |
  | 100 | 98 |  |
  | 101 | 99 | = 2.2.9 - 12/30/2020 = |
  | 102 | 100 | Renamed plugin to: WooCommerce - Quick License Manager Integration |
  | 103 | 101 | Fixed issue determining the expiry date when renewing a subscription following a change in the latest version of WooCommerce Subscriptions. |
  | 104 | 102 |  |
  | 105 | 103 | = 2.2.8 - 12/29/2020 = |
  | 106 | 104 | Fixed issue determining the expiry date of a subscription following a change in the latest version of WooCommerce Subscriptions. |
  | 107 | 105 |  |
  | 108 | 106 | = 2.2.7 - 12/13/2020 = |
  | 109 | 107 | For downloadable products, the license key was not included in the email because the Order Status is set to Completed before the license key is created. |
  | 110 | 108 | To resolve this, you need to install the WooCommerce Order Status Control plugin and set the "Orders Auto-Complete" option to None. |
  | 111 | 109 |  |
  | 112 | 110 | = 2.2.6 - 11/07/2020 = |
  | 113 | 111 | Fixed regression issue when renewing a subscription. |
  | 114 | 112 |  |
  | 115 | 113 | = 2.2.5 - 11/05/2020 = |
  | 116 | 114 | Fixed regression issue when renewing a subscription. |
  | 117 | 115 |  |
  | 118 | 116 | = 2.2.4 - 11/04/2020 = |
  | 119 | 117 | Fixed issue when number of items in order > 1. |
  | 120 | 118 | Fixed issue when renewing the maintenance plan of a product and the quantity > 1. |
  | 121 | 119 |  |
  | 122 | 120 | = 2.2.3 - 10/29/2020 = |
  | 123 | 121 | Fixed issue with QLM plugin setting the Order to Completed when no QLM items are in the order. |
  | 124 | 122 |  |
  | 125 | 123 | = 2.2.2 - 10/22/2020 = |
  | 126 | 124 | Fixed issue if WooCommerce Subscriptions is not installed. |
  | 127 | 125 |  |
  | 128 | 126 | = 2.2.0 - 10/13/2020 = |
  | 129 | 127 | Added support orders that contain subscription products with different durations. |
  | 130 | 128 | Added support for downloadable products. |
  | 131 | 129 | Added support for creating a dedicated log file. You can configure this option in Settings. |
  | 132 | 130 | Added a global setting for enabling QLM emails. You can configure this option in Settings. |
  | 133 | 131 |  |
  | 134 | 132 | = 2.1.4 - 10/09/2020 = |
  | 135 | 133 | Added support for revoking licenses when a subscription is cancelled. You must enable this option in Settings. |
  | 136 | 134 | Updated support for revoking licenses when an order is cancelled. You can now enable this option in Settings. |
  | 137 | 135 |  |
  | 138 | 136 | = 2.1.3 - 10/06/2020 = |
  | 139 | 137 | Fixed bug renewing a subscription. |
  | 140 | 138 |  |
  | 141 | 139 | = 2.1.2 - 10/05/2020 = |
  | 142 | 140 | Fixed bug when renewing a subscription . The subscription status was not switching from On Hold to Active. |
  | 143 | 141 | The QLM expiry date of a subscription is now set to the WooCommerce renewal date. There's no need to set the is\_expduration custom field. |
  | 144 | 142 |  |
  | 145 | 143 | = 2.0.10 - 07/26/2020 = |
  | 146 | 144 | Fixed bug when setting the user role upon purchase. The plugin was replacing the user role instead of adding a new user role. |
  | 147 | 145 |  |
  | 148 | 146 | = 2.0.8 - 5/5/2020 = |
  | 149 | 147 | Changed monthly subscription to be 31 days instead of 30 days. |
  | 150 | 148 | Validated compatibility with Wordpress 5.4 and WooCommerce 4.0. |
  | 151 | 149 |  |
  | 152 | 150 | = 2.0.7 - 2/7/2020 = |
  | 153 | 151 | Added integration with 3rd party plugin WooCommerce Custom Product Addons to support product upgrades. |
  | 154 | 152 | Added new settings to automatically change the user role once an order is completed. |
  | 155 | 153 |  |
  | 156 | 154 | = 2.0.6 - 12/25/2019 = |
  | 157 | 155 | Removed debug messages. |
  | 158 | 156 |  |
  | 159 | 157 | = 2.0.5 - 12/18/2019 = |
  | 160 | 158 | Added support for processing guest orders. |
  | 161 | 159 | Added support for revoking a license when a subscription is cancelled. |
  | 162 | 160 |  |
  | 163 | 161 | = 2.0.4 - 12/14/2019 = |
  | 164 | 162 | Fixed issue with WooCommerce Subscriptions whereby the subscription ID was not recorded in the QLM database. |
  | 165 | 163 |  |
  | 166 | 164 | = 2.0.3 - 11/14/2019 = |
  | 167 | 165 | You can now specify a list of categories that QLM will process. |
  | 168 | 166 |  |
  | 169 | 167 | = 2.0.2 - 11/30/2018 = |
  | 170 | 168 | Added support for specifying QLM features are variations |
  | 171 | 169 | Added support for specifying QLM product properties are variations |
  | 172 | 170 | Added support for specifying the QLM Maintenance Plan period as a variation |
  | 173 | 171 | Added support for the following new arguments: is\_maintduration, is\_usemultipleactivationskey, is\_affiliateid |
  | 174 | 172 |  |
  | 175 | 173 | = 1.9.14 - 08/03/2018 = |
  | 176 | 174 | Added support for configuring a Maintenance Plan as a Subscription Product |
  | 177 | 175 |  |
  | 178 | 176 | = 1.9.13 - 08/17/2017 = |
  | 179 | 177 | Added the ability to skip sending a QLM Email since WooCommerce can now send emails directly. To skip sending emails, set the is\_send\_mail custom field to false. |
  | 180 | 178 |  |
  | 181 | 179 | = 1.9.12 - 08/17/2017 = |
  | 182 | 180 | Changed greeting in email from lastname/firstname to firstname/lastname |
  | 183 | 181 |  |
  | 184 | 182 | = 1.9.11 - 08/17/2017 = |
  | 185 | 183 | Fixed default email subject template (pass 2). |
  | 186 | 184 |  |
  | 187 | 185 | = 1.9.10 - 08/17/2017 = |
  | 188 | 186 | Fixed default email subject template |
  | 189 | 187 |  |
  | 190 | 188 | = 1.9.9 - 08/16/2017 = |
  | 191 | 189 | Added support for customizing the subject of the confirmation email |
  | 192 | 190 |  |
  | 193 | 191 | = 1.9.8 - 08/16/2017 = |
  | 194 | 192 | Minor regression issue in the previous update. |
  | 195 | 193 |  |
  | 196 | 194 | = 1.9.6 - 08/16/2017 = |
  | 197 | 195 | Fixed issue when emailing orders for products of type variable. |
  | 198 | 196 |  |
  | 199 | 197 | = 1.9.5 - 06/04/2017 = |
  | 200 | 198 | Fixed issue when emailing orders containing multiple products. |
  | 201 | 199 |  |
  | 202 | 200 | = 1.9.4 - 06/04/2017 = |
  | 203 | 201 | Fixed issue with orders containing multiple products. |
  | 204 | 202 |  |
  | 205 | 203 | = 1.9.3 - 03/14/2017 = |
  | 206 | 204 | Fixed regression issue for non subscription products - if the WooCommerce Subscriptions plugin was not installed, regular products did not work as expected. |
  | 207 | 205 |  |
  | 208 | 206 | = 1.9.2 - 12/30/2016 = |
  | 209 | 207 | Added support for specifying is\_additionalactivations. |
  | 210 | 208 |  |
  | 211 | 209 | = 1.9.1 - 12/30/2016 = |
  | 212 | 210 | Fixed issue with simple ubscription products. |
  | 213 | 211 | Added support for specifying is\_licensemodel. |
  | 214 | 212 |  |
  | 215 | 213 | = 1.8.3 - 03/26/2016 = |
  | 216 | 214 | Fixed issue with subscription duration not being set consistently. |
  | 217 | 215 |  |
  | 218 | 216 | = 1.8.2 - 03/06/2016 = |
  | 219 | 217 | Fixed authentication issue. |
  | 220 | 218 |  |
  | 221 | 219 | = 1.8.1 - 02/18/2016 = |
  | 222 | 220 | Added support for specifying is\_features, is\_expdate and is\_expduration. |
  | 223 | 221 |  |
  | 224 | 222 | = 1.7.1 - 11/29/2015 = |
  | 225 | 223 | Fixed Readme.txt, added icon for plugin directory. |
  | 226 | 224 |  |
  | 227 | 225 |  |
  | 228 | 226 |  |
  | 229 | 227 |  |
* ## [quick-license-manager/trunk/classes/qlm\_emails.php](/changeset/3198437/quick-license-manager/trunk/classes/qlm_emails.php?old=3198385&old_path=quick-license-manager%2Ftrunk%2Fclasses%2Fqlm_emails.php "Show the [3198391:3198437] differences restricted to quick-license-manager/trunk/classes/qlm_emails.php")

  | [r3198391](/browser/quick-license-manager/trunk/classes/qlm_emails.php?rev=3198385#L1 "Show revision 3198391 of this file in browser") | [r3198437](/browser/quick-license-manager/trunk/classes/qlm_emails.php?rev=3198437#L1 "Show revision 3198437 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | if ( !class\_exists('QLM\_Emails')){ |
  | 3 | 3 | class QLM\_Emails{ |
  | 4 | 4 |  |
  | 5 | 5 | function \_\_construct(){ |
  | 6 | 6 |  |
  | 7 | 7 |  |
  | 8 | 8 | } |
  | 9 | 9 |  |
  | 10 | 10 | function show\_default\_footer(){ |
  | 11 | 11 | ob\_start(); |
  | 12 | 12 |  |
  | 13 | 13 | ?> |
  | 14 | 14 |  |
  | 15 | 15 | <div style = ""> |
  | 16 | 16 |  |
  | 17 | 17 | <h3>Powered by QLM </h3><br/> |
  | 18 | 18 |  |
  | 19 | 19 | </div> |
  | 20 | 20 |  |
  | 21 | 21 | <?php |
  | 22 | 22 |  |
  | 23 | 23 | $html = ob\_get\_clean(); |
  | 24 | 24 |  |
  | 25 | 25 | return $html; |
  | 26 | 26 | } |
  | 27 | 27 |  |
  | 28 | 28 | function show\_default\_header(){ |
  | 29 | 29 | ob\_start(); |
  | 30 | 30 |  |
  | 31 | 31 | ?> |
  | 32 | 32 |  |
  | 33 | 33 | <div style = ""> |
  | 34 | 34 |  |
  | 35 | 35 | <h3>Hi #customername#, </h3><br/> |
  | 36 | 36 |  |
  | 37 | 37 | </div> |
  | 38 | 38 |  |
  | 39 | 39 | <?php |
  | 40 | 40 |  |
  | 41 | 41 | $html = ob\_get\_clean(); |
  | 42 | 42 |  |
  | 43 | 43 | return $html; |
  | 44 | 44 | } |
  | 45 | 45 |  |
  | 46 | 46 | function show\_default\_subject(){ |
  | 47 | 47 | ob\_start(); |
  | 48 | 48 |  |
  | 49 | 49 | ?>Order ID: #order\_id#<?php |
  | 50 | 50 |  |
  | 51 | 51 | $html = ob\_get\_clean(); |
  | 52 | 52 |  |
  | 53 | 53 | return $html; |
  | 54 | 54 | } |
  | 55 | 55 |  |
  | 56 | 56 | //Shows email tempaltes in admin |
  | 57 | 57 | function show\_email\_templates($qlm\_products){ |
  | 58 | 58 | $qml\_product\_id = ''; |
  | 59 | 59 | if(isset($\_POST['submit\_qlm\_products'])){ |
  | 60 | 60 | $qml\_product\_id = sanitize\_text\_field ($\_POST['submit\_qlm\_products']); |
  | 61 | 61 | } |
  | 62 | 62 | ?> |
  | 63 | 63 | <div class="tw-bs container" style=""><!-- start container --> |
  | 64 | 64 | <form method="post" action=""> |
  | 65 | 65 | <div class="row"> |
  | 66 | 66 | <div class="col-md-12" style="margin-top:1em;" > |
  | 67 | 67 | <h1>Email Templates</h2> |
  | 68 | 68 | </div> |
  | 69 | 69 | </div> |
  | 70 | 70 | <!-- Subject --> |
  | 71 | 71 | <div class="row"> |
  | 72 | 72 | <div class="col-md-10" style="margin-top:1em;" > |
  | 73 | 73 | <h2 style="text-align:center;">Subject</h2> |
  | 74 | 74 | </div> |
  | 75 | 75 | </div> |
  | 76 | 76 | <div class="col-md-2" >&nbsp;</div> |
  | 77 | 77 |  |
  | 78 | 78 | <div class="row"> |
  | 79 | 79 | <div class="col-md-10" > |
  | 80 | 80 | <?php |
  | 81 | 81 |  |
  | 82 | 82 | $default\_subject=$this->show\_default\_subject(); |
  | 83 | 83 | $email\_template = get\_option( 'qlm\_subject', $default\_subject ); |
  | 84 | 84 | $editor\_id='qlm\_html\_subject'; |
  | 85 | 85 | $settings = array( 'media\_buttons' => false, |
  | 86 | 86 | 'textarea\_rows' => '1', |
  | 87 | 87 | 'tinymce'=> false, |
  | 88 | 88 | 'teeny' => true |
  | 89 | 89 | ); |
  | 90 | 90 |  |
  | 91 | 91 | wp\_editor( $email\_template, $editor\_id, $settings); |
  | 92 | 92 |  |
  | 93 | 93 | ?> |
  | 94 | 94 |  |
  | 95 | 95 | </div> |
  | 96 | 96 | <div class="col-md-2" >&nbsp;</div> |
  | 97 | 97 | </div> |
  | 98 | 98 | <!-- Subject --> |
  | 99 | 99 |  |
  | 100 | 100 | <div class="row"> |
  | 101 | 101 | <div class="col-md-10" style="margin-top:1em;" > |
  | 102 | 102 | <h2 style="text-align:center;">Header</h2> |
  | 103 | 103 | </div> |
  | 104 | 104 | </div> |
  | 105 | 105 | <div class="col-md-2" >&nbsp;</div> |
  | 106 | 106 |  |
  | 107 | 107 | <div class="row"> |
  | 108 | 108 | <div class="col-md-10" > |
  | 109 | 109 | <?php |
  | 110 | 110 |  |
  | 111 | 111 | $default\_template=$this->show\_default\_header(); |
  | 112 | 112 | $email\_template = get\_option( 'qlm\_header', $default\_template ); |
  | 113 | 113 | $editor\_id='qlm\_html\_header'; |
  | 114 | 114 | $settings = array( 'media\_buttons' => false, |
  | 115 | 115 | 'editor\_height' => '200px' |
  | 116 | 116 | ); |
  | 117 | 117 |  |
  | 118 | 118 | wp\_editor( $email\_template, $editor\_id, $settings); |
  | 119 | 119 |  |
  | 120 | 120 | ?> |
  | 121 | 121 |  |
  | 122 | 122 | </div> |
  | 123 | 123 | <div class="col-md-2" >&nbsp;</div> |
  | 124 | 124 | </div> |
  | 125 | 125 | <div class="row"> |
  | 126 | 126 | <div class="col-md-12" ><h3>Hashtags List</h3></div> |
  | 127 | 127 | </div> |
  | 128 | 128 | <div class="row"> |
  | 129 | 129 | <div class="col-md-12" > |
  | 130 | 130 | <ul> |
  | 131 | 131 | <li>#customername#</li> |
  | 132 | 132 | </ul> |
  | 133 | 133 | </div> |
  | 134 | 134 | </div> |
  | 135 | 135 | <div class="row"> |
  | 136 | 136 | <div class="col-md-10" style="margin-top:1em;" > |
  | 137 | 137 | <h1 style="text-align:center;">Body</h1> |
  | 138 | 138 | </div> |
  | 139 | 139 | </div> |
  | 140 | 140 | <div class="row"> |
  | 141 | 141 | <div class="col-md-10" > |
  | 142 | 142 | <div style="width:28em;"> |
  | 143 | 143 | <select class="form-control" required name="submit\_qlm\_products" onchange="this.form.submit()"> |
  | 144 | 144 | <?php if ($qml\_product\_id){?> |
  | 145 |  | <option value="<?php echo ~~sanitize\_text\_field($qml\_product\_id) ?>"><?php echo get\_the\_title(sanitize\_text\_field~~($qml\_product\_id)); ?></option> |
  |  | 145 | <option value="<?php echo esc\_attr($qml\_product\_id) ?>"><?php echo get\_the\_title(esc\_attr($qml\_product\_id)); ?></option> |
  | 146 | 146 | <?php } else { ?> |
  | 147 | 147 | <option value="<?php  ?>">Select Product</option> |
  | 148 | 148 | <?php } |
  | 149 | 149 | foreach($qlm\_products as $p){ |
  | 150 | 150 | $product\_id=$p->ID; |
  | 151 | 151 | $product\_title=$p->post\_title; |
  | 152 | 152 | ?><option value="<?php echo $product\_id; ?>"><?php echo $product\_title;?></option> <?php |
  | 153 | 153 | } |
  | 154 | 154 | ?> |
  | 155 | 155 | </select> |
  | 156 | 156 | </div> |
  | 157 | 157 | </div> |
  | 158 | 158 | <div class="col-md-2" >&nbsp;</div> |
  | 159 | 159 | </div> |
  | 160 | 160 | <?php |
  | 161 | 161 | if (!empty($qml\_product\_id)){ ?> |
  | 162 | 162 | <div class="row"> |
  | 163 | 163 | <div class="col-md-10" > |
  | 164 | 164 | <?php |
  | 165 | 165 | $email\_template = get\_post\_meta($qml\_product\_id,'qlm\_email\_html',true); |
  | 166 | 166 | $editor\_id='qlm\_html\_mail'; |
  | 167 | 167 | $settings = array( 'media\_buttons' => false); |
  | 168 | 168 |  |
  | 169 | 169 | if($email\_template){ |
  | 170 | 170 | wp\_editor( $email\_template, $editor\_id, $settings); |
  | 171 | 171 | }else{ |
  | 172 | 172 | $default\_template=$this->show\_default\_template\_html(); |
  | 173 | 173 | wp\_editor( $default\_template, $editor\_id, $settings); |
  | 174 | 174 | } ?> |
  | 175 |  | <input type="hidden" value="<?php echo ~~sanitize\_text\_field~~($qml\_product\_id);?>" name="qlm\_pid"> |
  |  | 175 | <input type="hidden" value="<?php echo esc\_attr($qml\_product\_id);?>" name="qlm\_pid"> |
  | 176 | 176 | </div> |
  | 177 | 177 | <div class="col-md-2" >&nbsp;</div> |
  | 178 | 178 | </div> |
  | 179 | 179 | <div class="row"> |
  | 180 | 180 | <div class="col-md-12" ><h3>Hashtags List</h3></div> |
  | 181 | 181 | </div> |
  | 182 | 182 | <div class="row"> |
  | 183 | 183 | <div class="col-md-12" > |
  | 184 | 184 | <ul> |
  | 185 | 185 | <li>#customername#</li> |
  | 186 | 186 | <li>#product#</li> |
  | 187 | 187 | <li>#LicenseKeys#</li> |
  | 188 | 188 | </ul> |
  | 189 | 189 | </div> |
  | 190 | 190 | </div> |
  | 191 | 191 |  |
  | 192 | 192 | <div class="row"> |
  | 193 | 193 | <div class="col-md-10" style="margin-top:1em;" > |
  | 194 | 194 | <h2 style="text-align:center;">Footer</h2> |
  | 195 | 195 | </div> |
  | 196 | 196 | </div> |
  | 197 | 197 | <div class="col-md-2" >&nbsp;</div> |
  | 198 | 198 | <div class="row"> |
  | 199 | 199 | <div class="col-md-10" > |
  | 200 | 200 | <?php |
  | 201 | 201 |  |
  | 202 | 202 | $default\_footer = $this->show\_default\_footer(); |
  | 203 | 203 | $email\_template = get\_option( 'qlm\_footer', $default\_footer ); |
  | 204 | 204 | $editor\_id='qlm\_html\_footer'; |
  | 205 | 205 | $settings = array( 'media\_buttons' => false, |
  | 206 | 206 | 'editor\_height' => '200px' |
  | 207 | 207 | ); |
  | 208 | 208 |  |
  | 209 | 209 | wp\_editor( $email\_template, $editor\_id, $settings); |
  | 210 | 210 |  |
  | 211 | 211 | ?> |
  | 212 | 212 | </div> |
  | 213 | 213 | <div class="col-md-2" >&nbsp;</div> |
  | 214 | 214 | </div> |
  | 215 | 215 | <div class="row"> |
  | 216 | 216 | <div class="col-md-12" style="margin-top:1em;"> |
  | 217 | 217 | <input type="submit" name="submit\_template" value="Update" class="btn btn-primary btn-lg" style="width:10em" /> |
  | 218 | 218 | </div> |
  | 219 | 219 | </div> |
  | 220 | 220 | <?php   } ?> |
  | 221 | 221 | </form> |
  | 222 | 222 | </div>  <!-- end container --> |
  | 223 | 223 | <?php |
  | 224 | 224 | } |
  | 225 | 225 |  |
  | 226 | 226 | function get\_html\_of\_each\_product($order, $product\_id, $order\_id, $license\_keys) |
  | 227 | 227 | { |
  | 228 | 228 | if (QLM\_DEBUG) |
  | 229 | 229 | { |
  | 230 | 230 | $order->add\_order\_note('QLM - Updating Email for product id:'.$product\_id.' and license key:'.$license\_keys); |
  | 231 | 231 | } |
  | 232 | 232 |  |
  | 233 | 233 | $product\_title = get\_the\_title($product\_id); |
  | 234 | 234 |  |
  | 235 | 235 | //$user = get\_userdata(); |
  | 236 | 236 | //$user\_name = $user->display\_name; |
  | 237 | 237 | //$user\_email = $user->user\_email; |
  | 238 | 238 |  |
  | 239 | 239 | $user\_name = $order->billing\_first\_name.' '.$order->billing\_last\_name; |
  | 240 | 240 | $user\_email = $order->billing\_email; |
  | 241 | 241 |  |
  | 242 | 242 | $email\_template = get\_post\_meta($product\_id,'qlm\_email\_html',true); |
  | 243 | 243 |  |
  | 244 | 244 | if(empty($email\_template)) |
  | 245 | 245 | { |
  | 246 | 246 | $email\_template = $this->show\_default\_template\_html(); |
  | 247 | 247 | } |
  | 248 | 248 |  |
  | 249 | 249 | if (QLM\_DEBUG) |
  | 250 | 250 | { |
  | 251 | 251 | $order->add\_order\_note('QLM - Updating Email - getting license key for product id:'.$product\_id); |
  | 252 | 252 | } |
  | 253 | 253 |  |
  | 254 | 254 | //$license\_keys = get\_post\_meta( $order\_id, '\_qlm\_license\_keys', true ); |
  | 255 | 255 |  |
  | 256 | 256 | if (QLM\_DEBUG) |
  | 257 | 257 | { |
  | 258 | 258 | $order->add\_order\_note('QLM - Updating Email for license key2:'.$license\_keys); |
  | 259 | 259 | } |
  | 260 | 260 |  |
  | 261 | 261 | $email\_template = str\_replace( '#customername#' ,$user\_name, $email\_template ); |
  | 262 | 262 | $email\_template = str\_replace( '#product#' ,$product\_title, $email\_template ); |
  | 263 | 263 | $email\_template = str\_replace( '#LicenseKeys#' ,$license\_keys, $email\_template ); |
  | 264 | 264 |  |
  | 265 | 265 | return $email\_template; |
  | 266 | 266 | } |
  | 267 | 267 |  |
  | 268 | 268 | /\* |
  | 269 | 269 | Sends email for an order |
  | 270 | 270 | $user\_id  user id of current customer |
  | 271 | 271 | $order\_id  order id of current order |
  | 272 | 272 | \*/ |
  | 273 | 273 | function send\_email($order, $email, $send\_email\_html, $email\_subject) |
  | 274 | 274 | { |
  | 275 | 275 | if (QLM\_DEBUG) |
  | 276 | 276 | { |
  | 277 | 277 | $order->add\_order\_note('QLM - Sending mail to: '.$email); |
  | 278 | 278 | } |
  | 279 | 279 |  |
  | 280 | 280 | add\_filter( 'wp\_mail\_content\_type',array(&$this,'wp\_set\_content\_type' )); |
  | 281 | 281 | $send\_mail = wp\_mail( $email, $email\_subject, $send\_email\_html ); |
  | 282 | 282 | remove\_filter( 'wp\_mail\_content\_type', array(&$this,'wp\_set\_content\_type' )); |
  | 283 | 283 | } |
  | 284 | 284 |  |
  | 285 | 285 | //wp function |
  | 286 | 286 | function wp\_set\_content\_type(){ |
  | 287 | 287 |  |
  | 288 | 288 | return "text/html"; |
  | 289 | 289 |  |
  | 290 | 290 | } |
  | 291 | 291 |  |
  | 292 | 292 | //It is default email templates and will be used if none has been created by admin |
  | 293 | 293 | function show\_default\_template\_html(){ |
  | 294 | 294 |  |
  | 295 | 295 | ob\_start(); |
  | 296 | 296 |  |
  | 297 | 297 | ?> |
  | 298 | 298 |  |
  | 299 | 299 | <div style = ""> |
  | 300 | 300 |  |
  | 301 | 301 | Thank you for purchasing #product#.<br/> |
  | 302 | 302 |  |
  | 303 | 303 | Your licence key is: #LicenseKeys#<br/><br> |
  | 304 | 304 |  |
  | 305 | 305 | </div> |
  | 306 | 306 |  |
  | 307 | 307 | <?php |
  | 308 | 308 |  |
  | 309 | 309 | $html = ob\_get\_clean(); |
  | 310 | 310 |  |
  | 311 | 311 | return $html; |
  | 312 | 312 |  |
  | 313 | 313 | } |
  | 314 | 314 |  |
  | 315 | 315 | function nmt\_quicktags\_buttons( $qt\_init) |
  | 316 | 316 | { |
  | 317 | 317 | $del\_buttons = array('del','ins','img','code'); |
  | 318 | 318 | $qt\_init['buttons'] = implode(',', array\_diff(explode(',',$qt\_init['buttons']), $del\_buttons)); |
  | 319 | 319 | return $qt\_init; |
  | 320 | 320 | } |
  | 321 | 321 |  |
  | 322 | 322 |  |
  | 323 | 323 | }// calss ends |
  | 324 | 324 | }//if ends |
  | 325 | 325 |  |
* ## [quick-license-manager/trunk/wc\_qlm.php](/changeset/3198437/quick-license-manager/trunk/wc_qlm.php?old=3198391&old_path=quick-license-manager%2Ftrunk%2Fwc_qlm.php "Show the [3198391:3198437] differences restricted to quick-license-manager/trunk/wc_qlm.php")

  | [r3198391](/browser/quick-license-manager/trunk/wc_qlm.php?rev=3198391#L1 "Show revision 3198391 of this file in browser") | [r3198437](/browser/quick-license-manager/trunk/wc_qlm.php?rev=3198437#L1 "Show revision 3198437 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | /\*\* |
  | 4 | 4 | \* Plugin Name: WooCommerce Quick License Manager Integration |
  | 5 | 5 | \* Plugin URI: https://wordpress.org/plugins/quick-license-manager/ |
  | 6 | 6 | \* Description: Automates the creation of license keys when orders are placed with WooCommerce |
  | 7 |  | \* Version: 2.4.1~~7~~ |
  |  | 7 | \* Version: 2.4.18 |
  | 8 | 8 | \* Author: Soraco Technologies Inc. |
  | 9 | 9 | \* Author URI: https://soraco.co |
  | 10 | 10 | \* WC requires at least: 4.0.0 |
  | 11 | 11 | \* WC tested up to: 9.4.2 |
  | 12 | 12 | \*/ |
  | 13 | 13 |  |
  | 14 | 14 | define("QLM\_DEBUG", false); |
  | 15 | 15 | define("QLM\_ENABLE\_SUBSCRIPTION", true); |
  | 16 | 16 |  |
  | 17 | 17 |  |
  | 18 | 18 | require\_once(\_\_DIR\_\_ ."/classes/qlm\_api.php"); |
  | 19 | 19 | require\_once(\_\_DIR\_\_ ."/classes/qlm\_api\_view.php"); |
  | 20 | 20 | require\_once(\_\_DIR\_\_ ."/classes/qlm\_emails.php"); |
  | 21 | 21 |  |
  | 22 | 22 | // |
  | 23 | 23 | //Debug Message Next Index: 615 |
  | 24 | 24 | // |
  | 25 | 25 |  |
  | 26 | 26 | function debug\_message($event\_id, $order, $function\_name, $message) |
  | 27 | 27 | { |
  | 28 | 28 |  |
  | 29 | 29 | // if (QLM\_DEBUG && ($order != '')) |
  | 30 | 30 | $qlm\_enable\_log = get\_option( 'qlm\_enable\_log'); |
  | 31 | 31 |  |
  | 32 | 32 | if (($qlm\_enable\_log == true) && ($order != '')) |
  | 33 | 33 | { |
  | 34 | 34 | //$order->add\_order\_note($message); |
  | 35 | 35 | qlm\_wordpress\_log ($event\_id, $order, $function\_name, $message) ; |
  | 36 | 36 | } |
  | 37 | 37 | } |
  | 38 | 38 |  |
  | 39 | 39 | function qlm\_wordpress\_log ($event\_id, $order, $function\_name, $str) |
  | 40 | 40 | { |
  | 41 | 41 | $uploads  = wp\_upload\_dir( null, false ); |
  | 42 | 42 | $logs\_dir = $uploads['basedir'] . '/wc-logs'; |
  | 43 | 43 |  |
  | 44 | 44 | if ( ! is\_dir( $logs\_dir ) ) { |
  | 45 | 45 | mkdir( $logs\_dir, 0755, true ); |
  | 46 | 46 | } |
  | 47 | 47 |  |
  | 48 | 48 | $logfile = $logs\_dir . '/' . 'qlm-'.$order->id.'.log'; |
  | 49 | 49 |  |
  | 50 | 50 | $d = date("j-M-Y H:i:s e"); |
  | 51 | 51 | error\_log("[$d] [$event\_id] [OrderID: $order->id] [$function\_name] $str\r\n", 3, $logfile); |
  | 52 | 52 | } |
  | 53 | 53 |  |
  | 54 | 54 | /\* |
  | 55 | 55 | function get\_product\_addon\_value($order, $field) |
  | 56 | 56 | { |
  | 57 | 57 | foreach ($order->get\_items() as $item\_id => $item) |
  | 58 | 58 | { |
  | 59 | 59 | $meta\_data = $item->get\_meta(WCPA\_ORDER\_META\_KEY); |
  | 60 | 60 | // $meta\_data this $meta\_data will have all the user submited data. |
  | 61 | 61 | // You can iterate through this and get the required value |
  | 62 | 62 | $fieldValue= ''; |
  | 63 | 63 |  |
  | 64 | 64 | if (is\_array($meta\_data) || is\_object($meta\_data)) |
  | 65 | 65 | { |
  | 66 | 66 | foreach ($meta\_data as $v) |
  | 67 | 67 | { |
  | 68 | 68 | if($v['name']== $field) |
  | 69 | 69 | { |
  | 70 | 70 | $fieldValue = $v['value']; |
  | 71 | 71 | debug\_message (5, $order, $field.': '.$fieldValue); |
  | 72 | 72 | return $fieldValue; |
  | 73 | 73 | } |
  | 74 | 74 | } |
  | 75 | 75 | } |
  | 76 | 76 | } |
  | 77 | 77 |  |
  | 78 | 78 | return ""; |
  | 79 | 79 | } |
  | 80 | 80 | \*/ |
  | 81 | 81 |  |
  | 82 | 82 | // Get the value of metadata associated to the product item being Order |
  | 83 | 83 | // This is used in the context of a product upgrade where the customer must enter a previous Activation Key |
  | 84 | 84 | // This feature requires a plugin called "WooCommerce Custom Product Addons" |
  | 85 | 85 | function get\_item\_addon\_value($order, $item, $field) |
  | 86 | 86 | { |
  | 87 | 87 | $qlm\_product\_addon = get\_option( 'qlm\_product\_addon'); |
  | 88 | 88 |  |
  | 89 | 89 | if ($qlm\_product\_addon == false) |
  | 90 | 90 | { |
  | 91 | 91 | debug\_message (9, $order, \_\_FUNCTION\_\_ , 'WooCommerce Custom Product Add-on is not enabled.'); |
  | 92 | 92 | return; |
  | 93 | 93 | } |
  | 94 | 94 |  |
  | 95 | 95 | if (is\_plugin\_active('woo-custom-product-addons/start.php') == false) |
  | 96 | 96 | { |
  | 97 | 97 | debug\_message (610, $order, \_\_FUNCTION\_\_ , 'WooCommerce Custom Product Add-on is not installed .'); |
  | 98 | 98 | return; |
  | 99 | 99 | } |
  | 100 | 100 |  |
  | 101 | 101 |  |
  | 102 | 102 | $meta\_data = $item->get\_meta(WCPA\_ORDER\_META\_KEY); |
  | 103 | 103 |  |
  | 104 | 104 | if (is\_null($meta\_data)) |
  | 105 | 105 | { |
  | 106 | 106 | debug\_message (12, $order, \_\_FUNCTION\_\_ , ':metadata is null .'); |
  | 107 | 107 | return ""; |
  | 108 | 108 | } |
  | 109 | 109 |  |
  | 110 | 110 |  |
  | 111 | 111 |  |
  | 112 | 112 | // $meta\_data this $meta\_data will have all the user submited data. |
  | 113 | 113 | // You can iterate through this and get the required value |
  | 114 | 114 | $fieldValue= ''; |
  | 115 | 115 |  |
  | 116 | 116 | if (is\_array($meta\_data) || is\_object($meta\_data)) |
  | 117 | 117 | { |
  | 118 | 118 | foreach ($meta\_data as $v) |
  | 119 | 119 | { |
  | 120 | 120 | if($v['name']== $field) |
  | 121 | 121 | { |
  | 122 | 122 | $fieldValue = $v['value']; |
  | 123 | 123 | debug\_message (10, $order, \_\_FUNCTION\_\_ , $field.': '.$fieldValue); |
  | 124 | 124 | return $fieldValue; |
  | 125 | 125 | } |
  | 126 | 126 | else |
  | 127 | 127 | { |
  | 128 | 128 | debug\_message (11, $order, \_\_FUNCTION\_\_ , $v['name'].': '.$v['value']); |
  | 129 | 129 | } |
  | 130 | 130 | } |
  | 131 | 131 | } |
  | 132 | 132 |  |
  | 133 | 133 |  |
  | 134 | 134 | return ""; |
  | 135 | 135 | } |
  | 136 | 136 |  |
  | 137 | 137 | function change\_role\_on\_purchase( $order ) |
  | 138 | 138 | { |
  | 139 | 139 | $qlm\_user\_role = get\_option( 'qlm\_user\_role'); |
  | 140 | 140 |  |
  | 141 | 141 | debug\_message (15, $order, \_\_FUNCTION\_\_ , 'Start setting user role to: '.$qlm\_user\_role); |
  | 142 | 142 |  |
  | 143 | 143 | if (is\_null($qlm\_user\_role) || ($qlm\_user\_role == '')) return; |
  | 144 | 144 |  |
  | 145 | 145 | debug\_message (20, $order, \_\_FUNCTION\_\_ , 'setting user role to: '.$qlm\_user\_role); |
  | 146 | 146 |  |
  | 147 | 147 | //$user = get\_userdata($order->user\_id); |
  | 148 | 148 | $user  = new WP\_User($order->user\_id); |
  | 149 | 149 |  |
  | 150 | 150 | if (!is\_null($user)) |
  | 151 | 151 | { |
  | 152 | 152 | debug\_message (25, $order, \_\_FUNCTION\_\_ , 'adding user role: '.$qlm\_user\_role); |
  | 153 | 153 | //$user->remove\_role( 'Customer' ); |
  | 154 | 154 | //$user->set\_role( $qlm\_user\_role ); |
  | 155 | 155 | $user->add\_role( $qlm\_user\_role ); |
  | 156 | 156 | debug\_message (30, $order, \_\_FUNCTION\_\_ , 'added user role: '.$qlm\_user\_role); |
  | 157 | 157 | } |
  | 158 | 158 | } |
  | 159 | 159 |  |
  | 160 | 160 | function qlm\_get\_order\_meta($order\_id, $key, $single = true) |
  | 161 | 161 | { |
  | 162 | 162 | return get\_post\_meta ($order\_id, $key, $single); |
  | 163 | 163 | } |
  | 164 | 164 |  |
  | 165 | 165 | function qlm\_update\_order\_meta($order\_id, $meta\_key, $meta\_value) |
  | 166 | 166 | { |
  | 167 | 167 | update\_post\_meta($order\_id, $meta\_key, $meta\_value); |
  | 168 | 168 | } |
  | 169 | 169 |  |
  | 170 | 170 |  |
  | 171 | 171 | class QlmWebhookSetup{ |
  | 172 | 172 |  |
  | 173 | 173 | public function \_\_construct(){ |
  | 174 | 174 | require\_once 'utils/woo-subs-helper-functions.php'; |
  | 175 | 175 | add\_action('rest\_api\_init',array($this,'create\_custom\_endpoint\_to\_listen')); |
  | 176 | 176 | //add\_action('admin\_menu',array($this,'admin\_options\_for\_API\_Endpoint')); |
  | 177 | 177 | } |
  | 178 | 178 |  |
  | 179 | 179 | function create\_custom\_endpoint\_to\_listen(){ |
  | 180 | 180 | require\_once 'classes/qlm\_webhook.php'; |
  | 181 | 181 | (new QlmWebhook())->init\_route(); |
  | 182 | 182 | } |
  | 183 | 183 | } |
  | 184 | 184 |  |
  | 185 | 185 |  |
  | 186 | 186 | if ( !class\_exists('QLM\_Main')){ |
  | 187 | 187 | class QLM\_Main{ |
  | 188 | 188 |  |
  | 189 | 189 | function \_\_construct() |
  | 190 | 190 | { |
  | 191 | 191 | new QlmWebhookSetup(); |
  | 192 | 192 |  |
  | 193 | 193 | register\_activation\_hook( \_\_FILE\_\_, array(&$this, 'install') ); |
  | 194 | 194 |  |
  | 195 | 195 | add\_action('admin\_menu', array(&$this,'admin\_menu')); |
  | 196 | 196 | add\_action('wp\_enqueue\_scripts', array(&$this, 'wp\_enqueue\_scripts') ); |
  | 197 | 197 | add\_action('admin\_enqueue\_scripts', array(&$this, 'wp\_enqueue\_scripts') ); |
  | 198 | 198 | add\_action('woocommerce\_order\_status\_processing',array(&$this, 'order\_status\_changed')); |
  | 199 | 199 | add\_action('woocommerce\_order\_status\_completed',array(&$this, 'order\_status\_completed')); |
  | 200 | 200 |  |
  | 201 | 201 | add\_action('woocommerce\_add\_to\_cart',array(&$this, 'action\_add\_to\_cart'), 10, 6); |
  | 202 | 202 | add\_action('add\_meta\_boxes', array(&$this,'add\_meta') ); |
  | 203 | 203 |  |
  | 204 | 204 | //add\_action('woocommerce\_payment\_complete',array(&$this, 'so\_payment\_complete')); |
  | 205 | 205 | add\_action('woocommerce\_order\_status\_cancelled',array(&$this, 'action\_woocommerce\_cancelled\_order')); |
  | 206 | 206 | add\_action('woocommerce\_subscription\_status\_cancelled',array(&$this, 'action\_woocommerce\_cancelled\_subscription')); |
  | 207 | 207 |  |
  | 208 | 208 |  |
  | 209 | 209 | // retrieve the early renewal setting in WC |
  | 210 | 210 | //$er = get\_option( 'woocommerce\_subscriptions\_enable\_early\_renewal' ); |
  | 211 | 211 |  |
  | 212 | 212 |  |
  | 213 | 213 | $qlm\_next\_payment\_date\_based\_on\_schedule = get\_option( 'qlm\_next\_payment\_date\_based\_on\_schedule'); |
  | 214 | 214 | if ($qlm\_next\_payment\_date\_based\_on\_schedule == true) |
  | 215 | 215 | { |
  | 216 | 216 | //By default, WooCommerce Subscriptions will calculate the next payment date for a subscription from the time of the last payment. |
  | 217 | 217 | // This filter changes that to preserve the original schedule and calculate the next payment date from the scheduled payment date, |
  | 218 | 218 | // not the time the payment was actually processed. |
  | 219 | 219 | add\_filter( 'wcs\_calculate\_next\_payment\_from\_last\_payment', '\_\_return\_false' ); |
  | 220 | 220 | } |
  | 221 | 221 |  |
  | 222 | 222 | } |
  | 223 | 223 |  |
  | 224 | 224 |  |
  | 225 | 225 |  |
  | 226 | 226 | /\*\* |
  | 227 | 227 | \* Function for `woocommerce\_add\_to\_cart` action-hook. |
  | 228 | 228 | \* |
  | 229 | 229 | \* @param string  $cart\_id          ID of the item in the cart. |
  | 230 | 230 | \* @param integer $product\_id       ID of the product added to the cart. |
  | 231 | 231 | \* @param integer $request\_quantity Quantity of the item added to the cart. |
  | 232 | 232 | \* @param integer $variation\_id     Variation ID of the product added to the cart. |
  | 233 | 233 | \* @param array   $variation        Array of variation data. |
  | 234 | 234 | \* @param array   $cart\_item\_data   Array of other cart item data. |
  | 235 | 235 | \* |
  | 236 | 236 | \* @return void |
  | 237 | 237 | \*/ |
  | 238 | 238 | function action\_add\_to\_cart($cart\_item\_key, $product\_id, $quantity, $variation\_id, $variation, $cart\_item\_data) |
  | 239 | 239 | { |
  | 240 | 240 | if (!is\_null(WC()->session)) |
  | 241 | 241 | { |
  | 242 | 242 | if (isset ($\_GET['is\_userdata1'])) |
  | 243 | 243 | { |
  | 244 | 244 | $userdata1 = $\_GET['is\_userdata1']; |
  | 245 | 245 | if (!is\_null($userdata1)) |
  | 246 | 246 | { |
  | 247 | 247 | WC()->session->set('is\_userdata1', $userdata1); |
  | 248 | 248 | } |
  | 249 | 249 | } |
  | 250 | 250 | } |
  | 251 | 251 |  |
  | 252 | 252 | } |
  | 253 | 253 |  |
  | 254 | 254 |  |
  | 255 | 255 | function so\_payment\_complete( $order\_id ) |
  | 256 | 256 | { |
  | 257 | 257 | $order = wc\_get\_order( $order\_id ); |
  | 258 | 258 |  |
  | 259 | 259 | debug\_message(35, $order, \_\_FUNCTION\_\_ , 'Payment completed. Setting Order Status to Completed.'); |
  | 260 | 260 |  |
  | 261 | 261 | //change\_role\_on\_purchase($order); |
  | 262 | 262 |  |
  | 263 | 263 | if ( order\_contains\_renewal( $order ) ) |
  | 264 | 264 | { |
  | 265 | 265 | debug\_message(40, $order, \_\_FUNCTION\_\_ , 'Detected renewal order id:'.$order\_id); |
  | 266 | 266 | //$parent\_order\_id = WC\_Subscriptions\_Renewal\_Order::get\_parent\_order\_id( $order\_id->id ); |
  | 267 | 267 |  |
  | 268 | 268 | $subscriptions = wcs\_get\_subscriptions\_for\_renewal\_order( $order\_id ); |
  | 269 | 269 |  |
  | 270 | 270 | foreach ( $subscriptions as $subscription ) |
  | 271 | 271 | { |
  | 272 | 272 | debug\_message(45, $order, \_\_FUNCTION\_\_ , 'subscription id:'.$subscription->id); |
  | 273 | 273 |  |
  | 274 | 274 | //$parent\_order\_id = WC\_Subscriptions\_Renewal\_Order::get\_parent\_order\_id( $subscription->id ); |
  | 275 | 275 | $orig\_subscription = $subscription; |
  | 276 | 276 | $orig\_order\_id = $subscription->order->id; |
  | 277 | 277 | // we only support one subscription |
  | 278 | 278 | break; |
  | 279 | 279 | } |
  | 280 | 280 |  |
  | 281 | 281 | if(!empty($orig\_subscription)) |
  | 282 | 282 | { |
  | 283 | 283 | $orig\_subscription->update\_status('active'); |
  | 284 | 284 | } |
  | 285 | 285 | } |
  | 286 | 286 | else |
  | 287 | 287 | { |
  | 288 | 288 | debug\_message(50, $order, \_\_FUNCTION\_\_ , 'Payment completed. This is not a renewal'); |
  | 289 | 289 | } |
  | 290 | 290 |  |
  | 291 | 291 | //debug\_message(55, $order, 'QLM -so\_payment\_complete - Set Order Status to Completed.'); |
  | 292 | 292 | //$order->update\_status('completed'); |
  | 293 | 293 | } |
  | 294 | 294 |  |
  | 295 | 295 | function action\_woocommerce\_cancelled\_order( $order\_id ) |
  | 296 | 296 | { |
  | 297 | 297 | $qlm\_revoke\_when\_order\_cancelled = get\_option( 'qlm\_revoke\_when\_order\_cancelled'); |
  | 298 | 298 |  |
  | 299 | 299 | if ($qlm\_revoke\_when\_order\_cancelled == false) return; |
  | 300 | 300 |  |
  | 301 | 301 | $order = new WC\_Order($order\_id); |
  | 302 | 302 |  |
  | 303 | 303 | $qlm\_v = new QLM\_Api\_View(); |
  | 304 | 304 |  |
  | 305 | 305 | debug\_message(59, $order, \_\_FUNCTION\_\_, 'Cancelling order id:'.$order\_id); |
  | 306 | 306 |  |
  | 307 | 307 | $res = $qlm\_v->send\_revoke\_request($order\_id, ''); |
  | 308 | 308 |  |
  | 309 | 309 | //check return status and handle error |
  | 310 | 310 | if($res['status'] == 'error') |
  | 311 | 311 | { |
  | 312 | 312 | $msg = $date\_time.' '.$res['err\_msg']; |
  | 313 | 313 | debug\_message(60, $order, \_\_FUNCTION\_\_, $msg); |
  | 314 | 314 | } |
  | 315 | 315 | else |
  | 316 | 316 | { |
  | 317 | 317 | $license\_key = $res['license\_key']; |
  | 318 | 318 |  |
  | 319 | 319 | //$old\_meta = get\_post\_meta($order\_id, '\_qlm\_license\_keys', true); |
  | 320 | 320 | $old\_meta = qlm\_get\_order\_meta ($order\_id, '\_qlm\_license\_keys', true); |
  | 321 | 321 |  |
  | 322 | 322 | $update\_meta = $old\_meta.'<br/>'.$license\_key.' Date: '.date("Y/m/d h:i:s"); |
  | 323 | 323 |  |
  | 324 | 324 | qlm\_update\_order\_meta ($order\_id, '\_qlm\_license\_keys', $update\_meta); |
  | 325 | 325 | } |
  | 326 | 326 | } |
  | 327 | 327 |  |
  | 328 | 328 | function action\_woocommerce\_cancelled\_subscription( $subscription ) |
  | 329 | 329 | { |
  | 330 | 330 | $qlm\_revoke\_when\_subscription\_cancelled = get\_option( 'qlm\_revoke\_when\_subscription\_cancelled'); |
  | 331 | 331 |  |
  | 332 | 332 | if ($qlm\_revoke\_when\_subscription\_cancelled == false) return; |
  | 333 | 333 |  |
  | 334 | 334 | $order = $subscription->order; |
  | 335 | 335 |  |
  | 336 | 336 | $qlm\_v = new QLM\_Api\_View(); |
  | 337 | 337 |  |
  | 338 | 338 | debug\_message(65, $order, \_\_FUNCTION\_\_, 'Cancelling subscription id:'.$subscription->id); |
  | 339 | 339 |  |
  | 340 | 340 | $res = $qlm\_v->send\_revoke\_request('', $subscription->id); |
  | 341 | 341 |  |
  | 342 | 342 | //check return status and handle error |
  | 343 | 343 | if($res['status'] == 'error') |
  | 344 | 344 | { |
  | 345 | 345 | $msg = $date\_time.' '.$res['err\_msg']; |
  | 346 | 346 | debug\_message(70, $order,  \_\_FUNCTION\_\_, $msg); |
  | 347 | 347 | } |
  | 348 | 348 | else |
  | 349 | 349 | { |
  | 350 | 350 | $license\_key = $res['license\_key']; |
  | 351 | 351 |  |
  | 352 | 352 | $old\_meta = qlm\_get\_order\_meta ($order->id, '\_qlm\_license\_keys', true); |
  | 353 | 353 |  |
  | 354 | 354 | $update\_meta = $old\_meta.'<br/>'.$license\_key.' Date: '.date("Y/m/d h:i:s"); |
  | 355 | 355 |  |
  | 356 | 356 | qlm\_update\_order\_meta($order->id, '\_qlm\_license\_keys', $update\_meta); |
  | 357 | 357 | } |
  | 358 | 358 | } |
  | 359 | 359 |  |
  | 360 | 360 | //sends email when an order is marked as completed |
  | 361 | 361 | function mail\_on\_order\_completed($order) |
  | 362 | 362 | { |
  | 363 | 363 | global $woocommerce; |
  | 364 | 364 |  |
  | 365 | 365 | $qlm\_send\_mail  = get\_option( 'qlm\_send\_mail'); |
  | 366 | 366 |  |
  | 367 | 367 | if ($qlm\_send\_mail == false) |
  | 368 | 368 | { |
  | 369 | 369 | debug\_message(74, $order,  \_\_FUNCTION\_\_, 'mail\_on\_order\_completed skipped because the option to send mail is disabled.'); |
  | 370 | 370 | return; |
  | 371 | 371 | } |
  | 372 | 372 |  |
  | 373 | 373 | debug\_message(75, $order,  \_\_FUNCTION\_\_, 'mail\_on\_order\_completed triggered'); |
  | 374 | 374 |  |
  | 375 | 375 | //change\_role\_on\_purchase( $order); |
  | 376 | 376 |  |
  | 377 | 377 |  |
  | 378 | 378 | $items = $order->get\_items(); |
  | 379 | 379 |  |
  | 380 | 380 |  |
  | 381 | 381 | foreach($items as $item) |
  | 382 | 382 | { |
  | 383 | 383 | $pid = $item['product\_id']; |
  | 384 | 384 | $option\_send\_mail = get\_post\_meta($pid,'is\_send\_mail', true); |
  | 385 | 385 |  |
  | 386 | 386 | if (($option\_send\_mail == 'no') || ($option\_send\_mail == 'false')) |
  | 387 | 387 | { |
  | 388 | 388 | break; |
  | 389 | 389 | } |
  | 390 | 390 |  |
  | 391 | 391 | } |
  | 392 | 392 |  |
  | 393 | 393 | //$option\_send\_mail = get\_option('is\_send\_mail'); |
  | 394 | 394 | if (($option\_send\_mail == 'no') || ($option\_send\_mail == 'false')) |
  | 395 | 395 | { |
  | 396 | 396 | debug\_message(80, $order,  \_\_FUNCTION\_\_, 'skipping send mail, value:'.$option\_send\_mail); |
  | 397 | 397 | return; |
  | 398 | 398 | } |
  | 399 | 399 | else |
  | 400 | 400 | { |
  | 401 | 401 | debug\_message(85, $order,  \_\_FUNCTION\_\_, 'starting send mail, value:'.$option\_send\_mail); |
  | 402 | 402 | } |
  | 403 | 403 |  |
  | 404 | 404 |  |
  | 405 | 405 | debug\_message(90, $order,  \_\_FUNCTION\_\_, 'mail\_on\_order\_completed processing'); |
  | 406 | 406 |  |
  | 407 | 407 | $qlm\_mail=new QLM\_Emails(); |
  | 408 | 408 |  |
  | 409 | 409 |  |
  | 410 | 410 |  |
  | 411 | 411 | $user\_id = $order->user\_id; |
  | 412 | 412 | $user = get\_userdata($user\_id); |
  | 413 | 413 |  |
  | 414 | 414 | //$user\_name = $user->display\_name; |
  | 415 | 415 | //$user\_email = $user->user\_email; |
  | 416 | 416 |  |
  | 417 | 417 | $user\_name = $order->billing\_last\_name.' '.$order->billing\_first\_name; |
  | 418 | 418 | $user\_email = $order->billing\_email; |
  | 419 | 419 |  |
  | 420 | 420 | debug\_message(95, $order,  \_\_FUNCTION\_\_, 'User ID1:'.$user\_id.'-User Name:'.$user\_name.'-User Email:'.$user\_email); |
  | 421 | 421 |  |
  | 422 | 422 | $default\_header = $qlm\_mail->show\_default\_header(); |
  | 423 | 423 | $email\_header = get\_option( 'qlm\_header', $default\_header ); |
  | 424 | 424 | $email\_header = str\_replace( '#customername#' ,$user\_name, $email\_header ); |
  | 425 | 425 |  |
  | 426 | 426 | $email\_subject= get\_option( 'qlm\_subject', 'Order Confirmation' ); |
  | 427 | 427 | $email\_subject = str\_replace( '#order\_id#' , $order->id, $email\_subject ); |
  | 428 | 428 |  |
  | 429 | 429 |  |
  | 430 | 430 | $template = ""; |
  | 431 | 431 | foreach ($items as $item) |
  | 432 | 432 | { |
  | 433 | 433 | if ($this->is\_qlm\_item ($order, $item) == false) |
  | 434 | 434 | { |
  | 435 | 435 | continue; |
  | 436 | 436 | } |
  | 437 | 437 |  |
  | 438 | 438 | $product\_id = $item['product\_id']; |
  | 439 | 439 |  |
  | 440 | 440 | if($item['variation\_id'] != 0 ) |
  | 441 | 441 | { |
  | 442 | 442 | $licenseKey = qlm\_get\_order\_meta ( $order->id, '\_qlm\_license\_key\_'.$item['variation\_id'], true ); |
  | 443 | 443 | } |
  | 444 | 444 | else |
  | 445 | 445 | { |
  | 446 | 446 | $licenseKey = qlm\_get\_order\_meta ( $order->id, '\_qlm\_license\_key\_'.$product\_id, true ); |
  | 447 | 447 | } |
  | 448 | 448 |  |
  | 449 | 449 | debug\_message(100, $order,  \_\_FUNCTION\_\_, 'Processing email for license key1:'.$licenseKey); |
  | 450 | 450 |  |
  | 451 | 451 | $email\_template = $qlm\_mail->get\_html\_of\_each\_product($order, $product\_id, $order->id, $licenseKey); |
  | 452 | 452 |  |
  | 453 | 453 | debug\_message(105, $order,  \_\_FUNCTION\_\_, 'Done processing email for license key:'.$licenseKey); |
  | 454 | 454 |  |
  | 455 | 455 | $template .= "<br />$email\_template<br />"; |
  | 456 | 456 | } |
  | 457 | 457 |  |
  | 458 | 458 | $default\_footer = $qlm\_mail->show\_default\_footer(); |
  | 459 | 459 | $email\_footer = get\_option( 'qlm\_footer', $default\_footer ); |
  | 460 | 460 |  |
  | 461 | 461 | $send\_email\_html = $email\_header.$template.$email\_footer; |
  | 462 | 462 |  |
  | 463 | 463 |  |
  | 464 | 464 |  |
  | 465 | 465 | $qlm\_mail->send\_email($order, $user\_email, $send\_email\_html, $email\_subject); |
  | 466 | 466 |  |
  | 467 | 467 | } |
  | 468 | 468 |  |
  | 469 | 469 | //adds metabox on order detail screen |
  | 470 | 470 | function add\_meta(){ |
  | 471 | 471 | add\_meta\_box( |
  | 472 | 472 | 'qlm\_license\_key', |
  | 473 | 473 | \_\_( 'License Keys' ), |
  | 474 | 474 | array(&$this,'lincense\_key\_meta\_box'), |
  | 475 | 475 | 'shop\_order', |
  | 476 | 476 | 'advanced', |
  | 477 | 477 | 'default' |
  | 478 | 478 | ); |
  | 479 | 479 | } |
  | 480 | 480 |  |
  | 481 | 481 | //fills meta box in conjection with above |
  | 482 | 482 | function lincense\_key\_meta\_box($post){ |
  | 483 | 483 | global $woocommerce; |
  | 484 | 484 |  |
  | 485 | 485 | ?> |
  | 486 | 486 |  |
  | 487 | 487 | <div style="border: 1px solid lightgray;padding:1em;margin-bottom: 0.5em;"><p><?php echo qlm\_get\_order\_meta( $post->ID, '\_qlm\_license\_keys', true ); ?></p></div> |
  | 488 | 488 | <?php |
  | 489 | 489 |  |
  | 490 | 490 | } |
  | 491 | 491 |  |
  | 492 | 492 | function is\_qlm\_item($order, $product) { |
  | 493 | 493 |  |
  | 494 | 494 | global $woocommerce; |
  | 495 | 495 |  |
  | 496 | 496 | $qlm\_categories = get\_option( 'qlm\_categories'); |
  | 497 | 497 |  |
  | 498 | 498 | debug\_message(110, $order,  \_\_FUNCTION\_\_, 'Determining if Product needs processing - order id:'.$product['name']); |
  | 499 | 499 | debug\_message(115, $order,  \_\_FUNCTION\_\_, 'QLM Categories:'.$qlm\_categories); |
  | 500 | 500 |  |
  | 501 | 501 | if ($qlm\_categories == '') return true; |
  | 502 | 502 |  |
  | 503 | 503 | $qlm\_categories\_array = explode(',', $qlm\_categories); |
  | 504 | 504 | if (empty($qlm\_categories\_array)) |
  | 505 | 505 | { |
  | 506 | 506 | $qlm\_categories\_array = explode(';', $qlm\_categories); |
  | 507 | 507 | } |
  | 508 | 508 |  |
  | 509 | 509 | $product\_id = $product['product\_id']; |
  | 510 | 510 |  |
  | 511 | 511 | foreach($qlm\_categories\_array as $qlm\_cat) |
  | 512 | 512 | { |
  | 513 | 513 | $qlm\_cat = trim ($qlm\_cat); |
  | 514 | 514 |  |
  | 515 | 515 | if ( has\_term( $qlm\_cat, 'product\_cat', $product\_id ) ) |
  | 516 | 516 | { |
  | 517 | 517 | debug\_message(120, $order,  \_\_FUNCTION\_\_, 'Detected product '.$product['name'] .' with category: '.$qlm\_cat.' as a QLM item.'); |
  | 518 | 518 | return true; |
  | 519 | 519 | } |
  | 520 | 520 | else |
  | 521 | 521 | { |
  | 522 | 522 | debug\_message(125, $order,  \_\_FUNCTION\_\_, 'Product '.$product['name'] .' is not a QLM item.'); |
  | 523 | 523 | } |
  | 524 | 524 | } |
  | 525 | 525 |  |
  | 526 | 526 | return false; |
  | 527 | 527 |  |
  | 528 | 528 | } |
  | 529 | 529 |  |
  | 530 | 530 | function order\_status\_changed( $order\_id ) |
  | 531 | 531 | { |
  | 532 | 532 | $order = wc\_get\_order( $order\_id ); |
  | 533 | 533 | debug\_message(130, $order,  \_\_FUNCTION\_\_, 'Processing order\_status\_changed.'); |
  | 534 | 534 |  |
  | 535 | 535 | if ($this->are\_all\_products\_downloadable ($order)) |
  | 536 | 536 | { |
  | 537 | 537 | // we will process the request in the order\_status\_completed action |
  | 538 | 538 | debug\_message(135, $order,  \_\_FUNCTION\_\_, 'Skipping order\_status\_changed.'); |
  | 539 | 539 | } |
  | 540 | 540 | else |
  | 541 | 541 | { |
  | 542 | 542 | $this->process\_order ( $order ); |
  | 543 | 543 | } |
  | 544 | 544 | } |
  | 545 | 545 |  |
  | 546 | 546 | function order\_status\_completed ( $order\_id ) |
  | 547 | 547 | { |
  | 548 | 548 | $order = wc\_get\_order( $order\_id ); |
  | 549 | 549 | debug\_message(140, $order,  \_\_FUNCTION\_\_, 'Processing order\_status\_completed.'); |
  | 550 | 550 |  |
  | 551 | 551 | $qlm\_process\_order\_on\_status\_completed = get\_option('qlm\_process\_order\_on\_status\_completed'); |
  | 552 | 552 |  |
  | 553 | 553 | // check if we already processed this order, i.e. was order\_status\_changed already triggered |
  | 554 | 554 | $license\_keys\_metadata = qlm\_get\_order\_meta ($order->id, '\_qlm\_license\_keys', true); |
  | 555 | 555 | $license\_keys\_already\_generated = true; |
  | 556 | 556 | if (is\_null($license\_keys\_metadata) || $license\_keys\_metadata == '') |
  | 557 | 557 | { |
  | 558 | 558 | // if the order already has the license key, it means that we already processed it on the status changed event |
  | 559 | 559 | $license\_keys\_already\_generated = false; |
  | 560 | 560 | } |
  | 561 | 561 |  |
  | 562 | 562 | debug\_message(141, $order,  \_\_FUNCTION\_\_, 'qlm\_process\_order\_on\_status\_completed:'.$qlm\_process\_order\_on\_status\_completed.' License Keys Data:'.$license\_keys\_metadata); |
  | 563 | 563 |  |
  | 564 | 564 | // If process order on status completed is true and no license keys have been created, try to process the order now |
  | 565 | 565 | if (($qlm\_process\_order\_on\_status\_completed == true)  && ($license\_keys\_already\_generated == false)) |
  | 566 | 566 | { |
  | 567 | 567 | debug\_message(142, $order,  \_\_FUNCTION\_\_, 'Processing this order now.'); |
  | 568 | 568 | $this->process\_order ( $order ); |
  | 569 | 569 | } |
  | 570 | 570 | else |
  | 571 | 571 | { |
  | 572 | 572 | debug\_message(143, $order,  \_\_FUNCTION\_\_, 'Skipping processing order on orer\_status\_completed'); |
  | 573 | 573 | } |
  | 574 | 574 |  |
  | 575 | 575 | $this->mail\_on\_order\_completed ($order); |
  | 576 | 576 |  |
  | 577 | 577 | debug\_message(142, $order,  \_\_FUNCTION\_\_, 'Completed order\_status\_completed.'); |
  | 578 | 578 | } |
  | 579 | 579 |  |
  | 580 | 580 | // Check if all the products in the order are downloadable |
  | 581 | 581 | function are\_all\_products\_downloadable ($order) |
  | 582 | 582 | { |
  | 583 | 583 | return false; |
  | 584 | 584 | debug\_message(150, $order,  \_\_FUNCTION\_\_, 'Start'); |
  | 585 | 585 |  |
  | 586 | 586 | $items = $order->get\_items(); |
  | 587 | 587 |  |
  | 588 | 588 | foreach($items as $item) |
  | 589 | 589 | { |
  | 590 | 590 | $product\_id = $item->get\_product\_id(); |
  | 591 | 591 | $product = wc\_get\_product ($product\_id); |
  | 592 | 592 |  |
  | 593 | 593 | if ($product->is\_downloadable() == false) |
  | 594 | 594 | { |
  | 595 | 595 | debug\_message(155, $order,  \_\_FUNCTION\_\_, 'Found one product not downloadable: '.$item['name']); |
  | 596 | 596 | return false; |
  | 597 | 597 | } |
  | 598 | 598 | } |
  | 599 | 599 |  |
  | 600 | 600 | debug\_message(160, $order,  \_\_FUNCTION\_\_, 'All products are downloadable.'); |
  | 601 | 601 |  |
  | 602 | 602 | return true; |
  | 603 | 603 | } |
  | 604 | 604 |  |
  | 605 | 605 |  |
  | 606 | 606 |  |
  | 607 | 607 | //Woocommerce calls this function when order status changes. |
  | 608 | 608 | function process\_order ( $order ) |
  | 609 | 609 | { |
  | 610 | 610 | global $woocommerce; |
  | 611 | 611 |  |
  | 612 | 612 | //instantiate api calss |
  | 613 | 613 | $qlm\_v = new QLM\_Api\_View(); |
  | 614 | 614 |  |
  | 615 | 615 | $date\_time = date('Y-m-d H:i:s'); |
  | 616 | 616 | $orig\_order\_id=""; |
  | 617 | 617 |  |
  | 618 | 618 | //create order object |
  | 619 | 619 | $order = new WC\_Order($order->id); |
  | 620 | 620 |  |
  | 621 | 621 | debug\_message(165, $order,  \_\_FUNCTION\_\_, 'Processing order id:'.$order->id); |
  | 622 | 622 | debug\_message(166, $order,  \_\_FUNCTION\_\_, 'UserData1 :'.$qlm\_v->userdata1); |
  | 623 | 623 |  |
  | 624 | 624 | change\_role\_on\_purchase( $order); |
  | 625 | 625 |  |
  | 626 | 626 | // The wcs\_order\_contains\_renewal API is only available if WooCommerce Subscription is installed |
  | 627 | 627 | // Check if the function exists first |
  | 628 | 628 | if( $this->woo\_subscriptions\_enabled ($order)) |
  | 629 | 629 | { |
  | 630 | 630 | debug\_message(170, $order,  \_\_FUNCTION\_\_, 'function wcs\_order\_contains\_renewal exists.'); |
  | 631 | 631 |  |
  | 632 | 632 | // Get first parent order |
  | 633 | 633 | if ( wcs\_order\_contains\_renewal( $order->id ) ) |
  | 634 | 634 | { |
  | 635 | 635 | debug\_message(175, $order,  \_\_FUNCTION\_\_, 'Detected renewal order id:'.$order->id); |
  | 636 | 636 | //$parent\_order\_id = WC\_Subscriptions\_Renewal\_Order::get\_parent\_order\_id( $order->id ); |
  | 637 | 637 |  |
  | 638 | 638 | $subscriptions = wcs\_get\_subscriptions\_for\_renewal\_order( $order->id ); |
  | 639 | 639 |  |
  | 640 | 640 | foreach ( $subscriptions as $subscription ) |
  | 641 | 641 | { |
  | 642 | 642 | debug\_message(180, $order,  \_\_FUNCTION\_\_, 'subscription id:'.$subscription->id); |
  | 643 | 643 |  |
  | 644 | 644 | //$parent\_order\_id = WC\_Subscriptions\_Renewal\_Order::get\_parent\_order\_id( $subscription->id ); |
  | 645 | 645 | $orig\_subscription = $subscription; |
  | 646 | 646 | $orig\_order\_id = $subscription->order->id; |
  | 647 | 647 |  |
  | 648 | 648 | debug\_message(185, $order,  \_\_FUNCTION\_\_, 'parent order id:'.$orig\_order\_id); |
  | 649 | 649 |  |
  | 650 | 650 | // we only support one subscription |
  | 651 | 651 | break; |
  | 652 | 652 | } |
  | 653 | 653 | } |
  | 654 | 654 | else |
  | 655 | 655 | { |
  | 656 | 656 | $subscriptions = wcs\_get\_subscriptions\_for\_order( $order->id ); |
  | 657 | 657 |  |
  | 658 | 658 | foreach ( $subscriptions as $subscription ) |
  | 659 | 659 | { |
  | 660 | 660 | debug\_message(190, $order,  \_\_FUNCTION\_\_, 'subscription id:'.$subscription->id); |
  | 661 | 661 |  |
  | 662 | 662 | //$parent\_order\_id = WC\_Subscriptions\_Renewal\_Order::get\_parent\_order\_id( $subscription->id ); |
  | 663 | 663 | $orig\_subscription = $subscription; |
  | 664 | 664 |  |
  | 665 | 665 | if (is\_null($orig\_order\_id)) |
  | 666 | 666 | { |
  | 667 | 667 | debug\_message(194, $order,  \_\_FUNCTION\_\_, 'parent order id: Null'); |
  | 668 | 668 | } |
  | 669 | 669 | else |
  | 670 | 670 | { |
  | 671 | 671 | debug\_message(195, $order,  \_\_FUNCTION\_\_, 'parent order id:'.$orig\_order\_id); |
  | 672 | 672 | } |
  | 673 | 673 |  |
  | 674 | 674 | // we only support one subscription |
  | 675 | 675 | break; |
  | 676 | 676 |  |
  | 677 | 677 | } |
  | 678 | 678 |  |
  | 679 | 679 | debug\_message(200, $order,  \_\_FUNCTION\_\_, 'Did not detect renewal order id:'.$order->id); |
  | 680 | 680 | } |
  | 681 | 681 | } |
  | 682 | 682 | else |
  | 683 | 683 | { |
  | 684 | 684 | debug\_message(205, $order,  \_\_FUNCTION\_\_, 'Function  wcs\_order\_contains\_renewal does not exist.'); |
  | 685 | 685 | } |
  | 686 | 686 |  |
  | 687 | 687 | debug\_message(210, $order,  \_\_FUNCTION\_\_, 'Processing order id:'.$order->id); |
  | 688 | 688 |  |
  | 689 | 689 |  |
  | 690 | 690 | /\*if we have parent order that means current order is a recurring order |
  | 691 | 691 | So let's call relevant function to handle recurring orders \*/ |
  | 692 | 692 | if(!empty($orig\_order\_id)) |
  | 693 | 693 | { |
  | 694 | 694 | debug\_message(225, $order,  \_\_FUNCTION\_\_, 'Processing recurring order - order id:'.$order->id); |
  | 695 | 695 | $this->process\_recurring\_subscription($order, $orig\_subscription); |
  | 696 | 696 | return; |
  | 697 | 697 | } |
  | 698 | 698 |  |
  | 699 | 699 | debug\_message(230, $order,  \_\_FUNCTION\_\_, 'Processing non-recurring order - order id:'.$order->id); |
  | 700 | 700 |  |
  | 701 | 701 | /\*we will have something in $recurring if this is a recurring parent order |
  | 702 | 702 | as we have already sent any recurring child order in the previous if \*/ |
  | 703 | 703 | // Ralph - recurring orders were handled above |
  | 704 | 704 |  |
  | 705 | 705 | //we have a recurring first order |
  | 706 | 706 | // TODO - not used |
  | 707 | 707 | $recurring = $order->get\_total(); |
  | 708 | 708 | //$recurring = ''; |
  | 709 | 709 |  |
  | 710 | 710 | debug\_message(235, $order,  \_\_FUNCTION\_\_, 'Getting Total - order id:'.$order->id .' Recurring value:'.$recurring ); |
  | 711 | 711 |  |
  | 712 | 712 | //get all items of an order |
  | 713 | 713 | $items = $order->get\_items(); |
  | 714 | 714 |  |
  | 715 | 715 | debug\_message(240, $order,  \_\_FUNCTION\_\_, 'Getting Items - order id:'.$order->id); |
  | 716 | 716 |  |
  | 717 | 717 | $user\_id = $order->user\_id; |
  | 718 | 718 |  |
  | 719 | 719 | debug\_message(245, $order,  \_\_FUNCTION\_\_, 'Getting UserID - order id:'.$order->id); |
  | 720 | 720 |  |
  | 721 | 721 | if($user\_id == 0) |
  | 722 | 722 | { |
  | 723 | 723 | debug\_message(250, $order,  \_\_FUNCTION\_\_, 'Customer is not logged in - Will use billing information - Order ID:'.$order->id); |
  | 724 | 724 | //return;  //do not proceed if user is not logged in |
  | 725 | 725 | } |
  | 726 | 726 |  |
  | 727 | 727 | debug\_message(255, $order,  \_\_FUNCTION\_\_, 'Starting to process items - order id:'.$order->id); |
  | 728 | 728 |  |
  | 729 | 729 | $this->process\_items ($qlm\_v, $order); |
  | 730 | 730 |  |
  | 731 | 731 | } |
  | 732 | 732 |  |
  | 733 | 733 | function process\_items ($qlm\_v, $order) |
  | 734 | 734 | { |
  | 735 | 735 | //$subscriptions = wcs\_get\_subscriptions\_for\_order( $order->id ); |
  | 736 | 736 | $items = $order->get\_items(); |
  | 737 | 737 |  |
  | 738 | 738 | $set\_order\_completed = true; |
  | 739 | 739 |  |
  | 740 | 740 | foreach($items as $item) |
  | 741 | 741 | { |
  | 742 | 742 | if ($this->is\_qlm\_item ($order, $item) == true) |
  | 743 | 743 | { |
  | 744 | 744 | $result = $this->process\_item ($qlm\_v, $order, $item); |
  | 745 | 745 |  |
  | 746 | 746 | if($result == false) |
  | 747 | 747 | { |
  | 748 | 748 | $set\_order\_completed = false; |
  | 749 | 749 | debug\_message(555, $order,  \_\_FUNCTION\_\_, 'The order will not be set to Completed because one item was not successfully processed:'.$item['name']); |
  | 750 | 750 | } |
  | 751 | 751 | } |
  | 752 | 752 | else |
  | 753 | 753 | { |
  | 754 | 754 | $set\_order\_completed = false; |
  | 755 | 755 | debug\_message(300, $order,  \_\_FUNCTION\_\_, 'Skipping non-qlm item:'.$item['name']); |
  | 756 | 756 | } |
  | 757 | 757 | } |
  | 758 | 758 |  |
  | 759 | 759 | /\* if we are here, it means everything went well |
  | 760 | 760 | if we do not set the order status, the license key is not getting displayed |
  | 761 | 761 | on the order confirmation web page, not is it shown in the email sent to the customer \*/ |
  | 762 | 762 |  |
  | 763 | 763 |  |
  | 764 | 764 |  |
  | 765 | 765 | // We only update the status if all products in the order are QLM related |
  | 766 | 766 | if ($set\_order\_completed == true) |
  | 767 | 767 | { |
  | 768 | 768 | if ($this->are\_all\_products\_downloadable ($order) == false) |
  | 769 | 769 | { |
  | 770 | 770 | debug\_message(260, $order,  \_\_FUNCTION\_\_, 'Webhook Order Status Changed. Setting Status to Completed.'); |
  | 771 | 771 | $order->update\_status('completed'); |
  | 772 | 772 | } |
  | 773 | 773 | else |
  | 774 | 774 | { |
  | 775 | 775 | debug\_message(265, $order,  \_\_FUNCTION\_\_, 'Webhook Order Status Changed. Setting Status to Completed.'); |
  | 776 | 776 | $order->update\_status('completed'); |
  | 777 | 777 | } |
  | 778 | 778 | } |
  | 779 | 779 | } |
  | 780 | 780 |  |
  | 781 | 781 | function woo\_subscriptions\_enabled ($order) |
  | 782 | 782 | { |
  | 783 | 783 | if( function\_exists( 'wcs\_order\_contains\_renewal' ) ) |
  | 784 | 784 | { |
  | 785 | 785 | return true; |
  | 786 | 786 | } |
  | 787 | 787 | else |
  | 788 | 788 | { |
  | 789 | 789 | debug\_message(530, $order,  \_\_FUNCTION\_\_, 'WooCommerce Subscriptions is not installed.'); |
  | 790 | 790 | return false; |
  | 791 | 791 | } |
  | 792 | 792 | } |
  | 793 | 793 |  |
  | 794 | 794 | function get\_subscription ($order, $order\_item) |
  | 795 | 795 | { |
  | 796 | 796 | if ($this->woo\_subscriptions\_enabled($order) == false) |
  | 797 | 797 | { |
  | 798 | 798 | return null; |
  | 799 | 799 | } |
  | 800 | 800 |  |
  | 801 | 801 | if ( wcs\_order\_contains\_renewal( $order->id ) ) |
  | 802 | 802 | { |
  | 803 | 803 | $subscriptions = wcs\_get\_subscriptions\_for\_renewal\_order( $order->id ); |
  | 804 | 804 | } |
  | 805 | 805 | else |
  | 806 | 806 | { |
  | 807 | 807 | $subscriptions = wcs\_get\_subscriptions\_for\_order( $order->id ); |
  | 808 | 808 | } |
  | 809 | 809 |  |
  | 810 | 810 | $item\_product\_id = $order\_item['product\_id']; |
  | 811 | 811 |  |
  | 812 | 812 | foreach ( $subscriptions as $subscription ) |
  | 813 | 813 | { |
  | 814 | 814 | $items = $subscription->get\_items(); |
  | 815 | 815 |  |
  | 816 | 816 | debug\_message(270, $order,  \_\_FUNCTION\_\_, 'Subscription ID: '.$subscription->id); |
  | 817 | 817 |  |
  | 818 | 818 |  |
  | 819 | 819 | foreach ($items as $item) |
  | 820 | 820 | { |
  | 821 | 821 | debug\_message(275, $order,  \_\_FUNCTION\_\_, 'Subscription ID: '.$subscription->id.' Item id:'.$item\_product\_id); |
  | 822 | 822 |  |
  | 823 | 823 | if ($item['product\_id'] == $item\_product\_id) |
  | 824 | 824 | { |
  | 825 | 825 | debug\_message(280, $order,  \_\_FUNCTION\_\_, 'Found match:'.$subscription->id); |
  | 826 | 826 |  |
  | 827 | 827 | return $subscription; |
  | 828 | 828 | } |
  | 829 | 829 |  |
  | 830 | 830 | } |
  | 831 | 831 | } |
  | 832 | 832 |  |
  | 833 | 833 | debug\_message(285, $order,  \_\_FUNCTION\_\_, 'No match.'); |
  | 834 | 834 |  |
  | 835 | 835 | return null; |
  | 836 | 836 | } |
  | 837 | 837 |  |
  | 838 | 838 | function is\_variation ($item) |
  | 839 | 839 | { |
  | 840 | 840 | if($item['variation\_id'] != 0 ) |
  | 841 | 841 | { |
  | 842 | 842 | return true; |
  | 843 | 843 | } |
  | 844 | 844 | else { |
  | 845 | 845 | return false; |
  | 846 | 846 | } |
  | 847 | 847 | } |
  | 848 | 848 |  |
  | 849 | 849 |  |
  | 850 | 850 | function process\_item ($qlm\_v, $order, $item) |
  | 851 | 851 | { |
  | 852 | 852 |  |
  | 853 | 853 | debug\_message(290, $order,  \_\_FUNCTION\_\_, 'Processing item  - order id:'.$order->id); |
  | 854 | 854 |  |
  | 855 | 855 | $subscription = $this->get\_subscription ($order, $item); |
  | 856 | 856 |  |
  | 857 | 857 |  |
  | 858 | 858 | if($this->is\_variation ($item) == true) |
  | 859 | 859 | { |
  | 860 | 860 | $res = $this->process\_variation\_item ($qlm\_v, $order, $item, $subscription); |
  | 861 | 861 | } |
  | 862 | 862 | else |
  | 863 | 863 | { |
  | 864 | 864 | $res = $this->process\_simple\_item ($qlm\_v, $order, $item, $subscription); |
  | 865 | 865 | } |
  | 866 | 866 |  |
  | 867 | 867 | //check return status and handle error |
  | 868 | 868 | return $this->process\_result ($qlm\_v, $order, $item, $res); |
  | 869 | 869 |  |
  | 870 | 870 | } |
  | 871 | 871 |  |
  | 872 | 872 | function process\_result ($qlm\_v, $order, $item, $res) |
  | 873 | 873 | { |
  | 874 | 874 | if($res['status'] == 'error') |
  | 875 | 875 | { |
  | 876 | 876 | $msg = $date\_time.' '.$res['err\_msg']; |
  | 877 | 877 | $order->add\_order\_note($msg); |
  | 878 | 878 |  |
  | 879 | 879 | debug\_message(550, $order,  \_\_FUNCTION\_\_, 'License Server Result: '.$res['err\_msg']); |
  | 880 | 880 | return false; |
  | 881 | 881 | } |
  | 882 | 882 | else |
  | 883 | 883 | { |
  | 884 | 884 | $license\_key = $res['license\_key']; |
  | 885 | 885 |  |
  | 886 | 886 | $licenseKeyFieldName = get\_option( 'qlm\_licenseKeyFieldName'); |
  | 887 | 887 | if(empty($licenseKeyFieldName)) $licenseKeyFieldName = 'licenseKey'; |
  | 888 | 888 |  |
  | 889 | 889 | debug\_message(310, $order,  \_\_FUNCTION\_\_, 'License caption: '.$licenseKeyFieldName); |
  | 890 | 890 |  |
  | 891 | 891 | $item[$licenseKeyFieldName] = $license\_key; |
  | 892 | 892 | $title = $item['name']; |
  | 893 | 893 |  |
  | 894 | 894 | $tmpKey = $item[$licenseKeyFieldName]; |
  | 895 | 895 | debug\_message(315, $order,  \_\_FUNCTION\_\_, 'Created Key:'.$tmpKey.' for item:'.$title); |
  | 896 | 896 |  |
  | 897 | 897 | $rest = substr($title, 0, 35); |
  | 898 | 898 | $new\_meta = "$rest: $license\_key"; |
  | 899 | 899 | //get post meta |
  | 900 | 900 | //oldvalue + Title + $licensekey |
  | 901 | 901 | if($this->is\_variation ($item) == true) |
  | 902 | 902 | { |
  | 903 | 903 | //saves license keys if product is a variable product |
  | 904 | 904 | $variation\_id = $item['variation\_id']; |
  | 905 | 905 |  |
  | 906 | 906 | debug\_message(320, $order,  \_\_FUNCTION\_\_, 'Finalizing variation ID:'.$variation\_id.' for item:'.$title); |
  | 907 | 907 |  |
  | 908 | 908 | //saves individual keys i.e one for each product. |
  | 909 | 909 | qlm\_update\_order\_meta($order->id, '\_qlm\_license\_key\_'.$variation\_id, $license\_key); |
  | 910 | 910 |  |
  | 911 | 911 | $order->save(); |
  | 912 | 912 |  |
  | 913 | 913 | debug\_message(321, $order,  \_\_FUNCTION\_\_, 'Updated metadata for:'.$variation\_id.' item:'.$title); |
  | 914 | 914 |  |
  | 915 | 915 | $old\_meta = qlm\_get\_order\_meta ($order->id, '\_qlm\_license\_keys', true); |
  | 916 | 916 | if($old\_meta) |
  | 917 | 917 | { |
  | 918 | 918 | $update\_meta = $old\_meta.'<br />'.$new\_meta; |
  | 919 | 919 | } |
  | 920 | 920 | else |
  | 921 | 921 | { |
  | 922 | 922 | $update\_meta = $new\_meta; |
  | 923 | 923 | } |
  | 924 | 924 |  |
  | 925 | 925 | //saves concatednated and html added keys for all products for display and email |
  | 926 | 926 | qlm\_update\_order\_meta($order->id, '\_qlm\_license\_keys', $update\_meta); |
  | 927 | 927 |  |
  | 928 | 928 | debug\_message(322, $order,  \_\_FUNCTION\_\_, 'Updated metadata for all products'); |
  | 929 | 929 | } |
  | 930 | 930 | else |
  | 931 | 931 | { |
  | 932 | 932 | //saves license keys if product is a simple product |
  | 933 | 933 | $product\_id = $item['product\_id']; |
  | 934 | 934 |  |
  | 935 | 935 | debug\_message(325, $order,  \_\_FUNCTION\_\_, 'Finalizing simple product  ID:'.$product\_id.' for item:'.$title); |
  | 936 | 936 |  |
  | 937 | 937 | // we save one license key per product ID |
  | 938 | 938 | qlm\_update\_order\_meta($order->id, '\_qlm\_license\_key\_'.$product\_id, $license\_key); |
  | 939 | 939 | $order->save(); |
  | 940 | 940 |  |
  | 941 | 941 | $old\_meta = qlm\_get\_order\_meta ($order->id, '\_qlm\_license\_keys', true); |
  | 942 | 942 |  |
  | 943 | 943 | if($old\_meta) |
  | 944 | 944 | { |
  | 945 | 945 | $update\_meta = $old\_meta.'<br />'.$new\_meta; |
  | 946 | 946 | } |
  | 947 | 947 | else |
  | 948 | 948 | { |
  | 949 | 949 | $update\_meta = $new\_meta; |
  | 950 | 950 | } |
  | 951 | 951 |  |
  | 952 | 952 | qlm\_update\_order\_meta($order->id, '\_qlm\_license\_keys', $update\_meta); |
  | 953 | 953 | } |
  | 954 | 954 | } |
  | 955 | 955 |  |
  | 956 | 956 | return true; |
  | 957 | 957 | } |
  | 958 | 958 |  |
  | 959 | 959 | function get\_next\_payment\_date\_from\_wc ($order, $subscription) |
  | 960 | 960 | { |
  | 961 | 961 | if (is\_null($subscription)) |
  | 962 | 962 | { |
  | 963 | 963 | debug\_message(566, $order,  \_\_FUNCTION\_\_, 'Subscription is null.'); |
  | 964 | 964 | return null; |
  | 965 | 965 | } |
  | 966 | 966 | else |
  | 967 | 967 | { |
  | 968 | 968 | $next\_payment\_get\_date\_str = $subscription->get\_date ('next\_payment'); |
  | 969 | 969 | if (($next\_payment\_get\_date\_str != '') && ($next\_payment\_get\_date\_str != '0')) |
  | 970 | 970 | { |
  | 971 | 971 | $next\_payment\_get\_date = new DateTime($next\_payment\_get\_date\_str); |
  | 972 | 972 | } |
  | 973 | 973 | debug\_message(570, $order,  \_\_FUNCTION\_\_, 'get\_date(next\_payment):'.$next\_payment\_get\_date\_str); |
  | 974 | 974 |  |
  | 975 | 975 | $next\_payment\_calc\_date\_str = $subscription->calculate\_date ('next\_payment'); |
  | 976 | 976 | if (($next\_payment\_calc\_date\_str != '') && ($next\_payment\_calc\_date\_str != '0')) |
  | 977 | 977 | { |
  | 978 | 978 | $next\_payment\_calc\_date = new DateTime($next\_payment\_calc\_date\_str); |
  | 979 | 979 | } |
  | 980 | 980 | debug\_message(575, $order,  \_\_FUNCTION\_\_, 'calculate\_date(next\_payment):'.$next\_payment\_calc\_date\_str); |
  | 981 | 981 |  |
  | 982 | 982 | if (is\_null($next\_payment\_get\_date) && is\_null($next\_payment\_calc\_date)) |
  | 983 | 983 | { |
  | 984 | 984 | debug\_message(580, $order,  \_\_FUNCTION\_\_, 'WC returned empty dates.'); |
  | 985 | 985 | return null; |
  | 986 | 986 | } |
  | 987 | 987 | else if (is\_null($next\_payment\_get\_date)) |
  | 988 | 988 | { |
  | 989 | 989 | debug\_message(585, $order,  \_\_FUNCTION\_\_, 'Using date:'.$next\_payment\_calc\_date\_str); |
  | 990 | 990 | $next\_payment\_date\_str = $next\_payment\_calc\_date\_str; |
  | 991 | 991 | } |
  | 992 | 992 | else if (is\_null($next\_payment\_calc\_date)) |
  | 993 | 993 | { |
  | 994 | 994 | debug\_message(590, $order,  \_\_FUNCTION\_\_, 'Using date:'.$next\_payment\_get\_date\_str); |
  | 995 | 995 | $next\_payment\_date\_str = $next\_payment\_get\_date\_str; |
  | 996 | 996 | } |
  | 997 | 997 | else |
  | 998 | 998 | { |
  | 999 | 999 | if ( wcs\_order\_contains\_renewal( $order->id ) ) |
  | 1000 | 1000 | { |
  | 1001 | 1001 | debug\_message(591, $order,  \_\_FUNCTION\_\_, 'This is a renewal of an existing subscription.'); |
  | 1002 | 1002 |  |
  | 1003 | 1003 | // we have 2 dates, take the largest one |
  | 1004 | 1004 | if ($next\_payment\_calc\_date > $next\_payment\_get\_date) |
  | 1005 | 1005 | { |
  | 1006 | 1006 | $next\_payment\_date\_str = $next\_payment\_calc\_date\_str; |
  | 1007 | 1007 | } |
  | 1008 | 1008 | else |
  | 1009 | 1009 | { |
  | 1010 | 1010 | $next\_payment\_date\_str = $next\_payment\_get\_date\_str; |
  | 1011 | 1011 | } |
  | 1012 | 1012 | } |
  | 1013 | 1013 | else |
  | 1014 | 1014 | { |
  | 1015 | 1015 | debug\_message(592, $order,  \_\_FUNCTION\_\_, 'This is the first order of a new subscription.'); |
  | 1016 | 1016 | // this is a first order of a subscription |
  | 1017 | 1017 | $next\_payment\_date\_str = $next\_payment\_get\_date\_str; |
  | 1018 | 1018 | } |
  | 1019 | 1019 |  |
  | 1020 | 1020 | debug\_message(595, $order,  \_\_FUNCTION\_\_, 'Using date:'.$next\_payment\_date\_str); |
  | 1021 | 1021 |  |
  | 1022 | 1022 | } |
  | 1023 | 1023 |  |
  | 1024 | 1024 | $next\_payment\_date = new DateTime($next\_payment\_date\_str); |
  | 1025 | 1025 | return $next\_payment\_date; |
  | 1026 | 1026 |  |
  | 1027 | 1027 | } |
  | 1028 | 1028 | return null; |
  | 1029 | 1029 | } |
  | 1030 | 1030 |  |
  | 1031 | 1031 | function process\_simple\_item ($qlm\_v, $order, $item, $subscription) |
  | 1032 | 1032 | { |
  | 1033 | 1033 | $recurring = $order->get\_total(); |
  | 1034 | 1034 | $qty = $item['qty']; |
  | 1035 | 1035 | $qlm\_activation\_key = get\_item\_addon\_value($order, $item, 'qlm\_activation\_key'); |
  | 1036 | 1036 | $yearly = 0; |
  | 1037 | 1037 | debug\_message(418, $order,  \_\_FUNCTION\_\_, 'Activation Key: '.$qlm\_activation\_key); |
  | 1038 | 1038 |  |
  | 1039 | 1039 | debug\_message(419, $order,  \_\_FUNCTION\_\_, 'Processing simple  item:'.$item); |
  | 1040 | 1040 |  |
  | 1041 | 1041 | if ($subscription != null) |
  | 1042 | 1042 | { |
  | 1043 | 1043 | $qlm\_object = new qlm\_object(); |
  | 1044 | 1044 | $this->calculate\_expiry\_date ($order, $subscription, $qlm\_object, $item); |
  | 1045 | 1045 |  |
  | 1046 | 1046 |  |
  | 1047 | 1047 | $res = $qlm\_v->send\_request($order, $item, $order->user\_id, $qty, $yearly, $qlm\_object->expiry\_duration, $qlm\_object->expiry\_date, "", $subscription, $qlm\_activation\_key); |
  | 1048 | 1048 | } |
  | 1049 | 1049 | else |
  | 1050 | 1050 | { |
  | 1051 | 1051 | debug\_message(421, $order,  \_\_FUNCTION\_\_, 'No subscription is associated with this order:'.$order->id); |
  | 1052 | 1052 |  |
  | 1053 | 1053 | // Do not send a subscriptionID if this is not a subscription Product. $subscription may have a value if the order contains |
  | 1054 | 1054 | // a combination of subscription products and regular products so we must clear it for the regular product by passing '' as the last argument to send\_request |
  | 1055 | 1055 | $res = $qlm\_v->send\_request($order, $item, $order->user\_id, $qty, $yearly, -1, null, "", '', $qlm\_activation\_key); |
  | 1056 | 1056 | } |
  | 1057 | 1057 |  |
  | 1058 | 1058 | debug\_message(365, $order,  \_\_FUNCTION\_\_, 'Processing Simple product - Completed call to License Server: '.$res['status']); |
  | 1059 | 1059 |  |
  | 1060 | 1060 | return $res; |
  | 1061 | 1061 | } |
  | 1062 | 1062 |  |
  | 1063 | 1063 | function get\_maintenance\_plan\_attribute\_name() |
  | 1064 | 1064 | { |
  | 1065 | 1065 | $mpi= get\_option( 'qlm\_maintenance\_plan\_identifier'); |
  | 1066 | 1066 | if (is\_null ($mpi) == false) |
  | 1067 | 1067 | { |
  | 1068 | 1068 | $mpi = strtolower($mpi); |
  | 1069 | 1069 | $mpi = str\_replace (" ", "-", $mpi); |
  | 1070 | 1070 | $mpi = "attribute\_".$mpi; |
  | 1071 | 1071 | } |
  | 1072 | 1072 | else |
  | 1073 | 1073 | { |
  | 1074 | 1074 | $mpi = "attribute\_maintenance-plan"; |
  | 1075 | 1075 | } |
  | 1076 | 1076 |  |
  | 1077 | 1077 | return $mpi; |
  | 1078 | 1078 | } |
  | 1079 | 1079 |  |
  | 1080 | 1080 | function process\_variation\_item ($qlm\_v, $order, $item, $subscription) |
  | 1081 | 1081 | { |
  | 1082 | 1082 | $recurring = $order->get\_total(); |
  | 1083 | 1083 | $qty = $item['qty']; |
  | 1084 | 1084 | $qlm\_activation\_key = get\_item\_addon\_value($order, $item, 'qlm\_activation\_key'); |
  | 1085 | 1085 |  |
  | 1086 | 1086 | debug\_message(295, $order,  \_\_FUNCTION\_\_, 'Activation Key: '.$qlm\_activation\_key); |
  | 1087 | 1087 |  |
  | 1088 | 1088 |  |
  | 1089 | 1089 | debug\_message(370, $order,  \_\_FUNCTION\_\_, 'Processing variation item:'.$item['variation\_id']); |
  | 1090 | 1090 |  |
  | 1091 | 1091 | //We will land here if product is a variable product |
  | 1092 | 1092 |  |
  | 1093 | 1093 | $prod = new WC\_Product\_Variation( $item['variation\_id'] ); |
  | 1094 | 1094 | $attributes = $prod->get\_variation\_attributes(); |
  | 1095 | 1095 |  |
  | 1096 | 1096 | $is\_args = $prod->get\_sku(); |
  | 1097 | 1097 |  |
  | 1098 | 1098 | debug\_message(375, $order,  \_\_FUNCTION\_\_, 'Found sku: name= '.$is\_args); |
  | 1099 | 1099 |  |
  | 1100 | 1100 | //if (substr( $is\_args, 0, 1 ) != "&") |
  | 1101 | 1101 | //{ |
  | 1102 | 1102 | // if the SKU does not start with &, it's not ours |
  | 1103 | 1103 | //$is\_args = ""; |
  | 1104 | 1104 | //} |
  | 1105 | 1105 | debug\_message(380, $order,  \_\_FUNCTION\_\_, 'Processing variation item recurring value:'.$recurring); |
  | 1106 | 1106 |  |
  | 1107 | 1107 | // Ralph - This is not true, we do not always have a maintenance plan |
  | 1108 | 1108 | //if(! isset($attributes['attribute\_maintenance-plan'])) continue; //we always have maintenence plan in a variation, so skip if this variation is not maintenance plan variation. |
  | 1109 | 1109 |  |
  | 1110 | 1110 | //Set maintenance plan option for api call accordingly |
  | 1111 | 1111 | if($attributes[$this->get\_maintenance\_plan\_attribute\_name()] == 'Yes') |
  | 1112 | 1112 | { |
  | 1113 | 1113 | debug\_message(600, $order,  \_\_FUNCTION\_\_, 'Maintenance Plan is selected.'); |
  | 1114 | 1114 | $yearly = 1; |
  | 1115 | 1115 | } |
  | 1116 | 1116 | else |
  | 1117 | 1117 | { |
  | 1118 | 1118 | debug\_message(605, $order,  \_\_FUNCTION\_\_, 'No Maintenance Plan selected.'); |
  | 1119 | 1119 | $yearly = 0; |
  | 1120 | 1120 | } |
  | 1121 | 1121 |  |
  | 1122 | 1122 | if ($subscription != null) |
  | 1123 | 1123 | { |
  | 1124 | 1124 | $qlm\_object = new qlm\_object(); |
  | 1125 | 1125 | $this->calculate\_expiry\_date ($order, $subscription, $qlm\_object, $item); |
  | 1126 | 1126 |  |
  | 1127 | 1127 | debug\_message(405, $order,  \_\_FUNCTION\_\_, 'Detected recurring variable product. Product:'.$item['product\_id'].' Frequency:'.$sp.' Interval:'.$sinterval.' Duration:'.$qlm\_object->expiry\_duration); |
  | 1128 | 1128 |  |
  | 1129 | 1129 | $res = $qlm\_v->send\_request($order, $item, $order->user\_id, $qty, $yearly, $qlm\_object->expiry\_duration, $qlm\_object->expiry\_date, $is\_args, $subscription, $qlm\_activation\_key); |
  | 1130 | 1130 | } |
  | 1131 | 1131 | else |
  | 1132 | 1132 | { |
  | 1133 | 1133 | debug\_message(410, $order,  \_\_FUNCTION\_\_, 'Detected non recurring variable product. Product:'.$item['product\_id'].' Frequency:'.$sp.' Interval:'.$sinterval.' Duration:'.$qlm\_object->expiry\_duration.' ProductName:'.$product\_name); |
  | 1134 | 1134 |  |
  | 1135 | 1135 | // Do not send a subscriptionID if this is not a subscription Product. $subscription may have a value if the order contains |
  | 1136 | 1136 | // a combination of subscription products and regular products so we must clear it for the regular product by passing '' as the last argument to send\_request |
  | 1137 | 1137 | $res = $qlm\_v->send\_request($order, $item, $order->user\_id, $qty, $yearly, -1, null, $is\_args, '', $qlm\_activation\_key); |
  | 1138 | 1138 | } |
  | 1139 | 1139 |  |
  | 1140 | 1140 | debug\_message(415, $order,  \_\_FUNCTION\_\_, 'Processing variable product - Completed call to License Server: '.$res['status']); |
  | 1141 | 1141 |  |
  | 1142 | 1142 | return $res; |
  | 1143 | 1143 | } |
  | 1144 | 1144 | /\* |
  | 1145 | 1145 | This function is only for processing of a recurrung order |
  | 1146 | 1146 | $order   It is the current order. It must be a recurring order |
  | 1147 | 1147 | $subscription is the current subscription |
  | 1148 | 1148 | \*/ |
  | 1149 | 1149 | function process\_recurring\_subscription($order,  $subscription ) |
  | 1150 | 1150 | { |
  | 1151 | 1151 | global $woocommerce; |
  | 1152 | 1152 |  |
  | 1153 | 1153 | debug\_message(540, $order,  \_\_FUNCTION\_\_, 'Starting to process recurring subscription'); |
  | 1154 | 1154 |  |
  | 1155 | 1155 | $qlm\_v = new QLM\_Api\_View(); |
  | 1156 | 1156 |  |
  | 1157 | 1157 | $date\_time = date('Y-m-d H:i:s'); |
  | 1158 | 1158 |  |
  | 1159 | 1159 | $items = $order->get\_items(); |
  | 1160 | 1160 |  |
  | 1161 | 1161 | $user\_id = $order->user\_id; |
  | 1162 | 1162 | if($user\_id == 0) |
  | 1163 | 1163 | { |
  | 1164 | 1164 | debug\_message(534, $order,  \_\_FUNCTION\_\_, 'No user associated to the subscription. We cannot process a subscription without a user.'); |
  | 1165 | 1165 | return; |
  | 1166 | 1166 | } |
  | 1167 | 1167 |  |
  | 1168 | 1168 |  |
  | 1169 | 1169 |  |
  | 1170 | 1170 | $set\_order\_completed = true; |
  | 1171 | 1171 |  |
  | 1172 | 1172 | foreach($items as $item) |
  | 1173 | 1173 | { |
  | 1174 | 1174 |  |
  | 1175 | 1175 | if ($this->is\_qlm\_item ($order, $item) == false) |
  | 1176 | 1176 | { |
  | 1177 | 1177 | $set\_order\_completed = false; |
  | 1178 | 1178 | debug\_message(489, $order,  \_\_FUNCTION\_\_, 'Detecting one non-qlm item in the order. We will not set the Setting Status to Completed. Item:'.$item); |
  | 1179 | 1179 | continue; |
  | 1180 | 1180 | } |
  | 1181 | 1181 |  |
  | 1182 | 1182 | debug\_message(491, $order,  \_\_FUNCTION\_\_, 'Starting to process subscription item:'.$item['name']); |
  | 1183 | 1183 |  |
  | 1184 | 1184 | $qlm\_result = $this->process\_recurring\_subscription\_item ($order, $subscription, $item); |
  | 1185 | 1185 |  |
  | 1186 | 1186 | if ($qlm\_result == true) |
  | 1187 | 1187 | { |
  | 1188 | 1188 |  |
  | 1189 | 1189 | // we will only process the first item since we will use the Subscription ID to perform the renewal |
  | 1190 | 1190 | // The QLM License Server takes care of renewing each item in the subscription |
  | 1191 | 1191 |  |
  | 1192 | 1192 | // update the order status if the products are not all downloadable - process recurring subscription |
  | 1193 | 1193 | if (($set\_order\_completed == true) && ($this->are\_all\_products\_downloadable ($order) == false)) |
  | 1194 | 1194 | { |
  | 1195 | 1195 | //debug\_message(485, $order,  \_\_FUNCTION\_\_, 'QLM -process\_recurring\_subscription - Set Order Status to Pending.'); |
  | 1196 | 1196 | //$current\_status = $order->get\_status(); |
  | 1197 | 1197 | debug\_message(490, $order,  \_\_FUNCTION\_\_, 'Processing Recurring subscription. Setting Status to Completed'); |
  | 1198 | 1198 | $order->update\_status('completed'); |
  | 1199 | 1199 | } |
  | 1200 | 1200 | else |
  | 1201 | 1201 | { |
  | 1202 | 1202 | debug\_message(491, $order,  \_\_FUNCTION\_\_, 'Processing Recurring subscription. Skipping Status to Completed'); |
  | 1203 | 1203 | } |
  | 1204 | 1204 | } |
  | 1205 | 1205 | else |
  | 1206 | 1206 | { |
  | 1207 | 1207 | debug\_message(492, $order,  \_\_FUNCTION\_\_, 'Processing Recurring subscription.  Status was not set Completed because the QLM License Server return an error.'); |
  | 1208 | 1208 | } |
  | 1209 | 1209 |  |
  | 1210 | 1210 |  |
  | 1211 | 1211 | return; |
  | 1212 | 1212 | } |
  | 1213 | 1213 | } |
  | 1214 | 1214 |  |
  | 1215 | 1215 | function calculate\_expiry\_date ($order, $subscription, $qlm\_object, $item) |
  | 1216 | 1216 | { |
  | 1217 | 1217 |  |
  | 1218 | 1218 | debug\_message(329, $order,  \_\_FUNCTION\_\_, 'calculate\_expiry\_date'); |
  | 1219 | 1219 |  |
  | 1220 | 1220 | $next\_payment\_date = $this->get\_next\_payment\_date\_from\_wc ($order, $subscription); |
  | 1221 | 1221 | if (!is\_null($next\_payment\_date)) |
  | 1222 | 1222 | { |
  | 1223 | 1223 | $qlm\_object->expiry\_date = $next\_payment\_date->format('Y-m-d'); |
  | 1224 | 1224 | $use\_next\_payment\_date = true; |
  | 1225 | 1225 | return $qlm\_object->expiry\_date; |
  | 1226 | 1226 | } |
  | 1227 | 1227 |  |
  | 1228 | 1228 | debug\_message(328, $order,  \_\_FUNCTION\_\_, 'WC returned a null expiry date. We will calculate it.'); |
  | 1229 | 1229 |  |
  | 1230 | 1230 | // Calculate the duration |
  | 1231 | 1231 |  |
  | 1232 | 1232 | if (method\_exists ( 'WC\_Subscriptions\_Product', 'get\_period')) |
  | 1233 | 1233 | { |
  | 1234 | 1234 |  |
  | 1235 | 1235 | if (QLM\_DEBUG  == true) |
  | 1236 | 1236 | { |
  | 1237 | 1237 | $order\_date = new DateTime(date()); |
  | 1238 | 1238 | $order\_date\_str = date\_format ($order\_date, 'Y-m-d H:i:s'); |
  | 1239 | 1239 | debug\_message(330, $order,  \_\_FUNCTION\_\_, 'Order Date: '.$order\_date\_str); |
  | 1240 | 1240 |  |
  | 1241 | 1241 | $next\_payment\_date\_str = date\_format ($next\_payment\_date, 'Y-m-d H:i:s'); |
  | 1242 | 1242 | debug\_message(331, $order,  \_\_FUNCTION\_\_, 'Next Date: '.$next\_payment\_date\_str); |
  | 1243 | 1243 |  |
  | 1244 | 1244 |  |
  | 1245 | 1245 |  |
  | 1246 | 1246 | $diff = date\_diff ($order\_date, $next\_payment\_date); |
  | 1247 | 1247 |  |
  | 1248 | 1248 | if ($diff->days < 0) |
  | 1249 | 1249 | { |
  | 1250 | 1250 | // early renewal |
  | 1251 | 1251 | debug\_message(331, $order,  \_\_FUNCTION\_\_, 'Late Renewal 1: '.$diff->days); |
  | 1252 | 1252 | } |
  | 1253 | 1253 | else if ($diff->days > 0) |
  | 1254 | 1254 | { |
  | 1255 | 1255 | debug\_message(331, $order,  \_\_FUNCTION\_\_, 'Early Renewal 2: '.$diff->days); |
  | 1256 | 1256 | } |
  | 1257 | 1257 | else |
  | 1258 | 1258 | { |
  | 1259 | 1259 | debug\_message(331, $order,  \_\_FUNCTION\_\_, 'On time renewal 3: '.$diff->days); |
  | 1260 | 1260 | } |
  | 1261 | 1261 | } |
  | 1262 | 1262 |  |
  | 1263 | 1263 |  |
  | 1264 | 1264 |  |
  | 1265 | 1265 | if($item['variation\_id'] != 0) |
  | 1266 | 1266 | { |
  | 1267 | 1267 | $sp = WC\_Subscriptions\_Product::get\_period( $item['variation\_id'] ); |
  | 1268 | 1268 | } |
  | 1269 | 1269 | else |
  | 1270 | 1270 | { |
  | 1271 | 1271 | $sp = WC\_Subscriptions\_Product::get\_period( $item['product\_id'] ); |
  | 1272 | 1272 | } |
  | 1273 | 1273 |  |
  | 1274 | 1274 | debug\_message(335, $order,  \_\_FUNCTION\_\_, 'Subscription Period: ' .$sp); |
  | 1275 | 1275 | } |
  | 1276 | 1276 | else |
  | 1277 | 1277 | { |
  | 1278 | 1278 | debug\_message(340, $order,  \_\_FUNCTION\_\_, 'WC\_Subscriptions\_Product::get\_period does not exist.'); |
  | 1279 | 1279 | } |
  | 1280 | 1280 |  |
  | 1281 | 1281 |  |
  | 1282 | 1282 | if($item['variation\_id'] != 0) |
  | 1283 | 1283 | { |
  | 1284 | 1284 | $sinterval = get\_post\_meta($item['variation\_id'], '\_subscription\_period\_interval', true); |
  | 1285 | 1285 | } |
  | 1286 | 1286 | else |
  | 1287 | 1287 | { |
  | 1288 | 1288 | $product\_id = $item['product\_id']; |
  | 1289 | 1289 | $sinterval = get\_post\_meta($product\_id, '\_subscription\_period\_interval', true); |
  | 1290 | 1290 | } |
  | 1291 | 1291 |  |
  | 1292 | 1292 |  |
  | 1293 | 1293 | debug\_message(455, $order,  \_\_FUNCTION\_\_, 'Calculating Expiry date of product: '.$product\_id.' - Interval: '.$sinterval); |
  | 1294 | 1294 |  |
  | 1295 | 1295 | $qlm\_object->expiry\_duration = -1; |
  | 1296 | 1296 |  |
  | 1297 | 1297 | if ($sp != null) |
  | 1298 | 1298 | { |
  | 1299 | 1299 | switch($sp) |
  | 1300 | 1300 | { |
  | 1301 | 1301 | case 'day': |
  | 1302 | 1302 | $qlm\_object->expiry\_duration = $sinterval; |
  | 1303 | 1303 | break; |
  | 1304 | 1304 | case 'week': |
  | 1305 | 1305 | $qlm\_object->expiry\_duration = $sinterval \* 7; |
  | 1306 | 1306 | break; |
  | 1307 | 1307 | case 'month': |
  | 1308 | 1308 | $qlm\_object->expiry\_duration = $sinterval \* 31; |
  | 1309 | 1309 | break; |
  | 1310 | 1310 | case 'year': |
  | 1311 | 1311 | $qlm\_object->expiry\_duration = $sinterval \* 365; |
  | 1312 | 1312 | break; |
  | 1313 | 1313 | } |
  | 1314 | 1314 | } |
  | 1315 | 1315 | else |
  | 1316 | 1316 | { |
  | 1317 | 1317 | $qlm\_object->expiry\_duration = -1; |
  | 1318 | 1318 | } |
  | 1319 | 1319 |  |
  | 1320 | 1320 | $tmpdate = new DateTime($order->order\_date); |
  | 1321 | 1321 | $tmpdate->modify ('+'.$qlm\_object->expiry\_duration.' day'); |
  | 1322 | 1322 |  |
  | 1323 | 1323 | $qlm\_object->expiry\_date = $tmpdate->format ('Y-m-d'); |
  | 1324 | 1324 |  |
  | 1325 | 1325 |  |
  | 1326 | 1326 |  |
  | 1327 | 1327 | return $qlm\_object->expiry\_date; |
  | 1328 | 1328 | } |
  | 1329 | 1329 |  |
  | 1330 | 1330 | function process\_recurring\_subscription\_item ($order, $subscription, $item) |
  | 1331 | 1331 | { |
  | 1332 | 1332 | debug\_message(540, $order,  \_\_FUNCTION\_\_, 'Start processing item: '.$item['name']); |
  | 1333 | 1333 |  |
  | 1334 | 1334 | $qlm\_v = new QLM\_Api\_View(); |
  | 1335 | 1335 |  |
  | 1336 | 1336 | $qty = $item['qty']; |
  | 1337 | 1337 |  |
  | 1338 | 1338 | if($item['variation\_id'] != 0) |
  | 1339 | 1339 | { |
  | 1340 | 1340 | debug\_message(425, $order,  \_\_FUNCTION\_\_, 'Processing Item:'.$item); |
  | 1341 | 1341 |  |
  | 1342 | 1342 | $qlm\_object = new qlm\_object(); |
  | 1343 | 1343 |  |
  | 1344 | 1344 | $this->calculate\_expiry\_date ($order, $subscription, $qlm\_object, $item); |
  | 1345 | 1345 |  |
  | 1346 | 1346 | debug\_message(435, $order,  \_\_FUNCTION\_\_, 'OrderDate: '.$order->order\_date.' - Expiry Date: '.$qlm\_object->expiry\_date ); |
  | 1347 | 1347 |  |
  | 1348 | 1348 | $prod = new WC\_Product\_Variation( $item['variation\_id'] ); |
  | 1349 | 1349 | $attributes = $prod->get\_variation\_attributes(); |
  | 1350 | 1350 |  |
  | 1351 | 1351 | if($attributes[$this->get\_maintenance\_plan\_attribute\_name] == 'Yes') |
  | 1352 | 1352 | { |
  | 1353 | 1353 | $yearly = 1; |
  | 1354 | 1354 | } |
  | 1355 | 1355 | else |
  | 1356 | 1356 | { |
  | 1357 | 1357 | $yearly = 0; |
  | 1358 | 1358 | } |
  | 1359 | 1359 |  |
  | 1360 | 1360 | $res = $qlm\_v->send\_recurring\_request($order, $item, $order->user\_id, $qty, $qlm\_object->expiry\_duration, $qlm\_object->expiry\_date, $yearly, $subscription); |
  | 1361 | 1361 |  |
  | 1362 | 1362 | debug\_message(440, $order,  \_\_FUNCTION\_\_, 'Processing variable product - Completed call to License Server: '.$res['status']); |
  | 1363 | 1363 |  |
  | 1364 | 1364 | } |
  | 1365 | 1365 | else |
  | 1366 | 1366 | { |
  | 1367 | 1367 | //simple product |
  | 1368 | 1368 | $yearly = 0; |
  | 1369 | 1369 | $product\_id = $item['product\_id']; |
  | 1370 | 1370 |  |
  | 1371 | 1371 | $qlm\_object = new qlm\_object(); |
  | 1372 | 1372 |  |
  | 1373 | 1373 | $this->calculate\_expiry\_date ($order, $subscription, $qlm\_object, $item); |
  | 1374 | 1374 |  |
  | 1375 | 1375 | debug\_message(465, $order,  \_\_FUNCTION\_\_, 'OrderDate: '.$order->order\_date.' - Expiry Date: '.$qlm\_object->expiry\_date); |
  | 1376 | 1376 |  |
  | 1377 | 1377 | $res = $qlm\_v->send\_recurring\_request($order, $item, $order->user\_id, $qty, $qlm\_object->expiry\_duration, $qlm\_object->expiry\_date, $yearly, $subscription); |
  | 1378 | 1378 |  |
  | 1379 | 1379 | debug\_message(475, $order,  \_\_FUNCTION\_\_, 'Processing Simple product - Completed call to License Server: '.$res['status']); |
  | 1380 | 1380 |  |
  | 1381 | 1381 | } |
  | 1382 | 1382 |  |
  | 1383 | 1383 | if($res['status'] == 'error') |
  | 1384 | 1384 | { |
  | 1385 | 1385 | $msg = $date\_time.' '.$res['err\_msg']; |
  | 1386 | 1386 | $order->add\_order\_note($msg); |
  | 1387 | 1387 |  |
  | 1388 | 1388 | debug\_message(480, $order,  \_\_FUNCTION\_\_, 'Order failed: '.$msg); |
  | 1389 | 1389 | return false; |
  | 1390 | 1390 | } |
  | 1391 | 1391 | else |
  | 1392 | 1392 | { |
  | 1393 | 1393 | $license\_key = $res['license\_key']; |
  | 1394 | 1394 | $title = $item['name']; |
  | 1395 | 1395 | $rest = substr($title, 0, 35); |
  | 1396 | 1396 | $new\_meta = "$rest: $license\_key"; |
  | 1397 | 1397 |  |
  | 1398 | 1398 | debug\_message(545, $order,  \_\_FUNCTION\_\_, 'Result from QLM License Server: '.$license\_key); |
  | 1399 | 1399 |  |
  | 1400 | 1400 | //get post meta |
  | 1401 | 1401 | //oldvalue + Title + $licensekey |
  | 1402 | 1402 |  |
  | 1403 | 1403 | if($item['variation\_id'] != 0) |
  | 1404 | 1404 | { |
  | 1405 | 1405 | $variation\_id = $item['variation\_id']; |
  | 1406 | 1406 |  |
  | 1407 | 1407 | $old\_meta = qlm\_get\_order\_meta ($order->id, '\_qlm\_license\_keys', true); |
  | 1408 | 1408 | if($old\_meta) |
  | 1409 | 1409 | { |
  | 1410 | 1410 | $update\_meta = $old\_meta.'<br />'.$new\_meta; |
  | 1411 | 1411 | }else{ |
  | 1412 | 1412 | $update\_meta = $new\_meta; |
  | 1413 | 1413 | } |
  | 1414 | 1414 |  |
  | 1415 | 1415 | qlm\_update\_order\_meta($order->id, '\_qlm\_license\_keys', $update\_meta); |
  | 1416 | 1416 | } |
  | 1417 | 1417 | else |
  | 1418 | 1418 | { |
  | 1419 | 1419 | $product\_id = $item['product\_id']; |
  | 1420 | 1420 |  |
  | 1421 | 1421 | $old\_meta = qlm\_get\_order\_meta($order->id, '\_qlm\_license\_keys', true); |
  | 1422 | 1422 |  |
  | 1423 | 1423 | if($old\_meta) |
  | 1424 | 1424 | { |
  | 1425 | 1425 | $update\_meta = $old\_meta.'<br />'.$new\_meta; |
  | 1426 | 1426 | }else { |
  | 1427 | 1427 | $update\_meta = $new\_meta; |
  | 1428 | 1428 | } |
  | 1429 | 1429 |  |
  | 1430 | 1430 | qlm\_update\_order\_meta($order->id, '\_qlm\_license\_keys', $update\_meta); |
  | 1431 | 1431 | } |
  | 1432 | 1432 | } |
  | 1433 | 1433 |  |
  | 1434 | 1434 | return true; |
  | 1435 | 1435 | } |
  | 1436 | 1436 |  |
  | 1437 | 1437 | //it is a wordpress function |
  | 1438 | 1438 | function wp\_enqueue\_scripts(){ |
  | 1439 | 1439 | wp\_enqueue\_script('jquery'); |
  | 1440 | 1440 | wp\_enqueue\_script('js-fe-bootstrap',plugins\_url('js/js-agile-bootstrap.js', \_\_FILE\_\_)); |
  | 1441 | 1441 | wp\_enqueue\_style( 'agile-fe-bootstrap', plugins\_url('css/agile-bootstrap.css', \_\_FILE\_\_) ); |
  | 1442 | 1442 | } |
  | 1443 | 1443 |  |
  | 1444 | 1444 | function install(){ |
  | 1445 | 1445 |  |
  | 1446 | 1446 | } |
  | 1447 | 1447 |  |
  | 1448 | 1448 | //it is a wordpress function |
  | 1449 | 1449 | function admin\_menu(){ |
  | 1450 | 1450 |  |
  | 1451 | 1451 | add\_menu\_page('Settings', 'QLM', 'manage\_options', 'mnu\_qlm', array(&$this, 'setting\_api'),plugins\_url( 'quick-license-manager/images/certificate.png' ) ); |
  | 1452 | 1452 | add\_submenu\_page('mnu\_qlm', 'Settings', 'Settings' , 'manage\_options','mnu\_qlm', array(&$this, 'setting\_api') ); |
  | 1453 | 1453 | add\_submenu\_page('mnu\_qlm', 'Email Templates', 'Email Templates' , 'manage\_options','qlm\_templates', array(&$this, 'qlm\_email\_templates') ); |
  | 1454 | 1454 | } |
  | 1455 | 1455 |  |
  | 1456 | 1456 |  |
  | 1457 | 1457 |  |
  | 1458 | 1458 | //it is a wordpress function |
  | 1459 | 1459 | function wp\_set\_content\_type(){ |
  | 1460 | 1460 |  |
  | 1461 | 1461 | return "text/html"; |
  | 1462 | 1462 |  |
  | 1463 | 1463 | } |
  | 1464 | 1464 |  |
  | 1465 | 1465 | //This function shows/edits email template via the admin |
  | 1466 | 1466 | function qlm\_email\_templates(){ |
  | 1467 | 1467 | $qlm\_email\_v =new QLM\_Emails(); |
  | 1468 | 1468 |  |
  | 1469 | 1469 | if(isset($\_POST['submit\_template'])){ |
  | 1470 | 1470 | $pid = $\_POST['qlm\_pid']; |
  | 1471 | 1471 |  |
  | 1472 | 1472 | $email\_subject = $\_POST['qlm\_html\_subject']; |
  | 1473 | 1473 | update\_option( 'qlm\_subject', $email\_subject ); |
  | 1474 | 1474 |  |
  | 1475 | 1475 | $email\_header = $\_POST['qlm\_html\_header']; |
  | 1476 | 1476 | update\_option( 'qlm\_header', $email\_header ); |
  | 1477 | 1477 | $email\_html = $\_POST['qlm\_html\_mail']; |
  | 1478 | 1478 |  |
  | 1479 | 1479 | update\_post\_meta( $pid,'qlm\_email\_html',$email\_html ); |
  | 1480 | 1480 | $email\_footer = $\_POST['qlm\_html\_footer']; |
  | 1481 | 1481 | update\_option( 'qlm\_footer', $email\_footer ); |
  | 1482 | 1482 | } |
  | 1483 | 1483 | $qlm\_category='qlm'; |
  | 1484 | 1484 | $qlm\_products=$this->get\_products\_by\_catagory($qlm\_category); |
  | 1485 | 1485 | $qlm\_email\_v->show\_email\_templates($qlm\_products); |
  | 1486 | 1486 |  |
  | 1487 | 1487 | } |
  | 1488 | 1488 |  |
  | 1489 | 1489 | function get\_products\_by\_catagory($qlm\_category){ |
  | 1490 | 1490 | $args = array( |
  | 1491 | 1491 | 'posts\_per\_page' => -1, |
  | 1492 | 1492 | 'product\_cat' => $qlm\_category, |
  | 1493 | 1493 | 'post\_type' => 'product', |
  | 1494 | 1494 | 'orderby' => 'title', |
  | 1495 | 1495 | ); |
  | 1496 | 1496 | $product\_array =get\_posts ( $args ); |
  | 1497 | 1497 | return $product\_array; |
  | 1498 | 1498 | } |
  | 1499 | 1499 |  |
  | 1500 | 1500 | //this plugin settings main function. It saves API end point etc |
  | 1501 | 1501 | function setting\_api(){ |
  | 1502 | 1502 | $qlm\_v = new QLM\_Api\_View(); |
  | 1503 | 1503 |  |
  | 1504 | 1504 | $this->handle\_setting(); |
  | 1505 | 1505 | $qlm\_v->show\_setting(); |
  | 1506 | 1506 | } |
  | 1507 | 1507 |  |
  | 1508 | 1508 | //Settings handler |
  | 1509 | 1509 | function handle\_setting(){ |
  | 1510 | 1510 | if(isset($\_POST['qlm\_submit\_set'])){ |
  | 1511 | 1511 | $end = $\_POST['qlm\_end\_point']; |
  | 1512 | 1512 | $version = $\_POST['is\_qlmversion']; |
  | 1513 | 1513 | $licenseKeyFieldName = $\_POST['qlm\_licenseKeyFieldName']; |
  | 1514 | 1514 | $qlm\_categories = $\_POST['qlm\_categories']; |
  | 1515 | 1515 | $qlm\_user\_role = $\_POST['qlm\_user\_role']; |
  | 1516 | 1516 | $qlm\_maintenance\_plan\_identifier = $\_POST['qlm\_maintenance\_plan\_identifier']; |
  | 1517 | 1517 | $qlm\_webhook\_secret\_key = $\_POST['qlm\_webhook\_secret\_key']; |
  | 1518 | 1518 | $user\_id = $\_POST['qlm\_user\_id']; |
  | 1519 | 1519 | $password = $\_POST['qlm\_password']; |
  | 1520 | 1520 |  |
  | 1521 | 1521 |  |
  | 1522 | 1522 | if (empty ($\_POST['qlm\_product\_addon'])) |
  | 1523 | 1523 | { |
  | 1524 | 1524 | $qlm\_product\_addon = false; |
  | 1525 | 1525 | } |
  | 1526 | 1526 | else |
  | 1527 | 1527 | { |
  | 1528 | 1528 | $qlm\_product\_addon= $\_POST['qlm\_product\_addon']; |
  | 1529 | 1529 | } |
  | 1530 | 1530 |  |
  | 1531 | 1531 | if (empty ($\_POST['qlm\_revoke\_when\_order\_cancelled'])) |
  | 1532 | 1532 | { |
  | 1533 | 1533 | $qlm\_revoke\_when\_order\_cancelled = false; |
  | 1534 | 1534 | } |
  | 1535 | 1535 | else |
  | 1536 | 1536 | { |
  | 1537 | 1537 | $qlm\_revoke\_when\_order\_cancelled= $\_POST['qlm\_revoke\_when\_order\_cancelled']; |
  | 1538 | 1538 | } |
  | 1539 | 1539 |  |
  | 1540 | 1540 | if (empty ($\_POST['qlm\_revoke\_when\_subscription\_cancelled'])) |
  | 1541 | 1541 | { |
  | 1542 | 1542 | $qlm\_revoke\_when\_subscription\_cancelled = false; |
  | 1543 | 1543 | } |
  | 1544 | 1544 | else |
  | 1545 | 1545 | { |
  | 1546 | 1546 | $qlm\_revoke\_when\_subscription\_cancelled= $\_POST['qlm\_revoke\_when\_subscription\_cancelled']; |
  | 1547 | 1547 | } |
  | 1548 | 1548 |  |
  | 1549 | 1549 | if (empty ($\_POST['qlm\_next\_payment\_date\_based\_on\_schedule'])) |
  | 1550 | 1550 | { |
  | 1551 | 1551 | $qlm\_next\_payment\_date\_based\_on\_schedule = false; |
  | 1552 | 1552 | } |
  | 1553 | 1553 | else |
  | 1554 | 1554 | { |
  | 1555 | 1555 | $qlm\_next\_payment\_date\_based\_on\_schedule= $\_POST['qlm\_next\_payment\_date\_based\_on\_schedule']; |
  | 1556 | 1556 | } |
  | 1557 | 1557 |  |
  | 1558 | 1558 | if (empty ($\_POST['qlm\_process\_order\_on\_status\_completed'])) |
  | 1559 | 1559 | { |
  | 1560 | 1560 | $qlm\_process\_order\_on\_status\_completed = false; |
  | 1561 | 1561 | } |
  | 1562 | 1562 | else |
  | 1563 | 1563 | { |
  | 1564 | 1564 | $qlm\_process\_order\_on\_status\_completed= $\_POST['qlm\_process\_order\_on\_status\_completed']; |
  | 1565 | 1565 | } |
  | 1566 | 1566 |  |
  | 1567 | 1567 | if (empty ($\_POST['qlm\_send\_mail'])) |
  | 1568 | 1568 | { |
  | 1569 | 1569 | $qlm\_send\_mail = false; |
  | 1570 | 1570 | } |
  | 1571 | 1571 | else |
  | 1572 | 1572 | { |
  | 1573 | 1573 | $qlm\_send\_mail= $\_POST['qlm\_send\_mail']; |
  | 1574 | 1574 | } |
  | 1575 | 1575 |  |
  | 1576 | 1576 | if (empty ($\_POST['qlm\_enable\_log'])) |
  | 1577 | 1577 | { |
  | 1578 | 1578 | $qlm\_enable\_log = false; |
  | 1579 | 1579 | } |
  | 1580 | 1580 | else |
  | 1581 | 1581 | { |
  | 1582 | 1582 | $qlm\_enable\_log = $\_POST['qlm\_enable\_log']; |
  | 1583 | 1583 | } |
  | 1584 | 1584 |  |
  | 1585 | 1585 |  |
  | 1586 | 1586 | update\_option( 'qlm\_end\_point', $end ); |
  | 1587 | 1587 | update\_option( 'is\_qlmversion', $version ); |
  | 1588 | 1588 | update\_option( 'qlm\_licenseKeyFieldName', $licenseKeyFieldName ); |
  | 1589 | 1589 | update\_option( 'qlm\_categories', $qlm\_categories ); |
  | 1590 | 1590 | update\_option( 'qlm\_user\_role', $qlm\_user\_role ); |
  | 1591 | 1591 | update\_option( 'qlm\_maintenance\_plan\_identifier', $qlm\_maintenance\_plan\_identifier ); |
  | 1592 | 1592 | update\_option( 'qlm\_webhook\_secret\_key', $qlm\_webhook\_secret\_key ); |
  | 1593 | 1593 | update\_option( 'qlm\_product\_addon', $qlm\_product\_addon ); |
  | 1594 | 1594 | update\_option( 'qlm\_userid', $user\_id ); |
  | 1595 | 1595 | update\_option( 'qlm\_password', $password ); |
  | 1596 | 1596 | update\_option( 'qlm\_revoke\_when\_order\_cancelled', $qlm\_revoke\_when\_order\_cancelled ); |
  | 1597 | 1597 | update\_option( 'qlm\_revoke\_when\_subscription\_cancelled', $qlm\_revoke\_when\_subscription\_cancelled ); |
  | 1598 | 1598 | update\_option( 'qlm\_next\_payment\_date\_based\_on\_schedule', $qlm\_next\_payment\_date\_based\_on\_schedule ); |
  | 1599 | 1599 | update\_option( 'qlm\_process\_order\_on\_status\_completed', $qlm\_process\_order\_on\_status\_completed ); |
  | 1600 | 1600 | update\_option( 'qlm\_send\_mail', $qlm\_send\_mail ); |
  | 1601 | 1601 | update\_option( 'qlm\_enable\_log', $qlm\_enable\_log ); |
  | 1602 | 1602 |  |
  | 1603 | 1603 | echo "<h2>Your settings have been saved successfully.</h2>"; |
  | 1604 | 1604 | } |
  | 1605 | 1605 | } |
  | 1606 | 1606 |  |
  | 1607 | 1607 | /\* OBSOLETE |
  | 1608 | 1608 | This function is only for processing of a recurring order |
  | 1609 | 1609 | $orig\_order\_id    is the parent order id  (first order) |
  | 1610 | 1610 | $order\_id   It is the current order. It must be a recurring order |
  | 1611 | 1611 | \*/ |
  | 1612 | 1612 | function process\_recurring($orig\_order\_id, $order\_id,  $orig\_subscription ) |
  | 1613 | 1613 | { |
  | 1614 | 1614 | global $woocommerce; |
  | 1615 | 1615 |  |
  | 1616 | 1616 | $qlm\_v = new QLM\_Api\_View(); |
  | 1617 | 1617 |  |
  | 1618 | 1618 | $date\_time = date('Y-m-d H:i:s'); |
  | 1619 | 1619 |  |
  | 1620 | 1620 | //current order object |
  | 1621 | 1621 | $order = new WC\_Order($order\_id); |
  | 1622 | 1622 | //first order object |
  | 1623 | 1623 | $orig\_order = new WC\_Order($orig\_order\_id); |
  | 1624 | 1624 |  |
  | 1625 | 1625 | $items = $order->get\_items(); |
  | 1626 | 1626 |  |
  | 1627 | 1627 | $user\_id = $order->user\_id; |
  | 1628 | 1628 | if($user\_id == 0) return; |
  | 1629 | 1629 |  |
  | 1630 | 1630 | foreach($items as $item) |
  | 1631 | 1631 | { |
  | 1632 | 1632 | $qty = $item['qty']; |
  | 1633 | 1633 |  |
  | 1634 | 1634 | if($item['variation\_id'] != 0) |
  | 1635 | 1635 | { |
  | 1636 | 1636 | //This product is a variable product and is a recurring product |
  | 1637 | 1637 | //Let's get its activation key from parent order |
  | 1638 | 1638 |  |
  | 1639 | 1639 | $activation\_key = qlm\_get\_order\_meta($orig\_order\_id, '\_qlm\_license\_key\_'.$item['variation\_id'], true); |
  | 1640 | 1640 |  |
  | 1641 | 1641 | if(empty($activation\_key)) continue; //if we don't have activation key we cannot renew current recurring order |
  | 1642 | 1642 |  |
  | 1643 | 1643 |  |
  | 1644 | 1644 | $sp = WC\_Subscriptions\_Product::get\_period( $item['variation\_id'] ); |
  | 1645 | 1645 | debug\_message(495, $order,  \_\_FUNCTION\_\_, 'Processing Item:'.$item.'Period'.$sp); |
  | 1646 | 1646 |  |
  | 1647 | 1647 |  |
  | 1648 | 1648 | $sinterval = get\_post\_meta($item['variation\_id'], '\_subscription\_period\_interval', true); |
  | 1649 | 1649 |  |
  | 1650 | 1650 |  |
  | 1651 | 1651 | debug\_message(500, $order,  \_\_FUNCTION\_\_, 'Processing Item:'.$item.'Interval'.$sinterval); |
  | 1652 | 1652 |  |
  | 1653 | 1653 | $exduration = 1; |
  | 1654 | 1654 | switch($sp){ |
  | 1655 | 1655 | case 'day': |
  | 1656 | 1656 | $exduration = $sinterval; |
  | 1657 | 1657 | break; |
  | 1658 | 1658 | case 'week': |
  | 1659 | 1659 | $exduration = $sinterval \* 7; |
  | 1660 | 1660 | break; |
  | 1661 | 1661 | case 'month': |
  | 1662 | 1662 | $exduration = $sinterval \* 31; |
  | 1663 | 1663 | break; |
  | 1664 | 1664 | case 'year': |
  | 1665 | 1665 | $exduration = $sinterval \* 365; |
  | 1666 | 1666 | break; |
  | 1667 | 1667 | } |
  | 1668 | 1668 |  |
  | 1669 | 1669 |  |
  | 1670 | 1670 | $exdate = WC\_Subscriptions\_Product::get\_expiration\_date( $item['variation\_id'], $orig\_order->order\_date ); |
  | 1671 | 1671 |  |
  | 1672 | 1672 | $prod = new WC\_Product\_Variation( $item['variation\_id'] ); |
  | 1673 | 1673 | $attributes = $prod->get\_variation\_attributes(); |
  | 1674 | 1674 |  |
  | 1675 | 1675 |  |
  | 1676 | 1676 | if($attributes[$this->get\_maintenance\_plan\_attribute\_name()] == 'Yes') |
  | 1677 | 1677 | { |
  | 1678 | 1678 | $yearly = 1; |
  | 1679 | 1679 | $res = $qlm\_v->send\_recurring\_request($order, $item, $order->user\_id, $qty, $exduration, $exdate, $activation\_key, $yearly, $orig\_subscription); |
  | 1680 | 1680 | } |
  | 1681 | 1681 | else |
  | 1682 | 1682 | { |
  | 1683 | 1683 | $yearly = 0; |
  | 1684 | 1684 | $res = $qlm\_v->send\_recurring\_request($order, $item, $order->user\_id, $qty, $exduration, $exdate, $activation\_key, $yearly, $orig\_subscription); |
  | 1685 | 1685 | } |
  | 1686 | 1686 |  |
  | 1687 | 1687 | } |
  | 1688 | 1688 | else |
  | 1689 | 1689 | { |
  | 1690 | 1690 | //simple product |
  | 1691 | 1691 | $yearly = 0; |
  | 1692 | 1692 | $product\_id = $item['product\_id']; |
  | 1693 | 1693 | $activation\_key = qlm\_get\_order\_meta($orig\_order\_id, '\_qlm\_license\_key\_'.$product\_id, true); |
  | 1694 | 1694 |  |
  | 1695 | 1695 | if(empty($activation\_key)) |
  | 1696 | 1696 | { |
  | 1697 | 1697 | debug\_message(505, $order,  \_\_FUNCTION\_\_, 'Skipping product because no activation key was found. Product ID: '.$product\_id); |
  | 1698 | 1698 |  |
  | 1699 | 1699 | continue; |
  | 1700 | 1700 | } |
  | 1701 | 1701 |  |
  | 1702 | 1702 | $sp = WC\_Subscriptions\_Product::get\_period( $product\_id ); |
  | 1703 | 1703 |  |
  | 1704 | 1704 | debug\_message(510, $order,  \_\_FUNCTION\_\_, 'Processing Simple product: '.$product\_id.'Period: '.$sp); |
  | 1705 | 1705 |  |
  | 1706 | 1706 |  |
  | 1707 | 1707 | $sinterval = get\_post\_meta($product\_id, '\_subscription\_period\_interval', true); |
  | 1708 | 1708 |  |
  | 1709 | 1709 |  |
  | 1710 | 1710 | debug\_message(515, $order,  \_\_FUNCTION\_\_, 'Processing Simple product: '.$product\_id.'Interval: '.$sinterval); |
  | 1711 | 1711 |  |
  | 1712 | 1712 |  |
  | 1713 | 1713 | $exduration = 1; |
  | 1714 | 1714 | switch($sp) |
  | 1715 | 1715 | { |
  | 1716 | 1716 | case 'day': |
  | 1717 | 1717 | $exduration = $sinterval; |
  | 1718 | 1718 | break; |
  | 1719 | 1719 | case 'week': |
  | 1720 | 1720 | $exduration = $sinterval \* 7; |
  | 1721 | 1721 | break; |
  | 1722 | 1722 | case 'month': |
  | 1723 | 1723 | $exduration = $sinterval \* 31; |
  | 1724 | 1724 | break; |
  | 1725 | 1725 | case 'year': |
  | 1726 | 1726 | $exduration = $sinterval \* 365; |
  | 1727 | 1727 | break; |
  | 1728 | 1728 | } |
  | 1729 | 1729 |  |
  | 1730 | 1730 | debug\_message(520, $order,  \_\_FUNCTION\_\_, 'Processing Simple product: '.$product\_id.'Exp Duration: '.$exduration); |
  | 1731 | 1731 |  |
  | 1732 | 1732 | $exdate = WC\_Subscriptions\_Product::get\_expiration\_date( $product\_id, $orig\_order->order\_date ); |
  | 1733 | 1733 |  |
  | 1734 | 1734 | $res = $qlm\_v->send\_recurring\_request($order, $item, $order->user\_id, $qty, $exduration, $exdate, $activation\_key, $yearly=0, $orig\_subscription); |
  | 1735 | 1735 |  |
  | 1736 | 1736 | } |
  | 1737 | 1737 |  |
  | 1738 | 1738 |  |
  | 1739 | 1739 | if($res['status'] == 'error') |
  | 1740 | 1740 | { |
  | 1741 | 1741 | $msg = $date\_time.' '.$res['err\_msg']; |
  | 1742 | 1742 | $order->add\_order\_note($msg); |
  | 1743 | 1743 | continue; |
  | 1744 | 1744 | } |
  | 1745 | 1745 | else |
  | 1746 | 1746 | { |
  | 1747 | 1747 | $license\_key = $res['license\_key']; |
  | 1748 | 1748 | $title = $item['name']; |
  | 1749 | 1749 | $rest = substr($title, 0, 35); |
  | 1750 | 1750 | $new\_meta = "$rest: $license\_key"; |
  | 1751 | 1751 |  |
  | 1752 | 1752 | //get post meta |
  | 1753 | 1753 | //oldvalue + Title + $licensekey |
  | 1754 | 1754 |  |
  | 1755 | 1755 | if($item['variation\_id'] != 0) |
  | 1756 | 1756 | { |
  | 1757 | 1757 | $variation\_id = $item['variation\_id']; |
  | 1758 | 1758 |  |
  | 1759 | 1759 | qlm\_update\_order\_meta($order\_id, '\_qlm\_license\_key\_'.$variation\_id, $activation\_key); |
  | 1760 | 1760 | $order->save(); |
  | 1761 | 1761 |  |
  | 1762 | 1762 | $old\_meta = qlm\_get\_order\_meta($order\_id, '\_qlm\_license\_keys', true); |
  | 1763 | 1763 |  |
  | 1764 | 1764 | if($old\_meta) |
  | 1765 | 1765 | { |
  | 1766 | 1766 | $update\_meta = $old\_meta.'<br />'.$new\_meta; |
  | 1767 | 1767 | }else{ |
  | 1768 | 1768 | $update\_meta = $new\_meta; |
  | 1769 | 1769 | } |
  | 1770 | 1770 |  |
  | 1771 | 1771 | qlm\_update\_order\_meta($order\_id, '\_qlm\_license\_keys', $update\_meta); |
  | 1772 | 1772 | } |
  | 1773 | 1773 | else |
  | 1774 | 1774 | { |
  | 1775 | 1775 | $product\_id = $item['product\_id']; |
  | 1776 | 1776 |  |
  | 1777 | 1777 | qlm\_update\_order\_meta($order\_id, '\_qlm\_license\_key\_'.$product\_id, $activation\_key); |
  | 1778 | 1778 | $order->save(); |
  | 1779 | 1779 |  |
  | 1780 | 1780 | $old\_meta = qlm\_get\_order\_meta($order\_id, '\_qlm\_license\_keys', true); |
  | 1781 | 1781 |  |
  | 1782 | 1782 | if($old\_meta) |
  | 1783 | 1783 | { |
  | 1784 | 1784 | $update\_meta = $old\_meta.'<br />'.$new\_meta; |
  | 1785 | 1785 | }else { |
  | 1786 | 1786 | $update\_meta = $new\_meta; |
  | 1787 | 1787 | } |
  | 1788 | 1788 |  |
  | 1789 | 1789 | qlm\_update\_order\_meta($order\_id, '\_qlm\_license\_keys', $update\_meta); |
  | 1790 | 1790 | } |
  | 1791 | 1791 |  |
  | 1792 | 1792 | /\* |
  | 1793 | 1793 | debug\_message(525, $order,  \_\_FUNCTION\_\_, 'Setting Order  Status to Completed.'); |
  | 1794 | 1794 | $order->update\_status('completed'); \*/ |
  | 1795 | 1795 | } |
  | 1796 | 1796 | } |
  | 1797 | 1797 | } |
  | 1798 | 1798 |  |
  | 1799 | 1799 | }// class ends |
  | 1800 | 1800 | }//if ends |
  | 1801 | 1801 |  |
  | 1802 | 1802 | new QLM\_Main(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3198437&old=3198391&new_path=%2Fquick-license-manager%2Ftrunk&old_path=%2Fquick-license-manager%2Ftrunk)
* [Zip Archive](?format=zip&new=3198437&old=3198391&new_path=%2Fquick-license-manager%2Ftrunk&old_path=%2Fquick-license-manager%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


