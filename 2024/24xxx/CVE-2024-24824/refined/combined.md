=== Content from github.com_1456aeb3_20250115_090050.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2F7f8ef7fa8edf493106d5ef6f777d4da02c5194d9)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2F7f8ef7fa8edf493106d5ef6f777d4da02c5194d9)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Graylog2%2Fgraylog2-server)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Graylog2](/Graylog2)
/
**[graylog2-server](/Graylog2/graylog2-server)**
Public

* [Notifications](/login?return_to=%2FGraylog2%2Fgraylog2-server) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2FGraylog2%2Fgraylog2-server)
* [Star
   7.5k](/login?return_to=%2FGraylog2%2Fgraylog2-server)

* [Code](/Graylog2/graylog2-server)
* [Issues
  1.7k](/Graylog2/graylog2-server/issues)
* [Pull requests
  148](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects
  0](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

Additional navigation options

* [Code](/Graylog2/graylog2-server)
* [Issues](/Graylog2/graylog2-server/issues)
* [Pull requests](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

## Commit

[Permalink](/Graylog2/graylog2-server/commit/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Restrict classes allowed for cluster config and event types ([#18165](https://github.com/Graylog2/graylog2-server/pull/18165)) ([#…](https://github.com/Graylog2/graylog2-server/pull/18180)

[Browse files](/Graylog2/graylog2-server/tree/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9)
Browse the repository at this point in the history

```
[…18180](https://github.com/Graylog2/graylog2-server/pull/18180))

* Restrict classes allowed for cluster config and event types ([#18165](https://github.com/Graylog2/graylog2-server/pull/18165))

Add a new safe_classes configuration option to restrict the classes allowed to be used
as cluster config and event types.
The configuration option allows to specify a comma-separated set of prefixes matched
against the fully qualified class name.

For now, the default value for the configuration is org.graylog.,org.graylog2., which will
allow all classes that Graylog maintains.

This should work out of the box for almost all setups. Changing the default value might
only be necessary if external plugins require cluster config or event types outside the
"org.graylog." or "org.graylog2." namespaces. If that is the case, the configuration setting
can be adjusted to cover this use case, e.b. by setting it to

    safe_classes = org.graylog.,org.graylog2.,custom.plugin.namespace.

if said classes are located within the custom.plugin.namespace package.

Refs: [GHSA-p6gg-5hf4-4rgj](https://github.com/Graylog2/graylog2-server/security/advisories/GHSA-p6gg-5hf4-4rgj "GHSA-p6gg-5hf4-4rgj")

(cherry picked from commit [8132032](https://github.com/Graylog2/graylog2-server/commit/813203263b06dda18e2aed68ae92b34277f904b4))

* Use javax.inject.Inject instead of jakarta.inject.Inject

* Add "jakarta.inject.**" to forbidden APIs

This will help us with issue for backported code that's already using
jakarta.inject.

* Use javax.ws.rs instead of jakarta.ws.rs

---------

Co-authored-by: Othello Maurer <othello@graylog.com>
```

* Loading branch information

[![@bernd](https://avatars.githubusercontent.com/u/461?s=40&v=4)](/bernd) [![@thll](https://avatars.githubusercontent.com/u/886541?s=40&v=4)](/thll)

[bernd](/Graylog2/graylog2-server/commits?author=bernd "View all commits by bernd")
and
[thll](/Graylog2/graylog2-server/commits?author=thll "View all commits by thll")
authored
Feb 6, 2024

1 parent
[fa99567](/Graylog2/graylog2-server/commit/fa995674e7ef4afcbdbf10c2db647b6d5aa018fd)

commit 7f8ef7f

 Show file tree

 Hide file tree

Showing
**17 changed files**
with
**430 additions**
and
**30 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* changelog/unreleased

  + changelog/unreleased/pr-18165.toml
    [pr-18165.toml](#diff-2efa20491342fcafad6f2cba7979bd0c491260d3a59a9658ea2808b26ef0da9d)
* data-node/src/main/java/org/graylog/datanode

  + data-node/src/main/java/org/graylog/datanode/Configuration.java
    [Configuration.java](#diff-b314d0858e1ff8ab37f372aece3a65f4e0f2daf7019056edd4cbec2127582cba)
* graylog2-server/src

  + main/java/org/graylog2

    - graylog2-server/src/main/java/org/graylog2/Configuration.java
      [Configuration.java](#diff-f9147c088b0c6c14d129a631c0bd352de6469624948c0ebf2af2c8119071c8cd)
    - cluster

      * graylog2-server/src/main/java/org/graylog2/cluster/ClusterConfigServiceImpl.java
        [ClusterConfigServiceImpl.java](#diff-850e5c024f4b7d5cdd62a4826ad7ebb00d9c88278204e5d53016fa8a84ba5d59)
    - events

      * graylog2-server/src/main/java/org/graylog2/events/ClusterEventPeriodical.java
        [ClusterEventPeriodical.java](#diff-b21f472266cbfcee53ea6dbde4b213af539d20ec8943796ba81ddc8a21e85b9e)
    - rest/resources/system

      * graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java
        [ClusterConfigResource.java](#diff-bbd8268eeda577686f553026b601d493dad19bbf95172f56b763600adb5377c2)
    - security

      * graylog2-server/src/main/java/org/graylog2/security/RestrictedChainingClassLoader.java
        [RestrictedChainingClassLoader.java](#diff-1902d0a09558487039fedbcdcfa1c39fd0481117899eb125fb076b25fc908a2f)
      * graylog2-server/src/main/java/org/graylog2/security/SafeClasses.java
        [SafeClasses.java](#diff-ea556ca9d6d41c0efd3700d7d5236439ff0cb2cbb7dd4062e28c3733fd78f2b1)
      * graylog2-server/src/main/java/org/graylog2/security/UnsafeClassLoadingAttemptException.java
        [UnsafeClassLoadingAttemptException.java](#diff-458958348300f6293950e10edd90b6f69adb98992d47c7a12476068b916bca5a)
  + test/java/org

    - graylog/plugins/views/search/views

      * graylog2-server/src/test/java/org/graylog/plugins/views/search/views/ViewServiceTest.java
        [ViewServiceTest.java](#diff-7ed796e227f4c76a03c6e1b24eed5bdc11c34a0cfd1d9e7c7e792d764635a21f)
    - graylog2

      * cluster

        + graylog2-server/src/test/java/org/graylog2/cluster/ClusterConfigServiceImplTest.java
          [ClusterConfigServiceImplTest.java](#diff-4999ddba870f695ec4523e86369df4ad2db45a5e8cd8c9b3fef9c98307e1fba5)
      * events

        + graylog2-server/src/test/java/org/graylog2/events/ClusterEventPeriodicalTest.java
          [ClusterEventPeriodicalTest.java](#diff-9d2173c1e3cfcf5fc7c2b1819e8d57421c158703e51481733fe7b9e13ad774b3)
      * indexer/indexset

        + graylog2-server/src/test/java/org/graylog2/indexer/indexset/MongoIndexSetServiceTest.java
          [MongoIndexSetServiceTest.java](#diff-f1d99a1586523e7d225888bd42cd74796a4b782f02ec266a5dd1c4a5315a6c3f)
      * migrations

        + graylog2-server/src/test/java/org/graylog2/migrations/V20161215163900\_MoveIndexSetDefaultConfigTest.java
          [V20161215163900\_MoveIndexSetDefaultConfigTest.java](#diff-e9eb1a684684bc855dbd424f3ecb6a6f57cfa330f09e5c7b3e21870b86d6ffa2)
        + graylog2-server/src/test/java/org/graylog2/migrations/V20170110150100\_FixAlertConditionsMigrationTest.java
          [V20170110150100\_FixAlertConditionsMigrationTest.java](#diff-88eb06111dcb4a573f1e65bd525785521e51e028ac318eeef560d9c38337a453)
      * rest/resources/system

        + graylog2-server/src/test/java/org/graylog2/rest/resources/system/ClusterConfigResourceTest.java
          [ClusterConfigResourceTest.java](#diff-d36e8e25e9b576bb73b3a643408675c27954472d3b7f7ab3e0664659852bca0d)
* pom.xml
  [pom.xml](#diff-9c5fb3d1b7e3b0f54bc5c4182965c4fe1f9023d449017cece3005d3f90e8e4d8)

## There are no files selected for viewing

4 changes: 4 additions & 0 deletions

4
[changelog/unreleased/pr-18165.toml](#diff-2efa20491342fcafad6f2cba7979bd0c491260d3a59a9658ea2808b26ef0da9d "changelog/unreleased/pr-18165.toml")

Show comments

[View file](/Graylog2/graylog2-server/blob/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9/changelog/unreleased/pr-18165.toml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,4 @@ |
|  |  | type = "security" |
|  |  | message = "Restrict classes allowed for cluster config and event types. [GHSA-p6gg-5hf4-4rgj](https://github.com/Graylog2/graylog2-server/security/advisories/GHSA-p6gg-5hf4-4rgj)" |
|  |  |  |
|  |  | pulls = ["18165"] |

9 changes: 9 additions & 0 deletions

9
[data-node/src/main/java/org/graylog/datanode/Configuration.java](#diff-b314d0858e1ff8ab37f372aece3a65f4e0f2daf7019056edd4cbec2127582cba "data-node/src/main/java/org/graylog/datanode/Configuration.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9/data-node/src/main/java/org/graylog/datanode/Configuration.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,6 +23,7 @@ |
|  |  | import com.github.joschi.jadconfig.ValidatorMethod; |
|  |  | import com.github.joschi.jadconfig.converters.IntegerConverter; |
|  |  | import com.github.joschi.jadconfig.converters.StringListConverter; |
|  |  | import com.github.joschi.jadconfig.converters.StringSetConverter; |
|  |  | import com.github.joschi.jadconfig.util.Duration; |
|  |  | import com.github.joschi.jadconfig.validators.DirectoryPathReadableValidator; |
|  |  | import com.github.joschi.jadconfig.validators.DirectoryPathWritableValidator; |
| Expand All | | @@ -33,6 +34,7 @@ |
|  |  | import com.google.common.net.InetAddresses; |
|  |  | import org.graylog.datanode.configuration.BaseConfiguration; |
|  |  | import org.graylog.datanode.configuration.DatanodeDirectories; |
|  |  | import org.graylog2.Configuration.SafeClassesValidator; |
|  |  | import org.graylog2.plugin.Tools; |
|  |  | import org.graylog2.shared.SuppressForbidden; |
|  |  | import org.joda.time.DateTimeZone; |
| Expand All | | @@ -52,6 +54,7 @@ |
|  |  | import java.util.Collections; |
|  |  | import java.util.List; |
|  |  | import java.util.Optional; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Helper class to hold configuration of Graylog |
| Expand Down  Expand Up | | @@ -212,6 +215,12 @@ public class Configuration extends BaseConfiguration { |
|  |  | @Parameter(value = "http\_allow\_embedding") |
|  |  | private boolean httpAllowEmbedding = false; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Classes considered safe to load by name. A set of prefixes matched against the fully qualified class name. |
|  |  | \*/ |
|  |  | @Parameter(value = org.graylog2.Configuration.SAFE\_CLASSES, converter = StringSetConverter.class, validators = SafeClassesValidator.class) |
|  |  | private Set<String> safeClasses = Set.of("org.graylog.", "org.graylog2."); |
|  |  |  |
|  |  | public boolean isInsecureStartup() { |
|  |  | return insecureStartup; |
|  |  | } |
| Expand Down | |  |

27 changes: 27 additions & 0 deletions

27
[graylog2-server/src/main/java/org/graylog2/Configuration.java](#diff-f9147c088b0c6c14d129a631c0bd352de6469624948c0ebf2af2c8119071c8cd "graylog2-server/src/main/java/org/graylog2/Configuration.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9/graylog2-server/src/main/java/org/graylog2/Configuration.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ |
|  |  | import com.github.joschi.jadconfig.validators.PositiveLongValidator; |
|  |  | import com.github.joschi.jadconfig.validators.StringNotBlankValidator; |
|  |  | import com.google.common.collect.Sets; |
|  |  | import org.apache.commons.lang3.StringUtils; |
|  |  | import org.graylog.plugins.views.search.engine.suggestions.FieldValueSuggestionMode; |
|  |  | import org.graylog.plugins.views.search.engine.suggestions.FieldValueSuggestionModeConverter; |
|  |  | import org.graylog.security.certutil.CaConfiguration; |
| Expand All | | @@ -49,11 +50,14 @@ |
|  |  | import java.util.Collections; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | import static org.graylog2.shared.utilities.StringUtils.f; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Helper class to hold configuration of Graylog |
|  |  | \*/ |
|  |  | @SuppressWarnings("FieldMayBeFinal") |
|  |  | public class Configuration extends CaConfiguration { |
|  |  | public static final String SAFE\_CLASSES = "safe\_classes"; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Deprecated! Use isLeader() instead. |
| Expand Down  Expand Up | | @@ -224,6 +228,12 @@ public class Configuration extends CaConfiguration { |
|  |  | @Parameter(value = "minimum\_auto\_refresh\_interval", required = true) |
|  |  | private Period minimumAutoRefreshInterval = Period.seconds(1); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Classes considered safe to load by name. A set of prefixes matched against the fully qualified class name. |
|  |  | \*/ |
|  |  | @Parameter(value = SAFE\_CLASSES, converter = StringSetConverter.class, validators = SafeClassesValidator.class) |
|  |  | private Set<String> safeClasses = Set.of("org.graylog.", "org.graylog2."); |
|  |  |  |
|  |  | @Parameter(value = "field\_value\_suggestion\_mode", required = true, converter = FieldValueSuggestionModeConverter.class) |
|  |  | private FieldValueSuggestionMode fieldValueSuggestionMode = FieldValueSuggestionMode.ON; |
|  |  |  |
| Expand Down  Expand Up | | @@ -450,6 +460,10 @@ public Period getMinimumAutoRefreshInterval() { |
|  |  | return minimumAutoRefreshInterval; |
|  |  | } |
|  |  |  |
|  |  | public Set<String> getSafeClasses() { |
|  |  | return safeClasses; |
|  |  | } |
|  |  |  |
|  |  | public FieldValueSuggestionMode getFieldValueSuggestionMode() { |
|  |  | return fieldValueSuggestionMode; |
|  |  | } |
| Expand Down  Expand Up | | @@ -557,4 +571,17 @@ public void validate(String name, String path) throws ValidationException { |
|  |  | throw new ValidationException("Node ID file at path " + path + " isn't " + b + ". Please specify the correct path or change the permissions"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | public static class SafeClassesValidator implements Validator<Set<String>> { |
|  |  | @Override |
|  |  | public void validate(String name, Set<String> set) throws ValidationException { |
|  |  | if (set.isEmpty()) { |
|  |  | throw new ValidationException(f("\"%s\" must not be empty. Please specify a comma-separated list of " + |
|  |  | "fully-qualified class name prefixes.", name)); |
|  |  | } |
|  |  | if (set.stream().anyMatch(StringUtils::isBlank)) { |
|  |  | throw new ValidationException(f("\"%s\" must only contain non-empty class name prefixes.", name)); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |

23 changes: 19 additions & 4 deletions

23
[graylog2-server/src/main/java/org/graylog2/cluster/ClusterConfigServiceImpl.java](#diff-850e5c024f4b7d5cdd62a4826ad7ebb00d9c88278204e5d53016fa8a84ba5d59 "graylog2-server/src/main/java/org/graylog2/cluster/ClusterConfigServiceImpl.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9/graylog2-server/src/main/java/org/graylog2/cluster/ClusterConfigServiceImpl.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -27,6 +27,9 @@ |
|  |  | import org.graylog2.events.ClusterEventBus; |
|  |  | import org.graylog2.plugin.cluster.ClusterConfigService; |
|  |  | import org.graylog2.plugin.system.NodeId; |
|  |  | import org.graylog2.security.RestrictedChainingClassLoader; |
|  |  | import org.graylog2.security.SafeClasses; |
|  |  | import org.graylog2.security.UnsafeClassLoadingAttemptException; |
|  |  | import org.graylog2.shared.plugins.ChainingClassLoader; |
|  |  | import org.graylog2.shared.utilities.AutoValueUtils; |
|  |  | import org.joda.time.DateTime; |
| Expand All | | @@ -52,23 +55,33 @@ public class ClusterConfigServiceImpl implements ClusterConfigService { |
|  |  | private final JacksonDBCollection<ClusterConfig, String> dbCollection; |
|  |  | private final NodeId nodeId; |
|  |  | private final ObjectMapper objectMapper; |
|  |  | private final ChainingClassLoader chainingClassLoader; |
|  |  | private final RestrictedChainingClassLoader chainingClassLoader; |
|  |  | private final EventBus clusterEventBus; |
|  |  |  |
|  |  | @Inject |
|  |  | public ClusterConfigServiceImpl(final MongoJackObjectMapperProvider mapperProvider, |
|  |  | final MongoConnection mongoConnection, |
|  |  | final NodeId nodeId, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final RestrictedChainingClassLoader chainingClassLoader, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this(JacksonDBCollection.wrap(prepareCollection(mongoConnection), ClusterConfig.class, String.class, mapperProvider.get()), |
|  |  | nodeId, mapperProvider.get(), chainingClassLoader, clusterEventBus); |
|  |  | } |
|  |  |  |
|  |  | @Deprecated |
|  |  | public ClusterConfigServiceImpl(final MongoJackObjectMapperProvider mapperProvider, |
|  |  | final MongoConnection mongoConnection, |
|  |  | final NodeId nodeId, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this(JacksonDBCollection.wrap(prepareCollection(mongoConnection), ClusterConfig.class, String.class, mapperProvider.get()), |
|  |  | nodeId, mapperProvider.get(), new RestrictedChainingClassLoader(chainingClassLoader, SafeClasses.allGraylogInternal()), clusterEventBus); |
|  |  | } |
|  |  |  |
|  |  | private ClusterConfigServiceImpl(final JacksonDBCollection<ClusterConfig, String> dbCollection, |
|  |  | final NodeId nodeId, |
|  |  | final ObjectMapper objectMapper, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final RestrictedChainingClassLoader chainingClassLoader, |
|  |  | final EventBus clusterEventBus) { |
|  |  | this.nodeId = checkNotNull(nodeId); |
|  |  | this.dbCollection = checkNotNull(dbCollection); |
| Expand Down  Expand Up | | @@ -174,10 +187,12 @@ public Set<Class<?>> list() { |
|  |  | for (ClusterConfig clusterConfig : clusterConfigs) { |
|  |  | final String type = clusterConfig.type(); |
|  |  | try { |
|  |  | final Class<?> cls = chainingClassLoader.loadClass(type); |
|  |  | final Class<?> cls = chainingClassLoader.loadClassSafely(type); |
|  |  | classes.add(cls); |
|  |  | } catch (ClassNotFoundException e) { |
|  |  | LOG.debug("Couldn't find configuration class \"{}\"", type, e); |
|  |  | } catch (UnsafeClassLoadingAttemptException e) { |
|  |  | LOG.warn("Couldn't load class <{}>.", type, e); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

38 changes: 27 additions & 11 deletions

38
[graylog2-server/src/main/java/org/graylog2/events/ClusterEventPeriodical.java](#diff-b21f472266cbfcee53ea6dbde4b213af539d20ec8943796ba81ddc8a21e85b9e "graylog2-server/src/main/java/org/graylog2/events/ClusterEventPeriodical.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9/graylog2-server/src/main/java/org/graylog2/events/ClusterEventPeriodical.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,6 +32,9 @@ |
|  |  | import org.graylog2.database.MongoConnection; |
|  |  | import org.graylog2.plugin.periodical.Periodical; |
|  |  | import org.graylog2.plugin.system.NodeId; |
|  |  | import org.graylog2.security.RestrictedChainingClassLoader; |
|  |  | import org.graylog2.security.SafeClasses; |
|  |  | import org.graylog2.security.UnsafeClassLoadingAttemptException; |
|  |  | import org.graylog2.shared.plugins.ChainingClassLoader; |
|  |  | import org.graylog2.shared.utilities.AutoValueUtils; |
|  |  | import org.mongojack.DBCursor; |
| Expand All | | @@ -56,25 +59,38 @@ public class ClusterEventPeriodical extends Periodical { |
|  |  | private final NodeId nodeId; |
|  |  | private final ObjectMapper objectMapper; |
|  |  | private final EventBus serverEventBus; |
|  |  | private final ChainingClassLoader chainingClassLoader; |
|  |  | private final RestrictedChainingClassLoader chainingClassLoader; |
|  |  |  |
|  |  | @Inject |
|  |  | public ClusterEventPeriodical(final MongoJackObjectMapperProvider mapperProvider, |
|  |  | final MongoConnection mongoConnection, |
|  |  | final NodeId nodeId, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final RestrictedChainingClassLoader chainingClassLoader, |
|  |  | final EventBus serverEventBus, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this(JacksonDBCollection.wrap(prepareCollection(mongoConnection), ClusterEvent.class, String.class, mapperProvider.get()), |
|  |  | nodeId, mapperProvider.get(), chainingClassLoader, serverEventBus, clusterEventBus); |
|  |  | } |
|  |  |  |
|  |  | @Deprecated |
|  |  | public ClusterEventPeriodical(final MongoJackObjectMapperProvider mapperProvider, |
|  |  | final MongoConnection mongoConnection, |
|  |  | final NodeId nodeId, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final EventBus serverEventBus, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this(JacksonDBCollection.wrap(prepareCollection(mongoConnection), ClusterEvent.class, String.class, |
|  |  | mapperProvider.get()), nodeId, mapperProvider.get(), |
|  |  | new RestrictedChainingClassLoader(chainingClassLoader, SafeClasses.allGraylogInternal()), |
|  |  | serverEventBus, clusterEventBus); |
|  |  | } |
|  |  |  |
|  |  | private ClusterEventPeriodical(final JacksonDBCollection<ClusterEvent, String> dbCollection, |
|  |  | final NodeId nodeId, |
|  |  | final ObjectMapper objectMapper, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final EventBus serverEventBus, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | final NodeId nodeId, |
|  |  | final ObjectMapper objectMapper, |
|  |  | final RestrictedChainingClassLoader chainingClassLoader, |
|  |  | final EventBus serverEventBus, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this.nodeId = checkNotNull(nodeId); |
|  |  | this.dbCollection = checkNotNull(dbCollection); |
|  |  | this.objectMapper = checkNotNull(objectMapper); |
| Expand Down  Expand Up | | @@ -204,15 +220,15 @@ private void updateConsumers(final String eventId, final NodeId nodeId) { |
|  |  |  |
|  |  | private Object extractPayload(Object payload, String eventClass) { |
|  |  | try { |
|  |  | final Class<?> clazz = chainingClassLoader.loadClass(eventClass); |
|  |  | final Class<?> clazz = chainingClassLoader.loadClassSafely(eventClass); |
|  |  | return objectMapper.convertValue(payload, clazz); |
|  |  | } catch (ClassNotFoundException e) { |
|  |  | LOG.debug("Couldn't load class <" + eventClass + "> for event", e); |
|  |  | return null; |
|  |  | } catch (IllegalArgumentException e) { |
|  |  | LOG.debug("Error while deserializing payload", e); |
|  |  | return null; |
|  |  |  |
|  |  | } catch (UnsafeClassLoadingAttemptException e) { |
|  |  | LOG.warn("Couldn't load class <{}>.", eventClass, e); |
|  |  | } |
|  |  | return null; |
|  |  | } |
|  |  | } |

11 changes: 7 additions & 4 deletions

11
[graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java](#diff-bbd8268eeda577686f553026b601d493dad19bbf95172f56b763600adb5377c2 "graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9/graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -33,7 +33,8 @@ |
|  |  | import org.graylog2.plugin.validate.ConfigValidationException; |
|  |  | import org.graylog2.rest.MoreMediaTypes; |
|  |  | import org.graylog2.rest.models.system.config.ClusterConfigList; |
|  |  | import org.graylog2.shared.plugins.ChainingClassLoader; |
|  |  | import org.graylog2.security.RestrictedChainingClassLoader; |
|  |  | import org.graylog2.security.UnsafeClassLoadingAttemptException; |
|  |  | import org.graylog2.shared.rest.resources.RestResource; |
|  |  | import org.graylog2.shared.security.RestPermissions; |
|  |  | import org.slf4j.Logger; |
| Expand Down  Expand Up | | @@ -71,13 +72,13 @@ public class ClusterConfigResource extends RestResource { |
|  |  | public static final String NO\_CLASS\_MSG = "Couldn't find configuration class '%s'"; |
|  |  |  |
|  |  | private final ClusterConfigService clusterConfigService; |
|  |  | private final ChainingClassLoader chainingClassLoader; |
|  |  | private final RestrictedChainingClassLoader chainingClassLoader; |
|  |  | private final ObjectMapper objectMapper; |
|  |  | private final ClusterConfigValidatorService clusterConfigValidatorService; |
|  |  |  |
|  |  | @Inject |
|  |  | public ClusterConfigResource(ClusterConfigService clusterConfigService, |
|  |  | ChainingClassLoader chainingClassLoader, |
|  |  | RestrictedChainingClassLoader chainingClassLoader, |
|  |  | ObjectMapper objectMapper, |
|  |  | ClusterConfigValidatorService clusterConfigValidatorService) { |
|  |  | this.clusterConfigService = requireNonNull(clusterConfigService); |
| Expand Down  Expand Up | | @@ -207,9 +208,11 @@ public JsonSchema schema(@ApiParam(name = "configClass", value = "The name of th |
|  |  | @Nullable |
|  |  | private Class<?> classFromName(String className) { |
|  |  | try { |
|  |  | return chainingClassLoader.loadClass(className); |
|  |  | return chainingClassLoader.loadClassSafely(className); |
|  |  | } catch (ClassNotFoundException e) { |
|  |  | return null; |
|  |  | } catch (UnsafeClassLoadingAttemptException e) { |
|  |  | throw new BadRequestException(e.getLocalizedMessage()); |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

61 changes: 61 additions & 0 deletions

61
[graylog2-server/src/main/java/org/graylog2/security/RestrictedChainingClassLoader.java](#diff-1902d0a09558487039fedbcdcfa1c39fd0481117899eb125fb076b25fc908a2f "graylog2-server/src/main/java/org/graylog2/security/RestrictedChainingClassLoader.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9/graylog2-server/src/main/java/org/graylog2/security/RestrictedChainingClassLoader.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,61 @@ |
|  |  | /\* |
|  |  | \* Copyright (C) 2020 Graylog, Inc. |
|  |  | \* |
|  |  | \* This program is free software: you can redistribute it and/or modify |
|  |  | \* it under the terms of the Server Side Public License, version 1, |
|  |  | \* as published by MongoDB, Inc. |
|  |  | \* |
|  |  | \* This program is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the |
|  |  | \* Server Side Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the Server Side Public License |
|  |  | \* along with this program. If not, see |
|  |  | \* <http://www.mongodb.com/licensing/server-side-public-license>. |
|  |  | \*/ |
|  |  | package org.graylog2.security; |
|  |  |  |
|  |  | import org.graylog2.Configuration; |
|  |  | import org.graylog2.shared.plugins.ChainingClassLoader; |
|  |  |  |
|  |  | import javax.inject.Inject; |
|  |  |  |
|  |  | import static org.graylog2.shared.utilities.StringUtils.f; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* A wrapper around the chaining class loader intended only for loading classes safely by considering an allow-list of |
|  |  | \* class name prefixes. |
|  |  | \*/ |
|  |  | public class RestrictedChainingClassLoader { |
|  |  | private final ChainingClassLoader delegate; |
|  |  | private final SafeClasses safeClasses; |
|  |  |  |
|  |  | @Inject |
|  |  | public RestrictedChainingClassLoader(ChainingClassLoader delegate, SafeClasses safeClasses) { |
|  |  | this.delegate = delegate; |
|  |  | this.safeClasses = safeClasses; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Load the class only if the name passes the check of {@link SafeClasses#isSafeToLoad(String)}. If the class name |
|  |  | \* passes the check, the call is delegated to {@link ChainingClassLoader#loadClass(String)}. If it doesn't pass the |
|  |  | \* check, an {@link UnsafeClassLoadingAttemptException} is thrown. |
|  |  | \* |
|  |  | \* @return class as returned by the delegated call to {@link ChainingClassLoader#loadClass(String)} |
|  |  | \* @throws ClassNotFoundException if the class was not found |
|  |  | \* @throws UnsafeClassLoadingAttemptException if the class name didn't pass the safety check of |
|  |  | \* {@link SafeClasses#isSafeToLoad(String)} |
|  |  | \*/ |
|  |  | public Class<?> loadClassSafely(String name) throws ClassNotFoundException, UnsafeClassLoadingAttemptException { |
|  |  | if (safeClasses.isSafeToLoad(name)) { |
|  |  | return delegate.loadClass(name); |
|  |  | } else { |
|  |  | throw new UnsafeClassLoadingAttemptException( |
|  |  | f("Prevented loading of unsafe class \"%s\". Consider adjusting the configuration setting " + |
|  |  | "\"%s\", if you think that this is a mistake.", name, Configuration.SAFE\_CLASSES) |
|  |  | ); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | } |

52 changes: 52 additions & 0 deletions

52
[graylog2-server/src/main/java/org/graylog2/security/SafeClasses.java](#diff-ea556ca9d6d41c0efd3700d7d5236439ff0cb2cbb7dd4062e28c3733fd78f2b1 "graylog2-server/src/main/java/org/graylog2/security/SafeClasses.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/7f8ef7fa8edf493106d5ef6f777d4da02c5194d9/graylog2-server/src/main/java/org/graylog2/security/SafeClasses.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,52 @@ |
|  |  | /\* |
|  |  | \* Copyright (C) 2020 Graylog, Inc. |
|  |  | \* |
|  |  | \* This program is free software: you can redistribute it and/or modify |
|  |  | \* it under the terms of the Server Side Public License, version 1, |
|  |  | \* as published by MongoDB, Inc. |
|  |  | \* |
|  |  | \* This program is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the |
|  |  | \* Server Side Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the Server Side Public License |
|  |  | \* along with this program. If not, see |
|  |  | \* <http://www.mongodb.com/licensing/server-side-public-license>. |
|  |  | \*/ |
|  |  | package org.graylog2.security; |
|  |  |  |
|  |  | import org.graylog2.Configuration; |
|  |  |  |
|  |  | import javax.annotation.Nonnull; |
|  |  | import javax.inject.Inject; |
|  |  | import javax.inject.Named; |
|  |  | import javax.inject.Singleton; |
|  |  | import java.util.Objects; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Adds a safety net for class loading. |
|  |  | \*/ |
|  |  | @Singleton |
|  |  | public class SafeClasses { |
|  |  | private final Set<String> prefixes; |
|  |  |  |
|  |  | public static SafeClasses allGraylogInternal() { |
|  |  | return new SafeClasses(Set.of("org.graylog.", "org.graylog2.")); |
|  |  | } |
|  |  |  |
|  |  | @Inject |
|  |  | public SafeClasses(@Named(Configuration.SAFE\_CLASSES) @Nonnull Set<String> prefixes) { |
|  |  | this.prefixes = Objects.requireNonNull(prefixes); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Check if the class name is considered safe for loading by names from a potentially user-provided input. |
|  |  | \* Classes are considered safe if their fully qualified class name starts with any of the prefixes configured in |
|  |  | \* {@link Configuration#getSafeClasses()}. |
|  |  | \*/ |
|  |  | public boolean isSafeToLoad(String className) { |
|  |  | return prefixes.stream().anyMatch(className::startsWith); |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7f8ef7f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2F7f8ef7fa8edf493106d5ef6f777d4da02c5194d9) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b482a3ef_20250115_090051.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fsecurity%2Fadvisories%2FGHSA-p6gg-5hf4-4rgj)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fsecurity%2Fadvisories%2FGHSA-p6gg-5hf4-4rgj)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=Graylog2%2Fgraylog2-server)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Graylog2](/Graylog2)
/
**[graylog2-server](/Graylog2/graylog2-server)**
Public

* [Notifications](/login?return_to=%2FGraylog2%2Fgraylog2-server) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2FGraylog2%2Fgraylog2-server)
* [Star
   7.5k](/login?return_to=%2FGraylog2%2Fgraylog2-server)

* [Code](/Graylog2/graylog2-server)
* [Issues
  1.7k](/Graylog2/graylog2-server/issues)
* [Pull requests
  148](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects
  0](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

Additional navigation options

* [Code](/Graylog2/graylog2-server)
* [Issues](/Graylog2/graylog2-server/issues)
* [Pull requests](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

# Instantiation of arbitrary classes triggered by API request

High

[bernd](/bernd)
published
GHSA-p6gg-5hf4-4rgj
Feb 7, 2024

## Package

maven

graylog2-server
([Maven](/advisories?query=ecosystem%3Amaven))

## Affected versions

>= 2.0.0, <=5.2.3

## Patched versions

5.2.4, 5.1.11

## Description

### Summary

Arbitrary classes can be loaded and instantiated using a HTTP PUT request to the `/api/system/cluster_config/` endpoint.

### Details

Graylog's cluster config system uses fully qualified class names as config keys. To validate the existence of the requested class before using them, Graylog loads the class using the class loader.

[graylog2-server/graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java](https://github.com/Graylog2/graylog2-server/blob/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java#L208-L214)

Lines 208 to 214
in
[e458db8](/Graylog2/graylog2-server/commit/e458db8bf4f789d4d19f1b37f0263f910c8d036c)

|  | private Class<?> classFromName(String className) { |
| --- | --- |
|  | try { |
|  | return chainingClassLoader.loadClass(className); |
|  | } catch (ClassNotFoundException e) { |
|  | return null; |
|  | } |
|  | } |

### PoC

A request of the following form will output the content of the `/etc/passwd` file:

```
curl -u admin:<admin-password> -X PUT http://localhost:9000/api/system/cluster_config/java.io.File \
    -H "Content-Type: application/json" \
    -H "X-Requested-By: poc" \
    -d '"/etc/passwd"'

```

To perform the request, authorization is required. Only users posessing the `clusterconfigentry:create` and `clusterconfigentry:edit` permissions are allowed to do so. These permissions are usually only granted to `Admin` users.

### Impact

If a user with the appropriate permissions performs the request, arbitrary classes with 1-arg String constructors can be instantiated.

This will execute arbitrary code that is run during class instantiation.

In the specific use case of `java.io.File`, the behaviour of the internal web-server stack will lead to information exposure by including the entire file content in the response to the REST request.

### Credits

Analysis provided by Fabian Yamaguchi - Whirly Labs (Pty) Ltd

### Severity

High

### CVE ID

CVE-2024-24824

### Weaknesses

[CWE-284](/advisories?query=cwe%3A284)

### Credits

* [![@fabsx00](https://avatars.githubusercontent.com/u/1379115?s=40&v=4)](/fabsx00)
  [fabsx00](/fabsx00)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_45c6b663_20250115_090046.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2F75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2F75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Graylog2%2Fgraylog2-server)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Graylog2](/Graylog2)
/
**[graylog2-server](/Graylog2/graylog2-server)**
Public

* [Notifications](/login?return_to=%2FGraylog2%2Fgraylog2-server) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2FGraylog2%2Fgraylog2-server)
* [Star
   7.5k](/login?return_to=%2FGraylog2%2Fgraylog2-server)

* [Code](/Graylog2/graylog2-server)
* [Issues
  1.7k](/Graylog2/graylog2-server/issues)
* [Pull requests
  148](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects
  0](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

Additional navigation options

* [Code](/Graylog2/graylog2-server)
* [Issues](/Graylog2/graylog2-server/issues)
* [Pull requests](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

## Commit

[Permalink](/Graylog2/graylog2-server/commit/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Restrict classes allowed for cluster config and event types ([#18165](https://github.com/Graylog2/graylog2-server/pull/18165)) ([#…](https://github.com/Graylog2/graylog2-server/pull/18179)

[Browse files](/Graylog2/graylog2-server/tree/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8)
Browse the repository at this point in the history

```
[…18179](https://github.com/Graylog2/graylog2-server/pull/18179))

* Restrict classes allowed for cluster config and event types ([#18165](https://github.com/Graylog2/graylog2-server/pull/18165))

Add a new safe_classes configuration option to restrict the classes allowed to be used
as cluster config and event types.
The configuration option allows to specify a comma-separated set of prefixes matched
against the fully qualified class name.

For now, the default value for the configuration is org.graylog.,org.graylog2., which will
allow all classes that Graylog maintains.

This should work out of the box for almost all setups. Changing the default value might
only be necessary if external plugins require cluster config or event types outside the
"org.graylog." or "org.graylog2." namespaces. If that is the case, the configuration setting
can be adjusted to cover this use case, e.b. by setting it to

    safe_classes = org.graylog.,org.graylog2.,custom.plugin.namespace.

if said classes are located within the custom.plugin.namespace package.

Refs: [GHSA-p6gg-5hf4-4rgj](https://github.com/Graylog2/graylog2-server/security/advisories/GHSA-p6gg-5hf4-4rgj "GHSA-p6gg-5hf4-4rgj")

(cherry picked from commit [8132032](https://github.com/Graylog2/graylog2-server/commit/813203263b06dda18e2aed68ae92b34277f904b4))

* Use javax.inject.Inject instead of jakarta.inject.Inject

* Use javax.ws.rs instead of jakarta.ws.rs

---------

Co-authored-by: Othello Maurer <othello@graylog.com>
```

* Loading branch information

[![@bernd](https://avatars.githubusercontent.com/u/461?s=40&v=4)](/bernd) [![@thll](https://avatars.githubusercontent.com/u/886541?s=40&v=4)](/thll)

[bernd](/Graylog2/graylog2-server/commits?author=bernd "View all commits by bernd")
and
[thll](/Graylog2/graylog2-server/commits?author=thll "View all commits by thll")
authored
Feb 6, 2024

1 parent
[d4a94b4](/Graylog2/graylog2-server/commit/d4a94b4c4f1a6d9ac8f3f7a1a8bed18d0b5aeda0)

commit 75ef2b8

 Show file tree

 Hide file tree

Showing
**16 changed files**
with
**429 additions**
and
**30 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* changelog/unreleased

  + changelog/unreleased/pr-18165.toml
    [pr-18165.toml](#diff-2efa20491342fcafad6f2cba7979bd0c491260d3a59a9658ea2808b26ef0da9d)
* data-node/src/main/java/org/graylog/datanode

  + data-node/src/main/java/org/graylog/datanode/Configuration.java
    [Configuration.java](#diff-b314d0858e1ff8ab37f372aece3a65f4e0f2daf7019056edd4cbec2127582cba)
* graylog2-server/src

  + main/java/org/graylog2

    - graylog2-server/src/main/java/org/graylog2/Configuration.java
      [Configuration.java](#diff-f9147c088b0c6c14d129a631c0bd352de6469624948c0ebf2af2c8119071c8cd)
    - cluster

      * graylog2-server/src/main/java/org/graylog2/cluster/ClusterConfigServiceImpl.java
        [ClusterConfigServiceImpl.java](#diff-850e5c024f4b7d5cdd62a4826ad7ebb00d9c88278204e5d53016fa8a84ba5d59)
    - events

      * graylog2-server/src/main/java/org/graylog2/events/ClusterEventPeriodical.java
        [ClusterEventPeriodical.java](#diff-b21f472266cbfcee53ea6dbde4b213af539d20ec8943796ba81ddc8a21e85b9e)
    - rest/resources/system

      * graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java
        [ClusterConfigResource.java](#diff-bbd8268eeda577686f553026b601d493dad19bbf95172f56b763600adb5377c2)
    - security

      * graylog2-server/src/main/java/org/graylog2/security/RestrictedChainingClassLoader.java
        [RestrictedChainingClassLoader.java](#diff-1902d0a09558487039fedbcdcfa1c39fd0481117899eb125fb076b25fc908a2f)
      * graylog2-server/src/main/java/org/graylog2/security/SafeClasses.java
        [SafeClasses.java](#diff-ea556ca9d6d41c0efd3700d7d5236439ff0cb2cbb7dd4062e28c3733fd78f2b1)
      * graylog2-server/src/main/java/org/graylog2/security/UnsafeClassLoadingAttemptException.java
        [UnsafeClassLoadingAttemptException.java](#diff-458958348300f6293950e10edd90b6f69adb98992d47c7a12476068b916bca5a)
  + test/java/org

    - graylog/plugins/views/search/views

      * graylog2-server/src/test/java/org/graylog/plugins/views/search/views/ViewServiceTest.java
        [ViewServiceTest.java](#diff-7ed796e227f4c76a03c6e1b24eed5bdc11c34a0cfd1d9e7c7e792d764635a21f)
    - graylog2

      * cluster

        + graylog2-server/src/test/java/org/graylog2/cluster/ClusterConfigServiceImplTest.java
          [ClusterConfigServiceImplTest.java](#diff-4999ddba870f695ec4523e86369df4ad2db45a5e8cd8c9b3fef9c98307e1fba5)
      * events

        + graylog2-server/src/test/java/org/graylog2/events/ClusterEventPeriodicalTest.java
          [ClusterEventPeriodicalTest.java](#diff-9d2173c1e3cfcf5fc7c2b1819e8d57421c158703e51481733fe7b9e13ad774b3)
      * indexer/indexset

        + graylog2-server/src/test/java/org/graylog2/indexer/indexset/MongoIndexSetServiceTest.java
          [MongoIndexSetServiceTest.java](#diff-f1d99a1586523e7d225888bd42cd74796a4b782f02ec266a5dd1c4a5315a6c3f)
      * migrations

        + graylog2-server/src/test/java/org/graylog2/migrations/V20161215163900\_MoveIndexSetDefaultConfigTest.java
          [V20161215163900\_MoveIndexSetDefaultConfigTest.java](#diff-e9eb1a684684bc855dbd424f3ecb6a6f57cfa330f09e5c7b3e21870b86d6ffa2)
        + graylog2-server/src/test/java/org/graylog2/migrations/V20170110150100\_FixAlertConditionsMigrationTest.java
          [V20170110150100\_FixAlertConditionsMigrationTest.java](#diff-88eb06111dcb4a573f1e65bd525785521e51e028ac318eeef560d9c38337a453)
      * rest/resources/system

        + graylog2-server/src/test/java/org/graylog2/rest/resources/system/ClusterConfigResourceTest.java
          [ClusterConfigResourceTest.java](#diff-d36e8e25e9b576bb73b3a643408675c27954472d3b7f7ab3e0664659852bca0d)

## There are no files selected for viewing

4 changes: 4 additions & 0 deletions

4
[changelog/unreleased/pr-18165.toml](#diff-2efa20491342fcafad6f2cba7979bd0c491260d3a59a9658ea2808b26ef0da9d "changelog/unreleased/pr-18165.toml")

Show comments

[View file](/Graylog2/graylog2-server/blob/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8/changelog/unreleased/pr-18165.toml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,4 @@ |
|  |  | type = "security" |
|  |  | message = "Restrict classes allowed for cluster config and event types. [GHSA-p6gg-5hf4-4rgj](https://github.com/Graylog2/graylog2-server/security/advisories/GHSA-p6gg-5hf4-4rgj)" |
|  |  |  |
|  |  | pulls = ["18165"] |

9 changes: 9 additions & 0 deletions

9
[data-node/src/main/java/org/graylog/datanode/Configuration.java](#diff-b314d0858e1ff8ab37f372aece3a65f4e0f2daf7019056edd4cbec2127582cba "data-node/src/main/java/org/graylog/datanode/Configuration.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8/data-node/src/main/java/org/graylog/datanode/Configuration.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,13 +23,15 @@ |
|  |  | import com.github.joschi.jadconfig.ValidatorMethod; |
|  |  | import com.github.joschi.jadconfig.converters.IntegerConverter; |
|  |  | import com.github.joschi.jadconfig.converters.StringListConverter; |
|  |  | import com.github.joschi.jadconfig.converters.StringSetConverter; |
|  |  | import com.github.joschi.jadconfig.validators.PositiveIntegerValidator; |
|  |  | import com.github.joschi.jadconfig.validators.StringNotBlankValidator; |
|  |  | import com.github.joschi.jadconfig.validators.URIAbsoluteValidator; |
|  |  | import com.google.common.annotations.VisibleForTesting; |
|  |  | import com.google.common.net.HostAndPort; |
|  |  | import com.google.common.net.InetAddresses; |
|  |  | import org.graylog.datanode.configuration.BaseConfiguration; |
|  |  | import org.graylog2.Configuration.SafeClassesValidator; |
|  |  | import org.graylog2.plugin.Tools; |
|  |  | import org.joda.time.DateTimeZone; |
|  |  | import org.slf4j.Logger; |
| Expand All | | @@ -48,6 +50,7 @@ |
|  |  | import java.util.Collections; |
|  |  | import java.util.List; |
|  |  | import java.util.Optional; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Helper class to hold configuration of Graylog |
| Expand Down  Expand Up | | @@ -124,6 +127,12 @@ public class Configuration extends BaseConfiguration { |
|  |  | @Parameter(value = "user\_password\_bcrypt\_salt\_size", validators = PositiveIntegerValidator.class) |
|  |  | private int userPasswordBCryptSaltSize = 10; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Classes considered safe to load by name. A set of prefixes matched against the fully qualified class name. |
|  |  | \*/ |
|  |  | @Parameter(value = org.graylog2.Configuration.SAFE\_CLASSES, converter = StringSetConverter.class, validators = SafeClassesValidator.class) |
|  |  | private Set<String> safeClasses = Set.of("org.graylog.", "org.graylog2."); |
|  |  |  |
|  |  | public Integer getStaleLeaderTimeout() { |
|  |  | return staleLeaderTimeout; |
|  |  | } |
| Expand Down | |  |

27 changes: 27 additions & 0 deletions

27
[graylog2-server/src/main/java/org/graylog2/Configuration.java](#diff-f9147c088b0c6c14d129a631c0bd352de6469624948c0ebf2af2c8119071c8cd "graylog2-server/src/main/java/org/graylog2/Configuration.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8/graylog2-server/src/main/java/org/graylog2/Configuration.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -27,6 +27,7 @@ |
|  |  | import com.github.joschi.jadconfig.validators.PositiveIntegerValidator; |
|  |  | import com.github.joschi.jadconfig.validators.PositiveLongValidator; |
|  |  | import com.github.joschi.jadconfig.validators.StringNotBlankValidator; |
|  |  | import org.apache.commons.lang3.StringUtils; |
|  |  | import org.graylog2.cluster.leader.AutomaticLeaderElectionService; |
|  |  | import org.graylog2.cluster.leader.LeaderElectionMode; |
|  |  | import org.graylog2.cluster.leader.LeaderElectionService; |
| Expand All | | @@ -44,11 +45,14 @@ |
|  |  | import java.util.Collections; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | import static org.graylog2.shared.utilities.StringUtils.f; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Helper class to hold configuration of Graylog |
|  |  | \*/ |
|  |  | @SuppressWarnings("FieldMayBeFinal") |
|  |  | public class Configuration extends BaseConfiguration { |
|  |  | public static final String SAFE\_CLASSES = "safe\_classes"; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Deprecated! Use isLeader() instead. |
| Expand Down  Expand Up | | @@ -210,6 +214,12 @@ public class Configuration extends BaseConfiguration { |
|  |  | @Parameter(value = "lock\_service\_lock\_ttl", converter = JavaDurationConverter.class) |
|  |  | private java.time.Duration lockServiceLockTTL = MongoLockService.MIN\_LOCK\_TTL; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Classes considered safe to load by name. A set of prefixes matched against the fully qualified class name. |
|  |  | \*/ |
|  |  | @Parameter(value = SAFE\_CLASSES, converter = StringSetConverter.class, validators = SafeClassesValidator.class) |
|  |  | private Set<String> safeClasses = Set.of("org.graylog.", "org.graylog2."); |
|  |  |  |
|  |  | public boolean maintainsStreamAwareFieldTypes() { |
|  |  | return streamAwareFieldTypes; |
|  |  | } |
| Expand Down  Expand Up | | @@ -425,6 +435,10 @@ public Duration getFailureHandlingShutdownAwait() { |
|  |  | return failureHandlingShutdownAwait; |
|  |  | } |
|  |  |  |
|  |  | public Set<String> getSafeClasses() { |
|  |  | return safeClasses; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* This is needed for backwards compatibility. The setting in TLSProtocolsConfiguration should be used instead. |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -528,4 +542,17 @@ public void validate(String name, String path) throws ValidationException { |
|  |  | throw new ValidationException("Node ID file at path " + path + " isn't " + b + ". Please specify the correct path or change the permissions"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | public static class SafeClassesValidator implements Validator<Set<String>> { |
|  |  | @Override |
|  |  | public void validate(String name, Set<String> set) throws ValidationException { |
|  |  | if (set.isEmpty()) { |
|  |  | throw new ValidationException(f("\"%s\" must not be empty. Please specify a comma-separated list of " + |
|  |  | "fully-qualified class name prefixes.", name)); |
|  |  | } |
|  |  | if (set.stream().anyMatch(StringUtils::isBlank)) { |
|  |  | throw new ValidationException(f("\"%s\" must only contain non-empty class name prefixes.", name)); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | } |

23 changes: 19 additions & 4 deletions

23
[graylog2-server/src/main/java/org/graylog2/cluster/ClusterConfigServiceImpl.java](#diff-850e5c024f4b7d5cdd62a4826ad7ebb00d9c88278204e5d53016fa8a84ba5d59 "graylog2-server/src/main/java/org/graylog2/cluster/ClusterConfigServiceImpl.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8/graylog2-server/src/main/java/org/graylog2/cluster/ClusterConfigServiceImpl.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -27,6 +27,9 @@ |
|  |  | import org.graylog2.events.ClusterEventBus; |
|  |  | import org.graylog2.plugin.cluster.ClusterConfigService; |
|  |  | import org.graylog2.plugin.system.NodeId; |
|  |  | import org.graylog2.security.RestrictedChainingClassLoader; |
|  |  | import org.graylog2.security.SafeClasses; |
|  |  | import org.graylog2.security.UnsafeClassLoadingAttemptException; |
|  |  | import org.graylog2.shared.plugins.ChainingClassLoader; |
|  |  | import org.graylog2.shared.utilities.AutoValueUtils; |
|  |  | import org.joda.time.DateTime; |
| Expand All | | @@ -52,23 +55,33 @@ public class ClusterConfigServiceImpl implements ClusterConfigService { |
|  |  | private final JacksonDBCollection<ClusterConfig, String> dbCollection; |
|  |  | private final NodeId nodeId; |
|  |  | private final ObjectMapper objectMapper; |
|  |  | private final ChainingClassLoader chainingClassLoader; |
|  |  | private final RestrictedChainingClassLoader chainingClassLoader; |
|  |  | private final EventBus clusterEventBus; |
|  |  |  |
|  |  | @Inject |
|  |  | public ClusterConfigServiceImpl(final MongoJackObjectMapperProvider mapperProvider, |
|  |  | final MongoConnection mongoConnection, |
|  |  | final NodeId nodeId, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final RestrictedChainingClassLoader chainingClassLoader, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this(JacksonDBCollection.wrap(prepareCollection(mongoConnection), ClusterConfig.class, String.class, mapperProvider.get()), |
|  |  | nodeId, mapperProvider.get(), chainingClassLoader, clusterEventBus); |
|  |  | } |
|  |  |  |
|  |  | @Deprecated |
|  |  | public ClusterConfigServiceImpl(final MongoJackObjectMapperProvider mapperProvider, |
|  |  | final MongoConnection mongoConnection, |
|  |  | final NodeId nodeId, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this(JacksonDBCollection.wrap(prepareCollection(mongoConnection), ClusterConfig.class, String.class, mapperProvider.get()), |
|  |  | nodeId, mapperProvider.get(), new RestrictedChainingClassLoader(chainingClassLoader, SafeClasses.allGraylogInternal()), clusterEventBus); |
|  |  | } |
|  |  |  |
|  |  | private ClusterConfigServiceImpl(final JacksonDBCollection<ClusterConfig, String> dbCollection, |
|  |  | final NodeId nodeId, |
|  |  | final ObjectMapper objectMapper, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final RestrictedChainingClassLoader chainingClassLoader, |
|  |  | final EventBus clusterEventBus) { |
|  |  | this.nodeId = checkNotNull(nodeId); |
|  |  | this.dbCollection = checkNotNull(dbCollection); |
| Expand Down  Expand Up | | @@ -174,10 +187,12 @@ public Set<Class<?>> list() { |
|  |  | for (ClusterConfig clusterConfig : clusterConfigs) { |
|  |  | final String type = clusterConfig.type(); |
|  |  | try { |
|  |  | final Class<?> cls = chainingClassLoader.loadClass(type); |
|  |  | final Class<?> cls = chainingClassLoader.loadClassSafely(type); |
|  |  | classes.add(cls); |
|  |  | } catch (ClassNotFoundException e) { |
|  |  | LOG.debug("Couldn't find configuration class \"{}\"", type, e); |
|  |  | } catch (UnsafeClassLoadingAttemptException e) { |
|  |  | LOG.warn("Couldn't load class <{}>.", type, e); |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand Down | |  |

38 changes: 27 additions & 11 deletions

38
[graylog2-server/src/main/java/org/graylog2/events/ClusterEventPeriodical.java](#diff-b21f472266cbfcee53ea6dbde4b213af539d20ec8943796ba81ddc8a21e85b9e "graylog2-server/src/main/java/org/graylog2/events/ClusterEventPeriodical.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8/graylog2-server/src/main/java/org/graylog2/events/ClusterEventPeriodical.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,6 +32,9 @@ |
|  |  | import org.graylog2.database.MongoConnection; |
|  |  | import org.graylog2.plugin.periodical.Periodical; |
|  |  | import org.graylog2.plugin.system.NodeId; |
|  |  | import org.graylog2.security.RestrictedChainingClassLoader; |
|  |  | import org.graylog2.security.SafeClasses; |
|  |  | import org.graylog2.security.UnsafeClassLoadingAttemptException; |
|  |  | import org.graylog2.shared.plugins.ChainingClassLoader; |
|  |  | import org.graylog2.shared.utilities.AutoValueUtils; |
|  |  | import org.mongojack.DBCursor; |
| Expand All | | @@ -56,25 +59,38 @@ public class ClusterEventPeriodical extends Periodical { |
|  |  | private final NodeId nodeId; |
|  |  | private final ObjectMapper objectMapper; |
|  |  | private final EventBus serverEventBus; |
|  |  | private final ChainingClassLoader chainingClassLoader; |
|  |  | private final RestrictedChainingClassLoader chainingClassLoader; |
|  |  |  |
|  |  | @Inject |
|  |  | public ClusterEventPeriodical(final MongoJackObjectMapperProvider mapperProvider, |
|  |  | final MongoConnection mongoConnection, |
|  |  | final NodeId nodeId, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final RestrictedChainingClassLoader chainingClassLoader, |
|  |  | final EventBus serverEventBus, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this(JacksonDBCollection.wrap(prepareCollection(mongoConnection), ClusterEvent.class, String.class, mapperProvider.get()), |
|  |  | nodeId, mapperProvider.get(), chainingClassLoader, serverEventBus, clusterEventBus); |
|  |  | } |
|  |  |  |
|  |  | @Deprecated |
|  |  | public ClusterEventPeriodical(final MongoJackObjectMapperProvider mapperProvider, |
|  |  | final MongoConnection mongoConnection, |
|  |  | final NodeId nodeId, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final EventBus serverEventBus, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this(JacksonDBCollection.wrap(prepareCollection(mongoConnection), ClusterEvent.class, String.class, |
|  |  | mapperProvider.get()), nodeId, mapperProvider.get(), |
|  |  | new RestrictedChainingClassLoader(chainingClassLoader, SafeClasses.allGraylogInternal()), |
|  |  | serverEventBus, clusterEventBus); |
|  |  | } |
|  |  |  |
|  |  | private ClusterEventPeriodical(final JacksonDBCollection<ClusterEvent, String> dbCollection, |
|  |  | final NodeId nodeId, |
|  |  | final ObjectMapper objectMapper, |
|  |  | final ChainingClassLoader chainingClassLoader, |
|  |  | final EventBus serverEventBus, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | final NodeId nodeId, |
|  |  | final ObjectMapper objectMapper, |
|  |  | final RestrictedChainingClassLoader chainingClassLoader, |
|  |  | final EventBus serverEventBus, |
|  |  | final ClusterEventBus clusterEventBus) { |
|  |  | this.nodeId = checkNotNull(nodeId); |
|  |  | this.dbCollection = checkNotNull(dbCollection); |
|  |  | this.objectMapper = checkNotNull(objectMapper); |
| Expand Down  Expand Up | | @@ -204,15 +220,15 @@ private void updateConsumers(final String eventId, final NodeId nodeId) { |
|  |  |  |
|  |  | private Object extractPayload(Object payload, String eventClass) { |
|  |  | try { |
|  |  | final Class<?> clazz = chainingClassLoader.loadClass(eventClass); |
|  |  | final Class<?> clazz = chainingClassLoader.loadClassSafely(eventClass); |
|  |  | return objectMapper.convertValue(payload, clazz); |
|  |  | } catch (ClassNotFoundException e) { |
|  |  | LOG.debug("Couldn't load class <" + eventClass + "> for event", e); |
|  |  | return null; |
|  |  | } catch (IllegalArgumentException e) { |
|  |  | LOG.debug("Error while deserializing payload", e); |
|  |  | return null; |
|  |  |  |
|  |  | } catch (UnsafeClassLoadingAttemptException e) { |
|  |  | LOG.warn("Couldn't load class <{}>.", eventClass, e); |
|  |  | } |
|  |  | return null; |
|  |  | } |
|  |  | } |

11 changes: 7 additions & 4 deletions

11
[graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java](#diff-bbd8268eeda577686f553026b601d493dad19bbf95172f56b763600adb5377c2 "graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8/graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -33,7 +33,8 @@ |
|  |  | import org.graylog2.plugin.validate.ConfigValidationException; |
|  |  | import org.graylog2.rest.MoreMediaTypes; |
|  |  | import org.graylog2.rest.models.system.config.ClusterConfigList; |
|  |  | import org.graylog2.shared.plugins.ChainingClassLoader; |
|  |  | import org.graylog2.security.RestrictedChainingClassLoader; |
|  |  | import org.graylog2.security.UnsafeClassLoadingAttemptException; |
|  |  | import org.graylog2.shared.rest.resources.RestResource; |
|  |  | import org.graylog2.shared.security.RestPermissions; |
|  |  | import org.slf4j.Logger; |
| Expand Down  Expand Up | | @@ -71,13 +72,13 @@ public class ClusterConfigResource extends RestResource { |
|  |  | public static final String NO\_CLASS\_MSG = "Couldn't find configuration class '%s'"; |
|  |  |  |
|  |  | private final ClusterConfigService clusterConfigService; |
|  |  | private final ChainingClassLoader chainingClassLoader; |
|  |  | private final RestrictedChainingClassLoader chainingClassLoader; |
|  |  | private final ObjectMapper objectMapper; |
|  |  | private final ClusterConfigValidatorService clusterConfigValidatorService; |
|  |  |  |
|  |  | @Inject |
|  |  | public ClusterConfigResource(ClusterConfigService clusterConfigService, |
|  |  | ChainingClassLoader chainingClassLoader, |
|  |  | RestrictedChainingClassLoader chainingClassLoader, |
|  |  | ObjectMapper objectMapper, |
|  |  | ClusterConfigValidatorService clusterConfigValidatorService) { |
|  |  | this.clusterConfigService = requireNonNull(clusterConfigService); |
| Expand Down  Expand Up | | @@ -207,9 +208,11 @@ public JsonSchema schema(@ApiParam(name = "configClass", value = "The name of th |
|  |  | @Nullable |
|  |  | private Class<?> classFromName(String className) { |
|  |  | try { |
|  |  | return chainingClassLoader.loadClass(className); |
|  |  | return chainingClassLoader.loadClassSafely(className); |
|  |  | } catch (ClassNotFoundException e) { |
|  |  | return null; |
|  |  | } catch (UnsafeClassLoadingAttemptException e) { |
|  |  | throw new BadRequestException(e.getLocalizedMessage()); |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

61 changes: 61 additions & 0 deletions

61
[graylog2-server/src/main/java/org/graylog2/security/RestrictedChainingClassLoader.java](#diff-1902d0a09558487039fedbcdcfa1c39fd0481117899eb125fb076b25fc908a2f "graylog2-server/src/main/java/org/graylog2/security/RestrictedChainingClassLoader.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8/graylog2-server/src/main/java/org/graylog2/security/RestrictedChainingClassLoader.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,61 @@ |
|  |  | /\* |
|  |  | \* Copyright (C) 2020 Graylog, Inc. |
|  |  | \* |
|  |  | \* This program is free software: you can redistribute it and/or modify |
|  |  | \* it under the terms of the Server Side Public License, version 1, |
|  |  | \* as published by MongoDB, Inc. |
|  |  | \* |
|  |  | \* This program is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the |
|  |  | \* Server Side Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the Server Side Public License |
|  |  | \* along with this program. If not, see |
|  |  | \* <http://www.mongodb.com/licensing/server-side-public-license>. |
|  |  | \*/ |
|  |  | package org.graylog2.security; |
|  |  |  |
|  |  | import org.graylog2.Configuration; |
|  |  | import org.graylog2.shared.plugins.ChainingClassLoader; |
|  |  |  |
|  |  | import javax.inject.Inject; |
|  |  |  |
|  |  | import static org.graylog2.shared.utilities.StringUtils.f; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* A wrapper around the chaining class loader intended only for loading classes safely by considering an allow-list of |
|  |  | \* class name prefixes. |
|  |  | \*/ |
|  |  | public class RestrictedChainingClassLoader { |
|  |  | private final ChainingClassLoader delegate; |
|  |  | private final SafeClasses safeClasses; |
|  |  |  |
|  |  | @Inject |
|  |  | public RestrictedChainingClassLoader(ChainingClassLoader delegate, SafeClasses safeClasses) { |
|  |  | this.delegate = delegate; |
|  |  | this.safeClasses = safeClasses; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Load the class only if the name passes the check of {@link SafeClasses#isSafeToLoad(String)}. If the class name |
|  |  | \* passes the check, the call is delegated to {@link ChainingClassLoader#loadClass(String)}. If it doesn't pass the |
|  |  | \* check, an {@link UnsafeClassLoadingAttemptException} is thrown. |
|  |  | \* |
|  |  | \* @return class as returned by the delegated call to {@link ChainingClassLoader#loadClass(String)} |
|  |  | \* @throws ClassNotFoundException if the class was not found |
|  |  | \* @throws UnsafeClassLoadingAttemptException if the class name didn't pass the safety check of |
|  |  | \* {@link SafeClasses#isSafeToLoad(String)} |
|  |  | \*/ |
|  |  | public Class<?> loadClassSafely(String name) throws ClassNotFoundException, UnsafeClassLoadingAttemptException { |
|  |  | if (safeClasses.isSafeToLoad(name)) { |
|  |  | return delegate.loadClass(name); |
|  |  | } else { |
|  |  | throw new UnsafeClassLoadingAttemptException( |
|  |  | f("Prevented loading of unsafe class \"%s\". Consider adjusting the configuration setting " + |
|  |  | "\"%s\", if you think that this is a mistake.", name, Configuration.SAFE\_CLASSES) |
|  |  | ); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | } |

52 changes: 52 additions & 0 deletions

52
[graylog2-server/src/main/java/org/graylog2/security/SafeClasses.java](#diff-ea556ca9d6d41c0efd3700d7d5236439ff0cb2cbb7dd4062e28c3733fd78f2b1 "graylog2-server/src/main/java/org/graylog2/security/SafeClasses.java")

Show comments

[View file](/Graylog2/graylog2-server/blob/75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8/graylog2-server/src/main/java/org/graylog2/security/SafeClasses.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,52 @@ |
|  |  | /\* |
|  |  | \* Copyright (C) 2020 Graylog, Inc. |
|  |  | \* |
|  |  | \* This program is free software: you can redistribute it and/or modify |
|  |  | \* it under the terms of the Server Side Public License, version 1, |
|  |  | \* as published by MongoDB, Inc. |
|  |  | \* |
|  |  | \* This program is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the |
|  |  | \* Server Side Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the Server Side Public License |
|  |  | \* along with this program. If not, see |
|  |  | \* <http://www.mongodb.com/licensing/server-side-public-license>. |
|  |  | \*/ |
|  |  | package org.graylog2.security; |
|  |  |  |
|  |  | import org.graylog2.Configuration; |
|  |  |  |
|  |  | import javax.annotation.Nonnull; |
|  |  | import javax.inject.Inject; |
|  |  | import javax.inject.Named; |
|  |  | import javax.inject.Singleton; |
|  |  | import java.util.Objects; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Adds a safety net for class loading. |
|  |  | \*/ |
|  |  | @Singleton |
|  |  | public class SafeClasses { |
|  |  | private final Set<String> prefixes; |
|  |  |  |
|  |  | public static SafeClasses allGraylogInternal() { |
|  |  | return new SafeClasses(Set.of("org.graylog.", "org.graylog2.")); |
|  |  | } |
|  |  |  |
|  |  | @Inject |
|  |  | public SafeClasses(@Named(Configuration.SAFE\_CLASSES) @Nonnull Set<String> prefixes) { |
|  |  | this.prefixes = Objects.requireNonNull(prefixes); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Check if the class name is considered safe for loading by names from a potentially user-provided input. |
|  |  | \* Classes are considered safe if their fully qualified class name starts with any of the prefixes configured in |
|  |  | \* {@link Configuration#getSafeClasses()}. |
|  |  | \*/ |
|  |  | public boolean isSafeToLoad(String className) { |
|  |  | return prefixes.stream().anyMatch(className::startsWith); |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `75ef2b8`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fcommit%2F75ef2b8d60e7d67f859b79fe712c8ae7b2e861d8) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_0785e345_20250115_090044.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fblob%2Fe458db8bf4f789d4d19f1b37f0263f910c8d036c%2Fgraylog2-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fgraylog2%2Frest%2Fresources%2Fsystem%2FClusterConfigResource.java)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FGraylog2%2Fgraylog2-server%2Fblob%2Fe458db8bf4f789d4d19f1b37f0263f910c8d036c%2Fgraylog2-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fgraylog2%2Frest%2Fresources%2Fsystem%2FClusterConfigResource.java)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=Graylog2%2Fgraylog2-server)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Graylog2](/Graylog2)
/
**[graylog2-server](/Graylog2/graylog2-server)**
Public

* [Notifications](/login?return_to=%2FGraylog2%2Fgraylog2-server) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2FGraylog2%2Fgraylog2-server)
* [Star
   7.5k](/login?return_to=%2FGraylog2%2Fgraylog2-server)

* [Code](/Graylog2/graylog2-server)
* [Issues
  1.7k](/Graylog2/graylog2-server/issues)
* [Pull requests
  148](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects
  0](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

Additional navigation options

* [Code](/Graylog2/graylog2-server)
* [Issues](/Graylog2/graylog2-server/issues)
* [Pull requests](/Graylog2/graylog2-server/pulls)
* [Actions](/Graylog2/graylog2-server/actions)
* [Projects](/Graylog2/graylog2-server/projects)
* [Security](/Graylog2/graylog2-server/security)
* [Insights](/Graylog2/graylog2-server/pulse)

## Files

 e458db8
## Breadcrumbs

1. [graylog2-server](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c)
2. /[graylog2-server](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server)
3. /[src](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src)
4. /[main](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main)
5. /[java](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java)
6. /[org](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org)
7. /[graylog2](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2)
8. /[rest](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest)
9. /[resources](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest/resources)
10. /[system](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest/resources/system)
/
# ClusterConfigResource.java

Copy path Blame  Blame
## Latest commit

## History

[History](/Graylog2/graylog2-server/commits/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java)220 lines (196 loc) · 8.88 KB e458db8
## Breadcrumbs

1. [graylog2-server](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c)
2. /[graylog2-server](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server)
3. /[src](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src)
4. /[main](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main)
5. /[java](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java)
6. /[org](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org)
7. /[graylog2](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2)
8. /[rest](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest)
9. /[resources](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest/resources)
10. /[system](/Graylog2/graylog2-server/tree/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest/resources/system)
/
# ClusterConfigResource.java

Top
## File metadata and controls

* Code
* Blame

220 lines (196 loc) · 8.88 KB[Raw](https://github.com/Graylog2/graylog2-server/raw/e458db8bf4f789d4d19f1b37f0263f910c8d036c/graylog2-server/src/main/java/org/graylog2/rest/resources/system/ClusterConfigResource.java)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220/\* \* Copyright (C) 2020 Graylog, Inc. \* \* This program is free software: you can redistribute it and/or modify \* it under the terms of the Server Side Public License, version 1, \* as published by MongoDB, Inc. \* \* This program is distributed in the hope that it will be useful, \* but WITHOUT ANY WARRANTY; without even the implied warranty of \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \* Server Side Public License for more details. \* \* You should have received a copy of the Server Side Public License \* along with this program. If not, see \* <http://www.mongodb.com/licensing/server-side-public-license>. \*/package org.graylog2.rest.resources.system;
import com.codahale.metrics.annotation.Timed;import com.fasterxml.jackson.databind.JsonMappingException;import com.fasterxml.jackson.databind.ObjectMapper;import com.fasterxml.jackson.module.jsonSchema.JsonSchema;import com.fasterxml.jackson.module.jsonSchema.factories.SchemaFactoryWrapper;import io.swagger.annotations.Api;import io.swagger.annotations.ApiOperation;import io.swagger.annotations.ApiParam;import org.apache.shiro.authz.annotation.RequiresAuthentication;import org.apache.shiro.authz.annotation.RequiresPermissions;import org.graylog2.audit.AuditEventTypes;import org.graylog2.audit.jersey.AuditEvent;import org.graylog2.plugin.cluster.ClusterConfigService;import org.graylog2.plugin.validate.ClusterConfigValidatorService;import org.graylog2.plugin.validate.ConfigValidationException;import org.graylog2.rest.MoreMediaTypes;import org.graylog2.rest.models.system.config.ClusterConfigList;import org.graylog2.shared.plugins.ChainingClassLoader;import org.graylog2.shared.rest.resources.RestResource;import org.graylog2.shared.security.RestPermissions;import org.slf4j.Logger;import org.slf4j.LoggerFactory;
import javax.annotation.Nullable;import javax.inject.Inject;import javax.validation.constraints.NotBlank;import javax.validation.constraints.NotNull;import javax.ws.rs.BadRequestException;import javax.ws.rs.Consumes;import javax.ws.rs.DELETE;import javax.ws.rs.GET;import javax.ws.rs.InternalServerErrorException;import javax.ws.rs.NotFoundException;import javax.ws.rs.PUT;import javax.ws.rs.Path;import javax.ws.rs.PathParam;import javax.ws.rs.Produces;import javax.ws.rs.core.MediaType;import javax.ws.rs.core.Response;import java.io.IOException;import java.io.InputStream;import java.util.Locale;import java.util.Set;
import static java.util.Objects.requireNonNull;
@Api(value = "System/ClusterConfig", description = "Graylog Cluster Configuration")@RequiresAuthentication@Path("/system/cluster\_config")@Produces(MediaType.APPLICATION\_JSON)public class ClusterConfigResource extends RestResource { private static final Logger LOG = LoggerFactory.getLogger(ClusterConfigResource.class); public static final String NO\_CLASS\_MSG = "Couldn't find configuration class '%s'";
 private final ClusterConfigService clusterConfigService; private final ChainingClassLoader chainingClassLoader; private final ObjectMapper objectMapper; private final ClusterConfigValidatorService clusterConfigValidatorService;
 @Inject public ClusterConfigResource(ClusterConfigService clusterConfigService, ChainingClassLoader chainingClassLoader, ObjectMapper objectMapper, ClusterConfigValidatorService clusterConfigValidatorService) { this.clusterConfigService = requireNonNull(clusterConfigService); this.chainingClassLoader = chainingClassLoader; this.objectMapper = objectMapper; this.clusterConfigValidatorService = clusterConfigValidatorService; }
 @GET @ApiOperation(value = "List all configuration classes") @Timed @RequiresPermissions(RestPermissions.CLUSTER\_CONFIG\_ENTRY\_READ) public ClusterConfigList list() { final Set<Class<?>> classes = clusterConfigService.list();
 return ClusterConfigList.createFromClass(classes); }
 @GET @Path("{configClass}") @ApiOperation(value = "Get configuration settings from database") @Timed @RequiresPermissions(RestPermissions.CLUSTER\_CONFIG\_ENTRY\_READ) public Object read(@ApiParam(name = "configClass", value = "The name of the cluster configuration class", required = true) @PathParam("configClass") @NotBlank String configClass) { final Class<?> cls = classFromName(configClass); if (cls == null) { String error = createNoClassMsg(configClass); throw new NotFoundException(error); }
 return clusterConfigService.get(cls); }
 @PUT @Timed @Path("{configClass}") @Consumes(MediaType.APPLICATION\_JSON) @ApiOperation(value = "Update configuration in database") @RequiresPermissions({RestPermissions.CLUSTER\_CONFIG\_ENTRY\_CREATE, RestPermissions.CLUSTER\_CONFIG\_ENTRY\_EDIT}) @AuditEvent(type = AuditEventTypes.CLUSTER\_CONFIGURATION\_UPDATE) public Response update(@ApiParam(name = "configClass", value = "The name of the cluster configuration class", required = true) @PathParam("configClass") @NotBlank String configClass, @ApiParam(name = "body", value = "The payload of the cluster configuration", required = true) @NotNull InputStream body) throws IOException { final Class<?> cls = classFromName(configClass); if (cls == null) { throw new NotFoundException(createNoClassMsg(configClass)); }
 final Object configObject = parseConfigObject(configClass, body, cls); validateConfigObject(configObject); writeConfigObject(configClass, configObject);
 return Response.accepted(configObject).build(); }
 private void writeConfigObject(String configClass, Object configObject) { try { clusterConfigService.write(configObject); } catch (Exception e) { final String msg = "Couldn't write cluster config \"" + configClass + "\"."; LOG.error(msg, e); throw new InternalServerErrorException(msg, e); } }
 private void validateConfigObject(Object configObject) { try { clusterConfigValidatorService.validate(configObject); } catch (ConfigValidationException e) { throw new BadRequestException(e.getMessage(), e); } }
 private Object parseConfigObject(String configClass, InputStream body, Class<?> cls) { final Object object; try { object = objectMapper.readValue(body, cls); } catch (Exception e) { final String msg = "Couldn't parse cluster configuration \"" + configClass + "\". The problem was : " + e.getMessage(); LOG.error(msg, e); throw new BadRequestException(msg); } return object; }
 @DELETE @Path("{configClass}") @ApiOperation(value = "Delete configuration settings from database") @Timed @RequiresPermissions(RestPermissions.CLUSTER\_CONFIG\_ENTRY\_DELETE) @AuditEvent(type = AuditEventTypes.CLUSTER\_CONFIGURATION\_DELETE) public void delete(@ApiParam(name = "configClass", value = "The name of the cluster configuration class", required = true) @PathParam("configClass") @NotBlank String configClass) { final Class<?> cls = classFromName(configClass); if (cls == null) { throw new NotFoundException(createNoClassMsg(configClass)); }
 clusterConfigService.remove(cls); }
 @GET @Path("{configClass}") @Produces(MoreMediaTypes.APPLICATION\_SCHEMA\_JSON) @ApiOperation(value = "Get JSON schema of configuration class") @Timed @RequiresPermissions(RestPermissions.CLUSTER\_CONFIG\_ENTRY\_READ) public JsonSchema schema(@ApiParam(name = "configClass", value = "The name of the cluster configuration class", required = true) @PathParam("configClass") @NotBlank String configClass) { final Class<?> cls = classFromName(configClass); if (cls == null) { throw new NotFoundException(createNoClassMsg(configClass)); }
 final SchemaFactoryWrapper visitor = new SchemaFactoryWrapper(); try { objectMapper.acceptJsonFormatVisitor(objectMapper.constructType(cls), visitor); } catch (JsonMappingException e) { throw new InternalServerErrorException("Couldn't generate JSON schema for configuration class " + configClass, e); }
 return visitor.finalSchema(); }
 @Nullable private Class<?> classFromName(String className) { try { return chainingClassLoader.loadClass(className); } catch (ClassNotFoundException e) { return null; } }
 private static String createNoClassMsg(String configClass) { return String.format(Locale.ENGLISH, NO\_CLASS\_MSG, configClass); }
}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


