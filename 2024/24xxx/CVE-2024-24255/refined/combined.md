=== Content from github.com_71b4561b_20250114_233947.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FDrone-Lab%2FPX4-Autopilot%2Fblob%2Freport-the-faliure-of-precheck%2Freport-the-faliure-of-precheck.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FDrone-Lab%2FPX4-Autopilot%2Fblob%2Freport-the-faliure-of-precheck%2Freport-the-faliure-of-precheck.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=Drone-Lab%2FPX4-Autopilot)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Drone-Lab](/Drone-Lab)
/
**[PX4-Autopilot](/Drone-Lab/PX4-Autopilot)**
Public

forked from [PX4/PX4-Autopilot](/PX4/PX4-Autopilot)

* [Notifications](/login?return_to=%2FDrone-Lab%2FPX4-Autopilot) You must be signed in to change notification settings
* [Fork
  0](/login?return_to=%2FDrone-Lab%2FPX4-Autopilot)
* [Star
   0](/login?return_to=%2FDrone-Lab%2FPX4-Autopilot)

* [Code](/Drone-Lab/PX4-Autopilot/tree/report-the-faliure-of-precheck)
* [Pull requests
  0](/Drone-Lab/PX4-Autopilot/pulls)
* [Actions](/Drone-Lab/PX4-Autopilot/actions)
* [Projects
  0](/Drone-Lab/PX4-Autopilot/projects)
* [Security](/Drone-Lab/PX4-Autopilot/security)
* [Insights](/Drone-Lab/PX4-Autopilot/pulse)

Additional navigation options

* [Code](/Drone-Lab/PX4-Autopilot/tree/report-the-faliure-of-precheck)
* [Pull requests](/Drone-Lab/PX4-Autopilot/pulls)
* [Actions](/Drone-Lab/PX4-Autopilot/actions)
* [Projects](/Drone-Lab/PX4-Autopilot/projects)
* [Security](/Drone-Lab/PX4-Autopilot/security)
* [Insights](/Drone-Lab/PX4-Autopilot/pulse)

## Files

 report-the-faliure-of-precheck
## Breadcrumbs

1. [PX4-Autopilot](/Drone-Lab/PX4-Autopilot/tree/report-the-faliure-of-precheck)
/
# report-the-faliure-of-precheck.md

Copy path Blame  Blame
## Latest commit

## History

[History](/Drone-Lab/PX4-Autopilot/commits/report-the-faliure-of-precheck/report-the-faliure-of-precheck.md)86 lines (57 loc) · 6.28 KB report-the-faliure-of-precheck
## Breadcrumbs

1. [PX4-Autopilot](/Drone-Lab/PX4-Autopilot/tree/report-the-faliure-of-precheck)
/
# report-the-faliure-of-precheck.md

Top
## File metadata and controls

* Preview
* Code
* Blame

86 lines (57 loc) · 6.28 KB[Raw](https://github.com/Drone-Lab/PX4-Autopilot/raw/refs/heads/report-the-faliure-of-precheck/report-the-faliure-of-precheck.md)
### Background

CVE-2024-24255 version <=1.14

PX4 (6.9k stars) <https://github.com/PX4/PX4-Autopilot>

PX4 is a professional autopilot system developed by world-class developers from both the industry and academia. Supported by an active global community, it provides power for a variety of vehicles, including racing and cargo drones, ground vehicles, and submarines. Due to code reusability, this vulnerability should be applicable not only to multirotor drones but also to fixed-wing drones, submarines, ground vehicles, and more.

The open-source project's code is directly utilized by numerous OEM drone manufacturers worldwide, including Freefly Systems, Quantum Systems, Skydio, Auterion, and others.

### Summary

Due to the lack of synchronization mechanism for loading geofence data,we identified a Race Condition vulnerability in the geofence.cpp and mission\_feasibility\_checker.cpp.This will result in the drone uploading overlapping geofences and mission routes.But, as expected, MissionFeasibilityChecker should prevent the uploading.

### Impact

* Due to multiple threads accessing the geofence data, checher is dysfunctional.
* Due to this vulnerability, users may unintentionally or intentionally execute missions within the no-fly zone after performing the following sequence of actions: triggering the vulnerability to bypass mission feasibility check, uploading waypoints within the no-fly zone, setting the home point within the no-fly zone, turn to return mode to bring the drone into the no-fly zone, and then switching to mission mode, causing the drone to execute the mission within the no-fly zone starting from the nearest waypoint.

20240109151442.-.Compressed.with.FlexClip.1.mp4

### Details

1. When the ground control station upload mission or geofence to the drone.In geofence.cpp, there is a state machine designed to read geofence data from ourb and load it onto the drone, as illustrated in the following picture.

   [![](https://user-images.githubusercontent.com/151698793/294857321-53c6d894-448a-4130-85ae-30ab7e12e171.png)](https://user-images.githubusercontent.com/151698793/294857321-53c6d894-448a-4130-85ae-30ab7e12e171.png)

   This functionality is called within a while(1) loop in navigator\_main.cpp.

   [PX4-Autopilot/src/modules/navigator/navigator\_main.cpp](https://github.com/Drone-Lab/PX4-Autopilot/blob/cf840ff3731d8bebf65e79bd8c9c7bbd8d29d404/src/modules/navigator/navigator_main.cpp#L893)

   Line 893
   in
   [cf840ff](/Drone-Lab/PX4-Autopilot/commit/cf840ff3731d8bebf65e79bd8c9c7bbd8d29d404)

   |  | \_geofence.run(); |
   | --- | --- |

   The read and load operations within it utilize **asynchronous** reading, ensuring that they do not block the function loop.

   [PX4-Autopilot/src/modules/navigator/geofence.cpp](https://github.com/Drone-Lab/PX4-Autopilot/blob/cf840ff3731d8bebf65e79bd8c9c7bbd8d29d404/src/modules/navigator/geofence.cpp#L111-L112)

   Lines 111 to 112
   in
   [cf840ff](/Drone-Lab/PX4-Autopilot/commit/cf840ff3731d8bebf65e79bd8c9c7bbd8d29d404)

   |  | success = \_dataman\_client.readAsync(DM\_KEY\_FENCE\_POINTS, 0, reinterpret\_cast<uint8\_t \*>(&\_stats), |
   | --- | --- |
   |  | sizeof(mission\_stats\_entry\_s)); |

   [PX4-Autopilot/src/modules/navigator/geofence.cpp](https://github.com/Drone-Lab/PX4-Autopilot/blob/cf840ff3731d8bebf65e79bd8c9c7bbd8d29d404/src/modules/navigator/geofence.cpp#L155-L163)

   Lines 155 to 163
   in
   [cf840ff](/Drone-Lab/PX4-Autopilot/commit/cf840ff3731d8bebf65e79bd8c9c7bbd8d29d404)

   |  | case DatamanState::Load: |
   | --- | --- |
   |  |  |
   |  | \_dataman\_cache.update(); |
   |  |  |
   |  | if (!\_dataman\_cache.isLoading()) { |
   |  | \_dataman\_state = DatamanState::UpdateRequestWait; |
   |  | \_updateFence(); |
   |  | \_fence\_updated = true; |
   |  | } |
2. When the ground control station upload mission or geofence to the drone.In mission\_feasibility\_checker.cpp, **synchronous** reading is employed to retrieve updates for the mission, and to check for potential conflicts between the mission and geofence.

   [PX4-Autopilot/src/modules/navigator/mission\_feasibility\_checker.cpp](https://github.com/Drone-Lab/PX4-Autopilot/blob/20129e63facab129ad31fa693d1397e7458afaa4/src/modules/navigator/mission_feasibility_checker.cpp#L122-L123)

   Lines 122 to 123
   in
   [20129e6](/Drone-Lab/PX4-Autopilot/commit/20129e63facab129ad31fa693d1397e7458afaa4)

   |  | bool success = \_dataman\_client.readSync((dm\_item\_t)mission.dataman\_id, i, reinterpret\_cast<uint8\_t \*>(&missionitem), |
   | --- | --- |
   |  | sizeof(mission\_item\_s)); |

   This functionality is called within a while(1) loop in navigator\_main.cpp too.

   [PX4-Autopilot/src/modules/navigator/navigator\_main.cpp](https://github.com/Drone-Lab/PX4-Autopilot/blob/20129e63facab129ad31fa693d1397e7458afaa4/src/modules/navigator/navigator_main.cpp#L873-L877)

   Lines 873 to 877
   in
   [20129e6](/Drone-Lab/PX4-Autopilot/commit/20129e63facab129ad31fa693d1397e7458afaa4)

   |  | for (unsigned int i = 0; i < NAVIGATOR\_MODE\_ARRAY\_SIZE; i++) { |
   | --- | --- |
   |  | if (\_navigation\_mode\_array[i]) { |
   |  | \_navigation\_mode\_array[i]->run(\_navigation\_mode == \_navigation\_mode\_array[i]); |
   |  | } |
   |  | } |
3. This is the cause of the issue. When on the ground control station, both the geofence and mission are updated simultaneously. The geofence undergoes multiple state transitions through the state machine (with each state transition requiring the execution of a while(1) loop), and it is only after asynchronous reading that the geofence data can be loaded for the mission\_feasibility\_checker to examine.
   Therefore, when the mission\_feasibility\_checker utilizes synchronous reading to obtain mission data, the geofence data involved in the check has not yet been updated. Consequently, the check is performed with outdated geofence data, resulting in the failure of the checker.

### Verification

I added some debug output to watch the drone's geofence data update.

We have observed that, after clicking "UPLOAD" in QGC, the updating of the geofence lags behind the mission updates and feasibility\_check by several rounds in the loop.

When the drone is executing a mission and the user clicks UPLOAD,the console will output the following content:

```
...
INFO  [navigator] loop
INFO  [navigator] loop
INFO  [navigator] update mission    //load the new mission data
INFO  [navigator] loop
INFO  [navigator] check feasibility   //triger check function
INFO  [navigator] loop
INFO  [navigator] loop
INFO  [navigator] loop
INFO  [navigator] loop
INFO  [navigator] update geofence  //Here load geofence data,but the feasibility checking has finshed
INFO  [navigator] loop
INFO  [navigator] loop
...

```

### Temporary Patch

Now, the check function is only present in the mission module. This is unreasonable.

When GCS update the geofence, we need the mission feasibility checks to be run immediately.

We can accomplish the above by simply adding the same check to the geofence.Like this:Add mission point check when update the geofence #22531

In the main branch now, someone noticed the potential issue with this checker's effectiveness. However, their solution is to perform the check again just before the drone takes off. This can address some problems since, after some time, the geofence data is updated to the latest. However, they did not recognize that the fundamental cause of the issue is data race due to multithreading, and this approach introduces new problems. We and the contributor discussed this in [#1261](https://github.com/PX4/PX4-Autopilot/pull/22394#issuecomment-1858063715).

> Currently, the same upload button doesn't trigger a check when updating only the fence, only updating the mission triggers a check, which I think is patently unreasonable.
> For example, a scenario like this: a user plans a task in advance and passes the check, is ready to execute it some time later, but doesn't get a notification that the task is not compliant until just before execution.

### Appendix

We have obtained the CNVD ID of this vulnerability.

[![Your Image](https://private-user-images.githubusercontent.com/151698793/296915697-edcc1255-d900-42fc-9b25-40e4efd02a48.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTgyODQsIm5iZiI6MTczNjg5Nzk4NCwicGF0aCI6Ii8xNTE2OTg3OTMvMjk2OTE1Njk3LWVkY2MxMjU1LWQ5MDAtNDJmYy05YjI1LTQwZTRlZmQwMmE0OC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTE0JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExNFQyMzM5NDRaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1mZDI0MGIwMzc0MzNmOWYyYjY3YzYyOTQxMmY1YWIzMTE1OTI1MzFkYmExNWQ5NDRiYWQ2MWJmZWVkNmU4NDI2JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.0iLeE1YN4MUDrmXncrFxq4-6urtJ1_qSBaInGHnvdOY)](https://private-user-images.githubusercontent.com/151698793/296915697-edcc1255-d900-42fc-9b25-40e4efd02a48.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY4OTgyODQsIm5iZiI6MTczNjg5Nzk4NCwicGF0aCI6Ii8xNTE2OTg3OTMvMjk2OTE1Njk3LWVkY2MxMjU1LWQ5MDAtNDJmYy05YjI1LTQwZTRlZmQwMmE0OC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTE0JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExNFQyMzM5NDRaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1mZDI0MGIwMzc0MzNmOWYyYjY3YzYyOTQxMmY1YWIzMTE1OTI1MzFkYmExNWQ5NDRiYWQ2MWJmZWVkNmU4NDI2JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.0iLeE1YN4MUDrmXncrFxq4-6urtJ1_qSBaInGHnvdOY)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


