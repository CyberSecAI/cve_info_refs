=== Content from github.com_2278b701_20250115_091143.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fmoby%2Fcommit%2F3e230cfdcc989dc524882f6579f9e0dac77400ae)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fmoby%2Fcommit%2F3e230cfdcc989dc524882f6579f9e0dac77400ae)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=moby%2Fmoby)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moby](/moby)
/
**[moby](/moby/moby)**
Public

* [Notifications](/login?return_to=%2Fmoby%2Fmoby) You must be signed in to change notification settings
* [Fork
  18.7k](/login?return_to=%2Fmoby%2Fmoby)
* [Star
   69k](/login?return_to=%2Fmoby%2Fmoby)

* [Code](/moby/moby)
* [Issues
  3.1k](/moby/moby/issues)
* [Pull requests
  422](/moby/moby/pulls)
* [Discussions](/moby/moby/discussions)
* [Actions](/moby/moby/actions)
* [Projects
  4](/moby/moby/projects)
* [Wiki](/moby/moby/wiki)
* [Security](/moby/moby/security)
* [Insights](/moby/moby/pulse)

Additional navigation options

* [Code](/moby/moby)
* [Issues](/moby/moby/issues)
* [Pull requests](/moby/moby/pulls)
* [Discussions](/moby/moby/discussions)
* [Actions](/moby/moby/actions)
* [Projects](/moby/moby/projects)
* [Wiki](/moby/moby/wiki)
* [Security](/moby/moby/security)
* [Insights](/moby/moby/pulse)

## Commit

[Permalink](/moby/moby/commit/3e230cfdcc989dc524882f6579f9e0dac77400ae)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-xw73-rw38-6vjc](https://github.com/advisories/GHSA-xw73-rw38-6vjc "GHSA-xw73-rw38-6vjc")

[Browse files](/moby/moby/tree/3e230cfdcc989dc524882f6579f9e0dac77400ae)
Browse the repository at this point in the history

```
image/cache: Restrict cache candidates to locally built images
```

* Loading branch information

[![@thaJeztah](https://avatars.githubusercontent.com/u/1804568?s=40&v=4)](/thaJeztah)

[thaJeztah](/moby/moby/commits?author=thaJeztah "View all commits by thaJeztah")
authored
Feb 1, 2024

2 parents
[f42b8ae](/moby/moby/commit/f42b8ae8db5914b99de52a3c4439be46d28325d3)
+
[96d461d](/moby/moby/commit/96d461d27e8da97b64620c94a4a1b2448511c058)

commit 3e230cf

 Show file tree

 Hide file tree

Showing
**12 changed files**
with
**263 additions**
and
**118 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* builder

  + builder/builder.go
    [builder.go](#diff-d371e466d16c4d92dff29b2806e847c619149cd6de147f1cb9ae7e9511d5da7f)
  + dockerfile

    - builder/dockerfile/copy.go
      [copy.go](#diff-2d8a0bbdcf9462632ef7ed93cd035b4f88851a33669d01311754ae9023812b74)
    - builder/dockerfile/dispatchers.go
      [dispatchers.go](#diff-64f5a562299db19e390a781b7083871527ba921d5d0516f07b5e83808f9f759e)
    - builder/dockerfile/imageprobe.go
      [imageprobe.go](#diff-179eb0e9962f62184f52770d46978ffa19fb17fab57d1ce1fed832e39cfbb1fd)
    - builder/dockerfile/internals.go
      [internals.go](#diff-2d1cd0cbc407f38960e628655d0f29f3bf49219da7be0d1f60d2ba42a8b10bfc)
    - builder/dockerfile/mockbackend\_test.go
      [mockbackend\_test.go](#diff-2d32ef531a45583912c9491f129cfaf8044928a33529296e4f63ea420aec8898)
* daemon

  + containerd

    - daemon/containerd/cache.go
      [cache.go](#diff-343282eced12b85e0c2edc3577e1bebdbe2c953127168c3feb91d8bc2472b9d0)
  + images

    - daemon/images/image\_builder.go
      [image\_builder.go](#diff-2279d32516c701d119f5e2ebad881dad05882ea1f87bc3197d833d24dfd472fa)
    - daemon/images/image\_commit.go
      [image\_commit.go](#diff-0402fdee83fd7f38dce7bb524e1c47b739c8b88ad63ad03644f8ad311e3c7d8b)
* image

  + cache

    - image/cache/cache.go
      [cache.go](#diff-94f837494b930281f1939a48771144270c82191da65ad867ddcd09541326f0d7)
    - image/cache/compare.go
      [compare.go](#diff-74a931a1c7ad5edded3d1e74e901e9943650ae39f6db1bdc9b744775d10b485e)
  + image/store.go
    [store.go](#diff-770024064df4fdbbcf407f1edb273fad08d5b345b6e2cd14aaa1320bbe461797)

## There are no files selected for viewing

3 changes: 2 additions & 1 deletion

3
[builder/builder.go](#diff-d371e466d16c4d92dff29b2806e847c619149cd6de147f1cb9ae7e9511d5da7f "builder/builder.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/builder/builder.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,6 +14,7 @@ import ( |
|  |  | "github.com/docker/docker/image" |
|  |  | "github.com/docker/docker/layer" |
|  |  | "github.com/opencontainers/go-digest" |
|  |  | ocispec "github.com/opencontainers/image-spec/specs-go/v1" |
|  |  | ) |
|  |  |  |
|  |  | const ( |
| Expand Down  Expand Up | | @@ -85,7 +86,7 @@ type ImageCacheBuilder interface { |
|  |  | type ImageCache interface { |
|  |  | // GetCache returns a reference to a cached image whose parent equals `parent` |
|  |  | // and runconfig equals `cfg`. A cache miss is expected to return an empty ID and a nil error. |
|  |  | GetCache(parentID string, cfg \*container.Config) (imageID string, err error) |
|  |  | GetCache(parentID string, cfg \*container.Config, platform ocispec.Platform) (imageID string, err error) |
|  |  | } |
|  |  |  |
|  |  | // Image represents a Docker image used by the builder. |
| Expand Down | |  |

17 changes: 2 additions & 15 deletions

17
[builder/dockerfile/copy.go](#diff-2d8a0bbdcf9462632ef7ed93cd035b4f88851a33669d01311754ae9023812b74 "builder/dockerfile/copy.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/builder/dockerfile/copy.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -8,7 +8,6 @@ import ( |
|  |  | "net/url" |
|  |  | "os" |
|  |  | "path/filepath" |
|  |  | "runtime" |
|  |  | "sort" |
|  |  | "strings" |
|  |  | "time" |
| Expand Down  Expand Up | | @@ -74,7 +73,7 @@ type copier struct { |
|  |  | source builder.Source |
|  |  | pathCache pathCache |
|  |  | download sourceDownloader |
|  |  | platform \*ocispec.Platform |
|  |  | platform ocispec.Platform |
|  |  | // for cleanup. TODO: having copier.cleanup() is error prone and hard to |
|  |  | // follow. Code calling performCopy should manage the lifecycle of its params. |
|  |  | // Copier should take override source as input, not imageMount. |
| Expand All | | @@ -83,19 +82,7 @@ type copier struct { |
|  |  | } |
|  |  |  |
|  |  | func copierFromDispatchRequest(req dispatchRequest, download sourceDownloader, imageSource \*imageMount) copier { |
|  |  | platform := req.builder.platform |
|  |  | if platform == nil { |
|  |  | // May be nil if not explicitly set in API/dockerfile |
|  |  | platform = &ocispec.Platform{} |
|  |  | } |
|  |  | if platform.OS == "" { |
|  |  | // Default to the dispatch requests operating system if not explicit in API/dockerfile |
|  |  | platform.OS = req.state.operatingSystem |
|  |  | } |
|  |  | if platform.OS == "" { |
|  |  | // This is a failsafe just in case. Shouldn't be hit. |
|  |  | platform.OS = runtime.GOOS |
|  |  | } |
|  |  | platform := req.builder.getPlatform(req.state) |
|  |  |  |
|  |  | return copier{ |
|  |  | source: req.source, |
| Expand Down | |  |

9 changes: 8 additions & 1 deletion

9
[builder/dockerfile/dispatchers.go](#diff-64f5a562299db19e390a781b7083871527ba921d5d0516f07b5e83808f9f759e "builder/dockerfile/dispatchers.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/builder/dockerfile/dispatchers.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -348,9 +348,16 @@ func dispatchRun(ctx context.Context, d dispatchRequest, c \*instructions.RunComm |
|  |  | saveCmd = prependEnvOnCmd(d.state.buildArgs, buildArgs, cmdFromArgs) |
|  |  | } |
|  |  |  |
|  |  | cacheArgsEscaped := argsEscaped |
|  |  | // ArgsEscaped is not persisted in the committed image on Windows. |
|  |  | // Use the original from previous build steps for cache probing. |
|  |  | if d.state.operatingSystem == "windows" { |
|  |  | cacheArgsEscaped = stateRunConfig.ArgsEscaped |
|  |  | } |
|  |  |  |
|  |  | runConfigForCacheProbe := copyRunConfig(stateRunConfig, |
|  |  | withCmd(saveCmd), |
|  |  | withArgsEscaped(argsEscaped), |
|  |  | withArgsEscaped(cacheArgsEscaped), |
|  |  | withEntrypointOverride(saveCmd, nil)) |
|  |  | if hit, err := d.builder.probeCache(d.state, runConfigForCacheProbe); err != nil || hit { |
|  |  | return err |
| Expand Down | |  |

9 changes: 5 additions & 4 deletions

9
[builder/dockerfile/imageprobe.go](#diff-179eb0e9962f62184f52770d46978ffa19fb17fab57d1ce1fed832e39cfbb1fd "builder/dockerfile/imageprobe.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/builder/dockerfile/imageprobe.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,13 +6,14 @@ import ( |
|  |  | "github.com/containerd/log" |
|  |  | "github.com/docker/docker/api/types/container" |
|  |  | "github.com/docker/docker/builder" |
|  |  | ocispec "github.com/opencontainers/image-spec/specs-go/v1" |
|  |  | ) |
|  |  |  |
|  |  | // ImageProber exposes an Image cache to the Builder. It supports resetting a |
|  |  | // cache. |
|  |  | type ImageProber interface { |
|  |  | Reset(ctx context.Context) error |
|  |  | Probe(parentID string, runConfig \*container.Config) (string, error) |
|  |  | Probe(parentID string, runConfig \*container.Config, platform ocispec.Platform) (string, error) |
|  |  | } |
|  |  |  |
|  |  | type resetFunc func(context.Context) (builder.ImageCache, error) |
| Expand Down  Expand Up | | @@ -51,11 +52,11 @@ func (c \*imageProber) Reset(ctx context.Context) error { |
|  |  |  |
|  |  | // Probe checks if cache match can be found for current build instruction. |
|  |  | // It returns the cachedID if there is a hit, and the empty string on miss |
|  |  | func (c \*imageProber) Probe(parentID string, runConfig \*container.Config) (string, error) { |
|  |  | func (c \*imageProber) Probe(parentID string, runConfig \*container.Config, platform ocispec.Platform) (string, error) { |
|  |  | if c.cacheBusted { |
|  |  | return "", nil |
|  |  | } |
|  |  | cacheID, err := c.cache.GetCache(parentID, runConfig) |
|  |  | cacheID, err := c.cache.GetCache(parentID, runConfig, platform) |
|  |  | if err != nil { |
|  |  | return "", err |
|  |  | } |
| Expand All | | @@ -74,6 +75,6 @@ func (c \*nopProber) Reset(ctx context.Context) error { |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | func (c \*nopProber) Probe(\_ string, \_ \*container.Config) (string, error) { |
|  |  | func (c \*nopProber) Probe(\_ string, \_ \*container.Config, \_ ocispec.Platform) (string, error) { |
|  |  | return "", nil |
|  |  | } |

17 changes: 16 additions & 1 deletion

17
[builder/dockerfile/internals.go](#diff-2d1cd0cbc407f38960e628655d0f29f3bf49219da7be0d1f60d2ba42a8b10bfc "builder/dockerfile/internals.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/builder/dockerfile/internals.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,6 +10,7 @@ import ( |
|  |  | "fmt" |
|  |  | "strings" |
|  |  |  |
|  |  | "github.com/containerd/containerd/platforms" |
|  |  | "github.com/containerd/log" |
|  |  | "github.com/docker/docker/api/types" |
|  |  | "github.com/docker/docker/api/types/backend" |
| Expand Down  Expand Up | | @@ -328,7 +329,7 @@ func getShell(c \*container.Config, os string) []string { |
|  |  | } |
|  |  |  |
|  |  | func (b \*Builder) probeCache(dispatchState \*dispatchState, runConfig \*container.Config) (bool, error) { |
|  |  | cachedID, err := b.imageProber.Probe(dispatchState.imageID, runConfig) |
|  |  | cachedID, err := b.imageProber.Probe(dispatchState.imageID, runConfig, b.getPlatform(dispatchState)) |
|  |  | if cachedID == "" || err != nil { |
|  |  | return false, err |
|  |  | } |
| Expand Down  Expand Up | | @@ -388,3 +389,17 @@ func hostConfigFromOptions(options \*types.ImageBuildOptions) \*container.HostConf |
|  |  | } |
|  |  | return hc |
|  |  | } |
|  |  |  |
|  |  | func (b \*Builder) getPlatform(state \*dispatchState) ocispec.Platform { |
|  |  | // May be nil if not explicitly set in API/dockerfile |
|  |  | out := platforms.DefaultSpec() |
|  |  | if b.platform != nil { |
|  |  | out = \*b.platform |
|  |  | } |
|  |  |  |
|  |  | if state.operatingSystem != "" { |
|  |  | out.OS = state.operatingSystem |
|  |  | } |
|  |  |  |
|  |  | return out |
|  |  | } |

3 changes: 2 additions & 1 deletion

3
[builder/dockerfile/mockbackend\_test.go](#diff-2d32ef531a45583912c9491f129cfaf8044928a33529296e4f63ea420aec8898 "builder/dockerfile/mockbackend_test.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/builder/dockerfile/mockbackend_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,6 +13,7 @@ import ( |
|  |  | "github.com/docker/docker/image" |
|  |  | "github.com/docker/docker/layer" |
|  |  | "github.com/opencontainers/go-digest" |
|  |  | ocispec "github.com/opencontainers/image-spec/specs-go/v1" |
|  |  | ) |
|  |  |  |
|  |  | // MockBackend implements the builder.Backend interface for unit testing |
| Expand Down  Expand Up | | @@ -106,7 +107,7 @@ type mockImageCache struct { |
|  |  | getCacheFunc func(parentID string, cfg \*container.Config) (string, error) |
|  |  | } |
|  |  |  |
|  |  | func (mic \*mockImageCache) GetCache(parentID string, cfg \*container.Config) (string, error) { |
|  |  | func (mic \*mockImageCache) GetCache(parentID string, cfg \*container.Config, \_ ocispec.Platform) (string, error) { |
|  |  | if mic.getCacheFunc != nil { |
|  |  | return mic.getCacheFunc(parentID, cfg) |
|  |  | } |
| Expand Down | |  |

74 changes: 10 additions & 64 deletions

74
[daemon/containerd/cache.go](#diff-343282eced12b85e0c2edc3577e1bebdbe2c953127168c3feb91d8bc2472b9d0 "daemon/containerd/cache.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/daemon/containerd/cache.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,6 +11,7 @@ import ( |
|  |  | "github.com/docker/docker/builder" |
|  |  | "github.com/docker/docker/errdefs" |
|  |  | "github.com/docker/docker/image" |
|  |  | "github.com/docker/docker/image/cache" |
|  |  | "github.com/opencontainers/go-digest" |
|  |  | ocispec "github.com/opencontainers/image-spec/specs-go/v1" |
|  |  | ) |
| Expand Down  Expand Up | | @@ -53,7 +54,7 @@ type localCache struct { |
|  |  | imageService \*ImageService |
|  |  | } |
|  |  |  |
|  |  | func (ic \*localCache) GetCache(parentID string, cfg \*container.Config) (imageID string, err error) { |
|  |  | func (ic \*localCache) GetCache(parentID string, cfg \*container.Config, platform ocispec.Platform) (imageID string, err error) { |
|  |  | ctx := context.TODO() |
|  |  |  |
|  |  | var children []image.ID |
| Expand Down  Expand Up | | @@ -98,9 +99,12 @@ func (ic \*localCache) GetCache(parentID string, cfg \*container.Config) (imageID |
|  |  | return "", err |
|  |  | } |
|  |  |  |
|  |  | if isMatch(&cc, cfg) { |
|  |  | childImage, err := ic.imageService.GetImage(ctx, child.String(), backend.GetImageOpts{}) |
|  |  | if cache.CompareConfig(&cc, cfg) { |
|  |  | childImage, err := ic.imageService.GetImage(ctx, child.String(), backend.GetImageOpts{Platform: &platform}) |
|  |  | if err != nil { |
|  |  | if errdefs.IsNotFound(err) { |
|  |  | continue |
|  |  | } |
|  |  | return "", err |
|  |  | } |
|  |  |  |
| Expand All | | @@ -123,10 +127,10 @@ type imageCache struct { |
|  |  | lc \*localCache |
|  |  | } |
|  |  |  |
|  |  | func (ic \*imageCache) GetCache(parentID string, cfg \*container.Config) (imageID string, err error) { |
|  |  | func (ic \*imageCache) GetCache(parentID string, cfg \*container.Config, platform ocispec.Platform) (imageID string, err error) { |
|  |  | ctx := context.TODO() |
|  |  |  |
|  |  | imgID, err := ic.lc.GetCache(parentID, cfg) |
|  |  | imgID, err := ic.lc.GetCache(parentID, cfg, platform) |
|  |  | if err != nil { |
|  |  | return "", err |
|  |  | } |
| Expand All | | @@ -142,7 +146,7 @@ func (ic \*imageCache) GetCache(parentID string, cfg \*container.Config) (imageID |
|  |  | lenHistory := 0 |
|  |  |  |
|  |  | if parentID != "" { |
|  |  | parent, err = ic.imageService.GetImage(ctx, parentID, backend.GetImageOpts{}) |
|  |  | parent, err = ic.imageService.GetImage(ctx, parentID, backend.GetImageOpts{Platform: &platform}) |
|  |  | if err != nil { |
|  |  | return "", err |
|  |  | } |
| Expand Down  Expand Up | | @@ -206,61 +210,3 @@ func (ic \*imageCache) isParent(ctx context.Context, img \*image.Image, parentID i |
|  |  | } |
|  |  | return ic.isParent(ctx, p, parentID) |
|  |  | } |
|  |  |  |
|  |  | // compare two Config struct. Do not compare the "Image" nor "Hostname" fields |
|  |  | // If OpenStdin is set, then it differs |
|  |  | func isMatch(a, b \*container.Config) bool { |
|  |  | if a == nil || b == nil || |
|  |  | a.OpenStdin || b.OpenStdin { |
|  |  | return false |
|  |  | } |
|  |  | if a.AttachStdout != b.AttachStdout || |
|  |  | a.AttachStderr != b.AttachStderr || |
|  |  | a.User != b.User || |
|  |  | a.OpenStdin != b.OpenStdin || |
|  |  | a.Tty != b.Tty { |
|  |  | return false |
|  |  | } |
|  |  |  |
|  |  | if len(a.Cmd) != len(b.Cmd) || |
|  |  | len(a.Env) != len(b.Env) || |
|  |  | len(a.Labels) != len(b.Labels) || |
|  |  | len(a.ExposedPorts) != len(b.ExposedPorts) || |
|  |  | len(a.Entrypoint) != len(b.Entrypoint) || |
|  |  | len(a.Volumes) != len(b.Volumes) { |
|  |  | return false |
|  |  | } |
|  |  |  |
|  |  | for i := 0; i < len(a.Cmd); i++ { |
|  |  | if a.Cmd[i] != b.Cmd[i] { |
|  |  | return false |
|  |  | } |
|  |  | } |
|  |  | for i := 0; i < len(a.Env); i++ { |
|  |  | if a.Env[i] != b.Env[i] { |
|  |  | return false |
|  |  | } |
|  |  | } |
|  |  | for k, v := range a.Labels { |
|  |  | if v != b.Labels[k] { |
|  |  | return false |
|  |  | } |
|  |  | } |
|  |  | for k := range a.ExposedPorts { |
|  |  | if \_, exists := b.ExposedPorts[k]; !exists { |
|  |  | return false |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | for i := 0; i < len(a.Entrypoint); i++ { |
|  |  | if a.Entrypoint[i] != b.Entrypoint[i] { |
|  |  | return false |
|  |  | } |
|  |  | } |
|  |  | for key := range a.Volumes { |
|  |  | if \_, exists := b.Volumes[key]; !exists { |
|  |  | return false |
|  |  | } |
|  |  | } |
|  |  | return true |
|  |  | } |

3 changes: 3 additions & 0 deletions

3
[daemon/images/image\_builder.go](#diff-2279d32516c701d119f5e2ebad881dad05882ea1f87bc3197d833d24dfd472fa "daemon/images/image_builder.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/daemon/images/image_builder.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -254,6 +254,9 @@ func (i \*ImageService) CreateImage(ctx context.Context, config []byte, parent st |
|  |  | return nil, errors.Wrapf(err, "failed to set parent %s", parent) |
|  |  | } |
|  |  | } |
|  |  | if err := i.imageStore.SetBuiltLocally(id); err != nil { |
|  |  | return nil, errors.Wrapf(err, "failed to mark image %s as built locally", id) |
|  |  | } |
|  |  |  |
|  |  | return i.imageStore.Get(id) |
|  |  | } |

3 changes: 3 additions & 0 deletions

3
[daemon/images/image\_commit.go](#diff-0402fdee83fd7f38dce7bb524e1c47b739c8b88ad63ad03644f8ad311e3c7d8b "daemon/images/image_commit.go")

Show comments

[View file](/moby/moby/blob/3e230cfdcc989dc524882f6579f9e0dac77400ae/daemon/images/image_commit.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -62,6 +62,9 @@ func (i \*ImageService) CommitImage(ctx context.Context, c backend.CommitConfig) |
|  |  | if err != nil { |
|  |  | return "", err |
|  |  | } |
|  |  | if err := i.imageStore.SetBuiltLocally(id); err != nil { |
|  |  | return "", err |
|  |  | } |
|  |  |  |
|  |  | if c.ParentImageID != "" { |
|  |  | if err := i.imageStore.SetParent(id, image.ID(c.ParentImageID)); err != nil { |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3e230cf`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fmoby%2Fcommit%2F3e230cfdcc989dc524882f6579f9e0dac77400ae) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_45975054_20250115_091144.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fmoby%2Fsecurity%2Fadvisories%2FGHSA-xw73-rw38-6vjc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fmoby%2Fsecurity%2Fadvisories%2FGHSA-xw73-rw38-6vjc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=moby%2Fmoby)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moby](/moby)
/
**[moby](/moby/moby)**
Public

* [Notifications](/login?return_to=%2Fmoby%2Fmoby) You must be signed in to change notification settings
* [Fork
  18.7k](/login?return_to=%2Fmoby%2Fmoby)
* [Star
   69k](/login?return_to=%2Fmoby%2Fmoby)

* [Code](/moby/moby)
* [Issues
  3.1k](/moby/moby/issues)
* [Pull requests
  422](/moby/moby/pulls)
* [Discussions](/moby/moby/discussions)
* [Actions](/moby/moby/actions)
* [Projects
  4](/moby/moby/projects)
* [Wiki](/moby/moby/wiki)
* [Security](/moby/moby/security)
* [Insights](/moby/moby/pulse)

Additional navigation options

* [Code](/moby/moby)
* [Issues](/moby/moby/issues)
* [Pull requests](/moby/moby/pulls)
* [Discussions](/moby/moby/discussions)
* [Actions](/moby/moby/actions)
* [Projects](/moby/moby/projects)
* [Wiki](/moby/moby/wiki)
* [Security](/moby/moby/security)
* [Insights](/moby/moby/pulse)

# Classic builder cache poisoning

Moderate

[tonistiigi](/tonistiigi)
published
GHSA-xw73-rw38-6vjc
Feb 1, 2024

## Package

gomod

github.com/docker/docker
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

>= v25, < v25.0.2
>= v24, < v24.0.9
>= v23, < v23.0.10

## Patched versions

>= v25.0.2
>= v24.0.9
>= v23.0.10

## Description

The classic builder cache system is prone to cache poisoning if the image is built `FROM scratch`.

Also, changes to some instructions (most important being `HEALTHCHECK` and `ONBUILD`) would not cause a cache miss.

An attacker with the knowledge of the Dockerfile someone is using could poison their cache by making them pull a specially crafted image that would be considered as a valid cache candidate for some build steps.

For example, an attacker could create an image that is considered as a valid cache candidate for:

```
FROM scratch
MAINTAINER Pawel

```

when in fact the malicious image used as a cache would be an image built from a different Dockerfile.

In the second case, the attacker could for example substitute a different `HEALTCHECK` command.

### Impact

23.0+ users are only affected if they explicitly opted out of Buildkit (`DOCKER_BUILDKIT=0` environment variable) or are using the `/build` API endpoint (which uses the classic builder by default).

All users on versions older than 23.0 could be impacted. An example could be a CI with a shared cache, or just a regular Docker user pulling a malicious image due to misspelling/typosquatting.

Image build API endpoint (`/build`) and `ImageBuild` function from `github.com/docker/docker/client` is also affected as it the uses classic builder by default.

### Patches

Patches are included in Moby releases:

* v25.0.2
* v24.0.9
* v23.0.10

### Workarounds

* Use `--no-cache` or use Buildkit if possible (`DOCKER_BUILDKIT=1`, it's default on 23.0+ assuming that the buildx plugin is installed).
* Use `Version = types.BuilderBuildKit` or `NoCache = true` in `ImageBuildOptions` for `ImageBuild` call.

### Severity

Moderate

6.9

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Local

Attack complexity
High

Privileges required
None

User interaction
Required

Scope
Changed

Confidentiality
Low

Integrity
High

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:L/AC:H/PR:N/UI:R/S:C/C:L/I:H/A:L

### CVE ID

CVE-2024-24557

### Weaknesses

No CWEs

### Credits

* [![@vvoland](https://avatars.githubusercontent.com/u/5046555?s=40&v=4)](/vvoland)
  [vvoland](/vvoland)
  Finder
* [![@rumpl](https://avatars.githubusercontent.com/u/99933?s=40&v=4)](/rumpl)
  [rumpl](/rumpl)
  Reporter
* [![@gabriellavengeo](https://avatars.githubusercontent.com/u/23005021?s=40&v=4)](/gabriellavengeo)
  [gabriellavengeo](/gabriellavengeo)
  Remediation reviewer

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


