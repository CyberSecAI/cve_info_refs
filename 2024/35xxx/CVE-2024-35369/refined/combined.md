=== Content from github.com_5e085379_20250114_184307.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fblob%2Fn6.1.1%2Flibavcodec%2Fspeexdec.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fblob%2Fn6.1.1%2Flibavcodec%2Fspeexdec.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=FFmpeg%2FFFmpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FFmpeg](/FFmpeg)
/
**[FFmpeg](/FFmpeg/FFmpeg)**
Public

* [Notifications](/login?return_to=%2FFFmpeg%2FFFmpeg) You must be signed in to change notification settings
* [Fork
  12.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)
* [Star
   47.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)

* [Code](/FFmpeg/FFmpeg/tree/n6.1.1)
* [Pull requests
  1](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

Additional navigation options

* [Code](/FFmpeg/FFmpeg/tree/n6.1.1)
* [Pull requests](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

## Files

 n6.1.1
## Breadcrumbs

1. [FFmpeg](/FFmpeg/FFmpeg/tree/n6.1.1)
2. /[libavcodec](/FFmpeg/FFmpeg/tree/n6.1.1/libavcodec)
/
# speexdec.c

Copy path Blame  Blame
## Latest commit

## History

[History](/FFmpeg/FFmpeg/commits/n6.1.1/libavcodec/speexdec.c)1596 lines (1342 loc) · 52.6 KB n6.1.1
## Breadcrumbs

1. [FFmpeg](/FFmpeg/FFmpeg/tree/n6.1.1)
2. /[libavcodec](/FFmpeg/FFmpeg/tree/n6.1.1/libavcodec)
/
# speexdec.c

Top
## File metadata and controls

* Code
* Blame

1596 lines (1342 loc) · 52.6 KB[Raw](https://github.com/FFmpeg/FFmpeg/raw/refs/tags/n6.1.1/libavcodec/speexdec.c)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000/\* \* Copyright 2002-2008 Xiph.org Foundation \* Copyright 2002-2008 Jean-Marc Valin \* Copyright 2005-2007 Analog Devices Inc. \* Copyright 2005-2008 Commonwealth Scientific and Industrial Research Organisation (CSIRO) \* Copyright 1993, 2002, 2006 David Rowe \* Copyright 2003 EpicGames \* Copyright 1992-1994 Jutta Degener, Carsten Bormann
 \* Redistribution and use in source and binary forms, with or without \* modification, are permitted provided that the following conditions \* are met:
 \* - Redistributions of source code must retain the above copyright \* notice, this list of conditions and the following disclaimer.
 \* - Redistributions in binary form must reproduce the above copyright \* notice, this list of conditions and the following disclaimer in the \* documentation and/or other materials provided with the distribution.
 \* - Neither the name of the Xiph.org Foundation nor the names of its \* contributors may be used to endorse or promote products derived from \* this software without specific prior written permission.
 \* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \* ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT \* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR \* A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE FOUNDATION OR \* CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, \* EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, \* PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR \* PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF \* LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING \* NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS \* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. \* \* This file is part of FFmpeg. \* \* FFmpeg is free software; you can redistribute it and/or \* modify it under the terms of the GNU Lesser General Public \* License as published by the Free Software Foundation; either \* version 2.1 of the License, or (at your option) any later version. \* \* FFmpeg is distributed in the hope that it will be useful, \* but WITHOUT ANY WARRANTY; without even the implied warranty of \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU \* Lesser General Public License for more details. \* \* You should have received a copy of the GNU Lesser General Public \* License along with FFmpeg; if not, write to the Free Software \* Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA \*/
#include "libavutil/avassert.h"#include "libavutil/float\_dsp.h"#include "avcodec.h"#include "bytestream.h"#include "codec\_internal.h"#include "decode.h"#include "get\_bits.h"#include "speexdata.h"
#define SPEEX\_NB\_MODES 3#define SPEEX\_INBAND\_STEREO 9
#define QMF\_ORDER 64#define NB\_ORDER 10#define NB\_FRAME\_SIZE 160#define NB\_SUBMODES 9#define NB\_SUBMODE\_BITS 4#define SB\_SUBMODE\_BITS 3
#define NB\_SUBFRAME\_SIZE 40#define NB\_NB\_SUBFRAMES 4#define NB\_PITCH\_START 17#define NB\_PITCH\_END 144
#define NB\_DEC\_BUFFER (NB\_FRAME\_SIZE + 2 \* NB\_PITCH\_END + NB\_SUBFRAME\_SIZE + 12)
#define SPEEX\_MEMSET(dst, c, n) (memset((dst), (c), (n) \* sizeof(\*(dst))))#define SPEEX\_COPY(dst, src, n) (memcpy((dst), (src), (n) \* sizeof(\*(dst))))
#define LSP\_LINEAR(i) (.25f \* (i) + .25f)#define LSP\_LINEAR\_HIGH(i) (.3125f \* (i) + .75f)#define LSP\_DIV\_256(x) (0.00390625f \* (x))#define LSP\_DIV\_512(x) (0.001953125f \* (x))#define LSP\_DIV\_1024(x) (0.0009765625f \* (x))
typedef struct LtpParams { const int8\_t \*gain\_cdbk; int gain\_bits; int pitch\_bits;} LtpParam;
static const LtpParam ltp\_params\_vlbr = { gain\_cdbk\_lbr, 5, 0 };static const LtpParam ltp\_params\_lbr = { gain\_cdbk\_lbr, 5, 7 };static const LtpParam ltp\_params\_med = { gain\_cdbk\_lbr, 5, 7 };static const LtpParam ltp\_params\_nb = { gain\_cdbk\_nb, 7, 7 };
typedef struct SplitCodebookParams { int subvect\_size; int nb\_subvect; const signed char \*shape\_cb; int shape\_bits; int have\_sign;} SplitCodebookParams;
static const SplitCodebookParams split\_cb\_nb\_ulbr = { 20, 2, exc\_20\_32\_table, 5, 0 };static const SplitCodebookParams split\_cb\_nb\_vlbr = { 10, 4, exc\_10\_16\_table, 4, 0 };static const SplitCodebookParams split\_cb\_nb\_lbr = { 10, 4, exc\_10\_32\_table, 5, 0 };static const SplitCodebookParams split\_cb\_nb\_med = { 8, 5, exc\_8\_128\_table, 7, 0 };static const SplitCodebookParams split\_cb\_nb = { 5, 8, exc\_5\_64\_table, 6, 0 };static const SplitCodebookParams split\_cb\_sb = { 5, 8, exc\_5\_256\_table, 8, 0 };static const SplitCodebookParams split\_cb\_high = { 8, 5, hexc\_table, 7, 1 };static const SplitCodebookParams split\_cb\_high\_lbr= { 10, 4, hexc\_10\_32\_table,5, 0 };
/\*\* Quantizes LSPs \*/typedef void (\*lsp\_quant\_func)(float \*, float \*, int, GetBitContext \*);
/\*\* Decodes quantized LSPs \*/typedef void (\*lsp\_unquant\_func)(float \*, int, GetBitContext \*);
/\*\* Long-term predictor quantization \*/typedef int (\*ltp\_quant\_func)(float \*, float \*, float \*, float \*, float \*, float \*, const void \*, int, int, float, int, int, GetBitContext \*, char \*, float \*, float \*, int, int, int, float \*);
/\*\* Long-term un-quantize \*/typedef void (\*ltp\_unquant\_func)(float \*, float \*, int, int, float, const void \*, int, int \*, float \*, GetBitContext \*, int, int, float, int);
/\*\* Innovation quantization function \*/typedef void (\*innovation\_quant\_func)(float \*, float \*, float \*, float \*, const void \*, int, int, float \*, float \*, GetBitContext \*, char \*, int, int);
/\*\* Innovation unquantization function \*/typedef void (\*innovation\_unquant\_func)(float \*, const void \*, int, GetBitContext \*, uint32\_t \*);
typedef struct SpeexSubmode { int lbr\_pitch; /\*\*< Set to -1 for "normal" modes, otherwise encode pitch using a global pitch and allowing a +- lbr\_pitch variation (for low not-rates)\*/ int forced\_pitch\_gain; /\*\*< Use the same (forced) pitch gain for all sub-frames \*/ int have\_subframe\_gain; /\*\*< Number of bits to use as sub-frame innovation gain \*/ int double\_codebook; /\*\*< Apply innovation quantization twice for higher quality (and higher bit-rate)\*/ lsp\_unquant\_func lsp\_unquant; /\*\*< LSP unquantization function \*/
 ltp\_unquant\_func ltp\_unquant; /\*\*< Long-term predictor (pitch) un-quantizer \*/ const void \*LtpParam; /\*\*< Pitch parameters (options) \*/
 innovation\_unquant\_func innovation\_unquant; /\*\*< Innovation un-quantization \*/ const void \*innovation\_params; /\*\*< Innovation quantization parameters\*/
 float comb\_gain; /\*\*< Gain of enhancer comb filter \*/} SpeexSubmode;
typedef struct SpeexMode { int modeID; /\*\*< ID of the mode \*/ int (\*decode)(AVCodecContext \*avctx, void \*dec, GetBitContext \*gb, float \*out); int frame\_size; /\*\*< Size of frames used for decoding \*/ int subframe\_size; /\*\*< Size of sub-frames used for decoding \*/ int lpc\_size; /\*\*< Order of LPC filter \*/ float folding\_gain; /\*\*< Folding gain \*/ const SpeexSubmode \*submodes[NB\_SUBMODES]; /\*\*< Sub-mode data for the mode \*/ int default\_submode; /\*\*< Default sub-mode to use when decoding \*/} SpeexMode;
typedef struct DecoderState { const SpeexMode \*mode; int modeID; /\*\*< ID of the decoder mode \*/ int first; /\*\*< Is first frame \*/ int full\_frame\_size; /\*\*< Length of full-band frames \*/ int is\_wideband; /\*\*< If wideband is present \*/ int count\_lost; /\*\*< Was the last frame lost? \*/ int frame\_size; /\*\*< Length of high-band frames \*/ int subframe\_size; /\*\*< Length of high-band sub-frames \*/ int nb\_subframes; /\*\*< Number of high-band sub-frames \*/ int lpc\_size; /\*\*< Order of high-band LPC analysis \*/ float last\_ol\_gain; /\*\*< Open-loop gain for previous frame \*/ float \*innov\_save; /\*\*< If non-NULL, innovation is copied here \*/
 /\* This is used in packet loss concealment \*/ int last\_pitch; /\*\*< Pitch of last correctly decoded frame \*/ float last\_pitch\_gain; /\*\*< Pitch gain of last correctly decoded frame \*/ uint32\_t seed; /\*\*< Seed used for random number generation \*/
 int encode\_submode; const SpeexSubmode \*const \*submodes; /\*\*< Sub-mode data \*/ int submodeID; /\*\*< Activated sub-mode \*/ int lpc\_enh\_enabled; /\*\*< 1 when LPC enhancer is on, 0 otherwise \*/
 /\* Vocoder data \*/ float voc\_m1; float voc\_m2; float voc\_mean; int voc\_offset;
 int dtx\_enabled; int highpass\_enabled; /\*\*< Is the input filter enabled \*/
 float \*exc; /\*\*< Start of excitation frame \*/ float mem\_hp[2]; /\*\*< High-pass filter memory \*/ float exc\_buf[NB\_DEC\_BUFFER]; /\*\*< Excitation buffer \*/ float old\_qlsp[NB\_ORDER]; /\*\*< Quantized LSPs for previous frame \*/ float interp\_qlpc[NB\_ORDER]; /\*\*< Interpolated quantized LPCs \*/ float mem\_sp[NB\_ORDER]; /\*\*< Filter memory for synthesis signal \*/ float g0\_mem[QMF\_ORDER]; float g1\_mem[QMF\_ORDER]; float pi\_gain[NB\_NB\_SUBFRAMES]; /\*\*< Gain of LPC filter at theta=pi (fe/2) \*/ float exc\_rms[NB\_NB\_SUBFRAMES]; /\*\*< RMS of excitation per subframe \*/} DecoderState;
/\* Default handler for user callbacks: skip it \*/static int speex\_default\_user\_handler(GetBitContext \*gb, void \*state, void \*data){ const int req\_size = get\_bits(gb, 4); skip\_bits\_long(gb, 5 + 8 \* req\_size); return 0;}
typedef struct StereoState { float balance; /\*\*< Left/right balance info \*/ float e\_ratio; /\*\*< Ratio of energies: E(left+right)/[E(left)+E(right)] \*/ float smooth\_left; /\*\*< Smoothed left channel gain \*/ float smooth\_right; /\*\*< Smoothed right channel gain \*/} StereoState;
typedef struct SpeexContext { AVClass \*class; GetBitContext gb;
 int32\_t version\_id; /\*\*< Version for Speex (for checking compatibility) \*/ int32\_t rate; /\*\*< Sampling rate used \*/ int32\_t mode; /\*\*< Mode used (0 for narrowband, 1 for wideband) \*/ int32\_t bitstream\_version; /\*\*< Version ID of the bit-stream \*/ int32\_t nb\_channels; /\*\*< Number of channels decoded \*/ int32\_t bitrate; /\*\*< Bit-rate used \*/ int32\_t frame\_size; /\*\*< Size of frames \*/ int32\_t vbr; /\*\*< 1 for a VBR decoding, 0 otherwise \*/ int32\_t frames\_per\_packet; /\*\*< Number of frames stored per Ogg packet \*/ int32\_t extra\_headers; /\*\*< Number of additional headers after the comments \*/
 int pkt\_size;
 StereoState stereo; DecoderState st[SPEEX\_NB\_MODES];
 AVFloatDSPContext \*fdsp;} SpeexContext;
static void lsp\_unquant\_lbr(float \*lsp, int order, GetBitContext \*gb){ int id;
 for (int i = 0; i < order; i++) lsp[i] = LSP\_LINEAR(i);
 id = get\_bits(gb, 6); for (int i = 0; i < 10; i++) lsp[i] += LSP\_DIV\_256(cdbk\_nb[id \* 10 + i]);
 id = get\_bits(gb, 6); for (int i = 0; i < 5; i++) lsp[i] += LSP\_DIV\_512(cdbk\_nb\_low1[id \* 5 + i]);
 id = get\_bits(gb, 6); for (int i = 0; i < 5; i++) lsp[i + 5] += LSP\_DIV\_512(cdbk\_nb\_high1[id \* 5 + i]);}
static void forced\_pitch\_unquant(float \*exc, float \*exc\_out, int start, int end, float pitch\_coef, const void \*par, int nsf, int \*pitch\_val, float \*gain\_val, GetBitContext \*gb, int count\_lost, int subframe\_offset, float last\_pitch\_gain, int cdbk\_offset){ av\_assert0(!isnan(pitch\_coef)); pitch\_coef = fminf(pitch\_coef, .99f); for (int i = 0; i < nsf; i++) { exc\_out[i] = exc[i - start] \* pitch\_coef; exc[i] = exc\_out[i]; } pitch\_val[0] = start; gain\_val[0] = gain\_val[2] = 0.f; gain\_val[1] = pitch\_coef;}
static inline float speex\_rand(float std, uint32\_t \*seed){ const uint32\_t jflone = 0x3f800000; const uint32\_t jflmsk = 0x007fffff; float fran; uint32\_t ran; seed[0] = 1664525 \* seed[0] + 1013904223; ran = jflone | (jflmsk & seed[0]); fran = av\_int2float(ran); fran -= 1.5f; fran \*= std; return fran;}
static void noise\_codebook\_unquant(float \*exc, const void \*par, int nsf, GetBitContext \*gb, uint32\_t \*seed){ for (int i = 0; i < nsf; i++) exc[i] = speex\_rand(1.f, seed);}
static void split\_cb\_shape\_sign\_unquant(float \*exc, const void \*par, int nsf, GetBitContext \*gb, uint32\_t \*seed){ int subvect\_size, nb\_subvect, have\_sign, shape\_bits; const SplitCodebookParams \*params; const signed char \*shape\_cb; int signs[10], ind[10];
 params = par; subvect\_size = params->subvect\_size; nb\_subvect = params->nb\_subvect;
 shape\_cb = params->shape\_cb; have\_sign = params->have\_sign; shape\_bits = params->shape\_bits;
 /\* Decode codewords and gains \*/ for (int i = 0; i < nb\_subvect; i++) { signs[i] = have\_sign ? get\_bits1(gb) : 0; ind[i] = get\_bitsz(gb, shape\_bits); } /\* Compute decoded excitation \*/ for (int i = 0; i < nb\_subvect; i++) { const float s = signs[i] ? -1.f : 1.f;
 for (int j = 0; j < subvect\_size; j++) exc[subvect\_size \* i + j] += s \* 0.03125f \* shape\_cb[ind[i] \* subvect\_size + j]; }}
#define SUBMODE(x) st->submodes[st->submodeID]->x
#define gain\_3tap\_to\_1tap(g) (FFABS(g[1]) + (g[0] > 0.f ? g[0] : -.5f \* g[0]) + (g[2] > 0.f ? g[2] : -.5f \* g[2]))
static voidpitch\_unquant\_3tap(float \*exc, float \*exc\_out, int start, int end, float pitch\_coef, const void \*par, int nsf, int \*pitch\_val, float \*gain\_val, GetBitContext \*gb, int count\_lost, int subframe\_offset, float last\_pitch\_gain, int cdbk\_offset){ int pitch, gain\_index, gain\_cdbk\_size; const int8\_t \*gain\_cdbk; const LtpParam \*params; float gain[3];
 params = (const LtpParam \*)par; gain\_cdbk\_size = 1 << params->gain\_bits; gain\_cdbk = params->gain\_cdbk + 4 \* gain\_cdbk\_size \* cdbk\_offset;
 pitch = get\_bitsz(gb, params->pitch\_bits); pitch += start; gain\_index = get\_bitsz(gb, params->gain\_bits); gain[0] = 0.015625f \* gain\_cdbk[gain\_index \* 4] + .5f; gain[1] = 0.015625f \* gain\_cdbk[gain\_index \* 4 + 1] + .5f; gain[2] = 0.015625f \* gain\_cdbk[gain\_index \* 4 + 2] + .5f;
 if (count\_lost && pitch > subframe\_offset) { float tmp = count\_lost < 4 ? last\_pitch\_gain : 0.5f \* last\_pitch\_gain; float gain\_sum;
 tmp = fminf(tmp, .95f); gain\_sum = gain\_3tap\_to\_1tap(gain);
 if (gain\_sum > tmp && gain\_sum > 0.f) { float fact = tmp / gain\_sum; for (int i = 0; i < 3; i++) gain[i] \*= fact; } }
 pitch\_val[0] = pitch; gain\_val[0] = gain[0]; gain\_val[1] = gain[1]; gain\_val[2] = gain[2]; SPEEX\_MEMSET(exc\_out, 0, nsf);
 for (int i = 0; i < 3; i++) { int tmp1, tmp3; int pp = pitch + 1 - i; tmp1 = nsf; if (tmp1 > pp) tmp1 = pp; for (int j = 0; j < tmp1; j++) exc\_out[j] += gain[2 - i] \* exc[j - pp]; tmp3 = nsf; if (tmp3 > pp + pitch) tmp3 = pp + pitch; for (int j = tmp1; j < tmp3; j++) exc\_out[j] += gain[2 - i] \* exc[j - pp - pitch]; }}
static void lsp\_unquant\_nb(float \*lsp, int order, GetBitContext \*gb){ int id;
 for (int i = 0; i < order; i++) lsp[i] = LSP\_LINEAR(i);
 id = get\_bits(gb, 6); for (int i = 0; i < 10; i++) lsp[i] += LSP\_DIV\_256(cdbk\_nb[id \* 10 + i]);
 id = get\_bits(gb, 6); for (int i = 0; i < 5; i++) lsp[i] += LSP\_DIV\_512(cdbk\_nb\_low1[id \* 5 + i]);
 id = get\_bits(gb, 6); for (int i = 0; i < 5; i++) lsp[i] += LSP\_DIV\_1024(cdbk\_nb\_low2[id \* 5 + i]);
 id = get\_bits(gb, 6); for (int i = 0; i < 5; i++) lsp[i + 5] += LSP\_DIV\_512(cdbk\_nb\_high1[id \* 5 + i]);
 id = get\_bits(gb, 6); for (int i = 0; i < 5; i++) lsp[i + 5] += LSP\_DIV\_1024(cdbk\_nb\_high2[id \* 5 + i]);}
static void lsp\_unquant\_high(float \*lsp, int order, GetBitContext \*gb){ int id;
 for (int i = 0; i < order; i++) lsp[i] = LSP\_LINEAR\_HIGH(i);
 id = get\_bits(gb, 6); for (int i = 0; i < order; i++) lsp[i] += LSP\_DIV\_256(high\_lsp\_cdbk[id \* order + i]);
 id = get\_bits(gb, 6); for (int i = 0; i < order; i++) lsp[i] += LSP\_DIV\_512(high\_lsp\_cdbk2[id \* order + i]);}
/\* 2150 bps "vocoder-like" mode for comfort noise \*/static const SpeexSubmode nb\_submode1 = { 0, 1, 0, 0, lsp\_unquant\_lbr, forced\_pitch\_unquant, NULL, noise\_codebook\_unquant, NULL, -1.f};
/\* 5.95 kbps very low bit-rate mode \*/static const SpeexSubmode nb\_submode2 = { 0, 0, 0, 0, lsp\_unquant\_lbr, pitch\_unquant\_3tap, &ltp\_params\_vlbr, split\_cb\_shape\_sign\_unquant, &split\_cb\_nb\_vlbr, .6f};
/\* 8 kbps low bit-rate mode \*/static const SpeexSubmode nb\_submode3 = { -1, 0, 1, 0, lsp\_unquant\_lbr, pitch\_unquant\_3tap, &ltp\_params\_lbr, split\_cb\_shape\_sign\_unquant, &split\_cb\_nb\_lbr, .55f};
/\* 11 kbps medium bit-rate mode \*/static const SpeexSubmode nb\_submode4 = { -1, 0, 1, 0, lsp\_unquant\_lbr, pitch\_unquant\_3tap, &ltp\_params\_med, split\_cb\_shape\_sign\_unquant, &split\_cb\_nb\_med, .45f};
/\* 15 kbps high bit-rate mode \*/static const SpeexSubmode nb\_submode5 = { -1, 0, 3, 0, lsp\_unquant\_nb, pitch\_unquant\_3tap, &ltp\_params\_nb, split\_cb\_shape\_sign\_unquant, &split\_cb\_nb, .25f};
/\* 18.2 high bit-rate mode \*/static const SpeexSubmode nb\_submode6 = { -1, 0, 3, 0, lsp\_unquant\_nb, pitch\_unquant\_3tap, &ltp\_params\_nb, split\_cb\_shape\_sign\_unquant, &split\_cb\_sb, .15f};
/\* 24.6 kbps high bit-rate mode \*/static const SpeexSubmode nb\_submode7 = { -1, 0, 3, 1, lsp\_unquant\_nb, pitch\_unquant\_3tap, &ltp\_params\_nb, split\_cb\_shape\_sign\_unquant, &split\_cb\_nb, 0.05f};
/\* 3.95 kbps very low bit-rate mode \*/static const SpeexSubmode nb\_submode8 = { 0, 1, 0, 0, lsp\_unquant\_lbr, forced\_pitch\_unquant, NULL, split\_cb\_shape\_sign\_unquant, &split\_cb\_nb\_ulbr, .5f};
static const SpeexSubmode wb\_submode1 = { 0, 0, 1, 0, lsp\_unquant\_high, NULL, NULL, NULL, NULL, -1.f};
static const SpeexSubmode wb\_submode2 = { 0, 0, 1, 0, lsp\_unquant\_high, NULL, NULL, split\_cb\_shape\_sign\_unquant, &split\_cb\_high\_lbr, -1.f};
static const SpeexSubmode wb\_submode3 = { 0, 0, 1, 0, lsp\_unquant\_high, NULL, NULL, split\_cb\_shape\_sign\_unquant, &split\_cb\_high, -1.f};
static const SpeexSubmode wb\_submode4 = { 0, 0, 1, 1, lsp\_unquant\_high, NULL, NULL, split\_cb\_shape\_sign\_unquant, &split\_cb\_high, -1.f};
static int nb\_decode(AVCodecContext \*, void \*, GetBitContext \*, float \*);static int sb\_decode(AVCodecContext \*, void \*, GetBitContext \*, float \*);
static const SpeexMode speex\_modes[SPEEX\_NB\_MODES] = { { .modeID = 0, .decode = nb\_decode, .frame\_size = NB\_FRAME\_SIZE, .subframe\_size = NB\_SUBFRAME\_SIZE, .lpc\_size = NB\_ORDER, .submodes = { NULL, &nb\_submode1, &nb\_submode2, &nb\_submode3, &nb\_submode4, &nb\_submode5, &nb\_submode6, &nb\_submode7, &nb\_submode8 }, .default\_submode = 5, }, { .modeID = 1, .decode = sb\_decode, .frame\_size = NB\_FRAME\_SIZE, .subframe\_size = NB\_SUBFRAME\_SIZE, .lpc\_size = 8, .folding\_gain = 0.9f, .submodes = { NULL, &wb\_submode1, &wb\_submode2, &wb\_submode3, &wb\_submode4 }, .default\_submode = 3, }, { .modeID = 2, .decode = sb\_decode, .frame\_size = 320, .subframe\_size = 80, .lpc\_size = 8, .folding\_gain = 0.7f, .submodes = { NULL, &wb\_submode1 }, .default\_submode = 1, },};
static float compute\_rms(const float \*x, int len){ float sum = 0.f;
 for (int i = 0; i < len; i++) sum += x[i] \* x[i];
 av\_assert0(len > 0); return sqrtf(.1f + sum / len);}
static void bw\_lpc(float gamma, const float \*lpc\_in, float \*lpc\_out, int order){ float tmp = gamma;
 for (int i = 0; i < order; i++) { lpc\_out[i] = tmp \* lpc\_in[i]; tmp \*= gamma; }}
static void iir\_mem(const float \*x, const float \*den, float \*y, int N, int ord, float \*mem){ for (int i = 0; i < N; i++) { float yi = x[i] + mem[0]; float nyi = -yi; for (int j = 0; j < ord - 1; j++) mem[j] = mem[j + 1] + den[j] \* nyi; mem[ord - 1] = den[ord - 1] \* nyi; y[i] = yi; }}
static void highpass(const float \*x, float \*y, int len, float \*mem, int wide){ static const float Pcoef[2][3] = {{ 1.00000f, -1.92683f, 0.93071f }, { 1.00000f, -1.97226f, 0.97332f } }; static const float Zcoef[2][3] = {{ 0.96446f, -1.92879f, 0.96446f }, { 0.98645f, -1.97277f, 0.98645f } }; const float \*den, \*num;
 den = Pcoef[wide]; num = Zcoef[wide]; for (int i = 0; i < len; i++) { float yi = num[0] \* x[i] + mem[0]; mem[0] = mem[1] + num[1] \* x[i] + -den[1] \* yi; mem[1] = num[2] \* x[i] + -den[2] \* yi; y[i] = yi; }}
#define median3(a, b, c) \ ((a) < (b) ? ((b) < (c) ? (b) : ((a) < (c) ? (c) : (a))) \ : ((c) < (b) ? (b) : ((c) < (a) ? (c) : (a))))
static int speex\_std\_stereo(GetBitContext \*gb, void \*state, void \*data){ StereoState \*stereo = data; float sign = get\_bits1(gb) ? -1.f : 1.f;
 stereo->balance = exp(sign \* .25f \* get\_bits(gb, 5)); stereo->e\_ratio = e\_ratio\_quant[get\_bits(gb, 2)];
 return 0;}
static int speex\_inband\_handler(GetBitContext \*gb, void \*state, StereoState \*stereo){ int id = get\_bits(gb, 4);
 if (id == SPEEX\_INBAND\_STEREO) { return speex\_std\_stereo(gb, state, stereo); } else { int adv;
 if (id < 2) adv = 1; else if (id < 8) adv = 4; else if (id < 10) adv = 8; else if (id < 12) adv = 16; else if (id < 14) adv = 32; else adv = 64; skip\_bits\_long(gb, adv); } return 0;}
static void sanitize\_values(float \*vec, float min\_val, float max\_val, int len){ for (int i = 0; i < len; i++) { if (!isnormal(vec[i]) || fabsf(vec[i]) < 1e-8f) vec[i] = 0.f; else vec[i] = av\_clipf(vec[i], min\_val, max\_val); }}
static void signal\_mul(const float \*x, float \*y, float scale, int len){ for (int i = 0; i < len; i++) y[i] = scale \* x[i];}
static float inner\_prod(const float \*x, const float \*y, int len){ float sum = 0.f;
 for (int i = 0; i < len; i += 8) { float part = 0.f; part += x[i + 0] \* y[i + 0]; part += x[i + 1] \* y[i + 1]; part += x[i + 2] \* y[i + 2]; part += x[i + 3] \* y[i + 3]; part += x[i + 4] \* y[i + 4]; part += x[i + 5] \* y[i + 5]; part += x[i + 6] \* y[i + 6]; part += x[i + 7] \* y[i + 7]; sum += part; }
 return sum;}
static int interp\_pitch(const float \*exc, float \*interp, int pitch, int len){ float corr[4][7], maxcorr; int maxi, maxj;
 for (int i = 0; i < 7; i++) corr[0][i] = inner\_prod(exc, exc - pitch - 3 + i, len); for (int i = 0; i < 3; i++) { for (int j = 0; j < 7; j++) { int i1, i2; float tmp = 0.f;
 i1 = 3 - j; if (i1 < 0) i1 = 0; i2 = 10 - j; if (i2 > 7) i2 = 7; for (int k = i1; k < i2; k++) tmp += shift\_filt[i][k] \* corr[0][j + k - 3]; corr[i + 1][j] = tmp; } } maxi = maxj = 0; maxcorr = corr[0][0]; for (int i = 0; i < 4; i++) { for (int j = 0; j < 7; j++) { if (corr[i][j] > maxcorr) { maxcorr = corr[i][j]; maxi = i; maxj = j; } } } for (int i = 0; i < len; i++) { float tmp = 0.f; if (maxi > 0.f) { for (int k = 0; k < 7; k++) tmp += exc[i - (pitch - maxj + 3) + k - 3] \* shift\_filt[maxi - 1][k]; } else { tmp = exc[i - (pitch - maxj + 3)]; } interp[i] = tmp; } return pitch - maxj + 3;}
static void multicomb(const float \*exc, float \*new\_exc, float \*ak, int p, int nsf, int pitch, int max\_pitch, float comb\_gain){ float old\_ener, new\_ener; float iexc0\_mag, iexc1\_mag, exc\_mag; float iexc[4 \* NB\_SUBFRAME\_SIZE]; float corr0, corr1, gain0, gain1; float pgain1, pgain2; float c1, c2, g1, g2; float ngain, gg1, gg2; int corr\_pitch = pitch;
 interp\_pitch(exc, iexc, corr\_pitch, 80); if (corr\_pitch > max\_pitch) interp\_pitch(exc, iexc + nsf, 2 \* corr\_pitch, 80); else interp\_pitch(exc, iexc + nsf, -corr\_pitch, 80);
 iexc0\_mag = sqrtf(1000.f + inner\_prod(iexc, iexc, nsf)); iexc1\_mag = sqrtf(1000.f + inner\_prod(iexc + nsf, iexc + nsf, nsf)); exc\_mag = sqrtf(1.f + inner\_prod(exc, exc, nsf)); corr0 = inner\_prod(iexc, exc, nsf); corr1 = inner\_prod(iexc + nsf, exc, nsf); if (corr0 > iexc0\_mag \* exc\_mag) pgain1 = 1.f; else pgain1 = (corr0 / exc\_mag) / iexc0\_mag; if (corr1 > iexc1\_mag \* exc\_mag) pgain2 = 1.f; else pgain2 = (corr1 / exc\_mag) / iexc1\_mag; gg1 = exc\_mag / iexc0\_mag; gg2 = exc\_mag / iexc1\_mag; if (comb\_gain > 0.f) { c1 = .4f \* comb\_gain + .07f; c2 = .5f + 1.72f \* (c1 - .07f); } else { c1 = c2 = 0.f; } g1 = 1.f - c2 \* pgain1 \* pgain1; g2 = 1.f - c2 \* pgain2 \* pgain2; g1 = fmaxf(g1, c1); g2 = fmaxf(g2, c1); g1 = c1 / g1; g2 = c1 / g2;
 if (corr\_pitch > max\_pitch) { gain0 = .7f \* g1 \* gg1; gain1 = .3f \* g2 \* gg2; } else { gain0 = .6f \* g1 \* gg1; gain1 = .6f \* g2 \* gg2; } for (int i = 0; i < nsf; i++) new\_exc[i] = exc[i] + (gain0 \* iexc[i]) + (gain1 \* iexc[i + nsf]); new\_ener = compute\_rms(new\_exc, nsf); old\_ener = compute\_rms(exc, nsf);
 old\_ener = fmaxf(old\_ener, 1.f); new\_ener = fmaxf(new\_ener, 1.f); old\_ener = fminf(old\_ener, new\_ener); ngain = old\_ener / new\_ener;
 for (int i = 0; i < nsf; i++) new\_exc[i] \*= ngain;}
static void lsp\_interpolate(const float \*old\_lsp, const float \*new\_lsp, float \*lsp, int len, int subframe, int nb\_subframes, float margin){ const float tmp = (1.f + subframe) / nb\_subframes;
 for (int i = 0; i < len; i++) { lsp[i] = (1.f - tmp) \* old\_lsp[i] + tmp \* new\_lsp[i]; lsp[i] = av\_clipf(lsp[i], margin, M\_PI - margin); } for (int i = 1; i < len - 1; i++) { lsp[i] = fmaxf(lsp[i], lsp[i - 1] + margin); if (lsp[i] > lsp[i + 1] - margin) lsp[i] = .5f \* (lsp[i] + lsp[i + 1] - margin); }}
static void lsp\_to\_lpc(const float \*freq, float \*ak, int lpcrdr){ float xout1, xout2, xin1, xin2; float \*pw, \*n0; float Wp[4 \* NB\_ORDER + 2] = { 0 }; float x\_freq[NB\_ORDER]; const int m = lpcrdr >> 1;
 pw = Wp;
 xin1 = xin2 = 1.f;
 for (int i = 0; i < lpcrdr; i++) x\_freq[i] = -cosf(freq[i]);
 /\* reconstruct P(z) and Q(z) by cascading second order \* polynomials in form 1 - 2xz(-1) +z(-2), where x is the \* LSP coefficient \*/ for (int j = 0; j <= lpcrdr; j++) { int i2 = 0; for (int i = 0; i < m; i++, i2 += 2) { n0 = pw + (i \* 4); xout1 = xin1 + 2.f \* x\_freq[i2 ] \* n0[0] + n0[1]; xout2 = xin2 + 2.f \* x\_freq[i2 + 1] \* n0[2] + n0[3]; n0[1] = n0[0]; n0[3] = n0[2]; n0[0] = xin1; n0[2] = xin2; xin1 = xout1; xin2 = xout2; } xout1 = xin1 + n0[4]; xout2 = xin2 - n0[5]; if (j > 0) ak[j - 1] = (xout1 + xout2) \* 0.5f; n0[4] = xin1; n0[5] = xin2;
 xin1 = 0.f; xin2 = 0.f; }}
static int nb\_decode(AVCodecContext \*avctx, void \*ptr\_st, GetBitContext \*gb, float \*out){ DecoderState \*st = ptr\_st; float ol\_gain = 0, ol\_pitch\_coef = 0, best\_pitch\_gain = 0, pitch\_average = 0; int m, pitch, wideband, ol\_pitch = 0, best\_pitch = 40; SpeexContext \*s = avctx->priv\_data; float innov[NB\_SUBFRAME\_SIZE]; float exc32[NB\_SUBFRAME\_SIZE]; float interp\_qlsp[NB\_ORDER]; float qlsp[NB\_ORDER]; float ak[NB\_ORDER]; float pitch\_gain[3] = { 0 };
 st->exc = st->exc\_buf + 2 \* NB\_PITCH\_END + NB\_SUBFRAME\_SIZE + 6;
 if (st->encode\_submode) { do { /\* Search for next narrowband block (handle requests, skip wideband blocks) \*/ if (get\_bits\_left(gb) < 5) return AVERROR\_INVALIDDATA; wideband = get\_bits1(gb); if (wideband) /\* Skip wideband block (for compatibility) \*/ { int submode, advance;
 submode = get\_bits(gb, SB\_SUBMODE\_BITS); advance = wb\_skip\_table[submode]; advance -= SB\_SUBMODE\_BITS + 1; if (advance < 0) return AVERROR\_INVALIDDATA; skip\_bits\_long(gb, advance);
 if (get\_bits\_left(gb) < 5) return AVERROR\_INVALIDDATA; wideband = get\_bits1(gb); if (wideband) { submode = get\_bits(gb, SB\_SUBMODE\_BITS); advance = wb\_skip\_table[submode]; advance -= SB\_SUBMODE\_BITS + 1; if (advance < 0) return AVERROR\_INVALIDDATA; skip\_bits\_long(gb, advance); wideband = get\_bits1(gb); if (wideband) { av\_log(avctx, AV\_LOG\_ERROR, "more than two wideband layers found\n"); return AVERROR\_INVALIDDATA; } } } if (get\_bits\_left(gb) < 4) return AVERROR\_INVALIDDATA; m = get\_bits(gb, 4); if (m == 15) /\* We found a terminator \*/ { return AVERROR\_INVALIDDATA; } else if (m == 14) /\* Speex in-band request \*/ { int ret = speex\_inband\_handler(gb, st, &s->stereo); if (ret) return ret; } else if (m == 13) /\* User in-band request \*/ { int ret = speex\_default\_user\_handler(gb, st, NULL); if (ret) return ret; } else if (m > 8) /\* Invalid mode \*/ { return AVERROR\_INVALIDDATA; } } while (m > 8);
 st->submodeID = m; /\* Get the sub-mode that was used \*/ }
 /\* Shift all buffers by one frame \*/ memmove(st->exc\_buf, st->exc\_buf + NB\_FRAME\_SIZE, (2 \* NB\_PITCH\_END + NB\_SUBFRAME\_SIZE + 12) \* sizeof(float));
 /\* If null mode (no transmission), just set a couple things to zero \*/ if (st->submodes[st->submodeID] == NULL) { float lpc[NB\_ORDER]; float innov\_gain = 0.f;
 bw\_lpc(0.93f, st->interp\_qlpc, lpc, NB\_ORDER); innov\_gain = compute\_rms(st->exc, NB\_FRAME\_SIZE); for (int i = 0; i < NB\_FRAME\_SIZE; i++) st->exc[i] = speex\_rand(innov\_gain, &st->seed);
 /\* Final signal synthesis from excitation \*/ iir\_mem(st->exc, lpc, out, NB\_FRAME\_SIZE, NB\_ORDER, st->mem\_sp); st->count\_lost = 0;
 return 0; }
 /\* Unquantize LSPs \*/ SUBMODE(lsp\_unquant)(qlsp, NB\_ORDER, gb);
 /\* Damp memory if a frame was lost and the LSP changed too much \*/ if (st->count\_lost) { float fact, lsp\_dist = 0;
 for (int i = 0; i < NB\_ORDER; i++) lsp\_dist = lsp\_dist + FFABS(st->old\_qlsp[i] - qlsp[i]); fact = .6f \* exp(-.2f \* lsp\_dist); for (int i = 0; i < NB\_ORDER; i++) st->mem\_sp[i] = fact \* st->mem\_sp[i]; }
 /\* Handle first frame and lost-packet case \*/ if (st->first || st->count\_lost) memcpy(st->old\_qlsp, qlsp, sizeof(st->old\_qlsp));
 /\* Get open-loop pitch estimation for low bit-rate pitch coding \*/ if (SUBMODE(lbr\_pitch) != -1) ol\_pitch = NB\_PITCH\_START + get\_bits(gb, 7);
 if (SUBMODE(forced\_pitch\_gain)) ol\_pitch\_coef = 0.066667f \* get\_bits(gb, 4);
 /\* Get global excitation gain \*/ ol\_gain = expf(get\_bits(gb, 5) / 3.5f);
 if (st->submodeID == 1) st->dtx\_enabled = get\_bits(gb, 4) == 15;
 if (st->submodeID > 1) st->dtx\_enabled = 0;
 for (int sub = 0; sub < NB\_NB\_SUBFRAMES; sub++) { /\* Loop on subframes \*/ float \*exc, \*innov\_save = NULL, tmp, ener; int pit\_min, pit\_max, offset, q\_energy;
 offset = NB\_SUBFRAME\_SIZE \* sub; /\* Offset relative to start of frame \*/ exc = st->exc + offset; /\* Excitation \*/ if (st->innov\_save) /\* Original signal \*/ innov\_save = st->innov\_save + offset;
 SPEEX\_MEMSET(exc, 0, NB\_SUBFRAME\_SIZE); /\* Reset excitation \*/
 /\* Adaptive codebook contribution \*/[View remainder of file in raw view](https://github.com/FFmpeg/FFmpeg/raw/refs/tags/n6.1.1/libavcodec/speexdec.c)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_eafd500e_20250114_184309.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2F0895ef0d6d6406ee6cd158fc4d47d80f201b8e9c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2F0895ef0d6d6406ee6cd158fc4d47d80f201b8e9c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=FFmpeg%2FFFmpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FFmpeg](/FFmpeg)
/
**[FFmpeg](/FFmpeg/FFmpeg)**
Public

* [Notifications](/login?return_to=%2FFFmpeg%2FFFmpeg) You must be signed in to change notification settings
* [Fork
  12.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)
* [Star
   47.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)

* [Code](/FFmpeg/FFmpeg)
* [Pull requests
  1](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

Additional navigation options

* [Code](/FFmpeg/FFmpeg)
* [Pull requests](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

## Commit

[Permalink](/FFmpeg/FFmpeg/commit/0895ef0d6d6406ee6cd158fc4d47d80f201b8e9c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

avcodec/speexdec: further check for sane frame\_size values

[Browse files](/FFmpeg/FFmpeg/tree/0895ef0d6d6406ee6cd158fc4d47d80f201b8e9c)
Browse the repository at this point in the history

```
Prevent potential integer overflows.

Signed-off-by: James Almer <jamrial@gmail.com>
```

* Loading branch information

[![@jamrial](https://avatars.githubusercontent.com/u/2442845?s=40&v=4)](/jamrial)

[jamrial](/FFmpeg/FFmpeg/commits?author=jamrial "View all commits by jamrial")
committed
Feb 17, 2024

1 parent
[d897bbb](/FFmpeg/FFmpeg/commit/d897bbb48dcda23ca3d32332d5be4717dd66e551)

commit 0895ef0

Showing
**1 changed file**
with
**3 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

5 changes: 3 additions & 2 deletions

5
[libavcodec/speexdec.c](#diff-55c4f7c9e257815202e6975d7687e8472f6a921bdeb7cb453c9c1a792fc6fd1d "libavcodec/speexdec.c")

Show comments

[View file](/FFmpeg/FFmpeg/blob/0895ef0d6d6406ee6cd158fc4d47d80f201b8e9c/libavcodec/speexdec.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1421,9 +1421,10 @@ static int parse\_speex\_extradata(AVCodecContext \*avctx, |
|  |  | return AVERROR\_INVALIDDATA; |
|  |  | s->bitrate = bytestream\_get\_le32(&buf); |
|  |  | s->frame\_size = bytestream\_get\_le32(&buf); |
|  |  | if (s->frame\_size < NB\_FRAME\_SIZE << (s->mode > 0)) |
|  |  | if (s->frame\_size < NB\_FRAME\_SIZE << (s->mode > 0) || |
|  |  | s->frame\_size > INT32\_MAX >> (s->mode > 0)) |
|  |  | return AVERROR\_INVALIDDATA; |
|  |  | s->frame\_size \*= 1 + (s->mode > 0); |
|  |  | s->frame\_size <<= (s->mode > 0); |
|  |  | s->vbr = bytestream\_get\_le32(&buf); |
|  |  | s->frames\_per\_packet = bytestream\_get\_le32(&buf); |
|  |  | if (s->frames\_per\_packet <= 0 || |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0895ef0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fffmpeg%2Fffmpeg%2Fcommit%2F0895ef0d6d6406ee6cd158fc4d47d80f201b8e9c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_6520231e_20250114_184301.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F455093807666f2e351d674750c8cd0b8)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F455093807666f2e351d674750c8cd0b8&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F455093807666f2e351d674750c8cd0b8) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F455093807666f2e351d674750c8cd0b8&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@1047524396](https://avatars.githubusercontent.com/u/77877041?s=64&v=4)](/1047524396)

# [1047524396](/1047524396)/**[CVE-2024-35369](/1047524396/455093807666f2e351d674750c8cd0b8)**

Last active
November 29, 2024 04:11

Show Gist options

* [Download ZIP](/1047524396/455093807666f2e351d674750c8cd0b8/archive/912ddf628b2a5e1b90df865a933df2b3405c8a7a.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F455093807666f2e351d674750c8cd0b8)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F455093807666f2e351d674750c8cd0b8)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/1047524396/455093807666f2e351d674750c8cd0b8.js&quot;&gt;&lt;/script&gt;
* Save 1047524396/455093807666f2e351d674750c8cd0b8 to your computer and use it in GitHub Desktop.

[Code](/1047524396/455093807666f2e351d674750c8cd0b8)
[Revisions
3](/1047524396/455093807666f2e351d674750c8cd0b8/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/1047524396/455093807666f2e351d674750c8cd0b8.js&quot;&gt;&lt;/script&gt;

Save 1047524396/455093807666f2e351d674750c8cd0b8 to your computer and use it in GitHub Desktop.

[Download ZIP](/1047524396/455093807666f2e351d674750c8cd0b8/archive/912ddf628b2a5e1b90df865a933df2b3405c8a7a.zip)

CVE-2024-35369

 [Raw](/1047524396/455093807666f2e351d674750c8cd0b8/raw/912ddf628b2a5e1b90df865a933df2b3405c8a7a/CVE-2024-35369)

[**CVE-2024-35369**](#file-cve-2024-35369)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | [CVE ID] |
| --- | --- |
|  | CVE-2024-35369 |
|  | [PRODUCT] |
|  | FFmpeg |
|  | [VERSION] |
|  | n6.1.1 |
|  | [PROBLEM TYPE] |
|  | Integer Overflow |
|  | [DESCRIPTION] |
|  | In FFmpeg version n6.1.1, specifically within the avcodec/speexdec.c module, a potential security vulnerability exists due to insufficient validation of certain parameters when parsing Speex codec extradata. This vulnerability could lead to integer overflow conditions, potentially resulting in undefined behavior or crashes during the decoding process. |
|  | [PATCH LINK] |
|  | https://github.com/ffmpeg/ffmpeg/commit/0895ef0d6d6406ee6cd158fc4d47d80f201b8e9c |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2F1047524396%2F455093807666f2e351d674750c8cd0b8)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


